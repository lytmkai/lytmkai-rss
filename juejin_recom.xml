<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[React Native新架构之iOS端初始化源码分析]]></title>    <link>https://juejin.cn/post/7600223321041879046</link>    <guid>https://juejin.cn/post/7600223321041879046</guid>    <pubDate>2026-01-28T13:41:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600223321041879046" data-draft-id="7594000527509274665" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React Native新架构之iOS端初始化源码分析"/> <meta itemprop="keywords" content="React Native,iOS,源码阅读"/> <meta itemprop="datePublished" content="2026-01-28T13:41:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="编程之路从0到1"/> <meta itemprop="url" content="https://juejin.cn/user/4125023359744296"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React Native新架构之iOS端初始化源码分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4125023359744296/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    编程之路从0到1
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T13:41:51.000Z" title="Wed Jan 28 2026 13:41:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React Native新架构之iOS端初始化源码分析</h2>
<h3 data-id="heading-1">前言</h3>
<p>注意，本文是基于<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Freact-native%2Ftree%2Fv0.83.0" target="_blank" title="https://github.com/facebook/react-native/tree/v0.83.0" ref="nofollow noopener noreferrer">React Native</a> 0.83版本源码进行分析。有了前面几篇Android端分析文章打基础，再来理解iOS端就易如反掌了。总的来说，iOS端的实现要比Android端简单太多了，这是因为Android端的Java/Kotlin 都是运行在Java的虚拟机环境中，其与C++通信要经过JNI，并不如OC与C++互调那么简单直接。此外，RN基于Android的Gradle构建机制，也使问题更加复杂。</p>
<h3 data-id="heading-2">初始化流程</h3>
<p>React Native的iOS端相比于安卓端要简单很多。现在我们基于Swift入口来分析一下初始化流程。首先找到RN源码工程中的测试工程，打开源码<code>react-native/private/helloworld/ios/HelloWorld/AppDelegate.swift</code>：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> React                          <span class="hljs-comment">// React Native 核心模块</span>
<span class="hljs-keyword">import</span> ReactAppDependencyProvider     <span class="hljs-comment">// Codegen 生成的依赖提供者</span>
<span class="hljs-keyword">import</span> React_RCTAppDelegate           <span class="hljs-comment">// AppDelegate 相关类</span>
<span class="hljs-keyword">import</span> UIKit

<span class="hljs-keyword">@main</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AppDelegate</span>: <span class="hljs-title class_">UIResponder</span>, <span class="hljs-title class_">UIApplicationDelegate</span> {
  <span class="hljs-keyword">var</span> window: <span class="hljs-type">UIWindow</span>?

  <span class="hljs-keyword">var</span> reactNativeDelegate: <span class="hljs-type">ReactNativeDelegate</span>?
  <span class="hljs-keyword">var</span> reactNativeFactory: <span class="hljs-type">RCTReactNativeFactory</span>?

  <span class="hljs-keyword">func</span> <span class="hljs-title function_">application</span>(
    <span class="hljs-keyword">_</span> <span class="hljs-params">application</span>: <span class="hljs-type">UIApplication</span>,
    <span class="hljs-params">didFinishLaunchingWithOptions</span> <span class="hljs-params">launchOptions</span>: [<span class="hljs-type">UIApplication</span>.<span class="hljs-params">LaunchOptionsKey</span>: <span class="hljs-keyword">Any</span>]<span class="hljs-operator">?</span> <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>
  ) -&gt; <span class="hljs-type">Bool</span> {
    <span class="hljs-comment">// 1: 创建 ReactNativeDelegate</span>
    <span class="hljs-keyword">let</span> delegate <span class="hljs-operator">=</span> <span class="hljs-type">ReactNativeDelegate</span>()
    <span class="hljs-comment">// 2: 创建 RCTReactNativeFactory</span>
    <span class="hljs-keyword">let</span> factory <span class="hljs-operator">=</span> <span class="hljs-type">RCTReactNativeFactory</span>(delegate: delegate)
    <span class="hljs-comment">// 3: 配置依赖提供者（Codegen 生成的模块）</span>
    delegate.dependencyProvider <span class="hljs-operator">=</span> <span class="hljs-type">RCTAppDependencyProvider</span>()

    <span class="hljs-comment">// 保持强引用</span>
    reactNativeDelegate <span class="hljs-operator">=</span> delegate
    reactNativeFactory <span class="hljs-operator">=</span> factory

    <span class="hljs-comment">// 4: 配置开发菜单（仅 DEBUG 模式）</span>
    <span class="hljs-keyword">#if</span> <span class="hljs-type">DEBUG</span>
    <span class="hljs-keyword">let</span> devMenuConfiguration <span class="hljs-operator">=</span> <span class="hljs-type">RCTDevMenuConfiguration</span>(
      devMenuEnabled: <span class="hljs-literal">true</span>,
      shakeGestureEnabled: <span class="hljs-literal">true</span>,
      keyboardShortcutsEnabled: <span class="hljs-literal">true</span>
    )
    reactNativeFactory<span class="hljs-operator">?</span>.devMenuConfiguration <span class="hljs-operator">=</span> devMenuConfiguration
    <span class="hljs-keyword">#endif</span>

    <span class="hljs-comment">// 5: 创建主窗口</span>
    window <span class="hljs-operator">=</span> <span class="hljs-type">UIWindow</span>(frame: <span class="hljs-type">UIScreen</span>.main.bounds)

    <span class="hljs-comment">// 6: 启动 React Native</span>
    factory.startReactNative(
      withModuleName: <span class="hljs-string">"HelloWorld"</span>,
      in: window,
      launchOptions: launchOptions
    )

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactNativeDelegate</span>: <span class="hljs-title class_">RCTDefaultReactNativeFactoryDelegate</span> {
  <span class="hljs-comment">// 旧架构兼容（新架构中会调用 bundleURL）</span>
  <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">sourceURL</span>(<span class="hljs-params">for</span> <span class="hljs-params">bridge</span>: <span class="hljs-type">RCTBridge</span>) -&gt; <span class="hljs-type">URL</span>? {
    <span class="hljs-keyword">self</span>.bundleURL()
  }

  <span class="hljs-comment">// 提供 JS Bundle 的 URL</span>
  <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">bundleURL</span>() -&gt; <span class="hljs-type">URL</span>? {
    <span class="hljs-keyword">#if</span> <span class="hljs-type">DEBUG</span>
    <span class="hljs-comment">// 开发模式：从 Metro 开发服务器加载</span>
    <span class="hljs-type">RCTBundleURLProvider</span>.sharedSettings().jsBundleURL(forBundleRoot: <span class="hljs-string">"index"</span>)
    <span class="hljs-keyword">#else</span>
    <span class="hljs-comment">// 生产模式：从 App Bundle 加载</span>
    <span class="hljs-type">Bundle</span>.main.url(forResource: <span class="hljs-string">"main"</span>, withExtension: <span class="hljs-string">"jsbundle"</span>)
    <span class="hljs-keyword">#endif</span>
  }
}
</code></pre>
<p>Swift 新架构使用 <code>@main</code> 注解作为应用入口，无需 <code>main.m</code> 或 <code>main.swift</code> 文件。<code>ReactNativeDelegate</code> 继承自 <code>RCTDefaultReactNativeFactoryDelegate</code>，负责提供 Bundle URL 和自定义配置。</p>
<p>这里<code>RCTAppDependencyProvider</code>是Objective-C++代码，这是为了方便与C++互调。源码<code>tcode/react-native/packages/react-native/Libraries/AppDelegate/RCTReactNativeFactory.mm</code>：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">RCTReactNativeFactory</span> () &lt;</span>
    RCTComponentViewFactoryComponentProvider, <span class="hljs-comment">// Fabric 组件提供者</span>
    RCTHostDelegate,                          <span class="hljs-comment">// RCTHost 代理</span>
    RCTJSRuntimeConfiguratorProtocol,         <span class="hljs-comment">// JS Runtime 配置</span>
    RCTTurboModuleManagerDelegate&gt;            <span class="hljs-comment">// TurboModule 管理器代理</span>
<span class="hljs-keyword">@end</span>

<span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">RCTReactNativeFactory</span></span>

- (<span class="hljs-keyword">instancetype</span>)initWithDelegate:(<span class="hljs-type">id</span>&lt;RCTReactNativeFactoryDelegate&gt;)delegate
{
  <span class="hljs-keyword">return</span> [<span class="hljs-keyword">self</span> initWithDelegate:delegate releaseLevel:Stable];
}

- (<span class="hljs-keyword">instancetype</span>)initWithDelegate:(<span class="hljs-type">id</span>&lt;RCTReactNativeFactoryDelegate&gt;)delegate releaseLevel:(RCTReleaseLevel)releaseLevel
{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span> = [<span class="hljs-variable language_">super</span> init]) {
    <span class="hljs-keyword">self</span>.delegate = delegate;
    [<span class="hljs-keyword">self</span> _setUpFeatureFlags:releaseLevel];
    <span class="hljs-comment">// 设置默认颜色空间</span>
    [RCTColorSpaceUtils applyDefaultColorSpace:[<span class="hljs-keyword">self</span> defaultColorSpace]];
    RCTEnableTurboModule(<span class="hljs-literal">YES</span>);

    <span class="hljs-comment">// 创建 RCTRootViewFactory</span>
    <span class="hljs-keyword">self</span>.rootViewFactory = [<span class="hljs-keyword">self</span> createRCTRootViewFactory];
    <span class="hljs-comment">// 设置第三方 Fabric 组件提供者</span>
    [RCTComponentViewFactory currentComponentViewFactory].thirdPartyFabricComponentsProvider = <span class="hljs-keyword">self</span>;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;
}
</code></pre>
<p>可以看到RCTReactNativeFactory的构造逻辑非常简单，但它实现了四个关键协议，这使得它可以作为多个子系统的代理。</p>
<p>先重点看一下<code>createRCTRootViewFactory</code>方法的实现，这是一个关键方法，同时设置了大量的回调 Block 来桥接代理模式：</p>
<pre><code class="hljs language-objc" lang="objc">- (RCTRootViewFactory *)createRCTRootViewFactory
{
  __<span class="hljs-keyword">weak</span> __<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) weakSelf = <span class="hljs-keyword">self</span>;
  <span class="hljs-comment">// 1. 创建 Bundle URL 提供者 Block</span>
  RCTBundleURLBlock bundleUrlBlock = ^{
    auto *strongSelf = weakSelf;
    <span class="hljs-keyword">return</span> strongSelf.bundleURL;
  };

  <span class="hljs-comment">// 2. 创建配置对象（新架构默认全部启用）</span>
  RCTRootViewFactoryConfiguration *configuration =
      [[RCTRootViewFactoryConfiguration alloc] initWithBundleURLBlock:bundleUrlBlock
                                                       newArchEnabled:<span class="hljs-literal">YES</span>
                                                   turboModuleEnabled:<span class="hljs-literal">YES</span>
                                                    bridgelessEnabled:<span class="hljs-literal">YES</span>];

  <span class="hljs-comment">// 省略旧架构代码......</span>

  <span class="hljs-comment">// 3.配置根视图自定义回调</span>
  configuration.customizeRootView = ^(<span class="hljs-built_in">UIView</span> *_Nonnull rootView) {
    [weakSelf.delegate customizeRootView:(RCTRootView *)rootView];
  };

  <span class="hljs-comment">// 4.配置 Bundle URL 获取回调</span>
  configuration.sourceURLForBridge = ^<span class="hljs-built_in">NSURL</span> *_Nullable(RCTBridge *_Nonnull bridge)
  {
    <span class="hljs-comment">// 新架构：直接使用 bundleURL，不再依赖 bridge</span>
    <span class="hljs-keyword">return</span> [weakSelf.delegate bundleURL];
  };

  <span class="hljs-comment">// 5.配置 Bundle 加载回调（支持进度）</span>
  <span class="hljs-keyword">if</span> ([<span class="hljs-keyword">self</span>.delegate respondsToSelector:<span class="hljs-keyword">@selector</span>(loadSourceForBridge:onProgress:onComplete:)]) {
    configuration.loadSourceForBridgeWithProgress =
        ^(RCTBridge *_Nonnull bridge,
          RCTSourceLoadProgressBlock _Nonnull onProgress,
          RCTSourceLoadBlock _Nonnull loadCallback) {
          <span class="hljs-comment">// 新架构：使用 loadBundleAtURL 替代旧的 loadSourceForBridge</span>
          [weakSelf.delegate loadBundleAtURL:<span class="hljs-keyword">self</span>.bundleURL onProgress:onProgress onComplete:loadCallback];
        };
  }

  <span class="hljs-comment">// 6.配置无进度的 Bundle 加载回调</span>
  <span class="hljs-keyword">if</span> ([<span class="hljs-keyword">self</span>.delegate respondsToSelector:<span class="hljs-keyword">@selector</span>(loadSourceForBridge:withBlock:)]) {
    configuration.loadSourceForBridge = ^(RCTBridge *_Nonnull bridge, RCTSourceLoadBlock _Nonnull loadCallback) {
      <span class="hljs-comment">// 新架构：使用 loadBundleAtURL，进度回调为空</span>
      [weakSelf.delegate loadBundleAtURL:<span class="hljs-keyword">self</span>.bundleURL
                              onProgress:^(RCTLoadingProgress *progressData) {
                              }
                              onComplete:loadCallback];
    };
  }

  <span class="hljs-comment">// 7.设置 JS Runtime 代理</span>
  configuration.jsRuntimeConfiguratorDelegate = <span class="hljs-keyword">self</span>;
  <span class="hljs-comment">// 8.创建并返回 RCTRootViewFactory</span>
  <span class="hljs-keyword">return</span> [[RCTRootViewFactory alloc] initWithTurboModuleDelegate:<span class="hljs-keyword">self</span> hostDelegate:<span class="hljs-keyword">self</span> configuration:configuration];
}
</code></pre>
<p>这里的大概流程是非常清楚的，主要就是设置了四个协议的代理。我们将流程绘制成一个关系图：</p>
<pre><code class="hljs language-lua" lang="lua">┌─────────────────────────────────────────────────────────────────────────┐
│                        RCTReactNativeFactory                             │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ 实现协议:                                                          │  │
│  │  • RCTTurboModuleManagerDelegate    → TurboModule 类/实例查找      │  │
│  │  • RCTHostDelegate                  → Host 生命周期 + Bundle 加载  │  │
│  │  • RCTJSRuntimeConfiguratorProtocol → JS Runtime 工厂创建         │  │
│  │  • RCTComponentViewFactoryComponentProvider → Fabric 组件注册     │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                    │                                     │
│                                    ▼                                     │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ createRCTRootViewFactory() 中设置:                                 │  │
│  │  • initWithTurboModuleDelegate: <span class="hljs-built_in">self</span>  ← RCTTurboModuleManagerDelegate│
│  │  • hostDelegate: <span class="hljs-built_in">self</span>                 ← RCTHostDelegate              │
│  │  • jsRuntimeConfiguratorDelegate: <span class="hljs-built_in">self</span> ← RCTJSRuntimeConfiguratorProtocol│
│  └───────────────────────────────────────────────────────────────────┘  │
│                                    │                                     │
│                                    ▼                                     │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ 初始化时设置:                                                       │  │
│  │  • thirdPartyFabricComponentsProvider = <span class="hljs-built_in">self</span>                       │  │
│  │    ← RCTComponentViewFactoryComponentProvider                      │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-3">RCTTurboModuleManagerDelegate</h4>
<p>主要负责 TurboModule 的类查找和实例创建，源码<code>react-native/packages/react-native/ReactCommon/react/nativemodule/core/platform/ios/ReactCommon/RCTTurboModuleManager.h</code>：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-class"><span class="hljs-keyword">@class</span> <span class="hljs-title">RCTBridgeProxy</span>;</span>
<span class="hljs-class"><span class="hljs-keyword">@class</span> <span class="hljs-title">RCTTurboModuleManager</span>;</span>
<span class="hljs-class"><span class="hljs-keyword">@class</span> <span class="hljs-title">RCTDevMenuConfigurationDecorator</span>;</span>

<span class="hljs-class"><span class="hljs-keyword">@protocol</span> <span class="hljs-title">RCTTurboModuleManagerDelegate</span> &lt;<span class="hljs-title">NSObject</span>&gt;</span>

<span class="hljs-comment">/**
 * 给定模块名称，返回其实际类。如果返回 nil，则执行基本的 ObjC 类查找
 */</span>
- (Class)getModuleClassFromName:(<span class="hljs-keyword">const</span> <span class="hljs-type">char</span> *)name;

<span class="hljs-comment">/**
 * 给定一个模块类，为其提供一个实例。如果返回值为 nil，则使用默认初始化器
 */</span>
- (<span class="hljs-type">id</span>&lt;RCTTurboModule&gt;)getModuleInstanceFromClass:(Class)moduleClass;

<span class="hljs-keyword">@optional</span>

<span class="hljs-comment">/**
 * 此方法用于获取一个工厂对象，该对象可以创建 `facebook::react::TurboModule` 实例。
 * 实现 `RCTTurboModuleProvider` 接口的类必须是 Objective-C 类，以便我们可以使用代码生成工具对其进行动态初始化。
 */</span>
- (<span class="hljs-type">id</span>&lt;RCTModuleProvider&gt;)getModuleProvider:(<span class="hljs-keyword">const</span> <span class="hljs-type">char</span> *)name;

<span class="hljs-comment">/**
 * 创建一个 TurboModule 实例，而无需依赖任何 ObjC++ 模块实例
 */</span>
- (std::shared_ptr&lt;facebook::react::TurboModule&gt;)getTurboModule:(<span class="hljs-keyword">const</span> std::string &amp;)name
                                                      jsInvoker:
                                                          (std::shared_ptr&lt;facebook::react::CallInvoker&gt;)jsInvoker;

- (<span class="hljs-type">void</span>)installJSBindings:(facebook::jsi::Runtime &amp;)runtime;

- (<span class="hljs-type">void</span>)invalidate;

<span class="hljs-keyword">@end</span>
</code></pre>
<p>再来看看<strong>RCTReactNativeFactory</strong> 中的实现：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark - RCTTurboModuleManagerDelegate</span>

- (Class)getModuleClassFromName:(<span class="hljs-keyword">const</span> <span class="hljs-type">char</span> *)name
{
<span class="hljs-meta">#<span class="hljs-keyword">if</span> RN_DISABLE_OSS_PLUGIN_HEADER</span>
  <span class="hljs-keyword">return</span> RCTTurboModulePluginClassProvider(name);
<span class="hljs-meta">#<span class="hljs-keyword">else</span></span>
  <span class="hljs-comment">// 先尝试从 delegate 获取</span>
  <span class="hljs-keyword">if</span> ([_delegate respondsToSelector:<span class="hljs-keyword">@selector</span>(getModuleClassFromName:)]) {
    Class moduleClass = [_delegate getModuleClassFromName:name];
    <span class="hljs-keyword">if</span> (moduleClass != <span class="hljs-literal">nil</span>) {
      <span class="hljs-keyword">return</span> moduleClass;
    }
  }
  <span class="hljs-keyword">return</span> RCTCoreModulesClassProvider(name);
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
}

- (<span class="hljs-keyword">nullable</span> <span class="hljs-type">id</span>&lt;RCTModuleProvider&gt;)getModuleProvider:(<span class="hljs-keyword">const</span> <span class="hljs-type">char</span> *)name
{
  <span class="hljs-keyword">if</span> ([_delegate respondsToSelector:<span class="hljs-keyword">@selector</span>(getModuleProvider:)]) {
    <span class="hljs-keyword">return</span> [_delegate getModuleProvider:name];
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;
}

<span class="hljs-comment">// 创建纯 C++ TurboModule</span>
- (std::shared_ptr&lt;facebook::react::TurboModule&gt;)getTurboModule:(<span class="hljs-keyword">const</span> std::string &amp;)name
                                                      jsInvoker:(std::shared_ptr&lt;facebook::react::CallInvoker&gt;)jsInvoker
{
  <span class="hljs-keyword">if</span> ([_delegate respondsToSelector:<span class="hljs-keyword">@selector</span>(getTurboModule:jsInvoker:)]) {
    <span class="hljs-keyword">return</span> [_delegate getTurboModule:name jsInvoker:jsInvoker];
  }

  <span class="hljs-keyword">return</span> facebook::react::DefaultTurboModules::getTurboModule(name, jsInvoker);
}

- (<span class="hljs-type">id</span>&lt;RCTTurboModule&gt;)getModuleInstanceFromClass:(Class)moduleClass
{
<span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_OSS_CODEGEN</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.delegate.dependencyProvider == <span class="hljs-literal">nil</span>) {
    [<span class="hljs-built_in">NSException</span> raise:<span class="hljs-string">@"ReactNativeFactoryDelegate dependencyProvider is nil"</span>
                format:<span class="hljs-string">@"Delegate must provide a valid dependencyProvider"</span>];
  }
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
  <span class="hljs-keyword">if</span> ([_delegate respondsToSelector:<span class="hljs-keyword">@selector</span>(getModuleInstanceFromClass:)]) {
    <span class="hljs-type">id</span>&lt;RCTTurboModule&gt; moduleInstance = [_delegate getModuleInstanceFromClass:moduleClass];
    <span class="hljs-keyword">if</span> (moduleInstance != <span class="hljs-literal">nil</span>) {
      <span class="hljs-keyword">return</span> moduleInstance;
    }
  }
  <span class="hljs-comment">// 使用默认方式创建（通过 dependencyProvider）</span>
  <span class="hljs-keyword">return</span> RCTAppSetupDefaultModuleFromClass(moduleClass, <span class="hljs-keyword">self</span>.delegate.dependencyProvider);
}
</code></pre>
<h4 data-id="heading-4">RCTHostDelegate</h4>
<p>主要负责 RCTHost 的生命周期和 Bundle 加载。源码<code>react-native/packages/react-native/ReactCommon/react/runtime/platform/ios/ReactCommon/RCTHost.h</code>：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-built_in">NS_ASSUME_NONNULL_BEGIN</span>

<span class="hljs-class"><span class="hljs-keyword">@class</span> <span class="hljs-title">RCTFabricSurface</span>;</span>
<span class="hljs-class"><span class="hljs-keyword">@class</span> <span class="hljs-title">RCTHost</span>;</span>
<span class="hljs-class"><span class="hljs-keyword">@class</span> <span class="hljs-title">RCTModuleRegistry</span>;</span>
<span class="hljs-class"><span class="hljs-keyword">@class</span> <span class="hljs-title">RCTDevMenuConfiguration</span>;</span>

<span class="hljs-class"><span class="hljs-keyword">@protocol</span> <span class="hljs-title">RCTTurboModuleManagerDelegate</span>;</span>

<span class="hljs-keyword">typedef</span> <span class="hljs-built_in">NSURL</span> *_Nullable (^RCTHostBundleURLProvider)(<span class="hljs-type">void</span>);

<span class="hljs-comment">// Runtime API</span>

<span class="hljs-class"><span class="hljs-keyword">@protocol</span> <span class="hljs-title">RCTHostDelegate</span> &lt;<span class="hljs-title">NSObject</span>&gt;</span>
<span class="hljs-comment">// Host 启动完成通知</span>
- (<span class="hljs-type">void</span>)hostDidStart:(RCTHost *)host;

<span class="hljs-keyword">@optional</span>
<span class="hljs-comment">// 需要在主线程初始化的模块列表</span>
- (<span class="hljs-built_in">NSArray</span>&lt;<span class="hljs-built_in">NSString</span> *&gt; *)unstableModulesRequiringMainQueueSetup;

<span class="hljs-comment">// 加载 Bundle（支持进度回调）</span>
- (<span class="hljs-type">void</span>)loadBundleAtURL:(<span class="hljs-built_in">NSURL</span> *)sourceURL
             onProgress:(RCTSourceLoadProgressBlock)onProgress
             onComplete:(RCTSourceLoadBlock)loadCallback;

<span class="hljs-keyword">@end</span>


<span class="hljs-built_in">NS_ASSUME_NONNULL_END</span>
</code></pre>
<p>查看<strong>RCTReactNativeFactory</strong> 中的实现：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark - RCTHostDelegate</span>

- (<span class="hljs-type">void</span>)hostDidStart:(RCTHost *)host
{
  <span class="hljs-keyword">if</span> ([_delegate respondsToSelector:<span class="hljs-keyword">@selector</span>(hostDidStart:)]) {
    [_delegate hostDidStart:host];
  }
}

- (<span class="hljs-built_in">NSArray</span>&lt;<span class="hljs-built_in">NSString</span> *&gt; *)unstableModulesRequiringMainQueueSetup
{
<span class="hljs-meta">#<span class="hljs-keyword">if</span> RN_DISABLE_OSS_PLUGIN_HEADER</span>
  <span class="hljs-keyword">return</span> RCTTurboModulePluginUnstableModulesRequiringMainQueueSetup();
<span class="hljs-meta">#<span class="hljs-keyword">else</span></span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.delegate.dependencyProvider
      ? RCTAppSetupUnstableModulesRequiringMainQueueSetup(<span class="hljs-keyword">self</span>.delegate.dependencyProvider)
      : @[];
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
}
</code></pre>
<h4 data-id="heading-5">RCTJSRuntimeConfiguratorProtocol</h4>
<p>主要负责创建 JS Runtime 工厂，源码<code>react-native/packages/react-native/Libraries/AppDelegate/RCTJSRuntimeConfiguratorProtocol.h</code>：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-built_in">NS_ASSUME_NONNULL_BEGIN</span>

<span class="hljs-comment">// Forward declarations for umbrella headers.</span>
<span class="hljs-comment">// In implementations, import `&lt;react/runtime/JSRuntimeFactoryCAPI.h&gt;` to obtain the actual type.</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-type">void</span> *JSRuntimeFactoryRef;

<span class="hljs-class"><span class="hljs-keyword">@protocol</span> <span class="hljs-title">RCTJSRuntimeConfiguratorProtocol</span></span>

<span class="hljs-comment">// 创建 JS Runtime 工厂（通常返回 Hermes）</span>
- (JSRuntimeFactoryRef)createJSRuntimeFactory;

<span class="hljs-keyword">@end</span>

<span class="hljs-built_in">NS_ASSUME_NONNULL_END</span>
</code></pre>
<p>查看<strong>RCTReactNativeFactory</strong> 中的实现：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark - RCTJSRuntimeConfiguratorProtocol</span>

- (JSRuntimeFactoryRef)createJSRuntimeFactory
{
  <span class="hljs-comment">// 委托给用户的 delegate</span>
  <span class="hljs-keyword">return</span> [_delegate createJSRuntimeFactory];
}
</code></pre>
<h4 data-id="heading-6">RCTComponentViewFactoryComponentProvider</h4>
<p>主要负责提供第三方 Fabric 组件，源码<code>react-native/packages/react-native/React/Fabric/Mounting/RCTComponentViewFactory.h</code>：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">/**
 * 可用于向 Fabric 提供第三方组件的协议。
 * Fabric 将检查此映射表，以确定是否存在需要注册的组件。
 */</span>
<span class="hljs-class"><span class="hljs-keyword">@protocol</span> <span class="hljs-title">RCTComponentViewFactoryComponentProvider</span> &lt;<span class="hljs-title">NSObject</span>&gt;</span>

<span class="hljs-comment">/**
 * 返回一个第三方组件字典，其中 `key` 是组件处理程序，`value` 是一个符合 `RCTComponentViewProtocol` 协议的类
 */</span>
- (<span class="hljs-built_in">NSDictionary</span>&lt;<span class="hljs-built_in">NSString</span> *, Class&lt;RCTComponentViewProtocol&gt;&gt; *)thirdPartyFabricComponents;

<span class="hljs-keyword">@end</span>
</code></pre>
<p>查看<strong>RCTReactNativeFactory</strong> 中的实现：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark - RCTComponentViewFactoryComponentProvider</span>

- (<span class="hljs-built_in">NSDictionary</span>&lt;<span class="hljs-built_in">NSString</span> *, Class&lt;RCTComponentViewProtocol&gt;&gt; *)thirdPartyFabricComponents
{
  <span class="hljs-comment">// 先尝试从 delegate 获取</span>
  <span class="hljs-keyword">if</span> ([_delegate respondsToSelector:<span class="hljs-keyword">@selector</span>(thirdPartyFabricComponents)]) {
    <span class="hljs-keyword">return</span> _delegate.thirdPartyFabricComponents;
  }
  <span class="hljs-comment">// 回退到 dependencyProvider（Codegen 生成）</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.delegate.dependencyProvider ? <span class="hljs-keyword">self</span>.delegate.dependencyProvider.thirdPartyFabricComponents : @{};
}
</code></pre>
<h4 data-id="heading-7">RCTDefaultReactNativeFactoryDelegate</h4>
<p>以上协的很多方法的实现，其实也是代理给<strong>RCTReactNativeFactory</strong> 中的<code>delegate</code>对象。此<code>delegate</code>也就是我们最开始自定义的<code>ReactNativeDelegate</code>实例。其也是继承自<code>RCTDefaultReactNativeFactoryDelegate</code>，现在分析一下此类的实现，源码<code>react-native/packages/react-native/Libraries/AppDelegate/RCTDefaultReactNativeFactoryDelegate.mm</code>：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">RCTDefaultReactNativeFactoryDelegate</span></span>

<span class="hljs-keyword">@synthesize</span> dependencyProvider;
<span class="hljs-comment">// 抽象方法：子类必须实现</span>
- (<span class="hljs-built_in">NSURL</span> *_Nullable)sourceURLForBridge:(<span class="hljs-keyword">nonnull</span> RCTBridge *)bridge
{
  [<span class="hljs-built_in">NSException</span> raise:<span class="hljs-string">@"RCTBridgeDelegate::sourceURLForBridge not implemented"</span>
              format:<span class="hljs-string">@"Subclasses must implement a valid sourceURLForBridge method"</span>];
  <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;
}

- (<span class="hljs-built_in">UIViewController</span> *)createRootViewController
{
  <span class="hljs-keyword">return</span> [<span class="hljs-built_in">UIViewController</span> new];
}

- (<span class="hljs-type">void</span>)setRootView:(<span class="hljs-built_in">UIView</span> *)rootView toRootViewController:(<span class="hljs-built_in">UIViewController</span> *)rootViewController
{
  rootViewController.view = rootView;
}

- (JSRuntimeFactoryRef)createJSRuntimeFactory
{
<span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_THIRD_PARTY_JSC != 1</span>
  <span class="hljs-keyword">return</span> jsrt_create_hermes_factory();
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
}

- (<span class="hljs-type">void</span>)customizeRootView:(RCTRootView *)rootView
{
  <span class="hljs-comment">// Override point for customization after application launch.</span>
}

- (RCTColorSpace)defaultColorSpace
{
  <span class="hljs-keyword">return</span> RCTColorSpaceSRGB;
}

- (<span class="hljs-built_in">NSURL</span> *_Nullable)bundleURL
{
  [<span class="hljs-built_in">NSException</span> raise:<span class="hljs-string">@"RCTAppDelegate::bundleURL not implemented"</span>
              format:<span class="hljs-string">@"Subclasses must implement a valid getBundleURL method"</span>];
  <span class="hljs-keyword">return</span> nullptr;
}

- (<span class="hljs-built_in">NSDictionary</span>&lt;<span class="hljs-built_in">NSString</span> *, Class&lt;RCTComponentViewProtocol&gt;&gt; *)thirdPartyFabricComponents
{
  <span class="hljs-keyword">return</span> (<span class="hljs-keyword">self</span>.dependencyProvider != nullptr) ? <span class="hljs-keyword">self</span>.dependencyProvider.thirdPartyFabricComponents : @{};
}

- (<span class="hljs-type">void</span>)hostDidStart:(RCTHost *)host
{
}

- (<span class="hljs-built_in">NSArray</span>&lt;<span class="hljs-built_in">NSString</span> *&gt; *)unstableModulesRequiringMainQueueSetup
{
  <span class="hljs-keyword">return</span> (<span class="hljs-keyword">self</span>.dependencyProvider != nullptr)
      ? RCTAppSetupUnstableModulesRequiringMainQueueSetup(<span class="hljs-keyword">self</span>.dependencyProvider)
      : @[];
}

- (<span class="hljs-keyword">nullable</span> <span class="hljs-type">id</span>&lt;RCTModuleProvider&gt;)getModuleProvider:(<span class="hljs-keyword">const</span> <span class="hljs-type">char</span> *)name
{
  <span class="hljs-built_in">NSString</span> *providerName = [<span class="hljs-built_in">NSString</span> stringWithCString:name encoding:<span class="hljs-built_in">NSUTF8StringEncoding</span>];
  <span class="hljs-keyword">return</span> (<span class="hljs-keyword">self</span>.dependencyProvider != nullptr) ? <span class="hljs-keyword">self</span>.dependencyProvider.moduleProviders[providerName] : nullptr;
}

- (std::shared_ptr&lt;facebook::react::TurboModule&gt;)getTurboModule:(<span class="hljs-keyword">const</span> std::string &amp;)name
                                                      jsInvoker:(std::shared_ptr&lt;facebook::react::CallInvoker&gt;)jsInvoker
{
  <span class="hljs-keyword">return</span> facebook::react::DefaultTurboModules::getTurboModule(name, jsInvoker);
}

<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark - RCTArchConfiguratorProtocol</span>

- (<span class="hljs-type">BOOL</span>)newArchEnabled
{
  <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;
}

- (<span class="hljs-type">BOOL</span>)bridgelessEnabled
{
  <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;
}

- (<span class="hljs-type">BOOL</span>)fabricEnabled
{
  <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;
}

- (<span class="hljs-type">BOOL</span>)turboModuleEnabled
{
  <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;
}

- (Class)getModuleClassFromName:(<span class="hljs-keyword">const</span> <span class="hljs-type">char</span> *)name
{
  <span class="hljs-keyword">return</span> nullptr;
}

- (<span class="hljs-type">id</span>&lt;RCTTurboModule&gt;)getModuleInstanceFromClass:(Class)moduleClass
{
  <span class="hljs-keyword">return</span> nullptr;
}

- (<span class="hljs-type">void</span>)loadSourceForBridge:(RCTBridge *)bridge
                 onProgress:(RCTSourceLoadProgressBlock)onProgress
                 onComplete:(RCTSourceLoadBlock)loadCallback
{
  [RCTJavaScriptLoader loadBundleAtURL:[<span class="hljs-keyword">self</span> sourceURLForBridge:bridge] onProgress:onProgress onComplete:loadCallback];
}

<span class="hljs-keyword">@end</span>
</code></pre>
<h4 data-id="heading-8">React Native 启动</h4>
<p>对于以上四个协议以及代理，我们已经有了大概认识，现在应该把视线拉回<strong>AppDelegate</strong>中的初始化流程，继续分析<code>startReactNative</code>方法的实现，它对应的OC方法名应该是<code>startReactNativeWithModuleName</code>：</p>
<pre><code class="hljs language-objc" lang="objc">- (<span class="hljs-type">void</span>)startReactNativeWithModuleName:(<span class="hljs-built_in">NSString</span> *)moduleName
                              inWindow:(<span class="hljs-built_in">UIWindow</span> *_Nullable)window
                         launchOptions:(<span class="hljs-built_in">NSDictionary</span> *_Nullable)launchOptions
{
  [<span class="hljs-keyword">self</span> startReactNativeWithModuleName:moduleName inWindow:window initialProperties:<span class="hljs-literal">nil</span> launchOptions:launchOptions];
}

- (<span class="hljs-type">void</span>)startReactNativeWithModuleName:(<span class="hljs-built_in">NSString</span> *)moduleName
                              inWindow:(<span class="hljs-built_in">UIWindow</span> *_Nullable)window
                     initialProperties:(<span class="hljs-built_in">NSDictionary</span> *_Nullable)initialProperties
                         launchOptions:(<span class="hljs-built_in">NSDictionary</span> *_Nullable)launchOptions
{
  <span class="hljs-comment">// 1. 通过 RootViewFactory 创建根视图</span>
  <span class="hljs-built_in">UIView</span> *rootView = [<span class="hljs-keyword">self</span>.rootViewFactory viewWithModuleName:moduleName
                                            initialProperties:initialProperties
                                                launchOptions:launchOptions
                                         devMenuConfiguration:<span class="hljs-keyword">self</span>.devMenuConfiguration];
  <span class="hljs-comment">// 2. 创建 RootViewController</span>
  <span class="hljs-built_in">UIViewController</span> *rootViewController = [_delegate createRootViewController];
  <span class="hljs-comment">// 3. 设置根视图</span>
  [_delegate setRootView:rootView toRootViewController:rootViewController];
  <span class="hljs-comment">// 4. 配置窗口并显示</span>
  window.rootViewController = rootViewController;
  [window makeKeyAndVisible];
}
</code></pre>
<p>可以看到，流程十分清楚，我们继续跟踪<code>viewWithModuleName</code>方法实现。</p>
<h5 data-id="heading-9">RCTHost  (ReactHost)初始化</h5>
<p>查看源码<code>react-native/packages/react-native/Libraries/AppDelegate/RCTRootViewFactory.mm</code>：</p>
<pre><code class="hljs language-objc" lang="objc">- (<span class="hljs-built_in">UIView</span> *)viewWithModuleName:(<span class="hljs-built_in">NSString</span> *)moduleName
             initialProperties:(<span class="hljs-built_in">NSDictionary</span> *)initProps
                 launchOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions
          devMenuConfiguration:(RCTDevMenuConfiguration *)devMenuConfiguration
{
  <span class="hljs-comment">// 1. 初始化 ReactHost</span>
  [<span class="hljs-keyword">self</span> initializeReactHostWithLaunchOptions:launchOptions devMenuConfiguration:devMenuConfiguration];

  <span class="hljs-comment">// 2. 创建 Fabric Surface</span>
  RCTFabricSurface *surface = [<span class="hljs-keyword">self</span>.reactHost createSurfaceWithModuleName:moduleName
                                                        initialProperties:initProps ? initProps : @{}];
   <span class="hljs-comment">// 3. 创建 SurfaceHostingProxyRootView</span>
  RCTSurfaceHostingProxyRootView *surfaceHostingProxyRootView =
      [[RCTSurfaceHostingProxyRootView alloc] initWithSurface:surface];

  surfaceHostingProxyRootView.backgroundColor = [<span class="hljs-built_in">UIColor</span> systemBackgroundColor];
  <span class="hljs-keyword">if</span> (_configuration.customizeRootView != <span class="hljs-literal">nil</span>) {
    <span class="hljs-comment">// 4. 自定义根视图</span>
    _configuration.customizeRootView(surfaceHostingProxyRootView);
  }
  <span class="hljs-keyword">return</span> surfaceHostingProxyRootView;
}


- (<span class="hljs-type">void</span>)initializeReactHostWithLaunchOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions
                        devMenuConfiguration:(RCTDevMenuConfiguration *)devMenuConfiguration
{
  <span class="hljs-comment">// Enable TurboModule interop by default in Bridgeless mode</span>
  RCTEnableTurboModuleInterop(<span class="hljs-literal">YES</span>);
  RCTEnableTurboModuleInteropBridgeProxy(<span class="hljs-literal">YES</span>);

  [<span class="hljs-keyword">self</span> createReactHostIfNeeded:launchOptions devMenuConfiguration:devMenuConfiguration];
  <span class="hljs-keyword">return</span>;
}

- (<span class="hljs-type">void</span>)createReactHostIfNeeded:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions
           devMenuConfiguration:(RCTDevMenuConfiguration *)devMenuConfiguration
{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.reactHost) {
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">self</span>.reactHost = [<span class="hljs-keyword">self</span> createReactHost:launchOptions devMenuConfiguration:devMenuConfiguration];
}


- (RCTHost *)createReactHost:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions
        devMenuConfiguration:(RCTDevMenuConfiguration *)devMenuConfiguration
{
  __<span class="hljs-keyword">weak</span> __<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) weakSelf = <span class="hljs-keyword">self</span>;
  RCTHost *reactHost =
      [[RCTHost alloc] initWithBundleURLProvider:<span class="hljs-keyword">self</span>-&gt;_configuration.bundleURLBlock
                                    hostDelegate:_hostDelegate
                      turboModuleManagerDelegate:_turboModuleManagerDelegate
                                jsEngineProvider:^std::shared_ptr&lt;facebook::react::JSRuntimeFactory&gt;() {
                                  <span class="hljs-keyword">return</span> [weakSelf createJSRuntimeFactory];
                                }
                                   launchOptions:launchOptions
                            devMenuConfiguration:devMenuConfiguration];
  <span class="hljs-comment">// 设置 Bundle URL 提供者</span>
  [reactHost setBundleURLProvider:^<span class="hljs-built_in">NSURL</span> *() {
    <span class="hljs-keyword">return</span> [weakSelf bundleURL];
  }];
  <span class="hljs-comment">// 启动 ReactHost</span>
  [reactHost start];
  <span class="hljs-keyword">return</span> reactHost;
}
</code></pre>
<h5 data-id="heading-10">RCTInstance 初始化</h5>
<p>继续跟踪<code>RCTHost</code>的<code>start</code>方法。源码<code>react-native/packages/react-native/ReactCommon/react/runtime/platform/ios/ReactCommon/RCTHost.mm</code>：</p>
<pre><code class="hljs language-objc" lang="objc">- (<span class="hljs-type">void</span>)start
{
  <span class="hljs-comment">// 1. 设置 Bundle URL</span>
  <span class="hljs-keyword">if</span> (_bundleURLProvider) {
    [<span class="hljs-keyword">self</span> _setBundleURL:_bundleURLProvider()];
  }

  <span class="hljs-comment">// 2. 设置 Inspector Target（用于调试）</span>
  auto &amp;inspectorFlags = jsinspector_modern::InspectorFlags::getInstance();
  <span class="hljs-keyword">if</span> (inspectorFlags.getFuseboxEnabled() &amp;&amp; !_inspectorPageId.has_value()) {
    _inspectorTarget =
        facebook::react::jsinspector_modern::HostTarget::create(*_inspectorHostDelegate, [](auto callback) {
          RCTExecuteOnMainQueue(^{
            callback();
          });
        });
    __<span class="hljs-keyword">weak</span> RCTHost *weakSelf = <span class="hljs-keyword">self</span>;
    _inspectorPageId = facebook::react::jsinspector_modern::getInspectorInstance().addPage(
        <span class="hljs-string">"React Native Bridgeless"</span>,
        <span class="hljs-comment">/* vm */</span> <span class="hljs-string">""</span>,
        [weakSelf](std::unique_ptr&lt;facebook::react::jsinspector_modern::IRemoteConnection&gt; remote)
            -&gt; std::unique_ptr&lt;facebook::react::jsinspector_modern::ILocalConnection&gt; {
          RCTHost *strongSelf = weakSelf;
          <span class="hljs-keyword">if</span> (!strongSelf) {
            <span class="hljs-comment">// This can happen if we're about to be dealloc'd. Reject the connection.</span>
            <span class="hljs-keyword">return</span> nullptr;
          }
          <span class="hljs-keyword">return</span> strongSelf-&gt;_inspectorTarget-&gt;connect(std::move(remote));
        },
        {.nativePageReloads = <span class="hljs-literal">true</span>, .prefersFuseboxFrontend = <span class="hljs-literal">true</span>});
  }
  <span class="hljs-keyword">if</span> (_instance) {
    RCTLogWarn(
        <span class="hljs-string">@"RCTHost should not be creating a new instance if one already exists. This implies there is a bug with how/when this method is being called."</span>);
    [_instance invalidate];
  }

  <span class="hljs-comment">// 3. 创建 RCTInstance</span>
  _instance = [[RCTInstance alloc] initWithDelegate:<span class="hljs-keyword">self</span>
                                   jsRuntimeFactory:[<span class="hljs-keyword">self</span> _provideJSEngine]
                                      bundleManager:_bundleManager
                         turboModuleManagerDelegate:_turboModuleManagerDelegate
                                     moduleRegistry:_moduleRegistry
                              parentInspectorTarget:_inspectorTarget.get()
                                      launchOptions:_launchOptions
                               devMenuConfiguration:_devMenuConfiguration];
  <span class="hljs-comment">// 4. 通知代理 Host 已启动</span>
  [_hostDelegate hostDidStart:<span class="hljs-keyword">self</span>];
}
</code></pre>
<p>继续查看<code>RCTInstance</code>的构造实现，源码<code>react-native/packages/react-native/ReactCommon/react/runtime/platform/ios/ReactCommon/RCTInstance.mm</code>：</p>
<pre><code class="hljs language-objc" lang="objc">- (<span class="hljs-keyword">instancetype</span>)initWithDelegate:(<span class="hljs-type">id</span>&lt;RCTInstanceDelegate&gt;)delegate
                jsRuntimeFactory:(std::shared_ptr&lt;facebook::react::JSRuntimeFactory&gt;)jsRuntimeFactory
                   bundleManager:(RCTBundleManager *)bundleManager
      turboModuleManagerDelegate:(<span class="hljs-type">id</span>&lt;RCTTurboModuleManagerDelegate&gt;)tmmDelegate
                  moduleRegistry:(RCTModuleRegistry *)moduleRegistry
           parentInspectorTarget:(jsinspector_modern::HostTarget *)parentInspectorTarget
                   launchOptions:(<span class="hljs-keyword">nullable</span> <span class="hljs-built_in">NSDictionary</span> *)launchOptions
            devMenuConfiguration:(RCTDevMenuConfiguration *)devMenuConfiguration
{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span> = [<span class="hljs-variable language_">super</span> init]) {
    <span class="hljs-comment">// 性能监控初始化</span>
    _performanceLogger = [RCTPerformanceLogger new];
    registerPerformanceLoggerHooks(_performanceLogger);
    [_performanceLogger markStartForTag:RCTPLReactInstanceInit];

    <span class="hljs-comment">// 保存外部传入的关键依赖</span>
    _delegate = delegate;
    _jsRuntimeFactory = jsRuntimeFactory;
    _appTMMDelegate = tmmDelegate;
    _jsThreadManager = [RCTJSThreadManager new];

    <span class="hljs-comment">// 开发菜单配置</span>
    _devMenuConfigurationDecorator =
<span class="hljs-meta">#<span class="hljs-keyword">if</span> RCT_DEV_MENU</span>
        [[RCTDevMenuConfigurationDecorator alloc] initWithDevMenuConfiguration:devMenuConfiguration];
<span class="hljs-meta">#<span class="hljs-keyword">else</span></span>
        <span class="hljs-literal">nil</span>;
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

    _parentInspectorTarget = parentInspectorTarget;

    <span class="hljs-comment">// JS 模块调用器配置(设置 Bridgeless 模式下的 JS 模块方法调用器)</span>
    {
      __<span class="hljs-keyword">weak</span> __<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) weakSelf = <span class="hljs-keyword">self</span>;
      [_bridgeModuleDecorator.callableJSModules
          setBridgelessJSModuleMethodInvoker:^(
              <span class="hljs-built_in">NSString</span> *moduleName, <span class="hljs-built_in">NSString</span> *methodName, <span class="hljs-built_in">NSArray</span> *args, dispatch_block_t onComplete) {
            [weakSelf callFunctionOnJSModule:moduleName method:methodName args:args];
            <span class="hljs-keyword">if</span> (onComplete) {
              [weakSelf
                  callFunctionOnBufferedRuntimeExecutor:[onComplete](facebook::jsi::Runtime &amp;_) { onComplete(); }];
            }
          }];
    }
    _launchOptions = launchOptions;

    <span class="hljs-comment">// 内存警告监听</span>
    [[<span class="hljs-built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="hljs-keyword">self</span>
                                             selector:<span class="hljs-keyword">@selector</span>(_handleMemoryWarning)
                                                 name:<span class="hljs-built_in">UIApplicationDidReceiveMemoryWarningNotification</span>
                                               object:<span class="hljs-literal">nil</span>];
    <span class="hljs-comment">// 启动核心初始化</span>
    [<span class="hljs-keyword">self</span> _start];
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;
}
</code></pre>
<p>接下来，我们来看整个初始化过程的核心方法<code>_start</code>实现：</p>
<pre><code class="hljs language-objc" lang="objc">- (<span class="hljs-type">void</span>)_start
{
  <span class="hljs-comment">// 1.设置定时器系统</span>
  auto objCTimerRegistry = std::make_unique&lt;ObjCTimerRegistry&gt;();
  auto timing = objCTimerRegistry-&gt;timing;
  auto *objCTimerRegistryRawPtr = objCTimerRegistry.get();

  auto timerManager = std::make_shared&lt;TimerManager&gt;(std::move(objCTimerRegistry));
  objCTimerRegistryRawPtr-&gt;setTimerManager(timerManager);

  __<span class="hljs-keyword">weak</span> __<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) weakSelf = <span class="hljs-keyword">self</span>;
  auto onJsError = [=](jsi::Runtime &amp;runtime, <span class="hljs-keyword">const</span> JsErrorHandler::ProcessedError &amp;error) {
    [weakSelf _handleJSError:error withRuntime:runtime];
  };

  <span class="hljs-comment">// 2.创建 ReactInstance (C++ 层)</span>
  _reactInstance = std::make_unique&lt;ReactInstance&gt;(
      _jsRuntimeFactory-&gt;createJSRuntime(_jsThreadManager.jsMessageThread),
      _jsThreadManager.jsMessageThread,
      timerManager,
      onJsError,
      _parentInspectorTarget);
  _valid = <span class="hljs-literal">true</span>;

  <span class="hljs-comment">// 3.设置 RuntimeExecutor</span>
  RuntimeExecutor bufferedRuntimeExecutor = _reactInstance-&gt;getBufferedRuntimeExecutor();
  timerManager-&gt;setRuntimeExecutor(bufferedRuntimeExecutor);

  auto jsCallInvoker = make_shared&lt;RuntimeSchedulerCallInvoker&gt;(_reactInstance-&gt;getRuntimeScheduler());
  <span class="hljs-comment">// 省略旧架构......</span>

  <span class="hljs-comment">// 4.创建 TurboModuleManager</span>
  _turboModuleManager = [[RCTTurboModuleManager alloc] initWithBridgeProxy:bridgeProxy
                                                     bridgeModuleDecorator:_bridgeModuleDecorator
                                                                  delegate:<span class="hljs-keyword">self</span>
                                                                 jsInvoker:jsCallInvoker
                                             devMenuConfigurationDecorator:_devMenuConfigurationDecorator];

<span class="hljs-meta">#<span class="hljs-keyword">if</span> RCT_DEV</span>
  <span class="hljs-comment">/**
    * 实例化 DevMenu 会产生副作用，即通过 RCTDevMenu 注册
    * CMD + d、CMD + i 和 CMD + n 的快捷键。 
    * 因此，启用 TurboModules 时，我们必须手动创建此NativeModule。
   */</span>
  [_turboModuleManager moduleForName:<span class="hljs-string">"RCTDevMenu"</span>];
<span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">// end RCT_DEV</span></span>

  <span class="hljs-comment">// 初始化 RCTModuleRegistry，以便 TurboModules 可以引用其他 TurboModules</span>
  [_bridgeModuleDecorator.moduleRegistry setTurboModuleRegistry:_turboModuleManager];

  <span class="hljs-keyword">if</span> (ReactNativeFeatureFlags::enableEagerMainQueueModulesOnIOS()) {
    <span class="hljs-comment">/**
     * 某些原生模块需要在主线程上捕获 UIKit 对象。
     * 因此，请在此处的主队列上开始初始化这些模块。JavaScript 线程将等待这些模块初始化完成后，才会执行 JavaScript 代码包。
     */</span>
    <span class="hljs-built_in">NSArray</span>&lt;<span class="hljs-built_in">NSString</span> *&gt; *modulesRequiringMainQueueSetup = [_delegate unstableModulesRequiringMainQueueSetup];

    std::shared_ptr&lt;std::mutex&gt; mutex = std::make_shared&lt;std::mutex&gt;();
    std::shared_ptr&lt;std::condition_variable&gt; cv = std::make_shared&lt;std::condition_variable&gt;();
    std::shared_ptr&lt;<span class="hljs-type">bool</span>&gt; isReady = std::make_shared&lt;<span class="hljs-type">bool</span>&gt;(<span class="hljs-literal">false</span>);

    _waitUntilModuleSetupComplete = ^{
      std::unique_lock&lt;std::mutex&gt; lock(*mutex);
      cv-&gt;wait(lock, [isReady] { <span class="hljs-keyword">return</span> *isReady; });
    };

    <span class="hljs-comment">// TODO(T218039767): 将性能日志记录功能集成到主队列模块初始化过程中</span>
    RCTExecuteOnMainQueue(^{
      <span class="hljs-keyword">for</span> (<span class="hljs-built_in">NSString</span> *moduleName <span class="hljs-keyword">in</span> modulesRequiringMainQueueSetup) {
        [<span class="hljs-keyword">self</span>-&gt;_bridgeModuleDecorator.moduleRegistry moduleForName:[moduleName UTF8String]];
      }

      RCTScreenSize();
      RCTScreenScale();
      RCTSwitchSize();

      std::lock_guard&lt;std::mutex&gt; lock(*mutex);
      *isReady = <span class="hljs-literal">true</span>;
      cv-&gt;notify_all();
    });
  }

  RCTLogSetBridgelessModuleRegistry(_bridgeModuleDecorator.moduleRegistry);
  RCTLogSetBridgelessCallableJSModules(_bridgeModuleDecorator.callableJSModules);

  <span class="hljs-comment">// 5.创建 ContextContainer</span>
  auto contextContainer = std::make_shared&lt;ContextContainer&gt;();
  [_delegate didCreateContextContainer:contextContainer];
  <span class="hljs-comment">// 插入核心模块</span>
  contextContainer-&gt;insert(
      <span class="hljs-string">"RCTImageLoader"</span>, facebook::react::wrapManagedObject([_turboModuleManager moduleForName:<span class="hljs-string">"RCTImageLoader"</span>]));
  contextContainer-&gt;insert(
      <span class="hljs-string">"RCTEventDispatcher"</span>,
      facebook::react::wrapManagedObject([_turboModuleManager moduleForName:<span class="hljs-string">"RCTEventDispatcher"</span>]));
  contextContainer-&gt;insert(<span class="hljs-string">"RCTBridgeModuleDecorator"</span>, facebook::react::wrapManagedObject(_bridgeModuleDecorator));
  contextContainer-&gt;insert(RuntimeSchedulerKey, std::weak_ptr&lt;RuntimeScheduler&gt;(_reactInstance-&gt;getRuntimeScheduler()));
  contextContainer-&gt;insert(<span class="hljs-string">"RCTBridgeProxy"</span>, facebook::react::wrapManagedObject(bridgeProxy));

  <span class="hljs-comment">// 6.创建 SurfacePresenter</span>
  _surfacePresenter = [[RCTSurfacePresenter alloc]
        initWithContextContainer:contextContainer
                 runtimeExecutor:bufferedRuntimeExecutor
      bridgelessBindingsExecutor:std::optional(_reactInstance-&gt;getUnbufferedRuntimeExecutor())];

  <span class="hljs-comment">// 这使得模块中的 RCTViewRegistry 能够通过其 viewForReactTag 方法返回 UIView 对象</span>
  __<span class="hljs-keyword">weak</span> RCTSurfacePresenter *weakSurfacePresenter = _surfacePresenter;
  [_bridgeModuleDecorator.viewRegistry_DEPRECATED setBridgelessComponentViewProvider:^<span class="hljs-built_in">UIView</span> *(<span class="hljs-built_in">NSNumber</span> *reactTag) {
    RCTSurfacePresenter *strongSurfacePresenter = weakSurfacePresenter;
    <span class="hljs-keyword">if</span> (strongSurfacePresenter == <span class="hljs-literal">nil</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;
    }

    <span class="hljs-keyword">return</span> [strongSurfacePresenter findComponentViewWithTag_DO_NOT_USE_DEPRECATED:reactTag.integerValue];
  }];

  <span class="hljs-comment">// 7.创建DisplayLink （用于调用计时器回调函数）</span>
  _displayLink = [RCTDisplayLink new];

  auto &amp;inspectorFlags = jsinspector_modern::InspectorFlags::getInstance();

  ReactInstance::JSRuntimeFlags options = {
      .isProfiling = inspectorFlags.getIsProfilingBuild(),
      .runtimeDiagnosticFlags = [RCTInstanceRuntimeDiagnosticFlags() UTF8String]};

  <span class="hljs-comment">// 8.初始化 JS Runtime 并加载 Bundle</span>
  _reactInstance-&gt;initializeRuntime(options, [=](jsi::Runtime &amp;runtime) {
    __<span class="hljs-keyword">strong</span> __<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) strongSelf = weakSelf;
    <span class="hljs-keyword">if</span> (!strongSelf) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 安装 TurboModule JS 绑定</span>
    [strongSelf-&gt;_turboModuleManager installJSBindings:runtime];
    <span class="hljs-comment">// 绑定 Native Logger</span>
    facebook::react::bindNativeLogger(runtime, [](<span class="hljs-keyword">const</span> std::string &amp;message, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> logLevel) {
      _RCTLogJavaScriptInternal(static_cast&lt;RCTLogLevel&gt;(logLevel), [<span class="hljs-built_in">NSString</span> stringWithUTF8String:message.c_str()]);
    });

    <span class="hljs-comment">// 安装 Native Component Registry 绑定</span>
    RCTInstallNativeComponentRegistryBinding(runtime);

    <span class="hljs-comment">// 通知代理 Runtime 已初始化</span>
    [strongSelf-&gt;_delegate instance:strongSelf didInitializeRuntime:runtime];

    <span class="hljs-comment">// 设置 DisplayLink</span>
    <span class="hljs-type">id</span>&lt;RCTDisplayLinkModuleHolder&gt; moduleHolder = [[RCTBridgelessDisplayLinkModuleHolder alloc] initWithModule:timing];
    [strongSelf-&gt;_displayLink registerModuleForFrameUpdates:timing withModuleHolder:moduleHolder];
    [strongSelf-&gt;_displayLink addToRunLoop:[<span class="hljs-built_in">NSRunLoop</span> currentRunLoop]];

    <span class="hljs-comment">// 尝试同步加载bundle包，如果失败则回退到异步加载。</span>
    [strongSelf-&gt;_performanceLogger markStartForTag:RCTPLScriptDownload];
    [strongSelf _loadJSBundle:[strongSelf-&gt;_bridgeModuleDecorator.bundleManager bundleURL]];
  });

  [_performanceLogger markStopForTag:RCTPLReactInstanceInit];
}
</code></pre>
<h5 data-id="heading-11">JS Bundle 加载</h5>
<p>继续查看<code>_loadJSBundle</code>方法的实现：</p>
<pre><code class="hljs language-objc" lang="objc">- (<span class="hljs-type">void</span>)_loadJSBundle:(<span class="hljs-built_in">NSURL</span> *)sourceURL
{
<span class="hljs-meta">#<span class="hljs-keyword">if</span> RCT_DEV_MENU &amp;&amp; __has_include(<span class="hljs-string">&lt;React/RCTDevLoadingViewProtocol.h&gt;)</span></span>
  {
    <span class="hljs-comment">// 显示加载视图</span>
    <span class="hljs-type">id</span>&lt;RCTDevLoadingViewProtocol&gt; loadingView =
        (<span class="hljs-type">id</span>&lt;RCTDevLoadingViewProtocol&gt;)[_turboModuleManager moduleForName:<span class="hljs-string">"DevLoadingView"</span>];
    [loadingView showWithURL:sourceURL];
  }
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

  __<span class="hljs-keyword">weak</span> __<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) weakSelf = <span class="hljs-keyword">self</span>;
  <span class="hljs-comment">// 通过代理加载 Bundle</span>
  [_delegate loadBundleAtURL:sourceURL
      onProgress:^(RCTLoadingProgress *progressData) {
        __<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) strongSelf = weakSelf;
        <span class="hljs-keyword">if</span> (!strongSelf) {
          <span class="hljs-keyword">return</span>;
        }

<span class="hljs-meta">#<span class="hljs-keyword">if</span> RCT_DEV_MENU &amp;&amp; __has_include(<span class="hljs-string">&lt;React/RCTDevLoadingViewProtocol.h&gt;)</span></span>
        <span class="hljs-type">id</span>&lt;RCTDevLoadingViewProtocol&gt; loadingView =
            (<span class="hljs-type">id</span>&lt;RCTDevLoadingViewProtocol&gt;)[strongSelf-&gt;_turboModuleManager moduleForName:<span class="hljs-string">"DevLoadingView"</span>];
        [loadingView updateProgress:progressData];
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
      }
      onComplete:^(<span class="hljs-built_in">NSError</span> *error, RCTSource *source) {
        __<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) strongSelf = weakSelf;
        <span class="hljs-keyword">if</span> (!strongSelf) {
          <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">if</span> (error) {
          [strongSelf handleBundleLoadingError:error];
          <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-comment">// _loadScriptFromSource 函数的回调函数需要 DevSettings 模块，因此需要提前进行初始化。</span>
        RCTDevSettings *<span class="hljs-keyword">const</span> devSettings =
            (RCTDevSettings *)[strongSelf-&gt;_turboModuleManager moduleForName:<span class="hljs-string">"DevSettings"</span>];

        <span class="hljs-comment">// 加载脚本</span>
        [strongSelf _loadScriptFromSource:source];
        <span class="hljs-comment">// 仅在开发环境中启用热模块重载功能。</span>
        [strongSelf-&gt;_performanceLogger markStopForTag:RCTPLScriptDownload];
        [devSettings setupHMRClientWithBundleURL:sourceURL];
<span class="hljs-meta">#<span class="hljs-keyword">if</span> RCT_DEV</span>
        [strongSelf _logOldArchitectureWarnings];
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
      }];
}


- (<span class="hljs-type">void</span>)_loadScriptFromSource:(RCTSource *)source
{
  std::lock_guard&lt;std::mutex&gt; lock(_invalidationMutex);
  <span class="hljs-keyword">if</span> (!_valid) {
    <span class="hljs-keyword">return</span>;
  }

  auto script = std::make_unique&lt;<span class="hljs-built_in">NSDataBigString</span>&gt;(source.data);
  <span class="hljs-keyword">const</span> auto *url = deriveSourceURL(source.url).UTF8String;

  auto beforeLoad = [waitUntilModuleSetupComplete = <span class="hljs-keyword">self</span>-&gt;_waitUntilModuleSetupComplete](jsi::Runtime &amp;_) {
    <span class="hljs-keyword">if</span> (waitUntilModuleSetupComplete) {
      waitUntilModuleSetupComplete();
    }
  };
  auto afterLoad = [](jsi::Runtime &amp;_) {
    [[<span class="hljs-built_in">NSNotificationCenter</span> defaultCenter] postNotificationName:<span class="hljs-string">@"RCTInstanceDidLoadBundle"</span> object:<span class="hljs-literal">nil</span>];
  };
  <span class="hljs-comment">// 在 ReactInstance 中执行脚本</span>
  _reactInstance-&gt;loadScript(std::move(script), url, beforeLoad, afterLoad);
}
</code></pre>
<h5 data-id="heading-12">Surface 创建与启动</h5>
<p>现在，我们把视线拉回<code>viewWithModuleName</code>方法中，继续分析后面的<code>createSurfaceWithModuleName</code>方法的实现。源码<code>RCTHost.mm</code>：</p>
<pre><code class="hljs language-objc" lang="objc">- (RCTFabricSurface *)createSurfaceWithModuleName:(<span class="hljs-built_in">NSString</span> *)moduleName initialProperties:(<span class="hljs-built_in">NSDictionary</span> *)properties
{
  <span class="hljs-keyword">return</span> [<span class="hljs-keyword">self</span> createSurfaceWithModuleName:moduleName mode:DisplayMode::Visible initialProperties:properties];
}

- (RCTFabricSurface *)createSurfaceWithModuleName:(<span class="hljs-built_in">NSString</span> *)moduleName
                                             mode:(DisplayMode)displayMode
                                initialProperties:(<span class="hljs-built_in">NSDictionary</span> *)properties
{
  <span class="hljs-comment">// 1. 创建 FabricSurface</span>
  RCTFabricSurface *surface = [[RCTFabricSurface alloc] initWithSurfacePresenter:<span class="hljs-keyword">self</span>.surfacePresenter
                                                                      moduleName:moduleName
                                                               initialProperties:properties];
  <span class="hljs-comment">// 2. 设置显示模式</span>
  surface.surfaceHandler.setDisplayMode(displayMode);

  <span class="hljs-comment">// 3. 附加 Surface</span>
  [<span class="hljs-keyword">self</span> _attachSurface:surface];

  __<span class="hljs-keyword">weak</span> RCTFabricSurface *weakSurface = surface;
  <span class="hljs-comment">// 在 JS Bundle 执行完成后，使用BufferedRuntimeExecutor启动Surface</span>
  [_instance callFunctionOnBufferedRuntimeExecutor:[weakSurface](facebook::jsi::Runtime &amp;_) { [weakSurface start]; }];
  <span class="hljs-keyword">return</span> surface;
}
</code></pre>
<h3 data-id="heading-13">总结</h3>
<p>初始化的大概流程：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>                        <span class="hljs-string">Swift</span> <span class="hljs-string">应用层</span>                              <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">┌─────────────────────────────────────────────────────────────┐│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-string">AppDelegate</span>                                                 <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">reactNativeDelegate:</span> <span class="hljs-string">ReactNativeDelegate</span>             <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">└──</span> <span class="hljs-attr">reactNativeFactory:</span> <span class="hljs-string">RCTReactNativeFactory</span>             <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─────────────────────────────────────────────────────────────┘│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">┌─────────────────────────────────────────────────────────────┐│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-attr">ReactNativeDelegate :</span> <span class="hljs-string">RCTDefaultReactNativeFactoryDelegate</span>  <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-string">bundleURL()</span> <span class="hljs-string">→</span> <span class="hljs-string">URL?</span>                                    <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">└──</span> <span class="hljs-attr">dependencyProvider:</span> <span class="hljs-string">RCTAppDependencyProvider</span>          <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─────────────────────────────────────────────────────────────┘│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────────────────┘</span>
                               <span class="hljs-string">│</span>
                               <span class="hljs-string">▼</span>
<span class="hljs-string">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>                        <span class="hljs-string">Factory</span> <span class="hljs-string">层</span>                                <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">┌─────────────────────────────────────────────────────────────┐│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-string">RCTReactNativeFactory</span>                                       <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">delegate:</span> <span class="hljs-string">RCTReactNativeFactoryDelegate</span>               <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">rootViewFactory:</span> <span class="hljs-string">RCTRootViewFactory</span>                   <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">└──</span> <span class="hljs-string">startReactNative(withModuleName:in:)</span>                  <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─────────────────────────────────────────────────────────────┘│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">┌─────────────────────────────────────────────────────────────┐│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-string">RCTRootViewFactory</span>                                          <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">reactHost:</span> <span class="hljs-string">RCTHost</span>                                    <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-string">view(withModuleName:)</span> <span class="hljs-string">→</span> <span class="hljs-string">UIView</span>                        <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">└──</span> <span class="hljs-string">createReactHost()</span> <span class="hljs-string">→</span> <span class="hljs-string">RCTHost</span>                           <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─────────────────────────────────────────────────────────────┘│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────────────────┘</span>
                               <span class="hljs-string">│</span>
                               <span class="hljs-string">▼</span>
<span class="hljs-string">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>                         <span class="hljs-string">Host</span> <span class="hljs-string">层</span>                                  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">┌─────────────────────────────────────────────────────────────┐│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-string">RCTHost</span>                                                     <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">instance:</span> <span class="hljs-string">RCTInstance</span>                                 <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">bundleManager:</span> <span class="hljs-string">RCTBundleManager</span>                       <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-string">start()</span>                                               <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">└──</span> <span class="hljs-string">createSurface(withModuleName:)</span> <span class="hljs-string">→</span> <span class="hljs-string">RCTFabricSurface</span>     <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─────────────────────────────────────────────────────────────┘│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────────────────┘</span>
                               <span class="hljs-string">│</span>
                               <span class="hljs-string">▼</span>
<span class="hljs-string">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>                       <span class="hljs-string">Instance</span> <span class="hljs-string">层</span>                                <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">┌─────────────────────────────────────────────────────────────┐│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-string">RCTInstance</span>                                                 <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">reactInstance:</span> <span class="hljs-string">ReactInstance</span> <span class="hljs-string">(C++)</span>                    <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">turboModuleManager:</span> <span class="hljs-string">RCTTurboModuleManager</span>             <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">surfacePresenter:</span> <span class="hljs-string">RCTSurfacePresenter</span>                 <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">displayLink:</span> <span class="hljs-string">RCTDisplayLink</span>                           <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">└──</span> <span class="hljs-string">_start()</span>                                              <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─────────────────────────────────────────────────────────────┘│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────────────────┘</span>
                               <span class="hljs-string">│</span>
                               <span class="hljs-string">▼</span>
<span class="hljs-string">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>                        <span class="hljs-string">C++</span> <span class="hljs-string">Runtime</span> <span class="hljs-string">层</span>                            <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">┌─────────────────────────────────────────────────────────────┐│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-string">ReactInstance</span> <span class="hljs-string">(C++)</span>                                         <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">jsRuntime:</span> <span class="hljs-string">jsi::Runtime</span> <span class="hljs-string">(Hermes)</span>                      <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">runtimeScheduler:</span> <span class="hljs-string">RuntimeScheduler</span>                    <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">timerManager:</span> <span class="hljs-string">TimerManager</span>                            <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-string">initializeRuntime()</span>                                   <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">└──</span> <span class="hljs-string">loadScript()</span>                                          <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─────────────────────────────────────────────────────────────┘│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────────────────┘</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Clawdbot是否才是真正的AI入口产品？一文带你搞懂Clawdbot架构！]]></title>    <link>https://juejin.cn/post/7600229327436709938</link>    <guid>https://juejin.cn/post/7600229327436709938</guid>    <pubDate>2026-01-28T13:45:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600229327436709938" data-draft-id="7600245693997547530" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Clawdbot是否才是真正的AI入口产品？一文带你搞懂Clawdbot架构！"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2026-01-28T13:45:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="moshuying"/> <meta itemprop="url" content="https://juejin.cn/user/2700056289356936"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Clawdbot是否才是真正的AI入口产品？一文带你搞懂Clawdbot架构！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2700056289356936/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    moshuying
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T13:45:02.000Z" title="Wed Jan 28 2026 13:45:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>由于Anthropic认为Clawdbot这个名字太容易被市场误解为Claude Code的产品，所以要求改名，目前Clawdbot刚改名为Moltbot，以下皆用Clawdbot代替。</p>
</blockquote>
<h2 data-id="heading-0">它是什么</h2>
<p>不是聊天机器人。是一个<strong>拥有键盘、屏幕和身份的高权限代理</strong>。</p>
<p>它运行在你的 Mac 或服务器上，通过 Telegram、Slack、iMessage 这些你已经在用的聊天软件作为入口，直接操控本地文件、终端、浏览器。你在手机上说一句"帮我把桌面的报告发给老板"，它真的会去读文件、打开邮件客户端、发送出去。</p>
<p>传统 AI 是"对话框里的聊天伴侣"，你得跳出工作流去迁就它。Moltbot 把自己变成后台进程，<strong>你不需要打开任何新 App，它就在你的聊天窗口里等着</strong>。</p>
<p>技术上，这是一个<strong>本地优先、统一控制平面</strong>的架构：Gateway 进程独占所有消息通道和工具权限，通过 WebSocket 协议管理多 Agent、多会话、多设备。数据不出本地，执行不经云端。</p>
<h2 data-id="heading-1">整体架构</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4b807f8e76b41e5b7bf1f38380b0f23~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9zaHV5aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770212701&amp;x-signature=LvHg88uI0jcOpZtd1eDFQRxc4PU%3D" alt="26n5y12000rb4n79dE78D.png" loading="lazy"/></p>
<p>假设你在 Telegram 给 Clawdbot 发了一条消息："帮我看看桌面有哪些 PDF 文件"。</p>
<p><strong>第一站：Channel Layer</strong></p>
<p>Telegram 的消息被 <code>grammY</code> SDK 捕获，进入 Channel 适配层。这一层的职责是<strong>抹平差异</strong>——WhatsApp 用 Baileys、Discord 用 discord.js、Signal 用 signal-cli，每个平台 SDK 不同、消息格式不同、认证方式不同。Channel Layer 把它们统一成一个结构：谁发的、从哪来、内容是什么。</p>
<p>为什么要这样？因为 AI 不应该关心消息是从 Telegram 还是 iMessage 来的，它只需要知道"用户说了什么"。</p>
<p><strong>第二站：Routing System</strong></p>
<p>消息到了 Gateway，但 Gateway 可能管理着多个 Agent（比如一个工作助手、一个生活助手）。Routing 系统决定这条消息交给谁处理。</p>
<p>路由规则是多级的：先看发送者（peer）、再看群组（guild）、再看账号（account）、再看通道（channel），最后才是默认。这意味着你可以配置"来自老板的消息走工作 Agent，来自家人的消息走生活 Agent"。</p>
<p>同时，Routing 还生成 <code>sessionKey</code>——这条消息属于哪个会话。会话隔离是核心设计：不同对话的上下文不会串，A 群的聊天历史不会出现在 B 群。</p>
<p><strong>第三站：Agent Runtime</strong></p>
<p>消息和会话上下文一起交给 Agent。Agent 的核心是 Pi Agent Core 框架，负责：</p>
<ol>
<li>构建 prompt（系统提示 + 历史消息 + 当前输入）</li>
<li>调用 AI 模型（Ollama 本地、OpenAI 云端，或其他）</li>
<li>解析模型响应，判断是直接回复还是需要调用工具</li>
</ol>
<p>对于"看桌面 PDF"这个请求，模型会判断需要调用 <code>bash</code> 工具。</p>
<p><strong>第四站：Tools System</strong></p>
<p>Agent 发起工具调用：<code>ls ~/Desktop/*.pdf</code>。</p>
<p>工具系统不是简单地执行命令——它有权限控制（哪些目录可访问）、沙箱隔离（非 main 会话在 Docker 里跑）、超时管理（防止命令卡死）。执行结果返回给 Agent，Agent 把结果组织成自然语言回复。</p>
<p><strong>回程</strong></p>
<p>回复沿着原路返回：Agent → Gateway → Channel → Telegram → 你的手机。</p>
<p>整个过程，Gateway 是唯一的调度中心。为什么单点？因为消息通道（WhatsApp session、Telegram bot）的状态是独占的，多进程会冲突。单一 Gateway 确保所有状态一致。</p>
<h2 data-id="heading-2">全局数据流</h2>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant User as 用户
    participant Channel as 消息通道
    participant Gateway as Gateway
    participant Router as 路由系统
    participant Agent as Agent Runtime
    participant Model as AI 模型
    participant Tool as 工具系统

    User-&gt;&gt;Channel: 发送消息
    Channel-&gt;&gt;Gateway: 接收消息
    Gateway-&gt;&gt;Router: 解析路由
    Router-&gt;&gt;Gateway: 返回 agent + sessionKey
    Gateway-&gt;&gt;Agent: 调用 agent.run()
    Agent-&gt;&gt;Model: 调用 AI 模型
    Model--&gt;&gt;Agent: 流式响应
    Agent-&gt;&gt;Tool: 工具调用（如有）
    Tool--&gt;&gt;Agent: 工具结果
    Agent--&gt;&gt;Gateway: 最终响应
    Gateway-&gt;&gt;Channel: 发送回复
    Channel-&gt;&gt;User: 显示消息
</code></pre>
<h2 data-id="heading-3">完全内网部署（Ollama）</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 安装</span>
git <span class="hljs-built_in">clone</span> https://github.com/moltbot/moltbot.git &amp;&amp; <span class="hljs-built_in">cd</span> moltbot
pnpm install &amp;&amp; pnpm build &amp;&amp; pnpm ui:build

<span class="hljs-comment"># 2. 配置 Ollama</span>
ollama pull llama3.3
<span class="hljs-built_in">export</span> OLLAMA_API_KEY=<span class="hljs-string">"ollama-local"</span>  <span class="hljs-comment"># 自动发现本地模型</span>

<span class="hljs-comment"># 3. 启动</span>
pnpm moltbot gateway  <span class="hljs-comment"># Gateway 启动后访问 http://127.0.0.1:18789</span>
</code></pre>
<p><strong>Ollama 配置要点</strong>：</p>
<ul>
<li>设置 <code>OLLAMA_API_KEY</code> 后，Clawdbot 自动发现本地模型（查询 <code>/api/tags</code>）</li>
<li>只有报告 <code>tools</code> 能力的模型才会被识别</li>
<li>推荐模型：<code>llama3.3</code>、<code>qwen2.5-coder:32b</code>、<code>deepseek-r1:32b</code></li>
</ul>
<p>三、产品层面思考</p>
<p>你有没有想过，为什么这一年冒出来这么多 AI App，但你手机里真正留下的没几个？</p>
<p>豆包、Kimi、ChatGPT……每个都想成为你的"AI 入口"，每个都让你下载、注册、记住一个新地方。但说实话，微信已经够好用了，Telegram 已经够好用了。用户不缺聊天工具，缺的是聊天工具里<strong>能帮他干活的东西</strong>。</p>
<p>Clawdbot 选了一条不一样的路：不做独立 App，直接"住进"你已有的聊天软件里。Telegram 里的一个 bot，Slack 里的一个 integration，iMessage 里的一个联系人。你不用切换任何东西，在原来的地方说话就行。</p>
<p>这让我想，也许 AI 产品的竞争，最后不是"谁的模型更强"，而是"谁能更无缝地嵌入用户已有的生活"。</p>
<p>大部分 AI 产品把你的聊天记录、记忆、偏好全存在云端。你不知道它存了什么，怎么用，会不会泄露。Clawdbot 做了个很"硬核"的决定：所有数据都以 Markdown 文件存在你本地。你可以像翻笔记一样查看 AI 的"思考过程"，随时删、改、备份。</p>
<p>对企业用户来说，这意味着数据合规问题天然解决。对个人用户来说，这意味着"我的 AI 只属于我"。</p>
<p>在 AI 时代，"数据主权"会不会成为一个真正的卖点？我不确定，但这个方向值得琢磨。</p>
<p>五、安全风险</p>
<p>这东西本质上是一个<strong>拥有你电脑完整控制权的代理</strong>。能读文件、执行命令、用你的身份发消息。配置失误、边界失守，泄露的不只是数据，而是你的身份和整台机器的控制权。</p>
<p>部署前，白名单一定要配（<code>allowFrom</code>），群组里 mention 门控一定要开，敏感操作最好用 Docker 沙箱隔离。绝对不要暴露到公网，绝对不要让不信任的人能访问。</p>
<p>现阶段，它还是个高危实验品。适合技术敏感度高、愿意折腾、能自己兜底的人。</p>
<p>官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fclawd.bot" target="_blank" title="https://clawd.bot" ref="nofollow noopener noreferrer">clawd.bot</a>
GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fclawdbot%2Fclawdbot" target="_blank" title="https://github.com/clawdbot/clawdbot" ref="nofollow noopener noreferrer">github.com/clawdbot/cl…</a>
文档 ：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.clawd.bot" target="_blank" title="https://docs.clawd.bot" ref="nofollow noopener noreferrer">docs.clawd.bot</a>
技能市场 ：<a href="https://link.juejin.cn?target=https%3A%2F%2Fclawdhub.com" target="_blank" title="https://clawdhub.com" ref="nofollow noopener noreferrer">clawdhub.com</a>
Discord社区：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscord.gg%2Fclawd" target="_blank" title="https://discord.gg/clawd" ref="nofollow noopener noreferrer">discord.gg/clawd</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OoderAgent Nexus 版本分支正式提交[号外]—核心四问]]></title>    <link>https://juejin.cn/post/7600032104249311295</link>    <guid>https://juejin.cn/post/7600032104249311295</guid>    <pubDate>2026-01-28T14:02:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600032104249311295" data-draft-id="7600219080046100523" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OoderAgent Nexus 版本分支正式提交[号外]—核心四问"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-28T14:02:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OneCodeCN"/> <meta itemprop="url" content="https://juejin.cn/user/1427583415622366"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OoderAgent Nexus 版本分支正式提交[号外]—核心四问
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1427583415622366/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OneCodeCN
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T14:02:39.000Z" title="Wed Jan 28 2026 14:02:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>ooderAgent Nexus 版本分支已正式完成提交，经多维度严苛验证，5 大全场景测试全部通过，标志着这一年轻开源项目正式从技术原型迈入有实际场景、有核心价值的产品级新阶段。本次 Nexus 版本围绕 “AIGC 时代 AI 能力枢纽” 的核心定位完成全维度升级，核心更新覆盖技术底座、生态落地、工具创新、核心模式四大维度，配套推出 SkillCenter 多中心设计，实现技术与价值的双闭环。以下为本次版本核心疑问的深度解答，精准诠释 Nexus 版本的核心升级与创新价值。</p>
<h2 data-id="heading-0">1. 本次更新都包含了什么？为什么被称为 Nexus 版本？</h2>
<p>本次 Nexus 版本是 ooderAgent 的关键产品级迭代，核心更新覆盖四大维度，且全量功能均通过 5 大全场景实战验证：技术侧完成 A2UI 工程化升级、VFS 分布式事务存储搭建、协议标准化落地及 mcpAgent SDK 易用性优化，筑牢 AI 能力枢纽的技术底座；生态侧打通 trae-solo skills 生态，实现个人用户零门槛接入 AI 资源，完成生态连接的核心突破；创新侧推出全新 RAD 可视化开发工具，验证 OneCode 全栈技术与 AI 的深度融合，实现工具链的创新升级；核心模式侧落地 Nexus P2P 能力分发体系，重构 AI 能力与用户需求的连接逻辑，同时配套推出 SkillCenter 多中心设计，形成 “能力枢纽 - 能力分发 - 能力落地 - 能力协同” 的完整闭环。</p>
<p>将该版本命名为 Nexus（枢纽），核心源于本次更新实现了技术与价值的双闭环，让 ooderAgent 从单一的 AI Agent 开发框架，进化为 AIGC 时代下连接 AI 能力、开发者、个人及企业用户的核心枢纽。本版本以高速发展的 AIGC 为核心驱动力，向上无缝对接各类 LLM 模型与 AI 能力，向下全面支撑个人开发、企业落地等多样化需求，中间通过标准化协议、分布式存储、SkillCenter、P2P 模式实现能力的高效调度、分发与协同，所有更新均围绕 “打造 AI 能力核心枢纽” 展开。而 5 大全场景测试的全部通过，更是为这一枢纽能力的商业化、规模化落地提供了坚实的质量保障，Nexus 的称号也因此成为该版本最贴切的诠释。</p>
<h2 data-id="heading-1">2. 本次更新的 SkillCenter 看似无所不能，它实际解决了哪些问题？</h2>
<p>SkillCenter 并非全能型工具，而是 ooderAgent 在 AI 能力落地实战中的核心总结与针对性解决方案，经全场景验证后正式落地，直击 AI 应用落地过程中的不确定性、可控性、规模化三大核心痛点，推动 AI 能力从 “随机生成” 走向 “规范、稳定落地”。</p>
<p>AI 的 “生成能力” 虽能快速响应需求，甚至仅凭一句话就能输出贴合需求的结果，但这份便捷背后存在天然的不确定性 —— 即便在 AI 编程这类确定性较强的领域，也会因输出的 “朝秦暮楚” 导致实际落地困难。skills 技术理念的推出，让 AI 重回确定性发展路线，而要打造 100% 避免无依据幻想的确定性产品，需在兼顾 AI 能力与创造力的同时，做好落地的规范约束，SkillCenter 正是这一需求的核心落地载体。</p>
<p>其核心解决的问题体现在两大维度：一是通过Remote Skills 远程技能服务，将 AI 能力落地全流程中确定性的问题抽象为标准化、确定性的结果服务，让这些结果摆脱本地 skills 框架的约束，在 AI 天然的道德约束之外，搭建起一层 “法律式” 的规则约束，确保 AI 能力稳定、可控发挥，从根源上解决 AI 输出的不确定性问题；二是通过多中心设计，构建起 AI 能力落地的标准化规范体系，让分散、个性化的 skills 能力能在统一体系中实现调度、分发与管理，解决了 AI 能力规模化落地的规范难题，成为 AI 能力从技术走向实际场景的核心桥梁。且这一设计已在 5 大全场景中完成实战验证，具备规模化落地的成熟条件。</p>
<h2 data-id="heading-2">3. 本次重要更新的 RAD 版本有什么特殊之处？</h2>
<p>RAD（快速应用开发）工具的更新，是 ooderAgent 一次跳出传统认知、颠覆式的技术创新，并非简单的 “旧瓶装新酒”，该功能经全场景测试验证后正式推出，其特殊性体现在技术选型、设计目标、AI 融合三大维度，核心验证了 OneCode 全栈技术与 AI 的深度结合，以及 ooderAgent 工具链为 AI 定制化设计的技术优势。</p>
<p>从技术选型来看，RAD 打破了行业固有认知：与人交互的可视化交互软件，本是工程与技术长期磨合的产物，而设计器作为软件技术的 “皇冠”，历来被认为需要高灵活性的技术架构，本次 RAD 却首次采用被认为 “灵活性、扩展性相对受限” 的 OneCode 全栈技术开发，技术实现难度不言而喻。但在 AI 的辅助下，OneCode 的优势被充分释放，短期内突破了其旧有架构的边界，实现了全套全新 UI、全套样式图标体系、多语言支持、渐进式整体升级、响应式 UI 设计等一系列此前难以完成的任务，完成了技术选型的反向验证，且所有功能均在全场景测试中实现稳定运行。</p>
<p>从设计目标来看，传统 RAD 与 AI 的确定性技术路线相悖，而本次 ooderAgent 的 RAD 设计，核心是打造AI 原生的可视化开发工具，将 AI 能力深度融入开发全流程。在已放出的演示视频中，能清晰看到 AI 与工具链的协同创新：LLM 可通过浏览器 debug 日志实时诊断脚本错误，通过实时截图获取定位信息偏差，运算输出 JavaScript 后通过浏览器预览实时调整布局，定位效果达标后再分析样式语法，精准找到需要修改的 OneCode 注解并完成精确修改。这一过程中，不仅验证了 LLM 的核心能力，更体现了 ooderAgent 强大的工具链支撑，以及框架层面对 AI 的专属定制化设计，让 RAD 成为 AI 辅助开发的核心载体。</p>
<p>从技术创新来看，本次 RAD 实现了实时反馈、自主编程等新技术的实战验证，将 AI 从 “辅助生成” 推向 “主动开发”，是对传统 RAD 工具的彻底重构，让可视化开发与 AI 能力实现无缝融合，成为 ooderAgent 技术创新的重要标杆。且该创新模式已在 5 大全场景中完成落地验证，具备实际应用价值，也为行业提供了 AI 与可视化开发融合的全新思路。</p>
<h2 data-id="heading-3">4. 本次更新支持的 P2P 模式是什么背景下的？为什么会反复宣传？</h2>
<p>Nexus P2P 是本次版本发布的核心核心，作为 ooderAgent 打造 AI 能力枢纽的核心模式，该功能经 5 大全场景严苛测试后正式落地，其推出的背景，源于 AI 能力落地的 “第一性原理”：在真实的用户需求中，永远只有 AI 与本质性的用户需求两大核心，二者之间的任何中间环节、包装层级，最终都会被需求跨越、击穿。而当前 AI 生态中，存在大量的能力包装、层级冗余问题，导致 AI 能力与用户需求之间的连接效率低下，这一行业痛点成为 P2P 模式推出的核心背景。</p>
<p>之所以反复宣传 Nexus P2P，核心在于它是一场AI 能力分发的革命，彻底重构了 AI 能力与用户需求的连接逻辑：让需求和能力之间，只存在 “AI” 与 “Agent Nexus”，砍掉了所有冗余的中间环节，实现了 AI 能力的直连式分发，且这一直连模式已在全场景中完成实战验证，确保高效、稳定运行。</p>
<p>Agent Nexus 围绕 “需求与能力直连” 这一核心需求，对 AI 能力落地的全流程进行层层拆解，剥去了所有非必要的包装与层级，但同时又通过标准化的规则与节奏，保障了能力分发的有序性与可控性 —— 这正是 “Agent Nexus” 的核心价值：既实现了 AI 能力与用户本质需求的无阻碍连接，又避免了无规则直连带来的混乱，让 AI 能力能高效、规范地触达用户。这种模式彻底打破了传统的能力分发逻辑，让 AI 能力落地回归本质，是 ooderAgent 从 “AI 能力枢纽” 走向 “AI 生态核心” 的关键，也是其区别于其他 AI Agent 框架的核心竞争力，更是本次 Nexus 版本能实现技术与价值双闭环的核心支撑，因此成为本次版本发布的核心宣传点。</p>
<h3 data-id="heading-4">写在最后</h3>
<p>ooderAgent Nexus 版本分支的正式提交与 5 大全场景测试的全部通过，是这一年轻开源项目的重要里程碑。从技术原型到产品级形态，从单一框架到 AI 能力枢纽，Nexus 版本的每一次升级、每一项创新，都围绕 “AIGC 时代让 AI 能力更高效、更规范、更普惠地落地” 这一核心目标。而 SkillCenter、RAD、Nexus P2P 的创新落地，不仅为 ooderAgent 自身生态奠定了基础，也为 AI Agent 行业的发展提供了全新的实践思路。未来，ooderAgent 将继续以技术创新为核心，完善生态布局，让 AI 能力真正服务于每一个开发者、每一个实际需求场景。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一天一个开源项目（第5篇）：最近火爆硅谷的ClaudBot，真不是什么不得了的事]]></title>    <link>https://juejin.cn/post/7600223321041682438</link>    <guid>https://juejin.cn/post/7600223321041682438</guid>    <pubDate>2026-01-28T12:13:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600223321041682438" data-draft-id="7600223321041666054" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一天一个开源项目（第5篇）：最近火爆硅谷的ClaudBot，真不是什么不得了的事"/> <meta itemprop="keywords" content="AI编程,人工智能,开源"/> <meta itemprop="datePublished" content="2026-01-28T12:13:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冬奇Lab"/> <meta itemprop="url" content="https://juejin.cn/user/1857501105781193"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一天一个开源项目（第5篇）：最近火爆硅谷的ClaudBot，真不是什么不得了的事
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1857501105781193/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冬奇Lab
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T12:13:51.000Z" title="Wed Jan 28 2026 12:13:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<blockquote>
<p>"当技术圈的狂欢遇到冷静的理性分析，真相往往比营销更值得关注。"</p>
</blockquote>
<p>这是"一天一个开源项目"系列的第5篇文章。今天带你了解的项目是 <strong>Moltbot</strong>（原名 Clawdbot，<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fmoltbot" target="_blank" title="https://github.com/moltbot/moltbot" ref="nofollow noopener noreferrer">GitHub</a>）。</p>
<p>最近这个项目在技术圈刷屏了：GitHub 星标狂飙到 72k+，被吹成"7×24小时AI员工""开源贾维斯"，甚至有人说它"带火了Mac mini销量"。但冷静分析后会发现，它的火爆更多是踩中了情绪，而非技术上的颠覆性创新。</p>
<h2 data-id="heading-1">项目背景</h2>
<h3 data-id="heading-2">项目简介</h3>
<p><strong>Moltbot</strong>（原名 Clawdbot）是一个<strong>开源的个人AI助手</strong>，支持多平台、多渠道运行。它通过 Gateway（网关）架构，将AI能力与桌面系统、社交软件、办公工具等连接起来，实现从"聊天"到"执行"的闭环。</p>
<p><strong>项目解决的核心问题</strong>：</p>
<ul>
<li>AI助手只能聊天，无法执行实际任务</li>
<li>需要统一的接口来连接各种服务和工具</li>
<li>个人数据隐私和本地部署的需求</li>
<li>开发者需要可定制的AI代理框架</li>
</ul>
<p><strong>面向的用户群体</strong>：</p>
<ul>
<li>技术极客和开发者</li>
<li>对隐私敏感的用户</li>
<li>需要高度定制化AI助手的用户</li>
<li>愿意折腾配置的技术爱好者</li>
</ul>
<h3 data-id="heading-3">作者/团队介绍</h3>
<p><strong>作者：Peter Steinberger (@steipete)</strong></p>
<ul>
<li><strong>背景</strong>：专注于AI和开发者工具的开源开发者</li>
<li><strong>理念</strong>：为 Molty（一只空间龙虾AI助手）构建个人AI代理</li>
<li><strong>项目起源</strong>：最初为个人需求开发，后开源给社区</li>
</ul>
<p><strong>项目创建时间</strong>：2024年（从 GitHub 提交历史可以看出项目持续活跃）</p>
<h3 data-id="heading-4">项目数据</h3>
<ul>
<li>⭐ <strong>GitHub Stars</strong>: 72.3k+（持续快速增长）</li>
<li>🍴 <strong>Forks</strong>: 9.2k+</li>
<li>📦 <strong>版本</strong>: Clawdbot 2026.1.24（最新版本，2026年1月25日发布）</li>
<li>📄 <strong>License</strong>: MIT（完全开源，自由使用）</li>
<li>🌐 <strong>官网</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fmolt.bot" target="_blank" title="https://molt.bot" ref="nofollow noopener noreferrer">molt.bot</a></li>
<li>📚 <strong>文档</strong>: 包含详细的文档和平台指南</li>
<li>💬 <strong>社区</strong>: GitHub Issues 和 Discussions 活跃</li>
</ul>
<p><strong>项目发展历程</strong>：</p>
<ul>
<li>2024年：项目启动，最初名为 Clawdbot</li>
<li>2024-2025年：快速发展，添加多平台支持</li>
<li>2025年底：项目更名，从 Clawdbot 改为 Moltbot</li>
<li>2026年：持续优化，社区活跃度极高</li>
</ul>
<hr/>
<h2 data-id="heading-5">主要功能</h2>
<h3 data-id="heading-6">核心作用</h3>
<p>Moltbot 的核心作用是<strong>将AI大模型的能力与桌面系统、各种服务连接起来</strong>，实现从自然语言指令到实际任务执行的完整闭环。它通过 Gateway 架构，统一管理各种渠道（Telegram、Slack、Discord、iMessage等）和工具（浏览器控制、文件操作、系统调用等）。</p>
<h3 data-id="heading-7">使用场景</h3>
<ol>
<li>
<p><strong>多渠道AI助手</strong></p>
<ul>
<li>通过 Telegram、Slack、Discord 等渠道与AI对话</li>
<li>统一管理多个社交和办公平台</li>
<li>实现跨平台的任务执行</li>
</ul>
</li>
<li>
<p><strong>桌面自动化</strong></p>
<ul>
<li>通过自然语言控制浏览器</li>
<li>自动化文件操作和系统任务</li>
<li>实现复杂的多步骤工作流</li>
</ul>
</li>
<li>
<p><strong>本地AI代理</strong></p>
<ul>
<li>本地部署，数据不上云</li>
<li>长期记忆和上下文管理</li>
<li>可对接本地大模型</li>
</ul>
</li>
<li>
<p><strong>智能家居集成</strong></p>
<ul>
<li>通过开源生态整合智能家居</li>
<li>自定义Agent和技能</li>
<li>实现个性化的自动化场景</li>
</ul>
</li>
<li>
<p><strong>开发者工具</strong></p>
<ul>
<li>作为AI代理开发框架</li>
<li>支持自定义扩展和插件</li>
<li>用于构建专属AI应用</li>
</ul>
</li>
</ol>
<h3 data-id="heading-8">快速开始</h3>
<h4 data-id="heading-9">安装方式</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用 npm/pnpm/yarn 安装</span>
npm install -g @moltbot/cli

<span class="hljs-comment"># 或使用 Docker</span>
docker run -it --<span class="hljs-built_in">rm</span> moltbot/moltbot

<span class="hljs-comment"># 或从源码构建</span>
git <span class="hljs-built_in">clone</span> https://github.com/moltbot/moltbot.git
<span class="hljs-built_in">cd</span> moltbot
pnpm install
pnpm build
</code></pre>
<h4 data-id="heading-10">基本配置</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># config.yaml</span>
<span class="hljs-attr">channels:</span>
  <span class="hljs-attr">telegram:</span>
    <span class="hljs-attr">botToken:</span> <span class="hljs-string">"YOUR_BOT_TOKEN"</span>
  
  <span class="hljs-attr">discord:</span>
    <span class="hljs-attr">token:</span> <span class="hljs-string">"YOUR_DISCORD_TOKEN"</span>
  
  <span class="hljs-attr">slack:</span>
    <span class="hljs-attr">botToken:</span> <span class="hljs-string">"YOUR_SLACK_BOT_TOKEN"</span>
    <span class="hljs-attr">appToken:</span> <span class="hljs-string">"YOUR_SLACK_APP_TOKEN"</span>

<span class="hljs-attr">browser:</span>
  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">color:</span> <span class="hljs-string">"#FF4500"</span>

<span class="hljs-attr">ai:</span>
  <span class="hljs-attr">provider:</span> <span class="hljs-string">"openai"</span>  <span class="hljs-comment"># 或 "anthropic", "local" 等</span>
  <span class="hljs-attr">model:</span> <span class="hljs-string">"gpt-4"</span>
  <span class="hljs-attr">apiKey:</span> <span class="hljs-string">"YOUR_API_KEY"</span>
</code></pre>
<h3 data-id="heading-11">核心特性</h3>
<ol>
<li>
<p><strong>Gateway 架构</strong></p>
<ul>
<li>统一的网关管理所有渠道和工具</li>
<li>支持多平台（Windows、macOS、Linux、iOS、Android）</li>
<li>可扩展的插件系统</li>
</ul>
</li>
<li>
<p><strong>多渠道支持</strong></p>
<ul>
<li>Telegram、Slack、Discord、Signal、iMessage、Microsoft Teams</li>
<li>WebChat 界面</li>
<li>统一的对话接口</li>
</ul>
</li>
<li>
<p><strong>浏览器控制</strong></p>
<ul>
<li>通过自然语言控制浏览器</li>
<li>支持网页操作、表单填写、数据提取</li>
<li>可视化操作反馈</li>
</ul>
</li>
<li>
<p><strong>本地记忆系统</strong></p>
<ul>
<li>每日日志和长期记忆</li>
<li>本地MD文件存储</li>
<li>人类可编辑和审查</li>
</ul>
</li>
<li>
<p><strong>技能系统（Skills）</strong></p>
<ul>
<li>可组合的技能库</li>
<li>支持自定义技能开发</li>
<li>自动触发和执行</li>
</ul>
</li>
<li>
<p><strong>远程访问</strong></p>
<ul>
<li>支持SSH隧道和Tailnet</li>
<li>安全的远程控制</li>
<li>多设备同步</li>
</ul>
</li>
<li>
<p><strong>开源生态</strong></p>
<ul>
<li>MIT协议，完全开源</li>
<li>支持本地大模型对接</li>
<li>可定制和扩展</li>
</ul>
</li>
<li>
<p><strong>安全控制</strong></p>
<ul>
<li>访问权限管理</li>
<li>认证和授权机制</li>
<li>可配置的安全策略</li>
</ul>
</li>
</ol>
<h2 data-id="heading-12">项目详细剖析</h2>
<h3 data-id="heading-13">核心差异分析：被过度炒作的"亮点"背后</h3>
<h4 data-id="heading-14">❶ 桌面系统高权限操作：不是做不到，而是敢不敢</h4>
<p><strong>被吹捧的说法</strong>：</p>
<blockquote>
<p>"Moltbot 实现了AI对桌面系统的完全控制，这是其他工具做不到的！"</p>
</blockquote>
<p><strong>真相分析</strong>：</p>
<p>这不是技术壁垒，而是<strong>产品定位和风险承担的选择</strong>。</p>
<p><strong>技术层面</strong>：</p>
<ul>
<li>豆包、千问App等成熟产品<strong>完全有技术能力</strong>实现全量桌面权限</li>
<li>macOS 的 Accessibility API、Windows 的 UI Automation、Linux 的 D-Bus 都是公开的系统接口</li>
<li>任何有系统编程能力的开发者都能实现类似功能</li>
</ul>
<p><strong>为什么闭源产品不这么做？</strong></p>
<ol>
<li><strong>合规风险</strong>：面向大众用户，开放高权限意味着巨大的合规和隐私风险</li>
<li><strong>安全责任</strong>：厂商需要为安全漏洞承担责任，而开源项目由用户自行承担</li>
<li><strong>用户教育成本</strong>：普通用户难以正确配置安全策略，容易造成隐私泄露</li>
<li><strong>法律风险</strong>：高权限操作可能涉及法律边界，厂商需要谨慎</li>
</ol>
<p><strong>Moltbot 的选择</strong>：</p>
<ul>
<li>把权限交给用户，让技术党自己承担风险</li>
<li>这是<strong>人群定位的选择</strong>，而非技术鸿沟</li>
<li>适合技术极客，不适合普通用户</li>
</ul>
<p><strong>结论</strong>：这不是技术优势，而是<strong>风险转移</strong>。</p>
<h4 data-id="heading-15">❷ 全渠道打通社交/办公软件：本质是提前配置的结果</h4>
<p><strong>被吹捧的说法</strong>：</p>
<blockquote>
<p>"Moltbot 无缝打通了所有社交和办公软件，实现了真正的统一入口！"</p>
</blockquote>
<p><strong>真相分析</strong>：</p>
<p>这本质上是<strong>提前配置的结果</strong>，而非独家技术。</p>
<p><strong>技术实现</strong>：</p>
<ul>
<li>Telegram Bot API、Slack API、Discord API 都是公开的</li>
<li>需要的是：Bot Token、App Token、Webhook URL 等配置信息</li>
<li>配置流程：注册应用 → 获取Token → 配置到Moltbot</li>
</ul>
<p><strong>类比理解</strong>：
就像给豆包配置好邮箱账号，它就能自动发邮件一样。Moltbot 的"无缝体验"来自：</p>
<ol>
<li><strong>部署时的账号对接</strong>：用户需要手动配置各种服务的Token</li>
<li><strong>统一的接口封装</strong>：Moltbot 把这些API调用封装成了统一的接口</li>
<li><strong>配置流程整合</strong>：把配置流程整合到了开源框架里</li>
</ol>
<p><strong>这不是技术突破，而是"一站式折腾"</strong>：</p>
<ul>
<li>用户需要：注册多个服务、获取多个Token、配置多个参数</li>
<li>对于普通用户，这个配置成本可能比使用多个独立工具还高</li>
<li>对于技术极客，这种统一管理确实有价值</li>
</ul>
<p><strong>结论</strong>：这是<strong>工程整合</strong>，不是技术创新。</p>
<h4 data-id="heading-16">❸ 本地长期记忆：真正的亮点，但没那么神</h4>
<p><strong>被吹捧的说法</strong>：</p>
<blockquote>
<p>"Moltbot 的本地记忆系统比云端AI的上下文窗口更强大，实现了真正的长期记忆！"</p>
</blockquote>
<p><strong>真相分析</strong>：</p>
<p>这确实是 Moltbot <strong>为数不多的真正亮点</strong>，但也没那么神。</p>
<p><strong>技术实现</strong>：</p>
<ul>
<li>记忆存储在本地MD文件中</li>
<li>分两层：每日日志（daily logs）和长期沉淀（long-term memory）</li>
<li>重启不丢失，人类可编辑和审查</li>
</ul>
<p><strong>优势</strong>：</p>
<ul>
<li>✅ 比云端AI的上下文窗口更持久（不受Token限制）</li>
<li>✅ 成本更低（不需要为长上下文付费）</li>
<li>✅ 隐私可控（数据不上云）</li>
<li>✅ 人类可审查和编辑（透明度高）</li>
</ul>
<p><strong>局限性</strong>：</p>
<ul>
<li>❌ 这种本地存储的思路，闭源产品<strong>只要想做，完全可以复刻</strong></li>
<li>❌ 只是会增加开发和维护成本，但不存在技术壁垒</li>
<li>❌ 记忆检索和关联能力，相比向量数据库等专业方案，可能还有差距</li>
</ul>
<p><strong>结论</strong>：这是<strong>产品设计亮点</strong>，但不是不可复制的技术壁垒。</p>
<h4 data-id="heading-17">❹ 真正的核心差异：开源生态</h4>
<p><strong>唯一不可替代的优势</strong>：</p>
<p>Moltbot 真正的核心差异，<strong>只有一个：开源生态</strong>。</p>
<p><strong>开源带来的价值</strong>：</p>
<ol>
<li>
<p><strong>按需定制</strong></p>
<ul>
<li>可以修改代码，对接本地大模型</li>
<li>可以开发专属Agent和技能</li>
<li>可以整合智能家居、IoT设备</li>
</ul>
</li>
<li>
<p><strong>数据主权</strong></p>
<ul>
<li>代码完全透明，可审计</li>
<li>数据完全本地，不上云</li>
<li>不依赖任何第三方服务</li>
</ul>
</li>
<li>
<p><strong>社区生态</strong></p>
<ul>
<li>72k+ Stars，活跃的社区贡献</li>
<li>丰富的扩展和插件</li>
<li>持续的功能迭代</li>
</ul>
</li>
<li>
<p><strong>学习价值</strong></p>
<ul>
<li>可以学习AI代理的实现</li>
<li>可以理解Gateway架构设计</li>
<li>可以作为开发框架使用</li>
</ul>
</li>
</ol>
<p><strong>但这个优势的受众极窄</strong>：</p>
<ul>
<li>普通用户根本折腾不动</li>
<li>需要技术背景和开发能力</li>
<li>配置和维护成本高</li>
</ul>
<p><strong>结论</strong>：开源生态是 Moltbot 的<strong>唯一不可替代优势</strong>，但受众面窄。</p>
<h3 data-id="heading-18">为什么能火出圈？营销与情绪的双重作用</h3>
<h4 data-id="heading-19">✅ 踩中了"AI从聊天到执行"的趋势</h4>
<ul>
<li>把大模型的"嘴"接上了桌面系统的"手"</li>
<li>实现了任务闭环，戳中了大家对"全能AI管家"的期待</li>
<li>这是技术趋势，不是 Moltbot 的独家能力</li>
</ul>
<h4 data-id="heading-20">✅ 开源+本地部署的标签</h4>
<ul>
<li>精准击中了技术党对数据主权、隐私可控的需求</li>
<li>在AI隐私担忧的背景下，这个标签自带传播力</li>
<li>但普通用户可能并不关心这些</li>
</ul>
<h4 data-id="heading-21">✅ 营销造势到位</h4>
<ul>
<li>"贾维斯平替""7×24小时AI员工"等话题自带传播度</li>
<li>"带火Mac mini销量"等话题放大了实际价值</li>
<li>技术圈的集体狂欢，放大了项目影响力</li>
</ul>
<h3 data-id="heading-22">狂欢背后的槽点：理性看待风险</h3>
<h4 data-id="heading-23">☑ 上手门槛高</h4>
<p><strong>看似开箱即用，实则复杂需求需要大量调试</strong>：</p>
<ul>
<li>基础配置需要：安装、配置Token、设置权限</li>
<li>复杂需求需要：编写自定义技能、调试Agent逻辑</li>
<li>那些"躺床上重构网站"的案例，都是开发者的秀操作</li>
<li>小白照搬只会全是报错</li>
</ul>
<p><strong>真实使用体验</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">用户：<span class="hljs-string">"帮我整理一下桌面文件"</span>
Moltbot：<span class="hljs-string">"我需要访问文件系统权限..."</span>
用户：<span class="hljs-string">"好的，怎么配置？"</span>
Moltbot：<span class="hljs-string">"请修改 config.yaml，设置 fileSystem.accessLevel: 'full'..."</span>
用户：<span class="hljs-string">"然后呢？"</span>
Moltbot：<span class="hljs-string">"请确保系统权限已授予..."</span>
用户：<span class="hljs-string">"系统提示权限被拒绝..."</span>
Moltbot：<span class="hljs-string">"请检查系统设置 → 隐私与安全性 → 辅助功能..."</span>
用户：<span class="hljs-string">"算了，我还是手动整理吧..."</span>
</code></pre>
<h4 data-id="heading-24">☑ 安全风险拉满</h4>
<p><strong>默认开放高权限，配置不当就是隐私定时炸弹</strong>：</p>
<ul>
<li>目前已有大量实例存在认证漏洞</li>
<li>配置不当可能导致：
<ul>
<li>文件系统被恶意访问</li>
<li>敏感信息泄露</li>
<li>系统被远程控制</li>
<li>社交账号被盗用</li>
</ul>
</li>
</ul>
<p><strong>安全建议</strong>：</p>
<ul>
<li>仅在可信网络环境使用</li>
<li>严格配置访问权限</li>
<li>定期审查日志和记忆文件</li>
<li>不要在生产环境使用</li>
</ul>
<h4 data-id="heading-25">☑ 并非大众产品</h4>
<p><strong>轻度使用的自动化需求，现有闭源工具更省心</strong>：</p>
<ul>
<li>为了整理文件开放全量权限，性价比太低</li>
<li>普通用户的自动化需求，Mac Automator、Windows Task Scheduler 更简单</li>
<li>轻度AI助手需求，豆包、千问App 更省心</li>
</ul>
<p><strong>适用场景对比</strong>：</p>








































<table><thead><tr><th align="left">使用场景</th><th align="left">Moltbot</th><th align="left">闭源工具</th></tr></thead><tbody><tr><td align="left"><strong>重度定制需求</strong></td><td align="left">⭐⭐⭐⭐⭐</td><td align="left">⭐⭐</td></tr><tr><td align="left"><strong>隐私敏感用户</strong></td><td align="left">⭐⭐⭐⭐⭐</td><td align="left">⭐⭐</td></tr><tr><td align="left"><strong>技术极客</strong></td><td align="left">⭐⭐⭐⭐⭐</td><td align="left">⭐⭐⭐</td></tr><tr><td align="left"><strong>普通用户轻度使用</strong></td><td align="left">⭐⭐</td><td align="left">⭐⭐⭐⭐⭐</td></tr><tr><td align="left"><strong>快速上手</strong></td><td align="left">⭐⭐</td><td align="left">⭐⭐⭐⭐⭐</td></tr><tr><td align="left"><strong>安全可控</strong></td><td align="left">⭐⭐（需自行保障）</td><td align="left">⭐⭐⭐⭐⭐（厂商保障）</td></tr></tbody></table>
<h3 data-id="heading-26">与其他AI桌面操作工具的深度对比</h3>
<h4 data-id="heading-27">vs 豆包/千问App：定位差异</h4>
<p><strong>豆包/千问App</strong>：</p>
<ul>
<li>定位：面向大众的AI助手</li>
<li>权限：受限，以安全为先</li>
<li>部署：云端为主，部分本地</li>
<li>定制：有限，依赖厂商能力</li>
<li>适用：普通用户日常使用</li>
</ul>
<p><strong>Moltbot</strong>：</p>
<ul>
<li>定位：面向技术极客的AI代理框架</li>
<li>权限：全量，用户自行承担风险</li>
<li>部署：完全本地，数据不上云</li>
<li>定制：高度可定制，开源生态</li>
<li>适用：技术极客、隐私敏感用户</li>
</ul>
<p><strong>核心差异</strong>：不是技术差异，而是<strong>产品定位和用户群体的差异</strong>。</p>
<h4 data-id="heading-28">vs AutoGPT/AutoGen：架构差异</h4>
<p><strong>AutoGPT/AutoGen</strong>：</p>
<ul>
<li>架构：Agent框架，专注于任务规划</li>
<li>能力：AI推理和规划能力强</li>
<li>工具：需要自行集成桌面操作能力</li>
<li>适用：研究和实验场景</li>
</ul>
<p><strong>Moltbot</strong>：</p>
<ul>
<li>架构：Gateway + Protocol，专注于系统集成</li>
<li>能力：系统集成和工具调用能力强</li>
<li>工具：内置丰富的桌面操作能力</li>
<li>适用：实际生产场景</li>
</ul>
<p><strong>核心差异</strong>：Moltbot 更注重<strong>系统集成</strong>，AutoGPT 更注重<strong>AI推理</strong>。</p>
<h4 data-id="heading-29">vs 传统自动化工具：AI能力差异</h4>
<p><strong>传统自动化工具</strong>（Mac Automator、Windows Task Scheduler）：</p>
<ul>
<li>能力：基于规则的自动化</li>
<li>灵活性：需要预先定义规则</li>
<li>AI能力：无，无法理解自然语言</li>
<li>适用：固定流程的自动化</li>
</ul>
<p><strong>Moltbot</strong>：</p>
<ul>
<li>能力：基于AI的智能自动化</li>
<li>灵活性：可以理解自然语言，动态规划任务</li>
<li>AI能力：强，可以处理复杂和不确定的任务</li>
<li>适用：需要智能决策的自动化</li>
</ul>
<p><strong>核心差异</strong>：Moltbot 的<strong>AI能力</strong>是传统工具无法替代的。</p>
<h3 data-id="heading-30">技术实现深度剖析</h3>
<h4 data-id="heading-31">Gateway 架构的优势与局限</h4>
<p><strong>优势</strong>：</p>
<ul>
<li>解耦设计，易于扩展</li>
<li>统一协议，降低复杂度</li>
<li>状态管理，支持多设备同步</li>
</ul>
<p><strong>局限</strong>：</p>
<ul>
<li>Gateway 成为单点故障</li>
<li>协议转换可能带来性能损耗</li>
<li>状态同步在复杂场景下可能不一致</li>
</ul>
<h4 data-id="heading-32">本地记忆系统的设计</h4>
<p><strong>存储结构</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">.moltbot/</span>
<span class="hljs-string">├──</span> <span class="hljs-string">memory/</span>
<span class="hljs-string">│</span>   <span class="hljs-string">├──</span> <span class="hljs-string">daily/</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>   <span class="hljs-string">├──</span> <span class="hljs-number">2026-01-27.</span><span class="hljs-string">md</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>   <span class="hljs-string">└──</span> <span class="hljs-number">2026-01-28.</span><span class="hljs-string">md</span>
<span class="hljs-string">│</span>   <span class="hljs-string">└──</span> <span class="hljs-string">long-term/</span>
<span class="hljs-string">│</span>       <span class="hljs-string">├──</span> <span class="hljs-string">facts.md</span>
<span class="hljs-string">│</span>       <span class="hljs-string">├──</span> <span class="hljs-string">preferences.md</span>
<span class="hljs-string">│</span>       <span class="hljs-string">└──</span> <span class="hljs-string">relationships.md</span>
</code></pre>
<p><strong>检索机制</strong>：</p>
<ul>
<li>基于关键词匹配</li>
<li>结合时间戳和相关性</li>
<li>人类可编辑和审查</li>
</ul>
<p><strong>局限性</strong>：</p>
<ul>
<li>相比向量数据库，检索精度可能不足</li>
<li>大规模记忆管理可能成为瓶颈</li>
<li>需要人工维护和清理</li>
</ul>
<h4 data-id="heading-33">技能系统的扩展性</h4>
<p><strong>技能结构</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># skill.yaml</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">"file-organizer"</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">"自动整理文件"</span>
<span class="hljs-attr">triggers:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">"整理文件"</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">"organize files"</span>
<span class="hljs-attr">actions:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">type:</span> <span class="hljs-string">"file-system"</span>
    <span class="hljs-attr">operation:</span> <span class="hljs-string">"organize"</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">pattern:</span> <span class="hljs-string">"*.pdf"</span>
        <span class="hljs-attr">destination:</span> <span class="hljs-string">"Documents/PDFs"</span>
</code></pre>
<p><strong>扩展能力</strong>：</p>
<ul>
<li>支持自定义技能开发</li>
<li>技能可以组合和复用</li>
<li>社区贡献丰富的技能库</li>
</ul>
<p><strong>局限性</strong>：</p>
<ul>
<li>技能开发需要技术背景</li>
<li>技能之间的冲突处理机制不完善</li>
<li>缺乏技能市场和审核机制</li>
</ul>
<hr/>
<h2 data-id="heading-34">项目地址与资源</h2>
<h3 data-id="heading-35">官方资源</h3>
<ul>
<li>🌟 <strong>GitHub</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fmoltbot" target="_blank" title="https://github.com/moltbot/moltbot" ref="nofollow noopener noreferrer">github.com/moltbot/mol…</a></li>
<li>🌐 <strong>官网</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fmolt.bot" target="_blank" title="https://molt.bot" ref="nofollow noopener noreferrer">molt.bot</a></li>
<li>📚 <strong>文档</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.molt.bot" target="_blank" title="https://docs.molt.bot" ref="nofollow noopener noreferrer">docs.molt.bot</a></li>
<li>🐛 <strong>Issues</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fmoltbot%2Fissues" target="_blank" title="https://github.com/moltbot/moltbot/issues" ref="nofollow noopener noreferrer">GitHub Issues</a></li>
<li>💬 <strong>Discussions</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fmoltbot%2Fdiscussions" target="_blank" title="https://github.com/moltbot/moltbot/discussions" ref="nofollow noopener noreferrer">GitHub Discussions</a></li>
<li>📦 <strong>Releases</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fmoltbot%2Freleases" target="_blank" title="https://github.com/moltbot/moltbot/releases" ref="nofollow noopener noreferrer">GitHub Releases</a></li>
</ul>
<h3 data-id="heading-36">相关资源</h3>
<ul>
<li><strong>作者博客</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fsteipete.me" target="_blank" title="https://steipete.me" ref="nofollow noopener noreferrer">steipete.me</a></li>
<li><strong>Molty介绍</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fclawd.me" target="_blank" title="https://clawd.me" ref="nofollow noopener noreferrer">clawd.me</a></li>
<li><strong>社区贡献</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fmoltbot%2Fgraphs%2Fcontributors" target="_blank" title="https://github.com/moltbot/moltbot/graphs/contributors" ref="nofollow noopener noreferrer">GitHub Contributors</a></li>
<li><strong>安全报告</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fmoltbot%2Fsecurity" target="_blank" title="https://github.com/moltbot/moltbot/security" ref="nofollow noopener noreferrer">GitHub Security</a></li>
</ul>
<h3 data-id="heading-37">适用人群</h3>
<p><strong>强烈推荐</strong>：</p>
<ul>
<li>✅ 技术极客和开发者</li>
<li>✅ 对隐私敏感的用户</li>
<li>✅ 需要高度定制化AI助手的用户</li>
<li>✅ 愿意折腾配置的技术爱好者</li>
<li>✅ 想要学习AI代理实现的研究者</li>
</ul>
<p><strong>不推荐</strong>：</p>
<ul>
<li>❌ 普通用户（配置成本太高）</li>
<li>❌ 轻度使用需求（现有工具更省心）</li>
<li>❌ 对安全要求极高的生产环境（风险自行承担）</li>
<li>❌ 缺乏技术背景的用户（上手难度高）</li>
</ul>
<hr/>
<p><em>欢迎来我中的<a href="https://link.juejin.cn?target=https%3A%2F%2Fhome.wonlab.top" target="_blank" title="https://home.wonlab.top" ref="nofollow noopener noreferrer">个人主页</a>找到更多有用的知识和有趣的产品</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 15网络子系统深度解析（一）：ConnectivityService与网络管理框架全解析]]></title>    <link>https://juejin.cn/post/7600060691350405162</link>    <guid>https://juejin.cn/post/7600060691350405162</guid>    <pubDate>2026-01-28T12:20:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600060691350405162" data-draft-id="7600219080046002219" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 15网络子系统深度解析（一）：ConnectivityService与网络管理框架全解析"/> <meta itemprop="keywords" content="Android,源码阅读,性能优化"/> <meta itemprop="datePublished" content="2026-01-28T12:20:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冬奇Lab"/> <meta itemprop="url" content="https://juejin.cn/user/1857501105781193"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 15网络子系统深度解析（一）：ConnectivityService与网络管理框架全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1857501105781193/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冬奇Lab
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T12:20:27.000Z" title="Wed Jan 28 2026 12:20:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>网络连接是现代移动设备最核心的功能之一。从打开网页、收发消息，到视频通话、在线游戏，每一个网络操作背后，都有Android网络子系统在默默工作。而<strong>ConnectivityService</strong>，正是这个庞大系统的"中枢大脑"。</p>
<p>在本系列的第一篇文章中，我们将深入探索：</p>
<h3 data-id="heading-1">为什么ConnectivityService如此重要？</h3>
<p>想象这样一个场景：你正在用WiFi观看高清视频，突然WiFi信号变弱。Android系统需要在1秒内完成以下复杂操作：</p>
<ol>
<li><strong>监测WiFi质量下降</strong> - NetworkMonitor持续验证网络</li>
<li><strong>评估切换时机</strong> - NetworkRanker对比WiFi和移动网络得分</li>
<li><strong>准备移动网络</strong> - TelephonyNetworkFactory激活移动数据</li>
<li><strong>无缝切换</strong> - 在不中断视频的情况下迁移连接</li>
<li><strong>通知应用</strong> - 通过NetworkCallback告知网络变更</li>
</ol>
<p>这一切，都由ConnectivityService协调完成。它就像交通指挥中心，管理着设备上所有网络的"交通"。</p>
<h3 data-id="heading-2">本文内容概览</h3>
<ol>
<li>
<p><strong>ConnectivityService架构总览</strong></p>
<ul>
<li>核心职责与设计理念</li>
<li>与其他系统服务的关系</li>
<li>Android 15的架构演进</li>
</ul>
</li>
<li>
<p><strong>NetworkAgent机制深度解析</strong></p>
<ul>
<li>NetworkAgent生命周期</li>
<li>网络状态上报流程</li>
<li>WiFi/Cellular的Agent实现</li>
</ul>
</li>
<li>
<p><strong>NetworkFactory工作原理</strong></p>
<ul>
<li>网络请求匹配机制</li>
<li>Factory评分与竞争</li>
<li>按需网络激活</li>
</ul>
</li>
<li>
<p><strong>网络状态管理</strong></p>
<ul>
<li>9种网络状态详解</li>
<li>状态机转换流程</li>
<li>Linger机制</li>
</ul>
</li>
<li>
<p><strong>WiFi与移动网络切换</strong></p>
<ul>
<li>切换决策算法</li>
<li>NetworkRanker评分机制</li>
<li>无缝切换实现</li>
</ul>
</li>
<li>
<p><strong>实战：网络问题诊断</strong></p>
<ul>
<li>WiFi连接失败排查</li>
<li>网络切换异常定位</li>
<li>性能优化技巧</li>
</ul>
</li>
</ol>
<p>让我们开始这段深入Android网络核心的旅程！</p>
<hr/>
<h2 data-id="heading-3">一、ConnectivityService架构总览</h2>
<h3 data-id="heading-4">1.1 ConnectivityService的核心职责</h3>
<p>ConnectivityService是Android网络栈的"总管家"，负责：</p>
<pre><code class="hljs language-objectivec" lang="objectivec">┌────────────────────────────────────────┐
│      ConnectivityService核心职责        │
├────────────────────────────────────────┤
│ <span class="hljs-number">1.</span> 网络生命周期管理                     │
│    - 创建/销毁网络                      │
│    - 监控网络状态                       │
│    - 处理网络切换                       │
│                                        │
│ <span class="hljs-number">2.</span> 网络请求调度                         │
│    - 接收NetworkRequest                │
│    - 分发到对应NetworkFactory          │
│    - 管理请求优先级                     │
│                                        │
│ <span class="hljs-number">3.</span> 网络能力管理                         │
│    - NetworkCapabilities匹配           │
│    - 网络评分(NetworkScore)            │
│    - 默认网络选择                       │
│                                        │
│ <span class="hljs-number">4.</span> 网络验证                            │
│    - 触发NetworkMonitor验证            │
│    - 处理Captive Portal               │
│    - 管理部分连接状态                   │
│                                        │
│ <span class="hljs-number">5.</span> 应用网络权限                         │
│    - <span class="hljs-built_in">UID</span>网络访问控制                    │
│    - 后台数据限制                       │
│    - VPN隧道管理                       │
└────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-5">1.2 整体架构</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/424ee010e395475da12c022ee30aad87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770207627&amp;x-signature=tjXJzYy5buG2mXRro1kDAt7b2co%3D" alt="07-01-connectivityservice-architecture.png" loading="lazy"/></p>
<p><strong>架构分层说明</strong>：</p>
<h4 data-id="heading-6"><strong>应用层（Application Layer）</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 应用使用ConnectivityManager API</span>
<span class="hljs-type">ConnectivityManager</span> <span class="hljs-variable">cm</span> <span class="hljs-operator">=</span> (ConnectivityManager)
    context.getSystemService(Context.CONNECTIVITY_SERVICE);

<span class="hljs-comment">// 请求网络</span>
<span class="hljs-type">NetworkRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequest</span>.Builder()
    .addCapability(NetworkCapabilities.NET_CAPABILITY_INTERNET)
    .addTransportType(NetworkCapabilities.TRANSPORT_WIFI)
    .build();

cm.requestNetwork(request, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkCallback</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAvailable</span><span class="hljs-params">(Network network)</span> {
        <span class="hljs-comment">// 网络可用</span>
    }
});
</code></pre>
<h4 data-id="heading-7"><strong>Framework层（ConnectivityService核心）</strong></h4>
<p>ConnectivityService源码位置：</p>
<pre><code class="hljs language-bash" lang="bash">packages/modules/Connectivity/service/src/com/android/server/ConnectivityService.java
</code></pre>
<p><strong>核心数据结构</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// frameworks/.../ConnectivityService.java (精简版)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectivityService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IConnectivityManager</span>.Stub {

    <span class="hljs-comment">// 所有NetworkAgent的集合</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> HashMap&lt;Messenger, NetworkAgentInfo&gt; mNetworkAgentInfos =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

    <span class="hljs-comment">// 所有NetworkRequest的集合</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SparseArray&lt;NetworkRequestInfo&gt; mNetworkRequests =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">SparseArray</span>&lt;&gt;();

    <span class="hljs-comment">// 所有NetworkFactory的集合</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ArrayList&lt;NetworkFactoryInfo&gt; mNetworkFactoryInfos =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

    <span class="hljs-comment">// 当前默认网络</span>
    <span class="hljs-keyword">private</span> NetworkAgentInfo mDefaultNetwork;

    <span class="hljs-comment">// 网络评分器</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> NetworkRanker mNetworkRanker;

    <span class="hljs-comment">// 权限监控</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PermissionMonitor mPermissionMonitor;

    <span class="hljs-comment">// 核心方法：注册NetworkAgent</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerNetworkAgent</span><span class="hljs-params">(Messenger messenger,
                                     NetworkInfo networkInfo,
                                     LinkProperties linkProperties,
                                     NetworkCapabilities networkCapabilities,
                                     <span class="hljs-type">int</span> currentScore,
                                     NetworkAgentConfig networkAgentConfig,
                                     <span class="hljs-type">int</span> factorySerialNumber)</span> {

        <span class="hljs-comment">// 1. 创建NetworkAgentInfo</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">NetworkAgentInfo</span> <span class="hljs-variable">nai</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkAgentInfo</span>(
            messenger, <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncChannel</span>(),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Network</span>(mNextNetworkId++),
            networkInfo, linkProperties,
            networkCapabilities, currentScore,
            mContext, mHandler,
            networkAgentConfig, <span class="hljs-built_in">this</span>,
            mNetd, mDnsResolver,
            mNMS, factorySerialNumber);

        <span class="hljs-comment">// 2. 分配NetId</span>
        <span class="hljs-keyword">try</span> {
            mNetd.networkCreate(nai.network.netId,
                               NativeNetworkType.PHYSICAL);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            loge(<span class="hljs-string">"Error creating network "</span> + nai.network.netId);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 3. 添加到管理列表</span>
        mNetworkAgentInfos.put(messenger, nai);

        <span class="hljs-comment">// 4. 通知NetworkMonitor开始验证</span>
        nai.networkMonitor.start();

        <span class="hljs-comment">// 5. 匹配NetworkRequest</span>
        rematchNetworkAndRequests(nai, ReapUnvalidatedNetworks.DONT_REAP);
    }

    <span class="hljs-comment">// 核心方法：处理NetworkRequest</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestNetwork</span><span class="hljs-params">(NetworkCapabilities nc,
                               Messenger messenger,
                               <span class="hljs-type">int</span> timeoutMs,
                               IBinder binder,
                               <span class="hljs-type">int</span> legacyType,
                               <span class="hljs-meta">@CallbackFlags</span> <span class="hljs-type">int</span> callbackFlags)</span> {

        <span class="hljs-comment">// 1. 权限检查</span>
        enforceAccessPermission();

        <span class="hljs-comment">// 2. 创建NetworkRequestInfo</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">NetworkRequestInfo</span> <span class="hljs-variable">nri</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequestInfo</span>(
            messenger, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequest</span>(nc, legacyType,
            nextNetworkRequestId(), NetworkRequest.Type.REQUEST),
            binder);

        <span class="hljs-comment">// 3. 保存请求</span>
        mNetworkRequests.put(nri.request.requestId, nri);

        <span class="hljs-comment">// 4. 发送给所有NetworkFactory</span>
        <span class="hljs-keyword">for</span> (NetworkFactoryInfo nfi : mNetworkFactoryInfos) {
            nfi.asyncChannel.sendMessage(
                android.net.NetworkFactory.CMD_REQUEST_NETWORK,
                nri.request);
        }

        <span class="hljs-comment">// 5. 尝试匹配现有网络</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">NetworkAgentInfo</span> <span class="hljs-variable">bestNetwork</span> <span class="hljs-operator">=</span>
            getBestNetwork(nri.request, <span class="hljs-literal">null</span>);
        <span class="hljs-keyword">if</span> (bestNetwork != <span class="hljs-literal">null</span>) {
            callCallbackForRequest(nri, bestNetwork,
                                  ConnectivityManager.CALLBACK_AVAILABLE);
        }
    }
}
</code></pre>
<h3 data-id="heading-8">1.3 与其他系统服务的关系</h3>
<pre><code class="hljs language-arduino" lang="arduino">┌──────────────────────────────────────────────┐
│           ConnectivityService                │
│              (核心协调者)                      │
└─────────────┬────────────────────────────────┘
              │
    ┌─────────┼─────────┬──────────┬──────────┐
    │         │         │          │          │
    ▼         ▼         ▼          ▼          ▼
┌────────┐ ┌──────┐ ┌────────┐ ┌──────┐ ┌────────┐
│NetworkStack│Netd │ │Telephony│ <span class="hljs-built_in">WiFi</span> │ │VpnManager
│        │ │      │ │Service │ |Service│ │        │
│验证网络  │ │路由  │ │蜂窝网络 │ |无线   │  │VPN隧道  │
│        │ │配置   │ │        │|      │  │        │
└────────┘ └──────┘ └────────┘ └──────┘ └────────┘
</code></pre>
<p><strong>关键交互</strong>：</p>
<ol>
<li><strong>与NetworkStack交互</strong> - 网络验证</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ConnectivityService触发验证</span>
nai.networkMonitor.notifyNetworkConnected(
    nai.linkProperties, nai.networkCapabilities);

<span class="hljs-comment">// NetworkStack执行HTTP探测</span>
<span class="hljs-comment">// 返回验证结果(VALID/PORTAL/INVALID)</span>
</code></pre>
<ol start="2">
<li><strong>与Netd交互</strong> - 路由配置</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 设置默认网络</span>
mNetd.networkSetDefault(nai.network.netId);

<span class="hljs-comment">// 添加路由规则</span>
mNetd.networkAddRoute(netId, ifname, destination, nexthop);
</code></pre>
<ol start="3">
<li><strong>与TelephonyService交互</strong> - 移动网络</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 请求移动数据连接</span>
telephonyNetworkFactory.needNetworkFor(request);

<span class="hljs-comment">// 接收数据连接状态变化</span>
onDataConnectionStateChanged(state, networkType);
</code></pre>
<h3 data-id="heading-9">1.4 Android 15的架构改进</h3>
<h4 data-id="heading-10"><strong>改进1：模块化NetworkStack</strong></h4>
<p>Android 10开始，NetworkStack从system_server独立为单独进程：</p>
<pre><code class="hljs language-markdown" lang="markdown">Android 9及之前:
┌────────────────────────┐
│    system<span class="hljs-emphasis">_server       │
│  ┌──────────────────┐  │
│  │ConnectivityService│  │
│  │  + NetworkMonitor │  │ ← 验证逻辑耦合
│  └──────────────────┘  │
└────────────────────────┘

Android 10+:
┌────────────────────────┐     ┌──────────────┐
│    system_</span>server       │     │NetworkStack  │
│  ┌──────────────────┐  │     │  进程         │
│  │ConnectivityService│◄─────►│┌────────────┐│
│  └──────────────────┘  │ AIDL││NetworkMonitor│
└────────────────────────┘     │└────────────┘│
<span class="hljs-code">                              └──────────────┘
                              ↑ 可独立更新
</span></code></pre>
<p><strong>好处</strong>：</p>
<ul>
<li>NetworkStack可通过APK更新，无需OTA</li>
<li>隔离故障，NetworkStack崩溃不影响system_server</li>
<li>更好的安全边界</li>
</ul>
<h4 data-id="heading-11"><strong>改进2：eBPF网络策略</strong></h4>
<p>Android 15使用eBPF替代iptables：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// kernel BPF程序 - 快速数据包过滤</span>
SEC(<span class="hljs-string">"cgroup/sock"</span>)
<span class="hljs-type">int</span> <span class="hljs-title function_">bpf_cgroup_sock_filter</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bpf_sock *sk)</span> {
    __u32 uid = bpf_get_current_uid_gid();

    <span class="hljs-comment">// 查询UID是否允许访问网络</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uid_permission_value</span> *<span class="hljs-title">value</span> =</span>
        bpf_map_lookup_elem(&amp;uid_permission_map, &amp;uid);

    <span class="hljs-keyword">if</span> (value &amp;&amp; value-&gt;permission == PERMISSION_DENIED)
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <span class="hljs-comment">// 拒绝连接</span>

    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;  <span class="hljs-comment">// 允许连接</span>
}
</code></pre>
<p><strong>性能提升</strong>：</p>
<ul>
<li>iptables规则匹配：O(n)</li>
<li>eBPF哈希查找：O(1)</li>
<li>延迟降低：~100μs → ~10μs</li>
</ul>
<h4 data-id="heading-12"><strong>改进3：Multi-Network API增强</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Android 15新增：网络切片(Network Slicing)支持</span>
<span class="hljs-type">NetworkRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequest</span>.Builder()
    .addCapability(NET_CAPABILITY_ENTERPRISE)  <span class="hljs-comment">// 企业专网</span>
    .setEnterpriseId(NET_ENTERPRISE_ID_1)      <span class="hljs-comment">// 切片ID</span>
    .build();

<span class="hljs-comment">// 5G网络切片可以为不同业务提供差异化QoS</span>
</code></pre>
<hr/>
<h2 data-id="heading-13">二、NetworkAgent机制深度解析</h2>
<h3 data-id="heading-14">2.1 NetworkAgent是什么？</h3>
<p><strong>NetworkAgent</strong>是网络提供者（如WiFi、Cellular、Ethernet、VPN）与ConnectivityService之间的"信使"。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-built_in">WiFi</span>底层驱动
    ↓
<span class="hljs-built_in">WiFiNetworkAgent</span> (继承NetworkAgent)
    ↓ Messenger通信
ConnectivityService
</code></pre>
<h3 data-id="heading-15">2.2 NetworkAgent生命周期</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca7e77cfb92d4126a7313de48768dae6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770207627&amp;x-signature=gKkU%2FnrZvJp7TwzFeV%2B%2FRB9HLPU%3D" alt="07-02-network-state-machine.png" loading="lazy"/></p>
<p><strong>9种核心状态详解</strong>：</p>
<h4 data-id="heading-16"><strong>1. DISCONNECTED（断开）</strong></h4>
<ul>
<li>初始状态，NetworkAgent尚未创建</li>
<li>或网络已完全销毁</li>
</ul>
<h4 data-id="heading-17"><strong>2. CONNECTING（连接中）</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// WiFiNetworkAgent创建时</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WiFiNetworkAgent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">NetworkAgent</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">WiFiNetworkAgent</span><span class="hljs-params">(Context context, ...)</span> {
        <span class="hljs-built_in">super</span>(context, looper, TAG,
              networkInfo,        <span class="hljs-comment">// 初始状态：CONNECTING</span>
              networkCapabilities,
              linkProperties,
              networkScore,
              config);
    }
}
</code></pre>
<h4 data-id="heading-18"><strong>3. CONNECTED（已连接）</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 物理连接建立后，Agent上报</span>
sendLinkProperties(linkProperties);
sendNetworkCapabilities(networkCapabilities);
sendNetworkScore(score);

<span class="hljs-comment">// ConnectivityService收到后更新状态 → CONNECTED</span>
</code></pre>
<h4 data-id="heading-19"><strong>4. VALIDATING（验证中）</strong></h4>
<p>ConnectivityService自动触发NetworkMonitor：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// packages/modules/NetworkStack/.../NetworkMonitor.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyNetworkConnected</span><span class="hljs-params">(LinkProperties lp,
                                   NetworkCapabilities nc)</span> {
    <span class="hljs-comment">// 1. HTTP探测</span>
    <span class="hljs-type">ValidationProbeEvent</span> <span class="hljs-variable">probeResult</span> <span class="hljs-operator">=</span>
        isCaptivePortal(mCleartextDnsNetwork);

    <span class="hljs-comment">// 2. HTTPS探测</span>
    probeResult = httpsProbe();

    <span class="hljs-comment">// 3. DNS探测</span>
    probeResult = sendDnsProbe(mPrivateDnsProviderHostname);

    <span class="hljs-comment">// 4. 返回验证结果</span>
    <span class="hljs-keyword">if</span> (allProbesSucceeded) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValidationResult</span>(
            NetworkValidationResult.VALID, ...);
    }
}
</code></pre>
<p><strong>验证URL（可配置）</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># HTTP</span>
http://connectivitycheck.gstatic.com/generate_204

<span class="hljs-comment"># HTTPS</span>
https://www.google.com/generate_204

<span class="hljs-comment"># 返回HTTP 204表示验证通过</span>
</code></pre>
<h4 data-id="heading-20"><strong>5. VALIDATED（已验证）</strong></h4>
<p>验证通过后，网络成为"候选默认网络"：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ConnectivityService.java</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateNetworkInfo</span><span class="hljs-params">(NetworkAgentInfo nai, NetworkInfo info)</span> {
    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">oldScore</span> <span class="hljs-operator">=</span> nai.getCurrentScore();

    <span class="hljs-keyword">if</span> (info.getDetailedState() == NetworkInfo.DetailedState.CONNECTED) {
        <span class="hljs-comment">// 网络验证通过，提升评分</span>
        nai.setScore(oldScore + <span class="hljs-number">10</span>);

        <span class="hljs-comment">// 重新评估默认网络</span>
        rematchAllNetworksAndRequests();
    }
}
</code></pre>
<h4 data-id="heading-21"><strong>6. CAPTIVE_PORTAL（强制门户）</strong></h4>
<p>检测到需要网页登录（如公共WiFi）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// NetworkMonitor检测到HTTP 302重定向</span>
<span class="hljs-keyword">if</span> (probeResult.isPortal()) {
    <span class="hljs-comment">// 显示登录通知</span>
    showSignInNotification(nai);

    <span class="hljs-comment">// 等待用户登录后重新验证</span>
    scheduleReevaluation(REEVALUATION_DELAY_MS);
}
</code></pre>
<p>用户体验：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 连接WiFi
<span class="hljs-bullet">2.</span> 系统检测到强制门户
<span class="hljs-bullet">3.</span> 弹出通知："需要登录WiFi网络"
<span class="hljs-bullet">4.</span> 点击通知打开登录页面
<span class="hljs-bullet">5.</span> 登录成功后自动重新验证
<span class="hljs-bullet">6.</span> 状态变为VALIDATED
</code></pre>
<h4 data-id="heading-22"><strong>7. LOSING（即将丢失）</strong></h4>
<p>Linger机制 - 给应用迁移时间：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// packages/modules/Connectivity/.../ConnectivityService.java</span>

<span class="hljs-comment">// 当更好的网络出现时</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleLingerComplete</span><span class="hljs-params">(NetworkAgentInfo nai)</span> {
    <span class="hljs-comment">// Linger倒计时开始（默认30秒）</span>
    nai.lingerExpiryMs = SystemClock.elapsedRealtime()
                        + mLingerDelayMs;

    <span class="hljs-comment">// 通知应用网络即将失去</span>
    <span class="hljs-keyword">for</span> (NetworkRequestInfo nri : nai.networkRequests) {
        callCallbackForRequest(nri, nai,
            ConnectivityManager.CALLBACK_LOSING,
            mLingerDelayMs);
    }
}
</code></pre>
<p>应用可以：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 应用收到CALLBACK_LOSING</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onLosing</span><span class="hljs-params">(Network network, <span class="hljs-type">int</span> maxMsToLive)</span> {
    <span class="hljs-comment">// 还有maxMsToLive毫秒，快速迁移连接</span>
    <span class="hljs-keyword">if</span> (maxMsToLive &gt; <span class="hljs-number">0</span> &amp;&amp; maxMsToLive &lt; <span class="hljs-number">30000</span>) {
        <span class="hljs-comment">// 将TCP连接迁移到新网络</span>
        migrateConnectionsToNewNetwork();
    }
}
</code></pre>
<h4 data-id="heading-23"><strong>8. SUSPENDED（暂停）</strong></h4>
<p>网络物理可用但逻辑暂停（如飞行模式）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 进入飞行模式</span>
when (Intent.ACTION_AIRPLANE_MODE_CHANGED) {
    <span class="hljs-keyword">if</span> (isAirplaneModeOn) {
        <span class="hljs-comment">// 暂停所有网络（除了local-only）</span>
        <span class="hljs-keyword">for</span> (NetworkAgentInfo nai : mNetworkAgentInfos.values()) {
            <span class="hljs-keyword">if</span> (!nai.isLocalNetwork()) {
                nai.networkInfo.setDetailedState(
                    NetworkInfo.DetailedState.SUSPENDED,
                    <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-24"><strong>9. DISCONNECTING（断开中）</strong></h4>
<p>主动或被动断开：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 主动断开</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">disconnect</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// Agent通知ConnectivityService</span>
    mAsyncChannel.sendMessage(CMD_NETWORK_DISCONNECT);
}

<span class="hljs-comment">// ConnectivityService处理</span>
<span class="hljs-keyword">case</span> CMD_NETWORK_DISCONNECT:
    <span class="hljs-comment">// 1. 移除路由</span>
    mNetd.networkDestroy(nai.network.netId);

    <span class="hljs-comment">// 2. 通知应用</span>
    callCallbackForRequest(nri, nai, CALLBACK_LOST);

    <span class="hljs-comment">// 3. 清理Agent</span>
    mNetworkAgentInfos.remove(nai.messenger);
    <span class="hljs-keyword">break</span>;
</code></pre>
<h3 data-id="heading-25">2.3 NetworkAgent实现示例：WiFiNetworkAgent</h3>
<p>源码位置：</p>
<pre><code class="hljs language-bash" lang="bash">packages/modules/Wifi/service/java/com/android/server/wifi/WifiNetworkAgent.java
</code></pre>
<p><strong>创建过程</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// frameworks/.../WifiNetworkAgent.java (简化版)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WifiNetworkAgent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">NetworkAgent</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> WifiInfo mWifiInfo;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">WifiNetworkAgent</span><span class="hljs-params">(Context context, Looper looper,
                           WifiInfo wifiInfo,
                           NetworkCapabilities nc,
                           LinkProperties lp,
                           NetworkScore score)</span> {
        <span class="hljs-built_in">super</span>(context, looper, <span class="hljs-string">"WifiNetworkAgent"</span>,
              nc, lp, score, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkAgentConfig</span>.Builder().build(),
              NetworkProvider.ID_WIFI);

        mWifiInfo = wifiInfo;
        register();  <span class="hljs-comment">// 向ConnectivityService注册</span>
    }

    <span class="hljs-comment">// 当WiFi连接信息变化时</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendNetworkCapabilities</span><span class="hljs-params">(NetworkCapabilities nc)</span> {
        <span class="hljs-comment">// 更新WiFi特定能力</span>
        nc.setSignalStrength(mWifiInfo.getRssi());
        nc.setLinkUpstreamBandwidthKbps(
            mWifiInfo.getLinkSpeed() * <span class="hljs-number">1000</span>);

        <span class="hljs-built_in">super</span>.sendNetworkCapabilities(nc);
    }

    <span class="hljs-comment">// 当IP配置完成时</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendLinkProperties</span><span class="hljs-params">(LinkProperties lp)</span> {
        <span class="hljs-comment">// WiFi接口名</span>
        lp.setInterfaceName(mWifiInfo.getInterfaceName());

        <span class="hljs-comment">// IP地址</span>
        lp.addLinkAddress(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkAddress</span>(ipAddress, prefixLength));

        <span class="hljs-comment">// DNS服务器</span>
        <span class="hljs-keyword">for</span> (InetAddress dns : dnsServers) {
            lp.addDnsServer(dns);
        }

        <span class="hljs-comment">// 路由</span>
        lp.addRoute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RouteInfo</span>(destination, gateway, ifname));

        <span class="hljs-built_in">super</span>.sendLinkProperties(lp);
    }
}
</code></pre>
<p><strong>状态上报流程</strong>：</p>
<pre><code class="hljs language-css" lang="css">WiFi驱动: DHCP成功获取IP
    ↓
WifiStateMachine: 解析IP配置
    ↓
WifiNetworkAgent.<span class="hljs-built_in">sendLinkProperties</span>(lp)
    ↓
NetworkAgent.<span class="hljs-built_in">sendMessage</span>(EVENT_NETWORK_PROPERTIES_CHANGED, lp)
    ↓
ConnectivityService收到消息
    ↓
<span class="hljs-built_in">updateLinkProperties</span>(nai, lp)
    ↓
触发NetworkMonitor验证
    ↓
<span class="hljs-built_in">notifyNetworkCallbacks</span>(CALLBACK_IP_CHANGED)
    ↓
应用收到<span class="hljs-built_in">onLinkPropertiesChanged</span>()回调
</code></pre>
<hr/>
<h2 data-id="heading-26">三、NetworkFactory工作原理</h2>
<h3 data-id="heading-27">3.1 NetworkFactory的角色</h3>
<p><strong>NetworkFactory</strong>是"网络工厂"，负责按需创建网络连接。</p>
<pre><code class="hljs language-vbnet" lang="vbnet">应用请求：<span class="hljs-string">"我需要WiFi网络"</span>
    ↓
<span class="hljs-symbol">ConnectivityService:</span> <span class="hljs-string">"哪个Factory能提供WiFi?"</span>
    ↓
<span class="hljs-symbol">WiFiNetworkFactory:</span> <span class="hljs-string">"我可以！"</span>
    ↓
WiFiNetworkFactory激活WiFi连接
    ↓
创建WifiNetworkAgent并注册
</code></pre>
<h3 data-id="heading-28">3.2 Factory注册与评分</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// packages/modules/Wifi/.../WifiNetworkFactory.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WifiNetworkFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">NetworkFactory</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">WifiNetworkFactory</span><span class="hljs-params">(Looper looper, Context context, ...)</span> {
        <span class="hljs-built_in">super</span>(looper, context, <span class="hljs-string">"WifiNetworkFactory"</span>,
              <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkCapabilities</span>.Builder()
                  .addTransportType(TRANSPORT_WIFI)
                  .addCapability(NET_CAPABILITY_INTERNET)
                  .addCapability(NET_CAPABILITY_NOT_RESTRICTED)
                  .build());

        <span class="hljs-comment">// 注册到ConnectivityService</span>
        register();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">needNetworkFor</span><span class="hljs-params">(NetworkRequest request)</span> {
        <span class="hljs-comment">// 收到ConnectivityService的网络请求</span>

        <span class="hljs-comment">// 1. 检查是否能满足请求</span>
        <span class="hljs-keyword">if</span> (!request.hasCapability(NET_CAPABILITY_INTERNET)) {
            <span class="hljs-keyword">return</span>;  <span class="hljs-comment">// 不处理</span>
        }

        <span class="hljs-comment">// 2. 启动WiFi扫描</span>
        mWifiManager.startScan();

        <span class="hljs-comment">// 3. 连接最佳AP</span>
        <span class="hljs-type">WifiConfiguration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> selectBestNetwork(scanResults);
        mWifiManager.connect(config, <span class="hljs-literal">null</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">releaseNetworkFor</span><span class="hljs-params">(NetworkRequest request)</span> {
        <span class="hljs-comment">// NetworkRequest被取消，可以断开WiFi</span>
        <span class="hljs-keyword">if</span> (noMoreRequests()) {
            mWifiManager.disconnect();
        }
    }
}
</code></pre>
<h3 data-id="heading-29">3.3 NetworkRequest匹配机制</h3>
<p><strong>NetworkCapabilities匹配规则</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// NetworkCapabilities.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">satisfiedByNetworkCapabilities</span><span class="hljs-params">(NetworkCapabilities nc)</span> {
    <span class="hljs-comment">// 1. Transport类型必须匹配</span>
    <span class="hljs-keyword">if</span> ((mTransportTypes &amp; nc.mTransportTypes) != mTransportTypes) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">// 2. 必须的Capability都要有</span>
    <span class="hljs-keyword">if</span> ((mNetworkCapabilities &amp; nc.mNetworkCapabilities)
        != mNetworkCapabilities) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">// 3. 禁止的Capability不能有</span>
    <span class="hljs-keyword">if</span> ((mUnwantedNetworkCapabilities &amp; nc.mNetworkCapabilities) != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">// 4. 链路上下行带宽满足要求</span>
    <span class="hljs-keyword">if</span> (getLinkDownstreamBandwidthKbps() &gt;
        nc.getLinkDownstreamBandwidthKbps()) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p><strong>示例：复杂NetworkRequest</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 应用请求：高速、非计费、WiFi直连网络</span>
<span class="hljs-type">NetworkRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequest</span>.Builder()
    .addCapability(NET_CAPABILITY_INTERNET)
    .addCapability(NET_CAPABILITY_NOT_METERED)  <span class="hljs-comment">// 非计费</span>
    .addTransportType(TRANSPORT_WIFI)           <span class="hljs-comment">// 必须WiFi</span>
    .setLinkDownstreamBandwidthKbps(<span class="hljs-number">10000</span>)      <span class="hljs-comment">// 至少10Mbps</span>
    .setNetworkSpecifier(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WifiNetworkSpecifier</span>.Builder()
        .setSsid(<span class="hljs-string">"MyNetwork"</span>)                   <span class="hljs-comment">// 指定SSID</span>
        .build())
    .build();

cm.requestNetwork(request, callback);
</code></pre>
<p><strong>ConnectivityService匹配过程</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ConnectivityService.java</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendUpdatedScoreToFactories</span><span class="hljs-params">(NetworkRequest request)</span> {
    <span class="hljs-comment">// 遍历所有Factory</span>
    <span class="hljs-keyword">for</span> (NetworkFactoryInfo nfi : mNetworkFactoryInfos) {

        <span class="hljs-comment">// 计算该Factory对这个Request的匹配得分</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> nfi.networkCapabilities
            .calculateScore(request.networkCapabilities);

        <span class="hljs-comment">// 发送REQUEST_NETWORK消息，附带分数</span>
        nfi.asyncChannel.sendMessage(CMD_REQUEST_NETWORK,
                                     score, <span class="hljs-number">0</span>, request);
    }
}
</code></pre>
<h3 data-id="heading-30">3.4 Factory竞争机制</h3>
<p>当多个Factory都能满足请求时，通过评分竞争：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// NetworkFactory.java</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(Message msg)</span> {
    <span class="hljs-keyword">switch</span> (msg.what) {
        <span class="hljs-keyword">case</span> CMD_REQUEST_NETWORK:
            <span class="hljs-type">NetworkRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> (NetworkRequest) msg.obj;
            <span class="hljs-type">int</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> msg.arg1;

            <span class="hljs-comment">// 如果分数为0，说明不匹配，释放网络</span>
            <span class="hljs-keyword">if</span> (score == <span class="hljs-number">0</span>) {
                releaseNetworkFor(request);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 分数越高，越应该积极响应</span>
                <span class="hljs-keyword">if</span> (score &gt; mCurrentScore) {
                    needNetworkFor(request);
                }
            }
            <span class="hljs-keyword">break</span>;
    }
}
</code></pre>
<p><strong>实际场景</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">用户请求：联网但不指定类型

WiFiNetworkFactory收到:
  - <span class="hljs-attr">score</span> = <span class="hljs-number">60</span> (WiFi已连接)
  - 无需操作，WiFi已激活

TelephonyNetworkFactory收到:
  - <span class="hljs-attr">score</span> = <span class="hljs-number">50</span> (移动数据可用但未连接)
  - score &lt; WiFi，不激活移动数据

VpnNetworkFactory收到:
  - <span class="hljs-attr">score</span> = <span class="hljs-number">0</span> (VPN无法满足普通请求)
  - 释放VPN请求(如果有)

最终：使用WiFi网络
</code></pre>
<hr/>
<h2 data-id="heading-31">四、WiFi与移动网络切换</h2>
<h3 data-id="heading-32">4.1 切换触发条件</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ConnectivityService.java</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rematchAllNetworksAndRequests</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 1. 重新评估所有网络</span>
    <span class="hljs-keyword">for</span> (NetworkAgentInfo nai : mNetworkAgentInfos.values()) {
        updateNetworkScore(nai);
    }

    <span class="hljs-comment">// 2. 重新选择最佳网络</span>
    <span class="hljs-type">NetworkAgentInfo</span> <span class="hljs-variable">newDefault</span> <span class="hljs-operator">=</span> getBestNetwork();

    <span class="hljs-comment">// 3. 如果默认网络变化</span>
    <span class="hljs-keyword">if</span> (newDefault != mDefaultNetwork) {
        <span class="hljs-comment">// 触发切换</span>
        makeDefault(newDefault);
    }
}
</code></pre>
<p><strong>常见触发场景</strong>：</p>



































<table><thead><tr><th align="left">场景</th><th align="left">触发条件</th><th align="left">切换方向</th></tr></thead><tbody><tr><td align="left">WiFi信号变弱</td><td align="left">RSSI &lt; -75dBm</td><td align="left">WiFi → 移动网络</td></tr><tr><td align="left">WiFi验证失败</td><td align="left">HTTP探测失败</td><td align="left">WiFi → 移动网络</td></tr><tr><td align="left">移动数据打开</td><td align="left">用户手动启用</td><td align="left">无 → 移动网络</td></tr><tr><td align="left">连接到更好的WiFi</td><td align="left">新WiFi RSSI更高</td><td align="left">移动网络 → WiFi</td></tr><tr><td align="left">移出WiFi覆盖</td><td align="left">WiFi断开</td><td align="left">WiFi → 移动网络</td></tr></tbody></table>
<h3 data-id="heading-33">4.2 NetworkRanker评分算法</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// packages/modules/Connectivity/.../NetworkRanker.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkRanker</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">rankNetwork</span><span class="hljs-params">(NetworkAgentInfo nai)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

        <span class="hljs-comment">// 1. 基础分数（Transport类型）</span>
        <span class="hljs-keyword">if</span> (nai.networkCapabilities.hasTransport(TRANSPORT_WIFI)) {
            score += <span class="hljs-number">60</span>;  <span class="hljs-comment">// WiFi基础分60</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nai.networkCapabilities.hasTransport(TRANSPORT_CELLULAR)) {
            score += <span class="hljs-number">50</span>;  <span class="hljs-comment">// 移动网络基础分50</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nai.networkCapabilities.hasTransport(TRANSPORT_ETHERNET)) {
            score += <span class="hljs-number">70</span>;  <span class="hljs-comment">// 以太网基础分70</span>
        }

        <span class="hljs-comment">// 2. 验证状态加分</span>
        <span class="hljs-keyword">if</span> (nai.everValidated) {
            score += <span class="hljs-number">10</span>;  <span class="hljs-comment">// 曾经验证通过+10分</span>
        }
        <span class="hljs-keyword">if</span> (nai.lastValidated) {
            score += <span class="hljs-number">20</span>;  <span class="hljs-comment">// 最近验证通过+20分</span>
        }

        <span class="hljs-comment">// 3. 网络能力加分</span>
        <span class="hljs-keyword">if</span> (nai.networkCapabilities.hasCapability(
            NET_CAPABILITY_NOT_METERED)) {
            score += <span class="hljs-number">5</span>;  <span class="hljs-comment">// 非计费网络+5分</span>
        }
        <span class="hljs-keyword">if</span> (nai.networkCapabilities.hasCapability(
            NET_CAPABILITY_NOT_ROAMING)) {
            score += <span class="hljs-number">5</span>;  <span class="hljs-comment">// 非漫游+5分</span>
        }

        <span class="hljs-comment">// 4. 信号强度影响(WiFi)</span>
        <span class="hljs-keyword">if</span> (nai.networkCapabilities.hasTransport(TRANSPORT_WIFI)) {
            <span class="hljs-type">int</span> <span class="hljs-variable">rssi</span> <span class="hljs-operator">=</span> nai.networkCapabilities.getSignalStrength();
            <span class="hljs-keyword">if</span> (rssi &gt; -<span class="hljs-number">60</span>) score += <span class="hljs-number">10</span>;      <span class="hljs-comment">// 优秀信号</span>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rssi &gt; -<span class="hljs-number">70</span>) score += <span class="hljs-number">5</span>;  <span class="hljs-comment">// 良好信号</span>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rssi &lt; -<span class="hljs-number">80</span>) score -= <span class="hljs-number">10</span>; <span class="hljs-comment">// 差信号扣分</span>
        }

        <span class="hljs-comment">// 5. 链路速度影响</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">linkSpeed</span> <span class="hljs-operator">=</span> nai.networkCapabilities
            .getLinkDownstreamBandwidthKbps();
        <span class="hljs-keyword">if</span> (linkSpeed &gt; <span class="hljs-number">100000</span>) score += <span class="hljs-number">10</span>;  <span class="hljs-comment">// &gt;100Mbps</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (linkSpeed &gt; <span class="hljs-number">10000</span>) score += <span class="hljs-number">5</span>; <span class="hljs-comment">// &gt;10Mbps</span>

        <span class="hljs-comment">// 6. VPN特殊处理</span>
        <span class="hljs-keyword">if</span> (nai.networkCapabilities.hasTransport(TRANSPORT_VPN)) {
            score += <span class="hljs-number">101</span>;  <span class="hljs-comment">// VPN总是优先</span>
        }

        <span class="hljs-keyword">return</span> score;
    }
}
</code></pre>
<p><strong>示例计算</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">场景：<span class="hljs-built_in">WiFi</span>和LTE同时可用

<span class="hljs-built_in">WiFi</span>网络:
  基础分: <span class="hljs-number">60</span>
  验证通过: +<span class="hljs-number">20</span>
  非计费: +<span class="hljs-number">5</span>
  信号强度(<span class="hljs-number">-65</span>dBm): +<span class="hljs-number">5</span>
  速度(<span class="hljs-number">50</span>Mbps): +<span class="hljs-number">5</span>
  总分: <span class="hljs-number">95</span>

LTE网络:
  基础分: <span class="hljs-number">50</span>
  验证通过: +<span class="hljs-number">20</span>
  漫游: <span class="hljs-number">0</span>
  总分: <span class="hljs-number">70</span>

结果：<span class="hljs-built_in">WiFi</span>得分更高，成为默认网络
</code></pre>
<h3 data-id="heading-34">4.3 无缝切换实现</h3>
<p><strong>第一阶段：准备新网络</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ConnectivityService.java</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">makeDefault</span><span class="hljs-params">(NetworkAgentInfo newDefault)</span> {
    <span class="hljs-type">NetworkAgentInfo</span> <span class="hljs-variable">oldDefault</span> <span class="hljs-operator">=</span> mDefaultNetwork;

    <span class="hljs-keyword">if</span> (oldDefault == <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 首次建立默认网络</span>
        setDefaultNetwork(newDefault);
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 1. 配置新网络路由（但不设为默认）</span>
    mNetd.networkAddRoute(newDefault.network.netId,
                         newDefault.linkProperties.getInterfaceName(),
                         <span class="hljs-string">"0.0.0.0/0"</span>, <span class="hljs-literal">null</span>);

    <span class="hljs-comment">// 2. 通知应用新网络可用</span>
    callCallbackForRequest(nri, newDefault, CALLBACK_AVAILABLE);

    <span class="hljs-comment">// 3. 给旧网络30秒Linger时间</span>
    handleLingerComplete(oldDefault);
}
</code></pre>
<p><strong>第二阶段：迁移连接</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 应用收到onAvailable回调</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAvailable</span><span class="hljs-params">(Network network)</span> {
    <span class="hljs-comment">// 主动将Socket绑定到新网络</span>
    network.bindSocket(mySocket);

    <span class="hljs-comment">// 或使用Network.openConnection</span>
    <span class="hljs-type">HttpURLConnection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> (HttpURLConnection)
        network.openConnection(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">"https://example.com"</span>));
}
</code></pre>
<p><strong>第三阶段：切换默认网络</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Linger超时后，切换默认路由</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleLingered</span><span class="hljs-params">(NetworkAgentInfo nai)</span> {
    <span class="hljs-comment">// 1. 移除旧网络默认路由</span>
    mNetd.networkClearDefault();

    <span class="hljs-comment">// 2. 设置新网络为默认</span>
    mNetd.networkSetDefault(mDefaultNetwork.network.netId);

    <span class="hljs-comment">// 3. 通知应用旧网络已丢失</span>
    callCallbackForRequest(nri, nai, CALLBACK_LOST);

    <span class="hljs-comment">// 4. 销毁旧NetworkAgent</span>
    nai.networkMonitor.stop();
    mNetworkAgentInfos.remove(nai.messenger);
}
</code></pre>
<p><strong>用户体验</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">时刻<span class="hljs-number">0</span>s: <span class="hljs-built_in">WiFi</span>信号变弱
  → NetworkMonitor检测到验证失败
  → NetworkRanker重新评分
  → LTE得分超过<span class="hljs-built_in">WiFi</span>

时刻<span class="hljs-number">0.1</span>s: 准备LTE网络
  → TelephonyNetworkFactory激活数据连接
  → <span class="hljs-number">3</span><span class="hljs-number">-5</span>秒后LTE连接建立

时刻<span class="hljs-number">5</span>s: 通知应用
  → 发送<span class="hljs-built_in">CALLBACK_AVAILABLE</span>(LTE)
  → 应用开始迁移连接

时刻<span class="hljs-number">5</span><span class="hljs-number">-35</span>s: Linger期
  → <span class="hljs-built_in">WiFi</span>和LTE并存
  → 新连接使用LTE
  → 旧连接仍用<span class="hljs-built_in">WiFi</span>

时刻<span class="hljs-number">35</span>s: 完成切换
  → <span class="hljs-built_in">WiFi</span>成为默认网络
  → 发送<span class="hljs-built_in">CALLBACK_LOST</span>(<span class="hljs-built_in">WiFi</span>)
  → <span class="hljs-built_in">WiFi</span>断开

用户感知：几乎无感知切换
</code></pre>
<h3 data-id="heading-35">4.4 避免频繁切换</h3>
<p><strong>问题</strong>：WiFi信号在临界值附近波动导致频繁切换</p>
<p><strong>解决方案：Hysteresis（滞后）机制</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// NetworkRanker.java</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">shouldSwitchToNewNetwork</span><span class="hljs-params">(NetworkAgentInfo oldNai,
                                        NetworkAgentInfo newNai)</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">oldScore</span> <span class="hljs-operator">=</span> rankNetwork(oldNai);
    <span class="hljs-type">int</span> <span class="hljs-variable">newScore</span> <span class="hljs-operator">=</span> rankNetwork(newNai);

    <span class="hljs-comment">// 新网络必须显著优于旧网络才切换</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">HYSTERESIS</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;  <span class="hljs-comment">// 滞后阈值</span>

    <span class="hljs-keyword">if</span> (newScore &gt; oldScore + HYSTERESIS) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 新网络显著更好</span>
    }

    <span class="hljs-comment">// 避免抖动：仅当新网络远优于旧网络时才切换</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<p><strong>效果</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">不使用滞后:
时间  <span class="hljs-built_in">WiFi</span> RSSI  分数  默认网络
<span class="hljs-number">0</span>s    <span class="hljs-number">-71</span>dBm    <span class="hljs-number">65</span>    <span class="hljs-built_in">WiFi</span>
<span class="hljs-number">1</span>s    <span class="hljs-number">-73</span>dBm    <span class="hljs-number">63</span>    <span class="hljs-built_in">WiFi</span>
<span class="hljs-number">2</span>s    <span class="hljs-number">-75</span>dBm    <span class="hljs-number">60</span>    → 切换到LTE
<span class="hljs-number">3</span>s    <span class="hljs-number">-73</span>dBm    <span class="hljs-number">63</span>    → 切换到<span class="hljs-built_in">WiFi</span>
<span class="hljs-number">4</span>s    <span class="hljs-number">-75</span>dBm    <span class="hljs-number">60</span>    → 切换到<span class="hljs-built_in">LTE</span>  (频繁抖动)

使用滞后(阈值<span class="hljs-number">10</span>):
<span class="hljs-number">0</span>s    <span class="hljs-number">-71</span>dBm    <span class="hljs-number">65</span>    <span class="hljs-built_in">WiFi</span>
<span class="hljs-number">1</span>s    <span class="hljs-number">-73</span>dBm    <span class="hljs-number">63</span>    <span class="hljs-built_in">WiFi</span>
<span class="hljs-number">2</span>s    <span class="hljs-number">-75</span>dBm    <span class="hljs-number">60</span>    <span class="hljs-built_in">WiFi</span>  (<span class="hljs-number">60</span> vs <span class="hljs-number">50</span>+<span class="hljs-number">10</span>=<span class="hljs-number">60</span>, 不切换)
<span class="hljs-number">3</span>s    <span class="hljs-number">-77</span>dBm    <span class="hljs-number">55</span>    → 切换到<span class="hljs-built_in">LTE</span> (<span class="hljs-number">55</span> &lt; <span class="hljs-number">50</span>+<span class="hljs-number">10</span>)
<span class="hljs-number">4</span>s    <span class="hljs-number">-73</span>dBm    <span class="hljs-number">63</span>    <span class="hljs-built_in">LTE</span>   (<span class="hljs-number">63</span> &lt; <span class="hljs-number">50</span>+<span class="hljs-number">10</span>, 仍用LTE)
</code></pre>
<hr/>
<h2 data-id="heading-36">五、网络验证与Captive Portal处理</h2>
<h3 data-id="heading-37">5.1 NetworkMonitor验证流程</h3>
<p>源码位置：</p>
<pre><code class="hljs language-bash" lang="bash">packages/modules/NetworkStack/src/android/net/captiveportal/CaptivePortalProbeResult.java
packages/modules/NetworkStack/src/android/net/NetworkMonitor.java
</code></pre>
<p><strong>完整验证流程</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// NetworkMonitor.java (简化版)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkMonitor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">StateMachine</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_HTTP_URL</span> <span class="hljs-operator">=</span>
        <span class="hljs-string">"http://connectivitycheck.gstatic.com/generate_204"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_HTTPS_URL</span> <span class="hljs-operator">=</span>
        <span class="hljs-string">"https://www.google.com/generate_204"</span>;

    <span class="hljs-keyword">private</span> CaptivePortalProbeResult <span class="hljs-title function_">isCaptivePortal</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 1. HTTP探测</span>
        <span class="hljs-type">CaptivePortalProbeResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> sendHttpProbe(
            mCleartextDnsNetwork, VALIDATION_TYPE_HTTP);

        <span class="hljs-keyword">if</span> (result.isSuccessful()) {
            <span class="hljs-comment">// HTTP 204返回，说明可以访问互联网</span>
            <span class="hljs-keyword">return</span> result;
        }

        <span class="hljs-keyword">if</span> (result.isPortal()) {
            <span class="hljs-comment">// HTTP重定向，说明是Captive Portal</span>
            <span class="hljs-keyword">return</span> result;
        }

        <span class="hljs-comment">// 2. HTTPS探测（更可靠）</span>
        result = sendHttpProbe(
            mCleartextDnsNetwork, VALIDATION_TYPE_HTTPS);

        <span class="hljs-keyword">if</span> (result.isSuccessful()) {
            <span class="hljs-keyword">return</span> result;
        }

        <span class="hljs-comment">// 3. DNS探测（检查DNS是否被劫持）</span>
        result = sendDnsProbe(mPrivateDnsProviderHostname);

        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-keyword">private</span> CaptivePortalProbeResult <span class="hljs-title function_">sendHttpProbe</span><span class="hljs-params">(
            Network network, <span class="hljs-type">int</span> validationType)</span> {

        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> (validationType == VALIDATION_TYPE_HTTPS)
                ? mHttpsUrl : mHttpUrl;

        <span class="hljs-type">HttpURLConnection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">try</span> {
            conn = (HttpURLConnection) network.openConnection(url);
            conn.setInstanceFollowRedirects(<span class="hljs-literal">false</span>);
            conn.setConnectTimeout(SOCKET_TIMEOUT_MS);
            conn.setReadTimeout(SOCKET_TIMEOUT_MS);
            conn.setUseCaches(<span class="hljs-literal">false</span>);
            conn.addRequestProperty(<span class="hljs-string">"Connection"</span>, <span class="hljs-string">"close"</span>);

            <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> SystemClock.elapsedRealtime();
            conn.getInputStream();
            <span class="hljs-type">long</span> <span class="hljs-variable">latency</span> <span class="hljs-operator">=</span> SystemClock.elapsedRealtime() - start;

            <span class="hljs-type">int</span> <span class="hljs-variable">responseCode</span> <span class="hljs-operator">=</span> conn.getResponseCode();
            <span class="hljs-type">String</span> <span class="hljs-variable">location</span> <span class="hljs-operator">=</span> conn.getHeaderField(<span class="hljs-string">"Location"</span>);

            <span class="hljs-comment">// HTTP 204 = 验证通过</span>
            <span class="hljs-keyword">if</span> (responseCode == <span class="hljs-number">204</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CaptivePortalProbeResult</span>(
                    CaptivePortalProbeResult.SUCCESS, latency);
            }

            <span class="hljs-comment">// HTTP 200 = 可能是Captive Portal</span>
            <span class="hljs-keyword">if</span> (responseCode &gt;= <span class="hljs-number">200</span> &amp;&amp; responseCode &lt;= <span class="hljs-number">399</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CaptivePortalProbeResult</span>(
                    CaptivePortalProbeResult.PORTAL,
                    location, latency);
            }

            <span class="hljs-comment">// 其他 = 验证失败</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CaptivePortalProbeResult</span>(
                CaptivePortalProbeResult.FAILED, latency);

        } <span class="hljs-keyword">catch</span> (IOException e) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CaptivePortalProbeResult</span>(
                CaptivePortalProbeResult.FAILED, <span class="hljs-number">0</span>);
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (conn != <span class="hljs-literal">null</span>) conn.disconnect();
        }
    }
}
</code></pre>
<h3 data-id="heading-38">5.2 Captive Portal登录流程</h3>
<p><strong>场景：连接星巴克WiFi</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">Step 1:</span> <span class="hljs-string">物理连接</span>
  <span class="hljs-string">用户:</span> <span class="hljs-string">选择"Starbucks</span> <span class="hljs-string">WiFi"</span>
  <span class="hljs-attr">WiFi:</span> <span class="hljs-string">DHCP获取IP</span> <span class="hljs-string">(192.168.1.100)</span>
  <span class="hljs-attr">WiFiNetworkAgent:</span> <span class="hljs-string">上报CONNECTED状态</span>

<span class="hljs-attr">Step 2:</span> <span class="hljs-string">NetworkMonitor验证</span>
  <span class="hljs-string">HTTP探测</span> <span class="hljs-string">→</span> <span class="hljs-string">http://connectivitycheck.gstatic.com/generate_204</span>
  <span class="hljs-string">服务器返回:</span> <span class="hljs-string">HTTP</span> <span class="hljs-number">302</span> <span class="hljs-string">Redirect</span>
  <span class="hljs-attr">Location:</span> <span class="hljs-string">http://星巴克登录页面.com/login</span>

  <span class="hljs-string">结论:</span> <span class="hljs-string">检测到Captive</span> <span class="hljs-string">Portal</span>

<span class="hljs-attr">Step 3:</span> <span class="hljs-string">通知用户</span>
  <span class="hljs-string">系统通知:</span> <span class="hljs-string">"需要登录WiFi网络"</span>
  <span class="hljs-string">点击后打开:</span> <span class="hljs-string">CaptivePortalLoginActivity</span>

<span class="hljs-attr">Step 4:</span> <span class="hljs-string">用户登录</span>
  <span class="hljs-string">WebView加载登录页</span>
  <span class="hljs-string">用户输入信息</span> <span class="hljs-string">/</span> <span class="hljs-string">同意条款</span>
  <span class="hljs-string">登录成功</span>

<span class="hljs-attr">Step 5:</span> <span class="hljs-string">重新验证</span>
  <span class="hljs-attr">NetworkMonitor:</span> <span class="hljs-string">再次发送HTTP探测</span>
  <span class="hljs-string">服务器返回:</span> <span class="hljs-string">HTTP</span> <span class="hljs-number">204</span> <span class="hljs-string">(验证通过)</span>
  <span class="hljs-string">状态:</span> <span class="hljs-string">CAPTIVE_PORTAL</span> <span class="hljs-string">→</span> <span class="hljs-string">VALIDATED</span>
</code></pre>
<p><strong>代码实现</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// CaptivePortalLoginActivity.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CaptivePortalLoginActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Activity</span> {

    <span class="hljs-keyword">private</span> WebView mWebView;
    <span class="hljs-keyword">private</span> Network mNetwork;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);

        <span class="hljs-comment">// 获取要验证的网络</span>
        mNetwork = getIntent().getParcelableExtra(
            ConnectivityManager.EXTRA_NETWORK);

        <span class="hljs-comment">// 设置WebView使用该网络</span>
        mWebView = findViewById(R.id.webview);
        mWebView.setWebViewClient(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PortalWebViewClient</span>());

        <span class="hljs-comment">// 加载登录页面</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> getIntent().getStringExtra(
            ConnectivityManager.EXTRA_CAPTIVE_PORTAL_URL);
        mWebView.loadUrl(url);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PortalWebViewClient</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebViewClient</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">shouldOverrideUrlLoading</span><span class="hljs-params">(WebView view, String url)</span> {
            <span class="hljs-comment">// 检查是否登录成功</span>
            <span class="hljs-keyword">if</span> (isSuccessUrl(url)) {
                <span class="hljs-comment">// 通知系统重新验证</span>
                notifyPortalLoginSuccess();
                finish();
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyPortalLoginSuccess</span><span class="hljs-params">()</span> {
        <span class="hljs-type">ConnectivityManager</span> <span class="hljs-variable">cm</span> <span class="hljs-operator">=</span> getSystemService(
            ConnectivityManager.class);
        cm.reportNetworkConnectivity(mNetwork, <span class="hljs-literal">true</span>);
    }
}
</code></pre>
<h3 data-id="heading-39">5.3 Android 15 Private DNS支持</h3>
<p><strong>DoT (DNS over TLS)</strong> - 加密DNS查询：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// NetworkMonitor.java - Android 15新增</span>
<span class="hljs-keyword">private</span> CaptivePortalProbeResult <span class="hljs-title function_">sendDnsProbe</span><span class="hljs-params">(String hostname)</span> {
    <span class="hljs-keyword">if</span> (isPrivateDnsValidationRequired()) {
        <span class="hljs-comment">// 使用TLS加密的DNS查询</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">SSLSocket</span> <span class="hljs-variable">socket</span> <span class="hljs-operator">=</span> (SSLSocket)
                SSLSocketFactory.getDefault()
                    .createSocket(mPrivateDnsServerIp, <span class="hljs-number">853</span>);

            socket.startHandshake();

            <span class="hljs-comment">// 发送DNS查询</span>
            <span class="hljs-type">DnsPacket</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> DnsPacket.createQuery(
                hostname, TYPE_A);
            socket.getOutputStream().write(query.getBytes());

            <span class="hljs-comment">// 接收响应</span>
            <span class="hljs-type">DnsPacket</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> DnsPacket.parse(
                socket.getInputStream());

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CaptivePortalProbeResult</span>(
                CaptivePortalProbeResult.SUCCESS, <span class="hljs-number">0</span>);

        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CaptivePortalProbeResult</span>(
                CaptivePortalProbeResult.FAILED, <span class="hljs-number">0</span>);
        }
    }
}
</code></pre>
<p><strong>配置Private DNS</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 设置 → 网络和互联网 → 私人DNS</span>
adb shell settings put global private_dns_mode hostname
adb shell settings put global private_dns_specifier dns.google

<span class="hljs-comment"># 验证</span>
adb shell getprop net.dns1
<span class="hljs-comment"># 输出: 8.8.8.8 (使用Google Public DNS)</span>
</code></pre>
<hr/>
<h2 data-id="heading-40">六、实战：网络问题诊断</h2>
<h3 data-id="heading-41">6.1 WiFi连接失败排查</h3>
<p><strong>症状</strong>：WiFi显示"已连接"但无法上网</p>
<p><strong>诊断步骤</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Step 1: 检查网络状态</span>
adb shell dumpsys connectivity | grep -A 30 <span class="hljs-string">"Active networks"</span>

<span class="hljs-comment"># 输出示例:</span>
<span class="hljs-comment"># NetworkAgentInfo{ ni{[WIFI () - 100]}</span>
<span class="hljs-comment">#   network{151}  handle{151}</span>
<span class="hljs-comment">#   lp{{InterfaceName: wlan0</span>
<span class="hljs-comment">#       LinkAddresses: [ 192.168.1.100/24 ]</span>
<span class="hljs-comment">#       DnsAddresses: [ 192.168.1.1 ]</span>
<span class="hljs-comment">#       Routes: [ 0.0.0.0/0 -&gt; 192.168.1.1 wlan0 ]}}</span>
<span class="hljs-comment">#   nc{[ Transports: WIFI</span>
<span class="hljs-comment">#        Capabilities: NOT_METERED</span>
<span class="hljs-comment">#        NOT_ROAMING INTERNET NOT_SUSPENDED VALIDATED]}  ← 注意这里</span>
<span class="hljs-comment">#   Score{current=60 validated=true}}</span>

<span class="hljs-comment"># 关键字段:</span>
<span class="hljs-comment"># - VALIDATED: 网络已验证 (如果没有此字段，说明验证失败)</span>
<span class="hljs-comment"># - DnsAddresses: DNS服务器 (检查是否正确)</span>
<span class="hljs-comment"># - LinkAddresses: 本机IP (检查是否在合理范围)</span>
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Step 2: 检查网络验证结果</span>
adb shell dumpsys network_stack | grep -i <span class="hljs-string">"validation"</span>

<span class="hljs-comment"># 输出:</span>
<span class="hljs-comment"># ValidationProbeEvent{latency=234 result=204 ...}  ← HTTP 204表示通过</span>
<span class="hljs-comment"># 或</span>
<span class="hljs-comment"># ValidationProbeEvent{latency=5000 result=timeout ...}  ← 超时</span>
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Step 3: 手动测试连通性</span>
adb shell

<span class="hljs-comment"># Ping网关</span>
ping -c 4 192.168.1.1
<span class="hljs-comment"># 如果不通，说明局域网问题</span>

<span class="hljs-comment"># Ping DNS</span>
ping -c 4 8.8.8.8
<span class="hljs-comment"># 如果不通，说明路由问题</span>

<span class="hljs-comment"># Ping域名</span>
ping -c 4 www.google.com
<span class="hljs-comment"># 如果不通，说明DNS问题</span>

<span class="hljs-comment"># HTTP测试</span>
curl -I http://connectivitycheck.gstatic.com/generate_204
<span class="hljs-comment"># 应该返回 HTTP/1.1 204 No Content</span>
</code></pre>
<p><strong>常见原因与解决方案</strong>：</p>



































<table><thead><tr><th align="left">现象</th><th align="left">原因</th><th align="left">解决方案</th></tr></thead><tbody><tr><td align="left">Ping网关不通</td><td align="left">WiFi驱动/硬件问题</td><td align="left">重启WiFi，检查驱动日志</td></tr><tr><td align="left">Ping DNS不通</td><td align="left">路由器未设置默认网关</td><td align="left">检查DHCP配置</td></tr><tr><td align="left">Ping域名不通</td><td align="left">DNS服务器故障</td><td align="left">手动设置DNS为8.8.8.8</td></tr><tr><td align="left">HTTP返回302</td><td align="left">Captive Portal</td><td align="left">打开浏览器完成登录</td></tr><tr><td align="left">HTTP超时</td><td align="left">防火墙拦截</td><td align="left">检查iptables规则</td></tr></tbody></table>
<h3 data-id="heading-42">6.2 网络切换异常定位</h3>
<p><strong>症状</strong>：从WiFi切换到移动网络后，应用无法联网</p>
<p><strong>诊断</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 查看当前默认网络</span>
adb shell dumpsys connectivity | grep <span class="hljs-string">"Active default"</span>
<span class="hljs-comment"># 输出: Active default network: 151</span>

<span class="hljs-comment"># 2. 查看该网络详情</span>
adb shell dumpsys connectivity networks 151
<span class="hljs-comment"># 确认是否是期望的网络(WiFi/LTE)</span>

<span class="hljs-comment"># 3. 检查应用是否绑定了旧网络</span>
adb shell dumpsys connectivity requests | grep <span class="hljs-string">"YOUR_PACKAGE"</span>
<span class="hljs-comment"># 输出会显示应用的NetworkRequest和绑定的Network</span>

<span class="hljs-comment"># 4. 抓取网络切换日志</span>
adb logcat -b all | grep -E <span class="hljs-string">"ConnectivityService|NetworkAgent"</span>
</code></pre>
<p><strong>典型日志分析</strong>：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"># 正常切换日志:
<span class="hljs-symbol">ConnectivityService:</span> NetworkAgentInfo [WIFI] validation passed
<span class="hljs-symbol">ConnectivityService:</span> Setting <span class="hljs-keyword">default</span> network <span class="hljs-keyword">to</span> <span class="hljs-number">151</span> (WIFI)
<span class="hljs-symbol">ConnectivityService:</span> Lingering network <span class="hljs-number">149</span> (MOBILE)
... (<span class="hljs-number">30</span>秒后)
<span class="hljs-symbol">ConnectivityService:</span> Tearing down network <span class="hljs-number">149</span>

# 异常切换日志:
<span class="hljs-symbol">ConnectivityService:</span> NetworkAgentInfo [MOBILE] validation failed
<span class="hljs-symbol">ConnectivityService:</span> <span class="hljs-built_in">Not</span> setting <span class="hljs-keyword">default</span> <span class="hljs-keyword">to</span> unvalidated network
← 移动网络验证失败，未切换
</code></pre>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 应用代码修复：使用ConnectivityManager.NetworkCallback</span>
<span class="hljs-type">ConnectivityManager</span> <span class="hljs-variable">cm</span> <span class="hljs-operator">=</span> ...;
<span class="hljs-type">NetworkCallback</span> <span class="hljs-variable">callback</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkCallback</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAvailable</span><span class="hljs-params">(Network network)</span> {
        <span class="hljs-comment">// 网络可用时，将Socket绑定到新网络</span>
        <span class="hljs-keyword">try</span> {
            network.bindSocket(mySocket);
            <span class="hljs-comment">// 或重新创建连接</span>
            recreateConnection(network);
        } <span class="hljs-keyword">catch</span> (IOException e) {
            Log.e(TAG, <span class="hljs-string">"Failed to bind socket"</span>, e);
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onLost</span><span class="hljs-params">(Network network)</span> {
        <span class="hljs-comment">// 网络丢失时，清理资源</span>
        closeConnection();
    }
};

<span class="hljs-comment">// 注册监听</span>
cm.registerDefaultNetworkCallback(callback);
</code></pre>
<h3 data-id="heading-43">6.3 性能优化：减少网络切换延迟</h3>
<p><strong>问题</strong>：WiFi→LTE切换需要5-8秒</p>
<p><strong>优化方案</strong>：</p>
<h4 data-id="heading-44"><strong>方案1：预连接移动网络</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Android 12引入的MultiPath API</span>
<span class="hljs-type">ConnectivityManager</span> <span class="hljs-variable">cm</span> <span class="hljs-operator">=</span> ...;

<span class="hljs-comment">// 请求同时使用WiFi和LTE</span>
<span class="hljs-type">NetworkRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequest</span>.Builder()
    .addCapability(NET_CAPABILITY_INTERNET)
    .build();

cm.requestNetwork(request, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkCallback</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAvailable</span><span class="hljs-params">(Network network)</span> {
        <span class="hljs-comment">// 保持LTE连接处于激活状态</span>
        <span class="hljs-comment">// 当WiFi断开时，可立即切换</span>
    }
}, MULTI_PATH_PREFERENCE_PERFORMANCE);
</code></pre>
<h4 data-id="heading-45"><strong>方案2：快速失败检测</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 缩短验证超时时间</span>
adb shell settings put global captive_portal_http_url_timeout_ms <span class="hljs-number">3000</span>

<span class="hljs-comment">// 默认值：10000ms (10秒)</span>
<span class="hljs-comment">// 优化后：3000ms (3秒)</span>
</code></pre>
<h4 data-id="heading-46"><strong>方案3：应用层优化 - Happy Eyeballs</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// RFC 8305: 同时尝试IPv4和IPv6，使用最快响应的</span>
<span class="hljs-keyword">public</span> Socket <span class="hljs-title function_">connectWithHappyEyeballs</span><span class="hljs-params">(String host, <span class="hljs-type">int</span> port)</span> {
    List&lt;InetAddress&gt; addresses =
        InetAddress.getAllByName(host);  <span class="hljs-comment">// 获取所有IP</span>

    List&lt;Future&lt;Socket&gt;&gt; futures = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newCachedThreadPool();

    <span class="hljs-comment">// 并发连接所有地址</span>
    <span class="hljs-keyword">for</span> (InetAddress addr : addresses) {
        futures.add(executor.submit(() -&gt; {
            <span class="hljs-type">Socket</span> <span class="hljs-variable">socket</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Socket</span>();
            socket.connect(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddress</span>(addr, port), <span class="hljs-number">1000</span>);
            <span class="hljs-keyword">return</span> socket;
        }));
    }

    <span class="hljs-comment">// 返回第一个成功的连接</span>
    <span class="hljs-keyword">for</span> (Future&lt;Socket&gt; future : futures) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> future.get(<span class="hljs-number">2</span>, TimeUnit.SECONDS);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 继续尝试下一个</span>
        }
    }

    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(<span class="hljs-string">"All connection attempts failed"</span>);
}
</code></pre>
<hr/>
<h2 data-id="heading-47">七、Android 15新特性</h2>
<h3 data-id="heading-48">7.1 Satellite Connectivity（卫星连接）</h3>
<p>Android 15新增卫星网络支持：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 检测卫星网络可用性</span>
<span class="hljs-type">NetworkCapabilities</span> <span class="hljs-variable">nc</span> <span class="hljs-operator">=</span> cm.getNetworkCapabilities(network);

<span class="hljs-keyword">if</span> (nc.hasTransport(NetworkCapabilities.TRANSPORT_SATELLITE)) {
    <span class="hljs-comment">// 这是卫星连接</span>
    <span class="hljs-comment">// 特点：高延迟(500-800ms)、低带宽(几Kbps)、高成本</span>

    <span class="hljs-comment">// 应用应该:</span>
    <span class="hljs-comment">// 1. 使用文本通信而非语音/视频</span>
    <span class="hljs-comment">// 2. 压缩数据</span>
    <span class="hljs-comment">// 3. 减少请求频率</span>
}
</code></pre>
<h3 data-id="heading-49">7.2 Network Slicing (5G网络切片)</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 请求特定的5G切片</span>
<span class="hljs-type">NetworkRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequest</span>.Builder()
    .addCapability(NET_CAPABILITY_ENTERPRISE)
    .setEnterpriseId(NET_ENTERPRISE_ID_1)  <span class="hljs-comment">// 企业专网切片</span>
    .build();

cm.requestNetwork(request, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkCallback</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAvailable</span><span class="hljs-params">(Network network)</span> {
        <span class="hljs-comment">// 使用企业专网，享受:</span>
        <span class="hljs-comment">// - 更低延迟 (&lt;10ms)</span>
        <span class="hljs-comment">// - 更高带宽保证</span>
        <span class="hljs-comment">// - 更好的QoS</span>
    }
});
</code></pre>
<h3 data-id="heading-50">7.3 Thread Network Support</h3>
<p>Android 15支持Thread协议（用于智能家居）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 连接Thread网络</span>
<span class="hljs-type">NetworkRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequest</span>.Builder()
    .addTransportType(NetworkCapabilities.TRANSPORT_THREAD)
    .build();

<span class="hljs-comment">// Thread特点:</span>
<span class="hljs-comment">// - 低功耗</span>
<span class="hljs-comment">// - Mesh网络</span>
<span class="hljs-comment">// - IPv6 only</span>
<span class="hljs-comment">// - 用于IoT设备</span>
</code></pre>
<hr/>
<h2 data-id="heading-51">八、总结与展望</h2>
<h3 data-id="heading-52">8.1 核心要点回顾</h3>
<ol>
<li>
<p><strong>ConnectivityService架构</strong></p>
<ul>
<li>系统网络管理中枢</li>
<li>协调NetworkAgent和NetworkFactory</li>
<li>管理网络生命周期</li>
</ul>
</li>
<li>
<p><strong>NetworkAgent机制</strong></p>
<ul>
<li>9种网络状态</li>
<li>状态机驱动</li>
<li>基于Messenger通信</li>
</ul>
</li>
<li>
<p><strong>NetworkFactory工作原理</strong></p>
<ul>
<li>按需激活网络</li>
<li>Capability匹配</li>
<li>评分竞争机制</li>
</ul>
</li>
<li>
<p><strong>网络切换</strong></p>
<ul>
<li>NetworkRanker评分算法</li>
<li>Linger优雅断开</li>
<li>Hysteresis防抖动</li>
</ul>
</li>
<li>
<p><strong>网络验证</strong></p>
<ul>
<li>HTTP/HTTPS探测</li>
<li>Captive Portal处理</li>
<li>Private DNS支持</li>
</ul>
</li>
</ol>
<h3 data-id="heading-53">8.2 ConnectivityService演进史</h3>













































<table><thead><tr><th align="left">版本</th><th align="left">关键变化</th><th align="left">影响</th></tr></thead><tbody><tr><td align="left">Android 5.0</td><td align="left">引入NetworkRequest/NetworkCallback</td><td align="left">应用可主动请求网络</td></tr><tr><td align="left">Android 7.0</td><td align="left">MultiNetwork API</td><td align="left">应用可同时使用多个网络</td></tr><tr><td align="left">Android 9.0</td><td align="left">强制使用HTTPS</td><td align="left">安全性提升</td></tr><tr><td align="left">Android 10.0</td><td align="left">NetworkStack模块化</td><td align="left">可独立更新</td></tr><tr><td align="left">Android 11.0</td><td align="left">eBPF网络策略</td><td align="left">性能大幅提升</td></tr><tr><td align="left">Android 12.0</td><td align="left">Network Slicing</td><td align="left">5G网络切片支持</td></tr><tr><td align="left">Android 15.0</td><td align="left">Satellite + Thread</td><td align="left">扩展连接场景</td></tr></tbody></table>
<h3 data-id="heading-54">8.3 未来展望</h3>
<p><strong>趋势1：AI驱动的网络管理</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 未来可能的实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AINetworkRanker</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.model = load_ml_model(<span class="hljs-string">"network_predictor.tflite"</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">predict_network_quality</span>(<span class="hljs-params">self, nai</span>):
        features = extract_features(nai)  <span class="hljs-comment"># RSSI, 速度, 延迟等</span>
        score = self.model.predict(features)
        <span class="hljs-keyword">return</span> score
</code></pre>
<p><strong>趋势2：Seamless Multi-Path</strong></p>
<ul>
<li>同时使用WiFi+5G，自动负载均衡</li>
<li>关键数据走5G（低延迟），大数据走WiFi（省流量）</li>
</ul>
<p><strong>趋势3：边缘计算集成</strong></p>
<ul>
<li>ConnectivityService感知MEC(多接入边缘计算)节点</li>
<li>自动将流量路由到最近的边缘服务器</li>
</ul>
<hr/>
<h2 data-id="heading-55">九、参考资源</h2>
<h3 data-id="heading-56">9.1 源码路径</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># ConnectivityService核心</span>
packages/modules/Connectivity/service/src/com/android/server/
├── ConnectivityService.java          <span class="hljs-comment"># 核心服务</span>
├── NetworkAgentInfo.java             <span class="hljs-comment"># Agent信息</span>
├── NetworkRequestInfo.java           <span class="hljs-comment"># 请求信息</span>
└── connectivity/
    ├── NetworkRanker.java            <span class="hljs-comment"># 网络排名</span>
    └── PermissionMonitor.java        <span class="hljs-comment"># 权限监控</span>

<span class="hljs-comment"># NetworkStack</span>
packages/modules/NetworkStack/src/
├── android/net/NetworkMonitor.java    <span class="hljs-comment"># 网络验证</span>
├── android/net/apf/                   <span class="hljs-comment"># APF包过滤</span>
└── android/net/ip/IpClient.java       <span class="hljs-comment"># IP配置</span>

<span class="hljs-comment"># NetworkAgent实现</span>
packages/modules/Wifi/service/java/com/android/server/wifi/
└── WifiNetworkAgent.java              <span class="hljs-comment"># WiFi Agent</span>

frameworks/opt/telephony/src/java/com/android/internal/telephony/
└── dataconnection/DcNetworkAgent.java <span class="hljs-comment"># Cellular Agent</span>
</code></pre>
<h3 data-id="heading-57">9.2 调试命令</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看所有网络</span>
adb shell dumpsys connectivity networks

<span class="hljs-comment"># 查看默认网络</span>
adb shell dumpsys connectivity | grep <span class="hljs-string">"Active default"</span>

<span class="hljs-comment"># 查看NetworkRequest</span>
adb shell dumpsys connectivity requests

<span class="hljs-comment"># 查看NetworkFactory</span>
adb shell dumpsys connectivity factories

<span class="hljs-comment"># 触发网络验证</span>
adb shell cmd connectivity force-network-validation &lt;netId&gt;

<span class="hljs-comment"># 模拟网络切换</span>
adb shell svc wifi <span class="hljs-built_in">disable</span> &amp;&amp; <span class="hljs-built_in">sleep</span> 2 &amp;&amp; adb shell svc wifi <span class="hljs-built_in">enable</span>

<span class="hljs-comment"># 查看eBPF统计</span>
adb shell dumpsys connectivity trafficcontroller
</code></pre>
<h3 data-id="heading-58">9.3 官方文档</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsource.android.com%2Fdocs%2Fcore%2Fconnect" target="_blank" title="https://source.android.com/docs/core/connect" ref="nofollow noopener noreferrer">Connectivity Overview</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroid%2Fnet%2FConnectivityManager" target="_blank" title="https://developer.android.com/reference/android/net/ConnectivityManager" ref="nofollow noopener noreferrer">ConnectivityManager API</a></li>
</ul>
<h3 data-id="heading-59">9.4 相关RFC</h3>
<ul>
<li>RFC 3093: DHCP</li>
<li>RFC 8305: Happy Eyeballs v2</li>
<li>RFC 7858: DNS over TLS</li>
<li>RFC 8910: Captive Portal API</li>
</ul>
<hr/>
<h2 data-id="heading-60">后记</h2>
<p>ConnectivityService是Android系统中最复杂的服务之一，管理着设备与外界的所有网络连接。从简单的WiFi连接，到复杂的多网络并发、VPN隧道、5G切片，ConnectivityService都能游刃有余地处理。</p>
<h3 data-id="heading-61">系列文章</h3>
<ul>
<li><a href="https://juejin.cn/post/7599330434427158579" target="_blank" title="https://juejin.cn/post/7599330434427158579">上一篇：Android 15存储子系统深度解析（三）：FBE加密文件系统与存储性能优化实战</a></li>
</ul>
<hr/>
<p><em>欢迎来我中的<a href="https://link.juejin.cn?target=https%3A%2F%2Fhome.wonlab.top" target="_blank" title="https://home.wonlab.top" ref="nofollow noopener noreferrer">个人主页</a>找到更多有用的知识和有趣的产品</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别AI塑料感？通义Z-Image开源：6B参数要把“大众脸”送进历史堆]]></title>    <link>https://juejin.cn/post/7600223321041780742</link>    <guid>https://juejin.cn/post/7600223321041780742</guid>    <pubDate>2026-01-28T12:43:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600223321041780742" data-draft-id="7600223321041764358" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别AI塑料感？通义Z-Image开源：6B参数要把“大众脸”送进历史堆"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2026-01-28T12:43:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别AI塑料感？通义Z-Image开源：6B参数要把“大众脸”送进历史堆
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T12:43:25.000Z" title="Wed Jan 28 2026 12:43:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>老实说，在AI绘画圈子里摸爬滚打了这么久，大家是不是都有点审美疲劳了？</p>
<p>不管是用哪个主流模型，跑多了你总能发现某种“诡异的默契”：千篇一律的完美光影，像是同一个整容医生刀下的“网红脸”，还有那种一眼就能看穿的塑料质感。这种“同质化”就像是AI绘画头顶的一层玻璃天花板，好看是好看，但总觉得少了点灵魂。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2FiShot_2026-01-28_20.34.07.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/iShot_2026-01-28_20.34.07.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9204d8f4eb934554a925c3c99c74110b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770209008&amp;x-signature=rq8skxf9Fxb%2FDMQ8H778w8AVheE%3D" alt="iShot_2026-01-28_20.34.07" loading="lazy"/></a></p>
<p>不过，就在2026年1月28日，阿里云通义团队搞了个大动作，开源了名为 <strong>Z-Image</strong> 的基座模型。看完这波技术细节，我感觉这层天花板可能要被敲出裂缝了。</p>
<h3 data-id="heading-0">不止是快，更重要的是“原生”</h3>
<p>这次发布的 Z-Image 是一个 6B（60亿）参数量的模型。在这个百亿甚至千亿参数横行的年代，6B听起来似乎不算庞然大物，但它的定位非常精准：<strong>做一个完美的“底座”</strong>。</p>
<p>这就得聊聊这次发布的一个核心关键词——<strong>非蒸馏</strong>。</p>
<p>之前的很多模型为了追求极速出图（比如所谓的Turbo版），往往使用了蒸馏技术。这就像是把浓缩咖啡兑水变成了速溶，速度是快了，但很多细腻的风味（权重分布）丢失了。而这次开源的 Z-Image Base 版本，保留了全量的权重分布。</p>
<p>这对我们这些喜欢折腾的人来说意味着什么？意味着它的可塑性极强。它原生支持 CFG 引导机制，更是 LoRA 和 ControlNet 的绝佳温床。如果你想训练一个属于自己独特画风的模型，或者要把自家猫主子炼进去，这个“非蒸馏”的底子绝对比那些为了速度而阉割过的模型要好用得多。</p>
<h3 data-id="heading-1">向“AI大众脸”宣战</h3>
<p>Z-Image 最让我感兴趣的，是它试图解决“人像同质化”的野心。</p>
<p>官方在技术文档里提到，他们优化了采样空间的分布。翻译成人话就是：它不再总是偷懒去抄那几张最稳妥的“标准脸”作业了。</p>
<p>以前我们抽卡，十张图里有八张脸型差不多，但在 Z-Image 的逻辑里，不同的种子和提示词会真的导向截然不同的面孔特征和构图逻辑。它不仅能驾驭从写实摄影到二次元动漫的跨度，更重要的是，它试图在多人场景中剥离那种“克隆人军团”的感觉。这对于需要做连环画、游戏资产或者故事绘本的创作者来说，简直是刚需中的刚需。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2FiShot_2026-01-28_20.34.13.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/iShot_2026-01-28_20.34.13.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/305ccea409aa47f782969f9966ea046a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770209008&amp;x-signature=5cwQ73kG%2Fi5IQaL%2FBVmDZoeIPj0%3D" alt="iShot_2026-01-28_20.34.13" loading="lazy"/></a></p>
<h3 data-id="heading-2">门槛打下来了，玩法升上去了</h3>
<p>聊聊配置。6B 的参数量，显存占用控制得相当克制。根据目前的测试，主流的消费级显卡（16GB显存就是一个很舒服的甜点区，甚至更低配置通过量化也能跑）完全能扛得住。</p>
<p>这意味着你不需要租昂贵的A100服务器，在自己的本地电脑上就能跑起来。对于开发者而言，它基于 S³-DiT（单流扩散Transformer）架构，推理效率本身就很高。</p>
<h3 data-id="heading-3">写在最后</h3>
<p>目前的AI绘图圈，缺的其实不是那种能一秒钟出图的工具，而是缺一个能真正理解“差异化”、能让创作者深度定制的扎实地基。</p>
<p>阿里云通义这次把 Z-Image 的基座开源，显然是想走“生态包围”的路子。虽然官方目前还没把牛吹上天，但作为开源社区的一员，我能预感到，很快 ModelScope 和 Hugging Face 上就会涌现出一大批基于 Z-Image 微调的惊艳模型。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2FiShot_2026-01-28_20.34.19-741x1024.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/iShot_2026-01-28_20.34.19-741x1024.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55ca5d878d684de0b4c5186d119efbf5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770209008&amp;x-signature=WLZOeM%2BzyhQHG7AeNp1trvq85bg%3D" alt="iShot_2026-01-28_20.34.19" loading="lazy"/></a></p>
<p>如果你也受够了千篇一律的AI脸，或者想亲手炼制一个真正听话的模型，不妨去魔搭社区或者 GitHub 上把这个权重拉下来试试。毕竟，工具只是画笔，真正的艺术，还得看握笔的人怎么用。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[这10个隐藏扣子skills，每一个都能让你封神]]></title>    <link>https://juejin.cn/post/7600238071038345225</link>    <guid>https://juejin.cn/post/7600238071038345225</guid>    <pubDate>2026-01-28T11:22:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600238071038345225" data-draft-id="7600245693997006858" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="这10个隐藏扣子skills，每一个都能让你封神"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-28T11:22:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿星AI工作室"/> <meta itemprop="url" content="https://juejin.cn/user/2250051536050763"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            这10个隐藏扣子skills，每一个都能让你封神
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2250051536050763/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿星AI工作室
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T11:22:04.000Z" title="Wed Jan 28 2026 11:22:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97c7a06ce0fa45b1a46f6e6866d2d5d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=wZoI9IkNjg7nu7mLeJ19HtJoGxI%3D" alt="图片" loading="lazy"/></p>
<p> </p>
<p>哈喽，大家好</p>
<p>我是阿星👋</p>
<p>自从扣子出了skills，阿星就在商店里各种收藏。</p>
<p>其中10个分享给大家。</p>
<p>（首先你需要下载个扣子app/去官网才能继续）——</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ce5464243744156be0715faca3cc1c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=PTvm1vSq2FgU%2FShtz8R1mO7VD%2Fo%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-0">1、新年绘本</h2>
<p>扣子新年绘本sklls是真的打印实体的画册啊，不是pdf啊。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/463d91fe32ec426dac2993febedf7feb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=35cT%2Bncf1CXsjwQl%2FNuqe26DBCw%3D" alt="图片" loading="lazy"/></p>
<p>其实就是用这个新年绘本skills做的，很傻瓜的操作。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10ed547c80e04ffdb58bcd778f5294e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=3XrRMEDGgu1vqu%2Bhra5AIEMun24%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38096c95ce004e9bacc9b8f4fa7b175d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=cIlcky7M2CNSYAyHywQ%2FhBCk1tI%3D" alt="图片" loading="lazy"/></p>
<p>把提示词发它，你可以改成自己或者宝宝的成长日记，</p>
<p>这样就更有纪念意义了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/446077a7b5844c08a04980dbaf239aed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=LXFx58ZD%2Fp7CK2ISIRX80qGma2E%3D" alt="图片" loading="lazy"/></p>
<p>然后它就开始生成了，</p>
<p>一顿代码输出，</p>
<p>播放起来竟然还是带音频的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85bf515b373245d182d015ce093318dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=mPYNAShEVl0kninMm1EGVDloHZc%3D" alt="图片" loading="lazy"/></p>
<p>最后，一键打印坐等就ok啦~而且可以保存成pdf自己留个底儿。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/924b74fcdd7545ccbef28c16ad06a6c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=UT5672LYt15XsQVj2mf8g4fEMcA%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1edd4df6b80a42ebb532e3e83d2287ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=5wJsulfVModvA426HTcGPB9bwvA%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-1">2、快速榨干一本书</h2>
<p>一款为AI提供的书籍内容深度处理工具，能提取核心知识并给出执行建议。</p>
<p>阿星用《理解媒介》试了试，可能因为这本书太长了（444页）只能先给大家展示一部分效果。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed66c22ba8f44404adc063068a6d86c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=masWyQlzqysQSrfmjHAGKAlkh54%3D" alt="图片" loading="lazy"/></p>
<p>这个工具最核心的提示词是四层榨取法—— <strong>通过骨架提取（定义核心概念）、肉质挖掘（配置3类案例）、精华萃取（跨行业迁移和执行SOP）、残渣利用（批判性视角）四个层次来解读。</strong></p>
<p>要求每个知识点必须包含： <strong>定义+逻辑+3个案例+跨行业迁移矩阵+执行</strong> SOP+批判性视角，每个案例还要80-150字加50-100字解读。主要文件如下，大家可以按照自己的理解尝试复现一个。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62050228aed64ee9a4cef3c7e7d6f673~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=v9FxL4FUI5eW3wYc7pPJznSBwLI%3D" alt="图片" loading="lazy"/></p>
<p>从参考文件（references/）可以看出，作者对文章的结构进行了深层级、格式、 给样例等辅助操作才完成了内容结构的规划。</p>
<p>然后又通过脚本文件（scripts/）做了一些格式上的处理。比如markdown转pdf，但是我不建议大家用因为它要安装的包太多了。非常慢。直接看markdown就行了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a8a185291984d5fbdb3b47dde66b5af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=vnL2ickTJy4cQyQ1uW8%2FImlKAGA%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-2">3、AI漫剧分镜提示词</h2>
<p>看到这个漫剧skills我一下就被吸引住了，</p>
<p>因为最近漫剧实在是太火了奈何阿星自己没学过编剧，</p>
<p>我还以为是随便给我生成个表格，结果它咔咔生成了好几分钟真的太专业了。</p>
<p>然后可以得到用来做整个漫剧图片的提示词。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21775308dd1a426ca3e2f45d766f488a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=Z9EejsKkTRNFE5KKjSNqqxgRi7Q%3D" alt="图片" loading="lazy"/></p>
<p>我们来看看产出物怎么样。</p>
<p>我惊喜的是它连人物一致性的关键词都给了。</p>
<p>阿星之前一直不想尝试漫剧就是因为定角色太麻烦了，这个skills竟然连主角的关键词都给我定好了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba6cd0cf004f479ba33420130d7c1640~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=rc3Ys1LkrLUFRhPxw4df4CJ52xA%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-3">4、答案之书</h2>
<p>看到这个答案之书sklls阿星要笑出猪叫，我最近正在疯狂搜集这类视觉。</p>
<p>它的用法就是你跟他提问，它直接让你抽卡来回答你。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ebae3e3c83a6400b9d32d07de340848d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=Wom13pGRhAdFrP15EoFHOOxGLxE%3D" alt="图片" loading="lazy"/></p>
<p>大家也可以利用media pipe</p>
<p>做一个类似的演示。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bbe519dda21467dadfb9ce5eb6e6796~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=76ibMNFEAIANQ1G0oEpWvHNgvMo%3D" alt="图片" loading="lazy"/></p>
<p>这个sklls我建议大家在PC端用。因为它涉及到手势调用。手机摄像头是启动失败的无法感受神奇交互。</p>
<p>我问它我是否会成为中国AI赛道第一IP，他就会生成一个脚本，结果还不错必然登顶。棒！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0152a08effca4e91a8ab07c8dc9ecb25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=yfS1RFpL2hW%2BaEDMGmnQieDx5SE%3D" alt="图片" loading="lazy"/></p>
<p>原理是里面预制了不少答案，随机给我抽了一个。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd26d7218a044baeb3556cda7e5bbecf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=xAifP9vuesyBZMrHRrubg4CthY4%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-4">5、二次元谷子定制助手</h2>
<p>二次元们可以用它定制周边，让心爱角色触手可及。</p>
<p>重点是生成完了还能直接变视频，擦除背景，</p>
<p>主要优点是比较方便我们二次修改。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b1a09c5b5be4a8397bf643db0da52c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=9rnRxjovGTdsBSw3MMFXkLqIagU%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-5">6、Obsidian入门</h2>
<p>众所周知Obsidian摸索起来费老大劲，要学的实在太多了。</p>
<p>之前我还看看到过类似的书专门讲Obsidian的。那也太痛苦了，学个Obsidian还得看书。</p>
<p>这个技能提供Obsidian咋用的知识，适合老baby们入坑。</p>
<p>像我很久没用这个Obsidian都是因为学习成本太高，现在好了，需要什么学什么吧～</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f0f6d6287204dc680d4a72660b76889~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=DaJR1jZA6R8do54ZOjG2KgmFfIM%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-6">7、DanKoe爆文写作</h2>
<p>Dan Koe风格爆文生成skills适合实在不会写作的同学，</p>
<p>可以一键生成标题、深度内容、封面及网页。</p>
<p>我建议大家但凡会写作就要自己动手写，让AI只是做辅助</p>
<p><strong>大神的写作模板只适合完全没有基础的同学模仿</strong> ，不适合想打造个人特色的同学。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75116bdf149144e598dde90c1b402035~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=7WqTsu5AkFdpMU6PM7JgR0Np81g%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-7">8、SEO专家</h2>
<p>SEO专家是一个搜索引擎优化辅助skills。</p>
<p>它本质上是两个脚本构成的，</p>
<ol>
<li>
<ol>
<li>seo_analyzer.py - 自动化 SEO 分析脚本</li>
</ol>
</li>
<li>
<ol start="2">
<li>generate_sitemap.py - XML 站点地图生成器</li>
</ol>
</li>
</ol>
<p>特别跟小白同学说下，它和我们平常理解的seo标题文章生成不一样，</p>
<p>是针对项目工程本身的代码结构的检查，并且会给出详细的建议。</p>
<p>甚至帮你生成站点地图。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8a3979d1258412b930dff4224347390~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=iZRK%2FbRe5zIrh0CI%2FkwvTs5SRD4%3D" alt="图片" loading="lazy"/></p>
<p>特别是站点地图，初学者可能不知道这个东西。但是这个skills可以直接生成。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b25df68e0da0453d8955cd92714f5fde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=N2HaviMPHxNjrlSdMScxN0zQcXY%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-8">9、文章一键转PPT</h2>
<p>将长篇文章智能转化为专业级HTML演示文稿，</p>
<p>支持商务、科技、极客等多维视觉风格。可以体验一下，</p>
<p>正儿八经做大家最好还是在本地编辑一下再。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/920dc1bf98414d218ad1369da5df8e00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=spr25VACUtk%2B3bw5795dahf759U%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-9">10、新年人生四宫格</h2>
<p>新年人生四宫格技能是我最喜欢的一个。</p>
<p>过年的时候用它当头像太方便啦～</p>
<p>新的一年换上红红的头像，感觉寓意也很好。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/845792dd7cc84b698e34ee46de366003~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=XPOs5lQfx8bVfLn2PPUqoIqoKI0%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ba8571d32984c2eaa760bc7b3d16e37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=1Rp6wK7ehUbM1MY9shhHorAvRKo%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c944ecc39d0445ca9ff653cb8a4b47e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=UHRm0ccz%2BwIn4qXjfck%2Bh08WoXQ%3D" alt="图片" loading="lazy"/></p>
<p>ok，我是阿星，更多AI应用，我们下期再见！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Jetpack Compose 从入门到精通（一）：初识 Compose]]></title>    <link>https://juejin.cn/post/7600032104249032767</link>    <guid>https://juejin.cn/post/7600032104249032767</guid>    <pubDate>2026-01-28T11:22:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600032104249032767" data-draft-id="7600060691350290474" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Jetpack Compose 从入门到精通（一）：初识 Compose"/> <meta itemprop="keywords" content="Android,Kotlin,JetBrains"/> <meta itemprop="datePublished" content="2026-01-28T11:22:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="邹阿涛涛涛涛涛涛涛涛"/> <meta itemprop="url" content="https://juejin.cn/user/3808364009106839"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Jetpack Compose 从入门到精通（一）：初识 Compose
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808364009106839/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    邹阿涛涛涛涛涛涛涛涛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T11:22:16.000Z" title="Wed Jan 28 2026 11:22:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>声明式 UI 的时代来临，让我们一起开启 Compose 学习之旅！</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">前言</h2>
<p>如果你还在用 XML 写布局、用 <code>findViewById</code> 查找视图、用 <code>setOnClickListener</code> 设置点击事件，那么你可能已经落后于时代了。</p>
<p>2021 年，Google 正式发布 <strong>Jetpack Compose 1.0</strong> 稳定版，标志着 Android 开发进入了<strong>声明式 UI</strong> 的新时代。今天，无论是 Google 官方应用、全新的 Android Studio，还是各大互联网厂的新项目，Compose 已经成为首选方案。</p>
<p>作为 Android 开发者，学习 Compose 不再是"可选项"，而是"必修课"。</p>
<p>本系列文章将带你从入门到精通，系统掌握 Jetpack Compose。今天的第一篇，我们先来打好基础，了解 Compose 是什么，并完成环境搭建。</p>
<hr/>
<h2 data-id="heading-1">一、Compose 是什么？</h2>
<h3 data-id="heading-2">1.1 官方定义</h3>
<p><strong>Jetpack Compose</strong> 是 Google 推出的用于构建 Android 界面的<strong>现代声明式 UI 工具包</strong>。它基于 Kotlin 语言，采用函数式编程思想，让界面开发变得更加简洁、直观和高效。</p>
<h3 data-id="heading-3">1.2 传统方式 vs Compose</h3>
<p>让我们用一段代码直观感受两者的区别：</p>
<p><strong>传统 View 系统（命令式）：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// XML 布局文件</span>
&lt;TextView
    android:id=<span class="hljs-string">"@+id/textView"</span>
    android:layout_width=<span class="hljs-string">"wrap_content"</span>
    android:layout_height=<span class="hljs-string">"wrap_content"</span> /&gt;

<span class="hljs-comment">// Kotlin 代码</span>
<span class="hljs-keyword">val</span> textView = findViewById&lt;TextView&gt;(R.id.textView)
textView.text = <span class="hljs-string">"Hello World"</span>
textView.setTextColor(Color.BLUE)
textView.setOnClickListener {
    <span class="hljs-comment">// 处理点击</span>
}
</code></pre>
<p><strong>Compose（声明式）：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">Greeting</span><span class="hljs-params">(name: <span class="hljs-type">String</span>)</span></span> {
    Text(
        text = <span class="hljs-string">"Hello <span class="hljs-variable">$name</span>"</span>,
        color = Color.Blue,
        modifier = Modifier.clickable {
            <span class="hljs-comment">// 处理点击</span>
        }
    )
}
</code></pre>
<p>可以看到，Compose 的代码更加简洁，布局与逻辑写在一起，无需在 XML 和 Kotlin 之间来回切换。</p>
<h3 data-id="heading-4">1.3 核心特性</h3>





























<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td><strong>声明式语法</strong></td><td>描述"界面应该是什么样子"，而不是"如何创建界面"</td></tr><tr><td><strong>纯 Kotlin 实现</strong></td><td>无需 XML，类型安全、智能提示更好</td></tr><tr><td><strong>组合而非继承</strong></td><td>通过组合小型组件构建复杂界面，符合单一职责原则</td></tr><tr><td><strong>智能重组</strong></td><td>系统自动跟踪状态变化，只更新必要的部分</td></tr><tr><td><strong>实时预览</strong></td><td>Android Studio 实时预览，无需运行应用</td></tr></tbody></table>
<h3 data-id="heading-5">1.4 为什么要学 Compose？</h3>
<p><strong>传统 View 系统的痛点：</strong></p>
<ol>
<li><strong>命令式编程复杂</strong> - 手动管理视图状态，<code>findViewById</code> 容易出错</li>
<li><strong>XML 与代码分离</strong> - 布局在 XML，逻辑在 Kotlin，维护困难</li>
<li><strong>状态管理困难</strong> - 状态分散在各个 View 中，数据流难以追踪</li>
<li><strong>重复代码多</strong> - 自定义 View 需要继承并重写多个方法</li>
</ol>
<p><strong>Compose 的优势：</strong></p>
<ul>
<li>代码量减少 <strong>50%+</strong></li>
<li>开发效率大幅提升</li>
<li>状态管理更加清晰</li>
<li>跨平台支持（Compose Multiplatform）</li>
</ul>
<p><strong>行业趋势：</strong></p>
<ul>
<li>iOS：SwiftUI 已成为推荐方案</li>
<li>Web：React、Vue 早已普及声明式开发</li>
<li>Android：Compose 正在快速普及，成为默认选择</li>
</ul>
<hr/>
<h2 data-id="heading-6">二、环境搭建</h2>
<h3 data-id="heading-7">2.1 系统要求</h3>
<ul>
<li><strong>Android Studio</strong>：Arctic Fox (2020.3.1) 或更高版本（推荐最新稳定版）</li>
<li><strong>Kotlin</strong>：1.5.10 或更高版本</li>
<li><strong>minSdk</strong>：API 21 (Android 5.0) 或更高</li>
</ul>
<h3 data-id="heading-8">2.2 创建新项目</h3>
<p><strong>步骤 1：新建项目</strong></p>
<p>打开 Android Studio，选择 <strong>New Project</strong> → <strong>Empty Activity</strong>（注意选择 Compose 模板）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87899d9bc93c46ec90113fad7f9f47f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YK56Zi_5rab5rab5rab5rab5rab5rab5rab5rab:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204608&amp;x-signature=7m36cG41AEg1t2e%2BTuXXW1G4dSM%3D" alt="image.png" loading="lazy"/>
<strong>步骤 2：配置项目</strong></p>
<ul>
<li><strong>Name</strong>：ComposeDemo</li>
<li><strong>Package name</strong>：com.example.composedemo</li>
<li><strong>Minimum SDK</strong>：API 21: Android 5.0 (Lollipop)</li>
<li><strong>Build configuration language</strong>：Kotlin DSL (build.gradle.kts)</li>
</ul>
<blockquote>
<p>💡 <strong>注意</strong>：确保勾选 "Use Compose" 选项（新版 Android Studio 默认启用）。</p>
</blockquote>
<p><strong>步骤 3：查看自动生成的配置</strong></p>
<p>项目创建完成后，<code>build.gradle.kts</code> (Module: app) 会自动包含以下配置：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">android {
    buildFeatures {
        compose = <span class="hljs-literal">true</span>
    }

    composeOptions {
        kotlinCompilerExtensionVersion = <span class="hljs-string">"1.5.10"</span> <span class="hljs-comment">// 根据实际版本调整</span>
    }

    kotlinOptions {
        jvmTarget = <span class="hljs-string">"1.8"</span>
    }
}

dependencies {
    <span class="hljs-comment">// Compose BOM（物料清单）</span>
    <span class="hljs-keyword">val</span> composeBom = platform(<span class="hljs-string">"androidx.compose:compose-bom:2024.02.00"</span>)
    implementation(composeBom)
    androidTestImplementation(composeBom)

    <span class="hljs-comment">// 核心库</span>
    implementation(<span class="hljs-string">"androidx.compose.ui:ui"</span>)
    implementation(<span class="hljs-string">"androidx.compose.ui:ui-graphics"</span>)
    implementation(<span class="hljs-string">"androidx.compose.ui:ui-tooling-preview"</span>)
    
    <span class="hljs-comment">// Material Design 3</span>
    implementation(<span class="hljs-string">"androidx.compose.material3:material3"</span>)
    
    <span class="hljs-comment">// 调试工具</span>
    debugImplementation(<span class="hljs-string">"androidx.compose.ui:ui-tooling"</span>)
    debugImplementation(<span class="hljs-string">"androidx.compose.ui:ui-test-manifest"</span>)
}
</code></pre>
<h3 data-id="heading-9">2.3 现有项目添加 Compose</h3>
<p>如果是现有项目，需要手动添加配置：</p>
<p><strong>build.gradle.kts (Module: app)：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin">android {
    buildFeatures {
        compose = <span class="hljs-literal">true</span>
    }
    
    composeOptions {
        kotlinCompilerExtensionVersion = <span class="hljs-string">"1.5.10"</span>
    }
}

dependencies {
    <span class="hljs-keyword">val</span> composeBom = platform(<span class="hljs-string">"androidx.compose:compose-bom:2024.02.00"</span>)
    implementation(composeBom)
    
    implementation(<span class="hljs-string">"androidx.compose.ui:ui"</span>)
    implementation(<span class="hljs-string">"androidx.compose.material3:material3"</span>)
    implementation(<span class="hljs-string">"androidx.compose.ui:ui-tooling-preview"</span>)
    debugImplementation(<span class="hljs-string">"androidx.compose.ui:ui-tooling"</span>)
}
</code></pre>
<h3 data-id="heading-10">2.4 第一个 Compose 应用</h3>
<p>创建项目后，<code>MainActivity.kt</code> 已经自动生成基础代码：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">ComponentActivity</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContent {
            ComposeDemoTheme {
                Surface(
                    modifier = Modifier.fillMaxSize(),
                    color = MaterialTheme.colorScheme.background
                ) {
                    Greeting(<span class="hljs-string">"Android"</span>)
                }
            }
        }
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">Greeting</span><span class="hljs-params">(name: <span class="hljs-type">String</span>, modifier: <span class="hljs-type">Modifier</span> = Modifier)</span></span> {
    Text(
        text = <span class="hljs-string">"Hello <span class="hljs-variable">$name</span>!"</span>,
        modifier = modifier
    )
}

<span class="hljs-meta">@Preview(showBackground = true)</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">GreetingPreview</span><span class="hljs-params">()</span></span> {
    ComposeDemoTheme {
        Greeting(<span class="hljs-string">"Android"</span>)
    }
}
</code></pre>
<p><strong>运行应用：</strong></p>
<p>点击 Android Studio 的 <strong>Run</strong> 按钮（▶），即可在模拟器或真机上看到 "Hello Android!" 的界面。</p>
<p><strong>实时预览：</strong></p>
<p>在 <code>GreetingPreview</code> 函数右侧，点击 <strong>Split</strong> 或 <strong>Design</strong> 模式，即可看到实时预览效果，无需运行应用！</p>
<hr/>
<h2 data-id="heading-11">三、Composable 函数基础</h2>
<h3 data-id="heading-12">3.1 什么是 Composable 函数？</h3>
<p><strong>Composable 函数</strong>是 Compose 的基本构建块，用 <code>@Composable</code> 注解标记。它描述了 UI 的某一部分，类似于传统 View 系统中的自定义 View。</p>
<p><strong>基本结构：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MyComponent</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// UI 描述</span>
}
</code></pre>
<h3 data-id="heading-13">3.2 命名规范</h3>
<ul>
<li>Composable 函数名使用<strong>大驼峰命名法</strong>（PascalCase）</li>
<li>名词或名词短语，描述 UI 的功能</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ 正确</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserProfile</span><span class="hljs-params">()</span></span> { }

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">LoginButton</span><span class="hljs-params">()</span></span> { }

<span class="hljs-comment">// ❌ 错误</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">userProfile</span><span class="hljs-params">()</span></span> { }  <span class="hljs-comment">// 小写开头</span>

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showButton</span><span class="hljs-params">()</span></span> { }   <span class="hljs-comment">// 动词开头</span>
</code></pre>
<h3 data-id="heading-14">3.3 参数传递</h3>
<p>Composable 函数可以接受参数，实现数据驱动的 UI：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">Greeting</span><span class="hljs-params">(name: <span class="hljs-type">String</span>, age: <span class="hljs-type">Int</span>)</span></span> {
    Text(text = <span class="hljs-string">"Hello, <span class="hljs-variable">$name</span>! You are <span class="hljs-variable">$age</span> years old."</span>)
}

<span class="hljs-comment">// 使用</span>
Greeting(name = <span class="hljs-string">"张三"</span>, age = <span class="hljs-number">25</span>)
</code></pre>
<h3 data-id="heading-15">3.4 Modifier 基础</h3>
<p><strong>Modifier</strong> 是 Compose 中用于修饰 UI 元素的重要工具，可以设置尺寸、边距、点击事件等。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">StyledText</span><span class="hljs-params">()</span></span> {
    Text(
        text = <span class="hljs-string">"Hello Compose"</span>,
        modifier = Modifier
            .padding(<span class="hljs-number">16.</span>dp)           <span class="hljs-comment">// 内边距</span>
            .fillMaxWidth()           <span class="hljs-comment">// 宽度填满父容器</span>
            .height(<span class="hljs-number">50.</span>dp)            <span class="hljs-comment">// 高度</span>
            .background(Color.LightGray) <span class="hljs-comment">// 背景色</span>
            .clickable {              <span class="hljs-comment">// 点击事件</span>
                <span class="hljs-comment">// 处理点击</span>
            }
    )
}
</code></pre>
<p><strong>常用 Modifier：</strong></p>

































<table><thead><tr><th>Modifier</th><th>作用</th></tr></thead><tbody><tr><td><code>padding()</code></td><td>设置内边距</td></tr><tr><td><code>fillMaxWidth()</code> / <code>fillMaxHeight()</code></td><td>填满父容器宽度/高度</td></tr><tr><td><code>size()</code> / <code>width()</code> / <code>height()</code></td><td>设置尺寸</td></tr><tr><td><code>background()</code></td><td>设置背景色</td></tr><tr><td><code>clickable()</code></td><td>添加点击事件</td></tr><tr><td><code>border()</code></td><td>添加边框</td></tr></tbody></table>
<h3 data-id="heading-16">3.5 预览注解</h3>
<p><code>@Preview</code> 注解用于在 Android Studio 中显示 Composable 的预览效果：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Preview(
    name = <span class="hljs-string">"默认预览"</span>,
    showBackground = true,      // 显示背景
    backgroundColor = 0xFFFFFFFF, // 背景颜色（白色）
    widthDp = 360,              // 预览宽度
    heightDp = 640              // 预览高度
)</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MyPreview</span><span class="hljs-params">()</span></span> {
    MyComponent()
}
</code></pre>
<p><strong>多个预览：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Preview(name = <span class="hljs-string">"浅色模式"</span>, uiMode = Configuration.UI_MODE_NIGHT_NO)</span>
<span class="hljs-meta">@Preview(name = <span class="hljs-string">"深色模式"</span>, uiMode = Configuration.UI_MODE_NIGHT_YES)</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ThemePreview</span><span class="hljs-params">()</span></span> {
    MyAppTheme {
        MyComponent()
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-17">四、Material Design 3 组件初探</h2>
<h3 data-id="heading-18">4.1 什么是 Material Design 3？</h3>
<p><strong>Material Design 3</strong>（简称 M3）是 Google 最新的设计系统，提供了丰富的预构建组件，帮助开发者快速构建美观、一致的界面。</p>
<h3 data-id="heading-19">4.2 常用基础组件</h3>
<h4 data-id="heading-20">Text（文本）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">TextDemo</span><span class="hljs-params">()</span></span> {
    Column(modifier = Modifier.padding(<span class="hljs-number">16.</span>dp)) {
        <span class="hljs-comment">// 基础文本</span>
        Text(<span class="hljs-string">"Hello World"</span>)
        
        <span class="hljs-comment">// 样式设置</span>
        Text(
            text = <span class="hljs-string">"Styled Text"</span>,
            fontSize = <span class="hljs-number">20.</span>sp,
            fontWeight = FontWeight.Bold,
            color = Color.Blue
        )
        
        <span class="hljs-comment">// 多行文本</span>
        Text(
            text = <span class="hljs-string">"这是一段很长的文本，可能会自动换行显示。"</span>,
            maxLines = <span class="hljs-number">2</span>,
            overflow = TextOverflow.Ellipsis
        )
    }
}
</code></pre>
<h4 data-id="heading-21">Button（按钮）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ButtonDemo</span><span class="hljs-params">()</span></span> {
    Column(
        modifier = Modifier.padding(<span class="hljs-number">16.</span>dp),
        verticalArrangement = Arrangement.spacedBy(<span class="hljs-number">8.</span>dp)
    ) {
        <span class="hljs-comment">// 基础按钮</span>
        Button(onClick = { <span class="hljs-comment">/* 点击处理 */</span> }) {
            Text(<span class="hljs-string">"点击我"</span>)
        }
        
        <span class="hljs-comment">// 带图标的按钮</span>
        Button(onClick = { }) {
            Icon(Icons.Default.Add, contentDescription = <span class="hljs-string">"添加"</span>)
            Spacer(modifier = Modifier.width(<span class="hljs-number">8.</span>dp))
            Text(<span class="hljs-string">"添加"</span>)
        }
        
        <span class="hljs-comment">// 描边按钮</span>
        OutlinedButton(onClick = { }) {
            Text(<span class="hljs-string">"描边按钮"</span>)
        }
        
        <span class="hljs-comment">// 文本按钮</span>
        TextButton(onClick = { }) {
            Text(<span class="hljs-string">"文本按钮"</span>)
        }
    }
}
</code></pre>
<h4 data-id="heading-22">Card（卡片）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CardDemo</span><span class="hljs-params">()</span></span> {
    Card(
        modifier = Modifier
            .fillMaxWidth()
            .padding(<span class="hljs-number">16.</span>dp),
        elevation = CardDefaults.cardElevation(defaultElevation = <span class="hljs-number">4.</span>dp)
    ) {
        Column(modifier = Modifier.padding(<span class="hljs-number">16.</span>dp)) {
            Text(
                text = <span class="hljs-string">"卡片标题"</span>,
                style = MaterialTheme.typography.titleLarge
            )
            Spacer(modifier = Modifier.height(<span class="hljs-number">8.</span>dp))
            Text(
                text = <span class="hljs-string">"这是卡片的内容描述文本。"</span>,
                style = MaterialTheme.typography.bodyMedium
            )
        }
    }
}
</code></pre>
<h4 data-id="heading-23">TextField（输入框）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">TextFieldDemo</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> text <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-string">""</span>) }
    
    OutlinedTextField(
        value = text,
        onValueChange = { text = it },
        label = { Text(<span class="hljs-string">"用户名"</span>) },
        placeholder = { Text(<span class="hljs-string">"请输入用户名"</span>) },
        leadingIcon = {
            Icon(Icons.Default.Person, contentDescription = <span class="hljs-literal">null</span>)
        },
        modifier = Modifier.fillMaxWidth()
    )
}
</code></pre>
<h3 data-id="heading-24">4.3 基础布局</h3>
<h4 data-id="heading-25">Column（垂直排列）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ColumnDemo</span><span class="hljs-params">()</span></span> {
    Column(
        modifier = Modifier.fillMaxSize(),
        verticalArrangement = Arrangement.Center,  <span class="hljs-comment">// 垂直居中</span>
        horizontalAlignment = Alignment.CenterHorizontally  <span class="hljs-comment">// 水平居中</span>
    ) {
        Text(<span class="hljs-string">"第一行"</span>)
        Text(<span class="hljs-string">"第二行"</span>)
        Text(<span class="hljs-string">"第三行"</span>)
    }
}
</code></pre>
<h4 data-id="heading-26">Row（水平排列）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">RowDemo</span><span class="hljs-params">()</span></span> {
    Row(
        modifier = Modifier.fillMaxWidth(),
        horizontalArrangement = Arrangement.SpaceEvenly,  <span class="hljs-comment">// 均匀分布</span>
        verticalAlignment = Alignment.CenterVertically
    ) {
        Text(<span class="hljs-string">"左侧"</span>)
        Text(<span class="hljs-string">"中间"</span>)
        Text(<span class="hljs-string">"右侧"</span>)
    }
}
</code></pre>
<h4 data-id="heading-27">Box（层叠布局）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">BoxDemo</span><span class="hljs-params">()</span></span> {
    Box(
        modifier = Modifier.fillMaxSize(),
        contentAlignment = Alignment.Center
    ) {
        <span class="hljs-comment">// 底层</span>
        CircularProgressIndicator()
        
        <span class="hljs-comment">// 上层</span>
        Text(<span class="hljs-string">"加载中..."</span>)
    }
}
</code></pre>
<h3 data-id="heading-28">4.4 完整示例：登录界面</h3>
<p>让我们用学到的组件组合一个简单的登录界面：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">LoginScreen</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> username <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-string">""</span>) }
    <span class="hljs-keyword">var</span> password <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-string">""</span>) }
    
    Column(
        modifier = Modifier
            .fillMaxSize()
            .padding(<span class="hljs-number">24.</span>dp),
        horizontalAlignment = Alignment.CenterHorizontally,
        verticalArrangement = Arrangement.Center
    ) {
        <span class="hljs-comment">// 标题</span>
        Text(
            text = <span class="hljs-string">"欢迎登录"</span>,
            style = MaterialTheme.typography.headlineLarge,
            modifier = Modifier.padding(bottom = <span class="hljs-number">32.</span>dp)
        )
        
        <span class="hljs-comment">// 用户名输入</span>
        OutlinedTextField(
            value = username,
            onValueChange = { username = it },
            label = { Text(<span class="hljs-string">"用户名"</span>) },
            leadingIcon = {
                Icon(Icons.Default.Person, contentDescription = <span class="hljs-literal">null</span>)
            },
            modifier = Modifier.fillMaxWidth()
        )
        
        Spacer(modifier = Modifier.height(<span class="hljs-number">16.</span>dp))
        
        <span class="hljs-comment">// 密码输入</span>
        OutlinedTextField(
            value = password,
            onValueChange = { password = it },
            label = { Text(<span class="hljs-string">"密码"</span>) },
            leadingIcon = {
                Icon(Icons.Default.Lock, contentDescription = <span class="hljs-literal">null</span>)
            },
            visualTransformation = PasswordVisualTransformation(),
            modifier = Modifier.fillMaxWidth()
        )
        
        Spacer(modifier = Modifier.height(<span class="hljs-number">24.</span>dp))
        
        <span class="hljs-comment">// 登录按钮</span>
        Button(
            onClick = { <span class="hljs-comment">/* 登录逻辑 */</span> },
            modifier = Modifier.fillMaxWidth()
        ) {
            Text(<span class="hljs-string">"登录"</span>)
        }
        
        Spacer(modifier = Modifier.height(<span class="hljs-number">16.</span>dp))
        
        <span class="hljs-comment">// 注册链接</span>
        TextButton(onClick = { }) {
            Text(<span class="hljs-string">"还没有账号？立即注册"</span>)
        }
    }
}

<span class="hljs-meta">@Preview(showBackground = true)</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">LoginScreenPreview</span><span class="hljs-params">()</span></span> {
    MaterialTheme {
        LoginScreen()
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-29">五、本篇小结</h2>
<p>今天我们完成了 Compose 的入门学习：</p>
<ol>
<li><strong>了解了 Compose 是什么</strong> - 现代声明式 UI 工具包，代码简洁、开发高效</li>
<li><strong>完成了环境搭建</strong> - 创建项目、配置依赖、运行第一个应用</li>
<li><strong>学习了 Composable 基础</strong> - 函数定义、参数传递、Modifier 使用、预览注解</li>
<li><strong>初探 Material Design 3 组件</strong> - Text、Button、Card、TextField 等常用组件，以及 Column、Row、Box 基础布局</li>
</ol>
<hr/>
<h2 data-id="heading-30">下篇预告</h2>
<p><strong>第二篇：核心基石</strong> 将深入讲解：</p>
<ul>
<li>Modifier 修饰符全解析</li>
<li>Column、Row、Box 布局详解</li>
<li>LazyColumn 与列表性能优化</li>
<li>ConstraintLayout in Compose</li>
</ul>
<p>敬请期待！</p>
<hr/>
<h2 data-id="heading-31">参考资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose" target="_blank" title="https://developer.android.com/jetpack/compose" ref="nofollow noopener noreferrer">Jetpack Compose 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fm3.material.io%2Fcomponents" target="_blank" title="https://m3.material.io/components" ref="nofollow noopener noreferrer">Material Design 3 组件库</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fandroid%2Fcompose-samples" target="_blank" title="https://github.com/android/compose-samples" ref="nofollow noopener noreferrer">Compose 示例代码</a></li>
</ul>
<hr/>
<blockquote>
<p>📌 <strong>系列文章导航</strong></p>
<ul>
<li>第一篇：初识 Compose（当前）✅</li>
<li>第二篇：核心基石</li>
<li>第三篇：状态管理</li>
<li>第四篇：Material 组件与主题</li>
<li>第五篇：动画与交互</li>
<li>第六篇：架构与工程化</li>
<li>第七篇：高级特性与实战</li>
</ul>
</blockquote>
<hr/>
<p>如果这篇文章对你有帮助，欢迎 <strong>点赞</strong>、<strong>收藏</strong>、<strong>关注</strong>！有任何问题可以在评论区留言，我会及时回复。</p>
<p><del>Generated by Kimi K2.5 Agent</del></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[（新手推荐）教你如何安装和使用 Clawdbot 的保姆级教程，另外 Clawdbot 已被迫改名为 Moltbot]]></title>    <link>https://juejin.cn/post/7600240045366411318</link>    <guid>https://juejin.cn/post/7600240045366411318</guid>    <pubDate>2026-01-28T11:35:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600240045366411318" data-draft-id="7600240045366394934" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="（新手推荐）教你如何安装和使用 Clawdbot 的保姆级教程，另外 Clawdbot 已被迫改名为 Moltbot"/> <meta itemprop="keywords" content="程序员,人工智能,开源"/> <meta itemprop="datePublished" content="2026-01-28T11:35:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="摆烂工程师"/> <meta itemprop="url" content="https://juejin.cn/user/1552933235470589"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            （新手推荐）教你如何安装和使用 Clawdbot 的保姆级教程，另外 Clawdbot 已被迫改名为 Moltbot
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1552933235470589/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    摆烂工程师
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T11:35:39.000Z" title="Wed Jan 28 2026 11:35:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近几天相信大家都被 <strong>Clawdbot</strong> 疯狂的刷屏了，跟去年的 <strong>Manus</strong> 发布时差不多一样，在互联网上爆发式的展开。</p>
<p>原先是小龙虾，现在的 Logo 是脱了壳的小龙虾，已命名为：<strong>Moltbot</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d0bfe9a8a564a59b43f1853bfc4da66~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=Ql3%2FdtDavHHy6qmkLkKsFl2nLwU%3D" alt="" loading="lazy"/></p>
<p>这是因为 Clawd 的读音跟 Claude 商标冲突，被 Anthropic 给告了，被迫改为 <strong>Moltbot</strong> 。</p>
<p>Anthropic 认为 Clawdbot 这个名字太容易被市场误解为 Claude Code的衍生产品，所以 Clawdbot 已改名为 Moltbot。</p>
<blockquote>
<p>Moltbot 取自龙虾的脱壳行为，符合原本的龙虾元素，并且规避了 Claude 的商标问题。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2839fdcbb72b4629b880547da12d5c5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=VurR58pCHiA3IoiiO5dnwtEd%2FBk%3D" alt="" loading="lazy"/></p>
<p><strong>什么是 Clawdbot 呢？</strong></p>
<p>Clawdbot 是一个 AI 助手，可以部署在本地电脑上或者服务器，可以理解为是一个拥有系统超级权限（root）的 Agent。</p>
<p>如果你用过 Claude Code， 就可以把它理解为拥有各种 skills 以及可以调用各种 MCP 服务协助完成任务的闭环。</p>
<p>可以让它帮你整理邮件、管理日程、炒股、写推文、读PPT等，在后台24小时运行，但这是非常耗 Token。</p>
<p><strong>因为 Clawdbot 拥有的权限比较高，一不小心可能会把电脑系统的东西删除了就麻烦啦！！！</strong></p>
<blockquote>
<p>另外 Clawdbot 的安全性堪忧，直接部署和一些线上服务联合在一起，你的 Clawdbot 大部分网关可是暴露在公网上的，没有任何身份验证，就可以拥有完整的 Shell 访问权限。 小心黑客直接偷家了哦</p>
</blockquote>
<p>需要尝试的伙伴，建议在虚拟机上部署，或者在一台不怎么用的 Mac 电脑也行。</p>
<h2 data-id="heading-0">如何安装使用 Clawdbot</h2>
<p>电脑系统需要的<strong>环境要求：</strong></p>
<ul>
<li>Node.js 版本 &gt;= 22 以上。</li>
<li>Git</li>
</ul>
<p><strong>Windows 电脑用户建议优先选择 WSL2 （推荐 Ubuntu 系统）</strong>，Mac 电脑用户直接开箱即用。</p>
<p>安装 Clawdbot 相对比较简单，只需要用到一条 shell 命令就行。</p>
<ul>
<li>macOS / Linux / Ubuntu / Debian安装使用下面命令**（推荐）**：</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">curl -fsSL https://molt.bot/install.sh | bash
</code></pre>
<ul>
<li>Windows (PowerShell) 安装使用下面命令**（推荐）**：</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">iwr -useb https://molt.bot/install.ps1 | iex
</code></pre>
<ul>
<li>如果你需要用最新 beta 版本，可以用最新的指令：</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">curl -fsSL https://molt.bot/install.sh | bash -s -- --beta
</code></pre>
<p>当然了，可以使用 Npm 包管理进行安装，你安装了 Node.js 环境之后，都有 Npm 工具的。</p>
<p>不管是 Mac / Linux / Ubuntu / Windows 都可以直接用 Npm 工具进行管理版本和安装：</p>
<ul>
<li>支持所有系统，全局安装的指令（对npm不熟悉的，不要使用这种方式安装）：</li>
</ul>
<p>因为 npm 是官方刚发布的，可能运行有点问题，建议还是使用上面的其他指令安装。 这边知道一下就行哈。</p>
<pre><code class="hljs language-shell" lang="shell">npm i -g moltbot@latest
</code></pre>
<p>npm 安装后，如果执行 moltbot 找不到指令的话，可以改为 clawdbot 指令。</p>
<blockquote>
<p>上面的指令，使用其中一条就行，按照自己的系统使用对应的指令。</p>
</blockquote>
<h2 data-id="heading-1">当前是 Mac 苹果电脑进行安装</h2>
<p>目前我是 Node.js 22.15 版本，执行指令后，等待一段时间，会进行克隆 Github 上的仓库。</p>
<p><code>curl -fsSL https://molt.bot/install.sh | bash</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1e8fdb9cc2c43879ff01bba523b9c6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=WMJSYQVEyvMZB6WaVWhGmZUdCyE%3D" alt="" loading="lazy"/></p>
<p>当你安装成功之后，会问你是否知道 Clawdbot 的风险很高，选择 yes 之后，就可以继续。</p>
<p>如果你选择 no，那么就会直接退出安装向导。</p>
<p>这边选择 <strong>QuickStart</strong> 模式，可以默认使用 Clawdbot 的配置。</p>
<p>这是分配的默认端口：18789， <strong>然后 Clawdbot 是支持 ChatGPT 和 Claude 的 OAuth 授权登录方式。</strong></p>
<p>也就是你可以不需要去购买API，使用会员的 Codex 或者 Claude Code。</p>
<blockquote>
<p>但是，这里建议别用 Claude 授权登录，因为 Claude 是小气鬼，会阻止你使用非 Claude Code 的服务去调用 Claude。 如果你非要用 Claude 的话，但是没有 Claude 账号，可以在这里申请一个：chatshare.cc</p>
</blockquote>
<p>因为我平时的主力是 Codex，所以我选择 OpenAI, 使用 Codex 的 OAuth 就行，<strong>另外你只要是 GPT 会员（Plus、Business、Pro）就可以用这个方式。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4490e61ad95407c9a125678b42b8346~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=WaquS0Hr%2FJDQmmHqLnUk8kjIdnE%3D" alt="" loading="lazy"/></p>
<p>虽然我本地有 Codex CLI，为了方便大家了解 ChatGPT 授权登录的方式，这边我先选择第 2 种。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43675a47b5004b6c8dbef9d60caf3745~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=7mteplvYFCnbdB3RWWm%2B39U8zYA%3D" alt="" loading="lazy"/></p>
<p>会给你一条 ChatGPT 授权登录的链接，正常你的电脑会自动弹起浏览器，你只需要选择对应的会员进行登录即可。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0678374324a94ef6a1dcf1e6b0f6f43e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=9gGVRHn2WWsGXfJHr%2BnH2%2BB9AtU%3D" alt="" loading="lazy"/></p>
<p>这边我是开通了 ChatGPT Businss 会员 和 Plus 会员，不过平时我会优先消耗 Business 会员的 额度，这里我就选择 Business 会员。</p>
<p><strong>因为 ChatGPT Business 会员比较便宜，目前有优惠活动价，几十块钱就可以用跟 Plus 会员一样的 Codex 额度。</strong></p>
<p><strong>高性价比体验 Clawdbot 的方式：</strong></p>
<blockquote>
<p><strong>ChatGPT Business 优惠开通的地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fupchatgpt.com" target="_blank" title="https://upchatgpt.com" ref="nofollow noopener noreferrer">upchatgpt.com</a></p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0824fc26cda544bbb36d2a55c4a76c16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=gtNaiOfZAXdZXp1OPSySFGHrmjM%3D" alt="" loading="lazy"/></p>
<p>点击继续后，就会进行回调，告诉你授权成功后，你就可以回到终端查看安装状态。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7dbb5a91f0f4292922de728f4d74ff8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=SnIA8C08XWZ6zh8swqkcgmP2FXY%3D" alt="" loading="lazy"/></p>
<p>PS：<strong>如果你的终端没有自动回调获取到 Code 的话，你就把当前这条回调地址，localhost 开头的，全部复制，粘贴到终端就成功登录啦</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ceb84ce3d4da48e6bdf326f2cbfedf92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=%2FY4MUkwa4i0yF9dY8oU9YUEy1Go%3D" alt="" loading="lazy"/></p>
<p>我选择了默认 GPT-5.2-Codex 模型，然后就会进入选择频道，我是测试了 TG 的机器人，这里教程的话，我就先跳过啦。</p>
<p>你可以跳过，后续再选择，或者配置其他的频道。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d543e1bf06204d12b7dedc983b14b8ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=LW0%2BQhscCyqYi6VFkZD0%2Fo6p%2FvI%3D" alt="" loading="lazy"/></p>
<p>接下来就是配置 <strong>skills</strong>，是的，这个 skills 就是你平时听到的那个 skills。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78101277044e495fad74c71229b7fe69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=SdFTTDb3z4rRkrLFwMeJKpeAbvs%3D" alt="" loading="lazy"/></p>
<p>接着就是包管理工具，这里选择平时自己喜欢的就行，默认用的 npm 就行。</p>
<p>后面就会给你一些 Skills，你可以按需选择，或者先跳过也可以。 后续都可以安装的，直接跟 Clawdbot 说安装对应的 skills 就行。</p>
<p>无需手动哦，只需对话。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/514d371d47234936adb2a0f2faebf961~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=c7EdvsnhV428UfUHmLhsFQWS174%3D" alt="" loading="lazy"/></p>
<p>后续出现一些 API KEY 的设置，如果你没有，直接回车：No 就行。 这里是一些图片生成之类的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21d63748cf3c44e68217e78254c1386e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=SevMG2GO%2FoO9M3yWG1JEqib9YtI%3D" alt="" loading="lazy"/></p>
<p>最后，问你需不需要开启钩子，这三个都是 <strong>Moltbot 的内置 hooks（钩子脚本）</strong>，用来在特定事件发生时自动做事：</p>
<ul>
<li>boot-md：网关（gateway）启动后自动读取并执行工作区里的 BOOT.md 里的引导/启动指令。</li>
<li>command-logger：把所有命令事件记录到本地审计日志文件（默认 ~/.clawdbot/logs/commands.log）</li>
<li>session-memory：当你发出 /new 时，把当前会话上下文保存成一份“记忆快照”到工作区（默认 ~/clawd/memory/ 相关路径）。</li>
</ul>
<p>建议直接三个都钩上开启。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7eb6b2317ae496a8a56a80d39040cca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=Vz%2FxXPCYujTmweTKnzVaZzKLiIY%3D" alt="" loading="lazy"/></p>
<p>接下来会问你用什么方式开启使用你的 AI 助手。对于新手的话，<strong>建议选择 web ui</strong> ，就是有页面可以操作，不需要输入各种指令进行操作。</p>
<p>配置基本都完成啦，现在可以运行你的 Clawdbot 。</p>
<p>可以执行下面指令，就会自动打开 web ui 控制页面啦：</p>
<pre><code class="hljs language-shell" lang="shell">clawdbot dashboard
</code></pre>
<p>默认本地服务运行的端口和地址：<code>http://127.0.0.1:18789</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db3222e815f24cd5ba25a8b50d41220a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=Y6n8T6EesiVXeSJxmu2XKmddN60%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>提示：虽然 Clawdbot 改名为 Moltbot，但是目前的工具的指令还没有更新为 moltbot，所以你用官方的指令可能无法确认自己是否成功安装！ 那么，你可以直接把 moltbot 相关 改为 clawdbot 去运行指令，就可以啦！</p>
</blockquote>
<h2 data-id="heading-2">一些常用的 Clawdbot 指令说明</h2>
<ul>
<li>快速诊断当前 clawdbot 的状态（含模型提供商用量/配额等信息）</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">clawdbot status
</code></pre>
<ul>
<li>打开 clawdbot 浏览器 Web UI（最快开始聊天/看状态）的管理页面：</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">clawdbot dashboard
</code></pre>
<ul>
<li>查看频道配置、探测频道健康、看频道日志。</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">clawdbot channels list|status|logs
</code></pre>
<ul>
<li>直接在终端里开 TUI 聊天（没浏览器/远程机很爽）。</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">clawdbot tui
</code></pre>
<ul>
<li>重新跑配置向导（改模型/频道/技能时很好用）</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">clawdbot configure
</code></pre>
<ul>
<li>管理网关（ <strong>Clawdbot 服务</strong> ） 服务的状态/安装/停/重启。</li>
</ul>
<p>如果要关闭你现在在运行的 clawdbot，直接用 <code>clawdbot gateway stop</code> 就可以啦～</p>
<pre><code class="hljs language-shell" lang="shell">clawdbot gateway status|install|stop|restart
</code></pre>
<p>现在你可以去体验 Clawdbot 啦！当然，如果你不使用 Codex、Claude 这些服务运行 Clawdbot 的话，也可以配置第三方 API 和 KEY，就是可以用国内模型运行 Clawdbot。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（69）Hibernate与JPA的关系]]></title>    <link>https://juejin.cn/post/7600229327436382258</link>    <guid>https://juejin.cn/post/7600229327436382258</guid>    <pubDate>2026-01-28T11:42:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600229327436382258" data-draft-id="7600068892989079562" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（69）Hibernate与JPA的关系"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-28T11:42:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（69）Hibernate与JPA的关系
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T11:42:44.000Z" title="Wed Jan 28 2026 11:42:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Hibernate和JPA（Java Persistence API）密切相关，Hibernate是JPA的一种实现。JPA是一种Java EE规范，定义了一组用于对象关系映射（ORM）的标准接口，而Hibernate是一个流行的ORM框架，它实现了JPA规范并扩展了其功能。</p>
<p>以下是详细解释它们关系的步骤：</p>
<h3 data-id="heading-0">1. JPA概述</h3>
<p>JPA是一种Java EE规范，Java EE 5引入了它，用于简化开发持久化层。JPA定义了一组标准接口，使开发人员可以使用不同的持久化提供程序而不需要改变应用程序代码。JPA提供了以下功能：</p>
<ul>
<li>实体（Entity）类：持久化的Java对象。</li>
<li>实体管理器（EntityManager）：用于管理实体的生命周期。</li>
<li>查询语言（JPQL）：一种面向对象的查询语言。</li>
</ul>
<h3 data-id="heading-1">2. Hibernate概述</h3>
<p>Hibernate是一个广泛使用的ORM框架，它实现了JPA规范并增加了许多额外的功能。Hibernate允许开发人员通过使用持久化类和映射来与数据库进行交互。</p>
<h3 data-id="heading-2">3. JPA与Hibernate的关系</h3>
<ul>
<li><strong>JPA是规范，Hibernate是实现</strong>：JPA定义了一组接口和规则，而Hibernate是一个具体的实现。</li>
<li><strong>标准化和灵活性</strong>：通过使用JPA接口，开发人员可以轻松地更换持久化提供程序，而不需要改变业务逻辑代码。Hibernate作为JPA的实现，提供了标准化的接口和额外的功能。</li>
</ul>
<h3 data-id="heading-3">4. 代码示例</h3>
<p>以下是一个使用JPA和Hibernate的完整代码示例，展示了如何配置和使用它们。</p>
<h4 data-id="heading-4">4.1. 项目依赖</h4>
<p>使用Maven进行依赖管理，在<code>pom.xml</code>中添加JPA和Hibernate的依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- JPA API --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.persistence<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javax.persistence-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Hibernate JPA Implementation --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.hibernate<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hibernate-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.4.32.Final<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- MySQL Connector --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.26<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Spring Data JPA if using Spring Boot --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h4 data-id="heading-5">4.2. 配置数据源</h4>
<p>在<code>application.properties</code>中配置数据源和JPA属性：</p>
<pre><code class="hljs language-properties" lang="properties">spring.datasource.url=jdbc:mysql://localhost:3306/mydatabase
spring.datasource.username=root
spring.datasource.password=rootpassword
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQLDialect
</code></pre>
<h4 data-id="heading-6">4.3. 定义实体类</h4>
<p>定义一个简单的实体类，例如<code>User</code>：</p>
<h5 data-id="heading-7"><code>User.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> javax.persistence.Entity;
<span class="hljs-keyword">import</span> javax.persistence.GeneratedValue;
<span class="hljs-keyword">import</span> javax.persistence.GenerationType;
<span class="hljs-keyword">import</span> javax.persistence.Id;
<span class="hljs-keyword">import</span> javax.persistence.Table;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> String password;

    <span class="hljs-comment">// Getters and Setters</span>
    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUsername</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> username;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUsername</span><span class="hljs-params">(String username)</span> {
        <span class="hljs-built_in">this</span>.username = username;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPassword</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> password;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPassword</span><span class="hljs-params">(String password)</span> {
        <span class="hljs-built_in">this</span>.password = password;
    }
}
</code></pre>
<h4 data-id="heading-8">4.4. 创建DAO层</h4>
<p>创建一个数据访问对象（DAO）接口，用于访问数据库。如果使用Spring Data JPA，可以简化为一个接口。</p>
<h5 data-id="heading-9"><code>UserRepository.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JpaRepository</span>&lt;User, Long&gt; {
    User <span class="hljs-title function_">findByUsername</span><span class="hljs-params">(String username)</span>;
}
</code></pre>
<h4 data-id="heading-10">4.5. 创建服务层</h4>
<p>创建一个服务类，用于处理业务逻辑。</p>
<h5 data-id="heading-11"><code>UserService.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserRepository userRepository;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserService</span><span class="hljs-params">(UserRepository userRepository)</span> {
        <span class="hljs-built_in">this</span>.userRepository = userRepository;
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">createUser</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-keyword">return</span> userRepository.save(user);
    }

    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-keyword">return</span> userRepository.findById(id).orElse(<span class="hljs-literal">null</span>);
    }

    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">getAllUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> userRepository.findAll();
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">updateUser</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-keyword">return</span> userRepository.save(user);
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(Long id)</span> {
        userRepository.deleteById(id);
    }
}
</code></pre>
<h4 data-id="heading-12">4.6. 编写控制器</h4>
<p>利用上述服务类来编写RESTful API控制器。</p>
<h5 data-id="heading-13"><code>UserController.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.http.ResponseEntity;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserService userService;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserController</span><span class="hljs-params">(UserService userService)</span> {
        <span class="hljs-built_in">this</span>.userService = userService;
    }

    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;User&gt; <span class="hljs-title function_">createUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">createdUser</span> <span class="hljs-operator">=</span> userService.createUser(user);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(createdUser);
    }

    <span class="hljs-meta">@GetMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;User&gt; <span class="hljs-title function_">getUserById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.getUserById(id);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(user);
    }

    <span class="hljs-meta">@GetMapping</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;List&lt;User&gt;&gt; <span class="hljs-title function_">getAllUsers</span><span class="hljs-params">()</span> {
        List&lt;User&gt; users = userService.getAllUsers();
        <span class="hljs-keyword">return</span> ResponseEntity.ok(users);
    }

    <span class="hljs-meta">@PutMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;User&gt; <span class="hljs-title function_">updateUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id, <span class="hljs-meta">@RequestBody</span> User user)</span> {
        user.setId(id); <span class="hljs-comment">// Ensure the user ID is set correctly</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">updatedUser</span> <span class="hljs-operator">=</span> userService.updateUser(user);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(updatedUser);
    }

    <span class="hljs-meta">@DeleteMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Void&gt; <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        userService.deleteUser(id);
        <span class="hljs-keyword">return</span> ResponseEntity.noContent().build();
    }
}
</code></pre>
<h3 data-id="heading-14">5. 运行应用</h3>
<ol>
<li><strong>启动MySQL数据库</strong>：确保你的MySQL数据库运行在<code>localhost:3306</code>，并且已创建了名为<code>mydatabase</code>的数据库。</li>
<li><strong>启动Spring Boot应用</strong>：运行Spring Boot应用程序。</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">mvn spring-boot:run
</code></pre>
<h3 data-id="heading-15">6. 访问API</h3>
<p>通过以下API访问用户数据：</p>
<ul>
<li><code>POST /users</code>：创建用户。</li>
<li><code>GET /users/{id}</code>：按ID获取用户。</li>
<li><code>GET /users</code>：获取所有用户。</li>
<li><code>PUT /users/{id}</code>：更新用户。</li>
<li><code>DELETE /users/{id}</code>：删除用户。</li>
</ul>
<h3 data-id="heading-16">总结</h3>
<p>通过上述步骤，我们展示了如何使用Hibernate和JPA，从配置项目依赖、设置数据源、定义实体类、创建DAO层和服务层，并编写RESTful API控制器。此外，我们解释了Hibernate和JPA的关系，JPA作为规范提供了接口和规则，而Hibernate作为实现提供了实际的ORM功能。这样，应用程序可以利用Hibernate实现JPA规范，进行高效的数据库操作。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（70）如何在多数据库环境中使用Hibernate？]]></title>    <link>https://juejin.cn/post/7600234310965198886</link>    <guid>https://juejin.cn/post/7600234310965198886</guid>    <pubDate>2026-01-28T11:43:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600234310965198886" data-draft-id="7600245693997137930" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（70）如何在多数据库环境中使用Hibernate？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-28T11:43:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（70）如何在多数据库环境中使用Hibernate？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T11:43:43.000Z" title="Wed Jan 28 2026 11:43:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在多数据库环境中使用Hibernate，需要配置多个数据源（DataSource）和多个实体管理器（EntityManager）。通常情况下，你可能需要在Spring Boot项目中使用Hibernate来连接多个数据库。下面是详细步骤和代码示例，展示如何在Spring Boot项目中配置和使用多个数据库。</p>
<h3 data-id="heading-0">1. 项目依赖</h3>
<p>在<code>pom.xml</code>中添加必要的依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Spring Boot Starter Data JPA --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- MySQL Connector --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.26<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- HikariCP for Connection Pooling --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.zaxxer<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>HikariCP<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-1">2. 配置多个数据源</h3>
<p>需要在<code>application.properties</code>或<code>application.yml</code>文件中配置多个数据源。</p>
<h4 data-id="heading-2"><code>application.properties</code></h4>
<pre><code class="hljs language-properties" lang="properties"># Primary DataSource
spring.datasource.primary.url=jdbc:mysql://localhost:3306/primarydb
spring.datasource.primary.username=root
spring.datasource.primary.password=rootpassword
spring.datasource.primary.driver-class-name=com.mysql.cj.jdbc.Driver

# Secondary DataSource
spring.datasource.secondary.url=jdbc:mysql://localhost:3306/secondarydb
spring.datasource.secondary.username=root
spring.datasource.secondary.password=rootpassword
spring.datasource.secondary.driver-class-name=com.mysql.cj.jdbc.Driver

# Hibernate properties
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
</code></pre>
<h3 data-id="heading-3">3. 配置多数据源与实体管理器</h3>
<p>需要创建配置类来配置多个数据源与对应的实体管理器。</p>
<h4 data-id="heading-4"><code>PrimaryDataSourceConfig.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;
<span class="hljs-keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;
<span class="hljs-keyword">import</span> org.springframework.boot.jdbc.DataSourceBuilder;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.data.jpa.repository.config.EnableJpaRepositories;
<span class="hljs-keyword">import</span> org.springframework.orm.jpa.JpaTransactionManager;
<span class="hljs-keyword">import</span> org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;
<span class="hljs-keyword">import</span> org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter;
<span class="hljs-keyword">import</span> org.springframework.transaction.PlatformTransactionManager;
<span class="hljs-keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;

<span class="hljs-keyword">import</span> javax.persistence.EntityManagerFactory;
<span class="hljs-keyword">import</span> javax.sql.DataSource;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableTransactionManagement</span>
<span class="hljs-meta">@EnableJpaRepositories(
        basePackages = "com.example.primary",
        entityManagerFactoryRef = "primaryEntityManagerFactory",
        transactionManagerRef = "primaryTransactionManager"
)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrimaryDataSourceConfig</span> {

    <span class="hljs-meta">@Bean(name = "primaryDataSource")</span>
    <span class="hljs-meta">@ConfigurationProperties(prefix = "spring.datasource.primary")</span>
    <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">primaryDataSource</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> DataSourceBuilder.create().build();
    }

    <span class="hljs-meta">@Bean(name = "primaryEntityManagerFactory")</span>
    <span class="hljs-keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="hljs-title function_">primaryEntityManagerFactory</span><span class="hljs-params">(
            <span class="hljs-meta">@Qualifier("primaryDataSource")</span> DataSource dataSource)</span> {
        <span class="hljs-type">LocalContainerEntityManagerFactoryBean</span> <span class="hljs-variable">em</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalContainerEntityManagerFactoryBean</span>();
        em.setDataSource(dataSource);
        em.setPackagesToScan(<span class="hljs-string">"com.example.primary"</span>);
        em.setJpaVendorAdapter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HibernateJpaVendorAdapter</span>());
        <span class="hljs-keyword">return</span> em;
    }

    <span class="hljs-meta">@Bean(name = "primaryTransactionManager")</span>
    <span class="hljs-keyword">public</span> PlatformTransactionManager <span class="hljs-title function_">primaryTransactionManager</span><span class="hljs-params">(
            <span class="hljs-meta">@Qualifier("primaryEntityManagerFactory")</span> EntityManagerFactory entityManagerFactory)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JpaTransactionManager</span>(entityManagerFactory);
    }
}
</code></pre>
<h4 data-id="heading-5"><code>SecondaryDataSourceConfig.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;
<span class="hljs-keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;
<span class="hljs-keyword">import</span> org.springframework.boot.jdbc.DataSourceBuilder;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.data.jpa.repository.config.EnableJpaRepositories;
<span class="hljs-keyword">import</span> org.springframework.orm.jpa.JpaTransactionManager;
<span class="hljs-keyword">import</span> org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;
<span class="hljs-keyword">import</span> org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter;
<span class="hljs-keyword">import</span> org.springframework.transaction.PlatformTransactionManager;
<span class="hljs-keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;

<span class="hljs-keyword">import</span> javax.persistence.EntityManagerFactory;
<span class="hljs-keyword">import</span> javax.sql.DataSource;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableTransactionManagement</span>
<span class="hljs-meta">@EnableJpaRepositories(
        basePackages = "com.example.secondary",
        entityManagerFactoryRef = "secondaryEntityManagerFactory",
        transactionManagerRef = "secondaryTransactionManager"
)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecondaryDataSourceConfig</span> {

    <span class="hljs-meta">@Bean(name = "secondaryDataSource")</span>
    <span class="hljs-meta">@ConfigurationProperties(prefix = "spring.datasource.secondary")</span>
    <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">secondaryDataSource</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> DataSourceBuilder.create().build();
    }

    <span class="hljs-meta">@Bean(name = "secondaryEntityManagerFactory")</span>
    <span class="hljs-keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="hljs-title function_">secondaryEntityManagerFactory</span><span class="hljs-params">(
            <span class="hljs-meta">@Qualifier("secondaryDataSource")</span> DataSource dataSource)</span> {
        <span class="hljs-type">LocalContainerEntityManagerFactoryBean</span> <span class="hljs-variable">em</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalContainerEntityManagerFactoryBean</span>();
        em.setDataSource(dataSource);
        em.setPackagesToScan(<span class="hljs-string">"com.example.secondary"</span>);
        em.setJpaVendorAdapter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HibernateJpaVendorAdapter</span>());
        <span class="hljs-keyword">return</span> em;
    }

    <span class="hljs-meta">@Bean(name = "secondaryTransactionManager")</span>
    <span class="hljs-keyword">public</span> PlatformTransactionManager <span class="hljs-title function_">secondaryTransactionManager</span><span class="hljs-params">(
            <span class="hljs-meta">@Qualifier("secondaryEntityManagerFactory")</span> EntityManagerFactory entityManagerFactory)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JpaTransactionManager</span>(entityManagerFactory);
    }
}
</code></pre>
<h3 data-id="heading-6">4. 定义实体类和DAO层</h3>
<p>根据不同的数据源，将实体类和DAO层放在不同的包中。</p>
<h4 data-id="heading-7">主数据源实体类和DAO层</h4>
<h5 data-id="heading-8"><code>com.example.primary.entity.User.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.primary.entity;

<span class="hljs-keyword">import</span> javax.persistence.Entity;
<span class="hljs-keyword">import</span> javax.persistence.GeneratedValue;
<span class="hljs-keyword">import</span> javax.persistence.GenerationType;
<span class="hljs-keyword">import</span> javax.persistence.Id;
<span class="hljs-keyword">import</span> javax.persistence.Table;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> String password;

    <span class="hljs-comment">// Getters and Setters</span>
    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUsername</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> username;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUsername</span><span class="hljs-params">(String username)</span> {
        <span class="hljs-built_in">this</span>.username = username;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPassword</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> password;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPassword</span><span class="hljs-params">(String password)</span> {
        <span class="hljs-built_in">this</span>.password = password;
    }
}
</code></pre>
<h5 data-id="heading-9"><code>com.example.primary.repository.UserRepository.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.primary.repository;

<span class="hljs-keyword">import</span> com.example.primary.entity.User;
<span class="hljs-keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JpaRepository</span>&lt;User, Long&gt; {
    User <span class="hljs-title function_">findByUsername</span><span class="hljs-params">(String username)</span>;
}
</code></pre>
<h4 data-id="heading-10">次数据源实体类和DAO层</h4>
<h5 data-id="heading-11"><code>com.example.secondary.entity.Order.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.secondary.entity;

<span class="hljs-keyword">import</span> javax.persistence.Entity;
<span class="hljs-keyword">import</span> javax.persistence.GeneratedValue;
<span class="hljs-keyword">import</span> javax.persistence.GenerationType;
<span class="hljs-keyword">import</span> javax.persistence.Id;
<span class="hljs-keyword">import</span> javax.persistence.Table;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "orders")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-keyword">private</span> String orderNumber;

    <span class="hljs-comment">// Getters and Setters</span>
    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getOrderNumber</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> orderNumber;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setOrderNumber</span><span class="hljs-params">(String orderNumber)</span> {
        <span class="hljs-built_in">this</span>.orderNumber = orderNumber;
    }
}
</code></pre>
<h5 data-id="heading-12"><code>com.example.secondary.repository.OrderRepository.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.secondary.repository;

<span class="hljs-keyword">import</span> com.example.secondary.entity.Order;
<span class="hljs-keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OrderRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JpaRepository</span>&lt;Order, Long&gt; {
    Order <span class="hljs-title function_">findByOrderNumber</span><span class="hljs-params">(String orderNumber)</span>;
}
</code></pre>
<h3 data-id="heading-13">5. 创建服务层</h3>
<h4 data-id="heading-14">主数据源服务层</h4>
<h5 data-id="heading-15"><code>com.example.primary.service.UserService.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.primary.service;

<span class="hljs-keyword">import</span> com.example.primary.entity.User;
<span class="hljs-keyword">import</span> com.example.primary.repository.UserRepository;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserRepository userRepository;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserService</span><span class="hljs-params">(UserRepository userRepository)</span> {
        <span class="hljs-built_in">this</span>.userRepository = userRepository;
    }

    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">createUser</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-keyword">return</span> userRepository.save(user);
    }

    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-keyword">return</span> userRepository.findById(id).orElse(<span class="hljs-literal">null</span>);
    }

    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">getAllUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> userRepository.findAll();
    }

    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">updateUser</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-keyword">return</span> userRepository.save(user);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(Long id)</span> {
        userRepository.deleteById(id);
    }
}
</code></pre>
<h4 data-id="heading-16">次数据源服务层</h4>
<h5 data-id="heading-17"><code>com.example.secondary.service.OrderService.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.secondary.service;

<span class="hljs-keyword">import</span> com.example.secondary.entity.Order;
<span class="hljs-keyword">import</span> com.example.secondary.repository.OrderRepository;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> OrderRepository orderRepository;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OrderService</span><span class="hljs-params">(OrderRepository orderRepository)</span> {
        <span class="hljs-built_in">this</span>.orderRepository = orderRepository;
    }

    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-keyword">return</span> orderRepository.save(order);
    }

    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">getOrderById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-keyword">return</span> orderRepository.findById(id).orElse(<span class="hljs-literal">null</span>);
    }

    <span class="hljs-keyword">public</span> List&lt;Order&gt; <span class="hljs-title function_">getAllOrders</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> orderRepository.findAll();
    }

    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">updateOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-keyword">return</span> orderRepository.save(order);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteOrder</span><span class="hljs-params">(Long id)</span> {
        orderRepository.deleteById(id);
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kimi 开源新模型，不输 Gemini 3，太有眼力见了！]]></title>    <link>https://juejin.cn/post/7600216277426864162</link>    <guid>https://juejin.cn/post/7600216277426864162</guid>    <pubDate>2026-01-28T10:09:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600216277426864162" data-draft-id="7600265780349173800" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kimi 开源新模型，不输 Gemini 3，太有眼力见了！"/> <meta itemprop="keywords" content="前端,AIGC,AI编程"/> <meta itemprop="datePublished" content="2026-01-28T10:09:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿杆"/> <meta itemprop="url" content="https://juejin.cn/user/4182956056773160"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kimi 开源新模型，不输 Gemini 3，太有眼力见了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4182956056773160/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿杆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T10:09:54.000Z" title="Wed Jan 28 2026 10:09:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>就在昨天，Kimi 正式发布了 K2.5 版本。点开公告一看，好家伙，这是要 “掀桌子” 啊！</p>
<p>这次 Kimi 不仅把模型能力拉满了（Lookahead 推理、长上下文），还直接开源了 K2.5 模型。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a62ffddd77d49b08b764ef190ce6e3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=AeL41udDxlmOsTonNUhItVBS7G8%3D" alt="" loading="lazy"/></p>
<p>不过，数据好不代表用起来好，是骡子是马还得先拉出来溜溜。</p>
<p>这次更新最大的两个亮点：<strong>Visual Coding（视觉编程）</strong> 和 <strong>Agent 集群</strong>。简单说，就是 AI 不仅能看懂你的屏幕，还能分身成一支团队帮你干活。</p>
<p>刚好我有个 idea 想试试，做一个 <strong>赛博朋克风格的番茄钟</strong>。</p>
<p>为了验证 K2.5 的真实实力，我给它定了个小目标：我全程不碰代码，只靠动嘴和截图，看这玩意儿到底能不能真落地。</p>
<h2 data-id="heading-0">Agent 集群初体验</h2>
<p>在开始大项目之前，我先拿 Kimi 试了个开胃菜 。</p>
<p>以前我们用 AI，都是一问一答模式。但 Kimi K2.5 的 Agent 集群打破了这个限制，<strong>它可以瞬间拆解任务，同时调度多个 Agent 协同工作</strong>。</p>
<p>我发了一条指令试水：</p>
<blockquote>
<p>帮我批量调研过去 10 年最奇葩的“搞笑诺贝尔奖”（Ig Nobel Prize），生成一个 Markdown 表格，列出年份、奖项、获奖者和搞笑理由。</p>
</blockquote>
<p>整个过程大约持续了8分钟，我看到它分配了10个Agent，然后每个人分别去查一年的资料，最后刷刷刷给我列出了一个表格！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40b7ed39f0fc43c28efe816060fab457~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=vkreW16EVOeG1tlGAW2w6MNmvXk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a30f21e5b9b6453ea8ddb4c19650aa18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=I9JWXTlB2NBooLU%2BL8zwbNWLdTw%3D" alt="" loading="lazy"/></p>
<p>以前这种活，我得自己搜完一个，再搜下一个，或者不停点 “继续生成”。</p>
<p>现在 Kimi 瞬间理解了批量意图，后台自动拆分任务去查资料，然后汇总给我。</p>
<p>这种高效率的爽感，让我对后面的项目充满了信心！</p>
<p>而且它的工作过程，让我看到，确实是一步步脚踏实地去做的，每一个 SubAgent 都真实的去做了调研，而不是随便找一个别人整理的不确定真实性的那种结果。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79b5b723128b45e0a9a879d622418d03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=6ATvcYxYxTMyKIBHZS0fjw0ZVZQ%3D" alt="" loading="lazy"/></p>
<p>这种能力，对于做产品或者做科研来说，都是相当有用的。</p>
<p><strong>那么接下来，要开始做我们的番茄钟了！</strong></p>
<h2 data-id="heading-1">第一步：调研</h2>
<p>要开发产品，绝不能拍脑袋。以前做竞品调研、查文献，少说得花一下午。现在？交给 Agent 集群。</p>
<p>我直接给它下了这个任务：</p>
<blockquote>
<p>帮我调研 50 篇关于“番茄工作法与专注力提升”的心理学论文或高引用文章，总结出最科学的专注时间、休息间隔，以及什么样的白噪音最能提升效率。</p>
</blockquote>
<p>在 Kimi 的任务管理器里，瞬间爆出了几个子任务，这就好比你手下多了几个实习生，每个人领了几篇论文去读。</p>
<p>看着后台刷刷刷全是它干活的记录，而我只能在一旁摸鱼，这种 <strong>一人成军</strong> 的感觉太棒了！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89c8ed865712406ba2b767360d8a446c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=7vW7%2FRz69Jgo2RGWyAoXlxQC1ww%3D" alt="" loading="lazy"/></p>
<p>几分钟后，一份深度报告出来了：</p>
<ul>
<li><strong>最佳节奏</strong>：25-30分钟专注+5分钟休息</li>
<li><strong>意外发现</strong>：<strong>粉红噪音/自然声音（45-55dB）</strong> 对提升专注力有显著效果</li>
</ul>
<p>而且还整理了很多的报告文档，以及它阅读了哪些论文，论文链接、摘要之类的都给整理出来了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fcb2ca7714104d948c96c67442747db8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=nUv87Yizkt3PNyhE%2BE75TvLBuCk%3D" alt="" loading="lazy"/></p>
<p>（右侧是它整理的文档内容）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb009058544a4d9d8faa5e279a720ee9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=OEj5t%2BiDZAC%2BizKk4S2D%2BmAZbyw%3D" alt="" loading="lazy"/></p>
<p>这调研能力真的很强，普通人依靠它也完全可以做好一个初步的调研。</p>
<h2 data-id="heading-2">Visual Coding</h2>
<p>有了需求，接下来就是开发。</p>
<p>这次，我选择不碰代码，而是试试 K2.5 的新功能，<strong>Video-to-Code（视频生成代码）</strong> 。</p>
<h3 data-id="heading-3">视频复刻</h3>
<p>既然要做赛博朋克风，那种故障艺术（Glitch）的动效是灵魂。但这种效果很难用文字描述清楚，“滋滋啦啦的”、   “有点跳变”，AI 哪能听懂这个？</p>
<p>所以我直接去 CodePen 上找了一个 <strong>Glitch 文字效果的 Demo</strong>，录了段屏丢给了 Kimi：</p>
<blockquote>
<p>看这个视频里的文字效果。帮我做一个番茄钟网页：</p>
<ol>
<li>倒计时 25 分钟，支持开始、暂停、重置</li>
<li>倒计时数字要有这种故障抖动、颜色闪烁的效果</li>
<li>背景播放 45Hz 双耳节拍白噪音</li>
<li>整体风格要赛博朋克，霓虹配色</li>
</ol>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8c729010027465e8b9db4611e82453b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=Eo6DN5m%2Bvcq0%2B3k5yhdNSwh9U%2BQ%3D" alt="" loading="lazy"/></p>
<p>（这是我找的效果）</p>
<p>很快啊，大概3分钟就做完了，结果让我有些惊讶。</p>
<p>仅仅凭借视觉信息，Kimi 就复刻出了几乎一模一样的 CSS 关键帧动画。倒计时数字开始随机抖动、变色，还原度相当高，非常有赛博朋克的感觉。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f533ea413d64fd58792ffce47172ab8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=UPmFXNqmjyNOEPGdv%2FSRGHV%2F6U0%3D" alt="" loading="lazy"/></p>
<p>然后我又尝试了不同风格的番茄钟，科技风、毛玻璃风……我发现这种简单页面对它来说简直小儿科。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/521b7f3e94fa4ec9ace88a8d83a91fbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=6vNWpCLreqDP5zt%2BrNBII7bPR8Y%3D" alt="" loading="lazy"/></p>
<p>既然这样，我决定给它上点难度，整点复杂度更高的东西试试。</p>
<h3 data-id="heading-4">复刻高端动效</h3>
<p>我找了一个觉得不错的交互效果，录了一段它的 Tab 切换动效，那种有层次的物理感交互。</p>
<p>然后<strong>我直接把视频丢给了 K2.5</strong>，让它参照视频给我复刻一个一样的。</p>
<p>结果 Kimi 不仅复刻了布局和画风，还捕捉到了很多细节：</p>
<ul>
<li>半透明毛玻璃卡片边框</li>
<li>三张卡片以不同的节奏上下浮动</li>
<li><strong>卡片内部元素的延迟加载和弹跳动画</strong></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/077c36e966cb4539ae12902557b03af5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=TvhPkUPPZRXyXPTKTYOnFXlE0YM%3D" alt="" loading="lazy"/></p>
<p>整体都还原得相当到位👍🏻。</p>
<h3 data-id="heading-5">完整 Landing Page</h3>
<p>既然单个组件没问题，那整页呢？我又找了一个设计感很强的 Landing Page，这次我直接把网站URL丢给了它，让它帮我复刻。</p>
<p>它首先打开并且查看了网站的内容，分析网站的设计风格，然后生成需要的素材图片，最后开始复刻网站。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22e568d93df04e219134e109e999c218~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=TBysWlGWKHdlrJETThg5C%2Fy%2FUu4%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/645f107324a645688d1f8cf2e85a7af7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=Bbpqx2dsfqxBwGsHbS4BAFyBtbY%3D" alt="" loading="lazy"/></p>
<p>大概花了 10 分钟，生成了一个完整的 Landing Page。虽然细节上还需要微调，但整体框架和动效已经有模有样了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3638b200ce54763a8b04c99f668d168~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=UcvmC6um6VaBnAQ8WE9MYGjnC9I%3D" alt="" loading="lazy"/></p>
<p>这让我想到，以前做一个这样的页面，光是切图加写样式就得半天。现在？录个屏或者丢个链接，剩下的交给 Kimi。</p>
<h2 data-id="heading-6">Visual Edit：哪里不爽圈哪里</h2>
<p>不管是番茄钟还是 Landing Page，生成的初版总会有些小瑕疵。</p>
<p>换做以前，改这种细节是比较麻烦的。我得去 F12 里找到对应元素，然后跟 AI 描述“把第三个 div 的 margin-top 改成 20px”之类的。</p>
<p>现在？Kimi 支持 <strong>Visual Edit（视觉调整）</strong> 。直接在预览界面用鼠标圈选不满意的地方，然后让它改就行。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b8bd564c6e4445c85b989695d4c065b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=cS5Q%2ByjNo80Z40pRM5Yr4eceTEo%3D" alt="" loading="lazy"/></p>
<p>Kimi 精准定位代码，很快就能修改完成。这种"圈哪里改哪里"的交互方式，用起来确实很爽。</p>
<p>而且代码可以直接下载，或者一键部署到 Kimi 的托管服务上。</p>
<h2 data-id="heading-7">尾声</h2>
<p>捣鼓了一上午，我用 Kimi K2.5 做出了赛博朋克番茄钟，还顺手复刻了几个高端网页动效。</p>
<p>整个过程，我连一行代码都没碰，只充当了产品经理和审美把关人的角色：</p>
<ul>
<li><strong>调研</strong>：交给 Agent 集群，50 篇论文分钟级消化</li>
<li><strong>开发</strong>：交给 Visual Coding，看视频直接生成代码</li>
<li><strong>调整</strong>：交给 Visual Edit，圈选即改</li>
</ul>
<p>除了这些，你还可以让它帮你批量生成图片，比如请 10 个风格截然不同的知名艺术家，每人为我设计一张马年主题微信表情包。也可以给它一张风景图让它识别地点，甚至丢一道行测图形推理题让它帮你分析。</p>
<p>整体体验下来，Kimi K2.5 这次的升级确实有看点：<strong>Agent 集群的并发效率、Visual Coding 的所见即所得、还有开源模型带来的想象空间</strong>。</p>
<p>尤其是 Visual Edit，对于开发者来说简直是福音。以前改个样式要翻代码半天，现在圈一下说句话就搞定。</p>
<p>当然，K2.5 的全部能力还需要更多场景来验证。比如生成的代码在复杂项目里能不能直接用、长期维护性如何，这些都有待观察。但作为一个快速验证想法、做 Demo 的工具，它已经相当能打了。</p>
<blockquote>
<p><strong>参考链接</strong></p>
<p>K2.5 开源模型：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fmoonshotai%2FKimi-K2.5" target="_blank" title="https://huggingface.co/moonshotai/Kimi-K2.5" ref="nofollow noopener noreferrer">huggingface.co/moonshotai/…</a></p>
<p>K2.5 发布公告：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.kimi.com%2Fblog%2Fkimi-k2-5.html" target="_blank" title="https://www.kimi.com/blog/kimi-k2-5.html" ref="nofollow noopener noreferrer">www.kimi.com/blog/kimi-k…</a></p>
<p>Kimi 官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.kimi.com%2F" target="_blank" title="https://www.kimi.com/" ref="nofollow noopener noreferrer">www.kimi.com/</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React Fiber 架构全方位梳理]]></title>    <link>https://juejin.cn/post/7600219080045756459</link>    <guid>https://juejin.cn/post/7600219080045756459</guid>    <pubDate>2026-01-28T10:00:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600219080045756459" data-draft-id="7599970244787879999" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React Fiber 架构全方位梳理"/> <meta itemprop="keywords" content="前端,React.js,前端框架"/> <meta itemprop="datePublished" content="2026-01-28T10:00:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sophie旭"/> <meta itemprop="url" content="https://juejin.cn/user/2559318799692952"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React Fiber 架构全方位梳理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2559318799692952/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sophie旭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T10:00:41.000Z" title="Wed Jan 28 2026 10:00:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读43分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>作为 react 高频考点，React Fiber反复出现，为啥会成为高频考点，我觉得，很大程度上是因为 React Fiber架构真的解决了问题，并且巧妙的思想或许在未来可以给我们一些性能优化的启发，所以我们今天一起来走进 React Fiber，感受它的</p>
<h2 data-id="heading-1">一、先理解：为什么需要 Fiber 架构？</h2>
<p>React 15 及之前使用的是 <strong>Stack Reconciler（栈协调器）</strong>，它采用递归方式遍历虚拟 DOM 树，一旦开始渲染就无法中断。JS 线程是单线程的，如果渲染任务（比如复杂组件树的更新）耗时超过 16.6ms（浏览器 60fps 下每帧的时长），就会阻塞浏览器的渲染、布局、用户交互（如点击/输入），导致页面卡顿。</p>
<p>Fiber 架构的核心目标就是<strong>将同步的、不可中断的递归渲染，改成异步的、可中断的迭代渲染</strong>，彻底解决渲染阻塞问题。</p>
<h4 data-id="heading-2">一、先明确：Stack Reconciler 是什么？</h4>
<p>Stack Reconciler（栈协调器）是 React 15 及之前版本的核心渲染引擎，负责两大核心工作：</p>
<ol>
<li><strong>Reconciliation（协调）</strong>：对比新旧虚拟 DOM 树（Virtual DOM），找出需要更新的节点（即「差异（diff）」）；</li>
<li><strong>Commit（提交）</strong>：将找到的差异同步应用到真实 DOM 上。</li>
</ol>
<p>它的核心特征是：<strong>基于 JavaScript 调用栈的同步递归遍历</strong> —— 这也是「Stack（栈）」这个名字的由来（完全依赖 JS 函数调用栈完成遍历）。</p>
<h4 data-id="heading-3">二、Stack Reconciler 的递归执行流程</h4>
<p>虚拟 DOM 是树形结构，递归是最直观的遍历方式，但也埋下了「无法中断」的隐患。我们先通过一个简化的示例，还原它的执行逻辑：</p>
<h5 data-id="heading-4">1. 模拟 Stack Reconciler 的递归遍历代码</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模拟 React 15 的虚拟 DOM 节点</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">VNode</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">tag, children = []</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tag</span> = tag; <span class="hljs-comment">// 组件/标签名</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">children</span> = children; <span class="hljs-comment">// 子节点</span>
  }
}

<span class="hljs-comment">// 模拟 Stack Reconciler 的核心递归遍历方法</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">reconcile</span>(<span class="hljs-params">oldVNode, newVNode</span>) {
  <span class="hljs-comment">// 1. 对比当前节点：如果标签不同，直接标记为替换</span>
  <span class="hljs-keyword">if</span> (oldVNode.<span class="hljs-property">tag</span> !== newVNode.<span class="hljs-property">tag</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`标记替换节点: <span class="hljs-subst">${oldVNode.tag}</span> → <span class="hljs-subst">${newVNode.tag}</span>`</span>);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// 2. 递归遍历子节点（核心：深度优先递归）</span>
  <span class="hljs-keyword">const</span> oldChildren = oldVNode.<span class="hljs-property">children</span>;
  <span class="hljs-keyword">const</span> newChildren = newVNode.<span class="hljs-property">children</span>;
  <span class="hljs-keyword">const</span> maxLen = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(oldChildren.<span class="hljs-property">length</span>, newChildren.<span class="hljs-property">length</span>);

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; maxLen; i++) {
    <span class="hljs-keyword">const</span> oldChild = oldChildren[i];
    <span class="hljs-keyword">const</span> newChild = newChildren[i];
    
    <span class="hljs-comment">// 递归处理每个子节点 —— 每递归一次，就向 JS 调用栈压入一层</span>
    <span class="hljs-keyword">if</span> (oldChild &amp;&amp; newChild) {
      <span class="hljs-title function_">reconcile</span>(oldChild, newChild); <span class="hljs-comment">// 子节点存在，继续递归</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (newChild) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`标记新增节点: <span class="hljs-subst">${newChild.tag}</span>`</span>); <span class="hljs-comment">// 新节点，标记新增</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (oldChild) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`标记删除节点: <span class="hljs-subst">${oldChild.tag}</span>`</span>); <span class="hljs-comment">// 旧节点，标记删除</span>
    }
  }
}

<span class="hljs-comment">// 模拟一个复杂的组件树（多层嵌套）</span>
<span class="hljs-keyword">const</span> oldTree = <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'App'</span>, [
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Header'</span>, [<span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Logo'</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Nav'</span>)]),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Content'</span>, [
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Article'</span>, [<span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Title'</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Text'</span>)]),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Sidebar'</span>, [<span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Menu'</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Ad'</span>)])
  ]),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Footer'</span>)
]);

<span class="hljs-keyword">const</span> newTree = <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'App'</span>, [
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Header'</span>, [<span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Logo'</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Nav'</span>)]),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Content'</span>, [
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Article'</span>, [<span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Title'</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Text'</span>, [<span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Span'</span>)])]),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Sidebar'</span>, [<span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Menu'</span>)])
  ]),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Footer'</span>)
]);

<span class="hljs-comment">// 触发渲染：一旦调用，必须执行完整个递归流程</span>
<span class="hljs-title function_">reconcile</span>(oldTree, newTree);
</code></pre>
<h5 data-id="heading-5">2. 递归执行的关键特点</h5>
<p>从代码中能看到，<code>reconcile</code> 函数的执行完全依赖 JS 调用栈：</p>
<ul>
<li>每递归处理一个子节点，就会向调用栈<strong>压入一层</strong> <code>reconcile</code> 函数；</li>
<li>只有当某个节点的所有子节点都处理完毕（递归返回），该层函数才会从调用栈<strong>弹出</strong>；</li>
<li><strong><code>整个遍历过程必须「一气呵成」—— 从根节点到最深层节点，再逐层返回，中间没有任何暂停的可能。</code></strong></li>
</ul>
<h4 data-id="heading-6">三、为什么递归遍历「无法中断」？</h4>
<p>核心原因是 <strong>JavaScript 单线程 + 调用栈的同步特性</strong>：</p>
<ol>
<li><strong>JS 单线程模型</strong>：浏览器中 JS 线程和渲染线程（布局、绘制）是互斥的 —— 只要 JS 线程在执行代码，渲染线程就会被阻塞；</li>
<li><strong>调用栈不可中断</strong>：<strong><code>JS 引擎的调用栈是「同步执行」的，一旦函数开始执行，必须等到函数体完全执行完毕、调用栈清空，才会释放主线程。</code></strong></li>
</ol>
<p>举个实际场景：如果你的组件树有 1000 个节点，<code>reconcile</code> 递归遍历需要 50ms 才能完成。这 50ms 内：</p>
<ul>
<li>JS 线程被完全占用，浏览器无法处理任何用户交互（点击、输入、滚动）；</li>
<li>渲染线程被阻塞，页面无法更新，用户会明显感觉到「卡顿」（60fps 下每帧只有 16.6ms，50ms 会丢失 3 帧）；</li>
<li>即使中途用户触发了更紧急的操作（比如点击按钮），也必须等这 50ms 的递归完成后才能响应 —— 因为调用栈没有「暂停」「插队」的机制。</li>
</ul>
<h4 data-id="heading-7">四、Stack Reconciler 的核心问题</h4>
<p>除了「无法中断」，递归遍历还带来两个关键问题：</p>
<ol>
<li><strong>无优先级调度</strong>：所有更新任务（比如用户输入的高优先级更新、数据请求的低优先级更新）都被同等对待，同步排队执行 —— 比如用户输入框打字（需要即时响应），却要等一个耗时的列表渲染完成，体验极差；</li>
<li><strong>调用栈溢出风险</strong>：如果组件树嵌套过深（比如 1000 层），递归遍历会导致调用栈层数过多，直接触发 <code>Maximum call stack size exceeded</code> 错误（栈溢出）。</li>
</ol>
<h4 data-id="heading-8">总结（核心关键点）</h4>
<ol>
<li>Stack Reconciler 依赖 <strong>JS 调用栈的同步递归</strong> 遍历虚拟 DOM 树，递归的特性决定了渲染过程「一旦开始就必须执行到底」；</li>
<li>无法中断的根源是 <strong>JS 单线程 + 调用栈不可中断</strong> —— 递归过程中主线程被完全占用，阻塞渲染和用户交互；</li>
<li>直接后果是 <strong>长任务导致页面卡顿</strong>，且无法区分任务优先级，无法优先响应用户交互等关键操作（这也是 Fiber 架构要解决的核心痛点）。</li>
</ol>
<p>简单来说，React 15 的 Stack Reconciler 就像「一口气跑完马拉松」，不管中途有没有突发情况，都不能停；而 Fiber 架构则是「分段跑马拉松」，跑一段歇一下，还能优先处理紧急的事（比如喝水、接电话），这也是两者最核心的区别。</p>
<h2 data-id="heading-9">二、核心原理拆解</h2>
<h3 data-id="heading-10">1. Fiber 解决渲染阻塞的核心逻辑</h3>
<p>Fiber 解决阻塞的核心是 <strong>“任务拆分 + 时间切片 + 优先级调度”</strong>，核心逻辑可总结为 3 点：</p>
<ul>
<li><strong>任务拆分</strong>：将原本一次性完成的“整棵组件树的渲染更新”拆成无数个小任务（每个小任务只处理一个 Fiber 节点）；</li>
<li><strong>时间切片（Time Slicing）</strong>：每次只执行一个小任务，且执行时长不超过浏览器预留的空闲时间，执行完就把控制权还给浏览器；</li>
<li><strong>中断与恢复</strong>：如果当前帧的空闲时间用完，就暂停渲染任务，记录当前执行到的 Fiber 节点，等浏览器下一次空闲时再从该节点继续执行。</li>
</ul>
<p>支撑这个逻辑的两个关键基础：</p>
<ul>
<li><strong>Fiber 数据结构</strong>：每个 Fiber 节点对应一个组件，除了保存组件的 props/state 外，还增加了 <code>return</code>（父节点）、<code>child</code>（子节点）、<code>sibling</code>（兄弟节点）等指针，形成链表结构——这是“中断后能恢复”的关键（递归栈无法记录中断点，链表可以）；</li>
<li><strong>Scheduler 调度器</strong>：React 自研的调度模块，负责给任务分配优先级、计算空闲时间、控制任务的执行/暂停。</li>
</ul>
<h4 data-id="heading-11">一、拆分的核心基础：Fiber 节点是「可独立处理的最小单元」</h4>
<p>要拆分任务，首先得有「可拆分的最小单元」—— Fiber 节点就是这个单元。
React 把每一个组件（无论是类组件、函数组件还是原生标签）都对应成一个 Fiber 节点，并且给每个节点设计了<strong>链表指针</strong>（<code>child</code>/<code>sibling</code>/<code>return</code>），替代了原来的递归树结构。</p>
<p>每个 Fiber 节点都包含了「处理该节点所需的全部信息」，比如：</p>
<ul>
<li>组件的 <code>props</code>/<code>state</code>；</li>
<li>对应的真实 DOM 节点；</li>
<li>要执行的操作（比如「更新」「新增」「删除」）；</li>
<li>链表指针（找到下一个要处理的节点）。</li>
</ul>
<p>这意味着：<strong>处理单个 Fiber 节点不需要依赖其他节点的执行结果</strong>，可以单独作为一个「小任务」来执行——这是任务能被拆分的核心前提。</p>
<h4 data-id="heading-12">二、任务拆分的核心逻辑：从「递归整树处理」→「迭代逐个节点处理」</h4>
<p>Stack Reconciler 是「一次性递归遍历整棵树」，而 Fiber 架构则是把「整树处理」拆成「处理单个节点」的小任务，通过<strong>迭代 + 链表遍历</strong>的方式逐个执行，具体拆分逻辑如下：</p>
<h5 data-id="heading-13">1. 拆分原则</h5>
<ul>
<li>大任务：整棵组件树的渲染更新（Reconciliation 阶段）；</li>
<li>小任务：处理<strong>一个 Fiber 节点</strong>（包括：对比新旧节点、标记副作用、确定下一个要处理的节点）；</li>
<li>拆分方式：按「深度优先 + 链表遍历」的顺序，把整树的处理拆成一个个独立的「单个节点处理任务」。</li>
</ul>
<h5 data-id="heading-14">2. 链表遍历的顺序（决定小任务的执行顺序）</h5>
<p>Fiber 链表的遍历遵循「深度优先」，但通过指针实现迭代（而非递归），顺序是：</p>
<ol>
<li>先处理当前节点（小任务 1）；</li>
<li>如果有子节点（<code>child</code>），下一个处理子节点（小任务 2）；</li>
<li>如果没有子节点，但有兄弟节点（<code>sibling</code>），下一个处理兄弟节点（小任务 3）；</li>
<li>如果既没有子节点也没有兄弟节点，回到父节点（<code>return</code>），再找父节点的兄弟节点（小任务 4）；</li>
<li>直到回到根节点，所有小任务执行完毕。</li>
</ol>
<p>这个过程就像「走迷宫」：先往深走（子节点），走到底就往旁边走（兄弟节点），旁边也走完就退回去（父节点），再往旁边走——每走一步，就是执行一个小任务。</p>
<h4 data-id="heading-15">三、代码模拟：直观看到任务是怎么拆分的</h4>
<p>下面用简化代码模拟 Fiber 的任务拆分和执行过程，你能清晰看到「整树任务」是如何被拆成「单个节点任务」的：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 定义 Fiber 节点（最小任务单元）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">FiberNode</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">tag, props</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tag</span> = tag; <span class="hljs-comment">// 组件/标签名（如 App、Div）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span> = props; <span class="hljs-comment">// 组件 props</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">child</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 第一个子节点</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sibling</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 下一个兄弟节点</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">return</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 父节点</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">effectTag</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 要执行的操作（新增/更新/删除）</span>
  }
}

<span class="hljs-comment">// 2. 构建 Fiber 链表（模拟组件树）</span>
<span class="hljs-comment">// 结构：App → Header → Logo → Nav → Content → Article → Footer</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">App</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FiberNode</span>(<span class="hljs-string">'App'</span>, {});
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Header</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FiberNode</span>(<span class="hljs-string">'Header'</span>, {});
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Logo</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FiberNode</span>(<span class="hljs-string">'Logo'</span>, {});
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Nav</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FiberNode</span>(<span class="hljs-string">'Nav'</span>, {});
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Content</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FiberNode</span>(<span class="hljs-string">'Content'</span>, {});
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Article</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FiberNode</span>(<span class="hljs-string">'Article'</span>, {});
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Footer</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FiberNode</span>(<span class="hljs-string">'Footer'</span>, {});

<span class="hljs-comment">// 设置链表指针（构建依赖关系）</span>
<span class="hljs-title class_">App</span>.<span class="hljs-property">child</span> = <span class="hljs-title class_">Header</span>;
<span class="hljs-title class_">Header</span>.<span class="hljs-property">return</span> = <span class="hljs-title class_">App</span>;
<span class="hljs-title class_">Header</span>.<span class="hljs-property">child</span> = <span class="hljs-title class_">Logo</span>;
<span class="hljs-title class_">Logo</span>.<span class="hljs-property">return</span> = <span class="hljs-title class_">Header</span>;
<span class="hljs-title class_">Logo</span>.<span class="hljs-property">sibling</span> = <span class="hljs-title class_">Nav</span>;
<span class="hljs-title class_">Nav</span>.<span class="hljs-property">return</span> = <span class="hljs-title class_">Header</span>;
<span class="hljs-title class_">Header</span>.<span class="hljs-property">sibling</span> = <span class="hljs-title class_">Content</span>;
<span class="hljs-title class_">Content</span>.<span class="hljs-property">return</span> = <span class="hljs-title class_">App</span>;
<span class="hljs-title class_">Content</span>.<span class="hljs-property">child</span> = <span class="hljs-title class_">Article</span>;
<span class="hljs-title class_">Article</span>.<span class="hljs-property">return</span> = <span class="hljs-title class_">Content</span>;
<span class="hljs-title class_">Content</span>.<span class="hljs-property">sibling</span> = <span class="hljs-title class_">Footer</span>;
<span class="hljs-title class_">Footer</span>.<span class="hljs-property">return</span> = <span class="hljs-title class_">App</span>;
</code></pre>
<h4 data-id="heading-16">总结（核心关键点）</h4>
<ol>
<li><strong>拆分基础</strong>：Fiber 节点是「可独立处理的最小单元」，链表指针（<code>child</code>/<code>sibling</code>/<code>return</code>）让节点能被逐个遍历，无需依赖递归栈；</li>
<li><strong>拆分方式</strong>：把「整棵组件树的渲染更新」拆成「处理单个 Fiber 节点」的原子小任务，按「深度优先 + 链表遍历」的顺序逐个执行；</li>
<li><strong>可中断核心</strong>：工作循环每次只执行一个小任务，执行前检查时间，不足则中断并记录断点，恢复时从断点继续——这也是拆分的最终目的：让长任务变可中断。</li>
</ol>
<p><strong><code>简单来说，Fiber 的任务拆分就像「把一本厚书拆成一页页来读」：原来的 Stack Reconciler 是「一口气读完整本书」，而 Fiber 是「读一页，看看有没有时间，有就继续读下一页，没有就合上书记下页码，下次从这页继续读」。</code></strong></p>
<h3 data-id="heading-17">为什么 Stack Reconciler 的「一次性递归遍历整棵树」做不到像 Fiber 那样把节点处理拆成独立小任务</h3>
<h4 data-id="heading-18">一、核心差异：递归遍历中「节点处理不具备独立性」</h4>
<p>Fiber 能拆分任务的关键是「单个节点的处理不依赖其他节点的执行上下文」，但 Stack Reconciler 的递归遍历中，<strong>处理子节点是父节点处理逻辑的「嵌套部分」，完全依赖父节点的调用上下文，无法单独拆分</strong>。</p>
<h5 data-id="heading-19">1. 先看 Stack Reconciler 的递归代码（核心片段）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Stack Reconciler 处理父节点的逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">reconcile</span>(<span class="hljs-params">oldVNode, newVNode</span>) {
  <span class="hljs-comment">// 1. 处理当前父节点的逻辑</span>
  <span class="hljs-keyword">if</span> (oldVNode.<span class="hljs-property">tag</span> !== newVNode.<span class="hljs-property">tag</span>) { <span class="hljs-comment">/* 标记替换 */</span> }

  <span class="hljs-comment">// 2. 遍历子节点 —— 这是父节点处理逻辑的「一部分」</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; maxLen; i++) {
    <span class="hljs-keyword">const</span> oldChild = oldVNode.<span class="hljs-property">children</span>[i];
    <span class="hljs-keyword">const</span> newChild = newVNode.<span class="hljs-property">children</span>[i];
    
    <span class="hljs-comment">// 3. 递归处理子节点 —— 这个调用「嵌套在父节点的函数体中」</span>
    <span class="hljs-keyword">if</span> (oldChild &amp;&amp; newChild) {
      <span class="hljs-title function_">reconcile</span>(oldChild, newChild); <span class="hljs-comment">// 子节点处理依赖父节点的循环上下文</span>
    }
  }
}
</code></pre>
<h5 data-id="heading-20">2. 递归模式下的「依赖陷阱」</h5>
<p>从代码能清晰看到：</p>
<ul>
<li>「处理子节点」不是一个「独立任务」，而是父节点 <code>reconcile</code> 函数执行过程中的<strong>嵌套步骤</strong>；</li>
<li>要处理子节点，必须先进入父节点的 <code>reconcile</code> 函数，且父节点的 <code>for</code> 循环必须执行到对应子节点的索引；</li>
<li><strong><code>子节点的递归调用「依附于父节点的调用栈」—— 父节点的函数没执行完，子节点的调用就无法独立存在；反过来，子节点的递归没返回，父节点的函数也无法结束。</code></strong></li>
</ul>
<p>举个通俗例子：</p>
<ul>
<li>Fiber 模式：每个节点是「独立的快递包裹」，处理一个包裹只需要包裹本身的信息，不用管其他包裹，能拆成一个个独立任务；</li>
<li>Stack 递归模式：所有节点是「一串连在一起的鞭炮」，要炸到第 5 个鞭炮，必须先点第 1 个，且中间不能停 —— 第 5 个的爆炸依赖前 4 个的传导，无法单独拆出第 5 个来炸。</li>
</ul>
<h4 data-id="heading-21">二、底层限制：JS 调用栈的「同步不可中断性」</h4>
<p>Stack Reconciler 依赖 JS 函数调用栈实现递归，而调用栈的特性决定了「一旦开始递归，必须执行到底」：</p>





















<table><thead><tr><th>Fiber 架构（迭代+链表）</th><th>Stack Reconciler（递归+调用栈）</th></tr></thead><tbody><tr><td>用「变量记录当前节点」（<code>workInProgress</code>），中断时只需保存这个变量</td><td>用「调用栈记录执行位置」，栈的层级和节点嵌套深度绑定</td></tr><tr><td>中断时：保存当前节点变量，直接退出循环，调用栈清空</td><td>中断时：无法退出——调用栈必须等嵌套的递归函数全部返回才能清空</td></tr><tr><td>恢复时：从保存的节点变量继续迭代，无需恢复调用栈</td><td>恢复时：无法实现——调用栈一旦弹出，无法还原之前的嵌套状态</td></tr></tbody></table>
<h5 data-id="heading-22">关键举例：递归调用栈的「不可回退性」</h5>
<p>假设组件树是 <code>App → Header → Logo</code>，递归处理时调用栈的变化是：</p>
<ol>
<li>调用 <code>reconcile(App)</code> → 栈：<code>[reconcile(App)]</code></li>
<li>遍历 App 的子节点，调用 <code>reconcile(Header)</code> → 栈：<code>[reconcile(App), reconcile(Header)]</code></li>
<li>遍历 Header 的子节点，调用 <code>reconcile(Logo)</code> → 栈：<code>[reconcile(App), reconcile(Header), reconcile(Logo)]</code></li>
</ol>
<p>此时如果想「中断处理 Logo，先处理其他任务」，不可能：</p>
<ul>
<li>要中断，必须让 <code>reconcile(Logo)</code> 执行完并返回 → 栈变成 <code>[reconcile(App), reconcile(Header)]</code>；</li>
<li>再让 <code>reconcile(Header)</code> 执行完并返回 → 栈变成 <code>[reconcile(App)]</code>；</li>
<li>最后让 <code>reconcile(App)</code> 执行完 → 栈清空。</li>
</ul>
<p><strong><code>整个过程中，你无法「暂停在 Logo 节点」，因为调用栈的层级和节点处理深度是强绑定的 —— 栈的状态就是执行位置，而栈无法被「冻结」或「保存」，只能按顺序弹出。 </code></strong></p>
<p>而 Fiber 架构中，执行位置是靠「变量（<code>workInProgress</code>）」记录的，不是调用栈：</p>
<ul>
<li>处理到 Logo 节点时，<code>workInProgress = Logo</code>；</li>
<li>想中断？直接退出循环，保存 <code>workInProgress = Logo</code> 即可，调用栈完全清空；</li>
<li>恢复时，把 <code>workInProgress</code> 设为 Logo，重新启动循环就能继续处理，无需依赖任何栈状态。</li>
</ul>
<h4 data-id="heading-23">三、处理单元的本质：「整树遍历」vs「单个节点处理」</h4>
<p>Stack Reconciler 的「最小处理单元」是「整棵树的遍历」，而 Fiber 的「最小处理单元」是「单个节点的处理」—— 这是能否拆分的根本：</p>
<ol>
<li>
<p><strong>Stack Reconciler</strong>：</p>
<ul>
<li>开发者调用 <code>setState</code> 后，React 启动的是「整棵树的 reconcile 任务」，这个任务是「不可分割的整体」；</li>
<li>即使你只想更新一个 Logo 节点，也必须从 App 根节点开始，递归遍历到 Logo，再逐层返回 —— 整个过程是一个「大任务」，没有更小的可执行单元。</li>
</ul>
</li>
<li>
<p><strong>Fiber 架构</strong>：</p>
<ul>
<li>启动的是「遍历链表的工作循环」，这个循环的「最小执行单元」是「处理单个 Fiber 节点」；</li>
<li>想更新 Logo 节点？工作循环可以只执行「处理 Logo 节点」这个小任务，时间不够就暂停，完全不影响其他节点的处理状态。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-24">总结（核心关键点）</h4>
<ol>
<li><strong>独立性差异</strong>：Stack 递归中，子节点处理是父节点逻辑的嵌套部分，依赖父节点的调用上下文，无法拆成独立任务；Fiber 节点包含全部处理信息，单个节点处理无需依赖其他节点；</li>
<li><strong>执行载体差异</strong>：Stack 依赖 JS 调用栈，栈的同步特性决定了递归必须执行到底，无法中断/保存状态；Fiber 依赖变量记录当前节点，迭代执行，可随时中断并保存执行位置；</li>
<li><strong>最小单元差异</strong>：Stack 的最小处理单元是「整树遍历」，Fiber 的最小处理单元是「单个节点处理」—— 这是能否拆分的核心。</li>
</ol>
<p>简单来说：Stack Reconciler 就像「用一根绳子串起所有珠子，要拿最后一颗必须把整串拉到底」；而 Fiber 是「每个珠子都有独立的标签和位置信息，想拿哪颗就拿哪颗，拿一半放下也能记住位置」。这就是递归遍历无法拆分，而 Fiber 能拆分的根本原因。</p>
<h3 data-id="heading-25">「中断后能恢复」的关键是<strong>能否精准记住「下一个该处理的节点」</strong></h3>
<p>本质上，「中断后能恢复」的关键是 <strong><code>能否精准记住「下一个该处理的节点」</code></strong> —— 递归栈的执行逻辑天然做不到这一点，而 Fiber 链表通过「显式的节点引用 + 独立变量记录」完美解决了这个问题。下面我用「通俗例子 + 逻辑拆解 + 对比」的方式讲透。</p>
<h4 data-id="heading-26">一、先明确：中断点需要记录什么？</h4>
<p>不管是递归还是 Fiber，想中断后恢复，必须记住一个核心信息：</p>
<blockquote>
<p><strong>中断时，下一个该处理的节点是谁？</strong>
比如处理到 <code>App → Header → Logo</code> 后中断，需要记住「接下来该处理 Logo 的兄弟节点 Nav」，恢复时直接从 Nav 开始，而不是从头重新处理 App。</p>
</blockquote>
<p>这是恢复的核心前提 —— 递归栈做不到记录这个信息，而链表可以。</p>
<h4 data-id="heading-27">二、递归栈为什么「无法记录中断点」？</h4>
<p><strong><code>递归栈的执行位置，是靠 **JS 调用栈的「层级」和「函数执行上下文」** 来隐式记录的，而非显式的节点引用 —— 这意味着一旦中断，这些上下文会全部丢失，无法还原。</code></strong></p>
<h5 data-id="heading-28">1. 递归栈的「执行位置」绑定调用栈层级</h5>
<p>举个具体例子：组件树是 <code>App → Header → Logo（子）/ Nav（兄弟）</code>，递归处理时的调用栈变化：</p>
<pre><code class="hljs language-css" lang="css">// 步骤<span class="hljs-number">1</span>：调用 reconcile(App) → 栈：<span class="hljs-selector-attr">[reconcile(App)]</span>
// 步骤<span class="hljs-number">2</span>：遍历 App 子节点，调用 reconcile(<span class="hljs-selector-tag">Header</span>) → 栈：<span class="hljs-selector-attr">[reconcile(App), reconcile(Header)]</span>
// 步骤<span class="hljs-number">3</span>：遍历 <span class="hljs-selector-tag">Header</span> 子节点，调用 reconcile(Logo) → 栈：<span class="hljs-selector-attr">[reconcile(App), reconcile(Header), reconcile(Logo)]</span>
</code></pre>
<p>此时想中断（比如时间不足），要处理的下一个节点是 <code>Nav</code>（Logo 的兄弟），但递归栈的问题来了：</p>
<ul>
<li>「下一个该处理 Nav」这个信息，只存在于 <code>reconcile(Header)</code> 函数的<strong>执行上下文</strong>中（比如循环变量 <code>i=1</code>，对应 Header 子节点的第二个元素）；</li>
<li>调用栈的层级只记录「当前正在执行 reconcile(Logo)」，但<strong>无法直接记录「下一个节点是 Nav」</strong>；</li>
<li>如果强行中断（比如退出函数），<code>reconcile(Logo)</code> 会返回，<code>reconcile(Header)</code> 的执行上下文（循环变量 <code>i</code>、Header 节点的引用）会被销毁，调用栈回到 <code>[reconcile(App)]</code>；</li>
<li>等恢复时，你只知道「之前执行到过 Logo」，但完全不知道「下一个该处理 Nav」—— 只能从头重新调用 <code>reconcile(App)</code>，相当于白执行了前面的步骤。</li>
</ul>
<h5 data-id="heading-29">2. 递归栈的「不可恢复性」核心</h5>





















<table><thead><tr><th>递归栈的特性</th><th>导致的问题</th></tr></thead><tbody><tr><td>执行位置靠「栈层级 + 函数上下文」隐式记录</td><td>中断时函数上下文销毁，无法记住「下一个节点」</td></tr><tr><td>调用栈只能「先进后出」，无法暂停/保存</td><td>要么执行完当前递归，要么全部退出，没有中间状态</td></tr><tr><td>没有独立变量记录「待处理节点」</td><td>恢复时只能从头开始，无法从中断点继续</td></tr></tbody></table>
<p>通俗比喻：递归栈就像「在纸上写作业，没写完就被擦掉」—— 你只知道写到了第3题，但不知道第3题写完后该写第4题，只能重新从第1题开始写。</p>
<h4 data-id="heading-30">三、Fiber 链表为什么「能记录中断点」？</h4>
<p>Fiber 架构放弃了递归栈，改用 <strong>「独立变量 + 链表指针」显式记录中断点</strong> —— 中断点的核心信息（下一个待处理节点）被保存在一个独立变量（<code>workInProgress</code>）中，和调用栈无关，就算中断也不会丢失。</p>
<h5 data-id="heading-31">1. 链表的「执行位置」绑定「节点引用」</h5>
<p>还是同一个例子：组件树 <code>App → Header → Logo / Nav</code>，Fiber 处理时的逻辑：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 初始化：待处理节点 = App</span>
<span class="hljs-keyword">let</span> workInProgress = <span class="hljs-title class_">App</span>;

<span class="hljs-comment">// 步骤1：处理 App → 找到下一个节点（App.child = Header）→ workInProgress = Header</span>
<span class="hljs-comment">// 步骤2：处理 Header → 找到下一个节点（Header.child = Logo）→ workInProgress = Logo</span>
<span class="hljs-comment">// 步骤3：处理 Logo → 找到下一个节点（Logo.sibling = Nav）→ workInProgress = Nav</span>
</code></pre>
<p>此时想中断：</p>
<ul>
<li>只需要保存 <code>workInProgress = Nav</code> 这个变量（记录「下一个该处理 Nav」），然后直接退出循环即可；</li>
<li>调用栈会被清空（因为是迭代而非递归），但 <code>workInProgress</code> 变量不会消失；</li>
<li>恢复时，直接把 <code>workInProgress</code> 设为 Nav，重新启动循环：<code>处理 Nav → 找到下一个节点（Nav.return = Header → Header.sibling = Content）→ workInProgress = Content</code>，完美继续。</li>
</ul>
<h5 data-id="heading-32">2. 链表指针让「中断点可追溯」</h5>
<p>Fiber 节点的 <code>child</code>/<code>sibling</code>/<code>return</code> 指针，让每个节点都能「找到自己的下一个节点」，无需依赖调用栈：</p>
<ul>
<li>就算中断时只记住了 <code>Nav</code>，通过 <code>Nav.return</code> 能找到 Header，通过 <code>Header.sibling</code> 能找到 Content，永远不会「迷路」；</li>
<li>而递归栈一旦丢失上下文，节点之间的关系就无从追溯。</li>
</ul>
<h5 data-id="heading-33">3. 链表的「可恢复性」核心</h5>





















<table><thead><tr><th>Fiber 链表的特性</th><th>解决的问题</th></tr></thead><tbody><tr><td>执行位置靠「workInProgress 变量」显式记录</td><td>中断时只需保存这个变量，上下文不丢失</td></tr><tr><td>节点关系靠指针（child/sibling/return）显式关联</td><td>从任意节点都能找到下一个待处理节点</td></tr><tr><td>迭代执行，调用栈随时可清空</td><td>中断时不依赖栈层级，恢复时直接用变量继续</td></tr></tbody></table>
<p>通俗比喻：Fiber 链表就像「在作业本上贴便利贴，写不完就贴在第4题上」—— 就算合上书，下次打开看到便利贴，直接从第4题开始写就行，不用重新写。</p>
<h4 data-id="heading-34">四、直观对比：递归栈 vs Fiber 链表（中断恢复）</h4>






























<table><thead><tr><th>场景</th><th>递归栈</th><th>Fiber 链表</th></tr></thead><tbody><tr><td>处理到 Logo 后中断</td><td>调用栈层级丢失，循环变量销毁，不知道下一个是 Nav</td><td>保存 workInProgress = Nav，变量不丢失</td></tr><tr><td>恢复执行</td><td>只能重新从 App 开始递归，重复处理 App/Header/Logo</td><td>直接从 workInProgress = Nav 开始，处理 Nav/Content/...</td></tr><tr><td>核心记录方式</td><td>隐式（栈层级 + 函数上下文）</td><td>显式（独立变量 + 节点引用）</td></tr><tr><td>能否恢复</td><td>❌ 不能，只能重跑</td><td>✅ 能，精准继续</td></tr></tbody></table>
<h4 data-id="heading-35">总结（核心关键点）</h4>
<ol>
<li><strong>中断点的核心是记录「下一个待处理节点」</strong>：<strong><code>递归栈靠「调用栈层级 + 函数上下文」隐式记录，中断后上下文销毁，无法还原；Fiber 靠 </code>workInProgress<code> 变量显式记录节点引用，中断后变量不丢失。</code></strong></li>
<li><strong>链表指针是恢复的基础</strong>：<code>child</code>/<code>sibling</code>/<code>return</code> 让每个节点都能找到下一个节点，无需依赖调用栈，从任意中断点都能继续遍历。</li>
<li><strong>递归栈的本质是「依赖栈状态」，链表的本质是「依赖节点引用」</strong>：栈状态不可保存，节点引用可保存 —— 这是「能否中断恢复」的根本区别。</li>
</ol>
<p>简单来说：递归栈是「靠记忆记位置」，中断后忘了就只能重来了；Fiber 链表是「靠笔记记位置」，中断后看笔记就能精准继续。这就是链表能记录中断点、递归栈做不到的核心原因。</p>
<h3 data-id="heading-36">2. Fiber 分片/中断的执行机制 -- Scheduler</h3>
<p>Fiber 的执行分为两个核心阶段，只有第一个阶段可中断：</p>























<table><thead><tr><th>阶段</th><th>名称</th><th>核心操作</th><th>是否可中断</th></tr></thead><tbody><tr><td>阶段1</td><td>Reconciliation（协调/渲染）</td><td>对比新旧 Fiber 树、标记 DOM 变更（副作用）</td><td>✅ 可中断、可暂停、可重启</td></tr><tr><td>阶段2</td><td>Commit（提交）</td><td>将标记的副作用应用到真实 DOM</td><td>❌ 不可中断（DOM 操作必须一次性完成，避免页面不完整）</td></tr></tbody></table>
<p><strong>分片/中断的具体执行流程</strong>：</p>
<ol>
<li><strong>任务调度</strong>：当组件触发更新（如 setState），Scheduler 会根据任务优先级（比如用户输入 &gt; 数据请求）将任务加入调度队列；</li>
<li><strong>启动迭代遍历</strong>：不再递归遍历组件树，而是基于 Fiber 链表做迭代式深度优先遍历：
<ul>
<li>先处理当前 Fiber 节点（比如计算 props、对比子节点）；</li>
<li>处理完后，检查“剩余空闲时间”：如果还有时间，就取下一个 Fiber 节点（child → sibling → return）继续处理；如果没有时间，就暂停遍历；</li>
</ul>
</li>
<li><strong>中断逻辑</strong>：暂停时，React 会记录当前“工作中的 Fiber 节点”（workInProgress），然后调用 <code>requestIdleCallback</code>（或 React 模拟的空闲回调），把控制权还给浏览器，让浏览器执行布局、绘制等操作；</li>
<li><strong>恢复逻辑</strong>：当浏览器进入下一次空闲期，Scheduler 会唤醒暂停的任务，从之前记录的 workInProgress 节点继续遍历，直到所有 Fiber 节点处理完毕；</li>
<li><strong>提交阶段</strong>：协调阶段完成后，React 会一次性执行所有标记的 DOM 变更，这个过程不可中断，保证 DOM 状态的一致性。</li>
</ol>
<h3 data-id="heading-37">Scheduler 调度器的具体实现原理</h3>
<p>Scheduler 本质是一个「智能任务调度中心」，核心目标是<strong>让高优先级任务优先执行，低优先级任务利用空闲时间执行，且所有任务都能被中断/恢复</strong>。下面我会从「优先级设计」「空闲时间计算」「任务执行/暂停控制」三个核心维度，拆解它的实现逻辑，还会附上简化代码模拟核心流程。</p>
<h4 data-id="heading-38">一、核心前置认知</h4>
<p>Scheduler 是独立于 React 核心的模块（甚至可以单独使用），它的实现不依赖 Fiber 架构，但为 Fiber 提供了「可中断渲染」的基础能力。其核心设计思路是：</p>
<ul>
<li><strong><code>用「过期时间」量化任务优先级，而非单纯的“高/中/低”标签；</code></strong></li>
<li><strong><code>用「requestAnimationFrame + postMessage」模拟高精度空闲回调，替代原生 </code>requestIdleCallback<code>；</code></strong></li>
<li><strong><code>用「工作循环 + 时间检查」实现任务的执行、中断与恢复。</code></strong></li>
</ul>
<h4 data-id="heading-39">二、模块1：任务优先级的实现</h4>
<p>Scheduler 不直接用“优先级等级”，而是用<strong>过期时间（expirationTime）</strong> 来定义优先级——优先级越高，任务的过期时间越短（越早需要执行）。</p>
<h5 data-id="heading-40">1. 优先级与过期时间的映射</h5>
<p>React 定义了 5 类核心优先级（对应不同的过期时间阈值），本质是「任务必须在多久内执行，否则用户会感知到卡顿」：</p>









































<table><thead><tr><th>优先级名称</th><th>过期时间（当前时间 + X）</th><th>适用场景</th><th>核心特点</th></tr></thead><tbody><tr><td>ImmediatePriority</td><td>0ms（立即过期）</td><td>同步执行的紧急任务（如报错）</td><td>阻塞渲染，必须立即执行</td></tr><tr><td>UserBlockingPriority</td><td>250ms</td><td>用户交互（点击/输入/滚动）</td><td>250ms内执行，否则感知卡顿</td></tr><tr><td>NormalPriority</td><td>5000ms</td><td>普通任务（如网络请求回调）</td><td>不紧急，可延迟</td></tr><tr><td>LowPriority</td><td>10000ms</td><td>低优先级任务（如非关键数据加载）</td><td>可大幅延迟</td></tr><tr><td>IdlePriority</td><td>Infinity（永不过期）</td><td>空闲任务（如日志/统计）</td><td>只有浏览器空闲时才执行</td></tr></tbody></table>
<h5 data-id="heading-41">2. 优先级队列的实现：最小堆（小顶堆）</h5>
<p>Scheduler 用<strong>最小堆</strong>管理所有待执行任务，<strong><code>堆的排序依据是「过期时间」——堆顶永远是「过期时间最早（优先级最高）」的任务，保证高优先级任务先执行。</code></strong></p>
<ul>
<li>为什么用最小堆？<strong><code>堆的「取顶（O(1)）」「插入（O(logn)）」效率远高于普通数组排序，适合频繁新增/取出任务的场景；</code></strong></li>
<li>核心操作：
<ul>
<li>新增任务：插入堆中，堆自动调整，保持堆顶是最高优先级任务；</li>
<li>执行任务：每次从堆顶取出任务执行，执行完后重新调整堆。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-42">三、模块2：空闲时间计算的实现</h4>
<p>原生 <code>requestIdleCallback</code> 有两个致命问题：① 兼容性差；② 触发时机不稳定（帧率低于 60fps 时可能不触发）。因此 Scheduler 用「requestAnimationFrame (rAF) + postMessage」模拟高精度的空闲时间计算。</p>
<h5 data-id="heading-43">1. 核心原理</h5>
<p>浏览器每帧（16.6ms）的执行顺序是：</p>
<pre><code class="hljs">事件处理 → 宏任务 → 微任务 → rAF → 布局 → 绘制 → 空闲时间
</code></pre>
<p>Scheduler 利用 rAF 精准获取每帧的开始时间，再用 postMessage 触发宏任务，在宏任务中计算「当前帧剩余的空闲时间」。</p>
<h5 data-id="heading-44">2. 空闲时间计算的步骤（代码级逻辑）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 步骤1：用 rAF 获取每帧的开始时间</span>
<span class="hljs-keyword">let</span> frameStartTime = <span class="hljs-number">0</span>;
<span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">(<span class="hljs-params">timestamp</span>) =&gt;</span> {
  frameStartTime = timestamp; <span class="hljs-comment">// 记录当前帧的开始时间（ms）</span>
});

<span class="hljs-comment">// 步骤2：计算当前帧的剩余空闲时间</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">calculateRemainingTime</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 16.6ms = 1000ms / 60fps（每帧总时长）</span>
  <span class="hljs-keyword">const</span> frameDuration = <span class="hljs-number">16.6</span>;
  <span class="hljs-keyword">const</span> elapsedTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - frameStartTime; <span class="hljs-comment">// 已用时间</span>
  <span class="hljs-keyword">const</span> remainingTime = frameDuration - elapsedTime; <span class="hljs-comment">// 剩余空闲时间</span>
  <span class="hljs-comment">// 预留 5ms 安全阈值，避免占用渲染时间</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, remainingTime - <span class="hljs-number">5</span>);
}

<span class="hljs-comment">// 步骤3：用 postMessage 触发空闲任务执行</span>
<span class="hljs-comment">// 原因：postMessage 的宏任务会在「绘制完成后、下一次 rAF 前」执行，正好对应空闲时间</span>
<span class="hljs-keyword">const</span> channel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageChannel</span>();
channel.<span class="hljs-property">port2</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> remainingTime = <span class="hljs-title function_">calculateRemainingTime</span>();
  <span class="hljs-keyword">if</span> (remainingTime &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// 有空闲时间，执行调度任务</span>
    <span class="hljs-title function_">workLoop</span>(remainingTime);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 无空闲时间，等待下一次 rAF</span>
    <span class="hljs-title function_">requestAnimationFrame</span>(channel.<span class="hljs-property">port1</span>.<span class="hljs-property">postMessage</span>.<span class="hljs-title function_">bind</span>(channel.<span class="hljs-property">port1</span>));
  }
};
</code></pre>
<h5 data-id="heading-45">3. 5ms 阈值的作用</h5>
<p>计算剩余时间时，会强制减去 5ms——这是为了预留足够时间给浏览器完成「布局/绘制」，避免任务执行超时导致丢帧。</p>
<h4 data-id="heading-46">四、模块3：任务执行/暂停的实现</h4>
<p>Scheduler 的核心是「工作循环（workLoop）」，它会逐次取出高优先级任务，执行“一小段”后检查剩余时间，不足则暂停，空闲时恢复。</p>
<h5 data-id="heading-47">1. 核心流程（简化代码模拟）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模拟：最小堆任务队列（简化版，仅示意）</span>
<span class="hljs-keyword">const</span> taskQueue = [];

<span class="hljs-comment">// 1. 新增任务（带优先级）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">scheduleTask</span>(<span class="hljs-params">callback, priorityLevel</span>) {
  <span class="hljs-comment">// 步骤1：计算过期时间（当前时间 + 优先级对应的阈值）</span>
  <span class="hljs-keyword">const</span> expirationTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() + <span class="hljs-title function_">getExpirationTimeByPriority</span>(priorityLevel);
  <span class="hljs-comment">// 步骤2：插入最小堆队列</span>
  taskQueue.<span class="hljs-title function_">push</span>({ callback, expirationTime, <span class="hljs-attr">isPending</span>: <span class="hljs-literal">true</span> });
  taskQueue.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">expirationTime</span> - b.<span class="hljs-property">expirationTime</span>); <span class="hljs-comment">// 简化堆排序</span>
  <span class="hljs-comment">// 步骤3：触发调度（启动工作循环）</span>
  <span class="hljs-title function_">startWorkLoop</span>();
}

<span class="hljs-comment">// 2. 工作循环（核心：执行/中断/恢复）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">workLoop</span>(<span class="hljs-params">remainingTime</span>) {
  <span class="hljs-comment">// 取出堆顶任务（最高优先级）</span>
  <span class="hljs-keyword">let</span> currentTask = taskQueue[<span class="hljs-number">0</span>];
  
  <span class="hljs-keyword">while</span> (currentTask &amp;&amp; remainingTime &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// 检查任务是否过期/取消</span>
    <span class="hljs-keyword">if</span> (currentTask.<span class="hljs-property">expirationTime</span> &lt; <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() || !currentTask.<span class="hljs-property">isPending</span>) {
      taskQueue.<span class="hljs-title function_">shift</span>(); <span class="hljs-comment">// 移除过期/取消的任务</span>
      currentTask = taskQueue[<span class="hljs-number">0</span>];
      <span class="hljs-keyword">continue</span>;
    }

    <span class="hljs-comment">// 执行任务的「一小段」（而非一次性执行完）</span>
    <span class="hljs-comment">// 关键点：callback 返回是否需要继续执行（true=未完成，false=完成）</span>
    <span class="hljs-keyword">const</span> needContinue = currentTask.<span class="hljs-title function_">callback</span>(remainingTime);
    
    <span class="hljs-keyword">if</span> (needContinue) {
      <span class="hljs-comment">// 任务未完成，计算剩余时间（模拟执行消耗）</span>
      remainingTime -= <span class="hljs-number">1</span>; <span class="hljs-comment">// 假设执行一小段消耗 1ms</span>
      <span class="hljs-comment">// 剩余时间不足 5ms，中断任务</span>
      <span class="hljs-keyword">if</span> (remainingTime &lt; <span class="hljs-number">5</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'⚠️ 时间不足，暂停任务'</span>);
        <span class="hljs-keyword">break</span>; <span class="hljs-comment">// 退出循环，任务留在队列中</span>
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 任务完成，移除队列</span>
      taskQueue.<span class="hljs-title function_">shift</span>();
      currentTask = taskQueue[<span class="hljs-number">0</span>];
    }
  }

  <span class="hljs-comment">// 任务未执行完，下次空闲时恢复</span>
  <span class="hljs-keyword">if</span> (currentTask) {
    <span class="hljs-comment">// 重新触发 postMessage，等待下一次空闲</span>
    channel.<span class="hljs-property">port1</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">'continue'</span>);
  }
}

<span class="hljs-comment">// 3. 启动工作循环</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">startWorkLoop</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">(<span class="hljs-params">timestamp</span>) =&gt;</span> {
    frameStartTime = timestamp;
    channel.<span class="hljs-property">port1</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">'start'</span>); <span class="hljs-comment">// 触发 postMessage 回调</span>
  });
}

<span class="hljs-comment">// 辅助函数：根据优先级获取过期时间</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getExpirationTimeByPriority</span>(<span class="hljs-params">priority</span>) {
  <span class="hljs-keyword">const</span> priorities = {
    <span class="hljs-string">'immediate'</span>: <span class="hljs-number">0</span>,
    <span class="hljs-string">'user-blocking'</span>: <span class="hljs-number">250</span>,
    <span class="hljs-string">'normal'</span>: <span class="hljs-number">5000</span>,
    <span class="hljs-string">'low'</span>: <span class="hljs-number">10000</span>,
    <span class="hljs-string">'idle'</span>: <span class="hljs-title class_">Infinity</span>
  };
  <span class="hljs-keyword">return</span> priorities[priority] || <span class="hljs-number">5000</span>;
}

<span class="hljs-comment">// 测试：新增一个用户交互任务（高优先级）</span>
<span class="hljs-title function_">scheduleTask</span>(<span class="hljs-function">(<span class="hljs-params">remainingTime</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`执行任务，剩余时间：<span class="hljs-subst">${remainingTime}</span>ms`</span>);
  <span class="hljs-comment">// 模拟任务需要多次执行（返回 true 表示未完成）</span>
  <span class="hljs-keyword">return</span> remainingTime &gt; <span class="hljs-number">10</span>; <span class="hljs-comment">// 剩余时间&gt;10ms 才继续，否则暂停</span>
}, <span class="hljs-string">'user-blocking'</span>);
</code></pre>
<h5 data-id="heading-48">2. 关键逻辑拆解</h5>
<ul>
<li><strong>任务可中断</strong>：任务的回调函数不是一次性执行完，而是返回「是否需要继续执行」——如果剩余时间不足，工作循环会退出，任务留在队列中；</li>
<li><strong>任务可恢复</strong>：中断后，Scheduler 会再次触发 <code>postMessage</code>，下一次空闲时重新启动工作循环，从队列中取出未完成的任务继续执行；</li>
<li><strong>任务取消</strong>：每个任务都有 <code>isPending</code> 标记，外部可通过修改该标记取消任务，工作循环会跳过已取消的任务。</li>
</ul>
<h4 data-id="heading-49">五、Scheduler 与 Fiber 的联动</h4>
<p>Scheduler 并不直接操作 Fiber 节点，而是给 Fiber 的「工作循环」提供“时间切片”能力：</p>
<ol>
<li>Fiber 把「处理单个节点」作为小任务，传给 Scheduler；</li>
<li>Scheduler 按优先级调度这个小任务，执行前检查空闲时间；</li>
<li>时间不足时，Scheduler 暂停执行，通知 Fiber 记录当前 <code>workInProgress</code> 节点；</li>
<li>下一次空闲时，Scheduler 恢复执行，Fiber 从 <code>workInProgress</code> 继续处理节点。</li>
</ol>
<h4 data-id="heading-50">总结（核心关键点）</h4>
<ol>
<li><strong>优先级实现</strong>：用「过期时间」量化优先级，结合「最小堆」保证高优先级任务先执行；</li>
<li><strong>空闲时间计算</strong>：基于 <code>rAF + postMessage</code> 模拟高精度空闲回调，替代原生 <code>requestIdleCallback</code>，并预留 5ms 安全阈值；</li>
<li><strong>执行/暂停控制</strong>：工作循环逐次执行任务的“小单元”，执行中持续检查剩余时间，不足则中断，下次空闲时从断点恢复。</li>
</ol>
<p>简单来说，Scheduler 就像「交通调度员」：给紧急车辆（高优先级任务）开绿灯，普通车辆（低优先级任务）错峰通行，且所有车辆都能临时靠边（中断），等道路空闲后再继续行驶（恢复）。</p>
<h3 data-id="heading-51">调度逻辑的核心底气：单个 Fiber 执行足够短</h3>
<p>React 这套调度逻辑的核心底气：<strong>从设计上把「单个 Fiber 执行足够短」做成「必然结果」，而非「偶然运气」</strong>，因此哪怕多执行一个，带来的耗时增量也只是微秒级，完全在浏览器的帧时间安全范围内，不会有任何“大碍”。</p>
<p>更准确地说，这个「坚信」不是凭空的设计自信，而是<strong>三层硬约束下的必然结论</strong>，让「单个 Fiber 执行短」成为不可打破的规则，这也是整个 Scheduler 敢放弃“精准预估”、采用“实时校验+容忍多执行一个”的底层前提：</p>
<h4 data-id="heading-52">1. 处理逻辑的硬约束：只做「纯内存原子操作」</h4>
<p>单个 Fiber 节点的处理被严格限定在<strong>无阻塞、无复杂计算、无IO</strong>的内存操作内：
props浅对比、副作用标记、链表指针读取，这些操作的耗时由 JS 引擎的内存访问速度决定，<strong>天然稳定在 0.1ms 以内</strong>，不会出现任何耗时突变。
不存在“一个 Fiber 处理突然花了 1ms”的可能，因为这类操作从根源上被排除在单个 Fiber 的处理逻辑之外。</p>
<h4 data-id="heading-53">2. 组件拆分的工程要求：复杂逻辑必须拆分为多个 Fiber - 对开发者，非强制</h4>
<p>React 的 Fiber 树构建规则强制要求：<strong>任何包含复杂计算/逻辑的组件，必须拆分为子组件</strong>，进而对应多个 Fiber 节点。
比如一个渲染时要做大量数据计算的组件，React 会要求开发者拆成「计算子组件+展示子组件」，让每个子组件对应一个 Fiber，单个 Fiber 只承担一部分简单逻辑，从拆分层面保证单个处理的轻量化。</p>
<h4 data-id="heading-54">3. 阶段隔离的硬约束：耗时操作被彻底排除在 Reconciliation 阶段</h4>
<p>React 把<strong>所有耗时操作</strong>（DOM 操作、样式计算、动画执行）都隔离到「Commit 阶段」，而 Reconciliation 阶段（Fiber 节点处理的阶段）只做纯内存的对比和标记。
Commit 阶段本身是不可中断的，但它的耗时操作是<strong>批量一次性执行</strong>的，且基于 Fiber 阶段的标记精准执行，不会有冗余操作，而 Fiber 阶段的轻量化则完全不受这些耗时操作的影响。</p>
<h4 data-id="heading-55">再补一层：“多执行一个也无碍”的实际体感</h4>
<p>假设剩余时间是 1.6ms，单个 Fiber 执行耗时 0.1ms，就算因为实时校验的时机问题，<strong>多执行了3个</strong>，总耗时也只是增加 0.3ms，达到 1.9ms，远低于浏览器 16.6ms 的帧时长，更低于 5ms 的安全阈值。
这个增量在浏览器层面属于「微秒级误差」，不会导致帧丢失，用户完全感知不到任何卡顿——这就是 React 敢“容忍多执行一个”的核心原因：<strong>增量耗时在人类感知和浏览器渲染的安全范围内</strong>。</p>
<h4 data-id="heading-56">最终结论</h4>
<p>你的判断切中了核心：<strong>React 所有的调度策略（执行前预估、执行后实时校验、可中断恢复），都是建立在「单个 Fiber 执行足够短」这个不可动摇的基础上的</strong>。
这个基础不是“坚信”出来的，而是通过「逻辑限定、组件拆分、阶段隔离」三层硬约束做出来的，正是因为这个基础的存在，Scheduler 才不用纠结于“精准预估耗时”，不用害怕“多执行一个”，只用做简单的实时时间校验，就能实现高效、不阻塞的调度。</p>
<p>简单说：<strong>先把单个任务的耗时压到极致，再谈调度的容错性</strong>——这是 React Fiber 架构最底层的设计哲学。</p>
<h3 data-id="heading-57">剩余空闲时间 的具体计算方法</h3>
<p>简单来说，剩余时间的计算核心是：<strong>以浏览器每帧的总时长（≈16.6ms）为基准，减去当前帧已消耗的时间，再预留 5ms 安全阈值，最终得到可用于执行 React 任务的空闲时间</strong>。下面我用「原理 + 代码 + 例子」的方式把计算逻辑拆透。</p>
<h4 data-id="heading-58">一、计算的核心前提</h4>
<p>浏览器要保证页面流畅（60fps），每帧的总时长必须控制在 <code>1000ms ÷ 60 ≈ 16.666ms</code>（以下简称 16.6ms）。每帧内浏览器需要依次完成：</p>
<pre><code class="hljs language-scss" lang="scss">事件处理 → 宏任务 → 微任务 → <span class="hljs-built_in">requestAnimationFrame</span>(rAF) → 布局(Layout) → 绘制(Paint) → 空闲时间
</code></pre>
<p>Scheduler 计算的「剩余时间」，就是<strong>当前帧总时长 - 已消耗时长</strong>，代表浏览器完成核心工作（布局、绘制）后，还剩多少时间可以执行 React 的低优先级任务。</p>
<h4 data-id="heading-59">二、剩余时间的完整计算步骤（带代码模拟）</h4>
<p>Scheduler 对剩余时间的计算分为 4 步，核心依赖 <code>requestAnimationFrame (rAF)</code> 的高精度时间戳（而非 <code>Date.now()</code>），保证计算准确性：</p>
<h5 data-id="heading-60">步骤1：获取当前帧的「开始时间」（核心基准）</h5>
<p><code>rAF</code> 的回调函数会接收一个<strong>高精度时间戳（timestamp）</strong>，这个时间戳是浏览器给出的「当前帧开始执行的时间」，是计算的唯一基准（比 <code>Date.now()</code> 更准，避免系统时间偏差）。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 存储当前帧的开始时间（全局变量）</span>
<span class="hljs-keyword">let</span> frameStartTime = <span class="hljs-number">0</span>;

<span class="hljs-comment">// 注册 rAF，在每帧开始时记录帧起始时间</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">registerFrameStartTime</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">(<span class="hljs-params">timestamp</span>) =&gt;</span> {
    <span class="hljs-comment">// timestamp：浏览器提供的高精度时间戳（单位：ms），代表当前帧的开始时间</span>
    frameStartTime = timestamp;
    <span class="hljs-comment">// 每帧都要重新注册，保证帧开始时间实时更新</span>
    <span class="hljs-title function_">registerFrameStartTime</span>();
  });
}

<span class="hljs-comment">// 启动帧时间监听</span>
<span class="hljs-title function_">registerFrameStartTime</span>();
</code></pre>
<h5 data-id="heading-61">步骤2：计算「当前帧已消耗的时间」</h5>
<p>从帧开始到「当前时刻」，已经用掉的时间，公式为：</p>
<pre><code class="hljs">已消耗时间 = 当前高精度时间 - 帧开始时间
</code></pre>
<p>代码实现：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 获取当前高精度时间（兼容浏览器）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getCurrentTime</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// performance.now() 是高精度时间（微秒级），比 Date.now() 更适合计算短时间间隔</span>
  <span class="hljs-keyword">return</span> performance.<span class="hljs-title function_">now</span>();
}

<span class="hljs-comment">// 计算已消耗时间</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getElapsedTime</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">getCurrentTime</span>() - frameStartTime;
}
</code></pre>
<h5 data-id="heading-62">步骤3：计算「原始剩余时间」</h5>
<p>原始剩余时间 = 每帧总时长（16.6ms） - 已消耗时间，代表当前帧理论上还剩的全部时间：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 每帧总时长（60fps 下的标准值）</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">FRAME_DURATION</span> = <span class="hljs-number">1000</span> / <span class="hljs-number">60</span>; <span class="hljs-comment">// ≈16.666ms</span>

<span class="hljs-comment">// 计算原始剩余时间</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getRawRemainingTime</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> elapsedTime = <span class="hljs-title function_">getElapsedTime</span>();
  <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">FRAME_DURATION</span> - elapsedTime;
}
</code></pre>
<h5 data-id="heading-63">步骤4：应用「安全阈值」并处理边界情况</h5>
<p>为了避免 React 任务占用过多时间导致浏览器来不及完成「布局/绘制」，Scheduler 会预留 <strong>5ms 安全阈值</strong>，并保证剩余时间不会为负数（负数代表当前帧已超时）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 安全阈值：预留 5ms 给浏览器完成布局/绘制</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SAFE_THRESHOLD</span> = <span class="hljs-number">5</span>;

<span class="hljs-comment">// 最终可用的剩余时间（Scheduler 实际使用的）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getRemainingTime</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> rawRemaining = <span class="hljs-title function_">getRawRemainingTime</span>();
  <span class="hljs-comment">// 1. 减去安全阈值；2. 保证结果 ≥ 0（避免负数）</span>
  <span class="hljs-keyword">const</span> remaining = rawRemaining - <span class="hljs-variable constant_">SAFE_THRESHOLD</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, remaining);
}
</code></pre>
<h4 data-id="heading-64">三、关键细节解释（为什么要这么算？）</h4>
<h5 data-id="heading-65">1. 为什么用 <code>performance.now()</code> 而非 <code>Date.now()</code>？</h5>
<ul>
<li><code>Date.now()</code> 是「系统时间」，精度低（毫秒级），且可能被用户手动修改、时区同步等影响；</li>
<li><code>performance.now()</code> 是「相对时间」（从页面加载开始计时），精度高达微秒级（1ms = 1000μs），完全不受系统时间影响——适合计算「帧内短时间间隔」。</li>
</ul>
<h5 data-id="heading-66">2. 为什么要减 5ms 安全阈值？</h5>
<p>16.6ms 的帧时长中，浏览器需要至少 10ms 左右完成「布局 + 绘制」（这是实践验证的经验值）。如果 React 任务把剩余时间用完（比如剩 5ms 全占用），浏览器会来不及完成渲染，导致帧丢失、页面卡顿。
减 5ms 后，即使 React 用满剩余时间，浏览器仍有足够时间完成核心渲染工作。</p>
<h5 data-id="heading-67">3. 剩余时间为 0 意味着什么？</h5>
<p>如果 <code>getRemainingTime()</code> 返回 0，说明：</p>
<ul>
<li>当前帧已消耗的时间 ≥ 11.6ms（16.6 - 5）；</li>
<li>没有空闲时间执行 React 任务，Scheduler 会立即暂停任务，等待下一次帧的空闲时间。</li>
</ul>
<h4 data-id="heading-68">四、实际场景举例（直观理解）</h4>
<p>假设当前帧的执行情况如下：</p>
<ul>
<li>帧开始时间（frameStartTime）：1000.0ms；</li>
<li>当前时间（performance.now()）：1010.0ms；</li>
</ul>
<p>计算过程：</p>
<ol>
<li>已消耗时间 = 1010.0 - 1000.0 = 10ms；</li>
<li>原始剩余时间 = 16.6 - 10 = 6.6ms；</li>
<li>最终剩余时间 = 6.6 - 5 = 1.6ms（取正值）；</li>
</ol>
<p>结论：Scheduler 只会给 React 任务分配 1.6ms 的执行时间，超时就中断。</p>
<p>再举一个超时场景：</p>
<ul>
<li>已消耗时间 = 15ms；</li>
<li>原始剩余时间 = 16.6 - 15 = 1.6ms；</li>
<li>最终剩余时间 = 1.6 - 5 = -3.4ms → 取 0；</li>
</ul>
<p>结论：无空闲时间，暂停任务。</p>
<h4 data-id="heading-69">总结（核心关键点）</h4>
<ol>
<li><strong>计算基准</strong>：以 60fps 下每帧 16.6ms 为总时长，剩余时间 = 总时长 - 已消耗时间 - 5ms 安全阈值；</li>
<li><strong>时间精度</strong>：依赖 <code>rAF</code> 的高精度时间戳和 <code>performance.now()</code>，避免系统时间偏差；</li>
<li><strong>边界处理</strong>：剩余时间最小为 0，保证不会出现负数（超时则暂停任务）；</li>
<li><strong>核心目的</strong>：预留足够时间给浏览器完成渲染，避免 React 任务阻塞页面流畅性。</li>
</ol>
<p>简单来说，剩余时间的计算逻辑就是：<strong>先算当前帧还剩多少时间，再扣掉浏览器必须的渲染时间，剩下的才给 React 用</strong>——这是时间切片能「不阻塞渲染」的根本保障。</p>
<h3 data-id="heading-70">rAF 和 postMessage 的分工</h3>
<p>Scheduler 并不是「在 requestAnimationFrame (rAF) 里开启任务」，而是用 rAF 获取「帧开始时间」（作为计算剩余时间的基准），真正执行任务的时机是在 <code>postMessage</code> 的宏任务回调中；时间不足时暂停任务后，也不是直接由 postMessage 触发处理剩余任务，而是<strong>下一次帧周期重新走「rAF 记时间 → postMessage 执行任务」的流程</strong>。</p>
<p>下面我用「精准流程拆解 + 通俗比喻」把这个逻辑讲透，你就能清楚 rAF 和 postMessage 的分工，以及任务暂停/恢复的完整链路：</p>
<h4 data-id="heading-71">一、先纠正核心偏差：rAF 和 postMessage 的核心分工</h4>

























<table><thead><tr><th>角色</th><th>requestAnimationFrame (rAF)</th><th>postMessage 宏任务</th></tr></thead><tbody><tr><td>执行时机</td><td>每帧「布局/绘制前」（帧内核心工作前）</td><td>每帧「绘制完成后」（帧内空闲时间）</td></tr><tr><td>核心作用</td><td>记录「帧开始时间」（计算剩余时间的基准）</td><td>执行 React 任务（Fiber 处理）+ 检查剩余时间</td></tr><tr><td>是否直接执行任务</td><td>❌ 不执行，只记时间</td><td>✅ 是，真正的任务执行入口</td></tr></tbody></table>
<h4 data-id="heading-72">二、Scheduler 完整执行流程（纠正后的准确版本）</h4>
<p>用步骤拆解，你能清晰看到「记时间 → 算剩余 → 执行任务 → 暂停/恢复」的全链路：</p>
<h5 data-id="heading-73">步骤1：rAF 标记「帧开始时间」（准备工作）</h5>
<p>浏览器每帧启动时，先触发 rAF 回调：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">(<span class="hljs-params">timestamp</span>) =&gt;</span> {
  <span class="hljs-comment">// 记录当前帧的开始时间（高精度时间戳），作为后续计算剩余时间的基准</span>
  frameStartTime = timestamp;
});
</code></pre>
<p>👉 这一步<strong>不执行任何 React 任务</strong>，只做「时间基准标记」，为后续计算“这一帧还剩多少空闲时间”铺路。</p>
<h5 data-id="heading-74">步骤2：postMessage 触发「任务执行」（核心）</h5>
<p>rAF 执行后，浏览器会完成「布局/绘制」等核心工作，之后触发 postMessage 宏任务（这才是空闲时间）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> channel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageChannel</span>();
channel.<span class="hljs-property">port2</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 1. 先计算当前帧的剩余空闲时间（基于 rAF 记录的 frameStartTime）</span>
  <span class="hljs-keyword">const</span> remainingTime = <span class="hljs-title function_">getRemainingTime</span>(); <span class="hljs-comment">// 比如算出 1.6ms</span>

  <span class="hljs-keyword">if</span> (remainingTime &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// 2. 有空闲时间 → 执行 React 任务（处理 Fiber 节点）</span>
    <span class="hljs-keyword">const</span> hasMoreWork = <span class="hljs-title function_">workLoop</span>(remainingTime); <span class="hljs-comment">// 执行任务，返回是否有剩余任务</span>
    
    <span class="hljs-keyword">if</span> (hasMoreWork) {
      <span class="hljs-comment">// 3. 任务没做完（时间不足暂停）→ 等待下一次帧周期</span>
      <span class="hljs-comment">// 不是直接触发 postMessage，而是等下一次 rAF 后再走流程</span>
      <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> channel.<span class="hljs-property">port1</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">''</span>));
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 4. 无空闲时间 → 直接等下一次帧周期</span>
    <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> channel.<span class="hljs-property">port1</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">''</span>));
  }
};
</code></pre>
<h5 data-id="heading-75">步骤3：workLoop 执行任务 + 时间不足则暂停</h5>
<p><code>workLoop</code> 里就是处理 Fiber 节点的核心逻辑：</p>
<ul>
<li>每处理一个 Fiber 节点，就检查「已用时间是否 ≥ 剩余时间」；</li>
<li>时间不足时，<code>workLoop</code> 返回 <code>true</code>（表示有剩余任务），Scheduler 就停止执行；</li>
<li>剩余任务不会立刻由 postMessage 触发，而是<strong>等下一个帧周期</strong>：先由 rAF 重新记录帧开始时间，再由 postMessage 回调执行剩余任务。</li>
</ul>
<h4 data-id="heading-76">三、通俗比喻：把「帧周期」比作「一节课」</h4>
<ul>
<li>rAF = 上课铃：打铃时记录“上课开始时间”（帧开始时间），只记时间，不讲课；</li>
<li>浏览器的布局/绘制 = 老师讲核心知识点：必须优先完成，不能打断；</li>
<li>postMessage = 课间休息：核心知识点讲完后，才有休息时间，此时才可以做“刷题（处理 Fiber 任务）”；</li>
<li>剩余时间不足 = 课间休息快结束了：刷不完题就暂停，把剩下的题留到「下一节课的课间休息」（下一次帧的 postMessage）再做；</li>
<li>下一次 rAF = 下一节课的上课铃：先记新的上课时间，再等新的课间休息（postMessage）刷题。</li>
</ul>
<h4 data-id="heading-77">总结（核心关键点）</h4>
<ol>
<li><strong><code>rAF 只记时间，不执行任务</code></strong>：<strong><code>它的作用是给剩余时间计算提供基准，不是任务执行入口；</code></strong></li>
<li><strong><code>postMessage 才是任务执行的核心时机</code></strong>：<strong><code>只有在绘制完成后的空闲时间（postMessage 回调），才会处理 Fiber 任务；</code></strong></li>
<li><strong><code>暂停后不是立即触发 postMessage</code></strong>：<strong><code>剩余任务会等「下一次帧周期」，重新走「rAF 记时间 → postMessage 执行任务」的流程，保证始终在空闲时间执行任务，不阻塞渲染。</code></strong></li>
</ol>
<p>简单来说：<strong><code>Scheduler 是「先靠 rAF 定时间基准，再靠 postMessage 找空闲时间执行任务，时间不够就等下一轮空闲时间继续」—— 而非“rAF 开任务，postMessage 收尾”。</code></strong></p>
<h3 data-id="heading-78"><code>requestIdleCallback</code>:想法很好，落地很拉垮</h3>
<h4 data-id="heading-79">一、先明确：requestIdleCallback 到底是干啥的？</h4>
<p><code>requestIdleCallback</code> 是<strong>浏览器原生提供的「空闲时间调度 API」</strong>，核心设计目标和 React Scheduler 一致——<strong>让开发者在浏览器“没活儿干”的时候执行低优先级任务</strong>，避免占用核心渲染时间导致卡顿。</p>
<h5 data-id="heading-80">1. 核心工作逻辑</h5>
<p>浏览器每帧（16.6ms）的执行顺序是：</p>
<pre><code class="hljs language-scss" lang="scss">事件处理 → 宏任务 → 微任务 → <span class="hljs-built_in">requestAnimationFrame</span>(rAF) → 布局 → 绘制 → 【空闲时间】→ requestIdleCallback 回调
</code></pre>
<p>只有当「布局+绘制」完成后，当前帧还有剩余时间（比如只用了 10ms，剩 6.6ms），浏览器才会触发 <code>requestIdleCallback</code> 的回调函数。</p>
<h5 data-id="heading-81">2. 核心能力</h5>
<p>回调函数会接收一个 <code>IdleDeadline</code> 对象，能拿到两个关键信息：</p>
<ul>
<li><code>timeRemaining()</code>：返回当前帧还剩多少空闲时间（比如 6.6ms）；</li>
<li><code>didTimeout</code>：标记任务是否过期（若浏览器长期无空闲，任务会强制触发）。</li>
</ul>
<h5 data-id="heading-82">3. 简单示例（原生用法）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 注册一个空闲任务</span>
<span class="hljs-title function_">requestIdleCallback</span>(<span class="hljs-function">(<span class="hljs-params">deadline</span>) =&gt;</span> {
  <span class="hljs-comment">// 只要还有空闲时间，就执行任务</span>
  <span class="hljs-keyword">while</span> (deadline.<span class="hljs-title function_">timeRemaining</span>() &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-title function_">doLowPriorityWork</span>(); <span class="hljs-comment">// 比如日志收集、非紧急数据处理</span>
  }
});
</code></pre>
<p>简单说：<code>requestIdleCallback</code> 就是浏览器给开发者的「空闲时间接口」，让你把不紧急的任务塞到帧的空闲期执行。</p>
<h4 data-id="heading-83">二、为什么 React 不用它？（核心还是那两个致命问题，展开讲透）</h4>
<p>虽然 <code>requestIdleCallback</code> 的设计初衷和 React Scheduler 一致，但它的两个硬伤让 React 完全无法用——咱们之前提过「兼容性差、触发时机不稳定」，这里结合实际场景展开：</p>

























<table><thead><tr><th>问题</th><th>具体表现</th><th>对 React 的致命影响</th></tr></thead><tbody><tr><td>兼容性极差</td><td>- IE 全版本不支持<br/>- iOS Safari 仅 14.5+ 支持<br/>- 安卓 WebView 大量不支持</td><td>React 要适配多端/多浏览器，依赖它会导致旧设备用户直接失去「可中断渲染」能力，退回卡顿状态</td></tr><tr><td>触发时机极不稳定</td><td>- 帧率 &lt; 60fps 时（页面卡顿），浏览器判定「无空闲时间」，回调<strong>完全不触发</strong><br/>- 浏览器为了“保核心渲染”，会刻意压缩触发机会</td><td>React 的低优先级任务（比如列表渲染）会无限积压，甚至永远不执行；中断后的任务也无法恢复</td></tr><tr><td>无优先级调度能力</td><td>所有注册的任务都是“同等优先级”，无法让用户交互（高优先级）插队</td><td>用户点击按钮后，低优先级任务还在占用空闲时间，导致交互响应卡顿</td></tr></tbody></table>
<h4 data-id="heading-84">三、关键补充：React 自研 Scheduler（rAF + postMessage）和 requestIdleCallback 的核心差异</h4>
<p>React 不是“不用空闲时间调度”，而是「抛弃原生的 requestIdleCallback，自己实现了一个更靠谱的版本」：</p>






























<table><thead><tr><th>特性</th><th>原生 requestIdleCallback</th><th>React Scheduler（rAF + postMessage）</th></tr></thead><tbody><tr><td>兼容性</td><td>差（仅新版浏览器支持）</td><td>好（rAF + postMessage 是基础 API，全浏览器兼容）</td></tr><tr><td>触发稳定性</td><td>帧率低时完全不触发</td><td>不管帧率多少，每帧都会尝试执行（剩余时间为0就等下一帧，不会积压）</td></tr><tr><td>优先级调度</td><td>无</td><td>支持5级优先级，高优先级任务（比如点击）可插队中断低优先级任务</td></tr><tr><td>时间控制精度</td><td>依赖浏览器内置计算，无法自定义 5ms 安全阈值</td><td>自研剩余时间计算，可精准预留 5ms 给浏览器渲染</td></tr></tbody></table>
<h4 data-id="heading-85">总结（核心关键点）</h4>
<ol>
<li><code>requestIdleCallback</code> 是浏览器原生的「空闲时间调度 API」，作用是在帧的空闲期执行低优先级任务；</li>
<li>React 不用它的核心原因：<strong>兼容性差（覆盖不全）、触发不稳定（帧率低时不执行）、无优先级调度</strong>，无法满足 Fiber 架构“可中断、高优先级优先”的核心需求；</li>
<li>React 转而用 <code>rAF + postMessage</code> 自研 Scheduler，本质是「重新实现了一个更稳定、更可控、带优先级的 requestIdleCallback」。</li>
</ol>
<p>简单来说：<code>requestIdleCallback</code> 是个“想法很好但落地拉胯”的原生 API，React 嫌它不好用，就自己造了个更强大的版本——这就是 Scheduler 的本质。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Three.js 变形动画-打造花瓣绽放]]></title>    <link>https://juejin.cn/post/7600068892988653578</link>    <guid>https://juejin.cn/post/7600068892988653578</guid>    <pubDate>2026-01-28T10:01:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600068892988653578" data-draft-id="7600234310964838438" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Three.js 变形动画-打造花瓣绽放"/> <meta itemprop="keywords" content="前端,three.js"/> <meta itemprop="datePublished" content="2026-01-28T10:01:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端王校长"/> <meta itemprop="url" content="https://juejin.cn/user/2295436010076631"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Three.js 变形动画-打造花瓣绽放
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2295436010076631/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端王校长
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T10:01:41.000Z" title="Wed Jan 28 2026 10:01:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>本文将详细介绍如何使用 Three.js 实现变形动画效果。我们将学习如何利用 Morph Targets（形态目标）技术，让 3D 模型在不同形状之间平滑过渡，创造出花瓣绽放等生动的动画效果。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/014543e98fbc4129bc37fe0992bc4393~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv546L5qCh6ZW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199625&amp;x-signature=GnMhv1W0tbYWAJyd45BlfEWXlxE%3D" alt="screenshot_2026-01-28_17-56-51.gif" loading="lazy"/></p>
<h2 data-id="heading-1">准备工作</h2>
<p>首先，我们需要引入必要的 Three.js 库和相关工具：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"three"</span>;
<span class="hljs-comment">// 导入轨道控制器</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">OrbitControls</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"three/examples/jsm/controls/OrbitControls"</span>;
<span class="hljs-comment">// 导入动画库</span>
<span class="hljs-keyword">import</span> gsap <span class="hljs-keyword">from</span> <span class="hljs-string">"gsap"</span>;
<span class="hljs-comment">// 导入dat.gui</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> dat <span class="hljs-keyword">from</span> <span class="hljs-string">"dat.gui"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">DRACOLoader</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"three/examples/jsm/loaders/DRACOLoader"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">GLTFLoader</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"three/examples/jsm/loaders/GLTFLoader"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">RGBELoader</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"three/examples/jsm/loaders/RGBELoader"</span>;
</code></pre>
<h2 data-id="heading-2">场景初始化</h2>
<p>首先，我们需要创建一个基本的 Three.js 场景：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> gui = <span class="hljs-keyword">new</span> dat.<span class="hljs-title function_">GUI</span>();
<span class="hljs-comment">// 1、创建场景</span>
<span class="hljs-keyword">const</span> scene = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Scene</span>();

<span class="hljs-comment">// 2、创建相机</span>
<span class="hljs-keyword">const</span> camera = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PerspectiveCamera</span>(
  <span class="hljs-number">75</span>,
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>,
  <span class="hljs-number">0.1</span>,
  <span class="hljs-number">1000</span>
);
camera.<span class="hljs-property">aspect</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;
<span class="hljs-comment">// 更新摄像机的投影矩阵</span>
camera.<span class="hljs-title function_">updateProjectionMatrix</span>();

<span class="hljs-comment">// 设置相机位置</span>
camera.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">20</span>);
scene.<span class="hljs-title function_">add</span>(camera);
</code></pre>
<h2 data-id="heading-3">环境设置</h2>
<p>添加 HDR 环境纹理，提升场景的真实感：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 添加hdr环境纹理</span>
<span class="hljs-keyword">const</span> loader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RGBELoader</span>();
loader.<span class="hljs-title function_">load</span>(<span class="hljs-string">"./textures/038.hdr"</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">texture</span>) {
  texture.<span class="hljs-property">mapping</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">EquirectangularReflectionMapping</span>;
  scene.<span class="hljs-property">environment</span> = texture;
});
</code></pre>
<h2 data-id="heading-4">DRACO 压缩模型加载</h2>
<p>使用 DRACO 压缩技术加载 GLB 模型：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 加载压缩的glb模型</span>
<span class="hljs-keyword">const</span> gltfLoader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GLTFLoader</span>();
<span class="hljs-keyword">const</span> dracoLoader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DRACOLoader</span>();
dracoLoader.<span class="hljs-title function_">setDecoderPath</span>(<span class="hljs-string">"./draco/gltf/"</span>);
dracoLoader.<span class="hljs-title function_">setDecoderConfig</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">"js"</span> });
dracoLoader.<span class="hljs-title function_">preload</span>();
gltfLoader.<span class="hljs-title function_">setDRACOLoader</span>(dracoLoader);
</code></pre>
<h2 data-id="heading-5">变形动画核心实现</h2>
<p>这是变形动画的关键部分，通过 Morph Targets 技术实现模型变形：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> params = {
  <span class="hljs-attr">value</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">value1</span>: <span class="hljs-number">0</span>,
};

<span class="hljs-keyword">let</span> mixer;
<span class="hljs-keyword">let</span> stem, petal, stem1, petal1, stem2, petal2;

<span class="hljs-comment">// 加载第一个模型（初始状态）</span>
gltfLoader.<span class="hljs-title function_">load</span>(<span class="hljs-string">"./model/f4.glb"</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">gltf1</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(gltf1);
  stem = gltf1.<span class="hljs-property">scene</span>.<span class="hljs-property">children</span>[<span class="hljs-number">0</span>];
  petal = gltf1.<span class="hljs-property">scene</span>.<span class="hljs-property">children</span>[<span class="hljs-number">1</span>];
  gltf1.<span class="hljs-property">scene</span>.<span class="hljs-property">rotation</span>.<span class="hljs-property">x</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>;

  <span class="hljs-comment">// 遍历场景中的对象并处理材质</span>
  gltf1.<span class="hljs-property">scene</span>.<span class="hljs-title function_">traverse</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (item.<span class="hljs-property">material</span> &amp;&amp; item.<span class="hljs-property">material</span>.<span class="hljs-property">name</span> == <span class="hljs-string">"Water"</span>) {
      item.<span class="hljs-property">material</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshStandardMaterial</span>({
        <span class="hljs-attr">color</span>: <span class="hljs-string">"skyblue"</span>,
        <span class="hljs-attr">depthWrite</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">transparent</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">depthTest</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">opacity</span>: <span class="hljs-number">0.5</span>,
      });
    }
    <span class="hljs-keyword">if</span> (item.<span class="hljs-property">material</span> &amp;&amp; item.<span class="hljs-property">material</span>.<span class="hljs-property">name</span> == <span class="hljs-string">"Stem"</span>) {
      stem = item;
    }
    <span class="hljs-keyword">if</span> (item.<span class="hljs-property">material</span> &amp;&amp; item.<span class="hljs-property">material</span>.<span class="hljs-property">name</span> == <span class="hljs-string">"Petal"</span>) {
      petal = item;
    }
  });

  <span class="hljs-comment">// 加载第二个模型（中间状态）</span>
  gltfLoader.<span class="hljs-title function_">load</span>(<span class="hljs-string">"./model/f2.glb"</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">gltf2</span>) {
    gltf2.<span class="hljs-property">scene</span>.<span class="hljs-title function_">traverse</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (item.<span class="hljs-property">material</span> &amp;&amp; item.<span class="hljs-property">material</span>.<span class="hljs-property">name</span> == <span class="hljs-string">"Stem"</span>) {
        stem1 = item;
        <span class="hljs-comment">// 将第二个模型的几何体作为第一个形态目标添加到基础模型</span>
        stem.<span class="hljs-property">geometry</span>.<span class="hljs-property">morphAttributes</span>.<span class="hljs-property">position</span> = [
          stem1.<span class="hljs-property">geometry</span>.<span class="hljs-property">attributes</span>.<span class="hljs-property">position</span>,
        ];
        stem.<span class="hljs-title function_">updateMorphTargets</span>();
      }
      <span class="hljs-keyword">if</span> (item.<span class="hljs-property">material</span> &amp;&amp; item.<span class="hljs-property">material</span>.<span class="hljs-property">name</span> == <span class="hljs-string">"Petal"</span>) {
        petal1 = item;
        <span class="hljs-comment">// 将第二个模型的几何体作为第一个形态目标添加到基础模型</span>
        petal.<span class="hljs-property">geometry</span>.<span class="hljs-property">morphAttributes</span>.<span class="hljs-property">position</span> = [
          petal1.<span class="hljs-property">geometry</span>.<span class="hljs-property">attributes</span>.<span class="hljs-property">position</span>,
        ];
        petal.<span class="hljs-title function_">updateMorphTargets</span>();
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(petal.<span class="hljs-property">morphTargetInfluences</span>);
      }

      <span class="hljs-comment">// 加载第三个模型（最终状态）</span>
      gltfLoader.<span class="hljs-title function_">load</span>(<span class="hljs-string">"./model/f1.glb"</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">gltf2</span>) {
        gltf2.<span class="hljs-property">scene</span>.<span class="hljs-title function_">traverse</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
          <span class="hljs-keyword">if</span> (item.<span class="hljs-property">material</span> &amp;&amp; item.<span class="hljs-property">material</span>.<span class="hljs-property">name</span> == <span class="hljs-string">"Stem"</span>) {
            stem2 = item;
            <span class="hljs-comment">// 将第三个模型的几何体作为第二个形态目标添加到基础模型</span>
            stem.<span class="hljs-property">geometry</span>.<span class="hljs-property">morphAttributes</span>.<span class="hljs-property">position</span>.<span class="hljs-title function_">push</span>(
              stem2.<span class="hljs-property">geometry</span>.<span class="hljs-property">attributes</span>.<span class="hljs-property">position</span>
            );
            stem.<span class="hljs-title function_">updateMorphTargets</span>();
          }
          <span class="hljs-keyword">if</span> (item.<span class="hljs-property">material</span> &amp;&amp; item.<span class="hljs-property">material</span>.<span class="hljs-property">name</span> == <span class="hljs-string">"Petal"</span>) {
            petal2 = item;
            <span class="hljs-comment">// 将第三个模型的几何体作为第二个形态目标添加到基础模型</span>
            petal.<span class="hljs-property">geometry</span>.<span class="hljs-property">morphAttributes</span>.<span class="hljs-property">position</span>.<span class="hljs-title function_">push</span>(
              petal2.<span class="hljs-property">geometry</span>.<span class="hljs-property">attributes</span>.<span class="hljs-property">position</span>
            );
            petal.<span class="hljs-title function_">updateMorphTargets</span>();
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(petal.<span class="hljs-property">morphTargetInfluences</span>);
          }
        });
      });
    });
  });

  <span class="hljs-comment">// 使用 GSAP 创建变形动画</span>
  gsap.<span class="hljs-title function_">to</span>(params, {
    <span class="hljs-attr">value</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">duration</span>: <span class="hljs-number">4</span>,
    <span class="hljs-attr">onUpdate</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
      <span class="hljs-comment">// 控制第一个形态目标的影响程度</span>
      stem.<span class="hljs-property">morphTargetInfluences</span>[<span class="hljs-number">0</span>] = params.<span class="hljs-property">value</span>;
      petal.<span class="hljs-property">morphTargetInfluences</span>[<span class="hljs-number">0</span>] = params.<span class="hljs-property">value</span>;
    },
    <span class="hljs-attr">onComplete</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
      <span class="hljs-comment">// 在第一个动画完成后，开始第二个变形动画</span>
      gsap.<span class="hljs-title function_">to</span>(params, {
        <span class="hljs-attr">value1</span>: <span class="hljs-number">1</span>,
        <span class="hljs-attr">duration</span>: <span class="hljs-number">4</span>,
        <span class="hljs-attr">onUpdate</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
          <span class="hljs-comment">// 控制第二个形态目标的影响程度</span>
          stem.<span class="hljs-property">morphTargetInfluences</span>[<span class="hljs-number">1</span>] = params.<span class="hljs-property">value1</span>;
          petal.<span class="hljs-property">morphTargetInfluences</span>[<span class="hljs-number">1</span>] = params.<span class="hljs-property">value1</span>;
        },
      });
    },
  });

  scene.<span class="hljs-title function_">add</span>(gltf1.<span class="hljs-property">scene</span>);
});
</code></pre>
<h2 data-id="heading-6">渲染器设置</h2>
<p>配置 WebGL 渲染器：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 初始化渲染器</span>
<span class="hljs-keyword">const</span> renderer = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">WebGLRenderer</span>({
  <span class="hljs-attr">logarithmicDepthBuffer</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">antialias</span>: <span class="hljs-literal">true</span>,
});
<span class="hljs-comment">// 设置渲染的尺寸大小</span>
renderer.<span class="hljs-title function_">setSize</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>);
<span class="hljs-comment">// 开启场景中的阴影贴图</span>
renderer.<span class="hljs-property">shadowMap</span>.<span class="hljs-property">enabled</span> = <span class="hljs-literal">true</span>;
renderer.<span class="hljs-property">physicallyCorrectLights</span> = <span class="hljs-literal">true</span>;
renderer.<span class="hljs-title function_">setClearColor</span>(<span class="hljs-number">0xcccccc</span>, <span class="hljs-number">1</span>);
renderer.<span class="hljs-property">autoClear</span> = <span class="hljs-literal">false</span>;
<span class="hljs-comment">// 设置电影渲染模式</span>
renderer.<span class="hljs-property">toneMapping</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">ACESFilmicToneMapping</span>;
renderer.<span class="hljs-property">outputEncoding</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">sRGBEncoding</span>;
renderer.<span class="hljs-property">sortObjects</span> = <span class="hljs-literal">true</span>;
renderer.<span class="hljs-property">logarithmicDepthBuffer</span> = <span class="hljs-literal">true</span>;

<span class="hljs-comment">// 将webgl渲染的canvas内容添加到body</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(renderer.<span class="hljs-property">domElement</span>);
</code></pre>
<h2 data-id="heading-7">控制器和动画循环</h2>
<p>设置轨道控制器和渲染循环：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建轨道控制器</span>
<span class="hljs-keyword">const</span> controls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrbitControls</span>(camera, renderer.<span class="hljs-property">domElement</span>);
<span class="hljs-comment">// 设置控制器阻尼，让控制器更有真实效果,必须在动画循环里调用.update()。</span>
controls.<span class="hljs-property">enableDamping</span> = <span class="hljs-literal">true</span>;

<span class="hljs-comment">// 添加坐标轴辅助器</span>
<span class="hljs-keyword">const</span> axesHelper = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">AxesHelper</span>(<span class="hljs-number">5</span>);
scene.<span class="hljs-title function_">add</span>(axesHelper);

<span class="hljs-comment">// 设置时钟</span>
<span class="hljs-keyword">const</span> clock = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Clock</span>();
<span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> time = clock.<span class="hljs-title function_">getDelta</span>();
  <span class="hljs-keyword">if</span> (mixer) {
    mixer.<span class="hljs-title function_">update</span>(time);
  }
  controls.<span class="hljs-title function_">update</span>();

  renderer.<span class="hljs-title function_">render</span>(scene, camera);
  <span class="hljs-comment">// 渲染下一帧的时候就会调用render函数</span>
  <span class="hljs-title function_">requestAnimationFrame</span>(render);
}

<span class="hljs-title function_">render</span>();
</code></pre>
<h2 data-id="heading-8">变形动画原理详解</h2>
<p>Morph Targets（形态目标）是一种在计算机图形学中用于实现网格变形的技术。其基本原理是：</p>
<ol>
<li><strong>基础几何体</strong>: 定义一个基础的网格几何体</li>
<li><strong>目标几何体</strong>: 定义一个或多个"目标"几何体，它们与基础几何体有相同的拓扑结构（相同的顶点数量和连接关系），但顶点位置不同</li>
<li><strong>权重控制</strong>: 通过权重值（0到1之间）来控制目标几何体对基础几何体的影响程度</li>
</ol>
<p>在代码中，我们使用 <code>morphTargetInfluences</code> 数组来控制每个形态目标的影响程度：</p>
<ul>
<li>当 <code>morphTargetInfluences[0] = 0</code> 时，模型呈现初始状态</li>
<li>当 <code>morphTargetInfluences[0] = 1</code> 时，模型完全变成第一个目标状态</li>
<li>当 <code>morphTargetInfluences[0] = 0.5</code> 时，模型是初始状态和目标状态的中间形态</li>
</ul>
<h2 data-id="heading-9">应用场景</h2>
<p>变形动画在 3D 应用中有广泛的应用：</p>
<ol>
<li><strong>角色面部表情</strong>: 实现人物的表情变化</li>
<li><strong>物体形态变化</strong>: 如花朵绽放、物体变形等</li>
<li><strong>动画过渡</strong>: 在不同模型状态之间平滑过渡</li>
<li><strong>程序化生成</strong>: 根据参数动态改变模型形状</li>
</ol>
<h2 data-id="heading-10">性能优化建议</h2>
<ol>
<li><strong>合理使用</strong>: Morph Targets 会增加内存消耗，只在必要时使用</li>
<li><strong>减少目标数量</strong>: 尽量减少形态目标的数量以提高性能</li>
<li><strong>压缩模型</strong>: 使用 DRACO 等压缩技术减少模型文件大小</li>
<li><strong>优化动画</strong>: 使用高效的动画库如 GSAP 来控制变形过程</li>
</ol>
<h2 data-id="heading-11">总结</h2>
<p>通过这个项目，我们学习了如何使用 Three.js 的 Morph Targets 技术：</p>
<ol>
<li>如何加载多个具有相同拓扑结构的模型</li>
<li>如何将目标模型的几何体作为形态目标添加到基础模型</li>
<li>如何通过控制权重来实现平滑的变形动画</li>
<li>如何使用 GSAP 等动画库来管理复杂的动画序列</li>
</ol>
<p>变形动画是一个强大而灵活的技术，能够为你的 3D 应用增添生动有趣的视觉效果，特别是在创建有机形态变化（如植物生长、花朵绽放等）方面特别有效。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JS-面试必考：手动实现一个标准的 Ajax 请求（XMLHttpRequest）]]></title>    <link>https://juejin.cn/post/7600234310964936742</link>    <guid>https://juejin.cn/post/7600234310964936742</guid>    <pubDate>2026-01-28T10:15:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600234310964936742" data-draft-id="7600068892988669962" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JS-面试必考：手动实现一个标准的 Ajax 请求（XMLHttpRequest）"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2026-01-28T10:15:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="发现一只大呆瓜"/> <meta itemprop="url" content="https://juejin.cn/user/180747382561607"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JS-面试必考：手动实现一个标准的 Ajax 请求（XMLHttpRequest）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/180747382561607/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    发现一只大呆瓜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T10:15:37.000Z" title="Wed Jan 28 2026 10:15:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>虽然 <code>fetch</code> API 在现代开发中非常流行，但 <strong>XMLHttpRequest (XHR)</strong> 依然是理解 Web 网络编程的基石。无论是底层的 Ajax 封装，还是需要细粒度监控<strong>上传/下载进度</strong>的场景，XHR 依然不可替代。</p>
<h2 data-id="heading-1">一、 什么是 Ajax？</h2>
<p><strong>Ajax（Asynchronous JavaScript And XML）</strong> 并不是一种单一的编程语言，而是一套技术的组合。其核心是在不重新加载整个网页的情况下，通过与服务器进行异步数据交换，实现页面的<strong>局部刷新</strong>。</p>
<ul>
<li><strong>核心优势</strong>：提升用户体验，减少网络带宽占用。</li>
<li><strong>实现基础</strong>：JavaScript 和浏览器原生的 <code>XMLHttpRequest</code> 对象。</li>
</ul>
<hr/>
<h2 data-id="heading-2">二、 XHR 操作的“五步法”逻辑</h2>
<h3 data-id="heading-3">1. 创建对象</h3>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">let</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();
</code></pre>
<h3 data-id="heading-4">2. 注册回调函数 (事件驱动)</h3>
<p>XHR 是基于事件驱动的，我们需要在请求发送前定义好如何处理各种状态。</p>
<ul>
<li><strong><code>onreadystatechange</code></strong>：监控请求的生命周期（状态 0-4）。</li>
<li><strong><code>onerror</code></strong>：处理网络层面的错误（如断网或 DNS 解析失败）。</li>
<li><strong><code>ontimeout</code></strong>：处理响应超时，需配合 <code>xhr.timeout</code> 使用。</li>
<li><strong><code>onprogress</code></strong>：数据传输进度监控。</li>
</ul>
<h3 data-id="heading-5">3. 配置请求参数</h3>
<p>通过 <code>open()</code> 方法初始化请求：</p>
<ul>
<li><strong><code>method</code></strong>：请求方法（GET, POST, PUT 等）。</li>
<li><strong><code>url</code></strong>：请求地址。</li>
<li><strong><code>async</code></strong>：是否异步（默认 <code>true</code>）。<strong>注意：</strong> 设为 <code>false</code> 会阻塞浏览器主线程，导致页面假死。</li>
</ul>
<h3 data-id="heading-6">4. 设置属性与请求头</h3>
<ul>
<li><code>responseType</code>：设置期望的返回格式（如 <code>json</code>, <code>blob</code>）。</li>
<li><code>setRequestHeader()</code>：手动添加自定义请求头（必须在 <code>open</code> 之后，<code>send</code> 之前调用）。</li>
</ul>
<h3 data-id="heading-7">5. 发送请求</h3>
<ul>
<li><code>send(data)</code>：正式发起请求。如果是 GET 请求，传 <code>null</code>；如果是 POST，传具体数据。</li>
</ul>
<hr/>
<h2 data-id="heading-8">三、 详解 readyState：五种状态的演变</h2>
<p><code>readyState</code> 是排查 Ajax 问题的关键，它记录了请求的每一步进展：</p>



































<table><thead><tr><th><strong>取值</strong></th><th><strong>状态名称</strong></th><th><strong>描述</strong></th></tr></thead><tbody><tr><td><strong>0</strong></td><td><strong>UNSENT</strong></td><td>初始化状态，对象已创建，尚未调用 <code>open()</code></td></tr><tr><td><strong>1</strong></td><td><strong>OPENED</strong></td><td>已调用 <code>open()</code>，尚未调用 <code>send()</code>，可设置 Header</td></tr><tr><td><strong>2</strong></td><td><strong>HEADERS_RECEIVED</strong></td><td>已调用 <code>send()</code>，接收到了响应头和状态码</td></tr><tr><td><strong>3</strong></td><td><strong>LOADING</strong></td><td>正在下载响应体，<code>responseText</code> 已包含部分数据</td></tr><tr><td><strong>4</strong></td><td><strong>DONE</strong></td><td><strong>数据接收完成</strong>，请求生命周期结束</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-9">四、 进度监控：如何实现进度条？</h2>
<p>XHR 相比 <code>fetch</code> 的一大优势就是对进度的原生支持。通过 <code>onprogress</code> 事件，我们可以计算出下载百分比：</p>
<ul>
<li><strong><code>lengthComputable</code></strong>：布尔值，表示服务器是否返回了 <code>Content-Length</code>。</li>
<li><strong><code>loaded</code></strong>：已接收的字节数。</li>
<li><strong><code>total</code></strong>：总字节数。</li>
</ul>
<hr/>
<h2 data-id="heading-10">五、 代码实现：封装一个标准的 Ajax 函数</h2>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">/**
 * 基于 XHR 封装的数据获取函数
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} URL 请求地址
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">GetWebData</span>(<span class="hljs-params">URL</span>) {
  <span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();

  <span class="hljs-comment">// 1. 状态监控：只在 DONE 阶段处理逻辑</span>
  xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">readyState</span> === <span class="hljs-number">4</span>) { 
      <span class="hljs-comment">// 兼容性判断：2xx 范围和 304 缓存均认为成功</span>
      <span class="hljs-keyword">if</span> ((xhr.<span class="hljs-property">status</span> &gt;= <span class="hljs-number">200</span> &amp;&amp; xhr.<span class="hljs-property">status</span> &lt; <span class="hljs-number">300</span>) || xhr.<span class="hljs-property">status</span> === <span class="hljs-number">304</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"请求成功:"</span>, xhr.<span class="hljs-property">response</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"请求失败, 状态码:"</span>, xhr.<span class="hljs-property">status</span>);
      }
    }
  };

  <span class="hljs-comment">// 2. 进度监控</span>
  xhr.<span class="hljs-property">onprogress</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) {
    <span class="hljs-keyword">if</span> (event.<span class="hljs-property">lengthComputable</span>) {
      <span class="hljs-keyword">let</span> percent = (event.<span class="hljs-property">loaded</span> / event.<span class="hljs-property">total</span>) * <span class="hljs-number">100</span>;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`下载进度: <span class="hljs-subst">${percent.toFixed(<span class="hljs-number">2</span>)}</span>%`</span>);
    }
  };

  <span class="hljs-comment">// 3. 异常与超时处理</span>
  xhr.<span class="hljs-property">timeout</span> = <span class="hljs-number">5000</span>; 
  xhr.<span class="hljs-property">ontimeout</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"请求超时！"</span>);
  xhr.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"网络异常或跨域错误"</span>);

  <span class="hljs-comment">// 4. 配置与发送</span>
  xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">"GET"</span>, <span class="hljs-variable constant_">URL</span>, <span class="hljs-literal">true</span>);
  xhr.<span class="hljs-property">responseType</span> = <span class="hljs-string">"json"</span>; <span class="hljs-comment">// 自动解析 JSON</span>
  xhr.<span class="hljs-title function_">setRequestHeader</span>(<span class="hljs-string">"X-Requested-With"</span>, <span class="hljs-string">"XMLHttpRequest"</span>);

  xhr.<span class="hljs-title function_">send</span>(<span class="hljs-literal">null</span>);
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vue3自定义指令合集-单例v-tooltip]]></title>    <link>https://juejin.cn/post/7600224355294085147</link>    <guid>https://juejin.cn/post/7600224355294085147</guid>    <pubDate>2026-01-28T10:17:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600224355294085147" data-draft-id="7486444624815915045" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vue3自定义指令合集-单例v-tooltip"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-28T10:17:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="fubobo"/> <meta itemprop="url" content="https://juejin.cn/user/3518911078999470"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vue3自定义指令合集-单例v-tooltip
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3518911078999470/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    fubobo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T10:17:37.000Z" title="Wed Jan 28 2026 10:17:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>在实际项目中，Tooltip 往往会遇到这些问题：</p>
<ul>
<li>大多数使用组件形式实现（有时候项目中对于tooltip没有过多要求，使用UI组件的话，需要包一层组件，有点臃肿）</li>
<li>每个元素一个 Tooltip，实例过多，性能差</li>
<li>页面滚动 / 容器滚动后，Tooltip 位置不更新</li>
<li>Tooltip 抖动、闪烁、频繁销毁重建</li>
<li>指令解绑不彻底，事件和监听器泄漏</li>
</ul>
<h3 data-id="heading-1">目标</h3>
<ul>
<li>全局只创建 <strong>一个 Tooltip 实例</strong></li>
<li>使用指令 <code>v-tooltip</code> 即插即用</li>
<li>支持 <code>top / right / bottom / left</code></li>
<li>自动跟随目标元素位置变化</li>
<li>无闪烁、无内存泄漏</li>
<li>TypeScript 类型安全</li>
</ul>
<p>造个轮子，代码放在仓库了，各位大佬自取：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2FGitfubobo%2Fvue-directives-kit" target="_blank" title="https://gitee.com/Gitfubobo/vue-directives-kit" ref="nofollow noopener noreferrer">gitee.com/Gitfubobo/v…</a></p>
<hr/>
<h2 data-id="heading-2">使用方式</h2>
<pre><code class="hljs language-ini" lang="ini">&lt;button <span class="hljs-attr">v-tooltip</span>=<span class="hljs-string">"'删除后无法恢复'"</span>&gt;删除&lt;/button&gt;
&lt;button <span class="hljs-attr">v-tooltip.right</span>=<span class="hljs-string">"'更多操作'"</span>&gt;操作&lt;/button&gt;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4390516703954053aa41cdded74a5bd2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZnVib2Jv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770200257&amp;x-signature=DlV0L1k85tVu8%2FvIVj6QoFJugGU%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-3">整体设计思路</h2>
<blockquote>
<p><strong>Tooltip 用单例统一管理，指令只负责绑定 DOM，这里的单例是指DOM单例，页面上只存在一个DOM</strong></p>
</blockquote>
<h3 data-id="heading-4">核心拆分</h3>
<ul>
<li>
<p><strong>TooltipSingleton</strong></p>
<ul>
<li>负责 Tooltip 的创建、更新、销毁</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-ts" lang="ts">  <span class="hljs-keyword">import</span> tooltipV <span class="hljs-keyword">from</span> <span class="hljs-string">'./tooltip.vue'</span>;
  
  
  <span class="hljs-comment">/**
     * <span class="hljs-doctag">@Author</span>: fubobo
     * <span class="hljs-doctag">@Description</span>: 单例
     * <span class="hljs-doctag">@return</span> {<span class="hljs-type">TooltipSingleton</span>}
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">getInstance</span>(): <span class="hljs-title class_">TooltipSingleton</span> {
        <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">TooltipSingleton</span>.<span class="hljs-property">instance</span>) {
            <span class="hljs-title class_">TooltipSingleton</span>.<span class="hljs-property">instance</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TooltipSingleton</span>();
        }
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">TooltipSingleton</span>.<span class="hljs-property">instance</span>;
    }

    <span class="hljs-comment">// 创建dom挂载tooltip组件</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">createInstance</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">tooltipInstance</span>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootEl</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
            <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">rootEl</span>);
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span> = <span class="hljs-title function_">createApp</span>(tooltipV);
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">tooltipInstance</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-title function_">mount</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">rootEl</span>);
        }
    }
</code></pre>
<ul>
<li>
<p><strong>v-tooltip 指令</strong></p>
<ul>
<li>负责 DOM 事件绑定与生命周期</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"> <span class="hljs-comment">// 指令对象</span>
 <span class="hljs-keyword">const</span> <span class="hljs-attr">tooltipDirective</span>: <span class="hljs-title class_">Directive</span>&lt;<span class="hljs-title class_">HTMLElement</span>, <span class="hljs-built_in">string</span>&gt; = {
    <span class="hljs-title function_">mounted</span>(<span class="hljs-params">el, binding</span>) {
        <span class="hljs-title class_">TooltipSingleton</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">mount</span>(el, binding);
    },
    <span class="hljs-title function_">updated</span>(<span class="hljs-params">el, binding</span>) {
        <span class="hljs-title class_">TooltipSingleton</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">updated</span>(el, binding);
    },
    <span class="hljs-title function_">unmounted</span>(<span class="hljs-params">el</span>) {
        <span class="hljs-title class_">TooltipSingleton</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">unmount</span>(el);
    },
};
</code></pre>
<ul>
<li>
<p><strong>位置监听工具</strong></p>
<ul>
<li>负责监听滚动 / resize / DOM 变化</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-ts" lang="ts">  <span class="hljs-comment">/**
     * <span class="hljs-doctag">@Author</span>: fubobo
     * <span class="hljs-doctag">@Description</span>: 根据目标元素和tooltip进行位置计算
     * <span class="hljs-doctag">@return</span> 坐标
     * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLElement</span>} <span class="hljs-variable">targetEl</span>
     * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Placement</span>} <span class="hljs-variable">placement</span>
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">calculatePosition</span>(<span class="hljs-params">targetEl: HTMLElement, placement: Placement</span>) {
        ....
        <span class="hljs-keyword">return</span> { x, y };
    }

<span class="hljs-comment">/**
 * 监听元素距离窗口顶部的距离变化
 * <span class="hljs-doctag">@param</span> element 目标元素
 * <span class="hljs-doctag">@param</span> callback 距离变化回调
 * <span class="hljs-doctag">@param</span> options 配置项
 * <span class="hljs-doctag">@returns</span> 停止监听的函数
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">observeElementViewportTop</span> = (<span class="hljs-params">
    element: HTMLElement,
    callback: PositionCallback,
    options?: {
        throttle?: <span class="hljs-built_in">number</span>; // 节流时间（默认 100ms）
        observeAncestors?: <span class="hljs-built_in">boolean</span>; // 是否监听祖先元素尺寸变化
    }
</span>) =&gt; {
    ....
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'scroll'</span>, handleWindowEvent);
        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'resize'</span>, handleWindowEvent);
        mutationObserver.<span class="hljs-title function_">disconnect</span>();
        resizeObserver.<span class="hljs-title function_">disconnect</span>();
    };
};
</code></pre>
<hr/>
<h2 data-id="heading-5">为什么一定要用「单例 Tooltip」</h2>
<p>如果每个 <code>v-tooltip</code> 都创建一个组件：</p>
<ul>
<li>DOM 数量指数级增长</li>
<li>每个 Tooltip 都监听 scroll / resize</li>
<li>事件难以统一管理</li>
</ul>
<h3 data-id="heading-6">带来的好处</h3>
<ul>
<li>整个应用 <strong>只存在一个 Tooltip</strong></li>
<li>hover 不同元素 → 只是更新内容和位置</li>
<li>性能稳定、结构清晰</li>
</ul>
<hr/>
<h2 data-id="heading-7">Tooltip 实例的创建与销毁</h2>
<h3 data-id="heading-8">创建（只会执行一次）</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> createInstance() {
  <span class="hljs-keyword">this</span>.rootEl = document.createElement(<span class="hljs-string">'div'</span>);
  document.body.appendChild(<span class="hljs-keyword">this</span>.rootEl);
  <span class="hljs-keyword">this</span>.app = createApp(tooltipV);
  <span class="hljs-keyword">this</span>.tooltipInstance = <span class="hljs-keyword">this</span>.app.mount(<span class="hljs-keyword">this</span>.rootEl);
}
</code></pre>
<h3 data-id="heading-9">销毁（最后一个指令卸载时）</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-title function_">destroyInstance</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-title function_">unmount</span>();
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">removeChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">rootEl</span>);
}
</code></pre>
<h2 data-id="heading-10">Tooltip 定位计算逻辑</h2>
<p>核心思路：</p>
<blockquote>
<p><strong>使用目标元素位置 + Tooltip 自身尺寸计算最终坐标</strong></p>
</blockquote>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">tooltipRect</span> = tooltip.getBoundingClientRect()<span class="hljs-comment">;</span>
const <span class="hljs-attr">targetRect</span> = target.getBoundingClientRect()<span class="hljs-comment">;</span>
</code></pre>

<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">switch</span> (placement) {
  <span class="hljs-keyword">case</span> <span class="hljs-string">'top'</span>:
    x = targetRect.x + targetRect.width / <span class="hljs-number">2</span> - tooltipRect.width / <span class="hljs-number">2</span>;
    y = targetRect.y - tooltipRect.height - <span class="hljs-number">10</span>;
}
</code></pre>
<h2 data-id="heading-11">监听「元素位置变化」</h2>
<p>仅靠 <code>mouseenter</code> 是完全不够的：</p>
<ul>
<li>页面滚动</li>
<li>容器滚动</li>
<li>DOM transform</li>
<li>父级尺寸变化</li>
</ul>
<h3 data-id="heading-12">解决方案：多维度监听</h3>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title function_ invoke__">observeElementViewportTop</span>(el, callback, {
  <span class="hljs-attr">observeAncestors</span>: <span class="hljs-literal">true</span>,
});
</code></pre>
<p>监听来源包括：</p>





















<table><thead><tr><th>监听方式</th><th>解决问题</th></tr></thead><tbody><tr><td>scroll / resize</td><td>页面和窗口变化</td></tr><tr><td>MutationObserver</td><td>class / style 改变</td></tr><tr><td>ResizeObserver</td><td>元素或父级尺寸变化</td></tr></tbody></table>
<p>📌 Tooltip 始终贴着目标元素，不会错位</p>
<h3 data-id="heading-13">关键点</h3>
<ul>
<li>Tooltip 自身维护 hover 状态</li>
<li>延迟隐藏（100ms）</li>
<li>体验更自然</li>
</ul>
<h3 data-id="heading-14">使用 WeakMap 优化性能</h3>
<ul>
<li>不阻止 GC</li>
<li>DOM 销毁后自动释放</li>
<li>从根源避免内存泄漏</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TooltipSingleton</span> {
    ...
    <span class="hljs-keyword">private</span> eventHandlers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>&lt;
        <span class="hljs-title class_">HTMLElement</span>,
        {
            <span class="hljs-attr">enter</span>: <span class="hljs-title class_">EventListener</span>;
            <span class="hljs-attr">leave</span>: <span class="hljs-title class_">EventListener</span>;
        }
    &gt;(); <span class="hljs-comment">// 存储元素的事件处理器（弱引用防止内存泄漏）</span>
    <span class="hljs-keyword">private</span> directiveInfo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>&lt;
        <span class="hljs-title class_">HTMLElement</span>,
        {
            <span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span>;
            <span class="hljs-attr">placement</span>: <span class="hljs-title class_">Placement</span>;
        }
    &gt;(); <span class="hljs-comment">// 存储元素关联的指令信息（弱引用）</span>
}
</code></pre>
<h2 data-id="heading-15">解决了哪些问题</h2>





































<table><thead><tr><th>问题</th><th>是否解决</th></tr></thead><tbody><tr><td>Tooltip 重复创建</td><td>✅</td></tr><tr><td>滚动后位置错乱</td><td>✅</td></tr><tr><td>hover 闪烁</td><td>✅</td></tr><tr><td>内存泄漏</td><td>✅</td></tr><tr><td>TypeScript 类型不安全</td><td>✅</td></tr><tr><td>指令更新无效</td><td>✅</td></tr><tr><td>支持DOM传值</td><td>✅</td></tr></tbody></table>
<h2 data-id="heading-16">代码仓库</h2>
<p>框框造个轮子，代码放在仓库了，各位大佬自取：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2FGitfubobo%2Fvue-directives-kit" target="_blank" title="https://gitee.com/Gitfubobo/vue-directives-kit" ref="nofollow noopener noreferrer">gitee.com/Gitfubobo/v…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[构建开放智能体生态：AgentScope 如何用 A2A 协议与 Nacos 打通协作壁垒？]]></title>    <link>https://juejin.cn/post/7600032104248934463</link>    <guid>https://juejin.cn/post/7600032104248934463</guid>    <pubDate>2026-01-28T10:25:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600032104248934463" data-draft-id="7600032104248819775" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="构建开放智能体生态：AgentScope 如何用 A2A 协议与 Nacos 打通协作壁垒？"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2026-01-28T10:25:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            构建开放智能体生态：AgentScope 如何用 A2A 协议与 Nacos 打通协作壁垒？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T10:25:43.000Z" title="Wed Jan 28 2026 10:25:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：恰橙、席翁、濯光</p>
<blockquote>
<p>AgentScope 基于 A2A 协议与 Nacos Agent Registry，实现智能体的统一发现、治理与跨生态协作。</p>
</blockquote>
<p>随着企业逐步落地 AI 应用架构，从原来测试 POC workflow/简单 Agent 开始逐步构建生产级可用 Agent，真正解决线上问题，构建 Agent 在企业是面相全员提升效率的路径，不再是简单业务流程面临问题更加复杂，可能企业就会遇到如下挑战：</p>
<ul>
<li><strong>语言栈多样化</strong>：企业内核心业务团队可能是 Java/Golang，算法团队使用 Python，面临 Agent 架构选型多语言栈怎么做无缝协作？</li>
<li><strong>Agent 框架割裂</strong>：LangChain、AutoGPT、AgentScope 等不同框架以及 Agent 各自为政，如何实现跨框架调用？</li>
<li><strong>多团队Agent协同</strong>：Agent 如果有一个团队做，不懂业务做不深，Agent 分布在不同的服务、团队、项目中，内部选型会有 Dify、n8n 低代码和高代码平台选型，如何统一发现和管理？</li>
<li><strong>协议不统一</strong>：REST、gRPC、自定义协议...每个 Agent 都有自己的接口规范，集成成本高、维护困难。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/376420a5e7234943a8b420a4c5ebc5a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770200743&amp;x-signature=EtB756VezetQw0R%2FDPjke0NiyIY%3D" alt="图片" loading="lazy"/></p>
<p><strong>A2A（Agent-to-Agent）协议正是为解决这些问题而生。</strong> 它是 Google 提出一套面向分布式多 Agent 互联互通的开放标准，定义了统一的消息结构和能力描述，让不同语言、不同框架、不同运行时上的 Agent 都能被发现、被调用、被编排。基于 A2A，Agent 之间可以在不共享代码、不耦合底层实现的前提下，完成文本对话、thinking、多模态内容、工具调用等丰富交互，真正实现“一次定义，处处可用”。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5d6ffbdf9d84fc4ad46cff42863637b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770200743&amp;x-signature=0eSFVMxugMlNgcY20hEK%2BzJcBcs%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-0">Agent 跨语言、跨框架调用最佳实践</h2>
<p><strong>AgentScope</strong> 是阿里巴巴推出的一款以开发者为核心，专注于<strong>多智能体开发的开源框架</strong>。它的核心目标是解决智能体在构建、运行和管理中的难题，提供一套覆盖“开发、部署、监控”全生命周期的生产级解决方案。</p>
<p>在 <strong>AgentScope</strong> 最新版本中，我们<strong>全面支持 A2A 协议，并集成 Nacos 作为 A2A Registry 的默认实现</strong>，构建了一套从开发到部署的完整分布式多智能体协作体系，让智能体协作从“单打独斗”走向“开放互联”。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/657e92a0770a4995a8740d46b5d23798~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770200743&amp;x-signature=MbLAkSX5FeYd0o6CYydVBoSb0oY%3D" alt="图片" loading="lazy"/></p>
<ul>
<li><strong>告别“Agent 孤岛”</strong>：通过 A2A 协议，AgentScope 的 Agent 可以与任何实现 A2A 的 Agent 无缝互操作，不论由谁开发、用何种技术栈构建，都能在统一的协作框架下高效协同，打破技术壁垒，共同构建跨语言、跨框架的开放生态。</li>
<li><strong>统一开发体验，告别适配烦恼</strong>：在 AgentScope 中，调用本地 Agent 和调用远端 A2A Agent 使用同一套 API。框架自动处理协议转换、错误重试和路由选择，我们可以专注业务，不必为适配不同 Agent 编写冗余代码，从而提升效率与可维护性。</li>
<li><strong>生产级治理，开箱即用</strong>：基于 Nacos 3.0 智能体注册中心，AgentScope 应用具备服务发现、健康检查、命名空间隔离等成熟能力。选择 Nacos 作为默认 A2A Registry，不仅因为它经过大规模生产验证，也因为它与企业现有运维体系兼容，让智能体治理无需重复造轮子，加速规模化落地。</li>
</ul>
<h2 data-id="heading-1">在 AgentScope 中使用 A2A</h2>
<h3 data-id="heading-2">1. AgentScope：连接外部 A2A 网络，像调用本地 Agent 一样简单</h3>
<p>AgentScope 提供统一的 A2A 对接能力，我们可以像调用本地工具一样自然地调用远端 A2A Agent，实现跨语言、跨框架的协同，告别繁琐的协议适配工作：</p>
<ul>
<li><strong>双向消息转换：</strong> 实现框架内部消息格式与 A2A <code>Message</code> 的双向转换，支持文本、thinking、多模态、工具调用等 Block 类型，保留必要元信息，确保语义一致。</li>
<li><strong>统一交互范式：</strong> 支持直接调用和 <code>observe()</code> 两种方式。直接调用 <code>agent(msg)</code> 可立即拿到结果；<code>observe()</code> 先累积上下文，后续再连同当前输入一起发送，适合长会话、多轮协作场景。</li>
<li><strong>任务与中断管理：</strong> 内建长任务状态管理与 Artifact 处理机制，支持长时间任务的平滑中断，覆盖超时与取消场景。</li>
<li><strong>统一的服务发现能力：</strong> 通过 <code>AgentCardResolver</code> 扩展点标准化“发现”能力，任何实现该接口的组件，例如：<code>FixedAgentCardResolver</code>、<code>FileAgentCardResolver</code>、<code>WellKnownAgentCardResolver</code>、<code>NacosAgentCardResolver</code> 等都可按需加载，轻松适配不同基础设施。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35d8e0d47b294113bc3d963862ae4d8d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770200743&amp;x-signature=bNZ2KwwXE0rwaadMaQ%2FHrtShx%2Fg%3D" alt="图片" loading="lazy"/></p>
<p>通过 <code>A2AAgent</code> 以及 <code>AgentCardResolver</code>，我们可以按名称、分组或标签从 A2A Registry 中发现并调用其他 Agent，实现跨团队、跨项目甚至跨语言的智能体复用。基于 A2A Registry，智能体拥有统一的服务发现与治理能力，可与现有配置中心、网关、熔断限流及安全体系协同，为大规模分布式智能体应用打好底座。</p>
<p>以下示例展示如何使用 <code>NacosAgentCardResolver</code> 从 Nacos Registry 中发现并调用 Agent：</p>
<p><em>注意在对应版本以上使用 demo，</em> <em><strong>Python</strong></em> <em>（AgentScope</em> <em><strong>v1.0.11</strong></em> <em>、AgentScope Runtime</em> <em><strong>v1.0.4</strong></em> *）和 * <em><strong>Java</strong></em> <em>（AgentScope</em> <em><strong>v1.0.6</strong></em> <em>，AgentScope Runtime</em> <em><strong>v1.0.0</strong></em> <em>）</em></p>
<h4 data-id="heading-3">Python 代码示例</h4>
<p><strong>查看详细文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.agentscope.io%2Fzh_CN%2Ftutorial%2Ftask_a2a.html" target="_blank" title="https://doc.agentscope.io/zh_CN/tutorial/task_a2a.html" ref="nofollow noopener noreferrer">doc.agentscope.io/zh_CN/tutor…</a></strong></p>
<pre><code class="hljs language-ini" lang="ini">from agentscope.agent import A2AAgent
from agentscope.a2a import NacosAgentCardResolver
from agentscope.message import Msg
<span class="hljs-comment"># Python AgentScope v1.0.11以上</span>
<span class="hljs-comment"># 创建 Nacos AgentCard Resolver</span>
<span class="hljs-attr">nacos_resolver</span> = NacosAgentCardResolver(
    <span class="hljs-attr">remote_agent_name</span>=<span class="hljs-string">"my-remote-agent"</span>,  <span class="hljs-comment"># Nacos 中注册的智能体名称</span>
    <span class="hljs-attr">nacos_client_config</span>=ClientConfig(
        <span class="hljs-attr">server_addresses</span>=<span class="hljs-string">"http://localhost:8848"</span>,  <span class="hljs-comment"># Nacos 服务器地址</span>
        <span class="hljs-comment"># 其他可选配置项</span>
    ),
)
<span class="hljs-comment"># 使用 Resolver 创建 A2AAgent，通过名称从 Nacos 发现 Agent</span>
<span class="hljs-attr">agent</span> = A2AAgent(
    <span class="hljs-attr">agent_card</span>=await nacos_resolver.get_agent_card()
)
</code></pre>
<h4 data-id="heading-4">Java 代码示例</h4>
<p><strong>查看详细文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjava.agentscope.io%2Fzh%2Ftask%2Fa2a.html" target="_blank" title="https://java.agentscope.io/zh/task/a2a.html" ref="nofollow noopener noreferrer">java.agentscope.io/zh/task/a2a…</a></strong></p>
<p>使用 <code>NacosAgentCardResolver</code> 从 Nacos Registry 中发现 Agent：</p>
<pre><code class="hljs language-ini" lang="ini">import io.agentscope.agent.A2AAgent<span class="hljs-comment">;</span>
import io.agentscope.extensions.a2a.nacos.NacosAgentCardResolver<span class="hljs-comment">;</span>
import java.util.Properties<span class="hljs-comment">;</span>
import com.alibaba.nacos.api.PropertyKeyConst<span class="hljs-comment">;</span>
import com.alibaba.nacos.api.ai.AiFactory<span class="hljs-comment">;</span>
import com.alibaba.nacos.api.ai.AiService<span class="hljs-comment">;</span>
Properties <span class="hljs-attr">properties</span> = new Properties()<span class="hljs-comment">;</span>
properties.put(PropertyKeyConst.SERVER_ADDR, "localhost:8848")<span class="hljs-comment">;</span>
// 其他可选配置项
AiService <span class="hljs-attr">aiService</span> = AiFactory.createAiService(properties)<span class="hljs-comment">;</span>
NacosAgentCardResolver <span class="hljs-attr">agentCardResolver</span> = new NacosAgentCardResolver(aiService)<span class="hljs-comment">;</span>
A2AAgent <span class="hljs-attr">agent</span> = A2AAgent.builder()
        .name("MyAgent")
        .agentCardResolver(agentCardResolver)
        .build()<span class="hljs-comment">;</span>
</code></pre>
<p>Nacos 3.0 作为智能体注册中心，其在生产环境中久经验证的服务发现与配置管理能力，能够助力企业构建统一的智能体服务治理平台。</p>
<h3 data-id="heading-5">2. AgentScope Runtime：暴露 A2A Agent 服务，启动即注册</h3>
<p>AgentScope Runtime 提供统一的 A2A 服务暴露能力，帮助我们把本地 Agent 应用包装成符合 A2A 规范的服务端点。通过 A2A 协议适配器，应用在启动时会自动完成：</p>
<ul>
<li><strong>结构化配置体系</strong>：通过 A2A 扩展配置 <code>a2a_config</code> 灵活定义 AgentCard（name、description、version、skills、default_input_modes/default_output_modes 等）、传输层配置（host、port、path 等）、Registry 参数和任务超时等。</li>
<li><strong>自动服务包装</strong>：启动时由 A2A 协议适配器将 Agent 应用封装成符合 A2A 规范的服务端点，自动处理协议转换、消息路由等底层细节。</li>
<li><strong>生产级部署支持</strong>：与主流框架无缝集成，Python 侧支持 <code>AgentApp</code> 配置体系，Java 侧支持 <code>Spring Boot Starter</code>，让智能体服务自然融入现有基础设施。</li>
<li><strong>自动服务注册与治理</strong>：通过 <code>A2ARegistry</code> 抽象接口，Python 与 Java 都能开箱即用地集成 Nacos Agent Registry。Agent 能力描述（AgentCard）和网络端点会自动注册到 Registry，让其他 Agent 可发现、可调用。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55dd73181c2940148036fccb9ad74158~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770200743&amp;x-signature=42WC7sFaCCxRJDKPaI72ZBYy6qE%3D" alt="图片" loading="lazy"/></p>
<p>以下示例展示如何在 Runtime 层使用 Nacos Registry 进行服务注册：</p>
<h4 data-id="heading-6">Python 代码示例</h4>
<p><strong>查看详细文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fruntime.agentscope.io%2Fzh%2Fa2a_registry.html" target="_blank" title="https://runtime.agentscope.io/zh/a2a_registry.html" ref="nofollow noopener noreferrer">runtime.agentscope.io/zh/a2a_regi…</a></strong></p>
<p><strong>方式一：参数配置</strong></p>
<p>在构造 AgentApp 时，通过 A2A 配置扩展字段 a2a_config 参数的 registry 字段指定 Registry 实例或列表：</p>
<pre><code class="hljs language-ini" lang="ini">from agentscope_runtime.engine.app import AgentApp
from agentscope_runtime.engine.deployers.adapter.a2a import (
    AgentCardWithRuntimeConfig,
)
from agentscope_runtime.engine.deployers.adapter.a2a.nacos_a2a_registry import (
    NacosRegistry,
)
from v2.nacos import ClientConfigBuilder
<span class="hljs-comment"># 创建 Nacos Registry 实例</span>
<span class="hljs-attr">registry</span> = NacosRegistry(
    <span class="hljs-attr">nacos_client_config</span>=ClientConfigBuilder()
        .server_address("nacos-server:8848")
        <span class="hljs-comment"># 其他可选配置项</span>
        .build()
)
<span class="hljs-attr">app</span> = AgentApp(
    <span class="hljs-attr">app_name</span>=<span class="hljs-string">"TestAgent"</span>,
    <span class="hljs-attr">app_description</span>=<span class="hljs-string">"TestAgent"</span>,
    <span class="hljs-comment"># 在 a2a_config 中配置 registry</span>
    <span class="hljs-attr">a2a_config</span>=AgentCardWithRuntimeConfig(registry=registry),
)
</code></pre>
<p><strong>方式二：使用环境变量配置</strong></p>
<p>环境变量可以通过 .env 文件或系统环境变量设置：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># .env 文件示例</span>
<span class="hljs-attr">A2A_REGISTRY_ENABLED</span>=<span class="hljs-literal">true</span>
<span class="hljs-attr">A2A_REGISTRY_TYPE</span>=nacos
<span class="hljs-attr">NACOS_SERVER_ADDR</span>=localhost:<span class="hljs-number">8848</span>
<span class="hljs-comment"># 其他可选配置项</span>
</code></pre>
<h4 data-id="heading-7">Java 代码示例</h4>
<p><strong>查看详细文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjava.agentscope.io%2Fzh%2Ftask%2Fa2a.html" target="_blank" title="https://java.agentscope.io/zh/task/a2a.html" ref="nofollow noopener noreferrer">java.agentscope.io/zh/task/a2a…</a></strong></p>
<p>在最新版本的 Java AgentScope 中，应用可以直接暴露 A2A 服务，只有在需要使用 Sandbox 时，才需要使用 Runtime。</p>
<p>对于非最新版本，Java 开发者可以将 AgentScope Agent 无缝融入现有的 Spring Boot 基础设施体系。通过引入 <code>spring-boot-starter-agentscope-runtime-a2a-nacos</code> 依赖，应用在启动时会自动暴露 A2A 服务并注册到 Nacos Registry。</p>
<p><strong>Maven 依赖配置</strong>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.agentscope<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-agentscope-runtime-a2a-nacos<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><strong>application.yaml 配置</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">agentscope:</span>
  <span class="hljs-attr">a2a:</span>
    <span class="hljs-attr">server:</span>
      <span class="hljs-attr">card:</span>
        <span class="hljs-string">description:</span> <span class="hljs-string">"基于 A2A 协议的 Java 智能体"</span>
        <span class="hljs-attr">provider:</span>
          <span class="hljs-attr">organization:</span> <span class="hljs-string">您的组织名称</span>
          <span class="hljs-attr">url:</span> <span class="hljs-string">https://your-organization.com</span>
      <span class="hljs-attr">nacos:</span>
        <span class="hljs-string">server-addr:</span> <span class="hljs-string">${NACOS_SERVER_ADDRESS:127.0.0.1:8848}</span>
        <span class="hljs-comment"># 其他可选配置项</span>
</code></pre>
<p>通过上述配置，Spring Boot 应用在启动时会自动：</p>
<ul>
<li>暴露符合 A2A 规范的 JSONRPC 服务端点（默认路径：<code>/a2a/jsonrpc</code>）。</li>
<li>暴露 AgentCard 的 Well-Known 端点（默认路径：<code>/.well-known/agent-card.json</code>），用于其他 Agent 发现和了解当前 Agent 的能力。</li>
<li>自动处理 A2A 协议的消息转换和路由，将 A2A 消息格式转换为应用内部的消息处理逻辑。</li>
<li>支持任务超时、中断等 A2A 协议规定的运行时特性。</li>
<li>将 Agent 的能力描述（AgentCard）注册到 Nacos，基于 Nacos 3.0 智能体注册中心进行统一治理。</li>
</ul>
<p>得益于这一机制，AgentScope 应用启动即完成在 Nacos 的 A2A Agent 注册，为后续的发现、路由、灰度与监控奠定基础。对于已经大规模采用 Java 技术栈的团队，这意味着智能体服务能自然长在同一套基础设施上，大幅降低引入成本与运维负担。</p>
<h2 data-id="heading-8">总结</h2>
<p><strong>AgentScope 全面支持 A2A 协议和 Nacos Agent Registry</strong>，标志着智能体从“单点能力”迈向“开放互联生态”的关键一步，为企业构建统一的智能体管理平台，助力大规模 Agent 化落地：</p>
<ul>
<li><strong>AgentScope 层：借助</strong> A2AAgent 与 AgentCardResolver，我们提供统一的 A2A 对接能力和灵活的发现策略，默认集成 Nacos，支持动态 Agent 发现与调用。</li>
<li><strong>AgentScope Runtime 层：通过 A2A 协议适配器和</strong> A2ARegistry 抽象接口，提供统一的 A2A 服务暴露能力，支持自动服务注册与治理，与 Python AgentApp 和 Java Spring Boot Starter 无缝集成。</li>
</ul>
<p>未来，我们会继续围绕 A2A 与 Registry 深耕，在发现与路由、版本与灰度、安全与访问控制等方向迭代，让面向生产的智能体应用更稳、更易用。</p>
<p><strong>扩展链接</strong>：</p>
<p>AgentScope：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.agentscope.io%2F" target="_blank" title="https://doc.agentscope.io/" ref="nofollow noopener noreferrer">doc.agentscope.io/</a></p>
<p>AgentScope Python A2A 文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.agentscope.io%2Ftutorial%2Ftask_a2a.htmlAgentScope" target="_blank" title="https://doc.agentscope.io/tutorial/task_a2a.htmlAgentScope" ref="nofollow noopener noreferrer">doc.agentscope.io/tutorial/ta…</a></p>
<p>Java：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjava.agentscope.io%2FAgentScope" target="_blank" title="https://java.agentscope.io/AgentScope" ref="nofollow noopener noreferrer">java.agentscope.io/AgentScope</a></p>
<p>Java A2A 文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjava.agentscope.io%2Fen%2Ftask%2Fa2a.html" target="_blank" title="https://java.agentscope.io/en/task/a2a.html" ref="nofollow noopener noreferrer">java.agentscope.io/en/task/a2a…</a></p>
<p>Nacos：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnacos.io%2Fdocs%2Flatest%2Fmanual%2Fuser%2Fai%2Fagent-registry" target="_blank" title="https://nacos.io/docs/latest/manual/user/ai/agent-registry" ref="nofollow noopener noreferrer">nacos.io/docs/latest…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[mri@1.2.0源码阅读]]></title>    <link>https://juejin.cn/post/7600234310965002278</link>    <guid>https://juejin.cn/post/7600234310965002278</guid>    <pubDate>2026-01-28T10:23:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600234310965002278" data-draft-id="7599496293174345747" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="mri@1.2.0源码阅读"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-28T10:23:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="米丘"/> <meta itemprop="url" content="https://juejin.cn/user/1611227736052074"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            mri@1.2.0源码阅读
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1611227736052074/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    米丘
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T10:23:50.000Z" title="Wed Jan 28 2026 10:23:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>mri</code>（全称 Minimalist CLI Argument Parser）的核心作用是<strong>解析命令行传入的参数</strong>，把用户在终端输入的命令行参数（比如 <code>--port 3000</code>、<code>-v</code>）转换成易于在代码中使用的 JavaScript 对象。</p>
<h2 data-id="heading-0">有什么特点？</h2>
<ol>
<li><strong>超轻量</strong>：体积只有几百 KB，无依赖，适合对包体积敏感的 Node.js/ 前端工具开发；</li>
<li><strong>易用性</strong>：API 极简，几行代码就能完成参数解析；</li>
<li><strong>常用场景</strong>：前端工程化工具（如自定义构建脚本、本地开发服务器、CLI 工具）中解析命令行参数。</li>
</ol>
<h2 data-id="heading-1">index文件</h2>
<p><code>mri-1.2.0/src/index.js</code></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">args, opts</span>) {
  args = args || []; <span class="hljs-comment">// 命令行参数数组（比如 process.argv.slice(2)）</span>
  opts = opts || {}; <span class="hljs-comment">// 解析配置（别名、默认值、类型等）</span>

  <span class="hljs-keyword">var</span> k, arr, arg, name, val, out={ <span class="hljs-attr">_</span>:[] }; <span class="hljs-comment">// out 解析结果对象</span>
  <span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>, j=<span class="hljs-number">0</span>, idx=<span class="hljs-number">0</span>, len=args.<span class="hljs-property">length</span>;

  <span class="hljs-comment">// 标记是否配置了别名、严格模式、默认值</span>
  <span class="hljs-keyword">const</span> alibi = opts.<span class="hljs-property">alias</span> !== <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> strict = opts.<span class="hljs-property">unknown</span> !== <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> defaults = opts.<span class="hljs-property">default</span> !== <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;

  opts.<span class="hljs-property">alias</span> = opts.<span class="hljs-property">alias</span> || {};
  opts.<span class="hljs-property">string</span> = <span class="hljs-title function_">toArr</span>(opts.<span class="hljs-property">string</span>); <span class="hljs-comment">// 字符串类型的参数名数组</span>
  opts.<span class="hljs-property">boolean</span> = <span class="hljs-title function_">toArr</span>(opts.<span class="hljs-property">boolean</span>); <span class="hljs-comment">// 布尔类型的参数名数组</span>

  <span class="hljs-comment">// 别名双向绑定</span>
  <span class="hljs-keyword">if</span> (alibi) {
    <span class="hljs-keyword">for</span> (k <span class="hljs-keyword">in</span> opts.<span class="hljs-property">alias</span>) {
      arr = opts.<span class="hljs-property">alias</span>[k] = <span class="hljs-title function_">toArr</span>(opts.<span class="hljs-property">alias</span>[k]);
      <span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>; i &lt; arr.<span class="hljs-property">length</span>; i++) {
        (opts.<span class="hljs-property">alias</span>[arr[i]] = arr.<span class="hljs-title function_">concat</span>(k)).<span class="hljs-title function_">splice</span>(i, <span class="hljs-number">1</span>);
      }
    }
  }
  <span class="hljs-comment">// 布尔 / 字符串类型补全</span>
  <span class="hljs-comment">// 布尔类型：把别名也加入布尔列表</span>
  <span class="hljs-keyword">for</span> (i=opts.<span class="hljs-property">boolean</span>.<span class="hljs-property">length</span>; i-- &gt; <span class="hljs-number">0</span>;) {
    arr = opts.<span class="hljs-property">alias</span>[opts.<span class="hljs-property">boolean</span>[i]] || [];
    <span class="hljs-keyword">for</span> (j=arr.<span class="hljs-property">length</span>; j-- &gt; <span class="hljs-number">0</span>;) opts.<span class="hljs-property">boolean</span>.<span class="hljs-title function_">push</span>(arr[j]);
  }

  <span class="hljs-comment">// 字符串类型：同理，把别名也加入字符串列表</span>
  <span class="hljs-keyword">for</span> (i=opts.<span class="hljs-property">string</span>.<span class="hljs-property">length</span>; i-- &gt; <span class="hljs-number">0</span>;) {
    arr = opts.<span class="hljs-property">alias</span>[opts.<span class="hljs-property">string</span>[i]] || [];
    <span class="hljs-keyword">for</span> (j=arr.<span class="hljs-property">length</span>; j-- &gt; <span class="hljs-number">0</span>;) opts.<span class="hljs-property">string</span>.<span class="hljs-title function_">push</span>(arr[j]);
  }

  <span class="hljs-comment">// 默认值关联类型</span>
  <span class="hljs-keyword">if</span> (defaults) {
    <span class="hljs-keyword">for</span> (k <span class="hljs-keyword">in</span> opts.<span class="hljs-property">default</span>) {
      name = <span class="hljs-keyword">typeof</span> opts.<span class="hljs-property">default</span>[k];
      arr = opts.<span class="hljs-property">alias</span>[k] = opts.<span class="hljs-property">alias</span>[k] || [];
      <span class="hljs-keyword">if</span> (opts[name] !== <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>) {
        opts[name].<span class="hljs-title function_">push</span>(k);
        <span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>; i &lt; arr.<span class="hljs-property">length</span>; i++) {
          opts[name].<span class="hljs-title function_">push</span>(arr[i]);
        }
      }
    }
  }

  <span class="hljs-comment">// 遍历解析命令行参数</span>
  <span class="hljs-keyword">const</span> keys = strict ? <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(opts.<span class="hljs-property">alias</span>) : [];

  <span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>; i &lt; len; i++) {
    arg = args[i]; <span class="hljs-comment">// 当前处理的参数（比如 '--port'、'-p=3000'）</span>

    <span class="hljs-comment">// 1. 遇到 "--" 终止解析，后续参数全部放入 out._</span>
    <span class="hljs-keyword">if</span> (arg === <span class="hljs-string">'--'</span>) {
      out.<span class="hljs-property">_</span> = out.<span class="hljs-property">_</span>.<span class="hljs-title function_">concat</span>(args.<span class="hljs-title function_">slice</span>(++i));
      <span class="hljs-keyword">break</span>;
    }

    <span class="hljs-comment">// 2. 计算参数前的 "-" 数量（比如 --port 是 2 个，-p 是 1 个）</span>
    <span class="hljs-keyword">for</span> (j=<span class="hljs-number">0</span>; j &lt; arg.<span class="hljs-property">length</span>; j++) {
      <span class="hljs-keyword">if</span> (arg.<span class="hljs-title function_">charCodeAt</span>(j) !== <span class="hljs-number">45</span>) <span class="hljs-keyword">break</span>; <span class="hljs-comment">// "-"</span>
    }

    <span class="hljs-comment">// 3. 无 "-"：非选项参数，放入 out._</span>
    <span class="hljs-keyword">if</span> (j === <span class="hljs-number">0</span>) {
      out.<span class="hljs-property">_</span>.<span class="hljs-title function_">push</span>(arg);

      <span class="hljs-comment">// 4. 以 "no-" 开头（比如 --no-open）：布尔值取反</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (arg.<span class="hljs-title function_">substring</span>(j, j + <span class="hljs-number">3</span>) === <span class="hljs-string">'no-'</span>) {
      name = arg.<span class="hljs-title function_">substring</span>(j + <span class="hljs-number">3</span>);
      <span class="hljs-keyword">if</span> (strict &amp;&amp; !~keys.<span class="hljs-title function_">indexOf</span>(name)) {
        <span class="hljs-keyword">return</span> opts.<span class="hljs-title function_">unknown</span>(arg);
      }
      out[name] = <span class="hljs-literal">false</span>;

      <span class="hljs-comment">// 5. 正常选项参数（比如 --port=3000、-p3000、-p 3000）</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 找到 "=" 的位置（分割参数名和值）</span>
      <span class="hljs-keyword">for</span> (idx=j+<span class="hljs-number">1</span>; idx &lt; arg.<span class="hljs-property">length</span>; idx++) {
        <span class="hljs-keyword">if</span> (arg.<span class="hljs-title function_">charCodeAt</span>(idx) === <span class="hljs-number">61</span>) <span class="hljs-keyword">break</span>; <span class="hljs-comment">// "="</span>
      }

      <span class="hljs-comment">// 取值：有=则取=后的值；无=则取下一个参数（如果下一个不是-开头）</span>
      name = arg.<span class="hljs-title function_">substring</span>(j, idx);
      val = arg.<span class="hljs-title function_">substring</span>(++idx) || (i+<span class="hljs-number">1</span> === len || (<span class="hljs-string">''</span>+args[i+<span class="hljs-number">1</span>]).<span class="hljs-title function_">charCodeAt</span>(<span class="hljs-number">0</span>) === <span class="hljs-number">45</span> || args[++i]);
      arr = (j === <span class="hljs-number">2</span> ? [name] : name);

      <span class="hljs-comment">// 遍历解析（比如 -pv 会拆成 p 和 v 分别处理）</span>
      <span class="hljs-keyword">for</span> (idx=<span class="hljs-number">0</span>; idx &lt; arr.<span class="hljs-property">length</span>; idx++) {
        name = arr[idx];
        <span class="hljs-keyword">if</span> (strict &amp;&amp; !~keys.<span class="hljs-title function_">indexOf</span>(name)) <span class="hljs-keyword">return</span> opts.<span class="hljs-title function_">unknown</span>(<span class="hljs-string">'-'</span>.<span class="hljs-title function_">repeat</span>(j) + name);
        <span class="hljs-comment">// 把解析后的值存入 out（toVal 是核心工具函数）</span>
        <span class="hljs-title function_">toVal</span>(out, name, (idx + <span class="hljs-number">1</span> &lt; arr.<span class="hljs-property">length</span>) || val, opts);
      }
    }
  }

  <span class="hljs-comment">// 1. 补全默认值：如果参数未解析到，用默认值填充</span>
  <span class="hljs-keyword">if</span> (defaults) {
    <span class="hljs-keyword">for</span> (k <span class="hljs-keyword">in</span> opts.<span class="hljs-property">default</span>) {
      <span class="hljs-keyword">if</span> (out[k] === <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>) {
        out[k] = opts.<span class="hljs-property">default</span>[k];
      }
    }
  }

  <span class="hljs-comment">// 2. 同步别名：比如解析到 -p=3000，自动给 out.port 也赋值 3000</span>
  <span class="hljs-keyword">if</span> (alibi) {
    <span class="hljs-keyword">for</span> (k <span class="hljs-keyword">in</span> out) {
      arr = opts.<span class="hljs-property">alias</span>[k] || [];
      <span class="hljs-keyword">while</span> (arr.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
        out[arr.<span class="hljs-title function_">shift</span>()] = out[k];
      }
    }
  }

  <span class="hljs-keyword">return</span> out;
}

</code></pre>
<h3 data-id="heading-2">toArr</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">toArr</span>(<span class="hljs-params">any</span>) {
	<span class="hljs-keyword">return</span> any == <span class="hljs-literal">null</span> ? [] : <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(any) ? any : [any];
}
</code></pre>
<h3 data-id="heading-3">toVal</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">toVal</span>(<span class="hljs-params">out, key, val, opts</span>) {
  <span class="hljs-keyword">var</span> x,
    old = out[key],
    nxt = !!~opts.<span class="hljs-property">string</span>.<span class="hljs-title function_">indexOf</span>(key)
      ? val == <span class="hljs-literal">null</span> || val === <span class="hljs-literal">true</span>
        ? <span class="hljs-string">''</span>
        : <span class="hljs-title class_">String</span>(val)
      : <span class="hljs-keyword">typeof</span> val === <span class="hljs-string">'boolean'</span>
        ? val
        : !!~opts.<span class="hljs-property">boolean</span>.<span class="hljs-title function_">indexOf</span>(key)
          ? val === <span class="hljs-string">'false'</span>
            ? <span class="hljs-literal">false</span>
            : val === <span class="hljs-string">'true'</span> ||
              (out.<span class="hljs-property">_</span>.<span class="hljs-title function_">push</span>(((x = +val), x * <span class="hljs-number">0</span> === <span class="hljs-number">0</span>) ? x : val), !!val)
          : ((x = +val), x * <span class="hljs-number">0</span> === <span class="hljs-number">0</span>)
            ? x
            : val;
  out[key] =
    old == <span class="hljs-literal">null</span> ? nxt : <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(old) ? old.<span class="hljs-title function_">concat</span>(nxt) : [old, nxt];
}

</code></pre>
<h2 data-id="heading-4">示例</h2>
<pre><code class="hljs language-js" lang="js">
<span class="hljs-keyword">const</span> mri = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mri'</span>);
<span class="hljs-keyword">const</span> args = <span class="hljs-title function_">mri</span>(process.<span class="hljs-property">argv</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">2</span>));
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(args);
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd7a88ff58c443adaf088a42016e276a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57Gz5LiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770200633&amp;x-signature=Zl9eZc2JN7pY7zxjvtkz%2B1xSiuU%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[蚂蚁出手VLA，就是开源超越Pi0.5的基座模型]]></title>    <link>https://juejin.cn/post/7600242248861401128</link>    <guid>https://juejin.cn/post/7600242248861401128</guid>    <pubDate>2026-01-28T10:31:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600242248861401128" data-draft-id="7600265780349190184" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="蚂蚁出手VLA，就是开源超越Pi0.5的基座模型"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2026-01-28T10:31:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            蚂蚁出手VLA，就是开源超越Pi0.5的基座模型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T10:31:24.000Z" title="Wed Jan 28 2026 10:31:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>一个机器人到底需要多「聪明」，你才愿意把它请进家门？</p>
<p>前段时间，明星具身智能公司 1X 开始预售其人形机器人 Neo。演示视频中，它能从冰箱取水、叠衣服、把餐具放进洗碗机，俨然一个称职的家务助手。</p>
<p>但问题是，它当时真正能自主完成的，也只有这几件事。至于更多样的日常任务 —— 比如整理散落的玩具、擦拭台面、收纳杂物 —— 在现阶段，大多仍需要工程师远程教学。</p>
<p>这就多少有些令人迟疑：花费近 14 万元，迎来的不仅是一个「助手」，还可能是一双需要你授权进入家庭隐私空间的「眼睛」。社交网络上，不少人也对这种「半成品智能」表达了困惑甚至调侃。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5601059b0c504929aa1ff40cdee59efd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201084&amp;x-signature=%2FYNa0khG0jvojgylwfOKTc%2FJHcs%3D" alt="图片" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e1fe017de064cf4b7168da5c3b3349a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201084&amp;x-signature=%2FCOldV%2BYNywz4okirqNYcgdpsSk%3D" alt="图片" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98080019d86248f8bba78557b8e681a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201084&amp;x-signature=XBCYh7N%2Bgi4hbKI6SOAQt3iFaLA%3D" alt="图片" loading="lazy"/></p>
<p>这种「演示场景自主、真实任务依赖人工」的割裂状态，恰恰映射出当前具身智能落地的核心挑战：泛化能力不足。</p>
<p>要突破这一瓶颈，业界共识是：需要更大规模、更多样化的真实机器人数据来「喂养」模型，使其学习到更本质的任务理解与动作泛化能力。然而，高质量真机数据的采集成本极高，且不同构型机器人的数据难以复用，导致大多数模型仍只能在有限数据或仿真环境中训练，难以实现真正的跨任务、跨本体泛化。</p>
<p>在这一背景下，蚂蚁灵波开源发布的第一款具身智能基座模型 LingBot-VLA 带来了一个好消息：它基于约 20000 小时、覆盖 9 种主流双臂机器人构型的真实世界数据预训练而成，在涵盖 100 多项任务的统一真机评测基准下整体表现超越 Pi0.5，成为了能够跨本体、跨场景泛化的开源具身基座模型新标杆。</p>
<p>这一超越并非偶然，而是源于 LingBot-VLA 在模型架构、数据规模与训练效率上的系统性突破。在最新的技术报告中，我们可以看到相关细节。而且，蚂蚁灵波还开源了相应的模型权重、代码、后训练工具链，确保开发者不仅能拿到模型，还能把模型调得更好。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23250a069c9a4880a7b8aad16b997f0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201084&amp;x-signature=9%2BvaonmKN3Hymgs5Qsf3%2Bn8cTq0%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>
<p>项目链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftechnology.robbyant.com%2Flingbot-vla" target="_blank" title="https://technology.robbyant.com/lingbot-vla" ref="nofollow noopener noreferrer">technology.robbyant.com/lingbot-vla</a></p>
</li>
<li>
<p>技术报告链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2601.18692" target="_blank" title="https://arxiv.org/pdf/2601.18692" ref="nofollow noopener noreferrer">arxiv.org/pdf/2601.18…</a></p>
</li>
<li>
<p>模型下载链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fcollections%2Frobbyant%2Flingbot-vla" target="_blank" title="https://huggingface.co/collections/robbyant/lingbot-vla" ref="nofollow noopener noreferrer">huggingface.co/collections…</a></p>
</li>
<li>
<p>代码、后训练工具链链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frobbyant%2Flingbot-vla%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25E9%25AD%2594%25E6%2590%25AD%25E7%25A4%25BE%25E5%258C%25BA%25EF%25BC%259Ahttps%3A%2F%2Fwww.modelscope.cn%2Fcollections%2FRobbyant%2FLingBot-VLA" target="_blank" title="https://github.com/robbyant/lingbot-vla%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%E9%AD%94%E6%90%AD%E7%A4%BE%E5%8C%BA%EF%BC%9Ahttps://www.modelscope.cn/collections/Robbyant/LingBot-VLA" ref="nofollow noopener noreferrer">github.com/robbyant/li…</a></p>
</li>
</ul>
<p>看来，在具身智能这个领域，通过大规模扩展真实数据驱动模型泛化，已从技术愿景走向工程现实。</p>
<p>超越 Pi0.5，意味着什么？</p>
<p>在 LingBot-VLA 出现之前，Physical Intelligence 开源的 Pi0.5 几乎是行业内无法绕开的标杆。</p>
<p>为什么它有这么强的统治力？根本原因在于，Pi0.5 首次在开源世界里证明了：一个模型，不需要针对特定场景专门训练，就能在完全陌生的真实家庭环境中，完成长达 10-15 分钟的复杂操作链条。这件事让行业第一次清晰地看到，具身智能并非只能在「摆拍式」的单一任务中工作，而是有可能真正进入非结构化、充满不确定性的真实生活场景，完成从「实验室奇观」到「规模化产品」的过渡。</p>
<p>所以无论是学术论文里的对比实验，还是产业界的模型选型，Pi0.5 都是那个「必须要放进去比一比」的对象。也因为有这么一个「扛把子」的开源模型存在，很多机器人公司并不直接从零训练模型，而是选择在 Pi0.5 的基础上进行微调，再部署到自己的机器人本体上，这也进一步巩固了它在开源具身生态中的核心地位。</p>
<p>当然，也有不少团队选择正面硬刚，以自研模型对标 Pi0.5。但真正落到实际评测中，情况却要复杂得多。许多模型往往只能在某一个特定任务、某一种固定构型的机器人上取得更好的成绩，一旦换一个任务类型，或换一台不同本体的机器人，优势就会消失，甚至性能大幅退化。本质上，这仍然是专用模型在特定分布上的胜利，而不是泛化能力的提升。</p>
<p>这种局面很大程度上受制于底层的现实约束。我们知道，目前困扰具身模型的最大问题就是数据不够用，而数据与特定硬件的强绑定又加剧了这一问题。如果模型和训练范式无法高效吸收多源异构数据，那么简单地「多喂数据」这条路就跑不通。</p>
<p>也正是在这样的行业背景下，真正意义上的「整体超越 Pi0.5」，才显得格外稀缺。它不只是某个指标上的领先，还意味着模型在数据利用方式、训练效率以及跨本体、跨任务泛化能力上，已经迈过了一个新的台阶。LingBot-VLA 的出现，正是在这个时间点上，给出了一个不同于以往的答案。</p>
<p>三大平台，100 项真机任务</p>
<p>LingBot-VLA 经住了考验</p>
<p>LingBot-VLA 的强泛化能力，本质上来源于其对海量跨本体数据的有效利用。这个模型所用的 20000 小时真机数据，来自 9 个不同的机器人平台。传统上，由于不同机器人之间的传感器、控制接口、本体结构差异巨大，这些数据是很难被统一利用的，而 LingBot-VLA 打破了这一瓶颈。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a283c529a3264b438e00afe38b13fc28~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201084&amp;x-signature=iMA7F8qfDtmyegS4UjhxuoTNb0U%3D" alt="图片" loading="lazy"/></p>
<p>为了验证 LingBot-VLA 到底有多强，蚂蚁灵波在一个全新的具身智能基准 ——GM-100 上对其进行了测试。</p>
<p>这个基准总共包含 100 项真机任务，由上海交大牵头，蚂蚁灵波等多机构联合研发。我们打开它的官网看了一下，发现事情并不简单 —— 那些任务不是简单的「pick，hold，place（拿取，保持，放置）」操作，而是涉及了很多长序列任务和精细操作，比如串糖葫芦、拉软包拉链、叠衣服…… 一些看似简单的任务，比如按台灯开关、整理小物体，也会因为机械臂构型、物体材质、位置摆放、指令理解等因素而呈现出区分度。可以说，GM-100 通过精心设计复杂、长尾的多样化任务，为具身大模型设置了一张科学、严谨且难以取巧的「统考卷」。想在这样一个数据集上拿到好成绩，对于现阶段的模型来说是相当不容易的。</p>
<p>即使是这样，蚂蚁灵波还是选择继续上难度 —— 模型并非仅在单一机器人上验证，而是被部署在来自三大不同平台（AgileX、Agibot G1、Galaxea R1Pro）的 25 台机器人上统一执行任务。如此一来，整个测试就成了一个跨本体、跨任务能力的综合考验。</p>
<p>同时参与测试的还有 GR00T、WALL-OSS 以及 Pi0.5，这些都是开源具身模型里的优秀代表。</p>
<p>实验结果显示，无论在哪个平台上，LingBot-VLA 的成功率（SR）和部分成功率（PS，子步骤完成情况）都是最高的。尤其在融入基于深度的空间信息后，模型优势更加明显 —— 相比 Pi0.5 平均 SR 提高了 4.28%，PS 提高了 7.76%。这说明，无论是在复杂长序列任务的执行精度上，还是在面对新任务的适应能力上，LingBot-VLA 都展现出了更胜一筹的智能水平。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbefa0c223304f1abdab104737490c4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201084&amp;x-signature=2fHNzAmfHTS99OgdkPRZYm2n%2BgQ%3D" alt="图片" loading="lazy"/></p>
<p>另外，值得注意的是，LingBot-VLA 的数据利用效率和算力效率也更高。</p>
<p>实验显示，在 Agibot G1 平台上，仅使用 80 条示范数据进行后训练，LingBot-VLA 的表现就超越了使用 130 条完整数据训练的 Pi0.5 模型。而且，当数据量逐步增加时，LingBot-VLA 与 Pi0.5 的性能差距进一步拉大，这从侧面印证了其模型架构在学习潜能和泛化可扩展性上的设计优势。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d5a1d3b5c75478f87cb7b4deeaa3671~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201084&amp;x-signature=kxj7jqARcmOi2iyiQN%2FUdxI4EF8%3D" alt="图片" loading="lazy"/></p>
<p>而在算力效率方面，LingBot-VLA 的训练框架也展现出明显优势。在相同数据集和标准化架构下，其训练吞吐量（samples/s）均显著高于 StarVLA、Dex Botic、OpenPI 等主流开源框架。更突出的是，随着 GPU 规模从 8 卡扩展至 256 卡，其训练效率仍能紧密跟随理论线性扩展上限，展现出卓越的大规模分布式训练可扩展性。这意味着企业能以更低算力成本、更短训练周期完成模型迭代，实现从实验到落地的高效转化。</p>
<p>架构揭秘</p>
<p>从「大脑」到「小脑」的智能耦合</p>
<p>刚才提到，LingBot-VLA 在模型架构、数据效率、训练效率等方面都经得起考验，那么，蚂蚁灵波是怎么做到的呢？在技术报告中，他们透露了一些细节。</p>
<p>首先，在架构层面，LingBot-VLA 选择了一个强大的预训练视觉语言模型作为理解世界的「大脑」，然后为其配上一个专门负责生成机器人动作的「动作专家」。两者并非简单拼接，而是通过一种名为 Mixture-of-Transformers (MoT) 的架构有机结合：视觉、语言和动作数据各自通过独立的处理通路，又在每一层通过共享的注意力机制进行交互。这样既保证了视觉语义知识能持续指导动作生成，又避免了不同模态信息间的相互干扰。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f941c98503b4306ac0d77a02f80d51b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201084&amp;x-signature=NipDi7RKtQHjgP9D2C1Bm0Kgii8%3D" alt="图片" loading="lazy"/></p>
<p>在动作生成上，模型采用了 Flow Matching 方法来建模连续、平滑的动作轨迹，这有助于提升复杂操作的控制稳定性。</p>
<p>对于机器人操作至关重要的空间感知能力，LingBot-VLA 采用了一种基于视觉蒸馏的深度信息融合方法。其核心在于：模型并未直接将深度图作为原始输入，而是通过一套可学习的查询（Learnable Queries）机制，使其视觉语言主干（VLM）提取的特征，与专用深度模型 LingBot-Depth 所生成的空间表征进行对齐。这让模型在推理时无需深度图输入，就能具备对三维几何关系的隐式理解，从而实现了在抓取、放置等任务中精度的大幅提升。具体效果如视频所示。</p>
<p>在训练效率方面，研发团队还对其训练代码库进行了系统级优化。在分布式策略上，采用经过改进的 FSDP 策略，在内存占用与通信开销间取得了最佳平衡；在算子层面，利用 FlexAttention 和算子融合等技术，大幅提升了核心计算效率。最终，其训练吞吐量达到了每 GPU 每秒 261 个样本，相比主流开源代码库有 1.5 至 2.8 倍的加速，且扩展性极佳，能随着 GPU 数量增加近乎线性地提升训练速度。</p>
<p>LingBot-VLA——</p>
<p>开源具身基座模型新起点</p>
<p>总体而言，无论在模型泛化能力还是训练效率方面，LingBot-VLA 都已树立起一个新的行业标杆。然而，其真正的深远意义，不止于一次性能的超越，更在于它为「通过扩展真实数据实现更强泛化」提供了首个扎实的实证。 </p>
<p>蚂蚁灵波在技术报告中首次系统性地揭示了 VLA 模型在真实机器人数据上的 Scaling Law：随着预训练数据规模从 3000 小时逐步扩展至 20000 小时，模型在下游任务的成功率获得了持续且显著的提升。尤为关键的是，即使达到 20000 小时这一量级，模型性能曲线仍未显示饱和迹象。这一发现为行业点亮了一座灯塔，用数据证实了「大力出奇迹」的路径在真实机器人学习中依然有效，为后续的大规模数据开发指明了可预期的回报。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce525fba24744bb8922c46602eaa3c33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201084&amp;x-signature=BfqanjF%2FEDwM33fOODGWpbZ3nH8%3D" alt="图片" loading="lazy"/></p>
<p>更进一步看，这类以真实交互数据为核心、兼顾规模与效率的成功实践，也为 VLA 模型未来与世界模型的深度融合奠定了现实基础。</p>
<p>不过，所有模型在 GM-100 上平均成功率都未超过 20% 的现实也在提醒我们，具身模型 —— 尤其是开源具身模型 —— 距离真正的跨本体、跨场景泛化还有很长的路要走。接下来，相关从业者可以在 LingBot-VLA 的基础上继续前进，而蚂蚁灵波的全链路开源（模型权重、代码、后训练工具链全部开源）也为这种持续迭代提供了土壤。</p>
<p>但如果把它放到更长周期里看，LingBot-VLA 可能还有另一层意义 —— 它也可以被理解为蚂蚁 AGI 版图里一次面向「真实世界交互」的落子：在基础大模型（百灵）与通用助手（灵光）等「通用智能」能力之外，通过具身智能把模型带入可验证、可复现的物理世界闭环。</p>
<p>这也解释了它为什么选择以开源方式发布，并同步建设 InclusionAI 这样的开源社区与技术体系：用更开放的协作与复现机制扩大验证面，让具身智能的迭代速度更接近 AGI 需要的「规模化试错」。</p>
<p>标杆的意义，在于被超越，更在于指明方向。LingBot-VLA 的发布，或许正是这样一个新方向的开始。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一句话把 B 站视频合集变成教程网站，这是什么神仙操作 ？MiniMax Agent 的专家功能，值得一试！]]></title>    <link>https://juejin.cn/post/7600245693996974090</link>    <guid>https://juejin.cn/post/7600245693996974090</guid>    <pubDate>2026-01-28T10:42:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600245693996974090" data-draft-id="7600234310965067814" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一句话把 B 站视频合集变成教程网站，这是什么神仙操作 ？MiniMax Agent 的专家功能，值得一试！"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2026-01-28T10:42:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="万少"/> <meta itemprop="url" content="https://juejin.cn/user/4441682708283191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一句话把 B 站视频合集变成教程网站，这是什么神仙操作 ？MiniMax Agent 的专家功能，值得一试！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4441682708283191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    万少
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.5 如鱼得水
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.5 如鱼得水" title="VIP.5 如鱼得水" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T10:42:38.000Z" title="Wed Jan 28 2026 10:42:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一句话把 B 站视频合集变成教程网站，这是什么神仙操作 ？MiniMax Agent 的专家功能，值得一试！</h2>
<blockquote>
<p>一句话把 B 站视频合集变成教程网站，这是什么神仙操作 ？MiniMax Agent 的专家功能，值得一试！</p>
<hr/>
<p>万少：华为HDE、鸿蒙极客</p>
<p>个人主页：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.zbztb.cn%2F" target="_blank" title="https://blog.zbztb.cn/" ref="nofollow noopener noreferrer">blog.zbztb.cn/</a></p>
<p><strong>2025年参与孵化了20+鸿蒙应用、技术文章300+、鸿蒙知识库用户500+、鸿蒙免费课程2套。</strong></p>
<p>如果你也喜欢交流AI和鸿蒙技术，欢迎扣我。</p>
</blockquote>
<p><strong>MiniMax Agent</strong> 最近上线的「专家 Agents」功能，支持创建包括自定义指令、模型和子代理等。</p>
<p>🔗 官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fagent.minimaxi.com%2F" target="_blank" title="https://agent.minimaxi.com/" ref="nofollow noopener noreferrer">agent.minimaxi.com/</a></p>
<p>早上抽空下载体验了下，感觉这个「专家 Agents」功能确实能 <strong>听懂人话</strong> 和 <strong>做些人事</strong>！</p>
<hr/>
<h3 data-id="heading-1">下载安装</h3>
<p>首先下载桌面端的 <strong>MiniMax Agent</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9be8dfe48fcf432aadc5beb2467bf3a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201757&amp;x-signature=0m9TIAe1AdeyKYWbQZGJG7MZGwI%3D" alt="图片" loading="lazy"/></p>
<p>下载成功后，直接登录即可。新用户赠送 <strong>1000 积分</strong>，够玩几圈的了！🎁</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db4a49ce18414fcfae05da2c77cd3010~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201757&amp;x-signature=06teT4mJ%2BsOZQkxHWXmSeHN0rx4%3D" alt="图片" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-2">体验效果</h3>
<p>我主要体验了它的「探索专家」功能：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/daa81c16486043f3892a6ace30788ea6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201757&amp;x-signature=zOvWyJCQJiOq%2FFfjk93YwKc2kzo%3D" alt="图片" loading="lazy"/></p>
<p>你可以使用已有的专家功能，或者自己创建专家。</p>
<hr/>
<p>我创建了一个名为 <strong>《B 站视频合集文档生成专家》</strong> 的专家：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acc80548af3247cf80be1a84a3013131~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201757&amp;x-signature=xVOjBv0MMb6nRGNIvd%2BUiRi2SWM%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-3">提供需求</h4>
<p><strong>给一个 B 站视频链接，自动把视频所在的合集，生成一个 VitePress 的博客网站。</strong></p>
<p>这相当于给你的 B 站视频做了一个系列教程网站。</p>
<p><strong>一句话做一个教程网站，是不是很酷？</strong> 😎</p>
<hr/>
<h4 data-id="heading-4">实际效果</h4>
<p>先看我做到的效果：</p>
<p><strong>开始对话</strong> → 输入 B 站视频链接</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f783a9bef39456dbd3e2d1196e8b88e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201757&amp;x-signature=ou1QOTVzBqcB3KEopT3mxIA%2Bohk%3D" alt="图片" loading="lazy"/></p>
<p><strong>得到结果</strong> → AI 自动分析并生成</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/efd171ffb1bb4a609e3de6b3fd97ad8d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201757&amp;x-signature=2gT30ahHm1gZJEqdDMEvehDXfuM%3D" alt="图片" loading="lazy"/></p>
<p><strong>实际效果</strong> → 打开生成的博客网站</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9f9e1f779d543fb8339e8c282824e2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201757&amp;x-signature=uEFfzBE%2FWaAlZgZSortRhQHxsIE%3D" alt="图片" loading="lazy"/></p>
<blockquote>
<p>看到了吗？内容完全对应上！</p>
</blockquote>
<hr/>
<p>我还有一个测试效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99a5a2735b7b4824ab12bb1732881b8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201757&amp;x-signature=xO3UZGVFSmXmiw%2FOav42ys9aQ8k%3D" alt="图片" loading="lazy"/></p>
<p>这个能力确实不俗，懂技术的同学应该知道，生成博客网站的过程可不简单！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b825039be354e55bbaaa0e9dbb5cc51~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201757&amp;x-signature=zRdc8FDdMjx9AAB7VB3Yc6hstbw%3D" alt="图片" loading="lazy"/></p>
<p>这个专家能力确实很强大！</p>
<hr/>
<h3 data-id="heading-5">创建专家</h3>
<p>如果你也有一些想法，想创建自己的专家，这样操作：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df00aab239584e4eaf3796eef2f67563~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201757&amp;x-signature=2Org8AaX4nauX%2BuSe3o3oNcacjU%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f089a11d9e5e4d3283ae792b0b1ada47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201757&amp;x-signature=MXAiig06fXrW1XGibYMT5WhhAIk%3D" alt="图片" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-6">📝 总结</h3>
<p>整个体验下来，MiniMax Agent 的专家功能确实值得一试！</p>
<p><strong>一句话总结</strong>：AI 真的能听懂你的需求，并且把复杂的事情做得简单。</p>
<p>如果你也想体验，赶紧去试试吧！</p>
<hr/>
<p><strong>互动一下</strong>你用过类似的 AI Agent 吗？欢迎在评论区分享你的体验！</p>
<p><strong>关注我</strong>，持续分享鸿蒙开发 + AI 提效的实战技巧。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Clawedbot 完整对接飞书教程 手把手搭建你的专属 AI 助手]]></title>    <link>https://juejin.cn/post/7600238071038197769</link>    <guid>https://juejin.cn/post/7600238071038197769</guid>    <pubDate>2026-01-28T10:43:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600238071038197769" data-draft-id="7600224355294199835" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Clawedbot 完整对接飞书教程 手把手搭建你的专属 AI 助手"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-28T10:43:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Clawedbot 完整对接飞书教程 手把手搭建你的专属 AI 助手
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T10:43:37.000Z" title="Wed Jan 28 2026 10:43:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Clawedbot 完整对接飞书教程 手把手搭建你的专属 AI 助手</h2>
<blockquote>
<p>注意本教程在 Linux 系统下进行</p>
</blockquote>
<p>Clawdbot 由于 Claude 的版权问题，已更名为 Moltbot，因此本教程基于最新版本编写。下面进入安装流程</p>
<p>首先准备一台闲置的云服务器或 VPS（推荐使用香港或海外节点）。由于 Moltbot 运行时权限较大，出于安全考虑，不建议在本地或工作机上安装，推荐在一台独立的空服务器上部署。准备完成后，登录到服务器。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2026-01%2Fclawedbot-install" target="_blank" title="https://catchadmin.com/post/2026-01/clawedbot-install" ref="nofollow noopener noreferrer">原文 Clawedbot 完整对接飞书教程 手把手搭建你的专属 AI 助手</a></p>
<h3 data-id="heading-1">安装</h3>
<p>第一步安装 Git</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">安装 Git</span>
sudo apt update
sudo apt install git -y
</code></pre>
<p>第二步安装 Node.js</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">安装 NVM</span>
<span class="hljs-meta prompt_"># </span><span class="bash">国内使用 gitee 的镜像源</span>
curl -o- https://gitee.com/RubyMetric/nvm-cn/raw/main/install.sh | bash
<span class="hljs-meta prompt_">
# </span><span class="bash">国外使用</span>
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash
<span class="hljs-meta prompt_">
# </span><span class="bash">重新加载环境变量</span>
source ~/.bashrc
<span class="hljs-meta prompt_">
# </span><span class="bash">安装 Node.js 22</span>
nvm install 22
<span class="hljs-meta prompt_">
# </span><span class="bash">查看 nodejs 版本</span>
node -v # 输出 v22 即可，版本只要 22 就行
</code></pre>
<h3 data-id="heading-2">安装 Moltbot (原 Clawdbot)</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">使用官方脚本安装</span>
curl -fsSL https://molt.bot/install.sh | bash
</code></pre>
<blockquote>
<p>服务器在国内，如果安装失败的话，可能需要解决网络问题</p>
</blockquote>
<p>其他平台安装方式请参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.molt.bot%2Finstall%2Finstaller" target="_blank" title="https://docs.molt.bot/install/installer" ref="nofollow noopener noreferrer">Moltbot (原Clawdbot) 安装文档</a></p>
<p>你会看到如下图输出
<img src="https://image.catchadmin.com/202601280801125.png" alt="Clawedbot 安装过程 - AI 助手部署初始化" loading="lazy"/>
如果首次安装，时间会很长，需要耐心等待。
如果最后输出如下内容：</p>
<pre><code class="hljs language-shell" lang="shell">→ npm install failed; cleaning up and retrying...
</code></pre>
<p><code>ctrl+c</code> 退出，重新运行安装脚本然后继续等待下。</p>
<p>成功之后会输出如下图片
<img src="https://image.catchadmin.com/202601281349920.png" alt="Clawedbot 安装成功 - AI 机器人配置向导" loading="lazy"/>
第一个选项选择 <code>yes</code>, 就是询问你是否知道风险的。
第二步选择 <code>QuickStart</code>
<img src="https://image.catchadmin.com/202601281351166.png" alt="Clawedbot QuickStart 快速开始选项" loading="lazy"/>
第三步选择模型服务商，这里选择 <code>Qwen</code>，免费额度充足，适合入门使用
<img src="https://image.catchadmin.com/202601281352080.png" alt="Clawedbot 选择 AI 模型服务商 Qwen 千问" loading="lazy"/>
选择千问模型后，会提供一个链接，复制并在浏览器中打开，如下图
<img src="https://image.catchadmin.com/202601281355542.png" alt="Clawedbot 千问模型授权链接" loading="lazy"/>
打开浏览器后，会看到如下界面。由于我已登录过，所以显示账户信息；如果尚未登录，按照提示完成登录即可。
<img src="https://image.catchadmin.com/202601281356909.png" alt="Clawedbot 千问 AI 账户登录页面" loading="lazy"/>
登录完成后，会出现以下选项，提示选择对应的千问模型，如下图
<img src="https://image.catchadmin.com/202601281358170.png" alt="Clawedbot 选择千问 AI 模型版本" loading="lazy"/>
选择默认模型即可。接下来会提示选择 channel，这里先跳过，后续再添加
<img src="https://image.catchadmin.com/202601281359123.png" alt="Clawedbot channel 渠道配置选项" loading="lazy"/>
继续下面选择 skills，也是选择 <code>No</code>，如下图
<img src="https://image.catchadmin.com/202601281359786.png" alt="Clawedbot skills 技能配置选项" loading="lazy"/>
继续下面选择 hooks，也是使用<code>空格</code>选择 <code>No</code>，如下图
<img src="https://image.catchadmin.com/202601281400483.png" alt="Clawedbot hooks 配置选项" loading="lazy"/>
然后等待安装完成，最后会出现以下选项，这里选择 <code>TUI</code>
<img src="https://image.catchadmin.com/202601281403169.png" alt="Clawedbot 选择 TUI 终端界面" loading="lazy"/>
如果看到 TUI 聊天界面，说明安装成功，可以尝试输入 <code>Hello</code> 进行测试。
<img src="https://image.catchadmin.com/202601281404354.png" alt="Clawedbot TUI 聊天界面 - AI 助手对话测试" loading="lazy"/>
然后直接使用 <code>ctrl+c</code> 先关闭，后面我们再来设置</p>
<h4 data-id="heading-3">查看服务</h4>
<p>可以使用下面的命令来查看</p>
<pre><code class="hljs language-shell" lang="shell">clawdbot status
</code></pre>
<p>会看到如下图的结果就说明服务启动了
<img src="https://image.catchadmin.com/202601281449942.png" alt="Clawedbot 服务状态检查 - AI 助手运行中" loading="lazy"/></p>
<h4 data-id="heading-4">访问 Web UI 面板</h4>
<p>如何访问面板？服务监听在 <code>http://127.0.0.1:18789/</code> 端口上，我们现在通过 ssh 隧道来访问，输入下面的命令</p>
<pre><code class="hljs language-shell" lang="shell">ssh -N -L 18789:127.0.0.1:18789 用户名@服务器IP
<span class="hljs-meta prompt_"># </span><span class="bash">回车之后</span>
用户名@服务器IP's password: # 输入密码
</code></pre>
<p>然后在浏览器打开 <code>http://127.0.0.1:18789/</code>, 你会看到 Dashboard 了，如下图
<img src="https://image.catchadmin.com/202601281509102.png" alt="Clawedbot Web UI Dashboard 未授权页面" loading="lazy"/>
图中显示的是未授权状态，回到服务器，输入以下命令</p>
<pre><code class="hljs language-shell" lang="shell">clawdbot dashboard
</code></pre>
<p>会看到下面的面板数据
<img src="https://image.catchadmin.com/202601281530336.png" alt="Clawedbot Dashboard URL 获取命令" loading="lazy"/>
复制对应的 <code>Dashboard URL</code> 到浏览器打开，即可正常查看聊天记录。
<img src="https://image.catchadmin.com/202601281532427.png" alt="Clawedbot Web UI 管理面板 - AI 助手聊天记录" loading="lazy"/></p>
<p>至此 Moltbot 已安装完成，可以正常访问了。</p>
<h3 data-id="heading-5">对接飞书</h3>
<p>首先安装飞书插件，输入以下命令</p>
<pre><code class="hljs language-shell" lang="shell">clawdbot plugins install @m1heng-clawd/feishu
</code></pre>
<p>登录飞书开放平台 <a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.feishu.cn%25EF%25BC%258C%25E7%2582%25B9%25E5%2587%25BB%25E3%2580%258C%25E5%25BC%2580%25E5%258F%2591%25E8%2580%2585%25E5%2590%258E%25E5%258F%25B0" target="_blank" title="https://open.feishu.cn%EF%BC%8C%E7%82%B9%E5%87%BB%E3%80%8C%E5%BC%80%E5%8F%91%E8%80%85%E5%90%8E%E5%8F%B0" ref="nofollow noopener noreferrer">open.feishu.cn，点击「开发者后台</a> -&gt; 创建企业自建应用」，如下图
<img src="https://image.catchadmin.com/202601281539117.png" alt="飞书开放平台创建企业自建应用 - Clawedbot 对接" loading="lazy"/>
然后点击创建应用，如下
<img src="https://image.catchadmin.com/202601281743642.png" alt="飞书创建应用 - Clawedbot AI 机器人" loading="lazy"/>
创建完成后，首先到凭据管理中获取 App ID 和 App Secret，注意保存，后续配置需要使用。
<img src="https://image.catchadmin.com/202601281757469.png" alt="飞书 App ID 和 App Secret 凭据管理" loading="lazy"/>
然后添加机器人，如下操作
<img src="https://image.catchadmin.com/202601281758607.png" alt="飞书添加机器人能力 - Clawedbot AI 助手" loading="lazy"/>
首先配置个名字
<img src="https://image.catchadmin.com/202601281758721.png" alt="飞书机器人名称配置 - Clawedbot" loading="lazy"/></p>
<p>飞书的其他配置先暂停，回到服务器配置 Moltbot 的飞书参数</p>
<h4 data-id="heading-6">添加飞书配置</h4>
<pre><code class="hljs language-shell" lang="shell">clawdbot config set channels.feishu.appId "飞书 app id"

clawdbot config set channels.feishu.appSecret "飞书 app secret"

clawdbot config set channels.feishu.enabled true
<span class="hljs-meta prompt_">
# </span><span class="bash">推荐使用 websocket</span>
clawdbot config set channels.feishu.connectionMode websocket

clawdbot config set channels.feishu.dmPolicy pairing

clawdbot config set channels.feishu.groupPolicy allowlist

clawdbot config set channels.feishu.requireMention true
</code></pre>
<p>配置完成之后，重启</p>
<pre><code class="hljs language-shell" lang="shell">clawdbot gateway restart
</code></pre>
<p>重启完成后回到飞书，找到「事件和回调」，选择长连接模式，如下图
<img src="https://image.catchadmin.com/202601281802128.png" alt="飞书事件和回调配置 - Clawedbot 长连接模式" loading="lazy"/>
如果配置成功，说明连接已建立。继续下面的配置，添加事件，选择「接收消息」事件
<img src="https://image.catchadmin.com/202601281811231.png" alt="飞书添加接收消息事件 - Clawedbot AI 助手" loading="lazy"/>
事件添加完成之后，还需要开通权限，有以下权限全部勾选</p>




















<table><thead><tr><th>权限</th><th>Scope（范围）</th><th>Description（说明）</th></tr></thead><tbody><tr><td>contact:user.base:readonly</td><td>用户信息</td><td>获取基础用户信息</td></tr><tr><td>im:message</td><td>消息 全部勾选</td><td>发送和接收消息</td></tr></tbody></table>
<p>如下图
<img src="https://image.catchadmin.com/202601281545906.png" alt="飞书权限配置 - Clawedbot 用户信息权限" loading="lazy"/></p>
<p><img src="https://image.catchadmin.com/202601281549559.png" alt="飞书消息权限配置 - Clawedbot AI 机器人" loading="lazy"/></p>
<p>以上步骤全部完成后，即可与机器人对话。但在此之前需要先创建一个版本
<img src="https://image.catchadmin.com/202601281814848.png" alt="飞书应用版本发布 - Clawedbot AI 助手上线" loading="lazy"/></p>
<blockquote>
<p>注意：每次修改配置后都需要重新发布版本，建议全部配置完成后再统一发布。</p>
</blockquote>
<p>发布完成后，回到飞书客户端，可以看到应用已上线，点击打开应用
<img src="https://image.catchadmin.com/202601281816608.png" alt="飞书应用发布成功 - Clawedbot AI 机器人" loading="lazy"/>
向机器人发送 <code>Hello</code>，即可收到 Moltbot 的回复
<img src="https://image.catchadmin.com/202601281817700.png" alt="飞书 Clawedbot AI 助手回复测试成功" loading="lazy"/></p>
<p>由于流程较长，如有勘误，还请指正</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[突破传统限制：OxygenREC--一个基于指令跟随的“快慢思考“电商生成式推荐框架]]></title>    <link>https://juejin.cn/post/7600068892988866570</link>    <guid>https://juejin.cn/post/7600068892988866570</guid>    <pubDate>2026-01-28T10:43:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600068892988866570" data-draft-id="7600234310965051430" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="突破传统限制：OxygenREC--一个基于指令跟随的“快慢思考“电商生成式推荐框架"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2026-01-28T10:43:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东零售技术"/> <meta itemprop="url" content="https://juejin.cn/user/4233576972293643"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            突破传统限制：OxygenREC--一个基于指令跟随的“快慢思考“电商生成式推荐框架
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4233576972293643/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东零售技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T10:43:58.000Z" title="Wed Jan 28 2026 10:43:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在电商推荐系统中，推荐模型长期面临着两个核心矛盾：一方面，传统的多阶段级联推荐系统存在目标不一致和误差累积的问题；另一方面，直接引入大型语言模型LLM虽然能带来强大的推理能力，但其高昂的延迟和计算成本在工业级应用中难以承受。更重要的是，现有的生成式推荐方法在多场景扩展性上面临巨大瓶颈--每个场景都需要独立训练和部署，导致资源利用率低下、维护成本高昂。</p>
<p>京东零售OxygenREC团队在论文《OxygenREC: An Instruction-Following Generative Framework for E-commerce Recommendation》中提出了一种全新的解决方案：OxygenREC。这是一个基于“快慢思考”的指令跟随生成式推荐框架，不仅解决了推理能力与延迟之间的矛盾，更实现了“一次训练，多处部署”的多场景统一高效解决方案。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7df8c0078784d2cbbe21c6175c19f8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=two5r0QHfN4%2FFUGKXeu2hm4CgCA%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">一、关键挑战</h2>
<p>OxygenREC 旨在解决当前推荐系统，特别是生成式推荐范式下的三大核心难题：</p>
<p>1.有限的演绎推理能力：现有的生成式推荐方法主要从用户海量行为中进行归纳学习，但在需要结合现实世界知识进行深度演绎推理的场景下表现不佳。比如下边两个例子：</p>
<p>当推荐的时空背景和用户画像是“成都冬至时的年轻宝妈”时，传统模型可能只是推荐“冬季外套”这样的商品，而无法深度推理出此时成都是“冷湿环境”，这位年轻母亲潜在的需求可能是“婴儿排汗睡衣”。</p>
<p>有个户外运动vlogger在购物行为中反复对比华为Mate 70和iPhone 16 Pro两款手机，传统系统因为用户频繁的交互历史，只会不断加强重复推荐这两款商品进行比价，而无法推理出其真正诉求可能是“高质量的移动影像”，从而模型未能精准推荐‘华为Pura’系列这一真正符合用户诉求的目标商品。</p>
<p>2.多场景适应与资源效率的矛盾：大部分推荐平台拥有首页、频道流、购物车、搜索等多种推荐场景。现有生成式推荐模型如果为每个场景训练独立模型，会带来巨大的运营和计算成本，而使用简单的统一模型又会面临“负迁移”问题--不同场景间的知识相互干扰，导致性能下降。</p>
<p>3.工业级部署的工程挑战：将LLM的深度推理能力与推荐系统的大规模稀疏特征、严格延迟要求相结合，是一个巨大的系统工程挑战。它需要同时处理推荐系统典型的TB级稀疏嵌入和LLM典型的十亿级稠密参数，这对训练框架和推理引擎都提出了极高要求。</p>
<h2 data-id="heading-1">二、核心贡献</h2>
<p>面对这些挑战，京东零售OxygenREC团队提出了一个基于指令跟随的生成式推荐框架-OxygenREC，首次把LLM中的“快慢思考”模式引入到生成式推荐中来。在OxygenREC框架中，通过基于Transformer 的Encoder-Decoder 作为骨干网络，能够根据特定指令生成语义化物品序列，来执行推荐场景的”快思考"方式。在“慢思考”模式中，引入上下文推理指令--由近线LLM pipeline 生成，将用户行为与上下文合成为可解释的指令。同时多场景对齐中，通过场景指令与基于强化学习的对齐机制，实现“一次训练，多场景部署”。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa6943c39aa3452a9461937c41dd99dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=LmqwDZ2L1J1VK%2Bt5K2HP7NHVzh0%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-2">1. “快慢思考”架构：知识注入与低延迟的平衡</h4>
<p>这是整个OxygenREC的基础，其核心思想是将复杂的推理过程“离线化”，保证在线服务的低延迟。</p>
<p>慢思考：一个近线的LLM pipeline，综合分析用户的时空上下文、个性化特征和历史行为，生成高质量的“上下文推理指令”。这个过程融合了世界知识，能进行深度演绎推理，但因其是近线批量处理，不增加在线请求的延迟。</p>
<p>快思考：一个高效的编码器-解码器骨干网络。它接收“慢思考”生成的指令，结合实时用户信号，在严格的延迟限制下生成推荐序列。该骨干网络本身轻量、高效，专为实时推理优化。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b52361b6fcf74385b289ca2312ddf96f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=bA49vQ0BcffsL8hXQ0E7YjbIW3c%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-3">2. 语义对齐的指令控制机制：让指令真正发挥作用</h4>
<p>仅仅生成指令是不够的，还必须确保模型能够准确理解并遵循指令。OxygenREC通过两项关键技术实现精准指令控制：</p>
<p>查询到物品的对齐损失：在训练阶段，通过一个辅助的Query-to-Item (Q2I) 损失函数，将指令嵌入与目标物品嵌入在同一个语义空间中对齐。这使得指令能够“理解”物品，并用于检索：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/456be53a34c64881b332f3ca1234ea54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=EgBT2a2bhxSYsCifMziQZyH8olM%3D" alt="image.png" loading="lazy"/></p>
<p>指令引导检索(IGR)：在生成推荐时，利用对齐后的指令作为查询，从用户长期历史行为中检索出最相关的部分，过滤掉无关的噪声。这确保了模型生成时专注在与当前指令意图最相关的历史信息上，大大提升了可控性和准确性。</p>
<h4 data-id="heading-4">3. 基于指令与强化学习的多场景统一对齐：Train-Once-Deploy-Everywhere</h4>
<p>这是解决多场景扩展性的关键。OxygenREC摒弃了为每个场景独立建模的思路。</p>
<p>场景指令化：将不同的场景信息（如首页、购物车）和可选的触发物品（如用户点击的入口商品）统一编码为“场景指令”，作为模型的条件输入。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab5da81d461544c99f265ffc6ade2b3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=VslxIpTc5Wu94KlcDUmKJ6yaJPo%3D" alt="image.png" loading="lazy"/></p>
<p>统一奖励映射与策略优化：设计了一个统一的奖励映射服务，将不同场景、不同业务目标（如GMV，转化率，合法性，多样性）的奖励信号归一化。在此基础上，提出了Soft Adaptive Group Clip Policy Optimization (SA-GCPO)算法进行强化学习训练:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/691bbb2d3c5a41c2852e5fbb621b3974~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=yY6qltu7fFGDbHF4fNPqt0K11xA%3D" alt="image.png" loading="lazy"/></p>
<p>该算法用自适应门控函数替代传统基于GRPO的硬截断方式(hard clip):</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7861e3ae0a14bb1a39f295b3d2a84db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=%2Fs27rs%2FTM4r9PTCMj%2Fp7qedGfwI%3D" alt="image.png" loading="lazy"/></p>
<p>并以基于用户真实反馈的奖励分数作为阈值区分正负advantage样本，显著提升了多任务、多场景下策略学习的稳定性和效率：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f6df5ad12294ba9a15a4f7cea575b7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=%2BSaOUEO6bJ44eb9RFxAu8lQvGoI%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-5">4. 大规模生产级系统实现</h4>
<p>为了支撑以上创新，团队构建了完整的工程体系：</p>
<p>统一训练框架：基于PyTorch，深度融合了工业级稀疏嵌入引擎和LLM稠密训练引擎，在128张H800 GPU集群上实现了40%的模型FLOPs利用率。﻿</p>
<p>高性能推理引擎xLLM：针对生成式推荐长上下文、大候选集的特点，定制开发了xLLM推理框架，通过xSchedule（系统调度）、xAttention（算子优化）、xBeam（束搜索优化）三级优化，满足线上严格的服务级别目标。</p>
<p>近线指令服务：推理指令通过近线服务批量生成并存入KV数据库，线上推荐模型直接读取，实现了零在线LLM调用，兼顾了语义丰富性和低延迟。</p>
<h2 data-id="heading-6">三、实验成果</h2>
<p>OxygenREC在京东几个核心场景的大量离线实验和在线A/B测试中取得了显著效果，证明OxygenREC 基于生成式推荐的方法在大规模工业级推荐系统中的有效性。</p>
<h4 data-id="heading-7">1. 基于快慢思考的生成式框架有效性验证</h4>
<p>语义ID：通过多源对比学习（文本、图像、行为关联）构建的层次化语义ID，在保持高类别纯度（92.8%）的同时，实现了极低的ID碰撞，证明了其强大的表达和区分能力。</p>
<p>指令跟随：消融实验证明，在BOS右侧插入指令的方式为最佳；融合了场景ID和触发物品ID的指令效果显著优于单一组件；IGR和Q2I对齐机制共同作用带来了显著的性能提升。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f9dd59be950429da8a3a310fee5dd44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=k7XxVwhntSYUlnbyqc2KEKNeAp0%3D" alt="image.png" loading="lazy"/></p>
<p>统一模型 vs. 独立模型：在六个核心场景的对比中，统一的OxygenREC模型全面超越了为每个场景独立微调的基线模型，验证了OxygenREC框架在场景间正向迁移的有效性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0b1466804884746b3ad44efb6446e10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=5U4ZnhK%2BL0RXvSOAoBNetYjdpys%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-8">2. 基于SA-GCPO后训练的有效性验证</h4>
<p>在后续训练阶段，提出的SA-GCPO算法在合成数据比例变化时表现更稳定，且性能显著优于传统的GRPO及其变体GSPO。例如，在33%合成数据比例下，SA-GCPO在HR@1和HR@10上有显著提升。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0087405b804745ceb529b71b5855817f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=08vEU0crdzoLzVVmQvE5fvAen60%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-9">3. 电商场景在线A/B测试的商业效果</h4>
<p>OxygenREC已在京东App上形成覆盖用户购物全链路的部署闭环：首页导流（场景1、2）-&gt; 频道浏览（场景3、4）-&gt; 商品结算转化（场景5、6）。在线测试结果表明，该模型在所有关键业务指标上均带来显著提升：</p>
<p>首页场景：GMV提升4.52%-8.40%。</p>
<p>频道流场景：其中一个场景的订单量提升了8.03%，显示出模型精准匹配购买意图的能力。</p>
<p>结算路径场景：在用户强购买意图下，GMV提升高达11.80%。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d67fbbf584e49edbe176cf9f1fc028f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=23bAzHEgiBYmFlb9avNIhDNPaPE%3D" alt="image.png" loading="lazy"/></p>
<p>与行业上其他生成式推荐方式对比:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/582dc6a123c741c381fd9891479fc4fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=oGNN%2BnJdtBnYTm1V4W1iZ9rLWnM%3D" alt="image.png" loading="lazy"/></p>
<p>OxygenREC 在几个关键维度上进行了生成式推荐的范式革新：</p>
<p>架构上，用“快慢思考”破解了推理与延迟的死结。</p>
<p>效率上，用“统一指令模型”破解了多场景训练的困局。</p>
<p>控制上，用“语义对齐与引导检索”构建了生成式推荐模型的指令跟随能力。</p>
<p>优化上，用“SA-GCPO”和全栈系统优化，确保了技术在工业巨量流量下的可行性、稳定性和卓越性能。</p>
<h2 data-id="heading-10">四、总结与展望</h2>
<p>OxygenREC的成功，标志着生成式推荐在工业落地上迈出了关键一步。它通过“快慢思考”巧妙平衡了深度推理与低延迟，通过“指令跟随”实现了对推荐过程的精准可控，并通过统一的奖励与策略学习破解了多场景扩展的难题，真正实现了“一次训练，多场景部署”的pipeline。</p>
<p>未来，京东零售OxygenREC团队计划从两个方向继续探索：</p>
<p>一是向基于语言扩散模型的非自回归生成范式演进，从根本上突破序列生成延迟与列表长度的线性关系，满足更高吞吐需求；</p>
<p>二是开展跨场景用户轨迹建模，从用户在首页、搜索、购物车、结算等多场景的连贯行为中挖掘更深层的用户意图，实现更长周期的价值推荐。</p>
<p>OxygenREC不仅是一个高效的推荐系统，更为工业级生成式AI应用的大模型设计提供了宝贵范式--如何将大模型的“脑”与小模型的“身手”结合，如何在复杂多目标任务中实现稳定高效的学习，这其中的思想值得广泛借鉴。</p>
<p>论文原文：OxygenREC: An Instruction-Following Generative Framework for E-commerce Recommendation</p>
<p>训练框架： Oxygen 9N-LLM生成式推荐训练</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[断网、断电，不断数据——LoongCollector 极限边缘场景可靠采集方案]]></title>    <link>https://juejin.cn/post/7600223321041518598</link>    <guid>https://juejin.cn/post/7600223321041518598</guid>    <pubDate>2026-01-28T10:54:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600223321041518598" data-draft-id="7600240045366247478" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="断网、断电，不断数据——LoongCollector 极限边缘场景可靠采集方案"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2026-01-28T10:54:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            断网、断电，不断数据——LoongCollector 极限边缘场景可靠采集方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T10:54:15.000Z" title="Wed Jan 28 2026 10:54:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：林润骑(太业)</p>
<h2 data-id="heading-0">背景</h2>
<p>在云计算和物联网快速发展的今天，越来越多的业务场景将计算和数据采集能力推向了边缘侧。从智能制造的产线设备、新能源汽车的车载系统，到遍布各地的零售终端和智能家居设备，这些终端设备产生的可观测数据（日志、指标、追踪）对于业务运营、故障诊断和用户体验优化至关重要。</p>
<p>然而，终端设备的环境极其复杂：</p>
<ul>
<li><strong>网络环境不稳定</strong>：终端设备常常运行在弱网、间歇性断网的环境中。移动网络信号波动、WiFi连接不稳定、跨地域网络延迟高等问题普遍存在。</li>
<li><strong>电源供应不保障</strong>：许多终端设备依赖电池供电或面临意外断电风险。</li>
<li><strong>资源极度受限</strong>：边缘设备的 CPU、内存、存储、网络带宽都极为有限。</li>
</ul>
<p>在这种极限条件下的可观测数据采集面临极大的挑战。比如车辆在偏远地区行驶时，长时间处于弱网或断网状态，网络信号时断时续，车辆熄火断电时，内存中缓存的监控数据全部丢失；在隧道、地下停车场等场景下，数据采集中断，关键的故障诊断数据无法回传。</p>
<p>本文将详细介绍 LoongCollector 如何针对弱网、断电等边缘场景，提供完整的可靠采集解决方案。</p>
<h2 data-id="heading-1">终端设备可观测数据采集的三大挑战</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4500185babb649c89df8e0336a3a3035~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770202455&amp;x-signature=zQazKPmFk4R2M5Gew%2BXnZoT16tM%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-2">挑战一：复杂的网络环境</h3>
<p>终端设备运行环境的网络条件远比数据中心复杂：</p>
<ul>
<li><strong>弱网场景</strong>：移动网络信号不稳定、WiFi 信号弱、跨地域长链路等导致网络带宽低、延迟高、丢包率高。</li>
<li><strong>间歇性断网</strong>：设备移动、网络切换、临时性网络故障导致周期性网络中断。</li>
<li><strong>长时间离线</strong>：某些场景下设备需要长时间离线工作，积累大量待上传数据。</li>
</ul>
<p>比如车载终端设备在偏远地区运输途中，可能很长时间都处于弱网或断网状态，网络正常的状态很少；在车辆熄火或者维修的情况下，车载终端设备也会断电。</p>
<h3 data-id="heading-3">挑战二：可观测数据可靠交付</h3>
<p>在弱网、断电等不稳定环境下，保证数据的可靠交付和一致性是最大的挑战：</p>
<ul>
<li><strong>数据丢失风险</strong>：网络中断、设备断电、进程异常等都可能导致数据丢失。</li>
<li><strong>顺序性保障</strong>：时序数据（如指标、追踪）需要保持采集时的时间顺序。</li>
</ul>
<h3 data-id="heading-4">挑战三：网络带宽限制</h3>
<p>终端设备的网络带宽通常受到严格限制：</p>
<ul>
<li><strong>流量成本高</strong>：4G/5G 移动网络的流量费用远高于数据中心专线。</li>
<li><strong>带宽竞争</strong>：采集数据上传需要与业务数据传输竞争有限的带宽资源。</li>
<li><strong>上传速率限制</strong>：某些运营商或网络环境会对上传带宽进行限制。</li>
</ul>
<p>在这样的环境下，如何高效压缩数据、智能控制发送速率、避免带宽被采集流量占满，成为必须解决的问题。</p>
<h2 data-id="heading-5">LoongCollector：为边缘场景优化的可靠采集方案</h2>
<p>LoongCollector 是阿里云开源的高性能、高可靠可观测性数据采集器，在支撑阿里云内部千万级规模部署的同时，针对边缘场景进行了深度优化。</p>
<h3 data-id="heading-6">核心能力概览</h3>
<h4 data-id="heading-7">统一的可观测数据采集</h4>
<p>LoongCollector 提供了完整的可观测数据采集能力：</p>
<ul>
<li><strong>主机监控</strong>：实时采集 CPU、内存、磁盘、网络等系统指标，支持 100+ 系统指标项。</li>
<li><strong>Prometheus 协议</strong>：完全兼容 Prometheus 生态，可采集所有支持 Prometheus 采集的应用指标。</li>
<li><strong>日志采集</strong>：高效的文本日志采集能力，支持多种日志格式和解析方式。</li>
</ul>
<h4 data-id="heading-8">超低资源消耗</h4>
<p>针对资源受限的终端设备，LoongCollector 进行了极致的性能优化：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16a01dd3d2e54aca970f628f2af1b88a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770202455&amp;x-signature=0fGEug5a4OYWgzUNYE10L8uvW3M%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9103fa522cf346928a97517877e24750~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770202455&amp;x-signature=oTLfxB1X3y0UOhV%2BlbPPLfQVwMo%3D" alt="图片" loading="lazy"/></p>
<p>这意味着在相同的硬件条件下，LoongCollector 可以支持更多的采集任务，或者在资源更受限的设备上稳定运行。</p>
<h4 data-id="heading-9">企业级稳定性保障</h4>
<ul>
<li><strong>生产级验证</strong>：支撑阿里云内部 1000 万+ 实例的可观测数据采集。</li>
<li><strong>高可用性</strong>：单实例高可用性，支持故障自恢复。</li>
<li><strong>久经考验</strong>：经历多年双11大促、突发流量等极端场景验证。</li>
</ul>
<h4 data-id="heading-10">解决方案架构：数据持久化 + 异步发送 + 智能重试</h4>
<p>针对弱网、断电、断网等边缘场景，LoongCollector 采用了“数据持久化 + 异步发送 + 智能重试”的核心架构设计。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24cbf89967834e54ad87b213785299dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770202455&amp;x-signature=JpPdtpyccKtfy62dw7AznR%2FRXgU%3D" alt="图片" loading="lazy"/></p>
<p><strong>分离采集与发送</strong>：将数据采集和网络发送完全解耦，采集过程不受网络状态影响。</p>
<p><strong>本地持久化</strong>：日志数据天然具备本地持久化的能力。此处主要指指标等无持久化能力的数据，此方案会将所有采集到的指标，先写入本地文件，确保断电、重启也不丢失。</p>
<p><strong>异步消费</strong>：独立的发送线程从持久化文件中读取数据并发送，失败时自动重试。</p>
<p><strong>智能反压</strong>：网络异常时，自动控制数据读取速度，避免内存占用过高。</p>
<h4 data-id="heading-11">指标数据落盘持久化</h4>
<p>传统的指标采集方案（如 Telegraf、Prometheus Pushgateway）通常将采集到的指标数据直接发送到服务端。这种架构在稳定网络环境下工作良好，但在边缘场景下存在致命缺陷：</p>
<ul>
<li><strong>断网丢数据</strong>：网络中断时，新采集的指标数据无法发送，只能丢弃或缓存在内存中。</li>
<li><strong>断电丢数据</strong>：设备意外断电时，内存中缓存的数据全部丢失。</li>
<li><strong>内存压力大</strong>：长时间断网时，内存缓存会迅速膨胀，最终导致 OOM。</li>
</ul>
<p>LoongCollector 创新性地将主机监控指标和 Prometheus 指标进行本地文件持久化，实现了指标数据的可靠存储：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f45664199264cfbab2e63dbae3b6d60~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770202455&amp;x-signature=x0%2FCwDhsKmQVNplKfoFkw7GJpQY%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>定时抓取主机和应用指标数据。</li>
<li>文本格式落盘到本地文件系统。</li>
<li>自动轮转机制，支持单文件大小和文件个数配置，保留最近固定格式的文件，自动删除过期文件，避免磁盘空间被历史数据占满。</li>
</ul>
<h4 data-id="heading-12">文件采集异步消费机制</h4>
<p>在持久化指标数据后，如何高效、可靠地将数据发送到服务端是下一个关键问题。传统方案面临的挑战包括：</p>
<ul>
<li><strong>发送阻塞采集</strong>：如果发送线程与采集线程耦合，网络慢会拖慢采集速度。</li>
<li><strong>顺序性保证</strong>：指标数据通常有时间顺序要求，需要确保按采集时间顺序发送。</li>
<li><strong>断点续传</strong>：网络恢复后，需要从断开位置继续发送，不能重复或遗漏。</li>
</ul>
<p>LoongCollector 采用了文件采集的方式来异步消费持久化的指标数据，<strong>关键技术点</strong>如下：</p>
<ul>
<li>Checkpoint 机制：LoongCollector 维护了细粒度的 checkpoint，记录每个文件的读取位置，这确保了即使在文件读取过程中进程崩溃或断电，重启后也能从断开位置继续读取，不会丢失数据。</li>
<li>文件顺序保证：通过文件轮转顺序，确保按采集时间顺序发送数据：
<ul>
<li>优先处理时间早的文件</li>
<li>同一时间段的文件按序号递增处理</li>
<li>支持使用原始数据中的时间，避免时间戳乱序导致的数据可视化问题</li>
</ul>
</li>
</ul>
<h4 data-id="heading-13">智能反压与流量控制</h4>
<p>在弱网环境下，如果不加控制地读取和发送数据，会导致：</p>
<ul>
<li><strong>内存占用激增</strong>：读取速度远大于发送速度，数据堆积在内存中。</li>
<li><strong>发送队列溢出</strong>：队列满后数据被丢弃或进程崩溃。</li>
<li><strong>带宽占满</strong>：采集流量占满带宽，影响业务正常通信。</li>
</ul>
<p>LoongCollector 实现了多层次的<strong>智能反压机制</strong>：</p>
<p>发送并发度自适应：借鉴 TCP 拥塞控制算法，LoongCollector 根据网络状态动态调整发送并发度，这种自适应机制确保了：</p>
<ul>
<li><strong>快速响应</strong>：网络正常时充分利用带宽，快速发送数据。</li>
<li><strong>快速收敛</strong>：网络异常时迅速降低发送频率，避免无效重试。</li>
<li><strong>自动恢复</strong>：网络恢复后自动增加并发，无需人工干预。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c61d8a6ba6f40479fded8125fce62a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770202455&amp;x-signature=oElLrHvNGqRuTf%2BZGfPQ%2FSS7EyE%3D" alt="图片" loading="lazy"/></p>
<ul>
<li><strong>队列反压</strong>：当发送队列积压达到阈值时，LoongCollector 会暂停文件读取，这避免了内存无限制增长，确保系统在长时间弱网环境下也能稳定运行。</li>
<li><strong>流量限速</strong>：LoongCollector 支持配置最大发送速率，避免采集流量影响业务 ilogtail_config.json：</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"max_bytes_per_sec"</span>: 1048576 <span class="hljs-comment"># 限制最大发送速率为 10MB/s</span>
}
</code></pre>
<h2 data-id="heading-14">LoongCollector 终端部署最佳实践</h2>
<p>这里以主机监控+一个应用的 Prometheus 采集为例。</p>
<h3 data-id="heading-15">LoongCollector 启动参数建议</h3>
<p>在 <code>/usr/local/ilogtail</code> 目录下修改 <code>ilogtail_config.json</code>。</p>
<p>a. 关闭丢弃旧数据 discard_old_data。</p>
<p>b. 调大与服务端断开连接重启的间隔 config_server_lost_connection_timeout，建议取 604800 秒，7 天。</p>
<p>c. 调大读取阻塞重启的间隔 force_quit_read_timeout，建议取 604800 秒，7 天。</p>
<p>d. 限制最大发送速率 max_bytes_per_sec。主机监控+一个 Java 应用的流量为 0.88KB/s，所以建议取 1MB/s，避免异常使用流量。</p>
<p>e. "working_ip", 在移动终端场景，IP 会不断变化，在机器上建议给固定 IP。</p>
<p><strong>ilogtail_config.json</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"discard_old_data"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"config_server_lost_connection_timeout"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">604800</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"force_quit_read_timeout"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">604800</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"max_bytes_per_sec"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1048576</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"cpu_usage_limit"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.4</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"mem_usage_limit"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">384</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"working_ip"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-16">采集配置</h3>
<h4 data-id="heading-17">本地配置-主机监控采集配置</h4>
<p>在 /etc/ilogtail/config/local 目录下创建例如 input_host_monitor.yaml 文件，将主机指标首先采集到本地文件路径下，例如 /usr/local/ilogtail/metrics/host.log。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">enable:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">inputs:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">input_host_monitor</span>
    <span class="hljs-attr">Interval:</span> <span class="hljs-number">15</span>
<span class="hljs-attr">flushers:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">flusher_file</span>
    <span class="hljs-attr">MaxFileSize:</span> <span class="hljs-number">104857600</span>
    <span class="hljs-attr">MaxFiles:</span> <span class="hljs-number">10</span>
    <span class="hljs-attr">FilePath:</span> <span class="hljs-string">/usr/local/ilogtail/metrics/host.log</span>
</code></pre>
<h4 data-id="heading-18">本地配置-自定义指标采集配置</h4>
<p>在 /etc/ilogtail/config/local 目录下创建例如 input_prometheus.yaml 文件，将主机指标首先采集到本地文件路径下，例如 /usr/local/ilogtail/metrics/metric.log。</p>
<p>input_prometheus.yaml</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">enable:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">inputs:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">input_prometheus</span>
    <span class="hljs-attr">ScrapeConfig:</span>
      <span class="hljs-attr">job_name:</span> <span class="hljs-string">node</span>
      <span class="hljs-string">host_only_mode:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">scrape_interval:</span> <span class="hljs-string">15s</span>
      <span class="hljs-attr">scrape_timeout:</span> <span class="hljs-string">10s</span>
      <span class="hljs-attr">static_configs:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">"localhost:12345"</span>]
<span class="hljs-attr">flushers:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">flusher_file</span>
    <span class="hljs-attr">MaxFileSize:</span> <span class="hljs-number">524288000</span>
    <span class="hljs-attr">MaxFiles:</span> <span class="hljs-number">10</span>
    <span class="hljs-attr">FilePath:</span> <span class="hljs-string">/usr/local/ilogtail/metrics/metric.log</span>
</code></pre>
<h4 data-id="heading-19">服务端管控配置-文件采集配置</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"aggregators"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"global"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"logSample"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"inputs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"Type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"input_file"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"FilePaths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
                <span class="hljs-string">"/usr/local/ilogtail/metrics/*.log"</span>
            <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"MaxDirSearchDepth"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"FileEncoding"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"utf8"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"EnableContainerDiscovery"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
        <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"processors"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"Type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"processor_parse_json_native"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"SourceKey"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"content"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"KeepingSourceWhenParseFail"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
        <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-20">注意事项</h3>
<ol>
<li>
<p>处理插件不要使用拓展插件，因为拓展插件会拉起 Golang 模块，导致内存占用升高。</p>
</li>
<li>
<p>移动终端场景，IP 会不断变化，机器组建议使用标识型机器组。</p>
</li>
</ol>
<h3 data-id="heading-21">LoongCollector 资源监控测试报告</h3>
<h4 data-id="heading-22">CPU：平均 0.02 核，峰值 0.028 核</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8fd6dfb56ac54768ab916d4aebc6e0e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770202455&amp;x-signature=Lx3Mym79JCgwPRqwnoTIz5%2FKIWQ%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-23">内存：平均 31.5MB，峰值 35MB</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9830b54760584a12b994a6c72772a7e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770202455&amp;x-signature=Q%2B9ZBMr%2F4t%2BYsFQCWfinHXk3WKA%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-24">网络：平均 1.07KB/s，峰值 1.10KB/s</h4>
<p>a. 压缩前：平均 12.99KB/s，峰值 13.13KB/s</p>
<p>b. 实际发送：平均 1.07KB/s，峰值 1.10KB/s</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8d6fda1425243cfb68fea39c7ca1145~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770202455&amp;x-signature=vdAiMSfiaL8x3fkrH3GkGFQ1pcg%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-25">磁盘：平均 6.07KB/s，峰值 13.03KB/s</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42de10e48e164f249baa780d3f073431~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770202455&amp;x-signature=8LS0dLHb9Xk4rmtcZvFmMtx5fY4%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-26">总结与展望</h2>
<p>边缘场景的可观测数据采集，是一个长期被低估的技术挑战。网络的不稳定性、电源的不可靠性、数据一致性的复杂性，让传统的采集方案在边缘环境下频繁失效。LoongCollector 通过“数据持久化 + 异步发送 + 智能重试”的创新架构，系统性地解决了这些问题：</p>
<ul>
<li>
<p>保证了可观测数据可靠交付</p>
<ul>
<li>本地持久化保证断网不丢数据</li>
<li>异步发送机制实现采集与发送解耦</li>
<li>智能重试和反压确保网络恢复后数据完整上传</li>
</ul>
</li>
<li>
<p>有效地进行了流量控制</p>
<ul>
<li>高效压缩减少传输数据量</li>
<li>智能流量控制避免带宽占满，影响业务</li>
</ul>
</li>
</ul>
<p>但是，LoongCollector 的采集方案还有更多的优化空间：</p>
<ol>
<li>
<p>当前的持久化采集方案需要配置两个 Pipeline（采集 Pipeline + 文件读取 Pipeline），虽然灵活但增加了用户的理解和配置成本。LoongCollector 正在进行流水线优化，支持单流水线内部持久化能力，方便用户配置。</p>
</li>
<li>
<p>终端设备对于 STS 鉴权是强需求，LoongCollector 正在适配阿里云 STS 动态鉴权，支持临时凭证自动刷新，避免终端 AccessKey 泄露风险。</p>
</li>
<li>
<p>在流量成本敏感的场景，每一个百分点的压缩率提升都意味着显著的成本节省，LoongCollector 也正在探索更加极致的压缩策略，进一步降低网络流量。</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[热更新中的HMR和React Fast Refresh]]></title>    <link>https://juejin.cn/post/7600032104248606783</link>    <guid>https://juejin.cn/post/7600032104248606783</guid>    <pubDate>2026-01-28T09:19:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600032104248606783" data-draft-id="7600032104248393791" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="热更新中的HMR和React Fast Refresh"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-28T09:19:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ximimimi"/> <meta itemprop="url" content="https://juejin.cn/user/3350967174040238"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            热更新中的HMR和React Fast Refresh
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3350967174040238/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ximimimi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T09:19:42.000Z" title="Wed Jan 28 2026 09:19:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">HRM</h2>
<p>是一个通用概念，由构建工具（如webpack、vite)提供，允许在不刷新页面的情况下替换、添加、删除模块</p>
<h2 data-id="heading-1">React Fast Refresh</h2>
<p>专门为HMR开发的特定实现，集成了react渲染引擎，确保在代码更新时能保持组件状态，
它和传统HRM相比，可以保持组件状态，容错性强，当代码中写了错误，Fast Refresh会显示错误弹窗，修复错误后能自动恢复并继续运行，无需手动刷新页面</p>
<ul>
<li>对于保持页面状态这个点，有时候可能会出现页面修改了，但是网页上没有变化</li>
</ul>
<pre><code class="hljs language-js" lang="js">    <span class="hljs-keyword">const</span> [data, setData] = <span class="hljs-title function_">useState</span>([])
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DATA</span> = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>, <span class="hljs-number">3</span>,<span class="hljs-number">4</span>]
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">getData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'xxx'</span>)
        <span class="hljs-title function_">setData</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">DATA</span>.<span class="hljs-title function_">map</span>(item)=&gt; {
                <span class="hljs-keyword">return</span> { <span class="hljs-attr">index</span>: item, <span class="hljs-attr">content</span>: res[item]}
            }
        })
    }
    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">getData</span>()
    },[])
 <span class="hljs-comment">// 在这个页面中修改DATA数据，网页状态也不会发生变化，因为要保持data这个useState状态不变</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[保姆级 SeaTunnel 入门！再学不会小编当场表演倒立敲代码]]></title>    <link>https://juejin.cn/post/7600242248860631080</link>    <guid>https://juejin.cn/post/7600242248860631080</guid>    <pubDate>2026-01-28T09:15:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600242248860631080" data-draft-id="7600216277426176034" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="保姆级 SeaTunnel 入门！再学不会小编当场表演倒立敲代码"/> <meta itemprop="keywords" content="大数据,开源,数据库"/> <meta itemprop="datePublished" content="2026-01-28T09:15:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="白鲸开源"/> <meta itemprop="url" content="https://juejin.cn/user/3870725052049454"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            保姆级 SeaTunnel 入门！再学不会小编当场表演倒立敲代码
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3870725052049454/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    白鲸开源
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T09:15:52.000Z" title="Wed Jan 28 2026 09:15:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://openwrite-whaleops.oss-cn-zhangjiakou.aliyuncs.com/2026/01/27/seatunnel-xin-shou.png" alt="SeaTunnel 新手" loading="lazy"/></p>
<p>欢迎来到 Apache SeaTunnel 的世界！这份文档旨在帮助新手快速了解 SeaTunnel 的核心功能、基本架构，并完成第一个数据同步任务。</p>
<h2 data-id="heading-0">1. 什么是 Apache SeaTunnel？</h2>
<p>Apache SeaTunnel 是一个非常易于使用、高性能、支持实时流式和离线批处理的海量数据集成平台。它的目标是解决常见的数据集成问题，如数据源多样性、同步场景复杂性以及资源消耗高的问题。</p>
<h3 data-id="heading-1">核心特性</h3>
<ul>
<li><strong>丰富的数据源支持</strong>：支持 100+ 种 Connector，涵盖主流数据库、云存储、SaaS 服务等。</li>
<li><strong>批流一体</strong>：同一套 Connector 代码同时支持批处理（离线）和流处理（实时）。</li>
<li><strong>高性能</strong>：支持多引擎（Zeta, Flink, Spark），提供高吞吐、低延迟的数据同步能力。</li>
<li><strong>简单易用</strong>：通过简单的配置文件（Config）即可定义复杂的数据同步任务。</li>
</ul>
<h2 data-id="heading-2">2. 架构与环境</h2>
<h3 data-id="heading-3">2.1 架构图</h3>
<p>SeaTunnel 采用了解耦的设计架构，Source、Transform、Sink 插件与具体的执行引擎（Engine）是分离的。</p>
<p><img src="https://openwrite-whaleops.oss-cn-zhangjiakou.aliyuncs.com/2026/01/27/st-architecture.png" alt="ST architecture" loading="lazy"/></p>
<h3 data-id="heading-4">2.2 操作系统支持</h3>
<p>SeaTunnel 基于 Java 开发，理论上支持所有安装了 JDK 的操作系统。</p>




















<table><thead><tr><th align="left">操作系统</th><th align="left">适用场景</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left"><strong>Linux</strong> (CentOS, Ubuntu, etc.)</td><td align="left"><strong>生产环境</strong> (推荐)</td><td align="left">稳定性高，适合长期运行服务。</td></tr><tr><td align="left"><strong>macOS</strong></td><td align="left">开发/测试</td><td align="left">适合开发者本地调试和编写 Config。</td></tr></tbody></table>
<h3 data-id="heading-5">2.3 环境准备</h3>
<p>在开始安装 SeaTunnel 之前，请确保你的环境满足以下要求：</p>
<ul>
<li><strong>JDK 版本</strong>：必须安装 <strong>Java 8</strong> 或 <strong>Java 11</strong>。
<ul>
<li>可以通过命令 <code>java -version</code> 检查。</li>
<li>确保设置了 <code>JAVA_HOME</code> 环境变量。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-6">3. 核心组件深度解析</h2>
<p>在使用 SeaTunnel 之前，深入理解其核心组件的内部机制有助于你更好地调优和排查问题。</p>
<h3 data-id="heading-7">3.1 Source (数据源)</h3>
<p>Source 负责从外部系统读取数据，并将其转换为 SeaTunnel 内部的行格式（SeaTunnelRow）。</p>
<ul>
<li><strong>Enumerator (枚举器)</strong>：运行在 Master 节点（Coordinator）。负责发现数据分片（Splits）。例如，在 JDBC Source 中，Enumerator 会根据 <code>partition_column</code> 的最大值和最小值计算出多个查询范围（Splits）。</li>
<li><strong>Reader (读取器)</strong>：运行在 Worker 节点。负责接收 Enumerator 分配的 Splits，并真正执行读取操作。多个 Reader 并行工作，极大提高了读取效率。</li>
<li><strong>Checkpoint 支持</strong>：对于流式作业，Source 还需要支持状态保存（如 Kafka 的 Offset），以便在故障恢复时实现断点续传。</li>
</ul>
<h3 data-id="heading-8">3.2 Transform (数据转换)</h3>
<p>Transform 负责在数据从 Source 流向 Sink 的过程中对数据进行处理。</p>
<ul>
<li><strong>无状态转换</strong>：大多数 Transform（如 <code>Sql</code>, <code>Filter</code>, <code>Replace</code>）是无状态的，即处理当前行不需要依赖其他行的数据。</li>
<li><strong>Schema 变更</strong>：Transform 可以改变数据的 Schema（增加、删除、修改字段），下游 Sink 会感知到这种变化。</li>
</ul>
<h3 data-id="heading-9">3.3 Sink (数据目标)</h3>
<p>Sink 负责将 SeaTunnel 处理后的数据写入到外部系统。</p>
<ul>
<li><strong>Writer (写入器)</strong>：运行在 Worker 节点。负责将数据写入目标系统。通常支持批量写入以提高吞吐量。</li>
<li><strong>Committer (提交器)</strong>：运行在 Master 节点（可选）。对于支持事务的 Sink（如文件系统、Iceberg），需要一个全局的 Committer 来在 Checkpoint 完成时统一提交事务（二阶段提交），从而实现 <strong>Exactly-Once</strong>（精确一次）语义。</li>
</ul>
<h3 data-id="heading-10">3.4 执行流程</h3>
<ol>
<li><strong>解析配置</strong>：SeaTunnel 解析配置文件，构建逻辑执行计划。</li>
<li><strong>资源分配</strong>：Master 节点根据并行度申请资源。</li>
<li><strong>任务分发</strong>：Enumerator 生成分片，分发给 Reader。</li>
<li><strong>数据流转</strong>：<code>Reader -&gt; Transform -&gt; Writer</code>。</li>
<li><strong>状态提交</strong>：周期性触发 Checkpoint，保存状态并提交事务。</li>
</ol>
<h2 data-id="heading-11">4. 支持的 Connector 及其优缺点分析</h2>
<p>SeaTunnel 支持超过 100 种 Connector，以下是几类最常用的 Connector 及其特性分析：</p>
<h3 data-id="heading-12">4.1 关系型数据库 (JDBC)</h3>
<p><strong>支持列表</strong>: MySQL, PostgreSQL, Oracle, SQLServer, DB2, Teradata, Dameng(达梦), OceanBase, TiDB 等。</p>
<ul>
<li><strong>优点</strong>：
<ul>
<li><strong>通用性强</strong>：只要有 JDBC 驱动即可连接几乎所有 SQL 数据库。</li>
<li><strong>功能完善</strong>：支持列投影（只读部分列）、并行读取（基于 <code>partition_column</code> 切分）、Exactly-Once（取决于实现）。</li>
<li><strong>自动建表</strong>：部分 Connector 支持在目标端自动创建表结构。</li>
</ul>
</li>
<li><strong>缺点</strong>：
<ul>
<li><strong>性能瓶颈</strong>：受限于 JDBC 协议和单机驱动性能，超大规模数据读取可能需要精细调优（如 <code>fetch_size</code>）。</li>
<li><strong>源库压力</strong>：如果并行度设置过高，可能打满源库连接池或 CPU。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-13">4.2 消息队列</h3>
<p><strong>支持列表</strong>: Kafka, Pulsar, RocketMQ, Amazon DynamoDB Streams 等。</p>
<ul>
<li><strong>优点</strong>：
<ul>
<li><strong>高吞吐</strong>：天生适合大规模流数据处理，支持削峰填谷。</li>
<li><strong>格式丰富</strong>：支持 JSON, Avro, Protobuf, Canal-JSON, Debezium-JSON 等多种序列化格式。</li>
<li><strong>Exactly-Once</strong>：支持端到端的精确一次语义（依赖 Checkpoint 机制）。</li>
</ul>
</li>
<li><strong>缺点</strong>：
<ul>
<li><strong>配置复杂</strong>：涉及 Offset 管理、序列化 Schema 配置、Consumer Group 管理等。</li>
<li><strong>数据可见性</strong>：相比数据库，数据在 Topic 中不够直观，调试稍显麻烦。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-14">4.3 变更数据捕获 (CDC)</h3>
<p><strong>支持列表</strong>: MySQL-CDC, PostgreSQL-CDC, Oracle-CDC, MongoDB-CDC, SQLServer-CDC, TiDB-CDC 等。</p>
<ul>
<li><strong>优点</strong>：
<ul>
<li><strong>实时性</strong>：毫秒级捕获数据库增删改操作。</li>
<li><strong>无锁读取</strong>：SeaTunnel 的 CDC 实现了无锁并行快照算法，极大降低了对源库的影响。</li>
<li><strong>断点续传</strong>：支持从 Binlog/WAL 指定位置恢复。</li>
<li><strong>Schema Evolution</strong>：支持表结构变更同步（部分支持）。</li>
</ul>
</li>
<li><strong>缺点</strong>：
<ul>
<li><strong>权限要求</strong>：通常需要较高的数据库权限（如 REPLICATION SLAVE）。</li>
<li><strong>依赖日志</strong>：源库必须开启 Binlog（或 WAL），且保留时间需足够长。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-15">4.4 文件系统 &amp; 云存储</h3>
<p><strong>支持列表</strong>: LocalFile, HDFS, S3, OSS, GCS, FTP, SFTP 等。</p>
<ul>
<li><strong>优点</strong>：
<ul>
<li><strong>海量存储</strong>：适合数据湖场景，成本低廉。</li>
<li><strong>格式支持</strong>：原生支持 Parquet, ORC, Avro, JSON, CSV, Excel, Text 等。</li>
<li><strong>压缩支持</strong>：支持 Snappy, Gzip, Lzo 等多种压缩算法。</li>
</ul>
</li>
<li><strong>缺点</strong>：
<ul>
<li><strong>小文件问题</strong>：流式写入时，如果 Checkpoint 间隔太短，容易产生大量小文件（SeaTunnel 有文件合并功能但会增加复杂度）。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-16">4.5 NoSQL &amp; 其他</h3>
<p><strong>支持列表</strong>: Elasticsearch, Redis, MongoDB, Cassandra, HBase, InfluxDB, ClickHouse, Doris, StarRocks 等。</p>
<ul>
<li><strong>特点</strong>：针对各数据库特性进行了优化，例如 ClickHouse/StarRocks 支持 Stream Load 高速导入，Elasticsearch 支持批量写入。</li>
</ul>
<h2 data-id="heading-17">5. Transform 实战演练 (附带详细注释)</h2>
<p>Transform 插件用于在 Source 和 Sink 之间处理数据。以下是几个常用 Transform 的配置示例。</p>
<h3 data-id="heading-18">5.1 Sql Transform (最推荐)</h3>
<p>使用 SQL 语法对数据进行处理，支持重命名、计算、常量添加、过滤等。</p>
<pre><code class="hljs language-hocon" lang="hocon">transform {
  Sql {
    # 输入表名，必须与 Source 的 result_table_name 一致
    plugin_input = "fake"
    # 输出表名，供后续 Transform 或 Sink 使用
    plugin_output = "fake_sql"
    
    # SQL 查询语句
    # 1. name as full_name: 字段重命名
    # 2. age + 1: 数值计算
    # 3. 'US' as country: 增加常量列
    # 4. where age &gt; 10: 数据过滤
    query = "select name as full_name, age + 1 as next_year_age, 'US' as country from fake where age &gt; 10"
  }
}
</code></pre>
<h3 data-id="heading-19">5.2 Filter Transform</h3>
<p>用于删除或保留指定字段（注意：不是过滤行，是过滤列/字段）。</p>
<pre><code class="hljs language-hocon" lang="hocon">transform {
  Filter {
    plugin_input = "fake"
    plugin_output = "fake_filter"
    
    # 仅保留 name 和 age 字段，其他字段会被丢弃
    include_fields = ["name", "age"]
    
    # 或者使用 exclude_fields 删除指定字段
    # exclude_fields = ["card"]
  }
}
</code></pre>
<h3 data-id="heading-20">5.3 Replace Transform</h3>
<p>用于字符串替换，支持正则表达式。</p>
<pre><code class="hljs language-hocon" lang="hocon">transform {
  Replace {
    plugin_input = "fake"
    plugin_output = "fake_replace"
    
    # 需要替换的字段名
    replace_field = "name"
    # 匹配模式（旧字符串）
    pattern = " "
    # 替换后的字符串（新字符串）
    replacement = "_"
    # 是否使用正则表达式，这里设为 true，表示 pattern 是一个正则
    is_regex = true
    # 是否只替换第一个匹配项
    replace_first = true
  }
}
</code></pre>
<h3 data-id="heading-21">5.4 Split Transform</h3>
<p>将一个字符串字段拆分为多个字段。</p>
<pre><code class="hljs language-hocon" lang="hocon">transform {
  Split {
    plugin_input = "fake"
    plugin_output = "fake_split"
    
    # 分隔符，这里使用空格
    separator = " "
    # 需要拆分的源字段
    split_field = "name"
    # 拆分后生成的新字段名列表
    output_fields = ["first_name", "last_name"]
  }
}
</code></pre>
<h2 data-id="heading-22">6. 快速安装</h2>
<p>对于新手，推荐直接下载编译好的二进制发行包进行体验。</p>
<h3 data-id="heading-23">步骤 1: 下载</h3>
<p>前往 <a href="https://link.juejin.cn?target=https%3A%2F%2Fseatunnel.apache.org%2Fdownload" target="_blank" title="https://seatunnel.apache.org/download" ref="nofollow noopener noreferrer">SeaTunnel 下载页面</a> 下载最新版本的二进制包（例如 <code>apache-seatunnel-2.3.x-bin.tar.gz</code>）。</p>
<h3 data-id="heading-24">步骤 2: 解压</h3>
<pre><code class="hljs language-bash" lang="bash">tar -xzvf apache-seatunnel-2.3.x-bin.tar.gz
<span class="hljs-built_in">cd</span> apache-seatunnel-2.3.x
</code></pre>
<h3 data-id="heading-25">步骤 3: 安装 Connector 插件</h3>
<p>SeaTunnel 的 Connector 是插件化的。首次使用需要下载插件：</p>
<pre><code class="hljs language-bash" lang="bash">sh bin/install-plugin.sh
</code></pre>
<p><em>注意：该命令会根据 <code>config/plugin_config</code> 文件中的配置，从 Maven 中央仓库下载常用插件（如 <code>connector-fake</code>, <code>connector-console</code> 等）。如果下载速度慢，请耐心等待或配置 Maven 镜像。</em></p>
<h4 data-id="heading-26">💡 技巧：配置 Maven 国内镜像加速下载</h4>
<p>如果遇到下载速度极慢或超时失败的情况，建议配置 Maven 阿里云镜像。</p>
<ol>
<li>找到或创建 Maven 配置文件：<code>~/.m2/settings.xml</code> (Windows 下为 <code>C:\Users\你的用户名\.m2\settings.xml</code>)。</li>
<li>添加如下镜像配置：</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">settings</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">mirrors</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">mirror</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>aliyunmaven<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">mirrorOf</span>&gt;</span>*<span class="hljs-tag">&lt;/<span class="hljs-name">mirrorOf</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>阿里云公共仓库<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://maven.aliyun.com/repository/public<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">mirror</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">mirrors</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">settings</span>&gt;</span>
</code></pre>
<p>保存后再次运行 <code>sh bin/install-plugin.sh</code> 即可享受高速下载。</p>
<h2 data-id="heading-27">7. 实战：第一个 SeaTunnel 任务</h2>
<p>我们将创建一个简单的任务：生成一些随机数据（FakeSource），并将其打印到控制台（Console Sink）。</p>
<h3 data-id="heading-28">步骤 1: 创建配置文件</h3>
<p>在 <code>config</code> 目录下创建一个名为 <code>hello_world.conf</code> 的文件，内容如下：</p>
<pre><code class="hljs language-hocon" lang="hocon">env {
  # 并行度设置：决定了有多少个线程同时执行任务。
  # 设置为 1 表示单线程执行，适合测试；生产环境可根据资源调大。
  parallelism = 1
  # 作业模式：
  # BATCH (批处理)：一次性处理完数据后结束（如离线同步）。
  # STREAMING (流处理)：持续运行，实时处理数据（如实时同步）。
  job.mode = "BATCH"
}

source {
  # FakeSource 是一个虚拟数据源，用于生成测试数据
  FakeSource {
    # result_table_name: 将此数据源产生的数据注册为一个临时表，表名为 "fake"
    # 后续的 Transform 或 Sink 可以通过这个名字引用这份数据
    result_table_name = "fake"
    
    # row.num: 指定生成数据的总行数，这里生成 16 行数据
    row.num = 16
    
    # schema: 定义数据的结构（字段名和类型）
    schema = {
      fields {
        name = "string" # 定义一个名为 name 的字符串字段
        age = "int"     # 定义一个名为 age 的整型字段
      }
    }
  }
}

transform {
  # Sql Transform: 使用 SQL 语句对数据进行处理
  Sql {
    # plugin_input: 指定输入数据来源，这里引用了 Source 中定义的 "fake" 表
    plugin_input = "fake"
    
    # plugin_output: 指定处理后的结果表名，命名为 "fake_transformed"
    # 下游的 Sink 将使用这个名字来获取处理后的数据
    plugin_output = "fake_transformed"
    
    # query: 执行的 SQL 查询语句
    # 这里演示了选择 name 和 age 字段，并新增一个常量字段 new_field
    query = "select name, age, 'new_field_val' as new_field from fake"
  }
}

sink {
  # Console Sink: 将数据输出打印到控制台（标准输出）
  Console {
    # plugin_input: 指定要输出的数据来源，这里引用了 Transform 输出的 "fake_transformed" 表
    plugin_input = "fake_transformed"
  }
}
</code></pre>
<h3 data-id="heading-29">步骤 2: 运行任务</h3>
<p>使用 SeaTunnel 自带的 Zeta 引擎运行该任务。</p>
<p><strong>执行命令：</strong></p>
<pre><code class="hljs language-bash" lang="bash">./bin/seatunnel.sh --config ./config/hello_world.conf -e <span class="hljs-built_in">local</span>
</code></pre>
<p><strong>命令详解：</strong></p>
<ul>
<li><code>./bin/seatunnel.sh</code>: 启动脚本，默认使用 Zeta 引擎。</li>
<li><code>--config</code> (或 <code>-c</code>): 指定配置文件的路径。这里我们指定了刚才创建的 <code>hello_world.conf</code>。</li>
<li><code>-e local</code> (或 <code>-m local</code>): 指定执行模式。
<ul>
<li><code>local</code>: 本地模式。SeaTunnel 会在当前进程中启动一个轻量级的 Zeta 引擎集群来运行任务，任务结束后集群关闭。<strong>适合开发和测试</strong>。</li>
<li><code>cluster</code>: 集群模式。任务会提交到已经运行的 SeaTunnel 集群中执行。<strong>适合生产环境</strong>。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-30">步骤 3: 查看结果与日志分析</h3>
<p>任务启动后，终端会输出大量日志。我们需要关注以下关键信息：</p>
<ol>
<li>
<p><strong>任务提交成功</strong>：
看到 <code>Job execution started</code> 表示配置文件解析通过，任务已提交给引擎。</p>
</li>
<li>
<p><strong>数据处理过程</strong>：
由于我们使用的是 <code>Console</code> Sink，数据会直接打印在日志中。你应能看到类似如下的输出：</p>
<pre><code class="hljs language-text" lang="text">...
INFO  ...ConsoleSinkWriter - subtaskIndex=0 rowIndex=1: SeaTunnelRow#tableId=-1 SeaTunnelRow#kind=INSERT: CpiOd, 12345, new_field_val
INFO  ...ConsoleSinkWriter - subtaskIndex=0 rowIndex=2: SeaTunnelRow#tableId=-1 SeaTunnelRow#kind=INSERT: eQqTs, 67890, new_field_val
...
</code></pre>
<ul>
<li><code>subtaskIndex</code>: 并行任务的编号。</li>
<li><code>rowIndex</code>: 当前处理的行号。</li>
<li><code>SeaTunnelRow</code>: 打印出的具体数据内容。</li>
</ul>
</li>
<li>
<p><strong>任务结束</strong>：
最后看到 <code>Job Execution Status: FINISHED</code> 表示任务执行成功结束。</p>
</li>
</ol>
<h3 data-id="heading-31">8. 常见问题排查 (Troubleshooting)</h3>
<p>如果在运行过程中遇到报错，请参考以下常见问题进行排查：</p>
<h4 data-id="heading-32">🔴 问题 1: <code>command not found: java</code> 或 <code>JAVA_HOME is not set</code></h4>
<ul>
<li><strong>现象</strong>：运行脚本时直接报错，提示找不到 Java。</li>
<li><strong>原因</strong>：环境未安装 Java 或未配置环境变量。</li>
<li><strong>解决</strong>：
<ol>
<li>运行 <code>java -version</code> 确认 Java 8 或 11 已安装。</li>
<li>设置环境变量：<code>export JAVA_HOME=/path/to/your/java</code> (建议写入 <code>~/.bashrc</code> 或 <code>~/.zshrc</code>)。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-33">🔴 问题 2: <code>Exception in thread "main" ... ClassNotFoundException</code></h4>
<ul>
<li><strong>现象</strong>：报错提示找不到某个类，例如 <code>ClassNotFoundException: org.apache.seatunnel.connectors.seatunnel.fake.source.FakeSourceFactory</code>。</li>
<li><strong>原因</strong>：<strong>Connector 插件未安装</strong>。默认包中只有引擎核心，没有包含具体的数据源插件。</li>
<li><strong>解决</strong>：
<ul>
<li>确保你执行过 <code>sh bin/install-plugin.sh</code>。</li>
<li>检查 <code>connectors/seatunnel</code> 目录下是否有对应的 jar 包（例如 <code>connector-fake-*.jar</code>）。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-34">🔴 问题 3: <code>Config file not valid</code> 或 <code>HOCONSyntaxError</code></h4>
<ul>
<li><strong>现象</strong>：提示配置文件格式错误。</li>
<li><strong>原因</strong>：<code>hello_world.conf</code> 中的括号 <code>{}</code> 不匹配，或者关键字拼写错误。</li>
<li><strong>解决</strong>：仔细检查配置文件语法。SeaTunnel 使用 HOCON 格式，确保每一层级的 <code>{</code> 和 <code>}</code> 都是成对出现的。</li>
</ul>
<h4 data-id="heading-35">🔴 问题 4: 任</h4></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[阿里云 Serverless 计算 12 月产品动态]]></title>    <link>https://juejin.cn/post/7600060691349995562</link>    <guid>https://juejin.cn/post/7600060691349995562</guid>    <pubDate>2026-01-28T09:24:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600060691349995562" data-draft-id="7600032104248590399" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="阿里云 Serverless 计算 12 月产品动态"/> <meta itemprop="keywords" content="Serverless"/> <meta itemprop="datePublished" content="2026-01-28T09:24:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            阿里云 Serverless 计算 12 月产品动态
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T09:24:09.000Z" title="Wed Jan 28 2026 09:24:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>精选文章：</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580161%26idx%3D1%26sn%3D232b5753f53bfe445f0f10154751a438%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580161&amp;idx=1&amp;sn=232b5753f53bfe445f0f10154751a438&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">AgentScope 拥抱函数计算 FC，为 Agent 应用提供 Serverless 运行底座</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580473%26idx%3D1%26sn%3Daa429466282245bceb798eac163691a9%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580473&amp;idx=1&amp;sn=aa429466282245bceb798eac163691a9&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">一杯咖啡成本搞定多模态微调：FC DevPod + Llama-Factory 极速实战</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580646%26idx%3D1%26sn%3D840d2fcc0e99bd012b89efdf86ae8c59%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580646&amp;idx=1&amp;sn=840d2fcc0e99bd012b89efdf86ae8c59&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">一文看懂函数计算 AgentRun，让 Agentic AI 加速进入企业生产环境</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580842%26idx%3D1%26sn%3D7e76a3a3ada98f173700fd56e9e98a43%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580842&amp;idx=1&amp;sn=7e76a3a3ada98f173700fd56e9e98a43&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">AgentRun Sandbox SDK 正式开源！集成 LangChain 等主流框架，一键开启智能体沙箱新体验</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580910%26idx%3D1%26sn%3Ddc2fc3a2c2b9321b0051f3ff58ba3f89%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580910&amp;idx=1&amp;sn=dc2fc3a2c2b9321b0051f3ff58ba3f89&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">探秘 AgentRun丨通过无代码创建的 Agent，如何用高代码进行更新？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247581079%26idx%3D1%26sn%3De1c7b0e2a01904d12affa89c96d8c63b%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247581079&amp;idx=1&amp;sn=e1c7b0e2a01904d12affa89c96d8c63b&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">AgentRun 实战：快速构建 AI 舆情实时分析专家</a></p>
<h2 data-id="heading-0">产品最新消息</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b75e94fa942348e08d82caed00da0f36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197053&amp;x-signature=3QFXIaYvm1%2FRlwUONKL3scQSJ0g%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[少年你渴望变强吗？]]></title>    <link>https://juejin.cn/post/7600002531398647817</link>    <guid>https://juejin.cn/post/7600002531398647817</guid>    <pubDate>2026-01-28T09:28:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600002531398647817" data-draft-id="7599981538298691634" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="少年你渴望变强吗？"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-28T09:28:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="PBitW"/> <meta itemprop="url" content="https://juejin.cn/user/3048261967153544"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            少年你渴望变强吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3048261967153544/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    PBitW
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T09:28:31.000Z" title="Wed Jan 28 2026 09:28:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>昨天发了个<a href="https://juejin.cn/pin/7599604510366892070" target="_blank" title="https://juejin.cn/pin/7599604510366892070">沸点</a>，发现GPT可以根据之前的聊天，来生成图片！</p>
<p>那为什么不能根据之前的聊天来判断我现在最该做什么？学什么？以及处于什么阶段呢？</p>
<p>注意：</p>
<blockquote>
<p>GPT聊天越多越准确，菜鸟前几天刚删了一次聊天，真的服了 (ˉ▽ˉ；)...</p>
</blockquote>
<p>如果你感兴趣，你也可以这样问一下你的AI助手：</p>
<blockquote>
<p>你可以根据我之前问你的技术问题来告诉我，我现在处于什么等级？需要怎么提升吗？不要粉饰，直接诚实呈现。</p>
</blockquote>
<p>今天和GPT聊了一下，想知道自己薄弱点在哪里，也将GPT给菜鸟的学习方式总结一下分享给大家！</p>
<h3 data-id="heading-0">怎么提升？</h3>
<p>不是“多学点”，而是“换打法”</p>
<h4 data-id="heading-1">🔥 1️⃣ 强制训练「技术分层思维」</h4>
<p>以后你遇到问题，<strong>必须先问自己 3 个问题</strong>：</p>
<ol>
<li>这是 <strong>语言问题 / 框架问题 / 架构问题 / 产品问题</strong>？</li>
<li>如果我不解决，它会在 <strong>哪个阶段爆雷</strong>？</li>
<li>我现在解决，是 <strong>临时修补还是长期方案</strong>？</li>
</ol>
<p>你可以不马上答对，但<strong>必须逼自己想</strong>。</p>
<hr/>
<h4 data-id="heading-2">🔥 2️⃣ 开始像“负责人”一样思考</h4>
<p>你可以强制自己做一件事：</p>
<blockquote>
<p><strong>每个技术选择，都写一句“为什么不用其他方案”</strong></p>
</blockquote>
<p>哪怕只是脑内。</p>
<p>这是<strong>从中级到高级唯一有效的跳板</strong>。</p>
<hr/>
<h2 data-id="heading-3">问题</h2>
<p>我感觉我现在处于一个被AI代替的阶段，就是遇见问题AI大部分可以帮我解决，我只需要审查代码，然后技术总是当时学的时候一起敲了，也实现了，但是过一段时间就会忘记，但是感觉记代码不是很low吗？然后就是记性不好，看一本书，如果一天不看，可能又要重新看的这种感觉，这怎么才能变强？</p>
<h3 data-id="heading-4">一、关于「代码上传 GitHub → 忘了就回去 copy」这件事</h3>
<h4 data-id="heading-5">1️⃣ 现实世界的真相（不浪漫版）</h4>
<p><strong>绝大多数成熟工程师</strong>：</p>
<ul>
<li>
<p>不记自己三个月前写的代码</p>
</li>
<li>
<p>会去翻：</p>
<ul>
<li>GitHub</li>
<li>旧项目</li>
<li>历史 commit</li>
</ul>
</li>
<li>
<p>会 copy 自己的实现</p>
</li>
<li>
<p>会顺手改一改再用</p>
</li>
</ul>
<p>👉 <strong>这是专业行为，不是偷懒</strong></p>
<h2 data-id="heading-6">重点</h2>
<p>真正 low 的不是 copy，而是：</p>
<ul>
<li>不知道自己以前解决过这个问题</li>
<li>不知道“该不该 copy”</li>
<li>copy 了也不知道适不适合现在的场景</li>
</ul>
<hr/>
<h4 data-id="heading-7">2️⃣ “忘记 = 不常用”这个判断，大体是对的</h4>
<p>你说得非常关键的一句是：</p>
<blockquote>
<p>“忘记就表示不常用”</p>
</blockquote>
<p>这在工程上基本成立。</p>
<ul>
<li>
<p>高频知识 → 自然留下</p>
</li>
<li>
<p>低频知识 → 本来就应该外包给：</p>
<ul>
<li>文档</li>
<li>搜索</li>
<li>GitHub</li>
<li>AI</li>
</ul>
</li>
</ul>
<p>👉 <strong>人脑是缓存，不是数据库</strong></p>
<hr/>
<h4 data-id="heading-8">3️⃣ 但你现在隐约感觉不对的地方，其实在这里</h4>
<p>你焦虑的不是：</p>
<blockquote>
<p>“我忘了怎么写”</p>
</blockquote>
<p>而是：</p>
<blockquote>
<p>“我下次遇到类似问题，<strong>没办法自然联想到我之前学过/做过的东西</strong>”</p>
</blockquote>
<p>⚠️ 这才是核心问题。</p>
<h3 data-id="heading-9">二、如何训练“串联能力”（关键部分）</h3>
<h4 data-id="heading-10">🔥 第一步：强制给问题“贴标签”</h4>
<p>以后你遇到任何问题，不管会不会做，先问一句：</p>
<blockquote>
<p>“这个问题，本质属于哪一类？”</p>
</blockquote>
<p>常见标签其实不多：</p>
<ul>
<li>状态问题</li>
<li>边界问题</li>
<li>权限问题</li>
<li>生命周期问题</li>
<li>数据一致性问题</li>
<li>性能问题</li>
<li>可维护性问题</li>
</ul>
<p>📌 <strong>你只要贴对标签，就已经赢了一半</strong></p>
<hr/>
<h4 data-id="heading-11">🔥 第二步：建立「问题 → 模式」映射，而不是「问题 → 解法」</h4>
<p>你现在是：</p>
<blockquote>
<p>问题 A → 解法 A</p>
</blockquote>
<p>你要训练成：</p>
<blockquote>
<p>问题 A → 模式 X → 若干实现方式</p>
</blockquote>
<p>比如：</p>
<ul>
<li>表单回显失败<br/>
→ <strong>状态源不唯一</strong></li>
<li>弹窗关闭后数据异常<br/>
→ <strong>生命周期不一致</strong></li>
<li>请求乱飞<br/>
→ <strong>副作用未收敛</strong></li>
</ul>
<p>这样你下次再遇到：</p>
<ul>
<li>表单</li>
<li>弹窗</li>
<li>新业务</li>
</ul>
<p>👉 <strong>大脑会自动联想</strong></p>
<hr/>
<h4 data-id="heading-12">🔥 第三步：给自己一个硬规则</h4>
<blockquote>
<p><strong>凡是 AI 给的代码或者照着敲的代码，必须做一件事：</strong></p>
<p>👉 “删掉重写一遍（哪怕写得更丑）”</p>
</blockquote>
<h5 data-id="heading-13">注意</h5>
<blockquote>
<p>只重写那些 <strong>你不确定理解、可能无法迁移、或逻辑稍复杂的</strong>代码。</p>
</blockquote>
<p>不是为了炫技，而是为了：</p>
<ul>
<li>验证你是否<strong>理解</strong></li>
<li>强迫你<strong>组织逻辑</strong></li>
<li>找出你真正不会的点</li>
</ul>
<p><strong>能写出来 ≠ 能讲出来 ≠ 能迁移到别的场景</strong></p>
<hr/>
<h3 data-id="heading-14">三、你是不是“可以彻底不记代码”？ 答案是：几乎可以</h3>
<p>你只需要记住三样东西：</p>
<ol>
<li><strong>问题的类别</strong></li>
<li><strong>典型坑位</strong></li>
<li><strong>你的历史解决思路在什么仓库</strong></li>
</ol>
<p>剩下的：</p>
<ul>
<li>代码 → GitHub</li>
<li>写法 → 文档</li>
<li>细节 → AI</li>
</ul>
<p>这不是退化，而是<strong>专业化分工</strong>。</p>
<h3 data-id="heading-15">四、我给你一个非常实用的“思维升级练习”</h3>
<p>你可以从下周开始，只做这一件事：</p>
<blockquote>
<p><strong>每周选一个你已经写完的功能，用一句话总结：<br/>
“这是在解决一个什么类型的问题？”</strong></p>
</blockquote>
<p>比如：</p>
<ul>
<li>“这是一个状态源唯一性的问题”</li>
<li>“这是一个副作用收敛的问题”</li>
<li>“这是一个用户输入可信度的问题”</li>
</ul>
<p>只要你能说出来，<strong>编程思维就已经在形成了</strong>。</p>
<hr/>
<h2 data-id="heading-16">问题</h2>
<p>感觉我写的都是业务代码，怎么才能变强？我应该每天学什么？干什么？除了敲公司的业务代码</p>
<h3 data-id="heading-17">一、先把一个误区掐死：不是“业务代码低级”</h3>
<p>现实是：</p>
<blockquote>
<p><strong>99% 的工程师一辈子都在写业务代码。</strong></p>
</blockquote>
<p>高级工程师也写业务，只是：</p>
<ul>
<li>他在写业务的同时<br/>
👉 <strong>提炼结构</strong></li>
<li>他在实现需求的时候<br/>
👉 <strong>在设计“下次怎么办”</strong></li>
</ul>
<p>你现在的问题不是写业务，而是：</p>
<blockquote>
<p><strong>你每写一行业务，能力几乎不增长。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-18">二、什么东西真的会让你“变强”（核心认知）</h3>
<p>我给你一句非常关键的话：</p>
<blockquote>
<p><strong>技术成长 ≠ 接触更复杂的业务<br/>
技术成长 = 从业务中抽象出“稳定结构”</strong></p>
</blockquote>
<p>你现在写的是：</p>
<ul>
<li>某个页面</li>
<li>某个表单</li>
<li>某个流程</li>
</ul>
<p>而“变强”的人写的是：</p>
<ul>
<li><strong>数据流</strong></li>
<li><strong>状态边界</strong></li>
<li><strong>错误路径</strong></li>
<li><strong>职责划分</strong></li>
</ul>
<p>同一份业务，成长差距会非常大。</p>
<h3 data-id="heading-19">三、你现在最该补的，不是“新技术”，而是这三件事</h3>
<h4 data-id="heading-20">🔥 1️⃣ 从「完成需求」升级为「设计需求」</h4>
<p>你现在的默认心智模型是：</p>
<blockquote>
<p>PM 给需求 → 我想办法实现</p>
</blockquote>
<p>你要强制升级成：</p>
<blockquote>
<p>PM 给需求 →<br/>
我拆：</p>
<ul>
<li>核心数据是什么？</li>
<li>状态怎么流动？</li>
<li>哪些地方可能变？</li>
</ul>
</blockquote>
<p>📌 <strong>只要你开始在脑内拆这三步，你就已经和普通业务工程师拉开差距了。</strong></p>
<hr/>
<h4 data-id="heading-21">🔥 2️⃣ 学会给业务代码“分类”，而不是“记住”</h4>
<p>你现在觉得业务代码没用，是因为：</p>
<blockquote>
<p><strong>每一段代码在你脑中都是“独立个体”</strong></p>
</blockquote>
<p>你要做的是：把它们归类。</p>
<p><strong>典型业务其实就这几类：</strong></p>
<ul>
<li>CRUD + 校验</li>
<li>多状态流程</li>
<li>列表 ↔ 详情 ↔ 编辑</li>
<li>权限 &amp; 可见性</li>
<li>异步流程 + 错误兜底</li>
</ul>
<p>📌 一旦你意识到：</p>
<blockquote>
<p>“哦，这又是一个老模式”</p>
</blockquote>
<p>你就在升级。</p>
<hr/>
<h4 data-id="heading-22">🔥 3️⃣ 把“公司业务”当成“训练素材”</h4>
<p>这是很多人<strong>一辈子都没意识到的点</strong>。</p>
<p>公司业务不是阻碍你成长的东西，<strong>它是免费的训练场</strong>。</p>
<p>但你必须多做一步：</p>
<blockquote>
<p>每写完一个功能，<br/>
问一句：<br/>
<strong>“如果下个项目也有这个需求，我会怎么提前设计？”</strong></p>
</blockquote>
<h3 data-id="heading-23">四、你每天到底该干什么？（不空谈）</h3>
<h4 data-id="heading-24">🟢 每天 30 分钟即可（真的够）</h4>
<p>✅ 1️⃣ 15 分钟：<strong>拆今天的业务</strong></p>
<p>不是写代码，是想：</p>
<ul>
<li>
<p>今天这个需求：</p>
<ul>
<li>状态有几个？</li>
<li>数据源在哪？</li>
<li>哪些地方最容易炸？</li>
</ul>
</li>
</ul>
<p>👉 不写文档，只在脑子里过一遍。</p>
<hr/>
<p>✅ 2️⃣ 10 分钟：<strong>反向总结一个点</strong></p>
<p>选今天代码里的一个小点：</p>
<ul>
<li>一个 if</li>
<li>一个 watch</li>
<li>一个接口处理</li>
</ul>
<p>问一句：</p>
<blockquote>
<p>“它在解决什么类型的问题？”</p>
</blockquote>
<p>📌 一天一个就够。</p>
<hr/>
<h4 data-id="heading-25">🔥 每周只做一件事（30～60 分钟）</h4>
<blockquote>
<p><strong>拿一个你已经完成的业务功能，重新审视它</strong></p>
</blockquote>
<p>不改代码，只回答三个问题：</p>
<ol>
<li>如果规模扩大 10 倍，会炸在哪？</li>
<li>哪个部分最不通用？</li>
<li>哪个地方其实可以抽象？</li>
</ol>
<p>这比学 10 篇博客都强。</p>
<h3 data-id="heading-26">五、那我还要不要“学新技术”？要，但顺序要对</h3>
<h4 data-id="heading-27">❌ 不要这样学：</h4>
<ul>
<li>随机刷技术文章</li>
<li>看到什么火学什么</li>
</ul>
<h4 data-id="heading-28">✅ 正确方式是：</h4>
<blockquote>
<p><strong>用你现在的业务，去“逼”技术出现</strong></p>
</blockquote>
<p>比如：</p>
<ul>
<li>表单太乱 → 学状态建模</li>
<li>逻辑太散 → 学组合式 API / hooks 设计</li>
<li>错误处理到处都是 → 学错误分层</li>
</ul>
<p>📌 技术不是学来的，是被问题“逼”出来的。</p>
<hr/>
<h2 data-id="heading-29">问题</h2>
<p>遇见一个问题，不知道怎么解决，就是不知道怎么思考，就算思考出来了，也不知道是不是正统解决办法，这种怎么搞？</p>
<h3 data-id="heading-30">一、为什么你会有这种感觉</h3>
<p>你描述的症状：</p>
<ol>
<li>遇到问题 → 不知道怎么入手</li>
<li>思考出来 → 不确定是否“正统”</li>
<li>经常靠“敲出来试”或“参考别人”</li>
</ol>
<p>背后的本质是：</p>
<h4 data-id="heading-31">1️⃣ 缺乏<strong>问题结构化思维</strong></h4>
<p>你现在看到的问题是“具体实例”，脑子里缺少<strong>抽象模型</strong>。</p>
<ul>
<li>
<p>例子：</p>
<ul>
<li>“为什么这个表单回显不对？”<br/>
→ 你只看到“字段不对”，而不是“数据源状态流不一致”</li>
<li>“接口返回异常怎么办？”<br/>
→ 你只看到“报错”，而不是“错误类型 → 错误分层 → 兜底策略”</li>
</ul>
</li>
</ul>
<h4 data-id="heading-32">2️⃣ 缺乏“方案判断标准”</h4>
<p>你不知道一个方案是不是正统，不是因为你菜，而是<strong>没有评价标准</strong>。</p>
<ul>
<li>
<p>正统解决方案 = 在<strong>边界条件、性能、可维护性、团队约定</strong>下最稳健的方案</p>
</li>
<li>
<p>你现在判断标准只有：</p>
<ul>
<li>“能不能实现？”</li>
<li>“能不能跑通？”</li>
</ul>
</li>
</ul>
<hr/>
<h4 data-id="heading-33">3️⃣ 依赖执行经验，而非思维经验</h4>
<p>你更擅长<strong>敲代码、试错、看报错</strong>，但不擅长<strong>在脑子里模拟问题和方案</strong></p>
<ul>
<li>
<p>工程师成长的阶梯：</p>
<ol>
<li>会写 → 能跑通</li>
<li>会思考 → 能预判问题</li>
<li>会抽象 → 能设计方案</li>
</ol>
</li>
</ul>
<p>你还停在 2 阶和 3 阶的交界。</p>
<h3 data-id="heading-34">二、怎么训练自己解决这种“不知道怎么解决”的问题</h3>
<p>我给你一个非常实用的方法论：<strong>三步法</strong></p>
<h4 data-id="heading-35">🔹 第一步：问题拆解法（先理清问题）</h4>
<blockquote>
<p>遇到问题 → 不管怎么实现，先拆成几个维度：</p>
</blockquote>
<ol>
<li>
<p><strong>问题本质</strong></p>
<ul>
<li>数据问题？状态问题？渲染问题？异步流程？权限问题？</li>
<li>例：表单回显错 → 数据源不唯一 → 状态问题</li>
</ul>
</li>
<li>
<p><strong>边界条件</strong></p>
<ul>
<li>会在哪些场景炸？</li>
<li>例：空数组 / null / 缓存未刷新 / 异步延迟</li>
</ul>
</li>
<li>
<p><strong>依赖和约束</strong></p>
<ul>
<li>现有框架、团队约定、性能要求、业务逻辑</li>
</ul>
</li>
</ol>
<p>📌 先做这个拆解，再去思考方案，比直接想着“怎么实现”强 10 倍。</p>
<h4 data-id="heading-36">🔹 第二步：方案生成法（先生成，再挑）</h4>
<blockquote>
<p>不急着敲代码，先列方案：</p>
</blockquote>
<ul>
<li>
<p>先在脑子里或者纸上写出 <strong>3~5 种可行方案</strong></p>
</li>
<li>
<p>对每个方案标注：</p>
<ol>
<li>实现难度</li>
<li>边界处理复杂度</li>
<li>可维护性</li>
<li>潜在坑位</li>
</ol>
</li>
<li>
<p>例：表单回显问题</p>
<ul>
<li>A：在组件 mounted 后 setTimeout 再赋值</li>
<li>B：统一使用 reactive + computed</li>
<li>C：在全局 store 先更新 → props 下发</li>
</ul>
</li>
</ul>
<h4 data-id="heading-37">🔹 第三步：方案评估法（找到正统 / 稳健方案）</h4>
<blockquote>
<p>评估的标准，就是“稳健 + 可维护 + 可复用 + 不踩坑”</p>
</blockquote>
<ul>
<li>建议使用一个简单的矩阵：<strong>稳定性 vs 复杂度</strong></li>
<li>如果方案稳定性高且复杂度适中 → 首选</li>
<li>如果不确定 → 写测试或小 demo 验证</li>
</ul>
<p>📌 核心是：<strong>先有标准，再对比方案，而不是靠经验判断</strong></p>
<h3 data-id="heading-38">三、训练方法（每天 10~15 分钟就够）</h3>
<ol>
<li>
<p><strong>每天挑一个自己遇到的小问题</strong></p>
<ul>
<li>不管多小，都拆解成 3 个维度</li>
</ul>
</li>
<li>
<p><strong>列 3 个以上可行方案</strong></p>
<ul>
<li>不一定写代码，可以纸上或脑内</li>
</ul>
</li>
<li>
<p><strong>给每个方案打分</strong></p>
<ul>
<li>稳定性 / 可维护性 / 可复用性</li>
</ul>
</li>
<li>
<p><strong>总结</strong></p>
<ul>
<li>哪个方案最稳健，为什么</li>
<li>下次遇到类似问题，可以直接复用模式</li>
</ul>
</li>
</ol>
<p>📌 这个过程本质就是<strong>把每个问题抽象成“模式 + 标准 + 验证”</strong> ，也是高级工程师的思考路径。</p>
<h2 data-id="heading-39">问题</h2>
<p>学习路径陡峭的，我需要看视频学习，不能像别人一样，看英文官网就能学会，这是为什么？</p>
<h3 data-id="heading-40">一、为什么你需要视频学习，而别人可以直接看英文官网</h3>
<ol>
<li>
<p><strong>认知加工成本不同</strong></p>
<ul>
<li>
<p>英文官网/文档通常<strong>信息密度极高</strong>，很多概念是压缩型表达：</p>
<blockquote>
<p>“你要先有前置知识、理解隐含假设，才能读懂一行话的意思。”</p>
</blockquote>
</li>
<li>
<p>视频教程是<strong>渐进式展开</strong>：</p>
<ul>
<li>讲解背景 → 讲解逻辑 → 举例 → 实操</li>
<li>这降低了你<strong>加工认知的成本</strong>，相当于“帮你拆开黑箱”。</li>
</ul>
</li>
</ul>
<p>换句话说，你现在的大脑在面对“压缩信息 + 英文表达 + 新概念”时，会自动做减负：</p>
<ul>
<li>视频慢慢引导，先给线索，再让你理解 → 所以容易吸收</li>
<li>英文官网一行代码、一个 API，可能涉及 3~5 个你还不熟的概念 → 自然卡壳</li>
</ul>
</li>
<li>
<p><strong>语言门槛 + 信息抽象</strong></p>
<ul>
<li>英文官网信息往往<strong>假设读者已有基础</strong>：你要知道上下文、已有概念、默认规则。</li>
<li>视频教程常常假设你是新手，会把这些概念讲清楚。</li>
<li>换句话说，这不是你能力差，而是<strong>认知结构没完全搭好</strong>，所以必须借助视频做“引导搭桥”。</li>
</ul>
</li>
<li>
<p><strong>学习风格差异</strong></p>
<ul>
<li>有的人是“文字型学习者” → 看文档很快</li>
<li>有的人是“视觉/听觉型学习者” → 通过视频更容易理解</li>
<li>你属于后者，不是缺陷，只是<strong>学习通道不同</strong></li>
</ul>
</li>
<li>
<p><strong>前置知识差异</strong></p>
<ul>
<li>
<p>有些前端工程师可以直接看官网，因为他们<strong>已经在脑里形成了一套抽象框架</strong>：</p>
<ul>
<li>状态管理、响应式、组件生命周期、数据流</li>
</ul>
</li>
<li>
<p>如果你缺少这个框架，一看到压缩信息就卡住 → 必须用视频把抽象层拉平</p>
</li>
</ul>
</li>
</ol>
<blockquote>
<p>🔑 核心结论：你需要视频，不是能力差，而是<strong>认知桥梁还没搭好</strong>。官网看不懂，是正常的。</p>
</blockquote>
<h3 data-id="heading-41">二、为什么别人看英文官网就能学会？</h3>
<p>别人能快速学，是因为他们的脑子里<strong>已有类似的“知识模型”</strong> ：</p>
<ul>
<li>
<p>Vue 官网文档里一行 <code>ref(0)</code> → 对他们来说：</p>
<ul>
<li>“响应式变量”</li>
<li>“composition API”</li>
<li>“响应式引用 vs 普通变量区别”</li>
<li>这些都已经在脑子里抽象过</li>
</ul>
</li>
<li>
<p>他们看到文档就是对已有模型的填充，而不是新建模型</p>
</li>
</ul>
<p>你现在，如果没有这种抽象模型，文档里的每一行都要“拆解 → 理解 → 联想”，认知负荷大 → 视频更适合。</p>
<h3 data-id="heading-42">三、怎么跨过这个“认知桥梁”阶段？</h3>
<p>你的目标是：<strong>慢慢减少对视频的依赖，把脑子里的抽象模型搭起来</strong>。具体方法：</p>
<h4 data-id="heading-43">1️⃣ 主动抽象法（搭框架）</h4>
<ul>
<li>
<p>每学一个新 API/概念，不仅记用法，还要记：</p>
<ol>
<li><strong>它解决了什么问题</strong></li>
<li><strong>它的适用场景</strong></li>
<li><strong>它和已有概念的关系</strong></li>
</ol>
</li>
<li>
<p>建议做笔记或思维导图，而不是抄代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">ref</span>() → 响应式引用
  - 可在 template 中绑定
  - 用于 composition <span class="hljs-variable constant_">API</span>
  - 不会自动解包对象
  - 对应 <span class="hljs-title function_">reactive</span>() 是深响应
</code></pre>
</li>
</ul>
<h4 data-id="heading-44">2️⃣ 知识分层法（减少负荷）</h4>
<ul>
<li><strong>第一层</strong>：能运行的代码、基础用法</li>
<li><strong>第二层</strong>：API 设计理念、原理</li>
<li><strong>第三层</strong>：边界、坑、性能问题</li>
<li>视频先帮你扫第一层，逐步建立第二层、第三层</li>
<li>当第二、三层建立后，再回去看官网 → 你能理解一行文档背后的假设</li>
</ul>
<h4 data-id="heading-45">3️⃣ 小步练习 + 模块化</h4>
<ul>
<li>
<p>每看完一段视频，自己写一个小 demo</p>
</li>
<li>
<p><strong>先照着视频做</strong>，然后：</p>
<ul>
<li>换数据</li>
<li>改逻辑</li>
<li>换成另一种写法</li>
</ul>
</li>
<li>
<p>这样大脑自动建立“迁移能力”</p>
</li>
</ul>
<h4 data-id="heading-46">4️⃣ 英文文档拆解训练</h4>
<ul>
<li>不要求一开始就能全懂</li>
<li>先用视频搭桥</li>
<li>同步看文档，把“生词 + 不懂的假设”记下来</li>
<li>逐渐减少视频依赖 → 英文官网变“复习资料”，而不是“学习入口”</li>
</ul>
<h3 data-id="heading-47">四、认知上的心理暗示</h3>
<ul>
<li>
<p><strong>你不是比别人慢，而是顺序不同</strong></p>
<ul>
<li>你的学习顺序：视频 → 桥梁 → 文档</li>
<li>别人顺序：文档 → 桥梁</li>
</ul>
</li>
<li>
<p>顺序不同不代表能力低，只是<strong>认知负荷管理不同</strong></p>
</li>
<li>
<p>关键是你要承认：<strong>搭认知桥梁阶段需要辅助</strong></p>
</li>
<li>
<p>不要自责“别人都看文档，我却要看视频”</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我把 Claude Code 搬进了 Slack，从此蹲坑也能 Vibe Coding]]></title>    <link>https://juejin.cn/post/7600223321041158150</link>    <guid>https://juejin.cn/post/7600223321041158150</guid>    <pubDate>2026-01-28T09:31:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600223321041158150" data-draft-id="7599933828544823359" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我把 Claude Code 搬进了 Slack，从此蹲坑也能 Vibe Coding"/> <meta itemprop="keywords" content="前端,人工智能,Claude"/> <meta itemprop="datePublished" content="2026-01-28T09:31:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刮涂层_赢大奖"/> <meta itemprop="url" content="https://juejin.cn/user/1521379826214119"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我把 Claude Code 搬进了 Slack，从此蹲坑也能 Vibe Coding
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379826214119/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刮涂层_赢大奖
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T09:31:14.000Z" title="Wed Jan 28 2026 09:31:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">我把 Claude Code 搬进了 Slack，从此蹲坑也能 Vibe Coding</h2>
<blockquote>
<p>周末两天肝出一个工具，让 AI 帮我干活，我在 Slack 里指挥就行</p>
</blockquote>
<h3 data-id="heading-1">🤔 起因：一次深刻的厕所沉思</h3>
<p>那是一个普通的下午，我正在电脑前和 Claude Code 愉快地 vibe coding。需求聊着聊着，代码写着写着，突然，肚子一阵翻涌 —— 该去解决人生大事了。</p>
<p>坐在马桶上，我习惯性地掏出手机刷了会儿。刷着刷着突然想起来：卧槽，刚才让 Claude 改的那个函数，我还没确认呢，它现在在干嘛？</p>
<p>更要命的是，我还想继续和它聊，让它把剩下的逻辑也写了。但是... <strong>我在厕所啊！</strong></p>
<p>我盯着手机屏幕陷入了沉思：</p>
<ul>
<li>回去继续？—— 但这坨还没解决完</li>
<li>用手机 SSH？—— 上次试过，vim 在手机上简直是酷刑</li>
<li>干等着？—— 这也太浪费时间了</li>
</ul>
<p>就在这个充满哲学意味的时刻，一个想法击中了我：</p>
<p><strong>为什么我不能在手机上继续 vibe coding？</strong></p>
<p>现在 AI 编程这么火，Claude Code 那么好用，凭什么非得坐在电脑前？我就不能蹲着坑，发条消息，让 Claude 继续帮我干活？</p>
<p>想到这里，我感觉这坨💩都拉得更顺畅了。</p>
<p>说干就干。</p>
<h3 data-id="heading-2">💡 想法：让 Claude Code 成为我的远程员工</h3>
<p>思路其实很简单：</p>
<pre><code class="hljs language-rust" lang="rust">我 (Slack) -<span class="hljs-punctuation">-&gt;</span> 消息 -<span class="hljs-punctuation">-&gt;</span> 服务器 -<span class="hljs-punctuation">-&gt;</span> Claude Code -<span class="hljs-punctuation">-&gt;</span> 代码修改 -<span class="hljs-punctuation">-&gt;</span> 结果返回 -<span class="hljs-punctuation">-&gt;</span> Slack
</code></pre>
<p>把 Claude Code CLI 包装成一个服务，跑在我的开发服务器上，然后通过 Slack 这类 IM 工具来和它对话。这样我就可以：</p>
<ul>
<li>🚽 蹲坑的时候继续 vibe coding</li>
<li>📱 躺床上用手机改代码</li>
<li>🚇 地铁上处理紧急 bug</li>
<li>🍜 吃饭的时候让 AI 跑着任务</li>
</ul>
<p>我给它起名叫 <strong>Heimerdinger</strong> —— 英雄联盟里那个小矮子发明家。因为这工具就像有个小机器人帮你干活一样。</p>
<h3 data-id="heading-3">🏗️ 架构设计：踩过的第一个坑</h3>
<h4 data-id="heading-4">最初的设想</h4>
<p>一开始我想得很简单：</p>
<ol>
<li>监听 Slack 消息</li>
<li>调用 Claude CLI</li>
<li>把结果发回去</li>
</ol>
<p>三步走，完事儿。</p>
<h4 data-id="heading-5">现实的暴击</h4>
<p>实际做的时候才发现，事情没那么简单：</p>
<p><strong>问题一：Claude Code 的输出是流式的</strong></p>
<p>Claude 不是一下子吐出所有结果，而是一个字一个字往外蹦的。如果我等它全部输出完再发 Slack，用户体验会很差 —— 要等好久才能看到结果。</p>
<p><strong>问题二：一个 Slack workspace 可能有多个项目</strong></p>
<p>不同的频道可能在聊不同的项目，我需要记住"这个频道正在操作哪个项目"。</p>
<p><strong>问题三：会话连续性</strong></p>
<p>Claude Code 有会话概念，同一个会话里它能记住上下文。如果每次都开新会话，那用户说"把刚才那个函数改一下"，Claude 根本不知道"刚才"是啥。</p>
<h4 data-id="heading-6">最终架构</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
    subgraph daemon["hmdg daemon"]
        subgraph adapters["IM Adapters"]
            slack["Slack Adapter"]
            feishu["Feishu Adapter"]
            discord["Discord...&lt;br/&gt;(Future)"]
        end

        subgraph processor["Message Processor"]
            state["Session State&lt;br/&gt;Project State"]
        end

        claude["Claude Code CLI&lt;br/&gt;(streaming JSON)"]

        slack --&gt; processor
        feishu --&gt; processor
        discord --&gt; processor
        processor --&gt; claude
    end

    user["📱 你 (手机/电脑)"] &lt;--&gt; slack
    user &lt;--&gt; feishu
</code></pre>
<p>我设计了一个<strong>适配器模式</strong>，把不同 IM 平台的差异封装起来。这样以后想支持飞书、Discord 什么的，只需要写个新 Adapter 就行。</p>
<h3 data-id="heading-7">🔧 技术实现：细节里全是魔鬼</h3>
<h4 data-id="heading-8">1. 流式输出的处理</h4>
<p>Claude Code 支持 <code>--output-format stream-json</code> 参数，会输出 JSONL 格式的流式数据：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"assistant"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"让我来"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"assistant"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"让我来看看"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"assistant"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"让我来看看这个bug"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
</code></pre>
<p>我需要实时解析这些 JSON，然后更新 Slack 消息。</p>
<p>但这里有个坑：<strong>Slack 有 API 频率限制</strong>。</p>
<p>如果每收到一个 JSON 就更新一次消息，很快就会被限流。所以我做了个节流处理：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 至少间隔 1 秒才更新一次消息</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MIN_UPDATE_INTERVAL</span> = <span class="hljs-number">1000</span>;
<span class="hljs-keyword">let</span> lastUpdateTime = <span class="hljs-number">0</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">throttledUpdate</span>(<span class="hljs-params">content: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  <span class="hljs-keyword">if</span> (now - lastUpdateTime &gt;= <span class="hljs-variable constant_">MIN_UPDATE_INTERVAL</span>) {
    <span class="hljs-title function_">updateMessage</span>(content);
    lastUpdateTime = now;
  }
}
</code></pre>
<h4 data-id="heading-9">2. 会话状态管理</h4>
<p>这是整个项目最复杂的部分。我需要维护三层状态：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 每个频道当前选择的项目</span>
<span class="hljs-keyword">const</span> userStates = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">ChannelState</span>&gt;();

<span class="hljs-comment">// 每个项目最后使用的会话 ID</span>
<span class="hljs-keyword">const</span> projectSessions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;();

<span class="hljs-comment">// 正在执行的任务（用于支持 /stop 命令）</span>
<span class="hljs-keyword">const</span> activeExecutions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">ExecutionInfo</span>&gt;();
</code></pre>
<p>而且这些状态要持久化，不然服务重启就全丢了：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 状态持久化到 ~/.heimerdinger/sessions-state.json</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">saveState</span>(<span class="hljs-params"/>) {
  fs.<span class="hljs-title function_">writeFileSync</span>(<span class="hljs-variable constant_">STATE_FILE</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
    <span class="hljs-attr">userStates</span>: <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">fromEntries</span>(userStates),
    <span class="hljs-attr">projectSessions</span>: <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">fromEntries</span>(projectSessions)
  }));
}
</code></pre>
<h4 data-id="heading-10">3. 项目发现机制</h4>
<p>Claude Code 会把项目信息存在 <code>~/.claude/projects/</code> 目录下，目录名是项目路径的编码形式：</p>
<pre><code class="hljs language-perl" lang="perl">~<span class="hljs-regexp">/.claude/pr</span>ojects/
├── home-dev-project-a/
├── home-dev-<span class="hljs-keyword">my</span>-project/
└── Users-test-<span class="hljs-keyword">my</span>-app/
</code></pre>
<p>编码规则很简单：把 <code>/</code> 替换成 <code>-</code>。但解码就头疼了。</p>
<p>比如 <code>home-dev-my-project</code>，它可能是：</p>
<ul>
<li><code>/home/dev/my/project</code> —— 4 层目录</li>
<li><code>/home/dev/my-project</code> —— 3 层目录，最后一层本身带连字符</li>
</ul>
<p><strong>没法直接区分哪个 <code>-</code> 是原来的 <code>/</code>，哪个是路径本身就有的。</strong></p>
<p>一开始我想简单处理：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 简单粗暴，但是错的</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">decodePath</span>(<span class="hljs-params">encoded: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-string">'/'</span> + encoded.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/-/g</span>, <span class="hljs-string">'/'</span>);
}
<span class="hljs-comment">// home-dev-my-project -&gt; /home/dev/my/project ❌ 错！</span>
</code></pre>
<p>后来想到一个办法：<strong>穷举所有可能的组合，看哪个路径在文件系统里真实存在</strong>。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">decodeProjectPath</span>(<span class="hljs-params">encodedPath: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">const</span> parts = encodedPath.<span class="hljs-title function_">split</span>(<span class="hljs-string">'-'</span>);  <span class="hljs-comment">// ['home', 'dev', 'my', 'project']</span>
  <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">findValidPath</span>(<span class="hljs-string">''</span>, parts, <span class="hljs-number">0</span>);
  <span class="hljs-keyword">return</span> result || <span class="hljs-string">`/<span class="hljs-subst">${encodedPath.replace(/-/g, <span class="hljs-string">'/'</span>)}</span>`</span>;  <span class="hljs-comment">// fallback</span>
}

<span class="hljs-comment">// 递归 + 回溯，尝试所有可能的路径组合</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">findValidPath</span>(<span class="hljs-params">current: <span class="hljs-built_in">string</span>, parts: <span class="hljs-built_in">string</span>[], index: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span> {
  <span class="hljs-keyword">if</span> (index &gt;= parts.<span class="hljs-property">length</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">existsSync</span>(current) ? current : <span class="hljs-literal">null</span>;
  }

  <span class="hljs-comment">// 从 index 开始，尝试把连续的 parts 拼成一个目录名</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = index; i &lt; parts.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-keyword">const</span> segment = parts.<span class="hljs-title function_">slice</span>(index, i + <span class="hljs-number">1</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">'-'</span>);  <span class="hljs-comment">// 'my' 或 'my-project'</span>
    <span class="hljs-keyword">const</span> newPath = <span class="hljs-string">`<span class="hljs-subst">${current}</span>/<span class="hljs-subst">${segment}</span>`</span>;

    <span class="hljs-keyword">if</span> (i === parts.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>) {
      <span class="hljs-comment">// 最后一段了，检查路径是否存在</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">existsSync</span>(newPath)) <span class="hljs-keyword">return</span> newPath;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 继续递归</span>
      <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">findValidPath</span>(newPath, parts, i + <span class="hljs-number">1</span>);
      <span class="hljs-keyword">if</span> (result) <span class="hljs-keyword">return</span> result;
    }
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<p>举个例子，对于 <code>home-dev-my-project</code>：</p>
<pre><code class="hljs language-arduino" lang="arduino">尝试 /home/dev/my/project  → <span class="hljs-built_in">existsSync</span>() = <span class="hljs-literal">false</span> ❌
尝试 /home/dev/my-project  → <span class="hljs-built_in">existsSync</span>() = <span class="hljs-literal">true</span>  ✅ 找到了！
</code></pre>
<p>本质就是暴力搜索，但因为目录层级不会太深，性能完全可以接受。</p>
<p><strong>有时候最笨的办法就是最好的办法</strong></p>
<h4 data-id="heading-11">4. 权限系统</h4>
<p>Claude Code 有权限控制，执行某些操作需要用户确认。在 CLI 里是交互式的，但在 Slack 里怎么办？</p>
<p>我做了个<strong>交互式卡片</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 当 Claude 需要权限时，发送一个带按钮的卡片</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendPermissionCard</span>(<span class="hljs-params">channel: <span class="hljs-built_in">string</span>, tool: <span class="hljs-built_in">string</span>, input: <span class="hljs-built_in">any</span></span>) {
  <span class="hljs-keyword">await</span> slack.<span class="hljs-property">chat</span>.<span class="hljs-title function_">postMessage</span>({
    channel,
    <span class="hljs-attr">blocks</span>: [
      {
        <span class="hljs-attr">type</span>: <span class="hljs-string">'section'</span>,
        <span class="hljs-attr">text</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'mrkdwn'</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">`🔐 *需要权限确认*\n工具: <span class="hljs-subst">${tool}</span>`</span> }
      },
      {
        <span class="hljs-attr">type</span>: <span class="hljs-string">'actions'</span>,
        <span class="hljs-attr">elements</span>: [
          { <span class="hljs-attr">type</span>: <span class="hljs-string">'button'</span>, <span class="hljs-attr">text</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'plain_text'</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'✅ 允许'</span> }, <span class="hljs-attr">action_id</span>: <span class="hljs-string">'approve'</span> },
          { <span class="hljs-attr">type</span>: <span class="hljs-string">'button'</span>, <span class="hljs-attr">text</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'plain_text'</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'❌ 拒绝'</span> }, <span class="hljs-attr">action_id</span>: <span class="hljs-string">'deny'</span> }
        ]
      }
    ]
  });
}
</code></pre>
<p>用户点击按钮后，我再用更高权限重新执行请求。</p>
<h4 data-id="heading-12">5. Slack 斜杠命令</h4>
<p>光发消息还不够，我还想要一些快捷操作。Slack 的斜杠命令（Slash Commands）正好派上用场：</p>
<ul>
<li><code>/project</code> —— 切换项目</li>
<li><code>/stop</code> —— 停止当前正在执行的任务</li>
<li><code>/clear</code> —— 清除会话，重新开始</li>
</ul>
<p>实现分两层：</p>
<p><strong>第一层：Slack Adapter 注册命令</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 注册 /project 命令</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-title function_">command</span>(<span class="hljs-string">'/project'</span>, <span class="hljs-keyword">async</span> ({ command, ack }) =&gt; {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">ack</span>();  <span class="hljs-comment">// 必须在 3 秒内响应，否则 Slack 会报错</span>

  <span class="hljs-keyword">const</span> context = {
    <span class="hljs-attr">channelId</span>: command.<span class="hljs-property">channel_id</span>,
    <span class="hljs-attr">userId</span>: command.<span class="hljs-property">user_id</span>,
  };

  <span class="hljs-comment">// 触发交互处理</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> handler <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">interactionHandlers</span>) {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">handler</span>(<span class="hljs-string">'show_project_selector'</span>, <span class="hljs-string">''</span>, context);
  }
});
</code></pre>
<p><strong>第二层：Message Processor 处理交互</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-title function_">handleInteraction</span>(<span class="hljs-params">action: <span class="hljs-built_in">string</span>, value: <span class="hljs-built_in">string</span>, context: MessageContext</span>) {
  <span class="hljs-keyword">if</span> (action === <span class="hljs-string">'show_project_selector'</span>) {
    <span class="hljs-comment">// 展示项目选择卡片</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">showProjectSelector</span>(adapter, context);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (action === <span class="hljs-string">'stop_execution'</span>) {
    <span class="hljs-comment">// 停止当前任务</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleStopExecution</span>(adapter, context);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (action === <span class="hljs-string">'clear_session'</span>) {
    <span class="hljs-comment">// 清除会话</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleClearSession</span>(adapter, context);
  }
}
</code></pre>
<p><code>/stop</code> 的实现有点意思 —— 需要能够中断正在运行的 Claude 进程：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleStopExecution</span>(<span class="hljs-params">adapter: IMAdapter, context: MessageContext</span>) {
  <span class="hljs-keyword">const</span> execution = <span class="hljs-variable language_">this</span>.<span class="hljs-property">activeExecutions</span>.<span class="hljs-title function_">get</span>(context.<span class="hljs-property">channelId</span>);

  <span class="hljs-keyword">if</span> (!execution) {
    <span class="hljs-keyword">await</span> adapter.<span class="hljs-title function_">sendMessage</span>(context.<span class="hljs-property">channelId</span>, <span class="hljs-string">'没有正在运行的任务。'</span>);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// 标记为已中止，防止后续消息更新</span>
  execution.<span class="hljs-property">aborted</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-comment">// 触发 AbortController</span>
  execution.<span class="hljs-title function_">abort</span>();

  <span class="hljs-keyword">await</span> adapter.<span class="hljs-title function_">updateMessage</span>(context.<span class="hljs-property">channelId</span>, execution.<span class="hljs-property">messageTs</span>, <span class="hljs-string">'🛑 已停止'</span>);
}
</code></pre>
<p>这里用了 <code>AbortController</code>，它是 Node.js 原生支持的中止信号机制。在启动 Claude 进程时传入 <code>abortSignal</code>，调用 <code>abort()</code> 就能优雅地终止进程。</p>
<p><strong>一个小细节</strong>：Slack 要求斜杠命令必须在 3 秒内响应（<code>ack()</code>），否则会显示错误。所以我先 <code>ack()</code>，再异步处理实际逻辑。这样用户体验会好很多。</p>
<h3 data-id="heading-13">😱 踩坑实录：那些让我头秃的问题</h3>
<h4 data-id="heading-14">坑 1：Bun + Slack WebSocket = 💥</h4>
<p>我一开始用 Bun 来开发，build 也用 Bun。结果发现一个诡异的问题：Slack 的 Socket Mode 在 Bun 运行时下经常断连。</p>
<p>排查了半天，发现是 Bun 的 WebSocket 实现和 <code>@slack/bolt</code> 不太兼容。</p>
<p><strong>解决方案</strong>：开发时用 <code>tsx</code>（Node.js 运行时），生产构建用 Bun 打包但改成 Node.js 的 shebang：</p>
<pre><code class="hljs language-bash" lang="bash">bun build ./src/cli.ts --outdir ./dist --target node &amp;&amp; \
sed -i <span class="hljs-string">'1s|#!/usr/bin/env bun|#!/usr/bin/env node|'</span> ./dist/cli.js
</code></pre>
<p>是的，有点丑陋，但它能用。</p>
<h4 data-id="heading-15">坑 2：Slack 消息长度限制</h4>
<p>Slack 单条消息最大 40KB（实际建议 38KB 以内）。但 Claude 有时候会输出很长的内容，特别是它在解释代码的时候。</p>
<p>直接截断？不行，可能截到一半把 markdown 格式搞坏了。</p>
<p><strong>解决方案</strong>：按字节长度截断，并确保截断点不在多字节字符中间：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">truncateToByteLength</span>(<span class="hljs-params">str: <span class="hljs-built_in">string</span>, maxBytes: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">const</span> encoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextEncoder</span>();
  <span class="hljs-keyword">const</span> encoded = encoder.<span class="hljs-title function_">encode</span>(str);

  <span class="hljs-keyword">if</span> (encoded.<span class="hljs-property">length</span> &lt;= maxBytes) <span class="hljs-keyword">return</span> str;

  <span class="hljs-comment">// 找到合适的截断点</span>
  <span class="hljs-keyword">let</span> truncated = encoded.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, maxBytes);
  <span class="hljs-comment">// 确保不截断 UTF-8 多字节字符</span>
  <span class="hljs-keyword">while</span> (truncated.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> &amp;&amp; (truncated[truncated.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>] &amp; <span class="hljs-number">0xc0</span>) === <span class="hljs-number">0x80</span>) {
    truncated = truncated.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>().<span class="hljs-title function_">decode</span>(truncated) + <span class="hljs-string">'\n\n... (内容过长，已截断)'</span>;
}
</code></pre>
<h4 data-id="heading-16">坑 3：Markdown 格式转换</h4>
<p>Claude 输出的是标准 Markdown，但 Slack 用的是自己的 <code>mrkdwn</code> 格式。两者语法不一样：</p>

























<table><thead><tr><th>Markdown</th><th>Slack mrkdwn</th></tr></thead><tbody><tr><td><code>**bold**</code></td><td><code>*bold*</code></td></tr><tr><td><code>*italic*</code></td><td><code>_italic_</code></td></tr><tr><td><code>[text](url)</code></td><td><code>&lt;url|text&gt;</code></td></tr><tr><td><code>`code`</code></td><td><code>`code`</code></td></tr></tbody></table>
<p>我写了个转换函数，处理这些差异。但最坑的是代码块 —— Slack 对代码块的渲染很奇怪，超过一定长度就会出问题。</p>
<p><strong>最终方案</strong>：长代码不放在消息里，而是上传成代码片段（Snippet）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (codeBlock.<span class="hljs-property">length</span> &gt; <span class="hljs-number">2000</span>) {
  <span class="hljs-keyword">await</span> slack.<span class="hljs-property">files</span>.<span class="hljs-title function_">uploadV2</span>({
    <span class="hljs-attr">channel_id</span>: channel,
    <span class="hljs-attr">content</span>: codeBlock,
    <span class="hljs-attr">filename</span>: <span class="hljs-string">'code.txt'</span>,
    <span class="hljs-attr">title</span>: <span class="hljs-string">'Code Output'</span>
  });
}
</code></pre>
<h4 data-id="heading-17">坑 4：语音消息支持</h4>
<p>既然是在手机上用，那支持语音消息岂不是更方便？说一句话就能让 Claude 干活。</p>
<p>我集成了 <code>whisper.cpp</code> 做语音转文字：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">transcribe</span>(<span class="hljs-params">audioPath: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {
  <span class="hljs-comment">// 先用 ffmpeg 转换成 whisper 需要的格式</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">exec</span>(<span class="hljs-string">`ffmpeg -i <span class="hljs-subst">${audioPath}</span> -ar 16000 -ac 1 -f wav <span class="hljs-subst">${wavPath}</span>`</span>);

  <span class="hljs-comment">// 调用 whisper</span>
  <span class="hljs-keyword">const</span> { stdout } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">exec</span>(<span class="hljs-string">`whisper-cli -m <span class="hljs-subst">${modelPath}</span> -f <span class="hljs-subst">${wavPath}</span>`</span>);
  <span class="hljs-keyword">return</span> stdout.<span class="hljs-title function_">trim</span>();
}
</code></pre>
<p>但这里又有坑：Slack 发来的语音是 <code>.mp4</code> 格式，需要先下载再转换。而且 whisper 模型挺大的，第一次运行要下载...</p>
<h4 data-id="heading-18">坑 5：进程管理</h4>
<p>作为一个后台服务，进程管理是必须的：</p>
<ul>
<li>如何优雅地启动/停止？</li>
<li>如何检测服务是否在运行？</li>
<li>如何处理僵尸进程？</li>
</ul>
<p>我用 PID 文件 + 信号量来管理：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">stop</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> pid = <span class="hljs-title function_">readPidFile</span>();
  <span class="hljs-keyword">if</span> (!pid) <span class="hljs-keyword">return</span>;

  <span class="hljs-comment">// 先尝试优雅退出</span>
  process.<span class="hljs-title function_">kill</span>(pid, <span class="hljs-string">'SIGTERM'</span>);

  <span class="hljs-comment">// 等待 5 秒</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-number">5000</span>);

  <span class="hljs-comment">// 如果还在运行，强制杀掉</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isRunning</span>(pid)) {
    process.<span class="hljs-title function_">kill</span>(pid, <span class="hljs-string">'SIGKILL'</span>);
  }
}
</code></pre>
<h3 data-id="heading-19">✨ 最终效果</h3>
<p>折腾了两天，终于能用了：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装</span>
npm install -g chat-heimerdinger

<span class="hljs-comment"># 初始化配置</span>
hmdg init

<span class="hljs-comment"># 启动服务</span>
hmdg start
</code></pre>
<p>然后在 Slack 里：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9bbf37e25a444669824261a7208d970~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yiu5raC5bGCX-i1ouWkp-Wllg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197474&amp;x-signature=6LgEiu2tVnnnd%2BhdBn0%2Bn9c4N5c%3D" alt="2db91133029cfc157e7dbbcea5630576.jpg" loading="lazy"/></p>
<p><strong>或者直接发语音</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac7f7df145434743a566bd802a638a7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yiu5raC5bGCX-i1ouWkp-Wllg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197474&amp;x-signature=ixMQg9iJqc%2FEf3cGoLTtujlh7Zo%3D" alt="cae84620508677ae00533e3fc5d68573.jpg" loading="lazy"/></p>
<p>蹲在马桶上，动动手指，代码就改好了。Vibe coding，永不断档！</p>
<p>如果不确定Claude code的改动是否正确，每次对话的thread里还有本次修改的diff</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65803658919e4b7aac248bfe5cc51f09~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yiu5raC5bGCX-i1ouWkp-Wllg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197474&amp;x-signature=h3YTO9ioCZIu0xzerH%2Fk7UMCPWo%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-20">写在最后</h3>
<p><strong>工具的价值在于节省时间。</strong> 虽然开发这个工具花了我两个整天，但以后每次蹲坑时继续 vibe coding 省下的时间，迟早会赚回来的（大概）。</p>
<p>slack目前支持已经基本完善，但飞书我是盲调的（公司内网有防火墙，连不到飞书的socket，所以飞书的不保证可用，后续我还会继续调整）。后续我还会考虑支持上钉钉、企微、微信，<strong>让更多的IM工具都能实现马桶vibe coding</strong>。</p>
<hr/>
<p>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fa1245582339%2Fchat-heimerdinger" target="_blank" title="https://github.com/a1245582339/chat-heimerdinger" ref="nofollow noopener noreferrer">GitHub - chat-heimerdinger</a></p>
<p>如果觉得有用，欢迎 Star ⭐</p>
<p>有问题欢迎评论区交流，我会尽量回复（如果我不是在厕所里指挥 Claude 干活的话）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[阿里千问最强模型来了！性能比肩GPT-5.2-Thinking、Claude-Opus-4.5、Gemini 3 Pro，4项基准测试排名第一]]></title>    <link>https://juejin.cn/post/7599852579066871823</link>    <guid>https://juejin.cn/post/7599852579066871823</guid>    <pubDate>2026-01-27T08:05:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599852579066871823" data-draft-id="7599852579066855439" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="阿里千问最强模型来了！性能比肩GPT-5.2-Thinking、Claude-Opus-4.5、Gemini 3 Pro，4项基准测试排名第一"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-27T08:05:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="歪斯Wise"/> <meta itemprop="url" content="https://juejin.cn/user/3156074412913466"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            阿里千问最强模型来了！性能比肩GPT-5.2-Thinking、Claude-Opus-4.5、Gemini 3 Pro，4项基准测试排名第一
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3156074412913466/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    歪斯Wise
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T08:05:51.000Z" title="Tue Jan 27 2026 08:05:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95a12665ba8b4200b0fd8a00acaf8217~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2q5pavV2lzZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770105951&amp;x-signature=oYlyuk2xMrbkB%2Fw%2BNh8xOE10wY8%3D" alt="" loading="lazy"/></p>
<p>昨天晚上，阿里悄然发布了一款新模型，Qwen3-Max-Thinking。这个模型的参数规模超过了1万亿，预训练数据达到36T tokens。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9064009a6134b0a928469eee32ab4eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2q5pavV2lzZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770105951&amp;x-signature=Z4pdkUwC3oqsd%2FOHGUsxUVGd14g%3D" alt="" loading="lazy"/></p>
<p>在19项权威基准测试中，其性能可媲美GPT-5.2-Thinking、Claude-Opus-4.5 和Gemini 3 Pro等顶尖模型。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24c3d976a7de422b952170b0190c6ba0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2q5pavV2lzZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770105951&amp;x-signature=eUEe5Ja7Hnqjo9BsqxVaNWrq2MA%3D" alt="" loading="lazy"/></p>
<p>上图是我重制后的表格,我们可以看到在4项基准测试中，千问的表现超过了GPT-5.2、Claude Opus 4.5和Gemini 3 Pro等頂尖模型，刷新了全球的记录，获得了第一。</p>
<p>这4项测试分别是C-Eval、HMMT Nov 2025、HLE (w/ tools)、Arena-Hard v2。</p>
<p>C-Eval第一，说明模型在中文理解、知识检索以及表述更强，Qwen超越了国外顶级模型的表现。</p>
<p>它让模型在理解用户问题的时候更容易抓住重点，能够按照中文的语义拆解问题，结合Arena-Hard，它能让同样的输入能够获得更完整、更少废话更接近人类偏好的回答。</p>
<p>HMMT Nov 25是哈佛和麻省理工数学锦标赛，它用来测试模型的高强度数学推理/解题能力，排名第一说明模型在复杂推理、多条件推导的情况会变得更强，通过提示词写代码逻辑容错性更高了。</p>
<p>而HLE拿到第一，可能对我们的作用更大，它是一个更聪明的智能体，会更懂规划，更会使用工具。</p>
<h2 data-id="heading-0">Qwen3-Max-Thinking这一次的创新是什么？</h2>
<h2 data-id="heading-1">1、自适应工具调用的能力</h2>
<p>模型调用工具的概念其实不新鲜了，最早期就开始有了Function Call，让模型能够去自主调用工具。但以前更多的时候工具的开关是掌握在用户手里，而现在是掌握在模型手里。</p>
<p>如果说GPT的创新是教会了模型遵循人类的指令，那千问可能是教会了模型在什么时候选择什么工具，以及基于用得好不好做了定向的训练。</p>
<p>根据官方的说明，而在搜索工具以往的幻觉、失忆老问题也得到了解决。</p>
<h2 data-id="heading-2">2、测试时扩展技术</h2>
<p>这个技术简单的说，是让模型聚焦在没有解决的问题。如果它已经知道这件事就不会再重复推导了。</p>
<p>这件事的原因是，传统的做法是并行多个任务进行推理，然后选择最优的那一条，增加推理能力很多时候是增加推理任务，但这种问题是每条推理路径可能是相同的，那这时候就会造成了浪费。</p>
<p>而Qwen拒绝无休止的多开任务，它限制了任务的数量，用少量并行和多轮迭代把任务做得更深，省下来的计算预算，用来做经验提取和自我反思。</p>
<p>通过这种方式实现更高的上下文利用效率，前两周Deepseek 的Engma机制解决了通识查询的问题，这次Qwen解决了推理效率的问题</p>
<p>在相同Token的消耗下</p>
<pre><code class="hljs">GPQA（研究生级问答/高难知识推理）：90.3 → 92.8（+2.5）HLE（高难长程推理）：34.1 → 36.5（+2.4）LiveCodeBench v6（真实编码能力）：88.0 → 91.4（+3.4）IMO-AnswerBench（奥数风格推理/答案准确）：89.5 → 91.5（+2.0）HLE（w/ tools，带工具的高难推理）：55.8 → 58.3（+2.5）
</code></pre>
<p>长程推理的分值提升，避免了在长链路推理跑偏或者自相矛盾，真实编程能力让代码的效率更高了，而且还有了类似奥数式的精细推理，结合更好的工具使用能力帮助我们完成任务。</p>
<h2 data-id="heading-3">来一次实测吧</h2>
<p>在中文理解的部分</p>
<pre><code class="hljs">Prompt：帮我写一条回复给朋友的消息，拒绝他的借钱，要求：语气：真诚但坚定，不怯懦结构：3 段，每段不超过 2 句禁用词：不能出现“但是”“抱歉”“可能”“不方便”必须包含：给出一个替代帮助方式（非借钱）
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ccfd3453ff7b42769f494c14e4d1810a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2q5pavV2lzZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770105951&amp;x-signature=HEc%2FrK9xg%2BOsVIiD%2BYz4mcj1jbs%3D" alt="" loading="lazy"/></p>
<p>我把国产的模型都测了1次，Qwen和Kimi的表现明显要更好，在借钱这种很难聊的场景，再顶尖的国外模型表现还是略差一些。</p>
<p>在联网查询+简单数学计算+中文理解部分</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">Prompt：今天是</span> <span class="hljs-number">2026-01-27</span><span class="hljs-string">（背景时间）。请你使用搜索确认：2026</span> <span class="hljs-string">年中国下一个公共假期的名称和日期，并给出引用来源。然后计算：从</span> <span class="hljs-number">2026-01-27</span> <span class="hljs-string">到这个假期还有多少天（按自然日计算）。最后用</span> <span class="hljs-number">2</span> <span class="hljs-string">句话告诉我：这个假期适合做什么“低成本”活动（别写旅游攻略）。</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a16bbba5174d460dab07d44a44e70bb1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2q5pavV2lzZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770105951&amp;x-signature=ddVAfjOBpMhn%2F4p5AMwgG9aYY5Y%3D" alt="" loading="lazy"/></p>
<p>联网搜索和数据计算部分，二者表现相当，但GPT在怎么低成本过春节的部分，是让我去合照和年夜饭火锅，Qwen会更贴合中文语境，包饺子、贴春联还有视频拜年。</p>
<p>更多的案例可以看乔帮主的测试。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzAwODIyOTQ4Mw%3D%3D%26mid%3D2649446478%26idx%3D1%26sn%3D96ce658c531e79d329c89c3f481f8793%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzAwODIyOTQ4Mw==&amp;mid=2649446478&amp;idx=1&amp;sn=96ce658c531e79d329c89c3f481f8793&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">我用阿里Qwen3 Max Thinking测了5个问题，彻底服气了</a></p>
<p>今天的分享就到这里了，文章没写完DeepseekOCR2，还有Kimi K2.5都来了，跟不上了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[IDEA 里终于能爽用 Claude Code了！]]></title>    <link>https://juejin.cn/post/7599975633478647846</link>    <guid>https://juejin.cn/post/7599975633478647846</guid>    <pubDate>2026-01-28T09:31:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599975633478647846" data-draft-id="7600068892988424202" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="IDEA 里终于能爽用 Claude Code了！"/> <meta itemprop="keywords" content="Java,IntelliJ IDEA"/> <meta itemprop="datePublished" content="2026-01-28T09:31:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JavaGuide"/> <meta itemprop="url" content="https://juejin.cn/user/166781497383294"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            IDEA 里终于能爽用 Claude Code了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/166781497383294/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JavaGuide
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T09:31:25.000Z" title="Wed Jan 28 2026 09:31:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果你是 JetBrains 家 IDE 的重度用户，大概率有过这样的体验：想用 Claude Code、Codex 这类终端 AI 工具时，只能在 Terminal 里跑着用。这些 CLI 工具虽强大，但缺少原生 UI 交互，体验上有些局限。虽然可以通过 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FGYaq_HNo5mKh2WjWtuEMyg" target="_blank" title="https://mp.weixin.qq.com/s/GYaq_HNo5mKh2WjWtuEMyg" ref="nofollow noopener noreferrer">Claude Code UI 类开源项目</a>来缓解，如 vibe kanban、1Code，但在写代码这件事上，没有什么比“在熟悉的 IDE 面板里直接对话”更爽了。</p>
<p>2025 年底，JetBrains 给 AI Assistant 插件更新了一个重磅功能：<strong>支持自定义 ACP（Agent Client Protocol）配置</strong>。这意味着你现在可以把任何支持 ACP 的 Agent 接入到 AI Assistant 里，包括 Claude Code。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b21adaa0ed1472f9d1999a7dd3b10d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197598&amp;x-signature=5EWb%2BjUyPlFLZS672hu19jqWQNg%3D" alt="" loading="lazy"/></p>
<p>这篇文章 Guide 就来手把手带大家在 IDEA 里通过 ACP 爽用 Claude Code，希望能给喜欢 IDEA 的朋友提供一个不一样选择。</p>
<blockquote>
<p><strong>需要注意</strong>：目前 ACP 还是 Beta 版，体验上可能存在一些小问题，Guide 在周末用了之后整体感觉还是很不错的。</p>
</blockquote>
<h2 data-id="heading-0">ACP 是什么？</h2>
<p>ACP 全称 <strong>Agent Client Protocol</strong>，是一个开放协议，用来规范 AI Agent 与代码编辑器/IDE 之间的通信方式。它类似于 Language Server Protocol (LSP)，但专注于 AI 代理的集成，帮助开发者在不同编辑器中使用各种 AI 工具，而无需为每个组合构建自定义适配器。</p>
<p>简单理解，它就是一个让 AI Agent 和 IDE "即插即用"的通用接口——就像 USB-C 之于设备连接一样。</p>
<p>ACP 由 Zed Industries（Zed 编辑器的开发者）主导开发，与 Anthropic、Google 等合作，JetBrains 目前也加入了。</p>
<h3 data-id="heading-1">为什么需要 ACP？</h3>
<p>在没有 ACP 之前，每个 AI Agent 想接入某个 IDE，都需要单独开发适配器。Claude Code 要写一套，Cursor 要写一套，Windsurf 也要写一套——重复造轮子，而且一旦 Agent 更新，适配器还得跟着改。</p>
<p>ACP 的核心思路是：<strong>定义一套标准的通信协议，任何 Agent 只要实现了 ACP Server，任何 IDE 只要实现了 ACP Client，两者就能直接对接</strong>。</p>
<p>关于 ACP 更详细的介绍，可以查看官方文档：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fagentclientprotocol.com%2Foverview%2Fintroduction" target="_blank" title="https://agentclientprotocol.com/overview/introduction" ref="nofollow noopener noreferrer">agentclientprotocol.com/overview/in…</a></strong> 。</p>
<h3 data-id="heading-2">生态现状</h3>
<p>目前加入 ACP 生态的成员包括：</p>
<ul>
<li><strong>IDE 端</strong>：JetBrains 全家桶、Zed 等。</li>
<li><strong>Agent 端</strong>：Claude Code、Codex、Gemini CLI、Kimi CLI、Qoder CLI 等。</li>
</ul>
<p>就连 Docker 也在 2025 年 11 月 13 日宣布将其开源多代理运行时 cagent 内置到 Docker Desktop，并支持 Agent Client Protocol (ACP)，以实现 AI 代理与 IDE/编辑器（如 Zed、VS Code）的无缝集成。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcdb19228b9d477fb28062cb87937e1f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197598&amp;x-signature=4Q2bHBMysasvJxqvmj%2FzHrrwXCw%3D" alt="" loading="lazy"/></p>
<p>这意味着可以在容器化环境中运行 AI 代理，简化开发工作流，如代码生成、测试和重构，同时保持容器隔离性。</p>
<h3 data-id="heading-3">技术原理</h3>
<p>ACP 底层基于 <strong>JSON-RPC 2.0</strong> 协议（与 LSP 完全相同），Agent 作为 Server 运行一个独立的进程，IDE 通过 stdin/stdout 与之通信。好处是 Agent 不需要被打包进 IDE 插件里，保持独立性和可维护性。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    subgraph IDE["IDE (ACP Client)"]
        AIAI["AI Assistant&lt;br/&gt;Plugin"]
    end

    subgraph ACP_Agent["ACP Agent Process"]
        ACPServer["ACP Server&lt;br/&gt;JSON-RPC"]
        LLM["AI Backend&lt;br/&gt;(Claude/GPT/...)"]
        Tools["MCP Tools&lt;br/&gt;Filesystem/Git/..."]
    end

    AIAI &lt;--&gt;|"stdin/stdout&lt;br/&gt;JSON-RPC"| ACPServer
    ACPServer --&gt; LLM
    ACPServer --&gt; Tools
</code></pre>
<h2 data-id="heading-4">前置条件</h2>
<p>要在 IDEA 里用 ACP 接入 Claude Code，需要满足：</p>
<ol>
<li><strong>IDE 版本</strong>：IntelliJ IDEA 2024.2 到 2025.3.x 或更高版本。ACP 支持从 2025 年底开始逐步集成，确保你的 IDEA 已更新到支持 ACP 的构建。</li>
<li><strong>AI Assistant 插件</strong>：确保已安装并启用</li>
<li><strong>Claude Code</strong>：已安装并能正常运行</li>
<li><strong>claude-code-acp</strong>：Zed 提供的 ACP 适配器（下文会讲如何安装）</li>
</ol>
<p>你可以检查 AI Assistant 插件版本，在 <code>File &gt; Settings &gt; Plugins</code> 里搜索 "JetBrains AI Assistant"，确认版本号在 2025.12 之后。</p>
<h2 data-id="heading-5">配置 ACP</h2>
<h3 data-id="heading-6">第一步：找到配置入口</h3>
<p>打开 AI Assistant 的聊天面板，点击右上角选择下拉框，你会看到 <strong>「配置 ACP 智能体」</strong> 选项。</p>
<p>点击后，IDE 会自动打开一个 <code>acp.json</code> 配置文件。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/366cba9af1444df9b10a3ea4a6022a2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197598&amp;x-signature=XdD02417833414koz9HlgJMWhSY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">第二步：安装 claude-code-acp</h3>
<p>Zed 官方提供了一个 ACP 适配器 <code>@zed-industries/claude-code-acp</code>，用来桥接 Claude Code 和 ACP 协议。</p>
<pre><code class="hljs language-bash" lang="bash">pnpm install -g @zed-industries/claude-code-acp
</code></pre>
<p>注意必须用 <code>-g</code> 全局安装，这样 ACP Server 才能作为独立命令被调用。</p>
<p>安装完成后，你会在全局 bin 目录里看到 <code>claude-code-acp</code> 命令。</p>
<pre><code class="hljs language-bash" lang="bash">❯ pnpm bin -g
/Users/guide/Library/pnpm
❯ <span class="hljs-built_in">ls</span> /Users/guide/Library/pnpm
claude-code-acp global          store
</code></pre>
<h3 data-id="heading-8">第三步：编辑 acp.json</h3>
<p>在 <code>acp.json</code> 中添加 Claude Code 的配置：</p>
<pre><code class="hljs language-json" lang="json">  <span class="hljs-attr">"agent_servers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"Claude Code"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/Users/guide/Library/pnpm/claude-code-acp"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
</code></pre>
<p>注意将路径替换为你本地的，或者将其添加到环境变量中。</p>
<p>保存文件后，回到 AI Assistant 的聊天面板，再次点击模型选择下拉框，你应该能看到 <strong>Claude Code</strong> 出现在列表里了。</p>
<h2 data-id="heading-9">爽用 Claude Code</h2>
<h3 data-id="heading-10">基础对话</h3>
<p>选择 Claude Code 作为 Agent 后，你就可以像用内置 Claude 一样进行对话：</p>
<ul>
<li>代码编写</li>
<li>代码解释</li>
<li>Bug 诊断</li>
<li>重构建议</li>
<li>生成单元测试</li>
</ul>
<p>这个周末，我就通过这种方式成功重构优化了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fjavaguide.cn%2Fzhuanlan%2Finterview-guide.html" target="_blank" title="https://javaguide.cn/zhuanlan/interview-guide.html" ref="nofollow noopener noreferrer">《SpringAI 智能面试平台+RAG 知识库》</a>这个项目：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/698b720bea144c17965a8323ca3f9443~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197598&amp;x-signature=84ysSaJ5K4uwWlPAjH7pOyniYLE%3D" alt="" loading="lazy"/></p>
<p>这个项目的配套实战项目教程正在更新，涉及到 Prompt Engineering、大模型集成、RAG（检索增强生成）、高性能对象存储与向量数据库。后续的话，还会同步上Agent 项目。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da03c8521a574eb1a8e5f6c8f81b43b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197598&amp;x-signature=gSrToHuo58ck3OhKyIAQoRyCEKY%3D" alt="" loading="lazy"/></p>
<p>内容非常全面，非常适合想要实战 AI 项目或者准备 AI 大模型应用开发岗位面试的朋友，来一张刚写完的<strong>3.4w 字+35 道题目</strong>的 RAG 面试题总结，大家感受一下（点此链接了解： <a href="https://link.juejin.cn?target=https%3A%2F%2Fjavaguide.cn%2Fabout-the-author%2Fzhishixingqiu-two-years.html" target="_blank" title="https://javaguide.cn/about-the-author/zhishixingqiu-two-years.html" ref="nofollow noopener noreferrer">星球</a>）：</p>
<h3 data-id="heading-11">模式和模型选择</h3>
<p>Claude Code 的 ACP 模式会识别你原本配置的所有设置，包括：</p>
<ol>
<li><strong>模式选择</strong>：Plan 模式、Code 模式等</li>
<li><strong>模型选择</strong>：claude-sonnet-4.5、claude-opus-4.5 等</li>
<li><strong>第三方中转站</strong>：如果你配置了自定义 API 地址，也会生效</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d34ba5ea908473a95f4dd44e604f8a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197598&amp;x-signature=zO9ZIrJE7WJQMYu%2FRlrGyXGeDNE%3D" alt="" loading="lazy"/></p>
<p>可以看到我这里目前就成功对接了第三方 GLM 模型，这个在国内也是用的人比较多的：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09e775f898014550a526b502f13bcba8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197598&amp;x-signature=2Qn%2By8xyQpDMOmJRQr3nlXOZcX0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">MCP 工具支持</h3>
<p>这是 ACP 方式相比内置 Agent 的最大优势——<strong>完整支持 MCP（Model Context Protocol）工具</strong>。</p>
<p>MCP 是 Anthropic 推出的另一个协议，用来让 LLM 接入外部工具和数据源。比如你可以配置：</p>
<ul>
<li><strong>文件系统工具</strong>：让 Agent 读写项目文件</li>
<li><strong>Git 工具</strong>：让 Agent 执行 commit、diff 操作</li>
<li><strong>数据库工具</strong>：让 Agent 查询生产环境数据</li>
<li><strong>自定义 API</strong>：接入公司内部服务</li>
</ul>
<p>用 ACP 接入 Claude Code 后，这些 MCP 工具都会被识别并可用。而 AI Assistant 内置的 Claude Agent 只能识别第三方 API 地址，MCP 工具是<strong>不支持</strong>的。</p>
<h2 data-id="heading-13">ACP vs 内置 Agent：如何选择？</h2>













































<table><thead><tr><th><strong>特性</strong></th><th><strong>ACP (Claude Code + Adapter)</strong></th><th><strong>IDEA 内置 Claude Agent (官方/三方插件)</strong></th></tr></thead><tbody><tr><td><strong>核心定位</strong></td><td>终端驱动的任务型机器人 (Task-Oriented)</td><td>侧边栏对话型助手 (Chat-Oriented)</td></tr><tr><td><strong>MCP 工具支持</strong></td><td><strong>✅ 完整原生支持</strong> (可调用本地 Python/DB 等)</td><td><strong>❌ 支持有限</strong> (多局限于 IDE 内部 API)</td></tr><tr><td><strong>模型灵活性</strong></td><td><strong>✅ 极高</strong> (自由切换 3.5 Sonnet / 3.7 / Opus)</td><td><strong>⚠️ 受限</strong> (通常绑定插件商提供的特定版本)</td></tr><tr><td><strong>API 兼容性</strong></td><td><strong>✅ 支持</strong> 中转站 / OneAPI 等自定义 Endpoint</td><td><strong>⚠️ 部分支持</strong> (官方插件常强制要求官方 Key)</td></tr><tr><td><strong>工作模式</strong></td><td><strong>✅ 拥有 Plan / Act 独立模式</strong></td><td><strong>❌ 主要是单轮或多轮对话</strong></td></tr><tr><td><strong>环境上下文</strong></td><td><strong>✅ 强</strong> (通过 MCP 直接读取系统/库文档)</td><td><strong>✅ 强</strong> (深度集成 IDE 索引，理解代码库)</td></tr><tr><td><strong>配置门槛</strong></td><td><strong>较高</strong> (需要配置 Node 环境及 Proxy)</td><td><strong>极低</strong> (插件市场一键安装)</td></tr></tbody></table>
<p><strong>建议</strong>：</p>
<ul>
<li>如果你<strong>需要 MCP 工具</strong>，必须用 ACP 方式</li>
<li>如果你<strong>习惯 Claude Code 的 Plan 模式</strong>，用 ACP 更顺手</li>
<li>如果你<strong>想要开箱即用</strong>，内置 Agent 更省心</li>
</ul>
<h2 data-id="heading-14">接入其他 Agent</h2>
<p>除了 Claude Code，你也可以接入其他支持 ACP 的 Agent。比如 Gemini CLI (Google) 、 Cagent (Docker)：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"agent_servers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"Claude Code"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/Users/guide/Library/pnpm/claude-code-acp"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"Gemini CLI"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"gemini-acp"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"--model"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"gemini-2.0-pro"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"Docker Cagent"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cagent"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"acp"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"agent.yml"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-15">踩坑与排查</h2>
<h3 data-id="heading-16">ACP 初始化失败</h3>
<p>JetBrains AI Assistant 无法运行 "pnpm" 命令（<code>IOException: Cannot run program "pnpm", error=2, No such file or directory</code>）。</p>
<pre><code class="hljs language-bash" lang="bash">❯ pnpm bin -g
/Users/guide/Library/pnpm
❯ <span class="hljs-built_in">ls</span> /Users/guide/Library/pnpm
claude-code-acp global
</code></pre>
<p>注意将 command 路径替换为你本地的，或者将其添加到环境变量中。</p>
<h3 data-id="heading-17">Agent 无响应</h3>
<p>如果选择 Agent 后聊天没反应：</p>
<ol>
<li>检查 Agent 进程是否启动：<code>ps aux | grep claude-code-acp</code></li>
<li>查看 AI Assistant 的日志：<code>Help &gt; Show Log in Finder</code></li>
<li>确认 Claude Code 本身能正常在终端运行</li>
</ol>
<h2 data-id="heading-18">总结</h2>
<p>ACP 目前还处于快速发展阶段，2025 年底才正式进入 Beta。有几个值得期待的方向：</p>
<ol>
<li><strong>更多 Agent 支持</strong>：Cursor、Windsurf 等热门 AI 工具可能会推出 ACP Server</li>
<li><strong>Per-Project 配置</strong>：JetBrains 的 Issue 追踪显示，他们正在计划支持项目级别的 ACP 配置</li>
<li><strong>社区生态</strong>：随着协议开放，可能会出现更多第三方 Agent</li>
</ol>
<p>如果你是 JetBrains IDE 的重度用户，又不太喜欢在终端环境使用 Claude Code ，或者你需要 MCP 工具的强大能力，那么 ACP 就是目前的终极解决方案。</p>
<p>虽然配置稍微麻烦一点，但一旦搞定，你就能在熟悉的 IDE 环境里获得：</p>
<ul>
<li>稳定的 UI 体验</li>
<li>完整的 Claude Code 功能</li>
<li>MCP 工具的加持</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SystemUI 开发之 NSSL.addContainerView() 之后发生了什么（八）]]></title>    <link>https://juejin.cn/post/7599579865609076778</link>    <guid>https://juejin.cn/post/7599579865609076778</guid>    <pubDate>2026-01-27T07:56:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599579865609076778" data-draft-id="7599579865608912938" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SystemUI 开发之 NSSL.addContainerView() 之后发生了什么（八）"/> <meta itemprop="keywords" content="Android,Kotlin,架构"/> <meta itemprop="datePublished" content="2026-01-27T07:56:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="愤怒的代码"/> <meta itemprop="url" content="https://juejin.cn/user/4125023358426190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SystemUI 开发之 NSSL.addContainerView() 之后发生了什么（八）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4125023358426190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    愤怒的代码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T07:56:49.000Z" title="Tue Jan 27 2026 07:56:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在前文的代码追踪中 <strong><code>NotificationViewHierarchyManager</code></strong> 将 <code>ExpandableNotificationRow</code> 通过<code>addContainerView</code> 方法传给了<code>NotificationStackScrollLayout</code> 并使用 <code>addView</code> 添加到子<code>View</code>中。接下来看看这一个过程。</p>
<h2 data-id="heading-0">0x00、<code>NSSL.addContainerView()</code></h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addContainerView</span><span class="hljs-params">(View v)</span> {
    Assert.isMainThread();
    addView(v);
}
</code></pre>
<h2 data-id="heading-1">0x01、<code>ViewGroup.addView()</code></h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addView</span><span class="hljs-params">(View child)</span> {
    addView(child, -<span class="hljs-number">1</span>);
}

...

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addView</span><span class="hljs-params">(View child, <span class="hljs-type">int</span> index, LayoutParams params)</span> {
    <span class="hljs-keyword">if</span> (DBG) {
        System.out.println(<span class="hljs-built_in">this</span> + <span class="hljs-string">" addView"</span>);
    }

    <span class="hljs-keyword">if</span> (child == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"Cannot add a null child view to a ViewGroup"</span>);
    }

    <span class="hljs-comment">// addViewInner() will call child.requestLayout() when setting the new LayoutParams</span>
    <span class="hljs-comment">// therefore, we call requestLayout() on ourselves before, so that the child's request</span>
    <span class="hljs-comment">// will be blocked at our level</span>
    <span class="hljs-comment">// 1、执行了requstLayout</span>
    requestLayout();
    invalidate(<span class="hljs-literal">true</span>);
    <span class="hljs-comment">// 2、执行 addView 操作</span>
    addViewInner(child, index, params, <span class="hljs-literal">false</span>);
}
</code></pre>
<p><code>ViewGroup.addView()</code> 会执行到 <code>requestLayout()</code> 中来</p>
<h3 data-id="heading-2">1、<code>View.requestLayout()</code></h3>
<p><code>requestLayout()</code> 会不停地向上查找直到 <code>ViewRootImpl</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestLayout</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (mMeasureCache != <span class="hljs-literal">null</span>) mMeasureCache.clear();

    <span class="hljs-keyword">if</span> (mAttachInfo != <span class="hljs-literal">null</span> &amp;&amp; mAttachInfo.mViewRequestingLayout == <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// Only trigger request-during-layout logic if this is the view requesting it,</span>
        <span class="hljs-comment">// not the views in its parent hierarchy</span>
        <span class="hljs-type">ViewRootImpl</span> <span class="hljs-variable">viewRoot</span> <span class="hljs-operator">=</span> getViewRootImpl();
        <span class="hljs-keyword">if</span> (viewRoot != <span class="hljs-literal">null</span> &amp;&amp; viewRoot.isInLayout()) {
            <span class="hljs-keyword">if</span> (!viewRoot.requestLayoutDuringLayout(<span class="hljs-built_in">this</span>)) {
                <span class="hljs-keyword">return</span>;
            }
        }
        mAttachInfo.mViewRequestingLayout = <span class="hljs-built_in">this</span>;
    }

    mPrivateFlags |= PFLAG_FORCE_LAYOUT;
    mPrivateFlags |= PFLAG_INVALIDATED;

    <span class="hljs-keyword">if</span> (mParent != <span class="hljs-literal">null</span> &amp;&amp; !mParent.isLayoutRequested()) {
		    <span class="hljs-comment">// 开始向上回溯</span>
        mParent.requestLayout();
    }
    <span class="hljs-keyword">if</span> (mAttachInfo != <span class="hljs-literal">null</span> &amp;&amp; mAttachInfo.mViewRequestingLayout == <span class="hljs-built_in">this</span>) {
        mAttachInfo.mViewRequestingLayout = <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<h3 data-id="heading-3">2、<code>ViewRootImpl.requestLayout()</code></h3>
<p>在 <code>ViewRootImpl</code> 中执行了 <code>scheduleTraversals()</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestLayout</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (!mHandlingLayoutInLayoutRequest) {
        checkThread();
        mLayoutRequested = <span class="hljs-literal">true</span>;
        <span class="hljs-comment">// 又到了这个非常著名的方法了</span>
        scheduleTraversals();
    }
}

<span class="hljs-keyword">void</span> <span class="hljs-title function_">scheduleTraversals</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (!mTraversalScheduled) {
        mTraversalScheduled = <span class="hljs-literal">true</span>;
        <span class="hljs-comment">// 发送同步屏障</span>
        mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();
        <span class="hljs-comment">// 注册 VSYNC 信号，监听回调触发UI渲染</span>
        mChoreographer.postCallback(
                Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, <span class="hljs-literal">null</span>);
        notifyRendererOfFramePending();
        pokeDrawLockIfNeeded();
    }
}
</code></pre>
<p>在 <code>mTraversalRunnable</code> 回调中最后执行 <code>doTraversal()</code> ，在此方法中执行了 <code>performTraversals()</code> ，就在这个方法中触发<code>measure</code>、<code>layout</code> 和 <code>draw</code> 的操作。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">doTraversal</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (mTraversalScheduled) {
        mTraversalScheduled = <span class="hljs-literal">false</span>;
        <span class="hljs-comment">// 移除同步屏障</span>
        mHandler.getLooper().getQueue().removeSyncBarrier(mTraversalBarrier);

        <span class="hljs-keyword">if</span> (mProfile) {
            Debug.startMethodTracing(<span class="hljs-string">"ViewAncestor"</span>);
        }
				<span class="hljs-comment">// 执行 measure、layout、draw 三大操作</span>
        performTraversals();

        <span class="hljs-keyword">if</span> (mProfile) {
            Debug.stopMethodTracing();
            mProfile = <span class="hljs-literal">false</span>;
        }
    }
}
</code></pre>
<p>这个过程可以简化如下：</p>
<p><code>addView</code>→ <code>requestLayout</code> → <code>scheduleTraversals</code> →监听<code>VSYNC</code>→ <code>doTraversal</code> → <code>performTraversals</code> → <code>measure</code> + <code>layout</code> + <code>draw</code></p>
<h3 data-id="heading-4">3、<code>ViewGroup.addViewInner()</code></h3>
<p>接下来在 <code>addViewInner</code> 方法中触发了 <code>dispatchViewAdded</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addViewInner</span><span class="hljs-params">(View child, <span class="hljs-type">int</span> index, LayoutParams params,
        <span class="hljs-type">boolean</span> preventRequestLayout)</span> {

    ...
    addInArray(child, index);

    <span class="hljs-comment">// tell our children</span>
    <span class="hljs-keyword">if</span> (preventRequestLayout) {
        child.assignParent(<span class="hljs-built_in">this</span>);
    } <span class="hljs-keyword">else</span> {
        child.mParent = <span class="hljs-built_in">this</span>;
    }
    <span class="hljs-keyword">if</span> (child.hasUnhandledKeyListener()) {
        incrementChildUnhandledKeyListeners();
    }

    <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">childHasFocus</span> <span class="hljs-operator">=</span> child.hasFocus();
    <span class="hljs-keyword">if</span> (childHasFocus) {
        requestChildFocus(child, child.findFocus());
    }

    <span class="hljs-type">AttachInfo</span> <span class="hljs-variable">ai</span> <span class="hljs-operator">=</span> mAttachInfo;
    <span class="hljs-keyword">if</span> (ai != <span class="hljs-literal">null</span> &amp;&amp; (mGroupFlags &amp; FLAG_PREVENT_DISPATCH_ATTACHED_TO_WINDOW) == <span class="hljs-number">0</span>) {
        <span class="hljs-type">boolean</span> <span class="hljs-variable">lastKeepOn</span> <span class="hljs-operator">=</span> ai.mKeepScreenOn;
        ai.mKeepScreenOn = <span class="hljs-literal">false</span>;
        child.dispatchAttachedToWindow(mAttachInfo, (mViewFlags&amp;VISIBILITY_MASK));
        <span class="hljs-keyword">if</span> (ai.mKeepScreenOn) {
            needGlobalAttributesUpdate(<span class="hljs-literal">true</span>);
        }
        ai.mKeepScreenOn = lastKeepOn;
    }

    <span class="hljs-keyword">if</span> (child.isLayoutDirectionInherited()) {
        child.resetRtlProperties();
    }
		<span class="hljs-comment">// 分发添加</span>
    dispatchViewAdded(child);

    ...
}
</code></pre>
<p>进入了 <code>dispatchViewAdded()</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">dispatchViewAdded</span><span class="hljs-params">(View child)</span> {
    onViewAdded(child);
    <span class="hljs-keyword">if</span> (mOnHierarchyChangeListener != <span class="hljs-literal">null</span>) {
        mOnHierarchyChangeListener.onChildViewAdded(<span class="hljs-built_in">this</span>, child);
    }
}

<span class="hljs-comment">/**
 * Called when a new child is added to this ViewGroup. Overrides should always
 * call super.onViewAdded.
 *
 * <span class="hljs-doctag">@param</span> child the added child view
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onViewAdded</span><span class="hljs-params">(View child)</span> {
	<span class="hljs-comment">// 这个方法给子类实现用的</span>
}
</code></pre>
<p>在这里又回调了子类实现的 <code>onViewAdded()</code></p>
<p>即当执行 <code>addView</code> 操作后除了触发 <code>ViewRootImpl</code> 的<code>VSYNC</code>信号订阅外，还回触发 <code>onViewAdded</code> 方法。</p>
<h2 data-id="heading-5">0x02、<code>NSSL.onViewAdded()</code></h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onViewAdded</span><span class="hljs-params">(View child)</span> {
    <span class="hljs-built_in">super</span>.onViewAdded(child);
    onViewAddedInternal((ExpandableView) child);
}

<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onViewAddedInternal</span><span class="hljs-params">(ExpandableView child)</span> {
		<span class="hljs-comment">// 锁屏时自动隐藏敏感通知内容</span>
    updateHideSensitiveForChild(child);
    <span class="hljs-comment">// 监听通知项的展开/折叠，实现流畅的连锁动画和布局调整</span>
    child.setOnHeightChangedListener(<span class="hljs-built_in">this</span>);
    <span class="hljs-comment">//新通知滑入、淡入的动画效果，提供操作响应感</span>
    generateAddAnimation(child, <span class="hljs-literal">false</span> <span class="hljs-comment">/* fromMoreCard */</span>);
    <span class="hljs-comment">//确保新通知的动画与整个列表的展开/折叠状态同步</span>
    updateAnimationState(child);
    <span class="hljs-comment">//更新通知中的“时间戳”（如“刚刚”），确保信息准确</span>
    updateChronometerForChild(child);
    <span class="hljs-keyword">if</span> (child <span class="hljs-keyword">instanceof</span> ExpandableNotificationRow) {
        ((ExpandableNotificationRow) child).setDismissRtl(mDismissRtl);
    }
    <span class="hljs-keyword">if</span> (ANCHOR_SCROLLING) {
        <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> once we're recycling this will need to check the adapter position of the child</span>
        <span class="hljs-keyword">if</span> (child == getFirstChildNotGone() &amp;&amp; (isScrolledToTop() || !mIsExpanded)) {
            <span class="hljs-comment">// New child was added at the top while we're scrolled to the top;</span>
            <span class="hljs-comment">// make it the new anchor view so that we stay at the top.</span>
            mScrollAnchorView = child;
        }
    }
}
</code></pre>
<h3 data-id="heading-6"><strong>与 <code>requestLayout</code> 流程的关系</strong></h3>
<p>将这些逻辑置于 <code>onViewAdded</code> 中的时机选择非常精妙：</p>
<ol>
<li><strong>即刻配置（<code>onViewAdded</code> 中）</strong>：在新通知视图进入容器的<strong>第一时间</strong>，就完成所有状态同步和关系绑定。此时，视图尚未布局。</li>
<li><strong>动态响应（后续 <code>layout</code> 过程中）</strong>：由于提前设置了 <code>OnHeightChangedListener</code>，当通知在后续交互中展开/折叠（改变高度）时，NSSL 能在监听器回调中再次触发 <code>requestLayout()</code>。</li>
<li><strong>闭环形成</strong>：这就形成了一个 <code>addView</code> → 配置 → <code>layout</code> → 用户交互 → 高度变化 → 回调 → 再次 <code>requestLayout</code> → 重新 <code>layout</code> 的<strong>完美闭环</strong>，支撑起整个动态列表。</li>
</ol>
<p>简单来说，<code>onViewAdded</code> 中的代码为每个新通知装上了 <strong>“遥控器”</strong> 和 <strong>“定位器”</strong> ，让 NSSL 这个“总控台”能够实时感知并精确控制每一个成员，从而实现高度动态、流畅的通知列表效果。</p>
<p><strong>接下来看看 layout 过程。</strong></p>
<h2 data-id="heading-7">0x03、<code>NSSL.onLayout()</code></h2>
<h3 data-id="heading-8">1、首先所有子 View 居中置顶</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onLayout</span><span class="hljs-params">(<span class="hljs-type">boolean</span> changed, <span class="hljs-type">int</span> l, <span class="hljs-type">int</span> t, <span class="hljs-type">int</span> r, <span class="hljs-type">int</span> b)</span> {
    <span class="hljs-comment">// we layout all our children centered on the top</span>
    <span class="hljs-comment">// 计算中心点位置</span>
    <span class="hljs-type">float</span> <span class="hljs-variable">centerX</span> <span class="hljs-operator">=</span> getWidth() / <span class="hljs-number">2.0f</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; getChildCount(); i++) {
        <span class="hljs-type">View</span> <span class="hljs-variable">child</span> <span class="hljs-operator">=</span> getChildAt(i);
        <span class="hljs-comment">// We need to layout all children even the GONE ones, such that the heights are</span>
        <span class="hljs-comment">// calculated correctly as they are used to calculate how many we can fit on the screen</span>
        <span class="hljs-type">float</span> <span class="hljs-variable">width</span> <span class="hljs-operator">=</span> child.getMeasuredWidth();
        <span class="hljs-type">float</span> <span class="hljs-variable">height</span> <span class="hljs-operator">=</span> child.getMeasuredHeight();
        <span class="hljs-comment">// left = centerX - width / 2.0f </span>
        <span class="hljs-comment">// 目的让 child 居中，top 固定为 0</span>
        child.layout((<span class="hljs-type">int</span>) (centerX - width / <span class="hljs-number">2.0f</span>),
                <span class="hljs-number">0</span>,
                (<span class="hljs-type">int</span>) (centerX + width / <span class="hljs-number">2.0f</span>),
                (<span class="hljs-type">int</span>) height);
    }
    <span class="hljs-comment">// 锁定 NSSL 的最大可用高度，并将此高度传递给 mShelf（通知托盘）。</span>
    <span class="hljs-comment">// 这决定了通知在滚动到哪个位置时应该开始“收缩”进入底部托盘。</span>
    setMaxLayoutHeight(getHeight());
    <span class="hljs-comment">// 计算当前所有通知的总高度（Intrinsic Height），这个加上通知之间的间距（Padding）</span>
    <span class="hljs-comment">// 以及 Section 之间的间隔</span>
    updateContentHeight();
    <span class="hljs-comment">// 防止由于布局改变（例如某条通知消失）导致的“非法滚动”。</span>
    <span class="hljs-comment">// 如果当前滚动量超过了新的内容总高度，它会将滚动条强制回弹到合法范围内。</span>
    clampScrollPosition();
		<span class="hljs-comment">// 这个方法向 ViewTreeObserver 注册一个 onPreDraw 监听。</span>
		<span class="hljs-comment">// 在下一帧绘制前，**StackScrollAlgorithm** 会介入，</span>
		<span class="hljs-comment">// 根据当前状态计算出每个 View 真正应该存在的 TranslationY</span>
    requestChildrenUpdate();
    <span class="hljs-comment">// 更新背景，通知列表是一个整体，需要为有圆角和边界的Item确定效果，</span>
    updateFirstAndLastBackgroundViews();
    <span class="hljs-comment">// 更新算法所需的最小高度</span>
    updateAlgorithmLayoutMinHeight();
    <span class="hljs-comment">// 根据通知在堆栈中的位置（是否有悬浮、是否是第一条）动态调整 TranslationZ。</span>
    <span class="hljs-comment">// 这是渲染阴影的关键，确保上层的通知阴影能正确投射在下层通知上</span>
    updateOwnTranslationZ();
}
</code></pre>
<p><strong>为什么top是0？</strong> NSSL 是一个高度动态的列表，通知的 Y 轴坐标受到滚动、展开进度、阻尼回弹、分组折叠等几十个变量影响。如果在 <code>onLayout</code> 中硬编码 Y 坐标，会导致频繁的 <code>requestLayout</code>，性能极差。因此，NSSL 选择在 <code>onLayout</code> 中完成基础定位，而将复杂的 Y 轴偏移交给 <strong><code>setTranslationY()</code></strong></p>
<p>**这样做的好处是：**当用户滚动列表时，NSSL 只需要改变子 View 的 <code>TranslationY</code>，这由 GPU 处理，不需要触发代价昂贵的全局 <code>layout</code> 过程，从而保证了通知中心滑动的极致流畅。</p>
<h3 data-id="heading-9">2、设置容器大小</h3>
<p><code>setMaxLayoutHeight</code> 和 <code>updateContentHeight</code> 设置通知列表高度。</p>
<h3 data-id="heading-10">3、触发渲染</h3>
<p><code>requestChildrenUpdate</code>它会向 <code>ViewTreeObserver</code> 注册一个 <code>onPreDraw</code> 监听。在下一帧绘制前，<strong><code>StackScrollAlgorithm</code></strong> 会介入，根据当前状态计算出每个 <code>View</code> 真正应该存在的 <code>TranslationY</code>。</p>
<p><strong>总结</strong></p>
<ul>
<li>结构层面：<code>addView</code> 触发 <code>requestLayout</code>，一路到 <code>ViewRootImpl</code>，由 VSYNC 驱动一次完整的 <code>measure/layout/draw</code>。</li>
<li>控制层面：<code>onViewAdded()</code> 中完成新通知的状态绑定和监听器安装，使其之后的任何高度和状态变化，都能回流到 NSSL 的布局和动画系统。</li>
<li>布局与动画层面：<code>onLayout()</code> 做统一基准布局，<code>requestChildrenUpdate()</code> + <code>StackScrollAlgorithm</code> 在下一帧前计算并下发真正的 TranslationY 和 Z，从而构建出一个依赖 GPU 合成、性能友好的动态通知列表。</li>
</ul>
<p><strong><code>NSSL.addContainerView()</code> 不只是“把 View 插进列表”，而是通过 <code>requestLayout + VSYNC + onViewAdded + 算法驱动 TranslationY</code>，把这条通知完全纳入到 NSSL 的滚动、动画和可见性控制闭环中，既保证结构正确，又保证交互流畅。</strong></p>
<blockquote>
<p><code>StackScrollAlgorithm</code> 对于 <code>NSSL</code> 非常重要，它是通知列表的排序算法的逻辑计算模块</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redisson分布式锁：从入门到实战]]></title>    <link>https://juejin.cn/post/7599581687357947954</link>    <guid>https://juejin.cn/post/7599581687357947954</guid>    <pubDate>2026-01-27T01:09:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599581687357947954" data-draft-id="7599514071104946191" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redisson分布式锁：从入门到实战"/> <meta itemprop="keywords" content="Redis"/> <meta itemprop="datePublished" content="2026-01-27T01:09:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redisson分布式锁：从入门到实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T01:09:35.000Z" title="Tue Jan 27 2026 01:09:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Redisson分布式锁：从入门到实战</h2>
<h3 data-id="heading-1">一、为什么需要分布式锁？</h3>
<p>在单体应用中，我们使用Java的synchronized或ReentrantLock就能解决并发问题。但在微服务架构下，多个实例同时运行，单机的锁机制就失效了。这时就需要分布式锁来保证跨JVM的互斥访问。</p>
<h4 data-id="heading-2">分布式锁的核心需求</h4>
<ol>
<li><strong>互斥性</strong>：同一时刻只能有一个客户端持有锁</li>
<li><strong>防止死锁</strong>：客户端崩溃后能自动释放锁</li>
<li><strong>容错性</strong>：Redis节点故障时仍能正常工作</li>
<li><strong>可重入性</strong>：同一个线程可以多次获取同一个锁</li>
</ol>
<h3 data-id="heading-3">二、Redis实现分布式锁的基础方案</h3>
<h4 data-id="heading-4">2.1 最简单的实现：SET NX</h4>
<p>最早期的实现方式是使用SET命令的NX选项：</p>
<pre><code class="hljs language-bash" lang="bash">SET key value NX PX 30000
</code></pre>
<ul>
<li>NX：只在key不存在时设置</li>
<li>PX：设置过期时间（毫秒）</li>
</ul>
<p>这种方式的缺点：</p>
<ul>
<li>无法实现可重入锁</li>
<li>无法获取锁的持有人信息</li>
<li>无法实现锁的自动续期</li>
</ul>
<h4 data-id="heading-5">2.2 完整实现方案</h4>
<p>一个相对完善的Redis分布式锁实现需要包含以下逻辑：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36710f1f72a74b159d94a971215edebd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770080976&amp;x-signature=RHisUCpuSPWs3zklvdtyQfftwKM%3D" alt="" loading="lazy"/></p>
<ol>
<li><strong>加锁</strong>：SET key value NX PX timeout</li>
<li><strong>解锁</strong>：Lua脚本保证原子性</li>
<li><strong>看门狗</strong>：定时续期防止业务执行时间超过锁过期时间</li>
</ol>
<h3 data-id="heading-6">三、Redisson分布式锁</h3>
<p>Redisson是Redis的Java客户端，它提供了完善的分布式锁实现，解决了原生Redis锁的各种问题。</p>
<h4 data-id="heading-7">3.1 核心特性</h4>
<ol>
<li><strong>可重入锁</strong>：同一个线程可多次获取锁</li>
<li><strong>公平锁</strong>：按请求顺序获取锁</li>
<li><strong>读写锁</strong>：允许多个读操作或单个写操作</li>
<li><strong>红锁</strong>：跨多个Redis节点的分布式锁</li>
<li><strong>自动续期</strong>：看门狗机制自动延长锁时间</li>
<li><strong>锁释放</strong>：Lua脚本保证原子性操作</li>
</ol>
<h4 data-id="heading-8">3.2 基本使用</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 获取锁对象</span>
<span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redisson.getLock(<span class="hljs-string">"myLock"</span>);

<span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 加锁（支持等待时间和自动续期）</span>
    <span class="hljs-type">boolean</span> <span class="hljs-variable">locked</span> <span class="hljs-operator">=</span> lock.tryLock(<span class="hljs-number">100</span>, <span class="hljs-number">30000</span>, TimeUnit.MILLISECONDS);
    <span class="hljs-keyword">if</span> (locked) {
        <span class="hljs-comment">// 执行业务逻辑</span>
        doBusiness();
    }
} <span class="hljs-keyword">finally</span> {
    <span class="hljs-comment">// 释放锁</span>
    <span class="hljs-keyword">if</span> (lock.isHeldByCurrentThread()) {
        lock.unlock();
    }
}
</code></pre>
<h3 data-id="heading-9">四、Redis实现 vs Redisson对比</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae00c47f604148e6a4006e0bae3d4cad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770080976&amp;x-signature=Qq5jyVZ3y4KFv6fIsSOvYt1aiHY%3D" alt="" loading="lazy"/></p>













































<table><thead><tr><th>特性</th><th>Redis原生实现</th><th>Redisson</th></tr></thead><tbody><tr><td>实现复杂度</td><td>高，需要处理多种边界情况</td><td>低，开箱即用</td></tr><tr><td>可重入锁</td><td>需要自己实现</td><td>原生支持</td></tr><tr><td>自动续期</td><td>需要后台线程续期</td><td>看门狗自动续期</td></tr><tr><td>公平锁</td><td>难以实现</td><td>开箱即用</td></tr><tr><td>读写锁</td><td>难以实现</td><td>开箱即用</td></tr><tr><td>红锁</td><td>需要自己协调</td><td>开箱即用</td></tr><tr><td>异常处理</td><td>需要仔细处理</td><td>完善的异常体系</td></tr></tbody></table>
<p><strong>结论</strong>：生产环境推荐使用Redisson，它已经处理了各种边界情况和异常场景。</p>
<h3 data-id="heading-10">五、Redisson核心原理解析</h3>
<h4 data-id="heading-11">5.1 加锁机制</h4>
<p>Redisson使用Lua脚本保证加锁的原子性：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6db4760a8ca34874b3d5029848f7c0b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770080976&amp;x-signature=NHt9Yu2zVeFx0zVw4zP3zyK0%2FaM%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- 检查key是否存在</span>
<span class="hljs-keyword">if</span> redis.call(<span class="hljs-string">'exists'</span>, KEYS[<span class="hljs-number">1</span>]) == <span class="hljs-number">0</span> <span class="hljs-keyword">then</span>
    <span class="hljs-comment">-- 不存在则设置，使用hash结构存储</span>
    redis.call(<span class="hljs-string">'hset'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">2</span>], <span class="hljs-number">1</span>)
    redis.call(<span class="hljs-string">'pexpire'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">1</span>])
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
<span class="hljs-keyword">end</span>

<span class="hljs-comment">-- key已存在，检查是否是当前线程</span>
<span class="hljs-keyword">if</span> redis.call(<span class="hljs-string">'hexists'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">2</span>]) == <span class="hljs-number">1</span> <span class="hljs-keyword">then</span>
    <span class="hljs-comment">-- 是当前线程，增加重入次数</span>
    redis.call(<span class="hljs-string">'hincrby'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">2</span>], <span class="hljs-number">1</span>)
    redis.call(<span class="hljs-string">'pexpire'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">1</span>])
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
<span class="hljs-keyword">end</span>

<span class="hljs-keyword">return</span> redis.call(<span class="hljs-string">'pttl'</span>, KEYS[<span class="hljs-number">1</span>])
</code></pre>
<p>锁的数据结构使用Hash类型：</p>
<ul>
<li>Key：锁名称</li>
<li>Field：线程标识（UUID:threadId）</li>
<li>Value：重入次数</li>
</ul>
<h4 data-id="heading-12">5.2 看门狗机制</h4>
<p>看门狗（Watchdog）是Redisson的核心特性，用于解决锁超时问题：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa290857b347461caa2c83f8f3808431~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770080976&amp;x-signature=pgDfxuK1gt4hgqT42KMG0Dxrh%2F4%3D" alt="" loading="lazy"/></p>
<ol>
<li>业务获得锁时，启动后台定时任务</li>
<li>每隔lockWatchdogTimeout/3时间检查锁是否还持有</li>
<li>如果还持有则重置过期时间</li>
<li>业务释放锁时停止看门狗</li>
</ol>
<p>默认情况下，看门狗每10秒续期一次，锁的过期时间为30秒。</p>
<h4 data-id="heading-13">5.3 解锁机制</h4>
<p>解锁同样使用Lua脚本保证原子性：</p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- 检查锁是否是当前线程持有</span>
<span class="hljs-keyword">if</span> redis.call(<span class="hljs-string">'hexists'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">2</span>]) &lt;= <span class="hljs-number">0</span> <span class="hljs-keyword">then</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
<span class="hljs-keyword">end</span>

<span class="hljs-comment">-- 减少重入次数</span>
<span class="hljs-keyword">local</span> counter = redis.call(<span class="hljs-string">'hincrby'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">2</span>], <span class="hljs-number">-1</span>)

<span class="hljs-comment">-- 如果重入次数大于0，重置过期时间</span>
<span class="hljs-keyword">if</span> counter &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span>
    redis.call(<span class="hljs-string">'pexpire'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">1</span>])
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
<span class="hljs-keyword">end</span>

<span class="hljs-comment">-- 重入次数为0，删除锁</span>
redis.call(<span class="hljs-string">'del'</span>, KEYS[<span class="hljs-number">1</span>])
<span class="hljs-comment">-- 发布解锁消息</span>
redis.call(<span class="hljs-string">'publish'</span>, KEYS[<span class="hljs-number">2</span>], ARGV[<span class="hljs-number">3</span>])
<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>
</code></pre>
<h3 data-id="heading-14">六、生产环境实战案例</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b30e1e93811642378d9b2fe34cce8d18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770080976&amp;x-signature=W0esadRxVnzvogk%2Be2mzMTPpWdo%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-15">6.1 库存扣减</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InventoryService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedissonClient redisson;

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">deductStock</span><span class="hljs-params">(String productId, <span class="hljs-type">int</span> quantity)</span> {
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redisson.getLock(<span class="hljs-string">"stock:"</span> + productId);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 等待5秒，锁过期30秒</span>
            <span class="hljs-keyword">if</span> (lock.tryLock(<span class="hljs-number">5</span>, <span class="hljs-number">30</span>, TimeUnit.SECONDS)) {
                <span class="hljs-comment">// 查询库存</span>
                <span class="hljs-type">int</span> <span class="hljs-variable">stock</span> <span class="hljs-operator">=</span> getStock(productId);
                <span class="hljs-keyword">if</span> (stock &gt;= quantity) {
                    <span class="hljs-comment">// 扣减库存</span>
                    updateStock(productId, stock - quantity);
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                }
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"系统繁忙，请稍后重试"</span>);
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-16">6.2 订单幂等性控制</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedissonClient redisson;

    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrder</span><span class="hljs-params">(OrderRequest request)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"order:create:"</span> + request.getUserId();
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redisson.getLock(lockKey);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (lock.tryLock(<span class="hljs-number">3</span>, <span class="hljs-number">10</span>, TimeUnit.SECONDS)) {
                <span class="hljs-comment">// 检查是否已有未完成订单</span>
                <span class="hljs-type">Order</span> <span class="hljs-variable">existOrder</span> <span class="hljs-operator">=</span> getUnfinishedOrder(request.getUserId());
                <span class="hljs-keyword">if</span> (existOrder != <span class="hljs-literal">null</span>) {
                    <span class="hljs-keyword">return</span> existOrder;
                }

                <span class="hljs-comment">// 创建新订单</span>
                <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> buildOrder(request);
                saveOrder(order);
                <span class="hljs-keyword">return</span> order;
            }
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"操作频繁，请稍后重试"</span>);
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-17">6.3 定时任务防止重复执行</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSyncJob</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedissonClient redisson;

    <span class="hljs-meta">@Scheduled(cron = "0 */5 * * * *")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">syncData</span><span class="hljs-params">()</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"job:data:sync"</span>;
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redisson.getLock(lockKey);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 尝试获取锁，不等待</span>
            <span class="hljs-keyword">if</span> (lock.tryLock(<span class="hljs-number">0</span>, TimeUnit.SECONDS)) {
                <span class="hljs-comment">// 执行数据同步</span>
                doSync();
            } <span class="hljs-keyword">else</span> {
                log.info(<span class="hljs-string">"上次同步任务尚未完成，跳过本次执行"</span>);
            }
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-18">七、高级特性：读写锁</h3>
<p>在读多写少的场景下，使用读写锁可以大幅提升并发性能：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4e4fafcea334003a242580e3dd039c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770080976&amp;x-signature=ERgnPFuN1pzSf2ilxz0vG0vVEpM%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedissonClient redisson;

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getConfig</span><span class="hljs-params">(String key)</span> {
        <span class="hljs-type">RReadWriteLock</span> <span class="hljs-variable">rwLock</span> <span class="hljs-operator">=</span> redisson.getReadWriteLock(<span class="hljs-string">"config:"</span> + key);
        <span class="hljs-type">RLock</span> <span class="hljs-variable">readLock</span> <span class="hljs-operator">=</span> rwLock.readLock();

        <span class="hljs-keyword">try</span> {
            readLock.lock();
            <span class="hljs-comment">// 多个线程可以同时读取</span>
            <span class="hljs-keyword">return</span> queryFromDB(key);
        } <span class="hljs-keyword">finally</span> {
            readLock.unlock();
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateConfig</span><span class="hljs-params">(String key, String value)</span> {
        <span class="hljs-type">RReadWriteLock</span> <span class="hljs-variable">rwLock</span> <span class="hljs-operator">=</span> redisson.getReadWriteLock(<span class="hljs-string">"config:"</span> + key);
        <span class="hljs-type">RLock</span> <span class="hljs-variable">writeLock</span> <span class="hljs-operator">=</span> rwLock.writeLock();

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 写操作独占锁</span>
            writeLock.lock();
            updateDB(key, value);
            <span class="hljs-comment">// 清除缓存</span>
            clearCache(key);
        } <span class="hljs-keyword">finally</span> {
            writeLock.unlock();
        }
    }
}
</code></pre>
<h3 data-id="heading-19">八、最佳实践</h3>
<h4 data-id="heading-20">8.1 锁的粒度选择</h4>
<ol>
<li><strong>粗粒度</strong>：锁整个表或模块，简单但并发度低</li>
<li><strong>细粒度</strong>：锁单个记录，并发度高但实现复杂</li>
</ol>
<p><strong>推荐</strong>：根据业务场景选择合适的粒度，库存扣减用商品维度，订单创建用用户维度。</p>
<h4 data-id="heading-21">8.2 锁的过期时间设置</h4>
<ol>
<li>不要设置过短，避免业务未执行完就释放</li>
<li>不要设置过长，避免故障时长时间阻塞</li>
<li>Redisson的看门狗会自动续期，但要设置合理的初始时间</li>
</ol>
<p><strong>推荐</strong>：根据业务执行时间的P99值设置，预留50%余量。</p>
<h4 data-id="heading-22">8.3 异常处理</h4>
<ol>
<li>捕获中断异常，确保锁能被释放</li>
<li>使用tryLock而不是lock，避免无限等待</li>
<li>检查锁的持有状态，避免误释放</li>
</ol>
<h3 data-id="heading-23">九、常见问题</h3>
<h4 data-id="heading-24">Q1：Redisson锁会丢失吗？</h4>
<p>不会。Redisson使用看门狗机制，即使业务执行时间超过锁的过期时间，也会自动续期，直到业务主动释放锁。</p>
<h4 data-id="heading-25">Q2：Redis主从切换会影响锁吗？</h4>
<p>会。单节点Redis在主从切换时可能丢失锁。需要使用Redisson的红锁（RedLock）或Redis Cluster。</p>
<h4 data-id="heading-26">Q3：如何实现公平锁？</h4>
<p>Redisson提供了公平锁实现：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">RLock</span> <span class="hljs-variable">fairLock</span> <span class="hljs-operator">=</span> redisson.getFairLock(<span class="hljs-string">"myFairLock"</span>);
fairLock.lock();
</code></pre>
<h4 data-id="heading-27">Q4：性能如何？</h4>
<p>Redisson的分布式锁性能很好，单机QPS可达5万+，足以应对大多数场景。如有更高性能需求，可以考虑分段锁或本地锁+分布式锁的组合方案。</p>
<h3 data-id="heading-28">十、总结</h3>
<p>Redisson分布式锁是Java领域最成熟的Redis分布式锁解决方案：</p>
<ol>
<li><strong>使用简单</strong>：API友好，学习成本低</li>
<li><strong>功能完善</strong>：支持多种锁类型和场景</li>
<li><strong>稳定可靠</strong>：经过大量生产环境验证</li>
<li><strong>性能优异</strong>：看门狗机制和Lua脚本保证性能</li>
</ol>
<p>在实际项目中，建议优先使用Redisson，它已经帮你处理了各种复杂的边界情况，让你专注于业务逻辑的实现。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[给显卡按下“暂停键”：阿里云函数计算 GPU “浅休眠”背后的硬核技术]]></title>    <link>https://juejin.cn/post/7600219080045658155</link>    <guid>https://juejin.cn/post/7600219080045658155</guid>    <pubDate>2026-01-28T09:42:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600219080045658155" data-draft-id="7600068631360585734" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="给显卡按下“暂停键”：阿里云函数计算 GPU “浅休眠”背后的硬核技术"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2026-01-28T09:42:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            给显卡按下“暂停键”：阿里云函数计算 GPU “浅休眠”背后的硬核技术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T09:42:38.000Z" title="Wed Jan 28 2026 09:42:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：王骜</p>
<p>在 AGI（通用人工智能）爆发的今天，AI 应用如雨后春笋般涌现。对于开发者而言，这既是最好的时代，也是最“贵”的时代。</p>
<p>部署 LLM（大语言模型）、Stable Diffusion 等 AI 应用时，我们往往面临一个两难的选择：</p>
<ul>
<li><strong>要速度（预留模式）</strong>：为了毫秒级 - 秒级的响应，必须长期通过预留模式持有 GPU 实例，但昂贵的空置成本让人心痛。</li>
<li><strong>要省钱（按量模式）</strong>：为了节省成本选择按量付费，但 GPU 实例的创建和模型加载带来的漫长“冷启动”延迟，又严重伤害用户体验。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59d1299dc3854b5da113740c2aac6f56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770198161&amp;x-signature=6l6AxodDRNTDSLjoFCzyu1XjznA%3D" alt="图片" loading="lazy"/></p>
<p><strong>难道性能与成本真的不可兼得？</strong></p>
<p>阿里云函数计算（Function Compute）推出的 <strong>CPU 和 GPU 实例浅休眠功能</strong>，正是为了打破这一僵局而来。它让实例学会了“浅休眠”，在保留热启动能力的同时，<strong>极大降低了实例的闲置成本</strong>。</p>
<p>本文将带你深入技术后台，揭秘 GPU 实例浅休眠这一功能是如何从 0 到 1 实现的。</p>
<h2 data-id="heading-0">什么是 GPU 实例浅休眠？给显卡按下“暂停键”</h2>
<p>在开启浅休眠功能后，当没有请求时，GPU 实例并不会被销毁，而是进入一种 <strong>“休眠”</strong> 状态。</p>
<p>此时，实例依然存在，但 CPU 和 GPU 的计算资源被挂起，用户只需支付极低的休眠费用（约为活跃实例费用的 10%-20%，CPU 不计费，具体见计费文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Ffunctioncompute%2Ffc%2Fproduct-overview%2Fthe-idle-gpu-usage-billable-item-is-added-to-function-compute%25EF%25BC%2589" target="_blank" title="https://help.aliyun.com/zh/functioncompute/fc/product-overview/the-idle-gpu-usage-billable-item-is-added-to-function-compute%EF%BC%89" ref="nofollow noopener noreferrer">help.aliyun.com/zh/function…</a></p>
<p>当请求再次到来时，系统会瞬间“解冻”实例，毫秒-秒级恢复计算能力（视模型大小）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/029a8cf72b9046a49a1959514e52ac04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770198161&amp;x-signature=ee1HnQ7WIKilT7Et%2FRhpWwiYxTI%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-1">技术揭秘：如何实现 GPU 的“浅休眠”？</h2>
<p>在容器技术中，实现 CPU 的暂停（Pause）相对成熟且容易，但要给正在显存中跑着几个 G 大模型的 GPU 做暂停，技术挑战极大。我们通过三项关键技术，实现了对 GPU 资源的精细化管理。</p>
<h3 data-id="heading-2">1. 显存状态的“迁移”</h3>
<p>传统释放 GPU 资源的方式意味着销毁实例，下次使用必须经历完整的冷启动（启动容器、加载模型）。为了解决这个问题，我们设计并实现了显存数据的<strong>迁移（Migration）机制</strong>：</p>
<ul>
<li><strong>休眠阶段</strong>：当实例空闲时，系统会将 GPU 显存中的所有数据（包括模型参数、中间状态等）完整迁移至外部存储保存。</li>
<li><strong>唤醒阶段</strong>：当新请求到达时，系统会迅速将存储中的数据回迁至 GPU 显存并重建状态，将实例恢复至休眠前的状态。</li>
</ul>
<p>这一过程避免了重复的模型加载，确保实例始终处于待命状态。</p>
<h3 data-id="heading-3">2. 驱动层的透明兼容</h3>
<p>为了让用户无需修改代码即可使用该功能，我们选择在底层进行技术突破。</p>
<p>FC GPU 实例做到了<strong>对框架无感</strong>。这意味着，无论是 PyTorch 还是 TensorFlow，现有的 AI 应用无需任何代码改造，即可直接具备浅休眠能力。</p>
<h3 data-id="heading-4">3. 基于请求的自动化调度</h3>
<p>有了“浅休眠”能力后，还需要解决“何时休眠、何时唤醒”的调度问题。依托函数计算<strong>以请求为中心</strong>的架构优势，我们实现了全自动化的资源管控。</p>
<p>平台天然感知每个请求的生命周期：</p>
<ul>
<li><strong>请求到达</strong>：系统自动触发解冻流程，毫秒级唤醒 GPU 执行任务。</li>
<li><strong>请求结束</strong>：系统自动触发冻结流程，释放 GPU 算力。</li>
</ul>
<p>整个过程由平台自动托管，用户无需配置复杂的伸缩策略，即可实现资源的按需分配与极致利用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be61a724918c4bc4b0f076d5f4ee61fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770198161&amp;x-signature=FTDiujCAe4AVq%2BuX7qt7K0nSQ0Y%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-5">浅休眠唤醒性能</h2>
<p>性能是用户最关心的指标。我们以 <strong>ComfyUI + Flux</strong> 的文生图场景为例进行了实测：</p>
<p>GPU 实例从“浅休眠”唤醒的耗时仅约为 <strong>500 毫秒 - 2 秒</strong>（视模型大小不同而略有差异）。</p>
<p>考虑到整个文生图生成过程通常持续数十秒，这 1-2 秒的延迟对于用户体验的影响极为有限，不足以降低用户感知的流畅性，却能换来显著的成本下降。</p>
<h2 data-id="heading-6">真实案例：某 OCR 业务降本 70% 实录</h2>
<p>深圳某科技公司主要业务是从专利文本中提取信息，使用 OCR 模型。他们的业务痛点非常典型：</p>
<p><strong>1. 启动耗时长</strong>：容器启动+加载模型+私有数据 OCR 识图，全套下来要<strong>十几秒</strong>。</p>
<p><strong>2. 流量难以预测</strong>：请求来去无法预判，“按量模式”的冷启动耗时长无法满足业务延迟需求。如果使用预留实例，大部分时间 GPU 都在空转出现了浪费。</p>
<p>开启 GPU 实例浅休眠后：</p>
<ul>
<li>启动延迟明显减少，请求到达后能快速响应。</li>
<li>日常使用成本大幅下降。</li>
<li>服务稳定性不受影响，用户体验保持良好。</li>
</ul>
<p>整体成本节省接近 70%。</p>
<h2 data-id="heading-7">如何使用</h2>
<p>开启方式非常简单，<strong>函数计算产品控制台（<a href="https://link.juejin.cn?target=https%3A%2F%2Ffcnext.console.aliyun.com%2Foverview%25EF%25BC%2589" target="_blank" title="https://fcnext.console.aliyun.com/overview%EF%BC%89" ref="nofollow noopener noreferrer">fcnext.console.aliyun.com/overview）</a></strong> 已默认支持该功能：</p>
<ol>
<li>
<p>进入函数的【弹性配置】页签。</p>
</li>
<li>
<p>设置【弹性实例】的数量。</p>
</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d11c08054e094bda922f71702adec951~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770198161&amp;x-signature=%2BSq%2FnskAKa2OW995aKESEMXrxMA%3D" alt="4d1f813cafb5be49b610eb7407973e1f.png" loading="lazy"/></p>
<ol start="3">
<li>系统将自动激活 GPU 实例的浅休眠功能。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8d58f22eade4f0cb45c8c996f7f0492~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770198161&amp;x-signature=WZqxlbnA5pbSHZedrlA3Cn%2BVm0Y%3D" alt="6e817a0bd35ee6f935e18ed4e5a3dd75.png" loading="lazy"/></p>
<p><strong>计费逻辑</strong>：</p>
<ul>
<li><strong>请求执行时</strong>：全额收费。</li>
<li><strong>无请求执行时</strong>：自动切换至浅休眠计费（GPU 资源视卡型收取 10%-20% 的费用，<strong>CPU 不收费</strong>）。</li>
</ul>
<h2 data-id="heading-8">结语：Serverless AI 的新范式</h2>
<p>Serverless 的核心理念是“按需付费”，而 GPU 昂贵的持有成本一直是阻碍 AI 全面 Serverless 化的大山。</p>
<p><strong>函数计算 CPU 和 GPU 实例均全面支持浅休眠能力</strong>。无论是高算力的 AI 推理（GPU），还是通用的计算任务（CPU），函数计算全系实例均致力助您在 Serverless 的道路上实现极致的降本增效。</p>
<p><strong>想要降本？现在就是最好的时机。</strong></p>
<p><strong>了解更多：</strong></p>
<p><strong>FunctionAI</strong> 是阿里云推出的一站式 <strong>AI 原生应用开发平台</strong>，基于<strong>函数计算 FC</strong> 的 Serverless 架构，深度融合 AI 技术，为企业提供从模型训练、推理到部署的全生命周期支持。</p>
<p>通过 Serverless 架构的弹性特性与智能化资源管理，显著降低 AI 应用的开发复杂度与资源成本，助力企业快速实现 AI 落地。</p>
<ol>
<li><strong>开发效率提升</strong>：无需关注底层资源，开发者可专注于业务逻辑，模型一键转换为 Serverless API。</li>
<li><strong>弹性资源调度</strong>：按需付费 + N 分之一卡资源分配（如 1/16 卡），GPU 部署成本降低 90% 以上。</li>
<li><strong>免运维特性</strong>：实例闲置时自动缩容至 0，资源利用率优化 60%，实现业务运维转型。</li>
</ol>
<p>快速体验 <strong>FunctionAI：</strong> <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fcap.console.aliyun.com%2Fexplore" target="_blank" title="https://cap.console.aliyun.com/explore" ref="nofollow noopener noreferrer">cap.console.aliyun.com/explore</a></strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b448c8d6638491a8a2767b11d79da75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770198161&amp;x-signature=B2dVrevySZ9YNKiudUwWebCB3S0%3D" alt="图片" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude Code的完美平替：OpenCode + GitHub Copilot]]></title>    <link>https://juejin.cn/post/7600242248861024296</link>    <guid>https://juejin.cn/post/7600242248861024296</guid>    <pubDate>2026-01-28T09:47:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600242248861024296" data-draft-id="7600225000851521571" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude Code的完美平替：OpenCode + GitHub Copilot"/> <meta itemprop="keywords" content="VibeCoding,Claude,Github Copilot"/> <meta itemprop="datePublished" content="2026-01-28T09:47:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序猿DD"/> <meta itemprop="url" content="https://juejin.cn/user/131597123993358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude Code的完美平替：OpenCode + GitHub Copilot
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/131597123993358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序猿DD
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T09:47:01.000Z" title="Wed Jan 28 2026 09:47:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：Claude 虽好，但你真的能用上吗？</h2>
<p>在当前席卷全球的“Vibe Coding”浪潮中，Anthropic 推出的 Claude 系列模型 + 终端工具 Claude Code，凭借极强的逻辑推理能力，成为了开发者眼中的“白月光”。但现实是残酷的：对于中国开发者而言，账号随时被封、海外信用卡支付遭拒、API 额度受限以及复杂的网络环境，构成了一道难以逾越的门槛。</p>
<p>虽然最近国产编程模型不断发力，Claude Code + GLM-4.7的表现非常出色，但面对复杂问题，Claude系列模型依然完胜。难道我们只能眼馋Claude全家桶的编程体验吗？</p>
<p>作为一名追求极致生产力的开发者，我发现了一个绝佳的完美替代方案：OpenCode + GitHub Copilot。这个组合不仅能让你享受如 GLM-4.7 一样的性价比，还能更方便的使用 Claude 的顶级模型。</p>
<h2 data-id="heading-1">Claude Code 的开源免费平替：OpenCode</h2>
<p>想要复刻 Claude Code 的体验，核心在于拥有一个强大的“AI 编程代理（Coding Agent）”。OpenCode 正是目前社区中最接近、甚至在某些维度超越 Claude Code 的工具。</p>
<p><img src="https://static.didispace.com/images4/ecb289e9e92977960fa4d92d07434696.png" alt="OpenCode" loading="lazy"/></p>
<p>OpenCode 的强大源于其深厚的社区根基，其核心数据足以证明其统治力：</p>
<ul>
<li>高社区认可度： 在 GitHub 上拥有超过 90,000 Stars、由 600 多名贡献者共同维护，并积累了超过 7,500 次 commits。</li>
<li>庞大的用户基数： 每月有超过 150 万名开发者活跃在该工具链中。</li>
<li>全场景覆盖： 不同于仅限终端的工具，OpenCode 提供了 Terminal、IDE 插件以及支持 macOS/Windows/Linux 的 Desktop（桌面端）应用。</li>
</ul>
<p>更硬核的是，OpenCode 秉持隐私优先理念，不存储任何代码或上下文数据，且能自动加载适配 LLM 的 LSP（语言服务协议）。这种自动化的环境感知，让它在执行复杂重构任务时，比手动配置的工具更具“专家感”。</p>
<h2 data-id="heading-2">隐藏的顶级模型分发器：GitHub Copilot</h2>
<p>很多开发者忽略了一个事实：GitHub Copilot 已不再仅仅是一个补全插件，它正进化为一个聚合顶级模型的低成本分发平台。</p>
<p>通过 OpenCode 提供的 “Log in with GitHub” 桥接功能，开发者可以直接调用 Copilot 账户下的模型能力。这意味着你不需要折腾海外信用卡去充值 Anthropic API，只需一个 GitHub 账号，就能实现对顶级模型的“一键接入”。</p>
<p>在 Copilot 计划中，你可以访问到的顶级模型矩阵（严格遵循来源名称）包括：</p>
<ul>
<li>Anthropic 系列： Claude Sonnet 4.5/4、Claude Opus 4.1/4.5、Claude Haiku 4.5。</li>
<li>OpenAI 系列： GPT-5、GPT-5 mini、GPT-5.1/5.2、GPT-4.1 以及多款 GPT-5-Codex 预览版。</li>
<li>Google 系列： Gemini 2.5 Pro、Gemini 3 Pro/Flash (Preview)。</li>
<li>新锐力量： xAI Grok Code Fast 1 以及 Raptor mini (Preview)。</li>
</ul>
<h2 data-id="heading-3">性价比之王：每月 $10 搞定顶级模型访问</h2>
<p>这套方案最具杀伤力的地方在于其经济逻辑。直接订阅 ChatGPT Plus 或直接使用 Claude API 的成本极高，而 GitHub Copilot Pro 的定价策略对独立开发者极其友好。</p>
<p><img src="https://static.didispace.com/images4/7db458cf156b6b8838103f4dd2a939a3.png" alt="GitHub Copilot" loading="lazy"/></p>
<ul>
<li>月费仅需 $10： 即可享受针对 GPT-5 mini 的无限量聊天与 Agent 模式请求，以及无限量的代码补全。</li>
<li>高级请求配额： Copilot Pro 计划每月提供 300 次 Premium requests（高级请求），用于调用 Claude Opus 4.5 或 GPT-5 等昂贵的旗舰模型；如果你是重度用户，升级至 Pro+ 计划，该配额将飙升至 1500 次。</li>
<li>完全免费通道： 针对经认证的学生、教师及流行开源项目维护者，上述所有能力均为 $0/月。</li>
</ul>
<p><img src="https://static.didispace.com/images4/f961dc001a453bd58fb0ded9dbb0c955.png" alt="GitHub Copilot" loading="lazy"/></p>
<p>这种“小钱办大事”的模式，完美解决了“复杂场景下 Opus 模型最有效”但“直接接入成本高”的矛盾。</p>
<h2 data-id="heading-4">总结</h2>
<p>OpenCode + GitHub Copilot 的组合比起其他平替方案而言，从工具、模型、价格等多个维度都是最优选择。所以，强烈推荐尝试一下这个编码组合。下面是这两个工具的官方地址，想要试试的可以直接前往：</p>
<ul>
<li>OpenCode：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopencode.ai%2F" target="_blank" title="https://opencode.ai/" ref="nofollow noopener noreferrer">opencode.ai/</a></li>
<li>GitHub Copilot：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffeatures%2Fcopilot" target="_blank" title="https://github.com/features/copilot" ref="nofollow noopener noreferrer">github.com/features/co…</a></li>
</ul>
<p>最后，做个小调研，目前你正在用什么工具和模型套件呢？留言区聊一聊吧。更多关于Vibe Coding的内容分享也可以关注<a href="https://link.juejin.cn?target=https%3A%2F%2Fdidispace.com%2F" target="_blank" title="https://didispace.com/" ref="nofollow noopener noreferrer">我的博客: 程序猿DD</a>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[根治监管报送“对不准”：从列级血缘到算子级血缘的数据治理新范式]]></title>    <link>https://juejin.cn/post/7600227607978786868</link>    <guid>https://juejin.cn/post/7600227607978786868</guid>    <pubDate>2026-01-28T09:51:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600227607978786868" data-draft-id="7600216277426405410" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="根治监管报送“对不准”：从列级血缘到算子级血缘的数据治理新范式"/> <meta itemprop="keywords" content="大数据"/> <meta itemprop="datePublished" content="2026-01-28T09:51:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Aloudata大应科技"/> <meta itemprop="url" content="https://juejin.cn/user/1579340474099927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            根治监管报送“对不准”：从列级血缘到算子级血缘的数据治理新范式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1579340474099927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Aloudata大应科技
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T09:51:36.000Z" title="Wed Jan 28 2026 09:51:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文首发于 Aloudata 官方技术博客：<a href="https://link.juejin.cn?target=https%3A%2F%2Fai.noetl.cn%2Fknowledge-base%2Fwhy-column-level-lineage-mismatch-in-east-reporting-operator-level-analysis" target="_blank" title="https://ai.noetl.cn/knowledge-base/why-column-level-lineage-mismatch-in-east-reporting-operator-level-analysis" ref="nofollow noopener noreferrer">《列级血缘为何在 EAST 报送中“对不准”？算子级解析的降维打击》</a>转载请注明出处。</p>
</blockquote>
<p><strong>摘要</strong>：在金融监管报送（如 EAST）场景中，传统列级血缘因 SQL 解析精度低（&lt;80%）、无法处理复杂逻辑，导致指标口径追溯不全、人工盘点耗时数月。本文深入剖析了列级血缘的技术局限，并介绍了以算子级血缘为核心的新范式。通过 AST 深度解析、行级裁剪和白盒化口径提取等技术，算子级血缘将解析准确率提升至 &gt;99%，实现监管指标“一键溯源”与自动化盘点，为数据治理和 DataOps 流程提供精准的溯源基座。</p>
<p>在金融监管报送（如 EAST、1104）领域，数据血缘的准确性直接关系到合规风险与运营效率。传统列级血缘技术因解析精度不足，已成为指标口径“对不准”、人工盘点“盘不动”的症结所在。本文将对比分析列级血缘的固有缺陷，并深入解读以算子级血缘（Operator-level Lineage） 为核心的技术新范式，如何通过 &gt;99% 的解析准确率与行级裁剪能力，为监管报送构建可靠的自动化数据溯源基座。</p>
<h2 data-id="heading-0">一、核心痛点：EAST 报送中的数据溯源困局</h2>
<p>金融监管指标背后是跨越数仓多层（ODS、明细层、汇总层、报表层）的复杂加工链路，涉及大量 SQL 转换、存储过程及临时表处理。传统数据血缘（表级/列级）在此场景下普遍失效，具体表现为：</p>
<ol>
<li>盘点效率低下：面对成千上万的监管指标，数据团队需投入数周至数月进行人工“扒代码”和访谈，成本高昂。</li>
<li>追溯结果不可靠：行业反馈显示，开源列级血缘工具对 Hive SQL 的解析准确率通常低于 70%，近三分之一的依赖关系错误或缺失，为合规埋下隐患。</li>
<li>变更风险失控：无法精准评估上游字段或逻辑变更对下游报送指标的影响，导致“牵一发而动全身”，易引发数据错误或报送延误。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14360e4cec6f472db0ad5d1449261f57~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWxvdWRhdGHlpKflupTnp5HmioA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770198698&amp;x-signature=%2FozJE%2B3919mL0ZYaXz1pdBky%2B80%3D" alt="血缘对比.png" loading="lazy"/></p>
<h2 data-id="heading-1">二、技术剖析：列级血缘为何“力不从心”？</h2>
<p>列级血缘的局限源于其技术原理，它通常基于正则匹配或浅层语法分析，只能识别“A 表的 X 列出现在 B 表 Y 列的 SELECT 语句中”，但无法理解其间的计算逻辑。这导致三大硬伤：</p>
<ul>
<li>解析精度天花板低：对包含 <code>CASE WHEN</code>、窗口函数、多层嵌套子查询的复杂 SQL 解析能力弱，准确率普遍低于 80%。</li>
<li>无法穿透黑盒逻辑：对 DB2、Oracle 的 PL/SQL 存储过程、动态 SQL、临时表加工等场景几乎无法解析，造成血缘链路断点。</li>
<li>影响分析过度泛化：缺乏对 <code>WHERE</code>、<code>JOIN ON</code> 等过滤条件的识别。例如，一个仅影响特定分行的源数据变更，会触发所有相关下游任务的告警，噪音率可超过 80%。</li>
</ul>



































<table><thead><tr><th>对比维度</th><th>传统列级血缘</th><th>算子级血缘 (如 Aloudata BIG)</th></tr></thead><tbody><tr><td>解析粒度</td><td>列级，仅知“从哪列到哪列”</td><td>算子级，可知“经过怎样的计算（过滤、连接、聚合）从哪列到哪列”</td></tr><tr><td>解析准确率</td><td>通常 &lt; 80%，复杂 SQL 下更低</td><td>&gt; 99%，基于 AST 深度解析</td></tr><tr><td>复杂场景支持</td><td>弱，难以处理存储过程、动态 SQL、临时表</td><td>强，深度支持 DB2、GaussDB 等 PL/SQL，穿透临时表</td></tr><tr><td>影响分析精度</td><td>粗粒度，易泛化，噪音大</td><td>行级裁剪，精准识别过滤条件，聚焦真实影响范围</td></tr><tr><td>口径提取</td><td>需人工拼接多层代码</td><td>白盒化口径提取，自动生成可读、可验证的最终加工逻辑</td></tr></tbody></table>
<h2 data-id="heading-2">三、新范式：算子级血缘的核心原理与“降维打击”</h2>
<p>算子级血缘实现了技术范式的跃迁。它深入 SQL 内部，将数据加工过程解析为最细粒度的算子（Operator）序列，如 <code>Filter</code>（过滤）、<code>Join</code>（连接）、<code>Aggregation</code>（聚合）等。结合以下核心技术，实现对传统方法的“降维打击”：</p>
<ol>
<li>行级裁剪 (Row-level Pruning)：精准识别 SQL 中的过滤条件（<code>WHERE</code>, <code>JOIN ON</code>）。当上游数据变更时，系统能自动判断变更是否落入下游任务所关心的数据子集内，从而剔除无关的上游分支，使影响评估范围平均降低 80% 以上，实现精准风险预警。</li>
<li>复杂场景全覆盖：基于对多 SQL 方言（Hive, Spark, Oracle, DB2 等）及 PL/SQL 的深度解析能力，可穿透存储过程、动态 SQL、临时表等传统黑盒，构建端到端的完整血缘链路。</li>
<li>白盒化口径提取：针对跨多层加工的监管指标，系统能自动将沿途的所有 <code>SELECT</code>、<code>CASE WHEN</code>、函数调用等逻辑，“压缩”成一段从最终指标反向追溯到源字段的、可读性极高的“加工口径”，直接替代人工“扒代码”。</li>
</ol>
<h2 data-id="heading-3">四、实践验证：算子级血缘在金融场景的落地成效</h2>
<p>该技术已在多家金融机构的 EAST 报送场景中得到验证：</p>
<p>浙江农商联合银行：通过部署具备算子级血缘能力的 Aloudata BIG 平台，实现了监管指标溯源人效提升 20 倍，全量指标口径盘点从数月缩短至 8 小时；对核心 DB2 存储过程的解析准确率达到 99%，攻克技术难关；自动生成符合监管要求的指标加工口径报告。</p>
<p>共性价值：算子级血缘实现的“一键溯源”能力，不仅大幅提升合规效率，更将管理动作从事后补救转向事前防控与事中协同，精准管控上游变更对下游报送指标的影响。</p>
<h2 data-id="heading-4">五、实施路径：构建 EAST 报送的数据溯源基座</h2>
<p>企业可遵循以下三步，系统性构建高可靠的数据溯源能力：</p>
<p>1、基座先行：优先接入核心数仓（Hive, Oracle）、ETL/ELT 平台（DataStage, Kettle）及 BI 系统，快速构建覆盖“入仓-&gt;加工-&gt;服务”全链路的算子级血缘图谱。</p>
<p>2、场景驱动：选择 EAST、1104 等具体监管报表作为首场景，利用“一键溯源”快速验证价值，赢得业务与合规部门支持。</p>
<p>3、流程嵌入：将血缘能力深度嵌入 DataOps 与合规流程：</p>
<ul>
<li>研发侧：代码提交前自动进行变更影响分析，识别波及的报送指标。</li>
<li>运维侧：发生数据异常时，利用血缘图谱快速定位根因。</li>
<li>合规侧：建立基于血缘的自动化口径报告与审计机制。</li>
</ul>
<h2 data-id="heading-5">六、常见问题（FAQ）</h2>
<h4 data-id="heading-6">Q1: 列级血缘和算子级血缘的核心区别是什么？</h4>
<p>最本质的区别是解析粒度。列级血缘仅知道字段的流向，而算子级血缘能还原完整的计算逻辑，例如“A.X 列经过 WHERE 过滤后，与 C 表 Z 列 LEFT JOIN，再 GROUP BY 生成 B.Y 列”，实现加工过程的白盒化。</p>
<h4 data-id="heading-7">Q2: 对复杂的存储过程和嵌套查询，算子级血缘解析效果如何？</h4>
<p>这是算子级血缘的核心优势。它针对 DB2、Oracle 等 PL/SQL 存储过程、动态 SQL 及多层嵌套查询进行了深度优化，解析准确率可超过 99%，能有效穿透这些传统血缘工具的解析盲区。</p>
<h4 data-id="heading-8">Q3: 引入算子级血缘对 EAST 报送的具体价值是什么？</h4>
<p>主要体现在三方面：效率提升（盘点从数月缩短到几小时）、准确性保障（&gt;99% 解析准确率确保口径完整正确）、风险防控（精准评估上游变更影响，实现主动预警）。</p>
<h2 data-id="heading-9">核心要点</h2>
<ol>
<li>精度是核心：传统列级血缘低解析精度（&lt;80%）是 EAST 报送“对不准”的根源。</li>
<li>算子级是解药：算子级血缘通过 AST 深度解析 Filter、Join 等算子，实现 &gt;99% 的解析准确率。</li>
<li>行级裁剪提效：行级裁剪技术能精准识别数据子集，将变更影响分析范围平均降低 80% 以上。</li>
<li>案例验证价值：在标杆案例中，算子级血缘已将监管指标盘点从数月缩短至 8 小时，人效提升 20 倍。</li>
<li>构建溯源基座：企业应优先建设全链路算子级血缘，并以此驱动 DataOps 与自动化合规流程。</li>
</ol>
<hr/>
<p>再次提醒：本文更详细的图表与案例细节，请访问Aloudata官方技术博客阅读原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fai.noetl.cn%2Fknowledge-base%2Fwhy-column-level-lineage-mismatch-in-east-reporting-operator-level-analysis" target="_blank" title="https://ai.noetl.cn/knowledge-base/why-column-level-lineage-mismatch-in-east-reporting-operator-level-analysis" ref="nofollow noopener noreferrer">ai.noetl.cn/knowledge-b…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python3+TensorFlow打造人脸识别智能小程序 - 学习服务]]></title>    <link>https://juejin.cn/post/7600238071037558793</link>    <guid>https://juejin.cn/post/7600238071037558793</guid>    <pubDate>2026-01-28T09:24:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600238071037558793" data-draft-id="7600238071037526025" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python3+TensorFlow打造人脸识别智能小程序 - 学习服务"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-28T09:24:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户88107983630"/> <meta itemprop="url" content="https://juejin.cn/user/3528777754748185"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python3+TensorFlow打造人脸识别智能小程序 - 学习服务
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3528777754748185/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户88107983630
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T09:24:56.000Z" title="Wed Jan 28 2026 09:24:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong><a href="https://link.juejin.cn?target=http%3A%2F%2Fxingkeit.top%2F7701%2F" target="_blank" title="http://xingkeit.top/7701/" ref="nofollow noopener noreferrer">Python3+TensorFlow 打造人脸识别智能小程序</a></strong></p>
<h2 data-id="heading-0">前言</h2>
<p>人脸识别是计算机视觉（CV）领域最经典、也最具商业价值的应用之一。从门禁打卡到移动支付，从安防监控到智能相册，它的身影无处不在。然而，看似简单的“刷脸”背后，隐藏着从<strong>图像预处理</strong>、<strong>特征提取</strong>到<strong>活体检测</strong>等多个技术难点。</p>
<p>利用 Python3 结合 TensorFlow 进行开发，虽然拥有成熟的库支持，但要构建一个高精度、高并发的生产级系统，仍需要对底层逻辑有深刻理解。本文将通过实战代码，拆解开发过程中的核心痛点。</p>
<h2 data-id="heading-1">一、 难点一：图像预处理与数据增强</h2>
<p><strong>痛点解析</strong>：<br/>
真实场景下采集的人脸图像往往存在光照不均、角度偏斜、分辨率低等问题。如果直接把原始图片喂给神经网络，模型性能会大打折扣。</p>
<p><strong>技术方案</strong>：<br/>
利用 OpenCV 进行几何变换（旋转、缩放）和光度变换（直方图均衡化），并通过 TensorFlow 的 <code>ImageDataGenerator</code> 进行在线数据增强，扩充训练集。</p>
<h3 data-id="heading-2">代码实战：使用 OpenCV 进行人脸对齐与预处理</h3>
<p>python</p>
<p>复制</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> cv2
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np

<span class="hljs-keyword">def</span> <span class="hljs-title function_">align_face</span>(<span class="hljs-params">image_path</span>):
    <span class="hljs-string">"""
    使用 OpenCV 检测人脸并进行简单的对齐预处理
    """</span>
    <span class="hljs-comment"># 加载 Haar 级联分类器用于人脸检测</span>
    face_cascade = cv2.CascadeClassifier(cv2.data.haarcascades + <span class="hljs-string">'haarcascade_frontalface_default.xml'</span>)
    
    img = cv2.imread(image_path)
    <span class="hljs-keyword">if</span> img <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
    
    gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
    
    <span class="hljs-comment"># 检测人脸</span>
    faces = face_cascade.detectMultiScale(gray, <span class="hljs-number">1.3</span>, <span class="hljs-number">5</span>)
    
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(faces) == <span class="hljs-number">0</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"未检测到人脸"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
        
    <span class="hljs-comment"># 取第一个人脸区域</span>
    (x, y, w, h) = faces[<span class="hljs-number">0</span>]
    
    <span class="hljs-comment"># 裁剪出人脸区域</span>
    face_roi = img[y:y+h, x:x+w]
    
    <span class="hljs-comment"># 调整大小以适应模型输入 (例如 112x112 是 FaceNet 常用尺寸)</span>
    face_resized = cv2.resize(face_roi, (<span class="hljs-number">112</span>, <span class="hljs-number">112</span>))
    
    <span class="hljs-comment"># 归一化到 0-1</span>
    face_normalized = face_resized.astype(np.float32) / <span class="hljs-number">255.0</span>
    
    <span class="hljs-keyword">return</span> face_normalized

<span class="hljs-comment"># 测试预处理流程</span>
processed_face = align_face(<span class="hljs-string">'test.jpg'</span>)
<span class="hljs-keyword">if</span> processed_face <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"预处理后图像形状: <span class="hljs-subst">{processed_face.shape}</span>"</span>)
</code></pre>
<h2 data-id="heading-3">二、 难点二：深度度量学习</h2>
<p><strong>痛点解析</strong>：<br/>
传统的分类任务（如猫狗分类）类别是固定的。但人脸识别是“开放集识别”，系统上线后可能会遇到成千上万的新用户。你不能为每个新用户重新训练模型。</p>
<p><strong>技术方案</strong>：<br/>
采用<strong>深度度量学习</strong>。模型不直接输出“这是谁”，而是输出一个 128 维或 512 维的向量。通过计算向量之间的<strong>欧氏距离</strong>或<strong>余弦相似度</strong>来判断是否为同一个人。TensorFlow 提供了强大的自定义层支持来实现这一逻辑。</p>
<h3 data-id="heading-4">代码实战：构建基于 ResNet 的特征提取模型</h3>
<p>python</p>
<p>复制</p>
<pre><code class="hljs language-ini" lang="ini">import tensorflow as tf
from tensorflow.keras import layers, Model

def build_embedding_model(<span class="hljs-attr">input_shape</span>=(<span class="hljs-number">112</span>, <span class="hljs-number">112</span>, <span class="hljs-number">3</span>), embedding_dim=<span class="hljs-number">128</span>):
    """
    构建一个用于提取人脸特征的 CNN 网络
    """
    <span class="hljs-attr">inputs</span> = layers.Input(shape=input_shape)
    
    <span class="hljs-comment"># 简化的 ResNet 风格骨干网络</span>
    <span class="hljs-attr">x</span> = layers.Conv2D(<span class="hljs-number">64</span>, (<span class="hljs-number">3</span>, <span class="hljs-number">3</span>), padding=<span class="hljs-string">'same'</span>, activation=<span class="hljs-string">'relu'</span>)(inputs)
    <span class="hljs-attr">x</span> = layers.MaxPooling2D((<span class="hljs-number">2</span>, <span class="hljs-number">2</span>))(x)
    
    <span class="hljs-attr">x</span> = layers.Conv2D(<span class="hljs-number">128</span>, (<span class="hljs-number">3</span>, <span class="hljs-number">3</span>), padding=<span class="hljs-string">'same'</span>, activation=<span class="hljs-string">'relu'</span>)(x)
    <span class="hljs-attr">x</span> = layers.MaxPooling2D((<span class="hljs-number">2</span>, <span class="hljs-number">2</span>))(x)
    
    <span class="hljs-attr">x</span> = layers.Conv2D(<span class="hljs-number">256</span>, (<span class="hljs-number">3</span>, <span class="hljs-number">3</span>), padding=<span class="hljs-string">'same'</span>, activation=<span class="hljs-string">'relu'</span>)(x)
    <span class="hljs-attr">x</span> = layers.GlobalAveragePooling2D()(x)
    
    <span class="hljs-comment"># 全连接层降维到 embedding_dim</span>
    <span class="hljs-comment"># 这里的输出就是人脸的“数字指纹”</span>
    <span class="hljs-attr">outputs</span> = layers.Dense(embedding_dim)(x)
    
    <span class="hljs-comment"># 对向量进行 L2 归一化，使得余弦相似度计算更稳定</span>
    <span class="hljs-attr">outputs</span> = tf.nn.l2_normalize(outputs, axis=<span class="hljs-number">1</span>)
    
    <span class="hljs-attr">model</span> = Model(inputs=inputs, outputs=outputs, name=<span class="hljs-string">"Face_Embedding"</span>)
    return model

<span class="hljs-comment"># 初始化模型</span>
<span class="hljs-attr">embedding_model</span> = build_embedding_model()
embedding_model.summary()
</code></pre>
<h3 data-id="heading-5">代码实战：计算人脸相似度（比对逻辑）</h3>
<p>python</p>
<p>复制</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np

<span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_similarity</span>(<span class="hljs-params">embedding1, embedding2, threshold=<span class="hljs-number">0.4</span></span>):
    <span class="hljs-string">"""
    计算两个 embedding 之间的欧氏距离并判断是否匹配
    
    Args:
        embedding1: 第一个人脸向量
        embedding2: 第二个人脸向量
        threshold: 判定阈值（越小越严格，通常在 0.4-0.6 之间）
    """</span>
    <span class="hljs-comment"># 计算欧氏距离</span>
    dist = np.linalg.norm(embedding1 - embedding2)
    
    is_same_person = dist &lt; threshold
    
    <span class="hljs-keyword">return</span> dist, is_same_person

<span class="hljs-comment"># 模拟两个特征向量</span>
emb_a = np.random.rand(<span class="hljs-number">128</span>)
emb_b = np.random.rand(<span class="hljs-number">128</span>)

<span class="hljs-comment"># 归一化模拟</span>
emb_a = emb_a / np.linalg.norm(emb_a)
emb_b = emb_b / np.linalg.norm(emb_b)

distance, <span class="hljs-keyword">match</span> = calculate_similarity(emb_a, emb_b)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"欧氏距离: <span class="hljs-subst">{distance:<span class="hljs-number">.4</span>f}</span>, 是否匹配: <span class="hljs-subst">{<span class="hljs-keyword">match</span>}</span>"</span>)
</code></pre>
<h2 data-id="heading-6">三、 难点三：实时性优化与模型压缩</h2>
<p><strong>痛点解析</strong>：<br/>
在移动端或嵌入式设备（如树莓派）上运行 TensorFlow 模型，最大的瓶颈是计算资源和内存。如果直接使用原始模型，推理速度可能无法达到实时要求（&gt;15 FPS）。</p>
<p><strong>技术方案</strong>：<br/>
使用 TensorFlow 提供的模型优化工具，将模型转换为 <strong>TFLite</strong> 格式，并开启<strong>量化</strong>，将 32 位浮点数权重转换为 8 位整数，在几乎不损失精度的情况下，大幅提升推理速度并降低内存占用。</p>
<h3 data-id="heading-7">代码实战：模型转换为 TFLite 并开启全整数量化</h3>
<p>python</p>
<p>复制</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">convert_to_tflite</span>(<span class="hljs-params">model_path, output_path</span>):
    <span class="hljs-string">"""
    将 SavedModel 格式转换为 TFLite 格式并进行量化
    """</span>
    <span class="hljs-comment"># 1. 加载训练好的模型</span>
    model = tf.keras.models.load_model(model_path)
    
    <span class="hljs-comment"># 2. 转换器配置</span>
    converter = tf.lite.TFLiteConverter.from_keras_model(model)
    
    <span class="hljs-comment"># 开启默认优化（包括权重量化）</span>
    converter.optimizations = [tf.lite.Optimize.DEFAULT]
    
    <span class="hljs-comment"># 3. 转换</span>
    tflite_model = converter.convert()
    
    <span class="hljs-comment"># 4. 保存文件</span>
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(output_path, <span class="hljs-string">'wb'</span>) <span class="hljs-keyword">as</span> f:
        f.write(tflite_model)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"模型已成功转换并保存至: <span class="hljs-subst">{output_path}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"原始模型大小: ... MB"</span>) <span class="hljs-comment"># 实际项目中可添加计算逻辑</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"量化后模型大小: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(tflite_model) / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>:<span class="hljs-number">.2</span>f}</span> MB"</span>)

<span class="hljs-comment"># 调用示例 (假设你已经训练好并保存了模型)</span>
<span class="hljs-comment"># convert_to_tflite('my_face_model.h5', 'face_model_quantized.tflite')</span>
</code></pre>
<h2 data-id="heading-8">四、 难点四：活体检测</h2>
<p><strong>痛点解析</strong>：<br/>
这是人脸识别系统安全性的最后一道防线。不法分子可能使用高清照片、3D 面具甚至 Deepfake 视频来欺骗系统。</p>
<p><strong>技术方案</strong>：<br/>
在主识别流程中增加一个“活体检测”分支。可以是基于<strong>眨眼检测</strong>的传统 CV 算法（简单有效），也可以是基于<strong>3D 结构光</strong>或<strong>近红外成像</strong>的深度学习分类器。</p>
<h3 data-id="heading-9">代码实战：简单的眨眼检测（基于眼睛纵横比）</h3>
<p>python</p>
<p>复制</p>
<pre><code class="hljs language-ini" lang="ini">import cv2
import dlib

def eye_aspect_ratio(eye):
    """
    计算眼睛的纵横比 (EAR)
    EAR 值越小，说明眼睛闭合程度越大
    """
    <span class="hljs-comment"># 垂直方向距离</span>
    <span class="hljs-attr">A</span> = np.linalg.norm(eye[<span class="hljs-number">1</span>] - eye[<span class="hljs-number">5</span>])
    <span class="hljs-attr">B</span> = np.linalg.norm(eye[<span class="hljs-number">2</span>] - eye[<span class="hljs-number">4</span>])
    <span class="hljs-comment"># 水平方向距离</span>
    <span class="hljs-attr">C</span> = np.linalg.norm(eye[<span class="hljs-number">0</span>] - eye[<span class="hljs-number">3</span>])
    
    <span class="hljs-attr">ear</span> = (A + B) / (<span class="hljs-number">2.0</span> * C)
    return ear

<span class="hljs-comment"># 初始化 dlib 的人脸检测器和关键点预测器</span>
<span class="hljs-comment"># 注意：需要下载 shape_predictor_68_face_landmarks.dat 文件</span>
<span class="hljs-attr">detector</span> = dlib.get_frontal_face_detector()
<span class="hljs-attr">predictor</span> = dlib.shape_predictor(<span class="hljs-string">'shape_predictor_68_face_landmarks.dat'</span>)

<span class="hljs-comment"># 眼睛关键点的索引 (左眼和右眼)</span>
<span class="hljs-attr">LEFT_EYE_INDICES</span> = list(range(<span class="hljs-number">36</span>, <span class="hljs-number">42</span>))
<span class="hljs-attr">RIGHT_EYE_INDICES</span> = list(range(<span class="hljs-number">42</span>, <span class="hljs-number">48</span>))

def check_blink(frame):
    <span class="hljs-attr">gray</span> = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)
    <span class="hljs-attr">rects</span> = detector(gray, <span class="hljs-number">0</span>)
    
    for rect in rects:
        <span class="hljs-attr">shape</span> = predictor(gray, rect)
        <span class="hljs-attr">shape</span> = np.array([[p.x, p.y] for p in shape.parts()])
        
        <span class="hljs-comment"># 提取左右眼坐标</span>
        <span class="hljs-attr">left_eye</span> = shape[LEFT_EYE_INDICES]
        <span class="hljs-attr">right_eye</span> = shape[RIGHT_EYE_INDICES]
        
        <span class="hljs-attr">left_ear</span> = eye_aspect_ratio(left_eye)
        <span class="hljs-attr">right_ear</span> = eye_aspect_ratio(right_eye)
        
        <span class="hljs-comment"># 双眼平均 EAR</span>
        <span class="hljs-attr">ear</span> = (left_ear + right_ear) / <span class="hljs-number">2.0</span>
        
        <span class="hljs-comment"># 眨眼阈值（需要根据实际情况调整）</span>
        if ear &lt; 0.21:
            return True <span class="hljs-comment"># 检测到眨眼</span>
            
    return False

<span class="hljs-comment"># 在主循环中调用</span>
<span class="hljs-comment"># if check_blink(frame):</span>
<span class="hljs-comment">#     print("用户眨眼了，活体验证通过")</span>
</code></pre>
<h2 data-id="heading-10">总结</h2>
<p>开发一个人脸识别小程序，涉及的技术链条非常长：</p>
<ol>
<li><strong>数据层</strong>：OpenCV 预处理增强鲁棒性。</li>
<li><strong>算法层</strong>：TensorFlow 深度度量学习解决开放集问题。</li>
<li><strong>工程层</strong>：TFLite 量化解决移动端性能瓶颈。</li>
<li><strong>安全层</strong>：活体检测防御照片攻击。</li>
</ol>
<p>每一个环节都是系统的关键节点，任何一个短板都可能导致整体体验崩塌。只有深入理解这些难点，并通过代码反复验证，才能构建出真正可用的产品。希望这篇拆解文章能帮你理清开发思路！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于C++构建DeepSeek大模型推理SDK：从架构设计到工程落地]]></title>    <link>https://juejin.cn/post/7600225000851292195</link>    <guid>https://juejin.cn/post/7600225000851292195</guid>    <pubDate>2026-01-28T09:27:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600225000851292195" data-draft-id="7600242248860680232" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于C++构建DeepSeek大模型推理SDK：从架构设计到工程落地"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-28T09:27:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无爱如何释怀"/> <meta itemprop="url" content="https://juejin.cn/user/4158824111150512"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于C++构建DeepSeek大模型推理SDK：从架构设计到工程落地
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4158824111150512/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无爱如何释怀
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T09:27:31.000Z" title="Wed Jan 28 2026 09:27:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>@<a href="https://link.juejin.cn?target=%25E8%25BF%2599%25E9%2587%258C%25E5%2586%2599%25E7%259B%25AE%25E5%25BD%2595%25E6%25A0%2587%25E9%25A2%2598" target="_blank" title="%E8%BF%99%E9%87%8C%E5%86%99%E7%9B%AE%E5%BD%95%E6%A0%87%E9%A2%98" ref="nofollow noopener noreferrer">TOC</a></p>
<h2 data-id="heading-0">前言</h2>
<p>在高性能计算与大模型（LLM）应用开发的浪潮中，C++凭借其卓越的内存管理能力和运行时效率，成为了构建底层推理SDK的首选语言。本文将深入剖析如何从零开始，设计并实现一个能够调用DeepSeek模型的C++ SDK。全通过程涵盖了云端鉴权、面向对象架构设计、多态接口封装、单元测试体系构建以及CMake编译系统的配置。</p>
<h2 data-id="heading-1">一、 云端环境配置与鉴权机制</h2>
<p>大模型的调用始于服务提供商的鉴权流程。本次实战选用蓝耘（Lanyun）作为算力与模型服务平台。鉴权体系通常采用基于OAuth2或API Key的机制，确保服务调用的安全性与计费准确性。</p>
<p>访问控制台注册页面，完成账户初始化。</p>
<pre><code class="hljs language-bash" lang="bash">https://console.lanyun.net/<span class="hljs-comment">#/register?promoterCode=5663b8b127</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3be85930194454c934c65501e439fed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197251&amp;x-signature=jXc%2BtY7rOxMGgweUgVE0Tsq4UM8%3D" alt="image.png" loading="lazy"/></p>
<p>注册完成后进入模型广场。在众多大语言模型中，选择DeepSeek-V3.2版本。模型ID（Model ID）是API调用中路由请求的关键标识符，系统后端依据此ID将请求分发至加载了特定权重的推理集群。此处记录模型ID为 <code>/maas/deepseek-ai/DeepSeek-V3.2</code>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b57b938b774a4c53910686d003a7a92f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197251&amp;x-signature=mS62i%2FObfIuuZds74gvOPEqcA7Q%3D" alt="image.png" loading="lazy"/></p>
<p>紧接着，在安全设置中生成API Key。API Key本质上是一个加密的凭证，通常包含用户标识和签名信息。在HTTP请求头中，它通常以Bearer Token的形式存在（<code>Authorization: Bearer &lt;API_KEY&gt;</code>）。该密钥必须严格保密，防止泄露导致额度被盗用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55bd753b5fc54d07ad8dfb76a0eab19c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197251&amp;x-signature=D1tuXRhwSxKMugHTf5FbGn%2FOk3c%3D" alt="image.png" loading="lazy"/></p>
<p>查阅API文档是集成的核心步骤。文档定义了通信协议（HTTP/HTTPS）、请求方法（POST）、数据格式（JSON）以及服务端点（Endpoint）。
文档显示Base URL为 <code>https://maas-api.lanyun.net/v1/chat/completions</code>。这表明该服务遵循OpenAI兼容的API规范，<code>/v1/chat/completions</code> 是标准的对话补全路由。这也决定了后续C++代码中HTTP客户端需要支持SSL/TLS加密（即HTTPS），因此引入OpenSSL库是架构设计的必要条件。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e6492238df444878998281a3b6d8b97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197251&amp;x-signature=zIjH5W2PPIOuzqo8J2ib0mY2H04%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">二、 C++ SDK 核心数据结构设计</h2>
<p>SDK的健壮性取决于底层数据结构的设计。在 <code>SDK/include/common.h</code> 中，通过结构体（Struct）对业务实体进行抽象，利用C++标准模板库（STL）管理内存资源。</p>
<h3 data-id="heading-3">1. 消息与配置实体</h3>
<p><code>Message</code> 结构体用于封装对话上下文。</p>
<ul>
<li><code>_id</code>：消息唯一标识，用于分布式追踪。</li>
<li><code>_role</code>：区分 <code>user</code>（用户）、<code>assistant</code>（模型）或 <code>system</code>（系统指令）。</li>
<li><code>_content</code>：实际文本载荷。</li>
<li><code>_timestamp</code>：使用 <code>std::time_t</code> 记录时间，便于会话排序与审计。</li>
</ul>
<p><code>Config</code> 结构体定义了推理参数。</p>
<ul>
<li><code>_temperature</code>：双精度浮点数，控制采样随机性。0.7是一个平衡创造性与准确性的典型值。</li>
<li><code>_maxTokens</code>：限制输出长度，防止显存溢出或超长生成。</li>
</ul>
<p><code>APIConfig</code> 继承自 <code>Config</code>，体现了面向对象设计的“扩展性”。它在基础配置之上增加了 <code>_apiKey</code>，专门用于云端推理场景。这种设计允许未来扩展本地模型配置（如本地模型路径）而不污染基础配置结构。</p>
<h3 data-id="heading-4">2. 模型信息与会话管理</h3>
<p><code>ModelInfo</code> 结构体存储元数据，包括提供方（Provider）、服务端点（Endpoint）及可用性状态。布尔值 <code>_isAvailable</code> 是连接池健康检查的关键指标。</p>
<p><code>Session</code> 结构体管理多轮对话的上下文。通过 <code>std::vector&lt;Message&gt;</code> 存储历史消息序列。在发送请求时，通常需要将此向量中的历史记录序列化为JSON数组，连同新问题一并发送，以维持LLM的“记忆”能力。
<code>ai_-model_-sdk/SDK/include/common.h</code><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/153b07ec386341ccbda0304a1c2fd948~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197251&amp;x-signature=ux2dQeioQlbGrgRwzNqYkivZjro%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ctime&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;vector&gt;</span></span>

  
  

<span class="hljs-keyword">namespace</span> ai_chat_sdk

{

    <span class="hljs-comment">//消息结构</span>

    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Message</span>

    {

        std::string _id;<span class="hljs-comment">//消息id</span>

        std::string _role;<span class="hljs-comment">//消息角色</span>

        std::string _content;<span class="hljs-comment">//消息内容</span>

        std::<span class="hljs-type">time_t</span> _timestamp;<span class="hljs-comment">//消息时间戳</span>

  
  

        <span class="hljs-comment">//构造函数</span>

        <span class="hljs-built_in">Message</span>(<span class="hljs-type">const</span> std::string&amp; role, <span class="hljs-type">const</span> std::string&amp; content)

            : _role(role), _content(content)

            {}

  

        <span class="hljs-comment">//模型的公共配置信息</span>

    };

  

    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Config</span>

    {

        std::string _modelName;<span class="hljs-comment">//模型名称</span>

        <span class="hljs-type">double</span> _temperature=<span class="hljs-number">0.7</span>;<span class="hljs-comment">//温度参数,用来控制模型的生成随机性,默认值为0.7</span>

        <span class="hljs-type">int</span> _maxTokens=<span class="hljs-number">2048</span>;<span class="hljs-comment">//最大token数,用来控制模型的生成长度,默认值为2048</span>

    };

  

    <span class="hljs-comment">//通过API方式接入云端模型</span>

    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">APIConfig</span>:<span class="hljs-keyword">public</span> Config<span class="hljs-comment">//继承Config</span>

    {

        std::string _apiKey;<span class="hljs-comment">//api key</span>

    };

  

    <span class="hljs-comment">//通过ollama接入本地模型---不需要apikey</span>

  

    <span class="hljs-comment">//LLM模型信息</span>

    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ModelInfo</span>

    {

        std::string _modelName;<span class="hljs-comment">//模型名称</span>

        std::string _modelDesc;<span class="hljs-comment">//模型描述信息</span>

        std::string _provider;<span class="hljs-comment">//模型提供方</span>

        std::string _endpoint;<span class="hljs-comment">//模型访问地址  base url</span>

        <span class="hljs-type">bool</span> _isAvailable=<span class="hljs-literal">false</span>;<span class="hljs-comment">//模型是否可用,默认值为false</span>

  

        <span class="hljs-built_in">ModelInfo</span>(<span class="hljs-type">const</span> std::string&amp; modelName=<span class="hljs-string">""</span>, <span class="hljs-type">const</span> std::string&amp; modelDesc=<span class="hljs-string">""</span>, <span class="hljs-type">const</span> std::string&amp; provider=<span class="hljs-string">""</span>, <span class="hljs-type">const</span> std::string&amp; endpoint=<span class="hljs-string">""</span>)

            : _modelName(modelName), _modelDesc(modelDesc), _provider(provider), _endpoint(endpoint)

            {}

    };

  

    <span class="hljs-comment">//会话结构</span>

    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Session</span>

    {

        std::string _sessionId;<span class="hljs-comment">//会话id</span>

        std::string _modelName;<span class="hljs-comment">//模型名称</span>

        std::vector&lt;Message&gt; _messages;<span class="hljs-comment">//会话消息列表</span>

        std::<span class="hljs-type">time_t</span> _createAt;<span class="hljs-comment">//会话创建时间戳</span>

        std::<span class="hljs-type">time_t</span> _updateAt;<span class="hljs-comment">//会话更新时间戳</span>

  

        <span class="hljs-comment">//构造函数</span>

        <span class="hljs-built_in">Session</span>( <span class="hljs-type">const</span> std::string&amp; modelName=<span class="hljs-string">""</span>)

            :_modelName(modelName)

            {}

    };

  

} <span class="hljs-comment">//end ai_chat_sdk</span>
</code></pre>
<h2 data-id="heading-5">三、 抽象接口层设计：策略模式的应用</h2>
<p>为了支持多种后端（如DeepSeek、ChatGPT、本地Ollama），在 <code>SDK/include/LLMProvider.h</code> 中定义了抽象基类 <code>LLMProvider</code>。这是“依赖倒置原则”的典型应用，上层业务逻辑依赖于抽象接口，而非具体实现。</p>
<p><code>LLMProvider</code> 声明了纯虚函数（Pure Virtual Functions），强制派生类必须实现这些行为：</p>
<ul>
<li><code>initModel</code>：接收 <code>std::map</code> 类型的配置参数，具有极高的灵活性，无需硬编码配置项。</li>
<li><code>sendMessage</code>：同步阻塞式调用，适用于短文本生成。</li>
<li><code>sendMessageStream</code>：流式响应接口。利用 <code>std::function</code> 回调机制，实现Token逐个返回。这对于提升用户体验至关重要，用户无需等待完整生成即可看到首字。</li>
</ul>
<p>值得注意的是，代码中原有的 <code>projected:</code> 访问修饰符应修正为 <code>protected:</code>。这是C++中用于限制成员变量仅对派生类可见的关键字。将 <code>_apiKey</code> 和 <code>_endpoint</code> 设为受保护成员，既保证了封装性，又允许子类直接访问这些基础资源。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a954d37feea1455d8eff8bbe6abdc8df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197251&amp;x-signature=QfW4Firq8IJ39rOHKLhT7TOCBSc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><code>ai_-model_-sdk/SDK/include/LLMprovider.h</code></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;string.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;map&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;vector&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">"common.h"</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;functional&gt;</span>  </span>

<span class="hljs-keyword">namespace</span> kk

{

    <span class="hljs-comment">//LLMProvider类</span>

    <span class="hljs-keyword">class</span> <span class="hljs-title class_">LLMProvider</span>

    {

    <span class="hljs-keyword">public</span>:

        <span class="hljs-comment">//初始化模型</span>

        <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">bool</span> <span class="hljs-title">initModel</span><span class="hljs-params">(<span class="hljs-type">const</span> std::map&lt;std::string,std::string&gt;&amp; modelConfig)</span></span>=<span class="hljs-number">0</span>;<span class="hljs-comment">//初始化模型,传入模型配置参数：模型名称、模型路径、模型参数等</span>

        <span class="hljs-comment">//检查模型是否可用</span>

        <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">bool</span> <span class="hljs-title">isAvailable</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>=<span class="hljs-number">0</span>;

        <span class="hljs-comment">//获取模型名称</span>

        <span class="hljs-function"><span class="hljs-keyword">virtual</span> std::string <span class="hljs-title">getModelName</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>=<span class="hljs-number">0</span>;

        <span class="hljs-comment">// 获取模型描述</span>

        <span class="hljs-function"><span class="hljs-keyword">virtual</span> std::string <span class="hljs-title">getModelDesc</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>=<span class="hljs-number">0</span>;

        <span class="hljs-comment">//发送消息 ---全量返回   非流式响应</span>

        <span class="hljs-function"><span class="hljs-keyword">virtual</span> std::string <span class="hljs-title">sendMessage</span><span class="hljs-params">(<span class="hljs-type">const</span> std::vector&lt;Message&gt;&amp; messages,<span class="hljs-type">const</span> std::map&lt;std::string,std::string&gt;&amp; requestParam)</span></span>=<span class="hljs-number">0</span>;<span class="hljs-comment">//第一个参数为消息列表，第二个参数为请求参数</span>

        <span class="hljs-comment">//发送消息 ---全量返回   流式响应</span>

        <span class="hljs-function"><span class="hljs-keyword">virtual</span> std::string <span class="hljs-title">sendMessageStream</span><span class="hljs-params">(<span class="hljs-type">const</span> std::vector&lt;Message&gt;&amp; messages,

                        <span class="hljs-type">const</span> std::map&lt;std::string,std::string&gt;&amp; requestParam,<span class="hljs-comment">//第一个参数为消息列表，第二个参数为请求参数</span>

                        std::function&lt;<span class="hljs-type">void</span>(<span class="hljs-type">const</span> std::string&amp;,<span class="hljs-type">bool</span>)&gt; callback)</span></span>=<span class="hljs-number">0</span>;<span class="hljs-comment">//第三个参数为回调函数，这个回调函数第一个参数是模型返回的数据，第二个参数为是否为最后一个响应</span>

                        <span class="hljs-comment">//callback:增量返回的每一个token，以及是否是最好一个token</span>

    projected:

        <span class="hljs-type">bool</span> _isAvailable=<span class="hljs-literal">false</span>;<span class="hljs-comment">//模型是否可用</span>

        std::string _apiKey;<span class="hljs-comment">//模型API密钥</span>

        std::string _endpoint;<span class="hljs-comment">//模型API地址</span>

    };

}
</code></pre>
<h2 data-id="heading-6">四、 DeepSeek 适配器实现</h2>
<p><code>DeepSeekProvider</code> 类继承自 <code>LLMProvider</code>，具体实现了针对DeepSeek模型的业务逻辑。</p>
<h3 data-id="heading-7">1. 初始化逻辑</h3>
<p>在 <code>src/DeepSeekProvider.cpp</code> 中，<code>initModel</code> 函数执行了防御性编程。它首先在传入的 <code>modelConfig</code> 映射中查找 <code>apiKey</code> 和 <code>endpoint</code>。若关键参数缺失，通过宏 <code>ERR</code> 记录错误日志并返回 <code>false</code>，防止系统在配置无效的状态下启动。只有当所有必要参数校验通过后，<code>_isAvailable</code> 标志位才会被置为 <code>true</code>。</p>
<h3 data-id="heading-8">2. 信息查询接口</h3>
<p><code>getModelName</code> 与 <code>getModelDesc</code> 提供了模型的自描述能力。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30932d4521ca4ea5a95a49d3de6a7ce9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197251&amp;x-signature=A4lA6bmphvt0FNPcUREpW2gsQNA%3D" alt="image.png" loading="lazy"/></p>
<p>上图展示了代码中返回模型名称的实现细节。这不仅仅是返回一个字符串，它在多模型混合调度的系统中，是路由分发和日志记录的重要依据。</p>
<p>虽然提供的代码片段中省略了 <code>sendMessage</code> 的具体HTTP实现（通常涉及 <code>libcurl</code> 或 <code>httplib</code> 的调用、JSON序列化与反序列化），但架构框架已经明确：接收 <code>Message</code> 向量，构建JSON Payload，发起HTTPS POST请求，解析响应中的 <code>choices[0].message.content</code>，并处理可能的网络异常。
在include目录中创建一个DeepSeekProvider.h文件</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">"LLMProvider.h"</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;string.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;map&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;vector&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">"common.h"</span></span>

  

<span class="hljs-keyword">namespace</span> kk

{

    <span class="hljs-comment">//LLMProvider类</span>

    <span class="hljs-keyword">class</span> <span class="hljs-title class_">DeepSeekProvider</span> : <span class="hljs-keyword">public</span> LLMProvider

    {

    <span class="hljs-keyword">public</span>:

        <span class="hljs-comment">//初始化模型</span>

        <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">initModel</span><span class="hljs-params">(<span class="hljs-type">const</span> std::map&lt;std::string,std::string&gt;&amp; modelConfig)</span></span>;<span class="hljs-comment">//初始化模型,传入模型配置参数：模型名称、模型路径、模型参数等</span>

        <span class="hljs-comment">//检查模型是否可用</span>

        <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">bool</span> <span class="hljs-title">isAvailable</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;

        <span class="hljs-comment">//获取模型名称</span>

        <span class="hljs-function"><span class="hljs-keyword">virtual</span> std::string <span class="hljs-title">getModelName</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;

        <span class="hljs-comment">// 获取模型描述</span>

        <span class="hljs-function"><span class="hljs-keyword">virtual</span> std::string <span class="hljs-title">getModelDesc</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;

        <span class="hljs-comment">//发送消息 ---全量返回   非流式响应</span>

        <span class="hljs-function">std::string <span class="hljs-title">sendMessage</span><span class="hljs-params">(<span class="hljs-type">const</span> std::vector&lt;Message&gt;&amp; messages,<span class="hljs-type">const</span> std::map&lt;std::string,std::string&gt;&amp; requestParam)</span></span>;<span class="hljs-comment">//第一个参数为消息列表，第二个参数为请求参数</span>

        <span class="hljs-comment">//发送消息 ---全量返回   流式响应</span>

        <span class="hljs-function"><span class="hljs-keyword">virtual</span> std::string <span class="hljs-title">sendMessageStream</span><span class="hljs-params">(<span class="hljs-type">const</span> std::vector&lt;Message&gt;&amp; messages,

                        <span class="hljs-type">const</span> std::map&lt;std::string,std::string&gt;&amp; requestParam,<span class="hljs-comment">//第一个参数为消息列表，第二个参数为请求参数</span>

                        <span class="hljs-keyword">virtual</span> std::function&lt;<span class="hljs-type">void</span>(<span class="hljs-type">const</span> std::string&amp;,<span class="hljs-type">bool</span>)&gt; callback)</span></span>;<span class="hljs-comment">//第三个参数为回调函数，这个回调函数第一个参数是模型返回的数据，第二个参数为是否为最后一个响应</span>

                        <span class="hljs-comment">//callback:增量返回的每一个token，以及是否是最好一个token</span>

  

    };

}
</code></pre>
<p>直接就是集成LLMProvider这个类</p>
<p>然后去src中创建一个DeepSeekProvider.cpp文件</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">"../include/DeepSeekProvider.h"</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">"../include/util/myLog.h"</span></span>

  

<span class="hljs-keyword">namespace</span> kk

{

    <span class="hljs-comment">//初始化模型</span>

    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">DeepSeekProvider::initModel</span><span class="hljs-params">(<span class="hljs-type">const</span> std::map&lt;std::string,std::string&gt;&amp; modelConfig)</span>

    </span>{

        <span class="hljs-comment">//初始化API key</span>

        <span class="hljs-keyword">auto</span> it =modelConfig.<span class="hljs-built_in">find</span>(<span class="hljs-string">"apiKey"</span>);

        <span class="hljs-keyword">if</span>(it==modelConfig.<span class="hljs-built_in">end</span>())<span class="hljs-comment">//没找到apikey的话</span>

        {

            <span class="hljs-built_in">ERR</span>(<span class="hljs-string">"DeepSeekProvider initModel:apiKey not found"</span>);<span class="hljs-comment">//打印一个错误日志</span>

            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

        }

        _apiKey=it-&gt;second;<span class="hljs-comment">//找到了的话就给apikey进行一个赋值操作</span>

  

        <span class="hljs-comment">//初始化endpoint</span>

        it=modelConfig.<span class="hljs-built_in">find</span>(<span class="hljs-string">"endpoint"</span>);

        <span class="hljs-keyword">if</span>(it==modelConfig.<span class="hljs-built_in">end</span>())<span class="hljs-comment">//没找到endpoint的话</span>

        {

            <span class="hljs-built_in">ERR</span>(<span class="hljs-string">"DeepSeekProvider initModel:endpoint not found"</span>);<span class="hljs-comment">//打印一个错误日志</span>

            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

        }

        _endpoint=it-&gt;second;<span class="hljs-comment">//找到了的话就给endpoint进行一个赋值操作</span>

        _isAvailable=<span class="hljs-literal">true</span>;<span class="hljs-comment">//模型可用</span>

  

        <span class="hljs-comment">//初始化成功，打印日志</span>

        <span class="hljs-built_in">INFO</span>(<span class="hljs-string">"DeepSeekProvider initModel:success,apiKey:%s,endpoint:%s"</span>,_apiKey.<span class="hljs-built_in">c_str</span>(),_endpoint.<span class="hljs-built_in">c_str</span>());

        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

    }

  

    <span class="hljs-comment">//检测模型是否可用</span>

    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">DeepSeekProvider::isAvailable</span><span class="hljs-params">()</span> <span class="hljs-type">const</span>

    </span>{

        <span class="hljs-keyword">return</span> _isAvailable;

    }

  

    <span class="hljs-comment">//获取模型名称</span>

    <span class="hljs-function">std::string <span class="hljs-title">DeepSeekProvider::getModelName</span><span class="hljs-params">()</span> <span class="hljs-type">const</span>

    </span>{

        <span class="hljs-keyword">return</span> <span class="hljs-string">"deepseek-v3.2"</span>;

    }

  

    <span class="hljs-comment">//获取模型的描述信息</span>

    <span class="hljs-function">std::string <span class="hljs-title">DeepSeekProvider::getModelDesc</span><span class="hljs-params">()</span> <span class="hljs-type">const</span>

    </span>{

        <span class="hljs-keyword">return</span> <span class="hljs-string">"deepseek-chat模型是一个基于Transformer架构的对话模型,由DeepSeek公司开发。它可以用于生成自然语言对话,支持多轮对话。"</span>;

    }

  

    <span class="hljs-comment">//发送消息 ---全量返回   非流式响应</span>

    <span class="hljs-function">std::string <span class="hljs-title">DeepSeekProvider::sendMessage</span><span class="hljs-params">(<span class="hljs-type">const</span> std::vector&lt;Message&gt;&amp; messages,<span class="hljs-type">const</span> std::map&lt;std::string,std::string&gt;&amp; requestParam)</span><span class="hljs-comment">//第一个参数为消息列表，第二个参数为请求参数</span>

    </span>{

    }

    <span class="hljs-comment">//发送消息 ---全量返回   流式响应</span>

    <span class="hljs-function">std::string <span class="hljs-title">DeepSeekProvider::sendMessageStream</span><span class="hljs-params">(<span class="hljs-type">const</span> std::vector&lt;Message&gt;&amp; messages,

                                            <span class="hljs-type">const</span> std::map&lt;std::string,std::string&gt;&amp; requestParam,<span class="hljs-comment">//第一个参数为消息列表，第二个参数为请求参数</span>

                                            std::function&lt;<span class="hljs-type">void</span>(<span class="hljs-type">const</span> std::string&amp;,<span class="hljs-type">bool</span>)&gt; callback)</span><span class="hljs-comment">//第三个参数为回调函数，这个回调函数第一个参数是模型返回的数据，第二个参数为是否为最后一个响应</span>

                                            <span class="hljs-comment">//callback:增量返回的每一个token，以及是否是最好一个token</span>

    </span>{

    }

  

}
</code></pre>
<h2 data-id="heading-9">五、 单元测试与质量保证</h2>
<p>软件工程中，未经测试的代码不具备交付价值。本项目引入 Google Test (gtest) 框架进行单元测试。</p>
<h3 data-id="heading-10">1. 测试环境构建</h3>
<p>在 <code>testLLM.cpp</code> 中，测试用例 <code>TEST(DeepSeekProviderTest, sendMessage)</code> 模拟了完整的调用流程。</p>
<ul>
<li><strong>智能指针管理</strong>：使用 <code>std::make_shared</code> 创建实例，自动管理生命周期，避免内存泄漏。</li>
<li><strong>安全凭证注入</strong>：通过 <code>std::getenv("deepseek_apikey")</code> 从环境变量读取密钥。这是DevOps的最佳实践，严禁将敏感密钥硬编码在源码中。</li>
<li><strong>断言机制</strong>：<code>ASSERT_TRUE</code> 验证对象指针有效性及初始化结果。若断言失败，测试立即终止，便于快速定位崩溃点。</li>
</ul>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;gtest/gtest.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">"../SDK/include/DeepSeekProvider.h"</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">"../SDK/include/util/myLog.h"</span></span>

  
  

<span class="hljs-comment">//测试DeepSeekProvider的initModel方法</span>

<span class="hljs-built_in">TEST</span>(DeepSeekProviderTest,sendMessage)<span class="hljs-comment">//第一个参数是测试用例的名称，第二个参数是测试用例的描述</span>

{

    <span class="hljs-keyword">auto</span> Provider=std::<span class="hljs-built_in">make_shared</span>&lt;kk::DeepSeekProvider&gt;();<span class="hljs-comment">//创建一个DeepSeekProvider对象的智能指针</span>

    <span class="hljs-built_in">ASSERT_TRUE</span>(Provider!=<span class="hljs-literal">nullptr</span>);<span class="hljs-comment">//断言Provider对象不为空指针</span>

  

    std::map&lt;std::string,std::string&gt; modelParam;

    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* env_apikey = std::<span class="hljs-built_in">getenv</span>(<span class="hljs-string">"deepseek_apikey"</span>);

    modelParam[<span class="hljs-string">"apiKey"</span>] = env_apikey ? env_apikey : <span class="hljs-string">"sk-xxxxxxxxxxxxxxxxxxxxxxxxxx"</span>;

    modelParam[<span class="hljs-string">"endpoint"</span>]=<span class="hljs-string">"https://maas-api.lanyun.net"</span>;

    <span class="hljs-comment">//实例化DeepSeekProvider对象</span>

    Provider-&gt;<span class="hljs-built_in">initModel</span>(modelParam);<span class="hljs-comment">//初始化模型，传入模型配置映射</span>

    <span class="hljs-built_in">ASSERT_TRUE</span>(Provider-&gt;<span class="hljs-built_in">isAvailable</span>());<span class="hljs-comment">//断言Provider对象不为空指针</span>

  
  
  

    std::map&lt;std::string,std::string&gt; requestParam=

    {<span class="hljs-comment">//创建一个模型配置映射，包含temperature和max_tokens</span>

        {<span class="hljs-string">"temperature"</span>,<span class="hljs-string">"0.5"</span>},

        {<span class="hljs-string">"max_tokens"</span>,<span class="hljs-string">"2048"</span>}

    };

  

    std::vector&lt;kk::Message&gt; messages;

    messages.<span class="hljs-built_in">push_back</span>({<span class="hljs-string">"user"</span>,<span class="hljs-string">"你是谁？"</span>});<span class="hljs-comment">//添加一个用户消息</span>

  

    <span class="hljs-comment">//调用sendMessage方法</span>

    std::string response=Provider-&gt;<span class="hljs-built_in">sendMessage</span>(messages,requestParam);<span class="hljs-comment">//传入消息列表和请求参数，返回模型的响应</span>

    <span class="hljs-built_in">ASSERT_TRUE</span>(!response.<span class="hljs-built_in">empty</span>());<span class="hljs-comment">//断言响应字符串不为空</span>

}

  
  
  

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span>

</span>{

    <span class="hljs-comment">//初始化spdlog日志库</span>

    kk::Logger::<span class="hljs-built_in">initLogger</span>(<span class="hljs-string">"testLLM"</span>,<span class="hljs-string">"stdout"</span>,spdlog::level::debug);<span class="hljs-comment">//初始化日志库，参数为日志名称、日志文件名、日志级别</span>

    <span class="hljs-built_in">INFO</span>(<span class="hljs-string">"Test log message with value: {}"</span>, <span class="hljs-number">42</span>);

    <span class="hljs-built_in">INFO</span>(<span class="hljs-string">"Test log message with two values: {} and {}"</span>, <span class="hljs-number">10</span>, <span class="hljs-number">20</span>);

    <span class="hljs-comment">//初始化gtest库</span>

    testing::<span class="hljs-built_in">InitGoogleTest</span>(&amp;argc, argv);<span class="hljs-comment">//调用初始化Google Test框架，将命令行参数传递给它</span>

    <span class="hljs-comment">//执行所有的测试用例</span>

    <span class="hljs-keyword">return</span> <span class="hljs-built_in">RUN_ALL_TESTS</span>();

}
</code></pre>
<h3 data-id="heading-11">2. 日志系统</h3>
<p>测试入口 <code>main</code> 函数中初始化了 <code>spdlog</code> 日志库。<code>kk::Logger::initLogger</code> 设置了日志级别为 <code>debug</code>，确保在开发阶段能捕获所有交互细节。<code>testing::InitGoogleTest</code> 负责解析命令行参数，驱动测试执行。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;spdlog/spdlog.h&gt;</span></span>

  
  

<span class="hljs-keyword">namespace</span> kk

{

    <span class="hljs-comment">//单例模式</span>

    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Logger</span>

    {

    <span class="hljs-keyword">public</span>:

        <span class="hljs-comment">//获取单例实例</span>

        <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">initLogger</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string &amp;loggerName,<span class="hljs-type">const</span> std::string &amp;loggerFile,spdlog::level::level_enum logLevel=spdlog::level::info)</span></span>;<span class="hljs-comment">//日志名称，日志文件路径，日志级别</span>

        <span class="hljs-comment">//获取日志实例</span>

        <span class="hljs-function"><span class="hljs-type">static</span> std::shared_ptr&lt;spdlog::logger&gt; <span class="hljs-title">getLogger</span><span class="hljs-params">()</span></span>;

    <span class="hljs-keyword">private</span>:

        <span class="hljs-comment">//构造函数  </span>

        <span class="hljs-built_in">Logger</span>();

        <span class="hljs-comment">//删除拷贝构造函数和赋值运算符</span>

        <span class="hljs-built_in">Logger</span>(<span class="hljs-type">const</span> Logger&amp;) = <span class="hljs-keyword">delete</span>;

        Logger&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> Logger&amp;) = <span class="hljs-keyword">delete</span>;

    <span class="hljs-keyword">private</span>:

        <span class="hljs-type">static</span>  std::shared_ptr&lt;spdlog::logger&gt; _logger;<span class="hljs-comment">//静态日志实例对象</span>

        <span class="hljs-type">static</span> std::mutex _mutex;<span class="hljs-comment">//静态互斥锁</span>

    };

  

<span class="hljs-comment">//调试日志宏</span>

<span class="hljs-comment">//format:日志格式</span>

<span class="hljs-comment">//...:可变参数</span>

<span class="hljs-comment">//__FILE__:当前文件名</span>

<span class="hljs-comment">//__LINE__:当前行号</span>

<span class="hljs-comment">//将文件名和行号格式化为[文件名:行号]的形式</span>

<span class="hljs-comment">//__VA_ARGS__:可变参数</span>

<span class="hljs-comment">//将格式化后的字符串和可变参数传递给日志器的debug方法</span>

<span class="hljs-comment">//09:04:03 [aiChat] [DEBUG] [/home/ubuntu/ai_-model_-sdk/SDK/src/util/myLog.cpp:123] 这是一条调试日志</span>

<span class="hljs-comment">//DBG("这是一条调试日志":{}:{},dbName,dbType)</span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> DBG(format, ...)kk::Logger::getLogger()-&gt;debug(<span class="hljs-string">"[{:&gt;10s}:{:&lt;4d}] "</span> format,__FILE__,__LINE__, ##__VA_ARGS__)</span>

<span class="hljs-comment">//定义其他日志级别宏</span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> TRACE(format, ...)kk::Logger::getLogger()-&gt;log(spdlog::level::trace,<span class="hljs-string">"[{:&gt;10s}:{:&lt;4d}] "</span> format,__FILE__,__LINE__, ##__VA_ARGS__)</span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> INFO(format, ...)kk::Logger::getLogger()-&gt;info(<span class="hljs-string">"[{:&gt;10s}:{:&lt;4d}] "</span> format,__FILE__,__LINE__, ##__VA_ARGS__)</span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> WARN(format, ...)kk::Logger::getLogger()-&gt;warn(<span class="hljs-string">"[{:&gt;10s}:{:&lt;4d}] "</span> format,__FILE__,__LINE__, ##__VA_ARGS__)</span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> ERR(format, ...)kk::Logger::getLogger()-&gt;<span class="hljs-keyword">error</span>(<span class="hljs-string">"[{:&gt;10s}:{:&lt;4d}] "</span> format,__FILE__,__LINE__, ##__VA_ARGS__)</span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> CRIT(format, ...)kk::Logger::getLogger()-&gt;critical(<span class="hljs-string">"[{:&gt;10s}:{:&lt;4d}] "</span> format,__FILE__,__LINE__, ##__VA_ARGS__)</span>

} <span class="hljs-comment">//end kk</span>
</code></pre>
<h2 data-id="heading-12">六、 CMake 构建系统配置</h2>
<p>C++项目的构建复杂性通过 CMake 进行管理。<code>CMakeLists.txt</code> 文件定义了编译规则与依赖关系。</p>
<h3 data-id="heading-13">1. 依赖管理</h3>
<p>项目依赖 OpenSSL 进行HTTPS通信，依赖 spdlog 进行日志记录，依赖 gtest 进行测试，依赖 jsoncpp 处理数据格式。
<code>find_package(OpenSSL REQUIRED)</code> 指令在系统中查找 OpenSSL 库的头文件与二进制文件。若未安装，CMake 配置阶段将直接报错阻断。</p>
<pre><code class="hljs language-cmake" lang="cmake"># 设置Cmake的最小版本为3.10

cmake_minimum_required(VERSION 3.10)

  

# 设置项目名称为testLLM

project(testLLM)

  

#设置C++标准为C++17

set(CMAKE_CXX_STANDARD 17)

set(CMAKE_CXX_STANDARD_REQUIRED ON) #不支持就报错

  

#设置构建类型

set(CMAKE_BUILD_TYPE Debug)

  

#添加可执行文件

#添加可执行文件

add_executable(testLLM testKKLLM.cpp

../SDK/src/DeepSeekProvider.cpp

../SDK/src/util/myLog.cpp)

  

#设置输出目录

set(ExECUTABLE_OUTPUT_PATH ${CMAKE_SOURCE_DIR})

  

#添加头文件

include_directories(${CMAKE_PROJECT_INCLUDE_DIR}/ ../sdk/include)

  

find_package(OpenSSL REQUIRED)#找这个库，没找到就报错

include_directories(${OPENSSL_INCLUDE_DIR})

#添加CPPHTTPLIB_OPENSSL_SUPPORT宏定义

target_compile_definitions(testLLM PRIVATE CPPHTTPLIB_OPENSSL_SUPPORT)

#链接库

target_link_libraries(testLLM  spdlog gtest jsoncpp fmt OpenSSL::Crypto OpenSSL::SSL)
</code></pre>
<h3 data-id="heading-14">2. 编译目标与链接</h3>
<p><code>add_executable</code> 指令将源文件 <code>DeepSeekProvider.cpp</code>、<code>myLog.cpp</code> 和测试文件 <code>testKKLLM.cpp</code> 编译为可执行文件 <code>testLLM</code>。
<code>target_link_libraries</code> 将具体的第三方库链接至目标文件。特别注意 <code>OpenSSL::Crypto</code> 和 <code>OpenSSL::SSL</code> 的显式链接，这是实现安全套接层通信的基础。</p>
<p>项目目录结构清晰，遵循了 <code>include</code> (头文件) 与 <code>src</code> (源文件) 分离的标准布局，有利于大型项目的模块化管理。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/edbfb460e651481093ee752fc3f7ccb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197251&amp;x-signature=PKsn5QIfFyzk7bcjRDk2du1m5pU%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-15">七、 编译与调试过程</h2>
<p>在 <code>build</code> 目录下执行 <code>cmake ..</code>，CMake 读取上一级目录的配置，生成 Makefile。此步骤成功意味着环境依赖和路径配置均无误。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7b775e2c9a041019861377bae9282a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197251&amp;x-signature=ABiA0JitMbDyf4X4tguTWEsMWh0%3D" alt="image.png" loading="lazy"/></p>
<p>生成的构建工件包括 Makefile、CMakeCache.txt 等，实现了“外部构建”（Out-of-source build），保持源码目录整洁。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57baaa9d7f7640a0be85a42e70c3a3ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197251&amp;x-signature=suZ6b7gMKrik9rpp84UKsWjqmiE%3D" alt="image.png" loading="lazy"/></p>
<p>执行 <code>make</code> 命令触发实际编译。在初次尝试中，可能会遇到链接错误或头文件缺失，这通常表现为大量的编译器输出信息。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4afab90cb72443e589c477a232885d03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197251&amp;x-signature=wCQZWXJ7Cy6cl3vMfXDAoyd1WLw%3D" alt="image.png" loading="lazy"/></p>
<p>上图反映了典型的编译期错误。解决此类问题通常需要检查：</p>
<ol>
<li>头文件路径是否通过 <code>include_directories</code> 正确包含。</li>
<li>命名空间是否匹配。</li>
<li>虚函数是否完全实现。</li>
<li>链接库顺序是否正确。</li>
</ol>
<p>经过调试修正后，再次编译通过。运行 <code>./testLLM</code> 执行测试程序。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06e70facd8b14fb6a09ac4aa87117dc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg54ix5aaC5L2V6YeK5oCA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197251&amp;x-signature=gbAB6YXkzGeVlMhBI843fBtDjM4%3D" alt="image.png" loading="lazy"/></p>
<p>控制台输出显示的绿色 <code>[ PASSED ]</code> 标志表明测试用例执行成功。日志中记录了初始化过程和测试值的输出，验证了 <code>DeepSeekProvider</code> 已正确加载配置，并且能够通过 HTTP 协议与云端 API 建立连接，完成了一次模拟的消息发送流程。</p>
<p>综上所述，构建一个生产级的C++ LLM SDK需要跨越网络协议、内存管理、设计模式与自动化测试等多个技术领域。通过严谨的架构设计与详尽的测试验证，能够确保SDK在复杂的生产环境中稳定运行。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SystemUI 开发之四张图看懂NotificationStackScrollLayout工作机制（九）]]></title>    <link>https://juejin.cn/post/7600224355294019611</link>    <guid>https://juejin.cn/post/7600224355294019611</guid>    <pubDate>2026-01-28T09:55:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600224355294019611" data-draft-id="7600242248860893224" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SystemUI 开发之四张图看懂NotificationStackScrollLayout工作机制（九）"/> <meta itemprop="keywords" content="Android,架构,Kotlin"/> <meta itemprop="datePublished" content="2026-01-28T09:55:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="愤怒的代码"/> <meta itemprop="url" content="https://juejin.cn/user/4125023358426190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SystemUI 开发之四张图看懂NotificationStackScrollLayout工作机制（九）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4125023358426190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    愤怒的代码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T09:55:50.000Z" title="Wed Jan 28 2026 09:55:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">0x00. 核心组件</h2>
<h3 data-id="heading-1">1、组件职责</h3>
<ul>
<li><strong>NotificationStackScrollLayout</strong>: 主控制器，协调所有组件</li>
<li><strong>AmbientState</strong>: 状态中心，存储和提供当前的环境状态</li>
<li><strong>StackScrollAlgorithm</strong>: 计算引擎，根据状态计算布局</li>
<li><strong>StackStateAnimator</strong>: 动画执行器，让状态变化平滑过渡</li>
<li><strong>ExpandableViewState</strong>: 视图状态(<code>ViewState</code>)，存储了通知在某一时刻应该具备的所有状态</li>
</ul>
<h3 data-id="heading-2">2、通知容器</h3>
<p><code>NotificationStackScrollLayout（NSSL）</code> 是控制器，负责协调所有组件的工作。例如接收到各种系统事件（如滑动、状态切换），并将这些数据填充进 <code>AmbientState</code> ，并调用计算引擎 <code>StackScrollAlgorithm</code> 为每一条通知计算出对应的 <code>ExpandableViewState</code> 坐标。</p>
<h3 data-id="heading-3">3、 <code>AmbientState</code> 与 <code>ExpandableViewState</code></h3>
<ul>
<li><code>AmbientState</code><strong>（输入）：</strong> 它是一个单例对象（在 NSSL 生命周期内），记录了当前屏幕的<strong>宏观状态</strong>。比如：用户滚到了哪里？QS（快捷设置）拉下来了多少？现在是不是在 AOD（息屏显示）模式？哪些通知正在被拖拽？</li>
<li><code>ExpandableViewState</code><strong>（输出）：</strong> 每一条通知（<code>ExpandableNotificationRow</code>）都有一个属于自己的 <code>ViewState</code>。它描述了**微观属性，**是每个通知 <code>ExpandableNotificationRow</code> 的目标状态。比如：这行通知应该在 Y 轴什么位置？它的透明度是多少？它的高度现在该是多少？</li>
</ul>
<h3 data-id="heading-4">4、计算引擎</h3>
<ul>
<li><code>StackScrollAlgorithm.resetViewStates(AmbientState)</code> 是计算的入口方法，它的输入参数就是<code>AmbientState</code> ，计算结果输出到每条通知<code>ExpandableNotificationRow</code>对应的<code>ExpandableViewState</code> 对象中</li>
</ul>
<h3 data-id="heading-5">5、动画执行</h3>
<p><strong>StackStateAnimator</strong> 会遍历这些 <code>ExpandableViewState</code>。它不仅知道<strong>目标值</strong>是多少，还知道 View <strong>当前值</strong>是多少。如果两者不一致，它就会启动属性动画（Property Animator），让 View 动起来。</p>
<h2 data-id="heading-6"><strong>0x01. 组件关系图</strong></h2>
<p>展示整体架构和组件间的持有关系</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "NotificationStackScrollLayout 通知堆栈滚动布局"
        NSSL[NotificationStackScrollLayout&lt;br/&gt;主容器ViewGroup]

        subgraph "子View管理"
            Children[ExpandableNotificationRow&lt;br/&gt;通知行]
            Shelf[NotificationShelf&lt;br/&gt;底部架子]
            Footer[FooterView&lt;br/&gt;底部视图]
            Empty[EmptyShadeView&lt;br/&gt;空白视图]
        end

        subgraph "核心组件"
            AS[AmbientState&lt;br/&gt;环境状态管理器]
            SSA[StackScrollAlgorithm&lt;br/&gt;布局算法引擎]
            StateAnimator[StackStateAnimator&lt;br/&gt;状态动画执行器]
        end

        subgraph "辅助组件"
            SwipeHelper[NotificationSwipeHelper&lt;br/&gt;滑动处理]
            ExpandHelper[ExpandHelper&lt;br/&gt;展开手势]
            RoundnessManager[NotificationRoundnessManager&lt;br/&gt;圆角管理]
            SectionsManager[NotificationSectionsManager&lt;br/&gt;分组管理]
        end
    end

    %% NSSL 持有核心组件
    NSSL --&gt;|持有实例| AS
    NSSL --&gt;|持有实例| SSA
    NSSL --&gt;|持有实例| StateAnimator

    %% NSSL 持有辅助组件
    NSSL --&gt;|持有实例| SwipeHelper
    NSSL --&gt;|持有实例| ExpandHelper
    NSSL --&gt;|持有实例| RoundnessManager
    NSSL --&gt;|持有实例| SectionsManager

    %% NSSL 管理子View
    NSSL --&gt;|addView/removeView| Children
    NSSL --&gt;|管理| Shelf
    NSSL --&gt;|管理| Footer
    NSSL --&gt;|管理| Empty

    %% AmbientState 的作用
    AS --&gt;|提供状态给| SSA
    AS --&gt;|提供状态给| StateAnimator
    AS --&gt;|提供状态给| Shelf

    %% 数据流向
    NSSL --&gt;|1.更新状态| AS
    SSA --&gt;|2.读取状态| AS
    SSA --&gt;|3.计算ViewState| Children
    Children --&gt;|4.存储状态| ViewState[ExpandableViewState]
    StateAnimator --&gt;|5.执行动画| ViewState
    ViewState --&gt;|6.应用到| Children

    style NSSL fill:#e1f5ff
    style AS fill:#fff4e1
    style SSA fill:#e8f5e8
    style StateAnimator fill:#ffe8f5

</code></pre>
<h2 data-id="heading-7"><strong>0x02. 时序图</strong></h2>
<p>展示完整的布局更新流程中各组件的交互顺序</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant NSSL as NotificationStackScrollLayout
    participant AS as AmbientState
    participant SSA as StackScrollAlgorithm
    participant Animator as StackStateAnimator
    participant Row as ExpandableNotificationRow
    participant VS as ExpandableViewState

    Note over NSSL: 用户操作触发(滚动/添加/展开等)

    NSSL-&gt;&gt;NSSL: requestChildrenUpdate()
    activate NSSL

    NSSL-&gt;&gt;NSSL: 注册 OnPreDrawListener

    Note over NSSL: 等待下一帧 PreDraw

    NSSL-&gt;&gt;NSSL: onPreDraw() → updateChildren()

    NSSL-&gt;&gt;AS: 更新状态&lt;br/&gt;setScrollY/setExpandFraction/etc
    activate AS
    AS--&gt;&gt;NSSL: 状态已更新
    deactivate AS

    NSSL-&gt;&gt;SSA: resetViewStates(mAmbientState)
    activate SSA

    SSA-&gt;&gt;AS: 读取环境状态&lt;br/&gt;getScrollY/getStackTranslation/etc
    activate AS
    AS--&gt;&gt;SSA: 返回状态值
    deactivate AS

    loop 遍历每个子View
        SSA-&gt;&gt;Row: 获取 ViewState
        Row--&gt;&gt;SSA: 返回 ExpandableViewState

        SSA-&gt;&gt;SSA: 计算位置、高度、透明度等

        SSA-&gt;&gt;VS: 更新 ViewState&lt;br/&gt;yTranslation/alpha/height/etc
    end

    SSA--&gt;&gt;NSSL: 所有 ViewState 已计算
    deactivate SSA

    alt 需要动画
        NSSL-&gt;&gt;NSSL: startAnimationToState()

        NSSL-&gt;&gt;NSSL: generateAllAnimationEvents()
        Note over NSSL: 生成动画事件列表

        NSSL-&gt;&gt;Animator: startAnimationForEvents(events)
        activate Animator

        loop 每个动画事件
            Animator-&gt;&gt;VS: 读取目标状态
            Animator-&gt;&gt;Animator: 创建属性动画
            Animator-&gt;&gt;Row: 应用动画&lt;br/&gt;setTranslationY/setAlpha/etc
        end

        Note over Animator: 动画执行中...

        Animator--&gt;&gt;NSSL: onAnimationFinished()
        deactivate Animator

    else 不需要动画
        NSSL-&gt;&gt;NSSL: applyCurrentState()

        loop 遍历每个子View
            NSSL-&gt;&gt;Row: applyViewState()
            Row-&gt;&gt;VS: 读取状态
            Row-&gt;&gt;Row: 直接设置属性&lt;br/&gt;setTranslationY/setAlpha/etc
        end
    end

    NSSL-&gt;&gt;NSSL: updateBackground()&lt;br/&gt;updateViewShadows()

    deactivate NSSL

    Note over NSSL,Row: 布局更新完成,等待下一次更新

</code></pre>
<h2 data-id="heading-8"><strong>0x02. 类图</strong></h2>
<p>展示各类的属性、方法以及类之间的依赖/组合/关联关系</p>
<pre><code class="hljs language-mermaid" lang="mermaid">classDiagram
    class NotificationStackScrollLayout {
        -AmbientState mAmbientState
        -StackScrollAlgorithm mStackScrollAlgorithm
        -StackStateAnimator mStateAnimator
        -int mOwnScrollY
        -boolean mNeedsAnimation
        -ArrayList~AnimationEvent~ mAnimationEvents

        +addContainerView(View v)
        +requestChildrenUpdate()
        -updateChildren()
        -startAnimationToState()
        -applyCurrentState()
        +onHeightChanged(ExpandableView view)
        +setOwnScrollY(int y)
    }

    class AmbientState {
        -int mScrollY
        -float mStackTranslation
        -boolean mDimmed
        -boolean mHideSensitive
        -float mOverScrollTopAmount
        -float mOverScrollBottomAmount
        -ExpandableView mActivatedChild
        -int mLayoutHeight
        -int mLayoutMinHeight
        -NotificationShelf mShelf

        +getScrollY() int
        +setScrollY(int y)
        +getStackTranslation() float
        +setStackTranslation(float translation)
        +isDimmed() boolean
        +setDimmed(boolean dimmed)
        +getLayoutHeight() int
    }

    class StackScrollAlgorithm {
        -StackScrollAlgorithmState mTempAlgorithmState
        -boolean mIsExpanded

        +resetViewStates(AmbientState ambientState)
        +getStackScrollState(AmbientState ambientState, StackScrollAlgorithmState algorithmState)
        -updatePositionsForState(StackScrollAlgorithmState algorithmState, AmbientState ambientState)
        -clampPositionToShelf(ExpandableViewState childViewState, NotificationShelf shelf)
        +getGapHeightForChild(...) float
        -computeCornerRoundnessForPinnedHun(...)
    }

    class StackStateAnimator {
        -NotificationStackScrollLayout mHostLayout
        -ArrayList~AnimationProperties~ mAnimationProperties
        -AnimationFilter mAnimationFilter
        -boolean mAnimationRunning

        +startAnimationForEvents(ArrayList~AnimationEvent~ events, long delay)
        -processAnimationEvents(ArrayList~AnimationEvent~ events)
        -startStackAnimations(...)
        -startViewAnimations(...)
        +animateOverScrollToAmount(float amount, boolean onTop)
        -onAnimationFinished()
    }

    class ExpandableNotificationRow {
        -ExpandableViewState mViewState
        -NotificationEntry mEntry
        -boolean mUserExpanded
        -int mActualHeight

        +getViewState() ExpandableViewState
        +applyViewState()
        +setUserExpanded(boolean expanded)
        +getActualHeight() int
        +setActualHeight(int height)
    }

    class ExpandableViewState {
        +float yTranslation
        +float zTranslation
        +float alpha
        +int height
        +boolean dimmed
        +boolean hideSensitive
        +boolean inShelf
        +float scale

        +applyToView(View view)
        +animateTo(View child, AnimationProperties properties)
        +copyFrom(ExpandableViewState viewState)
    }

    class AnimationEvent {
        +ExpandableView mChangingView
        +int animationType
        +AnimationFilter filter
        +long length
        +View viewAfterChangingView

        +combineLength(ArrayList~AnimationEvent~ events) long
    }

    class AnimationFilter {
        +boolean animateAlpha
        +boolean animateY
        +boolean animateZ
        +boolean animateHeight
        +boolean animateDimmed
        +boolean hasDelays

        +combineFilter(AnimationFilter filter)
        +applyCombination(AnimationFilter filter)
    }

    %% 组合关系
    NotificationStackScrollLayout *-- AmbientState : 持有
    NotificationStackScrollLayout *-- StackScrollAlgorithm : 持有
    NotificationStackScrollLayout *-- StackStateAnimator : 持有
    NotificationStackScrollLayout o-- ExpandableNotificationRow : 管理多个

    %% 依赖关系
    StackScrollAlgorithm ..&gt; AmbientState : 读取状态
    StackScrollAlgorithm ..&gt; ExpandableViewState : 计算并更新
    StackStateAnimator ..&gt; AnimationEvent : 处理
    StackStateAnimator ..&gt; ExpandableViewState : 动画到目标状态
    StackStateAnimator ..&gt; AnimationFilter : 使用

    %% 关联关系
    ExpandableNotificationRow --&gt; ExpandableViewState : 持有
    AnimationEvent --&gt; ExpandableNotificationRow : 引用
    AnimationEvent --&gt; AnimationFilter : 持有

    %% 继承关系
    ExpandableNotificationRow --|&gt; ExpandableView : 继承

</code></pre>
<h2 data-id="heading-9"><strong>0x04. 流程图</strong></h2>
<p>展示从用户操作到最终渲染的完整数据流</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    Start([用户操作&lt;br/&gt;滚动/添加/展开通知]) --&gt; Request[NSSL.requestChildrenUpdate]

    Request --&gt; CheckFlag{mChildrenUpdateRequested?}
    CheckFlag --&gt;|false| Register[注册 OnPreDrawListener]
    CheckFlag --&gt;|true| End1([已注册,等待执行])

    Register --&gt; SetFlag[mChildrenUpdateRequested = true]
    SetFlag --&gt; Invalidate[invalidate 触发重绘]

    Invalidate --&gt; PreDraw[下一帧: OnPreDraw]

    PreDraw --&gt; UpdateChildren[updateChildren]

    UpdateChildren --&gt; UpdateScroll[updateScrollStateForAddedChildren&lt;br/&gt;处理新添加View的滚动]

    UpdateScroll --&gt; SetAmbient[更新 AmbientState&lt;br/&gt;- setScrollY&lt;br/&gt;- setCurrentScrollVelocity&lt;br/&gt;- setAnchorViewIndex等]

    SetAmbient --&gt; CallAlgo[调用 StackScrollAlgorithm&lt;br/&gt;resetViewStates]

    CallAlgo --&gt; AlgoRead[算法读取 AmbientState&lt;br/&gt;- getScrollY&lt;br/&gt;- getStackTranslation&lt;br/&gt;- getLayoutHeight等]

    AlgoRead --&gt; AlgoCalc[遍历子View计算&lt;br/&gt;- yTranslation位置&lt;br/&gt;- alpha透明度&lt;br/&gt;- height高度&lt;br/&gt;- zTranslation深度&lt;br/&gt;- dimmed/scale等]

    AlgoCalc --&gt; AlgoWrite[更新各子View的&lt;br/&gt;ExpandableViewState]

    AlgoWrite --&gt; CheckAnim{需要动画?&lt;br/&gt;mNeedsAnimation}

    CheckAnim --&gt;|true| GenEvents[生成动画事件&lt;br/&gt;generateAllAnimationEvents]
    CheckAnim --&gt;|false| ApplyDirect[直接应用状态&lt;br/&gt;applyCurrentState]

    GenEvents --&gt; StartAnim[StackStateAnimator&lt;br/&gt;startAnimationForEvents]

    StartAnim --&gt; ProcessEvents[处理动画事件&lt;br/&gt;- ANIMATION_TYPE_ADD&lt;br/&gt;- ANIMATION_TYPE_REMOVE&lt;br/&gt;- ANIMATION_TYPE_CHANGE_POSITION等]

    ProcessEvents --&gt; CreateAnim[创建属性动画&lt;br/&gt;ObjectAnimator]

    CreateAnim --&gt; RunAnim[执行动画&lt;br/&gt;改变View属性]

    RunAnim --&gt; AnimEnd[动画结束回调&lt;br/&gt;onAnimationFinished]

    ApplyDirect --&gt; Loop1[遍历所有子View]
    Loop1 --&gt; ApplyState[调用 child.applyViewState&lt;br/&gt;直接设置属性]

    AnimEnd --&gt; UpdateBg[updateBackground&lt;br/&gt;更新背景]
    ApplyState --&gt; UpdateBg

    UpdateBg --&gt; UpdateShadow[updateViewShadows&lt;br/&gt;更新阴影]

    UpdateShadow --&gt; UpdateClip[updateClippingToTopRoundedCorner&lt;br/&gt;更新圆角裁剪]

    UpdateClip --&gt; ClearFlag[mChildrenUpdateRequested = false&lt;br/&gt;mNeedsAnimation = false]

    ClearFlag --&gt; End2([更新完成])

    style Start fill:#e1f5ff
    style AmbientState fill:#fff4e1
    style CallAlgo fill:#e8f5e8
    style StartAnim fill:#ffe8f5
    style End2 fill:#e1ffe1

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot+Uniapp实战开发全新仿抖音短视频App【2022升级版】]]></title>    <link>https://juejin.cn/post/7600224355293790235</link>    <guid>https://juejin.cn/post/7600224355293790235</guid>    <pubDate>2026-01-28T09:33:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600224355293790235" data-draft-id="7600068892988473354" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot+Uniapp实战开发全新仿抖音短视频App【2022升级版】"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-28T09:33:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户88107983630"/> <meta itemprop="url" content="https://juejin.cn/user/3528777754748185"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot+Uniapp实战开发全新仿抖音短视频App【2022升级版】
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3528777754748185/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户88107983630
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T09:33:00.000Z" title="Wed Jan 28 2026 09:33:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、 项目架构与技术选型</h2>
<p>在开始之前，我们要明确这个项目的核心逻辑：<strong>移动端负责展示与交互，后端负责内容分发与业务逻辑</strong>。<strong>学习地址：pan.baidu.com/s/1WwerIZ_elz_FyPKqXAiZCA?pwd=waug</strong></p>
<ul>
<li>
<p><strong>后端：SpringBoot + MyBatis-Plus + Redis + MinIO（对象存储）</strong></p>
<ul>
<li><em>理由</em>：SpringBoot 生态成熟，处理高并发请求（如视频流、点赞）稳定；Redis 用于缓存热门视频和做分布式锁；MinIO 自建私有云存储，比 OSS 成本更低，适合副业项目起步。</li>
</ul>
</li>
<li>
<p><strong>前端：Uniapp (Vue3) + TypeScript</strong></p>
<ul>
<li><em>理由</em>：一套代码，多端发布（iOS、Android、H5、小程序），性价比极高。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-1">二、 后端核心实现</h2>
<h3 data-id="heading-2">1. 数据库设计</h3>
<p>我们需要核心的几张表：视频表、用户表、点赞表。</p>
<p>sql</p>
<p>复制</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `tb_video` (
  `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,
  `user_id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'发布者ID'</span>,
  `video_url` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'视频地址'</span>,
  `cover_url` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'封面地址'</span>,
  `title` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'视频标题'</span>,
  `like_count` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'0'</span> COMMENT <span class="hljs-string">'点赞数'</span>,
  `is_deleted` tinyint(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'0'</span>,
  `create_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4;
</code></pre>
<h3 data-id="heading-3">2. 视频流接口（核心 Feed 流）</h3>
<p>仿抖音的核心是“滑动刷新”，我们需要一个高效的分页查询接口。这里使用 MyBatis-Plus 简化开发。</p>
<p><strong>Entity 实体类 (<code>Video.java</code>):</strong></p>
<p>java</p>
<p>复制</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@TableName(<span class="hljs-string">"tb_video"</span>)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Video</span> {
    <span class="hljs-meta">@TableId(type = IdType.AUTO)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">Long</span> id;
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">Long</span> userId;
    <span class="hljs-keyword">private</span> String videoUrl;
    <span class="hljs-keyword">private</span> String coverUrl;
    <span class="hljs-keyword">private</span> String title;
    <span class="hljs-keyword">private</span> Integer likeCount;
    <span class="hljs-comment">// getter/setter 省略，使用 Lombok @Data</span>
}
</code></pre>
<p><strong>Service 业务层 (<code>VideoService.java</code>):</strong><br/>
这里演示基础的分页查询。在生产环境中，通常结合 Redis 做推荐算法（如基于权重的 Feed 流）。</p>
<p>java</p>
<p>复制</p>
<pre><code class="hljs language-arduino" lang="arduino">@Service
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VideoService</span> {

    @Autowired
    <span class="hljs-keyword">private</span> VideoMapper videoMapper;

    <span class="hljs-comment">/**
     * 分页获取视频列表（仿抖音首页Feed流）
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> IPage&lt;Video&gt; <span class="hljs-title">getVideoFeed</span><span class="hljs-params">(<span class="hljs-type">long</span> current, <span class="hljs-type">long</span> size)</span> </span>{
        Page&lt;Video&gt; page = <span class="hljs-keyword">new</span> Page&lt;&gt;(current, size);
        <span class="hljs-comment">// 按照创建时间倒序排列</span>
        QueryWrapper&lt;Video&gt; queryWrapper = <span class="hljs-keyword">new</span> QueryWrapper&lt;&gt;();
        queryWrapper.<span class="hljs-built_in">orderByDesc</span>(<span class="hljs-string">"create_time"</span>);
        <span class="hljs-keyword">return</span> videoMapper.<span class="hljs-built_in">selectPage</span>(page, queryWrapper);
    }
}
</code></pre>
<p><strong>Controller 控制层 (<code>VideoController.java</code>):</strong></p>
<p>java</p>
<p>复制</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@RestController</span>
<span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">"/api/video"</span>)
public class VideoController {

    <span class="hljs-variable">@Autowired</span>
    private VideoService videoService;

    <span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">"/feed"</span>)
    public Result <span class="hljs-built_in">getFeed</span>(<span class="hljs-variable">@RequestParam</span>(defaultValue = <span class="hljs-string">"1"</span>) long current,
                          <span class="hljs-variable">@RequestParam</span>(defaultValue = <span class="hljs-string">"5"</span>) long size) {
        <span class="hljs-selector-tag">IPage</span>&lt;<span class="hljs-selector-tag">Video</span>&gt; <span class="hljs-selector-tag">videoPage</span> = <span class="hljs-selector-tag">videoService</span><span class="hljs-selector-class">.getVideoFeed</span>(current, size);
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Result</span><span class="hljs-selector-class">.success</span>(videoPage);
    }
}
</code></pre>
<h3 data-id="heading-4">3. 文件上传接口 (MinIO)</h3>
<p>视频上传是短视频应用最消耗资源的部分。</p>
<p>java</p>
<p>复制</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">"/upload"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-title class_">Result</span> <span class="hljs-title function_">uploadVideo</span>(<span class="hljs-params">MultipartFile file</span>) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 1. 生成唯一文件名</span>
        <span class="hljs-title class_">String</span> fileName = <span class="hljs-variable constant_">UUID</span>.<span class="hljs-title function_">randomUUID</span>().<span class="hljs-title function_">toString</span>() + <span class="hljs-string">".mp4"</span>;
        <span class="hljs-comment">// 2. 调用 MinIO 工具类上传（需自行配置 MinIOClient）</span>
        <span class="hljs-title class_">String</span> url = <span class="hljs-title class_">MinIOUtil</span>.<span class="hljs-title function_">upload</span>(file.<span class="hljs-title function_">getInputStream</span>(), fileName);
        <span class="hljs-comment">// 3. 返回访问地址</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Result</span>.<span class="hljs-title function_">success</span>(url);
    } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
        e.<span class="hljs-title function_">printStackTrace</span>();
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Result</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"上传失败"</span>);
    }
}
</code></pre>
<h2 data-id="heading-5">三、 前端核心实现</h2>
<h3 data-id="heading-6">1. 视频滑页组件</h3>
<p>这是仿抖音的灵魂，使用 <code>swiper</code> 组件实现垂直滑动。</p>
<h2 data-id="heading-7">四、 避坑指南与上线优化</h2>
<p>结合项目经验，这里有几个关键点需要注意：</p>
<ol>
<li><strong>视频加载优化</strong>：不要一次性加载所有视频，使用“预加载”机制。在用户滑动到 <code>index+1</code> 时，在后台静默加载下一个视频资源。</li>
<li><strong>视频格式转码</strong>：用户上传的视频格式五花八门，后端必须使用 FFmpeg 进行统一转码（转为 H.264 编码的 MP4），否则在 Android 和 iOS 上会出现兼容性问题。</li>
<li><strong>CDN 加速</strong>：如果你想真正做到“可上线”，视频资源必须走 CDN。MinIO 只是存储，必须结合 CDN 回源配置，否则用户播放会卡顿。</li>
<li><strong>Uniapp 原生插件</strong>：对于视频的高级特效（滤镜、贴纸），Uniapp 默认的 <code>&lt;video&gt;</code> 标签能力有限，可能需要购买或引入原生插件（如 DCloud 市场的短视频 SDK）。</li>
</ol>
<p>这套方案跑通后，你不仅拥有了一个可演示的 App，更掌握了一条完整的“短视频后端+跨端前端”技术链。对于做副业来说，这既可以作为外包项目的案例，也可以作为你自己打造独立产品的起点。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[90% 的人读不懂 Vue 源码，是因为没做这些准备]]></title>    <link>https://juejin.cn/post/7600002531398778889</link>    <guid>https://juejin.cn/post/7600002531398778889</guid>    <pubDate>2026-01-28T09:40:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600002531398778889" data-draft-id="7600060708933009418" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="90% 的人读不懂 Vue 源码，是因为没做这些准备"/> <meta itemprop="keywords" content="Vue.js,源码"/> <meta itemprop="datePublished" content="2026-01-28T09:40:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨色"/> <meta itemprop="url" content="https://juejin.cn/user/2436173500528103"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            90% 的人读不懂 Vue 源码，是因为没做这些准备
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2436173500528103/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨色
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T09:40:46.000Z" title="Wed Jan 28 2026 09:40:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>相信很多人阅读源码都是从响应式开始看起的，clone vue源码之后，查看reactivity下的reactive.ts模块，一行行阅读；十分钟后，合上编辑器，心里只剩下一个问题：<strong>“是我太菜，还是源码本来就看不懂？”</strong></p>
<p>事实是——<strong>绝大多数人不是看不懂源码，而是用错了方式。</strong></p>
<p>源码不是文档，它不是按“教学顺序”写的，而是按<strong>工程、性能和长期维护</strong>来组织的。如果你在<strong>不了解项目结构、不知道入口、不具备调试手段</strong>的情况下直接硬读，很容易陷入“每一行都认识，但整体完全不懂”的状态。</p>
<p>这也是为什么：<br/>
<strong>90% 的人读不懂 Vue 源码，并不是能力问题，而是没做阅读前的准备。</strong></p>
<h2 data-id="heading-1">为什么要读源码</h2>
<p>在阅读源码前，我们一定要问自己：<strong>为什么阅读源码？</strong> <strong>自己希望从源码中得知什么？</strong></p>
<p>如今源码阅读已成潮流，其中不乏培训机构的过度鼓吹，制造 “<strong>不懂源码就找不到工作</strong>” 的焦虑，让很多人盲目卷入内卷。但回归现实，多数面试并不会深究源码细节，核心还是考察 Vue 的设计思想与核心原理。如果单纯为了应试，针对性梳理高频面试题、核心知识点，远比通读源码简单高效、性价比更高。</p>
<p>而如果是出于对技术的兴趣，想要揭开 Vue 内部的运行原理，学习框架中精妙的设计思路、架构模式与工程化实践，或是为了解决开发中难以定位的疑难问题、完成框架的二次封装与定制开发，深入研读源码就非常有必要。这能帮我们跳出 “只会使用框架” 的层面，真正理解底层逻辑，大幅提升架构思维与问题解决能力。</p>
<h2 data-id="heading-2">源码不是让你“一行行啃”，而是让你“顺着主线走”</h2>
<p>很多人一提到“读源码”，脑海里就会自动等同成：<br/>
<strong>从第一行看到最后一行，一行都不能漏。</strong></p>
<p>但这恰恰是读源码最容易走偏的地方。</p>
<p>以 Vue 为例，源码中充满了大量的：</p>
<ul>
<li>边界判断（<code>if (__DEV__)</code>、<code>if (!isObject)</code>）</li>
<li>兼容处理</li>
<li>性能优化分支</li>
<li>为极端场景准备的兜底逻辑</li>
</ul>
<p>这些代码<strong>本身没有错</strong>，但如果一开始就死磕每一个分支，只会让你迅速迷失在细节里。</p>
<ul>
<li>
<h3 data-id="heading-3">真正高效的源码阅读方式：抓住「核心主线」</h3>
</li>
</ul>
<p>读源码时，更重要的不是“这一行在干嘛”，<br/>
而是先回答清楚这三个问题：</p>
<ol>
<li><strong>这个模块的核心职责是什么？</strong></li>
<li><strong>主流程是如何从入口一路走到出口的？</strong></li>
<li><strong>中途哪些是核心逻辑，哪些是边界保护？</strong></li>
</ol>
<p>比如在 Vue 响应式系统中：</p>
<ul>
<li>
<p><strong>主线只有一条</strong>：</p>
<blockquote>
<p>访问数据 → 依赖收集 → 数据变化 → 触发更新</p>
</blockquote>
</li>
</ul>
<p>只要你能顺着这条主线走通：</p>
<ul>
<li><code>track</code> 什么时候执行</li>
<li><code>trigger</code> 如何通知订阅者</li>
<li>effect / computed 是如何被调度的</li>
</ul>
<p>那些零散的判断条件，其实都是围绕主线展开的“护栏”。</p>
<ul>
<li>
<h3 data-id="heading-4">边界判断不是现在的重点</h3>
</li>
</ul>
<p>这并不意味着边界判断不重要，而是：</p>
<blockquote>
<p><strong>它们更适合在你第二次、第三次读源码时再深入。</strong></p>
</blockquote>
<p>第一次读源码，你的目标应该是：</p>
<ul>
<li>建立整体执行流程的<strong>心智模型</strong></li>
<li>知道“这一坨代码大概负责什么”</li>
<li>能把关键函数串成一条完整链路</li>
</ul>
<p>当你已经清楚主线之后，再回头看这些判断：</p>
<ul>
<li>
<p>你会知道<strong>为什么要加</strong></p>
</li>
<li>
<p>也能理解<strong>为什么要写得这么绕</strong></p>
</li>
<li>
<p>甚至能体会到框架作者在做取舍时的无奈</p>
</li>
<li>
<h3 data-id="heading-5">用调试而不是“意念”来跟主线</h3>
</li>
</ul>
<p>抓主线还有一个非常重要的前提：<br/>
<strong>不要靠猜，而是让代码跑起来。</strong></p>
<p>通过 SourceMap + 断点：</p>
<ul>
<li>从入口函数开始打断点</li>
<li>顺着调用栈一路向下</li>
<li>只跟踪你当前关心的那条路径</li>
</ul>
<p>你会发现：</p>
<ul>
<li>80% 的代码你暂时根本不用看</li>
<li>真正影响理解的，往往只有那 20% 的核心逻辑</li>
</ul>
<h2 data-id="heading-6">开启sourceMap</h2>
<p>接下来让我们揭开Vue的神秘面纱 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvuejs%2Fcore" target="_blank" title="https://github.com/vuejs/core" ref="nofollow noopener noreferrer">Vue3源码地址</a>， 推荐大家fork项目到自己仓库阅读</p>
<p>Vue 的源码并不是一堆散乱的文件，而是一个 <strong>Monorepo 工程</strong>，核心逻辑被清晰地拆分在 <code>packages</code> 目录，我们在vue源码的文档中，可以看到详细的介绍<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvuejs%2Fcore%2Fblob%2Fmain%2F.github%2Fcontributing.md" target="_blank" title="https://github.com/vuejs/core/blob/main/.github/contributing.md" ref="nofollow noopener noreferrer">github.com/vuejs/core/…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d858f7c589c643a2a828772d18d1c1e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6Imy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770198046&amp;x-signature=eDrOFAWUetc5eFQDYaAwU9uTtbA%3D" alt="image.png" loading="lazy"/></p>
<p>运行<code>pnpm install</code>安装相关依赖</p>
<p>vue源码项目采用的是<code>rollup</code>进行打包的，我们可以查看<code>package.json</code>打包命令， "build": <code>"build": "node scripts/build.js"</code>, 运行<code>pnpm build</code>生成 <code>dist</code> 打包文件</p>
<p>我们在<code>packages/vue/examples</code>下创建自己的demo文件夹，比如说之后我想看响应式相关源码，可以创建类似的demo文件 <code>packages/vue/examples/demo/reactive/index.html</code></p>
<pre><code class="hljs language-js" lang="js">&lt;!<span class="hljs-variable constant_">DOCTYPE</span> html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
    &lt;title&gt;Vue Effect Test&lt;/title&gt;

    &lt;!-- 引入你本地 clone 的 vue.global.js --&gt;
    &lt;script src="../../../../vue/dist/vue.global.js"&gt;&lt;/script&gt;
&lt;/head&gt;

&lt;body&gt;
    &lt;div id="text"&gt;&lt;/div&gt;
    &lt;div id="text1"&gt;&lt;/div&gt;
    &lt;button id="btn"&gt;count1++&lt;/button&gt;
    &lt;button id="btn2"&gt;count2++&lt;/button&gt; 

    &lt;script&gt;
        const { reactive, ref, effect } = Vue;

        // 创建响应式数据
        const state = reactive({
            count1: 1,
            count2: 10
        });

        // 绑定 effect：依赖收集 + 自动更新
        effect(() =&gt; {
            document.getElementById('text').innerText =
                `当前 count 值：${state.count1 + state.count2}`;
        });

        effect(() =&gt; {
            document.getElementById('text1').innerText =
                `当前 count 值：${state.count1 + state.count2 + 100}`;
        });


        // 事件：修改数据触发 effect 自动执行
        document.getElementById('btn').onclick = () =&gt; {
            state.count1++;
            state.count2++;
        };
        document.getElementById('btn2').onclick = () =&gt; {
            state.count1 = state.count1 + 5;
            state.count2 = state.count2 + 5
        };
    &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;

</code></pre>
<p>然后通过<code>liveServer</code>打开<code>index.html</code>（需要安装live server插件）
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/406408d42890448c9b6aa13bf60929cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6Imy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770198046&amp;x-signature=YbUIR6Kop3WIrUZ1fdSNCQUgDIY%3D" alt="image.png" loading="lazy"/>
但是我们会发现在<code>source</code>中查看源代码，发现并没有开启 <code>sourceMap</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c51cbaafe6240b790f9220309ac3b2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6Imy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770198046&amp;x-signature=qWxLWMogytDacICqH8XAUJox86c%3D" alt="image.png" loading="lazy"/></p>
<p>接下来我们开始<code>vue</code>的 <code>sourceMap</code>, 我们可以看到<code>pnpm build</code>命令质上还是执行的<code>script</code>文件夹下的<code>build.js</code>打包脚本</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57ea0de4876e468ba761966319da9910~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6Imy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770198046&amp;x-signature=XWjxBSTV%2F1NjcYt3F07ZHXpVHXg%3D" alt="image.png" loading="lazy"/>
而这个sourceMap开始是在指令中通过-s开启的</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/543d3826906c43cbb0fdcf0a5e8e6a5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6Imy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770198046&amp;x-signature=OeqIfelg4LrKPZVG328%2BBtLdxv8%3D" alt="image.png" loading="lazy"/></p>
<p><code>rollup.config.js</code>会根据<code>sourceMap</code>指令生成<code>sourceMap</code>文件</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a74e35990a8b4a24a33ee481a835230e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6Imy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770198046&amp;x-signature=1Lz0vf9CdnspRFThTaBgbk8Tyxs%3D" alt="image.png" loading="lazy"/></p>
<p>接下来我们修改在<code>package.json</code>中的<code>build</code>脚本，增加<code>-s</code>标识（<code>"build": "node scripts/build.js -s",</code>）, 然后重新执行 <code>pnpm build</code>, 这样打包出来的文件就有sourceMap文件</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef7b47f4a2fb44b8ba4ceb2f86721b02~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6Imy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770198046&amp;x-signature=CMU6%2FJ68aM3lmqXZhV6sf8RWCa0%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-7">源码debuger技巧</h2>
<p>比如说，我们想看响应式相关的逻辑，可以找到<code>reactive</code>函数处，设置断点，然后按步骤阅读
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0d7190433654817af8623ea59832a26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6Imy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770198046&amp;x-signature=WwKRlcwV%2FDf9CBniOYJzUpXH3vY%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-8">总结</h2>
<p>本节主要介绍阅读源码前的准备，后续将逐步带大家阅读<code>vue</code>源码, 如果对你有帮助，帮忙点个关注、赞~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Three.js 曲线应用详解]]></title>    <link>https://juejin.cn/post/7600068892988604426</link>    <guid>https://juejin.cn/post/7600068892988604426</guid>    <pubDate>2026-01-28T09:51:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600068892988604426" data-draft-id="7600238071037935625" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Three.js 曲线应用详解"/> <meta itemprop="keywords" content="前端,three.js"/> <meta itemprop="datePublished" content="2026-01-28T09:51:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端王校长"/> <meta itemprop="url" content="https://juejin.cn/user/2295436010076631"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Three.js 曲线应用详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2295436010076631/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端王校长
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T09:51:30.000Z" title="Wed Jan 28 2026 09:51:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>本文将详细介绍如何使用 Three.js 中的曲线功能。我们将学习如何创建 CatmullRomCurve3 样条曲线，并利用曲线来控制物体的运动轨迹，以及如何将曲线可视化地显示在场景中。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7b359c190ee494f8b524cbe73bca22b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv546L5qCh6ZW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770198689&amp;x-signature=FbVL5CAPTiZ2PrUv9fSouirsNqI%3D" alt="screenshot_2026-01-28_17-49-20.gif" loading="lazy"/></p>
<h2 data-id="heading-1">准备工作</h2>
<p>首先，我们需要引入必要的 Three.js 库：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"three"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">OrbitControls</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"three/examples/jsm/controls/OrbitControls"</span>;
</code></pre>
<h2 data-id="heading-2">场景初始化</h2>
<p>首先，我们需要创建一个基本的 Three.js 场景：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> camera, scene, renderer;
<span class="hljs-keyword">const</span> clock = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Clock</span>();
<span class="hljs-keyword">const</span> textureLoader = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">TextureLoader</span>();

<span class="hljs-keyword">let</span> moon;
<span class="hljs-keyword">let</span> earth;
<span class="hljs-keyword">let</span> curve;
<span class="hljs-keyword">const</span> raycaster = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Raycaster</span>();

<span class="hljs-keyword">function</span> <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">EARTH_RADIUS</span> = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MOON_RADIUS</span> = <span class="hljs-number">0.27</span>;

  <span class="hljs-comment">// 创建透视相机</span>
  camera = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PerspectiveCamera</span>(
    <span class="hljs-number">45</span>,
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>,
    <span class="hljs-number">1</span>,
    <span class="hljs-number">200</span>
  );
  camera.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>, -<span class="hljs-number">10</span>);

  <span class="hljs-comment">// 初始化场景</span>
  scene = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Scene</span>();
}
</code></pre>
<h2 data-id="heading-3">光照设置</h2>
<p>添加适当的光照使场景更真实：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 方向光</span>
<span class="hljs-keyword">const</span> dirLight = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">DirectionalLight</span>(<span class="hljs-number">0xffffff</span>);
dirLight.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
scene.<span class="hljs-title function_">add</span>(dirLight);

<span class="hljs-comment">// 环境光</span>
<span class="hljs-keyword">const</span> light = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">AmbientLight</span>(<span class="hljs-number">0xffffff</span>, <span class="hljs-number">0.5</span>); <span class="hljs-comment">// soft white light</span>
scene.<span class="hljs-title function_">add</span>(light);
</code></pre>
<h2 data-id="heading-4">创建地球和月球模型</h2>
<p>使用纹理贴图创建地球和月球模型：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建地球</span>
<span class="hljs-keyword">const</span> earthGeometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">SphereGeometry</span>(<span class="hljs-variable constant_">EARTH_RADIUS</span>, <span class="hljs-number">16</span>, <span class="hljs-number">16</span>);
<span class="hljs-keyword">const</span> earthMaterial = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshPhongMaterial</span>({
  <span class="hljs-attr">specular</span>: <span class="hljs-number">0x333333</span>,
  <span class="hljs-attr">shininess</span>: <span class="hljs-number">5</span>,
  <span class="hljs-attr">map</span>: textureLoader.<span class="hljs-title function_">load</span>(<span class="hljs-string">"textures/planets/earth_atmos_2048.jpg"</span>),
  <span class="hljs-attr">specularMap</span>: textureLoader.<span class="hljs-title function_">load</span>(<span class="hljs-string">"textures/planets/earth_specular_2048.jpg"</span>),
  <span class="hljs-attr">normalMap</span>: textureLoader.<span class="hljs-title function_">load</span>(<span class="hljs-string">"textures/planets/earth_normal_2048.jpg"</span>),
  <span class="hljs-attr">normalScale</span>: <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector2</span>(<span class="hljs-number">0.85</span>, <span class="hljs-number">0.85</span>),
});

earth = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(earthGeometry, earthMaterial);
scene.<span class="hljs-title function_">add</span>(earth);

<span class="hljs-comment">// 创建月球</span>
<span class="hljs-keyword">const</span> moonGeometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">SphereGeometry</span>(<span class="hljs-variable constant_">MOON_RADIUS</span>, <span class="hljs-number">16</span>, <span class="hljs-number">16</span>);
<span class="hljs-keyword">const</span> moonMaterial = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshPhongMaterial</span>({
  <span class="hljs-attr">shininess</span>: <span class="hljs-number">5</span>,
  <span class="hljs-attr">map</span>: textureLoader.<span class="hljs-title function_">load</span>(<span class="hljs-string">"textures/planets/moon_1024.jpg"</span>),
});
moon = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(moonGeometry, moonMaterial);
scene.<span class="hljs-title function_">add</span>(moon);
</code></pre>
<h2 data-id="heading-5">创建 CatmullRomCurve3 曲线</h2>
<p>这是关键部分，我们使用一系列点来创建平滑的 CatmullRomCurve3 样条曲线：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 根据这一系列的点创建闭合曲线</span>
curve = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">CatmullRomCurve3</span>(
  [
    <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(-<span class="hljs-number">10</span>, <span class="hljs-number">0</span>, <span class="hljs-number">10</span>),  <span class="hljs-comment">// 起始点</span>
    <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(-<span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>),    <span class="hljs-comment">// 控制点1</span>
    <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>),     <span class="hljs-comment">// 控制点2</span>
    <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(<span class="hljs-number">5</span>, -<span class="hljs-number">5</span>, <span class="hljs-number">5</span>),    <span class="hljs-comment">// 控制点3</span>
    <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(<span class="hljs-number">10</span>, <span class="hljs-number">0</span>, <span class="hljs-number">10</span>),   <span class="hljs-comment">// 结束点</span>
  ],
  <span class="hljs-literal">true</span>  <span class="hljs-comment">// true 表示创建闭合曲线，false 表示开放曲线</span>
);
</code></pre>
<p>CatmullRomCurve3 曲线是一种样条曲线，它会经过所有的控制点，形成平滑的路径。参数 <code>true</code> 表示创建闭合曲线，即曲线的终点会连接到起点。</p>
<h2 data-id="heading-6">可视化曲线</h2>
<p>将曲线可视化地显示在场景中：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在曲线里，getPoints获取501个点（500个分段+1）</span>
<span class="hljs-keyword">const</span> points = curve.<span class="hljs-title function_">getPoints</span>(<span class="hljs-number">500</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(points);
<span class="hljs-keyword">const</span> geometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">BufferGeometry</span>().<span class="hljs-title function_">setFromPoints</span>(points);

<span class="hljs-keyword">const</span> material = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">LineBasicMaterial</span>({ <span class="hljs-attr">color</span>: <span class="hljs-number">0xff0000</span> });

<span class="hljs-comment">// 创建线条对象并添加到场景</span>
<span class="hljs-keyword">const</span> curveObject = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Line</span>(geometry, material);
scene.<span class="hljs-title function_">add</span>(curveObject);
</code></pre>
<p><code>getPoints(divisions)</code> 方法会沿着曲线均匀地采样指定数量的点。在这里，我们使用 500 个分段，因此会得到 501 个点（包括起始点和结束点）。这样可以确保曲线看起来平滑流畅。</p>
<h2 data-id="heading-7">渲染器和控制器设置</h2>
<p>设置渲染器和控制器：</p>
<pre><code class="hljs language-javascript" lang="javascript">renderer = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">WebGLRenderer</span>();
renderer.<span class="hljs-title function_">setPixelRatio</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">devicePixelRatio</span>);
renderer.<span class="hljs-title function_">setSize</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>);
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(renderer.<span class="hljs-property">domElement</span>);

<span class="hljs-keyword">const</span> controls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrbitControls</span>(camera, renderer.<span class="hljs-property">domElement</span>);
controls.<span class="hljs-property">minDistance</span> = <span class="hljs-number">5</span>;
controls.<span class="hljs-property">maxDistance</span> = <span class="hljs-number">100</span>;
</code></pre>
<h2 data-id="heading-8">动画循环与曲线运动</h2>
<p>在动画循环中，我们让月球沿着曲线运动，同时相机也跟随曲线：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">animate</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">requestAnimationFrame</span>(animate);

  <span class="hljs-keyword">const</span> elapsed = clock.<span class="hljs-title function_">getElapsedTime</span>();
  <span class="hljs-comment">// 计算归一化的时间参数（0到1之间）</span>
  <span class="hljs-keyword">const</span> time = elapsed/<span class="hljs-number">10</span> % <span class="hljs-number">1</span>;
  
  <span class="hljs-comment">// 根据时间参数获取曲线上对应的点</span>
  <span class="hljs-keyword">const</span> point = curve.<span class="hljs-title function_">getPoint</span>(time);
  
  <span class="hljs-comment">// 将月球位置设置为曲线上当前点的位置</span>
  moon.<span class="hljs-property">position</span>.<span class="hljs-title function_">copy</span>(point);
  
  <span class="hljs-comment">// 相机也跟随曲线运动</span>
  camera.<span class="hljs-property">position</span>.<span class="hljs-title function_">copy</span>(point);
  
  <span class="hljs-comment">// 相机始终看向地球位置</span>
  camera.<span class="hljs-title function_">lookAt</span>(earth.<span class="hljs-property">position</span>)
  
  <span class="hljs-comment">// 渲染场景</span>
  renderer.<span class="hljs-title function_">render</span>(scene, camera);
}
</code></pre>
<p><code>getPoint(t)</code> 方法用于获取曲线上特定参数位置的点，其中 t 是一个介于 0 和 1 之间的值。当 t=0 时，返回曲线的起始点；当 t=1 时，返回曲线的结束点（在闭合曲线的情况下，这与起始点相同）。</p>
<h2 data-id="heading-9">曲线类型详解</h2>
<p>Three.js 提供了多种曲线类型：</p>
<ol>
<li><strong>CatmullRomCurve3</strong>: 经过所有控制点的三次样条曲线</li>
<li><strong>CubicBezierCurve3</strong>: 三次贝塞尔曲线</li>
<li><strong>QuadraticBezierCurve3</strong>: 二次贝塞尔曲线</li>
<li><strong>LineCurve3</strong>: 直线段</li>
</ol>
<h2 data-id="heading-10">CatmullRomCurve3 曲线参数</h2>
<p>CatmullRomCurve3 曲线构造函数接受以下参数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">CatmullRomCurve3</span>(points, closed, curveType, tension)
</code></pre>
<ul>
<li><code>points</code>: Vector3 类型的数组，定义曲线经过的点</li>
<li><code>closed</code>: Boolean 类型，是否闭合曲线</li>
<li><code>curveType</code>: String 类型，默认为 "centripetal"，还有 "chordal" 和 "catmullrom"</li>
<li><code>tension</code>: Number 类型，张力参数，默认为 0.5，值越大曲线越紧绷</li>
</ul>
<h2 data-id="heading-11">应用场景</h2>
<p>曲线在 Three.js 中有多种应用场景：</p>
<ol>
<li><strong>路径动画</strong>: 让物体沿着预设路径运动</li>
<li><strong>摄像机动画</strong>: 让摄像机沿着路径移动，创建电影般的镜头效果</li>
<li><strong>地形生成</strong>: 使用曲线生成平滑的地形轮廓</li>
<li><strong>粒子系统</strong>: 控制粒子的运动轨迹</li>
<li><strong>UI 动画</strong>: 创建复杂的 UI 动画效果</li>
</ol>
<h2 data-id="heading-12">总结</h2>
<p>通过这个项目，我们学习了如何使用 Three.js 的曲线功能：</p>
<ol>
<li>如何创建 CatmullRomCurve3 样条曲线</li>
<li>如何将曲线可视化显示在场景中</li>
<li>如何让物体沿着曲线运动</li>
<li>如何控制动画的时间参数</li>
<li>曲线在 3D 应用中的多种用途</li>
</ol>
<p>曲线是 Three.js 中一个非常强大的功能，它可以让我们创建流畅的动画和复杂的路径效果，为我们的 3D 应用增添更多的动态美感。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀 前端5分钟极速转全栈！orpc + cloudflare 前后端项目实践]]></title>    <link>https://juejin.cn/post/7600234310964789286</link>    <guid>https://juejin.cn/post/7600234310964789286</guid>    <pubDate>2026-01-28T09:57:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600234310964789286" data-draft-id="7600238071037853705" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀 前端5分钟极速转全栈！orpc + cloudflare 前后端项目实践"/> <meta itemprop="keywords" content="前端,全栈,后端"/> <meta itemprop="datePublished" content="2026-01-28T09:57:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码小学僧"/> <meta itemprop="url" content="https://juejin.cn/user/255519436842030"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀 前端5分钟极速转全栈！orpc + cloudflare 前后端项目实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/255519436842030/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码小学僧
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T09:57:39.000Z" title="Wed Jan 28 2026 09:57:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>标题党了一下哈哈，全栈还是有很多知识要学习的，这里只是简单介绍一套我觉得还不错的技术栈，希望对大家有帮助。</p>
<p>大前提: 请先注册一个 cloudflare 账户。5块钱买个域名绑定到 cloudflare 上，可以参考我之前的文章。</p>
<h2 data-id="heading-1">快速创建项目</h2>
<p>我在 GitHub 上偶然发现了一个很有意思的项目，想推荐给大家： <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.better-t-stack.dev%2Fnew" target="_blank" title="https://www.better-t-stack.dev/new" ref="nofollow noopener noreferrer">www.better-t-stack.dev/new</a></p>
<p>它提供了一个可视化页面，可以自由选择自己需要的技术栈，并自动生成初始化命令，一行命令就能创建完整项目。即使对技术栈不太熟悉，也可以直接使用社区中使用人数较多的预设配置，例如左下角提供的 T3 Stack、PERN Stack 等方案。同时还支持在线预览项目的文件结构，整体体验做得相当成熟。</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2271102e88b14775b336ce5d61648518~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199307&amp;x-signature=er7Rk1Q9RafkigK3icOBvMHGlU4%3D" alt="" width="100%" loading="lazy"/>
<p>这次我选择的是前后端统一部署到 Cloudflare，运行时使用 Cloudflare Workers，前后端之间通过 oRPC 通信。对于技术栈中一些不太熟悉的部分，我会在后文单独说明。通过复制生成的命令行即可完成项目初始化，最终得到的是一个前后端共存的 monorepo 项目结构，使用 Turbo 统一管理前后端的运行、调试和构建流程。</p>
<p>前后端代码全部采用 TypeScript 编写，对前端同学非常友好，上手成本也很低。(题外话: 我觉得写 JS / TS真幸福，应了那句话: 能用 JS 写的最后都用 JS 写😂)</p>
<pre><code class="hljs language-sql" lang="sql">pnpm <span class="hljs-keyword">create</span> better<span class="hljs-operator">-</span>t<span class="hljs-operator">-</span>stack<span class="hljs-variable">@latest</span> cf<span class="hljs-operator">-</span>todo <span class="hljs-comment">--frontend tanstack-router --backend hono --runtime workers --api orpc --auth none --payments none --database sqlite --orm drizzle --db-setup d1 --package-manager pnpm --git --web-deploy cloudflare --server-deploy cloudflare --install --addons biome turborepo --examples todo</span>
</code></pre>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79eb711a8f3b43ff8c54e22288ebae02~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199307&amp;x-signature=nNY6n0Jr9n6ZRBCaN%2F9hmv%2FknBI%3D" alt="" width="100%" loading="lazy"/>
<h2 data-id="heading-2">运行项目</h2>
<p>我们先把项目运行起来再看看代码。根据提示先运行一些Database的命令。<code>pnpm run db:generate</code></p>
<p>然后启动本地看看效果 <code>pnpm run dev</code> （注: 如果项目运行不起来，尝试升级一下pnpm版本，这个monorepo借助了pnpm-workspace的特性，一些 catalog 可能需要 pnpm 高版本才支持。）</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ed422af36734aa6984cd8cf133ae688~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199307&amp;x-signature=hQMCd%2Ff%2FFLayteqHcVtqgTHJHBs%3D" alt="" width="100%" loading="lazy"/>
<p>可以看到项目运行成功分别在本地 3001、3002端口，作者贴心的展示了一个TODO list示例。</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef572e2054f846a2a783f54cf02097ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199307&amp;x-signature=PSokVcBChgbcqlDc7QVlTVPL6yM%3D" alt="" width="100%" loading="lazy"/>
<h2 data-id="heading-3">了解代码</h2>
<h3 data-id="heading-4">文件结构</h3>
<p>很清爽的文件结构，apps下有前后端，然后packages下是一些共用的内容，根目录是格式化的biome与pnpm与turbo的配置。</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/651dbb89a668441e96b2892a8ed38ada~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199307&amp;x-signature=OPjFVkOv3EMECdASfHtVXTr2%2FLE%3D" alt="" width="50%" loading="lazy"/>
<h3 data-id="heading-5">Pnpm-workspace</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.pnpm.cn%2Fcatalogs" target="_blank" title="https://www.pnpm.cn/catalogs" ref="nofollow noopener noreferrer">www.pnpm.cn/catalogs</a> 使用了catalogs 方便在各个子包中共享同一个npm包避免重复安装。</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/200280409d31438299c69d72882c5049~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199307&amp;x-signature=7y4KbnAANXVftbQy83YsMWrjgDQ%3D" alt="" width="50%" loading="lazy"/>
<p>然后在 <code>/apps/web/package.json</code> 与 <code>/apps/server/package.json</code> 我们就可以看到使用根目录的catalogs了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e21f40753a5348eb86e01c8652f2be73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199307&amp;x-signature=pMJoEwA9H0cAdAQ4g07YQdXaTRE%3D" alt="" width="50%" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9deac12f0d4d49d1b2c84a0a4f2e84d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199307&amp;x-signature=zOr8EyDitWJpcvUQ2p%2Bz%2FZ1N2DY%3D" alt="" width="100%" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.pnpm.cn%2Fworkspaces" target="_blank" title="https://www.pnpm.cn/workspaces" ref="nofollow noopener noreferrer">www.pnpm.cn/workspaces</a> workspaces 方便引用同一工作区的其他子模块的文件。</p>
<h3 data-id="heading-6">Hono</h3>
<p>Hono 是一个轻量级的 Web 框架，主要面向 JavaScript 和 TypeScript 生态。它的设计目标是高性能、低开销，以及在不同运行时环境中的一致体验</p>
<p>官网: <a href="https://link.juejin.cn?target=https%3A%2F%2Fhono.dev%2F" target="_blank" title="https://hono.dev/" ref="nofollow noopener noreferrer">hono.dev/</a> ,常用与于 cloudflare 想结合出现。nodejs backend 框架也是多种多样的，选择自己喜欢的即可。</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6c2dccc45764a2a88cabec21bfca044~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199307&amp;x-signature=y2I5OS6Vox2RHd6FTTOleq0kfY4%3D" alt="" width="100%" loading="lazy"/>
<h3 data-id="heading-7">ORPC</h3>
<p>orpc 简单讲就是 trpc 的进化版。</p>
<p>trpc可能有的同学也不是很了解，引用自官网的介绍 <code>快速迭代，无忧无虑。轻松构建端到端类型安全的 API </code>。</p>
<p>说人话就是前后端共用一套TS，然后前端调用接口就可以直接以函数调用的方式访问后端接口，前端可以直接获得后端暴露的 API 类型定义。不用传统的前后端联调，后端给openapi文档，前端生成对应的TS接口响应入参与出参了，直接一套前端要调用接口直接点出来。</p>
<p>orpc 就是在 trpc 的基础上进行改造，官网: <a href="https://link.juejin.cn?target=https%3A%2F%2Forpc.dev%2Fdocs%2Fgetting-started" target="_blank" title="https://orpc.dev/docs/getting-started" ref="nofollow noopener noreferrer">orpc.dev/docs/gettin…</a> <code>oRPC（开放 API 远程过程调用）结合了 RPC（远程过程调用）与 OpenAPI，允许您通过类型安全的 API 定义和调用远程（或本地）过程，同时遵循 OpenAPI 规范。</code> 可以在享受trpc的同时生成openapi规范的文档。</p>
<p>访问我们这个示例项目的 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A3000%2Fapi-reference" target="_blank" title="http://localhost:3000/api-reference" ref="nofollow noopener noreferrer">http://localhost:3000/api-reference</a> 就可以看到一个美观的openapi规范的在线接口示例</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00012fc6bbb6422c83fc426149e826cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199307&amp;x-signature=r0CIrz3nICTbOML1qT395O86gRE%3D" alt="" width="100%" loading="lazy"/>
<p>我们来看orpc有多方便。</p>
<p><code>packages\api\src\routers\todo.ts</code> 接口的定义</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73c0988577694466b24db74066a68ad6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199307&amp;x-signature=fwiMlU8q9JFjU2tRmpAyPmfxJk8%3D" alt="" width="100%" loading="lazy"/>
<p><code>apps\web\src\routes\todos.tsx</code> 前端界面直接调用点出来要使用的函数。然后用 <code>@tanstack/react-query</code> 相关的hook进行处理，</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f5cfdccb1d54645b748c5860c98bd25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199307&amp;x-signature=GRnzO%2BUWF%2BVZHAq9HO7WI6ZljsA%3D" alt="" width="100%" loading="lazy"/>
<p>orpc也可以很好的与tanstack-query相结合。这样子直接开发个人项目的时候就免去了接口联调的麻烦，写完后端前端直接调用。</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b38a83e0fbd0484c837ed64470f9e4c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199307&amp;x-signature=8NucH92Rp9k8qvRYqFF%2BNlPIXg4%3D" alt="" width="100%" loading="lazy"/>
<h3 data-id="heading-8">drizzle</h3>
<p>drizzle orm 就是方便你来增删改查数据的，在没有这些ORM的时候需要直接写SQL语句执行，有了这些ORM他们封装了一些方法让你更轻松的掌控数据。然后实在复杂的SQL也可以自定义。</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/768274e612fb415aa9abb81735744f92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199307&amp;x-signature=IYJCmx9L5Bt%2FIhTH7OvgVEOeQ3c%3D" alt="" width="100%" loading="lazy"/>
<p>node的ORM选择有蛮多的 选自己喜欢的或者大家推荐比较多的即可。</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b46a3cc33ec4441987d05446ac17dd90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199307&amp;x-signature=gK7m%2BJ709RTNi9o2YBEsH9hj074%3D" alt="" width="100%" loading="lazy"/>
<h3 data-id="heading-9">Alchemy</h3>
<p>这个东西我也是第一次见到，我直接在bing搜还搜不到 需要加一些关键词，但感觉做的还不错，这里是官网: <a href="https://link.juejin.cn?target=https%3A%2F%2Falchemy.run%2Fwhat-is-alchemy%2F" target="_blank" title="https://alchemy.run/what-is-alchemy/" ref="nofollow noopener noreferrer">alchemy.run/what-is-alc…</a> 简单讲就是帮你管理一些部署用的基础设施信息，我这里是部署到 cloudflare，然后有一个 <code>alchemy.run.ts</code> 文件就是管理全部部署到 cloudflare相关的事情。</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc7f519d73e24e27b7a41ad34bc813ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199307&amp;x-signature=L3uKS0cDCcwWKokseNvyRbhpHqk%3D" alt="" width="100%" loading="lazy"/>
<p>如果你尝试 <code>pnpm run deploy</code> 部署这个项目的时候会发现运行不成功，因为你还没有给本地的 alchemy 授权你的 cloudflare 账户。</p>
<p><code>npm i -g alchemy</code>安装完成后 <code>alchemy configure</code> 会打开一个授权页授权到本地即可。如果打不开或授权失败，请尝试打开vpn的 TUN 模式试下。</p>
<h3 data-id="heading-10">Turborepo</h3>
<p>Turborepo 是一个用于 JavaScript 和 TypeScript 代码库的高性能构建系统。它专为扩展单体仓库而设计，也能加速<a href="https://link.juejin.cn?target=https%3A%2F%2Fturbo.net.cn%2Fdocs%2Fguides%2Fsingle-package-workspaces" target="_blank" title="https://turbo.net.cn/docs/guides/single-package-workspaces" ref="nofollow noopener noreferrer">单包工作区</a>中的工作流。</p>
<p>vercel开源的一个项目，常用于处理 monorepo 类型仓库的构建。</p>
<h3 data-id="heading-11">Cloudflare</h3>
<p>我们这个项目前后端都部署到 cf 的 woker上，有很多的免费额度，cf真是大善人。然后数据存储的数据库使用的也是 cf 的D1数据库，个人MVP的项目初期应该够用了，升级了也不贵，不愧是赛博佛祖。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/241ba89fd47f4055b4d789c8d407b3a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199307&amp;x-signature=W4vvdgzClhZoxNa%2FNsC8MnPzl7w%3D" alt="" width="50%" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ffbf7eeebfe4b67a851a2cc71229c4a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199307&amp;x-signature=SyyCRjtFIbZOIG7UhxWfvGgOntk%3D" alt="" width="50%" loading="lazy"/></p>
<h2 data-id="heading-12">项目部署</h2>
<p>授权完成后，我们运行 <code>pnpm run deploy</code> 试一下。可以看到给出了前后端两个地址。</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/876832ac0f0543c485a7b8e3b057d3b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199307&amp;x-signature=E%2FKVvEz7Hi5JyrFQRfdiyemYzVs%3D" alt="" width="100%" loading="lazy"/>
<p>访问前端后发现，我靠这么请求的是localhost:3000, 原来我们前后端的 .env 文件都没进行修改。</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da949dc8b16845568c6c90a52706c7d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199307&amp;x-signature=P76ozaLicAKjcqbe7iOehaWWj%2BM%3D" alt="" width="100%" loading="lazy"/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c817a38bdee47ea8a67cc55ce583ab8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199307&amp;x-signature=BIuZxF9F%2BuSBjCyXTXZV05g%2BuYM%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02ad08bcaa12498cb729dcb6d7045eeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199307&amp;x-signature=K180xpuFZ8De6QGHmZ9fgRlzNzs%3D" alt="" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de53f0acd85e4efba517023e261c1e73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199307&amp;x-signature=n9rVteBAIG2HMopI4ZAOG6Yo8go%3D" alt="" loading="lazy"/></p>
<p>在后端的根目录创建一个<code>.env.dev</code>文件，CORS_ORIGIN 填写前端访问的地址。</p>
<pre><code class="hljs language-shell" lang="shell">CORS_ORIGIN=[填写前端地址]
</code></pre>
<p>前端创建一个 <code>.env.dev</code>文件</p>
<pre><code class="hljs language-shell" lang="shell">VITE_SERVER_URL=[填写后端地址]
</code></pre>
<p>然后添加一个 <code>pnpm run deploy:dev</code> 命令在根目录的 package.json 文件，表示我们要对 env.dev 环境变量的内容进行打包构建。复制上一行的 deploy 命令基础上再添加了一个 ALCHEMY_ENV=dev 的标识。</p>
<pre><code class="hljs language-shell" lang="shell">"deploy:dev": "cross-env ALCHEMY_ENV=dev turbo -F @cf-todo/infra deploy",
</code></pre>
<p>再修改 <code>alchemy.run.ts</code> 文件，根据环境变量读取对应的env文件</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> alchemy <span class="hljs-keyword">from</span> <span class="hljs-string">"alchemy"</span>;
<span class="hljs-keyword">import</span> { D1Database, <span class="hljs-title class_">Vite</span>, <span class="hljs-title class_">Worker</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"alchemy/cloudflare"</span>;
<span class="hljs-keyword">import</span> { config } <span class="hljs-keyword">from</span> <span class="hljs-string">"dotenv"</span>;

<span class="hljs-keyword">const</span> mode = process.<span class="hljs-property">env</span>.<span class="hljs-property">ALCHEMY_ENV</span> ?? process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> ?? <span class="hljs-string">"development"</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title function_">loadEnv</span> = (<span class="hljs-params">path: string, override = <span class="hljs-literal">false</span></span>) =&gt; {
  <span class="hljs-title function_">config</span>({ path, override });
};

<span class="hljs-title function_">loadEnv</span>(<span class="hljs-string">"./.env"</span>);
<span class="hljs-title function_">loadEnv</span>(<span class="hljs-string">`./.env.<span class="hljs-subst">${mode}</span>`</span>, <span class="hljs-literal">true</span>);
<span class="hljs-title function_">loadEnv</span>(<span class="hljs-string">"../../apps/web/.env"</span>);
<span class="hljs-title function_">loadEnv</span>(<span class="hljs-string">`../../apps/web/.env.<span class="hljs-subst">${mode}</span>`</span>, <span class="hljs-literal">true</span>);
<span class="hljs-title function_">loadEnv</span>(<span class="hljs-string">"../../apps/server/.env"</span>);
<span class="hljs-title function_">loadEnv</span>(<span class="hljs-string">`../../apps/server/.env.<span class="hljs-subst">${mode}</span>`</span>, <span class="hljs-literal">true</span>);

<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> <span class="hljs-title function_">alchemy</span>(<span class="hljs-string">"cf-todo"</span>);

<span class="hljs-keyword">const</span> db = <span class="hljs-keyword">await</span> <span class="hljs-title function_">D1Database</span>(<span class="hljs-string">"database"</span>, {
  <span class="hljs-attr">migrationsDir</span>: <span class="hljs-string">"../../packages/db/src/migrations"</span>,
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> web = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Vite</span>(<span class="hljs-string">"web"</span>, {
  <span class="hljs-attr">cwd</span>: <span class="hljs-string">"../../apps/web"</span>,
  <span class="hljs-attr">assets</span>: <span class="hljs-string">"dist"</span>,
  <span class="hljs-attr">bindings</span>: {
    <span class="hljs-attr">VITE_SERVER_URL</span>: alchemy.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_SERVER_URL</span>!,
  },
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> server = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">"server"</span>, {
  <span class="hljs-attr">cwd</span>: <span class="hljs-string">"../../apps/server"</span>,
  <span class="hljs-attr">entrypoint</span>: <span class="hljs-string">"src/index.ts"</span>,
  <span class="hljs-attr">compatibility</span>: <span class="hljs-string">"node"</span>,
  <span class="hljs-attr">bindings</span>: {
    <span class="hljs-attr">DB</span>: db,
    <span class="hljs-attr">CORS_ORIGIN</span>: alchemy.<span class="hljs-property">env</span>.<span class="hljs-property">CORS_ORIGIN</span>!,
  },
  <span class="hljs-attr">dev</span>: {
    <span class="hljs-attr">port</span>: <span class="hljs-number">3000</span>,
  },
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Web    -&gt; <span class="hljs-subst">${web.url}</span>`</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Server -&gt; <span class="hljs-subst">${server.url}</span>`</span>);

<span class="hljs-keyword">await</span> app.<span class="hljs-title function_">finalize</span>();
</code></pre>
<p>最后还需要在turbo.json 文件添加下构建传递的这个标识变量。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"deploy"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"cache"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"ALCHEMY_ENV"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
</code></pre>
<h2 data-id="heading-13">重新部署</h2>
<p>先运行 <code>pnpm run destory</code> 销毁之前的资源。再执行 <code>pnpm run deploy:dev</code>。nice 可以使用了，美滋滋~</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/639bcdbe0ac84d56a18634a17199db6f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5bCP5a2m5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199307&amp;x-signature=eg9ftLbl2qCktjEfiT%2FgREAVuY0%3D" alt="" width="100%" loading="lazy"/>
<h2 data-id="heading-14">结语</h2>
<p>现在，一个简单完整的前后端项目已经准备好，并且可以零成本完成部署，已经交到你手里了。接下来就可以充分发挥想象力和创造力，去打磨一个让人眼前一亮的产品。你也可以选择继续深入研究这个项目，借助AI的能力不断学习或创作。希望对大家有帮助！</p>
<p>改造部署文件参考: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FLLmoskk%2Forpc-todolist%2Ftree%2Ffeature%2Ftodolist" target="_blank" title="https://github.com/LLmoskk/orpc-todolist/tree/feature/todolist" ref="nofollow noopener noreferrer">github.com/LLmoskk/orp…</a></p>
<p>最后，感恩Cloudflare！感恩 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.better-t-stack.dev%2Fnew" target="_blank" title="https://www.better-t-stack.dev/new" ref="nofollow noopener noreferrer">better-t-stack.dev/new</a> 项目！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从“工具过载”到“精准调用”：破解 Agent 工具管理难题]]></title>    <link>https://juejin.cn/post/7600032104248754239</link>    <guid>https://juejin.cn/post/7600032104248754239</guid>    <pubDate>2026-01-28T09:59:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600032104248754239" data-draft-id="7600219080045690923" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从“工具过载”到“精准调用”：破解 Agent 工具管理难题"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2026-01-28T09:59:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从“工具过载”到“精准调用”：破解 Agent 工具管理难题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T09:59:35.000Z" title="Wed Jan 28 2026 09:59:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：青瑭、聪言</p>
<h2 data-id="heading-0">背景与挑战</h2>
<h3 data-id="heading-1">行业背景：Agent 工具生态迈向规模化</h3>
<p>随着 AI Agent 在企业场景中的深度应用，开发者普遍为 Agent 配置大量工具——从天气查询、地图导航，到数据库接口、内部 API 等，以支撑复杂任务的执行。然而，当工具数量从几十个激增至上百甚至上千时，传统的“全量暴露”模式便难以为继：Agent 不仅要处理冗长的工具列表，还容易选错工具、响应变慢、调用成本飙升。如何让 Agent 在海量工具中快速、准确地选出真正需要的那几个，既决定了任务能否顺利完成，也直接影响系统的运行成本与响应效率。</p>
<p>AgentScope Java 框架作为面向生产级智能体的开源开发框架，致力于为 Java 开发者提供高内聚、低耦合、可扩展的 Agent 构建能力。面对日益膨胀的工具库，我们期望不再把所有工具一股脑塞给 Agent，而是按需、精准、安全地动态供给——这才是大规模 Agent 落地的关键所在。</p>
<h3 data-id="heading-2">企业级 Agent 工具管理的核心挑战</h3>
<p>尽管 Agent 开发框架 AgentScope Java 提供了灵活的工具集成机制，但在真实生产环境中，工具规模扩大反而带来“越强越笨”的悖论。主要体现在以下六大维度：</p>
<ul>
<li><strong>Prompt 膨胀，上下文资源被严重挤占</strong>：每个工具需在 Prompt 中声明名称、描述与参数 Schema。工具越多，输入越长，迅速耗尽 LLM 的上下文窗口，限制任务复杂度。</li>
<li><strong>推理成本不可控</strong>：冗长 Prompt 直接推高 Token 消耗，在高频调用或大规模部署场景下，LLM 调用费用呈指数级增长。</li>
<li><strong>工具选择准确率下降</strong>：面对功能相近或无关的工具列表，大模型易混淆误判，导致调用错误、任务失败或结果偏差。</li>
<li><strong>响应延迟增加</strong>：处理超长上下文显著延长 LLM 推理时间，拖慢端到端响应速度，损害用户体验。</li>
<li><strong>维护复杂度飙升</strong>：开发者需手动筛选“哪些工具对哪个任务可见”，难以实现动态、按需的工具分配，系统可扩展性受限。</li>
<li><strong>安全与稳定性风险加剧</strong>：无关甚至敏感工具若被误选执行，可能触发无效调用、数据污染，甚至引发安全漏洞。</li>
</ul>
<h3 data-id="heading-3">破局之道：构建语义驱动的智能工具精选体系</h3>
<p>要真正释放大规模工具库的价值，必须摒弃“全量推送”的粗放模式，转向一种以任务语义为中心、按需披露的现代化工具供给范式。</p>
<p>为此，AgentScope 深度集成 Higress AI Gateway，推出 Higress 扩展插件——基于语义化工具检索，在运行时动态为 Agent 注入与其当前意图最匹配的工具子集，实现精准供给、轻量推理与安全隔离。</p>
<p>这一机制本质上是一种面向智能体的渐进式能力披露：Agent 仅在需要时“看见”相关能力，既遵循最小权限原则，又显著降低上下文开销与决策噪声，从而全面提升系统的可扩展性、可观测性与鲁棒性。</p>
<h2 data-id="heading-4">AgentScope Java Higress 扩展：智能工具精选</h2>
<h3 data-id="heading-5">核心价值</h3>
<p>Higress 源自阿里巴巴内部，是一款开源的云原生 API 网关， 将流量网关、微服务网关、安全网关三合一。在 AI 时代，Higress 演进为 AI 原生网关的技术底座，将 LLM 调用、SSE 流式响应、Agent 工具交互等 AI 工作负载视为一等公民。阿里云基于 Higress 推出了商业化 AI 网关，提供 99.99% 高可用保障，已稳定支撑通义千问、百炼、PAI 等阿里内部 AI 业务，并服务零一万物、FastGPT 等头部 AIGC 企业。</p>
<p>AI 网关推出 MCP 语义检索功能，通过自然语言理解用户意图，动态返回最相关的工具子集，实现精准供给、降本增效、安全可控。核心能力包括：</p>
<ul>
<li>统一入口管理：所有 Agent 通过单一端点访问全部 MCP 工具，简化接入，集中治理。</li>
<li>智能语义匹配：基于 Qwen 大模型与 AnalyticDB 向量数据库，Agent 仅需描述需求（如“查北京天气和附近餐厅”），即可自动匹配最相关工具。</li>
<li>双阶段高精度检索：先通过 Qwen Embedding 向量召回候选工具，再可选使用 Qwen Rerank 模型精排，显著提升推荐准确性。</li>
<li>实时元数据同步：MCP Server 的增删改操作自动触发工具元信息采集与向量化更新，确保检索结果与实际服务状态一致。</li>
<li>一键开通，零配置上手：在控制台启用语义检索后，系统自动完成向量库初始化、模型配置、路由下发等全流程，即开即用。</li>
</ul>
<h3 data-id="heading-6">性能表现</h3>
<p>该语义检索功能使用 Weight 混合算法，与其他算法性能对比如下：</p>
<p><strong>1）准确性：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fba0a1c8888c4d5f9c581f68a6761a03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199177&amp;x-signature=E3M6iggQ9468%2BdIa2XlO1CQ6dmE%3D" alt="图片" loading="lazy"/></p>
<p><strong>2）时间延迟：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd9f7fe5f9a04e74ab471574b6eeff2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199177&amp;x-signature=sxusailXfzLkKRJ6AujXHqHzOuE%3D" alt="图片" loading="lazy"/></p>
<p>根据准确性和时间延迟的性能比较，Weight 算法在准确度上微幅领先并且搜索时间控制在 350 毫秒以内，相比纯向量搜索仅增加约 30 毫秒延迟，满足实时检索需求。</p>
<h3 data-id="heading-7">AgentScope Java Higress扩展</h3>
<p>因此，AgentScope Java 推出了 Higress 扩展，深度集成 Higress AI Gateway 的语义检索能力，覆盖 Agent 从工具发现、筛选、加载到调用的完整生命周期，全面支撑低成本、高精度、高效率的 Agent 运行。该插件提供以下能力：</p>
<ul>
<li>语义驱动的工具精选：用户可以告别硬编码工具列表，基于用户自然语言描述动态检索最相关工具。</li>
<li>无缝集成 MCP 客户端：提供标准化、响应式的 Java 客户端，零侵入兼容现有 AgentScope 生态。</li>
<li>企业级可观测与安全：依托阿里云 AI Gateway，提供认证鉴权的安全能力。</li>
</ul>
<h2 data-id="heading-8">快速开始</h2>
<h3 data-id="heading-9">前提条件</h3>
<ol>
<li>
<p>创建包年包月或按量付费的阿里云 AI Gateway 实例：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcommon-buy.aliyun.com%2F%3FcommodityCode%3Dapigateway_aipost_public_cn" target="_blank" title="https://common-buy.aliyun.com/?commodityCode=apigateway_aipost_public_cn" ref="nofollow noopener noreferrer">common-buy.aliyun.com/?commodityC…</a></p>
</li>
<li>
<p>在 AI Gateway 中注册 MCP 工具服务：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fapi-gateway%2Fai-gateway%2Fuser-guide%2Fgateway-managed-mcp-services" target="_blank" title="https://help.aliyun.com/zh/api-gateway/ai-gateway/user-guide/gateway-managed-mcp-services" ref="nofollow noopener noreferrer">help.aliyun.com/zh/api-gate…</a></p>
</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86b1a801080b4d0fa1c80ec7c8f61793~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199177&amp;x-signature=tjDiJ5s2tRizpkEy4mChFeF8Do8%3D" alt="图片" loading="lazy"/></p>
<ol start="3">
<li>在 MCP 管理 &gt; 语义检索页签中启用语义检索功能  </li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a17bf8bb0254aa3897956d2fa33d004~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199177&amp;x-signature=vCj53TxtUfZek%2B3xZcaUvvkt97Y%3D" alt="图片" loading="lazy"/></p>
<ol start="4">
<li>（可选）配置消费者认证，提升安全性</li>
</ol>
<h3 data-id="heading-10">使用 Higress 插件为 Agentscope Java Agent 添加工具</h3>
<h4 data-id="heading-11">1. 添加依赖</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.agentscope<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>agentscope-extensions-higress<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${agentscope.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h4 data-id="heading-12">2. 启用语义工具搜索</h4>
<p>通过使用 toolsearch 方法，您可以指定召回的与描述最相关的 topK 个工具，以供 Agent 调用。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 构建带语义搜索的客户端</span>
HigressMcpClientWrapper higressClient =
                HigressMcpClientBuilder<span class="hljs-selector-class">.create</span>("higress")
                        <span class="hljs-selector-class">.streamableHttpEndpoint</span>(HIGRESS_ENDPOINT)
                        <span class="hljs-comment">// .sseEndpoint(HIGRESS_ENDPOINT + "/sse")  // Alternative: SSE transport</span>
                        <span class="hljs-comment">// .header("Authorization", "Bearer xxx")   // Optional: Add auth header</span>
                        <span class="hljs-comment">// .queryParam("queryKey", "queryValue")   // Optional: Add query param</span>
                        <span class="hljs-selector-class">.toolSearch</span>("your agent description", <span class="hljs-number">5</span>) <span class="hljs-comment">// Optional: Enable tool search</span>
                        <span class="hljs-selector-class">.buildAsync</span>()
                        <span class="hljs-selector-class">.block</span>();
<span class="hljs-comment">// 2. Register with HigressToolkit</span>
Toolkit toolkit = new <span class="hljs-built_in">HigressToolkit</span>();
toolkit<span class="hljs-selector-class">.registerMcpClient</span>(higressClient)<span class="hljs-selector-class">.block</span>();
<span class="hljs-comment">// 创建 Agent</span>
ReActAgent agent =
                ReActAgent<span class="hljs-selector-class">.builder</span>()
                        <span class="hljs-selector-class">.name</span>("HigressAgent")
                        <span class="hljs-selector-class">.sysPrompt</span>(
                                "You are a helpful assistant. Please answer questions concisely and"
                                        + " accurately.")
                        <span class="hljs-selector-class">.model</span>(
                                DashScopeChatModel.builder()
                                        <span class="hljs-selector-class">.apiKey</span>(apiKey)
                                        <span class="hljs-selector-class">.modelName</span>("qwen-max")
                                        <span class="hljs-selector-class">.stream</span>(true)
                                        <span class="hljs-selector-class">.enableThinking</span>(false)
                                        <span class="hljs-selector-class">.formatter</span>(new DashScopeChatFormatter())
                                        <span class="hljs-selector-class">.build</span>())
                        <span class="hljs-selector-class">.toolkit</span>(toolkit)
                        <span class="hljs-selector-class">.memory</span>(new InMemoryMemory())
                        <span class="hljs-selector-class">.build</span>();
</code></pre>
<p>完整示例见 agentscope-examples/HigressToolExample.java：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fagentscope-ai%2Fagentscope-java%2Fblob%2Fmain%2Fagentscope-examples%2Fquickstart%2Fsrc%2Fmain%2Fjava%2Fio%2Fagentscope%2Fexamples%2Fquickstart%2FHigressToolExample.java" target="_blank" title="https://github.com/agentscope-ai/agentscope-java/blob/main/agentscope-examples/quickstart/src/main/java/io/agentscope/examples/quickstart/HigressToolExample.java" ref="nofollow noopener noreferrer">github.com/agentscope-…</a></p>
<h2 data-id="heading-13">加入我们，共建 AgentScope Java、Higress 生态</h2>
<p>AgentScope Java 与 Higress 都是开放的开源项目，我们诚邀所有对 Agent 与 AI网关感兴趣的开发者参与共建！</p>
<ul>
<li>GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fagentscope-ai%2Fagentscope-java" target="_blank" title="https://github.com/agentscope-ai/agentscope-java" ref="nofollow noopener noreferrer">github.com/agentscope-…</a></li>
<li>Github：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Falibaba%2Fhigress" target="_blank" title="https://github.com/alibaba/higress" ref="nofollow noopener noreferrer">github.com/alibaba/hig…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Agent Skills实战分享：AI编程最后一公里，别让代码死在localhost里]]></title>    <link>https://juejin.cn/post/7600227607977852980</link>    <guid>https://juejin.cn/post/7600227607977852980</guid>    <pubDate>2026-01-28T08:20:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600227607977852980" data-draft-id="7600031636248526888" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Agent Skills实战分享：AI编程最后一公里，别让代码死在localhost里"/> <meta itemprop="keywords" content="AI编程,Agent,小程序·云开发"/> <meta itemprop="datePublished" content="2026-01-28T08:20:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="腾讯云开发CloudBase"/> <meta itemprop="url" content="https://juejin.cn/user/2963939080036493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Agent Skills实战分享：AI编程最后一公里，别让代码死在localhost里
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2963939080036493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    腾讯云开发CloudBase
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T08:20:57.000Z" title="Wed Jan 28 2026 08:20:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如何把 8 年云端经验装进你的 AI 开发工具，让AI从"实习生"变成"持证上岗的专家"。 本文将分享如何用 Agent Skill 解决 AI Coding 领域的痛点问题，也分享如何解决 AI 不调用 Skill 等实践技巧。</p>
<p>最近我们在折腾 Agent Skills，想把腾讯云开发（CloudBase）这些年攒下的经验打包给 AI。实战下来发现，最折磨人的不是 AI 不会写代码，而是它写的代码“只能活在本地”，以及它“总是不听规矩”。</p>
<p>这篇文章主要分享两点实操复盘，希望能帮大家少走点弯路：</p>
<p>1.<strong>让 AI 生成的代码能直接上线：</strong> 大家可能都遇到过，AI 写的代码 Demo 感十足，但一上线就全是安全隐患。我们尝试给 AI 注入底座感知，让它学会用底座原生认证代替脆弱的传参，用安全规则代替接口“裸奔”，解决代码“死在本地”的尴尬。</p>
<p>2.<strong>解决“AI 有 Skill 却不爱用”的毛病：</strong> 最让人头疼的是，明明配好了 Skills，AI 却视而不见，非要凭直觉盲干。我们会分享如何通过“总纲+插件”的结构，配合简单的工程拦截，把 AI 的技能激活率从 20% 硬拉到 84%。</p>
<p>希望能给同样在研究 Skills 和 AI 开发的朋友一点参考，让 AI 交付的代码不再只是“看着挺美”，而是真正稳健。</p>
<h2 data-id="heading-0">现状：Vibe Coding 的 “本地舒适区”</h2>
<p>最近，开发者都在享受 Vibe Coding 的快感。在用户本地的 localhost 一顿操作，UI 漂亮得像成品，但魔法往往在“上线”瞬间戛然而止。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63cf24fcc6514624b10077639f525968~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-RQ2xvdWRCYXNl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193257&amp;x-signature=6nE2NKWl0RdYkURmWAbK3i%2FgySs%3D" alt="图片" loading="lazy"/></p>
<p>AI 的代码逻辑还不错，但它无法感知真实的后端底座，导致生成的“局部最优解”难以落地，无法简单的生成生产级可用的应用。</p>
<p>世界上最遥远的距离，是从 localhost 到真实访问的距离。 AI 填补了代码量的空白，却填补不了工程底座的断层。</p>
<p>有什么办法可以解决这个问题吗？这里就需要提到 Skills。</p>
<h2 data-id="heading-1">什么是 Skills</h2>
<p><strong>Skills 最早是 Anthropic 在 2025 年 10 月给 Claude Code 加的一个功能，它是一套包含指令、脚本和资源的能力包。把专业知识、步骤、代码打包成“技能包”。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/674bdc0d066c481e93186fad984d1ed9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-RQ2xvdWRCYXNl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193257&amp;x-signature=QVA32PyTujgKks6brKSb%2B6rNB3I%3D" alt="图片" loading="lazy"/></p>
<p>Agent Skills 是一种轻量级、开放式的格式，用于通过专业知识和工作流扩展 AI Agent 的能力。</p>
<p>从本质上讲，一个 Skill 就是一个包含 SKILL.md 文件的文件夹。该文件包含元数据（至少包括 name 和 description）以及告诉 Agent 如何执行特定任务的指令。Skills 还可以捆绑脚本、模板和参考材料。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0de8f31f84341e3b8b372cf08448fa1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-RQ2xvdWRCYXNl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193257&amp;x-signature=EkmKnozilcf1OXtw9s7F7DiAqKo%3D" alt="图片" loading="lazy"/></p>
<p>如果把 AI 比作高材生，Skills 就是他的 “岗位操作手册”。它不改变 AI 的智商，但它通过注入程序性知识（Procedural Knowledge），让 AI 知道在你的特定环境下，“正确且高效”的操作标准是什么。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8ac463fe3d142dc8c72934d53cabee6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-RQ2xvdWRCYXNl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193257&amp;x-signature=azoKH8Fl8oPxqewh4%2Ba3eVAC0Ts%3D" alt="图片" loading="lazy"/></p>
<p>Agent Skills 在 2025 年 12 月正式成为开放规范，目前已有包括 Claude、Cursor、VS Code、GitHub Copilot、OpenCode等主流AI开发工具宣布兼容支持。</p>
<h4 data-id="heading-2">Skills 的工作原理：渐进式加载（Progressive Disclosure）</h4>
<p><strong>Skills 通过渐进式加载来高效管理上下文（Context），确保 Agent 在拥有强大能力的同时不会因信息过载而变得迟钝：</strong></p>
<p>1、<strong>Discovery（发现）：</strong> 启动时，Agent 仅加载每个 Skill 的名称和描述。这足以让它在处理请求时，判断哪些 Skill 可能与当前任务相关，而不会耗尽上下文窗口。</p>
<p>2、<strong>Activation（激活）：</strong> 当任务与某个 Skill 的描述匹配时，Agent 才会按需将该 Skill 的完整 SKILL.md 指令读入当前上下文。</p>
<p>3、<strong>Execution（执行）：</strong> Agent 遵循指令执行任务，并根据需要动态加载引用文件或运行捆绑的脚本代码。</p>
<p>这种方法让 Agent 保持极高的响应速度，同时能够像“随身携带百科全书”一样，在需要时立即获取深度专业知识。</p>
<p>行业大佬们已经在行动：</p>
<p>Vercel 发布了 《Introducing: React Best Practices - Vercel》，解决 AI 乱写 React 导致的性能问题，将 React 专家十余年经验你浓缩为最佳实践。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9e195b4f5a34a4f8d57deca17314dd0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-RQ2xvdWRCYXNl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193257&amp;x-signature=mTlLFZpvVMLTAcqk3ElViOUF5ik%3D" alt="图片" loading="lazy"/></p>
<p>Remotion 推出视频制作 Skill，让 AI 学会用代码"剪辑"视频：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9a579527e1e456aa125846a9eb0ee0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-RQ2xvdWRCYXNl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193257&amp;x-signature=qWfxTXAuV6O7tdDr4c1wCiyrrs8%3D" alt="图片" loading="lazy"/></p>
<p>Vercel 推出了 skills 命令来快速安装 Skills 到各个工具中，这是当前热门的 skills 列表。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c598813174e4ec1a6c9987bd8e9cbfe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-RQ2xvdWRCYXNl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193257&amp;x-signature=CJFk5aax9B4hRacTC%2F1%2FvCz280M%3D" alt="图片" loading="lazy"/></p>
<p>这些 Skills 解决的核心问题是：让 AI 拥有特定领域的"工程直觉"。</p>
<p>那么，当你的应用需要落地到云端时，谁来给 AI 注入"后端直觉"？</p>
<h2 data-id="heading-3">CloudBase Skills：把 8 年云端经验打包给 AI</h2>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cdad015ba9f04c23bf1bd19829edd906~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-RQ2xvdWRCYXNl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193257&amp;x-signature=IOMLtxyaWYr6kIOK16XE2V1OqhU%3D" alt="图片" width="50%" loading="lazy"/>
<p><strong>腾讯云开发CloudBase</strong> 作为自 2018 年起就推出 Serverless 服务的团队，也推出CloudBase Skills（GitHub - TencentCloudBase/skills: Production Ready Backend Development （CloudBase）Agent Skills）。</p>
<p><strong>Skills 是软件层面的“岗位手册”，而 CloudBase 则是承载代码落地的“全栈底座”。</strong></p>
<p>许多 AI 生成的代码之所以“死在本地”，是因为 AI 往往只负责写逻辑，却不知道如何对接复杂的生产环境。CloudBase 为 AI 提供了一套高度抽象的基础设施，让 AI 写出的逻辑能无缝运行在公网：</p>
<ul>
<li><strong>全栈托管与部署能力：</strong> 支持前端静态网页与后端逻辑的快速部署，让项目从 localhost 真正变成可访问的在线 URL。</li>
<li><strong>多端原生身份认证：</strong> 打通了 Web、小程序等多种身份源。AI 无需手写复杂的登录逻辑，通过 Skills 直接调用底座的认证能力，实现秒级接入。</li>
<li><strong>数据库底座：</strong> 同时提供文档型（NoSQL）与 SQL 型数据库能力。更重要的是，底座原生集成了面向 C 端的权限控制机制，确保 AI 生成的每一行查询都运行在物理隔离的安全沙箱中，从根源规避越权风险。</li>
</ul>
<p>它将 CloudBase 支撑日均 10 亿次 API 调用、服务超过 330 万开发者的真实经验，翻译成了 AI 听得懂的指令。</p>
<p>举一些 CloudBase Skills 如何为 AI 注入生产级标准的场景：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb877342c4b247e496887f3a7de3deb4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-RQ2xvdWRCYXNl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193257&amp;x-signature=m4hjsuCaPdd1gjzbeula6IyhkpM%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-4">场景一：身份认证——拒绝“相信前端输入”</h4>
<p><strong>错误做法</strong></p>
<p>习惯于让前端通过 userId 传参给后端。</p>
<ul>
<li><strong>风险：</strong> 这是典型的“防君子不防小人”。攻击者只需拦截请求并修改参数，即可实现横向越权，访问任何人的私密数据。</li>
</ul>
<p><strong>正确做法</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9e179a803aa4144a5ca6784004ce434~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-RQ2xvdWRCYXNl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193257&amp;x-signature=e4J7EzbXfb%2Fgg%2F%2BHEuecD6FhQTU%3D" alt="图片" loading="lazy"/></p>
<p>加载 auth-wechat Skill 后，AI 会被强制要求放弃前端传参，转而利用云底座的原生链路。</p>
<p><strong>Before (脆弱逻辑)：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cab1439cee764b3ab01c2368d01ccd4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-RQ2xvdWRCYXNl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193257&amp;x-signature=e5mJruWkz8xkRm406X4d5Rtl%2FHw%3D" alt="图片" loading="lazy"/></p>
<p><strong>After (生产级标准)：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86626a023c3440b78f01c15a6b521d53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-RQ2xvdWRCYXNl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193257&amp;x-signature=wqVFt%2BhC32yzfBL52YRlwx28Nao%3D" alt="图片" loading="lazy"/></p>
<p>工程准则：安全性应由底座的原生互信保证，而非依赖前端输入的自觉。</p>
<h4 data-id="heading-5">场景二：数据安全——从“接口裸奔”到“行权限”</h4>
<p><strong>错误做法</strong></p>
<p>倾向于直接暴露数据库接口。如果你的 API 逻辑稍有疏忽，数据库对攻击者几乎是“裸奔”状态。</p>
<p><strong>正确做法</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fb651a7c9d34b98b7358ed2ed8c06d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-RQ2xvdWRCYXNl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193257&amp;x-signature=4qU1bbaAY1qlJTpuNJOXlQ3Ko0E%3D" alt="图片" loading="lazy"/></p>
<p>Skill 会引导 AI 将权限校验 下沉到数据库入口，直接驱动底座的 安全规则（Security Rules）。</p>
<p><strong>实现改变：</strong> 不再单纯写查询逻辑，而是为集合定义 auth.uid == doc._openid 规则。</p>
<p><strong>价值：</strong> 防御性编程的闭环。 即使业务逻辑代码出现 Bug，底座依然能从物理层面拦截任何非本人数据的越权修改。</p>
<h4 data-id="heading-6">场景三：AI 集成——消灭 Hardcoded，三行代码闭环</h4>
<p><strong>接入大模型是当前最热的需求，但 AI 往往给出的是“Demo 级”的代码，完全忽略了生产环境的安全与高可用要求。</strong></p>
<p><strong>错误做法</strong></p>
<p>将 API Key 硬编码在前端，写出一坨混乱的逻辑来处理流式输出（Streaming），既不安全也不稳定。</p>
<p><strong>正确做法</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/239717220e584bb09c871a9c37daaca3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-RQ2xvdWRCYXNl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193257&amp;x-signature=vAUaxqNf75vgY10kT%2FcVi2yodNg%3D" alt="图片" loading="lazy"/></p>
<p>Skill 注入了生产级 AI 接入规范，将复杂的封装逻辑简化为底层 SDK 的原生调用。</p>
<ul>
<li>
<p>安全加固：Key 自动托管在云端环境变量，前端实现 “零泄露”。</p>
</li>
<li>
<p>几行代码调用 AI 大模型 ，自动处理流式响应。</p>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb5bc71e661a4a1299580249e8fc1007~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-RQ2xvdWRCYXNl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193257&amp;x-signature=qJ5Z1GP3et%2F8LuCXdIwOfUQIT3Q%3D" alt="图片" loading="lazy"/></p>
<p><strong>核心价值</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58a7c7fa99cc47efbdcbb5edd62cfaf6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-RQ2xvdWRCYXNl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193257&amp;x-signature=YZYBq4Rowhk272HIjPEO1HE%2Fc4M%3D" alt="图片" loading="lazy"/></p>
<p>AI 提供了逻辑的上限，而 CloudBase Skills 守住了工程的下限。</p>
<h2 data-id="heading-7">实战：安装 CloudBase Skills</h2>
<p><strong>在你的终端输入以下命令，为你的 AI 助手注入“生产级直觉”：</strong></p>
<p>即可安装我们提供的多个 Skills 到你的开发工具中。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df04e6c1a3074d49bdf5563bb871f268~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-RQ2xvdWRCYXNl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193257&amp;x-signature=4kfh9i%2Bqc08VhJafyqAckf8tX2g%3D" alt="图片" loading="lazy"/></p>
<p><strong>CloudBase Skills 完整列表</strong></p>
<p>我们将 Skills 按照实际开发中的职能进行了归类，确保 AI 在不同环境下调用正确的 SDK 和工具。</p>
<p>这种分类不仅是为了方便开发者查阅，更是为了在 Discovery（发现阶段）降低 AI 的认知负荷，实现精准的按需挂载。</p>
<p><strong>核心理念：环境即边界（Environment as Boundary）</strong></p>
<p>在展开列表前，我们需要阐述这套架构的底层设计：总纲路由，三端隔离。</p>
<ul>
<li>
<p>物理隔离：Web、小程序、Node.js 的同名方法逻辑各异。我们将它们拆分为独立插件，从物理层面杜绝 AI 在小程序里写出 Web SDK 语法的语义污染。</p>
</li>
<li>
<p>总纲引导：cloudbase-guidelines 是所有任务的默认入口。它像一个语义路由器，先判定项目环境，再指引 AI 激活对应的子 Skill。</p>
</li>
</ul>
<p><strong>完整技能矩阵</strong></p>
















































































<table><thead><tr><th>分类</th><th>核心 Skills</th><th>核心职能与实战要点</th></tr></thead><tbody><tr><td>必读总纲</td><td>cloudbase-guidelines</td><td>全局入口。判定 Web/小程序/后端环境，负责架构导航与全局防错规矩。</td></tr><tr><td>AI 扩展</td><td>ai-model-nodejs</td><td>服务端专用。支持文本、流式及图像生成。唯一支持 Node SDK 3.16.0+ 图像能力的 Skill。</td></tr><tr><td> </td><td>ai-model-web / -wechat</td><td>前端专用。分别适配浏览器与小程序环境。注意小程序端 API 不同，且不支持图像生成。</td></tr><tr><td>身份鉴权</td><td>auth-nodejs / -web / -wechat</td><td>三端隔离。解决 Web 端的登录、小程序原生身份以及服务端的自定义 Ticket 逻辑。</td></tr><tr><td> </td><td>auth-tool</td><td>MCP 专用。通过 callCloudApi 直接配置短信、匿名、第三方登录等后台开关。</td></tr><tr><td>数据库</td><td>no-sql-web-sdk / -wx-mp-sdk</td><td>文档数据库。适配 Web 与小程序 SDK 的查询、创建、更新、删除及地理位置查询。</td></tr><tr><td> </td><td>relational-database-tool</td><td>关系型数据库。AI 专用 SQL 执行工具，内置生产数据保护机制，严禁裸写 SQL。</td></tr><tr><td> </td><td>relational-database-web</td><td>SQL-on-Web。前端通过 SDK 访问关系型数据库的标准初始化与查询模式。</td></tr><tr><td>计算与存储</td><td>cloud-functions</td><td>Serverless 核心。涵盖运行时选择、部署、日志、异步调用与 HTTP 访问配置。</td></tr><tr><td> </td><td>cloudrun-development</td><td>容器化模式。针对长连接、多语言或 AI Agent 需要的容器云环境开发规范。</td></tr><tr><td> </td><td>cloud-storage-web</td><td>文件管理。Web 环境下的上传、下载、临时链接生成及文件管理最佳实践。</td></tr><tr><td>研发流与 UI</td><td>spec-workflow</td><td>工程标准化。从需求分析到技术设计的标准 SOP，提升复杂项目的确定性。</td></tr><tr><td> </td><td>ui-design</td><td>审美基准。提供生产级的组件设计建议与 UI 规范，确保前端界面具备专业视觉品质。</td></tr><tr><td> </td><td>web / miniprogram</td><td>平台规则。针对 Web 静态托管或小程序开发（含企业微信、wx.cloud 模式）的专项规则。</td></tr></tbody></table>
<h2 data-id="heading-8">MCP vs Skills</h2>
<p>在构建 AI 原生开发生态的道路上，我们始终坚持“先打通，再优化”的逻辑。</p>
<p><strong>CloudBase MCP：早已就绪的“工程双手”</strong></p>
<p>事实上，云开发 CloudBase 在 2025 年上半年的时候就推出了 CloudBase MCP。作为 Anthropic 推出的行业标准协议，MCP 解决的是“连接”问题。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/20c89f1bfecd4bb3a2480fe78e0ab571~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-RQ2xvdWRCYXNl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193257&amp;x-signature=FTT75UOvhyW4S62e3cjjUsX0MVs%3D" alt="图片" loading="lazy"/></p>
<p>通过 MCP，我们让 AI 助手真正拥有了操作腾讯云底座的结构化权限。它不再只是在对话框里写代码，而是能直接查询云端状态、创建资源、拉取日志。目前，CloudBase MCP 已经支持了包括 Cursor、Claude Desktop、VS Code 在内的多种主流工具，帮助大量开发者实现了 AI 与云端的物理连接。 </p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7b682201d8e48168b3bc406067c9bab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-RQ2xvdWRCYXNl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193257&amp;x-signature=GEFPQ1cjEMQBGxfbTDcyWgOKR1k%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-9">CloudBase Skills：后发制人的“岗位手册”</h4>
<p>既然有了 MCP 这双强有力的“手”，为什么我们还要推出 Skills？</p>
<p>如果说 MCP 是让 AI “有权限”干活，那么 Skills 就是让 AI “懂规矩”干活。</p>
<p>在我们的规划中，Skills 是更上层的能力封装：</p>
<ul>
<li>
<p><strong>不仅仅是脚本：</strong> 虽然 Skills 规范支持包含脚本（Scripts），但我们现阶段更侧重于“程序性知识（Procedural Knowledge）”的注入。</p>
</li>
<li>
<p><strong>更安全、更通用的专家直觉：</strong> 正如前文提到的，AI 有了 MCP 虽然能执行脚本，但在云端生产环境，盲目执行脚本不仅不安全，也不符合工程规范。Skills 则是把我们 8 年的云端填坑经验（如行权限隔离、原生上下文认证）变成 AI 的直觉。</p>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6daf24d57ba049de99e236db5a39a928~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-RQ2xvdWRCYXNl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193257&amp;x-signature=Rxrd0EJAFM7cVl9t8ui9wtaa1Ho%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-10">为什么它们是黄金组合？</h2>
<p>你可以单独使用其中之一，但组合使用才是 AI 编程的“终极形态”：</p>
<p>“MCP 提供了标准化的安全连接，而 Skills 提供了生产级的工程直觉。”</p>
<p>两者搭配，让 AI 从一个 “力气大但鲁莽的实习生” ，真正进化为一个 <strong>“懂规矩、有权限”</strong> 的资深云开发专家。</p>
<h2 data-id="heading-11">实战案例</h2>
<p><strong>CodeBuddy IDE 中已经内置了 CloudBase MCP 和 Skills，在连接 CloudBase 之后会自动下载 Skills 到你项目中。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0bfefcbbc000422ea019d096747b598f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-RQ2xvdWRCYXNl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193257&amp;x-signature=FkFQ3kA4GsOuGzj5Iogry%2FUgmFU%3D" alt="图片" loading="lazy"/></p>
<p>这里有一篇教程,教你用免费云开发资源与混元Token，手把手教你用 AI 来开发一个 AI 小程序。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fdeveloper%2Farticle%2F2615984" target="_blank" title="https://cloud.tencent.com/developer/article/2615984" ref="nofollow noopener noreferrer">微信小程序送补贴！手把手教你薅免费云开发资源+混元Token（附使用教程）</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5feca14773ca4b89bd0f521468021cfc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-RQ2xvdWRCYXNl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193257&amp;x-signature=dc6ZQyIk2f852BBpDBFoikMyL0o%3D" alt="图片" loading="lazy"/></p>
<p>还可以查看更多入门视频教程和文章。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35a6e10397084f65bcae3c13b8531477~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-RQ2xvdWRCYXNl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193257&amp;x-signature=FOYBU7zroXMr2nhapAuvI3q5KFs%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-12">终章：Skills 落地踩坑与实战复盘</h2>
<p><strong>在做这套 Skills 的过程中，我们最大的感触是：现在的 AI 编程，其实处于一个“高智商、低纪律”的阶段。 别看各大工具都号称支持 Skills，真用起来全是坑。</strong></p>
<p>以下是几个我们里跟 AI “斗智斗勇”换来的经验教训：</p>
<h4 data-id="heading-13">1. 现状：AI 为什么会“装死”？</h4>
<p>明明配了 Skill，AI 还是视而不见。这背后的原因其实涉及大模型的两个底层逻辑：</p>
<ul>
<li><strong>注意力权重（Attention Bias）：</strong> 在大模型的 Transformer 架构中，它会根据你的 Prompt 实时计算每个词的权重。当你聊得越深，你提的业务需求权重就会越高，而作为背景板的外部 Skills 权重就会被“稀释”。</li>
<li><strong>决策惰性（Inference Laziness）：</strong> 调用 Skill 本质上是一次 Tool Use（工具调用）。模型在推理时会进行“路径评估”：如果它觉得自己脑子里的预训练数据（通常是 Localhost 模式）就能生成一段“看起来正确”的代码，它就会为了节省推理资源而跳过外部工具调用。</li>
<li><strong>激活率落差：</strong> 在我们的回归测试中，如果不加干预，AI 的主动调用率只有20%左右。它宁愿“盲目裸奔”，也不愿意翻书。</li>
</ul>
<h4 data-id="heading-14">2. “驯服” AI 的两套硬核解法</h4>
<p>既然 AI 会产生决策惰性，我们就得用工程手段拉高它的“警觉性”。</p>
<h5 data-id="heading-15">方案 A：最土但最稳的“首行注入”</h5>
<p>如果你的项目不容许犯错，就在提问的最开头带上这句“咒语”：</p>
<p>You MUST read the cloudbase-guidelines skill FIRST when working with CloudBase projects.</p>
<ul>
<li>原理：利用 首因效应（Primacy Effect）。模型对输入序列最前端的信息具有天然的高关注度。通过这种强行注入，能把 Skill 的激活率拉升。</li>
</ul>
<p>强烈建议大家在试用过程中也带上这句 Prompt，或者按照方案 B 来执行。</p>
<h5 data-id="heading-16">方案 B：项目级的“家法” (System Rules)</h5>
<p>在项目根目录创建 <strong>CLAUDE.md</strong> 或 <strong>AGENT.md</strong>，增加项目级别的约束规则。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74e3892d62ac42b3b7f3da3a02f83d4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-RQ2xvdWRCYXNl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193257&amp;x-signature=OLv8rRFyJv5gbry%2Fx7jTcYGjkEU%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-17">方案 C：自动化“强制拦截” (Forced Eval Hook)</h4>
<p>如果说前两个方案是靠“嘴”叮嘱 AI，那方案 3 就是靠“物理拦截”</p>
<p>技术专家 Scott Spence 在他的实测中发现，最有效的方式是利用编辑器的 Hook（钩子）机制。</p>
<ul>
<li>
<p><strong>它的本质是“中间件”：</strong> 这不再是你手动输入的 Prompt。通过配置（如 .claude/settings.json），脚本会在你按下回车的那一刻，自动拦截并“魔改”你的问题。</p>
</li>
<li>
<p><strong>强制“表态”才能“干活”：</strong> 这个钩子会强制 AI 在输出任何代码前，必须先生成一段 评估报告。AI 必须逐一陈述：“当前有哪些 Skill 可用？针对这个需求，我需不需要调用它们？理由是什么？”</p>
</li>
<li>
<p><strong>消除“决策惰性”：</strong> AI 有个毛病，只要它觉得脑子里的旧数据能糊弄过去，它就不会翻书。但这种 Hook 强迫 AI 必须白纸黑字写下“我要用这个工具”，一旦它在开头表了态，后面的代码生成就会严格遵守这个承诺。</p>
</li>
<li>
<p><strong>激活率的质变：</strong> 根据 Scott 的数据，这种“拦截+评估”的手段能将激活率从 20% 暴力拉升到 84%</p>
</li>
</ul>
<h4 data-id="heading-18">3. 架构复盘：为什么必须是“总纲 + 独立插件”？</h4>
<p>在开发过程中，我们发现 AI 最大的毛病是“端不分”。它分不清小程序、Web 和 Node.js 的环境边界。我们没有搞一个“全家桶” Skill，而是采用了 “1 个总纲 (Guidelines) Skill + 21 个独立 Skill” 的分布式架构。</p>
<p>这背后有三个核心逻辑：</p>
<h5 data-id="heading-19">A. 解决“语义污染”与环境误判</h5>
<p>Web、小程序、Node.js 的 SDK 方法名极其相似（如都有 init, callFunction）。</p>
<ul>
<li>
<p>痛点：如果全塞进一个 Skill，AI 经常在写小程序逻辑时，顺手掏出 Web 端的语法。这种语义污染是造成代码无法上线的元凶。</p>
</li>
<li>
<p>解法：我们将 Skill 按端进行物理拆分。配合 cloudbase-guidelines 这种 “入口点” (Entry Point) ，先指挥 AI 判定项目环境（如：识别到 app.json 即为小程序）。</p>
</li>
<li>
<p>收益：环境判定后，AI 只会加载相关的子 Skill。这把干扰项直接屏蔽掉，搜索空间缩小了 90%，推理精度自然大幅提升。</p>
</li>
</ul>
<h5 data-id="heading-20">B. 开发者可以“精准点菜”</h5>
<ul>
<li>痛点：全能包（单体架构）太重。当你想让 AI 专门解决“微信支付”或“安全规则”这种特定问题时，AI 的注意力会被庞大的全量手册稀释。</li>
<li>解法：独立插件支持局部强化。你可以直接下令：“调用 auth-web 检查实现手机号登录”。</li>
<li>收益：这种设计允许开发者直接干预 AI 的决策路径。在 AI 逻辑混乱时，通过唤起特定子 Skill 强行把它的思维拉回到正确的窄道上。</li>
</ul>
<h2 data-id="heading-21">未来规划</h2>
<p><strong>我们将持续推出：</strong></p>
<ul>
<li>
<p>小程序集成微信支付集成技能</p>
</li>
<li>
<p>小程序集成虚拟支付技能</p>
</li>
<li>
<p>小游戏集成云开发技能</p>
</li>
<li>
<p>云函数部署全栈后端应用技能</p>
</li>
<li>
<p>更多全栈应用开发模板和技能等</p>
</li>
</ul>
<p>欢迎访问：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTencentCloudBase%2FSkills" target="_blank" title="https://github.com/TencentCloudBase/Skills" ref="nofollow noopener noreferrer">github.com/TencentClou…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTencentCloudBase%2FCloudBase-MCP" target="_blank" title="https://github.com/TencentCloudBase/CloudBase-MCP" ref="nofollow noopener noreferrer">github.com/TencentClou…</a></p>
<h2 data-id="heading-22">写在最后：从“代码生成”到“生产级交付”的跨越</h2>
<p>折腾了这么多 Skills 之后，我们最大的感触是：AI 编程的生产力，不取决于模型能写出多么精妙的逻辑，而取决于你对它生成的代码具备多少“工程约束力”。</p>
<h4 data-id="heading-23">1. 核心本质：将“隐性经验”转化为“程序性知识”</h4>
<p>目前的 Agent 依然处于“高智商、零经验”的状态，它们是博学的“实习生”，却对真实的物理底座缺乏敬畏。</p>
<p>CloudBase Skills 的本质，是给 AI 注入一套工程化的“肌肉记忆”。 通过 guidelines 的语义导航和原子 Skill 的强约束，我们将云开发八年来沉淀的填坑经验（如行权限隔离、多端原生上下文、高并发限流）转化为了 AI 的前置判定条件。这种程序性知识（Procedural Knowledge）的注入，让 AI 真正理解了“正确且安全”的交付标准。</p>
<h4 data-id="heading-24">2. 范式转换：Agent 必须具备“环境感知力”</h4>
<p>Agent 进化的下一站，不仅仅是 Reasoning（推理）的增强，更是对 Infrastructure（基础设施）感知力的补齐。</p>
<ul>
<li>
<p>Skills 守住工程下限：它是一套“防呆协议”。通过场景化工作流和报错锚点，强制 AI 在编写阶段就化解鉴权漏洞和多端环境差异，彻底终结“代码只活在 localhost”的幻觉。</p>
</li>
<li>
<p>CloudBase 承载逻辑上限：作为全栈底座，它让 AI 的逻辑输出不再是网页里的文本，而是能直接部署、调通、并产生真实业务价值的生产级资源。</p>
</li>
</ul>
<h4 data-id="heading-25">3. 确定性是 AI 开发的唯一度量衡</h4>
<p>我们不应该期待 AI 自动变得“完美”，而应该通过工程手段让它变得“稳定”。</p>
<p>AI 提供逻辑的上限，Skills 守住工程的下限，而 CloudBase 则是承载这一切的物理底座。</p>
<p>我们正处于从“氛围感编程 (Vibe Coding)”向“生产级交付”跨越的节点。如果你也厌倦了在对话框里修Bug，欢迎安装 CloudBase Skills。给你的 AI 立个规矩，让它真正从一个“聊天搭子”进化为能帮你上线产品的“资深合伙人”。</p>
<p>如有问题或建议，欢迎在评论区交流。</p>
<h2 data-id="heading-26">立即开始！</h2>
<p>在你的终端输入以下命令，为你的 AI 助手注入“生产级直觉”： </p>
<p><code>npx skills add tencentcloudbase/skills</code></p>
<h2 data-id="heading-27">【名词解释】</h2>
<ul>
<li>
<p>Vibe Coding：一种依赖 AI 直觉、快速生成原型但缺乏工程严谨性的编程方式。</p>
</li>
<li>
<p>Procedural Knowledge：程序性知识。指关于“如何操作”的知识，让 AI 掌握特定场景下的标准作业流程（SOP）。</p>
</li>
<li>
<p>MCP：模型上下文协议。AI 的“连接器”，让其能直接操作数据库、文件系统或云资源。</p>
</li>
<li>
<p>Agent Skills：能力插件包。AI 的“专家手册”，注入特定领域的最佳实践和工程规范。</p>
</li>
<li>
<p>横向越权：安全漏洞。指攻击者通过篡改 ID 等参数，非法访问到同级别其他用户的数据。</p>
</li>
<li>
<p>安全规则：底座级权限控制。在数据库入口处强制执行访问校验，是防御越权的核心手段。</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI编程实践：从Claude Code实践到团队协作的优化思考｜得物技术]]></title>    <link>https://juejin.cn/post/7599828354514567208</link>    <guid>https://juejin.cn/post/7599828354514567208</guid>    <pubDate>2026-01-27T06:35:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599828354514567208" data-draft-id="7599585289947463743" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI编程实践：从Claude Code实践到团队协作的优化思考｜得物技术"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2026-01-27T06:35:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="得物技术"/> <meta itemprop="url" content="https://juejin.cn/user/2392954206960247"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI编程实践：从Claude Code实践到团队协作的优化思考｜得物技术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392954206960247/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    得物技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T06:35:02.000Z" title="Tue Jan 27 2026 06:35:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读34分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、开发痛点：为什么我们需要AI编程辅助？</h2>
<p><strong>核心发现：</strong> AI编程工具正在重塑开发流程，但真正的价值不在于替代开发者，而在于构建人机协作的新型开发范式。Claude Code通过精准对话流设计、模块化任务分解和专业化子代理协作，在提升开发效率的同时，也面临着上下文管理、协作边界和质量控制等实际挑战。</p>
<p>作为一线开发者，我们每天都在与复杂的业务逻辑和不断迭代的技术栈打交道。不知道你是否也遇到过这些场景：刚理清一个复杂业务流程，被打断后又得重新梳理思路；接手一个老项目，花了半天还没搞懂其中某个模块的设计思路；或者在不同项目间切换时，总要重新适应不同的编码规范和架构风格。</p>
<p><strong>日常开发的三个"拦路虎"：</strong></p>
<ul>
<li><strong>上下文切换成本高：</strong> 需求理解→技术选型→代码实现→质量验证的切换过程中，每次都要重新构建认知框架。</li>
<li><strong>知识传递效率低：</strong> 项目规范、架构经验分散在文档和个人经验中，新成员上手或跨模块开发时处处碰壁。</li>
<li><strong>开发流程割裂：</strong> 需求→设计→编码→审查各环节串行传递，信息易失真且反馈滞后。</li>
</ul>
<p>这些问题不是简单的"加人"或"加班"能解决的。我们需要的是一种新的开发范式，而Claude Code这类AI编程工具正是在这样的背景下进入了我们的视野。它的价值不在于替我们写代码，而在于成为我们的"认知放大器"和"流程协作者"。</p>
<h2 data-id="heading-1">二、Claude Code核心功能解析：从工具到方法论</h2>
<p>Claude Code构建了一套完整的AI辅助开发方法论。接下来将结合团队实际使用经验，从功能特性、使用场景和设计初衷三个维度，详细介绍其核心功能：</p>
<h3 data-id="heading-2">精准对话流设计：控制AI思考的艺术</h3>
<p>第一次用Claude Code时，就像面对一个热情但经验不足的实习生——如果不明确告诉他要做什么、怎么做、有什么要求，他很可能会给你一个"惊喜"。对话流设计就是解决这个问题的关键。</p>
<p><strong>设计初衷：</strong> 对话流设计的本质是将人类的编程思维模式转化为AI可理解的结构化交互方式，通过明确的上下文管理和约束条件设置，引导AI生成符合预期的代码结果。</p>
<p><strong>核心功能</strong></p>
<p>对话流设计通过三个关键机制控制AI的思考过程：</p>
<ul>
<li><strong>上下文聚焦：</strong> 要求单次对话仅处理一个功能模块，避免多任务混合导致的AI注意力分散。我们曾经试过在一个对话里同时让AI处理多个模块，结果它把两个模块的错误处理逻辑混在了一起。</li>
<li><strong>约束明确化：</strong> 通过具体指令减少AI的自由度，比如"仅修改X包下文件"、"必须复用Y工具类"。这些约束要尽可能具体，比如不说"遵循项目规范"，而是说"使用ResultDTO作为统一返回格式，错误码规则参考ErrorCodeEnum"。</li>
<li><strong>增量式提问：</strong> 采用"先框架后细节"的提问策略，先让AI生成接口定义和整体框架，待确认后再逐步深入实现细节。这种方式很像我们带新人时"先搭骨架再填肉"的指导方法。</li>
</ul>
<p><strong>使用心法</strong></p>
<p>启动新功能开发时，我们会创建专用对话线程，并在初始prompt中明确四件事：</p>
<ol>
<li>当前任务的功能边界和目标（做什么，不做什么。）</li>
<li>必须遵守的技术约束和规范（用什么技术栈，遵循什么标准。）</li>
<li>期望的输出格式和交付物（要代码？要文档？还是两者都要？）</li>
<li>分阶段的实现计划（先设计接口，再实现逻辑，最后写测试。）</li>
</ol>
<p><strong>真实踩坑经验</strong></p>
<p>处理跨模块依赖时，我们发现AI很容易"忘记"之前设定的约束。后来我们总结出一个技巧：每开始一个新的实现阶段，就简要回顾一下关键约束。比如："现在我们要处理任务交接流程，请记得：1. 使用Redis分布式锁；2. 需要修改商运关系和新商成长任务；3. 异常处理要符合规范。"</p>
<h3 data-id="heading-3">Plan模式：复杂任务的系统化分解</h3>
<p>面对"实现一个完整的拜访任务系统"这样的复杂需求，直接让AI生成代码就像让一个刚入行的开发者独立负责整个项目——结果往往是逻辑混乱、漏洞百出。Plan模式就是解决这个问题的"项目管理工具"。</p>
<p>现状与问题：我们早期使用Claude Code时，经常犯一个错误：把一个复杂需求一股脑丢给AI，然后期待它给出完美解决方案。结果通常是：</p>
<ul>
<li>实现逻辑不完整，有些边界情况根本没考虑到。</li>
<li>模块间接口设计不一致，调用起来磕磕绊绊。</li>
<li>技术选型不合理，用了个"看起来很酷但项目中并不适用"的方案。</li>
</ul>
<p>这其实不能怪AI，人在面对过于复杂的问题时也会手足无措。我们需要一种方法把大问题拆分成小问题，而Plan模式正是借鉴了项目管理中的WBS（工作分解结构）思想。</p>
<p>我们的解决方案：Plan模式使用三步法分解需求：</p>
<ol>
<li>需求分析与模块划分：把整体需求分解为独立的功能模块。</li>
<li>技术方案设计：为每个模块确定实现思路和技术选型。</li>
<li>任务优先级排序：根据依赖关系和重要性确定实现顺序。</li>
</ol>
<p><strong>实际操作示例：拜访任务需求</strong></p>
<p>拜访任务是一个简单的企业内部任务需求，在实现"拜访任务需求"时，我们通过Plan模式生成的任务清单是这样的：</p>
<pre><code class="hljs language-markdown" lang="markdown">---
拜访任务线上化 - 模块清单
M1: 任务创建模块
<span class="hljs-bullet">-</span> 功能: 创建拜访任务,包含基本信息、拜访对象、参与人员
<span class="hljs-bullet">-</span> 复杂度: Medium (需要处理多表关联和事务)
M2: 任务审批模块
<span class="hljs-bullet">-</span> 功能: 飞书审批流程集成,支持任务提交、审批、驳回
<span class="hljs-bullet">-</span> 复杂度: High (涉及飞书审批接口集成和状态流转)
M3: 日程同步模块
<span class="hljs-bullet">-</span> 功能: 将拜访任务同步到飞书日历
<span class="hljs-bullet">-</span> 复杂度: Medium (飞书API调用和异常处理)
M4: 任务列表查询模块
<span class="hljs-bullet">-</span> 功能: 分页查询任务列表,支持多维度筛选
<span class="hljs-bullet">-</span> 复杂度: Medium (ES聚合查询和数据转换)
M5: 任务详情查询模块
<span class="hljs-bullet">-</span> 功能: 查询任务详情,包括拜访对象、参与人员、商家信息
<span class="hljs-bullet">-</span> 复杂度: Low (简单的关联查询)
M6: 任务统计模块
<span class="hljs-bullet">-</span> 功能: 统计不同类型、不同状态的任务数量
<span class="hljs-bullet">-</span> 复杂度: Low (聚合统计)
M7: 拜访结果提交模块
<span class="hljs-bullet">-</span> 功能: 提交拜访记录,上传附件,记录拜访内容
<span class="hljs-bullet">-</span> 复杂度: Medium (文件上传和多表操作)
M8: 任务分配模块
<span class="hljs-bullet">-</span> 功能: 批量分配任务给运营人员
<span class="hljs-bullet">-</span> 复杂度: High (涉及分配策略和定时任务)
M9: 任务触达模块
<span class="hljs-bullet">-</span> 功能: 任务开始、结束、上传提醒通知
<span class="hljs-bullet">-</span> 复杂度: Medium (飞书消息卡片模板)
M10: ES数据同步模块
<span class="hljs-bullet">-</span> 功能: 将任务数据同步到ES,支持全文检索
<span class="hljs-bullet">-</span> 复杂度: Medium (事件驱动和ES批量操作)
M11: 任务导入模块
<span class="hljs-bullet">-</span> 功能: Excel批量导入拜访任务
<span class="hljs-bullet">-</span> 复杂度: High (Excel解析、数据校验、批量插入)
M12: 任务状态变更模块
<span class="hljs-bullet">-</span> 功能: 定时更新任务状态(未开始→进行中→已结束)
<span class="hljs-section">- 复杂度: Low (定时任务和批量更新)
---</span>
第二步:技术方案设计
| 模块       | 数据存储               | 查询方案         | 外部集成          |
|------------|------------------------|------------------|-------------------|
| M1-任务创建  | MySQL (事务)           | -                | -                 |
| M2-任务审批  | MySQL + 审批记录表      | -                | 飞书审批API       |
| M3-日程同步  | -                      | -                | 飞书日历API       |
| M4-任务列表  | ES (主) + MySQL (辅)   | ES聚合查询       | -                 |
| M5-任务详情  | MySQL                  | 联表查询         | 商家信息API |
| M6-任务统计  | ES                     | ES聚合统计       | -                 |
| M7-结果提交  | MySQL + OSS            | -                | OSS文件上传       |
| M8-任务分配  | MySQL                  | 分配算法         | -                 |
| M9-任务触达  | -                      | -                | 飞书消息卡片      |
| M10-ES同步  | ES                     | Spring Event     | -                 |
| M11-任务导入 | MySQL                  | Excel 解析    | -                 |
<span class="hljs-section">| M12-状态变更 | MySQL                  | JOB定时任务  | -                 |
---</span>
第三步:任务优先级排序
P0 核心流程(必须先实现)
<span class="hljs-bullet">1.</span> M1-任务创建 (基础功能)
<span class="hljs-bullet">2.</span> M5-任务详情 (数据展示)
<span class="hljs-bullet">3.</span> M4-任务列表 (核心查询)
<span class="hljs-bullet">4.</span> M7-结果提交 (闭环流程)
P1 审批与通知(核心功能增强)
<span class="hljs-bullet">5.</span> M2-任务审批 (依赖M1)
<span class="hljs-bullet">6.</span> M3-日程同步 (依赖M2审批通过)
<span class="hljs-bullet">7.</span> M9-任务触达 (依赖M1、M7)
P2 运营功能(效率提升)
<span class="hljs-bullet">8.</span> M8-任务分配 (依赖M1)
<span class="hljs-bullet">9.</span> M11-任务导入 (依赖M1)
<span class="hljs-bullet">10.</span> M6-任务统计 (依赖M4)
P3 技术优化(性能优化)
<span class="hljs-bullet">11.</span> M10-ES同步 (依赖M1、M4)
<span class="hljs-section">12. M12-状态变更 (独立模块)
---</span>
实现建议
阶段一:基础能力
<span class="hljs-bullet">-</span> 先实现 M1、M5、M4,打通任务创建→查询→详情的基本链路
<span class="hljs-bullet">-</span> 使用 MySQL 实现,暂不接入 ES
阶段二:审批流程
<span class="hljs-bullet">-</span> 实现 M2、M3,接入飞书审批和日历
<span class="hljs-bullet">-</span> 完成任务的完整生命周期管理
阶段三:结果闭环
<span class="hljs-bullet">-</span> 实现 M7,完成拜访结果提交
<span class="hljs-bullet">-</span> 实现 M9,添加任务触达通知
阶段四:运营优化
<span class="hljs-bullet">-</span> 实现 M8、M11、M6
<span class="hljs-bullet">-</span> 提升运营效率
阶段五:性能优化(按需)
<span class="hljs-bullet">-</span> 实现 M10,将查询迁移到 ES
<span class="hljs-bullet">-</span> 实现 M12,优化任务状态管理
</code></pre>
<p>这种方式不仅让AI能够有序工作，也让我们对整个开发进度有了更清晰的把控。</p>
<h3 data-id="heading-4">系统提示词：给AI立"规矩"的艺术</h3>
<p>如果把Claude Code比作一个新加入团队的开发人员，系统提示词（CLAUDE.md）就相当于给他的"入职手册"，告诉他团队的编码规范、工作流程和注意事项。</p>
<p><strong>新手常犯的错误：</strong> 把系统提示词写成"百科全书"，恨不得把所有项目知识都塞进去。结果AI要么忽略大部分内容，要么在生成代码时顾此失彼。我们早期的系统提示词长达5000字，包含了从架构设计到代码规范的所有内容，效果反而不好。</p>
<p>实践心得：有效的系统提示词应该像"护栏"而非"详尽手册"。我们发现，针对AI常见错误模式设计的针对性提示，远比全面但泛泛的规范更有效。现在我们的系统提示词控制在200字以内，只包含最关键的约束和指引。</p>
<p><strong>系统提示词模板</strong></p>
<p>经过多次迭代，我们总结出包含三个关键模块的系统提示词结构：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dcfb46a8554a4e3b99674a70bddcce98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770100504&amp;x-signature=F70JOAjQjsUfgoi9aEx8lOmbys0%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>使用技巧</strong></p>
<p>分享几个在实践中总结的系统提示词编写技巧：</p>
<ul>
<li><strong>避免信息过载：</strong> 不要试图包含所有知识，而是指引AI在需要时查询特定文档。例如："遇到分布式事务问题时，请参考/doc/分布式事务最佳实践.md文档中的TCC模式实现方案"。</li>
<li><strong>提供正向引导：</strong> 不仅说"不要做什么"，更要明确"应该怎么做"。例如，不说"不要使用过时的API"，而说"请使用OrderServiceV2替代OrderServiceV1。</li>
<li><strong>动态调整策略：</strong> 我们每两周会回顾一次系统提示词的有效性，根据AI最近常犯的错误补充新的约束。比如发现AI经常忘记处理空指针，就新增一条："所有方法入参必须进行非空校验，使用ValidateUtil.isEmpty()方法，异常时抛出IllegalArgumentException"。</li>
</ul>
<h3 data-id="heading-5">SKILL与MCP：知识沉淀与外部能力扩展</h3>
<p>在团队协作中，我们经常说"不要重复造轮子"。同样，在使用Claude Code时，我们也需要一种机制来沉淀和复用那些有效的Prompt和解决方案——这就是SKILL和MCP机制的价值所在。</p>
<p><strong>SKILL机制：</strong> 把好经验变成"可复用组件"</p>
<p>SKILL本质上是将单次生效的Prompt指令沉淀为可反复调用的标准化复用资产。举个例子，我们团队处理"ES数据查询"逻辑时，总结出了一个内部版本的SDK。我们把这个SDK的调用方式封装成一个SKILL，以后遇到类似场景，只需调用这个SKILL，AI就能按照我们团队的最佳实践来实现。</p>
<p><strong>MCP协议：</strong> 让AI能"调用"外部工具</p>
<p>MCP（模型上下文协议）解决了AI与外部工具、数据源的连接问题。通过MCP，AI不再局限于静态知识，而是能够动态访问实时数据。我们集成了飞书MCP服务器，让AI能够直接操作飞书平台，如自动生成技术方案文档、读取PRD需求、同步数据到多维表格等。</p>
<p><strong>最适合封装为SKILL的场景</strong></p>
<p>1.<strong>复杂工具使用指南：</strong> 如"ElasticSearch接入"、"Redis缓存更新策略"等需要特定知识的场景。</p>
<p>2.<strong>常见错误处理模板：</strong> 如"分布式锁冲突处理"、"数据库乐观锁重试机制"等反复出现的问题解决方案。</p>
<p><strong>MCP协议的典型应用场景</strong></p>
<ul>
<li><strong>场景1: 自动生成技术方案文档</strong></li>
<li>AI分析需求后，通过飞书MCP调用feishu_create_doc；</li>
<li>直接在指定的知识库目录创建格式化的技术方案文档；</li>
<li>省去手动复制粘贴的繁琐步骤。</li>
</ul>

<ul>
<li><strong>场景2: 读取PRD需求</strong></li>
<li>用户提供飞书文档链接；</li>
<li>AI通过feishu_get_doc_content获取文档内容；</li>
<li>基于完整需求信息生成技术方案和实现计划。</li>
</ul>

<ul>
<li><strong>场景3: 数据同步到多维表格</strong></li>
<li>代码生成后的统计数据(如代码行数、涉及文件等)；</li>
<li>通过feishu_append_bitable_data自动追加到飞书多维表格；</li>
<li>便于团队追踪AI编程效率指标。</li>
</ul>
<h2 data-id="heading-6">三、对话流设计方法论：让AI"懂"你的真实需求</h2>
<p>刚接触Claude Code时，我们采用的是简单直接的"需求-响应"模式：开发者描述需求，AI生成代码，开发者修改调整。这种模式在处理简单功能时还行，但遇到复杂场景就会出问题。</p>
<h3 data-id="heading-7">现状分析：传统对话模式的局限性</h3>
<p>我们早期在项目中踩过的三个坑：</p>
<p><strong>三大典型问题：</strong></p>
<ul>
<li><strong>需求表达不完整：</strong></li>
</ul>
<p>开发者说"实现一个商家信息查询接口"，AI生成了基础的CRUD代码，但没有考虑商家数据权限、数据脱敏、缓存策略等实际业务需求 ；</p>
<p>实现任务时，只描述了"需要任务分配功能"，结果AI生成的代码没有处理任务池、任务优先级、分配策略等核心逻辑。</p>
<ul>
<li><strong>上下文管理混乱：</strong></li>
</ul>
<p>一个对话持续了十几轮后，AI开始忘记我们前面确定的"使用MyBatis-Plus + BaseMapper"的设计决策，擅自改成了JPA Repository模式； </p>
<p>在实现相关功能时，早期确定的DTO转换规范在后续模块中被遗忘，导致代码风格不一致。</p>
<ul>
<li><strong>迭代反馈滞后：</strong></li>
</ul>
<p>等AI生成完整的Service + Controller + Repository代码后才发现方向不对，比如数据库表设计与现有架构冲突，不得不从头再来，浪费了大量时间；</p>
<p>实现触达功能时，生成的飞书消息发送代码没有考虑现有的FeishuClient封装，重复造了轮子。</p>
<h3 data-id="heading-8">核心问题：为什么AI总是"听不懂"？</h3>
<p>深入分析后，我们发现传统对话模式失败的根源在于三个核心矛盾：</p>
<p><strong>语义鸿沟</strong></p>
<p>自然语言描述的模糊性与代码逻辑的精确性之间的差距。我们说"这个接口要安全"，AI可能理解为"需要登录校验"，而我们实际想要的是：</p>
<ul>
<li>使用项目中的@Permission注解进行权限校验。</li>
<li>参数需要使用ValidatorUtil进行校验。</li>
<li>敏感操作需要记录操作日志。</li>
</ul>
<p><strong>约束衰减</strong></p>
<p>随着对话推进，早期设定的技术约束在AI理解中的权重逐渐降低。就像我们记笔记时，重要的事情要反复强调。比如：</p>
<ul>
<li>第1轮对话强调"必须继承BaseServiceImpl"。</li>
<li>第5轮对话AI可能忘记这个约束，直接实现了一个独立的Service类。</li>
<li>第10轮对话可能连项目的分层架构都混淆了。</li>
</ul>
<p><strong>目标偏移</strong></p>
<p>在多轮对话中，AI容易过度关注当前细节而忽视整体目标。比如讨论某个接口的参数设计时：</p>
<ul>
<li>AI可能会纠结于参数名称是否优雅。</li>
<li>而忽略了这个接口的核心业务价值是"快速检索符合条件的商家"。</li>
<li>结果生成的代码参数命名很完美，但缺少了分页、排序等实际必需的功能。</li>
</ul>
<h3 data-id="heading-9">解决方案：结构化对话设计方法</h3>
<p>针对这些问题，我们团队总结出一套"三阶段对话模型"，现在已经成为我们使用Claude Code的标准流程：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/970e35bac84745b386585f2f73576e59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770100504&amp;x-signature=vj%2FS3tTY9JLPbLdEvCwMdI3igJU%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>阶段一：需求定义——把"要做什么"说清楚</strong></p>
<p>这个阶段的目标是确保我们和AI对需求达成共识。我们会用"用户故事+验收标准"的格式来描述需求：</p>
<p><strong>示例1：新商户成长任务分配</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">【用户故事】
作为新商户运营，我需要一个任务分配功能，以便将成长任务高效分配给运营人员
【验收标准】
 - 支持从任务池中按优先级(P0/P1/P2)筛选待分配任务
 - 支持指定运营人员进行任务分配，需校验运营人员是否有权限
 - 分配时需检查运营人员当前任务负载，超过上限时提示<span class="hljs-string">"当前任务数已达上限"</span>
 - 分配成功后需发送飞书消息通知运营人员，消息内容包含任务详情和截止时间
 - 操作需记录到表，包含操作人、操作时间、任务ID、分配对象
</code></pre>
<p><strong>示例2：商家数据权限查询</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">【用户故事】
作为商家运营，我需要一个商家信息查询接口，查询结果需要根据我的数据权限进行过滤
【验收标准】
 - 支持按商家ID、商家名称、商家状态进行查询
 - 支持分页查询，默认每页<span class="hljs-number">20</span>条，最大<span class="hljs-number">100</span>条
 - 查询结果需要根据当前用户的数据范围进行过滤
 - 商家敏感信息(手机号、身份证号)需脱敏处理
 - 接口需要权限校验，至少具有<span class="hljs-string">"商家查看"</span>权限
 - 查询条件需记录到操作日志，便于审计
</code></pre>
<p><strong>阶段二：边界明确——确定"怎么做"的约束条件</strong></p>
<p>在这个阶段，我们会明确技术栈选择、架构设计和各种约束条件。关键是要区分"必须遵守"和"建议参考"的约束：</p>
<p><strong>示例1：新商户成长任务模块</strong></p>
<pre><code class="hljs language-sql" lang="sql">【技术约束】
必须遵守:
 <span class="hljs-operator">-</span> 使用SpringBoot标准分层架构,所有Service继承OcsBaseServiceImpl
 <span class="hljs-operator">-</span> 数据库操作使用MyBatis<span class="hljs-operator">-</span>Plus,实体类继承BaseEntity,Mapper继承BaseMapper
 <span class="hljs-operator">-</span> 接口返回统一使用<span class="hljs-keyword">Result</span><span class="hljs-operator">&lt;</span>T<span class="hljs-operator">&gt;</span>格式,错误码使用ErrorCode
 <span class="hljs-operator">-</span> 权限校验使用<span class="hljs-variable">@Permission</span>注解,参数校验使用<span class="hljs-variable">@Valid</span> <span class="hljs-operator">+</span> ValidatorUtil
 <span class="hljs-operator">-</span> 飞书消息发送必须使用FeishuClient,不要重复实现
建议参考:
 <span class="hljs-operator">-</span> 任务状态流转参考TaskServiceImpl中的状态机模式
 <span class="hljs-operator">-</span> 批量分配操作参考AssignImportHandler中的异步处理方式
 <span class="hljs-operator">-</span> 运营人员权限校验参考OperatorRelationServiceImpl
 <span class="hljs-operator">-</span> 数据权限过滤参考ScopeServiceImpl中的范围查询逻辑
【数据库约束】
 <span class="hljs-operator">-</span> 新增表必须包含created_at, updated_at, is_deleted字段
 <span class="hljs-operator">-</span> 表名使用ocs_前缀,字段名使用蛇形命名法
 <span class="hljs-operator">-</span> 索引设计需考虑查询场景,高频查询字段必须建立索引
 <span class="hljs-operator">-</span> 外键约束通过代码层面维护,不在数据库层面创建
</code></pre>
<p><strong>示例2：机器人问答功能</strong></p>
<pre><code class="hljs language-java" lang="java">【技术约束】
必须遵守:
 - Controller层使用<span class="hljs-meta">@RestController</span> + <span class="hljs-meta">@RequestMapping</span>,路径遵循/api/v1/{<span class="hljs-keyword">module</span>}/{action}格式
 - Service层业务逻辑必须有事务控制,使用<span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
 - DTO转换使用项目中的ConvertUtil,不要手动赋值
 - 第三方API调用(如Dify)必须有重试机制和降级策略
 - 敏感配置(API Key)必须从配置中心读取,不要硬编码
建议参考:
 - 对话上下文管理参考RobotServiceImpl中的会话ID生成逻辑
 - 消息发送失败重试参考FeishuMessageHandler中的重试策略
 - 错误处理参考GlobalExceptionHandler中的统一异常处理
【集成约束】
 - Dify API调用统一通过DifyClient,响应格式需转换为项目标准格式
 - 飞书机器人回调处理需实现签名校验,参考FeishuEventHandler
 - 所有外部API调用需记录请求日志到integration_log表 
</code></pre>
<p><strong>阶段三：迭代反馈——在"做的过程"中持续对齐</strong></p>
<p>这个阶段的核心是增量验证，避免一次性生成大量代码后才发现方向错误。</p>
<p><strong>实践要点：</strong></p>
<ul>
<li>分模块实现，逐个验证</li>
</ul>

<ul>
<li>先实现核心接口(如任务分配)，验证通过后再实现辅助功能(如任务查询)。</li>
<li>先实现Service层核心逻辑，验证业务流程正确后再补充Controller和参数校验。</li>
</ul>

<ul>
<li>关键节点主动暂停</li>
</ul>

<ul>
<li>数据库表设计完成后，先让开发者确认表结构再继续。</li>
<li>核心业务逻辑实现完成后，先通过单元测试验证再生成Controller。</li>
<li>集成第三方API前，先确认调用方式和参数映射。</li>
</ul>

<ul>
<li>持续同步技术方案</li>
</ul>

<ul>
<li>发现架构设计与现有代码不一致时，立即更新tech-solution.json和tech-solution.md。</li>
<li>新增数据表、修改核心逻辑时，同步更新技术方案文档。</li>
<li>每个模块完成后，更新模块状态为implemented → reviewed → verified。</li>
</ul>
<p><strong>对话示例：</strong></p>
<pre><code class="hljs language-vbnet" lang="vbnet">开发者: <span class="hljs-string">"实现新商户成长任务分配功能"</span>
<span class="hljs-symbol">AI:</span> <span class="hljs-string">"我将分三步实现:
1. 先设计数据库表结构(ocs_task_assignment表)
2. 实现核心分配逻辑(NewMerchantTaskAssignService)
3. 实现Controller层接口
现在开始第一步,设计的表结构如下:
[展示表结构]
请确认表结构是否符合需求?"</span>
开发者: <span class="hljs-string">"字段没问题,但索引需要加上(operator_id, status)"</span>
<span class="hljs-symbol">AI:</span> <span class="hljs-string">"已更新索引设计,现在开始实现Service层核心逻辑...
[生成Service代码]
核心逻辑已实现,包含:
- 任务池查询(按优先级过滤)
- 运营人员负载检查
- 任务分配和状态更新
- 飞书消息发送
请验证业务逻辑是否正确?"</span>
开发者: <span class="hljs-string">"逻辑正确,继续实现Controller"</span>
<span class="hljs-symbol">AI:</span> <span class="hljs-string">"开始实现Controller层...
[生成Controller代码]
已完成模块M1实现,更新技术方案状态为implemented"</span>
</code></pre>
<p><strong>对话设计三原则与常见问题应对策略</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/231e4617f2344e479c31643c9db05325~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770100504&amp;x-signature=HhZA1cNTIr%2Bb6wfHKRSZF0qJS2k%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-10">为什么这样设计：背后的认知科学原理</h3>
<p>这种结构化对话设计不是凭空想出来的，而是基于我们对人类认知过程的理解：</p>
<ul>
<li><strong>工作记忆限制理论：</strong> 就像我们一次只能记住7±2个信息块一样，AI的上下文理解能力也是有限的。通过分阶段对话和单次聚焦单模块，我们控制了每次交互的认知负荷。</li>
<li><strong>渐进式知识构建：</strong> 学习和理解是一个渐进过程，先掌握整体框架再深入细节，符合认知规律。这和我们教新人时"先讲架构图，再讲模块间交互，最后讲具体实现"的思路是一致的。</li>
</ul>
<h2 data-id="heading-11">四、AI团队协作模式：子代理系统的实践与思考</h2>
<p>随着团队使用Claude Code的深入，我们发现单个AI助手已经难以满足复杂项目的开发需求——就像一个人再厉害也干不了一个团队的活。于是，我们开始探索让多个AI"角色"协同工作的模式，这就是子代理（SubAgent）系统的由来。</p>
<h3 data-id="heading-12">团队协作的现状与挑战</h3>
<p>在传统开发模式中，我们有需求分析师、架构师、开发工程师、测试工程师等不同角色，他们通过文档、会议和代码审查等方式协作。这种模式虽然成熟，但在快节奏的业务迭代中，我们发现了一些问题：</p>
<p><strong>协作中的三大痛点：</strong></p>
<ul>
<li><strong>信息传递损耗：</strong> 需求文档从产品经理到开发再到测试，每经过一个环节就可能产生一些理解偏差。就像玩"电话游戏"，信息传到最后可能已经面目全非。</li>
<li><strong>责任边界模糊：</strong> 当出现问题时，有时会出现"这是架构设计问题"、"这是实现问题"、"这是测试不充分"的互相推诿。</li>
<li><strong>反馈周期漫长：</strong> 从需求分析到代码审查，整个流程走下来往往需要几天时间，等发现问题时可能已经投入了大量开发资源。</li>
</ul>
<p>这些问题促使我们思考：能不能在Claude Code中模拟团队协作模式，让不同的AI角色各司其职又协同工作？</p>
<h3 data-id="heading-13">Claude Code的子代理协作模式</h3>
<p>借鉴了MetaGPT等框架的思想，我们在Claude Code中构建了由多个专业化子代理组成的AI团队协作系统。每个子代理承担特定角色，通过标准化中间产物协同工作。</p>
<p><strong>核心工作机制：中间产物驱动</strong></p>
<p>所有子代理通过共享"技术方案文档"进行协作，这个文档就像团队的"共享白板"，包含需求分析、模块划分、实现状态和接口设计等关键信息。每个子代理只负责修改文档中与自己角色相关的部分，确保信息一致性。</p>
<p><strong>四个核心子代理角色</strong></p>
<p><strong>技术方案架构师</strong></p>
<p>负责需求分析、技术方案设计和模块划分。相当于团队里的架构师，输出"技术方案文档"这个"施工蓝图"。</p>
<p><strong>核心职责：</strong></p>
<ul>
<li>需求拆解与模块划分</li>
<li>技术栈选型与架构设计</li>
<li>接口定义与数据模型设计</li>
<li>模块间依赖关系梳理</li>
<li>技术方案文档编写与维护</li>
</ul>
<p><strong>代码审查专家</strong></p>
<p>负责代码质量审查。扮演技术负责人的角色，从架构合规性、代码规范和稳定性等角度挑毛病。</p>
<p><strong>核心职责：</strong></p>
<ul>
<li>检查代码是否符合架构设计</li>
<li>验证代码规范和命名约定</li>
<li>识别潜在性能问题和bug</li>
<li>评估代码可维护性和扩展性</li>
<li>提供具体修改建议</li>
</ul>
<p><strong>代码实现专家</strong></p>
<p>专注于代码实现和单元测试编写。就像主力开发工程师，按照架构师设计的蓝图一块块地实现功能。</p>
<p><strong>核心职责：</strong></p>
<ul>
<li>根据技术方案实现代码</li>
<li>编写单元测试和集成测试</li>
<li>修复代码审查中发现的问题</li>
<li>编写API文档和使用说明</li>
<li>同步更新技术方案实现状态</li>
</ul>
<p><strong>前端页面生成器</strong></p>
<p>专门负责生成符合我们低代码平台规范的前端页面配置。这是针对我们商家域管理后台特点定制的角色。</p>
<p><strong>核心职责：</strong></p>
<ul>
<li>根据接口定义生成前端页面配置</li>
<li>实现表格、表单、详情页等标准组件</li>
<li>配置页面权限和数据范围过滤</li>
<li>优化前端交互体验</li>
<li>确保符合设计规范和响应式要求</li>
</ul>
<p><strong>协作流程</strong></p>
<p>我们采用"先整体规划，再迭代实现"的工作方式，有点像敏捷开发中的Sprint规划+Daily Scrum：</p>
<p><strong>1. 整体规划阶段：</strong></p>
<ul>
<li>产品经理提供需求文档。</li>
<li>协调者调用"技术方案架构师"子代理分析需求，生成技术方案文档。</li>
<li>团队评审技术方案，提出修改意见。</li>
<li>架构师子代理根据反馈修改方案，直到团队确认。</li>
</ul>
<p><strong>2. 单模块迭代阶段：</strong></p>
<ul>
<li>协调者从技术方案文档中选取一个模块。</li>
<li>调用"代码实现专家"生成代码。</li>
<li>调用"代码审查专家"审查代码。</li>
<li>实现专家根据审查意见修改代码。</li>
<li>重复"实现-审查-修改"直到通过。</li>
<li>更新技术方案文档，标记该模块为"已完成"。</li>
<li>进入下一个模块。</li>
</ul>
<h3 data-id="heading-14">子代理协作的价值与局限</h3>
<p><strong>实践中的三个显著价值</strong></p>
<ul>
<li><strong>专业化分工提升质量：</strong> 每个子代理专注于特定领域，就像专科医院比综合医院在特定疾病上更专业一样。我们发现，专门的代码审查子代理比通用AI能发现更多潜在问题。</li>
<li><strong>流程标准化降低风险：</strong> 通过技术方案文档和明确的角色分工，开发流程被标准化和可视化。新人加入项目时，只要看技术方案文档就能快速了解整体情况。</li>
<li><strong>知识沉淀促进复用：</strong> 子代理的专业知识和决策逻辑被编码为可复用的配置和规则，避免了"人走经验丢"的问题。</li>
</ul>
<p><strong>遇到的四个实际挑战</strong></p>
<p><strong>子代理协作的挑战与应对：</strong></p>
<ul>
<li><strong>上下文同步问题：</strong> 当技术方案文档更新时，各子代理有时不能立即同步最新信息。解决办法：每次修改文档后，明确通知相关子代理"技术方案中XX部分已更新"。</li>
<li><strong>协作边界模糊：</strong> 在处理跨模块功能时，出现"该由哪个子代理负责"的困惑。解决办法：在技术方案文档中添加"责任人"字段，明确每个模块由哪个子代理负责。</li>
<li><strong>灵活性与标准化的平衡：</strong> 高度标准化的流程有时会限制处理特殊情况的灵活性。解决原则：90%的常规情况严格遵循标准流程，10%的特殊情况由人工介入处理。</li>
<li><strong>错误传递放大效应：</strong> 如果技术方案设计阶段就有问题，这个问题会在后续实现和审查阶段被放大。解决办法：加强技术方案的人工评审环节，确保"地基"打牢。</li>
</ul>
<h3 data-id="heading-15">子代理协作的设计思考</h3>
<p>在设计这套协作模式时，我们有几个关键思考：</p>
<ul>
<li><strong>为什么选择"中间产物驱动"而非"直接沟通"？</strong></li>
<li>直接让子代理之间对话可能更灵活，但会导致沟通成本指数级增加（n个代理就有n(n-1)/2种沟通渠道）。通过"技术方案文档"这个单一事实来源，我们大大降低了协作复杂度，也便于追踪变更历史。</li>
<li><strong>角色划分的依据是什么？</strong></li>
<li>我们的角色划分基于软件开发的自然阶段（设计→实现→审查）和专业领域（后端→前端），这符合软件开发生命周期的自然规律。没有盲目追求角色数量，而是根据实际需求逐步增加。</li>
<li><strong>为什么采用"增量迭代"而非"一次性开发"？</strong></li>
<li>复杂系统的构建本质上是一个不断学习和调整的过程。增量迭代让我们能够及早发现问题并调整方向，避免在错误的道路上走得太远。这和我们常说的"小步快跑，快速迭代"理念一致。</li>
</ul>
<h2 data-id="heading-16">五、实践经验与未来展望</h2>
<p>经过几个月的Claude Code实践，从最初的"试试看"到现在成为离不开的开发工具，我们积累了一些经验，也对AI编程的未来有了更清晰的认识。</p>
<h3 data-id="heading-17">实践经验总结</h3>
<p><strong>人机协作的最佳平衡点：</strong></p>
<p>我们发现最有效的AI编程模式是"人类主导，AI辅助"，而不是反过来。我们将工作内容分为三类：</p>
<ul>
<li><strong>AI主导：</strong> 标准化代码生成（如基础CRUD接口）、单元测试编写、API文档生成等重复性高、规则明确的任务。</li>
<li><strong>人机协作：</strong> 技术方案设计、复杂逻辑实现、代码审查等需要结合领域知识和创造性思维的任务。</li>
<li><strong>人类主导：</strong> 需求分析、架构设计、质量决策等高风险、高创造性的任务。</li>
</ul>
<p><strong>上下文管理的实用技巧</strong></p>
<p>管理好对话上下文是用好Claude Code的关键，分享几个我们团队总结的技巧：</p>
<ul>
<li><strong>对话线程化：</strong> 为不同功能模块创建独立对话线程。我们曾经在一个对话里讨论三个不同模块，结果上下文混乱到不得不从头开始。</li>
<li><strong>关键信息锚定：</strong> 重要的技术决策和约束要在对话中反复强调。就像写文章时，核心观点要多次出现。</li>
<li><strong>文档外化：</strong> 复杂设计和决策要记录在外部文档中，而不是仅依赖对话历史。我们会在对话中引用这些文档："数据库设计详见/doc/db_design.md，特别是索引设计部分"。</li>
<li><strong>状态可视化：</strong> 通过技术方案文档中的进度标记（如[未开始]、[设计中]、[已实现]、[已审查]），直观跟踪开发状态。</li>
</ul>
<p><strong>质量控制的三个关键策略</strong></p>
<p>使用AI生成代码后，质量控制变得更加重要。我们的做法是：</p>
<ul>
<li><strong>多层次验证：</strong> 单元测试（AI生成）+ 集成测试（人工设计）+ 代码审查（人机结合）的三层验证体系。</li>
<li><strong>渐进式信任：</strong> 从简单、低风险模块开始使用AI，建立信任后再逐步扩展。我们最先用AI生成内部工具，验证没问题后才用于核心业务系统。</li>
<li><strong>错误模式学习：</strong> 记录AI常犯的错误类型，针对性优化系统提示词。我们有一个"AI错误案例库"，记录了"AI忘记处理分布式锁超时"、"日期格式转换错误"等典型问题及解决方案。</li>
</ul>
<h3 data-id="heading-18">AI编程的局限性认知</h3>
<p>在实践过程中，我们也清醒地认识到AI编程并非万能解决方案，它有几个明显的局限性：</p>
<ul>
<li><strong>创造性思维不足：</strong> AI擅长在已有知识范围内进行组合和优化，但在需要突破性创新的场景下表现有限。比如我们尝试让AI设计一个全新的商家结算模型时，它还是会倾向于参考现有模型进行修改，难以跳出固有思维框架。</li>
<li><strong>上下文理解深度有限：</strong> 尽管Claude Code的上下文窗口已经很大，但对于我们系统中某些"牵一发而动全身"的核心模块，AI还是难以把握其深层设计意图和与其他模块的隐性依赖。</li>
<li><strong>质量责任边界模糊：</strong> 当AI生成的代码出现质量问题时，责任界定变得复杂。我们的解决办法是：开发者对AI生成的代码负全部责任，就像我们对自己写的代码负责一样。</li>
<li><strong>领域知识滞后性：</strong> AI对我们公司内部系统的最新变更反应不够及时。为此我们建立了"知识库更新机制"，每月将最新的系统变更和业务规则整理成文档，供AI参考。</li>
</ul>
<h3 data-id="heading-19">未来发展方向思考</h3>
<p>基于这些实践经验，我们对AI编程工具的未来发展有几点思考：</p>
<ul>
<li><strong>更智能的上下文管理：</strong> 未来的AI编程工具应该能自动识别相关上下文、追踪依赖关系，并在适当的时候提醒开发者潜在的上下文冲突。就像经验丰富的团队领导，能记住每个人负责的模块和项目的整体情况。</li>
<li><strong>多模态交互模式：</strong> 除了文本对话，未来可能引入图表、流程图等多种交互方式。有时画一个简单的流程图(PlantUML)，比写几百字描述更能说明问题。</li>
<li><strong>自适应学习机制：</strong> AI编程工具应该能从团队的使用反馈中学习，适应特定团队的编码风格和业务领域。就像新加入团队的开发者，会逐渐适应团队的工作方式。</li>
</ul>
<h2 data-id="heading-20">六、结语：人机协作的新型开发范式</h2>
<p>回顾这几个月使用Claude Code的经历，我们最大的体会是：AI编程工具的价值不在于替代开发者，而在于构建人机协作的新型开发范式。在这种范式下，人类开发者从繁琐的重复劳动中解放出来，更专注于需求分析、架构设计和质量把控等高价值创造性工作，而AI则承担起代码实现、文档生成和基础验证等标准化工作。</p>
<p>Claude Code作为我们实践的核心工具，通过精准对话流设计、模块化任务分解和专业化子代理协作，展示了这种新型开发范式的潜力。但我们也认识到，成功的AI编程应用需要"工具+方法论+团队协作"三位一体的系统性变革，其中人的角色从"代码生产者"向"问题解决者"和"质量把控者"转变。</p>
<p>作为开发者，我们需要保持开放学习的心态，积极探索和适应这种新范式。未来已来，与其恐惧被AI替代，不如学会与AI协作，在人机协作中实现更高的个人价值和团队效能。毕竟，代码只是解决问题的手段，而非目的；AI只是增强我们能力的工具，而真正的创新和价值，始终源于人的智慧和创造力。</p>
<p><strong>实践启示：</strong> 在AI编程时代，最有价值的开发者不是"写代码最快的人"，而是"最会引导AI、最能把控质量、最能解决复杂问题的人"。掌握与AI协作的技巧，建立系统化的AI辅助开发流程，将成为未来开发者的核心竞争力。我们的经验表明，通过合理设计对话流程、明确分工协作和严格质量控制，AI编程工具能够显著提升团队效能，但这需要整个团队在思维方式和工作流程上的共同转变。</p>
<h3 data-id="heading-21">往期回顾</h3>
<p>1.入选AAAI-PerFM｜得物社区推荐之基于大语言模型的新颖性推荐算法</p>
<p>2.Galaxy比数平台功能介绍及实现原理｜得物技术 </p>
<p>3.得物App智能巡检技术的探索与实践</p>
<p>4.深度实践：得物算法域全景可观测性从 0 到 1 的演进之路</p>
<p>5.前端平台大仓应用稳定性治理之路｜得物技术</p>
<h3 data-id="heading-22">文 /稚归</h3>
<p>关注得物技术，每周更新技术干货</p>
<p>要是觉得文章对你有帮助的话，欢迎评论转发点赞～</p>
<p>未经得物技术许可严禁转载，否则依法追究法律责任。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RUM 链路打通实战：打破移动端可观测性黑洞]]></title>    <link>https://juejin.cn/post/7599970244788109375</link>    <guid>https://juejin.cn/post/7599970244788109375</guid>    <pubDate>2026-01-28T08:21:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599970244788109375" data-draft-id="7599933828545036351" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RUM 链路打通实战：打破移动端可观测性黑洞"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2026-01-28T08:21:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RUM 链路打通实战：打破移动端可观测性黑洞
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T08:21:42.000Z" title="Wed Jan 28 2026 08:21:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：路锦（小蘭）</p>
<h2 data-id="heading-0">背景：移动端的“可观测性黑洞”</h2>
<p>在微服务架构蓬勃发展的今天，服务端的可观测性建设已日趋成熟。无论是 Jaeger、Zipkin 还是 SkyWalking，这些分布式链路追踪工具都能够帮助开发者清晰地观察到一个请求从网关进入后，是如何在各个微服务之间层层流转、逐级调用的。然而，当我们试图将这条链路向前延伸至移动端时，却发现一道难以逾越的鸿沟横亘其间。</p>
<ul>
<li>关联困难：移动端和服务端仿佛两座孤岛，各自维护着独立的日志系统。客户端记录着请求发起的时间和结果，服务端保存着完整的调用链路，但两者之间缺乏一条有效的纽带将其串联起来。一旦出现问题，排查人员只能依靠时间戳进行手工比对，既费时又容易出错，遇到高并发场景更是如同大海捞针。</li>
<li>定位模糊：我们常常遇到这样的场景：用户投诉说接口超时了，但翻开服务端监控，每一条请求都显示着正常返回的 200 状态码。问题究竟出在用户的网络环境、运营商的链路质量，还是服务端在某个瞬间的抖动？由于移动端与服务端的监控体系相互割裂，我们根本无从判断故障边界，各团队之间也容易陷入相互推诿的困境。</li>
<li>复现无门：移动端的网络环境远比服务端复杂——DNS 解析可能受到劫持、SSL 握手可能遭遇兼容性问题、弱网环境下的重试和超时更是家常便饭。这些关键信息在传统方案中往往随着请求结束而烟消云散，当问题间歇性发生时，开发者既无法还原现场，也难以定位根因，只能在用户的反复投诉中束手无策。</li>
</ul>
<p>正是这些痛点的存在，让端到端全链路追踪的需求变得愈发迫切。我们需要一种方案，能够让移动端真正成为分布式链路的起点，让每一次用户操作触发的请求都能够被完整记录、精准关联、一路追踪到最底层的数据库调用。本文将通过一个最佳实践案例，展示如何借助阿里云用户体验监控实现移动端到后端的全链路 Trace 打通，辅助网络请求问题排查。</p>
<h2 data-id="heading-1">核心方案：端到端链路打通的技术实现</h2>
<h3 data-id="heading-2">核心思想</h3>
<p>端到端链路打通的本质是：<strong>让客户端成为分布式追踪链路的第一跳，使其与服务端链路共享同一个 Trace ID。</strong></p>
<p>在传统架构中，链路追踪的起点是服务端网关——请求进入网关时，APM Agent 为其分配 Trace ID，并在后续的微服务调用中透传。而端到端打通方案则将这个起点前移到了用户的手机上，由移动端 SDK 主动生成 Trace ID 并注入到请求头中，使得整条链路从用户指尖到数据库底层都被同一个标识串联起来。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5162056d90f479aa8563c650bf27878~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193302&amp;x-signature=hnYUDn7xxNc11GevzmnS3a8WKNc%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-3">技术实现的四个关键环节</h3>
<p>整个链路打通的实现可以分为四个紧密衔接的环节：</p>
<h4 data-id="heading-4">环节一：客户端生成链路标识</h4>
<p>当用户触发一次网络请求时，客户端 SDK 在请求真正发出之前介入：</p>
<ol>
<li><strong>拦截请求</strong>：通过网络库的拦截机制（如 OkHttp Interceptor）捕获即将发出的请求</li>
<li><strong>创建 Span</strong>：为这次请求创建一个 Span 对象，生成两个核心标识：
<ul>
<li><strong>Trace ID</strong>（32 位十六进制）：整条链路的唯一身份</li>
<li><strong>Span ID</strong>（16 位十六进制）：当前这一跳的唯一身份</li>
</ul>
</li>
<li><strong>记录起始时间</strong>：精确记录请求发起的时间戳，用于后续计算各阶段耗时</li>
</ol>
<h4 data-id="heading-5">环节二：协议编码与注入</h4>
<p>生成链路标识后，需要将其编码为服务端能够理解的格式。这里的关键是选择一套双方都遵守的“通用语言”——W3C Trace Context 或 SkyWalking SW8 协议。</p>
<p>客户端 SDK 将编码后的信息写入 HTTP 请求头，随请求一同发送。</p>
<h4 data-id="heading-6">环节三：网络传输与透传</h4>
<p>HTTP 协议天然具备请求头的穿透性，这是透传能够实现的技术基础：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5fae82476b264a638224cfd488660dfa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193302&amp;x-signature=uYMPtHKjPgIN9Y5hxYzFAsXFPPM%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-7">环节四：服务端接收与延续</h4>
<p>当请求到达服务端时，APM Agent 接管后续处理，完成链路的延续：</p>
<ol>
<li><strong>解析请求头</strong>：从 <code>traceparent</code> 或 <code>sw8</code> 头中提取 Trace ID 和 Parent Span ID</li>
<li><strong>继承链路上下文</strong>：将客户端传入的 Trace ID 作为本条链路的身份标识，而非重新生成</li>
<li><strong>创建子 Span</strong>：为服务端的处理逻辑创建新的 Span，其 Parent Span ID 指向客户端的 Span</li>
<li><strong>继续透传</strong>：在调用下游服务时，继续在请求头中携带同一个 Trace ID</li>
</ol>
<p>通过这四个环节的紧密配合，移动端发出的每一个请求都能与服务端的调用链路无缝衔接，形成一条从用户设备到数据库的完整追踪链路。</p>
<h3 data-id="heading-8">链路打通协议</h3>
<p>为了让不同系统之间能够“说同一种语言”，业界制定了标准化的链路追踪协议。目前主流的协议有两种：</p>
<h4 data-id="heading-9">W3C Trace Context 协议</h4>
<p>W3C Trace Context 是 W3C 官方标准，具有最广泛的兼容性。</p>
<p><strong>Header 格式：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12877ce09ef04d5fbb5558f019586142~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193302&amp;x-signature=uv3X43IGWsNtwSW1aByqAjIqMCA%3D" alt="图片" loading="lazy"/></p>
<p><strong>字段说明：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1a9ca9a1b2e4059b256312981a0b1be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193302&amp;x-signature=jcpiSY6Qx4abw8QB2dRuEMEAyNw%3D" alt="图片" loading="lazy"/></p>
<p><strong>适用场景：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b62568aa342e4ca28e8cc1d91497c251~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193302&amp;x-signature=u40nJjPCEFwgmS6ERq69LqEv9es%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-10">SkyWalking SW8 协议</h4>
<p>SW8 是 Apache SkyWalking 的原生协议，包含更丰富的上下文信息。</p>
<p><strong>Header 格式：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16a20d8b663e46a6a8822f5852cdf47f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193302&amp;x-signature=30mma5RSm61gW1pb4vtTQfFI0Ac%3D" alt="图片" loading="lazy"/></p>
<p><strong>字段说明：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a841dd8eb27044cfa7e62c7ff6a844d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193302&amp;x-signature=yaU0Rt6KIqei84jq5CQWuiqchKA%3D" alt="图片" loading="lazy"/></p>
<p><strong>适用场景：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a9fca02f12c4a2199c719fd103bc5e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193302&amp;x-signature=LwDQvebtkXWHg913RiJAtSPMABk%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-11">实战案例：一次查询接口超时的全链路排查</h2>
<p>理论讲完了，接下来让我们通过一个真实的排查案例，看看端到端链路打通在实际问题定位中是如何发挥作用的。</p>
<h3 data-id="heading-12">问题背景</h3>
<p>我们基于某开源代码库构造了一个慢请求场景，架构如下图所示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02e48a2b24624ebcb52aceff8a17bf43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193302&amp;x-signature=nXILpGztcihnX29x3d2Uqxa%2Fu9Q%3D" alt="图片" loading="lazy"/></p>
<p>在日常使用中，我们发现某个页面打开十分缓慢，用户体验极差。初步怀疑是由于 API 请求响应过慢导致，但具体慢在哪里、为什么慢，还需要进一步分析。接下来，我们将借助阿里云用户体验监控的全链路追踪能力，一步步定位问题根因。</p>
<h3 data-id="heading-13">第一步：在云监控控制台定位异常请求</h3>
<p>首先，我们登录阿里云控制台，进入<strong>云监控 2.0 控制台 → 用户体验监控 →您的应用 → API 请求</strong>模块。在这里，我们可以看到所有 API 请求的性能统计数据。</p>
<p>通过对“缓慢占比”进行排序，我们很快发现了问题所在：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3538775992f485c8dd2ecb1b77c9136~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193302&amp;x-signature=p0fRGJO9or%2F0M7Q7F1I8RZTF%2FBg%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7aed5cd3efa4a29b2d5557582048df8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193302&amp;x-signature=HagjDWlUHSBmgp4kr5nNDbUOS7s%3D" alt="图片" loading="lazy"/></p>
<p>从监控数据可以清晰地看到，API <code>/java/products</code> 的响应时间异常——平均耗时高达 40 多秒！这个耗时远远超出了正常范围，难怪用户会感觉页面打开缓慢。</p>
<p>找到了可疑的 API，接下来我们需要进一步分析它的调用链，搞清楚这 40 多秒究竟消耗在了哪个环节。</p>
<h3 data-id="heading-14">第二步：查看调用链，追踪服务端链路</h3>
<p>点击对应 API 的“<strong>查看调用链</strong>”按钮，系统会跳转到当前请求的 Trace 详情页面。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b7987568bb04fb2a487d8fd1c585cba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193302&amp;x-signature=YTQGXbQMTcLsQnRkgyrtcVJLIn0%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f422ba7139854ffbb7fa1e83731bf7e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193302&amp;x-signature=DDLeR1hJVjz7vecJCIMyTSdyPy0%3D" alt="图片" loading="lazy"/></p>
<p>这里就是端到端链路打通的核心价值所在——我们可以直接看到从移动端到后端的完整调用链路，无需在多个系统之间来回切换。</p>
<p>从链路瀑布图中可以清晰地看到：</p>
<ul>
<li>移动端发起请求后，链路完整地延续到了后端服务</li>
<li>耗时主要发生在后端服务的 <code>/products</code> 接口</li>
<li>该接口处理耗时超过 40 秒才返回数据</li>
</ul>
<p>为了方便后续在后端应用监控中进行更深入的分析，我们记录下当前的 Trace ID：<code>c7f332f53a9f42ffa21ef6c92f029c15</code>。</p>
<h3 data-id="heading-15">第三步：查看后端服务Trace分析</h3>
<p>接下来，我们进入应用监控 → 找到对应的后端应用 → 调用链分析，使用刚才记录的 Trace ID 进行查询。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac0c4452b6a94c78b01bda4113533968~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193302&amp;x-signature=ng40a3QT0v%2BhqCCSQpcK8Gl63cI%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6249b41ee90646b397d17180961e6b46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193302&amp;x-signature=aHEtoXLio4rUSi8oj9zvfGeE0Gc%3D" alt="图片" loading="lazy"/></p>
<p>从后端链路数据可以还原出 <code>/products</code> 接口的执行链路：</p>
<ul>
<li>HikariDataSource.getConnection，重复 6 次，总耗时 3ms。含义：获取数据库连接（从连接池拿）一共 6 次，总共才 3ms，不是瓶颈。</li>
<li>postgres，重复 6 次，总耗时 2ms。这是一些非常快的 Postgres 操作/小查询，同样不是瓶颈。</li>
<li>SELECT postgres.products，重复执行了1 +  5 次，总耗时 42290ms ≈ 42.3s。这行才是关键：同一个 SQL（查 products 相关）一共执行了 5 次，总耗时 42.3s，平均每次大约 8 秒。</li>
<li>也就是说：主要时间都花在执行这个 SQL 上，而不是连库 / 建连接 / 网络。</li>
</ul>
<h3 data-id="heading-16">第四步：深入分析慢 SQL</h3>
<p>点击链路中的最后一个 Span，我们可以在右侧详情面板中看到具体执行的 SQL 语句：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 第一次查询：获取全量产品数据</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> products
<span class="hljs-comment">-- 对每个产品执行 N 次查询（N+1 问题）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> reviews, weekly_promotions <span class="hljs-keyword">WHERE</span> productId <span class="hljs-operator">=</span> ?
</code></pre>
<p>问题的根因逐渐浮出水面：</p>
<ol>
<li>第一次查询：<code>SELECT * FROM products</code> 获取所有产品，这一步耗时尚可</li>
<li>N 次循环查询：对于每一个产品，又单独执行了一次 <code>SELECT * FROM reviews, weekly_promotions WHERE productId = ?</code></li>
</ol>
<p>这是一个典型的 N+1 查询问题！更糟糕的是，<code>weekly_promotions</code> 是一个特意设计的“慢视图”（sleepy view），每次查询都会执行较重的操作。当产品数量较多时，这些查询累积起来就造成了 42 秒的惊人耗时。</p>
<p>我们记录下当前的线程名称：<code>http-nio-7001-exec-3</code>，以便进一步查看 Profile 数据进行验证。</p>
<h3 data-id="heading-17">第五步：查看 Profile 数据验证结论</h3>
<p>为了进一步确认我们的分析结论，我们进入<strong>应用诊断 → 持续性能剖析</strong>，查看后端服务的 Profile 数据。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bf96f77d7814b33b5fbe7430e2cc7cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193302&amp;x-signature=ImCRw0tRY7AjWXtDGM3M036Rw44%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f368a19f74454ec69f472505a31edd5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770193302&amp;x-signature=jaArK2CtNCJdvq%2Bqtls3zoM%2F3%2Fs%3D" alt="图片" loading="lazy"/></p>
<p>筛选对应的线程后，我们看到了服务执行时间的分布情况：</p>
<ul>
<li><code>sun.nio.ch.Net.poll(FileDescriptor, int, long)</code> 耗时占比接近 100%</li>
<li>这表明线程大部分时间都在<strong>等待 Postgres socket 返回数据</strong></li>
</ul>
<p>Profile 数据与调用链分析的结论完全吻合——问题确实出在数据库查询上，线程一直在等待慢 SQL 的执行结果。</p>
<h3 data-id="heading-18">第六步：定位根因</h3>
<p>综合以上分析，我们可以清晰地定位到问题的根因：</p>
<p><strong>问题根因：N+1 查询 + 慢视图</strong></p>
<ol>
<li>代码逻辑存在 N+1 查询问题：
<ul>
<li>第一次查询：<code>SELECT * FROM products</code>（1 次）</li>
<li>对每个 product 循环查询：<code>SELECT * FROM reviews, weekly_promotions WHERE productId = ?</code>（N 次）</li>
</ul>
</li>
<li>weekly_promotions 是一个“慢视图”，查询本身就很耗时</li>
<li>两者叠加，导致接口总耗时超过 40 秒</li>
</ol>
<h2 data-id="heading-19">总结</h2>
<p>全链路端到端打通解决了移动端与服务端之间的“可观测性黑洞”问题。通过在移动端注入标准化的 Trace Header，实现：</p>
<ul>
<li><strong>统一追踪</strong>：移动端请求和服务端链路使用同一个 TraceID，一键关联；</li>
<li><strong>精准定位</strong>：从用户手机到数据库，每一跳的耗时清晰可见；</li>
<li><strong>快速定界</strong>：告别“移动端说服务端慢，服务端说网络差”的扯皮；</li>
<li><strong>数据驱动</strong>：基于真实链路数据优化，而非猜测。</li>
</ul>
<p>阿里云 RUM 针对 Android 端实现了对应用性能、稳定性、和用户行为的无侵入式监控采集 SDK，可以参考接入文档体验使用。除了 Android 外，RUM 也支持 Web、小程序、iOS、鸿蒙等多种平台监控分析，相关问题可以加入“RUM 用户体验监控支持群”（钉钉群号： 67370002064）进行咨询。</p>
<p>参考链接：</p>
<p>[1] Android 接入文档：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Farms%2Fuser-experience-monitoring%2Faccess-to-android-applications%3Fspm%3Da2c4g.11186623.help-menu-34364.d_2_0_4_0.76a826bciWLPgj" target="_blank" title="https://help.aliyun.com/zh/arms/user-experience-monitoring/access-to-android-applications?spm=a2c4g.11186623.help-menu-34364.d_2_0_4_0.76a826bciWLPgj" ref="nofollow noopener noreferrer">help.aliyun.com/zh/arms/use…</a></p>
<p>[2] Java 应用监控说明文档：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Farms%2Fapplication-monitoring%2Fuser-guide%2Finstance-monitoring%3Fspm%3Da2c4g.11186623.help-menu-34364.d_2_1_3_5.7d356c4dA57sFw%26scm%3D20140722.H_2635962._.OR_help-T_cn~zh-V_1" target="_blank" title="https://help.aliyun.com/zh/arms/application-monitoring/user-guide/instance-monitoring?spm=a2c4g.11186623.help-menu-34364.d_2_1_3_5.7d356c4dA57sFw&amp;scm=20140722.H_2635962._.OR_help-T_cn~zh-V_1" ref="nofollow noopener noreferrer">help.aliyun.com/zh/arms/app…</a></p>
<p>[3] 持续性能剖析说明文档：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Farms%2Fapplication-monitoring%2Fuser-guide%2Fcontinuous-profiling%2F%3Fspm%3Da2c4g.11186623.help-menu-34364.d_2_1_3_8_2.59c93312PBUPuc%26scm%3D20140722.H_2929831._.OR_help-T_cn~zh-V_1" target="_blank" title="https://help.aliyun.com/zh/arms/application-monitoring/user-guide/continuous-profiling/?spm=a2c4g.11186623.help-menu-34364.d_2_1_3_8_2.59c93312PBUPuc&amp;scm=20140722.H_2929831._.OR_help-T_cn~zh-V_1" ref="nofollow noopener noreferrer">help.aliyun.com/zh/arms/app…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring 6.1新核心：JdbcClient，统一JdbcTemplate两套API的终极方案]]></title>    <link>https://juejin.cn/post/7599581687358095410</link>    <guid>https://juejin.cn/post/7599581687358095410</guid>    <pubDate>2026-01-27T01:23:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599581687358095410" data-draft-id="7599581687358079026" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring 6.1新核心：JdbcClient，统一JdbcTemplate两套API的终极方案"/> <meta itemprop="keywords" content="后端,Java,程序员"/> <meta itemprop="datePublished" content="2026-01-27T01:23:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SimonKing"/> <meta itemprop="url" content="https://juejin.cn/user/4001878056904584"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring 6.1新核心：JdbcClient，统一JdbcTemplate两套API的终极方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4001878056904584/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SimonKing
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T01:23:45.000Z" title="Tue Jan 27 2026 01:23:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>关注我的公众号：【编程朝花夕拾】，可获取首发内容。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd89756fa2d84439a7cbe6a37237ab8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770081825&amp;x-signature=draJFH8e62YAOskK%2BCRW9Ewhdic%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">01 引言</h2>
<p>企业中直接使用JDBC的进行<code>CRUD</code>操作的可能比较少，但是很多框架底层或者测试的时候可能用的比较多，因为<code>Spring</code>官方自带，注入可以直接使用，无需三方依赖。</p>
<p>因为直接使用的比较少，所以关注的人可能不是很多。在浏览<code>Spring Framework</code>时，发现了新的JDBC客户端，函数式操作<code>CRUD</code>相当丝滑，整理一下分享给大家。</p>
<h2 data-id="heading-1">02 JDBC客户端</h2>
<p>在介绍<code>JdbcClient</code>客户端之前，我们先来了解一下老牌的客户端：</p>
<ul>
<li><code>JdbcTemplate</code></li>
<li><code>NamedParameterJdbcTemplate</code></li>
</ul>
<p><code>JdbcTemplate</code>是<code>Spring 1.0</code>的时候引入的，参数通过<code>?</code>占位符占位，然后顺序传递。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT * FROM user_info WHERE id = ?"</span>;
<span class="hljs-type">UserInfo</span> <span class="hljs-variable">userInfo</span> <span class="hljs-operator">=</span> jdbcTemplate.queryForObject(sql, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanPropertyRowMapper</span>&lt;&gt;(UserInfo.class), <span class="hljs-number">10002</span>);
System.out.println(<span class="hljs-string">"jdbcTemplate:"</span> + userInfo);
<span class="hljs-comment">// jdbcTemplate:UserInfo(id=10002, name=王二狗, age=54, sex=null, job=null, birthday=null, createdTime=2025-08-15 15:39:28.0, updateTime=null)</span>
</code></pre>
<p><code>NamedParameterJdbcTemplate</code>是<code>Spring 2.0</code>引入的，通过<code>:name</code> 占位符，然后通过占位符的名称传递参数，不受顺序的限制。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT * FROM user_info WHERE id = :id"</span>;
<span class="hljs-type">MapSqlParameterSource</span> <span class="hljs-variable">params</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MapSqlParameterSource</span>().addValue(<span class="hljs-string">"id"</span>, <span class="hljs-number">10002</span>);
<span class="hljs-type">UserInfo</span> <span class="hljs-variable">userInfo</span> <span class="hljs-operator">=</span> namedParameterJdbcTemplate.queryForObject(sql, params, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanPropertyRowMapper</span>&lt;&gt;(UserInfo.class));
System.out.println(<span class="hljs-string">"MapSqlParameterSource:"</span> + userInfo);
<span class="hljs-comment">// MapSqlParameterSource:UserInfo(id=10002, name=王二狗, age=54, sex=null, job=null, birthday=null, createdTime=2025-08-15 15:39:28.0, updateTime=null)</span>
</code></pre>
<p>这两种客户端虽然可以满足基本的操作，但是不够流畅。随着函数式编程、Lamada表达式被广大开发者接受，这两种客户端的操作方式，可能会被大家一直嫌弃。</p>
<h2 data-id="heading-2">03 JdbcClient</h2>
<p><code>JdbcClient</code>是在<code>Spring 6.1</code>引入的，结合两款老牌的端的参数传递的形式，又加入链式编程，以方面开发者的使用。<code>JdbcClient</code>可以完全取代老牌的客户端。</p>
<p><code>JdbcClient</code>是 Spring 对 JDBC 访问的现代化改进，提供了更简洁、流畅的 API，统一了位置参数和命名参数的使用方式，减少了样板代码，更好地支持现代 Java 特性（Record、Optional等）。</p>
<p>官方地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.spring.io%2Fspring-framework%2Freference%2Fdata-access%2Fjdbc%2Fcore.html%23jdbc-JdbcClient" target="_blank" title="https://docs.spring.io/spring-framework/reference/data-access/jdbc/core.html#jdbc-JdbcClient" ref="nofollow noopener noreferrer">docs.spring.io/spring-fram…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8dae1abd5e8e49fba7ca5d1b6f48559a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770081825&amp;x-signature=KX%2FBreqP7BkIeUDM1kGHdlk%2BU30%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">3.1 查询</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT * FROM user_info WHERE id = :id"</span>;
<span class="hljs-type">String</span> <span class="hljs-variable">sql2</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT * FROM user_info WHERE id = ?"</span>;

<span class="hljs-meta">@Test</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">test01</span><span class="hljs-params">()</span> {
    <span class="hljs-type">UserInfo</span> <span class="hljs-variable">userInfo</span> <span class="hljs-operator">=</span> jdbcClient.sql(sql)
        .param(<span class="hljs-string">"id"</span>, <span class="hljs-number">10002</span>)
        .query(UserInfo.class)
        .single();
    System.out.println(<span class="hljs-string">"sql:"</span> + userInfo);
    System.out.println(<span class="hljs-string">"--------------------"</span>);

    <span class="hljs-type">UserInfo</span> <span class="hljs-variable">userInfo2</span> <span class="hljs-operator">=</span> jdbcClient.sql(sql2)
        .param(<span class="hljs-number">10002</span>)
        .query(UserInfo.class)
        .single();
    System.out.println(<span class="hljs-string">"sql2:"</span> + userInfo2);
}
</code></pre>
<p>执行结果</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05800507acbb4d359645975b556a489f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770081825&amp;x-signature=UfVjnVg4AvwRJedjxVONtRBigmE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">3.2 更新</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT * FROM user_info WHERE id = :id"</span>;
<span class="hljs-type">String</span> <span class="hljs-variable">updateSql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"update user_info set name = :name where id = :id"</span>;

<span class="hljs-meta">@Test</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">test02</span><span class="hljs-params">()</span> {
    jdbcClient.sql(updateSql)
            .param(<span class="hljs-string">"name"</span>, <span class="hljs-string">"刘十三"</span>)
            .param(<span class="hljs-string">"id"</span>, <span class="hljs-number">10002</span>)
            .update();
    <span class="hljs-type">UserInfo</span> <span class="hljs-variable">userInfo</span> <span class="hljs-operator">=</span> jdbcClient.sql(sql)
            .param(<span class="hljs-string">"id"</span>, <span class="hljs-number">10002</span>)
            .query(UserInfo.class)
            .single();
    System.out.println(<span class="hljs-string">"sql:"</span> + userInfo);
}
</code></pre>
<p>执行结果</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5dac86ed43cd4a95a37ec1afbff93fa3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770081825&amp;x-signature=1nq%2BJ%2BWJf0E5asgH90zavURs9gg%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">3.3 新增</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Test</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">test03</span><span class="hljs-params">()</span> {
    jdbcClient.sql(<span class="hljs-string">"INSERT INTO user_info(name, age) VALUES(:name, :age)"</span>)
            .param(<span class="hljs-string">"name"</span>, <span class="hljs-string">"归海一刀"</span>)
            .param(<span class="hljs-string">"age"</span>, <span class="hljs-string">"200"</span>)
            .update();

    <span class="hljs-type">UserInfo</span> <span class="hljs-variable">userInfo</span> <span class="hljs-operator">=</span> jdbcClient.sql(<span class="hljs-string">"SELECT * FROM user_info WHERE name = ?"</span>)
            .param(<span class="hljs-string">"归海一刀"</span>)
            .query(UserInfo.class)
            .single();
    System.out.println(<span class="hljs-string">"sql:"</span> + userInfo);
}
</code></pre>
<p>执行结果</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1a9c9d0543848c5a61c68fa56f16e2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770081825&amp;x-signature=zXogfp0PlQB0gukXD3LqpnCtYYE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">04 小结</h2>
<p><code>JdbcClient</code>相比之前的客户端确实简洁了不少，如果项目中需要使用<code>jdbc</code>客户端，<code>JdbcClient</code>将是你的不二选择。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解耦组件库 CLI 与模板：一种基于 Markdown 的务实插件化实践]]></title>    <link>https://juejin.cn/post/7600060708933124106</link>    <guid>https://juejin.cn/post/7600060708933124106</guid>    <pubDate>2026-01-28T08:19:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600060708933124106" data-draft-id="7596966040921096198" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解耦组件库 CLI 与模板：一种基于 Markdown 的务实插件化实践"/> <meta itemprop="keywords" content="前端,JavaScript,代码规范"/> <meta itemprop="datePublished" content="2026-01-28T08:19:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="donecoding"/> <meta itemprop="url" content="https://juejin.cn/user/3192637500430093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解耦组件库 CLI 与模板：一种基于 Markdown 的务实插件化实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3192637500430093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    donecoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T08:19:37.000Z" title="Wed Jan 28 2026 08:19:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前言</p>
<p>在<a href="https://juejin.cn/spost/7596966040921079814" target="_blank" title="https://juejin.cn/spost/7596966040921079814">上一篇文章</a>中，我们确定了组件库的样式技术栈。但随之而来的问题是：<strong>这些组件模板该如何管理？</strong></p>
<p>很多脚手架会将模板（<code>.tsx</code>, <code>.scss</code>）硬编码在 CLI 源码里。但在长期维护组件库的过程中，我发现这种做法极其僵化。为了让模板既能享受完美的<strong>开发体验</strong>，又能实现<strong>自由定制</strong>，我探索出了一套基于 Markdown 的插件化方案。</p>
<p>这套方案不是为了炫技，而是源于我在工程实践中对“可读性”和“解耦”的真实需求。</p>
<hr/>
<p>一、 为什么我坚持使用 Markdown 存储模板？</p>
<p>在尝试过各种模板载体后，我一直坚持使用 Markdown（MD）来编写组件模板。这并不是一个拍脑袋的决定，而是基于以下两个极其务实的理由：</p>
<ol>
<li>解决“模板占位符”与“语法检查”的冲突</li>
</ol>
<p>如果你直接写一个 <code>.ts</code> 模板文件，里面的变量占位符（如 <code>&lt;%= componentName %&gt;</code>）会导致编辑器疯狂报错，TSLint 也会飘红。<br/>
但将代码包裹在 Markdown 的<strong>代码块</strong>中，这些占位符就变成了纯文本。不仅编辑器不再报错，你还能天然享受到 Markdown 对不同语言（TS/SCSS/Vue）的代码高亮支持。</p>
<ol start="2">
<li>文档即模板，可读性至上</li>
</ol>
<p>组件模板不应是冷冰冰的字符串。在 MD 文件中，我可以在代码块之外书写逻辑说明、设计规范甚至 Todo List。对于插件开发者来说，打开 MD 文件就像在读一份技术文档，这种<strong>直观性</strong>是 <code>.ejs</code> 或 <code>.txt</code> 无法比拟的。</p>
<hr/>
<p>二、 从“内置模板”到“插件化解耦”</p>
<p>虽然 MD 解决了模板的开发体验，但如果模板依然耦合在 CLI 工具中，当我想切换样式方案（如从 Sass 换到 Less）时，依然要动 CLI 的核心代码。</p>
<p>于是，我借鉴了插件化的思想，将 MD 模板从 CLI 中剥离，变成了<strong>独立可配置的插件包</strong>。</p>
<ol>
<li>核心调度层：轻量化的 CLI</li>
</ol>
<p>CLI 不再关心模板长什么样，它只负责三件事：</p>
<ul>
<li><strong>读取配置：</strong>  识别用户安装了哪个模板插件。</li>
<li><strong>动态加载：</strong>  从 <code>node_modules</code> 中搜索并 <code>import</code> 对应的插件。</li>
<li><strong>执行渲染：</strong>  调用插件提供的协议，将字符串写入磁盘。</li>
</ul>
<ol start="2">
<li>模板内容层：独立的 NPM 插件</li>
</ol>
<p>每个插件包都是一个独立的生态。你可以发布 <code>@my-ui/plugin-sass</code>，也可以发布 <code>@my-ui/plugin-less</code>。插件内部包含了对应的 MD 模板文件和一个简单的映射配置文件。</p>
<hr/>
<p>三、 技术实现：避开 AST 的过度设计</p>
<p>关于如何解析 MD 并生成组件，我并没有选择复杂的 AST（抽象语法树）方案，因为对于“查找-替换”这种需求，AST 属于典型的过度设计。</p>
<ul>
<li><strong>字符串切片：</strong>  CLI 采用极简的逻辑，通过识别 Markdown 的代码块标识符（```）来提取内容。</li>
<li><strong>Lodash Template：</strong>  提取出的字符串直接交给 <code>lodash.template</code> 处理。它稳定、轻量，能完美处理组件名替换、条件渲染等逻辑。</li>
</ul>
<p>这种“MD 存储 + 字符串解析”的组合，保证了系统在拥有强大扩展性的同时，依然保持了极低的维护门槛。</p>
<hr/>
<p>四、 插件化协议的闭环</p>
<p>我定义了一套极其精简的协议，确保 CLI 能顺畅地与插件通信。一个插件包只需包含：</p>
<ol>
<li><strong>Markdown 模板：</strong>  存放带变量的代码块。</li>
<li><strong>入口配置文件：</strong>  告知 CLI 每个代码块应映射到哪个目标文件路径。</li>
</ol>
<p>这种设计让组件库的扩展变得极其简单：如果你想尝试一种新的样式方案，只需新写一个 MD 模板插件并修改配置文件，无需触碰一行 CLI 逻辑。</p>
<hr/>
<p>结语</p>
<p>这一套架构的核心在于： <strong>“尊重开发者的感官（可读性），同时保持工程的边界（解耦）。”</strong></p>
<p>通过 Markdown，我解决了模板编写时的语法冲突；通过插件系统，我解决了工具链的灵活度。至此，我们的组件库脚手架已经变成了一个 <strong>“样式可插拔、模板可视化”</strong> 的工程底座。</p>
<p>那么，在实际编写这些插件时，有哪些具体的体验优化？如何处理复杂的变量计算？在专栏的最后一篇中，我们将深入实战，聊聊插件开发的细节以及我对“零学习成本”工程化的终极追求。</p>
<p><strong>下篇预告：</strong>  《模板开发的体验革命：为什么 Markdown 是插件化的最后一公里》</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Agent Skills使用指南：让AI智能体拥有"即插即用"的超能力]]></title>    <link>https://juejin.cn/post/7599666118007455787</link>    <guid>https://juejin.cn/post/7599666118007455787</guid>    <pubDate>2026-01-27T05:15:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599666118007455787" data-draft-id="7599550337385300031" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Agent Skills使用指南：让AI智能体拥有&quot;即插即用&quot;的超能力"/> <meta itemprop="keywords" content="Claude,Agent"/> <meta itemprop="datePublished" content="2026-01-27T05:15:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="奇舞精选"/> <meta itemprop="url" content="https://juejin.cn/user/4388906147515367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Agent Skills使用指南：让AI智能体拥有"即插即用"的超能力
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4388906147515367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    奇舞精选
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T05:15:26.000Z" title="Tue Jan 27 2026 05:15:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    55
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文作者为 360 奇舞团前端开发工程师</p>
</blockquote>
<p>当前的AI智能体就像是一位<strong>拥有超强算力却患有‘短期失忆症’的超级员工</strong>：虽然它能迅速掌握复杂的单次指令，却无法将过往的交互经验沉淀为长期的工作记忆。每一次对话窗口的开启都等同于‘恢复出厂设置’，迫使你不得不反复进行基础的背景同步与流程教学，导致大量精力被消耗在低效的重复沟通之中。</p>
<p>继 2025 年初以 MCP 协议解决连接难题后，Anthropic 于 10 月再推杀手锏——<strong>Agent Skills</strong>。它将复杂的任务流程固化为可复用的‘技能组件’，让 AI 能够按需调用能力，无需重复训练。这一创新直接重塑了 AI 开发生态，让‘能力复用’成为新常态。</p>
<h2 data-id="heading-0">一、什么是Agent Skills？</h2>
<h3 data-id="heading-1">1.1 Agent Skills概念</h3>
<p>Agent Skills是包含指令、脚本和资源的文件夹，智能体可以发现并使用它们来更准确、更高效地完成特定任务。</p>
<p>用一个更生动的比喻：</p>
<ul>
<li>
<p><strong>传统方式</strong>：每次都要向AI详细解释"如何做"</p>
</li>
<li>
<p><strong>Agent Skills</strong>：给AI一本"操作手册"，需要时自动调用</p>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/295135a81277489691a724adc3da794e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWH6Iie57K-6YCJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770109031&amp;x-signature=M2VR1y2dcnEtQjAENl77QTiq9co%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">1.2 Skills与其他技术的区别</h3>
<p>很多人会困惑：Skills、Prompts、MCP有什么区别？</p>





























<table><thead><tr><th>技术</th><th>本质</th><th>作用范围</th><th>持久性</th></tr></thead><tbody><tr><td><strong>Prompts</strong></td><td>对话级指令</td><td>单次任务</td><td>临时</td></tr><tr><td><strong>Agent Skills</strong></td><td>领域知识包</td><td>可复用能力</td><td>持久化</td></tr><tr><td><strong>MCP</strong></td><td>工具连接协议</td><td>外部系统对接</td><td>持久化</td></tr></tbody></table>
<p><strong>用软件架构来理解</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">应用层：Agent Skills（领域知识、工作流、最佳实践）
<span class="hljs-code">    ↓
传输层：MCP（标准化接口、工具调用）
    ↓
基础设施层：数据库、API、文件系统
</span></code></pre>
<p>如果说MCP为智能体提供了"手"来操作工具，那么Skills就提供了"操作手册"或"SOP"，教导智能体如何正确使用这些工具。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8090f40835744cf79c940ccb7a3a160a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWH6Iie57K-6YCJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770109031&amp;x-signature=dPt8vSya4r0AIk36iCrJOJ8zW5w%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">二、Agent Skills的技术原理</h2>
<h3 data-id="heading-4">2.1 渐进式披露（Progressive Disclosure）</h3>
<p>Agent Skills最核心的创新是<strong>三层渐进式加载机制</strong>：</p>
<h4 data-id="heading-5"><strong>第一层：发现阶段（~50 tokens）</strong></h4>
<p>智能体启动时，只加载所有技能的元数据（名称+描述）</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">data-analysis-expert</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">专业数据分析技能，支持CSV/Excel处理和可视化</span>
<span class="hljs-meta">---
</span></code></pre>
<h4 data-id="heading-6"><strong>第二层：激活阶段</strong></h4>
<p>当任务相关时，才加载完整的SKILL.md指令文档</p>
<h4 data-id="heading-7"><strong>第三层：执行阶段</strong></h4>
<p>按需动态访问引用的脚本和资源文件</p>
<p>这种设计让智能体可以同时"掌握"数十甚至上百个技能，而不会因为上下文过载而失效。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25266524c4ea4771925e14e074aeb868~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWH6Iie57K-6YCJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770109031&amp;x-signature=IS%2Bkz9qYOXzNS9OOrlU0DjUxK84%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">2.2 标准文件结构</h3>
<p>一个完整的Skill通常包含：</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">my</span>-skill/
├── SKILL.md           <span class="hljs-comment"># 核心指令文档（必需）</span>
├── scripts/           <span class="hljs-comment"># 可执行脚本</span>
│   ├── process.py
│   └── validate.sh
├── reference/         <span class="hljs-comment"># 参考文档</span>
│   └── api-docs.md
└── assets/            <span class="hljs-comment"># 资源文件</span>
    ├── templates/
    └── examples/
</code></pre>
<p><strong>SKILL.md示例</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">---
name: github-actions-debugger
<span class="hljs-section">description: 帮助调试失败的GitHub Actions工作流
---</span>

<span class="hljs-section"># GitHub Actions调试专家</span>

<span class="hljs-section">## 使用时机</span>
当用户遇到CI/CD失败、构建错误或部署问题时使用

<span class="hljs-section">## 工作流程</span>
<span class="hljs-bullet">1.</span> 使用<span class="hljs-code">`list_workflow_runs`</span>工具查看最近的运行状态
<span class="hljs-bullet">2.</span> 使用<span class="hljs-code">`summarize_job_log_failures`</span>获取失败摘要
<span class="hljs-bullet">3.</span> 分析日志，定位问题根源
<span class="hljs-bullet">4.</span> 提供修复建议和代码示例

<span class="hljs-section">## 常见问题检查清单</span>
<span class="hljs-bullet">-</span> [ ] 环境变量和密钥配置
<span class="hljs-bullet">-</span> [ ] 依赖版本兼容性
<span class="hljs-bullet">-</span> [ ] 权限设置
<span class="hljs-bullet">-</span> [ ] 超时配置
</code></pre>
<h2 data-id="heading-9">三、Agent Skills的使用</h2>
<h3 data-id="heading-10">3.1 适用场景分析</h3>
<h4 data-id="heading-11"><strong>场景1：发现自己总是重复相同的指令</strong></h4>
<p><strong>案例</strong>：每次让AI写技术文档，都要说明：</p>
<ul>
<li>使用Markdown格式</li>
<li>包含目录</li>
<li>代码块要标注语言</li>
<li>添加实例和图表</li>
</ul>
<p><strong>Skills解决方案</strong>：创建<code>technical-writing</code>技能包，将这些规范固化。</p>
<h4 data-id="heading-12"><strong>场景2：需要遵循特定的领域知识或规范</strong></h4>
<p><strong>案例</strong>：公司的品牌设计规范（颜色、字体、布局）</p>
<p><strong>Skills解决方案</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">---
name: brand-guideline
<span class="hljs-section">description: 公司品牌视觉规范
---</span>

<span class="hljs-section">## 品牌色彩</span>
<span class="hljs-bullet">-</span> 主色：#FF6B6B（活力红）
<span class="hljs-bullet">-</span> 辅色：#4ECDC4（清新蓝）
<span class="hljs-bullet">-</span> 文字色：#2C3E50（深灰）

<span class="hljs-section">## 字体规范</span>
<span class="hljs-bullet">-</span> 标题：思源黑体 Bold
<span class="hljs-bullet">-</span> 正文：思源宋体 Regular
<span class="hljs-bullet">-</span> 代码：Fira Code

<span class="hljs-section">## 应用原则</span>
所有输出的视觉内容必须遵循以上规范...
</code></pre>
<h4 data-id="heading-13"><strong>场景3：复杂多步骤工作流</strong></h4>
<p><strong>案例</strong>：竞品分析报告制作</p>
<ol>
<li>收集竞品数据</li>
<li>数据清洗和分析</li>
<li>生成可视化图表</li>
<li>撰写分析报告</li>
<li>制作PPT演示</li>
</ol>
<p><strong>Skills解决方案</strong>：组合多个技能模块</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 智能体自动调用技能链</span>
<span class="hljs-variable">$web</span>-scraper → <span class="hljs-variable">$data</span>-analyzer → <span class="hljs-variable">$chart</span>-generator → <span class="hljs-variable">$report</span>-writer → <span class="hljs-variable">$pptx</span>-creator
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88058630a4954bff813f5d3d242fa4fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWH6Iie57K-6YCJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770109031&amp;x-signature=ukis7kP2JzCh44dmDwn4s8r0hLE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-14">3.2 快速上手：使用Claude Code</h3>
<h4 data-id="heading-15"><strong>1: 安装Claude Code</strong></h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># macOS/Linux</span>
curl -fsSL https://code.claude.com/install.sh | sh

<span class="hljs-comment"># Windows (使用PowerShell)</span>
irm https://code.claude.com/install.ps1 | iex
</code></pre>
<h4 data-id="heading-16"><strong>2: 安装预构建技能</strong></h4>
<p>Claude提供官方技能包：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在Claude Code中</span>
/skills

<span class="hljs-comment"># 选择要安装的技能</span>
- PowerPoint处理 (pptx)
- Excel数据分析 (xlsx)
- Word文档编辑 (docx)
- PDF生成 (pdf)
</code></pre>
<h4 data-id="heading-17"><strong>3: 使用技能</strong></h4>
<p><strong>方式1：显式调用</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用$符号直接指定技能</span>
<span class="hljs-variable">$pptx</span> 帮我创建一个产品发布会PPT，包含封面、产品特性、市场分析、Q&amp;A四个部分
</code></pre>
<p><strong>方式2：自动触发</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Claude会自动判断需要使用的技能</span>
帮我分析这个销售数据Excel，生成月度报告并制作可视化图表
<span class="hljs-comment"># → 自动激活 $xlsx 和 $chart-generator</span>
</code></pre>
<h3 data-id="heading-18">3.3 创建自定义技能</h3>
<h4 data-id="heading-19"><strong>方法1：手动创建</strong></h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 创建技能文件夹</span>
<span class="hljs-built_in">mkdir</span> -p ~/.config/claude-code/skills/my-first-skill

<span class="hljs-comment"># 2. 创建SKILL.md</span>
<span class="hljs-built_in">cat</span> &gt; ~/.config/claude-code/skills/my-first-skill/SKILL.md &lt;&lt; <span class="hljs-string">'EOF'</span>
---
name: blog-writer
description: 专业技术博客写作助手
---

<span class="hljs-comment"># 技术博客写作专家</span>

<span class="hljs-comment">## 写作规范</span>
1. 标题：简洁有力，包含关键词
2. 结构：引言→核心内容→实战案例→总结
3. 代码：必须可运行，包含完整示例
4. 配图：每个核心概念配示意图

<span class="hljs-comment">## 输出格式</span>
- 使用Markdown
- 代码块标注语言
- 添加emoji增强可读性
- 文末附参考资源
</code></pre>
<h4 data-id="heading-20"><strong>方法2：使用Skill Creator</strong></h4>
<p>如果你不想从零开始写 Skill，那么可以直接让 AI 来帮你生成。官方提供了一个叫做 skill-creator 的工具，只需要简单描述你希望 Skill 实现的功能和能力，它就能自动生成对应的 Skill，让你把精力更多放在业务本身，而不是重复造轮子。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装官方skill-creator</span>
<span class="hljs-variable">$skill</span>-creator

<span class="hljs-comment"># 描述你的需求</span>
我需要一个技能包，用于：
- 自动化代码审查
- 检查代码规范（变量命名、注释完整性）
- 生成审查报告

<span class="hljs-comment"># AI会自动生成完整的SKILL.md和相关脚本</span>
</code></pre>
<h3 data-id="heading-21">3.4 技能组合</h3>
<p>在实际工作中，很多任务并不是单一技能就能搞定的。比如你要做一份市场分析报告，需要先从网上收集数据，再用Excel处理数据，然后生成可视化图表，最后写成Word报告。如果每个步骤都要你手动切换技能、传递数据，那和没用AI有什么区别？技能组合要解决的就是这个痛点，它让多个技能能够协同工作、数据自动流转，你只需要一句话触发整个工作流，中间完全不用插手。更重要的是，整个流程按照统一标准执行，避免了人为失误，而且一旦定义好，就可以反复使用，彻底告别重复劳动。</p>
<p><strong>案例：自动化内容生产流水线</strong></p>
<p>痛点：每次写公众号文章都要经历选题→资料收集→撰写→配图→SEO优化→发布，至少半天时间。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># content-pipeline技能</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">content-pipeline</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">全自动内容生产流程</span>
<span class="hljs-meta">---
</span>
<span class="hljs-comment">## 工作流</span>
<span class="hljs-number">1</span><span class="hljs-string">.</span> <span class="hljs-string">$web-researcher:</span> <span class="hljs-string">收集行业资讯和热点话题</span>
<span class="hljs-number">2</span><span class="hljs-string">.</span> <span class="hljs-string">$content-outliner:</span> <span class="hljs-string">根据SEO策略生成文章大纲</span>
<span class="hljs-number">3</span><span class="hljs-string">.</span> <span class="hljs-string">$blog-writer:</span> <span class="hljs-string">撰写正文内容</span>
<span class="hljs-number">4</span><span class="hljs-string">.</span> <span class="hljs-string">$image-generator:</span> <span class="hljs-string">生成配图（调用DALL-E</span> <span class="hljs-string">API）</span>
<span class="hljs-number">5</span><span class="hljs-string">.</span> <span class="hljs-string">$seo-optimizer:</span> <span class="hljs-string">优化关键词和meta标签</span>
<span class="hljs-number">6</span><span class="hljs-string">.</span> <span class="hljs-string">$social-publisher:</span> <span class="hljs-string">发布到各平台</span>

<span class="hljs-comment">## 执行触发</span>
<span class="hljs-string">当用户说"写一篇关于[主题]的文章"时自动启动</span>
</code></pre>
<p><strong>使用结果：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 你只需要说一句话</span>
写一篇关于<span class="hljs-string">"2025年AI发展趋势"</span>的文章

<span class="hljs-comment"># AI自动完成：</span>
✓ 搜索最新AI新闻和报告（2分钟）
✓ 生成结构化大纲（1分钟）
✓ 撰写5000字文章（3分钟）
✓ 生成3张配图（2分钟）
✓ SEO优化（1分钟）
✓ 一键发布到公众号、知乎、掘金（1分钟）

总耗时：10分钟 vs 人工4小时
</code></pre>
<h2 data-id="heading-22">四、Agent Skills生态与工具</h2>
<h3 data-id="heading-23">4.1 官方技能库</h3>
<p><strong>Anthropic官方技能集</strong>：</p>
<ul>
<li>文档处理（PowerPoint、Excel、Word、PDF）</li>
<li>数据分析和可视化</li>
<li>Anthropic品牌规范</li>
</ul>
<h3 data-id="heading-24">4.2 社区生态工具</h3>
<h4 data-id="heading-25"><strong>Skill Seekers</strong></h4>
<p>自动抓取文档网站、GitHub仓库和PDF文件转换为Agent Skills</p>
<p><strong>应用</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 将Spring官方文档转换为技能包</span>
skill-seeker convert https://spring.io/docs --output spring-framework-skill
</code></pre>
<h4 data-id="heading-26"><strong>Superpowers</strong></h4>
<p>涵盖完整编程项目工作流的技能集合，包括：</p>
<ul>
<li>项目初始化和配置</li>
<li>代码规范检查</li>
<li>测试覆盖率分析</li>
<li>CI/CD自动化</li>
</ul>
<h4 data-id="heading-27"><strong>技能商店（SkillsMP）</strong></h4>
<ul>
<li>自动抓取GitHub上的所有Skills项目</li>
<li>按分类、更新时间、Star数量整理</li>
<li>一键下载和安装</li>
</ul>
<h3 data-id="heading-28">4.3 跨平台支持</h3>
<p>Agent Skills作为开放标准，已被多个平台支持：</p>








































<table><thead><tr><th>平台</th><th>支持状态</th><th>使用方式</th></tr></thead><tbody><tr><td><strong>Claude Code</strong></td><td>完整支持</td><td>原生集成</td></tr><tr><td><strong>Claude.ai</strong></td><td>完整支持</td><td>设置上传</td></tr><tr><td><strong>VS Code</strong></td><td>完整支持</td><td>chat.useAgentSkills</td></tr><tr><td><strong>Cursor</strong></td><td>完整支持</td><td>文档支持</td></tr><tr><td><strong>GitHub Copilot</strong></td><td>完整支持</td><td>原生集成</td></tr><tr><td><strong>OpenAI Codex</strong></td><td>完整支持</td><td>官方支持</td></tr></tbody></table>
<h2 data-id="heading-29">五、最佳实践与注意事项</h2>
<h3 data-id="heading-30">5.1 技能设计原则</h3>
<h4 data-id="heading-31"><strong>1. 单一职责</strong></h4>
<p>每个技能专注一个明确的能力领域</p>
<p><strong>错误示例</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">everything-helper</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">可以做任何事情的全能助手</span>
</code></pre>
<p><strong>正确示例</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">api-documentation-generator</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">根据代码自动生成API文档</span>
</code></pre>
<h4 data-id="heading-32"><strong>2. 清晰的触发条件</strong></h4>
<p>明确说明何时应该使用这个技能</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">## 使用时机</span>
<span class="hljs-bullet">-</span> 用户提到"生成API文档"
<span class="hljs-bullet">-</span> 用户上传了包含接口定义的代码文件
<span class="hljs-bullet">-</span> 用户询问"如何记录API"
</code></pre>
<h4 data-id="heading-33"><strong>3. 提供具体示例</strong></h4>
<p>包含完整的输入输出示例</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">## 示例</span>

<span class="hljs-section">### 输入</span>
<span class="hljs-code">```python
@app.route('/users/&lt;int:user_id&gt;', methods=['GET'])
def get_user(user_id):
    """获取用户信息"""
    user = User.query.get(user_id)
    return jsonify(user.to_dict())
</span></code></pre>
<h3 data-id="heading-34">输出</h3>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">## GET /users/{user<span class="hljs-emphasis">_id}

获取指定ID的用户信息

<span class="hljs-strong">**参数**</span>：
- `user_</span>id` (integer): 用户唯一标识</span>

<span class="hljs-strong">**返回**</span>：
<span class="hljs-bullet">-</span> 200: 用户对象
<span class="hljs-bullet">-</span> 404: 用户不存在
</code></pre>
<h3 data-id="heading-35">5.2 常见问题</h3>
<h4 data-id="heading-36"><strong>1：过度复杂</strong></h4>
<p>不要把太多逻辑塞进一个技能，善用技能组合</p>
<h4 data-id="heading-37"><strong>2：缺乏维护</strong></h4>
<p>技能需要随着业务变化及时更新</p>
<h4 data-id="heading-38"><strong>3：忽略错误处理</strong></h4>
<p>在脚本中添加健壮的错误处理逻辑</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># scripts/process.py</span>
<span class="hljs-keyword">import</span> sys

<span class="hljs-keyword">try</span>:
    <span class="hljs-comment"># 核心逻辑</span>
    result = process_data()
    <span class="hljs-built_in">print</span>(result)
<span class="hljs-keyword">except</span> FileNotFoundError:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"错误：找不到输入文件"</span>, file=sys.stderr)
    sys.exit(<span class="hljs-number">1</span>)
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"处理失败：<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>, file=sys.stderr)
    sys.exit(<span class="hljs-number">1</span>)
</code></pre>
<h2 data-id="heading-39">六、总结</h2>
<p>Agent Skills不仅是技术工具，更是一种思维方式的转变——<strong>将专业知识模块化、流程化、可复用化</strong>。在AI时代，这将成为个人和组织的核心竞争力。</p>
<h2 data-id="heading-40">参考资源</h2>
<p>Agent Skills官方文档:<a href="https://link.juejin.cn?target=https%3A%2F%2Fagentskills.io" target="_blank" title="https://agentskills.io" ref="nofollow noopener noreferrer">agentskills.io</a>
Anthropic工程博客:<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fengineering%2Fequipping-agents-for-the-real-world-with-agent-skills" target="_blank" title="https://www.anthropic.com/engineering/equipping-agents-for-the-real-world-with-agent-skills" ref="nofollow noopener noreferrer">www.anthropic.com/engineering…</a>
官方技能库:<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills" target="_blank" title="https://github.com/anthropics/skills" ref="nofollow noopener noreferrer">github.com/anthropics/…</a>
Awesome Agent Skills:<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fskillmatic-ai%2Fawesome-agent-skills" target="_blank" title="https://github.com/skillmatic-ai/awesome-agent-skills" ref="nofollow noopener noreferrer">github.com/skillmatic-…</a>
SkillsMP技能商店:<a href="https://link.juejin.cn?target=https%3A%2F%2Fskillsmp.com" target="_blank" title="https://skillsmp.com" ref="nofollow noopener noreferrer">skillsmp.com</a></p>
<hr/>
<p><strong>关于奇舞团</strong></p>
<p>奇舞团是 360 集团最大的大前端团队，非常重视人才培养，有工程师、讲师、翻译官、业务接口人、团队 Leader 等多种发展方向供员工选择，并辅以提供相应的技术力、专业力、通用力、领导力等培训课程。奇舞团以开放和求贤的心态欢迎各种优秀人才关注和加入奇舞团。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>