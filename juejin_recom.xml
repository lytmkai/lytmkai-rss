<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[扣子彻底变了！拥抱 Vibe Coding，不只是智能体！]]></title>    <link>https://juejin.cn/post/7586893663075860490</link>    <guid>https://juejin.cn/post/7586893663075860490</guid>    <pubDate>2025-12-23T13:02:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586893663075860490" data-draft-id="7586877892467851291" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="扣子彻底变了！拥抱 Vibe Coding，不只是智能体！"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-23T13:02:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苍何"/> <meta itemprop="url" content="https://juejin.cn/user/588993963763405"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            扣子彻底变了！拥抱 Vibe Coding，不只是智能体！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993963763405/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苍何
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T13:02:58.000Z" title="Tue Dec 23 2025 13:02:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是苍何的第 466 篇原创！</p>
<p>大家好，我是苍何。</p>
<p>前几天去火山大会上，最让人不可思议的是，在扣子的分论坛上，门口挤爆了，还有很多人根本进不去。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01c6403bbcca4bbdbf8df1ed92cbea65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=DqnWKTJQC%2BygCPn%2FZe1dO8RifDk%3D" alt="图片" loading="lazy"/></p>
<p>不用想也知道，扣子终于在沉寂了许久后，终于放大招了，我也有幸参与了扣子新产品发布的闭门会。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d26618152b51452faa51ec13083e14f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=MvPe6FZtSmTnXxX3h171BK5dDys%3D" alt="图片" loading="lazy"/></p>
<p>结合一些我了解到的（能说的东西），也想给大家做个分享。</p>
<p>先说结论，这次扣子直接强势推出<strong>扣子编程</strong>，可以说是扣子全面迈向 Vibe Coding 的重要一步。</p>
<p>在扣子编程，可以直接通过对话轻松构建智能体（Vibe Agent）、工作流（Vibe WorkFlow）和网站。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae23e1148a5246ccb47c119215041d41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=PwCSsrHI17QfrstZPjhtSYSDm5E%3D" alt="图片" loading="lazy"/></p>
<p>他是长这样子的，可以看到原先在扣子上不同空间项目和资源这些数据都同步过来了，现在更像是一站式 AI 开发平台了，可以通过对话创建智能体、工作流、网页应用和移动应用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/620b8102b8f7480c8548b5ba62622bcd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=rhrGYrubni2a%2FCzbaDh6T7kg0SA%3D" alt="图片" loading="lazy"/></p>
<p>发布会上说，扣子编程是首个提供完整 Vibe Infra 服务的开发平台，提供开箱即用的云端环境、拥有完善的集成与基础设施，内置模型、数据库、对象存储等常用能力。提供一键部署服务。</p>
<p>其实从闭门会回来后，我就一直在适用扣子编程，并做了不少的应用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35807dfccd9448d29f619cf0495932d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=TwT6D0arFlLFA22Vd90v%2BRuI0KQ%3D" alt="图片" loading="lazy"/></p>
<p>感触还蛮大的，原先要手动创建的智能体，拖拉拽才能完成的工作流，现在都是直接对话式生成，非常方便，一句话做应用再次成为了现实。</p>
<p>先 showcase 吧，看下扣子编程究竟能做哪些东西。</p>
<p>一句话生成天气查询智能体，并按照指定格式输出：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffcbee24e2d44d098bf3918d082172df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=p3RxwlCq86KXjKJljd80dJa0rJY%3D" alt="图片" loading="lazy"/></p>
<p>一句话生成 AI 早报资讯卡片，并自动同步到飞书多维表格和发送飞书消息：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/989bccb6ccba47498c88c6cc9f8701cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=Su7f7mKyEKwTWayLzl792LZNu6U%3D" alt="图片" loading="lazy"/></p>
<p>对话生成极客风格的个人主页应用，并可一键分享或者部署。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58a04622b59444d8879bf860e1b7ec76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=Xki4Cx%2BhvDaLW6vZdP7Q2w20TIg%3D" alt="图片" loading="lazy"/></p>
<p>生成作品集应用网站：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6340a16fba842d28ede377521c21c7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=zEkTlKaXKo%2BqZe8IpLGheiAOtAM%3D" alt="图片" loading="lazy"/></p>
<p>小红书图片生成器，可根据主题生成小红书图片。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eeca254f122749efa5f9b987bf1657bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=eSs9XUO4xvZeOKbfjsb5xsK4gDM%3D" alt="图片" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c42fec7549904947bc740cf512aeb29c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=zNEOp%2BNPnmlXZP99YGAKwtuy51w%3D" alt="图片" loading="lazy"/></p>
<p>可能你说上面的太简单，我还用扣子编程做了个前后端并带有数据库的供应商后台管理系统：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/886eae96a43249eca772fab780897026~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=G09ev3ZCxRQlqwSOsC208UfWGvo%3D" alt="图片" loading="lazy"/></p>
<p>具备供应商管理的基本功能以及添加搜索供应商，管理所有产品信息和库存，甚至可以导出数据：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59f5859408254105baa642cef0edbca4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=pXnXrV7nmTeVxk5jbcLMjQQY%2F6E%3D" alt="图片" loading="lazy"/></p>
<p>支持查看仪表盘信息：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a705d6a47d8f4bdbb6eab74cf2fc99b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=vsemTVcZb6lcjzGH9G%2BoH42T0q0%3D" alt="图片" loading="lazy"/></p>
<p>当然了，基本的登录注册功能也是必须有的：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1a4f09cb7174c83a942bb277790fc7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=ij3IIYdbuw4iD9lDHBjdZ7CibX8%3D" alt="图片" loading="lazy"/></p>
<p>可以说是一个合格的全栈应用了，而这个系统也是我在扣子编程中多轮对话完成的系统，他是一个完整的后台管理系统。</p>
<p>下面，从我实测的角度来给大家介绍下如何用好扣子编程吧。</p>
<p>原先的扣子，说实话，上手是有一些学习成本的，特别是工作流的创建，节点的搭建并不是一两句话就能搞定的事。</p>
<p>之前通过扣子搭建的 AI 视频工作流，很多同学用起来是简单，但真要自己去改，就显得有些摸不着头脑了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85e2dbbaf17d47f0b15d0a5fbe300d81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=MVYRdp7oBfl14t35IWunjRamwxM%3D" alt="图片" loading="lazy"/></p>
<p>因为节点真的有点儿长，长到不想看的那种🐶。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e0cbd70037f4334ac6769de594a8382~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=%2Fs1ZfAjtErCNZ6nVC6hSrQJcvNk%3D" alt="图片" loading="lazy"/></p>
<p>所以，我认为，扣子编程的推出，其实是将搭建智能体工作流以及应用这件事的门槛又降低了一个维度，你现在安全可以通过对话式去创建。</p>
<p>可以在原先的扣子最上方，点击进入扣子编程，也可以直接输入链接进入：code.coze.cn</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/471f2b1089354275ae06c63e36fd9264~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=J5qH%2FlBNUE7%2B8Vrr9GrvZ2lcf1o%3D" alt="图片" loading="lazy"/></p>
<p>进入后，原先扣子的「空间切换」、「资源库」位置没变，「项目开发」改为了「项目管理」，在扣子编程开发的智能体、工作流或者应用都会有一个 new 的标识：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01c8fa3f666c492c8d428d0515a7df90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=2fN3cVPiCBmuhxeyyIQYoNFQdto%3D" alt="图片" loading="lazy"/></p>
<p>也可以新建文件夹来存放，这个在原先扣子中也同样可以看到，两边数据是相通的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f358f44d85e745d5b16048989ab1138a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=sDsNb0D3aURVmLfLk5RUVkwoLTs%3D" alt="图片" loading="lazy"/></p>
<p>在扣子编程中新增了集成管理，一共分为内置集成和外部集成，内置集成集成了大语言模型、生图大模型，数据库、对象存储等常用元能力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6547535ab1644b89a4c7ec1db8369634~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=0YeRkjtF9oUNFRX6P1krsCBYh%2Fk%3D" alt="图片" loading="lazy"/></p>
<p>外部集成可以用飞书、企微、邮件、公众号等能力。像上面的几个 case 都分别用了内外部集成的能力，可以说很方便了。</p>
<p>如果我们要做一个智能体，现在只需要在扣子编程中输入需求，比如：</p>
<blockquote>
<p>做一个实时天气查询助手智能体，能够准确、及时地为用户提供全国各省、城市的天气情况。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb506bc7e06f4bae966ae0b7600813d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=A%2F3Hdgkq6o%2F20XYjhschFgOXHQo%3D" alt="图片" loading="lazy"/></p>
<p>扣子编程会自动创建任务来完成智能体的开发，包括会自动创建工具，联网搜索，自动编写智能体所需的系统提示词：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b63fc096a30c4cb0a19cf84be9e5836e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=i3T16GhKsRblFDlXMb5CMf4hlIU%3D" alt="图片" loading="lazy"/></p>
<p>可以直接切换选择不同模型来匹配 agent 节点，在右上角可以切换文件目录，查看 agent 的代码：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/447b56a74736459396681b38e69a9cd3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=zbaAavwxznbo0OWEvbT4JulyumE%3D" alt="图片" loading="lazy"/></p>
<p>可以设置编辑器主题、字体、代码编辑行为、上下文管理等常用设置。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4451c7c84ef4016b48c2b18c88e390e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=LnbRee98tclIy%2FzsF0n%2BfcDAj%2FI%3D" alt="图片" loading="lazy"/></p>
<p>调试 OK 后，就可以一键部署，可以绑定自己的域名部署后，查看线上环境日志，还是很方便的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/939f0437c06f4818b834eb709521d2d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=BZlMkikMsbG6ij%2FBOZxbG7H9atM%3D" alt="图片" loading="lazy"/></p>
<p>除此之外，还有非常多的开发工具及集成服务可以使用的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9afb3b02f1e449aca09fc34ae317f362~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099777&amp;x-signature=VNI4N8yAoFmOYwVe76b6gvjyPr0%3D" alt="图片" loading="lazy"/></p>
<p>在做智能体开发的时候，有个点还是期望扣子后面能优化的，就是我想使用之前资源库中的工作流，让他去找，没办法找到并使用。</p>
<p>这要是打通了，就更方便了，直接就可以原地整活，把之前做的工作流智能体用扣子编程重新做更多好的应用出来。</p>
<p>在 vibe 应用的时候，一次输入的需求可以明确详细一些，第一版产出的效果就会好些，比如供应商管理系统我给的提示词是这样子的:</p>
<pre><code class="hljs language-swift" lang="swift">你是一位全栈工程师，同时精通产品规划和<span class="hljs-type">UI设计</span><span class="hljs-operator">。</span> 我想开发一个供应商后台管理系统，
<span class="hljs-number">1</span><span class="hljs-operator">、</span>思考用户需要供应商管理系统app实现哪些功能 
<span class="hljs-number">2</span><span class="hljs-operator">、</span>结合用户需求，以产品经理的视角去规划的功能<span class="hljs-operator">、</span>页面和交互； 
<span class="hljs-number">3</span><span class="hljs-operator">、</span>作为设计师思考这些原型界面的设计，并以设计师的视角去输出完整的<span class="hljs-type">UI</span><span class="hljs-operator">/</span><span class="hljs-type">UX；</span> 
<span class="hljs-number">4</span><span class="hljs-operator">、</span>可以使用<span class="hljs-type">FontAwesome等开源图标库，让界面显得更精美和接近真实</span> 
<span class="hljs-number">5</span><span class="hljs-operator">、</span>引入tailwindcss来完成，而不是变成style样式，图片使用unsplash 我希望这些界面是需要能直接拿去进行推广的<span class="hljs-operator">。</span>
</code></pre>
<p>然后通过多轮对话调整，指定能力和调试 bug，效果会更好一些。</p>
<h2 data-id="heading-0">最后聊聊</h2>
<p>说实话，看到扣子这次全面拥抱 Vibe Coding，我还是挺感慨的。</p>
<p>这不仅仅是一个功能的更新，更像是一种信号：</p>
<p><strong>应用开发的门槛，正在被 AI 以前所未有的速度拉平。</strong></p>
<p>扣子选择这条路，其实是在告诉我们：未来的编程，可能真的不需要写代码，而是需要懂逻辑。Vibe Coding 的核心，就是让技术服务于创意，而不是让技术成为创意的绊脚石。</p>
<p>对于我们普通用户来说，这无疑是最好的时代。你不需要精通 Python 或 Java，只需要清晰地知道自己想要什么，剩下的交给 AI 就好。</p>
<p>当然，任何新技术的普及都需要时间，现在的扣子编程或许还有提升空间，但它展示出的可能性已经足够让人兴奋。</p>
<p>我很期待看到大家用它做出什么好玩的东西。如果你也有点子，不妨去试一试，说不定下一个爆款应用，就出自你手。</p>
<p>大家对这次更新怎么看？欢迎在评论区和我交流。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI Agents 智能体工作流的核心组成、模式、应用场景及案例]]></title>    <link>https://juejin.cn/post/7586893663075942410</link>    <guid>https://juejin.cn/post/7586893663075942410</guid>    <pubDate>2025-12-23T13:55:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586893663075942410" data-draft-id="7586865729703641126" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI Agents 智能体工作流的核心组成、模式、应用场景及案例"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2025-12-23T13:55:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="智泊AI"/> <meta itemprop="url" content="https://juejin.cn/user/3572727470361578"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI Agents 智能体工作流的核心组成、模式、应用场景及案例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3572727470361578/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    智泊AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T13:55:36.000Z" title="Tue Dec 23 2025 13:55:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如今，AI Agents（智能体）一词充斥于各类讨论之中，然而新兴技术的演进常伴生术语的模糊、预期的虚高，以及所谓“权威”所制造的迷雾。本文旨在穿透智能体领域泛滥的浮躁与包装，直指 Agentic AI 的本质核心：智能体工作流。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b426f3b680844d0a4a4af5709ba49bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767102936&amp;x-signature=4bCsl%2F5jarsgHxZzYxn29ifxq7k%3D" alt="图片" loading="lazy"/></p>
<p>仅靠智能体自身，所能执行的任务极为有限。它们必须依托清晰的角色定义、明确的目标导向，以及一套可落地的结构化执行路径——而这，正是“工作流”所承载的核心价值。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer"><strong>更多AI大模型学习视频及资源，都在智泊AI。</strong></a></p>
<p>唯有深入理解智能体工作流，方能真正洞悉AI智能体的运行机制与内在逻辑。本文将系统拆解AI智能体的关键构成要素，深入解析工作流的核心属性、典型范式、现实应用与典型实例，并全面梳理其带来的核心优势与现存挑战。</p>
<p><strong>一、AI智能体的核心组成</strong></p>
<p>AI智能体是一种以大语言模型（LLM）为核心驱动、通过工具与现实环境交互的系统，能够在极少人工介入的前提下执行复杂任务。</p>
<p>它被配置为承担特定角色，并拥有可调节的自主能力以实现预设目标，同时内置记忆机制，能够从历史交互中汲取经验，持续优化自身表现。虽然其设计目标是实现半自主运行，但这一能力的实现高度依赖于一个结构完备的组件体系。</p>
<p>该体系由三大支柱构成：支撑推理与决策的LLM、赋能任务执行的工具集，以及推动经验沉淀与响应优化的记忆模块。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec55ed75238c40c29cac5f2e4e38531b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767102936&amp;x-signature=%2BK3yTZzhJoI40cwOWj5j2kp7qMk%3D" alt="图片" loading="lazy"/></p>
<p><strong>1.推理能力（Reasoning）</strong></p>
<p>AI智能体的核心优势之一，体现在其迭代推理能力上，这一能力驱动其在问题解决全周期中持续进行主动思辨。该能力根植于底层的大型语言模型（LLM），并集中体现为两大核心职能：‌规划‌与‌反思‌。</p>
<p>‌规划阶段‌：智能体通过对任务进行系统性分解，将复杂目标拆解为一系列更细粒度、可执行的操作单元。这一机制不仅保障了任务处理的条理性，还支持智能体按需调用差异化的工具资源。</p>
<p>同时，该过程亦涵盖查询的精细化拆分，即将高复杂度的输入转化为多个低难度子查询，从而显著提升LLM输出的精准度与稳定性。</p>
<p>‌反思阶段‌：智能体依托对自身行动结果的回溯性分析开展推理。基于从外部数据源获取的反馈与信息，它能动态评估当前路径的有效性，并据此对后续行动计划进行迭代式优化与修正。</p>
<p><strong>2.工具（Tools）</strong></p>
<p>LLM的知识呈现静态化与参数化本质，其认知边界严格受限于训练阶段所编码的数据。为突破这一固有数据集的约束，智能体可通过集成外部工具——如网络搜索引擎、应用程序接口（API）、数据库及计算框架——实现能力拓展。</p>
<p>由此，智能体得以接入实时外部信息以支撑决策过程，并执行需协同多方应用的复杂任务。此类工具通常与特定权限体系紧密关联，下表列出了AI智能体的常见工具及其对应功能：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06864105fa2b487488dd9bcb9f69b1ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767102936&amp;x-signature=lKo7xtyDQr3eYfccxclIDk7wDhI%3D" alt="图片" loading="lazy"/></p>
<p>当大语言模型（LLM）为完成任务而选用外部工具时，这一过程被称为“函数调用”，从而突破纯文本生成的局限，实现与现实世界的交互。工具的启用方式可由终端用户事先设定，亦可交由智能体自主判断。</p>
<p>由智能体动态决策工具使用，能有效应对复杂任务场景；然而，在流程相对简单的场景中，这种动态性可能引入冗余开销，此时采用预设工具方案更为高效。</p>
<p><strong>3.记忆（Memory）</strong></p>
<p>从过往经验中习得并保留行动发生的上下文，构成了智能体工作流与纯LLM驱动工作流之间的核心差异。</p>
<p>记忆作为关键组件，使智能体能够在多次用户交互与会话中有效捕获并持久化上下文信息与反馈信号。智能体的记忆系统主要划分为两类：‌</p>
<p>短期记忆‌：用于暂存实时交互数据，例如对话历史，以辅助智能体动态规划下一步操作，从而推进整体目标的实现；‌</p>
<p>长期记忆‌：用于累积跨会话、随时间演进的知识与经验，推动智能体逐步实现个性化演进，并持续优化其长期表现。</p>
<p><strong>二、智能体工作流是什么？</strong></p>
<p>广义而言，工作流是一组为达成特定任务或目标而串联的关联性操作环节。基础形态的工作流具备确定性特征，即严格依照预设的步骤顺序执行，无法对新出现的信息或环境变动作出响应。</p>
<p>以自动化费用审批为例，其规则可表述为：“当费用类型标注为‘餐饮费’且金额小于50美元时，系统自动通过审批”。</p>
<p>部分工作流引入了大语言模型（LLM）或其他机器学习技术，此类流程通常被归类为AI工作流，并可细分为智能体工作流与非智能体工作流两类。在非智能体工作流中，LLM仅作为指令驱动的输出生成器，不参与决策闭环。</p>
<p>典型案例如文本摘要流程：输入原始长文→向LLM发出摘要指令→直接输出摘要内容。由此可知，即便嵌入了LLM，也不等同于构建了智能体工作流。</p>
<p>智能体工作流则由一个或多个智能体动态驱动，旨在实现既定目标的一连串交互式步骤。用户赋予智能体有限的自主权限，使其具备采集信息、执行动作与落地决策的能力。</p>
<p>此类工作流深度融合了AI智能体的三大核心能力：推理判断、工具调用与环境交互、以及持久化记忆机制，从而将传统静态流程革新为具备响应性、环境适应性与自我演进特性的动态系统。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9e25004e17345049bce04d33494e607~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767102936&amp;x-signature=aFlBtE7Ixn4IeXck4B2rdoZnWc0%3D" alt="图片" loading="lazy"/></p>
<p><strong>1.智能体工作流的核心特征</strong></p>
<p>当一个或多个智能体成为任务推进的核心驱动力时，AI工作流即展现出智能体特性。</p>
<p>在原有非智能体工作流中引入智能体，可构建混合型架构，融合结构化流程的稳定与可预期，同时保留大语言模型（LLM）的智能响应与动态适应能力。智能体工作流的三大核心机制如下：</p>
<p>‌制定计划‌：以规划为开端，LLM通过对复杂任务的层级拆解，生成细粒度子任务序列，并优选执行路径。</p>
<p>‌工具执行行动‌：依托预设的工具集合及其授权范围，智能体精准执行既定方案，完成目标任务。</p>
<p>‌反思与迭代‌：在每一步执行后，智能体自主评估输出结果，动态修正计划，通过多轮循环逼近最优解。</p>
<p>由此可明确划分三类工作流形态：传统非AI工作流、非智能体AI工作流、智能体AI工作流。</p>
<p>二者关键差异在于：传统规则驱动流程依赖固定步骤编排，而AI工作流由模型驱动完成任务；非智能体AI工作流使用静态模型执行预设逻辑，智能体AI工作流则采用具备自主决策能力的动态智能体。</p>
<p>正因如此，智能体工作流在响应变化与自我优化层面，显著优于非智能体形态。</p>
<p><strong>2.智能体架构与智能体工作流的区别</strong></p>
<p>任何新兴技术的兴起，往往伴随着大量新术语的涌现。尽管“智能体架构”与“智能体工作流”常被混为一谈，但二者在本质上存在明确分野。</p>
<p>‌智能体工作流‌，是指智能体为达成特定目标所循序执行的操作序列，涵盖：依托LLM规划行动路径、拆解子任务、调用互联网搜索等外部工具执行操作，以及通过LLM对执行结果进行反思并动态优化后续策略等关键环节。</p>
<p>‌智能体架构‌，则指支撑特定任务实现的底层技术框架与系统级设计方案。</p>
<p>其形态多样、结构灵活，但无论何种设计，均必须包含三大核心组件：具备自主决策与推理能力的智能体核心、可供调用的外部任务工具集，以及支撑上下文感知的短期与长期记忆系统。</p>
<p><strong>三、智能体工作流的核心模式</strong></p>
<p>智能体工作流是为完成特定目标而设计的结构化步骤序列。因此，探讨智能体工作流时，核心是分析使智能体能够实现其最终目标的特定行为模式。</p>
<p>如前所述，AI智能体的核心组件在这些模式中发挥着关键作用：智能体的推理能力促进了规划和反思模式，而它们使用工具与环境互动的能力则是工具使用模式的基础。</p>
<p><strong>1.规划模式（Planning Pattern</strong>* <em>）</em>*</p>
<p>规划模式使智能体能够自主将复杂任务拆解为一系列更小、更简单的子任务，即任务分解。这种模式能降低LLM的认知负荷、提升推理能力，并减少幻觉及其他不准确输出，从而优化结果质量。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7968f831c78b45969e36fa1c607050ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767102936&amp;x-signature=gQfmcdJmoj35z4QUrUZhjpG%2BvAY%3D" alt="图片" loading="lazy"/></p>
<p>当目标达成路径模糊、应对过程需动态调整时，规划模式展现出显著的适应性优势。以AI智能体接收“修复软件漏洞”指令为例，其会运用规划模式将任务分解为：阅读漏洞报告→定位相关代码段→列出潜在原因→选择特定调试策略。</p>
<p>若初次尝试未能成功，智能体能依据执行反馈信息动态优化后续策略。相较于固定流程的确定性工作流，规划模式在灵活性提升的同时，可能削弱输出结果的稳定性。</p>
<p>因此，该模式更契合对复杂推理与多阶段分析有深度需求的场景。</p>
<p><strong>2.工具使用模式（Tool Use Pattern）</strong></p>
<p>生成式LLM的核心短板在于其完全依赖预训练数据，既无法接入实时信息，也无法校验超出训练范围的事实，因而极易产出错误内容或对未知问题进行主观臆测。</p>
<p>检索增强生成（RAG）通过引入关联的实时外部数据，为LLM提供动态上下文支撑，显著增强了响应的准确度与语境契合度。</p>
<p>而工具使用模式则进一步突破了传统RAG的边界，使LLM能够与现实环境进行动态交互，而非局限于被动检索外部数据源。</p>
<p>在智能体工作流中，该模式通过驱动智能体调用外部工具、应用程序、实时数据流及其他计算服务，全方位延展了其功能边界与行动能力。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1758ce0f3ab944bbbc54d41d4826a018~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767102936&amp;x-signature=A3tvQuX%2FTUpLphqBoHzgX8J29Ew%3D" alt="图片" loading="lazy"/></p>
<p>常见工具包括API、信息检索工具（如向量搜索）、网页浏览器、机器学习模型及代码解释器等。这些工具用于执行特定任务，如网页搜索、从外部数据库提取数据或收发邮件，助力智能体达成目标。</p>
<p><strong>3.反思模式（Reflection Pattern）</strong></p>
<p>反思模式是一种简单却高效的智能体设计模式，能显著提升智能体工作流的性能。</p>
<p>它是智能体的自我反馈机制：在输出最终结果或采取进一步行动前，智能体会迭代评估自身输出或决策的质量，通过自我批判优化方法、修正错误，并提升后续响应与决策的准确性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf606598fbdb4ced91afa035b83d6834~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767102936&amp;x-signature=Ynxl6sGIsLKxRiORrPG4KOBb9is%3D" alt="图片" loading="lazy"/></p>
<p>当智能体在初次执行任务时遭遇失败，反思模式的作用便得到充分彰显——以代码生成为例：智能体产出代码片段后，于沙箱或执行环境中运行，将捕获的错误信息循环反馈至LLM，直至代码顺利运行。</p>
<p>该模式的核心竞争力在于，智能体能自主开展批判性分析，并将提炼的洞察实时嵌入执行流程，全程无需人工介入即可达成渐进式改进。</p>
<p>此类反思所得可持久化存入记忆模块，不仅加速当前对话中的问题收敛，更能依据用户偏好进行动态适配，从而显著增强后续交互的个性化与效能。</p>
<p><strong>四、智能体工作流的应用场景</strong></p>
<p>规划与工具使用等核心设计模式，经由灵活的组合运用，可驱动智能体工作流在多元领域中实现广泛适配。</p>
<p>除模式的重组外，还可通过为AI智能体定制差异化工具集、授权其动态选择工具的权限，或嵌入人工反馈机制、动态调节自主决策层级，进一步拓展其应用弹性。</p>
<p>此类多维度的配置策略，使智能体工作流能够精准契合各行业多样化任务需求。后续将聚焦阐述三大高价值应用场景：Agentic RAG、智能研究助手及智能编码助手。</p>
<p><strong>1.Agentic RAG</strong></p>
<p>‌RAG‌ 是一种借助外部数据源检索相关信息，从而为大语言模型（LLM）扩充知识的架构。</p>
<p>‌智能体RAG‌ 则在该流程中嵌入一个或多个智能体，以增强系统能力。</p>
<p>在‌规划阶段‌，智能体可运用‌查询分解‌，将复杂请求拆解为若干子任务，或判断是否需向用户追问以明确意图。</p>
<p>‌AI智能体‌ 同时承担对检索结果与生成响应的‌相关性‌与‌准确性‌评估职责，确认无误后才交付用户。</p>
<p>若输出未达预期，智能体将触发迭代机制：重拟查询、回溯至‌查询分解‌环节，或重构整体响应策略。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bb7f23ce5414bc681b3616722ea1cda~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767102936&amp;x-signature=je63p07%2F5A2gyIKnlIQI8KwRf4A%3D" alt="图片" loading="lazy"/></p>
<p><strong>2.智能研究助手（Agentic Research Assistants）</strong></p>
<p>智能研究助手（部分AI企业称之为“DeepResearch”）依托网络与多元外部数据源，针对复杂议题生成深度分析报告与细致洞察。此类工具基于智能体RAG架构，响应用户查询时主动从互联网及其他外部渠道获取信息。</p>
<p>与传统RAG机制不同，智能研究助手不仅通过检索外部数据优化大语言模型的输出，更能对多源信息进行整合与深度分析。</p>
<p>这一能力由三大关键特征支撑：</p>
<p>其一，其底层大语言模型经过网页浏览、任务拆解与动态规划的专项训练；</p>
<p>其二，工作流中的智能体主动向用户发起交互，通过提问补充细节或澄清意图，以更精准地对齐最终目标；</p>
<p>其三，智能体可依据新获取的信息动态修正执行路径，灵活拓展分析维度，或持续调用多个数据源，直至达成完整信息闭环。</p>
<p>正因如此，智能研究助手能够提炼深层洞察、捕捉长期演化趋势、构建系统性专题报告，超越了单纯的知识检索范畴。</p>
<p>截至本文撰写时，OpenAI、Perplexity及谷歌均已上线公开的深度研究型工具。</p>
<p><strong>3.智能编码助手（Agentic Coding Assistants）</strong></p>
<p>智能体编码助手能够在极低的人力干预下完成代码的生成、重构、优化与调试。与之相对，非智能体编码助手（例如GitHub Copilot的早期版本）依赖于经过微调的生成式LLM，其功能仅止步于代码的初步产出。</p>
<p>真正赋予编码助手“智能体”属性的，是其与运行环境的动态交互能力：它能执行自身生成的代码，依据执行反馈、异常信息或用户意见进行多轮迭代与修正。</p>
<p>此类助手还可被授权直接对代码库执行提交操作、发起拉取请求（PR），实现开发流程的自动化闭环（如Anthropic的Claude Code），标志着软件开发自动化的关键跃迁。</p>
<p>同时，智能体编码助手能够提议终端指令及其他代码增补方案，并在执行前强制请求人工确认（如Cursor的Agent），确保人类对变更拥有最终决策权。</p>
<p>尤为关键的是，它能将过往的错误模式编码进长期记忆，实现持续自我进化，随时间推移不断提升智能水平。</p>
<p><strong>五、智能体工作流实例</strong></p>
<p>前文介绍了智能体工作流的应用场景，下文将通过Claygent和ServiceNow AI智能体两个真实案例，详细拆解其工作流程。</p>
<p>这两个案例中的工作流采用了独特的模式与工具组合，赋予智能体不同程度的自主权与决策权，并依赖不同的人工反馈机制。</p>
<p><strong>1.Claygent（Clay公司）</strong></p>
<p>对于增长与销售团队而言，挖掘潜在客户并完成数据补全往往耗时耗力。Clay公司推出的AI驱动研究智能体Claygent，正是为破解这一难题而生——它能持续爬取网络与内部数据源，实时输出可直接落地的洞察。</p>
<p>若你希望基于姓名与邮箱列表，自动补全LinkedIn个人资料并生成定制化邀约信息，流程如下：</p>
<p>‌第一步‌：明确所需提取的数据维度（如职业经历、教育履历、核心技能），并将这些字段嵌入预设的提示模板；</p>
<p>‌第二步‌：Claygent的LLM接收指令，联动网络爬虫工具定位目标LinkedIn链接，精准抓取个人资料中的关键内容；</p>
<p>‌第三步‌：提取后的数据被传递至另一LLM，由你自由定义其分析逻辑——无论是归纳、分类还是趋势提炼，均可按需配置；</p>
<p>‌第四步‌：同一或另一LLM随即基于 enriched 数据，为每位目标用户生成高度个性化的推广文案。</p>
<p>Claygent正是这样一个可塑性强的智能体工作流范本：它在保留预配置提示模板对任务边界约束的同时，赋予用户极大的创造性空间，实现精准与灵活的动态平衡。</p>
<p><strong>2.ServiceNow AI智能体</strong></p>
<p>ServiceNow 是一个云端平台，旨在优化与自动化跨 IT、运营、人力资源及客户服务等多个职能领域的工作流程。</p>
<p>其 ServiceNow Platform 已集成对 AI 智能体的接入能力，目标是推动重复性任务与既有流程的自动化，同时确保人类始终保有最终决策权。</p>
<p>以下为一个智能体工作流在处理技术支持案例中的应用示例：当终端用户提交技术支持工单后，自动化流程随即启动。</p>
<p>工单所含信息被分发至一个或多个 AI 智能体，这些智能体基于企业内部 IT 支持知识库执行 RAG 操作。它们综合检索结果、比对历史相似案例，并为一线 IT 支持人员生成精炼摘要。</p>
<p>最终，智能体输出处置建议，由专家审阅并决定是否采纳。ServiceNow AI Agents 体现了一种在生产环境中部署智能体的创新范式。</p>
<p>既保持审慎，又赋予其清晰界定的角色、限定任务范围，以及对影响最终用户或客户决策的有限自主权限。</p>
<p><strong>六、智能体工作流的优势与局限</strong></p>
<p>智能体已从机器学习领域快速渗透至主流应用场景，伴随而来的是诸多兴奋、期待与过高预期。</p>
<p>要客观认知其价值，需拨开炒作迷雾，明确其真实能力与局限。下文将从优势、挑战与局限三方面展开分析。</p>
<p><strong>1.智能体工作流的优势</strong></p>
<p>智能体工作流突破了传统自动化固有的边界，赋予AI智能体规划、调适与持续进化的内在能力。</p>
<p>区别于依赖预设规则的确定性流程，智能体工作流能够实时响应动态环境，借助反馈机制迭代方案，从而驾驭更高阶的任务需求。</p>
<p>这种动态适应特性，使其在强调灵活应变、自主学习与智能决策的场景中展现出独特优势，具体体现为：</p>
<p>‌灵活性、适应性与可定制性‌：传统静态工作流在面对环境变化或突发状况时往往捉襟见肘，而智能体工作流能依据任务复杂度动态调整执行策略，确保始终输出高效且适配的解决方案。</p>
<p>通过模块化整合多种能力单元，该工作流支持灵活拼装，可随应用场景的深化持续演进与升级。</p>
<p>‌复杂任务处理能力提升‌：依托任务拆解与多步规划机制，智能体工作流在应对复杂任务时的表现显著优于传统“零样本”确定性方法。</p>
<p>‌自我修正与持续学习‌：引入反思机制后，智能体工作流可对自身决策过程进行评估，主动优化策略路径，从而稳步提升输出质量。</p>
<p>融合短期记忆与长期经验存储，系统能从历史交互中汲取知识，逐步增强运行效率，并实现个体化行为适配。</p>
<p>‌运营效率与可扩展性优化‌：在合理架构下，智能体工作流可精准自动化高频重复操作，显著降低人力依赖与运营开销。</p>
<p>同时，其架构天然具备良好的横向扩展能力，可无缝支撑更大规模的任务负载与更复杂的系统集成。</p>
<p><strong>2.智能体工作流的挑战与局限</strong></p>
<p>尽管AI智能体展现出显著的创新潜力与多重优势，其应用仍面临诸多现实挑战与内在局限。</p>
<p>受其概率性本质影响，智能体的引入必然抬升工作流的复杂程度。需清醒认识到：“能够自动化”并不等同于“应当自动化”。</p>
<p>在评估是否采纳智能体驱动的工作流时，必须审慎权衡以下关键限制：</p>
<p>‌简单任务的冗余复杂性‌：针对表单填写、基础数据提取等结构化程度高、规则明确的流程，部署AI智能体反而会引入不必要的资源消耗。</p>
<p>若传统确定性规则系统已能精准完成任务，启用智能体不仅无益，更可能引发效率滑坡、成本攀升乃至系统性能退化。</p>
<p>‌自主权提升导致可靠性降低‌：随着智能体在流程中决策权限的扩大，其概率性输出所伴随的不确定性亦同步加剧，致使结果的稳定性与可控性显著削弱。</p>
<p>为此，必须为智能体构建清晰的边界约束，并实施持续的权限审计与行为监控。</p>
<p>‌伦理与实践考量‌：并非所有决策场景均适配AI系统的介入。</p>
<p>在涉及高风险或高度敏感的领域部署智能体时，必须建立严格的监管框架，确保其运行符合合规要求，并有效防范潜在的伦理与操作风险。</p>
<p>基于上述限制，建议在引入智能体前，系统性地回应以下核心问题以评估其必要性：</p>
<p>该任务是否复杂至需依赖自适应决策？</p>
<p>现有确定性方案是否已充分覆盖需求？</p>
<p>更轻量的AI辅助工具（如无智能体的RAG）能否达成同等效果？</p>
<p>工作流是否蕴含不确定性、动态环境或多步推理，且智能体具备更优处理能力？</p>
<p>赋予智能体自主权将带来哪些具体风险？</p>
<p>这些风险是否具备可落地的缓解路径？</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer"><strong>更多AI大模型学习视频及资源，都在智泊AI。</strong></a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手写一个 Askama 模板压缩工具]]></title>    <link>https://juejin.cn/post/7586872817876074522</link>    <guid>https://juejin.cn/post/7586872817876074522</guid>    <pubDate>2025-12-23T13:56:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586872817876074522" data-draft-id="7586877892467916827" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手写一个 Askama 模板压缩工具"/> <meta itemprop="keywords" content="性能优化,Rust,前端"/> <meta itemprop="datePublished" content="2025-12-23T13:56:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="jump_jump"/> <meta itemprop="url" content="https://juejin.cn/user/4230576474692765"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手写一个 Askama 模板压缩工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4230576474692765/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    jump_jump
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T13:56:07.000Z" title="Tue Dec 23 2025 13:56:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Web 开发中，前端资源的大小直接影响用户体验。大型模板文件不仅占用带宽，还会延长页面加载时间。虽然市面上有很多 HTML 压缩工具，但对于使用了模板引擎的 HTML 文件（如 Askama、Jinja2 等），通用压缩器往往会破坏模板语法。</p>
<p>于是个人写了一个 Askama 模板压缩工具 askama-minify，专门用于压缩 Askama 模板文件，同时完美保留模板语法。</p>
<h2 data-id="heading-0">Askama 为什么要压缩</h2>
<h3 data-id="heading-1">模板文件占用的空间</h3>
<p>在实际的 Web 项目中，模板文件往往占据相当大的体积：</p>





























<table><thead><tr><th>项目类型</th><th>模板数量</th><th>总大小</th><th>压缩后大小</th></tr></thead><tbody><tr><td>小型网站</td><td>10-20</td><td>200-500KB</td><td>100-250KB</td></tr><tr><td>中型应用</td><td>50-100</td><td>1-3MB</td><td>500KB-1.5MB</td></tr><tr><td>大型系统</td><td>200+</td><td>5-10MB</td><td>2-5MB</td></tr></tbody></table>
<h3 data-id="heading-2">压缩的好处</h3>
<ol>
<li><strong>减少带宽消耗</strong>：模板大小减少 40-55%，直接降低流量成本</li>
<li><strong>加快页面加载</strong>：更小的文件意味着更快的传输速度</li>
<li><strong>提升用户体验</strong>：首屏渲染时间缩短，特别是移动端用户</li>
<li><strong>降低服务器负载</strong>：传输数据量减少，服务器压力降低</li>
<li><strong>节省存储空间</strong>：生产环境的模板文件占用更少空间</li>
</ol>
<h3 data-id="heading-3">Askama 自带的压缩配置</h3>
<p>Askama 本身提供了 whitespace 控制功能，在项目根目录的 <code>askama.toml</code> 中配置：</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-section">[general]</span>
<span class="hljs-comment"># 三种模式可选</span>
<span class="hljs-attr">whitespace</span> = <span class="hljs-string">"suppress"</span>   <span class="hljs-comment"># 或 "minimize" / "preserve"</span>
</code></pre>
<p><strong>三种模式对比：</strong></p>

























<table><thead><tr><th>模式</th><th>行为</th><th>适用场景</th></tr></thead><tbody><tr><td><code>preserve</code></td><td>保留所有空白（默认）</td><td>开发调试</td></tr><tr><td><code>suppress</code></td><td>激进移除空白</td><td>生产环境</td></tr><tr><td><code>minimize</code></td><td>适度移除空白</td><td>平衡模式</td></tr></tbody></table>
<p>也可以在单个模板上覆盖：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[derive(Template)]</span>
<span class="hljs-meta">#[template(path = <span class="hljs-string">"example.html"</span>, whitespace = <span class="hljs-string">"suppress"</span>)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ExampleTemplate</span>;
</code></pre>
<h3 data-id="heading-4">Askama 自带压缩的局限性</h3>
<p>Askama 的 whitespace 控制有以下限制：</p>
<ol>
<li><strong>只处理空白字符</strong>：不能移除 HTML 注释 <code>&lt;!-- --&gt;</code></li>
<li><strong>不影响 CSS</strong>：<code>&lt;style&gt;</code> 标签内的 CSS 完全保留</li>
<li><strong>不影响 JavaScript</strong>：<code>&lt;script&gt;</code> 标签内的 JS 完全保留</li>
<li><strong>不优化代码</strong>：无法进行属性合并、颜色优化等</li>
</ol>
<p><strong>示例对比：</strong></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 原始模板 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-tag">body</span> {
        <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">0</span>;
        <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">0</span>;
        <span class="hljs-comment">/* 这是 CSS 注释 */</span>
        <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ff0000</span>;
    }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// 这是 JS 注释</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Hello"</span>);
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- Askama whitespace = "suppress" 的结果 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css"><span class="hljs-selector-tag">body</span>{<span class="hljs-attribute">margin-top</span>:<span class="hljs-number">0</span>;<span class="hljs-attribute">margin-bottom</span>:<span class="hljs-number">0</span>;<span class="hljs-comment">/*这是CSS注释*/</span><span class="hljs-attribute">background-color</span>:<span class="hljs-number">#ff0000</span>;}</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript"><span class="hljs-comment">//这是JS注释</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Hello"</span>);</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- askama-minify 的结果 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css"><span class="hljs-selector-tag">body</span>{<span class="hljs-attribute">margin</span>:<span class="hljs-number">0</span> <span class="hljs-number">0</span>;<span class="hljs-attribute">background-color</span>:red}</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Hello"</span>);</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>可以看到，askama-minify 做得更彻底：</p>
<ul>
<li>移除了所有注释</li>
<li>合并了 CSS 属性</li>
<li>优化了颜色值</li>
<li>压缩了 JavaScript</li>
</ul>
<h2 data-id="heading-5">项目演进</h2>
<p>任何项目都不是一蹴而就的，下面是关于 askama-minify 库的编写思路。希望能对大家有一些帮助。</p>
<h2 data-id="heading-6">为什么需要专门的工具（补充）</h2>
<p>在使用 Askama 这样的 Rust 模板引擎时，我们的模板文件中会包含特殊的语法：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- Askama 模板语法 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{{ title }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
{% for item in items %}
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ item.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
{% endfor %}
</code></pre>
<p>通用的 HTML 压缩器（如 html-minifier）可能会：</p>
<ul>
<li>将 <code>{{ }}</code> 识别为无效语法而破坏</li>
<li>将 <code>{% %}</code> 中的空格错误处理</li>
<li>无法区分模板语法和普通文本</li>
</ul>
<p>因此我们需要一个专门设计的压缩工具。</p>
<h2 data-id="heading-7">简单的 HTML 压缩</h2>
<p>最基础的 HTML 压缩非常简单：移除多余的空白字符即可。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">minify_html_simple</span>(content: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">result</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">with_capacity</span>(content.<span class="hljs-title function_ invoke__">len</span>());
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">last_was_space</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">for</span> <span class="hljs-variable">ch</span> <span class="hljs-keyword">in</span> content.<span class="hljs-title function_ invoke__">chars</span>() {
        <span class="hljs-keyword">if</span> ch.<span class="hljs-title function_ invoke__">is_whitespace</span>() {
            <span class="hljs-keyword">if</span> !last_was_space &amp;&amp; !result.<span class="hljs-title function_ invoke__">is_empty</span>() {
                result.<span class="hljs-title function_ invoke__">push</span>(<span class="hljs-string">' '</span>);
                last_was_space = <span class="hljs-literal">true</span>;
            }
        } <span class="hljs-keyword">else</span> {
            result.<span class="hljs-title function_ invoke__">push</span>(ch);
            last_was_space = <span class="hljs-literal">false</span>;
        }
    }

    result
}
</code></pre>
<p>这个简单版本会将：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>   Hello   <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>压缩为：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span> Hello <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>但这样还不够——我们需要：</p>
<ol>
<li>移除 HTML 注释</li>
<li>处理特殊标签（<code>&lt;pre&gt;</code>, <code>&lt;textarea&gt;</code>）</li>
<li>保留模板语法</li>
</ol>
<h2 data-id="heading-8">保留模板语法</h2>
<p>模板语法的保留是本工具的核心。我们需要在遇到 <code>{{</code> 和 <code>{%</code> 时，保持原样输出，直到遇到对应的 <code>}}</code> 和 <code>%}</code>。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">minify_html</span>(content: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">result</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">with_capacity</span>(content.<span class="hljs-title function_ invoke__">len</span>());
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">chars</span> = content.<span class="hljs-title function_ invoke__">chars</span>().<span class="hljs-title function_ invoke__">peekable</span>();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">in_template_brace</span> = <span class="hljs-literal">false</span>;  <span class="hljs-comment">// {{ }}</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">in_template_chevron</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// {% %}</span>

    <span class="hljs-keyword">while</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Some</span>(ch) = chars.<span class="hljs-title function_ invoke__">next</span>() {
        <span class="hljs-comment">// 检测模板语法开始</span>
        <span class="hljs-keyword">if</span> ch == <span class="hljs-string">'{'</span> {
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Some</span>(&amp;next_ch) = chars.<span class="hljs-title function_ invoke__">peek</span>() {
                <span class="hljs-keyword">if</span> next_ch == <span class="hljs-string">'{'</span> {
                    in_template_brace = <span class="hljs-literal">true</span>;
                    result.<span class="hljs-title function_ invoke__">push</span>(ch);
                    <span class="hljs-keyword">continue</span>;
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> next_ch == <span class="hljs-string">'%'</span> {
                    in_template_chevron = <span class="hljs-literal">true</span>;
                    result.<span class="hljs-title function_ invoke__">push</span>(ch);
                    <span class="hljs-keyword">continue</span>;
                }
            }
        }

        <span class="hljs-comment">// 在模板语法内，保持原样</span>
        <span class="hljs-keyword">if</span> in_template_brace || in_template_chevron {
            result.<span class="hljs-title function_ invoke__">push</span>(ch);
            <span class="hljs-comment">// 检测模板语法结束</span>
            <span class="hljs-keyword">if</span> in_template_brace &amp;&amp; ch == <span class="hljs-string">'}'</span> &amp;&amp; result.<span class="hljs-title function_ invoke__">ends_with</span>(<span class="hljs-string">"}}"</span>) {
                in_template_brace = <span class="hljs-literal">false</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> in_template_chevron &amp;&amp; ch == <span class="hljs-string">'}'</span> &amp;&amp; result.<span class="hljs-title function_ invoke__">ends_with</span>(<span class="hljs-string">"%}"</span>) {
                in_template_chevron = <span class="hljs-literal">false</span>;
            }
            <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-comment">// ... 其他处理逻辑</span>
    }

    result
}
</code></pre>
<p>测试一下：</p>
<pre><code class="hljs language-javascript" lang="javascript">输入: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{{ title }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
输出: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{{ title }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>  <span class="hljs-comment">// 完美保留</span>

输入: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>  {{  title  }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
输出: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span> {{ title }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>  <span class="hljs-comment">// 模板外空格压缩，模板内保留</span>
</code></pre>
<h2 data-id="heading-9">移除 HTML 注释</h2>
<p>HTML 注释的移除需要小心，不能破坏字符串中的 <code>&lt;!--</code>：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// HTML 注释处理（只在不在 script/style 内时处理）</span>
<span class="hljs-keyword">if</span> !in_script &amp;&amp; !in_style &amp;&amp; ch == <span class="hljs-string">'&lt;'</span> &amp;&amp; chars.<span class="hljs-title function_ invoke__">peek</span>() == <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-string">'!'</span>) {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">comment</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"&lt;"</span>);
    comment.<span class="hljs-title function_ invoke__">push</span>(chars.<span class="hljs-title function_ invoke__">next</span>().<span class="hljs-title function_ invoke__">unwrap</span>()); <span class="hljs-comment">// '!'</span>

    <span class="hljs-keyword">if</span> chars.<span class="hljs-title function_ invoke__">peek</span>() == <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-string">'-'</span>) {
        comment.<span class="hljs-title function_ invoke__">push</span>(chars.<span class="hljs-title function_ invoke__">next</span>().<span class="hljs-title function_ invoke__">unwrap</span>()); <span class="hljs-comment">// first '-'</span>
        <span class="hljs-keyword">if</span> chars.<span class="hljs-title function_ invoke__">peek</span>() == <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-string">'-'</span>) {
            comment.<span class="hljs-title function_ invoke__">push</span>(chars.<span class="hljs-title function_ invoke__">next</span>().<span class="hljs-title function_ invoke__">unwrap</span>()); <span class="hljs-comment">// second '-'</span>
            <span class="hljs-comment">// 这是一个注释，跳过直到 --&gt;</span>
            <span class="hljs-keyword">while</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Some</span>(c) = chars.<span class="hljs-title function_ invoke__">next</span>() {
                comment.<span class="hljs-title function_ invoke__">push</span>(c);
                <span class="hljs-keyword">if</span> comment.<span class="hljs-title function_ invoke__">ends_with</span>(<span class="hljs-string">"--&gt;"</span>) {
                    <span class="hljs-keyword">break</span>;
                }
            }
            <span class="hljs-keyword">continue</span>; <span class="hljs-comment">// 跳过注释</span>
        }
    }
    result.<span class="hljs-title function_ invoke__">push_str</span>(&amp;comment);
    <span class="hljs-keyword">continue</span>;
}
</code></pre>
<h2 data-id="heading-10">处理特殊标签</h2>
<p>某些标签（如 <code>&lt;pre&gt;</code> 和 <code>&lt;textarea&gt;</code>）的内容需要完全保留原样，包括空格和换行：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">in_pre</span> = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">in_textarea</span> = <span class="hljs-literal">false</span>;

<span class="hljs-comment">// 在标签检测时</span>
<span class="hljs-keyword">if</span> tag_name == <span class="hljs-string">"pre"</span> {
    in_pre = <span class="hljs-literal">true</span>;
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> tag_name == <span class="hljs-string">"textarea"</span> {
    in_textarea = <span class="hljs-literal">true</span>;
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> tag_name == <span class="hljs-string">"/pre"</span> {
    in_pre = <span class="hljs-literal">false</span>;
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> tag_name == <span class="hljs-string">"/textarea"</span> {
    in_textarea = <span class="hljs-literal">false</span>;
}

<span class="hljs-comment">// 在字符处理时</span>
<span class="hljs-keyword">if</span> in_pre || in_textarea {
    result.<span class="hljs-title function_ invoke__">push</span>(ch);  <span class="hljs-comment">// 完全保留</span>
    <span class="hljs-keyword">continue</span>;
}
</code></pre>
<h2 data-id="heading-11">添加 CSS 优化</h2>
<p>HTML 中的 <code>&lt;style&gt;</code> 标签内容可以使用专业的 CSS 优化器。这里选择 lightningcss，它是 Parcel 团队开发的高性能 CSS 解析器：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> lightningcss::stylesheet::{MinifyOptions, ParserOptions, PrinterOptions, StyleSheet};

<span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">minify_css</span>(css_code: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">stylesheet</span> = StyleSheet::<span class="hljs-title function_ invoke__">parse</span>(css_code, ParserOptions::<span class="hljs-title function_ invoke__">default</span>());

    <span class="hljs-keyword">match</span> stylesheet {
        <span class="hljs-title function_ invoke__">Ok</span>(<span class="hljs-keyword">mut</span> sheet) =&gt; {
            sheet.<span class="hljs-title function_ invoke__">minify</span>(MinifyOptions::<span class="hljs-title function_ invoke__">default</span>()).<span class="hljs-title function_ invoke__">ok</span>();
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">result</span> = sheet.<span class="hljs-title function_ invoke__">to_css</span>(PrinterOptions {
                minify: <span class="hljs-literal">true</span>,
                ..PrinterOptions::<span class="hljs-title function_ invoke__">default</span>()
            });

            <span class="hljs-keyword">match</span> result {
                <span class="hljs-title function_ invoke__">Ok</span>(output) =&gt; output.code,
                <span class="hljs-title function_ invoke__">Err</span>(e) =&gt; {
                    eprintln!(<span class="hljs-string">"Warning: Failed to minify CSS: {:?}"</span>, e);
                    css_code.<span class="hljs-title function_ invoke__">to_string</span>()
                },
            }
        }
        <span class="hljs-title function_ invoke__">Err</span>(e) =&gt; {
            eprintln!(<span class="hljs-string">"Warning: Failed to parse CSS: {:?}"</span>, e);
            css_code.<span class="hljs-title function_ invoke__">to_string</span>()
        },
    }
}
</code></pre>
<p>lightningcss 的优化效果非常好：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 输入 */</span>
<span class="hljs-selector-tag">body</span> {
    <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ff0000</span>;
}

<span class="hljs-comment">/* 输出 */</span>
<span class="hljs-selector-tag">body</span>{<span class="hljs-attribute">margin</span>:<span class="hljs-number">0</span> <span class="hljs-number">0</span>;<span class="hljs-attribute">background-color</span>:red}
</code></pre>
<ul>
<li>属性合并：<code>margin-top: 0; margin-bottom: 0</code> → <code>margin: 0 0</code></li>
<li>颜色优化：<code>#ff0000</code> → <code>red</code></li>
<li>移除所有不必要的空格和换行</li>
</ul>
<h2 data-id="heading-12">添加 JavaScript 压缩</h2>
<p>JavaScript 的压缩需要更加小心，因为：</p>
<ol>
<li>字符串中的注释语法不应被处理</li>
<li>除法运算符 <code>/</code> 容易与注释混淆</li>
<li>转义字符需要正确处理（<code>\"</code>, <code>\'</code>）</li>
<li>正则表达式需要保护</li>
</ol>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">minify_js</span>(js_code: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">result</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">with_capacity</span>(js_code.<span class="hljs-title function_ invoke__">len</span>());
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">chars</span> = js_code.<span class="hljs-title function_ invoke__">chars</span>().<span class="hljs-title function_ invoke__">peekable</span>();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">in_string</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">in_single_comment</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">in_multi_comment</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">string_char</span> = <span class="hljs-string">'\0'</span>;

    <span class="hljs-keyword">while</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Some</span>(ch) = chars.<span class="hljs-title function_ invoke__">next</span>() {
        <span class="hljs-comment">// 处理单行注释</span>
        <span class="hljs-keyword">if</span> !in_string &amp;&amp; !in_multi_comment &amp;&amp; ch == <span class="hljs-string">'/'</span> &amp;&amp; chars.<span class="hljs-title function_ invoke__">peek</span>() == <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-string">'/'</span>) {
            in_single_comment = <span class="hljs-literal">true</span>;
            chars.<span class="hljs-title function_ invoke__">next</span>(); <span class="hljs-comment">// 跳过第二个 /</span>
            <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-keyword">if</span> in_single_comment {
            <span class="hljs-keyword">if</span> ch == <span class="hljs-string">'\n'</span> {
                in_single_comment = <span class="hljs-literal">false</span>;
            }
            <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-comment">// 处理多行注释</span>
        <span class="hljs-keyword">if</span> !in_string &amp;&amp; !in_single_comment &amp;&amp; ch == <span class="hljs-string">'/'</span> &amp;&amp; chars.<span class="hljs-title function_ invoke__">peek</span>() == <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-string">'*'</span>) {
            in_multi_comment = <span class="hljs-literal">true</span>;
            chars.<span class="hljs-title function_ invoke__">next</span>(); <span class="hljs-comment">// 跳过 *</span>
            <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-keyword">if</span> in_multi_comment {
            <span class="hljs-keyword">if</span> ch == <span class="hljs-string">'*'</span> &amp;&amp; chars.<span class="hljs-title function_ invoke__">peek</span>() == <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-string">'/'</span>) {
                in_multi_comment = <span class="hljs-literal">false</span>;
                chars.<span class="hljs-title function_ invoke__">next</span>(); <span class="hljs-comment">// 跳过 /</span>
            }
            <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-comment">// 处理字符串</span>
        <span class="hljs-keyword">if</span> ch == <span class="hljs-string">'"'</span> || ch == <span class="hljs-string">'\''</span> || ch == <span class="hljs-string">'`'</span> {
            <span class="hljs-keyword">if</span> !in_string {
                in_string = <span class="hljs-literal">true</span>;
                string_char = ch;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ch == string_char {
                <span class="hljs-comment">// 检查是否被转义：计算前面的反斜杠数量</span>
                <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">backslash_count</span> = <span class="hljs-number">0</span>;
                <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">temp_result</span> = result.<span class="hljs-title function_ invoke__">clone</span>();
                <span class="hljs-keyword">while</span> temp_result.<span class="hljs-title function_ invoke__">ends_with</span>(<span class="hljs-string">'\\'</span>) {
                    backslash_count += <span class="hljs-number">1</span>;
                    temp_result.<span class="hljs-title function_ invoke__">pop</span>();
                }
                <span class="hljs-comment">// 偶数个反斜杠（包括0个）意味着引号没有被转义</span>
                <span class="hljs-keyword">if</span> backslash_count % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> {
                    in_string = <span class="hljs-literal">false</span>;
                }
            }
            result.<span class="hljs-title function_ invoke__">push</span>(ch);
            <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-keyword">if</span> in_string {
            result.<span class="hljs-title function_ invoke__">push</span>(ch);
            <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-comment">// 压缩空白（保留必要的空格）</span>
        <span class="hljs-comment">// ...</span>
    }

    result
}
</code></pre>
<p>测试转义字符处理：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 输入</span>
<span class="hljs-keyword">let</span> s = <span class="hljs-string">"test\\"</span>;  <span class="hljs-comment">// 字符串中有转义的反斜杠</span>
<span class="hljs-keyword">let</span> s2 = <span class="hljs-string">'quote\''</span>;

<span class="hljs-comment">// 输出</span>
<span class="hljs-keyword">let</span> s=<span class="hljs-string">"test\\"</span>;   <span class="hljs-comment">// 正确保留转义字符</span>
<span class="hljs-keyword">let</span> s2=<span class="hljs-string">'quote\''</span>;  <span class="hljs-comment">// 正确保留转义字符</span>
</code></pre>
<h2 data-id="heading-13">整合三层压缩</h2>
<p>将 HTML、CSS、JS 压缩整合在一起，在解析 HTML 时识别 <code>&lt;script&gt;</code> 和 <code>&lt;style&gt;</code> 标签：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">minify_html</span>(content: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">in_script</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">in_style</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">script_content</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">new</span>();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">style_content</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">new</span>();

    <span class="hljs-keyword">while</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Some</span>(ch) = chars.<span class="hljs-title function_ invoke__">next</span>() {
        <span class="hljs-comment">// 标签处理</span>
        <span class="hljs-keyword">if</span> ch == <span class="hljs-string">'&lt;'</span> {
            <span class="hljs-comment">// ... 读取标签名</span>

            <span class="hljs-keyword">if</span> tag_name == <span class="hljs-string">"script"</span> {
                in_script = <span class="hljs-literal">true</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> tag_name == <span class="hljs-string">"/script"</span> {
                <span class="hljs-comment">// 压缩并输出 script 内容</span>
                <span class="hljs-keyword">if</span> !script_content.<span class="hljs-title function_ invoke__">trim</span>().<span class="hljs-title function_ invoke__">is_empty</span>() {
                    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">minified</span> = <span class="hljs-title function_ invoke__">minify_js</span>(&amp;script_content);
                    result.<span class="hljs-title function_ invoke__">push_str</span>(&amp;minified);
                }
                script_content.<span class="hljs-title function_ invoke__">clear</span>();
                in_script = <span class="hljs-literal">false</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> tag_name == <span class="hljs-string">"style"</span> {
                in_style = <span class="hljs-literal">true</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> tag_name == <span class="hljs-string">"/style"</span> {
                <span class="hljs-comment">// 压缩并输出 style 内容</span>
                <span class="hljs-keyword">if</span> !style_content.<span class="hljs-title function_ invoke__">trim</span>().<span class="hljs-title function_ invoke__">is_empty</span>() {
                    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">minified</span> = <span class="hljs-title function_ invoke__">minify_css</span>(&amp;style_content);
                    result.<span class="hljs-title function_ invoke__">push_str</span>(&amp;minified);
                }
                style_content.<span class="hljs-title function_ invoke__">clear</span>();
                in_style = <span class="hljs-literal">false</span>;
            }
        }

        <span class="hljs-comment">// 收集 script/style 内容</span>
        <span class="hljs-keyword">if</span> !in_tag {
            <span class="hljs-keyword">if</span> in_script {
                script_content.<span class="hljs-title function_ invoke__">push</span>(ch);
                <span class="hljs-keyword">continue</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> in_style {
                style_content.<span class="hljs-title function_ invoke__">push</span>(ch);
                <span class="hljs-keyword">continue</span>;
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-14">压缩效果</h2>
<p>经过三层压缩，整体压缩率可达 <strong>40-55%</strong>：</p>






























<table><thead><tr><th>层级</th><th>贡献率</th><th>示例</th></tr></thead><tbody><tr><td>CSS 优化</td><td>20-30%</td><td><code>margin-top: 0; margin-bottom: 0</code> → <code>margin:0 0</code></td></tr><tr><td>JS 压缩</td><td>15-25%</td><td>移除注释和空白</td></tr><tr><td>HTML 压缩</td><td>10-15%</td><td>移除换行和缩进</td></tr><tr><td>注释移除</td><td>5-10%</td><td>取决于注释密度</td></tr></tbody></table>
<p>完整示例：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 输入：324 字节 --&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>{{ title }}<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 这是注释 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-tag">body</span> {
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f0f0f0</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{{ heading }}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    {% for item in items %}
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ item.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    {% endfor %}
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-comment">// 这是注释</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Hello"</span>);
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 输出：152 字节，-53% --&gt;</span>
<span class="hljs-meta">&lt;!doctype <span class="hljs-keyword">html</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">zh-CN</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">UTF-8</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>{{ title }}<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css"><span class="hljs-selector-tag">body</span>{<span class="hljs-attribute">background-color</span>:<span class="hljs-number">#f0f0f0</span>;<span class="hljs-attribute">margin</span>:<span class="hljs-number">0</span>;<span class="hljs-attribute">padding</span>:<span class="hljs-number">20px</span>}</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{{ heading }}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>{% for item in items %} <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ item.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>{% endfor %}<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Hello"</span>);</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h2 data-id="heading-15">其他技术细节</h2>
<h3 data-id="heading-16">命令行参数设计</h3>
<p>使用 clap 库来处理命令行参数：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> clap::Parser;

<span class="hljs-meta">#[derive(Parser, Debug)]</span>
<span class="hljs-meta">#[command(name = <span class="hljs-string">"askama-minify"</span>)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Args</span> {
    <span class="hljs-comment">/// 要压缩的文件或文件夹路径</span>
    <span class="hljs-meta">#[arg(value_name = <span class="hljs-string">"PATH"</span>)]</span>
    path: PathBuf,

    <span class="hljs-comment">/// 递归处理文件夹（默认启用）</span>
    <span class="hljs-meta">#[arg(short, long, default_value_t = true)]</span>
    recursive: <span class="hljs-type">bool</span>,

    <span class="hljs-comment">/// 输出文件或文件夹路径</span>
    <span class="hljs-meta">#[arg(short = 'd', long)]</span>
    output: <span class="hljs-type">Option</span>&lt;PathBuf&gt;,

    <span class="hljs-comment">/// 输出文件的后缀名（例如: "min" 会生成 .min.html）</span>
    <span class="hljs-meta">#[arg(short = 's', long)]</span>
    suffix: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">String</span>&gt;,
}
</code></pre>
<h3 data-id="heading-17">文件处理优化</h3>
<p>使用 walkdir 库实现高效的文件夹遍历：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> walkdir::WalkDir;

<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">walker</span> = <span class="hljs-keyword">if</span> recursive {
    WalkDir::<span class="hljs-title function_ invoke__">new</span>(path)
} <span class="hljs-keyword">else</span> {
    WalkDir::<span class="hljs-title function_ invoke__">new</span>(path).<span class="hljs-title function_ invoke__">max_depth</span>(<span class="hljs-number">1</span>)
};

<span class="hljs-keyword">for</span> <span class="hljs-variable">entry</span> <span class="hljs-keyword">in</span> walker.<span class="hljs-title function_ invoke__">into_iter</span>().<span class="hljs-title function_ invoke__">filter_map</span>(|e| e.<span class="hljs-title function_ invoke__">ok</span>()) {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">file_path</span> = entry.<span class="hljs-title function_ invoke__">path</span>();
    <span class="hljs-keyword">if</span> !file_path.<span class="hljs-title function_ invoke__">is_file</span>() || !<span class="hljs-title function_ invoke__">is_template_file</span>(file_path) {
        <span class="hljs-keyword">continue</span>;
    }
    <span class="hljs-comment">// 处理文件...</span>
}
</code></pre>
<h3 data-id="heading-18">代码质量优化</h3>
<ol>
<li><strong>常量提取</strong>：避免魔法字符串</li>
</ol>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">const</span> DEFAULT_SUFFIX: &amp;<span class="hljs-type">str</span> = <span class="hljs-string">"min"</span>;
<span class="hljs-keyword">const</span> MIN_MARKER: &amp;<span class="hljs-type">str</span> = <span class="hljs-string">".min."</span>;
<span class="hljs-keyword">const</span> VALID_EXTENSIONS: &amp;[&amp;<span class="hljs-type">str</span>] = &amp;[<span class="hljs-string">"html"</span>, <span class="hljs-string">"htm"</span>, <span class="hljs-string">"xml"</span>, <span class="hljs-string">"svg"</span>];
</code></pre>
<ol start="2">
<li><strong>避免不必要的字符串分配</strong>：使用 <code>eq_ignore_ascii_case</code> 而不是 <code>to_lowercase()</code></li>
</ol>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 优化后</span>
ext_str.<span class="hljs-title function_ invoke__">eq_ignore_ascii_case</span>(valid_ext)

<span class="hljs-comment">// 优化前（会创建新字符串）</span>
ext_str.<span class="hljs-title function_ invoke__">to_lowercase</span>() == valid_ext
</code></pre>
<ol start="3">
<li><strong>空文件快速处理</strong></li>
</ol>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">if</span> original_size == <span class="hljs-number">0</span> {
    fs::<span class="hljs-title function_ invoke__">write</span>(output_path, <span class="hljs-string">""</span>)?;
    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Ok</span>((<span class="hljs-number">0</span>, <span class="hljs-number">0</span>));
}
</code></pre>
<h2 data-id="heading-19">使用方式</h2>
<h3 data-id="heading-20">安装</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 克隆仓库</span>
git <span class="hljs-built_in">clone</span> https://github.com/wsafight/askama-minify.git
<span class="hljs-built_in">cd</span> askama-minify

<span class="hljs-comment"># 编译</span>
cargo build --release
</code></pre>
<p>编译后的二进制文件位于 <code>target/release/askama-minify</code>。</p>
<h3 data-id="heading-21">基本用法</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 压缩单个文件（默认生成 .min.html 后缀）</span>
./target/release/askama-minify template.html

<span class="hljs-comment"># 指定输出文件</span>
./target/release/askama-minify -d output.html template.html

<span class="hljs-comment"># 压缩整个文件夹</span>
./target/release/askama-minify templates/

<span class="hljs-comment"># 输出到指定目录并保持目录结构</span>
./target/release/askama-minify -d dist/ templates/
</code></pre>
<h3 data-id="heading-22">命令行选项</h3>





























<table><thead><tr><th>选项</th><th>简写</th><th>说明</th><th>默认值</th></tr></thead><tbody><tr><td><code>--output &lt;PATH&gt;</code></td><td><code>-d</code></td><td>输出文件或文件夹路径</td><td>原路径</td></tr><tr><td><code>--suffix &lt;SUFFIX&gt;</code></td><td><code>-s</code></td><td>输出文件后缀名</td><td><code>min</code></td></tr><tr><td><code>--recursive</code></td><td><code>-r</code></td><td>递归处理子文件夹</td><td><code>true</code></td></tr></tbody></table>
<h3 data-id="heading-23">后缀规则</h3>






























<table><thead><tr><th>配置</th><th>结果</th><th>示例</th></tr></thead><tbody><tr><td>无 <code>-d</code> 无 <code>-s</code></td><td>默认后缀 <code>min</code></td><td><code>file.html</code> → <code>file.min.html</code></td></tr><tr><td>无 <code>-d</code> 有 <code>-s</code></td><td>自定义后缀</td><td><code>file.html</code> + <code>-s prod</code> → <code>file.prod.html</code></td></tr><tr><td>有 <code>-d</code> 无 <code>-s</code></td><td>不添加后缀</td><td><code>file.html</code> + <code>-d out.html</code> → <code>out.html</code></td></tr><tr><td>有 <code>-d</code> 有 <code>-s</code></td><td>后缀 + 自定义路径</td><td><code>file.html</code> + <code>-d out/</code> + <code>-s prod</code> → <code>out/file.prod.html</code></td></tr></tbody></table>
<h3 data-id="heading-24">集成到构建流程</h3>
<h4 data-id="heading-25">方式一：在 <code>build.rs</code> 中使用</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// build.rs</span>
<span class="hljs-keyword">use</span> std::process::Command;

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-comment">// 在生产构建时自动压缩模板</span>
    <span class="hljs-keyword">if</span> std::env::<span class="hljs-title function_ invoke__">var</span>(<span class="hljs-string">"PROFILE"</span>).<span class="hljs-title function_ invoke__">as_deref</span>() == <span class="hljs-title function_ invoke__">Ok</span>(<span class="hljs-string">"release"</span>) {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">status</span> = Command::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">"./target/release/askama-minify"</span>)
            .<span class="hljs-title function_ invoke__">args</span>([<span class="hljs-string">"-d"</span>, <span class="hljs-string">"dist/templates/"</span>, <span class="hljs-string">"templates/"</span>])
            .<span class="hljs-title function_ invoke__">status</span>()
            .<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">"Failed to execute askama-minify"</span>);

        <span class="hljs-keyword">if</span> !status.<span class="hljs-title function_ invoke__">success</span>() {
            <span class="hljs-built_in">panic!</span>(<span class="hljs-string">"Template minification failed"</span>);
        }
    }
}
</code></pre>
<h4 data-id="heading-26">方式二：在 Makefile 中使用</h4>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-comment"># Makefile</span>
<span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: build minify-templates</span>

<span class="hljs-section">build: minify-templates</span>
	cargo build --release

<span class="hljs-section">minify-templates:</span>
	askama-minify -d dist/templates/ -s prod templates/
</code></pre>
<h4 data-id="heading-27">方式三：在 CI/CD 中使用</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># .github/workflows/deploy.yml</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span> [ <span class="hljs-string">main</span> ]

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">deploy:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">Rust</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions-rs/toolchain@v1</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">toolchain:</span> <span class="hljs-string">stable</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">askama-minify</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          git clone https://github.com/wsafight/askama-minify.git
          cd askama-minify
          cargo build --release
</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Minify</span> <span class="hljs-string">templates</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">./askama-minify/target/release/askama-minify</span> <span class="hljs-string">-d</span> <span class="hljs-string">dist/</span> <span class="hljs-string">-s</span> <span class="hljs-string">prod</span> <span class="hljs-string">templates/</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span>
        <span class="hljs-attr">run:</span> <span class="hljs-comment"># 你的部署脚本</span>
</code></pre>
<h3 data-id="heading-28">在 Askama 中使用压缩后的模板</h3>
<p>有两种使用方式：</p>
<h4 data-id="heading-29">方式一：切换模板路径（推荐）</h4>
<p>开发环境使用源模板，生产环境使用压缩模板：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> askama::Template;

<span class="hljs-meta">#[derive(Template)]</span>
<span class="hljs-meta">#[template(
    path = <span class="hljs-string">"{{ template_path }}"</span>,  // 通过配置传入
    whitespace = <span class="hljs-string">"suppress"</span>
)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">HomePage</span> {
    title: <span class="hljs-type">String</span>,
}

<span class="hljs-comment">// 根据环境变量选择模板路径</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_template_path</span>(name: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> {
    <span class="hljs-keyword">if</span> std::env::<span class="hljs-title function_ invoke__">var</span>(<span class="hljs-string">"PROFILE"</span>).<span class="hljs-title function_ invoke__">as_deref</span>() == <span class="hljs-title function_ invoke__">Ok</span>(<span class="hljs-string">"release"</span>) {
        <span class="hljs-built_in">format!</span>(<span class="hljs-string">"dist/{}.prod.html"</span>, name)  <span class="hljs-comment">// 使用压缩版</span>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">format!</span>(<span class="hljs-string">"templates/{}.html"</span>, name)   <span class="hljs-comment">// 使用源文件</span>
    }
}
</code></pre>
<h4 data-id="heading-30">方式二：构建时替换</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 开发环境</span>
<span class="hljs-built_in">cp</span> templates/*.html templates/

<span class="hljs-comment"># 生产构建时</span>
askama-minify -d templates/ -s prod templates/
</code></pre>
<h3 data-id="heading-31">实际项目示例</h3>
<p>假设你有以下项目结构：</p>
<pre><code class="hljs language-csharp" lang="csharp">my-app/
├── templates/
│   ├── <span class="hljs-keyword">base</span>.html
│   ├── index.html
│   └── user/
│       ├── profile.html
│       └── settings.html
├── dist/              <span class="hljs-meta"># 压缩后的输出目录</span>
├── Cargo.toml
└── build.rs
</code></pre>
<p><strong>开发时</strong>：直接使用 <code>templates/</code> 下的原始文件</p>
<p><strong>部署前</strong>：运行压缩命令</p>
<pre><code class="hljs language-bash" lang="bash">askama-minify -d dist/ -s prod templates/
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-csharp" lang="csharp">dist/
├── <span class="hljs-keyword">base</span>.prod.html
├── index.prod.html
└── user/
    ├── profile.prod.html
    └── settings.prod.html
</code></pre>
<p><strong>配置 Askama 使用生产模板</strong>：</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-comment"># askama.toml</span>
<span class="hljs-section">[general]</span>
<span class="hljs-attr">dirs</span> = [<span class="hljs-string">"dist"</span>]  <span class="hljs-comment"># 指向压缩后的目录</span>
</code></pre>
<h2 data-id="heading-32">总结</h2>
<p>askama-minify 通过以下技术实现了高效的模板压缩：</p>
<ol>
<li><strong>模板语法保留</strong>：完整保留 <code>{{ }}</code> 和 <code>{% %}</code> 语法</li>
<li><strong>三层压缩策略</strong>：HTML 层、CSS 层、JS 层分别优化</li>
<li><strong>智能边缘处理</strong>：正确处理转义字符、运算符、正则表达式</li>
<li><strong>专业 CSS 优化</strong>：使用 lightningcss 进行属性合并和颜色优化</li>
<li><strong>Rust 实现</strong>：高性能、内存安全</li>
</ol>
<h3 data-id="heading-33">与 Askama 自带压缩的对比</h3>








































<table><thead><tr><th>特性</th><th>Askama whitespace</th><th>askama-minify</th></tr></thead><tbody><tr><td>空白压缩</td><td>✅</td><td>✅</td></tr><tr><td>HTML 注释移除</td><td>❌</td><td>✅</td></tr><tr><td>CSS 压缩优化</td><td>❌</td><td>✅</td></tr><tr><td>JavaScript 压缩</td><td>❌</td><td>✅</td></tr><tr><td>模板语法保留</td><td>✅</td><td>✅</td></tr><tr><td>构建时处理</td><td>❌</td><td>✅</td></tr></tbody></table>
<p>项目已开源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwsafight%2Faskama-minify" target="_blank" title="https://github.com/wsafight/askama-minify" ref="nofollow noopener noreferrer">github.com/wsafight/as…</a></p>
<p>欢迎大家提出 issue 和 pr。</p>
<h2 data-id="heading-34">参考资料</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fparcel-bundler%2Flightningcss" target="_blank" title="https://github.com/parcel-bundler/lightningcss" ref="nofollow noopener noreferrer">lightningcss</a> - 出色的 CSS 解析和优化工具</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fclap-rs%2Fclap" target="_blank" title="https://github.com/clap-rs/clap" ref="nofollow noopener noreferrer">clap</a> - 强大的命令行参数解析库</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdjc%2Faskama" target="_blank" title="https://github.com/djc/askama" ref="nofollow noopener noreferrer">Askama</a> - 灵活的 Rust 模板引擎</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[彻底搞懂 SSH 与 Git 的“幕后交易”]]></title>    <link>https://juejin.cn/post/7586893663075958794</link>    <guid>https://juejin.cn/post/7586893663075958794</guid>    <pubDate>2025-12-23T14:01:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586893663075958794" data-draft-id="7586892413890805806" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="彻底搞懂 SSH 与 Git 的“幕后交易”"/> <meta itemprop="keywords" content="GitHub,Git,全栈"/> <meta itemprop="datePublished" content="2025-12-23T14:01:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ssshooter"/> <meta itemprop="url" content="https://juejin.cn/user/3122268751795101"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            彻底搞懂 SSH 与 Git 的“幕后交易”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3122268751795101/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ssshooter
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T14:01:43.000Z" title="Tue Dec 23 2025 14:01:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>很多开发者在配置 GitHub SSH 的时候，通常是按照网上的教程，噼里啪啦一顿复制：先 <code>ssh-keygen</code>，再把公钥贴到 GitHub，最后 <code>git push</code>。如果一切顺利，你会觉得这是一种“魔法”，但一旦报错，往往就一脸懵逼。</p>
<p>其实，这背后是一套非常逻辑严密的“身份代换”过程。</p>
<h4 data-id="heading-0">1. 钥匙与锁：非对称加密的“挑战”</h4>
<p>SSH 的核心是<strong>非对称加密</strong>。当你运行 <code>ssh-keygen</code> 时，你其实是产生了一对关系：**私钥（Private Key）**留在你电脑里，相当于你的指纹；**公钥（Public Key）**上传到 GitHub，相当于在 GitHub 门口装了一个只认你指纹的扫描仪。</p>
<p>当你尝试 <code>git push</code> 时，并不是直接发送密码，而是一个“挑战与应答”的过程：</p>
<ol>
<li>GitHub 拿你的公钥加密一段随机信息发给你。</li>
<li>只有你电脑里的私钥能解开这段信息并签上名发回去。</li>
<li>GitHub 验证签名成功，门开了。</li>
</ol>
<p>这就是为什么 SSH 比账号密码安全得多：即便网络被监听，黑客也拿不到你的私钥。</p>
<h4 data-id="heading-1">2. 管理员 ssh-agent：你的“钥匙包”</h4>
<p>如果你电脑里有很多把钥匙（比如公司的、个人的、不同服务器的），你不可能每次推送代码都手动指定用哪把。</p>
<p>这时候 <strong><code>ssh-add</code></strong> 就出场了。它把你的私钥加载进一个叫 <code>ssh-agent</code> 的后台管家那里。当你发起连接时，这个管家会像拿着一大串钥匙的保安，挨个去试。</p>
<p>但这里有个陷阱：<strong>试错是有上限的</strong>。如果管家试了 5-6 把钥匙都没对上，GitHub 就会觉得你在暴力破解，直接切断连接。这就是为什么有时候明明钥匙是对的，却依然报错 <code>Too many authentication failures</code>。</p>
<h4 data-id="heading-2">3. SSH Config：这才是真正的“高级配置”</h4>
<p>为了不让管家“盲目试错”，我们需要一个名为 <code>config</code> 的配置文件（在 <code>~/.ssh/</code> 目录下）。</p>
<p>这个文件就像一张<strong>精确的地图</strong>，它告诉 SSH：</p>
<ul>
<li>“如果是去 GitHub，请直接用这把名为 <code>id_ed25519_me</code> 的钥匙。”</li>
<li>“不要去试其他的钥匙（<code>IdentitiesOnly yes</code>）。”</li>
<li>“甚至如果 22 端口被封了，你可以偷偷走 443 端口。”</li>
</ul>
<p>有了它，SSH 就不再是猜测，而是精准导航。</p>
<h4 data-id="heading-3">4. Git 与 SSH 的“外包关系”</h4>
<p>很多人分不清 Git 地址和 SSH 地址。其实，当你看到 <code>git@github.com:user/repo.git</code> 这种地址时，它本质上就是一个 <strong>SSH 路径</strong>。</p>
<ul>
<li><strong>Git 是货物</strong>：它只负责打包你的代码变更（Commit）。</li>
<li><strong>SSH 是隧道</strong>：它负责把这些货物安全地送到远程仓库（Push）。</li>
</ul>
<p>Git 其实很懒，它根本不负责身份校验。它只是把地址里的 <code>github.com</code> 丢给系统里的 SSH 客户端，说：“喂，帮我连上这个地方，我要发货。”</p>
<p>这时候，SSH 客户端就会去翻你的 <code>config</code> 文件，找对应的钥匙，建立隧道。隧道一旦修通，Git 就在里面欢快地传输数据。</p>
<h4 data-id="heading-4">5. 总结：一个完整的链路</h4>
<p>当你完成一次成功的提交并推送时，底层逻辑是这样的：</p>
<ol>
<li><strong>Git Commit</strong>：在本地把修改存进仓库。</li>
<li><strong>Git Push</strong>：识别到地址是 SSH 格式，呼叫 SSH 客户端。</li>
<li><strong>SSH 寻址</strong>：查看 <code>~/.ssh/config</code>，确定去哪个 IP、用哪个端口、带哪把钥匙。</li>
<li><strong>身份验证</strong>：通过 <code>ssh-agent</code> 提供的私钥与 GitHub 上的公钥完成“暗号对接”。</li>
<li><strong>数据传输</strong>：身份确认，隧道开启，Git 开始搬运代码。</li>
</ol>
<p>一句话总结：</p>
<p>ssh-keygen 造了钥匙，GitHub 拿了模具，ssh-add 把它挂在腰间，config 给了你一张地图，而 Git 则是那个顺着地图走、拿着钥匙开门送货的快递员。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再只会调 API 了！LangChain.js 才是前端 AI 工程化的真正起点]]></title>    <link>https://juejin.cn/post/7586872817875812378</link>    <guid>https://juejin.cn/post/7586872817875812378</guid>    <pubDate>2025-12-23T12:07:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586872817875812378" data-draft-id="7586893663075696650" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再只会调 API 了！LangChain.js 才是前端 AI 工程化的真正起点"/> <meta itemprop="keywords" content="前端,LangChain"/> <meta itemprop="datePublished" content="2025-12-23T12:07:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="白兰地空瓶"/> <meta itemprop="url" content="https://juejin.cn/user/191753514127514"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再只会调 API 了！LangChain.js 才是前端 AI 工程化的真正起点
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/191753514127514/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    白兰地空瓶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T12:07:38.000Z" title="Tue Dec 23 2025 12:07:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>2025 年，如果你还在代码里写：</strong><br/>
<code>const res = await fetch('https://api.openai.com/v1/chat/completions')</code></p>
<p>那你大概率，正在亲手制造一个未来必然崩塌的 <strong>AI 屎山工程</strong>。</p>
</blockquote>
<p>随着 <strong>DeepSeek 等国产大模型的爆发</strong>，前端开发者的主战场已经彻底转移：</p>
<p>❌ 不再是：<strong>我会不会调用模型 API</strong><br/>
✅ 而是：<strong>我能不能编排一个稳定、可扩展、可演进的 AI 工作流</strong></p>
<p>而 <strong>LangChain.js</strong>，正是这场迁移里的<strong>标准答案</strong>。</p>
<hr/>
<h2 data-id="heading-0">一、LangChain 到底是什么？为什么它成了“AI 工程事实标准”？</h2>
<p>在写任何代码之前，我们必须搞清楚一件事：</p>
<blockquote>
<p><strong>LangChain ≠ AI 模型</strong><br/>
<strong>LangChain = AI 应用的“工程骨架”</strong></p>
</blockquote>
<h3 data-id="heading-1">一个前端能秒懂的比喻</h3>
<ul>
<li>
<p>🧠 <strong>大模型（LLM）</strong> ：一个聪明但失忆、不会用工具的大脑</p>
</li>
<li>
<p>🦴 <strong>LangChain</strong>：让这个大脑</p>
<ul>
<li>能记事</li>
<li>会用工具</li>
<li>能拆任务</li>
<li>会按流程干活</li>
</ul>
</li>
</ul>
<p>它解决的不是“模型聪不聪明”，而是<strong>工程层面的三大致命痛点</strong>：</p>
<h3 data-id="heading-2">❌ 痛点 1：逻辑碎片化</h3>
<p>复杂业务 ≠ 一次 Prompt<br/>
LangChain 的 <strong>Chain</strong>，让多步推理变成流水线。</p>
<h3 data-id="heading-3">❌ 痛点 2：数据孤岛</h3>
<p>模型不知道你的：</p>
<ul>
<li>PDF</li>
<li>私有文档</li>
<li>数据库</li>
</ul>
<p>LangChain 的 <strong>RAG（检索增强生成）</strong> ，让模型“读你自己的数据”。</p>
<h3 data-id="heading-4">❌ 痛点 3：模型锁死</h3>
<p>今天 OpenAI<br/>
明天 DeepSeek<br/>
后天再换别的？</p>
<p>LangChain 用 <strong>统一接口</strong>，让你实现真正的 <strong>模型自由</strong>。</p>
<blockquote>
<p><strong>一句话总结</strong><br/>
👉 LangChain 之于 AI，就像 <strong>React 之于浏览器</strong>、<strong>Express 之于 Node.js</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-5">二、LangChain 的“四大支柱”，你代码里其实已经用到了</h2>
<p>你写的实战代码，其实已经踩在 LangChain 的核心设计上，只是你可能没意识到。</p>
<h3 data-id="heading-6">🧱 1. Model I/O（模型输入输出）</h3>
<ul>
<li>PromptTemplate</li>
<li>ChatModel</li>
<li>OutputParser</li>
</ul>
<p>👉 负责 <strong>“怎么喂模型、怎么拿结果”</strong></p>
<hr/>
<h3 data-id="heading-7">🧱 2. Retrieval（检索 / RAG）</h3>
<ul>
<li>文档切片</li>
<li>向量化</li>
<li>相似度搜索</li>
</ul>
<p>👉 负责 <strong>“让模型说你自己的话”</strong></p>
<hr/>
<h3 data-id="heading-8">🧱 3. Chains（执行链）</h3>
<blockquote>
<p><strong>LangChain 的灵魂</strong></p>
</blockquote>
<p>把 Prompt / Model / Parser<br/>
像管道一样串起来。</p>
<hr/>
<h3 data-id="heading-9">🧱 4. Agents（智能体）</h3>
<p>不给流程<br/>
只给工具</p>
<p>让 AI 自己决定：</p>
<ul>
<li>搜索？</li>
<li>算数？</li>
<li>写代码？</li>
</ul>
<p>👉 这是 <strong>AI 从“脚本”走向“自治”</strong> 的起点。</p>
<hr/>
<h2 data-id="heading-10">三、Prompt 工程化：像写 React 组件一样写 Prompt</h2>
<p>你代码里最亮眼的一点，是这一段 👇</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PromptTemplate</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/core/prompts'</span>;

<span class="hljs-keyword">const</span> prompt = <span class="hljs-title class_">PromptTemplate</span>.<span class="hljs-title function_">fromTemplate</span>(<span class="hljs-string">`
你是一个 {role}
请用不超过 {limit} 字回答以下问题：
{question}
`</span>);
</code></pre>
<h3 data-id="heading-11">💡 为什么这是“工程级 Prompt”？</h3>
<p>因为它解决了 <strong>提示词三大老问题</strong>：</p>
<h4 data-id="heading-12">✅ 1. 解耦</h4>
<p>Prompt 不再是字符串拼接<br/>
而是 <strong>配置 + 参数</strong></p>
<h4 data-id="heading-13">✅ 2. 可维护</h4>
<ul>
<li>可版本化</li>
<li>可复用</li>
<li>可测试</li>
</ul>
<h4 data-id="heading-14">✅ 3. 防手滑</h4>
<p>占位符校验，避免：</p>
<blockquote>
<p>“怎么模型突然胡说八道了？”</p>
</blockquote>
<blockquote>
<p><strong>类比一句话</strong><br/>
👉 <code>PromptTemplate</code> 就是 <strong>AI 世界里的 Props</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-15">四、DeepSeek 丝滑接入：这才是适配器模式的正确用法</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatDeepSeek</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/deepseek'</span>;

<span class="hljs-keyword">const</span> model = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({
  <span class="hljs-attr">model</span>: <span class="hljs-string">'deepseek-reasoner'</span>,
  <span class="hljs-attr">temperature</span>: <span class="hljs-number">0.7</span>,
});
</code></pre>
<h3 data-id="heading-16">为什么 LangChain 对前端特别友好？</h3>
<p>因为各家模型虽然<strong>长得像 OpenAI</strong>，但细节全是坑：</p>
<ul>
<li>BaseURL 不同</li>
<li>Auth 不同</li>
<li>Token 计算不同</li>
</ul>
<p>LangChain 的 Provider 层，<strong>把这些脏活全吃掉了</strong>。</p>
<p>你只需要：</p>
<blockquote>
<p><strong>关心业务，不关心模型厂商</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-17">五、真正的灵魂：<code>.pipe()</code> 与 LCEL 声明式编排</h2>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">chain</span> = prompt.pipe(model)<span class="hljs-comment">;</span>
</code></pre>
<blockquote>
<p><strong>这行代码，是整篇文章的技术核心</strong></p>
</blockquote>
<h3 data-id="heading-18">什么是 LCEL（LangChain Expression Language）？</h3>
<p>它借鉴的是 <strong>Unix 管道思想</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cat</span> file | grep keyword | <span class="hljs-built_in">sort</span>
</code></pre>
<p>在 LangChain 中：</p>
<pre><code class="hljs">Prompt → Model → Output
</code></pre>
<h3 data-id="heading-19">对比一下就懂了</h3>
<p>❌ 命令式（越写越乱）：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">const</span> <span class="hljs-keyword">text</span> = <span class="hljs-built_in">await</span> prompt.format(...)
<span class="hljs-keyword">const</span> res = <span class="hljs-built_in">await</span> model.invoke(<span class="hljs-keyword">text</span>)
</code></pre>
<p>✅ 声明式（可组合、可扩展）：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> chain = prompt.<span class="hljs-built_in">pipe</span>(model)
await chain.<span class="hljs-built_in">invoke</span>(...)
</code></pre>
<blockquote>
<p><strong>LCEL 的真正价值在于</strong></p>
<ul>
<li>天然支持 Streaming</li>
<li>天然支持并发</li>
<li>天然可观测</li>
</ul>
</blockquote>
<hr/>
<h2 data-id="heading-20">六、进阶实战：多链协作，才是 AI 工程的常态</h2>
<p>真实场景几乎从来不是“一问一答”。</p>
<p>你这个例子，非常典型，也非常高级 👇</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> fullChain = <span class="hljs-title class_">RunnableSequence</span>.<span class="hljs-title function_">from</span>([
  <span class="hljs-function">(<span class="hljs-params">input</span>) =&gt;</span> explainChain.<span class="hljs-title function_">invoke</span>({ <span class="hljs-attr">topic</span>: input.<span class="hljs-property">topic</span> }).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-property">text</span>),
  <span class="hljs-function">(<span class="hljs-params">explanation</span>) =&gt;</span>
    summaryChain.<span class="hljs-title function_">invoke</span>({ explanation }).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span>
      <span class="hljs-string">`【详情】<span class="hljs-subst">${explanation}</span>\n【总结】<span class="hljs-subst">${r.text}</span>`</span>
    )
]);
</code></pre>
<h3 data-id="heading-21">这段代码本质上在干什么？</h3>
<p>👉 <strong>AI 流水线加工</strong></p>
<ul>
<li>原子性：每个 Chain 都能单测</li>
<li>组合性：像搭积木一样拼</li>
<li>闭环性：前端只管一个输入</li>
</ul>
<blockquote>
<p><strong>这，才配叫 AI 工程化</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-22">七、前端 AI 实战避坑指南</h2>
<h3 data-id="heading-23">⚠️ 1. 永远别把 API Key 写在浏览器</h3>
<p>LangChain = <strong>Node / Serverless 专属</strong></p>
<h3 data-id="heading-24">⚠️ 2. Temperature 不是随便填的</h3>
<ul>
<li><code>0.0</code>：代码 / 数学</li>
<li><code>0.7</code>：博客 / 对话</li>
<li><code>1.0+</code>：创作 / 发散</li>
</ul>
<h3 data-id="heading-25">⚠️ 3. 一定要用 Streaming</h3>
<pre><code class="hljs language-scss" lang="scss">chain<span class="hljs-selector-class">.stream</span>()
</code></pre>
<p>体验差距 = ChatGPT vs 普通输入框</p>
<hr/>
<h2 data-id="heading-26">八、结语：你不是不会 AI，你只是缺一套“工程语法”</h2>
<p>很多人觉得 AI 开发 = 调包<br/>
其实真正的分水岭在于：</p>
<blockquote>
<p><strong>你有没有一套可组合、可演进的 AI 结构</strong></p>
</blockquote>
<p>LangChain 的意义，不是让模型更聪明<br/>
而是让 <strong>人类工程师重新掌控复杂度</strong></p>
<hr/>
<h3 data-id="heading-27">🎯 最后一句话送你</h3>
<blockquote>
<p><strong>Prompt → Model → Chain</strong></p>
<p>这是前端迈入 AI 工程时代的第一性原理。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Jetpack Compose Navigation]]></title>    <link>https://juejin.cn/post/7586892413890641966</link>    <guid>https://juejin.cn/post/7586892413890641966</guid>    <pubDate>2025-12-23T12:44:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586892413890641966" data-draft-id="7585146584893980722" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Jetpack Compose Navigation"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-23T12:44:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Best_Jerry"/> <meta itemprop="url" content="https://juejin.cn/user/1099167360106999"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Jetpack Compose Navigation
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1099167360106999/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Best_Jerry
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T12:44:31.000Z" title="Tue Dec 23 2025 12:44:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fcodelabs%2Fjetpack-compose-navigation%3Fhl%3Dzh-cn%26continue%3Dhttps%253A%252F%252Fdeveloper.android.com%252Fcourses%252Fpathways%252Fjetpack-compose-for-android-developers-3%253Fhl%253Dzh-cn%2523codelab-https%253A%252F%252Fdeveloper.android.com%252Fcodelabs%252Fjetpack-compose-navigation%230" target="_blank" title="https://developer.android.com/codelabs/jetpack-compose-navigation?hl=zh-cn&amp;continue=https%3A%2F%2Fdeveloper.android.com%2Fcourses%2Fpathways%2Fjetpack-compose-for-android-developers-3%3Fhl%3Dzh-cn%23codelab-https%3A%2F%2Fdeveloper.android.com%2Fcodelabs%2Fjetpack-compose-navigation#0" ref="nofollow noopener noreferrer">Jetpack Compose Navigation</a></p>
<p>了解如何在 Compose 中使用 Jetpack Navigation 库、在应用中导航、使用参数进行导航、支持深层链接及测试导航。</p>
<h2 data-id="heading-0">1. 简介</h2>
<h3 data-id="heading-1">使用 Compose 进行导航</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fguide%2Fnavigation%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/guide/navigation?hl=zh-cn" ref="nofollow noopener noreferrer">Navigation</a> 是一个 Jetpack 库，用于在应用中从一个目的地导航到另一个目的地。Navigation 库还提供了一个专用工件，用于<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fnavigation%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/jetpack/compose/navigation?hl=zh-cn" ref="nofollow noopener noreferrer">使用 Jetpack Compose 实现一致而惯用的导航方式</a>。此 Codelab 会重点介绍这个制品 (<code>navigation-compose</code>)。</p>
<h3 data-id="heading-2"><strong>实践内容</strong></h3>
<p>您将使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmaterial.io%2Fdesign%2Fmaterial-studies%2Frally.html%23about-rally" target="_blank" title="https://material.io/design/material-studies/rally.html#about-rally" ref="nofollow noopener noreferrer">Rally Material 研究</a>作为此 Codelab 的基础，从而实现 Jetpack Navigation 组件并在可组合的 Rally 屏幕之间实现导航。</p>
<h3 data-id="heading-3"><strong>学习内容</strong></h3>
<ul>
<li>将 Jetpack Navigation 与 Jetpack Compose 配合使用的基础知识</li>
<li>在可组合项之间导航</li>
<li>将自定义标签页栏可组合项集成到导航层次结构中</li>
<li>使用实参进行导航</li>
<li>使用深层链接进行导航</li>
<li>测试导航</li>
</ul>
<h2 data-id="heading-4">2. 设置</h2>
<p>如需自行学习，请克隆此 Codelab 的起始代码（<code>main</code> 分支）。</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">$ </span><span class="bash">git <span class="hljs-built_in">clone</span> https://github.com/android/codelab-android-compose.git</span>
</code></pre>
<p>或者，您也可以下载两个 ZIP 文件：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fandroid%2Fcodelab-android-compose%2Farchive%2Frefs%2Fheads%2Fmain.zip" target="_blank" title="https://github.com/android/codelab-android-compose/archive/refs/heads/main.zip" ref="nofollow noopener noreferrer">起始代码</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fandroid%2Fcodelab-android-compose%2Farchive%2Frefs%2Fheads%2Fend.zip" target="_blank" title="https://github.com/android/codelab-android-compose/archive/refs/heads/end.zip" ref="nofollow noopener noreferrer">解决方案</a></li>
</ul>
<p>现在，您已下载相应代码，请在 Android Studio 中打开 <strong>NavigationCodelab</strong> 项目文件夹。现已准备就绪，可以开始开发项目了。</p>
<blockquote>
<p>compose-codelabs 库包含开发者在线课程中所有 Codelab 的起始代码。</p>
<p>对于此 Codelab，请使用 <strong>NavigationCodelab</strong> 项目。</p>
<ul>
<li><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29d39ffd20f848cf98486a20de6d5834~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmVzdF9KZXJyeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767098671&amp;x-signature=%2BTiPewpCcc70Nl7B4b3kZOr0nOg%3D" alt="android_studio_folder.png" loading="lazy"/> <strong>NavigationCodelab</strong> - 这个项目包含此 Codelab 的起始代码和完成后的代码</li>
</ul>
<p>该项目有多个 git 分支：</p>
<ul>
<li><strong>main</strong> - 该项目的<strong>起始代码</strong>；您将更改这些代码来完成此 Codelab</li>
<li><strong>end</strong> - 包含此 Codelab 的<strong>解决方案</strong></li>
</ul>
</blockquote>
<h2 data-id="heading-5">3. Rally 应用概览</h2>
<p>首先，您应当熟悉 Rally 应用及其代码库。运行应用并稍加探索。</p>
<p>Rally 有三个主屏幕作为可组合项：</p>
<ol>
<li><strong><code>OverviewScreen</code></strong> - 所有财务交易和提醒的概览</li>
<li><strong><code>AccountsScreen</code></strong> - 有关现有账户的数据分析</li>
<li><strong><code>BillsScreen</code></strong> - 预定支出</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67240abc70804e4ebbd5d3c6a558d04b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmVzdF9KZXJyeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767098671&amp;x-signature=nzzdKfR5S9Nl1REd0M4LEZ5yNEk%3D" alt="image.png" loading="lazy"/></p>
<p>在屏幕的最顶部，Rally 使用<strong>自定义标签页栏可组合项 ( <code>RallyTabRow</code> )</strong>  在这三个屏幕之间进行导航。点按每个图标应该会展开当前所选内容，您也会转到其对应的屏幕：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e5f7420dd05407d83f378c1d8bcb610~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmVzdF9KZXJyeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767098671&amp;x-signature=d1S7qg3111odGP48EWWO0U8%2FuDU%3D" alt="image.png" loading="lazy"/></p>
<p>在导航到这些可组合屏幕时，您还可以将它们视为导航目的地，因为我们希望在特定时间点到达各个目的地。这些目的地是在 <code>RallyDestinations.kt</code> 文件中预定义的。</p>
<p>在该文件中，您会找到所有三个定义为对象的主要目的地（<code>Overview, Accounts</code> 和 <code>Bills</code>），以及一个日后要添加到应用的 <code>SingleAccount</code>。每个对象都从 <code>RallyDestination</code> 接口扩展，并且包含有关每个目的地的必要信息，以便进行导航：</p>
<ol>
<li>顶栏的 <code>icon</code></li>
<li>字符串 <code>route</code>（这对 Compose Navigation 而言是必需的，可作为指向相应目的地的路径）</li>
<li><code>screen</code>，表示相应目的地的整个可组合项</li>
</ol>
<p>运行应用时，您会发现自己实际上可以在当前使用顶栏的目的地之间导航。然而，应用实际上并未使用 Compose Navigation，但它当前使用的导航机制依靠手动切换一些可组合项和触发<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fmental-model%3Fhl%3Dzh-cn%23recomposition" target="_blank" title="https://developer.android.com/jetpack/compose/mental-model?hl=zh-cn#recomposition" ref="nofollow noopener noreferrer">重组</a>来显示新内容。因此，此 Codelab 的目标是成功迁移并实现 Compose Navigation。</p>
<h2 data-id="heading-6">4. 迁移到 Compose Navigation</h2>
<p>迁移到 Jetpack Compose 所涉及的基本步骤如下：</p>
<ol>
<li>添加最新的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmvnrepository.com%2Fartifact%2Fandroidx.navigation%2Fnavigation-compose" target="_blank" title="https://mvnrepository.com/artifact/androidx.navigation/navigation-compose" ref="nofollow noopener noreferrer">Compose Navigation 依赖项</a></li>
<li>设置 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fnavigation%3Fhl%3Dzh-cn%23getting-started" target="_blank" title="https://developer.android.com/jetpack/compose/navigation?hl=zh-cn#getting-started" ref="nofollow noopener noreferrer"><code>NavController</code></a></li>
<li>添加 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fnavigation%3Fhl%3Dzh-cn%23create-navhost" target="_blank" title="https://developer.android.com/jetpack/compose/navigation?hl=zh-cn#create-navhost" ref="nofollow noopener noreferrer"><code>NavHost</code></a> 并创建导航图</li>
<li>准备路线以在不同的应用目的地之间导航</li>
<li>将当前导航机制替换为 Compose Navigation</li>
</ol>
<p>下面我们将更详细地逐一介绍这些步骤。</p>
<h3 data-id="heading-7">添加 Navigation 依赖项</h3>
<p>打开应用的 build 文件（位于 <code>app/build.gradle</code>）。在“dependencies”区段中，添加 <code>navigation-compose</code> 依赖项。</p>
<pre><code class="hljs language-arduino" lang="arduino">dependencies {
  implementation <span class="hljs-string">"androidx.navigation:navigation-compose:{latest_version}"</span>
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>您可以点击<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fandroidx%2Freleases%2Fnavigation%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/jetpack/androidx/releases/navigation?hl=zh-cn" ref="nofollow noopener noreferrer">此处</a>找到最新版 Navigation Compose。</p>
<p>现在，同步项目，然后您就可以开始使用 Compose 中的 Navigation 了。</p>
<h3 data-id="heading-8"><strong>设置 NavController</strong></h3>
<p>使用 Compose 中的 Navigation 时，<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fnavigation%3Fhl%3Dzh-cn%23getting-started" target="_blank" title="https://developer.android.com/jetpack/compose/navigation?hl=zh-cn#getting-started" ref="nofollow noopener noreferrer"><code>NavController</code></a> 是核心组件。它可跟踪返回堆栈可组合条目、使堆栈向前移动、支持对返回堆栈执行操作，以及在不同目的地状态之间导航。由于 <code>NavController</code> 是导航的核心，因此在设置 Compose Navigation 时必须先创建它。</p>
<p><code>NavController</code> 是通过调用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fnavigation%2Fcompose%2Fpackage-summary%3Fhl%3Dzh-cn%23rememberNavController(kotlin.Array)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/navigation/compose/package-summary?hl=zh-cn#rememberNavController(kotlin.Array)" ref="nofollow noopener noreferrer"><code>rememberNavController()</code></a> 函数获取的。这将创建并<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fstate%3Fhl%3Dzh-cn%23state-in-composables" target="_blank" title="https://developer.android.com/jetpack/compose/state?hl=zh-cn#state-in-composables" ref="nofollow noopener noreferrer">记住</a> <code>NavController</code>，它可以在配置更改后继续存在（使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fsaveable%2Fpackage-summary%3Fhl%3Dzh-cn%23rememberSaveable(kotlin.Array%2Candroidx.compose.runtime.saveable.Saver%2Ckotlin.String%2Ckotlin.Function0)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/saveable/package-summary?hl=zh-cn#rememberSaveable(kotlin.Array,androidx.compose.runtime.saveable.Saver,kotlin.String,kotlin.Function0)" ref="nofollow noopener noreferrer"><code>rememberSaveable</code></a>）。</p>
<blockquote>
<p><strong>注意</strong>：此 Codelab 不会介绍 Compose 中状态管理的基础知识。如果您需要了解详情，不妨考虑仔细阅读 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fstate%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/jetpack/compose/state?hl=zh-cn" ref="nofollow noopener noreferrer">“状态和 Jetpack Compose”文档</a>或学习<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fcodelabs%2Fjetpack-compose-state%3Fhl%3Dzh-cn%230" target="_blank" title="https://developer.android.com/codelabs/jetpack-compose-state?hl=zh-cn#0" ref="nofollow noopener noreferrer">“Jetpack Compose 中的状态”Codelab</a>。</p>
</blockquote>
<p>一定要创建 <code>NavController</code> 并将其放置在可组合项层次结构的顶层（通常位于 <code>App</code> 可组合项中）。之后，所有需要引用 <code>NavController</code> 的可组合项都可以访问它。这么做符合<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fstate%3Fhl%3Dzh-cn%23state-hoisting" target="_blank" title="https://developer.android.com/jetpack/compose/state?hl=zh-cn#state-hoisting" ref="nofollow noopener noreferrer">状态提升</a>的原则，并可确保 <code>NavController</code> 是在可组合屏幕之间导航和维护返回堆栈的主要可信来源。</p>
<p>打开 <code>RallyActivity.kt</code>。使用 <code>RallyApp</code> 内的 <code>rememberNavController()</code> 获取 <code>NavController</code>，因为它是整个应用的根可组合项和入口点：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.navigation.compose.rememberNavController
<span class="hljs-comment">// ...</span>

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">RallyApp</span><span class="hljs-params">()</span></span> {
    RallyTheme {
        <span class="hljs-keyword">var</span> currentScreen: RallyDestination <span class="hljs-keyword">by</span> remember { mutableStateOf(Overview) }
        <span class="hljs-keyword">val</span> navController = rememberNavController()
        Scaffold(
            <span class="hljs-comment">// ...</span>
        ) { 
            <span class="hljs-comment">// ...</span>
       }
}
</code></pre>
<h3 data-id="heading-9"><strong>Compose Navigation 中的路线</strong></h3>
<p>如前所述，Rally 应用有三个主要目的地，以及一个日后要添加的额外目的地 (<code>SingleAccount</code>)。这些目的地在 <code>RallyDestinations.kt</code> 中定义。我们已经提到，每个目的地都有定义的 <code>icon</code>、<code>route</code> 和 <code>screen</code>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46a1239218a4421c8fc1a0add70c7632~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmVzdF9KZXJyeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767098671&amp;x-signature=783l3CkXRXp%2FbMkSC3f7Z3bufH8%3D" alt="image.png" loading="lazy"/></p>
<p>接下来，将这些目的地添加到导航图中，其中 <code>Overview</code> 作为应用启动时的起始目的地。</p>
<p>使用 Compose 中的 Navigation 时，导航图中的每个可组合目的地都与一个<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fnavigation%3Fhl%3Dzh-cn%23create-navhost" target="_blank" title="https://developer.android.com/jetpack/compose/navigation?hl=zh-cn#create-navhost" ref="nofollow noopener noreferrer"><strong>路线</strong></a>相关联。路线用字符串表示，用于定义指向可组合项的路径，并指引您的 <code>navController</code> 到达正确的位置。您可以将其视为指向特定目的地的隐式深层链接。<strong>每个目的地都必须有一条唯一的路线</strong>。</p>
<p>为此，我们会使用每个 <code>RallyDestination</code> 对象的 <code>route</code> 属性。例如，<code>Overview.route</code> 是将您转到 <code>Overview</code> 屏幕可组合项的路线。</p>
<h3 data-id="heading-10"><strong>使用导航图调用 NavHost 可组合项</strong></h3>
<p>下一步是添加 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fnavigation%3Fhl%3Dzh-cn%23create-navhost" target="_blank" title="https://developer.android.com/jetpack/compose/navigation?hl=zh-cn#create-navhost" ref="nofollow noopener noreferrer"><code>NavHost</code></a> 并创建导航图。</p>
<p>Navigation 的 3 个主要部分是 <code>NavController</code>、<code>NavGraph</code> 和 <code>NavHost</code>。<code>NavController</code> 始终与一个 <code>NavHost</code> 可组合项相关联。<code>NavHost</code> 充当容器，负责显示导航图的当前目的地。当您在可组合项之间进行导航时，<code>NavHost</code> 的内容会自动进行<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fmental-model%3Fhl%3Dzh-cn%23recomposition" target="_blank" title="https://developer.android.com/jetpack/compose/mental-model?hl=zh-cn#recomposition" ref="nofollow noopener noreferrer">重组</a>。此外，它还会将 <code>NavController</code> 与导航图 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroidx%2Fnavigation%2FNavGraph%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/androidx/navigation/NavGraph?hl=zh-cn" ref="nofollow noopener noreferrer"><code>NavGraph</code></a>) 相关联，后者用于标出能够在其间进行导航的可组合目的地。它实际上是一系列可提取的目的地。</p>
<p>返回到 <code>RallyActivity.kt</code> 中的 <code>RallyApp</code> 可组合项。将 <code>Scaffold</code> 内的 <code>Box</code> 可组合项（其中包含当前屏幕的内容，用于手动切换屏幕）替换为新的 <code>NavHost</code>（可按照以下代码示例进行创建）。</p>
<p>传入我们在上一步中创建的 <code>navController</code>，以将其挂接到这个 <code>NavHost</code>。如前所述，每个 <code>NavController</code> 都必须与一个 <code>NavHost</code> 相关联。</p>
<p><code>NavHost</code> 还需要一个 <code>startDestination</code> 路线才能知道在应用启动时显示哪个目的地，因此请将其设置为 <code>Overview.route</code>。此外，传递 <code>Modifier</code> 以接受外部 <code>Scaffold</code> 内边距，然后将其应用于 <code>NavHost</code>。</p>
<p>最后一个形参 <code>builder: NavGraphBuilder.() -&gt; Unit</code> 负责定义和构建导航图。该形参使用的是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fguide%2Fnavigation%2Fnavigation-kotlin-dsl%3Fhl%3Dzh-cn%23navgraphbuilder" target="_blank" title="https://developer.android.com/guide/navigation/navigation-kotlin-dsl?hl=zh-cn#navgraphbuilder" ref="nofollow noopener noreferrer">Navigation Kotlin DSL</a> 中的 lambda 语法，因此可作为函数正文内部的尾随 lambda 传递并从括号中取出：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.navigation.compose.NavHost
...

Scaffold(...) { innerPadding -&gt;
    NavHost(
        navController = navController,
        startDestination = Overview.route,
        modifier = Modifier.padding(innerPadding)
    ) { 
       <span class="hljs-comment">// builder parameter will be defined here as the graph</span>
    }
}
</code></pre>
<h3 data-id="heading-11">向 Nav<strong>Graph</strong> 添加目的地</h3>
<p>现在，您可以定义导航图以及 <code>NavController</code> 可导航到的目的地。如上所述，<code>builder</code> 形参要求使用函数，因此 Navigation Compose 提供了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fnavigation%2Fcompose%2Fpackage-summary%3Fhl%3Dzh-cn%23(androidx.navigation.NavGraphBuilder).composable(kotlin.String%2C%2520kotlin.collections.List%2C%2520kotlin.collections.List%2C%2520kotlin.Function1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/navigation/compose/package-summary?hl=zh-cn#(androidx.navigation.NavGraphBuilder).composable(kotlin.String,%20kotlin.collections.List,%20kotlin.collections.List,%20kotlin.Function1)" ref="nofollow noopener noreferrer"><code>NavGraphBuilder.composable</code></a> 扩展函数，以便轻松将各个可组合目的地添加到导航图中，并定义必要的导航信息。</p>
<p>第一个目的地是 <code>Overview</code>，因此您需要通过 <code>composable</code> 扩展函数添加它，并为其设置唯一字符串 <code>route</code>。此操作只会将目的地添加到导航图中，因此您还需要定义导航到此目的地时要显示的实际界面。此外，还可通过 <code>composable</code> 函数正文内部的尾随 lambda 完成此操作，这是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fkotlin%3Fhl%3Dzh-cn%23trailing-lambdas" target="_blank" title="https://developer.android.com/jetpack/compose/kotlin?hl=zh-cn#trailing-lambdas" ref="nofollow noopener noreferrer">Compose 中常用的模式</a>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.navigation.compose.composable
<span class="hljs-comment">// ...</span>

NavHost(
    navController = navController,
    startDestination = Overview.route,
    modifier = Modifier.padding(innerPadding)
) { 
    composable(route = Overview.route) { 
        Overview.screen()
    }
}
</code></pre>
<p>我们会按照这种模式将所有三个主屏幕可组合项添加为三个目的地：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">NavHost(
    navController = navController,
    startDestination = Overview.route,
    modifier = Modifier.padding(innerPadding)
) { 
    composable(route = Overview.route) {
        Overview.screen()
    }
    composable(route = Accounts.route) {
        Accounts.screen()
    }
    composable(route = Bills.route) {
        Bills.screen()
    }
</code></pre>
<p>现在运行应用，您会看到 <code>Overview</code> 作为起始目的地，以及其对应的界面。</p>
<p>我们之前提到过自定义顶部标签页栏可组合项 <code>RallyTabRow</code>，该可组合项之前处理了屏幕之间的手动导航。此时，它尚未与新导航相关联，因此您可以验证一下点击标签页是否会更改所显示屏幕可组合项的目的地。</p>
<h2 data-id="heading-12">5. 将 RallyTabRow 与导航集成</h2>
<p>在此步骤中，您需要将 <code>RallyTabRow</code> 与 <code>navController</code> 和导航图连接起来，以便其导航到正确的目的地。</p>
<p>为此，您需要使用新的 <code>navController</code>，为 <code>RallyTabRow</code> 的 <code>onTabSelected</code> 回调定义正确的导航操作。此回调定义了选择特定标签页图标时应发生的情况，并通过 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fnavigation%3Fhl%3Dzh-cn%23nav-to-composable" target="_blank" title="https://developer.android.com/jetpack/compose/navigation?hl=zh-cn#nav-to-composable" ref="nofollow noopener noreferrer"><code>navController.navigate(route)</code></a> 执行导航操作<code>.</code></p>
<blockquote>
<p><strong>注意</strong>：为了使代码具有可测试性且可重复使用，建议不要将整个 <code>navController</code> 直接传递给可组合项。不过，您应该始终提供回调，定义您希望触发的确切导航操作。</p>
</blockquote>
<p>遵循此指南，在 <code>RallyActivity</code> 中找到 <code>RallyTabRow</code> 可组合项及其回调形参 <code>onTabSelected</code>。</p>
<p>由于我们希望点按标签页后导航到特定目的地，因此您还需要知道所选择的确切标签页图标。幸运的是，<code>onTabSelected: (RallyDestination) -&gt; Unit</code> 形参已提供这些信息。您将使用这些信息和 <code>RallyDestination</code> 路线来指引 <code>navController</code> 并在用户选择标签页时调用 <code>navController.navigate(newScreen.route)</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">RallyApp</span><span class="hljs-params">()</span></span> {
    RallyTheme {
        <span class="hljs-keyword">var</span> currentScreen: RallyDestination <span class="hljs-keyword">by</span> remember { mutableStateOf(Overview) }
        <span class="hljs-keyword">val</span> navController = rememberNavController()
        Scaffold(
            topBar = {
                RallyTabRow(
                    allScreens = rallyTabRowScreens,
                    <span class="hljs-comment">// Pass the callback like this,</span>
                    <span class="hljs-comment">// defining the navigation action when a tab is selected:</span>
                    onTabSelected = { newScreen -&gt;
                        navController.navigate(newScreen.route)
                    },
                    currentScreen = currentScreen,
                )
            }
</code></pre>
<p>如果现在运行应用，可以验证点按 <code>RallyTabRow</code> 中的各个标签页是否确实会导航到正确的可组合目的地。不过，您目前可能已经注意到以下两个问题：</p>
<ol>
<li>重按同一标签页会启动同一目的地的多个副本</li>
<li>标签页的界面与所显示的正确目的地不符，也就是说，无法正常展开和收起所选标签页：</li>
</ol>
<p>下面我们来解决这两个问题！</p>
<h3 data-id="heading-13"><strong>启动目的地的单个副本</strong></h3>
<p>为了解决第一个问题，并确保返回堆栈顶部最多只有给定目的地的一个副本，Compose Navigation API 提供了一个 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fnavigation%2FNavOptionsBuilder%3Fhl%3Dzh-cn%23launchSingleTop()" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/navigation/NavOptionsBuilder?hl=zh-cn#launchSingleTop()" ref="nofollow noopener noreferrer"><code>launchSingleTop</code></a> 标志，您可以将其传递给 <code>navController.navigate()</code> 操作，如下所示：</p>
<p><code>navController.navigate(route) { launchSingleTop = true }</code></p>
<p>由于您希望在整个应用中实现这种行为，因此对于每个目的地，不要将此标志复制粘贴到所有的 .<code>navigate(...)</code> 调用中，而是将其提取到 <code>RallyActivity</code> 底部的辅助扩展程序中。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.navigation.NavHostController
<span class="hljs-comment">// ...</span>

<span class="hljs-function"><span class="hljs-keyword">fun</span> NavHostController.<span class="hljs-title">navigateSingleTopTo</span><span class="hljs-params">(route: <span class="hljs-type">String</span>)</span></span> =
    <span class="hljs-keyword">this</span>.navigate(route) { launchSingleTop = <span class="hljs-literal">true</span> }
</code></pre>
<p>现在，您可以将 <code>navController.navigate(newScreen.route)</code> 调用替换为 .<code>navigateSingleTopTo(...)</code>。重新运行应用，然后验证一下：在顶栏中多次点击其图标时，现在是否只会获得单个目的地的一个副本：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">RallyApp</span><span class="hljs-params">()</span></span> {
    RallyTheme {
        <span class="hljs-keyword">var</span> currentScreen: RallyDestination <span class="hljs-keyword">by</span> remember { mutableStateOf(Overview) }
        <span class="hljs-keyword">val</span> navController = rememberNavController()
        Scaffold(
            topBar = {
                RallyTabRow(
                    allScreens = rallyTabRowScreens,
                    onTabSelected = { newScreen -&gt;
                        navController
                            .navigateSingleTopTo(newScreen.route)
                    },
                    currentScreen = currentScreen,
                )
            }
</code></pre>
<h3 data-id="heading-14"><strong>控制导航选项和返回堆栈状态</strong></h3>
<p>除了 <code>launchSingleTop</code> 之外，您还可以使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fnavigation%2FNavOptionsBuilder%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/navigation/NavOptionsBuilder?hl=zh-cn" ref="nofollow noopener noreferrer"><code>NavOptionsBuilder</code></a> 中的其他标志进一步控制和自定义导航行为。由于 <code>RallyTabRow</code> 的作用类似于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fmaterial%2Fpackage-summary%3Fhl%3Dzh-cn%23BottomNavigation(androidx.compose.ui.Modifier%2Candroidx.compose.ui.graphics.Color%2Candroidx.compose.ui.graphics.Color%2Candroidx.compose.ui.unit.Dp%2Ckotlin.Function1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/material/package-summary?hl=zh-cn#BottomNavigation(androidx.compose.ui.Modifier,androidx.compose.ui.graphics.Color,androidx.compose.ui.graphics.Color,androidx.compose.ui.unit.Dp,kotlin.Function1)" ref="nofollow noopener noreferrer"><code>BottomNavigation</code></a>，因此您还应想一想，在导航到和离开目的地时是否要保存并恢复目的地状态。例如，如果要滚动到“Overview”屏幕底部，然后导航到“Accounts”屏幕，接着返回，那么您是否要保持滚动位置？是否要重按 <code>RallyTabRow</code> 中的同一目的地，以重新加载屏幕状态？这些都是有效问题，应根据您自己的应用设计要求来确定。</p>
<p>我们将介绍同一 <code>navigateSingleTopTo</code> 扩展函数中可供您使用的一些其他选项：</p>
<ul>
<li><code>launchSingleTop = true</code> - 如上所述，这可确保返回堆栈顶部最多只有给定目的地的一个副本</li>
<li>在 Rally 应用中，这意味着，多次重按同一标签页不会启动同一目的地的多个副本</li>
<li><code>popUpTo(startDestination) { saveState = true }</code> - 弹出到导航图的起始目的地，以免在您选择标签页时在返回堆栈上积累大量目的地</li>
<li>在 Rally 中，这意味着，在任何目的地按下返回箭头都会将整个返回堆栈弹出到“Overview”屏幕</li>
<li><code>restoreState = true</code> - 确定此导航操作是否应恢复 <code>PopUpToBuilder.saveState</code> 或 <code>popUpToSaveState</code> 属性之前保存的任何状态。请注意，如果之前未使用要导航到的目的地 ID 保存任何状态，<strong>此项不会产生任何影响</strong></li>
<li>在 Rally 中，这意味着，重按同一标签页会保留屏幕上之前的数据和用户状态，而无需重新加载</li>
</ul>
<p>您可以将所有这些选项逐一添加到代码中，然后在添加每个选项后运行应用，并在添加每个标志后验证确切行为。这样一来，您就可以在实践中了解每个标志是如何更改导航和返回堆栈状态的：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.navigation.NavHostController
<span class="hljs-keyword">import</span> androidx.navigation.NavGraph.Companion.findStartDestination
<span class="hljs-comment">// ...</span>

<span class="hljs-function"><span class="hljs-keyword">fun</span> NavHostController.<span class="hljs-title">navigateSingleTopTo</span><span class="hljs-params">(route: <span class="hljs-type">String</span>)</span></span> =
    <span class="hljs-keyword">this</span>.navigate(route) { 
        popUpTo(
            <span class="hljs-keyword">this</span><span class="hljs-symbol">@navigateSingleTopTo</span>.graph.findStartDestination().id
        ) {
            saveState = <span class="hljs-literal">true</span>
        }
        launchSingleTop = <span class="hljs-literal">true</span>
        restoreState = <span class="hljs-literal">true</span>
}
</code></pre>
<blockquote>
<p><strong>注意</strong>：如果您需要有关管理多个返回堆栈的更多指导，请参阅<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fguide%2Fnavigation%2Fmulti-back-stacks%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/guide/navigation/multi-back-stacks?hl=zh-cn" ref="nofollow noopener noreferrer">有关支持多个返回堆栈的文档</a>。</p>
</blockquote>
<h3 data-id="heading-15"><strong>解决标签页界面问题</strong></h3>
<p>在此 Codelab 开始时，<code>RallyTabRow</code> 虽然仍在使用手动导航机制，但会使用 <code>currentScreen</code> 变量来确定是展开还是收起各个标签页。</p>
<p>不过，在您完成更改后，<code>currentScreen</code> 将不再更新。因此，<code>RallyTabRow</code> 内展开和收起所选标签页的操作不再起作用。</p>
<p>如需使用 Compose Navigation 重新启用此行为，您需要知道在每个时间点显示的当前目的地是什么（或者用导航术语来说，当前返回堆栈条目的顶部是什么），然后在此行为每次更改时更新 <code>RallyTabRow</code>。</p>
<p>如需以 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2FState%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/State?hl=zh-cn" ref="nofollow noopener noreferrer"><code>State</code></a> 的形式获取返回堆栈中当前目的地的实时更新，您可以使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fnavigation%2Fcompose%2Fpackage-summary%3Fhl%3Dzh-cn%23(androidx.navigation.NavController).currentBackStackEntryAsState()" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/navigation/compose/package-summary?hl=zh-cn#(androidx.navigation.NavController).currentBackStackEntryAsState()" ref="nofollow noopener noreferrer"><code>navController.currentBackStackEntryAsState()</code></a>，然后获取其当前 <code>destination:</code></p>
<blockquote>
<p><strong>注意</strong>：此 Codelab 不会介绍 Compose 中状态管理的基础知识。如果您需要了解详情，不妨考虑仔细阅读 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fstate%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/jetpack/compose/state?hl=zh-cn" ref="nofollow noopener noreferrer">“状态和 Jetpack Compose”文档</a>或学习<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fcodelabs%2Fjetpack-compose-state%3Fhl%3Dzh-cn%230" target="_blank" title="https://developer.android.com/codelabs/jetpack-compose-state?hl=zh-cn#0" ref="nofollow noopener noreferrer">“Jetpack Compose 中的状态”Codelab</a>。</p>
</blockquote>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.navigation.compose.currentBackStackEntryAsState
<span class="hljs-keyword">import</span> androidx.compose.runtime.getValue
<span class="hljs-comment">// ...</span>

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">RallyApp</span><span class="hljs-params">()</span></span> {
    RallyTheme {
        <span class="hljs-keyword">val</span> navController = rememberNavController()

        <span class="hljs-keyword">val</span> currentBackStack <span class="hljs-keyword">by</span> navController.currentBackStackEntryAsState()
        <span class="hljs-comment">// Fetch your currentDestination: </span>
        <span class="hljs-keyword">val</span> currentDestination = currentBackStack?.destination
        <span class="hljs-comment">// ...</span>
    }
}
</code></pre>
<p><code>currentBackStack?.destination</code> 会返回 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fnavigation%2FNavDestination%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/navigation/NavDestination?hl=zh-cn" ref="nofollow noopener noreferrer"><code>NavDestination</code></a><code>.</code>如需重新正确更新 <code>currentScreen</code>，您需要想方设法将返回值 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fnavigation%2FNavDestination%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/navigation/NavDestination?hl=zh-cn" ref="nofollow noopener noreferrer"><code>NavDestination</code></a> 与 Rally 的三个主要屏幕可组合项之一进行匹配。您必须确定当前显示的目的地，以便随后将这些信息传递给 <code>RallyTabRow.</code>如前所述，每个目的地都有一条唯一的路线，因此我们可以使用此 String 路线作为类似的 ID，以进行严格的对比并找到唯一匹配。</p>
<p>如需更新 <code>currentScreen</code>，您需要迭代 <code>rallyTabRowScreens</code> 列表，以找到匹配路线，然后返回对应的 <code>RallyDestination</code>。Kotlin 为此提供了一个便捷的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fapi%2Flatest%2Fjvm%2Fstdlib%2Fkotlin.collections%2Ffind.html" target="_blank" title="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.collections/find.html" ref="nofollow noopener noreferrer"><code>.find()</code></a> 函数：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.navigation.compose.currentBackStackEntryAsState
<span class="hljs-keyword">import</span> androidx.compose.runtime.getValue
<span class="hljs-comment">// ...</span>

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">RallyApp</span><span class="hljs-params">()</span></span> {
    RallyTheme {
        <span class="hljs-keyword">val</span> navController = rememberNavController()

        <span class="hljs-keyword">val</span> currentBackStack <span class="hljs-keyword">by</span> navController.currentBackStackEntryAsState()
        <span class="hljs-keyword">val</span> currentDestination = currentBackStack?.destination

        <span class="hljs-comment">// Change the variable to this and use Overview as a backup screen if this returns null</span>
        <span class="hljs-keyword">val</span> currentScreen = rallyTabRowScreens.find { it.route == currentDestination?.route } ?: Accounts
        <span class="hljs-comment">// ...</span>
    }
}
</code></pre>
<p>由于已将 <code>currentScreen</code> 传递给 <code>RallyTabRow</code>，因此您可以运行应用，并验证标签页栏界面现在是否已相应更新。</p>
<blockquote>
<p><strong>注意</strong>：现在也支持直接通过 Navigation Component 进行返回行为导航。您无需为它进行任何其他设置。在目的地之间切换，然后按返回按钮后，系统会正确弹出返回堆栈并转到上一个目的地。</p>
</blockquote>
<h2 data-id="heading-16">6. 从 RallyDestination 中提取屏幕可组合项</h2>
<p>到目前为止，为简单起见，我们一直使用 <code>RallyDestination</code> 接口中的 <code>screen</code> 属性以及通过该属性扩展的屏幕对象，将可组合界面添加到 <code>NavHost (RallyActivity.kt</code>) 中：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> com.example.compose.rally.ui.overview.OverviewScreen
<span class="hljs-comment">// ...</span>

NavHost(
    navController = navController,
    startDestination = Overview.route,
    modifier = Modifier.padding(innerPadding)
) { 
    composable(route = Overview.route) { 
        Overview.screen()
    }
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>不过，此 Codelab 中的后续步骤（例如点击事件）需要将额外信息直接传递给可组合屏幕。在生产环境中，肯定需要传递更多数据。</p>
<p>若要实现这一目标，正确且更简洁的方式是将可组合项直接添加到 <code>NavHost</code> 导航图中，然后从 <code>RallyDestination</code> 中提取。之后，<code>RallyDestination</code> 和屏幕对象将仅保存导航专属信息（例如 <code>icon</code> 和 <code>route</code>），还将与任何与 Compose 界面相关的信息分离。</p>
<p>打开 <code>RallyDestinations.kt</code>。将每个屏幕的可组合项从 <code>RallyDestination</code> 对象的 <code>screen</code> 形参提取到 <code>NavHost</code> 中对应的 <code>composable</code> 函数中，以替换之前的 <code>.screen()</code> 调用，如下所示<code>:</code></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> com.example.compose.rally.ui.accounts.AccountsScreen
<span class="hljs-keyword">import</span> com.example.compose.rally.ui.bills.BillsScreen
<span class="hljs-keyword">import</span> com.example.compose.rally.ui.overview.OverviewScreen
<span class="hljs-comment">// ...</span>

NavHost(
    navController = navController,
    startDestination = Overview.route,
    modifier = Modifier.padding(innerPadding)
) {
    composable(route = Overview.route) {
        OverviewScreen()
    }
    composable(route = Accounts.route) {
        AccountsScreen()
    }
    composable(route = Bills.route) {
        BillsScreen()
    }
}
</code></pre>
<p>此时，您可以从 <code>RallyDestination</code> 及其对象中安全移除 <code>screen</code> 形参：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">RallyDestination</span> {
    <span class="hljs-keyword">val</span> icon: ImageVector
    <span class="hljs-keyword">val</span> route: String
}

<span class="hljs-comment">/**
 * Rally app navigation destinations
 */</span>
<span class="hljs-keyword">object</span> Overview : RallyDestination {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> icon = Icons.Filled.PieChart
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> route = <span class="hljs-string">"overview"</span>
}
<span class="hljs-comment">// ...</span>
</code></pre>
<p>再次运行应用，并验证一切是否像先前一样正常运行。现在，您已经完成此步骤，接下来可以在可组合屏幕中设置点击事件了。</p>
<h3 data-id="heading-17">对 OverviewScreen 启用点击</h3>
<p>目前，<code>OverviewScreen</code> 中的所有点击事件都已被忽略。也就是说，“Accounts”和“Bills”的子部分“SEE ALL”按钮可供点击，但实际上不会转到任何位置。此步骤的目的是为这些点击事件启用导航。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/986335db3edf4d6f9c61e81fb52cd3c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmVzdF9KZXJyeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767098671&amp;x-signature=A8JVziZPYqijXPG3Tq3C2fgRizI%3D" alt="image.png" loading="lazy"/></p>
<p><code>OverviewScreen</code> 可组合项可以接受多个函数作为回调，以设置为点击事件，在本示例中，这应该是可让您转到 <code>AccountsScreen</code> 或 <code>BillsScreen</code> 的导航操作。我们来将这些导航回调传递给 <code>onClickSeeAllAccounts</code> 和 <code>onClickSeeAllBills</code>，以导航到相关目的地。</p>
<p>打开 <code>RallyActivity.kt</code>，在 <code>NavHost</code> 中找到 <code>OverviewScreen</code>，然后将 <code>navController.navigateSingleTopTo(...)</code> 传递给具有相应路线的两个导航回调：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">OverviewScreen(
    onClickSeeAllAccounts = {
        navController.navigateSingleTopTo(Accounts.route) 
    },
    onClickSeeAllBills = { 
        navController.navigateSingleTopTo(Bills.route) 
    }
)
</code></pre>
<p><code>navController</code> 现在将获得足够的信息（例如确切目的地的路线）<code>,</code>可在用户点击按钮时导航到正确的目的地。如果您查看 <code>OverviewScreen</code> 的实现，便会发现这些回调已设置为相应的 <code>onClick</code> 形参<code>:</code></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">OverviewScreen</span><span class="hljs-params">(...)</span></span> {
    <span class="hljs-comment">// ...</span>
    AccountsCard(
        onClickSeeAll = onClickSeeAllAccounts,
        onAccountClick = onAccountClick
    )
    <span class="hljs-comment">// ...</span>
    BillsCard(
        onClickSeeAll = onClickSeeAllBills
    )
}
</code></pre>
<p>如前所述，若能将 <code>navController</code> 保持在导航层次结构的顶层并将其提升到 <code>App</code> 可组合项级别（例如，不将其直接传递给 <code>OverviewScreen)</code>，就可以轻松地单独预览、重复使用和测试 <code>OverviewScreen</code> 可组合项，而不必依赖于实际或模拟的 <code>navController</code> 实例。此外，改为传递回调还可让您快速更改点击事件！</p>
<h2 data-id="heading-18">7. 使用实参导航到 SingleAccountScreen</h2>
<p>让我们为 <code>Accounts</code> 和 <code>Overview</code> 屏幕添加一些新功能！目前，这些屏幕会显示一个包含多种不同类型账户（“Checking”“Home Savings”等）的列表。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80c666002dac45d5a9cafe0970ad43b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmVzdF9KZXJyeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767098671&amp;x-signature=jCxAndPgpk14a6N4SIviRLd0v34%3D" alt="image.png" loading="lazy"/></p>
<p>不过，点击这些账户类型（目前）不会起任何作用。接下来，让我们解决这个问题！在点按每个账号类型后，我们希望看到一个包含完整账号详细信息的新屏幕。为此，我们需要向 <code>navController</code> 提供与所点击的确切账户类型有关的其他信息。这可以通过<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fnavigation%3Fhl%3Dzh-cn%23nav-with-args" target="_blank" title="https://developer.android.com/jetpack/compose/navigation?hl=zh-cn#nav-with-args" ref="nofollow noopener noreferrer">实参</a>实现。</p>
<p>实参是一类非常强大的工具，它们会将一个或多个实参传递给路线，从而使导航路线变为动态形式。它支持根据所提供的不同实参显示不同的信息。</p>
<blockquote>
<p><strong>注意</strong>：具名实参的定义方式是附加到路线并用大括号括起来，如下所示：<code>{argument}</code>。其语法与 Kotlin 的 String 模板语法类似，均在必要时使用美元符号来转义变量名称，例如：<code>{${argument}}</code></p>
</blockquote>
<p>在 <code>RallyApp</code> 中，通过向现有 <code>NavHost:</code> 添加新的 <code>composable</code> 函数，将新的目的地 <code>SingleAccountScreen</code>（用于处理这些具体账户的显示操作）添加到导航图中：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> com.example.compose.rally.ui.accounts.SingleAccountScreen
<span class="hljs-comment">// ...</span>

NavHost(
    navController = navController,
    startDestination = Overview.route,
    modifier = Modifier.padding(innerPadding)
) {
    ...
    composable(route = SingleAccount.route) {
        SingleAccountScreen()
    }
}
</code></pre>
<h3 data-id="heading-19"><strong>设置 SingleAccountScreen 到达目的地</strong></h3>
<p>当您到达 <code>SingleAccountScreen</code> 时，此目的地将需要更多信息才能知道打开时应显示的确切账户类型。我们可以使用实参传递此类信息。您需要指明，其路线还需要一个实参 <code>{account_type}</code>。如果您查看 <code>RallyDestination</code> 及其 <code>SingleAccount</code> 对象，便会发现该实参已定义为 <code>accountTypeArg</code> String，供您使用。</p>
<p>如需在导航时随路线一起传递实参，您需要按照以下模式将它们附加在一起：<code>"route/{argument}"</code>。在本示例中，应如下所示：<code>"${SingleAccount.route}/{${SingleAccount.accountTypeArg}}"</code>。请注意，$ 符号用于转义变量：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.navigation.NavType
<span class="hljs-keyword">import</span> androidx.navigation.compose.navArgument
<span class="hljs-comment">// ...</span>

composable(
    route =
        <span class="hljs-string">"<span class="hljs-subst">${SingleAccount.route}</span>/{<span class="hljs-subst">${SingleAccount.accountTypeArg}</span>}"</span>
) { 
    SingleAccountScreen()
}
</code></pre>
<p>这样可确保当操作被触发以导航到 <code>SingleAccountScreen</code> 时，还必须传递 <code>accountTypeArg</code> 实参，否则导航将会失败。您可以将其视为其他要导航到 <code>SingleAccountScreen</code> 的目的地需要遵循的签名或协定。</p>
<blockquote>
<p><strong>注意</strong>：为了提高代码安全性和处理任何极端情况，您还可以将默认值设置为实参并明确指定其类型。</p>
</blockquote>
<p>第二步是让此 <code>composable</code> 知道它应该接受实参。为此，您可以定义其 <code>arguments</code> 形参。您可以根据需要定义任意数量的实参，因为 <code>composable</code> 函数默认接受实参列表。在本示例中，您只需添加一个名为 <code>accountTypeArg</code> 的实参，并将其类型指定为 <code>String</code>，即可提高安全性。如果您未明确设置类型，系统将根据此实参的默认值推断出其类型：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.navigation.NavType
<span class="hljs-keyword">import</span> androidx.navigation.compose.navArgument
<span class="hljs-comment">// ...</span>

composable(
    route =
        <span class="hljs-string">"<span class="hljs-subst">${SingleAccount.route}</span>/{<span class="hljs-subst">${SingleAccount.accountTypeArg}</span>}"</span>,
    arguments = listOf(
        navArgument(SingleAccount.accountTypeArg) { type = NavType.StringType }
    )
) { 
    SingleAccountScreen()
}
</code></pre>
<p>这样就可以做到完美运行，您可以选择保留代码，如下所示。不过，由于我们的所有目的地专属信息都位于 <code>RallyDestinations.kt</code> 及其对象中，因此我们会继续采用相同的方法（就像我们在前面为 <code>Overview</code>、<code>Accounts,</code> 和 <code>Bills</code> 采取的方法一样）并将此实参列表迁移到 <code>SingleAccount:</code></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">object</span> SingleAccount : RallyDestination {
    <span class="hljs-comment">// ...</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> route = <span class="hljs-string">"single_account"</span>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> accountTypeArg = <span class="hljs-string">"account_type"</span>
    <span class="hljs-keyword">val</span> arguments = listOf(
        navArgument(accountTypeArg) { type = NavType.StringType }
    )
}
</code></pre>
<p>将之前的实参替换为 <code>SingleAccount.arguments</code>，现在返回到相应的 NavHost <code>composable</code>。这还可以确保让 <code>NavHost</code> 尽可能简洁且易读：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">composable(
    route = <span class="hljs-string">"<span class="hljs-subst">${SingleAccount.route}</span>/{<span class="hljs-subst">${SingleAccount.accountTypeArg}</span>}"</span>,
    arguments =  SingleAccount.arguments
) {
    SingleAccountScreen()
}
</code></pre>
<p>现在，您已使用实参定义了 <code>SingleAccountScreen</code> 的完整路线，接下来要确保将此 <code>accountTypeArg</code> 进一步向下传递给 <code>SingleAccountScreen</code> 可组合项，这样它就会知道要正确显示哪个账户类型。如果您查看 <code>SingleAccountScreen</code> 的实现，就会发现它已设置完毕且正在等待接受 <code>accountType</code> 形参：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">SingleAccountScreen</span><span class="hljs-params">(
    accountType: <span class="hljs-type">String</span>? = UserData.accounts.first()</span></span>.name
) { 
   <span class="hljs-comment">// ... </span>
}
</code></pre>
<p>简而言之，到目前为止：</p>
<ul>
<li>您已确保我们定义请求实参的路线，作为先前目的地的信号</li>
<li>您已确保 <code>composable</code> 知道它需要接受实参</li>
</ul>
<p>最后一步是以某种方式真正<strong>检索传递的实参</strong>值。</p>
<p>在 Compose Navigation 中，每个 <code>NavHost</code> 可组合函数都可以访问当前的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fnavigation%2FNavBackStackEntry%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/navigation/NavBackStackEntry?hl=zh-cn" ref="nofollow noopener noreferrer"><code>NavBackStackEntry</code></a>，该类用于保存当前路线的相关信息，以及返回堆栈中条目的已传递实参。您可以使用该类从 <code>navBackStackEntry</code> 中获取所需的 <code>arguments</code> 列表，然后搜索并检索所需的确切实参，将其进一步向下传递给可组合屏幕。</p>
<p>在这种情况下，您需要从 <code>navBackStackEntry</code> 请求 <code>accountTypeArg</code>。然后，您需要将其进一步向下传递给 <code>SingleAccountScreen'</code> 的 <code>accountType</code> 形参。</p>
<p>您也可以为实参提供一个默认值（如果尚未提供）作为占位符，并包含这种极端情况，以提高代码的安全性。</p>
<p>现在，您的代码应如下所示：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">NavHost(...) {
    <span class="hljs-comment">// ...</span>
    composable(
        route =
          <span class="hljs-string">"<span class="hljs-subst">${SingleAccount.route}</span>/{<span class="hljs-subst">${SingleAccount.accountTypeArg}</span>}"</span>,
        arguments = SingleAccount.arguments
    ) { navBackStackEntry -&gt;
        <span class="hljs-comment">// Retrieve the passed argument</span>
        <span class="hljs-keyword">val</span> accountType =
            navBackStackEntry.arguments?.getString(SingleAccount.accountTypeArg)

        <span class="hljs-comment">// Pass accountType to SingleAccountScreen</span>
        SingleAccountScreen(accountType)
    }
}
</code></pre>
<p>您的 <code>SingleAccountScreen</code> 现已获得在您导航到那里时显示正确账户类型所需的必要信息。如果您查看 <code>SingleAccountScreen,</code> 的实现，就会发现它已经将传递的 <code>accountType</code> 与 <code>UserData</code> 源进行匹配，以获取相应的账户详细信息。</p>
<p>我们再来执行一项次要优化任务，将 <code>"${SingleAccount.route}/{${SingleAccount.accountTypeArg}}"</code> 路线也移至 <code>RallyDestinations.kt</code> 及其 <code>SingleAccount</code> 对象中<code>:</code></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">object</span> SingleAccount : RallyDestination {
    <span class="hljs-comment">// ...</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> route = <span class="hljs-string">"single_account"</span>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> accountTypeArg = <span class="hljs-string">"account_type"</span>
    <span class="hljs-keyword">val</span> routeWithArgs = <span class="hljs-string">"<span class="hljs-subst">${route}</span>/{<span class="hljs-subst">${accountTypeArg}</span>}"</span>
    <span class="hljs-keyword">val</span> arguments = listOf(
        navArgument(accountTypeArg) { type = NavType.StringType }
    )
}
</code></pre>
<p>同样，在相应的 <code>NavHost composable:</code> 中进行替换</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ...</span>
composable(
    route = SingleAccount.routeWithArgs,
    arguments = SingleAccount.arguments
) {...}
</code></pre>
<h3 data-id="heading-20"><strong>设置“Accounts”和“Overview”的起始目的地</strong></h3>
<p>现在，您已经定义了 <code>SingleAccountScreen</code> 路线及其成功导航到 <code>SingleAccountScreen</code> 所需要和接受的实参，接下来您需要确保是从上一个目的地（即您来自的目的地）传递同一 <code>accountTypeArg</code> 实参。</p>
<p>如您所见，这包含两个方面：一个是提供并传递实参的起始目的地，另一个是接受该实参并使用它显示正确信息的到达目的地。<strong>这两者都需要进行明确定义</strong>。</p>
<p>例如，当您位于 <code>Accounts</code> 目的地，并点按“Checking”账户类型时，“Accounts”目的地需要将“Checking”String（已附加到“single_account”String 路线）作为实参传递，以便成功打开相应的 <code>SingleAccountScreen</code>。其 String 路线将如下所示：<code>"single_account/Checking"</code></p>
<p>使用 <code>navController.navigateSingleTopTo(...),</code> 时，您需要使用与其完全相同的路线，并包含传递的实参，如下所示：</p>
<p><code>navController.navigateSingleTopTo("${SingleAccount.route}/$accountType")</code>。</p>
<p>将此导航操作回调传递给 <code>OverviewScreen</code> 和 <code>AccountsScreen</code> 的 <code>onAccountClick</code> 形参。请注意，这些形参已预定义为 <code>onAccountClick: (String) -&gt; Unit</code>，其中 String 作为输入。也就是说，当用户点按 <code>Overview</code> 和 <code>Account</code> 中的特定账户类型时，该账户类型 String 已经可供您使用，并且可以作为导航实参轻松传递：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">OverviewScreen(
    <span class="hljs-comment">// ...</span>
    onAccountClick = { accountType -&gt;
        navController
          .navigateSingleTopTo(<span class="hljs-string">"<span class="hljs-subst">${SingleAccount.route}</span>/<span class="hljs-variable">$accountType</span>"</span>)
    }
)
<span class="hljs-comment">// ...</span>
                    
AccountsScreen(
    <span class="hljs-comment">// ...</span>
    onAccountClick = { accountType -&gt;
        navController
          .navigateSingleTopTo(<span class="hljs-string">"<span class="hljs-subst">${SingleAccount.route}</span>/<span class="hljs-variable">$accountType</span>"</span>)
    }
)
</code></pre>
<p>为确保内容易于阅读，您可以将此导航操作提取到私有辅助扩展函数中：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.navigation.NavHostController
<span class="hljs-comment">// ...</span>
OverviewScreen(
    <span class="hljs-comment">// ...</span>
    onAccountClick = { accountType -&gt;
        navController.navigateToSingleAccount(accountType)
    }
)

<span class="hljs-comment">// ...</span>
                    
AccountsScreen(
    <span class="hljs-comment">// ...</span>
    onAccountClick = { accountType -&gt;
        navController.navigateToSingleAccount(accountType)
    }
)

<span class="hljs-comment">// ...</span>

<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> NavHostController.<span class="hljs-title">navigateToSingleAccount</span><span class="hljs-params">(accountType: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-keyword">this</span>.navigateSingleTopTo(<span class="hljs-string">"<span class="hljs-subst">${SingleAccount.route}</span>/<span class="hljs-variable">$accountType</span>"</span>)
}
</code></pre>
<p>此时，当您运行应用时，可以点击每个账户类型，系统会将您转到显示给定账户数据的对应 <code>SingleAccountScreen</code>。</p>
<h2 data-id="heading-21">8. 启用深层链接支持</h2>
<p>除了添加实参之外，您还可以添加<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fnavigation%3Fhl%3Dzh-cn%23deeplinks" target="_blank" title="https://developer.android.com/jetpack/compose/navigation?hl=zh-cn#deeplinks" ref="nofollow noopener noreferrer">深层链接</a>，将特定网址、操作和/或 MIME 类型与可组合项关联起来。在 Android 中，深层链接是指将用户直接转到应用内特定目的地的链接。Navigation Compose 支持<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fguide%2Fnavigation%2Fnavigation-deep-link%3Fhl%3Dzh-cn%23implicit" target="_blank" title="https://developer.android.com/guide/navigation/navigation-deep-link?hl=zh-cn#implicit" ref="nofollow noopener noreferrer">隐式深层链接</a>。调用隐式深层链接（例如，当用户点击某个链接）时，Android 可以将应用打开到相应的目的地。</p>
<p>在此部分中，您将添加一个新的深层链接，用于导航到包含相应账户类型的 <code>SingleAccountScreen</code> 可组合项，还要让此深层链接向外部应用公开。我们来回顾一下，此可组合项的路线是 <code>"single_account/{account_type}"</code>，这也是您将用于深层链接的路线，其中包含一些与深层链接相关的细微更改。</p>
<p>默认情况下，系统不会启用向外部应用公开深层链接这一功能，因此您还必须向应用的 <code>manifest.xml</code> 文件添加 <code>&lt;intent-filter&gt;</code> 元素，这是第一步。</p>
<p>首先，向应用的 <code>AndroidManifest.xml</code> 添加深层链接。您需要通过 <code>&lt;activity&gt;</code> 内的 <code>&lt;intent-filter&gt;</code> 创建一个新的 intent 过滤器，相应操作为 <code>VIEW</code>，类别为 <code>BROWSABLE</code> 和 <code>DEFAULT</code>。</p>
<p>然后，在该过滤器内，您需要使用 <code>data</code> 标记添加 <strong><code>scheme</code></strong>（<code>rally</code> - 应用名称）和 <strong><code>host</code></strong>（<code>single_account</code> - 导航到可组合项的路线），以定义精确的深层链接。这将为您提供 <code>rally://single_account</code> 作为深层链接网址。</p>
<p>请注意，您无需在 <code>AndroidManifest</code> 中声明 <code>account_type</code> 实参。该实参稍后会附加到 <code>NavHost</code> 可组合函数内。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">&lt;activity
    android:name=<span class="hljs-string">".RallyActivity"</span>
    android:windowSoftInputMode=<span class="hljs-string">"adjustResize"</span>
    android:label=<span class="hljs-string">"@string/app_name"</span>
    android:exported=<span class="hljs-string">"true"</span>&gt;
    &lt;intent-filter&gt;
        &lt;action android:name=<span class="hljs-string">"android.intent.action.MAIN"</span> /&gt;
        &lt;category android:name=<span class="hljs-string">"android.intent.category.LAUNCHER"</span> /&gt;
    &lt;/intent-filter&gt;
    &lt;intent-filter&gt;
        &lt;action android:name=<span class="hljs-string">"android.intent.action.VIEW"</span> /&gt;
        &lt;category android:name=<span class="hljs-string">"android.intent.category.DEFAULT"</span> /&gt;
        &lt;category android:name=<span class="hljs-string">"android.intent.category.BROWSABLE"</span> /&gt;
        &lt;<span class="hljs-keyword">data</span> android:scheme=<span class="hljs-string">"rally"</span> android:host=<span class="hljs-string">"single_account"</span> /&gt;
    &lt;/intent-filter&gt;
&lt;/activity&gt;
</code></pre>
<h3 data-id="heading-22">触发并验证深层链接</h3>
<p>现在，您可以在 <code>RallyActivity</code> 中响应传入的 intent。</p>
<p>可组合项 <code>SingleAccountScreen</code> 已经接受实参，但现在还需要接受新创建的深层链接，才能在其深层链接触发时启动此目的地。</p>
<p>在 <code>SingleAccountScreen</code> 的可组合函数内，再添加一个形参 <code>deepLinks</code>。与 <code>arguments,</code> 类似，它还接受 <code>navDeepLink</code> 列表，因为您可以定义多个指向同一目的地的深层链接。传递 <code>uriPattern</code>，匹配清单 <code>rally://singleaccount</code> 的 <code>intent-filter</code> 中定义的一个 uriPattern，但这次您还需附加其 <code>accountTypeArg</code> 实参：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.navigation.navDeepLink
<span class="hljs-comment">// ...</span>

composable(
    route = SingleAccount.routeWithArgs,
    <span class="hljs-comment">// ...</span>
    deepLinks = listOf(navDeepLink {
        uriPattern = <span class="hljs-string">"rally://<span class="hljs-subst">${SingleAccount.route}</span>/{<span class="hljs-subst">${SingleAccount.accountTypeArg}</span>}"</span>
    })
)
</code></pre>
<p>您知道接下来该怎么做，对吧？将此列表移至 <code>RallyDestinations SingleAccount:</code></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">object</span> SingleAccount : RallyDestination {
    <span class="hljs-comment">// ...</span>
    <span class="hljs-keyword">val</span> arguments = listOf(
        navArgument(accountTypeArg) { type = NavType.StringType }
    )
    <span class="hljs-keyword">val</span> deepLinks = listOf(
       navDeepLink { uriPattern = <span class="hljs-string">"rally://<span class="hljs-variable">$route</span>/{<span class="hljs-variable">$accountTypeArg</span>}"</span>}
    )
}
</code></pre>
<p>同样，在相应的 <code>NavHost</code> 可组合项中进行替换：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ...</span>
composable(
    route = SingleAccount.routeWithArgs,
    arguments = SingleAccount.arguments,
    deepLinks = SingleAccount.deepLinks
) {...}
</code></pre>
<h3 data-id="heading-23">使用 adb 测试深层链接</h3>
<p>现在，您的应用和 <code>SingleAccountScreen</code> 已准备好处理深层链接。为了测试它能否正常运行，请在已连接的模拟器或设备上重新安装 Rally，打开命令行并执行以下命令，以便模拟深层链接启动：</p>
<pre><code class="hljs language-sql" lang="sql">adb shell am <span class="hljs-keyword">start</span> <span class="hljs-operator">-</span>d "rally://single_account/Checking" <span class="hljs-operator">-</span>a android.intent.action.VIEW
</code></pre>
<p>系统会带您直接进入“Checking”账户，不过您也可以针对所有其他账户类型验证它能否正常运行。</p>
<h2 data-id="heading-24">9. 将 NavHost 提取到 RallyNavHost</h2>
<p>您的 <code>NavHost</code> 现已完成。不过，为了使其可测试并保持 <code>RallyActivity</code> 更加简洁，您可以将当前 <code>NavHost</code> 及其辅助函数（如 <code>navigateToSingleAccount</code>）从 <code>RallyApp</code> 可组合项提取到它自己的可组合函数，并将其命名为 <code>RallyNavHost</code>。</p>
<p><code>RallyApp</code> 是应使用 <code>navController</code> 直接处理的唯一一个可组合项。如前所述，其他每个嵌套的可组合屏幕应该仅获得导航回调，而不是 <code>navController</code> 本身。</p>
<p>因此，新的 <code>RallyNavHost</code> 将接受 <code>RallyApp</code> 中的 <code>navController</code> 和 <code>modifier</code> 作为形参：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">RallyNavHost</span><span class="hljs-params">(
    navController: <span class="hljs-type">NavHostController</span>,
    modifier: <span class="hljs-type">Modifier</span> = Modifier
)</span></span> {
    NavHost(
        navController = navController,
        startDestination = Overview.route,
        modifier = modifier
    ) {
        composable(route = Overview.route) {
            OverviewScreen(
                onClickSeeAllAccounts = {
                    navController.navigateSingleTopTo(Accounts.route)
                },
                onClickSeeAllBills = {
                    navController.navigateSingleTopTo(Bills.route)
                },
                onAccountClick = { accountType -&gt;
                   navController.navigateToSingleAccount(accountType)
                }
            )
        }
        composable(route = Accounts.route) {
            AccountsScreen(
                onAccountClick = { accountType -&gt;
                   navController.navigateToSingleAccount(accountType)
                }
            )
        }
        composable(route = Bills.route) {
            BillsScreen()
        }
        composable(
            route = SingleAccount.routeWithArgs,
            arguments = SingleAccount.arguments,
            deepLinks = SingleAccount.deepLinks
        ) { navBackStackEntry -&gt;
            <span class="hljs-keyword">val</span> accountType =
              navBackStackEntry.arguments?.getString(SingleAccount.accountTypeArg)
            SingleAccountScreen(accountType)
        }
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> NavHostController.<span class="hljs-title">navigateSingleTopTo</span><span class="hljs-params">(route: <span class="hljs-type">String</span>)</span></span> =
    <span class="hljs-keyword">this</span>.navigate(route) { launchSingleTop = <span class="hljs-literal">true</span> }

<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> NavHostController.<span class="hljs-title">navigateToSingleAccount</span><span class="hljs-params">(accountType: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-keyword">this</span>.navigateSingleTopTo(<span class="hljs-string">"<span class="hljs-subst">${SingleAccount.route}</span>/<span class="hljs-variable">$accountType</span>"</span>)
}
</code></pre>
<p>现在，将新的 <code>RallyNavHost</code> 添加到 <code>RallyApp</code>，然后重新运行应用，验证一切是否像先前一样正常运行：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">RallyApp</span><span class="hljs-params">()</span></span> {
    RallyTheme {
    ...
        Scaffold(
        ...
        ) { innerPadding -&gt;
            RallyNavHost(
                navController = navController,
                modifier = Modifier.padding(innerPadding)
            )
        }
     }
}
</code></pre>
<h2 data-id="heading-25">10. 测试 Compose Navigation</h2>
<blockquote>
<p><strong>注意</strong>：此 Codelab 没有介绍 Compose 测试方面的基础知识。如需了解这些内容，请参阅 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Ftesting%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/jetpack/compose/testing?hl=zh-cn" ref="nofollow noopener noreferrer">Compose 测试文档</a>或学习<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fcodelabs%2Fjetpack-compose-testing%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/codelabs/jetpack-compose-testing?hl=zh-cn" ref="nofollow noopener noreferrer">“在 Jetpack Compose 中进行测试”Codelab</a>。</p>
</blockquote>
<p>从此 Codelab 的开头开始，您就确保不将 <code>navController</code> 直接传入任何可组合项（高级应用除外），而是将导航回调作为形参传递。这样一来，您的所有可组合项均可<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fnavigation%3Fhl%3Dzh-cn%23testing" target="_blank" title="https://developer.android.com/jetpack/compose/navigation?hl=zh-cn#testing" ref="nofollow noopener noreferrer">单独测试</a>，因为它们不需要在测试中使用 <code>navController</code> 实例。</p>
<p>一定要测试整个 Compose Navigation 机制能否在应用中按预期运行，方法是测试传递给可组合项的 <code>RallyNavHost</code> 和导航操作。这些将是此部分的主要目标。如需单独测试各个可组合函数，请务必查看<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fcodelabs%2Fjetpack-compose-testing%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/codelabs/jetpack-compose-testing?hl=zh-cn" ref="nofollow noopener noreferrer">在 Jetpack Compose 中进行测试</a> Codelab。</p>
<p>若要开始测试，我们首先需要添加必要的测试依赖项，因此请返回到应用的 build 文件（位于 <code>app/build.gradle</code>）。在测试依赖项部分中，添加 <code>navigation-testing</code> 依赖项：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">dependencies {
<span class="hljs-comment">// ...</span>
  androidTestImplementation <span class="hljs-string">"androidx.navigation:navigation-testing:<span class="hljs-variable">$rootProject</span>.composeNavigationVersion"</span>
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<h3 data-id="heading-26">准备 NavigationTest 类</h3>
<p>您的 <code>RallyNavHost</code> 可独立于 <code>Activity</code> 本身进行测试。</p>
<p>由于此测试仍会在 Android 设备上运行，因此您需要创建测试目录 <code>/app/src/androidTest/java/com/example/compose/rally</code>，然后创建一个新的测试文件来测试类并将其命名为 <code>NavigationTest</code>。</p>
<p>首先，若要使用 Compose 测试 API，以及使用 Compose 进行测试并控制可组合项和应用，请添加 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fui%2Ftest%2Fjunit4%2FComposeTestRule%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/ui/test/junit4/ComposeTestRule?hl=zh-cn" ref="nofollow noopener noreferrer">Compose 测试规则</a>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.compose.ui.test.junit4.createComposeRule
<span class="hljs-keyword">import</span> org.junit.Rule

<span class="hljs-keyword">class</span> <span class="hljs-title class_">NavigationTest</span> {

    <span class="hljs-meta">@get:Rule</span>
    <span class="hljs-keyword">val</span> composeTestRule = createComposeRule()

}
</code></pre>
<h3 data-id="heading-27"><strong>编写首个测试</strong></h3>
<p>创建一个公共 <code>rallyNavHost</code> 测试函数，并为其添加 <code>@Test</code> 注解。在该函数中，首先需要设置要测试的 Compose 内容。您可以使用 <code>composeTestRule</code> 的 <code>setContent</code> 执行此操作。它接受一个可组合形参作为正文，并且支持您编写 Compose 代码，以及在测试环境中添加可组合项，就像您在常规生产环境应用中一样。</p>
<p>在 <code>setContent,</code> 内，您可以设置当前测试对象 <code>RallyNavHost</code>，并将新的 <code>navController</code> 实例传递给该对象。Navigation Testing 工件提供了一个便捷的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fnavigation%2Ftesting%2FTestNavHostController%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/navigation/testing/TestNavHostController?hl=zh-cn" ref="nofollow noopener noreferrer"><code>TestNavHostController</code></a> 供您使用。接下来，我们来添加此步骤：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.compose.ui.platform.LocalContext
<span class="hljs-keyword">import</span> androidx.navigation.compose.ComposeNavigator
<span class="hljs-keyword">import</span> androidx.navigation.testing.TestNavHostController
<span class="hljs-keyword">import</span> org.junit.Assert.fail
<span class="hljs-keyword">import</span> org.junit.Test
<span class="hljs-comment">// ...</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">NavigationTest</span> {

    <span class="hljs-meta">@get:Rule</span>
    <span class="hljs-keyword">val</span> composeTestRule = createComposeRule()

    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> navController: TestNavHostController

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">rallyNavHost</span><span class="hljs-params">()</span></span> {
        composeTestRule.setContent {
            <span class="hljs-comment">// Creates a TestNavHostController</span>
            navController = 
                TestNavHostController(LocalContext.current)
            <span class="hljs-comment">// Sets a ComposeNavigator to the navController so it can navigate through composables</span>
            navController.navigatorProvider.addNavigator(
                ComposeNavigator()
            )
            RallyNavHost(navController = navController)
        }
        fail()
    }
}
</code></pre>
<p>如果您复制了上述代码，<code>fail()</code> 调用会确保您的测试一直失败，直到出现实际断言为止。它用于提醒您完成测试的实现。</p>
<blockquote>
<p><strong>注意</strong>：如需检查 <code>RallyNavHost</code> 能否正常运行，必须先组合其层次结构，然后再测试其他一切内容。这意味着，您的测试断言和验证必须在 <code>setContent</code> 函数<strong>外部和之后</strong>编写。</p>
</blockquote>
<p>如需验证是否显示了正确的屏幕可组合项，您可以使用其 <code>contentDescription</code> 并断言它会显示。在此 Codelab 中，“Accounts”和“Overview”目的地的 <code>contentDescription</code> 之前已设置完毕，因此您已经可以使用它们进行测试验证。</p>
<p>首次验证时，您应该检查“Overview”屏幕在 <code>RallyNavHost</code> 首次初始化时是否会作为第一个目的地显示。您还应重命名测试来反映这一点，不妨将其命名为 <code>rallyNavHost_verifyOverviewStartDestination</code>。为此，请将 <code>fail()</code> 调用替换为以下代码：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.compose.ui.test.assertIsDisplayed
<span class="hljs-keyword">import</span> androidx.compose.ui.test.onNodeWithContentDescription
<span class="hljs-comment">// ...</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">NavigationTest</span> {

    <span class="hljs-meta">@get:Rule</span>
    <span class="hljs-keyword">val</span> composeTestRule = createComposeRule()

    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> navController: TestNavHostController

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">rallyNavHost_verifyOverviewStartDestination</span><span class="hljs-params">()</span></span> {
        composeTestRule.setContent {
            navController = 
                TestNavHostController(LocalContext.current)
            navController.navigatorProvider.addNavigator(
                ComposeNavigator()
            )
            RallyNavHost(navController = navController)
        }

        composeTestRule
            .onNodeWithContentDescription(<span class="hljs-string">"Overview Screen"</span>)
            .assertIsDisplayed()
    }
}
</code></pre>
<p>再次运行测试，并验证测试是否会通过。</p>
<p>由于您需要以相同的方式为即将到来的每项测试设置 <code>RallyNavHost</code>，因此您可以将其初始化部分提取到带注解的 <code>@Before</code> 函数中，以避免多余的重复代码并确保测试更加简洁：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> org.junit.Before
<span class="hljs-comment">// ...</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">NavigationTest</span> {

    <span class="hljs-meta">@get:Rule</span>
    <span class="hljs-keyword">val</span> composeTestRule = createComposeRule()
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> navController: TestNavHostController

    <span class="hljs-meta">@Before</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setupRallyNavHost</span><span class="hljs-params">()</span></span> {
        composeTestRule.setContent {
            navController = 
                TestNavHostController(LocalContext.current)
            navController.navigatorProvider.addNavigator(
                ComposeNavigator()
            )
            RallyNavHost(navController = navController)
        }
    }

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">rallyNavHost_verifyOverviewStartDestination</span><span class="hljs-params">()</span></span> {
        composeTestRule
            .onNodeWithContentDescription(<span class="hljs-string">"Overview Screen"</span>)
            .assertIsDisplayed()
    }
}
</code></pre>
<h3 data-id="heading-28">在测试中导航</h3>
<p>您可以通过多种方式测试导航实现，具体方法是：点击界面元素，然后验证显示的目的地；或者比较预期路线与当前路线。</p>
<h4 data-id="heading-29"><strong>通过界面点击和屏幕 contentDescription 进行测试</strong></h4>
<p>如果您要测试具体应用的实现，最好在界面中执行点击操作。接下来的文本内容可以验证这一点：在“Overview”屏幕中，点击“Accounts”子部分中的“SEE ALL”按钮后，您便会转到“Accounts”目的地：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/310ee2cbe7c34e54a5231c0cbe7cb41e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmVzdF9KZXJyeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767098671&amp;x-signature=S6Zb68uxfg1XgcjmFjI6JQDtA28%3D" alt="image.png" loading="lazy"/></p>
<p>您将再次在 <code>OverviewScreenCard</code> 可组合项中使用为此特定按钮设置的 <code>contentDescription</code>，从而通过 <code>performClick()</code> 模拟对该按钮的点击，并验证“Accounts”目的地随后是否会显示：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.compose.ui.test.performClick
<span class="hljs-comment">// ...</span>

<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">rallyNavHost_clickAllAccount_navigatesToAccounts</span><span class="hljs-params">()</span></span> {
    composeTestRule
        .onNodeWithContentDescription(<span class="hljs-string">"All Accounts"</span>)
        .performClick()

    composeTestRule
        .onNodeWithContentDescription(<span class="hljs-string">"Accounts Screen"</span>)
        .assertIsDisplayed()
}
</code></pre>
<p>您可以按照此模式在应用中测试其余所有的点击导航操作。</p>
<h4 data-id="heading-30">通过界面点击和路线对比进行测试</h4>
<p>您还可以使用 <code>navController</code> 检查您的断言，只需将当前 String 路线与预期路线进行比较即可。为此，请按照与上一部分中相同的步骤，在界面中执行点击操作，然后使用 <code>navController.currentBackStackEntry?.destination?.route</code> 来比较当前路线与预期路线。</p>
<p>您还需要再执行一个步骤，即确保先在“Overview”屏幕上滚动到“Bills”子部分，否则测试将会失败，因为它无法找到具有 <code>contentDescription</code>“All Bills”的节点：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.compose.ui.test.performScrollTo
<span class="hljs-keyword">import</span> org.junit.Assert.assertEquals
<span class="hljs-comment">// ...</span>

<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">rallyNavHost_clickAllBills_navigateToBills</span><span class="hljs-params">()</span></span> {
    composeTestRule.onNodeWithContentDescription(<span class="hljs-string">"All Bills"</span>)
        .performScrollTo()
        .performClick()

    <span class="hljs-keyword">val</span> route = navController.currentBackStackEntry?.destination?.route
    assertEquals(route, <span class="hljs-string">"bills"</span>)
}
</code></pre>
<blockquote>
<p><strong>注意</strong>：如需详细了解导航代码的高级测试，请参阅<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fguide%2Fnavigation%2Fnavigation-testing%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/guide/navigation/navigation-testing?hl=zh-cn" ref="nofollow noopener noreferrer">测试导航</a>指南。</p>
</blockquote>
<p>您可以按照这些模式涵盖任何其他导航路线、目的地和点击操作，以便完成测试类。立即运行整套测试，验证它们是否均已通过。</p>
<h2 data-id="heading-31">11. 恭喜</h2>
<p>恭喜，您已成功完成此 Codelab！您可以<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fandroid%2Fcodelab-android-compose%2Ftree%2Fend%2FNavigationCodelab" target="_blank" title="https://github.com/android/codelab-android-compose/tree/end/NavigationCodelab" ref="nofollow noopener noreferrer">在此处找到解决方案代码</a>，并将其与您的代码进行比较。</p>
<p>您已向 Rally 应用添加了 Jetpack Compose Navigation，现在已经熟悉了它的关键概念。您学习了如何设置可组合目的地的导航图、定义导航路线和操作、通过实参向路线传递额外信息、设置深层链接以及测试导航。</p>
<p>如需获取更多主题和信息（例如<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fnavigation%3Fhl%3Dzh-cn%23bottom-nav" target="_blank" title="https://developer.android.com/jetpack/compose/navigation?hl=zh-cn#bottom-nav" ref="nofollow noopener noreferrer">底部导航栏集成</a>、多模块导航和<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fnavigation%3Fhl%3Dzh-cn%23nested-nav" target="_blank" title="https://developer.android.com/jetpack/compose/navigation?hl=zh-cn#nested-nav" ref="nofollow noopener noreferrer">嵌套图</a>），您可以访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fandroid%2Fnowinandroid" target="_blank" title="https://github.com/android/nowinandroid" ref="nofollow noopener noreferrer">Now in Android GitHub 代码库</a>，了解具体的实现方式。</p>
<h3 data-id="heading-32"><strong>接下来做什么？</strong></h3>
<p>参阅以下材料，继续完成您的 <a href="https://link.juejin.cn?target=http%3A%2F%2Fgoo.gle%2Fcompose-pathway" target="_blank" title="http://goo.gle/compose-pathway" ref="nofollow noopener noreferrer">Jetpack Compose 开发者在线课程</a>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fcodelabs%2Fjetpack-compose-testing%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/codelabs/jetpack-compose-testing?hl=zh-cn" ref="nofollow noopener noreferrer">“测试 Compose”Codelab</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DEOQB8PTLkpY%26hl%3Dzh-cn" target="_blank" title="https://www.youtube.com/watch?v=EOQB8PTLkpY&amp;hl=zh-cn" ref="nofollow noopener noreferrer">“Jetpack Compose 中的常见性能问题”视频</a></li>
</ul>
<p>如需详细了解 Jetpack Navigation，请参阅以下内容：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fguide%2Fnavigation%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/guide/navigation?hl=zh-cn" ref="nofollow noopener noreferrer">Jetpack 导航</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fcodelabs%2Fandroid-navigation%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/codelabs/android-navigation?hl=zh-cn" ref="nofollow noopener noreferrer">“了解 Jetpack Navigation”Codelab</a></li>
</ul>
<h3 data-id="heading-33">参考文档</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fnavigation%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/jetpack/compose/navigation?hl=zh-cn" ref="nofollow noopener noreferrer">“使用 Compose 进行导航”文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fnavigation%2Fcompose%2Fpackage-summary%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/navigation/compose/package-summary?hl=zh-cn" ref="nofollow noopener noreferrer">Navigation Compose 参考文档</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[抢先实测豆包1.8模型，多模态Agent超强！]]></title>    <link>https://juejin.cn/post/7586877892467834907</link>    <guid>https://juejin.cn/post/7586877892467834907</guid>    <pubDate>2025-12-23T12:55:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586877892467834907" data-draft-id="7586872817875943450" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="抢先实测豆包1.8模型，多模态Agent超强！"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-23T12:55:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苍何"/> <meta itemprop="url" content="https://juejin.cn/user/588993963763405"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            抢先实测豆包1.8模型，多模态Agent超强！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993963763405/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苍何
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T12:55:56.000Z" title="Tue Dec 23 2025 12:55:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是苍何的第 463 篇原创！</p>
<p>大家好，我是人在火山大会的苍何。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a899720895b347bfa7a13c46ac7538bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099356&amp;x-signature=hHMg4dHF7tbhSEfCFajUyFbd30k%3D" alt="图片" loading="lazy"/></p>
<p>说实话，我现在就在火山引擎 FORCE 原动力大会的现场，人太多了，多到要挤着才能进来。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c9a7a542baa41e6a3772d52adc4d125~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099356&amp;x-signature=cdt%2BNHT2lwO%2BobeizJrOENtK%2FLI%3D" alt="图片" loading="lazy"/></p>
<p>这一年也见证了豆包大模型的快速成长，今天豆包大模型 1.8 也正式发布。</p>
<p>这次模型的更新带来了更强的 Agent 能力和多模态理解能力，在公开测试集中的表现相对于豆包 1.6有了很大的提升。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ebeb84f9b1f45ac81a21227580a901a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099356&amp;x-signature=2BeSakW%2BPk4N1y84am%2BHP9FrN0g%3D" alt="图片" loading="lazy"/></p>
<p>不少能力都可以和其他全球顶尖模型一争高下，在不同场景维度下的测试集表现也很出色。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40519c8e1e9144baaed2809f28d12f21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099356&amp;x-signature=F4TZgUYkPxHHhvf88tzyz4p%2FqmI%3D" alt="图片" loading="lazy"/></p>
<p>豆包大模型 1.8 大幅增强工具调用（Tool Use）能力，长文和多轮指令遵循大幅度增强，Coding能力也显著增强。</p>
<p>具备 OS Agent 落地能力，支持 Agent 完成屏幕操作任务。模型格式输出更稳定，执行规划能力和复杂流程理解再提升，更适合复杂多步多分支的企业级 Agent 任务。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8d7c0a07b8243d7b91a809c10969a19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099356&amp;x-signature=GjU%2B%2FjmmYjDOyaVc2K3VpK6kVjA%3D" alt="图片" loading="lazy"/></p>
<p>同时视觉理解基础能力大幅跃升，图片理解Tokens消耗更少，理解精度更高，单次视频理解帧数从640帧提升至1280帧，（在1秒1帧的情况下，可支持20分钟长视频理解）。</p>
<p>同时火山方舟应用实验室还支持Video Cup Tool体验：新增低帧率(如每5s一帧)查看完整视频后，聚焦某个与问题强相关的视频片段，正常或高帧率（如每1s一帧或5帧）具体理解并回答问题。</p>
<p>模型推理能力更出色，支持思考长度可调节，各模式下思考更加精简，Tokens更节省。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c83c6736930443d7b9c3299d1a7ef277~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099356&amp;x-signature=7vIwS7oeZQPMetGvRQpTmlCtbZw%3D" alt="图片" loading="lazy"/></p>
<p>关于模型信息更新信息给大家介绍完毕，接下来是带来一手实测，其实前些天就拿到了内测资格，这次测试我更聚焦于实际 Agent复杂场景，而非简单case测试。</p>
<p>先是来一个自动写公众号图文并发布的场景，要求根据主题搜索相关图文信息，并写文章，同时发布到公众号后台。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d0abf0ae7154b938d2d5ec636029cf3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099356&amp;x-signature=MQji13Yrok1lnUeMTyiZrr5rJLU%3D" alt="wxv_4301758944881786880" loading="lazy"/></p>
<p>我是在 Trae 中调用豆包大模型 1.8 的 API，然后自定义的智能体。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/476474e909594110862847fb890fd7f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099356&amp;x-signature=oThvdiZNuh4D%2Fd2LCrMok61Bru8%3D" alt="图片" loading="lazy"/></p>
<p>智能体的提示词是这样子的：</p>
<pre><code class="hljs language-arduino" lang="arduino">你是专业的内容编辑，擅长做公众号文章的创作，你能根据指定的主题创作一篇公众号文章，并写入到文件中，文件名以标题.md来命名，你需要先调用Chrome DevTools 工具去浏览器搜索查找相关信息（注意这一步是必须的，你必须调用工具自行百度搜索，
搜索内容是用户输入的主题，请严格将用户主题放入搜索而非其他多余元素），然后调用MiniMax MCP工具来生成文章配图，
放在image文件夹下，并引入到到文章中。最后帮我到公众号后台发布。公众号标题你自行选择爆款标题。
</code></pre>
<p>同时配置了 Chrome DevTools MCP 和 MiniMax MCP。</p>
<p>可以看到豆包大模型 1.8 会根据任务自动调用浏览器搜索内容，然后生成文字和配图，最后发布。</p>
<p>整个长时任务，可以看到豆包大模型 1.8 完成的很不错。</p>
<p>另外看一个更复杂的实测，扮演一个CTO 助手审核邮件匹配出合适的投资项目。</p>
<p>为了测试它到底有多硬核，我给它设置了一个极具挑战性的 <strong>Case</strong>：模拟一个 <strong>CTO 助手</strong>，完成一整套 AI 项目的立项审批。</p>
<blockquote>
<p>背景：模拟一家奶茶公司，茶小鲜，要投资 AI 项目的，由各个分公司提报项目到指定邮件。CTO再结合公司的情况进行审查出合适的投资项目。</p>
</blockquote>
<p>先给大家看下最终的效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd55bc8d4dbb4eaba89da9795360dace~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099356&amp;x-signature=Z1FKYm37%2FmwxB5c%2BZD1G1HqA8WY%3D" alt="wxv_4301754318765424641" loading="lazy"/></p>
<p>整个任务足够复杂，从邮件中提取附件并解析附件，然后去调用众多的公司文件解析，最终生层决策报告。</p>
<p>你可以看下我给的提示词：</p>
<pre><code class="hljs language-objectivec" lang="objectivec">作为 <span class="hljs-built_in">CTO</span> 助手，请按照以下详细流程完成 AI 项目审批工作：
<span class="hljs-number">1.</span> 邮件筛选与提取：
● 使用 Chrome DevTools 工具登录 <span class="hljs-number">163</span> 邮箱
● 精确筛选满足以下条件的邮件：
 ○ 主题包含<span class="hljs-string">"立项申请"</span>的邮件
 ○ 主题包含<span class="hljs-string">"2026年战略重点"</span>的邮件
● 确保完整获上述取邮件正文内容和所有附件
<span class="hljs-number">1.</span> 附件下载与存储：
● 将所有符合条件的邮件附件下载至指定路径：/Users/Downloads<span class="hljs-comment">/*.pdf
2. 内容解析与整合：
● 调用 mcp-email-service 中的专用解析工具
● 对每份PDF附件进行结构化解析
● 将解析结果与对应邮件正文内容进行智能整合
3. 战略契合度评估：
● 以公司最新发布的 邮件 2026年战略重点 的正文和附件内容 为评估基准
● 为每个项目生成量化评分和详细评估意见
4. HTML汇报页面制作：
● 创建专业的企业级HTML静态页面，包含：
 ○ 项目概览仪表盘
 ○ 战略契合度雷达图
 ○ 预算分配饼图
 ○ ROI预测折线图
● 确保所有数据展示均标注明确来源：
 ○ 直接引用原始PDF文件关键页截图
 ○ 标注具体引用位置（页码/段落）
● 实现交互功能：
 ○ 点击数据可跳转至对应PDF原文
 ○ 支持筛选和排序功能
5. 自动交付：
● 生成完成后自动在默认浏览器中打开HTML页面
质量要求：
1. 数据准确性：所有引用数据必须与原始文件100%一致
2. 视觉规范：符合公司VI标准，使用官方配色方案
3. 安全要求：处理过程中不得存储任何敏感邮件内容
</span></code></pre>
<p>可以看到它直接调用 Chrome DevTools MCP，像真人一样登录邮箱、精准筛选、自动下载附件到指定路径。这种 OS Agent 的落地感，真的非常丝滑。 </p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8089da4547bc4c6ca3e1d8e7222a8105~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099356&amp;x-signature=RzMmuhpouKuQvANju6Jm35AcUrw%3D" alt="图片" loading="lazy"/></p>
<p>它没有上来就盲目操作，而是先在后台给自己拆解了 10 个任务步骤：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-number">1</span>、登录<span class="hljs-number">163</span>邮箱并筛选包含"立项申请"的邮件
<span class="hljs-number">2</span>、下载符合条件邮件的所有PDF附件到/Downloads/
<span class="hljs-number">3</span>、调用mcp-email-service解析所有PDF附件和邮件正文
<span class="hljs-number">4</span>、以指定基准文件评估项目战略契合度，选出最合适的投资项目
<span class="hljs-number">5</span>、创建企业级<span class="hljs-selector-tag">HTML</span>静态汇报页面，包含仪表盘、图表和交互功能
<span class="hljs-number">6</span>、在默认浏览器中打开生成的<span class="hljs-selector-tag">HTML</span>页面完成交付
<span class="hljs-number">7</span>、解析新增补充文档：中国茶饮AI应用白皮书、投资回报分析报告、预算制度、人力资源档案
<span class="hljs-number">8</span>、结合补充文档重新评估项目投资价值，确定最终最优项目
<span class="hljs-number">9</span>、更新<span class="hljs-selector-tag">HTML</span>评估报告，整合新的评估维度
<span class="hljs-number">10</span>、重新打开更新后的<span class="hljs-selector-tag">HTML</span>报告完成最终交付
</code></pre>
<p>大概总结一下</p>
<p>登录与筛选： 搞定 163 邮箱。登录这个步骤需要人工扫描参与收集数据（邮件的正文和邮件的附件）<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/523dfa3c7a074066a3afbfc9acc76744~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099356&amp;x-signature=6uYrGEo2jewW%2F777eUFdn4i9pok%3D" alt="图片" loading="lazy"/></p>
<p>调用MCP工具 mcp-email-service 提取结构化数据这里包含了需要结合的本地文件。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e8b23db6fe841fa99a37f98a615326e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099356&amp;x-signature=QHkjfXgBRFSTbNC73Iz97orcapQ%3D" alt="图片" loading="lazy"/></p>
<p>每一个 PDF的文件都至少有十几页，字数非常多，这人要一个个看没个把小时很难看完。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4e4f671cea04e40a15c2d6fd6997cf5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099356&amp;x-signature=OoXRx6Zf6tI5oNvmXuk9FWOzZIA%3D" alt="图片" loading="lazy"/></p>
<p>此时整个任务需要加载5+5 =10份PDF的解析任务，每份文档大小不低于500kb</p>
<p>最后是战略契合度评估环节，这一点最难，它需要理解 256K 窗口里的那堆复杂战略。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4405701805d1487a87ca5b0b318a50d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099356&amp;x-signature=%2BX2ptVdvxlOVIg7LkLBUnDfTJqA%3D" alt="图片" loading="lazy"/></p>
<p> 我中途丢给它《中国茶饮 AI 白皮书》和预算制度，它能迅速合并维度，重新修正投资价值。</p>
<p>最终自动在浏览器打开一个带交互功能的 HTML 仪表盘。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/048053bf5c3b43f483c83b4bc695e8cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099356&amp;x-signature=ZEWQo6JE84tpeOpsXF8CdH5l%2FNQ%3D" alt="图片" loading="lazy"/></p>
<p>最后得到评估报告：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a3b6831061d41a5be7d0a28fc77af6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099356&amp;x-signature=A4qKrpr07Fx6QM8s%2BJZC1nTAVWg%3D" alt="图片" loading="lazy"/></p>
<p>在测试过程中，我有几个非常深刻的体会：</p>
<p><strong>1、工具调用（ToolUse）极其稳定</strong></p>
<p>以前的 Agent 经常会在多步调用中断片，但豆包 1.8 的输出格式非常稳定。即使是面对 mcp_mcp-email-service_parse_pdf 这种复杂的自定义工具，它也能精准传参，报错率低得惊人。 </p>
<p><strong>2、思考长度可调节</strong></p>
<p>它支持思考过程的精简或深入。在处理“战略契合度评分”时，我能感觉到它在进行深度逻辑推理；而在处理下载附件这种确定性任务时，它又非常节省 Tokens，这才是成熟模型该有的样子。</p>
<p><strong>3、视觉与多模态的精准度</strong></p>
<p>在 HTML 报告里，它能直接引用 PDF 原始文件的关键页截图，并标注页码。这种对多模态内容的“索引”能力，避免了 AI 常见的胡说八道。 </p>
<p>最后统计了下大概的 token 消耗情况：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33afcdc3e8cd4892bd319221021e1bd6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099356&amp;x-signature=6BWkRUv%2Fll%2FUkbeJvXmPN4DKS34%3D" alt="图片" loading="lazy"/></p>
<p>在企业级复杂的业务场景中，豆包大模型 1.8 更适合处理复杂的 Agent 任务。</p>
<p>看完豆包 1.8 的表现，我一直在想，现在的工具真的太多了，开发者和职场人的切换成本越来越高。</p>
<p>我觉得<strong>工具不应该让人去适应它，而应该主动融入我们的工作流。</strong></p>
<p>豆包这次把 Agent、超长上下文和多模态打通，其实是给了每个人一个“一站式”的数字办公室。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[以前我以为达人营销很玄学，用了 Aha 才知道还能这么玩！（附教程）]]></title>    <link>https://juejin.cn/post/7586872817875992602</link>    <guid>https://juejin.cn/post/7586872817875992602</guid>    <pubDate>2025-12-23T12:58:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586872817875992602" data-draft-id="7586892413890707502" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="以前我以为达人营销很玄学，用了 Aha 才知道还能这么玩！（附教程）"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-23T12:58:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苍何"/> <meta itemprop="url" content="https://juejin.cn/user/588993963763405"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            以前我以为达人营销很玄学，用了 Aha 才知道还能这么玩！（附教程）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993963763405/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苍何
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T12:58:46.000Z" title="Tue Dec 23 2025 12:58:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是苍何的第 458 篇原创！</p>
<p>大家好，我是在学出海做产品的苍何。</p>
<p>最近这段时间，我一直在研究 AI 出海。</p>
<p>看了很多案例，也研究了不少工具。甚至我自己以身入局做达人，天天泡在 X、Reddit 、YouTube 上。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/746b754293714f1b84b5e0a8328d9941~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099526&amp;x-signature=qfuMyMApkDsL5h%2BeiPOw9xr6vWk%3D" alt="图片" loading="lazy"/></p>
<p>发现一个扎心的真相：<strong>再 PLG 的产品，如果没有外部信任与内容曝光，也会迅速被淹没。</strong></p>
<p>所以用达人营销解决产品增长问题显得尤为重要。我想着是否能用 AI 来解决这个问题。</p>
<p>扫了一圈市面上的工具，发现现在的 AI 营销产品真是满天飞，看得人眼花缭乱。</p>
<p>但真正能落到执行层面的并不多。大多数还是停留在辅助创作上，帮你写点文案、出几张图，解决的是“做内容快一点”，而不是“营销这件事怎么真的跑起来”。</p>
<p>直到我在 Product Hunt 上看到了 <strong>Aha</strong> 这个产品，决定深入研究一下。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2191751edd9e4abd9c5bf86a164c21b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099526&amp;x-signature=U5dO%2F3Q4aOCyjuDFyaNayEQF1tU%3D" alt="图片" loading="lazy"/></p>
<p>查了下 Aha 这家公司，主要是做 AI 达人营销的，也即为品牌与创作者搭建更高效、更智能的平台协作体系。团队成员来自北美、亚洲等地，拥有连续创业、VC 投资及TikTOK、阿里等大厂背景。<strong>产品上线 9个月即赢得全球 300+ 家企业客户的信任与长期合作。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3361fed844fc4a6bbe8d39e83b1b6cf4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099526&amp;x-signature=fuob6YhB4tUA0oKqyQp%2FTbezNjA%3D" alt="图片" loading="lazy"/></p>
<p>在这之前，我特意去扒了他们的技术 Blog 和白皮书（老读者的都知道，我不信宣传语，我信底层逻辑）。读完之后，我发现这东西有点意思。</p>
<p>它不是那种一键生成的傻瓜工具，相反，<strong>它是有使用门槛的。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74c631c91b4446908b0c948d951c45a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099526&amp;x-signature=Zuo9r00R%2BDw7a1DOm9u9U8PpNqE%3D" alt="图片" loading="lazy"/>来源：<a href="https://link.juejin.cn?target=https%3A%2F%2Faha.inc%2Funiversity%3FuniversityType%3DAha%2Binsights%26utm_source%3Dinf022" target="_blank" title="https://aha.inc/university?universityType=Aha+insights&amp;utm_source=inf022" ref="nofollow noopener noreferrer">aha.inc/university?…</a></p>
<p>这个门槛不在于操作难，而在于<strong>认知的转变</strong>。一旦你搞明白了其中的 AI 逻辑和原理，把它当成一个「智能 Agent」而不是一个普通的搜号工具来用，一切就会变得极其丝滑。</p>
<p>今天就来拆解一下，这个声称比行业领先一年的产品，到底是怎么用大模型重构达人营销的。</p>
<h2 data-id="heading-0">01 告别「玄学」，回归「第一性原理」</h2>
<p>以前找达人（Influencer）带货或推广，在很多人的印象里就是「玄学」。</p>
<p>你会觉得：这个博主粉丝多，应该能火；那个博主看起来很极客，应该适合我的产品。结果投下去，钱花了，水花都没一个。</p>
<p>Aha 的创始人 Kay 在他们的技术复盘里提到了一个很有趣的观点：<strong>达人营销的本质，其实和「搜索/广告推荐」是同一类问题</strong> 。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b1f8c70f6b8404aae206b4d90fe1e73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099526&amp;x-signature=aUb%2B7wBGELeUObhIMGb6rP3EJBM%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<ul>
<li><strong>Query（查询）：</strong>  你的品牌、产品、Campaign 需求。</li>
<li><strong>Candidates（候选人）：</strong>  全球几百万的创作者。</li>
<li><strong>Scoring Function（评分）：</strong>  谁最相关、最有价值。</li>
</ul>
<p>所以，Aha 并没有搞什么花里胡哨的新名词，而是老老实实地用大模型重构了经典的「召回（Recall）→ 粗排（Coarse Ranking）→ 精排（Fine Ranking）」架构。</p>
<p><strong>这里最大的创新点在于：它让 LLM（大模型）成为了决策者，而不是单纯的特征提取工具</strong>。</p>
<p>传统推荐系统需要海量的历史点击数据，但达人营销是「零数据」行业，我们不知道这个博主还没发的视频会不会火。这时候，大模型的「语义理解」能力就进场了。</p>
<p>它像一个人类专家一样，去阅读博主的字幕、简介、风格，然后推理：<strong>这个人的受众，到底会不会买我的单？</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94f07549246448a2ba0fadd5c86d9d54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099526&amp;x-signature=bzsO%2ByGnRMvusaJBYTtHUSEzPok%3D" alt="图片" loading="lazy"/></p>
<p>这就是为什么说它有门槛——你得相信 AI 的推理能力，胜过相信粉丝数。</p>
<h2 data-id="heading-1">02 不被「宰」的秘密：动态定价</h2>
<p>除了找人准，还有一个痛点是「谈钱」。</p>
<p>海外达人报价那是相当混乱，完全看心情。Aha 做了一个<strong>动态定价 AI 系统</strong> 。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d78fa63b80e44c1d8d87de37cefc552f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099526&amp;x-signature=PgYKsQrgn1mZWVqbpOmdIgKS31o%3D" alt="图片" loading="lazy"/></p>
<p>它不靠猜，而是基于达人的历史表现、受众数据、甚至实时的市场供需关系（比如旺季淡季），自动算出一个一口价 。</p>
<p>这有点像打车软件的预估价，直接省去了你跟达人一来一回几十封邮件砍价的时间。</p>
<p>看个数据：</p>
<p>Aha 的客户 Vizard（一个 AI 切片工具），以前人工搞一个月才能完成的达人合作，用 Aha 几天就搞定了，效率提升了 5-10 倍。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d2dd288b6b0414d8c940c772550d007~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099526&amp;x-signature=PCD8HOJ26mnqCUDt24DZsptWjRE%3D" alt="图片" loading="lazy"/></p>
<p>还有一个大家都比较熟悉的做 PPT 的 AI 产品 AiPPT，平均每次点击成本（CPC）甚至压到了 $0.43 。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c9b824a337442c09c745cf23d62052e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099526&amp;x-signature=Knf5VSBOIguDeS5ncVDYu2oUUI4%3D" alt="图片" loading="lazy"/></p>
<p>这在传统的 Agency 模式下，几乎是不可能做到的数据。</p>
<h2 data-id="heading-2">03 既然这么强，到底该怎么用？</h2>
<p>如果你也想试试用 AI Agent 来替你跑腿，这里有几个我总结的「避坑指南」。</p>
<p><strong>第一：Campaign 信息越精确，AI 做得越好（Prompt 工程）</strong></p>
<p>在 Aha 上创建 Campaign，输入 URL 它会自动抓取信息。但我建议你别偷懒，<strong>要把这一步当成是在写 Prompt。</strong></p>
<p>虽然它能自动生成，但你要人工去校准。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ac46699ff094deab46aa8bd3f4efb5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099526&amp;x-signature=F%2FtIEMrRd4iRG72pzFO1WDPCD6c%3D" alt="图片" loading="lazy"/></p>
<p>比如：你的竞品是谁？你的核心受众画像（Persona）到底是什么？</p>
<p>你给 AI 的 Context（上下文）越丰富、越准确，它在「精排」阶段的语义推理就越精准。别指望你给个「好用的软件」这种模糊指令，它能给你找到精准的垂类博主。</p>
<p>另外我发现还有一个非常重要、但经常被忽略的检查步骤。</p>
<p>在正式发布 Campaign 之前，Aha 会给你 3–5 个预匹配达人。</p>
<p>这一步的作用不是让你直接挑达人，而是用来“校验前面的 Campaign 信息是否设置准确”。</p>
<p>你可以简单看几个问题：</p>
<p>1、这些达人的内容方向，是否贴近你设定的 Persona？</p>
<p>2、他们是否是你“希望被你的目标用户看到的那种人”？</p>
<p>如果你发现这 3–5 个达人明显不对路，那基本可以确定你前面的 Context 给得不够准。</p>
<p>这时候最优解不是「凑合着发」，而是果断返回第一步，重新编辑 Campaign 信息。</p>
<p>相反，如果这几个预匹配达人一眼看过去就很对，那说明你的产品信息已经写对了，语义方向是清晰的，这时再进入付费 + 发布，效率和结果都会好很多。</p>
<p>⚠️ 这里一定要注意一点：</p>
<p>这 3–5 个预匹配达人并不是完整的合作名单，只是一个「校准样本」，千万别在这里就开始纠结数量或者覆盖面，别误会了 hhhh。</p>
<p>真正的 Aha，是在你确认方向正确、正式发布之后才开始全速工作的。</p>
<p>前面的步骤，本质上都是在帮你把「方向盘校正好」。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec16f4a7fac04f3db81c7a27dedac9bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767099526&amp;x-signature=DQWTM3nI0Dfy%2Bl9e7PexqWiiXxc%3D" alt="图片" loading="lazy"/></p>
<p><strong>第二：格局打开，全球投放</strong></p>
<p>Aha 覆盖了 140 多个国家。很多出海的朋友如果不熟悉当地语言，往往只盯着英美投。</p>
<p>但其实，除了少数价值明显偏低、转化路径不清晰的市场之外，很多非英语国家（比如拉美、东南亚）的流量洼地价值巨大，达人更好找、报价更理性、内容竞争没那么激烈。</p>
<p>利用 Aha 的多语言能力，你应该尽可能多选一些国家和语言。国家一放开，语言一放开，可合作的达人池自然就会变大，同样的预算，能跑出的内容数量和测试空间，也会明显拉开差距。</p>
<p>既然 AI 能帮你解决了多语言沟通、建联、谈价、合同和流程合规这些本该最麻烦的问题，就别把自己的路走窄了。</p>
<p><strong>第三：预算结构要符合「量变到质变」</strong></p>
<p>如果你只打算投 1 个博主，那我建议你别用 Aha，去买彩票可能更快。</p>
<p>Aha 的逻辑是概率与确定性的博弈。根据他们的最佳实践，初期最好能投 50-100 个达人，用数量来放大爆款的概率 。</p>
<p>这就是我在开头说的「门槛」：</p>
<p>你不能带着「赌一把」的心态，而要带着「做实验」的心态。利用 AI 的规模化能力，快速跑出数据，然后复投那些效果好的 ROI 模型。</p>
<h2 data-id="heading-3">04 什么样的产品适合用？</h2>
<p>研究了一圈，我觉得两类团队最适合用 Aha：</p>
<p><strong>1、AI / 软件 / App / AI 硬件类产品</strong></p>
<p>这类产品往往不是“卖一个功能点”，而是卖一整套使用体验或工作方式的改变。</p>
<p>无论是 AI 工具、企业软件，还是 AI 硬件，单靠官网文案或广告，很难让用户真正理解它“好在哪”。</p>
<p>相比反复解释参数、能力和技术路线，让真实创作者直接演示使用过程——比如一次完整的操作流程、一个真实使用场景、一个前后对比的效果展示，往往比再精致的文案都更有说服力。</p>
<p>本质上，这类产品需要被看到、被用过、被理解，而不是被“说明”。</p>
<p>2、具备一定团队规模、处于快速增长期的创业团队</p>
<p>这类团队通常已经明确增长方向，也知道达人营销是有效手段，但现实问题是：人永远不够用。</p>
<p>市场同学要分出很多精力做脏活累活：</p>
<p>选达人、建联、谈合作、审内容、催进度、看数据……</p>
<p>哪一步都不复杂，但全部堆在一起，就会迅速吃掉整个团队的精力。</p>
<p>Aha 更适合这种“没时间、没人力、有预算、有计划”的团队。</p>
<p>把大量重复、琐碎、但必须被执行的工作交给 AI，让有限的人力真正用在策略判断、创意方向和结果决策上，而不是被流程拖慢增长节奏。</p>
<h3 data-id="heading-4">写在最后</h3>
<p>现在的 AI 工具很多，能真正解决业务闭环的不多。</p>
<p>Aha 给我的感觉是，它不仅是个工具，更像是一个「全职的 AI 营销员工」。它帮你把找人、发邮件、谈价格、签合同、催稿子这些脏活累活全干了。</p>
<p>如果你的产品也准备出海，或者正在为海外增长发愁，建议你别急着上手操作。</p>
<p>因为是 ToB 的产品，流程还是比较严谨的。<strong>强烈建议先去官网约个 Demo 演示</strong>，让他们的专家给你讲讲具体怎么适配你的赛道，感受一下那个「语义匹配」的精准度，再决定要不要上车。</p>
<p>少走弯路，才是最快的捷径。</p>
<p>在 AI 时代，对普通人来说真正的壁垒从来不是模型本身，而是如何把模型嵌入到复杂业务流里，让它能够稳定、规模化地产生结果。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在macOS上无缝整合：为Claude Code配置魔搭社区免费API完全指南]]></title>    <link>https://juejin.cn/post/7586922268024340516</link>    <guid>https://juejin.cn/post/7586922268024340516</guid>    <pubDate>2025-12-23T13:03:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586922268024340516" data-draft-id="7586588823906811913" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在macOS上无缝整合：为Claude Code配置魔搭社区免费API完全指南"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-23T13:03:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="90后晨仔"/> <meta itemprop="url" content="https://juejin.cn/user/2717648476705773"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在macOS上无缝整合：为Claude Code配置魔搭社区免费API完全指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2717648476705773/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    90后晨仔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T13:03:13.000Z" title="Tue Dec 23 2025 13:03:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">引言：当Claude遇见魔搭，本地开发者的福音</h3>
<p>本文将详细记录在macOS系统上，从零开始配置Claude Code使用魔搭API的完整过程，涵盖每一步操作、遇到的每一个坑及其解决方案。</p>
<h3 data-id="heading-1">环境准备与初始状态</h3>
<p><strong>系统环境</strong>：macOS (Apple Silicon)，终端为zsh，已安装Homebrew。
<strong>目标</strong>：配置Claude Code，使其后端使用魔搭社区的免费Anthropic兼容API。</p>
<h3 data-id="heading-2">第一阶段：Python环境搭建与基础配置</h3>
<h4 data-id="heading-3">问题一：pip命令不存在</h4>
<p>最初尝试安装anthropic库时，终端提示<code>zsh: command not found: pip</code>。</p>
<p><strong>解决方案</strong>：</p>
<ol>
<li>通过Homebrew安装Python 3：<code>brew install python</code></li>
<li>验证安装：<code>python3 --version</code> 和 <code>pip3 --version</code></li>
</ol>
<h4 data-id="heading-4">问题二：externally-managed-environment错误</h4>
<p>在系统Python环境下直接运行<code>pip install anthropic</code>遇到此错误，这是新版Python的保护机制。</p>
<p><strong>解决方案</strong>：使用Python虚拟环境，隔离项目依赖：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建虚拟环境</span>
python3 -m venv venv
<span class="hljs-comment"># 激活虚拟环境</span>
<span class="hljs-built_in">source</span> venv/bin/activate
<span class="hljs-comment"># 在虚拟环境中安装所需库</span>
pip install anthropic
</code></pre>
<h3 data-id="heading-5">第二阶段：魔搭API配置详解</h3>
<h4 data-id="heading-6">获取魔搭API密钥</h4>
<ol>
<li>注册并登录<a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelscope.cn" target="_blank" title="https://modelscope.cn" ref="nofollow noopener noreferrer">魔搭社区</a></li>
<li>完成阿里云账号绑定（必需步骤）</li>
<li>在个人中心获取Access Token（格式为<code>ms-xxxxxxxxxxxx</code>）</li>
<li><strong>关键点</strong>：实际使用时需去掉<code>ms-</code>前缀</li>
</ol>
<h4 data-id="heading-7">环境变量配置</h4>
<p>在<code>~/.zshrc</code>中添加以下配置：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 魔搭社区配置</span>
<span class="hljs-built_in">export</span> ANTHROPIC_API_KEY=<span class="hljs-string">"your_token_without_ms_prefix"</span>  <span class="hljs-comment"># 重要：去掉ms-前缀</span>
<span class="hljs-built_in">export</span> ANTHROPIC_BASE_URL=<span class="hljs-string">"https://api-inference.modelscope.cn"</span>
<span class="hljs-built_in">export</span> ANTHROPIC_MODEL=<span class="hljs-string">"Qwen/Qwen3-Coder-480B-A35B-Instruct"</span>
</code></pre>
<p>使配置生效：<code>source ~/.zshrc</code></p>
<h3 data-id="heading-8">第三阶段：Claude Code配置与问题排查</h3>
<h4 data-id="heading-9">Claude Code配置文件创建</h4>
<p>创建Claude Code专用配置文件：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> -p ~/.claude
nano ~/.claude/settings.json
</code></pre>
<p>文件内容如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"ANTHROPIC_API_KEY"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"your_token_without_ms_prefix"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ANTHROPIC_BASE_URL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://api-inference.modelscope.cn"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ANTHROPIC_MODEL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Qwen/Qwen3-Coder-480B-A35B-Instruct"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>nano编辑器保存技巧</strong>：按<code>Control+X</code> → 按<code>Y</code> → 按<code>Enter</code></p>
<h4 data-id="heading-10">遇到的典型问题及解决</h4>
<ol>
<li>
<p><strong>Auth Conflict错误</strong></p>
<pre><code class="hljs language-java" lang="java">⚠Auth conflict: Both a <span class="hljs-title function_">token</span> <span class="hljs-params">(ANTHROPIC_AUTH_TOKEN)</span> and an API <span class="hljs-title function_">key</span> <span class="hljs-params">(ANTHROPIC_API_KEY)</span> are set.
</code></pre>
<p><strong>原因</strong>：环境变量命名冲突，同时存在<code>ANTHROPIC_AUTH_TOKEN</code>和<code>ANTHROPIC_API_KEY</code>。
<strong>解决</strong>：统一使用<code>ANTHROPIC_API_KEY</code>，删除或注释掉<code>ANTHROPIC_AUTH_TOKEN</code>的定义。</p>
</li>
<li>
<p><strong>模型不支持错误</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">Model id:</span> <span class="hljs-string">ZhipuAI/GLM-4.6,</span> <span class="hljs-string">has</span> <span class="hljs-literal">no</span> <span class="hljs-string">provider</span> <span class="hljs-string">supported</span>
</code></pre>
<p><strong>原因</strong>：某些模型在魔搭的Anthropic兼容接口中暂不可用。
<strong>解决</strong>：更换为魔搭文档中明确支持的模型，如<code>Qwen/Qwen3-Coder-480B-A35B-Instruct</code>。</p>
</li>
<li>
<p><strong>环境变量未生效</strong>
<strong>解决步骤</strong>：</p>
<ul>
<li>确认<code>~/.zshrc</code>修改已保存</li>
<li>运行<code>source ~/.zshrc</code>使配置生效</li>
<li>通过<code>echo $ANTHROPIC_API_KEY</code>验证</li>
<li>如仍无效，尝试重启终端应用</li>
</ul>
</li>
</ol>
<h3 data-id="heading-11">第四阶段：验证与测试</h3>
<h4 data-id="heading-12">Python脚本测试</h4>
<p>创建测试文件<code>test_modelscope.py</code>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> anthropic

client = anthropic.Anthropic(
    api_key=<span class="hljs-string">"your_token_without_ms_prefix"</span>,
    base_url=<span class="hljs-string">"https://api-inference.modelscope.cn"</span>
)

<span class="hljs-keyword">with</span> client.messages.stream(
    model=<span class="hljs-string">"Qwen/Qwen3-Coder-480B-A35B-Instruct"</span>,
    messages=[{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"用Python写一个快速排序函数"</span>}],
    max_tokens=<span class="hljs-number">1024</span>
) <span class="hljs-keyword">as</span> stream:
    <span class="hljs-keyword">for</span> text <span class="hljs-keyword">in</span> stream.text_stream:
        <span class="hljs-built_in">print</span>(text, end=<span class="hljs-string">""</span>, flush=<span class="hljs-literal">True</span>)
</code></pre>
<p>成功运行并获取代码生成结果，表明API配置正确。</p>
<h4 data-id="heading-13">Claude Code启动验证</h4>
<ol>
<li>激活虚拟环境：<code>source venv/bin/activate</code></li>
<li>启动Claude Code：<code>claude</code></li>
<li>在Claude Code中输入<code>/status</code>命令，确认Base URL和Model配置正确</li>
<li>进行实际对话测试，验证功能完整性</li>
</ol>
<h3 data-id="heading-14">配置流程图</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[开始配置] --&gt; B[安装Python环境]
    B --&gt; C{是否遇到pip问题?}
    C --&gt;|是| D[通过Homebrew安装Python]
    C --&gt;|否| E[创建虚拟环境]
    D --&gt; E
    E --&gt; F[安装anthropic库]
    F --&gt; G[获取魔搭API密钥]
    G --&gt; H[配置环境变量]
    H --&gt; I[创建Claude配置文件]
    I --&gt; J{是否遇到冲突?}
    J --&gt;|是| K[排查环境变量冲突]
    J --&gt;|否| L[启动Claude Code]
    K --&gt; L
    L --&gt; M[验证配置]
    M --&gt; N[成功使用]
</code></pre>
<h3 data-id="heading-15">最佳实践与注意事项</h3>
<ol>
<li><strong>虚拟环境管理</strong>：为每个AI项目创建独立的虚拟环境，避免依赖冲突</li>
<li><strong>API密钥安全</strong>：切勿将API密钥提交到版本控制系统，使用环境变量管理</li>
<li><strong>免费额度监控</strong>：魔搭社区每日2000次免费调用，注意合理使用</li>
<li><strong>模型选择</strong>：优先使用魔搭文档中明确支持Anthropic协议的模型</li>
<li><strong>故障排查顺序</strong>：环境变量 → 配置文件 → 网络连接 → 模型可用性</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用即梦视频3.5pro复刻爆款AI探班视频，直接发现一个AI片场！]]></title>    <link>https://juejin.cn/post/7586877892467425307</link>    <guid>https://juejin.cn/post/7586877892467425307</guid>    <pubDate>2025-12-23T11:04:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586877892467425307" data-draft-id="7586877892467376155" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用即梦视频3.5pro复刻爆款AI探班视频，直接发现一个AI片场！"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-23T11:04:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苍何"/> <meta itemprop="url" content="https://juejin.cn/user/588993963763405"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用即梦视频3.5pro复刻爆款AI探班视频，直接发现一个AI片场！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993963763405/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苍何
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T11:04:00.000Z" title="Tue Dec 23 2025 11:04:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是苍何的第 462 篇原创！</p>
<p>大家好，我是加班加到忧伤又颓废的苍何。</p>
<p>一颓废就想摆烂，一摆烂就想刷搞笑视频，结果刷到了一系列 AI 走进经典电影片场的视频，挺有趣的，而且流量还都高的离谱。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5485b7b3ee8f4d329a78e67c34756f9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=y2BSw%2F25FFrbDAMqTlhAuHW%2FmEU%3D" alt="图片" loading="lazy"/></p>
<p>立马来了灵感，想着也复刻一个（顺带蹭噌），于是花了一些时间做了个剧场更多的 AI 片场视频，走进更多片场，满满的回忆杀，答应我一定要看完。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc803b057da64661a0c646b78935fed0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=dzxBSWM%2B0RTSz48EcmCjcX5Quh0%3D" alt="wxv_4300760788626571269" loading="lazy"/></p>
<p>讲真的，看到《少年包青天》那一幕，眼里多少有些湿润，那个时候爸妈都在外面打工，暑假每天下午 4 点，端着小板凳坐在外公旁边看着包拯查案，现在他却去了另外一个世界。</p>
<p>其实这种视频的制作并不复杂，最近尤其可以很简单——就在昨天，即梦网页版做了全新升级，包括画布和 Agent 带来的交互方式更新，视频 3.5 Pro与图片 4.5 等重要模型能力上新，以及能够打造更自由更专业的“一镜到底”的智能多帧2.0。<br/>
我做的这支视频的全部流程基本都能在即梦网页版的画布里完成，真的是“一站式AI片场”。本着独乐乐不如众乐乐的宗旨，我来给大家分享下如何用即梦的“AI片场”完成这种“AI探班”的视频。按照惯例，教程同样主打有手就行，就能复刻出同样爆款视频。</p>
<p>先说工具，这次用的是即梦网页版的画布，在画布里可以调用图片 4.5 和 Agent 模式来生成所需图片，用视频 3.5 pro 来生成同框片场视频，用智能多帧 2.0 来一镜到底出片。总的来说就是最新模型、各种工具都能在画布里随时调用，不用再频繁切换场景，</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8cb4322523884725b78d642628d02d5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=iqzio2VF8tcAczqdYChLufJQdBo%3D" alt="图片" loading="lazy"/></p>
<blockquote>
<p>这个视频3.5 Pro 模型是基于字节自研模型Seedance 1.5 Pro，支持视频与音频的同时生成，我的视频中主角说话的声音其实就是通过它依次生成的。</p>
</blockquote>
<p>这个AI片场还有个特点，就是管理很清晰。用即梦画布+Agent一站式创作，除了上面提到的整合创作，还可以做可视化的素材管理，支持多个资产并行，同时还加入了工单模式，交互体验更加高效。很适合AI漫剧、AI短片等视频创作，真的是随时随地马上开机。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5cd98f69de4f4b90a17907d237c4b66d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=zTMEkNeFvVi6nZawAli4tXtSAhg%3D" alt="图片" loading="lazy"/>我发现即梦AI网页版现在不仅仅是个简单的生成工具，简直直接进化成了一个一站式“AI片场”，像AI漫剧、AI短片都可以直接在上面一站式完成，无需切换平台。</p>
<p>接下来我们直接来上教程，希望你也能复刻出一毛一样的爆款 AI 探班视频。</p>
<p>做这个视频分一下几个步骤：</p>
<p>1、文生角色图：生成一个特点鲜明的美女；（这里如果你想用真人出镜的话这一步可略过）<br/>
2、参考生成剧照场景图：上传第一步的美女图片及各经典电视剧剧照图片，生成合影；<br/>
3、首尾帧生视频；</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/868e511d105b489ba08c5238dcd5a987~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=5c%2FvicxdBUieUjWiz%2Ff81MNkRGY%3D" alt="图片" loading="lazy"/></p>
<p><strong>第一步：生成一个特点鲜明的美女</strong></p>
<p>打开即梦网页版，选择即梦 Agent 模式，输入以下提示词，Agent 自动识别并调文生图工具，就得到了这么一组校花照片。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e9954be00c34903adc61d8b23af1e61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=crnPo%2BAnwyyQ19bp5DgZrsK6wu8%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs">提示词：
提示词：双眼皮，大眼睛，长发微卷的长腿校花美女，穿着学生制服，白色百褶短裙，微笑，全身立体照片
</code></pre>
<p>一次生成 4 张，不满意可以点击「再次生成」，选择一张喜欢的照片：</p>
<p>最终我选择了这张作为女主角，特点够鲜明吧，卷发百褶裙女孩，大学梦中女神的样子。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f302a08d2af43faa06b9e0bf4d6a491~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=oQgn7q%2BoTH%2BkwBwuYTf%2FqUErjDE%3D" alt="图片" loading="lazy"/></p>
<p><strong>第二步：参考生成剧照场景图</strong></p>
<p>在即梦里，这里一共有 2 种方法，一种是同样选择即梦agent模式，上传参考图，输入提示词，agent自动调用生图模型生成图片</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b8ad4fa15e74b58ac5c9dabb9d9c8df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=BalY6PQ%2Bb7ZeXvApasm2Vh7AggE%3D" alt="图片" loading="lazy"/></p>
<p>第二种方式是直接选择图片生成，选择最新的图片 4.5 模型，来生成剧场场景照片。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6436668267ca49c1b0074925a854ddf3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=aLJcoZW86rQRNR5ExDq1tsx4vXo%3D" alt="图片" loading="lazy"/></p>
<blockquote>
<p>测下来即梦图片 4.5 相较于 4.0 有整体提升，在人像场景和美观度上，4.5得到显著改善，同时在画面美感和推理能力也有所增强。</p>
</blockquote>
<p>这个的提示词，需要根据你想要哪部电影剧场来做提示词的提炼，我提炼了个元提示词，大家可以在此基础上替换为自己想要的电影或者电视剧。</p>
<pre><code class="hljs">一张纪实风格的幕后照片，拍摄于一个繁忙的电视剧拍摄现场，模仿《填入电影或电视剧名》1999版的场景。参考图中的女孩（图1）站在四个人（图2）中间，五人看着镜头微笑合影。
背景是在古色古香的花园里面，有古代造型的亭子，
摄影机吊臂、专业灯光设备以及许多忙碌的剧组工作人员，电影颗粒感，抓拍瞬间。
</code></pre>
<p>比如，如果是想要《小李飞刀》的剧场，就直接将电视剧名填入进去，然后也可以做一些更多细节的补充。</p>
<blockquote>
<p>注意：其他合影的提示词与此类似，大家可以发挥自己的想象修改提示词</p>
</blockquote>
<p>放几张在即梦生成的合影图片，大家可以感受一下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9cda41c3a7cd4ee59b702e5d55fe83e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=iIXWnxBU%2Bit07GnSLumUQwL2%2FUY%3D" alt="图片" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b035152c378b476f92395c364821ab1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=e5vkRzGSmA9urm8CyQp9JMJaXA4%3D" alt="图片" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88fb37b59c094e7fa5477212f17d38d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=gzOZpozAi69SssMorULy8MrC8oo%3D" alt="图片" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6114623529634dda8e4d207b45846131~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=uK6HFSBhz9O89FIxXXkQCXbxafo%3D" alt="图片" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d6ed2720f014b179ac81e8ae4e72bfc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=%2Fm4arnyntkjhWR8bXGFjGp0MGyA%3D" alt="图片" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05f43f6244df4664a04f52c863f850ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=1Sf5SbjKSDLUWY3cAkDKBqBlTpE%3D" alt="图片" loading="lazy"/></p>
<p>依次生成各种合影图片之后，就可以开始视频的创作啦。</p>
<p><strong>第三步：视频生成</strong></p>
<p>在即梦中这里同样有 2 种方法，第一种就是用最新出来的智能多帧 2.0，<strong>新升级的智能多帧2.0 支持上传视频段落，进行“视频 + 视频”或“视频 + 图片”的拼接了，同时也可以视频片段修改，支持锁定特定片段后进行精细化编辑。</strong></p>
<p>点击「视频生成」，选择「智能多帧模式」，依次导入第二步生成的合影，即梦的智能多帧模式，在帧与帧之间输入提示词，生成好之后，如果对其中某个片段不满意，可以点击左下角的片段编辑。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7888d46567d24bf3bca9c94c40a6e070~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=7E9XyNAHlNx9FOqvoXdDQVlITEg%3D" alt="图片" loading="lazy"/></p>
<p>这里每个帧之间的提示词，基本都是这样的，如果想更复杂也可以自己稍加修改。</p>
<blockquote>
<p>提示词：图2中的卷发百褶裙女孩，从图2的片场中走出，走到了图3的片场中，与图3中的主创们合影</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5aae876e780a40da95de68051d8dcacb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=xYYy2ylWeLnsa3ujDRWBkS%2BJPkw%3D" alt="图片" loading="lazy"/></p>
<p>可以一镜到底生成视频：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59245fae83724bb0b170fcaec409ee28~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=mKjSIXWPc%2FPExSSD71auSWBsZs0%3D" alt="图片" loading="lazy"/></p>
<p>但这里我发现如果过于多片段，在个别片段中会有瑕疵，也可以直接编辑。</p>
<p>除了智能多帧，还可以用即梦的首尾帧模式。首尾帧模式还可以直接使用最新的视频 3.5 Pro 模型，智能多帧 2.0 目前还无法使用视频 3.5 Pro ，且帧与帧之间可以生成8秒的视频，首尾帧模式模式下最多可生成 12 s 的视频。</p>
<p>点击视频生成、选择首尾帧，然后在视频模型那里选择视频 3.5 Pro。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d78e58173e6146119112f4e7dfbf12a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=5I3E1qTW9QV08P%2FzjpUhQeV0wiM%3D" alt="图片" loading="lazy"/></p>
<p>即梦最新的视频3.5Pro模型支持音画同出，而且时长可以选择5s、10s，最长支持12s。</p>
<p>这里可以输入如下提示词：</p>
<pre><code class="hljs">提示词：图1中的卷发百褶裙女孩，走出图1 的片场，走到图2的片场中转过身来，
与片场主创合影，要求有脚步声，有片场嘈杂的工作声音，前3秒女孩只走路，后7秒女孩边走边与图2主创互动说：“三位老师辛苦啦”。
要求人物走路时自然灵动，眼神到位。
</code></pre>
<p>提示词大差不差，大家自己微调即可。</p>
<p>这里放一个首尾帧生成的片段，视频中声音也是由视频 3.5 Pro 直出的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf6b4162faf5450a87469cade750e67a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092639&amp;x-signature=OnMAmw3IJlOQL3GrjDLJOT8vB0U%3D" alt="wxv_4300881757102358532" loading="lazy"/></p>
<p>怎么样，是不是非常简单，大家快点实践起来吧。</p>
<p>接下来，我准备把这些视频发布到短视频平台，看看数据，到时再来和大家汇报。</p>
<p>当昔日耳熟能详的歌声响起，那些熟悉的街道、庭院和江湖并没有消失。</p>
<p>它们只是换了一种方式，活在我们的记忆里，也活在每一个被 AI 唤醒的想象中。</p>
<p>原来我们怀念的从来不只是某部剧，<strong>而是那个搬着小板凳守在电视机前，相信所有故事都会有好结局的自己</strong></p>
<p>这一刻 AI 最动人的时刻，或许就是让我们与曾经的自己重逢。</p>
<p>在这个片场里，每个人都可以是造梦者，随时开机。</p>
<p>随时回到那个相信光的世界。</p>
<p>回到开头提到的工具，这次即梦AI网页版的升级，真的有点东西。它把“灵感—画面—视频—长镜头”这一整套创作全流程都打通了，完全就是给了我们一个随身携带的一站式“AI片场”。</p>
<p>首发接入的 Seedance 1.5 pro表现也很不错，除了音画同出，还可以说方言，人物表情等也能达到影视级的呈现。企业用户12月18日起可前往火山方舟体验中心体验。</p>
<p>不管你是想做那种让人一眼惊艳的创意海报，还是想做剧情复杂的AI漫剧、AI短片，它现在的能力都能接得住，而且门槛低到离谱。</p>
<p>以后再有啥天马行空的脑洞，真不用担心技术不行了，打开网页随时都能开机创作。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[观测云在企业应用性能故障分析场景中的最佳实践]]></title>    <link>https://juejin.cn/post/7586855770504675362</link>    <guid>https://juejin.cn/post/7586855770504675362</guid>    <pubDate>2025-12-23T11:12:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586855770504675362" data-draft-id="7586973107321585704" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="观测云在企业应用性能故障分析场景中的最佳实践"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-23T11:12:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="可观测性用观测云"/> <meta itemprop="url" content="https://juejin.cn/user/2392958212523102"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            观测云在企业应用性能故障分析场景中的最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392958212523102/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    可观测性用观测云
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T11:12:25.000Z" title="Tue Dec 23 2025 11:12:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>某企业经常遇到应用性能问题，对于应用性能的监测缺少基本的手段，这无疑对故障的排查增加了难度，而且对于产品大促期间，这无疑会影响用户的体验以及最终的交易，本文主要通过介绍某出海企业用户在使用观测云应用性能监测分析时的故障场景分析实践。</p>
<h2 data-id="heading-1">应用性能监测</h2>
<p>观测云拥有应用性能监测的能力，支持各种主流语言的技术栈，并兼容 OpenTelemetry，Skywalking，Jaeger，DDTrace 等等开源的 Agent，最佳部署方案是将 DataKit 部署在每一台应用服务器中，通过服务所在主机的 DataKit 后将数据打到观测云中心，能更好地对应用服务的服务器主机指标、应用日志、系统日志、应用服务链路数据等统一汇聚，进行各项数据的关联分析，而观测云应用性能监测主要功能包含服务，概览，链路，错误追踪，Profiling，应用性能指标检测等功能，本文主要基于观测云的应用监测能力，对用户故障场景进行分析实践。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67e933182523400184c88c247e696322~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=Ws%2FyDwidhStiwAWac9m2SiyHte4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">应用性能故障场景分析</h2>
<p>故障概述：用户反馈在 17:00 前后发生应用性能访问的故障，页面卡顿，数据加载不出，基于此进行了以下场景的分析。</p>
<h3 data-id="heading-3">某服务故障场景分析实践-Read time out</h3>
<ul>
<li>如图，通过观测云查看到，请求量增加，从 1 万 3 的请求量级增加到，20 万左右量级，并出现大量报错，请求超时，建议平时做好压测</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/731ff73df8a24c12be1dcfdd2464a6b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=wWKVj%2FSEhSMzkRmp%2FZHYkhqwjl8%3D" alt="" loading="lazy"/></p>
<ul>
<li>查看报错聚类分析，服务报错在该段时间，Read time out 报错最多</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6e10a7cfe634eaeb6fd03d2cb25a0ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=S4fQKM7A0nKE6jljOLGgVTzWZ7E%3D" alt="" loading="lazy"/></p>
<ul>
<li>分析 timeout 详细，超时底层栈在 SocketInputStream.socketRead，该底层方法即发起请求后在读数据的返回</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c64674f67d7448e5849a361261406122~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=qh36Ybu0oA7jjaXf%2BtNWNCQDQ6w%3D" alt="" loading="lazy"/></p>
<ul>
<li>查看链路的瀑布图，有 1 分钟超时报错，建议检查超时设置</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d31b0fe2a0f44238bfaf709619e35da3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=V%2FoFi7tFmW6gvimM8Yjzp1J1od4%3D" alt="" loading="lazy"/></p>
<ul>
<li>查看链路调用超时的拓扑图，有调 MySQL 数据库，在应用侧超时报错</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/629684b72bc848688cccb1eaee351a0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=BydhavSr187rpqEGfQmXBKb7hG4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">MySQL 故障场景分析实践-JDBC连接通信异常</h3>
<ul>
<li>对 MySQL 请求量分析，发现在 17:00 左右，MySQL 请求量级也增加至少不低于 10 倍，并出现了大量报错</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e245e410d5534f5cb15033c801736bab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=qLqfd0U%2BTwh797wHrcj%2F5Ck8OHc%3D" alt="" loading="lazy"/></p>
<ul>
<li>报错如下，主要是数据包发送接收超时，通信失败以及服务 shutdown 的情况</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a9ef549a4e6435b95c46d64651d618f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=ox5RI32BpQbr4GK7ORbRDV2ENMk%3D" alt="" loading="lazy"/></p>
<ul>
<li>以上时间段可能有 MySQL 重启，筛选 17:00 左右数据，没有 server shutdown 的报错，但依然是通信超时异常</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dce4def37cad4204ad9dd94f8c372218~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=F4C8VZ4PyBdGsZTrJdwbthAzxQo%3D" alt="" loading="lazy"/></p>
<ul>
<li>报错详细堆栈显示 Druid 数据库连接产生的 jdbc 异常，建议用户检查数据库连接池连接与配置情况</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04180bfc5e074682b6ada431e4f56f07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=QYoE%2F3y%2FJXD4a6AsFCKhKqnw4yk%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">MySQL 故障场景分析实践-MySQL 请求调用分析</h3>
<ul>
<li>分析 MySQL 的请求与调用，很多服务都会调用 MySQL，每秒 5 万多请求调用</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e447affb33a24199a1275fda8a7b28db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=YfQEhekCJK70a%2FNszgqnD4By2M4%3D" alt="" loading="lazy"/></p>
<ul>
<li>其中调用 MySQL 调用最多的为该服务，每秒 4 万多请求</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f0faf7029264f6fb744658cce4cf798~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=MT0bXF5u0Om1tvYm1BCsszYEOxc%3D" alt="" loading="lazy"/></p>
<ul>
<li>其次调用 MySQL 调用最多的为 xxxxx-product-server 服务，每秒 9 千多请求</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63fb8b2b2c7d42898726ac144aad3a24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=NzNe%2F9EtthEmSA2MQ7J2vgTjrz0%3D" alt="" loading="lazy"/></p>
<ul>
<li>对 MySQL 调用最多的服务分析上下游调用情况，发现很多服务都会通过该配置服务调用 MySQL，建议考虑是否可以增加 MySQL 缓存优化</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0347a17cd8094893865abc35891ec3a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=wjutaJgidaw7QENv1fW%2FuLW8YjE%3D" alt="" loading="lazy"/></p>
<ul>
<li>而且服务之间很多相互调用，服务之间也会直接或者间接的调用调数据库，只要有一个服务有问题，就可能引起连锁性能问题</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82f52074fffe4327a9de398924853689~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=gbfqGX6Xh1OKQxrhXteHDri%2FzJc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">调用数据库较多的配置服务-量能分析实践</h3>
<ul>
<li>分析配置服务请求，发现请求量从 5 万级别到 50 万级别</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eea56f5d415c48d7923022c2804a995b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=ErRVBGXFwzNSigHp2bS%2BmcsFUFw%3D" alt="" loading="lazy"/></p>
<ul>
<li>大量请求错误，并呈现几分钟的严重超时</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc39f984622f400694b12f18e26d2be1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=bCOIDlKALRUfDR%2FaXQSNhnJsgWU%3D" alt="" loading="lazy"/></p>
<ul>
<li>超时也是从 17:00 左右发生，等待数据返回</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25fbcf25cc0a46af8bd298ebcdad4854~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093145&amp;x-signature=JGg3NLLgQ44yuxYlrhkQpsA8uhY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">观测云应用性能分析总结</h2>
<p>综上场景分析实践，基于观测云的应用性能监测分析得出结论与建议：</p>
<ul>
<li>MySQL 数据库连接问题导致本次故障，建议检查数据库连接配置，确认为连接池数不够用，连接超时，可以基于观测云增加基于连接池指标的监控</li>
<li>业务请求并发量较高，导致 MySQL 数据库请求连接数量过高</li>
<li>对调用 MySQL 较多的 xxxxx-config-server 服务，后续可以考虑采用 redis 缓存方式，减少对 MySQL 的调用</li>
<li>当有高并发活动大促时，为避免高并发导致一系列的故障采用秒级可以拉起的高性能数据库厂商</li>
<li>对于高并发的场景，提前做好性能压测，确保对应的资源能满足对应活动的并发量请求</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀开源编程新王诞生，对标Claude Sonnet 4.5？实测GLM-4.7：Coding和Agentic能力直逼Gemini 3和Claude 4.5]]></title>    <link>https://juejin.cn/post/7586865729703084070</link>    <guid>https://juejin.cn/post/7586865729703084070</guid>    <pubDate>2025-12-23T11:15:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586865729703084070" data-draft-id="7586902693857984554" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀开源编程新王诞生，对标Claude Sonnet 4.5？实测GLM-4.7：Coding和Agentic能力直逼Gemini 3和Claude 4.5"/> <meta itemprop="keywords" content="ChatGLM (智谱),AIGC,AI编程"/> <meta itemprop="datePublished" content="2025-12-23T11:15:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="win4r"/> <meta itemprop="url" content="https://juejin.cn/user/1739869037541555"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀开源编程新王诞生，对标Claude Sonnet 4.5？实测GLM-4.7：Coding和Agentic能力直逼Gemini 3和Claude 4.5
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1739869037541555/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    win4r
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T11:15:25.000Z" title="Tue Dec 23 2025 11:15:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>昨天凌晨，智谱AI悄悄放了个大招——发布了最新的开源大模型GLM-4.7。</p>
<p>🔥🔥🔥本篇笔记所对应的视频：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1UTBKBxESA%2F" target="_blank" title="https://www.bilibili.com/video/BV1UTBKBxESA/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1UT…</a></p>
<p>说"悄悄"是因为这年头新模型实在太多，大家早就审美疲劳了。但这款模型有点不一样，358B参数的MoE架构，关键是MIT开源协议——这意味着你拿去商用都没问题。</p>
<p>光看参数和协议没意思，模型好不好用，还得实测才知道。我花了几个小时把这款模型从简单到复杂折腾了一遍，下面跟大家聊聊真实的使用感受。</p>
<h2 data-id="heading-0">先说说官方给的成绩单</h2>
<p>在看实测之前，简单过一下官方公布的基准测试数据。</p>
<p>数学竞赛这一项，GLM-4.7拿了95.7分，直接超过了GPT-5.1。代码能力方面，超过了DeepSeek 3.2和Claude Sonnet 4.5。科学推理、复杂推理这几个维度，基本都是同样的结果——比DeepSeek 3.2强，跟Claude Sonnet 4.5打得有来有回，部分指标还有明显优势。</p>
<p>当然，基准测试这东西，大家心里都清楚，参考价值有限。真正好不好用，还是得拉出来遛遛。</p>
<h2 data-id="heading-1">第一轮：前端能力试水</h2>
<h3 data-id="heading-2">一句话生成太阳系动画</h3>
<p>先从简单的开始。我在官方网页版输入了一句话："用SVG生成模拟太阳系的动画"。</p>
<p>结果确实让我有点意外。它不仅画出了八大行星围绕太阳公转的动画，而且动画相当流畅。放大之后能看到行星的运行轨迹，月球绕着地球转，土星还带着光环。</p>
<p>就这么简单的一句提示词，能出这个效果，前端基础能力是过关的。</p>
<h3 data-id="heading-3">冒泡排序可视化</h3>
<p>接下来加点难度。我让它创建一个冒泡算法的动画演示，要求画面里有12颗大小不同的小行星，还有一艘指挥舰来执行排序操作。</p>
<p>这个任务其实挺考验综合能力的——算法理解、前端实现、动画设计、交互逻辑，缺一不可。</p>
<p>最终效果：点击开始后，指挥舰会在小行星上方移动，发现左侧的小行星比右侧大，就执行交换。整个过程有状态提示，显示"正在比较"或"正在交换"，运行全程没有报错。</p>
<p>到这里，基本的前端+算法能力算是验证通过了。</p>
<h3 data-id="heading-4">3D恐龙狩猎游戏</h3>
<p>然后是真正的硬菜——让它从零开发一个3D风格的恐龙狩猎游戏。</p>
<p>要求挺复杂的：玩家操控一辆装有机枪的皮卡车，用鼠标瞄准射击恐龙，键盘控制车辆移动。场景要有侏罗纪风格，原始森林、高大植物、岩石、河流、火山，还要有雾气效果。</p>
<p>坦白讲，发出这个提示词的时候，我没抱太大期望。这种需求涉及3D图形渲染、物理碰撞检测、AI行为系统、多模态交互，一般的模型做出来要么跑不起来，要么就是一堆报错。</p>
<p>结果出乎意料——游戏真的能玩。皮卡车可以用键盘控制移动，鼠标瞄准射击。远处会刷新恐龙，小型恐龙两三枪就倒，大型恐龙要多打几枪。开枪后恐龙还会逃跑，打死后尸体会消失。远处能看到山脉和雾气效果，游戏结束后会显示得分。</p>
<p>能一次跑通这么复杂的游戏项目，说明它对大规模代码组织和系统性工程实现的能力确实不弱。</p>
<h3 data-id="heading-5">数学推导动画</h3>
<p>接着测试了数学能力。让它创建一个演示圆面积公式推导过程的交互动画。</p>
<p>这个任务的难点在于把抽象的数学概念变成直观的视觉呈现。需要理解极限思想，还要把圆切割、重排成近似长方形的过程用动画展示出来。</p>
<p>最终效果很不错。可以设置切割数量，比如切成64份，然后看着这64个扇形被分开、重组成一个近似的长方形，高是半径r，底边是πr。下面还有文字解释切割原理、重排原理、极限思想，公式推导一目了然。</p>
<p>这种把复杂概念可视化的能力，在教育场景下应该挺有价值的。</p>
<h3 data-id="heading-6">PPT自动生成</h3>
<p>最后试了一下让它根据网页内容自动生成PPT。给了一个GLM-4.7的官方介绍链接，让它直接做成演示文稿。</p>
<p>生成的PPT有模型介绍、核心特性、基准测试数据、三大思考模式、使用方法、产品优势等内容，还自动配了代码截图和数据图表。</p>
<p>作为一键生成的初稿，效果算是及格线以上，拿来稍作修改就能用。</p>
<h2 data-id="heading-7">第二轮：Claude Code接入测试</h2>
<p>前端能力测完了，接下来试试在Claude Code中调用这款模型，测试它的工具调用能力和复杂编程能力。</p>
<h3 data-id="heading-8">配置方法</h3>
<p>接入方式很简单，三条命令搞定：设置Base URL、API Key、模型ID。海外用户可以通过z.ai平台获取API，国内用户用BigModel平台。</p>
<p>启动Claude Code后，模型ID显示为GLM-4.7，说明接入成功。</p>
<h3 data-id="heading-9">浏览器自动化测试</h3>
<p>这部分使用了谷歌官方的Chrome DevTools MCP来测试浏览器自动化能力。</p>
<p>任务是：访问我的博客，点击进入前三篇文章，提取内容，然后改写成适合发X（原Twitter）的短文案。</p>
<p>整个过程看着它自动打开浏览器，点击第一篇博客、返回首页、点击第二篇、返回、点击第三篇，然后提取内容进行改写。最终输出了三篇带emoji表情和标签的X Post，运行速度也挺快。</p>
<p>工具调用能力没问题。</p>
<h3 data-id="heading-10">终极测试：iOS原生APP开发</h3>
<p>压轴的是一个难度拉满的任务——开发一款iOS原生背单词APP。</p>
<p>要求支持iOS 17+、Swift 5.9、SwiftUI、SwiftData、Swift Charts等技术栈。功能包括：首页展示学习进度、单词卡片支持正反面3D翻转动画、练习测试模块、学习进度统计图表、设置模块等。</p>
<p>先用Xcode初始化一个空项目，然后在Claude Code中执行init命令生成CLAUDE.md文件，让它理解项目结构。接着进入计划模式，粘贴完整需求，让它制定开发计划并执行。</p>
<p>等了大概十多分钟，它完成了开发。然后我又让它把显示语言改成中文。</p>
<p>在Xcode中运行，编译成功。测试结果：可以滑动卡片切换单词，点击翻转查看中文释义，点击"已掌握"后自动切换下一个单词，有每日目标显示，练习和进度模块也能正常使用。</p>
<p>唯一没实现的是设置功能，不过让它继续补充应该问题不大。</p>
<p>能在十几分钟内完成一个功能相对完整的iOS原生应用，这个复杂编程能力确实有点东西。</p>
<h2 data-id="heading-11">几个值得关注的特性</h2>
<p>除了实测体验，GLM-4.7还有几个设计上的亮点值得一提：</p>
<p>三种思考模式。Interleaved Thinking是在每次响应和工具调用前先思考；Preserved Thinking是在多轮对话中保留之前的思考过程，不用每次从头推导；Turn-level Thinking是支持按轮次控制是否启用思考，简单问题关掉思考降低延迟，复杂任务打开提高准确性。</p>
<p>这种设计对长链路、多步骤的Agent任务应该挺有帮助，能减少信息丢失和前后不一致的问题。</p>
<p>上下文和输出限制。200K的上下文窗口，128K的最大输出长度，做复杂项目的时候不太容易撑爆。</p>
<p>开源友好。权重在HuggingFace和ModelScope都能下载，支持vLLM和SGLang本地部署，MIT协议商用无压力。</p>
<h2 data-id="heading-12">总结</h2>
<p>折腾了一圈下来，说说我的真实感受：</p>
<p>GLM-4.7的前端能力确实不错，从简单的SVG动画到复杂的3D游戏都能一次跑通，代码组织能力和工程实现能力在开源模型里算是第一梯队。工具调用稳定，iOS原生开发也能应付，综合编程能力比上一代有明显提升。</p>
<p>当然，基准测试里那些"超越GPT-5.1"、"领先Claude Sonnet 4.5"的说法，还是要打个问号。毕竟基准测试和实际使用场景差异很大，而且不同任务表现可能差别也不小。</p>
<p>但不管怎么说，作为一款MIT协议的开源模型，能做到这个水平，对开发者来说是个好消息。毕竟有竞争才有进步，开源生态越卷，大家的选择就越多。</p>
<p>想试试的可以去z.ai（海外）或BigModel平台（国内）体验网页版，也可以在Claude Code里通过API调用。本地部署的话，HuggingFace上有权重可以下载。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 布局组件选择指南]]></title>    <link>https://juejin.cn/post/7586855770504740898</link>    <guid>https://juejin.cn/post/7586855770504740898</guid>    <pubDate>2025-12-23T11:22:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586855770504740898" data-draft-id="7586855770504724514" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 布局组件选择指南"/> <meta itemprop="keywords" content="Flutter"/> <meta itemprop="datePublished" content="2025-12-23T11:22:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="麦客奥德彪"/> <meta itemprop="url" content="https://juejin.cn/user/2365804752418232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 布局组件选择指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2365804752418232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    麦客奥德彪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T11:22:26.000Z" title="Tue Dec 23 2025 11:22:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">快速决策流程图</h2>
<pre><code class="hljs language-scss" lang="scss">需要布局？
├─ 只有一个子组件？
│  ├─ 需要居中？ → Center
│  ├─ 需要边距？ → <span class="hljs-attribute">Padding</span>
│  ├─ 需要背景/边框/圆角？ → Container
│  ├─ 需要固定大小？ → SizedBox
│  ├─ 需要特定对齐？ → Align
│  └─ 需要保持宽高比？ → AspectRatio
│
└─ 有多个子组件？
   ├─ 横向排列？ → Row
   ├─ 纵向排列？ → Column
   ├─ 重叠显示？ → Stack
   ├─ 自动换行？ → Wrap
   ├─ 网格显示？ → GridView
   ├─ 列表显示？ → ListView
   └─ 内容超出屏幕？ → SingleChildScrollView
</code></pre>
<h2 data-id="heading-1">场景化选择指南</h2>
<h3 data-id="heading-2">1. 基础样式场景</h3>
<h4 data-id="heading-3">需要设置背景色、圆角、阴影、边框</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 使用 Container</span>
<span class="hljs-selector-tag">Container</span>(
  <span class="hljs-attribute">decoration</span>: <span class="hljs-built_in">BoxDecoration</span>(
    <span class="hljs-attribute">color</span>: Colors.blue,
    <span class="hljs-attribute">borderRadius</span>: BorderRadius.<span class="hljs-built_in">circular</span>(<span class="hljs-number">12</span>),
    <span class="hljs-attribute">boxShadow</span>: [<span class="hljs-built_in">BoxShadow</span>(<span class="hljs-attribute">color</span>: Colors.grey, <span class="hljs-attribute">blurRadius</span>: <span class="hljs-number">4</span>)],
  ),
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'内容'</span>),
)
</code></pre>
<h4 data-id="heading-4">只需要边距</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 使用 Padding（更轻量）</span>
<span class="hljs-selector-tag">Padding</span>(
  <span class="hljs-attribute">padding</span>: EdgeInsets.<span class="hljs-built_in">all</span>(<span class="hljs-number">16</span>),
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'内容'</span>),
)

<span class="hljs-comment">// ❌ 避免用 Container（过重）</span>
<span class="hljs-selector-tag">Container</span>(
  <span class="hljs-attribute">padding</span>: EdgeInsets.<span class="hljs-built_in">all</span>(<span class="hljs-number">16</span>),
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'内容'</span>),
)
</code></pre>
<h4 data-id="heading-5">需要固定间距</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 使用 SizedBox</span>
<span class="hljs-selector-tag">Column</span>(
  <span class="hljs-attribute">children</span>: [
    <span class="hljs-built_in">Text</span>(<span class="hljs-string">'第一行'</span>),
    <span class="hljs-built_in">SizedBox</span>(<span class="hljs-attribute">height</span>: <span class="hljs-number">16</span>),  <span class="hljs-comment">// 间距</span>
    <span class="hljs-built_in">Text</span>(<span class="hljs-string">'第二行'</span>),
  ],
)
</code></pre>
<h3 data-id="heading-6">2. 排列布局场景</h3>
<h4 data-id="heading-7">横向排列（如工具栏、按钮组）</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 使用 Row</span>
<span class="hljs-selector-tag">Row</span>(
  <span class="hljs-attribute">mainAxisAlignment</span>: MainAxisAlignment.spaceBetween,
  <span class="hljs-attribute">children</span>: [
    <span class="hljs-built_in">Icon</span>(Icons.menu),
    <span class="hljs-built_in">Text</span>(<span class="hljs-string">'标题'</span>),
    <span class="hljs-built_in">Icon</span>(Icons.search),
  ],
)
</code></pre>
<h4 data-id="heading-8">纵向排列（如表单、卡片内容）</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 使用 Column</span>
<span class="hljs-selector-tag">Column</span>(
  <span class="hljs-attribute">crossAxisAlignment</span>: CrossAxisAlignment.start,
  <span class="hljs-attribute">children</span>: [
    <span class="hljs-built_in">Text</span>(<span class="hljs-string">'姓名'</span>),
    <span class="hljs-built_in">TextField</span>(),
    <span class="hljs-built_in">SizedBox</span>(<span class="hljs-attribute">height</span>: <span class="hljs-number">16</span>),
    <span class="hljs-built_in">Text</span>(<span class="hljs-string">'邮箱'</span>),
    <span class="hljs-built_in">TextField</span>(),
  ],
)
</code></pre>
<h4 data-id="heading-9">子组件需要自适应分配空间</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 使用 Expanded 或 Flexible</span>
<span class="hljs-selector-tag">Row</span>(
  <span class="hljs-attribute">children</span>: [
    <span class="hljs-built_in">Icon</span>(Icons.star),
    <span class="hljs-built_in">Expanded</span>(  <span class="hljs-comment">// 占据剩余空间</span>
      <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'这是一段很长的文本...'</span>),
    ),
    <span class="hljs-built_in">Icon</span>(Icons.more_vert),
  ],
)
</code></pre>
<h3 data-id="heading-10">3. 特殊排列场景</h3>
<h4 data-id="heading-11">标签云、流式布局（自动换行）</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 使用 Wrap</span>
<span class="hljs-selector-tag">Wrap</span>(
  <span class="hljs-attribute">spacing</span>: <span class="hljs-number">8</span>,
  <span class="hljs-attribute">runSpacing</span>: <span class="hljs-number">8</span>,
  <span class="hljs-attribute">children</span>: [
    <span class="hljs-built_in">Chip</span>(<span class="hljs-attribute">label</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'Flutter'</span>)),
    <span class="hljs-built_in">Chip</span>(<span class="hljs-attribute">label</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'Dart'</span>)),
    <span class="hljs-built_in">Chip</span>(<span class="hljs-attribute">label</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'Mobile'</span>)),
    <span class="hljs-comment">// 自动换行</span>
  ],
)
</code></pre>
<h4 data-id="heading-12">图片上叠加按钮、角标</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 使用 Stack + Positioned</span>
<span class="hljs-selector-tag">Stack</span>(
  <span class="hljs-attribute">children</span>: [
    Image.<span class="hljs-built_in">network</span>(<span class="hljs-string">'url'</span>),
    <span class="hljs-built_in">Positioned</span>(
      <span class="hljs-attribute">top</span>: <span class="hljs-number">8</span>,
      <span class="hljs-attribute">right</span>: <span class="hljs-number">8</span>,
      <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Icon</span>(Icons.favorite, <span class="hljs-attribute">color</span>: Colors.red),
    ),
  ],
)
</code></pre>
<h3 data-id="heading-13">4. 列表场景</h3>
<h4 data-id="heading-14">少量固定项目（&lt;20项）</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 使用 Column（简单直接）</span>
<span class="hljs-selector-tag">Column</span>(
  <span class="hljs-attribute">children</span>: [
    <span class="hljs-built_in">ListTile</span>(<span class="hljs-attribute">title</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'项目1'</span>)),
    <span class="hljs-built_in">ListTile</span>(<span class="hljs-attribute">title</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'项目2'</span>)),
    <span class="hljs-built_in">ListTile</span>(<span class="hljs-attribute">title</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'项目3'</span>)),
  ],
)
</code></pre>
<h4 data-id="heading-15">大量动态数据</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 使用 ListView.builder（性能优化）</span>
<span class="hljs-selector-tag">ListView</span><span class="hljs-selector-class">.builder</span>(
  <span class="hljs-attribute">itemCount</span>: <span class="hljs-number">1000</span>,
  <span class="hljs-attribute">itemBuilder</span>: (context, index) {
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ListTile</span>(<span class="hljs-attribute">title</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'项目 $index'</span>));
  },
)
</code></pre>
<h4 data-id="heading-16">横向滚动列表</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 使用 ListView + scrollDirection</span>
<span class="hljs-selector-tag">ListView</span><span class="hljs-selector-class">.builder</span>(
  <span class="hljs-attribute">scrollDirection</span>: Axis.horizontal,
  <span class="hljs-attribute">itemCount</span>: <span class="hljs-number">10</span>,
  <span class="hljs-attribute">itemBuilder</span>: (context, index) {
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Container</span>(
      <span class="hljs-attribute">width</span>: <span class="hljs-number">150</span>,
      <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Card</span>(<span class="hljs-attribute">child</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'卡片 $index'</span>)),
    );
  },
)
</code></pre>
<h4 data-id="heading-17">网格布局</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 固定列数用 GridView.count</span>
<span class="hljs-selector-tag">GridView</span><span class="hljs-selector-class">.count</span>(
  <span class="hljs-attribute">crossAxisCount</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attribute">children</span>: List.<span class="hljs-built_in">generate</span>(<span class="hljs-number">20</span>, (index) =&gt; <span class="hljs-built_in">Card</span>()),
)

<span class="hljs-comment">// ✅ 固定宽度用 GridView.extent</span>
<span class="hljs-selector-tag">GridView</span><span class="hljs-selector-class">.extent</span>(
  <span class="hljs-attribute">maxCrossAxisExtent</span>: <span class="hljs-number">150</span>,  <span class="hljs-comment">// 每项最大宽度</span>
  <span class="hljs-attribute">children</span>: List.<span class="hljs-built_in">generate</span>(<span class="hljs-number">20</span>, (index) =&gt; <span class="hljs-built_in">Card</span>()),
)
</code></pre>
<h3 data-id="heading-18">5. 滚动场景</h3>
<h4 data-id="heading-19">单个组件需要滚动</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 使用 SingleChildScrollView</span>
<span class="hljs-selector-tag">SingleChildScrollView</span>(
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Column</span>(
    <span class="hljs-attribute">children</span>: [
      <span class="hljs-comment">// 很多内容</span>
    ],
  ),
)
</code></pre>
<h4 data-id="heading-20">列表需要滚动</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// ✅ ListView 自带滚动</span>
<span class="hljs-built_in">ListView</span>(children: [...])

<span class="hljs-comment">// ❌ 不需要额外包裹 SingleChildScrollView</span>
</code></pre>
<h4 data-id="heading-21">避免嵌套滚动冲突</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ ListView 内使用 shrinkWrap</span>
<span class="hljs-selector-tag">Column</span>(
  <span class="hljs-attribute">children</span>: [
    <span class="hljs-built_in">Text</span>(<span class="hljs-string">'标题'</span>),
    ListView.<span class="hljs-built_in">builder</span>(
      <span class="hljs-attribute">shrinkWrap</span>: true,  <span class="hljs-comment">// 重要！</span>
      <span class="hljs-attribute">physics</span>: <span class="hljs-built_in">NeverScrollableScrollPhysics</span>(),  <span class="hljs-comment">// 禁用内部滚动</span>
      <span class="hljs-attribute">itemCount</span>: <span class="hljs-number">10</span>,
      <span class="hljs-attribute">itemBuilder</span>: (context, index) =&gt; <span class="hljs-built_in">ListTile</span>(),
    ),
  ],
)
</code></pre>
<h3 data-id="heading-22">6. 对齐场景</h3>
<h4 data-id="heading-23">单个组件居中</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 使用 Center（最简单）</span>
<span class="hljs-selector-tag">Center</span>(<span class="hljs-attribute">child</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'居中文本'</span>))

<span class="hljs-comment">// ✅ 或使用 Align（更灵活）</span>
<span class="hljs-selector-tag">Align</span>(
  <span class="hljs-attribute">alignment</span>: Alignment.center,
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'居中文本'</span>),
)
</code></pre>
<h4 data-id="heading-24">多个组件整体居中</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 使用 Center 包裹 Column/Row</span>
<span class="hljs-selector-tag">Center</span>(
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Column</span>(
    <span class="hljs-attribute">mainAxisSize</span>: MainAxisSize.min,  <span class="hljs-comment">// 重要！</span>
    <span class="hljs-attribute">children</span>: [
      <span class="hljs-built_in">Text</span>(<span class="hljs-string">'标题'</span>),
      <span class="hljs-built_in">Text</span>(<span class="hljs-string">'副标题'</span>),
    ],
  ),
)
</code></pre>
<h4 data-id="heading-25">Row/Column 内部对齐</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 使用对齐属性</span>
<span class="hljs-selector-tag">Column</span>(
  <span class="hljs-attribute">mainAxisAlignment</span>: MainAxisAlignment.center,  <span class="hljs-comment">// 主轴居中</span>
  <span class="hljs-attribute">crossAxisAlignment</span>: CrossAxisAlignment.start,  <span class="hljs-comment">// 交叉轴起始</span>
  <span class="hljs-attribute">children</span>: [...],
)
</code></pre>
<h3 data-id="heading-26">7. 响应式场景</h3>
<h4 data-id="heading-27">根据屏幕宽度调整布局</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// ✅ 使用 LayoutBuilder</span>
<span class="hljs-built_in">LayoutBuilder</span>(
  builder: (context, constraints) {
    if (constraints.maxWidth &gt; <span class="hljs-number">600</span>) {
      return <span class="hljs-built_in">Row</span>(children: [侧边栏, 内容]);  <span class="hljs-comment">// 平板/桌面</span>
    } else {
      return <span class="hljs-built_in">Column</span>(children: [内容]);  <span class="hljs-comment">// 手机</span>
    }
  },
)
</code></pre>
<h4 data-id="heading-28">适配安全区域（刘海屏、底部栏）</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 使用 SafeArea</span>
<span class="hljs-selector-tag">SafeArea</span>(
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Column</span>(<span class="hljs-attribute">children</span>: [...]),
)
</code></pre>
<h2 data-id="heading-29">常见错误与优化</h2>
<h3 data-id="heading-30">❌ 错误示例 1：过度使用 Container</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ❌ 只需要边距，却用 Container</span>
<span class="hljs-selector-tag">Container</span>(
  <span class="hljs-attribute">padding</span>: EdgeInsets.<span class="hljs-built_in">all</span>(<span class="hljs-number">16</span>),
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'内容'</span>),
)

<span class="hljs-comment">// ✅ 应该用 Padding</span>
<span class="hljs-selector-tag">Padding</span>(
  <span class="hljs-attribute">padding</span>: EdgeInsets.<span class="hljs-built_in">all</span>(<span class="hljs-number">16</span>),
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'内容'</span>),
)
</code></pre>
<h3 data-id="heading-31">❌ 错误示例 2：不必要的嵌套</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ❌ 多层无意义嵌套</span>
<span class="hljs-selector-tag">Container</span>(
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Center</span>(
    <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Container</span>(
      <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'内容'</span>),
    ),
  ),
)

<span class="hljs-comment">// ✅ 简化</span>
<span class="hljs-selector-tag">Center</span>(<span class="hljs-attribute">child</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'内容'</span>))
</code></pre>
<h3 data-id="heading-32">❌ 错误示例 3：Column 超出屏幕未处理</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ❌ 内容多时会溢出</span>
<span class="hljs-selector-tag">Column</span>(
  <span class="hljs-attribute">children</span>: [
    <span class="hljs-comment">// 很多内容</span>
  ],
)

<span class="hljs-comment">// ✅ 添加滚动</span>
<span class="hljs-selector-tag">SingleChildScrollView</span>(
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Column</span>(<span class="hljs-attribute">children</span>: [...]),
)
</code></pre>
<h3 data-id="heading-33">❌ 错误示例 4：ListView 内嵌套 ListView</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ❌ 会报错或性能差</span>
<span class="hljs-selector-tag">ListView</span>(
  <span class="hljs-attribute">children</span>: [
    <span class="hljs-built_in">ListView</span>(<span class="hljs-attribute">children</span>: [...]),  <span class="hljs-comment">// 错误！</span>
  ],
)

<span class="hljs-comment">// ✅ 使用 shrinkWrap</span>
<span class="hljs-selector-tag">ListView</span>(
  <span class="hljs-attribute">children</span>: [
    <span class="hljs-built_in">ListView</span>(
      <span class="hljs-attribute">shrinkWrap</span>: true,
      <span class="hljs-attribute">physics</span>: <span class="hljs-built_in">NeverScrollableScrollPhysics</span>(),
      <span class="hljs-attribute">children</span>: [...],
    ),
  ],
)
</code></pre>
<h2 data-id="heading-34">性能优化建议</h2>
<ol>
<li><strong>大列表必须用 .builder</strong>：超过 20 项就用 <code>ListView.builder</code> 或 <code>GridView.builder</code></li>
<li><strong>避免深层嵌套</strong>：超过 5 层考虑拆分成独立 Widget</li>
<li><strong>合理使用 const</strong>：静态 Widget 加 <code>const</code> 提升性能</li>
<li><strong>避免在 build 中创建大量对象</strong>：把样式定义提取到常量</li>
<li><strong>使用 <code>RepaintBoundary</code></strong>：隔离频繁重绘的组件</li>
</ol>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 性能优化示例</span>
<span class="hljs-selector-tag">const</span> <span class="hljs-selector-tag">EdgeInsets</span> <span class="hljs-selector-tag">_padding</span> = <span class="hljs-selector-tag">EdgeInsets</span><span class="hljs-selector-class">.all</span>(<span class="hljs-number">16</span>);  <span class="hljs-comment">// 复用常量</span>

<span class="hljs-selector-tag">ListView</span><span class="hljs-selector-class">.builder</span>(  <span class="hljs-comment">// 大列表用 builder</span>
  <span class="hljs-attribute">itemCount</span>: <span class="hljs-number">1000</span>,
  <span class="hljs-attribute">itemBuilder</span>: (context, index) {
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">RepaintBoundary</span>(  <span class="hljs-comment">// 隔离重绘</span>
      <span class="hljs-attribute">child</span>: const <span class="hljs-built_in">ListTile</span>(<span class="hljs-attribute">title</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'项目'</span>)),  <span class="hljs-comment">// 使用 const</span>
    );
  },
)
</code></pre>
<h2 data-id="heading-35">快速记忆口诀</h2>
<ul>
<li><strong>单个组件</strong>：居中 Center，边距 Padding，样式 Container</li>
<li><strong>横向排列</strong>：Row + Expanded</li>
<li><strong>纵向排列</strong>：Column + Expanded</li>
<li><strong>层叠覆盖</strong>：Stack + Positioned</li>
<li><strong>自动换行</strong>：Wrap 最方便</li>
<li><strong>列表滚动</strong>：ListView.builder 性能好</li>
<li><strong>网格展示</strong>：GridView.count 列数定</li>
<li><strong>内容太多</strong>：SingleChildScrollView 包一包</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 Guava ListenableFuture 学习生产级并发调用实践]]></title>    <link>https://juejin.cn/post/7586942589321183268</link>    <guid>https://juejin.cn/post/7586942589321183268</guid>    <pubDate>2025-12-23T11:26:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586942589321183268" data-draft-id="7586940555403952169" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 Guava ListenableFuture 学习生产级并发调用实践"/> <meta itemprop="keywords" content="后端,面试,架构"/> <meta itemprop="datePublished" content="2025-12-23T11:26:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 Guava ListenableFuture 学习生产级并发调用实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T11:26:18.000Z" title="Tue Dec 23 2025 11:26:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>之前从 Elasticsearch 源码学到了线程池配置的设计思想，但 ES 的代码太底层，难以直接迁移到业务系统。今天在 Guava 框架中找到了更实用的方案：相比 <code>CompletableFuture</code> 复杂的链式调用，<code>ListenableFuture</code> 提供了更清晰的并发编排模式。</p>
<hr/>
<h2 data-id="heading-1">一、为什么选择 Guava ListenableFuture</h2>
<h3 data-id="heading-2">CompletableFuture 的痛点</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// allOf 返回 Void，还要手动 join</span>
CompletableFuture.allOf(productFuture, inventoryFuture)
    .thenApply(v -&gt; {
        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> productFuture.join();  <span class="hljs-comment">// 还要再次 join</span>
        <span class="hljs-type">Inventory</span> <span class="hljs-variable">inventory</span> <span class="hljs-operator">=</span> inventoryFuture.join();
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductDetailDTO</span>(product, inventory);
    });
</code></pre>
<h3 data-id="heading-3">Guava 的优势</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 提交任务</span>
ListenableFuture&lt;Product&gt; productFuture = executor.submit(() -&gt; 
    productService.getProduct(id));
ListenableFuture&lt;Inventory&gt; inventoryFuture = executor.submit(() -&gt; 
    inventoryService.getInventory(id));

<span class="hljs-comment">// 等待全部成功后组装</span>
<span class="hljs-keyword">return</span> Futures.whenAllSucceed(productFuture, inventoryFuture)
    .call(() -&gt; {
        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> Futures.getDone(productFuture);
        <span class="hljs-type">Inventory</span> <span class="hljs-variable">inventory</span> <span class="hljs-operator">=</span> Futures.getDone(inventoryFuture);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductDetailDTO</span>(product, inventory);
    }, executor);
</code></pre>
<p>核心优势：</p>
<ul>
<li><strong>职责分离</strong>：提交和处理分开</li>
<li><strong>类型安全</strong>：<code>getDone()</code> 直接返回结果</li>
<li><strong>语义清晰</strong>：<code>whenAllSucceed</code> 明确表达意图</li>
</ul>
<hr/>
<h2 data-id="heading-4">二、业务场景：电商商品详情页</h2>
<p>用户访问商品详情页，需要并行查询商品服务和库存服务：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[GET /product/123] --&gt; B[ProductFacade]
    B --&gt; C[商品服务 80ms]
    B --&gt; D[库存服务 60ms]
    C --&gt; E[组装结果]
    D --&gt; E
    E --&gt; F[返回DTO]
</code></pre>
<ul>
<li>串行耗时：80ms + 60ms = 140ms</li>
<li>并行耗时：max(80ms, 60ms) ≈ 80ms</li>
</ul>
<hr/>
<h2 data-id="heading-5">三、完整代码实现</h2>
<h3 data-id="heading-6">数据模型</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 商品信息</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String id;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String name;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> priceInCents;
    
    Product(String id, String name, <span class="hljs-type">int</span> priceInCents) {
        <span class="hljs-built_in">this</span>.id = id;
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-built_in">this</span>.priceInCents = priceInCents;
    }
    
    String <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> id; }
    String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> name; }
    <span class="hljs-type">int</span> <span class="hljs-title function_">getPriceInCents</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> priceInCents; }
}

<span class="hljs-comment">// 库存信息</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Inventory</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String productId;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> quantity;
    
    Inventory(String productId, <span class="hljs-type">int</span> quantity) {
        <span class="hljs-built_in">this</span>.productId = productId;
        <span class="hljs-built_in">this</span>.quantity = quantity;
    }
    
    String <span class="hljs-title function_">getProductId</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> productId; }
    <span class="hljs-type">int</span> <span class="hljs-title function_">getQuantity</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> quantity; }
}

<span class="hljs-comment">// 返回的 DTO</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductDetailDTO</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String productId;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String name;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> priceInCents;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> quantity;
    
    ProductDetailDTO(String productId, String name, <span class="hljs-type">int</span> priceInCents, <span class="hljs-type">int</span> quantity) {
        <span class="hljs-built_in">this</span>.productId = productId;
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-built_in">this</span>.priceInCents = priceInCents;
        <span class="hljs-built_in">this</span>.quantity = quantity;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"ProductDetailDTO{"</span> +
                <span class="hljs-string">"productId='"</span> + productId + <span class="hljs-string">'\''</span> +
                <span class="hljs-string">", name='"</span> + name + <span class="hljs-string">'\''</span> +
                <span class="hljs-string">", priceInCents="</span> + priceInCents +
                <span class="hljs-string">", quantity="</span> + quantity +
                <span class="hljs-string">'}'</span>;
    }
}
</code></pre>
<h3 data-id="heading-7">模拟服务</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {
    Product <span class="hljs-title function_">getProduct</span><span class="hljs-params">(String productId)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        TimeUnit.MILLISECONDS.sleep(<span class="hljs-number">80</span>);  <span class="hljs-comment">// 模拟网络调用</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(productId, <span class="hljs-string">"MacBook Pro 14"</span>, <span class="hljs-number">149900</span>);
    }
}

<span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InventoryService</span> {
    Inventory <span class="hljs-title function_">getInventory</span><span class="hljs-params">(String productId)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        TimeUnit.MILLISECONDS.sleep(<span class="hljs-number">60</span>);  <span class="hljs-comment">// 模拟网络调用</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Inventory</span>(productId, <span class="hljs-number">42</span>);
    }
}
</code></pre>
<h3 data-id="heading-8">核心门面类</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductFacade</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ProductService productService;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> InventoryService inventoryService;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ListeningExecutorService executor;
    
    ProductFacade(ProductService productService,
                  InventoryService inventoryService,
                  ListeningExecutorService executor) {
        <span class="hljs-built_in">this</span>.productService = productService;
        <span class="hljs-built_in">this</span>.inventoryService = inventoryService;
        <span class="hljs-built_in">this</span>.executor = executor;
    }
    
    <span class="hljs-comment">/**
     * 并行获取商品信息和库存信息，然后组装成 ProductDetailDTO
     */</span>
    ListenableFuture&lt;ProductDetailDTO&gt; <span class="hljs-title function_">getProductDetail</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String productId)</span> {
        <span class="hljs-comment">// 步骤1：Fan-Out 并行查询</span>
        ListenableFuture&lt;Product&gt; productFuture = executor.submit(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Callable</span>&lt;Product&gt;() {
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
                    <span class="hljs-keyword">return</span> productService.getProduct(productId);
                }
            }
        );
        
        ListenableFuture&lt;Inventory&gt; inventoryFuture = executor.submit(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Callable</span>&lt;Inventory&gt;() {
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> Inventory <span class="hljs-title function_">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
                    <span class="hljs-keyword">return</span> inventoryService.getInventory(productId);
                }
            }
        );
        
        <span class="hljs-comment">// 步骤2：Fan-In 汇总结果</span>
        <span class="hljs-comment">// whenAllSucceed：只有两个 Future 都成功，才执行 call 里的逻辑</span>
        <span class="hljs-keyword">return</span> Futures.whenAllSucceed(productFuture, inventoryFuture)
            .call(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Callable</span>&lt;ProductDetailDTO&gt;() {
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> ProductDetailDTO <span class="hljs-title function_">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
                    <span class="hljs-comment">// getDone：安全获取已完成的 Future 结果</span>
                    <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> Futures.getDone(productFuture);
                    <span class="hljs-type">Inventory</span> <span class="hljs-variable">inventory</span> <span class="hljs-operator">=</span> Futures.getDone(inventoryFuture);
                    
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductDetailDTO</span>(
                        product.getId(),
                        product.getName(),
                        product.getPriceInCents(),
                        inventory.getQuantity()
                    );
                }
            }, executor);
    }
}
</code></pre>
<p>关键点：</p>
<ol>
<li><strong><code>executor.submit(Callable)</code></strong>：提交任务到线程池异步执行，立即返回 <code>ListenableFuture</code></li>
<li><strong><code>Futures.whenAllSucceed(f1, f2)</code></strong>：等待所有 Future 都成功完成，任何一个失败整体就失败</li>
<li><strong><code>Futures.getDone(future)</code></strong>：安全获取已完成的结果，因为 <code>whenAllSucceed</code> 保证了成功</li>
</ol>
<h3 data-id="heading-9">程序入口</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-comment">// 创建线程池</span>
    <span class="hljs-type">ListeningExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> MoreExecutors.listeningDecorator(
        Executors.newFixedThreadPool(<span class="hljs-number">4</span>)
    );
    
    <span class="hljs-comment">// 初始化服务</span>
    <span class="hljs-type">ProductService</span> <span class="hljs-variable">productService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductService</span>();
    <span class="hljs-type">InventoryService</span> <span class="hljs-variable">inventoryService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InventoryService</span>();
    <span class="hljs-type">ProductFacade</span> <span class="hljs-variable">facade</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductFacade</span>(
        productService, inventoryService, executor
    );
    
    <span class="hljs-type">String</span> <span class="hljs-variable">productId</span> <span class="hljs-operator">=</span> <span class="hljs-string">"P123"</span>;
    <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.nanoTime();
    
    <span class="hljs-comment">// 发起并行查询</span>
    ListenableFuture&lt;ProductDetailDTO&gt; future = facade.getProductDetail(productId);
    
    <span class="hljs-comment">// 阻塞等待结果（Demo 演示用，实际 Web 场景可以用回调异步处理）</span>
    <span class="hljs-type">ProductDetailDTO</span> <span class="hljs-variable">dto</span> <span class="hljs-operator">=</span> future.get();
    
    <span class="hljs-type">long</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> System.nanoTime();
    <span class="hljs-type">long</span> <span class="hljs-variable">costMillis</span> <span class="hljs-operator">=</span> (end - start) / <span class="hljs-number">1_000_000L</span>;
    
    System.out.println(<span class="hljs-string">"Result = "</span> + dto);
    System.out.println(<span class="hljs-string">"Cost   = "</span> + costMillis + <span class="hljs-string">" ms"</span>);
    
    executor.shutdown();
}
</code></pre>
<p>执行结果：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">Result</span> = ProductDetailDTO{productId=<span class="hljs-string">'P123'</span>, name=<span class="hljs-string">'MacBook Pro 14'</span>, priceInCents=<span class="hljs-number">149900</span>, quantity=<span class="hljs-number">42</span>}
<span class="hljs-attr">Cost</span>   = <span class="hljs-number">85</span> ms
</code></pre>
<hr/>
<h2 data-id="heading-10">四、执行流程</h2>
<h3 data-id="heading-11">时序图</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant C as Controller
    participant F as ProductFacade
    participant E as 线程池
    participant PS as ProductService
    participant IS as InventoryService
    
    C-&gt;&gt;F: getProductDetail(&amp;#34;P123&amp;#34;)
    F-&gt;&gt;E: submit(查商品)
    F-&gt;&gt;E: submit(查库存)
    
    par 并行执行
        E-&gt;&gt;PS: getProduct(&amp;#34;P123&amp;#34;)
        PS--&gt;&gt;E: Product(80ms)
    and
        E-&gt;&gt;IS: getInventory(&amp;#34;P123&amp;#34;)
        IS--&gt;&gt;E: Inventory(60ms)
    end
    
    E-&gt;&gt;F: 两个结果都完成
    F-&gt;&gt;F: 组装 ProductDetailDTO
    F--&gt;&gt;C: 返回结果(~85ms)
</code></pre>
<h3 data-id="heading-12">Fan-Out / Fan-In 模式</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[请求] --&gt; B[Fan-Out]
    B --&gt; C[任务1]
    B --&gt; D[任务2]
    C --&gt; E[Fan-In]
    D --&gt; E
    E --&gt; F[结果]
    
    style B fill:#e1f5ff
    style E fill:#fff4e1
</code></pre>
<p>这是并发编程的经典模式：</p>
<ul>
<li><strong>Fan-Out</strong>：将一个任务拆分成多个并行子任务</li>
<li><strong>Fan-In</strong>：等待所有子任务完成后汇总结果</li>
</ul>
<hr/>
<h2 data-id="heading-13">五、与 Elasticsearch 的对比</h2>
<h3 data-id="heading-14">ES 的场景：多索引并行查询</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[搜索请求] --&gt; B[logs-2024-01]
    A --&gt; C[logs-2024-02]
    A --&gt; D[logs-2024-03]
    B --&gt; E[合并排序]
    C --&gt; E
    D --&gt; E
    E --&gt; F[Top 10]
</code></pre>
<h3 data-id="heading-15">电商场景：多服务并行查询</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[详情请求] --&gt; B[商品服务]
    A --&gt; C[库存服务]
    B --&gt; D[简单组装]
    C --&gt; D
    D --&gt; E[返回DTO]
</code></pre>
<h3 data-id="heading-16">共同点</h3>






























<table><thead><tr><th>维度</th><th>Elasticsearch</th><th>电商商品详情</th></tr></thead><tbody><tr><td>模式</td><td>Fan-Out / Fan-In</td><td>Fan-Out / Fan-In</td></tr><tr><td>并行目标</td><td>多个索引/分片</td><td>多个微服务</td></tr><tr><td>汇总方式</td><td>合并排序</td><td>简单组装</td></tr><tr><td>核心诉求</td><td>正确性 + 性能</td><td>响应时间</td></tr></tbody></table>
<p>虽然场景不同，但底层思想一致：</p>
<ol>
<li><strong>分解</strong>：把大任务拆成多个独立小任务</li>
<li><strong>并行</strong>：利用线程池同时执行</li>
<li><strong>汇总</strong>：等待全部完成后组装结果</li>
</ol>
<hr/>
<h2 data-id="heading-17">六、更多应用场景</h2>
<h3 data-id="heading-18">订单详情页</h3>
<pre><code class="hljs language-java" lang="java">ListenableFuture&lt;Order&gt; orderFuture = getOrder(orderId);
ListenableFuture&lt;User&gt; userFuture = getUser(userId);
ListenableFuture&lt;List&lt;OrderItem&gt;&gt; itemsFuture = getOrderItems(orderId);
ListenableFuture&lt;Logistics&gt; logisticsFuture = getLogistics(orderId);

<span class="hljs-keyword">return</span> Futures.whenAllSucceed(orderFuture, userFuture, itemsFuture, logisticsFuture)
    .call(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderDetailDTO</span>(...), executor);
</code></pre>
<h3 data-id="heading-19">用户个人中心</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 并行查询：用户信息、订单统计、优惠券、积分</span>
ListenableFuture&lt;UserInfo&gt; userFuture = getUserInfo(userId);
ListenableFuture&lt;OrderStats&gt; statsFuture = getOrderStats(userId);
ListenableFuture&lt;List&lt;Coupon&gt;&gt; couponFuture = getCoupons(userId);
ListenableFuture&lt;Points&gt; pointsFuture = getPoints(userId);

<span class="hljs-keyword">return</span> Futures.whenAllSucceed(userFuture, statsFuture, couponFuture, pointsFuture)
    .call(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserCenterVO</span>(...), executor);
</code></pre>
<h3 data-id="heading-20">数据报表</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 并行查询：销售数据、用户数据、库存数据</span>
ListenableFuture&lt;SalesData&gt; salesFuture = getSalesData(startDate, endDate);
ListenableFuture&lt;UserData&gt; userDataFuture = getUserData(startDate, endDate);
ListenableFuture&lt;InventoryData&gt; inventoryFuture = getInventoryData();

<span class="hljs-keyword">return</span> Futures.whenAllSucceed(salesFuture, userDataFuture, inventoryFuture)
    .call(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReportVO</span>(...), executor);
</code></pre>
<hr/>
<h2 data-id="heading-21">七、异常处理与降级</h2>
<h3 data-id="heading-22">单个服务降级</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用 Futures.catching 处理异常</span>
ListenableFuture&lt;Product&gt; productWithFallback = Futures.catching(
    productFuture,
    Exception.class,
    ex -&gt; {
        log.error(<span class="hljs-string">"查询商品失败，使用默认值"</span>, ex);
        <span class="hljs-keyword">return</span> getDefaultProduct(productId);
    },
    executor
);
</code></pre>
<h3 data-id="heading-23">超时控制</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用 Futures.withTimeout 添加超时</span>
ListenableFuture&lt;Product&gt; productFuture = Futures.withTimeout(
    executor.submit(() -&gt; productService.getProduct(id)),
    <span class="hljs-number">2</span>, TimeUnit.SECONDS,
    scheduledExecutor  <span class="hljs-comment">// 需要一个 ScheduledExecutorService</span>
);
</code></pre>
<h3 data-id="heading-24">部分失败允许</h3>
<p>如果允许部分查询失败，可以使用 <code>Futures.successfulAsList()</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 即使部分失败，也返回成功的结果（失败的为 null）</span>
ListenableFuture&lt;List&lt;Object&gt;&gt; results = Futures.successfulAsList(
    productFuture, 
    inventoryFuture
);

<span class="hljs-keyword">return</span> Futures.transform(results, list -&gt; {
    <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> (Product) list.get(<span class="hljs-number">0</span>);
    <span class="hljs-type">Inventory</span> <span class="hljs-variable">inventory</span> <span class="hljs-operator">=</span> (Inventory) list.get(<span class="hljs-number">1</span>);
    
    <span class="hljs-comment">// 处理可能为 null 的情况</span>
    <span class="hljs-keyword">if</span> (product == <span class="hljs-literal">null</span>) product = getDefaultProduct();
    <span class="hljs-keyword">if</span> (inventory == <span class="hljs-literal">null</span>) inventory = getDefaultInventory();
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductDetailDTO</span>(...);
}, executor);
</code></pre>
<hr/>
<h2 data-id="heading-25">八、生产环境配置建议</h2>
<h3 data-id="heading-26">线程池配置</h3>
<p>基于 ES 的经验（详见我的上一篇文章），推荐配置：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">int</span> <span class="hljs-variable">processors</span> <span class="hljs-operator">=</span> Runtime.getRuntime().availableProcessors();

<span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">threadPool</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    processors,                          <span class="hljs-comment">// 核心线程数 = CPU 核心数</span>
    processors * <span class="hljs-number">2</span>,                      <span class="hljs-comment">// 最大线程数（IO 密集型）</span>
    <span class="hljs-number">60</span>, TimeUnit.SECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">256</span> * processors * <span class="hljs-number">2</span>),  <span class="hljs-comment">// 有理论依据的队列大小</span>
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadFactoryBuilder</span>()
        .setNameFormat(<span class="hljs-string">"ProductQuery-%d"</span>)  <span class="hljs-comment">// 线程命名</span>
        .build(),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy()  <span class="hljs-comment">// 业务系统用降级策略</span>
);

<span class="hljs-type">ListeningExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> MoreExecutors.listeningDecorator(threadPool);
</code></pre>
<h3 data-id="heading-27">Spring Bean 配置</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExecutorConfig</span> {
    
    <span class="hljs-meta">@Bean("productQueryExecutor")</span>
    <span class="hljs-keyword">public</span> ListeningExecutorService <span class="hljs-title function_">productQueryExecutor</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">processors</span> <span class="hljs-operator">=</span> Runtime.getRuntime().availableProcessors();
        
        <span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">threadPool</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
            processors,
            processors * <span class="hljs-number">2</span>,
            <span class="hljs-number">60</span>, TimeUnit.SECONDS,
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">256</span> * processors * <span class="hljs-number">2</span>),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadFactoryBuilder</span>()
                .setNameFormat(<span class="hljs-string">"ProductQuery-%d"</span>)
                .build(),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy()
        );
        
        <span class="hljs-keyword">return</span> MoreExecutors.listeningDecorator(threadPool);
    }
}
</code></pre>
<h3 data-id="heading-28">监控指标</h3>
<p>关键监控点：</p>
<ul>
<li><strong>活跃线程数</strong>：当前正在执行任务的线程数</li>
<li><strong>队列大小</strong>：等待执行的任务数</li>
<li><strong>拒绝次数</strong>：线程池满了被拒绝的任务数</li>
<li><strong>平均执行时间</strong>：任务的平均耗时</li>
</ul>
<p>告警阈值：</p>
<ul>
<li>队列堆积 &gt; 最大线程数 × 100：可能有慢查询</li>
<li>拒绝次数突增：流量超过处理能力</li>
<li>活跃线程数长期 = 最大线程数：需要扩容</li>
</ul>
<hr/>
<h2 data-id="heading-29">九、何时使用并发</h2>
<h3 data-id="heading-30">适合的场景</h3>
<ol>
<li><strong>多个独立的 IO 操作</strong>：查询多个数据表、调用多个外部 API</li>
<li><strong>操作之间无依赖</strong>：查商品和查评论没有先后顺序</li>
<li><strong>对响应时间敏感</strong>：用户等待的接口</li>
</ol>
<h3 data-id="heading-31">不适合的场景</h3>
<ol>
<li><strong>有依赖关系的操作</strong>：第二步依赖第一步的结果（应该用 <code>transformAsync</code>）</li>
<li><strong>需要事务一致性</strong>：扣库存和创建订单必须在同一事务</li>
<li><strong>纯 CPU 密集计算</strong>：应该用 <code>ParallelStream</code> 或 <code>ForkJoinPool</code></li>
<li><strong>需要消息可靠性保证</strong>：用 MQ（RabbitMQ、RocketMQ）</li>
</ol>
<hr/>
<h2 data-id="heading-32">十、总结</h2>
<h3 data-id="heading-33">核心收获</h3>
<ol>
<li>
<p><strong>Guava ListenableFuture 比 CompletableFuture 更清晰</strong></p>
<ul>
<li><code>whenAllSucceed</code> 语义明确</li>
<li><code>getDone</code> 类型安全</li>
<li>职责分离，代码可读性强</li>
</ul>
</li>
<li>
<p><strong>Fan-Out / Fan-In 是通用模式</strong></p>
<ul>
<li>ES 用于多索引查询</li>
<li>业务系统用于多服务聚合</li>
<li>底层思想一致</li>
</ul>
</li>
<li>
<p><strong>线程池配置有理论依据</strong></p>
<ul>
<li>核心线程数 = CPU 核心数</li>
<li>最大线程数 = CPU 核心数 × 2（IO 密集型）</li>
<li>队列大小 = 256 × 最大线程数</li>
</ul>
</li>
</ol>
<h3 data-id="heading-34">实践建议</h3>
<ol>
<li><strong>从简单场景开始</strong>：先用在商品详情这类典型场景</li>
<li><strong>加强监控</strong>：关注线程池状态和任务执行时间</li>
<li><strong>做好降级</strong>：考虑异常和超时情况</li>
<li><strong>压测验证</strong>：用真实流量验证配置合理性</li>
</ol>
<p>这套模式可以作为你以后所有"多服务并行查询 + 聚合返回"场景的模板：代码清晰、思路简单、足够贴近真实业务。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[例题]]></title>    <link>https://juejin.cn/post/7586687526867681295</link>    <guid>https://juejin.cn/post/7586687526867681295</guid>    <pubDate>2025-12-23T11:48:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586687526867681295" data-draft-id="7586703355645788187" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="例题"/> <meta itemprop="keywords" content="C++"/> <meta itemprop="datePublished" content="2025-12-23T11:48:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ozyzo"/> <meta itemprop="url" content="https://juejin.cn/user/458965109710202"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            例题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/458965109710202/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ozyzo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T11:48:43.000Z" title="Tue Dec 23 2025 11:48:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">（一）</h2>
<h2 data-id="heading-1">代码如下:</h2>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-type">void</span> <span class="hljs-title function_">f</span><span class="hljs-params">(<span class="hljs-type">int</span> m)</span>{
    m += <span class="hljs-number">10</span>;
}
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>{
    <span class="hljs-type">int</span> m = <span class="hljs-number">1</span>;
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"m=%d\n"</span>, m);
    f(m);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"m=%d"</span>, m);
}
</code></pre>
<h2 data-id="heading-2">运行结果如下：</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a1591fcd44f455c81e8558b9ffdbd13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgb3p5em8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767095322&amp;x-signature=XbeZMsa%2FmcH7%2F88TUmJ8Oxz7I2o%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62d886672144485cb910b0cc3466ac1f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgb3p5em8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767095322&amp;x-signature=iEWJUMlXk1wH5%2Bq10RuexzLlaxU%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-3">（二）</h2>
<h2 data-id="heading-4">代码如下：</h2>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-type">void</span> <span class="hljs-title function_">f</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span>{
    x += <span class="hljs-number">1</span>;
    y -= <span class="hljs-number">1</span>;
}
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>{
    <span class="hljs-type">int</span> x = <span class="hljs-number">10</span>;
    <span class="hljs-type">int</span> y = <span class="hljs-number">10</span>;
    f(x,y);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"x=%d,y=%d"</span>, x,y);
}
</code></pre>
<h2 data-id="heading-5">运行结果如下：</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35b060b52d9e40a5b4bcee512a9fc3f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgb3p5em8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767095322&amp;x-signature=RN%2BviUNU4NLFzsepDLEzzk37xvg%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82967286693846e3a60b6902af9973e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgb3p5em8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767095322&amp;x-signature=Ei%2BMDPWczrmsgo%2BvHXsklNw553s%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 性能优化完整指南]]></title>    <link>https://juejin.cn/post/7586687526867632143</link>    <guid>https://juejin.cn/post/7586687526867632143</guid>    <pubDate>2025-12-23T11:33:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586687526867632143" data-draft-id="7586687526867615759" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 性能优化完整指南"/> <meta itemprop="keywords" content="Flutter"/> <meta itemprop="datePublished" content="2025-12-23T11:33:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="麦客奥德彪"/> <meta itemprop="url" content="https://juejin.cn/user/2365804752418232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 性能优化完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2365804752418232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    麦客奥德彪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T11:33:42.000Z" title="Tue Dec 23 2025 11:33:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、构建优化（Build Optimization）</h2>
<h3 data-id="heading-1">1.1 使用 const 构造函数</h3>
<p><strong>原理</strong>：const Widget 在编译时创建，不会在每次 build 时重建。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// ❌ 错误：每次都创建新对象</span>
Widget <span class="hljs-built_in">build</span>(BuildContext context) {
  return <span class="hljs-built_in">Container</span>(
    padding: EdgeInsets.all(<span class="hljs-number">16</span>),
    child: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'标题'</span>),
  );
}

<span class="hljs-comment">// ✅ 正确：使用 const</span>
Widget <span class="hljs-built_in">build</span>(BuildContext context) {
  return <span class="hljs-built_in">Container</span>(
    padding: const EdgeInsets.all(<span class="hljs-number">16</span>),
    child: const <span class="hljs-built_in">Text</span>(<span class="hljs-string">'标题'</span>),
  );
}
</code></pre>
<p><strong>优化建议</strong>：</p>
<ul>
<li>静态文本、图标、样式等都用 const</li>
<li>善用 IDE 提示，它会提示哪里可以加 const</li>
<li>对于不变的 Widget 树，整个都标记为 const</li>
</ul>
<h3 data-id="heading-2">1.2 避免在 build 方法中创建对象</h3>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// ❌ 错误：每次 build 都创建新样式</span>
Widget <span class="hljs-title function_ invoke__">build</span>(BuildContext context) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Text</span>(
    <span class="hljs-string">'内容'</span>,
    <span class="hljs-attr">style</span>: <span class="hljs-title function_ invoke__">TextStyle</span>(<span class="hljs-attr">fontSize</span>: <span class="hljs-number">16</span>, <span class="hljs-attr">color</span>: Colors.blue),  // 每次重建
  );
}

<span class="hljs-comment">// ✅ 正确：提取为常量</span>
<span class="hljs-built_in">static</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">_textStyle</span> = <span class="hljs-title function_ invoke__">TextStyle</span>(<span class="hljs-attr">fontSize</span>: <span class="hljs-number">16</span>, <span class="hljs-attr">color</span>: Colors.blue);

Widget <span class="hljs-title function_ invoke__">build</span>(BuildContext context) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Text</span>(<span class="hljs-string">'内容'</span>, <span class="hljs-attr">style</span>: _textStyle);
}
</code></pre>
<h3 data-id="heading-3">1.3 拆分 Widget，缩小重建范围</h3>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// ❌ 错误：整个页面重建</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-type">State</span>&lt;<span class="hljs-type">MyPage</span>&gt; createState() =&gt; _MyPageState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_MyPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State&lt;MyPage&gt;</span> </span>{
  int _counter = <span class="hljs-number">0</span>;

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">return</span> <span class="hljs-type">Column</span>(
      children: [
        <span class="hljs-type">Header</span>(),  <span class="hljs-comment">// 不需要重建，但会重建</span>
        <span class="hljs-type">Text</span>('计数: $_counter'),  <span class="hljs-comment">// 需要重建</span>
        <span class="hljs-type">Footer</span>(),  <span class="hljs-comment">// 不需要重建，但会重建</span>
      ],
    );
  }
}

<span class="hljs-comment">// ✅ 正确：拆分可变部分</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">return</span> <span class="hljs-type">Column</span>(
      children: [
        const <span class="hljs-type">Header</span>(),  <span class="hljs-comment">// const，不会重建</span>
        <span class="hljs-type">CounterWidget</span>(),  <span class="hljs-comment">// 只有这部分重建</span>
        const <span class="hljs-type">Footer</span>(),  <span class="hljs-comment">// const，不会重建</span>
      ],
    );
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CounterWidget</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-type">State</span>&lt;<span class="hljs-type">CounterWidget</span>&gt; createState() =&gt; _CounterWidgetState();
}
</code></pre>
<h3 data-id="heading-4">1.4 使用 Builder 延迟构建</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ❌ 错误：一次性构建大量 Widget</span>
<span class="hljs-selector-tag">Column</span>(
  <span class="hljs-attribute">children</span>: List.<span class="hljs-built_in">generate</span>(<span class="hljs-number">1000</span>, (index) =&gt; <span class="hljs-built_in">ListTile</span>(<span class="hljs-attribute">title</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'$index'</span>))),
)

<span class="hljs-comment">// ✅ 正确：按需构建</span>
<span class="hljs-selector-tag">ListView</span><span class="hljs-selector-class">.builder</span>(
  <span class="hljs-attribute">itemCount</span>: <span class="hljs-number">1000</span>,
  <span class="hljs-attribute">itemBuilder</span>: (context, index) =&gt; <span class="hljs-built_in">ListTile</span>(<span class="hljs-attribute">title</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'$index'</span>)),
)
</code></pre>
<h2 data-id="heading-5">二、渲染优化（Rendering Optimization）</h2>
<h3 data-id="heading-6">2.1 使用 RepaintBoundary 隔离重绘</h3>
<p><strong>原理</strong>：创建独立的绘制层，避免不必要的重绘传播。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 隔离频繁变化的动画区域</span>
<span class="hljs-selector-tag">Column</span>(
  <span class="hljs-attribute">children</span>: [
    const <span class="hljs-built_in">Text</span>(<span class="hljs-string">'静态标题'</span>),
    <span class="hljs-built_in">RepaintBoundary</span>(
      <span class="hljs-attribute">child</span>: <span class="hljs-built_in">AnimatedWidget</span>(),  <span class="hljs-comment">// 动画只重绘这部分</span>
    ),
    const <span class="hljs-built_in">Text</span>(<span class="hljs-string">'静态底部'</span>),
  ],
)
</code></pre>
<p><strong>适用场景</strong>：</p>
<ul>
<li>复杂动画</li>
<li>频繁更新的区域（如时钟、进度条）</li>
<li>列表项中的复杂 Widget</li>
</ul>
<h3 data-id="heading-7">2.2 避免使用 Opacity 做淡入淡出</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ❌ 错误：Opacity 会导致昂贵的离屏渲染</span>
<span class="hljs-selector-tag">Opacity</span>(
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.5</span>,
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">ComplexWidget</span>(),
)

<span class="hljs-comment">// ✅ 正确：使用 AnimatedOpacity</span>
<span class="hljs-selector-tag">AnimatedOpacity</span>(
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.5</span>,
  <span class="hljs-attribute">duration</span>: <span class="hljs-built_in">Duration</span>(<span class="hljs-attribute">milliseconds</span>: <span class="hljs-number">300</span>),
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">ComplexWidget</span>(),
)

<span class="hljs-comment">// ✅ 或者直接用颜色透明度</span>
<span class="hljs-selector-tag">Container</span>(
  <span class="hljs-attribute">color</span>: Colors.blue.<span class="hljs-built_in">withOpacity</span>(<span class="hljs-number">0.5</span>),
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">ComplexWidget</span>(),
)
</code></pre>
<h3 data-id="heading-8">2.3 避免使用 ClipPath/ClipRRect 的昂贵裁剪</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ❌ 较慢：复杂路径裁剪</span>
<span class="hljs-selector-tag">ClipPath</span>(
  <span class="hljs-attribute">clipper</span>: <span class="hljs-built_in">CustomClipper</span>(),
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">ComplexWidget</span>(),
)

<span class="hljs-comment">// ✅ 较快：使用 DecoratedBox + borderRadius</span>
<span class="hljs-selector-tag">Container</span>(
  <span class="hljs-attribute">decoration</span>: <span class="hljs-built_in">BoxDecoration</span>(
    <span class="hljs-attribute">borderRadius</span>: BorderRadius.<span class="hljs-built_in">circular</span>(<span class="hljs-number">12</span>),
  ),
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">ComplexWidget</span>(),
)
</code></pre>
<h3 data-id="heading-9">2.4 减少 saveLayer 调用</h3>
<p><strong>会触发 saveLayer 的操作</strong>（都很昂贵）：</p>
<ul>
<li>Opacity（部分情况）</li>
<li>ColorFilter</li>
<li>ShaderMask</li>
<li>BackdropFilter</li>
<li>带透明度的 ClipRRect</li>
</ul>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ❌ 避免这种写法</span>
<span class="hljs-selector-tag">Opacity</span>(
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.5</span>,
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Container</span>(
    <span class="hljs-attribute">decoration</span>: <span class="hljs-built_in">BoxDecoration</span>(
      <span class="hljs-attribute">color</span>: Colors.blue,
      <span class="hljs-attribute">boxShadow</span>: [<span class="hljs-built_in">BoxShadow</span>(...)],
    ),
  ),
)

<span class="hljs-comment">// ✅ 改为直接设置颜色透明度</span>
<span class="hljs-selector-tag">Container</span>(
  <span class="hljs-attribute">decoration</span>: <span class="hljs-built_in">BoxDecoration</span>(
    <span class="hljs-attribute">color</span>: Colors.blue.<span class="hljs-built_in">withOpacity</span>(<span class="hljs-number">0.5</span>),
    <span class="hljs-attribute">boxShadow</span>: [<span class="hljs-built_in">BoxShadow</span>(...)],
  ),
)
</code></pre>
<h2 data-id="heading-10">三、列表优化（List Optimization）</h2>
<h3 data-id="heading-11">3.1 使用 ListView.builder 而非 ListView</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ❌ 错误：一次性创建所有 Widget</span>
<span class="hljs-selector-tag">ListView</span>(
  <span class="hljs-attribute">children</span>: List.<span class="hljs-built_in">generate</span>(<span class="hljs-number">10000</span>, (i) =&gt; <span class="hljs-built_in">ListTile</span>(<span class="hljs-attribute">title</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'$i'</span>))),
)

<span class="hljs-comment">// ✅ 正确：按需加载</span>
<span class="hljs-selector-tag">ListView</span><span class="hljs-selector-class">.builder</span>(
  <span class="hljs-attribute">itemCount</span>: <span class="hljs-number">10000</span>,
  <span class="hljs-attribute">itemBuilder</span>: (context, index) =&gt; <span class="hljs-built_in">ListTile</span>(<span class="hljs-attribute">title</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'$index'</span>)),
)
</code></pre>
<h3 data-id="heading-12">3.2 添加 itemExtent 或 prototypeItem</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 指定固定高度，提升滚动性能</span>
<span class="hljs-selector-tag">ListView</span><span class="hljs-selector-class">.builder</span>(
  <span class="hljs-attribute">itemCount</span>: <span class="hljs-number">1000</span>,
  <span class="hljs-attribute">itemExtent</span>: <span class="hljs-number">56.0</span>,  <span class="hljs-comment">// 每项固定高度</span>
  <span class="hljs-attribute">itemBuilder</span>: (context, index) =&gt; <span class="hljs-built_in">ListTile</span>(<span class="hljs-attribute">title</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'$index'</span>)),
)

<span class="hljs-comment">// ✅ 或使用 prototypeItem</span>
<span class="hljs-selector-tag">ListView</span><span class="hljs-selector-class">.builder</span>(
  <span class="hljs-attribute">itemCount</span>: <span class="hljs-number">1000</span>,
  <span class="hljs-attribute">prototypeItem</span>: const <span class="hljs-built_in">ListTile</span>(<span class="hljs-attribute">title</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'原型'</span>)),
  <span class="hljs-attribute">itemBuilder</span>: (context, index) =&gt; <span class="hljs-built_in">ListTile</span>(<span class="hljs-attribute">title</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'$index'</span>)),
)
</code></pre>
<h3 data-id="heading-13">3.3 使用 AutomaticKeepAlive 保持状态</h3>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyListItem</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-type">State</span>&lt;<span class="hljs-type">MyListItem</span>&gt; createState() =&gt; _MyListItemState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_MyListItemState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State&lt;MyListItem&gt;</span></span>
    <span class="hljs-keyword">with</span> <span class="hljs-type">AutomaticKeepAliveClientMixin</span> {
  <span class="hljs-meta">@override</span>
  bool get wantKeepAlive =&gt; <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 保持状态不被销毁</span>

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">super</span>.build(context);  <span class="hljs-comment">// 必须调用</span>
    <span class="hljs-keyword">return</span> <span class="hljs-type">ExpansiveWidget</span>();  <span class="hljs-comment">// 展开收起的复杂组件</span>
  }
}
</code></pre>
<h3 data-id="heading-14">3.4 缓存复杂计算结果</h3>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyListItem</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> data;
  
  const <span class="hljs-type">MyListItem</span>(<span class="hljs-keyword">this</span>.data);

  <span class="hljs-comment">// ❌ 错误：每次 build 都计算</span>
  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">final</span> processed = expensiveProcessing(data);
    <span class="hljs-keyword">return</span> <span class="hljs-type">Text</span>(processed);
  }
}

<span class="hljs-comment">// ✅ 正确：使用 Memo 或在外部处理</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyListItem</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> data;
  <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> processed;  <span class="hljs-comment">// 预处理好的数据</span>
  
  const <span class="hljs-type">MyListItem</span>(<span class="hljs-keyword">this</span>.data, <span class="hljs-keyword">this</span>.processed);

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">return</span> <span class="hljs-type">Text</span>(processed);
  }
}
</code></pre>
<h2 data-id="heading-15">四、图片优化（Image Optimization）</h2>
<h3 data-id="heading-16">4.1 使用合适的图片格式和尺寸</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ❌ 错误：加载原图（10MB，4000x3000）</span>
<span class="hljs-selector-tag">Image</span><span class="hljs-selector-class">.network</span>(<span class="hljs-string">'https://example.com/huge-image.jpg'</span>)

<span class="hljs-comment">// ✅ 正确：使用缩略图或指定尺寸</span>
<span class="hljs-selector-tag">Image</span><span class="hljs-selector-class">.network</span>(
  <span class="hljs-string">'https://example.com/thumbnail.jpg'</span>,
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100</span>,
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100</span>,
  <span class="hljs-attribute">cacheWidth</span>: <span class="hljs-number">100</span>,  <span class="hljs-comment">// 解码时缩放，节省内存</span>
  <span class="hljs-attribute">cacheHeight</span>: <span class="hljs-number">100</span>,
)
</code></pre>
<h3 data-id="heading-17">4.2 使用 cached_network_image 缓存网络图片</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">import</span> '<span class="hljs-selector-tag">package</span>:<span class="hljs-selector-tag">cached_network_image</span>/<span class="hljs-selector-tag">cached_network_image</span><span class="hljs-selector-class">.dart</span>';

<span class="hljs-comment">// ✅ 自动缓存，避免重复下载</span>
<span class="hljs-selector-tag">CachedNetworkImage</span>(
  <span class="hljs-attribute">imageUrl</span>: <span class="hljs-string">'https://example.com/image.jpg'</span>,
  <span class="hljs-attribute">placeholder</span>: (context, url) =&gt; <span class="hljs-built_in">CircularProgressIndicator</span>(),
  <span class="hljs-attribute">errorWidget</span>: (context, url, error) =&gt; <span class="hljs-built_in">Icon</span>(Icons.error),
  <span class="hljs-attribute">memCacheWidth</span>: <span class="hljs-number">200</span>,  <span class="hljs-comment">// 内存缓存优化</span>
  <span class="hljs-attribute">maxWidthDiskCache</span>: <span class="hljs-number">400</span>,  <span class="hljs-comment">// 磁盘缓存优化</span>
)
</code></pre>
<h3 data-id="heading-18">4.3 预加载图片</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@override</span>
void didChangeDependencies() {
  super<span class="hljs-selector-class">.didChangeDependencies</span>();
  <span class="hljs-comment">// 预加载下一页可能用到的图片</span>
  <span class="hljs-built_in">precacheImage</span>(AssetImage('assets/next_page.png'), context);
  <span class="hljs-built_in">precacheImage</span>(NetworkImage('https://example.com/image.jpg'), context);
}
</code></pre>
<h3 data-id="heading-19">4.4 使用 ResizeImage 缩小图片</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// ✅ 解码时就缩放，节省内存</span>
<span class="hljs-selector-tag">Image</span>(
  <span class="hljs-attribute">image</span>: <span class="hljs-built_in">ResizeImage</span>(
    <span class="hljs-built_in">NetworkImage</span>(<span class="hljs-string">'https://example.com/image.jpg'</span>),
    <span class="hljs-attribute">width</span>: <span class="hljs-number">300</span>,
    <span class="hljs-attribute">height</span>: <span class="hljs-number">300</span>,
  ),
)
</code></pre>
<h2 data-id="heading-20">五、状态管理优化</h2>
<h3 data-id="heading-21">5.1 选择合适的状态管理方案</h3>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// ❌ 简单应用过度设计</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">return</span> <span class="hljs-type">Provider</span>&lt;<span class="hljs-type">ComplexStore</span>&gt;(
      create: (_) =&gt; <span class="hljs-type">ComplexStore</span>(),
      child: <span class="hljs-type">MaterialApp</span>(...),
    );
  }
}

<span class="hljs-comment">// ✅ 简单情况用 StatefulWidget 或 ValueNotifier</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CounterWidget</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-type">State</span>&lt;<span class="hljs-type">CounterWidget</span>&gt; createState() =&gt; _CounterWidgetState();
}

<span class="hljs-comment">// ✅ 复杂情况用 Provider/Riverpod/Bloc</span>
</code></pre>
<h3 data-id="heading-22">5.2 使用 ValueListenableBuilder 局部刷新</h3>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyWidget</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-type">State</span>&lt;<span class="hljs-type">MyWidget</span>&gt; createState() =&gt; _MyWidgetState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_MyWidgetState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State&lt;MyWidget&gt;</span> </span>{
  <span class="hljs-keyword">final</span> _counter = <span class="hljs-type">ValueNotifier</span>&lt;int&gt;(<span class="hljs-number">0</span>);

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">return</span> <span class="hljs-type">Column</span>(
      children: [
        const <span class="hljs-type">Text</span>('静态标题'),  <span class="hljs-comment">// 不会重建</span>
        <span class="hljs-type">ValueListenableBuilder</span>&lt;int&gt;(
          valueListenable: _counter,
          builder: (context, value, child) {
            <span class="hljs-keyword">return</span> <span class="hljs-type">Text</span>('计数: $value');  <span class="hljs-comment">// 只有这里重建</span>
          },
        ),
        <span class="hljs-type">ElevatedButton</span>(
          onPressed: () =&gt; _counter.value++,
          child: const <span class="hljs-type">Text</span>('增加'),
        ),
      ],
    );
  }

  <span class="hljs-meta">@override</span>
  void dispose() {
    _counter.dispose();
    <span class="hljs-keyword">super</span>.dispose();
  }
}
</code></pre>
<h3 data-id="heading-23">5.3 使用 Selector 精确监听</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 使用 Provider + Selector</span>
Consumer&lt;MyModel&gt;(
  builder: (context, model, child) {
    <span class="hljs-keyword">return</span> Text(<span class="hljs-string">'<span class="hljs-subst">${model.counter}</span>'</span>);  <span class="hljs-comment">// model 任何变化都会重建</span>
  },
)

<span class="hljs-comment">// ✅ 改为 Selector，只监听特定字段</span>
Selector&lt;MyModel, <span class="hljs-built_in">int</span>&gt;(
  selector: (context, model) =&gt; model.counter,  <span class="hljs-comment">// 只监听 counter</span>
  builder: (context, counter, child) {
    <span class="hljs-keyword">return</span> Text(<span class="hljs-string">'<span class="hljs-subst">$counter</span>'</span>);  <span class="hljs-comment">// 只有 counter 变化才重建</span>
  },
)
</code></pre>
<h2 data-id="heading-24">六、异步与网络优化</h2>
<h3 data-id="heading-25">6.1 使用 FutureBuilder/StreamBuilder 避免手动管理状态</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// ✅ 自动处理加载、成功、失败状态</span>
FutureBuilder&lt;List&lt;Item&gt;&gt;(
  future: fetchItems(),
  builder: (context, snapshot) {
    if (snapshot.hasData) {
      return <span class="hljs-built_in">ListView</span>(children: snapshot.data!.map(...)<span class="hljs-selector-class">.toList</span>());
    } else if (snapshot.hasError) {
      return Text('错误: ${snapshot.error}');
    }
    return <span class="hljs-built_in">CircularProgressIndicator</span>();
  },
)
</code></pre>
<h3 data-id="heading-26">6.2 使用 compute 执行耗时计算</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// ❌ 错误：在主线程执行耗时操作</span>
List&lt;Item&gt; <span class="hljs-built_in">parseData</span>(String json) {
  return <span class="hljs-built_in">expensiveParsing</span>(json);  <span class="hljs-comment">// 阻塞 UI</span>
}

<span class="hljs-comment">// ✅ 正确：在后台线程执行</span>
Future&lt;List&lt;Item&gt;&gt; <span class="hljs-built_in">parseData</span>(String json) async {
  return <span class="hljs-built_in">compute</span>(_parseInBackground, json);
}

List&lt;Item&gt; <span class="hljs-built_in">_parseInBackground</span>(String json) {
  return <span class="hljs-built_in">expensiveParsing</span>(json);
}
</code></pre>
<h3 data-id="heading-27">6.3 防抖和节流</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 搜索框防抖</span>
Timer? _debounce;

void <span class="hljs-built_in">onSearchChanged</span>(String query) {
  _debounce?<span class="hljs-selector-class">.cancel</span>();
  _debounce = <span class="hljs-built_in">Timer</span>(const Duration(milliseconds: <span class="hljs-number">500</span>), () {
    <span class="hljs-built_in">performSearch</span>(query);  <span class="hljs-comment">// 500ms 后才执行</span>
  });
}

<span class="hljs-keyword">@override</span>
void dispose() {
  _debounce?<span class="hljs-selector-class">.cancel</span>();
  super<span class="hljs-selector-class">.dispose</span>();
}
</code></pre>
<h2 data-id="heading-28">七、内存优化</h2>
<h3 data-id="heading-29">7.1 及时释放资源</h3>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyWidget</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-type">State</span>&lt;<span class="hljs-type">MyWidget</span>&gt; createState() =&gt; _MyWidgetState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_MyWidgetState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State&lt;MyWidget&gt;</span> </span>{
  late <span class="hljs-type">AnimationController</span> _controller;
  late <span class="hljs-type">StreamSubscription</span> _subscription;

  <span class="hljs-meta">@override</span>
  void initState() {
    <span class="hljs-keyword">super</span>.initState();
    _controller = <span class="hljs-type">AnimationController</span>(vsync: <span class="hljs-keyword">this</span>, ...);
    _subscription = stream.listen(...);
  }

  <span class="hljs-meta">@override</span>
  void dispose() {
    _controller.dispose();  <span class="hljs-comment">// ✅ 释放动画控制器</span>
    _subscription.cancel();  <span class="hljs-comment">// ✅ 取消订阅</span>
    <span class="hljs-keyword">super</span>.dispose();
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) =&gt; <span class="hljs-type">Container</span>();
}
</code></pre>
<h3 data-id="heading-30">7.2 避免内存泄漏</h3>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// ❌ 错误：闭包持有 State 引用</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_MyWidgetState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State&lt;MyWidget&gt;</span> </span>{
  void startTimer() {
    <span class="hljs-type">Timer</span>.periodic(<span class="hljs-type">Duration</span>(seconds: <span class="hljs-number">1</span>), (timer) {
      setState(() {});  <span class="hljs-comment">// 即使 Widget 销毁，timer 仍在运行</span>
    });
  }
}

<span class="hljs-comment">// ✅ 正确：保存引用并取消</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_MyWidgetState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State&lt;MyWidget&gt;</span> </span>{
  <span class="hljs-type">Timer</span>? _timer;

  void startTimer() {
    _timer = <span class="hljs-type">Timer</span>.periodic(<span class="hljs-type">Duration</span>(seconds: <span class="hljs-number">1</span>), (timer) {
      <span class="hljs-keyword">if</span> (mounted) {  <span class="hljs-comment">// 检查是否仍然挂载</span>
        setState(() {});
      }
    });
  }

  <span class="hljs-meta">@override</span>
  void dispose() {
    _timer?.cancel();
    <span class="hljs-keyword">super</span>.dispose();
  }
}
</code></pre>
<h3 data-id="heading-31">7.3 使用弱引用或事件总线</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 使用 event_bus 避免直接持有引用</span>
final EventBus eventBus = <span class="hljs-built_in">EventBus</span>();

<span class="hljs-comment">// 订阅</span>
StreamSubscription subscription = eventBus<span class="hljs-selector-class">.on</span>&lt;UserEvent&gt;()<span class="hljs-selector-class">.listen</span>((event) {
  <span class="hljs-comment">// 处理事件</span>
});

<span class="hljs-comment">// 取消订阅</span>
subscription<span class="hljs-selector-class">.cancel</span>();
</code></pre>
<h2 data-id="heading-32">八、启动优化</h2>
<h3 data-id="heading-33">8.1 延迟初始化</h3>
<pre><code class="hljs language-scss" lang="scss">void <span class="hljs-selector-tag">main</span>() async {
  WidgetsFlutterBinding<span class="hljs-selector-class">.ensureInitialized</span>();
  
  <span class="hljs-comment">// ✅ 只初始化必要的服务</span>
  await <span class="hljs-built_in">initCriticalServices</span>();
  
  <span class="hljs-built_in">runApp</span>(MyApp());
  
  <span class="hljs-comment">// ✅ 应用启动后再初始化非关键服务</span>
  <span class="hljs-built_in">initNonCriticalServices</span>();
}
</code></pre>
<h3 data-id="heading-34">8.2 使用占位符快速渲染首屏</h3>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">return</span> <span class="hljs-type">MaterialApp</span>(
      home: <span class="hljs-type">FutureBuilder</span>(
        future: loadInitialData(),
        builder: (context, snapshot) {
          <span class="hljs-keyword">if</span> (snapshot.connectionState == <span class="hljs-type">ConnectionState</span>.done) {
            <span class="hljs-keyword">return</span> <span class="hljs-type">HomePage</span>();
          }
          <span class="hljs-keyword">return</span> <span class="hljs-type">SplashScreen</span>();  <span class="hljs-comment">// ✅ 轻量级占位屏幕</span>
        },
      ),
    );
  }
}
</code></pre>
<h2 data-id="heading-35">九、性能监控与分析</h2>
<h3 data-id="heading-36">9.1 使用 Flutter DevTools</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 运行应用后打开 DevTools</span>
flutter run
<span class="hljs-comment"># 然后在浏览器打开 DevTools 链接</span>
</code></pre>
<p><strong>重点关注</strong>：</p>
<ul>
<li>Performance 页面：查看帧率、重建次数</li>
<li>Memory 页面：监控内存使用</li>
<li>Network 页面：分析网络请求</li>
</ul>
<h3 data-id="heading-37">9.2 使用 Timeline</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-string">'dart:developer'</span>;

<span class="hljs-keyword">void</span> <span class="hljs-title function_">expensiveOperation</span>(<span class="hljs-params"/>) {
  <span class="hljs-title class_">Timeline</span>.<span class="hljs-title function_">startSync</span>(<span class="hljs-string">'expensiveOperation'</span>);
  <span class="hljs-comment">// 执行操作</span>
  <span class="hljs-title class_">Timeline</span>.<span class="hljs-title function_">finishSync</span>();
}
</code></pre>
<h3 data-id="heading-38">9.3 检查过度重建</h3>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyWidget</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    print('<span class="hljs-type">MyWidget</span> build');  <span class="hljs-comment">// 监控重建次数</span>
    <span class="hljs-keyword">return</span> <span class="hljs-type">Container</span>();
  }
}
</code></pre>
<h2 data-id="heading-39">十、编译优化</h2>
<h3 data-id="heading-40">10.1 使用 Profile/Release 模式测试性能</h3>
<pre><code class="hljs language-arduino" lang="arduino"># ❌ Debug 模式性能差，不能作为参考
flutter run

# ✅ Profile 模式：保留调试信息 + 优化性能
flutter run --profile

# ✅ Release 模式：最佳性能
flutter run --release
flutter build apk --release
flutter build ios --release
</code></pre>
<h3 data-id="heading-41">10.2 启用代码混淆</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># Android</span>
flutter build apk --obfuscate <span class="hljs-attr">--split-debug-info</span>=/&lt;project-name&gt;/&lt;directory&gt;

<span class="hljs-comment"># iOS</span>
flutter build ios --obfuscate <span class="hljs-attr">--split-debug-info</span>=/&lt;project-name&gt;/&lt;directory&gt;
</code></pre>
<h3 data-id="heading-42">10.3 分析包体积</h3>
<pre><code class="hljs language-css" lang="css"># 分析包大小
flutter build apk <span class="hljs-attr">--analyze-size</span>
flutter build appbundle <span class="hljs-attr">--analyze-size</span>

# 查看详细信息
flutter build apk <span class="hljs-attr">--target-platform</span> android-arm64 <span class="hljs-attr">--analyze-size</span>
</code></pre>
<h2 data-id="heading-43">性能优化检查清单</h2>
<p><strong>每个页面发布前检查</strong>：</p>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 使用了 const 构造函数</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 避免在 build 中创建对象</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 大列表使用了 .builder</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 图片指定了合适的尺寸</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 没有不必要的重建</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 动画使用了 RepaintBoundary</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 资源在 dispose 中释放</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 在 Profile 模式下测试过性能</li>
</ul>
<p><strong>性能指标参考</strong>：</p>
<ul>
<li>帧率：保持 60fps（或 120fps for 高刷屏）</li>
<li>卡顿：UI 线程不超过 16ms，Raster 线程不超过 16ms</li>
<li>内存：不出现明显泄漏，增长趋势平稳</li>
<li>启动时间：冷启动 &lt; 3秒，热启动 &lt; 1秒</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[京东金融鸿蒙端部署AI超分模型实践]]></title>    <link>https://juejin.cn/post/7586877892467277851</link>    <guid>https://juejin.cn/post/7586877892467277851</guid>    <pubDate>2025-12-23T10:11:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586877892467277851" data-draft-id="7586865729702920230" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="京东金融鸿蒙端部署AI超分模型实践"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-12-23T10:11:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            京东金融鸿蒙端部署AI超分模型实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T10:11:17.000Z" title="Tue Dec 23 2025 10:11:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>1. 背景</strong></h2>
<p><strong>这可能是全网第一篇完整讲解鸿蒙端使用CANN部署AI模型的文章, 满满干货。</strong></p>
<p>社区作为用户交流、信息传递的核心载体，图片内容（如理财产品截图、投资经验分享配图、用户互动评论图片等）的展示质量直接影响用户的信息获取效率与平台信任感。从京东金融App社区的业务需求来看，当前用户上传图片普遍存在多样性失真问题：部分用户通过老旧设备拍摄的图片分辨率较低，部分用户为节省流量选择低画质压缩上传，还有部分截图类内容因原始来源清晰度不足导致信息模糊（如理财产品收益率数字、合同条款细节等），这些问题不仅降低了内容可读性，还可能因信息传递不清晰引发用户误解。</p>
<p>京东金融App团队已完成Real-ESRGAN-General-x4v3超分辨率模型在安卓端的部署，能够针对性提升评论区、内容详情页、个人主页等核心场景的图片清晰度，从视觉体验层面优化用户留存与互动意愿。</p>
<p>ESRGAN-General-x4v3模型在安卓端的部署，采用的是ONNX框架，该方案已有大量公开资料可参考，且取得显著业务成效。但鸿蒙端部署面临核心技术瓶颈：鸿蒙系统不支持ONNX框架，部署端侧AI仅能使用华为自研的CANN（Compute Architecture for Neural Networks）架构，且当前行业内缺乏基于CANN部署端侧AI的公开资料与成熟方案，全程需技术团队自主探索。接下来我会以ESRGAN-General-x4v3为例, 分享从模型转换(NPU亲和性改造)到端侧离线模型部署的全部过程。</p>
<h2 data-id="heading-1"><strong>2. 部署前期准备</strong></h2>
<h3 data-id="heading-2"><strong>2.1 离线模型转换</strong></h3>
<p>CANN Kit当前仅支持Caffe、TensorFlow、ONNX和MindSpore模型转换为离线模型，其他格式的模型需要开发者自行转换为CANN Kit支持的模型格式。模型转换为OM离线模型，移动端AI程序直接读取离线模型进行推理。</p>
<h4 data-id="heading-3"><strong>2.1.1 下载CANN工具</strong></h4>
<p>从鸿蒙开发者官网下载 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcontentcenter-vali-drcn.dbankcdn.cn%2Fpvt_2%2FDeveloperAlliance_package_901_9%2Fc0%2Fv3%2FEvg84kYpQlOkQvRT-Th0tw%2FDDK-tools-next-5.1.1.1.zip%3FHW-CC-KV%3DV1%26HW-CC-Date%3D20251015T082207Z%26HW-CC-Expire%3D315360000%26HW-CC-Sign%3D8D8CE92B39E6A5353B8A43EB6779C1D79C346C40776F2242593CBD751BE87EE4" target="_blank" title="https://contentcenter-vali-drcn.dbankcdn.cn/pvt_2/DeveloperAlliance_package_901_9/c0/v3/Evg84kYpQlOkQvRT-Th0tw/DDK-tools-next-5.1.1.1.zip?HW-CC-KV=V1&amp;HW-CC-Date=20251015T082207Z&amp;HW-CC-Expire=315360000&amp;HW-CC-Sign=8D8CE92B39E6A5353B8A43EB6779C1D79C346C40776F2242593CBD751BE87EE4" ref="nofollow noopener noreferrer">DDK-tools-5.1.1.1 </a>, 解压使用Tools下的OMG工具，将ONNX、TensorFlow模型转换为OM模型。(OMG工具位于Tools下载的tools/tools_omg下，<strong>仅可运行在64位Linux平台上</strong>。)</p>
<p>﻿</p>
<h4 data-id="heading-4"><strong>2.1.2 下载ESRGAN-General-x4v3模型文件</strong></h4>
<p>从<a href="https://link.juejin.cn?target=https%3A%2F%2Faihub.qualcomm.com%2Fcompute%2Fmodels%2Freal_esrgan_general_x4v3" target="_blank" title="https://aihub.qualcomm.com/compute/models/real_esrgan_general_x4v3" ref="nofollow noopener noreferrer">aihub.qualcomm.com/compute/mod…</a>下载模型的onnx文件.</p>
<p>注意: 下载链接中的a8a8的量化模型使用了高通的算子(亲测无法转换), CANN工具无法进行转换, 因此请下载float的量化模型。</p>
<p><strong>下载后有两个文件:</strong></p>
<p>•model.onnx文件 (模型结构): 包含计算图、opset版本、节点配置等，文件较小。</p>
<p>•model.data文件 (权重数据): 包含神经网络参数、权重等，文件较大。</p>
<p>现在我们需要把这种分离文件格式的模型合并成一个文件,后续的操作都使用这个。</p>
<p><strong>合并文件:</strong></p>
<p>请使用JoyCode写个合并脚本即可, 提示词: 请写一个脚本, 把onnx模型文件的.onnx和.data文件合并。</p>
<h4 data-id="heading-5"><strong>2.1.3 OM模型转换</strong></h4>
<p><strong>1. ONNX opset 版本转换</strong></p>
<p>当前使用CANN进行模型转换, 支持ONNX opset版本7~18（最高支持到V1.13.1）, 首先需要查看原始的onnx模型的opset版本是否在支持范围, 这里我们使用<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flutzroeder%2Fnetron%2Ftags" target="_blank" title="https://github.com/lutzroeder/netron/tags" ref="nofollow noopener noreferrer">Netron</a>(点击下载)可视化工具进行查看。</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de53c34107d842da95851d71bc1915d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089477&amp;x-signature=GTZxPGBS3O3%2FeUQCZKdolPJZiyI%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<p>目前该模型使用的opset版本是20, 因此我们需要把该模型的opset版本转成18, 才可以用CANN转换成鸿蒙上可部署的模型。请使用JoyCode写个opset转换脚本即可, 提示词: 请写一个脚本, 把onnx模型文件的opset版本从20转换成18。</p>
<p>﻿</p>
<p><strong>2. OM离线模型</strong>****</p>
<p>命令行中的参数说明请参见<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides%2Fcannkit-overall-parameter" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-overall-parameter" ref="nofollow noopener noreferrer">OMG参数</a>，转换命令：</p>
<pre><code class="hljs language-css" lang="css">./tools/tools_omg/omg <span class="hljs-attr">--model</span> new_model_opset18<span class="hljs-selector-class">.onnx</span> <span class="hljs-attr">--framework</span> <span class="hljs-number">5</span> <span class="hljs-attr">--output</span> ./model
</code></pre>
<p>转换完成后, 生成model.om的模型文件, 该模型文件就是鸿蒙上可以正常使用的模型文件</p>
<h3 data-id="heading-6"><strong>2.2 查看模型的输入/输出张量信息</strong></h3>
<p>部署AI模式时, 我们需要确认模型的输入张量和输出张量信息, 请使用JoyCode编写一个脚本, 确定输入输出张量信息, 提示词: 写一个脚本查看onnx模型的输入输出张量信息。</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e07ceb9dcfc04f71a9cf179cf399ffb4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089477&amp;x-signature=OaBgcmN8vLYLQUhTU0GiR1jqx6E%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<h4 data-id="heading-7"><strong>2.2.1 输入张量</strong></h4>
<p>BCHW格式, 是深度学习中常见的张量维度排列格式, 在图像处理场景中:</p>
<p>•B (Batch): 批次大小 - 一次处理多少个样本。</p>
<p>•C (Channel): 通道数 - 图像的颜色通道数。</p>
<p>•H (Height): 高度 - 图像的像素高度。</p>
<p>•W (Width): 宽度 - 图像的像素宽度。</p>
<p>由此可以得出结论, 该模型1个批次处理1张宽高为128*128的RGB图片(因为C是3,因此不包含R通道)。</p>
<p>﻿</p>
<h4 data-id="heading-8"><strong>2.2.2 输出张量</strong></h4>
<p>该模型1个批次输出1张宽高为512*512的RGB图片。</p>
<p>﻿</p>
<h4 data-id="heading-9"><strong>2.2.3 BCHW和BHWC格式的区别:</strong></h4>
<p>超分模型中的BCHW和BHWC是两种不同的张量存储格式，主要区别在于通道维度的位置：</p>
<p>﻿</p>
<p>•<strong>BCHW格式（Batch-Channel-Height-Width）</strong></p>
<p>◦维度顺序：[批次, 通道, 高度, 宽度]</p>
<p>◦内存布局：通道维度在空间维度之前</p>
<p>◦常用框架：PyTorch、TensorRT等</p>
<p>示例: 形状为 (1, 3, 256, 256) 的RGB图像</p>
<p><strong>内存中的存储顺序：</strong> R通道的所有像素 -&gt; G通道的所有像素 -&gt; B通道的所有像素</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">tensor_bchw</span> = torch.randn(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">256</span>, <span class="hljs-number">256</span>)
访问第一个像素的RGB值需要跨越不同的内存区域
<span class="hljs-attr">pixel_0_0_r</span> = tensor_bchw[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]  <span class="hljs-comment"># R通道</span>
<span class="hljs-attr">pixel_0_0_g</span> = tensor_bchw[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]  <span class="hljs-comment"># G通道  </span>
<span class="hljs-attr">pixel_0_0_b</span> = tensor_bchw[<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]  <span class="hljs-comment"># B通道</span>
</code></pre>
<p>•<strong>BHWC格式（Batch-Height-Width-Channel）</strong></p>
<p>◦维度顺序：[批次, 高度, 宽度, 通道]</p>
<p>◦内存布局：通道维度在最后，像素的所有通道连续存储</p>
<p>◦常用框架：TensorFlow、OpenCV等</p>
<p>示例：形状为 (1, 256, 256, 3) 的RGB图像</p>
<p>内存中的存储顺序：像素(0,0)的RGB -&gt; 像素(0,1)的RGB -&gt; ... -&gt; 像素(0,255)的RGB -&gt; 像素(1,0)的RGB...</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">tensor_bhwc</span> = tf.random.normal([<span class="hljs-number">1</span>, <span class="hljs-number">256</span>, <span class="hljs-number">256</span>, <span class="hljs-number">3</span>])
<span class="hljs-comment"># 访问第一个像素的RGB值在连续的内存位置</span>
<span class="hljs-attr">pixel_0_0_rgb</span> = tensor_bhwc[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, :]  <span class="hljs-comment"># [R, G, B]</span>
</code></pre>
<p>﻿</p>
<h2 data-id="heading-10"><strong>3. 鸿蒙端部署核心步骤</strong></h2>
<h3 data-id="heading-11"><strong>3.1 创建项目</strong></h3>
<p>1.创建DevEco Studio项目，选择“Native C++”模板，点击“Next”。</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46f2d4161ef44984881401020f6a30fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089477&amp;x-signature=FO4ZXb3ysjT2qkzUpotPqVcQOaM%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<p>2.按需填写“Project name”、“Save location”和“Module name”，选择“Compile SDK”为“5.1.0(18)”及以上版本，点击“Finish”。</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c8bac1d934c44b7b3daff85617fbb4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089477&amp;x-signature=P6mxqs%2BLOWtEY%2BGaMsH5jxAlfrQ%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<h3 data-id="heading-12"><strong>3.2 配置项目NAPI</strong></h3>
<p>CANN部署只提供了C++接口, 因此需要使用NAPI, 编译HAP时，NAPI层的so需要编译依赖NDK中的libneural_network_core.so和libhiai_foundation.so。</p>
<p>﻿</p>
<p><strong>头文件引用</strong></p>
<p>按需引用NNCore和CANN Kit的头文件。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"neural_network_runtime/neural_network_core.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"CANNKit/hiai_options.h"</span></span>
</code></pre>
<p><strong>编写CMakeLists.txt</strong></p>
<p>CMakeLists.txt示例代码如下。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">cmake_minimum_required</span>(VERSION <span class="hljs-number">3.5</span>.<span class="hljs-number">0</span>)
<span class="hljs-built_in">project</span>(myNpmLib)

<span class="hljs-built_in">set</span>(NATIVERENDER_ROOT_PATH ${CMAKE_CURRENT_SOURCE_DIR})

<span class="hljs-built_in">include_directories</span>(${NATIVERENDER_ROOT_PATH}
                    ${NATIVERENDER_ROOT_PATH}/include)

<span class="hljs-built_in">include_directories</span>(${HMOS_SDK_NATIVE}/sysroot/usr/lib)
<span class="hljs-built_in">FIND_LIBRARY</span>(cann-lib hiai_foundation)

<span class="hljs-built_in">add_library</span>(imagesr SHARED HIAIModelManager.cpp ImageSuperResolution.cpp)
<span class="hljs-built_in">target_link_libraries</span>(imagesr PUBLIC libace_napi.z.so
    libhilog_ndk.z.so
    librawfile.z.so
    ${cann-lib}
    libneural_network_core.so
    )
</code></pre>
<h3 data-id="heading-13"><strong>3.3 集成模型</strong></h3>
<p>模型的加载、编译和推理主要是在native层实现，应用层主要作为数据传递和展示作用。模型推理之前需要对输入数据进行预处理以匹配模型的输入，同样对于模型的输出也需要做处理获取自己期望的结果</p>
<p>﻿</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb2af561a0954b37802f76a57a72b5a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089477&amp;x-signature=llwQdjDQLIDuprCBEFSSf29%2FQU8%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<h4 data-id="heading-14"><strong>3.3.1 加载离线模型</strong></h4>
<p>为了让App运行时能够读取到模型文件和处理推理结果，需要先把离线模型和模型对应的结果标签文件预置到工程的“entry/src/main/resources/rawfile”目录中。</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3e78a1905514c80af05ac4bbd3c9411~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089477&amp;x-signature=UB4r11wWFJskohWLsZSQ3QNlSfs%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<p>在App应用创建时加载模型:</p>
<p>1.native层读取模型的buffer。</p>
<pre><code class="hljs language-ini" lang="ini">const char* <span class="hljs-attr">modelPath</span> = <span class="hljs-string">"imagesr.om"</span><span class="hljs-comment">;</span>
RawFile *<span class="hljs-attr">rawFile</span> = OH_ResourceManager_OpenRawFile(resourceMgr, modelPath)<span class="hljs-comment">;</span>
long <span class="hljs-attr">modelSize</span> = OH_ResourceManager_GetRawFileSize(rawFile)<span class="hljs-comment">;</span>
std::unique_ptr&lt;uint8_t<span class="hljs-section">[]</span>&gt; <span class="hljs-attr">modelData</span> = std::make_unique&lt;uint8_t[]&gt;(modelSize)<span class="hljs-comment">;</span>
int <span class="hljs-attr">res</span> = OH_ResourceManager_ReadRawFile(rawFile, modelData.get(), modelSize)<span class="hljs-comment">;</span>
</code></pre>
<p>2.使用模型的buffer, 调用OH_NNCompilation_ConstructWithOfflineModelBuffer创建模型的编译实例</p>
<pre><code class="hljs language-ini" lang="ini">HiAI_Compatibility <span class="hljs-attr">compibility</span> = HMS_HiAICompatibility_CheckFromBuffer(modelData, modelSize)<span class="hljs-comment">;</span>
OH_NNCompilation *<span class="hljs-attr">compilation</span> = OH_NNCompilation_ConstructWith<span class="hljs-literal">Off</span>lineModelBuffer(modelData, modelSize)<span class="hljs-comment">;</span>
</code></pre>
<p>3.（可选）根据需要调用HMS_HiAIOptions_SetOmOptions接口，打开维测功能（如Profiling）。</p>
<pre><code class="hljs language-ini" lang="ini">const char *<span class="hljs-attr">out_path</span> = <span class="hljs-string">"/data/storage/el2/base/haps/entry/files"</span><span class="hljs-comment">;</span>
HiAI_OmType <span class="hljs-attr">omType</span> = HIAI_OM_TYPE_PROFILING<span class="hljs-comment">;</span>
OH_NN_ReturnCode <span class="hljs-attr">ret</span> = HMS_HiAIOptions_SetOmOptions(compilation, omType, out_path)<span class="hljs-comment">;     </span>
</code></pre>
<p>4.设置模型的deviceID。</p>
<pre><code class="hljs language-ini" lang="ini">size_t <span class="hljs-attr">deviceID</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
const size_t *<span class="hljs-attr">allDevicesID</span> = nullptr<span class="hljs-comment">;</span>
uint32_t <span class="hljs-attr">deviceCount</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
OH_NN_ReturnCode <span class="hljs-attr">ret</span> = OH_NNDevice_GetAllDevicesID(&amp;allDevicesID, &amp;deviceCount)<span class="hljs-comment">;</span>

for (uint32_t <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; deviceCount; i++) {</span>
    const char *<span class="hljs-attr">name</span> = nullptr<span class="hljs-comment">;</span>
    <span class="hljs-attr">ret</span> = OH_NNDevice_GetName(allDevicesID[i], &amp;name)<span class="hljs-comment">;</span>
    if (ret != OH_NN_SUCCESS || <span class="hljs-attr">name</span> == nullptr) {
        OH_LOG_ERROR(LOG_APP, "OH_NNDevice_GetName failed")<span class="hljs-comment">;</span>
        return deviceID<span class="hljs-comment">;</span>
    }
    if (std::string(name) == "HIAI_F") {
        <span class="hljs-attr">deviceID</span> = allDevicesID[i]<span class="hljs-comment">;</span>
        break<span class="hljs-comment">;</span>
    }
}

<span class="hljs-attr">ret</span> = OH_NNCompilation_SetDevice(compilation, deviceID)<span class="hljs-comment">;</span>
</code></pre>
<p>5.调用OH_NNCompilation_Build，执行模型编译。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">ret</span> = SetModelBuildOptions(compilation)<span class="hljs-comment">;</span>
<span class="hljs-attr">ret</span> = OH_NNCompilation_Build(compilation)<span class="hljs-comment">;</span>
</code></pre>
<p>6.调用OH_NNExecutor_Construct，创建模型执行器。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">executor_</span> = OH_NNExecutor_Construct(compilation)<span class="hljs-comment">;</span>
</code></pre>
<p>7.调用OH_NNCompilation_Destroy，释放模型编译实例。</p>
<p>﻿</p>
<h4 data-id="heading-15"><strong>3.3.2 准备输入输出****Tensor</strong></h4>
<p>1.处理模型的输入，模型的输入为1<em>3</em>128*128格式(BCHW) Float类型的数据, 需要把RGB 数据转成BCHW格式并进行归一化。</p>
<pre><code class="hljs language-ini" lang="ini">从图片中读取的RGB数据为BHWC,需要转换成模型可以识别的BCHW
/**
 * 把bhwc转成bchw
 */
uint8_t *<span class="hljs-attr">rgbData</span> = static_cast&lt;uint8_t*&gt;(data)<span class="hljs-comment">;</span>
uint8_t *<span class="hljs-attr">floatData_tmp</span> = new uint8_t[length]<span class="hljs-comment">;</span>
for (int <span class="hljs-attr">c</span> = <span class="hljs-number">0</span><span class="hljs-comment">; c &lt; 3; ++c) {</span>
    for (int <span class="hljs-attr">h</span> = <span class="hljs-number">0</span><span class="hljs-comment">; h &lt; 128; ++h) {</span>
        for (int <span class="hljs-attr">w</span> = <span class="hljs-number">0</span><span class="hljs-comment">; w &lt; 128; ++w) {</span>
            // HWC 索引: h * width * channels + w * channels +c 
            int <span class="hljs-attr">hwc_index</span> = h * <span class="hljs-number">128</span> * <span class="hljs-number">3</span> + w * <span class="hljs-number">3</span> + c<span class="hljs-comment">;</span>
            // CHW 索引: C * height * width + h* width + W
            int <span class="hljs-attr">chw_index</span> = c * <span class="hljs-number">128</span> * <span class="hljs-number">128</span> + h * <span class="hljs-number">128</span> + w<span class="hljs-comment">;</span>
            floatData_tmp<span class="hljs-section">[chw_index]</span> = rgbData<span class="hljs-section">[hwc_index]</span><span class="hljs-comment">;</span>
        }
    }
}
//归一化
float *<span class="hljs-attr">floatData</span> = new float[length]<span class="hljs-comment">;</span>
for (size_t <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; length; ++i) {</span>
    floatData<span class="hljs-section">[i]</span> = static_cast&lt;float&gt;(floatData_tmp<span class="hljs-section">[i]</span>)/ 255.0f<span class="hljs-comment">;</span>
}
</code></pre>
<p>2.创建模型的输入和输出Tensor，并把应用层传递的数据填充到输入的Tensor中</p>
<pre><code class="hljs language-ini" lang="ini">// 准备输入张量
size_t <span class="hljs-attr">inputCount</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
OH_NN_ReturnCode <span class="hljs-attr">ret</span> = OH_NNExecutor_GetInputCount(executor_, &amp;inputCount)<span class="hljs-comment">;</span>
for (size_t <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; inputCount; ++i) {</span>
    NN_TensorDesc *<span class="hljs-attr">tensorDesc</span> = OH_NNExecutor_CreateInputTensorDesc(executor_, i)<span class="hljs-comment">;</span>
    NN_Tensor *<span class="hljs-attr">tensor</span> = OH_NNTensor_Create(deviceID_, tensorDesc)<span class="hljs-comment">;</span>
    if (tensor != nullptr) {
        inputTensors_.push_back(tensor)<span class="hljs-comment">;</span>
    }
    OH_NNTensorDesc_Destroy(&amp;tensorDesc)<span class="hljs-comment">;</span>
}


<span class="hljs-attr">ret</span> = SetInputTensorData(inputTensors_, inputData)<span class="hljs-comment">;</span>

// 准备输出张量
size_t <span class="hljs-attr">outputCount</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
<span class="hljs-attr">ret</span> = OH_NNExecutor_GetOutputCount(executor_, &amp;outputCount)<span class="hljs-comment">;</span>

for (size_t <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; outputCount; i++) {</span>
    NN_TensorDesc *<span class="hljs-attr">tensorDesc</span> = OH_NNExecutor_CreateOutputTensorDesc(executor_, i)<span class="hljs-comment">;</span>
    NN_Tensor *<span class="hljs-attr">tensor</span> = OH_NNTensor_Create(deviceID_, tensorDesc)<span class="hljs-comment">;</span>
    if (tensor != nullptr) {
        outputTensors_.push_back(tensor)<span class="hljs-comment">;</span>
    }
    OH_NNTensorDesc_Destroy(&amp;tensorDesc)<span class="hljs-comment">;</span>
}
if (outputTensors_.size() != outputCount) {
    DestroyTensors(inputTensors_)<span class="hljs-comment">;</span>
    DestroyTensors(outputTensors_)<span class="hljs-comment">;</span>
    OH_LOG_ERROR(LOG_APP, "output size mismatch.")<span class="hljs-comment">;</span>
    return OH_NN_FAILED<span class="hljs-comment">;</span>
}
</code></pre>
<p>﻿</p>
<h4 data-id="heading-16"><strong>3.3.3 进行推理</strong></h4>
<p>调用OH_NNExecutor_RunSync，完成模型的同步推理。</p>
<pre><code class="hljs language-scss" lang="scss">OH_NN_ReturnCode ret = <span class="hljs-built_in">OH_NNExecutor_RunSync</span>(executor_, inputTensors_.data(), inputTensors_<span class="hljs-selector-class">.size</span>(),
                                                 outputTensors_<span class="hljs-selector-class">.data</span>(), outputTensors_<span class="hljs-selector-class">.size</span>());
</code></pre>
<p>说明</p>
<p>•如果不更换模型，则首次编译加载完成后可多次推理，即一次编译加载，多次推理。</p>
<p>•所有关于模型的操作, 均无法多线程执行。</p>
<p>﻿</p>
<h4 data-id="heading-17"><strong>3.3.4 获取模型输出并处理数据</strong></h4>
<p>1.调用OH_NNTensor_GetDataBuffer，获取输出的Tensor，在输出Tensor中会得到模型的输出数据。</p>
<pre><code class="hljs language-ini" lang="ini">// 获取第一个输出张量
NN_Tensor* <span class="hljs-attr">tensor</span> = outputTensors_[<span class="hljs-number">0</span>]<span class="hljs-comment">;</span>

// 获取张量数据缓冲区
void *<span class="hljs-attr">tensorData</span> = OH_NNTensor_GetDataBuffer(tensor)<span class="hljs-comment">;</span>

// 获取张量大小
size_t <span class="hljs-attr">size</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
OH_NN_ReturnCode <span class="hljs-attr">ret</span> = OH_NNTensor_GetSize(tensor, &amp;size)<span class="hljs-comment">;</span>

float *<span class="hljs-attr">tensorDataOutput</span> = (float*)malloc(size)<span class="hljs-comment">;</span>
// 将tensorData的数据一次性复制到tensorDataOutput中
memcpy(tensorDataOutput, tensorData, size)<span class="hljs-comment">;</span>
</code></pre>
<p>﻿</p>
<p>2.对Tensor输出数据进行相应的处理</p>
<p>把模型输出的BCHW转成BHWC, 并进行反归一化处理</p>
<p>﻿</p>
<pre><code class="hljs language-ini" lang="ini">//把模型输出的BCHW转成BHWC
float *<span class="hljs-attr">outputResult</span> = static_cast&lt;float *&gt;(tensorData)<span class="hljs-comment">;</span>
float *<span class="hljs-attr">output_tmp</span> = new float[size/sizeof(float)]<span class="hljs-comment">;</span>
for (int <span class="hljs-attr">h</span> = <span class="hljs-number">0</span><span class="hljs-comment">; h &lt; 512; ++h) {</span>
    for (int <span class="hljs-attr">w</span> = <span class="hljs-number">0</span><span class="hljs-comment">; w &lt; 512; ++w) {</span>
        for (int <span class="hljs-attr">c</span> = <span class="hljs-number">0</span><span class="hljs-comment">; c &lt; 3; ++c) {</span>
            output_tmp<span class="hljs-section">[h * 512 * 3 + w* 3 + c]</span> = outputResult<span class="hljs-section">[c * 512 * 512 + h * 512 + w]</span><span class="hljs-comment">;</span>
        }
    }
}
std::vector&lt;float&gt; output(size / sizeof(float), 0.0)<span class="hljs-comment">;</span>
for (size_t <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; size / sizeof(float); ++i) {</span>
    output<span class="hljs-section">[i]</span> = output_tmp<span class="hljs-section">[i]</span><span class="hljs-comment">;</span>
}
delete <span class="hljs-section">[]</span> output_tmp<span class="hljs-comment">;</span>


 // 计算总的数据大小
size_t <span class="hljs-attr">totalSize</span> = output.size()<span class="hljs-comment">;</span>

// 分配结果数据内存
std::unique_ptr&lt;uint8_t<span class="hljs-section">[]</span>&gt; <span class="hljs-attr">result_data</span> = std::make_unique&lt;uint8_t[]&gt;(totalSize)<span class="hljs-comment">;</span>

// 将float数据转换为uint8_t (反归一化)
size_t <span class="hljs-attr">index</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
for (float value : result) {
    // 将float值转换为uint8_t (0-255范围)
    float <span class="hljs-attr">scaledValue</span> = value * <span class="hljs-number">255.0</span>f<span class="hljs-comment">;</span>
    <span class="hljs-attr">scaledValue</span> = std::max(<span class="hljs-number">0.0</span>f, std::min(<span class="hljs-number">255.0</span>f, scaledValue))<span class="hljs-comment">;</span>
    result_data<span class="hljs-section">[index++]</span> = static_cast&lt;uint8_t&gt;(scaledValue)<span class="hljs-comment">;</span>
}

result_data 就是最终的超分数据,可以正常显示
</code></pre>
<p>﻿</p>
<h2 data-id="heading-18"><strong>4. 总结与技术展望</strong></h2>
<p>京东金融App在鸿蒙端部署Real-ESRGAN-General-x4v3超分辨率模型的完整实践过程，成功解决了ONNX模型到OM离线模型转换、BCHW与BHWC张量格式处理、以及基于CANN Kit和NAPI的完整部署链路等关键技术难题。</p>
<p>展望端智能的未来发展，随着芯片算力的指数级增长、模型压缩技术的突破性进展以及边缘计算架构的日趋成熟，端侧设备将从单纯的数据采集终端演进为具备强大推理能力的智能计算节点，通过实现多模态AI融合、实时个性化学习、隐私保护计算和跨设备协同等核心能力，将大语言模型、计算机视觉、语音识别等AI技术深度集成到移动设备中，构建起无需联网即可提供智能服务的自主计算生态，推动人机交互从被动响应向主动感知、预测和服务的范式转变，最终开启真正意义上的普惠人工智能时代。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【前瞻技术布局】咖啡机器人：具身智能技术首阶段探索与实践]]></title>    <link>https://juejin.cn/post/7586872817875402778</link>    <guid>https://juejin.cn/post/7586872817875402778</guid>    <pubDate>2025-12-23T10:13:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586872817875402778" data-draft-id="7586872817875386394" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【前瞻技术布局】咖啡机器人：具身智能技术首阶段探索与实践"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-12-23T10:13:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【前瞻技术布局】咖啡机器人：具身智能技术首阶段探索与实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T10:13:44.000Z" title="Tue Dec 23 2025 10:13:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、前言</h2>
<p>我是一名京东具身智能算法团队的研究人员，目前，主要专注在<strong>真实场景真实机器人</strong>下打造一套<strong>快速落地新场景的具身智能技术架构</strong>，聚集机器人操作泛化能力提升，涉及模仿/强化学习、“视觉-语言-动作”大模型等方法研究。本文主要以第一阶段<strong>咖啡机器人</strong>任务场景为切入点，来阐述所取得的技术突破，以及后续技术优化方向。如下是机器人全程自主完成打咖啡的视频。</p>
<h2 data-id="heading-1">二、问题定义和路径选择</h2>
<p>具身智能，指的是配备实体身躯、支持物理交互的智能体所展现出的智能形态。凭借这一智能形式，机器人及其他智能设备得以在复杂多变的现实世界中执行各类任务。然而，鉴于任务的复杂性以及操作所呈现出的高难度与多样性，具身智能技术遭遇诸多挑战，当前仍处于持续发展阶段。现阶段，多数具身智能研究仅在<strong>实验室或结构化场景中</strong>开展，很难将成果迁移至真实场景加以应用。究其根源，理想环境屏蔽了诸多在真实场景中才会暴露的问题。有鉴于此，我将研究重心聚焦于<strong>真实场景下的具身智能技术突破</strong>，同时，为推动具身智能技术广泛赋能多元业务，着力打造一套能够<strong>快速适配新场景的具身智能技术架构</strong>。</p>
<p>目前，具身操作是具身智能核心技术卡点，其技术路线粗分为<strong>预测机器人操作动作</strong>与<strong>预测物体抓取位姿</strong>。前者泛化性弱且依赖大量专家数据，后者难适用于复杂长序列任务，灵巧手位姿也难获取。鉴于此，创建了技术上<strong>乘上启下“末端模仿” 新路径</strong>，融合两者优势，包括<strong>预测预抓取位姿</strong>（易实现、泛化性强）与<strong>统一操作轨迹学习</strong>（减少专家数据依赖、操作灵巧），且该路径可灵活扩展为 “视觉 - 语言 - 动作” 大模型方法。</p>
<h2 data-id="heading-2">三、快速落地新场景技术架构打造</h2>
<p>在当今快速变化的技术环境中，集团会面临着不断适应新业务场景的挑战。只能适应单一场景的具身智能技术不具备长期价值，而能够快速落地新场景的具身智能技术则至关重要。因此，针对于真实场景下机器人打咖啡任务，打造了一套快速落地新场景的技术架构<strong>原型</strong>，并取得了关键技术突破。</p>
<h3 data-id="heading-3">1、关键技术突破及价值</h3>
<h4 data-id="heading-4">1）真实场景下从0到1打造具身智能系统技术架构</h4>
<ul>
<li><strong>面临挑战</strong>：具身智能系统往往涉及内容模块较多，耦合关系较为复杂，可扩展性较差，难以快速适应新任务场景。与此同时，真实场景下，往往面临着通信时延、模型推理速度和系统稳定性等挑战。</li>
<li><strong>技术突破</strong>：如下图所示，打造了一套具备<strong>高扩展性</strong>的具身智能系统技术架构，只需定义<strong>合适的子任务序列</strong>就可落地新场景。其中，该系统以<strong>ROS系统</strong>为基础构建，整个流程通过主调度模块进行协调，确保各模块之间的协同工作，通过不同控制模式决定系统不同阶段的工作方式，包括导航、感知、基于Agent的任务规划、遥操、具身操作等。此外，设计了模型异步推理、GRPC协议数据传输和子母路由通信等机制来攻克通信时延、推理速度慢等问题。</li>
<li><strong>核心价值</strong>：在真实场景下，从<strong>0到1打造了整套具身智能系统技术架构</strong>，并且<strong>成功落地咖啡机器人任务场景</strong>中，而不是在简单的实验室或者结构化场景下。与此同时，为后续真实场景下具身智能技术的研发提供了<strong>坚实的基础</strong>。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b02253d41164017a0172efd1e9bd843~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089624&amp;x-signature=zON%2FHei2%2B46dKW50pzuvwhtDWb8%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-5">2）面向双臂灵巧手构建高频率一体式遥操技术</h4>
<ul>
<li><strong>面临挑战</strong>：目前，大多数遥操采用了同构方式。这种方式需要额外配置相应的机械臂，并且不同结构机器人是无法共享，可扩展性及便捷性低。其次，双臂和灵巧手的一体式遥操技术对其同步性及延迟率要求高，实现难度大。</li>
<li><strong>技术突破</strong>：如以下视频所示，构建了<strong>面向双臂灵巧手的一体式高频率遥操技术</strong>。通过结合<strong>惯性动捕</strong>和<strong>视觉动捕</strong>技术，对遥操设备进行了创新设计，使机器人能够精准复刻人类动作。同时，借助<strong>手和臂数据透传技术</strong>，优化了从动作捕捉到控制执行的高频率跟随链路，极大提升了系统响应速度与操作精度。</li>
<li><strong>核心价值</strong>：相比于行业其他遥操技术，该技术具备<strong>轻量化</strong>、<strong>价格低廉</strong>和<strong>扩展性强</strong>特点。此外，通过该遥操技术，双臂灵巧手的整体控制频率达<strong>50hz</strong>以上，并且系统延时在<strong>50ms</strong>以内。</li>
</ul>
<h4 data-id="heading-6">3）少量数据下实现物体位置的泛化操作</h4>
<ul>
<li><strong>面临挑战</strong>：具身操作的泛化性一直是一个挑战性问题。目前，大多数方法都依赖于大量数据使其涌现出泛化性能。然而，大量的示教数据需要消耗大量人力物力。训练模型也需较多计算资源的支撑，且效果也难以达到较佳的泛化性能。</li>
<li><strong>技术突破</strong>：如下图所示，提出了基于<strong>末端模仿的泛化操作方法</strong>，聚集于<strong>统一的操作轨迹学习</strong>，能在较少的数据下实现较强的位置泛化能力，涉及核心模块包括：<strong>操作物体感知与位姿估计</strong>、<strong>预操作位姿到达</strong>和<strong>聚集物体的策略学习</strong>。此外，设计了<strong>聚集于物体的视觉特征</strong>提取模块，增强对核心操作区域的感知。</li>
<li><strong>核心价值</strong>：相比与行业已有方法，首次提出聚集于<strong>核心操作轨迹</strong>的学习方法，能在较少数据量情况下实现物体位置的泛化操作，在打咖啡任务中，成功率<strong>达90%以上</strong>。此外，在大量抓取任务中（拿扫码枪、抓娃娃、搬箱子等等），该方法表现出的性能相比于baseline成功率<strong>提升了50%以上</strong>。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de04b425d526422bad7473e244ab627c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089624&amp;x-signature=Dcq78%2Fe4DYuNjBHPOAWdFxPqOBw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">2、咖啡机器人任务场景实践</h3>
<p>基于所打造的具身智能技术架构，首先落地了<strong>咖啡机器人</strong>任务场景。机器人打咖啡任务主要包含以下几个步骤：<strong>导航到咖啡机</strong>、<strong>拿起空杯子</strong>、<strong>放好杯子</strong>、<strong>点击屏幕</strong>（选择咖啡、确认按钮和已放好按钮）、<strong>拿起咖啡杯</strong>、<strong>导航到用户位置</strong>、<strong>将咖啡杯递给人</strong>。打咖啡任务是一个真实场景下的<strong>长序列任务</strong>，包含多个子任务。子任务都是按序列衔接好的，完成当前子任务才会执行下一个子任务。与此同时，设计了<strong>子任务是否成功完成的检测机制</strong>，提升整个系统的<strong>鲁棒性</strong>，比如：点击屏幕过程中，如果没有点击触发，会反复点击直到成功。即便面对打咖啡这样复杂的场景，凭借该具身智能技术架构打造的系统，仍能以极高的成功率完成任务。以下是机器人打咖啡的<strong>精彩瞬间</strong>。</p>















<table><thead><tr><th><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0381409b2064b36a783793d6a7c139d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089624&amp;x-signature=YnHLRytog4ywJwxClniADi89pY4%3D" alt="拿空杯子" loading="lazy"/>拿空杯子</th><th><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12dd036fe35542dfb4fe7fd15ca6f728~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089624&amp;x-signature=weLQjTOHkRUMGvIijdI8p9eibt4%3D" alt="拿空杯子" loading="lazy"/>放杯子</th><th><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56ee51ab7f8048f1ba81120fc2928793~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089624&amp;x-signature=C9qjfReUKd3cdDMHS6iUNFkP2Z0%3D" alt="拿空杯子" loading="lazy"/>选咖啡</th></tr></thead><tbody><tr><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd8d48bc8a0e46639d463378bf7a9f91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089624&amp;x-signature=w9A%2FtA6aCLpaDdX6jf7AI0sdusA%3D" alt="拿空杯子" loading="lazy"/>点击按钮</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45740e6694f64f42bc1fd3d2c89ccafe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089624&amp;x-signature=xhGOBuKWhs8NZl7dN2D2WVuINuA%3D" alt="拿空杯子" loading="lazy"/>拿咖啡杯</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/daeef9b122a2495bae43e5ca6251a369~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089624&amp;x-signature=QYaQx2LTsOqjBzxgICAi1Anp0qs%3D" alt="拿空杯子" loading="lazy"/>递送给人</td></tr></tbody></table>
<p>在咖啡机器人任务场景实践中，遇到诸多新问题。起初为机器人在胸部和头部各配备 RealSense D435 相机，却发现胸部相机易被机械臂遮挡，且两款相机 <strong>FOV 过小，常无法捕捉操作物体和灵巧手</strong>，而这类问题在<strong>实验室桌面操作场景中难以察觉</strong>。于是，将头部相机换成 FOV 更大的 ZED 相机，可新相机又导致<strong>模型视觉特征不聚集</strong>，遂通过聚焦手部局部视角解决。点击屏幕时，<strong>按钮需快速抽离动作才能触发</strong>，给灵巧手控制带来极大困难。为此设计检测机制，让灵巧手能反复尝试，有效提升了点击成功率。</p>
<h2 data-id="heading-8">四、下一步技术优化及进展</h2>
<p>后续，将进一步完善和优化整个具身智能系统架构，使其能快速落地新场景。核心聚集于<strong>具身操作方向，提升机器人的泛化操作能力，扩充其技能库的上限</strong>。结合具身技术<strong>发展趋势</strong>以及现有架构的<strong>不足</strong>，主要围绕以下两个方面开展工作。</p>
<ul>
<li><strong>“视觉-语言-动作”大模型促进快速落地新场景</strong>：“视觉-语言-动作”大模型会<strong>利用“视觉-语言”预训练模型知识</strong>来促进对机器人动作的学习。在大量的数据训练基础上，“视觉-语言-动作”大模型将会涌现出令人意想不到的能力：<strong>基于语言指令的新技能泛化</strong>、<strong>新物体泛化</strong>、甚至<strong>多机协作能力</strong>。这些潜能在Figure AI公司最新发布的Helix模型实验结果中已展现出来。</li>
<li><strong>真机强化学习优化整个具身智能系统</strong>：在目前的具身操作技术中，大多数采用了模仿学习方法。然而，<strong>模仿学习</strong>存在其<strong>局限性</strong>，较为<strong>依赖于专家数据</strong>，并且存在<strong>性能上限</strong>。<strong>强化学习</strong>方法则能使机器人探索更多数据，<strong>突破其性能上限</strong>，对专家数据<strong>依赖程度较低</strong>。另外，真机强化学习是基于机器人实时与环境交互所得数据来优化模型，这种优化不仅仅是提升模型性能，而且能够对<strong>整个具身系统进行优化</strong>。</li>
</ul>
<h2 data-id="heading-9">五、我对具身智能的思考和坚持</h2>
<ul>
<li>在具身智能技术的实际落地进程中，真实场景的复杂程度往往远远超出了在实验室或结构化场景中预先设定的界限。在<strong>真实任务场景中进行技术探索</strong>，不但有助于我们对算法的实际性能进行验证和优化，还能够发掘出<strong>在实验室或结构化场景中未曾预想到的问题与挑战</strong>。通过在真实场景中对技术进行测试和应用，我们能够获取更为丰富的数据和反馈，进而推动技术不断迭代和创新。</li>
<li>随着 Figure AI 公司发布的 Helix 模型并在物流仓库中的成功应用，这使我愈发坚信具身智能的时代已然降临。对其实现的技术逻辑进行剖析：重点围绕<strong>一个机器人本体</strong>，在一个特定的<strong>垂类领域中积累充足的数据量</strong>，<strong>在 “视觉 - 语言 - 动作” 大模型</strong>的有力支持下，机器人能够学会<strong>多种类人的技能</strong>，并且具有<strong>较强的泛化性能</strong>。其能够出圈的核心在于<strong>围绕一本体在真实场景下打磨技术</strong>。我认为这是实现快速落地的较佳方案，值得借鉴。此外，当前技术都围绕提升机器人任务成功率开展，若要真正将其在新场景中落地，还必须考虑机器人完成任务的<strong>效率问题</strong>。</li>
<li>展望未来，机器人会逐步融入人类社会。我们须倾<strong>热血</strong>与<strong>干劲</strong>，全力投身具身智能技术攻坚，力求让<strong>技术快速落地新场景</strong>，为企业<strong>技术增长添砖加瓦</strong>。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[DeepSeek 正当红，聊聊大模型应用的四大关键要素和未来]]></title>    <link>https://juejin.cn/post/7586872817875370010</link>    <guid>https://juejin.cn/post/7586872817875370010</guid>    <pubDate>2025-12-23T10:13:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586872817875370010" data-draft-id="7586703355646672923" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="DeepSeek 正当红，聊聊大模型应用的四大关键要素和未来"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-12-23T10:13:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            DeepSeek 正当红，聊聊大模型应用的四大关键要素和未来
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T10:13:15.000Z" title="Tue Dec 23 2025 10:13:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>大模型应用的春天来了。在人工智能的浪潮中，大模型正成为推动技术变革的核心力量。春节前，DeepSeek R1 的发布在全球范围内引发了巨大轰动，它不仅在性能上与 OpenAI 的模型不相上下，更凭借其基于 CoT（Chain of Thought）的推理过程，展现出强大的逻辑能力，同时，开源和低成本的优势，让众多企业迅速接入。DeepSeek 已然成为各行业关注的焦点，今年无疑是大模型应用爆发的关键一年。</p>
<h2 data-id="heading-1">一、大模型应用的爆发：为什么是2025？</h2>
<p>技术的发展并非一蹴而就，而是经历从萌芽到成熟，再到广泛应用的过程。20多年前的PC互联网和10多年前的移动互联网的兴起，都经历了这样的阶段，如今，从周期和技术成熟度来看，AI大模型也正站在爆发的前夜。</p>
<p>DeepSeek R1 的出现，不仅展示了大模型的强大能力，更以开源和低成本的姿态，为更多企业和开发者提供了平等的机会。短短一个多月，国内众多公司纷纷接入，甚至包括腾讯、阿里等行业巨头。这种现象表明，大模型的应用已经具备了广泛落地的基础，从金融风控到投资决策，从智能家居到医疗辅助，大模型的应用场景正在不断拓展。2025年，或许就是这场技术变革的“临界点”。</p>
<h2 data-id="heading-2">二、大模型的应用价值：不只是“通用聊天”</h2>
<p>很多人可能会问：既然 DeepSeek、ChatGPT 等聊天类App已经如此强大，为什么还要开发基于大模型的应用呢？原因主要有两个方面：一是通用聊天应用虽然灵活，但在很多专业领域，普通用户并不具备问正确问题的能力；二是大模型推理需要基于场景的相关数据，通用聊天工具从互联网搜索到的数据，可能不全或者不准确，在医疗、投资等大部分专业领域需要准确数据的场景，并不可靠。</p>
<p>在当下的技术发展阶段，大模型尚未真正具备智能，其核心价值在于卓越的数据处理能力。这种能力在众多专业领域中展现出巨大的潜力，能够显著提升工作效率。以医疗领域为例，大模型能够基于患者的病历、检查报告、生理数据等多维度信息，快速进行病情分析和辅助诊断，为医生提供精准的决策支持。在投资领域，它也能迅速获取市场动态数据，完成基本面与技术面的深度分析，为投资者提供科学的决策参考。这些应用场景充分证明，大模型的价值远不止于简单的“聊天”。</p>
<h2 data-id="heading-3">三、做好大模型应用的关键：四大要素</h2>
<p>过去两年，我们在积极探索大模型的应用过程中：从营销运营领域的热搜机器人、到 Coding 领域的 JoyCoder，金融科技领域从社区的热点话题生成、到基金/保险产品解读。DeepSeek R1 的出现，让我们更加意识到，目前的应用还非常初级，只是有，离好还有很大的差距和空间。基于过往的这些场景探索，大模型应用要取得更好的效果，我们认为需要综合考虑以下4大要素：好的效果 = 大模型 + 专业知识 + 知识库 + 工程架构。</p>
<h3 data-id="heading-4">（1）专业知识和交互设计：让大模型“容易使用”</h3>
<p>DeepSeek 等通用聊天类App虽然简单，但要用好的话往往需要用户具备专业知识，看似普惠，事实上门槛比较高，交互体验也不够便捷。例如在投资领域，普通用户可能并不知道该问什么问题，如果只是问“今天的市场行情怎么样，这只股票是买入还是卖出”，大模型并不能给出能赚到钱的答案。而稍有一些投资经验的人，可以问“分析一下沪深300指数的技术面，时间从2021年到现在，从形态、均线、趋势等看走势是反弹还是反转，并用MACD、背离、量能等交叉确认”等更复杂的问题。如果涉及到更具体买卖决策和调仓建议，可能需要更加深入和专业的问题。</p>
<p>此外，交互不够便捷也是一大问题。用户需要组织语言、打字输入，还要在聊天工具和具体的如券商的App之间来回切换，体验较差。今日头条等之所以能取代门户网站，正是因为其在交互上体验更好。因此，交互设计和专业知识的结合是大模型应用成功的关键，场景化的AI是探索的一个方向。</p>
<h3 data-id="heading-5">（2）领域知识库和搜索能力：让大模型“有据可依”</h3>
<p>问准确的问题还不够，还需要有充分的上下文信息以及准确获取的能力。首先，信息的及时、准确和丰富至关重要。大模型是神经网络，仿照大脑的原理构建，可以看作一个看完了互联网上所有数据的超级专家。就像让医生看病或操盘手交易，需要告知其“病情”或“行情”才能开展工作，信息越及时和全面，专家的决策就越准确、可靠。</p>
<p>DeepSeek App 虽然具有联网能力，能在回答问题前搜索相关信息，但搜索回来的数据可能存在问题，如数据过期或数据较少，导致推理结果不够准确。比如下图案例，做出推理结论而引用的数据4和6是过期的，导致看起来完美的推理逻辑也是无法用的。企业要想用好大模型，必须建立本地知识库，确保数据的数量和质量。在 DeepSeek 这类大模型开源后，算法已经平权，企业之间的竞争又回到了数据这个生产力要素。</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a69006c4f7374a5db454810ca94e50f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089595&amp;x-signature=MAYoWya5VmYSKTLCSziRV8e1%2Bf8%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<p>其次，高效准确地获取数据也极为关键。即使知识库建的很大、很丰富，搜索能力也至关重要，这是百度、谷歌等深耕多年的能力，技术门槛比较高，要做好并不容易。知识库本身的架构，访问权限设计，以及各种RAG技术，都极为关键。（图片来自于网络）</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f269a89b9590421ab3f3d6b901d1739f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089595&amp;x-signature=Z4nG6Lck4F%2FCmyrusR6Oo0ABZ64%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<h3 data-id="heading-6">（3）Agent架构与工程能力：让大模型“激发潜能”</h3>
<p>对于简单问题，大模型可以通过一轮对话给出答案；而对于复杂问题，如买一张去西藏的便宜机票，或判断中证A500指数基金什么时候买，则需要更加复杂的设计，如果能更好地组织和引导，类似于人类的头脑风暴和专家讨论，把多个专家的智力都激发出来，就有可能找到更好的解决方案。</p>
<p>大模型是一个待机的超级专家，提供简单的API供应用随时调用，如何面向大模型编程，激发其潜力需要研发人员的精心设计，目标是大模型成为真的“大脑”，取代原来预设的业务流程，策略引擎和流程编排工具，让应用具备自主智能。通过Agent架构，甚至多Agent（智能体）交互，可以引导大模型进行多轮交互和逻辑推理，从而获得更准确的结果，工具/MCP，记忆，规划、思维链、反思等架构和设计模式，需要持续探索应用。（图片来自于网络）</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8044a97b264446ebc724181142caf0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089595&amp;x-signature=ouQ0gzTXYd%2B%2B%2FcCtu%2BrhmtJp%2BtE%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<h3 data-id="heading-7">（4）大模型自身：“选择比拥有更重要”</h3>
<p>大模型是整个应用的核心部件，当然是最重要的。但从应用开发的角度来看，选择合适的大模型并灵活切换更为关键，应用系统的架构，需要更加灵活的支持多个大模型。DeepSeek R1的成功表明，大模型在持续的竞争和迭代，另外，不同大模型在不同领域的潜质也不一样，就像有些人擅长科学，有些擅长经商，有些擅长音乐，多Agent系统中，每个Agent可以使用不同的大模型。未来，大模型的市场竞争将更加激烈，选择比拥有更重要。</p>
<h2 data-id="heading-8">四、大模型的未来：探索与展望</h2>
<p>DeepSeek R1 是终点吗？当然不是。Transformer 是实现 AGI（通用人工智能）的终极算法架构吗？估计也不是。吴军、杨立琨、王兴兴等专家都曾提出过类似的观点：尽管Transformer架构在自然语言处理等领域取得了巨大突破，但它并非万能。未来仍有可能出现更强大的算法，推动人工智能迈向新的高度。</p>
<p>数据真的已经用完了吗？应该也不是。人类在学习和沉淀规律时，从来不仅仅是依赖过往的书本知识。从开普勒三大定律到牛顿力学，这些伟大的科学发现，都是通过对现实世界中的数据进行获取、分析和总结得出的。无论是日月星辰的运行轨迹，还是潮起潮落风云变幻，亦或是粒子撞击的微观过程，甚至是人类自身的脉搏跳动，只要通过摄像机、传感器等工具进行捕捉，就能从这些更广泛、更丰富的自然界获取数据。这些数据，或许将成为未来人工智能发展的重要“养料”，为模型的训练和优化提供新的思路和方向。</p>
<p>除了算法和数据，大模型的未来发展还需要强大的算力。量子计算或许是解决这一问题的关键方案。哦，还有能源问题，小时候看《变形金刚》，一直不理解他们为什么整天争夺“终极能源”，未来当硅基生命充满大地和天空的时候，能源问题或许将成为制约技术发展的关键瓶颈。</p>
<p>这一天，或许终将会到来。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[拿走200多万奖金的AI人才，到底给出了什么样的技术方案？]]></title>    <link>https://juejin.cn/post/7586865729702985766</link>    <guid>https://juejin.cn/post/7586865729702985766</guid>    <pubDate>2025-12-23T10:26:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586865729702985766" data-draft-id="7586836874016899082" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="拿走200多万奖金的AI人才，到底给出了什么样的技术方案？"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-12-23T10:26:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            拿走200多万奖金的AI人才，到底给出了什么样的技术方案？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T10:26:28.000Z" title="Tue Dec 23 2025 10:26:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在国内，懂技术 —— 尤其是 AI 技术的年轻人，真的不缺崭露头角的机会。</p>
<p>前段时间，2025 年腾讯广告算法大赛结果揭晓，前 10 名队伍的全部成员都拿到了腾讯的录用意向书，冠军还拿到了 200 万元巨额奖金。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a92f9d0e3c0745ce9165a6e5bdab10a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090388&amp;x-signature=aiNp7bFi%2BtRPWXBPgwkSwuz5OeQ%3D" alt="图片" loading="lazy"/></p>
<p>当时，看完选手们的答辩，腾讯公司副总裁蒋杰感慨地说，这届年轻人的知识储备令人惊叹，他们做出来的东西和工业界的实际工作非常接近，没有代差。</p>
<p>如果说大赛考的是一个已经被工业界解决的问题，选手们查查论文、复现方案，拼拼工程把问题解决掉倒也不是什么新鲜事。但看过今年赛题的人都知道，这次摆在桌面上的，是一个仍在探索中的真实难题，没有现成答案，也不存在所谓「最优解」。</p>
<p>也正因如此，比赛真正精彩的部分，其实不在排名本身，而在于：这道题究竟难在哪里？工业界已经做了些什么？而这些年轻人，又给出了哪些实用的解法？</p>
<p>在这篇文章中，我们将结合冠亚军团队的解决方案，来详细聊聊这些问题。</p>
<p>广告推荐</p>
<p>从来不是一件简单的事</p>
<p>一提到广告，很多人都会下意识皱眉。这种情绪其实很正常，没有人喜欢被无关的信息打断。但换个角度看，今天我们习以为常的很多内容和服务之所以能够长期、稳定地存在，本身就离不开广告的支撑。</p>
<p>也正因如此，平台真正想做的，并不是把更多广告塞给用户，而是尽量让广告「少出现一点、对一点」。只有把广告在合适的时间，推给真正可能需要的人，才能减少无效曝光，也减少对其他人的打扰。腾讯广告算法大赛所讨论的，正是如何把这件事做得更克制、更聪明。</p>
<p>在业界，目前主要有两种方法在 PK。一种是已经用了很多年的判别式方法，另一种是最近两三年兴起的生成式方法。</p>
<p>要理解两种方法的差异，我们可以举个例子：假设你是一个新来的班主任，想要根据小明同学的兴趣给他推荐合适的课外书。</p>
<p>在传统的判别式方法里，你的任务很明确：不是理解小明的成长过程，而是判断「这本书适不适合他」。学校会给你一张小明的档案表，以及一张馆藏书单。档案表上记录的是一系列已经被「统计好」的特征，你需要做的，是把这些特征代入模型，给每一本书算一个匹配分数，然后按分数高低排序。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c24688e1ff147c19cb14895cc6fdbc4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090388&amp;x-signature=8i3QxqMVOBjsHeXURIr3T7imK2g%3D" alt="图片" loading="lazy"/></p>
<p>而按照最近兴起的生成式方法，学校换了一种要求。不再让你给书打分，而是直接把小明过去一整年的借阅「流水账」交给你，让你去发现其中的规律，并预测：接下来最可能发生的那一次借书，会是什么样子。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1c71b0ea4dc4b8ea8d506954eacfd90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090388&amp;x-signature=pVnujfg9fhU5qr%2BiVE0f3aQzX%2F4%3D" alt="图片" loading="lazy"/></p>
<p>后一种方法之所以兴起，是因为前一种方法在研究多年之后，遇到了很难克服的瓶颈。</p>
<p>从例子里可以看出，传统判别式方法，更像是把小明压缩成一张「人设表」，在书和人之间算匹配度，然后用一种级联的「漏斗」去筛选。这种方式在早期非常有效，但后来，随着系统不断加入新的手工特征、更多统计维度、更复杂的级联模型，效果提升却越来越有限，尤其是在冷启动方面。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c9439cdd8984e57acde19e6237c7469~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090388&amp;x-signature=PE%2BMGXtHEyBkS9mmeSVNDFaXwl0%3D" alt="图片" loading="lazy"/></p>
<p>传统判别式方法的级联架构，像漏斗一样对广告层层筛选。</p>
<p>原因并不是工程师不努力，而是这种范式本身就存在很大的局限，包括特征挖掘遇上天花板，模型架构无法有效建模世界知识、推理用户意图、吸收多领域多模态用户行为信息，级联架构把目标拆碎并带来误差累积等。这就造成一个局面：算法工程师已经很难通过简单地增加特征或扩大现有模型规模来获得预期效果。</p>
<p>而生成式方法换了一种思路。它不急着给小明下结论，而是直接看他一整段时间的借阅记录，去理解兴趣是如何变化的，并顺着这个过程，预测「下一步最可能发生什么」。</p>
<p>对应到广告场景里，这意味着系统不再只判断「点不点」某个广告，而是尝试回答：在此时此刻，这个人最不反感、也最可能有用的广告，会是什么。</p>
<p>生成式模型本身的一些特质，使得它们擅长回答这类问题，包括处理长时间跨度的行为序列的能力，可以直接利用大模型中已经学到的世界知识和多模态先验等。</p>
<p>腾讯广告算法大赛所关注的，正是这一代方法，而且考虑到多模态信息在此类场景中的重要性，他们把赛题确定为「全模态生成式推荐」。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0d2b6ac883142508e732c428f529dfa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090388&amp;x-signature=UFFdnwGKQbkWueDddIt8N7sfNcI%3D" alt="图片" loading="lazy"/></p>
<p>目前，业界已经涌现出了一些优秀工作，有些成功地将传统级联架构中的某个组件替换为了生成式模型，比如 Google TIGER、Meta HSTU；还有些探索了端到端的生成式推荐，比如快手的 OneRec、腾讯的单模型框架 GPR。值得注意的是，HSTU 首次在推荐中观察到了 Scaling Law，这说明推荐系统也可以「吃到 scaling 的红利」。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06ec532929574330ab65c6a202e653aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090388&amp;x-signature=pPVOmuM%2FrBRpy3OVdb7GLL3y6P0%3D" alt="图片" loading="lazy"/></p>
<p>传统级联方法、用生成式模型替代部分组件的方法以及端到端生成式方法（腾讯 GPR）对比图。图源：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2511.10138" target="_blank" title="https://arxiv.org/pdf/2511.10138" ref="nofollow noopener noreferrer">arxiv.org/pdf/2511.10…</a></p>
<p>不过，这一领域依然存在很多挑战，比如工业级动态词表带来的训练 / 推理双重爆炸、毫秒级延迟与巨量算力的矛盾、大尺寸模型性能尚未得到充分验证等。</p>
<p>就是在这样的探索阶段，选手们拿到了这个赛题。对于没有接触过广告业务的他们来说，这个赛题极具挑战性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4d0c50ae9784f3dace93bdc2a985cd5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090388&amp;x-signature=eXQC%2FS4odmfjfDvAe4dCarazYFw%3D" alt="图片" loading="lazy"/></p>
<p>首先从数据规模来看，赛题对应的是超大规模数据场景：涉及千万级广告、千万级用户，以及同样规模的交互序列，但可用于训练的计算资源却是有限的，这要求模型在效果与效率之间做出权衡。</p>
<p>其次，数据本身的结构也非常复杂。选手拿到的是经过脱敏处理的用户全模态历史行为数据，包含文本、图像以及用户与广告之间的协同行为信息，同时还存在特征缺失、行为序列时间跨度大的问题，需要在不完整信息下建模长期与短期行为。</p>
<p>在任务层面，复赛赛题并非单一目标优化，而是同时涉及曝光、点击与转化等多个隐式目标，并且存在近半数的冷启动 item，这进一步提高了建模难度。</p>
<p>接下来我们就看看，本届大赛的冠亚军团队是怎么解决这些问题的。</p>
<p>冠军 Echoch：让推荐系统真正理解</p>
<p>用户「此时此刻」想要什么</p>
<p>冠军 Echoch 团队由来自华中科技大学、北京大学、中国科学技术大学的同学组成。在答辩中，他们从特征工程、模型设计、语义 ID、训推加速四个角度介绍了自己的方案。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ca4d3f5787245aea1f1605f692cd9cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090388&amp;x-signature=W%2BjRQYNhasLs6GtBOB1Mv%2FwO5Oc%3D" alt="图片" loading="lazy"/></p>
<p>三级会话体系 + 周期编码 + 时间差分桶：让模型拥有节奏感</p>
<p>同一个行为，在不同时间和状态下，含义可能完全不一样。比如同样是点一个广告，早上看到可能是随便点点，晚上可能更容易下单；5 分钟前点过一双鞋可能是刚感兴趣，3 天前点过的鞋可能已经不喜欢了。所以 Echoch 团队努力去解决的第一个大问题是：如何让推荐系统拥有「时间感」和「节奏感」，知道用户「此时此刻」处于什么状态。</p>
<p>为了解决这个问题，他们提出了三种方法，从不同角度来描述用户行为的特征，分别是：三级会话体系、周期编码和时间差分桶。</p>
<p>所谓的三级会话体系如下图所示，它解决的问题是怎么组织用户的各种行为：是刚点开，随手划两下；还是已经刷了一会儿，兴趣在变化；还是之前刷过，现在又回来刷了。这样的区分有助于系统判断「用户现在想干嘛」，从而决定推荐的时机和节奏。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d427e23747b541b4b07eaa6b8496318d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090388&amp;x-signature=NJ9GuIsIPgX%2BtnaJFSlo%2BUfXa2g%3D" alt="图片" loading="lazy"/></p>
<p>而周期编码的作用则是找到时间点的规律，让模型感知此刻是用户常刷的高峰期，还是偶尔点开的空档，从而决定推荐的内容类型。时间差分桶是为了让模型分清「新鲜度」，即某个商品是「刚刚感兴趣」还是「早就看过」，从而决定历史行为的参考权重。</p>
<p>这几个维度的信息叠加在一起，可以让推荐系统既贴着用户的作息周期，又更好地把握新鲜度和轰炸感，在合适的时间推合适的内容。</p>
<p>点击和转化：一个模型，两套策略</p>
<p>到了复赛阶段，大赛的规则其实发生了一些变化：在初赛中，选手们只需要预测「点击」行为；但到了复赛，他们需要同时预测「点击」与「转化」两种行为。</p>
<p>这就带来了一个问题：两种行为的目标与权重差异巨大，但模型只能生成一个统一的用户画像，推荐时左右为难。</p>
<p>对此，Echoch 团队给出的解决方案是让同一个模型，能根据「想让用户点击」还是「想让用户购买」自动切换推荐策略，而不是一套画像硬撑两个目标。</p>
<p>除此之外，他们在模型设计层面还发现了一个问题，就是用 HSTU 作为基座模型会遇到显存瓶颈和性能瓶颈。经过调查，他们发现这个问题的本质是 HSTU 需要靠「外挂补丁」去了解时间和行为信息，这样不但显存和计算成本很高，效果也开始停滞。于是，他们把基座模型换成了 LLM，因为 LLM 天生就有一个叫 RoPE 的位置编码机制，就像自带了「时间感」，这样时间和行为就不再是负担。结果不仅线上得分提升不少，显存占用也减少 5G 左右。</p>
<p>引入随机性，让冷门广告也有曝光机会</p>
<p>对于 Echoch 团队来说，语义 ID 层面的核心问题在于：用传统的聚类方法给广告编号，热门广告占据了大部分「好位置」，冷门广告被挤到角落，几乎没有被推荐的机会。</p>
<p>对此，他们给出的解法是：在编码的最后一层，故意引入一些随机性，让码表使用更均匀，从而让更多广告能被模型真正看到、参与训练。这种方法效果显著：长尾物品训练关注度提升了 190 倍，码表利用率从 81.2% 提升至 100%，Gini 系数（衡量曝光分布的不平等程度的指标）从 0.53 降至接近于 0。</p>
<p>引入 Muon 优化器，训练又快又稳定</p>
<p>前面提到，HSTU 首次证明，推荐系统也能吃到 scaling 的红利。但对于选手来说，训练更大的模型却没有那么容易，因为他们可以调动的计算资源是有限的。模型一大就面临显存不够用、训练不稳定的问题。</p>
<p>为了不在模型规模上妥协，Echoch 引入了 Muon 优化器。与需要为每个参数额外存储 2 份历史信息的 AdamW 相比，Muon 通过 Newton-Schulz 迭代把梯度矩阵变成正交矩阵，省掉了记录二阶动量的显存开销，显存占用实测锐减 45%，收敛速度提升 40%。</p>
<p>亚军 leejt：大数据，大模型</p>
<p>scaling is all you need</p>
<p>亚军 leejt 团队成员来自中山大学。在答辩中，他们从数据处理、模型训练、模型推理与后训练等几个角度介绍了自己的方案。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db11134f23f642e582e6ed306039728f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090388&amp;x-signature=zSCsCGlVuOSIF9ryVmuzaMVB4V4%3D" alt="图片" loading="lazy"/></p>
<p>共享词表 + 哈希编码：巧妙处理超大规模数据</p>
<p>和 LLM 一样，全模态生成式广告推荐的底层逻辑也是 next-token 预测，但两者面对的 token 世界规模完全不同。语言模型的词表只有十几万，而且是静态的；而在广告推荐中，如果把每个广告都视作一个 token，词表规模会迅速膨胀到千万甚至上亿级。即便在比赛这种受控环境下，广告数量也超过了 1800 万。如果为每个广告分配独立的嵌入向量，显存很快就会爆掉。</p>
<p>因此，leejt 团队在数据处理阶段做的第一件事，就是压缩词表规模。他们发现，接近一半的广告交互频次极低，既难以学到稳定表示，又大量消耗显存，于是将这些低频广告映射到共享词表中；同时再通过 ID 哈希，把原始广告 ID 压缩成更紧凑的表示。这两步基本解决了模型「训不起来」的问题。</p>
<p>此外，这里还涉及对多模态特征的取舍与压缩。面对维度极高、噪声较重的多模态向量，leejt 并没有选择直接堆进模型，而是先用 SVD 做降维去噪，再通过 RQ-KMeans 将连续向量离散为语义 ID（SID），把高维连续空间压缩成可控的离散表示。与此同时，对于缺失率高、线下验证效果不佳的模态特征，他们选择直接舍弃，而不是让模型为低质量信息付出建模成本。</p>
<p>session 划分 + 异构时序图：数据脏乱差也不怕</p>
<p>除了数据规模，真正让团队感到棘手的，还有数据本身的复杂性。</p>
<p>用户行为序列看似很长，但仔细分析会发现，很多序列其实是多个 session 拼接而成，如果不显式建模 session 边界，模型会把跨天、跨兴趣阶段的行为当成连续偏好来学，噪声极大；此外，大量商品是冷启动或低频，同时多模态特征维度高、缺失多、噪声重，如果直接输入模型，只会放大不确定性。</p>
<p>leejt 给出的解法是：主动补充序列之外的信息结构。一方面，他们通过时间特征和 session 划分，让模型知道哪些行为是「刚刚发生的」，哪些只是历史残留；另一方面，他们引入了异构时序图，把用户、广告以及语义层面的节点连接在一起。当某个用户或广告自身信息不足时，模型可以通过与其相邻的用户、相似广告和语义簇来「借信号」，用群体行为来弥补个体数据的稀疏。这一步的本质，是把原本只能在一条序列上盲猜的问题，转化成在一个关系网络中有依据地推断。</p>
<p>极致的工程优化：把 GPU 利用率拉到 100%</p>
<p>和 Echoch 团队一样，在有限的算力上训出更大更有效的模型也是 leejt 团队的核心目标。这方面，他们确实做得很成功，把模型从 4 层 512 维扩展到 8 层 2048 维，带来了百分位级别的性能提升。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29ec3c3382904a6e8ef9d3f43d4a70b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090388&amp;x-signature=kZkp4tSDw%2BKKsWa%2F2mCbYgY93VQ%3D" alt="图片" loading="lazy"/></p>
<p>团队的解法是从多个环节挤出效率空间：混合精度训练、梯度检查点、torch.compile 图编译，以及把所有数据预处理都放进 Dataloader 里让数据加载和模型计算完全并行。这套方法效果显著：每步训练时间从 3.5 秒压缩到 0.8 秒，GPU 利用率拉满到 100%，省下来的时间和空间全部用来把模型做大做深，最终验证了团队的核心信念 ——Scaling is all you need。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e499579c9d24733a5c8e764edaa74bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090388&amp;x-signature=l9tOgWi1zh17vY%2F3F94aGmwS7%2FM%3D" alt="图片" loading="lazy"/></p>
<p>腾讯广告算法大赛</p>
<p>让技术理想照进现实的起点</p>
<p>从这次比赛来看，全模态生成式广告推荐确实不是一个简单的问题。但年轻一代给出了非常有价值的思路。这些方案既有扎实的工程功底，也有对问题本质的深刻理解。</p>
<p>从业界实践来看，从判别式到生成式的演进正在平稳推进。蒋杰提到，腾讯内部已经尝试在召回和粗排阶段用生成式模型替代传统的判别式模型，并且取得了不错的效果，这些收益在财报的营收数据上也有所体现。这说明生成式推荐不只是学术界的热门话题，而是真正能落地、能创造商业价值的技术方向。</p>
<p>为了适应这种趋势，腾讯广告内部也在积极布局。蒋杰提到，未来，他们的数据将全面多模态化，内部广告系统也将全面 Agent 化。同时，为了支持整个社区的发展，腾讯广告会将本次大赛的数据开源，让更多研究者和开发者能够在真实场景的数据上探索和验证自己的想法。</p>
<p>而生成式广告推荐的想象空间，其实远超这次大赛所考察的范围。比赛关注的还是「从候选池里挑出最合适的广告」，但未来可能出现即时生成的广告 —— 不再是从现有素材中检索，而是根据用户当下的兴趣、场景、情绪，实时生成个性化的广告文案、图片甚至视频。到那时，「千人千面」才算真正名副其实。</p>
<p>当然，这中间还有很多技术难点需要克服。腾讯广告算法大赛，正是这样一个让技术理想照进现实的起点。</p>
<p>期待明年还能看到如此精彩的赛事。</p>
<p>参考链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FhlUk9P6vJk7fTir-TaVxNg" target="_blank" title="https://mp.weixin.qq.com/s/hlUk9P6vJk7fTir-TaVxNg" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/hlUk9P6vJ…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS 上架需要哪些准备，围绕证书、描述文件和上传方式等关键环节展开分析]]></title>    <link>https://juejin.cn/post/7586922268023816228</link>    <guid>https://juejin.cn/post/7586922268023816228</guid>    <pubDate>2025-12-23T10:29:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586922268023816228" data-draft-id="7586943543017963562" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS 上架需要哪些准备，围绕证书、描述文件和上传方式等关键环节展开分析"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-23T10:29:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="疯狂的程序猴"/> <meta itemprop="url" content="https://juejin.cn/user/2760245749234147"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS 上架需要哪些准备，围绕证书、描述文件和上传方式等关键环节展开分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2760245749234147/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    疯狂的程序猴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T10:29:17.000Z" title="Tue Dec 23 2025 10:29:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在不少项目中，iOS 上架被放在开发流程的末尾。功能完成、测试通过，大家自然会认为“准备工作也差不多了”。
但真正开始提交时，问题才集中出现，而且很少是代码层面的。</p>
<p>我参与过的多个项目里，上架前的准备并不是某一个步骤没做好，而是 <strong>很多小前提从来没有被明确过</strong>。</p>
<hr/>
<h2 data-id="heading-0"><strong>准备上架之前，先确认你在为哪个“应用”负责</strong></h2>
<p>在苹果体系里，一个 App 的存在并不是从代码开始的，而是从 <strong>应用标识</strong> 开始的。</p>
<p>在实际项目中，我见过不少团队直到准备上传时，才发现：</p>
<ul>
<li>当前 Bundle ID 已被历史项目占用</li>
<li>测试包和正式包共用了同一个标识</li>
<li>应用在 App Store Connect 中根本不存在</li>
</ul>
<p>这些问题并不复杂，但一旦拖到最后才发现，返工成本就会非常高。</p>
<p>在上架准备阶段，我通常会先确认 Apple Developer 账号中已经存在的应用标识情况。
在非 macOS 环境下，可以通过 <strong>开心上架（Appuploader）查看账号内的 Bundle ID 列表</strong>，提前判断是否需要新增或调整。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81cb52f874424811bc79d3cc8db91fd7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC55qE56iL5bqP54y0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090556&amp;x-signature=%2BfpDP8tMxkArfZ80G3yTb3veZGM%3D" alt="查看bid" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-1"><strong>证书是否“能用”，比是否“已创建”更重要</strong></h2>
<p>很多团队在准备上架时，会确认“证书有没有”，但很少确认“这份证书是不是适合现在用”。</p>
<p>我遇到过的情况包括：</p>
<ul>
<li>使用了开发证书生成发布包</li>
<li>证书只存在于某一台 Mac</li>
<li>构建机和上传机使用的证书不一致</li>
</ul>
<p>这些问题并不会在开发阶段明显暴露，但在上架时会集中爆发。</p>
<p>在一些跨平台或 CI 驱动的项目中，我们会通过 <strong>开心上架（Appuploader）创建 iOS 证书</strong>，直接生成 <code>.p12</code> 文件，用于构建和发布流程。
这样做的好处在于：证书不再是某一台设备的“隐性状态”，而是明确的工程资源。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4725c2a6cb5943ada19f899f6ee73261~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC55qE56iL5bqP54y0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090556&amp;x-signature=J6pd5f8OCU8WxtxJacfZbZZwrac%3D" alt="证书生成" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-2"><strong>描述文件，往往决定了“能不能安装”和“能不能提交”</strong></h2>
<p>描述文件在很多项目里存在感很低，但在上架准备阶段，它的作用非常具体。</p>
<p>我遇到过的常见问题包括：</p>
<ul>
<li>描述文件类型选错</li>
<li>描述文件绑定的 Bundle ID 与实际应用不一致</li>
<li>开发描述文件被带到了发布包中</li>
</ul>
<p>这些问题在构建阶段不一定报错，但在安装或审核阶段一定会出现异常。</p>
<p>在准备上架前，我更倾向于直接检查描述文件的内部信息，而不是反复下载。
通过 <strong>开心上架（Appuploader）查看 mobileprovision 文件内容</strong>，可以确认描述文件类型、绑定的应用标识以及使用的证书是否正确。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a04c6c9dc33049b9a0dfc2f51f6179e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC55qE56iL5bqP54y0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090556&amp;x-signature=9T9jMPIyoNsI0IRD2uAgYOxA94s%3D" alt="查看描述文件" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-3"><strong>App Store 元数据准备，常常和工程配置不同步</strong></h2>
<p>上架准备不仅是工程问题，还涉及应用信息本身。</p>
<p>我见过一些被拒案例，并不是因为功能违规，而是：</p>
<ul>
<li>应用描述与实际行为不一致</li>
<li>权限说明缺失或表述不准确</li>
<li>截图与当前版本不匹配</li>
</ul>
<p>这些问题往往出现在工程配置和运营信息由不同角色维护的项目中。
如果在准备阶段没有明确责任边界，上架时就容易出现反复。</p>
<hr/>
<h2 data-id="heading-4"><strong>上传方式，也属于“上架准备”的一部分</strong></h2>
<p>很多人会把上传当成最后一步，但在工程实践中，上传方式本身需要提前考虑。</p>
<p>常见差异包括：</p>
<ul>
<li>是否依赖 Xcode</li>
<li>是否只能在 macOS 上执行</li>
<li>是否支持失败重试</li>
</ul>
<p>在一些项目中，我们会使用 <strong>开心上架（Appuploader）的上传方式</strong>，将上传动作从 Xcode 中拆分出来，使其可以在 Windows、Linux 或 macOS 环境中执行。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6399d2bfc112435e8e4e9ecb126c83ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC55qE56iL5bqP54y0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090556&amp;x-signature=DegpVbAVeKXuDt1OXa8STtdzfWA%3D" alt="ipa上传" loading="lazy"/></p>
<p>这并不会改变苹果的审核流程，但能让上架准备更贴合团队的实际工作方式。</p>
<hr/>
<h2 data-id="heading-5"><strong>iOS 上架准备，本质是在降低不确定性</strong></h2>
<p>回顾多次发布经历，我逐渐意识到：
所谓“上架准备”，并不是多做几步操作，而是 把流程中的不确定因素尽量提前暴露出来。</p>
<p>当你在提交之前已经清楚地知道：</p>
<ul>
<li>应用身份是什么</li>
<li>用的证书和描述文件是哪一份</li>
<li>IPA 内部实际包含什么</li>
<li>上传会在哪个环境完成</li>
</ul>
<p>上架本身反而变成了一件相对平稳的事情。
上架流程参考链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.appuploader.net%2Ftutorial%2Fzh%2F1%2F1.html" target="_blank" title="https://www.appuploader.net/tutorial/zh/1/1.html" ref="nofollow noopener noreferrer">www.appuploader.net/tutorial/zh…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React/Vue 代理配置全攻略：Vite 与 Webpack 实战指南]]></title>    <link>https://juejin.cn/post/7586877892467261467</link>    <guid>https://juejin.cn/post/7586877892467261467</guid>    <pubDate>2025-12-23T10:03:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586877892467261467" data-draft-id="7586892413889855534" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React/Vue 代理配置全攻略：Vite 与 Webpack 实战指南"/> <meta itemprop="keywords" content="Vue.js,React.js"/> <meta itemprop="datePublished" content="2025-12-23T10:03:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端无涯"/> <meta itemprop="url" content="https://juejin.cn/user/3967483738859639"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React/Vue 代理配置全攻略：Vite 与 Webpack 实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3967483738859639/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端无涯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T10:03:19.000Z" title="Tue Dec 23 2025 10:03:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<blockquote>
<p>在前端开发中，<strong>跨域问题</strong>是我们绕不开的坎。浏览器的同源策略限制了不同域名、端口或协议之间的资源请求，而开发环境中前端项目（通常是<code>localhost:3000</code>/<code>localhost:5173</code>）与后端接口（如<code>http://api.example.com</code>）往往不在同一域下，直接请求会触发跨域错误。</p>
</blockquote>
<p>为了解决开发环境的跨域问题，主流的前端构建工具（Vite、Webpack）都提供了 ** 代理（Proxy）** 功能。代理的核心原理是：以构建工具启动的开发服务器作为中间层，前端请求先发送到开发服务器，再由开发服务器转发到后端接口服务器（服务器之间的请求不受同源策略限制），最后将后端响应返回给前端，从而绕过浏览器的跨域限制。</p>
<p>本文将详细讲解 React 和 Vue 两大主流框架，分别基于<strong>Vite</strong>（新一代前端构建工具）和<strong>Webpack</strong>（传统主流构建工具）的代理配置方案，涵盖基础配置、进阶场景和常见问题排查。</p>
<h2 data-id="heading-0">一、Vue 框架的代理配置</h2>
<p>Vue 项目的构建工具主要分为两种：<strong>Vite</strong>（Vue 3 推荐）和<strong>Vue CLI</strong>（基于 Webpack，Vue 2/3 都支持），两者的代理配置方式略有不同。</p>
<h3 data-id="heading-1">1.1 Vue + Vite 代理配置</h3>
<p>Vite 的代理配置在项目根目录的<code>vite.config.js</code>（或<code>vite.config.ts</code>）文件中，通过<code>server.proxy</code>选项配置。</p>
<h4 data-id="heading-2">基础配置示例</h4>
<p>假设前端项目运行在<code>http://localhost:5173</code>，后端接口地址为<code>http://localhost:8080/api</code>，我们希望将前端以<code>/api</code>开头的请求代理到后端接口。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">vue</span>()],
  <span class="hljs-comment">// 开发服务器配置</span>
  <span class="hljs-attr">server</span>: {
    <span class="hljs-attr">port</span>: <span class="hljs-number">5173</span>, <span class="hljs-comment">// 前端项目端口（默认5173，可自定义）</span>
    <span class="hljs-attr">open</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 启动时自动打开浏览器</span>
    <span class="hljs-comment">// 代理配置</span>
    <span class="hljs-attr">proxy</span>: {
      <span class="hljs-comment">// 匹配以/api开头的请求</span>
      <span class="hljs-string">'/api'</span>: {
        <span class="hljs-attr">target</span>: <span class="hljs-string">'http://localhost:8080'</span>, <span class="hljs-comment">// 后端接口的基础地址</span>
        <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 开启跨域模拟（关键：让后端认为请求来自target域名）</span>
        <span class="hljs-attr">rewrite</span>: <span class="hljs-function">(<span class="hljs-params">path</span>) =&gt;</span> path.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^/</span>api/, <span class="hljs-string">''</span>) <span class="hljs-comment">// 路径重写（可选：如果后端接口没有/api前缀，需要去掉）</span>
      }
    }
  }
})
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>配置项说明</strong>：</p>
<ul>
<li><code>target</code>：后端接口的服务器地址（必填）。</li>
<li><code>changeOrigin</code>：是否开启跨域模拟，设置为<code>true</code>时，开发服务器会在转发请求时修改<code>Host</code>请求头为<code>target</code>的域名，避免后端因域名校验拒绝请求（建议始终开启）。</li>
<li><code>rewrite</code>：路径重写函数，用于修改转发到后端的请求路径。例如前端请求<code>/api/user</code>，经过重写后会转发到<code>http://localhost:8080/user</code>（如果后端接口本身带有<code>/api</code>前缀，则不需要此配置）。</li>
</ul>
<h4 data-id="heading-3">测试效果</h4>
<p>前端发送请求：</p>
<pre><code class="hljs language-css" lang="css">// 原本需要直接请求http://localhost:<span class="hljs-number">8080</span>/api/user（跨域）
// 现在直接请求/api/user，会被代理转发
<span class="hljs-built_in">fetch</span>(<span class="hljs-string">'/api/user'</span>)
  .<span class="hljs-built_in">then</span>(res =&gt; res.<span class="hljs-built_in">json</span>())
  .<span class="hljs-built_in">then</span>(data =&gt; console.<span class="hljs-built_in">log</span>(data))
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-4">1.2 Vue + Vue CLI（Webpack）代理配置</h3>
<p>Vue CLI 基于 Webpack，其代理配置在项目根目录的<code>vue.config.js</code>文件中，通过<code>devServer.proxy</code>选项配置（底层依赖<code>webpack-dev-server</code>的 proxy 功能）。</p>
<h4 data-id="heading-5">基础配置示例</h4>
<p>需求与上述一致：将<code>/api</code>开头的请求代理到<code>http://localhost:8080</code>。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// vue.config.js</span>
<span class="hljs-keyword">module</span>.<span class="hljs-keyword">exports</span> = {
  devServer: {
    port: <span class="hljs-number">8081</span>, <span class="hljs-comment">// 前端项目端口</span>
    open: <span class="hljs-literal">true</span>,
    proxy: {
      <span class="hljs-string">'/api'</span>: {
        target: <span class="hljs-string">'http://localhost:8080'</span>,
        changeOrigin: <span class="hljs-literal">true</span>,
        pathRewrite: { <span class="hljs-string">'^/api'</span>: <span class="hljs-string">''</span> } <span class="hljs-comment">// 路径重写（与Vite的rewrite作用一致，语法不同）</span>
      }
    }
  }
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>注意</strong>：Vue CLI 的路径重写使用<code>pathRewrite</code>对象，而 Vite 使用<code>rewrite</code>函数，语法略有差异，但功能一致。</p>
<h2 data-id="heading-6">二、React 框架的代理配置</h2>
<p>React 项目的构建工具同样分为<strong>Vite</strong>（新一代）和<strong>Create React App</strong>（基于 Webpack，简称 CRA，React 官方脚手架）。</p>
<h3 data-id="heading-7">2.1 React + Vite 代理配置</h3>
<p>React + Vite 的代理配置与 Vue + Vite 完全一致，因为 Vite 的代理功能是框架无关的。</p>
<h4 data-id="heading-8">基础配置示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> react <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-react'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">react</span>()],
  <span class="hljs-attr">server</span>: {
    <span class="hljs-attr">port</span>: <span class="hljs-number">5173</span>,
    <span class="hljs-attr">proxy</span>: {
      <span class="hljs-string">'/api'</span>: {
        <span class="hljs-attr">target</span>: <span class="hljs-string">'http://localhost:8080'</span>,
        <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">rewrite</span>: <span class="hljs-function">(<span class="hljs-params">path</span>) =&gt;</span> path.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^/</span>api/, <span class="hljs-string">''</span>)
      }
    }
  }
})
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-9">2.2 React + Create React App（Webpack）代理配置</h3>
<p>CRA 隐藏了 Webpack 的核心配置，因此其代理配置分为两种方式：<strong>简单配置（package.json）<strong>和</strong>进阶配置（setupProxy.js）</strong> 。</p>
<h4 data-id="heading-10">方式 1：简单配置（package.json）</h4>
<p>适用于单一路径的代理场景，直接在<code>package.json</code>中添加<code>proxy</code>字段。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"react-app"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0.1.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"private"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^18.2.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"react-dom"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^18.2.0"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 简单代理配置：将所有请求代理到http://localhost:8080</span>
  <span class="hljs-attr">"proxy"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://localhost:8080"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>注意</strong>：这种方式的局限性很大：</p>
<ul>
<li>只能配置一个代理目标，无法针对不同路径配置不同代理。</li>
<li>不支持路径重写、HTTPS 等进阶配置。</li>
</ul>
<h4 data-id="heading-11">方式 2：进阶配置（setupProxy.js）</h4>
<p>适用于多路径代理、路径重写等复杂场景，需要创建<code>src/setupProxy.js</code>文件，并安装<code>http-proxy-middleware</code>依赖（CRA 已内置该依赖，若未安装可手动执行<code>npm install http-proxy-middleware --save-dev</code>）。</p>
<h5 data-id="heading-12">基础配置示例（匹配 /api 路径）</h5>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// src/setupProxy.js</span>
<span class="hljs-keyword">const</span> { createProxyMiddleware } = <span class="hljs-keyword">require</span>(<span class="hljs-string">'http-proxy-middleware'</span>)

module.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">app</span>) </span>{
  app.<span class="hljs-keyword">use</span>(
    <span class="hljs-comment">// 匹配以/api开头的请求</span>
    <span class="hljs-string">'/api'</span>,
    <span class="hljs-title function_ invoke__">createProxyMiddleware</span>({
      <span class="hljs-attr">target</span>: <span class="hljs-string">'http://localhost:8080'</span>,
      <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">pathRewrite</span>: { <span class="hljs-string">'^/api'</span>: <span class="hljs-string">''</span> }
    })
  )
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h5 data-id="heading-13">多代理规则示例</h5>
<p>如果需要将<code>/api</code>代理到<code>http://localhost:8080</code>，将<code>/admin</code>代理到<code>http://localhost:9090</code>，可以配置多个代理规则：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// src/setupProxy.js</span>
<span class="hljs-keyword">const</span> { createProxyMiddleware } = <span class="hljs-keyword">require</span>(<span class="hljs-string">'http-proxy-middleware'</span>)

module.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">app</span>) </span>{
  <span class="hljs-comment">// 代理/api到8080端口</span>
  app.<span class="hljs-keyword">use</span>(
    <span class="hljs-string">'/api'</span>,
    <span class="hljs-title function_ invoke__">createProxyMiddleware</span>({
      <span class="hljs-attr">target</span>: <span class="hljs-string">'http://localhost:8080'</span>,
      <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">pathRewrite</span>: { <span class="hljs-string">'^/api'</span>: <span class="hljs-string">''</span> }
    })
  )
  <span class="hljs-comment">// 代理/admin到9090端口</span>
  app.<span class="hljs-keyword">use</span>(
    <span class="hljs-string">'/admin'</span>,
    <span class="hljs-title function_ invoke__">createProxyMiddleware</span>({
      <span class="hljs-attr">target</span>: <span class="hljs-string">'http://localhost:9090'</span>,
      <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">pathRewrite</span>: { <span class="hljs-string">'^/admin'</span>: <span class="hljs-string">''</span> }
    })
  )
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>注意</strong>：修改<code>setupProxy.js</code>后，需要重启 CRA 的开发服务器才能生效。</p>
<h2 data-id="heading-14">三、代理的进阶配置场景</h2>
<p>除了基础的代理配置，我们还会遇到一些复杂场景，比如代理 HTTPS 接口、携带 Cookie、匹配正则路径等。</p>
<h3 data-id="heading-15">3.1 代理 HTTPS 接口</h3>
<p>如果后端接口是 HTTPS 协议（如<code>https://api.example.com</code>），需要添加<code>secure: false</code>配置，忽略 SSL 证书验证（开发环境下常用，生产环境不建议）。</p>
<h4 data-id="heading-16">Vite 配置示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">proxy</span>: {
  <span class="hljs-string">'/api'</span>: {
    <span class="hljs-attr">target</span>: <span class="hljs-string">'https://api.example.com'</span>,
    <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">secure</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 忽略HTTPS证书验证</span>
    <span class="hljs-attr">rewrite</span>: <span class="hljs-function">(<span class="hljs-params">path</span>) =&gt;</span> path.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^/</span>api/, <span class="hljs-string">''</span>)
  }
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-17">Webpack（Vue CLI/CRA）配置示例</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// Vue CLI：vue.config.js</span>
proxy: {
  <span class="hljs-string">'/api'</span>: {
    target: <span class="hljs-string">'https://api.example.com'</span>,
    changeOrigin: <span class="hljs-literal">true</span>,
    secure: <span class="hljs-literal">false</span>,
    pathRewrite: { <span class="hljs-string">'^/api'</span>: <span class="hljs-string">''</span> }
  }
}

<span class="hljs-comment">// CRA：setupProxy.js</span>
<span class="hljs-title function_ invoke__">createProxyMiddleware</span>({
  <span class="hljs-attr">target</span>: <span class="hljs-string">'https://api.example.com'</span>,
  <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">secure</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">pathRewrite</span>: { <span class="hljs-string">'^/api'</span>: <span class="hljs-string">''</span> }
})
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-18">3.2 跨域携带 Cookie</h3>
<p>如果需要在跨域请求中携带 Cookie（如用户登录状态），需要同时配置前端请求的<code>withCredentials</code>和代理的<code>cookieDomainRewrite</code>。</p>
<h4 data-id="heading-19">前端请求配置</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// fetch请求</span>
fetch(<span class="hljs-string">'/api/user'</span>, {
  credentials: <span class="hljs-string">'include'</span> <span class="hljs-comment">// 携带Cookie</span>
})

<span class="hljs-comment">// axios请求</span>
axios.<span class="hljs-keyword">get</span>(<span class="hljs-string">'/api/user'</span>, {
  withCredentials: <span class="hljs-literal">true</span> <span class="hljs-comment">// 携带Cookie</span>
})
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-20">代理配置</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Vite</span>
<span class="hljs-attr">proxy</span>: {
  <span class="hljs-string">'/api'</span>: {
    <span class="hljs-attr">target</span>: <span class="hljs-string">'http://localhost:8080'</span>,
    <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">rewrite</span>: <span class="hljs-function">(<span class="hljs-params">path</span>) =&gt;</span> path.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^/</span>api/, <span class="hljs-string">''</span>),
    <span class="hljs-attr">cookieDomainRewrite</span>: <span class="hljs-string">'localhost'</span> <span class="hljs-comment">// 将后端返回的Cookie域名重写为前端域名</span>
  }
}

<span class="hljs-comment">// Webpack</span>
<span class="hljs-title function_">createProxyMiddleware</span>({
  <span class="hljs-attr">target</span>: <span class="hljs-string">'http://localhost:8080'</span>,
  <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">pathRewrite</span>: { <span class="hljs-string">'^/api'</span>: <span class="hljs-string">''</span> },
  <span class="hljs-attr">cookieDomainRewrite</span>: <span class="hljs-string">'localhost'</span>
})
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-21">3.3 正则匹配路径</h3>
<p>如果需要匹配更复杂的路径（如以<code>/api/v1</code>或<code>/api/v2</code>开头的请求），可以使用正则表达式作为代理的匹配规则。</p>
<h4 data-id="heading-22">Vite 配置示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">proxy</span>: {
  <span class="hljs-comment">// 匹配以/api/v开头的请求</span>
  <span class="hljs-string">'^/api/v\d+'</span>: {
    <span class="hljs-attr">target</span>: <span class="hljs-string">'http://localhost:8080'</span>,
    <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">rewrite</span>: <span class="hljs-function">(<span class="hljs-params">path</span>) =&gt;</span> path.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^/</span>api/, <span class="hljs-string">''</span>)
  }
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-23">Webpack（CRA）配置示例</h4>
<pre><code class="hljs language-php" lang="php">app.<span class="hljs-keyword">use</span>(
  <span class="hljs-comment">// 正则匹配/api/v1或/api/v2</span>
  /^/api/v\d+/,
  <span class="hljs-title function_ invoke__">createProxyMiddleware</span>({
    <span class="hljs-attr">target</span>: <span class="hljs-string">'http://localhost:8080'</span>,
    <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">pathRewrite</span>: { <span class="hljs-string">'^/api'</span>: <span class="hljs-string">''</span> }
  })
)
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-24">四、代理配置常见问题排查</h2>
<p>配置代理后，如果请求仍然失败，可从以下几个方面排查：</p>
<h3 data-id="heading-25">4.1 代理规则未匹配</h3>
<ul>
<li>检查前端请求的路径是否与代理的匹配规则一致（如前端请求<code>/api/user</code>，代理规则是<code>/api</code>，则匹配；若请求<code>/user</code>，则不匹配）。</li>
<li>正则匹配时，注意正则表达式的语法是否正确（如转义字符、量词等）。</li>
</ul>
<h3 data-id="heading-26">4.2 路径重写错误</h3>
<ul>
<li>如果后端接口没有<code>/api</code>前缀，但代理配置了<code>rewrite: (path) =&gt; path.replace(/^/api/, '')</code>，则前端请求<code>/api/user</code>会被转发到<code>/user</code>；若后端接口有<code>/api</code>前缀，去掉重写配置即可。</li>
<li>检查路径重写的语法（Vite 用<code>rewrite</code>函数，Webpack 用<code>pathRewrite</code>对象）。</li>
</ul>
<h3 data-id="heading-27">4.3 changeOrigin 未开启</h3>
<ul>
<li>若后端接口有域名校验（如只允许特定域名访问），未开启<code>changeOrigin: true</code>会导致后端拒绝请求，此时需要开启该配置。</li>
</ul>
<h3 data-id="heading-28">4.4 后端接口地址错误</h3>
<ul>
<li>检查<code>target</code>配置的后端地址是否正确（包括域名、端口、协议），可直接在浏览器中访问后端接口地址，确认接口是否正常。</li>
</ul>
<h3 data-id="heading-29">4.5 开发服务器未重启</h3>
<ul>
<li>修改 Vite/Vue CLI 的配置文件后，开发服务器会自动重启；但修改 CRA 的<code>setupProxy.js</code>后，需要手动重启开发服务器才能生效。</li>
</ul>
<h2 data-id="heading-30">五、总结</h2>
<p>开发环境的代理配置是解决跨域问题的最优方案，不同构建工具的配置方式虽有差异，但核心原理一致。</p>
<ul>
<li><strong>Vite</strong>：配置简洁，框架无关，通过<code>server.proxy</code>实现，支持函数式路径重写和正则匹配。</li>
<li><strong>Webpack</strong>：Vue CLI 通过<code>devServer.proxy</code>配置，CRA 则分为简单的<code>package.json</code>配置和进阶的<code>setupProxy.js</code>配置，底层依赖<code>http-proxy-middleware</code>。</li>
</ul>
<p>在实际开发中，我们可以根据项目的框架（React/Vue）和构建工具（Vite/Webpack）选择对应的配置方式，并根据业务需求添加路径重写、HTTPS 支持、Cookie 携带等进阶配置。同时，遇到问题时可按照 “规则匹配→路径重写→跨域配置→接口地址” 的顺序排查，快速定位问题。</p>
<p>最后需要注意：<strong>代理配置仅适用于开发环境</strong>，生产环境的跨域问题需要通过后端配置 CORS（跨域资源共享）或 Nginx 反向代理来解决。</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文带你了解LangChain数据容器及其使用]]></title>    <link>https://juejin.cn/post/7586687526867402767</link>    <guid>https://juejin.cn/post/7586687526867402767</guid>    <pubDate>2025-12-23T09:43:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586687526867402767" data-draft-id="7586836874016391178" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文带你了解LangChain数据容器及其使用"/> <meta itemprop="keywords" content="LangChain,Agent,AI编程"/> <meta itemprop="datePublished" content="2025-12-23T09:43:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="FreeCode"/> <meta itemprop="url" content="https://juejin.cn/user/1282499717900794"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文带你了解LangChain数据容器及其使用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1282499717900794/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    FreeCode
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T09:43:48.000Z" title="Tue Dec 23 2025 09:43:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><blockquote>
<p>在LangChain生态中，<strong>State</strong>、<strong>Runtime</strong>、<strong>RunnableConfig</strong> 是三个核心概念，分别承担状态数据容器、环境数据容器、配置数据容器的角色。
管理和使用好这些数据容器，直接影响智能体的性能表现。本文带领大家深刻理解这三个概念和它们的使用方法。</p>
</blockquote>
<h2 data-id="heading-0">一、概念解读</h2>
<h3 data-id="heading-1">1.1 状态（State）：状态数据容器</h3>
<p>State是表示智能体当前状态的内部<strong>共享数据结构</strong>。它在智能体执行步骤或节点之间传输。</p>
<h4 data-id="heading-2">1.1.1 LangChain中的状态（State）</h4>
<ol>
<li><strong>默认状态 AgentState</strong> <br/>
create_agent接口创建的Agent的默认状态是 <code>langchain.agents.AgentState</code>，它是一个只包含必要键messages的字典（dict），用于存储智能体的短期记忆。</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AgentState</span>(TypedDict, <span class="hljs-type">Generic</span>[ResponseT]):
    <span class="hljs-string">"""State schema for the agent."""</span>
    messages: Required[Annotated[<span class="hljs-built_in">list</span>[AnyMessage], add_messages]]
    jump_to: NotRequired[Annotated[JumpTo | <span class="hljs-literal">None</span>, EphemeralValue, PrivateStateAttr]]
    structured_response: NotRequired[Annotated[ResponseT, OmitFromInput]]
</code></pre>
<ol start="2">
<li>
<p><strong>自定义状态（State）</strong> <br/>
智能体默认通过消息状态自动维护对话历史。开发者也可以为智能体配置自定义状态模式，使其在对话过程中记录更多额外信息。自定义状态模式定义为一个继承AgentState的TypedDict类型，并在create_agent接口中传递给state_schema参数。</p>
<p>在LangChain 1.0中，自定义的state schemas必须是TypedDict类型，Pydantic模型和dataclass类型不再支持。此外，自定义状态还可以通过中间件实现。</p>
</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent,AgentState 

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomState</span>(<span class="hljs-title class_ inherited__">AgentState</span>):
    <span class="hljs-string">"""定制 Agent State Schema."""</span>
    counter: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span>

agent = create_agent(
    model=<span class="hljs-string">"openai:gpt-4o"</span>,
    tools=[get_weather],
    system_prompt=<span class="hljs-string">"你是一个乐于助人的个人助手。"</span>,
    state_schema=CustomState,
)
<span class="hljs-comment"># Run the agent</span>
agent.invoke(
    {<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"北京今天天气怎么样？"</span>}]}
)
</code></pre>
<h4 data-id="heading-3">1.1.2 LangGraph中的状态（State）</h4>
<p>在LangGraph中，状态类型可以是 TypedDict、dataclass 或Pydantic模型。官方推荐的图状态模式定义方式是使用TypedDict。若需在状态中设置默认值，可使用dataclass。如果需要实现递归数据验证，可以用Pydantic BaseModel定义图的状态（但需注意，Pydantic的性能要低于TypedDict 或 dataclass）。
状态的模式会作为图中所有节点（Node）与边（Edge）的输入（input）模式。所有节点（Node）都会输出状态的更新信息，这些信息随后会通过指定的归约函数进行应用于状态（State）。</p>
<p>LangGraph实现了基础的消息状态 <code>langgraph.graph.MessagesState</code>。开发者可以继承MessagesState类来自定义需要的状态。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MessagesState</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    messages: Annotated[<span class="hljs-built_in">list</span>[AnyMessage], add_messages]
</code></pre>
<h3 data-id="heading-4">1.2 运行时（Runtime）：环境数据容器</h3>
<p>LangChain通过create_agent方法创建的智能体，底层是基于LangGraph的运行时来执行的。
LangGraph对外暴露一个 <code>langgraph.runtime.Runtime</code>对象，它包含以下信息：</p>
<ul>
<li>上下文（Context）：静态信息，例如用户 ID、数据库连接，或智能体调用所需的其他依赖项。</li>
<li>存储（Store）：用于长期记忆的 BaseStore 实例。</li>
<li>流写入器（Stream writer）：用于通过自定义流模式传输信息的对象。</li>
</ul>
<h3 data-id="heading-5">1.3 运行配置（RunnableConfig）：配置数据容器</h3>
<p>LangChain框架抽象出了一个“可调用、可组合、可序列化” 的组件接口Runable，作为其最基本的工作单元。其核心定义在 langchain-core 模块中，<code>langchain_core.runnables.Runnable</code>。LangChain同时还提供了RunnableConfig类，用于配置Runnable组件的运行时参数。它位于 <code>langchain_core.runnables.RunnableConfig</code>。RunnableConfig是一个TypedDict，包含以下字段：</p>
<ol>
<li><strong>tags</strong>: list[str]   为当前调用及其所有子调用添加标签，用于过滤和分类不同的调用（比如按业务模块、用户ID、任务类型打标签）。</li>
<li><strong>metadata</strong>: dict[str, Any]  当前调用及子调用的元数据，要求键是字符串，值可JSON序列化（如字符串、数字、列表、字典）。</li>
<li><strong>callbacks</strong>: Callbacks    回调函数集合，用于监听Runnable执行的生命周期事件（启动、成功、失败、结束、工具调用等）。</li>
<li><strong>run_name</strong>: str    为当前调用的运行实例命名，默认值为当前Runnable类的名称。</li>
<li><strong>max_concurrency</strong>: int | None  控制当前调用中并行子调用的最大数量；默认为ThreadPoolExecutor的默认值（通常为CPU核心数 × 5）。</li>
<li><strong>recursion_limit</strong>: int   限制当前调用的最大递归次数，防止无限递归。默认值为 25。</li>
<li><strong>configurable</strong>: dict[str, Any]  为Runnable中预先标记为可配置的字段提供运行时动态值。可配置字段通过configurable_fields或configurable_alternatives定义，支持在运行时覆盖默认值，无需修改代码。</li>
<li><strong>run_id</strong>: uuid.UUID | None  当前调用的唯一标识（UUID），用于追踪系统中唯一识别一次运行。若未提供，LangChain 会自动生成一个新的 UUID。</li>
</ol>
<p>RunnableConfig是控制Runnable执行的核心,涵盖可观测性（tags/metadata/callbacks）、性能控制（max_concurrency/recursion_limit）、动态配置（configurable）、追踪（run_name/run_id）等维度。RunnableConfig会透传所有子调用。当前调用的配置会作用于其所有子调用（如 Chain 调用 LLM、图节点调用工具），实现全链路统一配置。</p>
<p>LangGraph是基于langchain_core模块构建的有状态图执行框架，其核心组件（如图、状态机）均实现了Runnable接口，所以LangGraph无缝兼容RunnableConfig。配置会自动传递到节点，支持节点内读取和使用。</p>
<h2 data-id="heading-6">二、数据容器传入</h2>
<h3 data-id="heading-7">2.1 LangChain中的数据容器传入</h3>
<p>在LangChain中，通过craete_agent接口的参数state_schema、context_schema、store分别传入状态、上下文、存储的定义。
通过智能体的调用方法invoke/ainvoke,stream/astream, batch/abatch等传入初始的状态、运行配置、上下文数据。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> TypedDict
<span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnableConfig
<span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> ToolMessage
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent, AgentState
<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool, ToolRuntime
<span class="hljs-keyword">from</span> langgraph.types <span class="hljs-keyword">import</span> Command
<span class="hljs-keyword">from</span> langgraph.checkpoint.memory <span class="hljs-keyword">import</span> InMemorySaver
<span class="hljs-keyword">from</span> langgraph.store.memory <span class="hljs-keyword">import</span> InMemoryStore
<span class="hljs-keyword">from</span> model <span class="hljs-keyword">import</span> model


<span class="hljs-comment"># 自定义状态</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomState</span>(<span class="hljs-title class_ inherited__">AgentState</span>):
    <span class="hljs-string">"""定制 Agent State Schema."""</span>
    counter: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span>
<span class="hljs-comment"># 自定义上下文</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomContext</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    <span class="hljs-string">"""定制 Runtime Context Schema."""</span>
    user_id: <span class="hljs-built_in">str</span>
<span class="hljs-comment"># 工具</span>
<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">counter</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span>, runtime: ToolRuntime</span>) -&gt; Command:
    <span class="hljs-string">"""用户消息接收次数计数器：每次接收到用户消息调用此工具。"""</span>
    <span class="hljs-keyword">if</span> query.strip() != <span class="hljs-string">""</span>:
        runtime.state[<span class="hljs-string">"counter"</span>] += <span class="hljs-number">1</span>
        store = runtime.store
        store.put((<span class="hljs-string">"users"</span>,), runtime.context[<span class="hljs-string">"user_id"</span>], {<span class="hljs-string">"counter"</span>: runtime.state[<span class="hljs-string">"counter"</span>]})
        info=store.get((<span class="hljs-string">"users"</span>,), runtime.context[<span class="hljs-string">"user_id"</span>])
        <span class="hljs-built_in">print</span>(info)
    <span class="hljs-keyword">return</span> Command (update={<span class="hljs-string">"messages"</span>: [ToolMessage(<span class="hljs-string">"消息次数记录成功！"</span>, tool_call_id=runtime.tool_call_id)], <span class="hljs-string">"counter"</span>: runtime.state[<span class="hljs-string">"counter"</span>]})

<span class="hljs-comment"># 创建智能体</span>
agent = create_agent(
    model=model,
    tools=[counter],
    system_prompt=<span class="hljs-string">"你是一个个人助手"</span>,
    state_schema=CustomState,         <span class="hljs-comment"># 指定状态模型</span>
    context_schema=CustomContext,     <span class="hljs-comment"># 指定上下文模型</span>
    checkpointer=InMemorySaver(),     <span class="hljs-comment"># 设置检查点</span>
    store=InMemoryStore(),            <span class="hljs-comment"># 存储（长期记忆）</span>
)

<span class="hljs-comment"># 创建运行配置</span>
config=RunnableConfig(
    tags=[<span class="hljs-string">"user-123"</span>],
    metadata={<span class="hljs-string">"source"</span>: <span class="hljs-string">"user-input"</span>},
    run_name=<span class="hljs-string">"user-query"</span>,
    configurable={<span class="hljs-string">"thread_id"</span>: <span class="hljs-string">"1"</span>},
)
<span class="hljs-comment"># 初始状态</span>
init_state = CustomState(
        messages=[{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你好"</span>}], 
        counter=<span class="hljs-number">0</span>
    )
<span class="hljs-comment"># 上下文</span>
context = CustomContext(user_id=<span class="hljs-string">"123"</span>)

<span class="hljs-comment"># 调用智能体</span>
result = agent.invoke(
    <span class="hljs-built_in">input</span>=init_state,
    config=config,
    context=context,
)
<span class="hljs-comment"># 打印结果</span>
<span class="hljs-keyword">for</span> key,value <span class="hljs-keyword">in</span> result.items():
    <span class="hljs-keyword">if</span> key == <span class="hljs-string">"messages"</span>:
        <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> value:
            msg.pretty_print()
    <span class="hljs-keyword">else</span>:
        <span class="hljs-built_in">print</span>(key, value)
</code></pre>
<h3 data-id="heading-8">2.2 LangGraph中的数据容器传入</h3>
<p>在LangGraph中，通过StateGraph传入state_schema、context_schema；通过compile方法传入store对象。
通过图的调用方法invoke/ainvoke,stream/astream, batch/abatch等传入初始的状态、运行配置、上下文数据。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> TypedDict
<span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnableConfig
<span class="hljs-keyword">from</span> langchain.messages <span class="hljs-keyword">import</span> AIMessage, HumanMessage
<span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> MessagesState, StateGraph, START, END
<span class="hljs-keyword">from</span> langgraph.runtime <span class="hljs-keyword">import</span> Runtime
<span class="hljs-keyword">from</span> langgraph.store.memory <span class="hljs-keyword">import</span> InMemoryStore
<span class="hljs-keyword">from</span> langgraph.checkpoint.memory <span class="hljs-keyword">import</span> InMemorySaver
<span class="hljs-keyword">from</span> model <span class="hljs-keyword">import</span> model


<span class="hljs-comment"># 自定义图状态</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyGraphState</span>(<span class="hljs-title class_ inherited__">MessagesState</span>):
    <span class="hljs-string">"""MyGraphState"""</span>
    counter: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span>
<span class="hljs-comment"># 自定义上下文</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyContext</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    <span class="hljs-string">"""MyContext"""</span>
    user_id: <span class="hljs-built_in">str</span>
<span class="hljs-comment"># 自定义输出格式</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyStructuredOutput</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    <span class="hljs-string">"""MyStructedOutput"""</span>
    response: <span class="hljs-built_in">str</span>
    user_id: <span class="hljs-built_in">str</span>

<span class="hljs-comment"># 定义Node</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">node_1</span>(<span class="hljs-params">state: MyGraphState, runtime: Runtime, config: RunnableConfig</span>) -&gt; MyGraphState:
    <span class="hljs-string">"""node_1"""</span>
    state[<span class="hljs-string">"counter"</span>] += <span class="hljs-number">1</span>
    user_id = runtime.context[<span class="hljs-string">"user_id"</span>]
    thread_id = config[<span class="hljs-string">"configurable"</span>][<span class="hljs-string">"thread_id"</span>]
    store = runtime.store
    store.put((<span class="hljs-string">"users"</span>,),user_id,{<span class="hljs-string">"thread_id"</span>:thread_id, <span class="hljs-string">"counter"</span>:state[<span class="hljs-string">"counter"</span>]})
    state[<span class="hljs-string">"messages"</span>].append(AIMessage(content=<span class="hljs-string">f"user_id为<span class="hljs-subst">{user_id}</span>的用户的消息次数记录成功！"</span>))
    <span class="hljs-built_in">print</span>(store.get((<span class="hljs-string">"users"</span>,),user_id))
    <span class="hljs-keyword">return</span> state
<span class="hljs-keyword">def</span> <span class="hljs-title function_">node_2</span>(<span class="hljs-params">state: MyGraphState, runtime: Runtime, config: RunnableConfig</span>) -&gt; MyGraphState:
    <span class="hljs-string">"""node_2"""</span>
    user_id = runtime.context[<span class="hljs-string">"user_id"</span>]
    thread_id = config[<span class="hljs-string">"configurable"</span>][<span class="hljs-string">"thread_id"</span>]
    store = runtime.store
    user_data = store.get((<span class="hljs-string">"users"</span>,),user_id)
    <span class="hljs-keyword">if</span> user_data <span class="hljs-keyword">and</span> user_data.value[<span class="hljs-string">"thread_id"</span>] == thread_id <span class="hljs-keyword">and</span> state[<span class="hljs-string">"counter"</span>] &lt; <span class="hljs-number">10</span>:
        structed_model = model.with_structured_output(MyStructuredOutput)
        prompt = <span class="hljs-string">" "</span>.join([msg.content <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> state[<span class="hljs-string">"messages"</span>]])
        response = structed_model.invoke(prompt)
        state[<span class="hljs-string">"messages"</span>].append(AIMessage(content=response[<span class="hljs-string">"response"</span>]))
    <span class="hljs-keyword">return</span> state

<span class="hljs-comment"># 构建图</span>
graph = StateGraph(state_schema=MyGraphState,context_schema=MyContext)
graph.add_node(node_1)
graph.add_node(node_2)
graph.add_edge(START, <span class="hljs-string">"node_1"</span>)
graph.add_edge(<span class="hljs-string">"node_1"</span>, <span class="hljs-string">"node_2"</span>)
graph.add_edge(<span class="hljs-string">"node_2"</span>, END)

<span class="hljs-comment">#编译图</span>
agent = graph.<span class="hljs-built_in">compile</span>(checkpointer=InMemorySaver(), store=InMemoryStore())

<span class="hljs-comment"># 创建运行配置</span>
config=RunnableConfig(
    tags=[<span class="hljs-string">"user-123"</span>],
    metadata={<span class="hljs-string">"source"</span>: <span class="hljs-string">"user-input"</span>},
    run_name=<span class="hljs-string">"user-query"</span>,
    configurable={<span class="hljs-string">"thread_id"</span>: <span class="hljs-string">"1"</span>},
)

<span class="hljs-comment"># 调用</span>
result = agent.invoke(
    <span class="hljs-built_in">input</span>={<span class="hljs-string">"messages"</span>: [HumanMessage(content=<span class="hljs-string">"你好"</span>)], <span class="hljs-string">"counter"</span>: <span class="hljs-number">0</span>},
    config=config,
    context={<span class="hljs-string">"user_id"</span>: <span class="hljs-string">"user_123"</span>},
)

<span class="hljs-comment"># 打印结果</span>
<span class="hljs-keyword">for</span> key,value <span class="hljs-keyword">in</span> result.items():
    <span class="hljs-keyword">if</span> key == <span class="hljs-string">"messages"</span>:
        <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> value:
            msg.pretty_print()
    <span class="hljs-keyword">else</span>:
        <span class="hljs-built_in">print</span>(key, value)

</code></pre>
<h2 data-id="heading-9">三、访问数据容器</h2>
<h3 data-id="heading-10">3.1 工具（Tools）访问</h3>
<p>在LangChain中，工具可以通过 <code>langchain.tools.ToolRuntime</code>访问运行时信息。ToolRuntime作为统一的工具参数，可使工具获取状态、配置、工具调用ID、上下文、存储、流式输出这些运行时信息。
在工具函数签名中注入runtime:ToolRuntime参数，即可在函数内部引用相关信息，如runtime.state、runtime.context、runtime.config等。可以访问的信息如下：</p>
<ul>
<li><code>context</code>: Runtime context (from langgraph <code>Runtime</code>)</li>
<li><code>store</code>: <code>BaseStore</code> instance for persistent storage (from langgraph <code>Runtime</code>)</li>
<li><code>stream_writer</code>: <code>StreamWriter</code> for streaming output (from langgraph <code>Runtime</code>)</li>
<li><code>state</code>: The current graph state</li>
<li><code>tool_call_id</code>: The ID of the current tool call</li>
<li><code>config</code>: <code>RunnableConfig</code> for the current execution</li>
</ul>
<p>注意：ToolRuntime中的context、store、stream_writer来自LangGraph的Runtime对象。</p>
<p>示例代码可参考2.1节的案例。</p>
<h3 data-id="heading-11">3.2 中间件（Middleware）访问</h3>
<p>LangChain的中间件可以在每个步骤控制和定制智能体的执行过程。中间件提供两种类型的钩子用于植入智能体的执行过程：</p>
<ul>
<li>节点类型钩子，如before_agent, before_model, after_model, after_agent；</li>
<li>包裹类型钩子，如wrap_model_call, wrap_tool_call。</li>
</ul>
<p>节点类型的中间件接收state和runtime参数作为其输入，返回State更新或<code>Command</code>。对于包裹型中间件，wrap_model_call类型的接收ModelRequest和handler参数作为其输入，返回<code>ModelResponse</code> 或 <code>AIMessage</code>；wrap_tool_call类型的接收ToolCallRequest和handler参数作为其输入，返回 <code>ToolMessage</code> 或 <code>Command</code>。ModelRequest和ToolCallRequest中包含了state和runtime信息。
<strong>特别要注意的是，中间件不支持访问RunnableConfig</strong>。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass
<span class="hljs-keyword">from</span> collections.abc <span class="hljs-keyword">import</span> <span class="hljs-type">Callable</span>
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent, AgentState
<span class="hljs-keyword">from</span> langchain.agents.middleware <span class="hljs-keyword">import</span> dynamic_prompt, ModelRequest, before_model, after_model, wrap_model_call, wrap_tool_call
<span class="hljs-keyword">from</span> langchain.tools.tool_node <span class="hljs-keyword">import</span> ToolCallRequest
<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> ToolMessage
<span class="hljs-keyword">from</span> langgraph.runtime <span class="hljs-keyword">import</span> Runtime
<span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnableConfig
<span class="hljs-keyword">from</span> model <span class="hljs-keyword">import</span> model

<span class="hljs-comment"># 上下文</span>
<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Context</span>:
    user_name: <span class="hljs-built_in">str</span>

<span class="hljs-comment"># 工具</span>
<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">think_tool</span>(<span class="hljs-params">thought: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""在回答问题前先进行思考"""</span>
    <span class="hljs-keyword">return</span> thought

<span class="hljs-comment"># Dynamic prompts（dynamic_prompt为wrap_model_call的子类）</span>
<span class="hljs-meta">@dynamic_prompt</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">dynamic_system_prompt</span>(<span class="hljs-params">request: ModelRequest</span>) -&gt; <span class="hljs-built_in">str</span>:
    user_name = request.runtime.context.user_name  
    system_prompt = <span class="hljs-string">f"You are a helpful assistant. Address the user as <span class="hljs-subst">{user_name}</span>. you must use think_tool before you answer the questions."</span>
    <span class="hljs-keyword">return</span> system_prompt

<span class="hljs-meta">@wrap_model_call</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">modify_model_call</span>(<span class="hljs-params">request: ModelRequest, handler: <span class="hljs-type">Callable</span></span>) -&gt; <span class="hljs-built_in">dict</span> | <span class="hljs-literal">None</span>:
    <span class="hljs-comment"># 从配置中获取线程ID</span>
    user_name = request.runtime.context.user_name
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Modifying model call for user: <span class="hljs-subst">{user_name}</span>"</span>)
    result = handler(request)
    <span class="hljs-keyword">return</span> result

<span class="hljs-meta">@wrap_tool_call</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">modify_tool_call</span>(<span class="hljs-params">request: ToolCallRequest, handler: <span class="hljs-type">Callable</span></span>) -&gt; ToolMessage:
    <span class="hljs-comment"># 从配置中获取线程ID</span>
    user_name = request.runtime.context.user_name
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Modifying tool call for user: <span class="hljs-subst">{user_name}</span>"</span>)
    result = handler(request)
    <span class="hljs-keyword">return</span> result


<span class="hljs-comment"># Before model hook</span>
<span class="hljs-meta">@before_model</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">log_before_model</span>(<span class="hljs-params">state: AgentState, runtime: Runtime</span>) -&gt; <span class="hljs-built_in">dict</span> | <span class="hljs-literal">None</span>:  
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Processing request for user: <span class="hljs-subst">{runtime.context.user_name}</span>"</span>)  
    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

<span class="hljs-comment"># After model hook</span>
<span class="hljs-meta">@after_model</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">log_after_model</span>(<span class="hljs-params">state: AgentState, runtime: Runtime</span>) -&gt; <span class="hljs-built_in">dict</span> | <span class="hljs-literal">None</span>:  
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Completed request for user: <span class="hljs-subst">{runtime.context.user_name}</span>"</span>)  
    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

<span class="hljs-comment"># 创建智能体</span>
agent = create_agent(
    model,
    tools=[think_tool],
    middleware=[dynamic_system_prompt, log_before_model, modify_model_call, modify_tool_call, log_after_model],  
    context_schema=Context
)

<span class="hljs-comment"># 创建运行配置</span>
config=RunnableConfig(
    tags=[<span class="hljs-string">"user-123"</span>],
    metadata={<span class="hljs-string">"source"</span>: <span class="hljs-string">"user-input"</span>},
    run_name=<span class="hljs-string">"user-query"</span>,
    configurable={<span class="hljs-string">"thread_id"</span>: <span class="hljs-string">"1"</span>},
)

<span class="hljs-comment"># 调用</span>
result = agent.invoke(
    {<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"What's my name?"</span>}]},
    config,
    context=Context(user_name=<span class="hljs-string">"John Smith"</span>)
)

<span class="hljs-comment"># 打印结果</span>
<span class="hljs-built_in">print</span>(result[<span class="hljs-string">"messages"</span>][-<span class="hljs-number">1</span>].content)

</code></pre>
<h3 data-id="heading-12">3.3 节点访问</h3>
<p>节点本质上是一个Python函数，它接收state、runtime、config等参数作为输入。
因此节点函数可以在其内部方便的访问状态、运行时信息、配置等数据。
节点函数的返回值通常是更新后的状态。
代码示例可参考2.2节的案例。</p>
<h2 data-id="heading-13">四、总结</h2>
<h3 data-id="heading-14">4.1 核心定位与本质</h3>
<p>三者的<strong>本质身份</strong>和<strong>核心使命</strong>，这是理解差异的基础：</p>





























<table><thead><tr><th>概念</th><th>核心定位</th><th>本质类型</th><th>类比（便于理解）</th></tr></thead><tbody><tr><td><strong>State</strong></td><td>图的<strong>数据载体</strong>，存储图执行过程中的所有状态数据，是节点间通信的唯一媒介。</td><td>通常为<strong>TypedDict（字典）</strong> 或 <code>dataclass</code>（Pydantic 模型），支持结构化数据定义。</td><td>程序中的“变量/数据库”，存数据</td></tr><tr><td><strong>RunnableConfig</strong></td><td>图/节点的<strong>配置载体</strong>，传递静态/运行时的配置信息，是跨 LangChain/LangGraph 的通用配置结构。</td><td>本质是<strong>Python 字典</strong>（带类型提示的 <code>RunnableConfig</code> 类型），包含回调、标签、线程 ID 等配置项。</td><td>程序的“配置文件/命令行参数”</td></tr><tr><td><strong>Runtime</strong></td><td>图的<strong>执行环境信息</strong>，管理运行时资源与执行流程，是图运行的“底层支撑”。</td><td>LangGraph 内置的<strong>Runtime 类实例</strong>，包含存储、缓存、流写入器等资源。</td><td>程序的“操作系统/运行时环境”</td></tr></tbody></table>
<h3 data-id="heading-15">4.2 关键维度深度对比</h3>















































<table><thead><tr><th>对比维度</th><th>State（状态）</th><th>RunnableConfig（配置）</th><th>Runtime(运行时)</th></tr></thead><tbody><tr><td><strong>生命周期</strong></td><td>与<strong>图的单次执行会话</strong>绑定：从图启动开始创建，到执行结束销毁（或持久化）；节点每次调用都会接收/修改 State。</td><td>与<strong>单次节点/图调用</strong>绑定：可全局传递（整个图共用），也可按节点/请求单独指定；调用结束后配置失效。</td><td>与<strong>图的编译/实例化</strong>绑定：编译图时创建 Runtime 实例，直到图对象被销毁；同一 Runtime 可支撑多次图执行。</td></tr><tr><td><strong>核心作用</strong></td><td>1. 存储节点的输入/输出数据；<br/> 2. 作为节点间数据传递的唯一媒介；<br/> 3. 决定图的分支走向（如条件边的判断依据）。</td><td>1. 传递回调函数（监控执行过程）；<br/> 2. 传递元数据（线程 ID、用户 ID、标签）；<br/> 3. 配置缓存策略、并发限制。</td><td>1. 管理运行时资源（存储、流写入器）；<br/> 2. 提供上下文环境；<br/> 3. 处理持久化、并行执行、事件流等底层能力。</td></tr><tr><td><strong>数据流向</strong></td><td><strong>节点间双向流动</strong>：节点读取 State 中的数据，修改后返回新的 State 供下一个节点使用。</td><td><strong>自上而下传递</strong>：从图的调用方传递到节点，节点仅读取配置，一般不修改（特殊场景可动态更新）。</td><td><strong>全局静态存在</strong>：节点可读取 Runtime 中的资源（如缓存、存储），但不能修改 Runtime 本身的核心属性。</td></tr><tr><td><strong>可修改性</strong></td><td><strong>高度可修改</strong>：节点的核心逻辑就是修改 State（如新增/更新字段），是图的“可变数据层”。</td><td><strong>几乎不可修改</strong>：节点仅读取配置项，修改配置无实际意义（配置是单次调用的静态参数）。</td><td><strong>不可修改</strong>：Runtime 是执行环境，节点仅使用其提供的资源，不修改 Runtime 实例。</td></tr><tr><td><strong>典型属性/字段</strong></td><td>业务相关的自定义字段（如 <code>user_query</code>、<code>tool_results</code>、<code>agent_answer</code>）。</td><td><code>callbacks</code>（回调）、<code>tags</code>（标签）、<code>metadata</code>（元数据）、<code>thread_id</code>（线程 ID）。</td><td><code>store</code>（键值存储）、<code>stream_writer</code>（流写入器）、<code>context</code>（运行时上下文）。</td></tr><tr><td><strong>定义方式</strong></td><td>由用户<strong>自定义结构化类型</strong>（如 TypedDict 定义字段名和类型）。</td><td>由用户<strong>按框架规范组装字典</strong>（可使用 LangChain 的 <code>RunnableConfig</code> 类型提示）。</td><td>由 LangGraph<strong>内置实现</strong>，用户仅在编译图时指定配置（如缓存、存储），可自定义上下文。</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[开发调试与生产分析的利器：MyBatis SQL日志合并插件，让复杂日志秒变可执行SQL]]></title>    <link>https://juejin.cn/post/7586869907066290211</link>    <guid>https://juejin.cn/post/7586869907066290211</guid>    <pubDate>2025-12-23T10:34:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586869907066290211" data-draft-id="7586610067568951296" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="开发调试与生产分析的利器：MyBatis SQL日志合并插件，让复杂日志秒变可执行SQL"/> <meta itemprop="keywords" content="后端,Chrome,MyBatis"/> <meta itemprop="datePublished" content="2025-12-23T10:34:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一灰灰"/> <meta itemprop="url" content="https://juejin.cn/user/377887729916126"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            开发调试与生产分析的利器：MyBatis SQL日志合并插件，让复杂日志秒变可执行SQL
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/377887729916126/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一灰灰
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T10:34:58.000Z" title="Tue Dec 23 2025 10:34:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cabdd940b674c26bdcb1e0fecf689db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54Gw54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090897&amp;x-signature=R52jnuTnTQ3FSVpN8bLqN6PzL8Y%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">一、开篇</h2>
<p>在Java开发的世界里，MyBatis作为最受欢迎的ORM框架之一，为我们提供了灵活的SQL操作能力。然而，伴随着这种灵活性，也带来了一个让人头疼的问题：当应用在开发或生产环境中遇到SQL相关问题时，如何快速定位和分析那些被参数化的SQL日志？</p>
<p>相信各位javaer都会有类似的经历：面对控制台中输出的MyBatis日志，看到类似"Preparing: SELECT * FROM user WHERE id = ? AND status = ?"和"Parameters: 123(Long), active(String)"这样的信息，却需要手动将参数值代入SQL模板中，才能知道这条SQL实际执行的是什么？这个过程不仅繁琐，而且容易出错，尤其是在处理复杂查询时。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/799c2105406e49cda8456c9435511feb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54Gw54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090897&amp;x-signature=6Wj3NvkOm7YKdbc8nEdlcjKu9hY%3D" alt="" loading="lazy"/></p>
<p>下面给大家推荐一个能彻底解决这个问题的神器——MyBatis SQL Log Merger插件，它不仅能大幅提升开发调试效率，更是生产环境SQL分析的得力助手。</p>
<h2 data-id="heading-1">二、场景痛点分析</h2>
<h3 data-id="heading-2">1. 开发阶段痛点</h3>
<p>在开发过程中，我们经常需要验证SQL的正确性，分析查询性能，或者调试业务逻辑。传统的做法是：</p>
<ol>
<li>从日志中复制SQL模板和参数信息</li>
<li>手动将参数值代入SQL模板中</li>
<li>将完整的SQL粘贴到数据库客户端执行</li>
<li>分析执行结果</li>
</ol>
<p>这个过程不仅耗时，而且容易出错，特别是当SQL包含大量参数或复杂条件时。</p>
<h3 data-id="heading-3">2. 生产阶段痛点</h3>
<p>在生产环境中，这个问题更加突出。当系统出现性能问题或异常时，比如现在出现了一个慢SQL，但是面对控制台上输出的SQL模板和传参，需要快速分析MyBatis日志，但：</p>
<ol>
<li>生产环境的SQL通常更加复杂，尤其是涉及多个表关联的场景</li>
<li>不能直接在生产数据库中执行可能影响业务的SQL（业务重放可能加剧问题的影响面）</li>
<li>需要将生产日志带回安全环境进行分析</li>
<li>手动还原SQL既耗时又可能引入错误</li>
</ol>
<p>这些痛点严重影响了问题排查效率，延长了故障恢复时间；同时也极大的降低了程序员的幸福指数</p>
<h2 data-id="heading-4">三、插件核心功能介绍</h2>
<p>MyBatis SQL Log Merger插件正是为了解决这些痛点而生</p>
<h3 data-id="heading-5">1. 一键将MyBatis日志转换为可执行SQL</h3>
<p>只需将MyBatis日志复制到插件中，即可一键生成完整的、可直接执行的SQL语句。插件会自动识别SQL模板和参数信息，并将参数值正确地代入SQL中。</p>
<p>如在监控的网页上，开启SQL提取功能，选中sql模板和sql传参，直接生成对应的sql；更能一键导航到您配置的sql管理工具站点</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bdb6cc475137488a85c040ba555a784e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54Gw54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090897&amp;x-signature=SXGcDlq4oOn%2Bt7iLeG2pgUx3jLo%3D" alt="00.gif" loading="lazy"/></p>
<h3 data-id="heading-6">2. 独立的SQL合成工具页</h3>
<p>除了上面的在目标网站上注入合成按钮之外，这个插件还提供了一个独立的页面，适用于从非浏览器场景获取Mybatis执行日志的场景，如 IDEA 的控制台日志：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed38fe4512ff4b58a32e1afbab4eef6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54Gw54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090897&amp;x-signature=kJYAPPNlqNvA7ITfMx3fyERPSUE%3D" alt="01.gif" loading="lazy"/></p>
<p>在这个独立的SQL合成工具页中，提供了两种输入方式</p>
<ul>
<li><strong>单框模式</strong>：适用于完整的MyBatis日志，插件自动解析SQL模板和参数</li>
<li><strong>双框模式</strong>：分别输入SQL模板和参数信息，提供更精确的控制</li>
</ul>

















<table><thead><tr><th>输入模式</th><th>示例图</th></tr></thead><tbody><tr><td>单框模式</td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6951e1c9f8ac4f3aba8b4867492b6bf2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54Gw54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090897&amp;x-signature=k26aJRrzYUmxAWu9T%2BIqJqP7Ccg%3D" alt="" loading="lazy"/> <br/> <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/158df85e97fa4ca09b857d1a1ae0abaf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54Gw54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090897&amp;x-signature=CQUdhcyPyzZ3qQIrLfpNhLMk0Mo%3D" alt="" loading="lazy"/></td></tr><tr><td>双框模式</td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3aef7fd95151421ca3c1a682c90bc0a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54Gw54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090897&amp;x-signature=Iuh3k2fd0g4QCPqi3ewfOy3ALqk%3D" alt="" loading="lazy"/></td></tr></tbody></table>
<h3 data-id="heading-7">3. SQL格式化与语法高亮</h3>
<p>生成的SQL支持进行格式化，提高可读性，并提供语法高亮功能，方便快速识别SQL结构和潜在问题；生成的SQL可以通过一键复制到剪贴板，方便粘贴到数据库客户端或其他工具中执行。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f2a9f869e94413db0c0e44808cb0a79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54Gw54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090897&amp;x-signature=ddsStxTBsyquHR7ouQ9pmmTp60o%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">4. 本地处理，保障数据安全</h3>
<p>所有处理都在浏览器本地进行，无需上传任何数据到服务器，确保敏感的SQL信息不会泄露，特别适合处理生产环境日志。</p>
<h3 data-id="heading-9">5. 插件优势</h3>
<ul>
<li>提升开发效率
<ul>
<li>通过自动化处理SQL日志，插件可以将原本需要几分钟的手动操作缩短到几秒钟，大幅提升开发效率。开发人员可以将更多时间专注于业务逻辑的实现，而不是繁琐的日志分析。</li>
</ul>
</li>
<li>支持生产环境安全分析
<ul>
<li>插件的本地处理特性使其非常适合分析生产环境日志。无需将敏感数据上传到任何服务器，确保数据安全，同时又能高效地进行SQL分析。</li>
</ul>
</li>
<li>数据本地处理，无泄漏风险
<ul>
<li>所有处理都在浏览器本地完成，没有任何数据传输，完全避免了敏感SQL信息泄露的风险，符合企业安全要求。</li>
</ul>
</li>
<li>多语言支持
<ul>
<li>插件支持中英文界面，满足国际化团队的需求，让不同语言背景的开发人员都能方便使用。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-10">四、使用方法详解</h2>
<h3 data-id="heading-11">1. 开发场景应用</h3>
<p>在开发环境中使用MyBatis SQL Log Merger非常简单：</p>
<ol>
<li><strong>安装插件</strong>：从Chrome应用商店安装 <a href="https://link.juejin.cn?target=https%3A%2F%2Fchromewebstore.google.com%2Fdetail%2Fmybatis-sql-log-merger%2Fldlekpjpadmkfoohidfgjjcmegdbkbho" target="_blank" title="https://chromewebstore.google.com/detail/mybatis-sql-log-merger/ldlekpjpadmkfoohidfgjjcmegdbkbho" ref="nofollow noopener noreferrer">MyBatis SQL Log Merger</a></li>
<li><strong>获取日志</strong>：从IDE控制台或日志文件中复制MyBatis的DEBUG级别日志</li>
<li><strong>粘贴处理</strong>：打开插件界面，粘贴日志内容，点击"Process SQL/处理SQL"</li>
<li><strong>验证结果</strong>：查看生成的完整SQL，如有需要可复制到数据库客户端执行</li>
</ol>
<p>这种方式可以大大加快SQL验证和调试的速度。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3c7e82b556d447f8a2cf2a8f2652815~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54Gw54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090897&amp;x-signature=Gpa3vZZ2mMDXhYAeAg2fF3fy%2FQ8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">2. 生产场景应用</h3>
<p>在生产环境中分析日志时，可以这样使用(对于有网页可以直接查看服务日志的场景)</p>
<ol>
<li><strong>SQL日志查询网页</strong>：安装插件之后，建议将插件固定到外部工具栏；然后导航到目标网站</li>
<li><strong>激活提取SQL按钮</strong>：点击 Chrome 工具栏中的 <code>MyBatis SQL Log Merger</code> 图标，在弹出窗口中，点击非活动状态指示器旁边的"注入 SQL 提取按钮"切换开关</li>
<li><strong>复制SQL</strong>：直接复制包含SQL模板和SQL参数的两行日志</li>
<li><strong>提取SQL</strong>：点击右小角的提取SQL按钮，将自动得到可执行的SQL语句</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/124f5588c1804ffaa4e4cae41aad120c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54Gw54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090897&amp;x-signature=UYZTcA7SRNmqy975ktm6TXFrfys%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c268ce3f080348d880eba4fd1049e603~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54Gw54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090897&amp;x-signature=nXDxdqtxGdbNkNolFTRtTdC0Uaw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c1d6525874746d7b441088357c01967~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54Gw54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767090897&amp;x-signature=qLRKnCXbexPfj6vpkc4bxPU%2FB4s%3D" alt="" loading="lazy"/></p>
<p>这种方式既保证了生产数据的安全，又能高效地进行SQL分析。</p>
<h3 data-id="heading-13">3. 不同日志格式的支持</h3>
<p>插件支持多种MyBatis日志格式：</p>
<ul>
<li>标准MyBatis日志格式</li>
<li>带"Preparing:"和"Parameters:"前缀的日志</li>
<li>不同日志框架（Log4j、Logback等）的输出格式</li>
<li>自定义日志格式</li>
</ul>
<h2 data-id="heading-14">五、小结</h2>
<p>这个插件的优势还是比较明显的，MyBatis SQL Log Merger插件是一个真正解决开发和运维痛点的工具。它不仅在开发阶段能大幅提升调试效率，在生产环境中也能帮助快速定位和分析SQL相关问题。强烈推荐给每一个有需要的javer开发小伙伴🙂，有兴趣的小伙伴可以直接在谷歌浏览器上点进行下载体验</p>
<ul>
<li>主页：<a href="https://link.juejin.cn?target=https%3A%2F%2Fai.hhui.top%2Fmybatislog%2Findex.html" target="_blank" title="https://ai.hhui.top/mybatislog/index.html" ref="nofollow noopener noreferrer">MyBatis SQL 日志合并工具</a></li>
<li>谷歌插件商店：<a href="https://link.juejin.cn?target=https%3A%2F%2Fchromewebstore.google.com%2Fdetail%2Fmybatis-sql-log-merger%2Fldlekpjpadmkfoohidfgjjcmegdbkbho" target="_blank" title="https://chromewebstore.google.com/detail/mybatis-sql-log-merger/ldlekpjpadmkfoohidfgjjcmegdbkbho" ref="nofollow noopener noreferrer">Chrome商店下载地址</a></li>
<li>项目源码： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliuyueyi%2Fai-chrome-mysql-merge" target="_blank" title="https://github.com/liuyueyi/ai-chrome-mysql-merge" ref="nofollow noopener noreferrer">ai-chrome-mysql-merge</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS CPU 占用率在性能问题中的表现形式]]></title>    <link>https://juejin.cn/post/7586869907066339363</link>    <guid>https://juejin.cn/post/7586869907066339363</guid>    <pubDate>2025-12-23T10:38:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586869907066339363" data-draft-id="7586973107321552936" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS CPU 占用率在性能问题中的表现形式"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-23T10:38:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我是谁的程序员"/> <meta itemprop="url" content="https://juejin.cn/user/2390811467846089"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS CPU 占用率在性能问题中的表现形式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2390811467846089/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我是谁的程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T10:38:37.000Z" title="Tue Dec 23 2025 10:38:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在不少性能讨论里，<strong>iOS CPU 占用率</strong>常被当成一个直观指标：数值高了就是问题，低了就算安全。
但真正参与过线上问题排查之后，会发现这种理解过于粗糙。</p>
<p>我第一次真正被 CPU 占用率困住，并不是因为它“飙到了一个夸张的数”，而是因为——
<strong>它看起来不高，却始终维持在一个不该出现的水平。</strong></p>
<hr/>
<h2 data-id="heading-0">CPU 问题，往往从一句模糊的反馈开始</h2>
<p>那次的反馈很典型：页面不卡，但手机有点热，用一会儿就掉电。</p>
<p>如果只从功能角度看，这几乎没有可操作的信息。
但经验告诉我，这类问题十有八九和 CPU 使用方式有关。</p>
<hr/>
<h2 data-id="heading-1">Instruments 能看到很多，但前提是你知道该看什么</h2>
<p>排查 CPU 的第一反应，通常还是 Instruments。</p>
<p>Time Profiler 很快能给出调用栈、线程分布、函数耗时。
在短时间测试里，一切都显得“还行”：</p>
<ul>
<li>主线程没有明显阻塞</li>
<li>CPU 峰值不高</li>
<li>没有死循环</li>
</ul>
<p>如果就此下结论，很容易认为“CPU 没问题”。</p>
<hr/>
<h2 data-id="heading-2">当 CPU 问题不发生在瞬间</h2>
<p>问题出在这里：
这次的 CPU 异常，并不是某一次操作触发的，而是<strong>持续存在的状态</strong>。</p>
<p>单次 Time Profiler 很难说明：</p>
<ul>
<li>为什么 CPU 一直处在偏高区间</li>
<li>哪些操作在“慢慢累积”</li>
<li>为什么退出页面后 CPU 没有明显回落</li>
</ul>
<p>这类问题，本质上和时间有关。</p>
<hr/>
<h2 data-id="heading-3">把 CPU 放回真实使用环境里看</h2>
<p>后来我换了一种方式，不再急着抓调用栈，而是先观察 CPU 在真实使用过程中的变化。</p>
<p>这一步，我用的是 <strong>克魔（KeyMob）</strong>。</p>
<p>原因并不复杂：
它可以在真机上持续监控 CPU 占用率，并把变化过程完整记录下来，而不是只看某一个采样点。</p>
<hr/>
<h2 data-id="heading-4">一条 CPU 曲线，比一个数值更有说服力</h2>
<p>当我连续使用 App 十几分钟之后，CPU 的问题才真正显现出来：</p>
<ul>
<li>CPU 没有明显峰值</li>
<li>但均值始终偏高</li>
<li>页面切换后没有明显回落</li>
<li>前后台切换时存在短暂抖动</li>
</ul>
<p>这些现象，单独看都不算“异常”，
但组合在一起，就很难忽略了。</p>
<hr/>
<h2 data-id="heading-5">回到 Instruments，这一次目标很明确</h2>
<p>有了趋势之后，再回到 Instruments，事情就变得简单多了。</p>
<p>我开始刻意盯着几段流程：</p>
<ul>
<li>页面切换时的线程活动</li>
<li>某些异步任务是否在后台持续运行</li>
<li>定时逻辑是否按预期结束</li>
</ul>
<p>最终发现，一个看似无害的轮询逻辑，在页面退出后并没有停止。</p>
<p>如果没有前面的长期观察，这个点很容易被忽略。</p>
<hr/>
<h2 data-id="heading-6">WebView 和 CPU，经常是“低调的消耗者”</h2>
<p>在另一个项目中，CPU 占用问题并不来自 Native。</p>
<p>通过 <strong>Safari Inspector</strong>，我发现某些 WebView 页面在退到后台后，仍然有 JS 定时任务在执行。
每一次执行都不重，但长期叠加，对 CPU 的影响非常稳定。</p>
<p>这类问题，用纯 Native 的 CPU 分析工具很难察觉。</p>
<hr/>
<h2 data-id="heading-7">网络行为，有时会把 CPU 问题放大</h2>
<p>还有一次 CPU 异常，最终是通过 <strong>Charles</strong> 才理清楚的。</p>
<p>抓包发现：</p>
<ul>
<li>接口在弱网环境下频繁重试</li>
<li>数据解析逻辑被反复触发</li>
<li>日志输出量明显增加</li>
</ul>
<p>单次看，这些行为都算不上严重。
但在真实使用中，它们共同维持了一个不必要的 CPU 活跃状态。</p>
<hr/>
<h2 data-id="heading-8">CPU 占用率，不是一个孤立指标</h2>
<p>经历这些排查之后，我对 CPU 占用率的理解发生了变化：</p>
<ul>
<li>它不是用来“判定对错”的</li>
<li>而是用来提示“行为是否合理”</li>
</ul>
<p>在工程实践中，我更关心的是：</p>
<ul>
<li>CPU 在什么阶段升高</li>
<li>操作结束后是否能回落</li>
<li>是否存在长期活跃的线程或任务</li>
</ul>
<p>KeyMob 在这里的价值，并不是替代 Instruments，而是帮我<strong>找到该用 Instruments 看哪里</strong>。</p>
<hr/>
<h2 data-id="heading-9">实际工作中常用的一种组合方式</h2>
<p>现在在处理 CPU 相关问题时，我通常会这样配合工具：</p>
<ul>
<li><strong>KeyMob</strong>：观察真机 CPU 长期变化</li>
<li><strong>Instruments</strong>：定位具体消耗点</li>
<li><strong>Safari Inspector</strong>：检查 WebView 行为</li>
<li><strong>Charles</strong>：分析网络引发的 CPU 活动</li>
<li><strong>Xcode</strong>：验证逻辑与线程状态</li>
</ul>
<p>这样做的好处是，不会被单一视角误导。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[终于找到可以一键做 AI 漫剧的方法了]]></title>    <link>https://juejin.cn/post/7586836874016931850</link>    <guid>https://juejin.cn/post/7586836874016931850</guid>    <pubDate>2025-12-23T10:43:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586836874016931850" data-draft-id="7586892413890052142" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="终于找到可以一键做 AI 漫剧的方法了"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-23T10:43:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苍何"/> <meta itemprop="url" content="https://juejin.cn/user/588993963763405"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            终于找到可以一键做 AI 漫剧的方法了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993963763405/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苍何
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T10:43:15.000Z" title="Tue Dec 23 2025 10:43:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是苍何的第 459 篇原创！</p>
<p>大家好，我是继续学习做 AI 漫剧的苍何。</p>
<p>前几天给大家分享了制作 AI 漫剧从 0 到 1 详细教程，深深感受到了大家的热情。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34f259334e824e40b5ef8c90c8f12709~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=5%2Bh%2F6LujSuXx9HC%2FihFf%2BZ1szf8%3D" alt="图片" loading="lazy"/></p>
<p>于是我们决定本周末举办一场关于 AI 漫剧的线下沙龙，目前已经有 100 人报名了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/915ccf466bd24a5fae04fd594fe3da44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=qLZfSd5EOTL%2BUiOjFVp%2Bc64Pqds%3D" alt="图片" loading="lazy"/></p>
<p>其实也想学习那些大神们是用的什么工具和方法，现在感觉到了最大的一个痛点就是，我对影视漫剧制作行业一无所知。</p>
<p>特别对于分镜剧集的把控，可以说非常失控。</p>
<p>既然 AI 都这么牛了，理论上应该有能一键出漫剧的平台吧，一找，还真有，而且不少。</p>
<p>一番了解后尝试了个朋友推荐的新工具，实现了我一键做 AI 漫剧的需求。</p>
<p>我们先来看看效果，先来个简单的《哪吒闹海》故事漫剧：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71806cdd4c544f6f83b8ce5f7199c830~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=vwDG2RYg9D6qJ6bfgPetKqCxy5E%3D" alt="wxv_4291534038629990405" loading="lazy"/></p>
<p>马上元旦了，来个Q版祝福吧：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae0773c52f8e4d378ef2a017e4d222cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=afmVJB60m9TkuVFLoMy%2FWTApDXk%3D" alt="wxv_4292152091554185235" loading="lazy"/></p>
<p>然后我还做了两个稍微复杂一点的，《滕王阁序》的故事：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/832e94f130d14d298cbe6c39cf027b86~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=TYZGuL1tOLtC3PYAS%2BCYCOZp1FU%3D" alt="wxv_4291534670208270337" loading="lazy"/></p>
<p>还整了个《凡人修仙》前传的剧情：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83ee238805ce48ed806e6a4b9e6e93b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=%2FvFJE7EHAX5UlEll0Q%2FrxSE3PZI%3D" alt="wxv_4291536283052015618" loading="lazy"/></p>
<p>这几个漫剧都是直接一键直出，不用自己考虑剧集和分镜。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15255337a29749428c3fd1c9a5c283c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=Fh2RO1lWh0mK0LbQ9uOc0QkR%2Bqk%3D" alt="图片" loading="lazy"/></p>
<p>真正做到了一句话（或者一份剧本），Agent 就可以自动完成剧本填充、人物、场景、风格设定，自动批量制作分镜图以及自动批量生视频，最后导出完整视频。</p>
<p>甚至配音和音乐都是一键生成，不用切换平台剪辑处理了。</p>
<blockquote>
<p>下面给大家分享一下我整个的创作过程，如果对你有帮助可以点赞三连支持告诉我。</p>
</blockquote>
<p>我把这次的 AI 漫剧制作 做了个信息图。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2ddefb308dc4f4489b0a21b1c39fa27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=a7mVPBHaLxdiGnWK%2BO3iNnixjOM%3D" alt="图片" loading="lazy"/></p>
<p>先说下工具，这次用的是商汤科技的的 Seko2.0，地址在这里：seko.sensetime.com</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6567b629558944a0ad9e5c227bdfe40d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=I4R%2BeSB0q2ZDKeTl9c7n7AgmNR0%3D" alt="图片" loading="lazy"/></p>
<p>这里除了一句话生成外也是可以上传剧本的，参考生图模型有即梦 4.0</p>
<p>在漫剧创作的时候，主角是非常重要的，之前我还用 NotebookLM 帮生成主角，现在 Seko 中可以直接使用内置的主体，比如拉布布、娜扎等，也可自定义一个主体。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b011fef7d1d240e184276f00c11a5daa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=gHMFDo1wk9bAtRkAL6ICAUrkpW0%3D" alt="图片" loading="lazy"/></p>
<p>这点很重要，我们必须先确认人物的主体，再选择想要的风格，在 Seko 中可以直接添加多种的风格，卡通、3D、日漫等，种类比较全，完全够用了，不够也可以自己自定义。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f40a491f9c82441b83f58e65a9a2ced2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=RPOPq5UCpj0LzmLgRajWr8VCM8k%3D" alt="图片" loading="lazy"/></p>
<p>下面就以我创作的作品《滕王阁序故事》来简单分享下我的创作流程。</p>
<p><strong>第一步，上传剧本或者一句话描述。</strong></p>
<p>点击对话框一句话输入：“讲述王勃创作《滕王阁序》时的故事”。选择画风为古风。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d5c84aa77b042eebda4b557ae69fdc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=eOxoxYcf6FGibMFPz%2B%2FOVj4QFdk%3D" alt="图片" loading="lazy"/></p>
<p>注意开启多剧集模式，就可以分多集制作视频。</p>
<p><strong>第二步，策划剧本大纲</strong></p>
<p>点击开始就可以看到它开始吭哧吭哧的干活了，首先出策划剧本大纲，交代基本信息、主要角色以及情节概要。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d740f30a84b49e58625be522474e4a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=lmlD3x1JgQOTCLlMVPu3CpILo1w%3D" alt="图片" loading="lazy"/></p>
<p>然后规划剧集，可以看到这里 Seko 一共帮规划了 5 集，并给出了分镜大纲。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a153a9baf1440e3bba7fcff890243d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=ZEiEbdG5mwYjsraLh1jJFbKQj28%3D" alt="图片" loading="lazy"/></p>
<p>如果对以上的部分有任何不满意，直接在对话框中就可以修改，直到修改满意之后，确认剧本大纲发送。</p>
<p><strong>第三步，分集制作分镜</strong></p>
<p>接下来开始分集制作分镜了，确认了剧本大纲之后，就会分为左右 2 栏，左边为剧本大纲，右边为每一集的故事梗概、美术风格、主体列表、场景列表以及分镜剧本。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/511ccd049228400f82ee3ba0b0f58b71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=g0fcL%2BqSkWtEMNHaEdkCdd62SOA%3D" alt="wxv_4292155039546032133" loading="lazy"/></p>
<p>这是自动生成的主体列表，会在以后的场景中使用到，并 保证整体人物的一致性。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbb33fd9b5364622beef716c5cef589c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=AWs02z99%2FzWW%2BZmf2R6O4y51co0%3D" alt="图片" loading="lazy"/></p>
<p>这里生成的场景图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8eb45b6d20c34fe3a55abb94f9731ee9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=ZIhjhPGNHen1inPa5YjvWXb9VCs%3D" alt="图片" loading="lazy"/></p>
<p>在一集中同一个场景里的各种景别构图，例如第一集中在滕王阁宴这个场景，几个分镜均为滕王阁宴的远、中、近、特，更加符合剧情片的实际生成使用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10bd500de5784acc985865f3de54de62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=wLKY1DsV7cDIwjbuUW8XznDP6FU%3D" alt="图片" loading="lazy"/></p>
<p>第二集中的滕王阁里面的场景也高度保持了场景的一致性，这点非常重要。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6aa59b826727499e8fb9e22aece1108c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=YoNioSr%2BqCwYQhidCddC2%2FDyiMQ%3D" alt="图片" loading="lazy"/></p>
<p>如果对主体列表及场景列表有任何的不满意，可以点击图片右上角的修改图标，进去修改，对分镜剧本不满意的可以直接对话框中修改。</p>
<p>以上内容确认无误之后，可以选择屏幕右下角的模型、画面比例，之后点击生成分镜</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/411327f2172f402da929ae18c5bd200b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=GB%2B9sYEnuiTCijuUJfw4KMM7A9g%3D" alt="图片" loading="lazy"/></p>
<p>Agent 就开始一步一步执行了，分析脚本、明确分镜主体、匹配参考风格、设计构图等这些都是自动执行的，我们只要看着就好。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c42ef3f5390c4fc3b213820304b033fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=U8GYAQZtRzTko%2Brj%2FOWIBeZNZBo%3D" alt="图片" loading="lazy"/></p>
<p>然后就出来了分镜图，如果想看全部的分镜图，可以点击右下角的故事版视图查看所有。</p>
<p>在这里可以从左至右浏览每一个分镜图是否符合要求，如果不符合要求，可以点击屏幕中间的画布编辑，对分镜图进行编辑，包括消除、局部重绘制，元素添加以及裁剪，编辑完成之后点击右上角的应用修改即可。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e580b2d8745648dbb71960f427515e2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=0Bjy%2BWDrgAmU6Vt3weiUdXWY%2F1o%3D" alt="图片" loading="lazy"/></p>
<p>也可以选中下方要修改的分镜图，在屏幕左侧中部，图片提示词板块，点击重新编辑或者引用改图，进行修改。</p>
<p><strong>第四步，分镜转视频</strong></p>
<p>依次修改完分镜图之后，点击右上角的一键转视频，即可将所有的分镜图转为视频。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c96da59a14c64e2e9ab5cb2680e29cc7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=rg4Z6FlIvrSPAkeFve5dD%2F%2Fwd1I%3D" alt="图片" loading="lazy"/></p>
<p>所有分镜图转为视频之后，可以选中需要修改的视频，在屏幕左侧中间的视频提示词板块，修改视频。</p>
<p>如有对口型的需要，可以点击屏幕中上部的对口型，重新制作视频</p>
<p>如果对声音不满意，点击左上侧的配音按钮，即可对当段视频进行声音修改</p>
<p>逐一修改好视频之后，点击导出就可以得到第一集的视频了</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44b05136c2534cef89572e6c39afab12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=u6iutFa%2BV6dTG%2FogEHFpnEGzcjM%3D" alt="图片" loading="lazy"/></p>
<p>点击屏幕左上角的返回策划，回到剧集策划页面，点击左侧中部的加号按钮，就可开始第二集、第三集的创作啦。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c211d42f003c480c84a37e9ba42d2017~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=0gw7qWeMOub0BouipZXxP60FRCo%3D" alt="图片" loading="lazy"/></p>
<p>这个 Agent，可以说完全解决了 AI 漫剧创作的不少痛点，生图支持即梦等，而且速度贼快，完全省心省力，爱了爱了。</p>
<p>以上就是基本的一个步骤，人工大部分时间是用来做最后的决策，Seko 的 Agent 帮我自动做了很多工作。。</p>
<p>这真的达到了一键做漫剧了，也不需要什么过多复杂的提示词，通通交给 Agent。</p>
<p>我发现 Seko 在多集中依旧能保持上下文记忆，全过程都能保持每集中剧情对应的主体和场景调用的参考图一致，这样才不至于每集生成的人物和场景的随机。</p>
<p>刚好看到官网有优惠活动，到今年 12 月 31 日，免费生成 100 张，而且这段期间年会员直接半价，买积分的话也有 8 折优惠。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f386b24b298e4a63af8ac6baba05c3cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091395&amp;x-signature=2%2FXUja6RcdCYZsIUMTiv2tEPgzo%3D" alt="图片" loading="lazy"/></p>
<p>很兴奋，又剁手冲了，希望能多做些漫剧，圆我梦。</p>
<p>突然想起那些曾经被困在漫长流程里的灵感，被时间消磨的热情，现在有了更快抵达世界的方式。</p>
<p>技术进步的真正温度，或许不在于它取代了什么，而在于它为我们腾出了什么：腾出双手去捕捉更多转瞬即逝的创意，腾出心力去打磨故事里更动人的细节，最重要的是，腾出那份“也许我能试试”的勇气。</p>
<p>当工具隐入幕后，站在聚光灯下的，始终是那个渴望讲述、渴望被看见的你。<strong>而最好的作品，永远诞生于人类讲故事的本能，与时代赋予的新可能相遇之时</strong>。</p>
<p>这条路的前方，会有更多人的创作之梦，被温柔地照亮。</p>
<p>不妨试试看，也许你的下一个想法，就能快速变成一部作品。期待在评论区，看到你用它打造出的第一个成果。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 LiblibAI 做爆款动态海报，绝了！（附教程）]]></title>    <link>https://juejin.cn/post/7586865729703051302</link>    <guid>https://juejin.cn/post/7586865729703051302</guid>    <pubDate>2025-12-23T10:52:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586865729703051302" data-draft-id="7586865729703034918" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 LiblibAI 做爆款动态海报，绝了！（附教程）"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-23T10:52:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苍何"/> <meta itemprop="url" content="https://juejin.cn/user/588993963763405"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 LiblibAI 做爆款动态海报，绝了！（附教程）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993963763405/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苍何
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T10:52:44.000Z" title="Tue Dec 23 2025 10:52:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是苍何的第 460 篇原创！</p>
<p>大家好，我是苍何。</p>
<p>最近刷到非常多这样的动态海报，效果都非常惊艳。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2e382d3cb9a41f39b1d48728dbc0a45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091964&amp;x-signature=zntKy3OdmAfxhUF7%2BMYlCE1uaLM%3D" alt="图片" loading="lazy"/></p>
<p>和传统海报不同，是一张可以动起来的海报，更具备视觉冲击力。</p>
<p>觉得还挺有意思的，也想来玩玩，看了很多教程，然后今天给大家分享下怎么制作。</p>
<p>工具的话用的是博主推荐最近很火的 LiblibAI，地址：👉 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.liblib.art" target="_blank" title="https://www.liblib.art" ref="nofollow noopener noreferrer">www.liblib.art</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7492edf577e488689da03ac7abe9b2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091964&amp;x-signature=izN18qY4SdJvePQ4g0XIku5JyUE%3D" alt="图片" loading="lazy"/></p>
<p>这是我做出的几个效果：女王风海报走秀场：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad995f2c6ffc4e05880332db62c60159~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091964&amp;x-signature=Lmdp%2FeE6m5AIi1VaSsXd6teVwx0%3D" alt="wxv_4292898758599491590" loading="lazy"/></p>
<p>还有这种也很好看：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3e501b76d02415f94c873137cb6f374~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091964&amp;x-signature=erKSmVySAw%2BXTNemCEqjcCvPFzo%3D" alt="wxv_4292899348805173253" loading="lazy"/></p>
<p>再来一个伞送快递动态海报风：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ec7b27cf2434253966c51603d27b47d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091964&amp;x-signature=mjj0L%2BcXu1WrlyPK61vH2O3aMys%3D" alt="wxv_4292899728792338438" loading="lazy"/></p>
<p>再来一个树木开花过程的动态海报：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8d046671d164cc799dfeee439aaa75d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091964&amp;x-signature=FM96CGe0dTjggBH9ddeXGomF6wk%3D" alt="wxv_4292900146964545541" loading="lazy"/></p>
<p>再来个产品营销别样动态海报：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2719c018e0614cceaf492afb63419d86~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091964&amp;x-signature=OiYUr2mJsBX0Utsn7w0gE06NoGU%3D" alt="wxv_4292900646103498755" loading="lazy"/></p>
<p>这种动态海报都是怎么做出来的呢？其实很简单，一共有 2 种方法。</p>
<p>先说第一种，整体思路是：先在 LiblibAI 生成图片，再将图片作为参考一键生成特效视频，然后导出，最后转 GIF。这种是最简单的，全程无需切换平台，在 LiblibAI 就可以完成一站式的动态海报创作。</p>
<p>一共分为以下四步：</p>
<p><strong>第一步，生成原始底图片</strong></p>
<p>在 LiblibAI 中选择图片生成，生图模型选择 Seedream 4.5。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f899f3f1f28439bb91a5d6eff010371~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091964&amp;x-signature=Ir2hh3jHMYxMBrNLIgPelWG1qqw%3D" alt="图片" loading="lazy"/></p>
<p>选择单图模式，4k 画质，9：16 比例。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b986f3bd17841c19e8daaa25d4912c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091964&amp;x-signature=AHFu3BSUaNkduPhSSuMd6%2BiPBt0%3D" alt="图片" loading="lazy"/></p>
<blockquote>
<p>提示词输入：一个中国古装美女在花园里面采花，长发。</p>
</blockquote>
<p><strong>第二步，生成原始底图片</strong></p>
<p>然后就会生成 4 张图片，选择自己喜欢的一张，以此作为参考图，来生成一张海报，</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1ebddb29cc441daa2d79adff9121ecb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091964&amp;x-signature=WKy7g69LmOhZ%2FhrJd2YxlS%2FudaQ%3D" alt="图片" loading="lazy"/></p>
<blockquote>
<p>输入提示词：帮我把这张图片生成海报图，类似 vogue 等杂志的海报</p>
</blockquote>
<p>就会生成四张海报图，可以选择自己最喜欢的一张。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22cb3ece86724410a43ef0f46aeb1366~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091964&amp;x-signature=YLkA7NOUJIHlHZDB6%2Bc3TK2ikh8%3D" alt="图片" loading="lazy"/></p>
<p>如果没有满意的可以点击重新生成。</p>
<p><strong>第三步，根据海报图生特效视频</strong></p>
<p>选择生视频模型通义万相 2.5，1080 P，5 s。在特效这里选择「羊驼入境特效」</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8f9da5ac6744a53813c97d35b016bcb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091964&amp;x-signature=zbnjZWhubd%2BNvaqiOgHJSCVa64k%3D" alt="图片" loading="lazy"/></p>
<p>LiblibAI 还是方便，内置了非常多的视频模型，比如最新的海螺 2.3、可灵 2.6、通义万相 2.5 等。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b3d0c8f93a8452bab739241c4269def~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091964&amp;x-signature=pFq5Wb2fxRC8NdAG35Ca1MZNY9s%3D" alt="图片" loading="lazy"/></p>
<p>在特效上，更是非常多好玩的内置特效，根本划不完，特效的使用是动态海报最为关键和省事的一步。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/085d338b77a34e15ba376785ced4263e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091964&amp;x-signature=UeGKn9eq%2FkbTowyjzo619mGYHek%3D" alt="图片" loading="lazy"/></p>
<p>他这里的特效相当于内置了视频效果，用上后就能发挥非常多有意思的 idea，像很多爆火的 AI 短视频，很多都是通过这种特效做出来的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e0faf17592544d3aee5d2ad7bd82b83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091964&amp;x-signature=DoxwXL%2B6RlsWQrFVTQXLXIkKUIM%3D" alt="图片" loading="lazy"/></p>
<p>生成好视频后直接导出，可以选择无水印导出，这里可以进行设置，不过第一次是让自己选择的，我通常会选择无水印导出。</p>
<p>然后在 Eagle 等工具中将视频一键转 GIF，就能生成一张好看的动态海报了。</p>
<p>第二种就是对于文字内的调整会更高一些，在 LiblibAI 中生成底图和对应的特效视频后，导出到剪映，选择字体并配特效，达到效果。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dbdb1ac73f184c2898c0ccdf36b61965~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091964&amp;x-signature=JEnxM60iWY8aZlplOGPpw27Ak9c%3D" alt="图片" loading="lazy"/></p>
<p>整体感觉要想快的话就直接在 LiblibAI 中一站式生成，但有些特效对文字的效果不可控，可以多试试一些特效。</p>
<p>比如这个「自然生长」特效，配合这个提示词，就能出这样的效果。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d5fab6c99764785b2e53192a3dad49e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091964&amp;x-signature=tXwQF26Ve8ELnM%2BVd1FHp4AekfM%3D" alt="图片" loading="lazy"/></p>
<blockquote>
<p>提示词：文字一致保持在画面上不变，背景枯萎的树枝上长出新芽和鲜花。</p>
</blockquote>
<p>做了几个海报觉得还不过瘾，又玩了很多 LiblibAI 上的特效，很有意思。</p>
<p>比如配合这个「巨物闯入」的特效，出来一个非常 nice 的效果。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54066f36b00346d899fb7e3be044afdd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091964&amp;x-signature=mhFww3NQv9%2FXSiOA0r46ntHOOFY%3D" alt="图片" loading="lazy"/></p>
<p>提示词直接复刻的特效广场中提示词：</p>
<blockquote>
<p>FPV 视角，高运动运镜，镜头拉远，惊恐的拉布布拼命奔跑，后面的怪物穷追不舍，乌烟瘴气的氛围，惊吓追逐的场景</p>
</blockquote>
<p>最终效果如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44c0186852ca4051adef0eb18e48e234~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091964&amp;x-signature=wtUFU6iBG1yjHWck1y9t2erGw3M%3D" alt="wxv_4292901441511194629" loading="lazy"/></p>
<p>还有这个特效做出来的效果也很有意思：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ad1369e9eb44fe894a2c67369dd0826~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091964&amp;x-signature=Zmy983plg5PUcBCjXyk19Zhixcg%3D" alt="wxv_4292901942579609603" loading="lazy"/></p>
<p>谁又能拒绝这样的洗发水呢？</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f907d5ea58045fd81111989b6322561~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091964&amp;x-signature=K5cnVh28J%2BfsY4W1yIVdOHUBNKs%3D" alt="wxv_4292902335384567814" loading="lazy"/></p>
<p>我算是发现了，在 LiblibAI 中有超级多的模型可以用，还有非常多有意思的特效，然后每个特效又有非常多的创作者来复刻生成自己的作品。</p>
<p>如果你也感兴趣，可以去玩一玩：地址：👉 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.liblib.art" target="_blank" title="https://www.liblib.art" ref="nofollow noopener noreferrer">www.liblib.art</a></p>
<p>一站式创作平台+AI 内容社区，也难怪 LiblibAI 能获得 1.3亿美金融资。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02a813366d7340b2935c2d6aeebec375~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767091964&amp;x-signature=2gnqXZwii057ALwQeEFEAmxJRrw%3D" alt="图片" loading="lazy"/></p>
<p>之前还发布过一篇文章专门讲 LiblibAI 获得巨额融资的事情。</p>
<p>用产品圈数据、用数据喂模型、用模型强产品，Liblib 这个飞轮的转速很厉害。</p>
<p>好了，以上是用 LiblibAI 做爆款动态海报的全部教程，感谢你的阅读，我们下一期见。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[NineData第三届数据库编程大赛：用一条SQL解数独问题]]></title>    <link>https://juejin.cn/post/7586855770504658978</link>    <guid>https://juejin.cn/post/7586855770504658978</guid>    <pubDate>2025-12-23T10:53:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586855770504658978" data-draft-id="7586851351469178920" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" NineData第三届数据库编程大赛：用一条SQL解数独问题"/> <meta itemprop="keywords" content="云计算,数据库,AI编程"/> <meta itemprop="datePublished" content="2025-12-23T10:53:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="NineData"/> <meta itemprop="url" content="https://juejin.cn/user/1684900320129816"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             NineData第三届数据库编程大赛：用一条SQL解数独问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1684900320129816/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    NineData
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T10:53:21.000Z" title="Tue Dec 23 2025 10:53:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>2025 第三届数据库编程大赛正式开启！</strong> 本次大赛由 NineData 和云数据库技术社区主办，并联合佰晟智算、达梦数据、 ITPUB、CSDN、IFclub、开源中国、DataFun、墨天轮等技术社区，共同举办了本次《第三届数据库编程大赛》，诚邀各路数据库以及编程技术大牛踊跃参与！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0edc5ca4020140c68fca8f80a404cc9f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmluZURhdGE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092001&amp;x-signature=rk8awSOgDPVOfpzJHCoRJUDZaRs%3D" alt="2025第三届数据库编程大赛正式开启.png" loading="lazy"/></p>
<p>数独是一种经典的逻辑推理游戏，其规则简洁而富有挑战性，玩法核心围绕已知数字，运用排除法、唯一法等逻辑推理技巧，逐步确定所有空格中的数字。本届大赛延续 "一条 SQL" 的核心挑战 <strong>，设置题目为「用一条 SQL」解数独问题</strong>。</p>
<p>往期大赛回顾：</p>
<p>2023年数据库编程大赛回顾：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzg5NDg3MjQ0NA%3D%3D%26mid%3D2247486656%26idx%3D1%26sn%3Dca1d1835c11b4e147a04f501f7a1e47a%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=Mzg5NDg3MjQ0NA==&amp;mid=2247486656&amp;idx=1&amp;sn=ca1d1835c11b4e147a04f501f7a1e47a&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">一条SQL计算扑克牌24点</a></p>
<p>2024年数据库编程大赛回顾：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzg5NDg3MjQ0NA%3D%3D%26mid%3D2247488866%26idx%3D1%26sn%3D9e3a1a9ad424546ea5b0065b7257618a%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=Mzg5NDg3MjQ0NA==&amp;mid=2247488866&amp;idx=1&amp;sn=9e3a1a9ad424546ea5b0065b7257618a&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">一条SQL秒杀100万张火车票</a></p>
<h2 data-id="heading-0">大赛奖品</h2>
<p>本次数据库编程大赛的奖项安排：一等奖(1人）、二等奖(2人）、三等奖(3人)、阳光普照纪念奖（50人）。</p>
<ul>
<li>
<p><strong>一等奖(1人）</strong> ：大疆无人机 DJI NEO 2 畅飞套装 1 组 + 奖杯</p>
</li>
<li>
<p><strong>二等奖(2人</strong>）：Fuzozo 芙崽AI情感陪伴机器人 1 个 + 奖杯</p>
</li>
<li>
<p><strong>三等奖(3人)</strong> ：华为蓝牙耳机 1 个 + 奖杯</p>
</li>
<li>
<p><strong>阳光普照纪念奖（50人）</strong>：办公养生壶 1 个</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6ad7eab6fd345419ce2401d556c86cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmluZURhdGE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092001&amp;x-signature=%2B03peHbhzJOZT%2BTIqUh8JWl9bv0%3D" alt="数据库编程大赛奖品，欢迎来挑战.png" loading="lazy"/></p>
<h2 data-id="heading-1">比赛玩法</h2>
<p>参赛时间</p>
<ul>
<li>开赛提交：2025.12.23 ~ 2026.01.08 22:00 截止</li>
<li>测试评分：2026.01.09~ 2026.01.10</li>
<li>决赛答辩：2026.01.12（在线）</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28f9e1abebb646bf813c495ef5524082~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmluZURhdGE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092001&amp;x-signature=nQ9xNpWpmtdbWMnDcUNY9aGWBH4%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-2">比赛题目</h2>
<p>数独是一个非常流行的益智数字游戏，常见有四宫格和九宫格模式，其规则简洁而富有挑战性。在本届大赛中，我们设置了两个难度级别：</p>
<h3 data-id="heading-3">1. 普通挑战：四宫格数独</h3>
<p><strong>完成普通挑战的前50名选手，即可获得参赛纪念奖品</strong></p>
<p>在 4×4 方格内填入 1-4 的数字，要求每行每列和上下、左右每小组的 4 个数字不能重复。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d6585d07d554683ac5154f7087eb8b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmluZURhdGE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092001&amp;x-signature=sMNk8T1pQlkFB6WuL1zQLHBY%2BmE%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-4">普通挑战（sudoku 4_4）</h4>
<ul>
<li>数据规模: 100 rows</li>
<li>使用一条 SQL 给出如下图结果。字段 id 为自增字段的数字主键，字段 puzzle 是题目内容，由 4×4 个数字组成，问号表示未知的数字，其中 result 字段是选手需要给出数独的解。 </li>
</ul>
<p>要求选手使用一条SQL给出如下结果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f315be1d47b44c99b4aae94e29906ab4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmluZURhdGE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092001&amp;x-signature=8s4bLTcJ4oeM%2F5evjWnRVR1w%2FJI%3D" alt="图片" loading="lazy"/></p>
<blockquote>
<p>完成普通挑战，可以进一步参加进阶挑战（注：提交进阶挑战SQL前必须先提交普通挑战的SQL）</p>
</blockquote>
<h3 data-id="heading-5">2. 进阶挑战：九宫格数独</h3>
<p><strong>性能得分加解题正确性得分排名前8，成绩进入决赛评选</strong></p>
<p>在 9×9 的方格内填入 1-9 的数字，要求每行每列和上中下、左中右每 3*3 小组的 9 个数字不能重复。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ce7519f9f6345a38bbe88e45ee16c42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmluZURhdGE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092001&amp;x-signature=eBPl2rh%2BtAC2ib9jeNFzsKn%2FOAk%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-6">进阶挑战 ( sudoku 9_9 )</h4>
<ul>
<li>数据规模: 1000~100万 rows</li>
<li>使用一条 SQL 给出如下图的结果。字段 id 为自增字段的数字主键，字段 puzzle 是题目内容，由 9×9 个数字组成，问号表示未知的数字。其中 result 字段是选手需要给出数独的解。</li>
</ul>
<p>要求选手使用一条SQL给出如下结果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24c2e24942594de193086104c5fb9cbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmluZURhdGE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092001&amp;x-signature=WQDZFGng9Wk5jTxMBMLVDo2BiFc%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-7">比赛规则与约束</h2>
<h3 data-id="heading-8">SQL要求</h3>
<ul>
<li>仅允许使用一条 SQL 语句，允许使用数据库内置函数，不允许使用存储过程/自定义函数和代码块。</li>
<li>SQL 执行时间不超过 5 分钟，超过 5 分钟则认为成绩无效。</li>
</ul>
<p>校验与运行环境</p>
<ul>
<li>参赛者可以在以下环境中自行验证 SQL 的正确性：1. NineData 平台 demo 数据库、2.参赛者自有数据库环境</li>
<li>组委会评测环境配置：4 核 CPU，32 GB 内存</li>
</ul>
<h3 data-id="heading-9">提交规则</h3>
<ul>
<li>每位参赛者最多可提交 10 次比赛代码，提交的 SQL 不能超过 10 KB 大小，以最后一次提交的 SQL 作为最终参赛代码</li>
</ul>
<h3 data-id="heading-10">诚信与原创性要求</h3>
<ul>
<li>选手个人诚信参赛，不允许提交他人比赛代码。如发现 SQL 方案高度相似，工作组以第一个提交的为有效参赛</li>
<li>严禁互相抄袭答案，如果发现有雷同代码，组委会将取消成绩。</li>
</ul>
<h2 data-id="heading-11">测试数据与验证流程</h2>
<ol>
<li>进入 NineData 官网（<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ninedata.cloud%25EF%25BC%2589%25EF%25BC%258C%25E6%25B3%25A8%25E5%2586%258C%25E5%25B9%25B6%25E7%2599%25BB%25E5%25BD%2595" target="_blank" title="https://www.ninedata.cloud%EF%BC%89%EF%BC%8C%E6%B3%A8%E5%86%8C%E5%B9%B6%E7%99%BB%E5%BD%95" ref="nofollow noopener noreferrer">www.ninedata.cloud），注册并登录</a> NineData 控制台</li>
<li>打开 SQL 窗口，申请一个 mysql demo 数据库</li>
<li>查询 demo 表数据，game3.sudoku4_4， game3.sudoku9_9 </li>
<li>在 SQL 窗口编写参赛 SQL 并验证逻辑</li>
<li>在 NineData 官网提交参赛 SQL</li>
</ol>
<h2 data-id="heading-12">参赛数据库</h2>
<p>大赛可以使用的数据库种类以及相应支持版本：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b484eb634a8401cac8f0a30a53ebbb4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmluZURhdGE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092001&amp;x-signature=ATV9HvYs9NqDiOIdH08aHNGvFQ0%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-13">参赛提交</h2>
<p>通过数据库编程大赛入口报名，提交 SQL 答案的表单。参赛人员需要提交信息：1. 姓名、2. 邮箱、3. 联系方式、4. 数据库类型 、5. 数据库版本、6. SQL、7. 算法说明。</p>
<p><strong>方式一：官网提交</strong></p>
<p>登录 NineData 官网，参赛地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ninedata.cloud%2Fsql_sudo2025" target="_blank" title="https://www.ninedata.cloud/sql_sudo2025" ref="nofollow noopener noreferrer">www.ninedata.cloud/sql_sudo202…</a></p>
<p><strong>方式二：公众号后台</strong></p>
<p>NineData 公众号后台回复「数据库编程」，立即获得参赛入口链接。</p>
<p><strong>方式三：数据库编程大赛群</strong></p>
<p>扫码进群后，自动获得参赛活动地址和提交答案入口。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68ee2097d87f468b9f5a79a42b8e3307~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmluZURhdGE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092001&amp;x-signature=XCFd%2B2hnqgysRX0xSeT5BN437iQ%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-14">大赛评选规则</h2>
<p>**本次大赛的评委，均是数据库领域的领军人物，通过主办方 NineData 的邀请，组成 2025 年第三届《数据库编程大赛》强大的评审嘉宾团。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6c5474d8463478e9c79445a53065cca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmluZURhdGE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092001&amp;x-signature=1g65lszgIzEV1w2AL44JUXsI6oc%3D" alt="图片" loading="lazy"/></p>
<p>《第三届数据库编程大赛》评审嘉宾团本次大赛主要会从以下 4 个方面评审，一定要注意下面的评审规则！</p>
<p><strong>正确解题数量排名（30%）</strong></p>
<p>总得分占比30%，组委会验证：第一名 30 分，第二名 25 分，第三名 22 分，第四名 20 分，第五名 19 分，后面每排名下降一名减少 1 分，以此类推，最低得 10 分。</p>
<p><strong>性能（30%）</strong></p>
<p>总得分占比 30%，组委会给出测试成绩（第一名 30 分，第二名 25 分，第三名 22 分，第四名 20 分，第五名 19 分，后面每排名下降一名减少 1 分，以此类推，最低得 10 分），总得分占比 30%。进阶挑战，sudoku9_9 表的记录数 1000~100万。</p>
<p><strong>代码创新性（20%）</strong></p>
<p>总得分占比 20% ，由评委打分（ 0~20 分）</p>
<p><strong>代码易读性（20%）</strong></p>
<p>总得分占比 20% ，由评委打分（ 0~20 分）</p>
<h2 data-id="heading-15">赛事日程</h2>
<p>本次大赛提交答题的截止时间：2026 年 01 月 08 日 22:00 点</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1b1eb96d37f481683b133ca7e5995ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmluZURhdGE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092001&amp;x-signature=p4hQmlSI0F%2FZaU8NzgoTsrR2iw4%3D" alt="图片" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[免费！漫画 PPT + 全文档讲解，这谁顶得住啊。。。]]></title>    <link>https://juejin.cn/post/7586893663075368970</link>    <guid>https://juejin.cn/post/7586893663075368970</guid>    <pubDate>2025-12-23T10:54:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586893663075368970" data-draft-id="7586865729703067686" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="免费！漫画 PPT + 全文档讲解，这谁顶得住啊。。。"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-23T10:54:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苍何"/> <meta itemprop="url" content="https://juejin.cn/user/588993963763405"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            免费！漫画 PPT + 全文档讲解，这谁顶得住啊。。。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993963763405/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苍何
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T10:54:27.000Z" title="Tue Dec 23 2025 10:54:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是苍何的第 461 篇原创！</p>
<p>大家好，我是周末不休息的卷 B 苍何。</p>
<p>这两天实在太忙了，忙的 OpenAI 刚发布十周年🎁的 GPT 5.2 都没来得及看，更别说第一时间给大家做分享。</p>
<p>不过没关系，消息估计都满天飞了。</p>
<p>完全可以借助 AI 搜索来帮助快速整理信息，供我学习（tou kui）。</p>
<p>于是照例先在秘塔上搜索 GPT 5.2 相关情报。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5dc3f31267ed48e1ab80385f58fba1e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092067&amp;x-signature=EKJSta7xcYMsUU5Ds6rzqkWw24U%3D" alt="图片" loading="lazy"/></p>
<p>好，已经迅速掌握到信息，但要想分享到社群，最好是可视化好些，光秃秃的文字，群友会提 8 米长的大砍刀架在我脖子上的。</p>
<p>文字转 PPT，然后发个 PPT 版本是我惯用伎俩，这东西转一下，秘塔原先直接就支持，直接点击搜索结果下方的「生成幻灯片」就好了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b844269d227c4355b3ee48c4d5926956~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092067&amp;x-signature=OC4gZGx8EDiP7EKSQAZWBsLvozU%3D" alt="图片" loading="lazy"/></p>
<p>选择具体页数、字数、语言先生成大纲：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/792dec817ddf4486a16540788988f5db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092067&amp;x-signature=neBULTjuG%2BeppKU092CT%2BxoNXIo%3D" alt="图片" loading="lazy"/></p>
<p>这地方突然蹦出了个「图片幻灯片风格」可供选择：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70b3fe09af1748be93f11bba74d8046e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092067&amp;x-signature=laa0PvLyuJpS3JnuI2hzQQHt464%3D" alt="图片" loading="lazy"/></p>
<p>机灵的我一下子就发现了，这不就是最近爆火的香蕉做 PPT 吗？还记得苍何之前分享过的做 PPT 工具，第一个，NotebookLM 吗？</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0563628709a946aaaeebf47cf1184ca4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092067&amp;x-signature=0VxiSHze94cb6rp2TBRpjM8MiDw%3D" alt="图片" loading="lazy"/></p>
<p>这种风格的 PPT 超级无敌爆炸火，火到几乎所有的 PPT 产品都这样玩了，秘塔这波也算是贼快。</p>
<p>但仔细了解了下他们官方介绍，根本不是接的香蕉 pro，而是基于国产大模型<del>山寨</del>致敬了一个（内部代号Meta-banana🍌</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81d05ed6522b4ca09ebd1bdf47e34028~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092067&amp;x-signature=it4MW%2BxZeBK9Hd5RFmb6NCA3JT4%3D" alt="图片" loading="lazy"/></p>
<p>没别的好说的，就冲他这勇气，而且秘塔一直主打的免费，搞的我都挺不好意思的，新出的功能不得好好玩玩。</p>
<p>目前可选的图片风格内置了不少，多格漫画、黑板报风、手账风等。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6563108f2d645d5a18a9b6fd5636830~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092067&amp;x-signature=Bz9smBDLyKdSbyHEIZ6U%2FQAGdek%3D" alt="图片" loading="lazy"/></p>
<p>还能支持自定义风格，这点比 NotebookLM 方便的是，内置风格让用户选而非直接上来就让你自己自定义或者压根就用默认的。</p>
<p>我选了个手账风，第一张首图，我比较喜欢，自己悄悄融入了 520 的感觉？</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45d8f5bef1114aeaa4bb3850a36033d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092067&amp;x-signature=HBVb7W4oBVM40osq2JfxGk1jfj4%3D" alt="图片" loading="lazy"/></p>
<p>我一共快速生成了 8 页 PPT，效果如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85b241c99da64894844205b895fe26ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092067&amp;x-signature=749eDi8HAme9cTKxwt94psU4jDQ%3D" alt="图片" loading="lazy"/></p>
<p>有点那个感觉了，哈哈哈。</p>
<p>在搜索结果中点击来源，展开后点击「讲解」，同样也能直接生成图片风格的PPT。比如这个《中国人工智能应用发展报告》是搜索结果来源，同样可以让塔老师来生成带图片风格PPT的讲解。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ddfc4314b33342a09f70a97f6d3474a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092067&amp;x-signature=Zd6A2OVvViKwni5HuUUwMGDZoSU%3D" alt="图片" loading="lazy"/></p>
<p>这几十页的文档，一个个去读，花费的时间会很长，在一开始，完全可以交给 AI，先来知识的总结理解，通过塔老师配合图片 PPT，来学习。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40f56b37739a4004ba80cc8f8abad2d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092067&amp;x-signature=mYYqm6l9F%2FyOYJ5DlXZSxV3f%2BBc%3D" alt="wxv_4294495164942745603" loading="lazy"/></p>
<p>这次用的是黑板报的方式，我发现很适合这类发展报告类的文档。</p>
<p>这几天不是一直在研究 AI 漫剧吗？刚好周六有关于 AI 漫剧的主体沙龙，就用秘塔来搜索信息，然后生成一些图片 PPT，用来分享。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35f6097ba72d499c933f232b58e46ba6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092067&amp;x-signature=yn%2F2ZvZQOoablPVqp%2F8Q06Lm2VQ%3D" alt="图片" loading="lazy"/></p>
<p>风格的话用的多格漫画风格。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/548ab199924c4be798bff16677c30d14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092067&amp;x-signature=QpPAvoeQaNAe4NJZMVyQDbxchEE%3D" alt="图片" loading="lazy"/></p>
<p>然后也试了下黑板报风格。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a365b2845704781b3bb26c81e956312~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092067&amp;x-signature=%2FGwwFGPFjBDJPamUANPcy0T7azE%3D" alt="图片" loading="lazy"/></p>
<p>没有了漫画人物的干扰，信息密度会更多一些吧。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e9e20890cd74d4ca6724342c4de28c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092067&amp;x-signature=vHaiiwEDHaAu23Xn12SCMh6sWuE%3D" alt="图片" loading="lazy"/></p>
<p>对于教程类的黑板报风格会好一些。</p>
<p>试了一些其他风格，有时候会有一些文字乱码的情况出现，这也正常，毕竟香蕉或 NotebookLM 有时候也经不起细看，对于 beta 版本，秘塔也可以了。</p>
<p>而且我发现，除了在搜索结果中能生成图片 PPT 外，上传任意文档，也可以选择图片风格的 PPT，然后还可以让塔老师来讲解。</p>
<p>刚好，随着 GPT 5.2 的发布，Sam Altman 写的一封公开信《Ten Years》也火了。</p>
<p>说实话，面对这个一手开启 AI 时代、把世界翻了个底朝天的男人，谁不想听听他到底怎么看未来？</p>
<p>我直接点击上传文件把英文文档丢进秘塔了，然后准备让塔老师用御姐的声音帮我讲解，配上最新出的图片风格 PPT。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28b1c7ff0c7a4519b34b68edac6e1168~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092067&amp;x-signature=pWLwhtZJNhhWXWtyPR%2Fj2e%2BCuDk%3D" alt="图片" loading="lazy"/></p>
<p>风格选择手账风格，讲解风格为精读。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b78ecbd1ea804713a8da37b6303afd2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092067&amp;x-signature=CIXVG%2BR3Rz%2Fq9QHJK0IgV%2BGKLW4%3D" alt="图片" loading="lazy"/></p>
<p>录了个视频，非常推荐大家听完。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/430508b7886045a48f46c2aafea12b55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092067&amp;x-signature=9hk%2BDadS%2BNHh1hcHmZL35x%2BfG00%3D" alt="wxv_4294491738045267969" loading="lazy"/></p>
<p>是啊，当年谁又能猜到 OpenAI 能有如此巨大的成就，当年大家那股劲儿，是那种哪怕成功几率渺茫，也值得拼一把的使命感。</p>
<p><strong>这种感觉就像你坚信自己找到了改变世界的一把钥匙，哪怕他看起来锈迹斑斑。</strong></p>
<p>不知为何，这种使命感仿佛会传递，我们要始终相信，自己做的事儿是有意义的。</p>
<p>这种讲解的方式其实挺有意思的，自己喜欢的声音配合有意思的图片 PPT，很多枯燥的知识也能听进去了。</p>
<p>我们太忙了，忙到连静下心来看完一份 PDF 都成了奢望。</p>
<p>这时候，有个工具能把它画成漫画，掰开了揉碎了讲给你听。</p>
<p>不收你钱，也不要你学复杂的 Prompt。</p>
<p>它就像个深夜陪读的老友，默默把知识喂到你嘴边。</p>
<p>在这个浮躁的圈子里，这种笨拙的诚意，反倒显得有点珍贵。</p>
<p>或许，这就是我们对抗知识焦虑的最好解药。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在全世界都教你做小红书图片的时候，我基于秒哒Pro做了个一键生成的网站。]]></title>    <link>https://juejin.cn/post/7586892413890084910</link>    <guid>https://juejin.cn/post/7586892413890084910</guid>    <pubDate>2025-12-23T10:59:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586892413890084910" data-draft-id="7586877892467359771" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在全世界都教你做小红书图片的时候，我基于秒哒Pro做了个一键生成的网站。"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-23T10:59:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苍何"/> <meta itemprop="url" content="https://juejin.cn/user/588993963763405"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在全世界都教你做小红书图片的时候，我基于秒哒Pro做了个一键生成的网站。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993963763405/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苍何
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T10:59:22.000Z" title="Tue Dec 23 2025 10:59:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是苍何的第 461 篇原创！</p>
<p>大家好，我是晚上不睡觉的老卷 B 苍何。</p>
<p>昨晚熬夜开发完成了一款小产品。</p>
<p>解决公众号长文转小红书图片的问题，产品暂时还没有名字。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b530dff275146559c32314b73f40ec5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092362&amp;x-signature=Jl91u2iGkjcy5GDQVvMXOnKDPHM%3D" alt="图片" loading="lazy"/></p>
<p>他的功能很简单，输入公众号文章链接或者上传本地文档（支持文本文件（.txt）、Markdown文档（.md）、PDF文件（.pdf）、Word文档（.doc/.docx）），就能生成精美排版的小红书图片（包含封面图和内容图）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3a37af5cab941aabce7ebf78ad4ec34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092362&amp;x-signature=eQGoElC28HdK5GpYTXm9zmtYMBc%3D" alt="图片" loading="lazy"/></p>
<p>还可以自定义配置生图模型 API，这里我用的秒哒 生成出的效果好看一些。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7116ab74f9e349f3b1dc6fba9e987a5a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092362&amp;x-signature=bfxdjqm7fpngtgXkBUn%2Bu9fFNcM%3D" alt="图片" loading="lazy"/></p>
<p>当然也可以在个人中心中查看自己的生成记录。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a453327577e497e920ada87fd3db79f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092362&amp;x-signature=JrwqYo6I95NmtZn2QMP3nNtD%2BuI%3D" alt="图片" loading="lazy"/></p>
<p>不满意的图片也完全支持单张修改，同样支持打包下载。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a25b8652b7814e658d786944e0b57376~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092362&amp;x-signature=Pe24%2BtlGrw%2BpiboxrEMNcrF4PDQ%3D" alt="图片" loading="lazy"/></p>
<p>当然了，除了核心能力外就是一些很常见的基础功能了，比如登录注册。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc52fa3e06fa41be895913d97fb21726~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092362&amp;x-signature=K5pM%2BB%2BSBbBSAb8HsGj3IzX%2BUxQ%3D" alt="图片" loading="lazy"/></p>
<p>以及账号基本信息维护能力，比如改账号，传图像等。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7f1e3eb47df4715ad752710244780cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092362&amp;x-signature=W0iLyqWDzuf2WO03XcggG2t7W0A%3D" alt="图片" loading="lazy"/></p>
<p>为了方便你系统的了解这个小产品，我特意录制了个视频。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/323ffd3999424b23b21caae59004eeb3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092362&amp;x-signature=GTKJHWgG%2BpO8iPGRXbRjcvHooV4%3D" alt="wxv_4298991052167757826" loading="lazy"/></p>
<p>而整个过程，我只花了 2 小时，全程 vibe coding，甚至没写过没看过一行代码。</p>
<p>所以这篇文章，主要想分享，我做 MVP 产品的一些，可以算是经验的东西。</p>
<p>所以本文将主要包括以下内容的分享：</p>
<ul>
<li><strong>为什么要做这款产品？</strong></li>
<li><strong>怎么从 0-1 开始做（工具选择 &amp; 如何给 AI 提示词）</strong></li>
<li><strong>未来迭代计划以及如何体验这款产品</strong></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40ad53f3a84c4e2c9b3cb0c6df042ad2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092362&amp;x-signature=I4%2FUjJLm130uKN4VuwhWckmnXu0%3D" alt="图片" loading="lazy"/></p>
<blockquote>
<p>这篇文章又会显得比较长，但不妨碍他是一篇干货文，如果你也有想做小产品的想法，不妨点赞收藏，并转发给需要的朋友。</p>
</blockquote>
<h2 data-id="heading-0">为什么要做这款产品？</h2>
<p>不怕你笑话，我的小红书，一直没做起来，粉丝至今保持在三位数。</p>
<p>你怕是会笑死，并内心狠狠骂我是个憨逼，同步下公众号不是非常省事吗？</p>
<p>况且官方都有工具一键同步，你做这东西有个锤子用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b55309f01d14ec08425b7cd7279ef25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092362&amp;x-signature=Vdl3u28aWIW76SrgYOQaoJ3m1Bc%3D" alt="图片" loading="lazy"/></p>
<p>好吧，你看，这是官方工具同步的效果，同步出来贼 chou。</p>
<p>封面和图片又是如此重要，那样同步过去，有人看才怪。</p>
<p>所以，我一直在探索解决方案，也尝试做过 Obsidian 插件，解决文案问题，但图片依旧是个难关。</p>
<p>现在秒哒 能力已经很强了，于是脑子里就蹦出一个念头，为啥不自己开发个工具呢？</p>
<p>我希望产品本身提供原子化的能力足够简单，输入公众号链接或者导入文件，一键生成小红书风格的图片。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90e2802f998b49d4a2ce2f87d1856d7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092362&amp;x-signature=kk3b8cVd6Pdfrbm6vaZKTKfKt9g%3D" alt="图片" loading="lazy"/></p>
<p>如果是有像我一样本地 Obsidian 创作的同学一定要试试导入本地 md 文件，会更快更爽更丝滑。</p>
<h2 data-id="heading-1">怎么从 0-1 开始做</h2>
<p>最近加班熬夜比较狠，熬夜多了人会变得麻，我有点儿不想写代码，甚至不想看代码。</p>
<p>就想口喷来出产品，所以并没有用 Cursor/Trae 这些可见代码的 IDE。</p>
<p>刚好想起上次去北京参加百度世界大会，亲眼看到了秒哒能无代码现场生成前后端项目。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02f4d78fdbe7499f81043f74c4e4e877~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092362&amp;x-signature=CTihtqxVJMgyVRw9bjmauvNWIs8%3D" alt="图片" loading="lazy"/></p>
<p>而且效果非常不错，当时就忍不住给秒哒产品负责人朱总发了句话😂。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f33e76e776244369bb2fc730afb3f91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092362&amp;x-signature=%2B47lPGIKdgSCVOVrZ3f2ElVkn5w%3D" alt="图片" loading="lazy"/></p>
<p>这和我之前认识的秒哒真不一样，当时就很想尝试，一直忙成狗，没抽空来测测。</p>
<p>刚好借此机会，看看能力咋样。</p>
<p>所以，工具就定的秒哒。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e236ffd5285489ebe9455928f7dbaa2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092362&amp;x-signature=Cvn92aeFRgHWIcB1HzN4qyOirPs%3D" alt="图片" loading="lazy"/></p>
<p>那怎么从 0-1 开始做呢？脑子里有个想法，如何告诉 AI，描述好需求呢？</p>
<p>我的方法是：<strong>先确定好主要功能和整体框架出来一个可用版本，给参考技术路线或者框架代码学习，给到清晰的交互关系，给到相关配置，让其自验证应用的准确性或可靠性。</strong></p>
<p>你可以看到，我在 2 个小时内一共做了 15 个版本的迭代。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce63bfd0b19d41bba927c5dea8efdf1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092362&amp;x-signature=NJxISsq3LYO9rVZxrRGNkzOJLPE%3D" alt="图片" loading="lazy"/></p>
<p>每一次迭代新增或者优化一小部分功能，完成最小逻辑单元的功能完整性可靠性闭环。</p>
<p><strong>不要指望着 AI 一句话一口气能做出一个 APP。</strong></p>
<p>拿这个产品来说，最主要的功能就是根据公众号链接，一键生成小红书图片。</p>
<p>其他的历史记录啊、个人信息管理啊都是非核心能力。</p>
<p>所以我一开始的提示词就是这样的：</p>
<pre><code class="hljs">我想做一个可以将公众号文章转为小红书图文风格的内容图片的web应用，要求先解析公众号文章，然后根据文章内容总结大纲。

文本生成大模型用来理解内容，并总结成符合小红书风格的文案。
然后调用图片生成能力生成小红书图片。

生成图片的提示词如下：【这里如果有比较精致的提示词可以放上来，没有也没关系，效果问题，后期可以调】

用户只输入公众号文章链接，就能自动完成小红书图片创作。
</code></pre>
<p>第一次出来的整体功能看着都行，但是调用 API 生成图片的时候就莫名出错了。</p>
<p>我比较奇怪，为啥能自动调用生图 API？我并没指定啊，</p>
<p>稍微研究了下，原来是他能自动调用生图插件。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/450ec6b0da514fd19521909921bf287a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092362&amp;x-signature=2WWZYLbc9iSKQNZ7GPNYSXwk2Aw%3D" alt="图片" loading="lazy"/></p>
<p>但其实，我是想调用的香蕉 Pro，而且想要自定义 API。</p>
<p>于是继续在秒哒中输入以下需求：</p>
<pre><code class="hljs language-bash" lang="bash">图片生成服务我希望用自定义API的方式，并做成可配置，服务商支持自定义添加，根据类型可分为google_genai、Google Vertex AI 和 image_api，其中 image_api 为 OpenAI 兼容接口（如支持图片生成的第三方 API）。

配置信息包含：<span class="hljs-built_in">type</span>、api_key、model以及high_concurrency（是否启用高并发）。
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a49921d7c7b433fbee5cf2ee38330ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092362&amp;x-signature=lkrmI%2FOpRZ5LszNBIZftQbSIU%2BA%3D" alt="图片" loading="lazy"/></p>
<p>这里调接口需要花费些时间，我的经验是直接给到地址和配置，让 AI 自己先去调用测试，并对应的对齐输入输出，效果会好很多。</p>
<p>接下来就是除了链接，还需要本地文件上传，于是继续输入需求：</p>
<pre><code class="hljs language-bash" lang="bash">现在需要支持本地文件上传功能，要求如下：
1、支持文本文件（.txt）、Markdown文档（.md）、PDF文件（.pdf）、Word文档（.doc/.docx）等格式，文件大小不超过10MB。
2、Markdown文件将保留文本内容，格式标记需要保留。
3、需要再下方给到信息提示
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ccc3731b15464de8ad8ae64705bc4785~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092362&amp;x-signature=9QSluNazQgj9oFPq57eJWktzQf4%3D" alt="图片" loading="lazy"/></p>
<p>然后这个功能是一次性生成的，提示的足够精准能减少改 bug。</p>
<p>然后就是一些细节问题了，比如预览啊，生成加载 louding 啊。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf8068b19e284b3b9e0c263df341b4ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092362&amp;x-signature=rCFLlRxsiLafMLT%2FC09jF9pNBJc%3D" alt="图片" loading="lazy"/></p>
<p>每次不要发送过多的改动或者优化点，尽量单向任务，往往一次就能按照要求完成效果。</p>
<p>这里也可以直接上传想要参考的产品截图，或者在页面上截图并标记功能来修改，就是指哪打哪的逻辑。</p>
<p>这个功能还蛮好用的。</p>
<p>这样整个产品的核心能力就算做完了。</p>
<p>但目前你会发现，好像还没涉及后端数据库，这些配置存在哪里呢？</p>
<p>我看了下，如果不指定，他就是默认存浏览器缓存，所以这里为了增加复杂度，就需要引入用户的概念，并且用户数据是要存数据库的。</p>
<p>ok，先搞定登录注册吧：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5fa766f435a14090ad82a6b06e96407b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092362&amp;x-signature=w1n8MbhDbBocIJUtmnlVI6fgsio%3D" alt="图片" loading="lazy"/></p>
<p>这个提示词是这个样子的：</p>
<blockquote>
<p>我希望增加账号登录注册功能。并基于当前应用功能，将应用数据永久存储到数据库。</p>
</blockquote>
<p>显性的指定数据库，这样用户信息就能入库了。</p>
<p>在秒哒的这里点击就可以看到数据库表的配置信息了：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a500515ab8844c19855a15fc218e973~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092362&amp;x-signature=BJoBS%2BDA0Kntjz8IKW54Scl%2FafY%3D" alt="图片" loading="lazy"/></p>
<p>验证数据库最简单办法就是登录修改个名字和头像再重新换个浏览器登录，看下有没有变化，有变化就代表数据是入库了。</p>
<p>然后是账户信息，提示词是这样子的：我现在希望点击头像设置，能够修改账号信息，比如账号名和头像。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/506dfeb3239c4c48bb6404cc70d5a662~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092362&amp;x-signature=KzQQw%2FQt5%2F2SFZC8VQaetLWIMkg%3D" alt="图片" loading="lazy"/></p>
<p>好，接下来是需要把历史记录这些也都加上，同样通过简单提示词就可以完成。</p>
<p>这样，整个产品的 MVP 就算完成了。</p>
<p>秒哒确实挺强的，整个前后端完整的系统，一行代码没写，也没看就生成好了。</p>
<p>我看了广场还有很多更惊艳的产品和项目：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33b41e10ff5e49a5821ceb35972eba2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092362&amp;x-signature=KZez92Rkz9nj0g9b6WgIJ70C7D4%3D" alt="图片" loading="lazy"/></p>
<p>讲真的，这要不说谁知道是 AI 做的啊，功能太完整了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/566ac633142042b18b52d1f27a53ff29~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092362&amp;x-signature=4nyaTVwqbLixRTDhpCV%2FSTcumiw%3D" alt="图片" loading="lazy"/></p>
<p>我看到，12月16日，在秒哒2025创造者大会上，百度公布秒哒的最新进展：上线8个月以来，平台已累计生成超50万个商业应用，日新增应用涨幅超150%，其中带有后端的应用占到一半，覆盖教育、商业、内容创作、企业服务等200余个场景，累计创造经济与效率价值超50亿元。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44ae33b84b7c4d3e92e116410f2a271e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092362&amp;x-signature=yIVpoZsUiYIVK%2FhHEsszAhUcFBo%3D" alt="图片" loading="lazy"/></p>
<p>好家伙，合着大家都在偷偷用秒哒开发产品啊。</p>
<h2 data-id="heading-2">产品迭代计划</h2>
<p>准备直接发布成自己域名的 web 应用和微信小程序，这是要立马做的，因为狗命要紧，写文章已经五点多了，不能再熬了。</p>
<p>但发布其实在秒哒也很简单，配置一下发布渠道：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57cb3d86c3ea422fae14e72064f48a9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092362&amp;x-signature=G%2B2lEMbyRWGUKDPwqnXzFmwX0wE%3D" alt="图片" loading="lazy"/></p>
<p>然后点击发布就好了，可以发布到自己的域名。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/390787e44c754372b00289dcaaa61142~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767092362&amp;x-signature=DL1ZWUhp03%2FHgKzEXDxSBzssg1Q%3D" alt="图片" loading="lazy"/></p>
<p>还需要迭代一些更多的能力，比如将原先 ob 插件的文案能力集成进来，能基于内容出小红薯风格的文案，这样配图和文案就有了。</p>
<p>后面版本会添加一些别的平台链接支持，比如知乎、微博等文章链接。然后转的平台也支持更多一些。</p>
<p>那怎么体验呢？如果感兴趣想体验这款产品的话，可以评论区留言，我拉你进内测群。</p>
<h2 data-id="heading-3">写在最后</h2>
<p>说实话，vibe coding 才 2 小时，但写文章却花了三四个小时。</p>
<p>也终于是分享完了这次 0 代码开发 MVP 产品的经验。</p>
<p>同样适用于零代码基础的小白，我相信 vibe coding 的本质是 product 本身，而非 code。</p>
<p>未来代码或许不一定再是非常珍贵的数字资产，你的创意想法、你的痛点需求转化为 AI 可执行的产品才是数字资产。</p>
<p>就像百度集团执行副总裁、百度智能云事业群总裁沈抖在秒哒2025创造者大会上说的：</p>
<p>AI时代，创造正在从过去少数人掌握的专利，变成今天多数人触手可及的权利。</p>
<p>互联网极大降低了获取信息和表达观点的成本，但却并没有真正降低参与生产的门槛。而AI则真正进入了生产和决策的核心环节，包括写代码、做设计、做分析、做运营、做产品，甚至重造业务系统。</p>
<p>在这种趋势下，创造的源头也从技术部门，流向离用户和场景最近的每一个角落。无论是业务一线的员工还是捕捉痛点的创业者，只要有想法、有创造价值的欲望，人人都可以成为创造者。对了，要想体验秒哒，不妨使用我的邀请链接，你能领取秒点礼包，我也能获得一些秒点奖励然后去迭代🐶：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.miaoda.cn%2F%3Finvitecode%3Duser-893c1i2aw7i8%25E5%25A5%25BD%25E5%2595%25A6%25E3%2580%2582%25E6%2584%259F%25E8%25B0%25A2%25E9%2598%2585%25E8%25AF%25BB%25EF%25BC%258C%25E6%2588%2591%25E4%25BB%25AC%25E4%25B8%258B%25E4%25B8%2580%25E6%259C%259F%25E8%25A7%2581%25E3%2580%2582" target="_blank" title="https://www.miaoda.cn/?invitecode=user-893c1i2aw7i8%E5%A5%BD%E5%95%A6%E3%80%82%E6%84%9F%E8%B0%A2%E9%98%85%E8%AF%BB%EF%BC%8C%E6%88%91%E4%BB%AC%E4%B8%8B%E4%B8%80%E6%9C%9F%E8%A7%81%E3%80%82" ref="nofollow noopener noreferrer">www.miaoda.cn/?invitecode…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[nest.js / hono.js 一起学！日志功能/统一返回格式/错误处理]]></title>    <link>https://juejin.cn/post/7585798113547829298</link>    <guid>https://juejin.cn/post/7585798113547829298</guid>    <pubDate>2025-12-22T02:14:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585798113547829298" data-draft-id="7450771973871091724" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="nest.js / hono.js 一起学！日志功能/统一返回格式/错误处理"/> <meta itemprop="keywords" content="Node.js,前端"/> <meta itemprop="datePublished" content="2025-12-22T02:14:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="孟祥_成都"/> <meta itemprop="url" content="https://juejin.cn/user/96412752684744"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            nest.js / hono.js 一起学！日志功能/统一返回格式/错误处理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/96412752684744/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    孟祥_成都
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:14:42.000Z" title="Mon Dec 22 2025 02:14:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    41
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在继续搭建 <strong>NestJS</strong> 和 <strong>Hono.js</strong> 的通用框架之前，可以先回顾一下前几篇文章：</p>
<ul>
<li><a href="https://juejin.cn/post/7576555431943503882" target="_blank" title="https://juejin.cn/post/7576555431943503882">深入 NestJS 底层概念（1）：依赖注入和面向切面编程 AOP</a></li>
<li><a href="https://juejin.cn/post/7580564126403362866" target="_blank" title="https://juejin.cn/post/7580564126403362866">NestJS / Hono.js 一起学！Hono 的设计思想</a></li>
<li><a href="https://juejin.cn/post/7581448482544713754" target="_blank" title="https://juejin.cn/post/7581448482544713754">NestJS / Hono.js 一起学！开发前必备</a></li>
<li><a href="https://juejin.cn/post/7583727768543199268" target="_blank" title="https://juejin.cn/post/7583727768543199268">NestJS / Hono.js 一起学！字节团队如何配置多环境攻略</a></li>
</ul>
<p>本篇文章主要实现 <strong>NestJS 与 Hono.js</strong> 的以下功能：</p>
<ol>
<li><strong>打印日志 &amp; 收集日志</strong></li>
<li><strong>统一返回前端的数据格式</strong></li>
<li><strong>统一错误处理</strong></li>
</ol>
<p>这些功能在很多 NestJS 教程中都有覆盖，但我们会在此基础上做一些增强：</p>
<ul>
<li>
<p><strong>日志打印增加 <code>traceId</code> 功能</strong></p>
<ul>
<li>在 Node.js 高并发场景下，<strong>每个请求的 traceId 必须独立</strong>，因为它是<strong>单线程异步</strong>模型，如果我们像写传统同步代码那样直接定义一个全局变量来存 <code>traceId</code>，就会发生严重的“串号”现象。</li>
</ul>
</li>
</ul>
<p><strong>案例：</strong></p>
<p>假设我们有一个 Web 服务，同时收到两个用户请求：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> traceId; <span class="hljs-comment">// 全局变量</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleRequest</span>(<span class="hljs-params">user</span>) {
  traceId = <span class="hljs-string">`trace-<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">1000</span>)}</span>`</span>; <span class="hljs-comment">// 给当前请求生成 traceId</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[<span class="hljs-subst">${traceId}</span>] 开始处理 <span class="hljs-subst">${user}</span> 的请求`</span>);

  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 异步操作，可能晚于其他请求执行</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[<span class="hljs-subst">${traceId}</span>] 完成处理 <span class="hljs-subst">${user}</span> 的请求`</span>);
  }, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">1000</span>);
}

<span class="hljs-comment">// 模拟两个用户几乎同时发起请求</span>
<span class="hljs-title function_">handleRequest</span>(<span class="hljs-string">'Alice'</span>);
<span class="hljs-title function_">handleRequest</span>(<span class="hljs-string">'Bob'</span>);
</code></pre>
<p><strong>可能的输出（串号）</strong> ：</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">trace-532</span>] 开始处理 Alice 的请求
[<span class="hljs-meta">trace-764</span>] 开始处理 Bob 的请求
[<span class="hljs-meta">trace-764</span>] 完成处理 Alice 的请求   ← 错误，日志 traceId 被覆盖，因为全局目前的 traceId 已经是 trace<span class="hljs-number">-764</span> 了
[<span class="hljs-meta">trace-764</span>] 完成处理 Bob 的请求
</code></pre>
<p>以上的问题有些笨办法可以处理，但我们最终会借助 node.js AsyncLocalStorage（在 nest.js 有对应模块，简单实现，在 hono.js 中我们自己封装一个类似功能的模块。）</p>
<p>还有一个必须了解的，这个 traceId 是服务端必须有的，因为我们的处理一个用户请求会经过很多中间件很多不同的模块处理，如何判断经过这么多模块的某个请求是同一个请求，就要用这个 traceId 来记录。</p>
<ul>
<li>
<p><strong>统一返回前端的数据格式</strong>，例如，我们希望所有接口返回：</p>
<pre><code class="hljs language-css" lang="css">```
{
  "<span class="hljs-selector-tag">code</span>": <span class="hljs-number">0</span>,
  <span class="hljs-string">"data"</span>: {...},
  "message": <span class="hljs-string">"success"</span>
}
```
</code></pre>
<ul>
<li><strong>可选配置</strong>：某些路由可以跳过统一格式返回。</li>
</ul>
</li>
</ul>
<hr/>
<p>接下来，我们将先从 nest.js 框架开始，逐步实现这些功能。</p>
<h2 data-id="heading-1">nest.js 配置</h2>
<h3 data-id="heading-2">链路日志追踪功能</h3>
<p>这套系统的灵魂在于 <code>nestjs-cls</code> 和 <code>Winston</code> 的结合。</p>
<p>为什么要这么做？</p>
<p>在 Node.js 异步环境中，传统的全局变量无法区分哪个日志属于哪个用户请求。</p>
<ul>
<li><strong>ClsModule (上下文存储)</strong> ：就像给每个进站的乘客（请求）发一个专属的“透明信封”。这个信封里装着 <code>traceId</code>。</li>
<li><strong>Winston (记录员)</strong> ：当程序需要记录日志时，记录员会从这个“信封”里掏出 <code>traceId</code> 盖在日志条目上。</li>
</ul>
<p>这样，即便服务器同时处理 1000 个请求，你只需要在日志里搜索特定的 <code>traceId</code>，就能看到该请求从“进入”到“报错”的所有心路历程。</p>
<hr/>
<h3 data-id="heading-3">代码功能深度拆解</h3>
<p>我们将代码逻辑分为三个核心模块来理解：</p>
<h4 data-id="heading-4">第一部分：CLS 上下文初始化 (AppModule)</h4>
<p>这是全链路追踪的起点。在根 module 配置，也就是 app.module.ts中增加：</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigModule</span>, <span class="hljs-title class_">ConfigService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ClsModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'nestjs-cls'</span>;
<span class="hljs-keyword">import</span> { randomUUID } <span class="hljs-keyword">from</span> <span class="hljs-string">'crypto'</span>;

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [
    <span class="hljs-comment">// 之前文章讲的环境变量配置模块</span>
    <span class="hljs-title class_">ConfigModule</span>.<span class="hljs-title function_">forRoot</span>({
      <span class="hljs-attr">isGlobal</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 全局可用，无需在每个模块导入</span>
      <span class="hljs-attr">load</span>: [initConfig], <span class="hljs-comment">// 使用自定义加载器</span>
    }),
    <span class="hljs-comment">// 1. 初始化 CLS 上下文，并自动生成 traceId</span>
    <span class="hljs-title class_">ClsModule</span>.<span class="hljs-title function_">forRoot</span>({
      <span class="hljs-attr">global</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">middleware</span>: {
        <span class="hljs-attr">mount</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">generateId</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">idGenerator</span>: <span class="hljs-function">(<span class="hljs-params">req: <span class="hljs-built_in">any</span></span>) =&gt;</span>
          (req.<span class="hljs-property">headers</span>[<span class="hljs-string">'x-request-id'</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>) ?? <span class="hljs-title function_">randomUUID</span>(), <span class="hljs-comment">// 优先使用 header 中的 ID</span>
      },
    }),
  ],
  <span class="hljs-attr">controllers</span>: [],
  <span class="hljs-attr">providers</span>: [],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppModule</span> {}

</code></pre>
<p>通过优先读取 <code>x-request-id</code>，我们可以实现跨系统的全链路追踪（如果你的前端或上游网关也带了这个 ID，就能实现真正的端到端打通）。</p>
<p>这里我们简单说下 ClsModule 实现的基本原理：</p>
<p>我们分三步来实现：</p>
<ul>
<li>第一步：封装 ALS 工具类</li>
</ul>
<p>这是我们的“储物柜”管理器。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// cls.service.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AsyncLocalStorage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'async_hooks'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClsService</span> {
  <span class="hljs-comment">// 1. 创建一个物理存储对象</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> storage = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncLocalStorage</span>&lt;<span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;&gt;();

  <span class="hljs-comment">// 2. 启动上下文（包裹请求）</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">callback: () =&gt; <span class="hljs-built_in">void</span></span>) {
    <span class="hljs-keyword">const</span> store = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">storage</span>.<span class="hljs-title function_">run</span>(store, callback);
  }

  <span class="hljs-comment">// 3. 存储数据</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">set</span>(<span class="hljs-params">key: <span class="hljs-built_in">string</span>, value: <span class="hljs-built_in">any</span></span>) {
    <span class="hljs-keyword">const</span> store = <span class="hljs-variable language_">this</span>.<span class="hljs-property">storage</span>.<span class="hljs-title function_">getStore</span>();
    <span class="hljs-keyword">if</span> (store) store.<span class="hljs-title function_">set</span>(key, value);
  }

  <span class="hljs-comment">// 4. 获取数据</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">key: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-keyword">const</span> store = <span class="hljs-variable language_">this</span>.<span class="hljs-property">storage</span>.<span class="hljs-title function_">getStore</span>();
    <span class="hljs-keyword">return</span> store?.<span class="hljs-title function_">get</span>(key);
  }
}
</code></pre>
<ul>
<li>编写中间件 (Middleware)</li>
</ul>
<p>在 NestJS 中，中间件是请求进来的第一站，我们在这里“开启”储物柜。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// cls.middleware.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span>, <span class="hljs-title class_">NestMiddleware</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { randomUUID } <span class="hljs-keyword">from</span> <span class="hljs-string">'crypto'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">MyClsService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./cls.service'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClsMiddleware</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NestMiddleware</span> {
  <span class="hljs-title function_">use</span>(<span class="hljs-params">req: <span class="hljs-built_in">any</span>, res: <span class="hljs-built_in">any</span>, next: () =&gt; <span class="hljs-built_in">void</span></span>) {
    <span class="hljs-comment">// 关键点：将后续所有的逻辑（next）都运行在 MyClsService.run 的回调里</span>
    <span class="hljs-title class_">MyClsService</span>.<span class="hljs-title function_">run</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> traceId = req.<span class="hljs-property">headers</span>[<span class="hljs-string">'x-request-id'</span>] || <span class="hljs-title function_">randomUUID</span>();
      <span class="hljs-title class_">MyClsService</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">'traceId'</span>, traceId); <span class="hljs-comment">// 存入 traceId</span>
      <span class="hljs-title function_">next</span>();
    });
  }
}
</code></pre>
<p>这个中间件添加之后，意味着所有的请求都会有一个 traceId 值，那在其它地方如何调用呢？请看</p>
<ul>
<li>第三步：在任何地方使用</li>
</ul>
<p>由于 <code>AsyncLocalStorage</code> 跟踪的是异步调用栈，你不再需要通过参数传递 <code>traceId</code>。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// any.service.ts</span>
<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AnyService</span> {
  <span class="hljs-title function_">doSomething</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 像变魔术一样，直接拿！</span>
    <span class="hljs-keyword">const</span> traceId = <span class="hljs-title class_">MyClsService</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'traceId'</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[当前任务] TraceID 是: <span class="hljs-subst">${traceId}</span>`</span>);
  }
}
</code></pre>
<p>我们接着讲日志功能，</p>
<h3 data-id="heading-5">第二部分：Winston 动态工厂 (common/logger)</h3>
<p>这里体现了<strong>环境差异化处理</strong>的思想。</p>

























<table><thead><tr><th><strong>特性</strong></th><th><strong>开发环境 (Development)</strong></th><th><strong>生产环境 (Production)</strong></th></tr></thead><tbody><tr><td><strong>输出目标</strong></td><td>只有控制台 (Console)</td><td>控制台 + 每日滚动文件 (Daily File)</td></tr><tr><td><strong>展示样式</strong></td><td>漂亮的彩色、缩进、Nest 风格</td><td>严谨的 JSON 格式（方便日志分析系统 ELK 抓取）</td></tr><tr><td><strong>日志保留</strong></td><td>随启随看</td><td>保留 14 天，单文件 20MB（防止硬盘爆掉）</td></tr></tbody></table>
<h3 data-id="heading-6">第三部分：异步注入 (WinstonModule.forRootAsync)</h3>
<p>这是 NestJS 的高级用法，确保日志配置是在获取到系统配置（ConfigService）之后才生成的。</p>
<p>在 app.module.ts 中增加 winston配置</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">WinstonModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'nest-winston'</span>;
<span class="hljs-keyword">import</span> { winstonConfigFactory } <span class="hljs-keyword">from</span> <span class="hljs-string">'./common/logger'</span>;

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [
     <span class="hljs-comment">// ... 其它配置</span>
    <span class="hljs-comment">// 2. 注入 Winston</span>
    <span class="hljs-comment">// 3. 使用 forRootAsync 异步加载配置</span>
    <span class="hljs-title class_">WinstonModule</span>.<span class="hljs-title function_">forRootAsync</span>({
      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">ConfigModule</span>], <span class="hljs-comment">// 导入 ConfigModule 以便使用 ConfigService</span>
      <span class="hljs-attr">inject</span>: [<span class="hljs-title class_">ConfigService</span>], <span class="hljs-comment">// 注入 ConfigService</span>
      <span class="hljs-attr">useFactory</span>: <span class="hljs-function">(<span class="hljs-params">configService: ConfigService</span>) =&gt;</span> {
        <span class="hljs-comment">// 调用我们抽离出去的配置函数</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">winstonConfigFactory</span>(configService);
      },
    }),
  ],
  <span class="hljs-attr">controllers</span>: [],
  <span class="hljs-attr">providers</span>: [],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppModule</span> {}

</code></pre>
<p>其中  winstonConfigFactory 的代码如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> winston, { transports, format } <span class="hljs-keyword">from</span> <span class="hljs-string">'winston'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'winston-daily-rotate-file'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;
<span class="hljs-keyword">import</span> { utilities <span class="hljs-keyword">as</span> nestWinstonModuleUtilities } <span class="hljs-keyword">from</span> <span class="hljs-string">'nest-winston'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ClsServiceManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'nestjs-cls'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">DEFAULT_LOG_DIR</span>, <span class="hljs-variable constant_">DIR_NAME</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'src/config/constants'</span>;

<span class="hljs-comment">// 保持之前的 format 定义不变</span>
<span class="hljs-keyword">const</span> appendRequestId = <span class="hljs-title function_">format</span>(<span class="hljs-function">(<span class="hljs-params">info</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> cls = <span class="hljs-title class_">ClsServiceManager</span>.<span class="hljs-title function_">getClsService</span>();
  <span class="hljs-keyword">const</span> traceId = cls?.<span class="hljs-property">get</span>&lt;string&gt;(<span class="hljs-string">'traceId'</span>);
  <span class="hljs-keyword">if</span> (traceId) {
    info.<span class="hljs-property">traceId</span> = traceId;
  }
  <span class="hljs-keyword">return</span> info;
});

<span class="hljs-comment">// 核心修改：导出一个 Factory 函数，而不是静态对象</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">winstonConfigFactory</span> = (<span class="hljs-params">configService: ConfigService</span>) =&gt; {
  <span class="hljs-comment">// 1. 从 ConfigService 获取配置，提供默认值</span>
  <span class="hljs-keyword">const</span> logDir = configService.<span class="hljs-property">get</span>&lt;string&gt;(<span class="hljs-variable constant_">DIR_NAME</span>, <span class="hljs-variable constant_">DEFAULT_LOG_DIR</span>);
  <span class="hljs-keyword">const</span> isProduction = configService.<span class="hljs-property">get</span>&lt;string&gt;(<span class="hljs-string">'NODE_ENV'</span>) === <span class="hljs-string">'production'</span>;

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">transports</span>: isProduction
      ? [
          <span class="hljs-comment">// 2. 定义 DailyRotateFile (使用动态路径)</span>
          <span class="hljs-comment">// 错误日志按天滚动，保留 14 天，每个文件最大 20MB</span>
          <span class="hljs-comment">// 仍然把错误打印到控制台（k8s / docker 日志）</span>
          <span class="hljs-keyword">new</span> winston.<span class="hljs-property">transports</span>.<span class="hljs-title class_">Console</span>({
            <span class="hljs-attr">level</span>: <span class="hljs-string">'error'</span>,
            <span class="hljs-attr">format</span>: winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">combine</span>(
              winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">colorize</span>(),
              winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">printf</span>(<span class="hljs-function">(<span class="hljs-params">info: any</span>) =&gt;</span> {
                <span class="hljs-keyword">const</span> trace = info.<span class="hljs-property">traceId</span> ? <span class="hljs-string">` [trace:<span class="hljs-subst">${info.traceId}</span>]`</span> : <span class="hljs-string">''</span>;
                <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${info.timestamp}</span> <span class="hljs-subst">${info.level}</span><span class="hljs-subst">${trace}</span>: <span class="hljs-subst">${info.message}</span>`</span>;
              }),
            ),
          }),
          <span class="hljs-keyword">new</span> transports.<span class="hljs-title class_">DailyRotateFile</span>({
            <span class="hljs-attr">dirname</span>: logDir, <span class="hljs-comment">// &lt;--- 这里使用了配置中的路径</span>
            <span class="hljs-attr">filename</span>: <span class="hljs-string">'error-%DATE%.log'</span>,
            <span class="hljs-attr">datePattern</span>: <span class="hljs-string">'YYYY-MM-DD'</span>,
            <span class="hljs-attr">maxSize</span>: <span class="hljs-string">'20m'</span>,
            <span class="hljs-attr">maxFiles</span>: <span class="hljs-string">'14d'</span>,
            <span class="hljs-attr">level</span>: <span class="hljs-string">'error'</span>,
            <span class="hljs-attr">format</span>: format.<span class="hljs-title function_">combine</span>(
              <span class="hljs-title function_">appendRequestId</span>(),
              format.<span class="hljs-title function_">timestamp</span>(),
              format.<span class="hljs-title function_">json</span>(),
            ),
          }),
        ]
      : [
          <span class="hljs-comment">// 3. 定义 Console Transport</span>
          <span class="hljs-comment">// 开发环境通常只需要 Console，也可以按需加 File</span>
          <span class="hljs-keyword">new</span> transports.<span class="hljs-title class_">Console</span>({
            <span class="hljs-attr">level</span>: <span class="hljs-string">'info'</span>,
            <span class="hljs-attr">format</span>: format.<span class="hljs-title function_">combine</span>(
              format.<span class="hljs-title function_">timestamp</span>(),
              nestWinstonModuleUtilities.<span class="hljs-property">format</span>.<span class="hljs-title function_">nestLike</span>(<span class="hljs-string">'MyApp'</span>, {
                <span class="hljs-attr">colors</span>: <span class="hljs-literal">true</span>,
                <span class="hljs-attr">prettyPrint</span>: <span class="hljs-literal">true</span>,
              }),
            ),
          }),
        ],
  };
};
</code></pre>
<p>注意，上面的例子，我们后续例如单机使用 docker-compose 部署也好，还是使用k8s/k3s部署也好，就不需要使用winston本身的 DailyRotateFile 功能了，可以借助 docker 或者 k8s/k3s 本身的日志轮转功能实现</p>
<p>为了让这套系统更完美，在实际应用中，你可以这样使用：</p>
<h3 data-id="heading-7">如何在 Service 中打印带 TraceId 的日志？</h3>
<p>这里使用 <code>this.logger.log</code> 的时候，你不需要手动去取 ID，因为我们在 <code>winstonConfigFactory</code> 里的 <code>appendRequestId</code> 已经自动处理了。所以会自带 traceId 属性在日志里。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Logger</span>, <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppService</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> logger = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Logger</span>(<span class="hljs-title class_">AppService</span>.<span class="hljs-property">name</span>);

  <span class="hljs-title function_">doSomething</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'这是一条带有 traceId 的业务日志！'</span>); 
    <span class="hljs-comment">// 输出结果会自动带上: {"traceId":"...", "message":"...", "timestamp":"..."}</span>
  }
}
</code></pre>
<p>接下来实现第二个功能，将返回前端的格式统一</p>
<h3 data-id="heading-8">统一返回格式</h3>
<p>统一格式，在 nest.js 中有拦截器实现（hono.js就没有拦截器的概念），很简单：</p>
<h4 data-id="heading-9">nest.js 统一返回格式：用拦截器实现标准响应结构</h4>
<p>在前后端分离的业务架构中，<strong>统一接口返回格式</strong>已成为标配：<br/>
无论后端返回什么，都应该在一层标准的格式中输出，例如：</p>
<pre><code class="hljs language-typescript" lang="typescript">{
  <span class="hljs-string">"code"</span>: <span class="hljs-number">0</span>,
  <span class="hljs-string">"message"</span>: <span class="hljs-string">"OK"</span>,
  <span class="hljs-string">"data"</span>: {...},
  <span class="hljs-string">"traceId"</span>: <span class="hljs-string">"xxx"</span>
}
</code></pre>
<p>这样做有几个直接收益：</p>
<ol>
<li>前端更容易做异常和展示逻辑，不需要每个接口单独处理。</li>
<li>服务端可以统一标记 traceId，方便链路排查问题。</li>
<li>协议一致后，可快速扩展错误码体系。</li>
</ol>
<p>在 nest.js 中，我们可以使用 <strong>Interceptors（拦截器）</strong> 来完成这一目标。下面是一段完整的拦截器代码。</p>
<h4 data-id="heading-10">拦截器核心代码示例</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">Injectable</span>,
  <span class="hljs-title class_">NestInterceptor</span>,
  <span class="hljs-title class_">ExecutionContext</span>,
  <span class="hljs-title class_">CallHandler</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { map } <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ClsService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'nestjs-cls'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ErrorCodes</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../constants'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">StandardResponse</span>&lt;T&gt; {
  <span class="hljs-attr">code</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">data</span>: T;
  traceId?: <span class="hljs-built_in">string</span>;
}

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StandardResponseInterceptor</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NestInterceptor</span>&lt;
  T,
  <span class="hljs-title class_">StandardResponse</span>&lt;T&gt;
&gt; {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> cls: ClsService</span>) {}

  <span class="hljs-title function_">intercept</span>(<span class="hljs-params">context: ExecutionContext, next: CallHandler</span>) {
    <span class="hljs-keyword">if</span> (context.<span class="hljs-title function_">getType</span>() !== <span class="hljs-string">'http'</span>) {
      <span class="hljs-keyword">return</span> next.<span class="hljs-title function_">handle</span>();
    }

    <span class="hljs-keyword">const</span> handler = context.<span class="hljs-title function_">getHandler</span>();
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">getMetadata</span>(<span class="hljs-string">'skip_transform'</span>, handler)) {
      <span class="hljs-keyword">return</span> next.<span class="hljs-title function_">handle</span>();
    }

    <span class="hljs-keyword">const</span> traceId = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cls</span>.<span class="hljs-title function_">getId</span>();

    <span class="hljs-keyword">return</span> next.<span class="hljs-title function_">handle</span>().<span class="hljs-title function_">pipe</span>(
      <span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> ({
        <span class="hljs-attr">code</span>: <span class="hljs-title class_">ErrorCodes</span>.<span class="hljs-property">SUCCESS</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">'OK'</span>,
        data,
        traceId,
      })),
    );
  }
}
</code></pre>
<p>说明：</p>
<ul>
<li>ClsService 用于获取当前请求的 traceId</li>
<li>map() 包裹所有返回内容</li>
<li>拦截器只在 HTTP 请求上执行（GraphQL、Microservice 可以忽略）</li>
<li>可通过自定义 Decorator 跳过包装</li>
</ul>
<h4 data-id="heading-11">如何注册拦截器（全局启用）</h4>
<p>在 <code>main.ts</code> 中：</p>
<pre><code class="hljs language-typescript" lang="typescript">app.<span class="hljs-title function_">useGlobalInterceptors</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardResponseInterceptor</span>(app.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">ClsService</span>)));
</code></pre>
<p>这样所有路由默认都统一格式输出。</p>
<h4 data-id="heading-12">某些接口不想被统一格式怎么办？</h4>
<p>例如导出文件等特殊接口，不希望包裹。</p>
<p>你可以加自定义装饰器：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-string">'reflect-metadata'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">SkipTransform</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-title class_">SetMetadata</span>(<span class="hljs-string">'skip_transform'</span>, <span class="hljs-literal">true</span>);
</code></pre>
<p>使用方式：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Get</span>(<span class="hljs-string">'upload'</span>)
<span class="hljs-meta">@SkipTransform</span>()
<span class="hljs-title function_">getCaptcha</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> someRawBinary;
}
</code></pre>
<p>当前路由会跳过统一包裹。</p>
<h4 data-id="heading-13">实际效果展示</h4>
<p>原本控制器返回：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Get</span>(<span class="hljs-string">'user'</span>)
<span class="hljs-title function_">getUser</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Tom'</span> };
}
</code></pre>
<p>最终前端收到：</p>
<pre><code class="hljs language-typescript" lang="typescript">{
  <span class="hljs-string">"code"</span>: <span class="hljs-number">0</span>,
  <span class="hljs-string">"message"</span>: <span class="hljs-string">"OK"</span>,
  <span class="hljs-string">"data"</span>: {
    <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"Tom"</span>
  },
  <span class="hljs-string">"traceId"</span>: <span class="hljs-string">"abc-123-xyz"</span>
}
</code></pre>
<h2 data-id="heading-14">通用错误处理</h2>
<p>在后端系统中，错误处理往往经历三个阶段：</p>
<ol>
<li>能跑（框架兜底）</li>
<li>能返回（让前端知道错哪里）</li>
<li>能排障（日志链路、定位效率）</li>
</ol>
<p>nestjs 的 <code>ExceptionFilter</code> 为第三阶段提供了完整治理能力。本节通过自定义 <code>AllExceptionsFilter</code>，从“拦截错误”开始，一层层增强错误输出、业务语义、日志能力和 traceId 支持。</p>
<h3 data-id="heading-15">第一层：拦截所有异常，而不是依赖框架默认行为</h3>
<p>默认情况下，框架会尝试处理异常，但格式、内容和处理方式不可控。<br/>
通过 <code>@Catch()</code> 拦截全场景错误，我们将接管所有异常通道：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Catch</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AllExceptionsFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ExceptionFilter</span> {
  <span class="hljs-keyword">catch</span>(<span class="hljs-attr">exception</span>: <span class="hljs-built_in">unknown</span>, <span class="hljs-attr">host</span>: <span class="hljs-title class_">ArgumentsHost</span>) {
</code></pre>
<p>借助 <code>ArgumentsHost</code>，我们拿到 HTTP 请求上下文，后续就能构造专属响应：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> ctx = host.<span class="hljs-title function_">switchToHttp</span>();
<span class="hljs-keyword">const</span> response = ctx.<span class="hljs-property">getResponse</span>&lt;<span class="hljs-title class_">Response</span>&gt;();
<span class="hljs-keyword">const</span> request = ctx.<span class="hljs-property">getRequest</span>&lt;<span class="hljs-title class_">Request</span>&gt;();
</code></pre>
<p>此时的目标是“掌控入口”。</p>
<h3 data-id="heading-16">第二层：区分 HTTP 状态码，让协议正确表达成功或失败</h3>
<p>框架层能力拦截之后，下一层诉求是协议语义正确。<br/>
对客户端返回的 HTTP Status 必须准确，否则代理、浏览器、监控系统均无法判断请求情况：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> httpStatus =
  exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HttpException</span>
    ? exception.<span class="hljs-title function_">getStatus</span>()
    : <span class="hljs-title class_">HttpStatus</span>.<span class="hljs-property">INTERNAL_SERVER_ERROR</span>;
</code></pre>
<p>简单讲：</p>
<ul>
<li>可预期的业务错误维持 4xx</li>
<li>其它错误不想让前端知道具体错误，直接返回  <code>INTERNAL_SERVER_ERROR</code>。</li>
</ul>
<p>这实现了“系统对外的协议治理”。</p>
<h3 data-id="heading-17">第三层：建立业务错误码体系，与协议语义解耦</h3>
<p>HTTP Status 永远不适合作为业务判断依据。<br/>
因此体系化项目会分离“协议错误码”和“业务错误码”。这一步实现业务语义治理：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> <span class="hljs-attr">businessCode</span>: <span class="hljs-built_in">number</span>;
<span class="hljs-keyword">if</span> (httpStatus &gt;= <span class="hljs-number">400</span> &amp;&amp; httpStatus &lt; <span class="hljs-number">500</span>) {
  businessCode = <span class="hljs-title class_">ErrorCodes</span>.<span class="hljs-property">BUSINESS_ERROR</span>;
} <span class="hljs-keyword">else</span> {
  businessCode = <span class="hljs-title class_">ErrorCodes</span>.<span class="hljs-property">SYSTEM_ERROR</span>;
}
</code></pre>
<p>从此，前端不再需要看 400/500 决策，而是看业务码 1000/5000 做逻辑分支(如果需要有业务错误码的话，一般可以不加业务状态码)。</p>
<h3 data-id="heading-18">第四层：控制返回给用户的 message，不泄漏内部实现</h3>
<p>继续向下走，我们需要控制“用户可见信息”。</p>
<p>对于 <code>HttpException</code>，返回异常信息安全可控；<br/>
而普通异常有堆栈、内部错误，不可直给客户端：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> <span class="hljs-attr">userMessage</span>: <span class="hljs-built_in">string</span>;
<span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HttpException</span>) {
  <span class="hljs-keyword">const</span> exceptionResponse = exception.<span class="hljs-title function_">getResponse</span>() <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>;
  userMessage = exceptionResponse.<span class="hljs-property">message</span> || exception.<span class="hljs-property">message</span>;
} <span class="hljs-keyword">else</span> {
  userMessage = <span class="hljs-string">'Server Internal Error'</span>;
}
</code></pre>
<h3 data-id="heading-19">第五层：注入 traceId，将错误纳入链路追踪体系</h3>
<p>协议治理与安全治理之后，我们需要可观测性。<br/>
依赖 <code>ClsService</code> 获取 traceId，使任意异常都能与一次请求绑定：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> traceId = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cls</span>.<span class="hljs-title function_">getId</span>();
</code></pre>
<p>这让后续日志检索有了线索，从“出错”变为“定位在哪个请求出错”。</p>
<hr/>
<h3 data-id="heading-20">第六层：构造统一错误返回体，让前端接收结构稳定</h3>
<p>业务响应格式统一之后，客户端解析与 UI 逻辑才能标准化：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> finalClientResponse = {
  <span class="hljs-attr">code</span>: businessCode,
  <span class="hljs-attr">message</span>: userMessage,
  traceId,
  <span class="hljs-attr">error</span>: {
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
    <span class="hljs-attr">path</span>: request.<span class="hljs-property">url</span>,
    <span class="hljs-attr">method</span>: request.<span class="hljs-property">method</span>,
    httpStatus,
  },
};
</code></pre>
<p>这一层，从“不固定字段”变为“返回契约统一”。</p>
<hr/>
<h3 data-id="heading-21">第七层：按严重程度结构化日志，结合 traceId 可查可追</h3>
<p>有了 traceId 后，日志才具备上下文意义。<br/>
对非预期错误记录堆栈并升为 <code>error</code>，对客户端调用错误降级为 <code>warn</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (httpStatus &gt;= <span class="hljs-number">500</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`[<span class="hljs-subst">${httpStatus}</span>] Unhandled Exception: <span class="hljs-subst">${userMessage}</span>`</span>, {
    <span class="hljs-attr">clientResponse</span>: finalClientResponse,
    <span class="hljs-attr">stack</span>: (exception <span class="hljs-keyword">as</span> <span class="hljs-title class_">Error</span>).<span class="hljs-property">stack</span>,
    traceId,
  });
} <span class="hljs-keyword">else</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`[<span class="hljs-subst">${httpStatus}</span>] Client Error: <span class="hljs-subst">${userMessage}</span>`</span>, {
    <span class="hljs-attr">clientResponse</span>: finalClientResponse,
    traceId,
  });
}
</code></pre>
<p>此处是“日志治理 + 可观测性治理”。</p>
<hr/>
<h3 data-id="heading-22">第八层：保持 HTTP 状态原样返回，确保协议链路正常识别</h3>
<p>最终输出必须保留协议语义，否则监控、负载均衡、浏览器都将错误判断请求：</p>
<pre><code class="hljs language-typescript" lang="typescript">response.<span class="hljs-title function_">status</span>(httpStatus).<span class="hljs-title function_">json</span>(finalClientResponse);
</code></pre>
<p>接下来就可以在 main.ts 中使用这个全局错误管理器了。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NestFactory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/core'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.module'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ClsService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'nestjs-cls'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AllExceptionsFilter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./common/filters/http-exception.filter'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-keyword">type</span> <span class="hljs-title class_">NestExpressApplication</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/platform-express'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-keyword">type</span> <span class="hljs-title class_">LoggerService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NestFactory</span>.<span class="hljs-property">create</span>&lt;<span class="hljs-title class_">NestExpressApplication</span>&gt;(<span class="hljs-title class_">AppModule</span>, {
    <span class="hljs-attr">bufferLogs</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 先缓存日志，直到 Logger 替换完成</span>
  });

  <span class="hljs-keyword">const</span> configService = app.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">ConfigService</span>);

  <span class="hljs-comment">// 1. 替换 Nest 默认 Logger 为 Winston</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">logger</span>: <span class="hljs-title class_">LoggerService</span> = app.<span class="hljs-title function_">get</span>(<span class="hljs-variable constant_">WINSTON_MODULE_NEST_PROVIDER</span>);

  app.<span class="hljs-title function_">useLogger</span>(logger);

  <span class="hljs-comment">// 获取 CLS 服务实例</span>
  <span class="hljs-keyword">const</span> clsService = app.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">ClsService</span>);

  <span class="hljs-comment">// 4. 注册全局异常过滤器：捕获所有异常并打印日志 + 返回统一结构</span>
  app.<span class="hljs-title function_">useGlobalFilters</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AllExceptionsFilter</span>(clsService, logger));

  <span class="hljs-keyword">const</span> port = configService.<span class="hljs-property">get</span>&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-string">'port'</span>) ?? <span class="hljs-number">3000</span>;

  <span class="hljs-keyword">await</span> app.<span class="hljs-title function_">listen</span>(port, <span class="hljs-function">() =&gt;</span> {
    logger.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Server on :<span class="hljs-subst">${port}</span>`</span>);
  });
}
<span class="hljs-title function_">bootstrap</span>();
</code></pre>
<h2 data-id="heading-23">honojs 配置</h2>
<h3 data-id="heading-24">第一部分：链路日志追踪功能</h3>
<p>首先我们封装记录 traceId 的功能，我们通过编写一个中间件来实现，这个中间件是所有请求过来，经过的第一步，这样所有请求就带了 traceId，具体实现如下：</p>
<p>首先我们要创建一个 AsyncLocalStorage 实例，让后续的中间件调用其 run 方法，为每个请求创建独立的上下文。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AsyncLocalStorage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:async_hooks"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RequestContext</span> {
  <span class="hljs-attr">traceId</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-comment">// 初始化全局存储</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> ctx = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncLocalStorage</span>&lt;<span class="hljs-title class_">RequestContext</span>&gt;();

<span class="hljs-comment">// 封装一个获取 traceId 的快捷方法</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getTraceId = (): <span class="hljs-built_in">string</span> | <span class="hljs-function"><span class="hljs-params">undefined</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> store = ctx.<span class="hljs-title function_">getStore</span>();
  <span class="hljs-keyword">return</span> store?.<span class="hljs-property">traceId</span>;
};

</code></pre>
<p>以下是 middleware 的实现</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createMiddleware } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono/factory"</span>;
<span class="hljs-keyword">import</span> { ctx } <span class="hljs-keyword">from</span> <span class="hljs-string">"../context"</span>; <span class="hljs-comment">// 导入您的 ctx</span>

<span class="hljs-comment">// 确保在 Node.js 环境下使用</span>
<span class="hljs-keyword">import</span> { randomUUID } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:crypto"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> traceMiddleware = <span class="hljs-title function_">createMiddleware</span>(<span class="hljs-keyword">async</span> (c, next) =&gt; {
  <span class="hljs-comment">// 1. 生成唯一的 Trace ID</span>
    <span class="hljs-keyword">const</span> traceId = c.<span class="hljs-property">req</span>.<span class="hljs-title function_">header</span>(<span class="hljs-string">"x-request-id"</span>) || <span class="hljs-title function_">randomUUID</span>();

  <span class="hljs-comment">// 2. 将 Trace ID 存储在 AsyncLocalStorage 中，并运行后续的处理链</span>
  <span class="hljs-keyword">await</span> ctx.<span class="hljs-title function_">run</span>({ traceId }, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-comment">// 3. (可选) 记录请求开始日志</span>
    <span class="hljs-comment">// logger.info(`Request started: ${c.req.method} ${c.req.url}`, {</span>
    <span class="hljs-comment">//   traceId: getTraceId(),</span>
    <span class="hljs-comment">// });</span>

    <span class="hljs-comment">// 4. 继续处理链</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();

    <span class="hljs-comment">// 5. (可选) 设置响应头</span>
    c.<span class="hljs-property">res</span>.<span class="hljs-property">headers</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">"X-Trace-ID"</span>, traceId);

    <span class="hljs-comment">// // 6. (可选) 记录请求结束日志</span>
    <span class="hljs-comment">// logger.info(`Request finished: ${c.req.method} ${c.req.url}`, {</span>
    <span class="hljs-comment">//   traceId: getTraceId(),</span>
    <span class="hljs-comment">//   status: c.res.status,</span>
    <span class="hljs-comment">// });</span>
  });
});
</code></pre>
<p>通过优先读取 <code>x-request-id</code>，我们可以实现跨系统的全链路追踪（如果你的前端或上游网关也带了这个 ID，就能实现真正的端到端打通）。</p>
<p>主要代码就是 ctx.run({ traceId }, async () =&gt; { xxx }), 将后所有内容，包含在 AsyncLocalStorage 上下文中，也就是 traceId 会伴随整个请求的生命周期。</p>
<h3 data-id="heading-25">第二部分：Winston 动态工厂 (common/logger)</h3>
<p>这里体现了<strong>环境差异化处理</strong>的思想。</p>

























<table><thead><tr><th><strong>特性</strong></th><th><strong>开发环境 (Development)</strong></th><th><strong>生产环境 (Production)</strong></th></tr></thead><tbody><tr><td><strong>输出目标</strong></td><td>只有控制台 (Console)</td><td>控制台 + 每日滚动文件 (Daily File)</td></tr><tr><td><strong>展示样式</strong></td><td>漂亮的彩色、缩进、Nest 风格</td><td>严谨的 JSON 格式（方便日志分析系统 ELK 抓取）</td></tr><tr><td><strong>日志保留</strong></td><td>随启随看</td><td>保留 14 天，单文件 20MB（防止硬盘爆掉）</td></tr></tbody></table>
<p>以上的功能，我们封装到一个 logger.ts 中，代码如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { format, transports, createLogger } <span class="hljs-keyword">from</span> <span class="hljs-string">"winston"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"winston-daily-rotate-file"</span>;
<span class="hljs-keyword">import</span> { getTraceId } <span class="hljs-keyword">from</span> <span class="hljs-string">"../context"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">PROD_ENV</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../../../constant"</span>;

<span class="hljs-comment">// 1. 自定义 Format：自动从 ALS 获取 Trace ID</span>
<span class="hljs-keyword">const</span> appendTraceId = <span class="hljs-title function_">format</span>(<span class="hljs-function">(<span class="hljs-params">info</span>) =&gt;</span> {
  <span class="hljs-comment">// 使用 ctx.getStore() 获得</span>
  <span class="hljs-keyword">const</span> traceId = <span class="hljs-title function_">getTraceId</span>();
  <span class="hljs-keyword">if</span> (!traceId) {
    info.<span class="hljs-property">traceId</span> = traceId;
  }
  <span class="hljs-keyword">return</span> info;
});

<span class="hljs-comment">/// 2. 基础配置</span>
<span class="hljs-keyword">const</span> logFormat = format.<span class="hljs-title function_">combine</span>(
  <span class="hljs-title function_">appendTraceId</span>(),
  format.<span class="hljs-title function_">timestamp</span>({ <span class="hljs-attr">format</span>: <span class="hljs-string">"YYYY-MM-DD HH:mm:ss"</span> }),
  format.<span class="hljs-title function_">errors</span>({ <span class="hljs-attr">stack</span>: <span class="hljs-literal">true</span> }), <span class="hljs-comment">// 自动捕获 error stack</span>
  format.<span class="hljs-title function_">json</span>()
);

<span class="hljs-keyword">const</span> devTransport = <span class="hljs-keyword">new</span> transports.<span class="hljs-title class_">Console</span>({
  <span class="hljs-attr">level</span>: <span class="hljs-string">"info"</span>,
  <span class="hljs-attr">format</span>: format.<span class="hljs-title function_">combine</span>(
    format.<span class="hljs-title function_">colorize</span>(),
    format.<span class="hljs-title function_">printf</span>(<span class="hljs-function">(<span class="hljs-params">{ timestamp, level, message, traceId, stack }</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> tid = traceId ? <span class="hljs-string">`[Trace: <span class="hljs-subst">${traceId}</span>]`</span> : <span class="hljs-string">""</span>;
      <span class="hljs-keyword">const</span> output = <span class="hljs-string">`<span class="hljs-subst">${timestamp}</span> <span class="hljs-subst">${level}</span> <span class="hljs-subst">${tid}</span>: <span class="hljs-subst">${message}</span>`</span>;
      <span class="hljs-keyword">return</span> stack ? <span class="hljs-string">`<span class="hljs-subst">${output}</span>\n<span class="hljs-subst">${stack}</span>`</span> : output;
    })
  ),
});

<span class="hljs-comment">// 导出 Logger 实例</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> logger = <span class="hljs-title function_">createLogger</span>({
  <span class="hljs-attr">format</span>: logFormat,
  <span class="hljs-attr">transports</span>:
    process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-variable constant_">PROD_ENV</span>
      ? <span class="hljs-comment">// 生产环境 Transports</span>
        [
          <span class="hljs-keyword">new</span> transports.<span class="hljs-title class_">DailyRotateFile</span>({
            <span class="hljs-attr">filename</span>: <span class="hljs-string">"logs/error-%DATE%.log"</span>,
            <span class="hljs-attr">datePattern</span>: <span class="hljs-string">"YYYY-MM-DD"</span>,
            <span class="hljs-attr">level</span>: <span class="hljs-string">"error"</span>,
            <span class="hljs-attr">maxSize</span>: <span class="hljs-string">"20m"</span>,
            <span class="hljs-attr">maxFiles</span>: <span class="hljs-string">"14d"</span>,
          }),
          <span class="hljs-keyword">new</span> transports.<span class="hljs-title class_">Console</span>({
            <span class="hljs-attr">level</span>: <span class="hljs-string">"error"</span>,
            <span class="hljs-attr">format</span>: format.<span class="hljs-title function_">combine</span>(
              format.<span class="hljs-title function_">colorize</span>(),
              format.<span class="hljs-title function_">printf</span>(<span class="hljs-function">(<span class="hljs-params">{ timestamp, level, message, traceId, stack }</span>) =&gt;</span> {
                <span class="hljs-keyword">const</span> tid = traceId ? <span class="hljs-string">`[Trace: <span class="hljs-subst">${traceId}</span>]`</span> : <span class="hljs-string">""</span>;
                <span class="hljs-keyword">const</span> output = <span class="hljs-string">`<span class="hljs-subst">${timestamp}</span> <span class="hljs-subst">${level}</span> <span class="hljs-subst">${tid}</span>: <span class="hljs-subst">${message}</span>`</span>;
                <span class="hljs-keyword">return</span> stack ? <span class="hljs-string">`<span class="hljs-subst">${output}</span>\n<span class="hljs-subst">${stack}</span>`</span> : output;
              })
            ),
          }),
        ]
      : <span class="hljs-comment">// 开发环境 Transport</span>
        [devTransport],
});

</code></pre>
<p>注意，上面的例子，我们后续例如单机使用 docker-compose 部署也好，还是使用k8s/k3s部署也好，就不需要使用winston本身的 DailyRotateFile 功能了，可以借助 docker 或者 k8s/k3s 本身的日志轮转功能实现</p>
<h3 data-id="heading-26">如何在 Service 中打印带 TraceId 的日志？</h3>
<p>如下，我们就可以在路由中使用 logger 功能，就会自带 traceId 了</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Hono</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono"</span>;
<span class="hljs-keyword">import</span> { logger } <span class="hljs-keyword">from</span> <span class="hljs-string">"./common/logger"</span>;
<span class="hljs-keyword">import</span> { standardResponse } <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils"</span>;
<span class="hljs-keyword">import</span> { getTraceId } <span class="hljs-keyword">from</span> <span class="hljs-string">"./context"</span>;

<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hono</span>();

app.<span class="hljs-title function_">get</span>(<span class="hljs-string">"/users"</span>, <span class="hljs-keyword">async</span> (c) =&gt; {
  logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"开始处理 /users 请求"</span>);

  <span class="hljs-keyword">const</span> list = [{ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Tom"</span> }];

  logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">`查询用户数量=<span class="hljs-subst">${list.length}</span>`</span>);

  <span class="hljs-keyword">return</span> <span class="hljs-title function_">standardResponse</span>(c, { list });
});
</code></pre>
<p>访问结果输出（示例）：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-number">2025-01-05 22:11:01 </span><span class="hljs-string">info</span> [<span class="hljs-attr">Trace:</span> <span class="hljs-string">099f42...</span>] <span class="hljs-string">开始处理</span> <span class="hljs-string">/users</span> <span class="hljs-string">请求</span>
<span class="hljs-number">2025-01-05 22:11:01 </span><span class="hljs-string">info</span> [<span class="hljs-attr">Trace:</span> <span class="hljs-string">099f42...</span>] <span class="hljs-string">查询用户数量=1</span>
</code></pre>
<h3 data-id="heading-27">在 hono.js 中封装统一返回格式</h3>
<p>与 nest.js 不同，hono.js 没有 <strong>Interceptor</strong> 的概念，因此无法在框架层自动包装所有路由的返回值。hono 更偏向极简设计：框架提供 Context（<code>c</code>）与响应方法（如 <code>c.json()</code>），开发者通过 middleware 或工具函数扩展能力。</p>
<p>在这种模式下，一个常见策略是：<strong>在 utils 层封装一个标准响应函数</strong>，每当路由处理完成业务逻辑后，调用该函数输出标准格式。示例如下：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// utils/response.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-keyword">type</span> <span class="hljs-title class_">Context</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono"</span>;
<span class="hljs-keyword">import</span> { getTraceId } <span class="hljs-keyword">from</span> <span class="hljs-string">"../common/context"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">CODES</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../common/constants/codes"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">ContentfulStatusCode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono/utils/http-status"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SUCCESS_MESSAGE</span> = <span class="hljs-string">"OK"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> standardResponse = &lt;T&gt;(
  <span class="hljs-attr">c</span>: <span class="hljs-title class_">Context</span>,
  <span class="hljs-attr">data</span>: T,
  <span class="hljs-attr">httpStatus</span>: <span class="hljs-title class_">ContentfulStatusCode</span> = <span class="hljs-number">200</span>
): <span class="hljs-function"><span class="hljs-params">Response</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> traceId = <span class="hljs-title function_">getTraceId</span>();

  <span class="hljs-keyword">const</span> finalResponse = {
    <span class="hljs-attr">code</span>: <span class="hljs-variable constant_">CODES</span>.<span class="hljs-property">SUCCESS</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-variable constant_">SUCCESS_MESSAGE</span>,
    data,
    traceId,
  };
  
   <span class="hljs-comment">// 使用 c.json() 返回 Response</span>
  <span class="hljs-comment">// c.json() 负责设置 Content-Type: application/json</span>
  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>(finalResponse, httpStatus);
};
</code></pre>
<p>这一函数实现了几个能力：</p>
<ol>
<li><strong>统一业务结构</strong>：code / message / data 统一格式化。</li>
<li><strong>链路可观测性</strong>：自动从 ALS 中获取 traceId，可跨路由跟踪调用链路。</li>
<li><strong>控制协议行为</strong>：可指定 HTTP status，而不影响业务 code。</li>
<li><strong>无框架侵入性</strong>：不需要全局 patch，路由自由决定是否使用。</li>
</ol>
<p>实际使用方式非常直接：在路由处理函数中调用该函数包裹输出即可：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { standardResponse } <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils/response"</span>;

app.<span class="hljs-title function_">get</span>(<span class="hljs-string">"/user"</span>, <span class="hljs-function">(<span class="hljs-params">c</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> user = { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Tom"</span> };
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">standardResponse</span>(c, user);
});
</code></pre>
<p>输出结构：</p>
<pre><code class="hljs language-typescript" lang="typescript">{
  <span class="hljs-string">"code"</span>: <span class="hljs-number">0</span>,
  <span class="hljs-string">"message"</span>: <span class="hljs-string">"OK"</span>,
  <span class="hljs-string">"data"</span>: {
    <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"Tom"</span>
  },
  <span class="hljs-string">"traceId"</span>: <span class="hljs-string">"abc-123-xyz"</span>
}
</code></pre>
<h3 data-id="heading-28">错误处理</h3>
<p>hono.js 并没有 nest.js 中那样的 exception（异常）处理器，但 hono 官方提供了两个方法来处理全局异常。</p>
<ul>
<li>Error Handling 回调函数</li>
<li>Not Found 回调函数</li>
</ul>
<p>其中 <code>app.onError</code> 允许我们处理未捕获的错误并返回自定义响应。例如</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hono</span>();
app.<span class="hljs-title function_">onError</span>(<span class="hljs-function">(<span class="hljs-params">err, c</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`<span class="hljs-subst">${err}</span>`</span>);
  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">text</span>(<span class="hljs-string">"Custom Error Message"</span>, <span class="hljs-number">500</span>);
});
</code></pre>
<p>接下来我们实现一个生产级别的全局错误处理函数，代替上面的 onError 中的函数：</p>
<h4 data-id="heading-29">阶段一：只实现兜底，确保不会爆栈到框架</h4>
<p>目标：任何异常都返回 500，避免框架直接输出默认错误页面。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">customErrorHandler</span> = (<span class="hljs-params">exception: <span class="hljs-built_in">unknown</span>, c: Context</span>) =&gt; {
  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>(
    {
      <span class="hljs-attr">message</span>: <span class="hljs-string">"Internal Server Error"</span>,
    },
    <span class="hljs-number">500</span>,
  );
};
</code></pre>
<p>此阶段的函数虽然简陋，但实现了基本“拦截能力”。技术人员可以理解到：不允许异常直接泄漏给框架。</p>
<h4 data-id="heading-30">阶段二：支持错误分类（业务可控错误 vs 系统错误）</h4>
<p>需求出现：业务层需要显式抛出 4xx，不应该全部变成 500。因此我们引入 Hono 的 HTTPException。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">HTTPException</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono/http-exception"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">customErrorHandler</span> = (<span class="hljs-params">exception: <span class="hljs-built_in">unknown</span>, c: Context</span>) =&gt; {
  <span class="hljs-keyword">let</span> httpStatus = <span class="hljs-number">500</span>;
  <span class="hljs-keyword">let</span> message = <span class="hljs-string">"Internal Server Error"</span>;

  <span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HTTPException</span>) {
    httpStatus = exception.<span class="hljs-property">status</span>;
    message = exception.<span class="hljs-property">message</span>;
  }

  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>({ message }, httpStatus);
};
</code></pre>
<p>团队到此能看到两个差异：</p>
<ul>
<li>不再一刀切地用 500</li>
<li>支持框架级错误语义</li>
</ul>
<h4 data-id="heading-31">阶段三：支持普通 Error，并提取堆栈</h4>
<p>当后端代码抛出 Error 对象时，我们不希望把内部堆栈暴露给客户端，但日志需要保留：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span>) {
  httpStatus = <span class="hljs-number">500</span>;
  message = exception.<span class="hljs-property">message</span>;
  stack = exception.<span class="hljs-property">stack</span>;
}
</code></pre>
<p>与第二阶段结合后，代码局部已经具备三类来源：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HTTPException</span>) {
  <span class="hljs-comment">// 合法业务错误</span>
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span>) {
  <span class="hljs-comment">// 非预期系统错误</span>
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// 字符串或其他类型，兜底转字符串</span>
}
</code></pre>
<p>这一阶段解决“所有类型异常都能进入统一通路”。</p>
<h4 data-id="heading-32">阶段四：对外 Message 安全脱敏</h4>
<p>生产会提出安全要求：500 段错误不能暴露内部 message。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> userMessage =
  httpStatus &gt;= <span class="hljs-number">500</span> ? <span class="hljs-string">"Server Internal Error"</span> : exceptionMessage;
</code></pre>
<h4 data-id="heading-33">阶段五：加入 Trace ID，实现可观测能力</h4>
<p>在前几阶段之后，团队开始发现：仅凭日志很难定位请求调用链。因此引入 Trace ID：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { getTraceId } <span class="hljs-keyword">from</span> <span class="hljs-string">"../context"</span>;

<span class="hljs-keyword">const</span> traceId = <span class="hljs-title function_">getTraceId</span>();
</code></pre>
<p>并将其放入响应，用于 API 与日志上下游联动。</p>
<h4 data-id="heading-34">阶段六：构建统一响应协议</h4>
<p>现在错误信息、trace 信息都有了，我们需要形成一致返回结构，便于前端或 API 网关解析：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> finalClientResponse = {
  <span class="hljs-attr">code</span>: <span class="hljs-number">500</span>,
  <span class="hljs-attr">message</span>: userMessage,
  <span class="hljs-attr">traceId</span>: traceId,
  <span class="hljs-attr">error</span>: {
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
    <span class="hljs-attr">path</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">path</span>,
    <span class="hljs-attr">method</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">method</span>,
    <span class="hljs-attr">httpStatus</span>: httpStatus,
  },
};
</code></pre>
<p>这样可以回复格式统一的响应。</p>
<h4 data-id="heading-35">阶段七：结构化日志分级输出</h4>
<p>生产要求日志可检索、可告警，因此需要按状态区分 error 与 warn，并携带堆栈：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (httpStatus &gt;= <span class="hljs-number">500</span>) {
  logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">`[<span class="hljs-subst">${httpStatus}</span>] Unhandled Exception: <span class="hljs-subst">${exceptionMessage}</span>`</span>, {
    <span class="hljs-attr">clientResponse</span>: finalClientResponse,
    <span class="hljs-attr">stack</span>: exceptionStack,
    <span class="hljs-attr">traceId</span>: traceId,
    <span class="hljs-attr">path</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">path</span>,
  });
} <span class="hljs-keyword">else</span> {
  logger.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`[<span class="hljs-subst">${httpStatus}</span>] Client Error: <span class="hljs-subst">${exceptionMessage}</span>`</span>, {
    <span class="hljs-attr">clientResponse</span>: finalClientResponse,
    <span class="hljs-attr">traceId</span>: traceId,
    <span class="hljs-attr">path</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">path</span>,
  });
}
</code></pre>
<p>团队能看到：</p>
<ul>
<li>500+ 是告警级别</li>
<li>4xx 只是用户请求问题，不污染告警系统</li>
</ul>
<h4 data-id="heading-36">阶段八：最终闭环，按状态返回响应</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>(finalClientResponse, httpStatus);
</code></pre>
<p>请求闭环如下：</p>
<ol>
<li>识别异常</li>
<li>分类</li>
<li>安全脱敏</li>
<li>绑定 Trace</li>
<li>构建协议</li>
<li>结构化日志</li>
<li>返回状态码与响应体</li>
</ol>
<p>最终成果（合并段落）即为我们起初提供的完整生产代码：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-keyword">type</span> <span class="hljs-title class_">Context</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono"</span>;
<span class="hljs-keyword">import</span> { getTraceId } <span class="hljs-keyword">from</span> <span class="hljs-string">"../context"</span>;
<span class="hljs-keyword">import</span> { logger } <span class="hljs-keyword">from</span> <span class="hljs-string">"../logger"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">HTTPException</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono/http-exception"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-keyword">type</span> <span class="hljs-title class_">ContentfulStatusCode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono/utils/http-status"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">customErrorHandler</span> = (<span class="hljs-params">exception: <span class="hljs-built_in">unknown</span>, c: Context</span>) =&gt; {
  <span class="hljs-keyword">let</span> <span class="hljs-attr">httpStatus</span>: <span class="hljs-title class_">ContentfulStatusCode</span>;
  <span class="hljs-keyword">let</span> <span class="hljs-attr">exceptionMessage</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"Internal Server Error"</span>;
  <span class="hljs-keyword">let</span> <span class="hljs-attr">exceptionStack</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span>;

  <span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HTTPException</span>) {
    httpStatus = exception.<span class="hljs-property">status</span>;
    exceptionMessage = exception.<span class="hljs-property">message</span>;
    exceptionStack = exception.<span class="hljs-property">stack</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span>) {
    httpStatus = <span class="hljs-number">500</span>;
    exceptionMessage = exception.<span class="hljs-property">message</span>;
    exceptionStack = exception.<span class="hljs-property">stack</span>;
  } <span class="hljs-keyword">else</span> {
    httpStatus = <span class="hljs-number">500</span>;
    exceptionMessage = <span class="hljs-title class_">String</span>(exception);
  }

  <span class="hljs-keyword">const</span> userMessage =
    httpStatus &gt;= <span class="hljs-number">500</span> ? <span class="hljs-string">"Server Internal Error"</span> : exceptionMessage;

  <span class="hljs-keyword">const</span> traceId = <span class="hljs-title function_">getTraceId</span>();

  <span class="hljs-keyword">const</span> finalClientResponse = {
    <span class="hljs-attr">code</span>: <span class="hljs-number">500</span>,
    <span class="hljs-attr">message</span>: userMessage,
    <span class="hljs-attr">traceId</span>: traceId,
    <span class="hljs-attr">error</span>: {
      <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
      <span class="hljs-attr">path</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">path</span>,
      <span class="hljs-attr">method</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">method</span>,
      <span class="hljs-attr">httpStatus</span>: httpStatus,
    },
  };

  <span class="hljs-keyword">if</span> (httpStatus &gt;= <span class="hljs-number">500</span>) {
    logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">`[<span class="hljs-subst">${httpStatus}</span>] Unhandled Exception: <span class="hljs-subst">${exceptionMessage}</span>`</span>, {
      <span class="hljs-attr">clientResponse</span>: finalClientResponse,
      <span class="hljs-attr">stack</span>: exceptionStack,
      <span class="hljs-attr">traceId</span>: traceId,
      <span class="hljs-attr">path</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">path</span>,
    });
  } <span class="hljs-keyword">else</span> {
    logger.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`[<span class="hljs-subst">${httpStatus}</span>] Client Error: <span class="hljs-subst">${exceptionMessage}</span>`</span>, {
      <span class="hljs-attr">clientResponse</span>: finalClientResponse,
      <span class="hljs-attr">traceId</span>: traceId,
      <span class="hljs-attr">path</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">path</span>,
    });
  }

  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>(finalClientResponse, httpStatus);
};
</code></pre>
<p>接下来我们来处理全局捕获的 404 回调，也就是自定义 Not Found Response, 个人感觉生产环境就简单返回 404 状态码就足够了，所以函数定义如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">notFoundHandler</span> = (<span class="hljs-params">c: Context</span>) =&gt; {
  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">"Resource not found"</span> }, <span class="hljs-number">404</span>);
};
</code></pre>
<h2 data-id="heading-37">欢迎一起交流</h2>
<p>欢迎大家一起进群讨论前端全栈技术和 ai agent ，一起进步！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PinK(Cocos4.0？)生成飞机大战，抢先体验全流程！]]></title>    <link>https://juejin.cn/post/7585948869844287523</link>    <guid>https://juejin.cn/post/7585948869844287523</guid>    <pubDate>2025-12-22T00:54:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585948869844287523" data-draft-id="7585948869844271139" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PinK(Cocos4.0？)生成飞机大战，抢先体验全流程！"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-22T00:54:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="亿元程序员"/> <meta itemprop="url" content="https://juejin.cn/user/1972988307323236"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PinK(Cocos4.0？)生成飞机大战，抢先体验全流程！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972988307323236/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    亿元程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T00:54:24.000Z" title="Mon Dec 22 2025 00:54:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f49ea03c767b44e8971a96bba6e0b289~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=BDEBBkHTzIu7CbRLN77rG5Cq0zw%3D" alt="来源于Cocos官方论坛" loading="lazy"/></p>
<h2 data-id="heading-0">引言</h2>
<p><strong>哈喽大家好</strong>，原小道消息<code>PinK</code>将于<code>18号</code>公测，但是白天一整天迟迟未见。</p>
<p><strong>终于</strong>在晚上<code>19</code>点左右<code>PinK 0.0.1-alpha.1</code>版发布了！不过<code>alpha</code>测试仅对部分开发者开放：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e45ee02bfa545a4a847e9a79b92d084~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=TQX7g853na1zJ3jnU7BZ84gyneQ%3D" alt="来源于Cocos官方论坛" loading="lazy"/></p>
<p><strong>论坛</strong>瞬间炸开了锅，一码难求。</p>
<p><strong>笔者</strong>为了宠粉，鼓起勇气直接私信了产品经理，幸运地拿到了想要的码，连夜进行了测评。</p>
<p><strong>先</strong>看看简单的介绍：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9631f1e91524ae09a3378ef42718ccb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=NVlWZSkh2MqZps0HRyK9OJHxZYU%3D" alt="来源于Cocos官方论坛" loading="lazy"/></p>
<p><strong>言归正传</strong>，小伙伴们跟随笔者，一起来体验下<code>PinK(Cocos4.0)</code>以及用它生成飞机大战实战全过程！</p>
<h2 data-id="heading-1">1. 安装和激活</h2>
<p><strong>下载</strong>完成后，直接解压运行<code>PinK.exe</code>，据说是基于<code>VSCode</code>开发，意味着坐拥<code>VSCode</code>所有插件！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2acc244dbb974779be7a1c65d10540bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=C9dv3tWEMwo5tfv5xFj5jB6lBmE%3D" alt="" loading="lazy"/></p>
<p><strong>首次</strong>打开需要填入我们拿到的码进行激活，粉红色的椰子头格外耀眼，符合主题<code>PinK</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/333980f11a834aa5aaa9154bba1fcdb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=Z55a%2B88PBlIRjVvQ3N%2BdyRtIL3E%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">2. 界面</h2>
<p><strong>完整界面</strong>如下，非常熟悉了，大家看看都有啥！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2645cc7e25946e28b5e225c43ae3b5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=fGRTVg%2B4uwkl8%2B5IXBAV%2BTMQHB0%3D" alt="" loading="lazy"/></p>
<p><strong>左上角</strong>一排图标分别是<code>Scene</code>(场景)、<code>Hierarchy</code>(层级管理器)、<code>Inspector</code>(属性检查器)、<code>Asset</code>(资源管理器)等等<code>Creator</code>常用的面板，不过目前测试点击无效果。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b6e89f4f33e46279b7857599d188db1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=SZxz0AlceJ7xccg6ujL1f26ret0%3D" alt="" loading="lazy"/></p>
<p><strong>正上方</strong>的就是和<code>Creator</code>一样的运行工具。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6572a69682bb46c996a670b29acbc13e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=LKzyRb5Tthr%2FNgzWvSbYusq1GvI%3D" alt="" loading="lazy"/></p>
<p><strong>右上角</strong>也是一排工具按钮，不怎么见过，不介绍了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e31b2c1236cf457fbb0ba78a93f5a29c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=0BgflRrpbVa4QL01UUrNaYxzhOA%3D" alt="" loading="lazy"/></p>
<p><strong>其余剩下</strong>的部分就是与<code>VSCode</code>一致的，左侧资源管理器，右侧是我们的<code>AI</code>聊天面板。</p>
<h2 data-id="heading-3">3.安装SDK</h2>
<p><strong>使用之前</strong>要在<code>PinK</code>里面安装<code>cocos-sdk</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32b3fe92dcf34505bbf2977522b3d96f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=4VM1cKcHbeRhK79H7tYr46H18gI%3D" alt="" loading="lazy"/></p>
<p><strong>总大小</strong>接近<code>5G</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8322c40aee74e12a986e81f1e2c0ec8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=vGMUUTEm4DlWdJvBiQxpIFp%2BN0s%3D" alt="" loading="lazy"/></p>
<p><strong>里面</strong>包括我们熟悉的引擎源码：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30cafbd1d9c24db69f1efd4baf404f55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=OEQPPlgbDv5Y9bKnaCnDIUjLdWU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">4.PinK飞机大战实战</h2>
<p><strong>前面</strong>有关注笔者的小伙伴，笔者通过<code>DeepSeek</code>和生图软件去简单粗暴地开发一款飞机大战游戏，收获了非常多的点赞。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca49bb8fd6224dd6af23ec92d53232b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=Wwa%2Bm6SGyp9Xf%2FPuIzdRHzazfpc%3D" alt="" loading="lazy"/></p>
<p><strong>里面</strong>明确指出<code>AI</code>并不能通过<code>Chat</code>全自动利用<code>Creator</code>完成开发，还是要扎实掌握许多基本功，即使通过<code>AI</code>操作<code>Scene</code>文件和<code>Pfefab</code>文件，目前都还是比较难。</p>
<p><strong>下面</strong>我们用<code>PinK</code>实战对比，看看有什么不同。</p>
<h3 data-id="heading-5">1.创建工程</h3>
<p><strong>首先</strong>通过<code>Create Project</code>按钮创建我们的工程<code>PinkTest</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/138fc7bfe5084c7daf4e078332fbb76d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=8%2BvDYmLFkmfwwfsmC3MAgkws8nc%3D" alt="" loading="lazy"/></p>
<p><strong>创建</strong>完成后会自动生成我们熟悉的工程目录结构。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/379f0b06a83b43a984d97f19aefd094e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=BupbDMpD463qNwazfCq%2B3DQM9PQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">2.选择模型</h3>
<p><strong>目前</strong>测试阶段，<code>PinK</code>自掏腰包内置<code>Gemini3</code>，给予好评。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c84a43d54c454087b030d1b02db7eda7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=doE%2FC15P7p9Z7ycoxGMtwA3Uwpw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">3.实战开始</h3>
<p><strong>二话</strong>不说，笔者先来个下马威：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31c26b13ce2c4e46812ab1bc34a1b5cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=GWxnONwEN3bPcX0KxPL%2BLFxsl40%3D" alt="" loading="lazy"/></p>
<p><strong>PinK</strong>反手就丢给我3个<code>md</code>文件，分别是：</p>
<ul>
<li><strong><code>GD.md</code></strong> : 游戏设计文档。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83b8e84305294e44b78c20ded438d3ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=pdwoOP9K7rHRWj74o9102uxxCJ4%3D" alt="" loading="lazy"/></li>
<li><strong><code>ART.md</code></strong> : 美术需求文档。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c2bc4ca0212418a95e26e3a433a688d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=lyTo20gjvRDS3HbBQ9HfvkX4lCw%3D" alt="" loading="lazy"/></li>
<li><strong><code>TECH.md</code></strong> : 技术需求文档。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/441ffa45eaca4bfeba54dc19b5e03bd7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=s3Z8OFJbSOSE3tw3Q5WRVuHmRo0%3D" alt="" loading="lazy"/></li>
</ul>
<p><strong>整体流程</strong>就靠上面<code>3</code>个文档驱动,生成完成后等待老板下发指令开工。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b93cc3f3105342e4ae10bc484b8026f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=h%2Fru26054r4M08x5HkVpTupZn4g%3D" alt="" loading="lazy"/></p>
<p><strong>由于</strong>笔者没有配置<code>API Key</code>，没办法直接生成所需的美术资源，一直卡在生成图片阶段。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee92f5accaed4cbcbd13438b8c961f71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=0ZY8iGDvlVi6LM9uRibnAZuEoYI%3D" alt="" loading="lazy"/></p>
<p><strong>只能</strong>重新让他先做好游戏，后续我再根据美术需求补充资源。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee736293b67f4fdf8e9980c10e6c5d3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=N6tUVnbBLzS2h7m0xxhyQrZTHt8%3D" alt="" loading="lazy"/></p>
<p><strong>开启</strong><code>Auto Approve</code>之后，笔者就去洗漱了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d47812016f447fea6f1565376a510dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=Vp6%2FsIBuryXN4GMK5alL9jl4Zj4%3D" alt="" loading="lazy"/></p>
<p><strong>回来</strong>时，他告诉我已经做好了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a538c872e70a4d8783ec8cfa0dd39cc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=VeR58EjOvjBNYaPZekLGPhfQULE%3D" alt="" loading="lazy"/></p>
<p><strong>把</strong>我们上次生成的资源改成指定的名字放在指定目录。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b37c44ef25644ee980fda940f8e37ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=N%2BKXov5l1ef1tby4cwmL09LnphA%3D" alt="" loading="lazy"/></p>
<p><strong>PinK神</strong>启动！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83fc5fe136ce476bbff264c5c0653d6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=0WmgHlhB2RcwKqC24kehoMG8L1M%3D" alt="" loading="lazy"/></p>
<p><strong>果不其然</strong>，事情并没有那么简单，运行之后一片空白。乍眼一看脚本还有报错。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1bb77d26742046ce9965a7b4cb177697~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=8q6VVuIr%2FqkEjc41%2Bv8QbmjWZqk%3D" alt="" loading="lazy"/></p>
<p><strong>笔者</strong>好奇地打开<code>Creator</code>看看生成的场景和节点长什么样，节点也没有生成(<strong>到后面发现其实是笔者搞错了场景</strong>)。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df5acb74dc6d4caabdbe3af581d62e73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=Ts0ab3twTkGk0SnC3BFZQrPJNDU%3D" alt="" loading="lazy"/></p>
<p><strong>于是</strong>我让他修复一下报错和挂载<code>GameManager</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9472eb89eda4a938a74ac90a0580620~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=d9IJxkIM8kHetF9z9rbgpZbIQ6M%3D" alt="" loading="lazy"/></p>
<p><strong>打开</strong><code>Main</code>场景可以看到，节点已生成，代码也挂载好了(妥妥解决了痛点)。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7591f356852a4b1a977db7c09063654e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=os1WzRcQ1cmfQU936G9FIthIKD4%3D" alt="" loading="lazy"/></p>
<p><strong>最后</strong>让他运行游戏。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68a43ac8d3d0478aba0c43655584076f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=y8A%2BX%2FVoEklVlxfC0yI7DqTm2dw%3D" alt="" loading="lazy"/></p>
<p><strong>在控制台</strong>可以清晰看到<code>Cocos Creator v4.0.0</code>字样，这是不是就说明<code>PinK</code>就是<code>Cocos4.0</code>?</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bed7892f534240bd97c6c08980c16299~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=l%2FwZrktYRrmlnVqtPEuiDHygXvk%3D" alt="" loading="lazy"/></p>
<p><strong>这次</strong>他自动打开了内置的简单浏览器，但是游戏画面还是没有出来。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2aac4b2b23f94a43a98ee821e2bfc6aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=RaH0y6AnxThPbjg7coyRoWEBJW8%3D" alt="" loading="lazy"/></p>
<p><strong>查看报错</strong>可以知道图片的导入格式不对。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/417de1c775db4ffdbefa7bb0af16a546~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=R7zZQk7gw7ZX7Sjb8ndMyrXzf%2F8%3D" alt="" loading="lazy"/></p>
<p><strong>把</strong>报错信息复制过去，并且告诉他格式不对。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83dd69c0c0f54eb6b2238f5a866c189c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=Ix76YYckAKbTQml9LC3lf2r9k1M%3D" alt="" loading="lazy"/></p>
<p><strong>然后</strong>他就自动调整格式了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef459388835e48a4b067e3e3d7ddfcf5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=SNSNg9fu4XrDh%2FusF2cMgfxksCw%3D" alt="" loading="lazy"/></p>
<p><strong>最后运行</strong>，画面终于出来了，泪流满面，就是图片有点太大了，不太协调。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/331804b18f9a43a586fd269cf4b1f74e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=3rkVdHntQ524Y6e9udziCHnImEA%3D" alt="" loading="lazy"/></p>
<p><strong>让他</strong>调小一点。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94be9cd40845457fbd63489bc1bf3559~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=JFVpFkDHU%2BUGzrpIMdtZ7%2BV1%2BrQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">4.效果演示</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b8dedf74711414396f986c98ccc705f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=nPwt6IkztU907ZYc1FDxBxAj1ME%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">5.体验感受</h2>
<ul>
<li><strong>全程</strong>零代码、零编辑场景，全自动生成游戏(有引擎的)，虽然游戏简单，后面会尝试生成更复杂的游戏，欢迎关注。</li>
<li><strong>PinK</strong>并不只是代码编辑器，全程可以不需要写代码和打开<strong>Creator</strong>(笔者好奇自己打开)，根据界面布局推断，<strong>Creator</strong>的功能终将全部移植到<strong>PinK</strong>。</li>
<li><strong>由于</strong>只是<code>alpha</code>测试，看群里反馈的问题,<code>BUG</code>也不少，笔者觉得可以理解，需要点时间让它飞一会。</li>
<li><strong>此外PinK</strong>上手有点难度，一开始看会比较懵，不知道从哪里开始动手。</li>
<li><strong>笔者</strong>尝试用<code>PinK</code>打开旧的项目(Creator3.8.7)，也存在一些问题，都反馈到群里了。</li>
</ul>
<h2 data-id="heading-10">结语</h2>
<p><strong>总的</strong>来说，<code>PinK</code>让笔者眼前一亮，持看好态度，个人看法，轻喷！</p>
<p><strong>小伙伴们</strong>看完后觉得如何？还想笔者测评哪些内容？欢迎来评论区发表看法！</p>
<hr/>
<p><strong>我是"亿元程序员"，一位有着8年游戏行业经验的主程。在游戏开发中，希望能给到您帮助, 也希望通过您能帮助到大家。</strong></p>
<p>AD:笔者线上的小游戏《打螺丝闯关》《贪吃蛇掌机经典》《重力迷宫球》《填色之旅》《方块掌机经典》大家可以自行点击搜索体验。</p>
<p>实不相瞒，想要个<strong>赞</strong>和<strong>爱心</strong>！请把该文章<strong>分享</strong>给你觉得有需要的其他小伙伴。谢谢！</p>
<p>推荐文章：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FXLCknL3fJDubec2GW6KLFA" target="_blank" title="https://mp.weixin.qq.com/s/XLCknL3fJDubec2GW6KLFA" ref="nofollow noopener noreferrer">Cocos游戏如何接入安卓穿山甲广告变现？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F3_VrSld4KnDKY_7hxjSoKg" target="_blank" title="https://mp.weixin.qq.com/s/3_VrSld4KnDKY_7hxjSoKg" ref="nofollow noopener noreferrer">你知道和不知道的微信小游戏常用API整理，赶紧收藏用起来~</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F0Lj24VHJ-pL8z82hHqQLiA" target="_blank" title="https://mp.weixin.qq.com/s/0Lj24VHJ-pL8z82hHqQLiA" ref="nofollow noopener noreferrer">Cocos游戏如何快速接入抖音小游戏广告变现？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FZ7DusUJA2v1IFZDFtBsueg" target="_blank" title="https://mp.weixin.qq.com/s/Z7DusUJA2v1IFZDFtBsueg" ref="nofollow noopener noreferrer">如何在CocosCreator3.8中实现割绳子游戏效果</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F3BzzFBzeVAO-a6LPTeFTrA" target="_blank" title="https://mp.weixin.qq.com/s/3BzzFBzeVAO-a6LPTeFTrA" ref="nofollow noopener noreferrer">如何在CocosCreator3.8中实现动态切割模型？</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[💪别再迷茫！一份让你彻底掌控 TypeScript 类型系统的终极指南]]></title>    <link>https://juejin.cn/post/7586506307726491658</link>    <guid>https://juejin.cn/post/7586506307726491658</guid>    <pubDate>2025-12-22T11:25:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586506307726491658" data-draft-id="7586482860103827483" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="💪别再迷茫！一份让你彻底掌控 TypeScript 类型系统的终极指南"/> <meta itemprop="keywords" content="前端,TypeScript"/> <meta itemprop="datePublished" content="2025-12-22T11:25:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="hboot"/> <meta itemprop="url" content="https://juejin.cn/user/2084329777543191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            💪别再迷茫！一份让你彻底掌控 TypeScript 类型系统的终极指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2084329777543191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    hboot
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T11:25:34.000Z" title="Mon Dec 22 2025 11:25:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    33
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>TypeScript</code>现在的普及度已经很高了，虽然它是一种静态类型定义，但它的庞大已足够我们要向对待一门语言一样对待它了，去深入学习，以便更好的利用它的能力。</p>
<p>当然了，我们首先要明确为什么需要它，而不是把它当作一种负担：</p>
<ul>
<li>编译时类型检查，避免了运行时才检查的数据类型错误，导致系统奔溃。</li>
<li>提升开发效率，IDE基于类型系统提供了精准的代码补全、接口提示。减少了查询文档、查询API的成本。</li>
<li>增强了代码可读性，通过类型注解帮助成员快速理解函数输入、输出，降低了协作成本。</li>
</ul>
<h2 data-id="heading-0">类型系统基石</h2>
<p>像一门语言有基本的语法一样，<code>TypeScript</code>也有基本的类型定义，这些基本类型对应<code>JavaScript</code>中的基本数据类型，包括<code>number</code>、<code>string</code>、<code>boolean</code>、<code>null</code>、<code>undefined</code>、<code>symbol</code>、<code>bigint</code>、<code>object</code>。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"hboot"</span>;
<span class="hljs-keyword">const</span> <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">18</span>;
<span class="hljs-keyword">const</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">`hello, <span class="hljs-subst">${name}</span>`</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">uniqueKey</span>: <span class="hljs-built_in">symbol</span> = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">"key"</span>);
</code></pre>
<h3 data-id="heading-1">空类型、任意类型、未知类型</h3>
<p><code>void</code>表示空类型，<code>any</code>表示任意类型，<code>unknown</code>表示未知类型。</p>
<ul>
<li><code>void</code> 常用于函数无返回值时的返回类型声明；</li>
<li><code>any</code> 表示任意类型，失去了类型检查的能力，非必要不要用；</li>
<li><code>unknown</code> 表示未知类型，可以用来代替<code>any</code>，但是它不能直接用，必须通过类型断言或类型守卫明确具体类型才能操作。</li>
<li><code>never</code> 表示没有任何类型，变量和函数返回不会存在任何实际值。它是所有类型的字类型，可以赋值给任意类型。</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">noReturn</span>(<span class="hljs-params">msg: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(msg);
}

<span class="hljs-keyword">let</span> <span class="hljs-attr">name</span>: <span class="hljs-built_in">any</span> = <span class="hljs-string">"admin"</span>;
<span class="hljs-comment">// 可以任意赋值</span>
name = <span class="hljs-number">123</span>;
<span class="hljs-comment">// 甚至是当作函数调用,这导致开发不易发现，运行时才报错</span>
<span class="hljs-title function_">name</span>():

<span class="hljs-keyword">let</span> <span class="hljs-attr">age</span>: <span class="hljs-built_in">unknown</span> = <span class="hljs-number">18</span>;
<span class="hljs-comment">// 类型为未知，无法直接操作</span>
age += <span class="hljs-number">10</span>;
<span class="hljs-comment">// 通过类型守卫，明确类型为 number</span>
<span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> age === <span class="hljs-string">'number'</span>) { 
    age += <span class="hljs-number">10</span>;
}
</code></pre>
<h2 data-id="heading-2">复合类型</h2>
<p>复合类型就是基础类型的组合，包括数组、对象、元组、枚举、类。</p>
<h3 data-id="heading-3">数组</h3>
<p>数组的类型定义<code>T[]</code>或<code>Array&lt;T&gt;</code></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 数组</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">names</span>: <span class="hljs-built_in">string</span>[] = [<span class="hljs-string">'admin'</span>, <span class="hljs-string">'user'</span>];
<span class="hljs-keyword">let</span> <span class="hljs-attr">names</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt; = [<span class="hljs-string">'admin'</span>, <span class="hljs-string">'user'</span>];
</code></pre>
<h3 data-id="heading-4">对象</h3>
<p>对象类型定义对象的属性名、属性类型。属性支持可选、只读、索引签名。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 对象</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">user</span>: { <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span> } = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'hboot'</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>
}
</code></pre>
<h3 data-id="heading-5">元组</h3>
<p>元组是明确了数组长度以及元素类型的。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 元组</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">userInfo</span>: [<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>] = [<span class="hljs-string">'hboot'</span>, <span class="hljs-number">18</span>];
</code></pre>
<h3 data-id="heading-6">枚举</h3>
<p>枚举用于定义一组有特殊含义的常量，比如状态码、类型标识等。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 枚举</span>
<span class="hljs-keyword">const</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Status</span> { 
    <span class="hljs-title class_">Success</span> = <span class="hljs-number">200</span>,
    <span class="hljs-title class_">Fail</span> = <span class="hljs-number">500</span>
}
</code></pre>
<p>未赋值时，枚举值从 0 开始递增。如果自定义了开始值，则后面的值递增。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Status</span> { 
  <span class="hljs-title class_">Success</span>, <span class="hljs-comment">// 0</span>
  <span class="hljs-title class_">Fail</span> <span class="hljs-comment">// 1</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Status</span> { 
  <span class="hljs-title class_">Success</span> = <span class="hljs-number">1</span>, <span class="hljs-comment">// 1</span>
  <span class="hljs-title class_">Fail</span> <span class="hljs-comment">// 2</span>
}
</code></pre>
<p>可以通过<code>const enum</code>修饰枚举定义，在编译时仅保留常量值，减少代码体积。</p>
<h3 data-id="heading-7">类<code>Class</code></h3>
<p>类<code>class</code>是面向对象编程的核心。es6中已经增强了对类的支持，可以通过类定义对象，明确属性、方法。类不仅可以用来创建实例，也可以作为类型注解描述实例类型。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }
}
</code></pre>
<p>类的定义包括实例属性、实例方法、静态属性、静态方法，同时还支持通过访问修饰符控制成员可见。</p>
<p>子类可以通过<code>extends</code>继承父类的非<code>private</code>成员，重写父类方法。<strong>仅能继承一个父类。</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> {
  <span class="hljs-title class_">WangWang</span>() {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"WangWang"</span>;
  }
}
</code></pre>
<p>类可以通过<code>implements</code>实现接口，用于约束类的实现，包括属性、方法，仅约束结构，不提供实现。<strong>可实现多个接口</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Animal</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-title function_">speak</span>(): <span class="hljs-built_in">void</span>;
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Animal</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-title function_">speak</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"WangWang"</span>);
  }
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }
}
</code></pre>
<p>通过<code>abstract</code>关键字可以声明抽象类，抽象类不能被实例化。它只定义了字段、方法结构，未实现具体逻辑，它仅可被子类继承，并需要实现它定义的所有抽象成员。</p>
<h2 data-id="heading-8">高级类型</h2>
<p>基础类型可以满足绝大多数业务，但面对复杂业务需要类型复用、条件判断、属性筛选则需要高级类型。</p>
<h3 data-id="heading-9">复用类型</h3>
<p>为了复用类型，可以通过<code>type</code> \ <code>interface</code>定义类型。<code>type</code>可以定义任意类型，包括基础类型、复合类型、联合类型等，比较灵活；<code>interface</code> 只能定义对象类型,但是可以<code>继承</code>和<code>同名合并</code>。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// type</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Age</span> = <span class="hljs-built_in">number</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">User</span> = { 
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">age</span>: <span class="hljs-title class_">Age</span>;
}
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Status</span> = <span class="hljs-string">'success'</span> | <span class="hljs-number">200</span>;

<span class="hljs-comment">// interface</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> { 
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">SuperUser</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">User</span> { 
    <span class="hljs-attr">role</span>: <span class="hljs-built_in">string</span>;
}
</code></pre>
<p><code>interface</code> 不同于类<code>class</code>,它可以继承多个接口。</p>
<h3 data-id="heading-10">联合/交叉类型</h3>
<p>联合类型通过<code>|</code>表示变量可以是任意其中一种类型；交叉类型通过<code>&amp;</code>表示变量必须同时满足多个类型。</p>
<p>联合类型使用时需要类型守卫明确类型后才能操作,如果变量已经赋值，则会自动推导出类型；</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Age</span> = <span class="hljs-built_in">number</span> | <span class="hljs-built_in">string</span>;

<span class="hljs-keyword">let</span> <span class="hljs-attr">age</span>: <span class="hljs-title class_">Age</span> = <span class="hljs-number">18</span>;
age+=<span class="hljs-number">2</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">agePlus</span>(<span class="hljs-params">age: Age</span>){ 
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> age === <span class="hljs-string">'number'</span>){ 
        age+=<span class="hljs-number">2</span>;
    }
    <span class="hljs-keyword">return</span> age;
}
</code></pre>
<p>交叉类型常用合并对象类型，需要满足所有类型条件。<strong>如果无法满足所有类型条件，则该类型为<code>never</code></strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">User</span> = { 
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
}
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Address</span> = { 
    <span class="hljs-attr">address</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">type</span> <span class="hljs-title class_">UserAddress</span> = <span class="hljs-title class_">User</span> &amp; <span class="hljs-title class_">Address</span>;
</code></pre>
<h3 data-id="heading-11">泛型</h3>
<p>泛型是将类型参数化，可以不指定具体类型来定义函数、类、接口。在使用时在传入具体类型，它可以高度抽象定义类型，保障类型复用和类型安全。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 函数泛型</span>
<span class="hljs-keyword">function</span> getData&lt;T&gt;(<span class="hljs-attr">data</span>: T): T {
    <span class="hljs-keyword">return</span> data;
}

<span class="hljs-comment">// 接口泛型</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">IData</span>&lt;T&gt; {
    <span class="hljs-attr">data</span>: T;
}

<span class="hljs-comment">// 类泛型</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Data</span>&lt;T&gt; {
    <span class="hljs-attr">data</span>: T[] = [];
}
</code></pre>
<p>因为不知道具体类型，就无法获知这个类型有什么属性，可以调用什么方法。为了使用某个属性或者某个方法，我们使用泛型约束来指定这个类型必须有哪些属性或者方法。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> getData&lt;T <span class="hljs-keyword">extends</span> { <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> }&gt;(<span class="hljs-attr">data</span>: T): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">return</span> data.<span class="hljs-property">name</span>;
}
</code></pre>
<p>在调用具有泛型的类型时，需要传递具体类型，有时候这个泛型我们知道在很多情况下就是某一个类型，避免重复传入，我们可以指定泛型的默认类型，从而在使用时不再需要传入。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">User</span> = { 
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">function</span> getData&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">User</span> = <span class="hljs-title class_">User</span>&gt;(<span class="hljs-attr">data</span>: T): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">return</span> data.<span class="hljs-property">name</span>;
}
</code></pre>
<p>泛型约束和默认类型不需要同时出现，也可以定义其一，根据需求使用。</p>
<h2 data-id="heading-12">类型运算</h2>
<p>除了定义具体类型，还可以通过类型运算从一个类型得到一个新的类型。也可以称之为推导，从一个类型推导为另一个类型。类型运算也是导致一些复杂类型产生的因素。</p>
<h3 data-id="heading-13">类型守卫</h3>
<p>类型守卫是在运行时判断数据类型，它可以精准到具体类型，用于类型收窄，包括<code>unknown</code>、联合类型、类继承。关键字包括<code>typeof</code> <code>instanceof</code> <code>in</code> <code>is</code></p>
<p><strong><code>typeof</code> 用于判断基础类型。但是无法判断 <code>null</code>，<code>typeof null</code> 返回 <code>'object'</code>，可通过<code>value!==null</code> 进行判断。</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">agePlus</span>(<span class="hljs-params">age: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span></span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> age === <span class="hljs-string">"number"</span>) {
    age += <span class="hljs-number">2</span>;
  }
  <span class="hljs-keyword">return</span> age;
}
</code></pre>
<p><strong><code>instanceof</code> 判断是否为某个类实例。</strong></p>
<pre><code class="hljs language-ts" lang="ts">
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> {
  <span class="hljs-title class_">WangWang</span>() {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"WangWang"</span>;
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> {
  <span class="hljs-title class_">MiaoMiao</span>() {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"MiaoMiao"</span>;
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">speak</span>(<span class="hljs-params">animal: Animal</span>) {
  <span class="hljs-keyword">if</span> (animal <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Dog</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${animal.name}</span>:<span class="hljs-subst">${animal.WangWang()}</span>`</span>;
  }
  <span class="hljs-keyword">if</span> (animal <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Cat</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${animal.name}</span>:<span class="hljs-subst">${animal.MiaoMiao()}</span>`</span>;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${animal.name}</span>`</span>;
}
</code></pre>
<p><strong><code>in</code> 适用于对象类型定义，用于判断是否包含某个属性</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Dog</span> = {
  <span class="hljs-attr">a</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span>;
};
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Cat</span> = {
  <span class="hljs-attr">d</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">c</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">getAttr</span>(<span class="hljs-params">animal: Dog | Cat</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-string">"b"</span> <span class="hljs-keyword">in</span> animal) {
    <span class="hljs-keyword">return</span> animal.<span class="hljs-property">a</span>;
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-string">"d"</span> <span class="hljs-keyword">in</span> animal) {
    <span class="hljs-keyword">return</span> animal.<span class="hljs-property">c</span>;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-string">"unknown"</span>;
}
</code></pre>
<p><strong><code>is</code> 用于精准明确是什么类型，但是判断逻辑是我们自己写的，这就要求我们判断逻辑要精确，否则可能导致运行时错误。</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Dog</span> = {
  <span class="hljs-attr">a</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span>;
};
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Cat</span> = {
  <span class="hljs-attr">d</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">c</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-comment">// 内部逻辑自定义判断是否为某个类型</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isDog</span>(<span class="hljs-params">animal: Dog | Cat</span>): animal is <span class="hljs-title class_">Dog</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-string">"b"</span> <span class="hljs-keyword">in</span> animal;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">getAttr</span>(<span class="hljs-params">animal: Dog | Cat</span>) {
  <span class="hljs-comment">// 调用时如果为true，则推导为Dog</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDog</span>(animal)) {
    <span class="hljs-keyword">return</span> animal.<span class="hljs-property">a</span>;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> animal.<span class="hljs-property">c</span>;
  }
}
</code></pre>
<h3 data-id="heading-14">类型断言</h3>
<p>类型断言是将一个类型临时转为另一个类型，仅在编译阶段告诉TypeScript是什么类型，不能改变变量的实际类型。</p>
<p>类型断言需要开发者明确保证断言类型正确，否则可能会导致运行时异常。对于不确定的类型，因该优先使用<code>类型守卫</code>.</p>
<p><strong>使用<code>as</code>断言类型，可以转<code>unknown</code>类型、父类型转子类型场景。</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">let</span> <span class="hljs-attr">age</span>: <span class="hljs-built_in">unknown</span> = <span class="hljs-number">34</span>;
<span class="hljs-comment">// 可以断言类型为string，从而调用字符串的方法。</span>
<span class="hljs-comment">// 但是在运行时会报错</span>
(age <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>).<span class="hljs-title function_">toUpperCase</span>();
</code></pre>
<p>还可以通过<code>as const</code>断言为只读常量，常用于固定值的类型约束。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 类型为 string</span>
<span class="hljs-keyword">const</span> name = <span class="hljs-string">"hboot"</span>;

<span class="hljs-comment">// 类型为字面量 "hboot" 类型</span>
<span class="hljs-keyword">const</span> name = <span class="hljs-string">"hboot"</span> <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>;
</code></pre>
<p><strong>使用<code>!</code>断言非空，常用于访问某个可选属性时，断言非空</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Cat</span> = {
  d?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">c</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-keyword">let</span> <span class="hljs-attr">cat</span>: <span class="hljs-title class_">Cat</span> = {
  <span class="hljs-attr">c</span>: <span class="hljs-number">20</span>,
};
<span class="hljs-comment">// 未断言时调用报错属性 d 可能未定义</span>
<span class="hljs-comment">// cat.d.toUpperCase();</span>

<span class="hljs-comment">// 断言非空后则不会再提时报错，但是运行时报错 </span>
cat.<span class="hljs-property">d</span>!.<span class="hljs-title function_">toUpperCase</span>();
</code></pre>
<blockquote>
<p>所以，断言要谨慎使用、避免滥用，确保断言的类型是是实际数据类型的兼容类型。</p>
</blockquote>
<p><strong>还可以通过双层断言将一个明确的类型断言为另一个类型。</strong></p>
<p>这个操作很危险，实例中将<code>string</code>类型断言为<code>Cat</code>对象类型去访问属性<code>c</code>,编译通过，运行时爆炸。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Cat</span> = {
  d?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">c</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-keyword">let</span> name = <span class="hljs-string">"hboot"</span>;

(name <span class="hljs-keyword">as</span> <span class="hljs-built_in">unknown</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Cat</span>).<span class="hljs-property">c</span>;
</code></pre>
<h3 data-id="heading-15">运算符</h3>
<p>运算符可以从一个类型的到另一个类型。<code>类型安全</code>，类型运算的操作有很多</p>
<p><strong><code>keyof</code> 得到对象类型的所有字段<code>key</code>类型构成的联合类型。</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Cat</span> = {
  d?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">c</span>: <span class="hljs-built_in">number</span>;
};
<span class="hljs-comment">// 得到 Cat 的所有字段 key 类型 联合类型 "d" | "c"</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Keys</span> = keyof <span class="hljs-title class_">Cat</span>;

<span class="hljs-comment">// 如果字段是索引签名，则返回索引签名的类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Cat</span> = {
  [<span class="hljs-attr">x</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">unknown</span>;
};
<span class="hljs-comment">// 得到的是索引签名类型 string</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Keys</span> = keyof <span class="hljs-title class_">Cat</span>;
</code></pre>
<p><strong><code>typeof</code> 之前再类型守卫里已经介绍过了，它可以返回变量的类型（基本类型）。</strong></p>
<p><strong>索引访问（IndexedAccessType）获取类型,比如我们要获取对象类型里某个字段的类型，就可以使用索引获取。</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Cat</span> = {
  d?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">c</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-comment">// 获取字段类型为 string，但由于字段是可选 ？，</span>
<span class="hljs-comment">// 所以返回的是 string | undefined</span>
<span class="hljs-keyword">type</span> D = <span class="hljs-title class_">Cat</span>[<span class="hljs-string">"d"</span>];
</code></pre>
<p>也可以通过联合类型获取到多个字段的类型，结果为一个联合类型。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> D = <span class="hljs-title class_">Cat</span>[<span class="hljs-string">"d"</span>|<span class="hljs-string">"c"</span>]

<span class="hljs-comment">// 如果想要获取所有字段类型,可以通过keyof 获取到所有key的联合类型</span>
<span class="hljs-keyword">type</span> D = <span class="hljs-title class_">Cat</span>[keyof <span class="hljs-title class_">Cat</span>]
</code></pre>
<p>索引最重要的一点是可以对数组、元组元素的类型索引获取.</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> names = [<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>];
<span class="hljs-comment">// 索引第一个元素的类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Name</span> = names[<span class="hljs-number">0</span>];

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Names</span> = <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt;;
<span class="hljs-comment">// 索引数组元素的类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Name</span> = <span class="hljs-title class_">Names</span>[<span class="hljs-built_in">number</span>];
</code></pre>
<p>还可以搭配<code>typeof</code> 对变量的类型进行索引获取。</p>
<p><strong>条件类型（ConditionalType），通过输入的类型，决定输出类型</strong>，通过<code>extends</code>关键字和三元表达式来标识。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Name</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span> ? <span class="hljs-built_in">string</span> : <span class="hljs-built_in">number</span>;

<span class="hljs-comment">// 输入泛型参数返回类型，</span>
<span class="hljs-comment">// 输出类型为 string</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Admin</span> = <span class="hljs-title class_">Name</span>&lt;<span class="hljs-built_in">string</span>&gt;;
<span class="hljs-comment">// 输出类型为 number</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">User</span> = <span class="hljs-title class_">Name</span>&lt;<span class="hljs-built_in">unknown</span>&gt;;
</code></pre>
<p>也可以声明一个函数书写更复杂的判断逻辑。既然通过<code>extends</code>关键字以及泛型参数，那么也可以增加泛型约束、泛型默认值。</p>
<p><strong>映射类型（MappedType）,从一个类型创建一个新类型</strong>,建立在索引签名语法之上,通过对对象的字段键值、字段类型进行转换操作。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Cat</span> = {
  name?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-keyword">type</span> <span class="hljs-title class_">ToFunction</span>&lt;T&gt; = {
  [K <span class="hljs-keyword">in</span> keyof T]: <span class="hljs-function">() =&gt;</span> T[K];
};

<span class="hljs-comment">// 从基本类型转换成函数类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">CatFunction</span> = <span class="hljs-title class_">ToFunction</span>&lt;<span class="hljs-title class_">Cat</span>&gt;;
<span class="hljs-comment">/**
 *  type CatFunction = {
 *    name?: (() =&gt; string | undefined) | undefined;
 *    age: () =&gt; number;
 *  }
 */</span>
</code></pre>
<p><strong>文本类型（LiteralType）</strong>，通过扩展字符串生成文本类型，表现同字符串字面值相同。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Name</span> = <span class="hljs-string">"hboot"</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">GoodName</span> = <span class="hljs-string">`Good, <span class="hljs-subst">${Name}</span>`</span>;
</code></pre>
<p>利用文本类型扩展，可以结合映射类型，改变键值，得到一个全新的类型。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">ToFunction</span>&lt;T&gt; = {
  [K <span class="hljs-keyword">in</span> keyof T <span class="hljs-keyword">as</span> <span class="hljs-string">`on_<span class="hljs-subst">${<span class="hljs-built_in">string</span> &amp; K}</span>`</span>]: <span class="hljs-function">() =&gt;</span> T[K];
};

<span class="hljs-comment">// 就会得到不同键值、不同类型的新对象类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">CatFunction</span> = <span class="hljs-title class_">ToFunction</span>&lt;<span class="hljs-title class_">Cat</span>&gt;;
<span class="hljs-comment">/**
 *  type CatFunction = {
 *    on_name?: (() =&gt; string | undefined) | undefined;
 *    on_age: () =&gt; number;
 *  }
 */</span>
</code></pre>
<p><strong><code>infer</code> 类型推断</strong>，通常用于泛型参数推导；函数返回值类型推导</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Name</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Array</span>&lt;infer U&gt; ? U : T;

<span class="hljs-comment">// 条件类型推导 得到数组元素类型 string</span>
<span class="hljs-keyword">type</span> str = <span class="hljs-title class_">Name</span>&lt;<span class="hljs-built_in">string</span>[]&gt;;
<span class="hljs-comment">// 非数组类型，返回原类型 { name: string }</span>
<span class="hljs-keyword">type</span> info = <span class="hljs-title class_">Name</span>&lt;{ <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> }&gt;;
</code></pre>
<h3 data-id="heading-16">内置工具函数</h3>
<p>除了上述我们要手动去实现逻辑从而创建新的类型外，提供了内置函数可以直接使用，这些工具提供一些常用的类型转换逻辑。</p>
<p><strong><code>Partial&lt;T&gt;</code> 得到一个新类型，定义类型所有的字段都是可选的，与之相反的是<code>Required&lt;T&gt;</code></strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Cat</span> = {
  name?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-keyword">type</span> <span class="hljs-title class_">NewCat</span> = <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">Cat</span>&gt;;
<span class="hljs-comment">/**
 * type NewCat = {
 *   name?: string;
 *   age?: number;
 * }
 */</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">RequiredCat</span> = <span class="hljs-title class_">Required</span>&lt;<span class="hljs-title class_">Cat</span>&gt;;
<span class="hljs-comment">/**
 * type RequiredCat = {
 *   name: string;
 *   age: number;
 * }
 */</span>
</code></pre>
<p><strong><code>Pick&lt;T,Keys&gt;</code> 从一个类型中选择某些字段得到一个新类型，<code>Omit&lt;T,Keys&gt;</code>从一个类型中删除某些字段得到一个新类型</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Cat</span> = {
  name?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-keyword">type</span> <span class="hljs-title class_">NewCat</span> = <span class="hljs-title class_">Pick</span>&lt;<span class="hljs-title class_">Cat</span>, <span class="hljs-string">'name'</span>&gt;;
<span class="hljs-comment">/**
 * type NewCat = {
 *   name?: string;
 * }
 */</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">NewCat</span> = <span class="hljs-title class_">Omit</span>&lt;<span class="hljs-title class_">Cat</span>, <span class="hljs-string">'age'</span>&gt;;
<span class="hljs-comment">/**
 * type NewCat = {
 *   name?: string;
 * }
 */</span>
</code></pre>
<p><strong><code>Readonly&lt;T&gt;</code> 得到一个新类型，定义类型所有的字段都是只读的,初始化后不可以修改</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Cat</span> = {
  name?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-keyword">type</span> <span class="hljs-title class_">ReadonlyCat</span> = <span class="hljs-title class_">Readonly</span>&lt;<span class="hljs-title class_">Cat</span>&gt;;

<span class="hljs-keyword">let</span> <span class="hljs-attr">cat</span>: <span class="hljs-title class_">ReadonlyCat</span> = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"hboot"</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,
};

<span class="hljs-comment">// 报错，不可以修改再赋值，属性是只读的</span>
<span class="hljs-comment">// cat.age = 20;</span>
</code></pre>
<p>它没有与之相反定义的工具，怎么处理让所有只读属性都变为可编辑的呢？还记得上面讲过的<strong>映射类型</strong>吗？</p>
<p>在映射类型中通过使用<code>-</code>符号将所有字段的<code>readonly</code>修饰符都移除掉</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">MutableType</span>&lt;T&gt; = {
  -<span class="hljs-keyword">readonly</span> [K <span class="hljs-keyword">in</span> keyof T]: T[K];
};

<span class="hljs-keyword">let</span> <span class="hljs-attr">cat</span>: <span class="hljs-title class_">MutableType</span>&lt;<span class="hljs-title class_">ReadonlyCat</span>&gt; = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"hboot"</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,
};

<span class="hljs-comment">// 通过映射类型 -readonly 移除掉属性的只读修饰符</span>
cat.<span class="hljs-property">age</span> = <span class="hljs-number">20</span>;
</code></pre>
<p><strong><code>Record&lt;Keys,T&gt;</code> 可以创建一个由<code>Keys</code>组成的属性对应类型为<code>T</code>的对象类型</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Animal</span> = <span class="hljs-title class_">Record</span>&lt;
  <span class="hljs-string">"dog"</span> | <span class="hljs-string">"cat"</span>,
  {
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
  }
&gt;;

<span class="hljs-comment">/**
 * type Animal = {
 *   dog: {
 *     name: string;
 *     age: number;
 *   };
 *   cat: {
 *     name: string;
 *     age: number;
 *  }; 
 * }
 */</span>
</code></pre>
<p><strong><code>Exclude&lt;U,T&gt;</code>从指定联合类型<code>U</code>排除某个满足 <code>T</code>类型的成员，得到新类型；与之相反的是<code>Extract&lt;U,T&gt;</code></strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Type</span> = <span class="hljs-title class_">Exclude</span>&lt;<span class="hljs-string">"name"</span> | <span class="hljs-string">"age"</span> | <span class="hljs-number">32</span>, <span class="hljs-built_in">number</span> | <span class="hljs-string">"name"</span>&gt;;

<span class="hljs-comment">/**
 * type Type = "age"
 */</span>

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Type</span> = <span class="hljs-title class_">Extract</span>&lt;<span class="hljs-string">"name"</span> | <span class="hljs-string">"age"</span> | <span class="hljs-number">32</span>, <span class="hljs-built_in">number</span> | <span class="hljs-string">"name"</span>&gt;;
<span class="hljs-comment">/**
 * type Type = "name" | 32
 */</span>
</code></pre>
<p><strong><code>NonNullable&lt;Type&gt;</code>排除<code>null</code>和<code>undefined</code>的成员，得到新类型</strong></p>
<p><strong><code>Parameters&lt;Type&gt;</code> 从函数类型提取函数的参数类型，得到一个元组类型</strong>,非函数类型定义得到<code>never</code>类型。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Fun</span> = <span class="hljs-function">(<span class="hljs-params">name: <span class="hljs-built_in">string</span>, age: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Params</span> = <span class="hljs-title class_">Parameters</span>&lt;<span class="hljs-title class_">Fun</span>&gt;;
<span class="hljs-comment">/**
 * type Params = [name: string, age: number]
 */</span>
</code></pre>
<p><strong><code>ConstructorParameters&lt;Type&gt;</code> 从构造函数类型提取构造函数的参数类型，得到一个元组类型或数组类型</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">FunConstructorParams</span> = <span class="hljs-title class_">ConstructorParameters</span>&lt;<span class="hljs-title class_">FunctionConstructor</span>&gt;;
<span class="hljs-comment">/**
 * type FunConstructorParams = string[]
 */</span>

<span class="hljs-keyword">type</span> <span class="hljs-title class_">ErrorConstructorParams</span> = <span class="hljs-title class_">ConstructorParameters</span>&lt;<span class="hljs-title class_">ErrorConstructor</span>&gt;;
<span class="hljs-comment">/**
 * type ErrorConstructorParams =  [message?: string, options?: ErrorOptions]
 */</span>
</code></pre>
<p><strong><code>ReturnType&lt;Type&gt;</code> 从函数类型提取函数的返回值类型</strong>,对于非函数类型会得到<code>any</code>.</p>
<p><strong><code>Awaited</code> 用来获取异步函数的返回值类型</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Fun</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;{ <span class="hljs-attr">data</span>: <span class="hljs-built_in">string</span> }&gt;;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">FunType</span> = <span class="hljs-title class_">Awaited</span>&lt;<span class="hljs-title class_">ReturnType</span>&lt;<span class="hljs-title class_">Fun</span>&gt;&gt;;
<span class="hljs-comment">/**
 * type FunType = {
 *   data: string;
 * }
 */</span>
</code></pre>
<p><strong><code>InstanceType&lt;Type&gt;</code> 从构造函数类型提取构造函数的实例类型</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Fun</span> = <span class="hljs-keyword">new</span> () =&gt; { <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> };

<span class="hljs-keyword">type</span> <span class="hljs-title class_">FunType</span> = <span class="hljs-title class_">InstanceType</span>&lt;<span class="hljs-title class_">Fun</span>&gt;;
<span class="hljs-comment">/**
 * type FunType = {
 *   name: string;
 * }
 */</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }
}

<span class="hljs-keyword">type</span> <span class="hljs-title class_">AnimalType</span> = <span class="hljs-title class_">InstanceType</span>&lt;<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Animal</span>&gt;;
<span class="hljs-comment">/**
 * type AnimalType = Animal
 */</span>
</code></pre>
<p><strong><code>NoInfer&lt;T&gt;</code>阻止从该处推导泛型参数类型</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> compare&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>&gt;(<span class="hljs-attr">a</span>: T[], b?: <span class="hljs-title class_">NoInfer</span>&lt;T&gt;) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a, b);
}

<span class="hljs-comment">// 锁定了泛型 T 类型是 "admin" | "test" , 所以传入参数 "hboot" 会提示报错</span>
<span class="hljs-comment">// 如果没有 NoInfer 则不会报错，推断类型 string</span>
<span class="hljs-title function_">compare</span>([<span class="hljs-string">"admin"</span>, <span class="hljs-string">"test"</span>], <span class="hljs-string">"hboot"</span>);

</code></pre>
<p><strong><code>ThisParameterType&lt;T&gt;</code> 提取函数类型中的<code>this</code>参数的类型</strong>，如果没有<code>this</code>参数则返回<code>unknown</code></p>
<p><strong><code>OmitThisParameter&lt;Type&gt;</code> 移除函数类型中的<code>this</code>参数，得到一个新的函数类型</strong>，如果没有<code>this</code>参数或不是函数类型则返回类型本身。</p>
<p><strong><code>ThisType&lt;Type&gt;</code> 用于指定方法上下文中的<code>this</code>类型，不会返回新类型</strong>,指定后在方法中就可以通过<code>this</code>访问到指定属性。但是需要开启<code>noImplicitThis</code>（tsconfig.json）标志才可以使用。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Animal</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Dog</span> = {
  <span class="hljs-title function_">speak</span>(): <span class="hljs-built_in">void</span>;
} &amp; <span class="hljs-title class_">ThisType</span>&lt;<span class="hljs-title class_">Animal</span>&gt;;

<span class="hljs-keyword">const</span> <span class="hljs-attr">dog</span>: <span class="hljs-title class_">Dog</span> = {
  <span class="hljs-title function_">speak</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 通过this 可以访问到 name 属性</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
  },
};
</code></pre>
<p><strong>文本类型工具，用于处理文本，包括:</strong></p>
<ul>
<li><code>Uppercase&lt;StringType&gt;</code>  将字符串转换为大写</li>
<li><code>Lowercase&lt;StringType&gt;</code> 将字符串转换为小写</li>
<li><code>Capitalize&lt;StringType&gt;</code> 将字符串的第一个字符转换为大写</li>
<li><code>Uncapitalize&lt;StringType&gt;</code> 将字符串的开头字符转换为小写</li>
</ul>
<h2 data-id="heading-17">命名空间</h2>
<p>通过关键字<code>namespace</code> 定义空间名，用于分组相关的类型和值，避免命名冲突。并可通过<code>export</code>导出供外部使用</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Hboot</span> {
  <span class="hljs-comment">//外部无法访问</span>
  <span class="hljs-keyword">const</span> name = <span class="hljs-string">"hboot"</span> <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>;

  <span class="hljs-comment">// 外部可以访问</span>
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getName</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> name;
  }
}

<span class="hljs-title class_">Hboot</span>.<span class="hljs-title function_">getName</span>();
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[回顾计算属性的缓存与监听的触发返回结果]]></title>    <link>https://juejin.cn/post/7586879894207922239</link>    <guid>https://juejin.cn/post/7586879894207922239</guid>    <pubDate>2025-12-23T09:13:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586879894207922239" data-draft-id="7533501485156368418" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="回顾计算属性的缓存与监听的触发返回结果"/> <meta itemprop="keywords" content="前端,Vue.js,JavaScript"/> <meta itemprop="datePublished" content="2025-12-23T09:13:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="拉不动的猪"/> <meta itemprop="url" content="https://juejin.cn/user/1429793504759630"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            回顾计算属性的缓存与监听的触发返回结果
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1429793504759630/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    拉不动的猪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T09:13:55.000Z" title="Tue Dec 23 2025 09:13:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atelier-sulphurpool-light">.hljs-comment,.hljs-quote{color:#6b7394}.hljs-attribute,.hljs-link,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#c94922}.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#c76b29}.hljs-bullet,.hljs-string,.hljs-symbol{color:#ac9739}.hljs-section,.hljs-title{color:#3d8fd1}.hljs-keyword,.hljs-selector-tag{color:#6679cc}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#f5f7ff;color:#5e6687}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>网上的给出的区别有很多，今天只是简单来回归下其中的一些流程和区别的关键点。</p>
<p><strong>以下面的代码为例进行思考：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"calc"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-model.number</span>=<span class="hljs-string">"n1"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"number"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"数字1"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-model.number</span>=<span class="hljs-string">"n2"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"number"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"数字2"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>和：{{ sum }} 平均值：{{ avg }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"用户名"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"{color: tipColor}"</span>&gt;</span>{{ tip }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">n1</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">n2</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">tip</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">tipColor</span>: <span class="hljs-string">'#333'</span> }
    },
    <span class="hljs-attr">computed</span>: {
      <span class="hljs-title function_">sum</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">n1</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">n2</span> },
      <span class="hljs-title function_">avg</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">sum</span> / <span class="hljs-number">2</span> }
    },
    <span class="hljs-attr">watch</span>: {
      <span class="hljs-title function_">name</span>(<span class="hljs-params">v</span>) {
        <span class="hljs-keyword">if</span> (!v.<span class="hljs-title function_">trim</span>()) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">tip</span> = <span class="hljs-string">'不能为空'</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipColor</span> = <span class="hljs-string">'red'</span> }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (v.<span class="hljs-property">length</span> &lt; <span class="hljs-number">3</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">tip</span> = <span class="hljs-string">'不少于3位'</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipColor</span> = <span class="hljs-string">'orange'</span> }
        <span class="hljs-keyword">else</span> { <span class="hljs-variable language_">this</span>.<span class="hljs-property">tip</span> = <span class="hljs-string">'可用'</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipColor</span> = <span class="hljs-string">'green'</span> }
      }
    }
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
  <span class="hljs-selector-class">.calc</span> { <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>; <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#eee</span>; <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>; <span class="hljs-attribute">margin</span>: <span class="hljs-number">20px</span> auto; }
  <span class="hljs-selector-tag">input</span> { <span class="hljs-attribute">display</span>: block; <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>; <span class="hljs-attribute">margin</span>: <span class="hljs-number">8px</span> <span class="hljs-number">0</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">6px</span>; <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ccc</span>; <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>; }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>关于 watch 和 computed 的使用我们很多，这里我们不一一介绍，<strong>但是请记住：监听是不需要 return 的，计算属性是百分百必须要有的。</strong></p>
<h2 data-id="heading-1">1、监听和计算属性的区别</h2>
<h4 data-id="heading-2"><strong>最关键的区别：</strong></h4>
<p><strong>1、监听是没有缓存的，计算属性是有缓存的</strong></p>
<p><strong>2、监听是不需要有返回值的，但是机损属性是必须要有返回值的。（极限情况下不return基本没意义）</strong></p>
<p><strong>其他的区别：</strong></p>






























<table><thead><tr><th><strong>对比维度</strong></th><th><strong>计算属性（computed）</strong></th><th><strong>监听器（watch）</strong></th></tr></thead><tbody><tr><td><strong>核心用途</strong></td><td>基于已有数据<strong>推导 / 计算新数据</strong>（数据转换 / 组合）</td><td>监听已有数据的<strong>变化</strong>，执行异步操作或复杂逻辑（无新数据产出，侧重 “副作用”）</td></tr><tr><td><strong>依赖关系</strong></td><td>只能依赖 Vue 实例中的响应式数据（<code>data</code>/<code>props</code>/ 其他 <code>computed</code>），自动感知依赖变化</td><td>可监听单个响应式数据、对象属性、数组，甚至通过 <code>deep: true</code>监听对象深层变化，支持手动指定监听目标</td></tr><tr><td><strong>使用场景</strong></td><td>1. 简单数据拼接（如全名：<code>firstName + lastName</code>）2. 数据格式化（如时间戳转日期字符串）3. 依赖多数据的计算（如总价：<code>price * count</code>）4. 需缓存的重复计算场景</td><td>1. 异步操作（如监听输入框变化，延迟请求接口获取联想数据）2. 复杂逻辑处理（如监听用户状态变化，同步更新权限菜单）3. 监听对象深层变化（如监听表单对象，统一处理提交前校验）4. 数据变化后的联动操作（非数据推导类）</td></tr><tr><td><strong>是否支持异步</strong></td><td>不支持异步操作：若在 <code>computed</code>中使用异步（如定时器、接口请求），无法正确返回推导结果，会得到 <code>undefined</code></td><td>支持异步操作：这是 <code>watch</code>的核心优势之一，可在监听函数中执行任意异步逻辑</td></tr></tbody></table>
<h2 data-id="heading-3">2： 监听和计算属性的基本触发流程：</h2>
<h3 data-id="heading-4">核心逻辑：<code>set</code> → <code>Dep</code> → <code>Watcher</code> → <code>watch</code>/<code>computed</code> 联动流程</h3>
<p>无论是 <code>watch</code> 还是 <code>computed</code>，底层联动流程的核心一致，<strong>仅在</strong> <code>Watcher</code> <strong>执行逻辑上有差异</strong>，完整流程如下：</p>
<h3 data-id="heading-5">第一步：初始化阶段 —— 依赖收集（<code>get</code> 拦截器 + <code>Dep</code> + <code>Watcher</code> 绑定）</h3>
<ol>
<li><code>computed</code> ****<strong>的依赖收集</strong>：</li>
</ol>

<ol>
<li>组件初始化时，会为每个计算属性创建一个「计算属性 <code>Watcher</code>」；
1.  执行计算属性的 <code>get</code> 方法，访问依赖的响应式数据（如 <code>this.num1</code>）；
1.  触发该数据的 <code>get</code> 拦截器，<code>get</code> 拦截器会将当前「计算属性 <code>Watcher</code>」添加到该数据的 <code>Dep</code> 依赖列表中；
1.  所有依赖数据都完成 <code>Watcher</code> 绑定，最终缓存计算属性的初始结果。</li>
</ol>

<ol start="2">
<li><code>watch</code> ****<strong>的依赖收集</strong>：</li>
</ol>

<ol>
<li>
<ol>
<li>组件初始化时，会为每个 <code>watch</code> 监听目标创建一个「普通 <code>Watcher</code>」；</li>
<li>主动读取一次监听目标数据（如 <code>this.username</code>），触发该数据的 <code>get</code> 拦截器；</li>
<li><code>get</code> 拦截器将当前「普通 <code>Watcher</code>」添加到该数据的 <code>Dep</code> 依赖列表中；</li>
<li>若开启 <code>deep: true</code>，会递归遍历对象 / 数组的内部属性，完成深层依赖收集。</li>
</ol>
</li>
</ol>
<h3 data-id="heading-6">第二步：更新阶段 ——<code>set</code> 拦截器触发 <code>Watcher</code> 执行</h3>
<p>当修改响应式数据时（如 <code>this.num1 = 10</code>），触发底层联动：</p>
<ol>
<li>数据被修改，触发该数据的 <code>set</code> 拦截器；</li>
<li><code>set</code> 拦截器调用对应 <code>Dep</code> 的 <code>notify()</code> 方法（派发更新通知）；</li>
<li><code>Dep</code> 遍历自身的依赖列表，通知所有绑定的 <code>Watcher</code>「数据已更新」；</li>
<li>不同类型的 <code>Watcher</code> 接收通知后，执行差异化操作（这是 <code>watch</code> 和 <code>computed</code> 表现不同的核心原因）：</li>
</ol>
<ul>
<li>
<ul>
<li><strong>普通</strong> <code>Watcher</code> <strong>（对应</strong> <code>watch</code> <strong>）</strong> ：收到通知后，<strong>立即执行</strong> <code>watch</code> <strong>的回调函数</strong>，传入 <code>newVal</code> 和 <code>oldVal</code>，执行异步 / 复杂逻辑；</li>
<li><strong>计算属性</strong> <code>Watcher</code> <strong>（对应</strong> <code>computed</code> <strong>）</strong> ：收到通知后，<strong>仅将自身标记为「脏状态」（缓存失效）</strong> ，不立即执行计算逻辑，等待下次访问计算属性时，才重新执行 <code>get</code> 方法计算新结果并更新缓存。</li>
</ul>
</li>
</ul>
<p>举个例子：</p>
<pre><code class="hljs language-javascript" lang="javascript">  <span class="hljs-attr">watch</span>: {
    <span class="hljs-title function_">num</span>(<span class="hljs-params">newVal, oldVal</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`【watch】：num从<span class="hljs-subst">${oldVal}</span>变为<span class="hljs-subst">${newVal}</span>，我立即执行回调`</span>);
    }
  },
</code></pre>
<p>当 set 触发 watcher 后，watcher 就会立即触发：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">num</span>(<span class="hljs-params">newVal, oldVal</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`【watch】：num从<span class="hljs-subst">${oldVal}</span>变为<span class="hljs-subst">${newVal}</span>，我立即执行回调`</span>);
    }
</code></pre>
<p><strong>什么叫</strong> <strong>收到通知后，</strong> <strong>仅将自身标记为「脏状态」（缓存失效）</strong> <strong>，不立即执行计算逻辑，等待下次访问计算属性时，才重新执行</strong> <code>get</code> <strong>方法计算新结果并更新缓存。</strong></p>
<p><strong>举个例子：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 这里就是「访问计算属性」：模板渲染时会读取 numDouble 的值 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"num &lt; 2"</span>&gt;</span>两倍数：{{ numDouble }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">num</span>: <span class="hljs-number">1</span> };
  },
  <span class="hljs-attr">computed</span>: {
    <span class="hljs-title function_">numDouble</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"计算属性执行计算"</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">num</span> * <span class="hljs-number">2</span>;
    },
  },
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">num</span> = <span class="hljs-number">5</span>; <span class="hljs-comment">// 2秒后，v-if不成立</span>
  }, <span class="hljs-number">2000</span>);
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">num</span> = <span class="hljs-number">1</span>; <span class="hljs-comment">// 4秒后，v-if再次成立</span>
  }, <span class="hljs-number">4000</span>);
  },
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

// 控制台只会打印2次“计算属性执行
</code></pre>
<p><strong>为什么只打印 2 次：</strong></p>
<p><strong>原因就是我们的计算属性在 2s 后没有执行</strong></p>
<p><strong>1、 当初始化时，页面中 v-if 条件是符合的，会执行一次 get 计算得到返回值</strong></p>
<p><strong>2、当经过两秒后、</strong> <strong>v-if 不符合条件，这个时候表明numDouble 是脏数据，会对其进行标记（</strong> <strong>v-if 不符合条件，所以无法对numDouble 进行访问，</strong> <strong>这里也就是我们说的缓存，缓存计算属性的结果值，当脏状态取消时才会进行新的计算</strong> <strong>)</strong></p>
<p><strong>3、当 经过 4 秒后条件再次被满足时，才会有新的计算。</strong></p>
<h2 data-id="heading-7">3： 计算属性为什么不能异步</h2>
<p><strong>举个例子，我们使用延时进行模仿：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 这里就是「访问计算属性」：模板渲染时会读取 numDouble 的值 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"num &lt; 2"</span>&gt;</span>两倍数：{{ numDouble }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">num</span>: <span class="hljs-number">1</span> };
  },
  <span class="hljs-attr">computed</span>: {
    <span class="hljs-title function_">numDouble</span>(<span class="hljs-params"/>) {
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">num</span> * <span class="hljs-number">2</span>;
      }, <span class="hljs-number">1000</span>);
    },
  },
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">numDouble</span>);
  },
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>打印结果如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e5f59c20b284dd38f6f7325a9e275cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ouJ5LiN5Yqo55qE54yq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086035&amp;x-signature=2Wg17EQIry85cV7xM1hV0RJP8W4%3D" alt="" loading="lazy"/></p>
<p>为什么会打印 underfined 呢，这里有两个原因？</p>
<h3 data-id="heading-8">原因 1：JavaScript 中，任何函数如果没有显式写 <code>return</code> 语句，或 <code>return</code> 后没有跟随具体值，都会默认返回 <code>undefined</code>，这是计算属性返回 <code>undefined</code> 的基础原因。</h3>
<p>举个例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"/>) {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-keyword">return</span> <span class="hljs-number">11</span>;
        }, <span class="hljs-number">1000</span>);
      }
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">test</span>());
      }, <span class="hljs-number">2000</span>);
</code></pre>
<p>这样写是属于语法的错误。</p>
<h3 data-id="heading-9">原因 2：setTimeout 的异步特性（关键）</h3>
<p>即使你在 <code>setTimeout</code> 回调中写了 <code>return this.num * 2</code>，这个返回值也毫无意义，因为 <code>setTimeout</code>是<strong>异步宏任务</strong>：</p>
<ol>
<li>当 Vue 访问 <code>this.numDouble</code> 时，会立即执行计算属性的函数体；</li>
<li>函数体执行到 <code>setTimeout</code> 时，只会「注册一个异步任务」，然后直接跳过 <code>setTimeout</code> 继续执行；</li>
<li>此时计算属性函数体已经执行完毕（没有显式 <code>return</code>），默认返回 <code>undefined</code>，并被 <code>console.log</code> 打印；</li>
<li>1 秒后，<code>setTimeout</code> 的回调函数才会执行，此时回调中的 <code>return this.num * 2</code> 只是回调函数自身的返回值，无法传递给计算属性，也无法改变之前已经返回的 <code>undefined</code>。</li>
</ol>
<p><strong>简单说：异步回调的返回值，无法成为计算属性的返回值，计算属性会在异步任务注册后，直接默认返回</strong> <code>undefined</code> <strong>。</strong></p>
<h3 data-id="heading-10"><strong>也可以分两步走</strong></h3>
<h3 data-id="heading-11">一、先明确：计算属性的函数体，<strong>只在 “被访问” 时同步执行一次（除非满足重新计算条件）</strong></h3>
<p>当 <code>mounted</code> 中访问 <code>this.numDouble</code>，或者模板渲染访问 <code>numDouble</code> 时，Vue 会<strong>同步、完整地执行一遍</strong> ****<code>numDouble</code> ****<strong>函数体的代码</strong>，但这个执行过程和 <code>setTimeout</code> 内部的回调是完全分离的：</p>
<h4 data-id="heading-12">第一步：计算属性函数体「同步执行」（瞬间完成，不等待异步）</h4>
<p>我们把 <code>numDouble</code> 的执行过程拆解成 “逐行执行”，你就能看清流程：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">numDouble</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 第1步：执行 setTimeout 这行代码</span>
  <span class="hljs-comment">// 作用：向浏览器“注册一个1秒后执行的异步任务”，仅此而已</span>
  <span class="hljs-comment">// 注意：这行代码执行时，不会等待1秒，也不会执行回调函数内部的代码</span>
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 这是回调函数，此时完全没有执行！</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"回调函数开始执行"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">num</span> * <span class="hljs-number">2</span>;
  }, <span class="hljs-number">1000</span>);

  <span class="hljs-comment">// 第2步：计算属性函数体执行到末尾</span>
  <span class="hljs-comment">// 没有显式 return，默认返回 undefined</span>
  <span class="hljs-comment">// 此时，numDouble 已经完成了“返回值”的传递，整个函数体执行结束</span>
}
</code></pre>
<p>简单来说就是<code>numDouble</code> 函数体的执行，只做了一件事 ——“安排了一个 1 秒后的任务”，然后就直接返回了 <code>undefined</code>，它不会停下来等 1 秒后回调执行完再返回值。</p>
<h4 data-id="heading-13">第二步：1 秒后，异步回调才执行，但为时已晚</h4>
<ol>
<li>计算属性已经在第一步就返回了 <code>undefined</code>，这个返回值已经被 <code>console.log</code> 打印，也被 Vue 缓存起来了；</li>
<li>1 秒后，浏览器才会执行 <code>setTimeout</code> 的回调函数，此时回调里的 <code>return this.num * 2</code> 只是 “回调函数自己的返回值”—— <strong>这个值没有任何接收者，既不能传给</strong> <code>numDouble</code> <strong>，也不能改变之前已经返回的</strong> <code>undefined</code> <strong>；</strong></li>
<li>更关键的是：回调执行时，<code>numDouble</code> 函数体早就执行完毕了，<strong>两者是完全独立的执行流程</strong>，回调的返回值无法 “回溯” 给已经执行完的计算属性。</li>
</ol>
<h3 data-id="heading-14">简单来讲就是：</h3>
<p><strong>计算属性是要内置返回一个结果的，如果加入异步就会因为执行顺讯返回一个undefined，监听是在事件触发后对写入的回调函数的调用。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[当10年架构师拿起AI：不是写不动了，是写得太快了]]></title>    <link>https://juejin.cn/post/7586657335882154011</link>    <guid>https://juejin.cn/post/7586657335882154011</guid>    <pubDate>2025-12-23T09:11:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586657335882154011" data-draft-id="7586836874016292874" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="当10年架构师拿起AI：不是写不动了，是写得太快了"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-23T09:11:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="腾讯云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/3456520257538830"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            当10年架构师拿起AI：不是写不动了，是写得太快了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3456520257538830/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    腾讯云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T09:11:15.000Z" title="Tue Dec 23 2025 09:11:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>引言</strong></h2>
<p>过去这一年，AI 编程工具如雨后春笋。作为技术人，我们或许都体验过 AI 编程工具补全代码的“爽感”。但当视角从“个人”拉升到“组织”，作为 CTO 或架构师的你，是否正面临着一种“数据的尴尬”：</p>
<ul>
<li>开发者说好用，但项目交付周期并没有显著缩短？</li>
<li>代码生成量上去了，但 Code Review 和 Debug 的时间却变长了？</li>
<li>想在团队推广 AI 工作流，却发现只有零星几个人在真正使用？</li>
</ul>
<p><strong>“AI 编程提效”</strong> ，究竟是实打实的生产力革命，还是一场属于管理者的集体错觉？</p>
<p>在个人好用与团队可用之间，隔着一道名为“工程化”的鸿沟。架构师的职责，就是填平这道沟。</p>
<p><strong>12 月 25 日（周四）晚 19:00</strong>，圣诞之夜， <strong>《架构师夜生活》邀你共赴一场关于“真相”的年终复盘。我们集结了出行、金融、AI</strong> <strong>智能体</strong> <strong>、低代码领域的四位技术领袖，不聊虚的，只谈 AI 编程在组织级落地的真实数据、踩坑经验与边界规范。</strong></p>
<h2 data-id="heading-1"><strong>直播看点</strong></h2>
<ul>
<li>抛开厂商的宣传 PPT，在真实的业务场景（高并发交易、银行核心系统、<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fproduct%2Fweda%3Ffrom_column%3D20065%26from%3D20065" target="_blank" title="https://cloud.tencent.com/product/weda?from_column=20065&amp;from=20065" ref="nofollow noopener noreferrer">低代码平台</a>）中，AI 到底能提效多少？10% 还是 50%？哪些岗位被严重高估了？</li>
<li>从“个人玩具”到“团队工具”，CTO 们在推行 AI 编程时最容易犯哪些错？如何避免陷入“为了 AI 而 AI”的 KPI 游戏？</li>
<li>当 AI 介入编码，代码规范、Code Review 流程、安全边界该如何重构？架构师如何定义 AI 的“行动边界”，防止它成为生产环境的“定时炸弹”？</li>
</ul>
<h2 data-id="heading-2"><strong>嘉宾阵容</strong></h2>
<p>本次做客直播间的四位嘉宾，有一个共同的特点：<strong>他们既是掌控全局的技术决策者，又是依然活跃在代码一线的“超级个体”。</strong></p>
<p>正因为拥有深厚的架构功底和业务视野，AI 编程在他们手中，不再仅仅是“补全代码”的初级工具，而是得心应手、能指数级放大个人能力的“外脑”。</p>
<p>在当下软件开发领域，有这样一群资深程序员：随着年岁增长，他们或许不再有通宵逐字敲代码的体力，但几十年的业务洞察与架构经验却已化作直觉。AI 编程工具的出现，为他们开启了职业生涯的“第二春”。</p>
<p>编程不再是单纯的体力劳动，而是演变成了“人、机器、业务”三者间的深度协作。有经验的架构师们，能够凭借对业务逻辑的深刻理解，一语中的，将复杂需求抽象为精准指令，指挥 AI 高效产出。这种“经验+AI”的组合，让他们爆发出了甚至<strong>超越壮年时期 3 倍的生产力</strong>。他们不再只是写代码的人，而是懂业务、懂架构、懂沟通的指挥官。</p>
<p><strong>主持人</strong></p>
<p><strong>Dora | 腾讯<strong><strong>云架构</strong></strong>师技术同盟副秘书长</strong></p>
<p>全面负责腾讯云千万级开发者社群的建设与发展。致力于搭建跨行业技术创新平台，连接技术决策者与开发者，推动企业数字化转型。</p>
<p><strong>嘉宾</strong></p>
<p><strong>王晓波 | 腾讯云架构师技术同盟活动组织主席</strong></p>
<p>拥有十余年基础架构与业务架构经验，主导了同程基础架构、私有云系统建设。他在处理海量交易与高可用系统设计方面有着深厚功力，深刻理解技术驱动力的重要性。</p>
<p><strong>鲍丹 | 腾讯云架构师名人堂专家</strong></p>
<p>曾负责邮储银行新一代分布式核心系统实施，是 Dubbo、Sentinel 等知名开源项目的 Committer。精通 Redis-Cluster 等<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fproduct%2Fmessage-queue-catalog%3Ffrom_column%3D20065%26from%3D20065" target="_blank" title="https://cloud.tencent.com/product/message-queue-catalog?from_column=20065&amp;from=20065" ref="nofollow noopener noreferrer">中间件</a>技术，拥有丰富的<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fproduct%2Fai-class%3Ffrom_column%3D20065%26from%3D20065" target="_blank" title="https://cloud.tencent.com/product/ai-class?from_column=20065&amp;from=20065" ref="nofollow noopener noreferrer">人工智能</a>应用落地经验。</p>
<p><strong>白德鑫 | 腾讯云架构师名人堂专家</strong></p>
<p>全面负责 AI 智能体与脑机接口产品的架构与商业化落地。曾任关税宝 CTO 及神策数据架构师，是一位横跨前沿技术与商业管理的复合型专家。</p>
<p><strong>茹炳晟 | 腾讯云架构师技术同盟入会成长主席</strong></p>
<p>业界知名实战派软件质量和研发工程效能专家，具有超过 16 年的软件测试开发经验和技术管理经验，具有丰富的测试框架设计与自动化测试经验。</p>
<h2 data-id="heading-3"><strong>直播信息</strong></h2>
<p>⏰ 直播时间： 12 月 25 日（周四） 19:00 - 22:00</p>
<p>📍 观看方式： 视频号直播（扫描海报二维码预约）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8547d358d06d4316941f3901d29cc529~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767085875&amp;x-signature=NDDfDYgK4YRZSIgNzv7SLduVOpw%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-4"><strong>关于《架构师夜生活》</strong></h2>
<p><strong>《架构师夜生活》——技术人的深夜食堂</strong></p>
<p>当夜幕降临，代码的世界才真正苏醒。我们致力为技术人们打造一场有温度的深夜对话。邀请业内知名技术专家和行业 KOL，用最轻松的方式聊最前沿的技术。这里没有枯燥的 PPT，只有真实的故事和犀利的观点。</p>
<p>从架构设计到职业迷茫，从技术选型到管理心经——我们把复杂的技术问题掰开了、揉碎了聊。</p>
<p><strong>12 月 25 日晚 19:00，在这个特殊的夜晚，来直播间，我们一起拆解 AI 编程的真相。</strong></p>
<p><strong>【架构师夜生活】</strong></p>
<p><em>当夜幕降临，代码的世界才真正苏醒。我们致力于为技术人们打造一场有温度的深夜对话。邀请业内知名技术专家和行业 KOL，用最轻松的方式聊最前沿的技术。这里没有 PPT，只有真实的故事。从架构设计到创业感悟，从技术选型到职场成长——复杂的技术问题用最简单的语言解释，让每个技术人都能有所收获。我们相信，最好的技术交流不需要西装革履，只需要一颗好奇的心和一群有趣的灵魂。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[05 Go Eino AI应用开发实战 | Docker 部署指南]]></title>    <link>https://juejin.cn/post/7585474459776565284</link>    <guid>https://juejin.cn/post/7585474459776565284</guid>    <pubDate>2025-12-20T09:32:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585474459776565284" data-draft-id="7585121055037374514" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="05 Go Eino AI应用开发实战 | Docker 部署指南"/> <meta itemprop="keywords" content="后端,Go,人工智能"/> <meta itemprop="datePublished" content="2025-12-20T09:32:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="王中阳讲AI编程"/> <meta itemprop="url" content="https://juejin.cn/user/2189882892232029"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            05 Go Eino AI应用开发实战 | Docker 部署指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2189882892232029/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    王中阳讲AI编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T09:32:00.000Z" title="Sat Dec 20 2025 09:32:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;font-weight:400;line-height:2;font-size:17px;overflow-x:hidden;color:#000}.markdown-body strong{padding:1px;color:#ee3f4d}.markdown-body em{padding:0 2px;color:#f33b1f}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:30px;margin-bottom:20px;line-height:1.5;font-weight:700}.markdown-body h1{text-align:center;padding-bottom:5px;font-size:32px;color:#ac1f18}.markdown-body h1:after{content:"";display:block;margin:4px auto 0;width:100px;height:2px;border-bottom:2px solid #f33b1f}.markdown-body h2{font-size:28px;border-bottom:1px solid #f33b1f}.markdown-body h2:before{content:"# "!important;color:#f33b1f}.markdown-body h3{font-size:24px;padding-left:9px;border-left:6px solid #f33b1f}.markdown-body h4{font-size:20px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #bbb;margin:16px 0}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f9f1db;color:#ee2746;border-radius:2px;font-size:16px;padding:1px 2px}.markdown-body code,.markdown-body pre{font-family:-apple-system,-apple-system-body,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,PingFang SC,思源黑体 CN,思源黑体,JetBrains Mono,Fira Code,Menlo,Ubuntu Mono,Consolas,sans-serif}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{margin:12px 0!important;border-radius:3px;font-size:15px;padding:16px 12px;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f7f7f7}.markdown-body a{text-decoration:none;color:#1781b5;padding:0 2px;border-bottom:1px solid #1781b5}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #f33b1f;color:#ac1f18}.markdown-body blockquote{color:#3d3d3d;background-color:#fff9f9;padding:6px 16px;margin:16px 0;border-left:3px solid #f07c82}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:6px 0}.markdown-body ol,.markdown-body ul{padding-left:30px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:6px}.markdown-body ol li{padding-left:6px}.markdown-body ::marker{color:#f33b1f}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body .task-list-item input[type=checkbox]{position:relative}.markdown-body .task-list-item input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:#fff;border:1px solid #f07c82;border-radius:3px;box-sizing:border-box;z-index:1}.markdown-body .task-list-item input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-5px;left:0;right:0;bottom:0;width:0;height:0;color:#f33b1f;font-size:16px;font-weight:700;z-index:2}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table thead{background:#fff9f9;color:#000;text-align:left;font-size:15px}.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table tr:hover{background-color:#fff9f9}.markdown-body table td,.markdown-body table th{padding:12px 7px;line-height:24px;border:1px solid #f9f1db}.markdown-body table td{min-width:120px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><blockquote>
<p>本指南提供了使用 Docker 和 Docker Compose 部署 Go-Eino Interview Agent 平台的全面说明。该平台由多个微服务组成，包括 Go 后端、Next.js 前端、MySQL 数据库、Redis 缓存以及用于 AI 功能的可选 Milvus 向量数据库。</p>
</blockquote>
<h2 data-id="heading-0">架构概述</h2>
<p>部署架构采用微服务模式，包含以下核心组件：</p>
<ul>
<li>外部访问</li>
<li>Docker 网络
<ul>
<li>端口 80</li>
<li>端口 80</li>
<li>/api/*</li>
<li>/*</li>
</ul>
</li>
<li>Nginx 反向代理</li>
<li>前端 :3000</li>
<li>后端 :8888</li>
<li>MySQL :3306</li>
<li>Redis :6379</li>
<li>Etcd :2379</li>
<li>用户浏览器</li>
<li>API 客户端</li>
</ul>
<h2 data-id="heading-1">前置条件</h2>
<p>在开始部署之前，请确保已安装以下软件：</p>
<ul>
<li>Docker（版本 20.10 或更高）</li>
<li>Docker Compose（版本 2.0 或更高）</li>
<li>Git 用于克隆仓库</li>
<li>至少 4GB RAM 以获得最佳性能</li>
</ul>
<h2 data-id="heading-2">快速开始</h2>
<p>运行平台最快的方式是使用提供的 Docker Compose 配置：</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> &lt;repository-url&gt;
<span class="hljs-built_in">cd</span> go-eino-interview-agent 
<span class="hljs-comment"># 启动所有服务</span>
docker compose -f docker-compose.yml up -d 
<span class="hljs-comment"># 检查服务状态</span>
docker compose ps
</code></pre>
<p>应用程序将在以下地址可用：</p>
<ul>
<li>前端：<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost" target="_blank" title="http://localhost" ref="nofollow noopener noreferrer">http://localhost</a></li>
<li>后端 API：<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%2Fapi" target="_blank" title="http://localhost/api" ref="nofollow noopener noreferrer">http://localhost/api</a></li>
<li>MySQL：localhost:3307</li>
<li>Redis：localhost:6379</li>
</ul>
<h2 data-id="heading-3">部署配置</h2>
<p>项目为不同的部署场景提供了三种 Docker Compose 配置：</p>

























<table><thead><tr><th>配置</th><th>用途</th><th>主要特性</th></tr></thead><tbody><tr><td>docker-compose.yml</td><td>开发</td><td>包含 Nginx 代理的全栈服务，暴露外部端口</td></tr><tr><td>docker-compose-prod.yml</td><td>生产</td><td>为生产环境优化，内部网络通信</td></tr><tr><td>docker-compose-example.yml</td><td>模板</td><td>包含示例的配置参考</td></tr></tbody></table>
<h3 data-id="heading-4">开发环境部署</h3>
<p>开发配置文件 docker-compose.yml 包含：</p>
<ul>
<li>Nginx 反向代理，监听端口 80</li>
<li>所有服务的外部端口暴露</li>
<li>健康检查用于服务监控</li>
<li>数据持久化的卷挂载</li>
</ul>
<h3 data-id="heading-5">生产环境部署</h3>
<p>生产配置文件 docker-compose-prod.yml 针对以下方面进行了优化：</p>
<ul>
<li>内部网络通信（减少外部暴露）</li>
<li>生产环境变量</li>
<li>优化的构建参数</li>
<li>安全加固</li>
</ul>
<p>对于生产部署，请始终使用环境变量来管理敏感数据，如数据库密码和 API 密钥。切勿将这些值提交到版本控制系统。</p>
<h2 data-id="heading-6">服务配置</h2>
<h3 data-id="heading-7">后端服务</h3>
<p>后端服务 backend/Dockerfile 使用多阶段构建进行优化：</p>
<pre><code class="hljs language-dockerfile" lang="dockerfile"># 构建阶段
FROM golang:1.24-alpine AS builder
# ... 构建过程 ... 
# 运行时阶段  
FROM alpine:3.18
# ... 最小运行时镜像 ...
</code></pre>
<p>关键配置：</p>
<ul>
<li>端口：8888</li>
<li>健康检查：/health 端点</li>
<li>用户：非 root 用户（appuser:1001）</li>
<li>时区：Asia/Shanghai</li>
</ul>
<h3 data-id="heading-8">前端服务</h3>
<p>前端服务 frontend/Dockerfile 同样使用多阶段构建：</p>
<pre><code class="hljs language-dockerfile" lang="dockerfile"># 构建阶段
FROM node:18-alpine AS builder
# ... Next.js 构建 ... 
# 运行时阶段
FROM node:18-alpine
# ... 生产运行时 ...
</code></pre>
<p>关键配置：</p>
<ul>
<li>端口：3000</li>
<li>构建参数：NEXT_PUBLIC_API_BASE_URL</li>
<li>健康检查：根端点</li>
<li>用户：非 root 用户（appuser:1001）</li>
</ul>
<h3 data-id="heading-9">数据库服务</h3>
<h4 data-id="heading-10">MySQL 配置</h4>
<ul>
<li>版本：8.0</li>
<li>端口：3307（外部），3306（内部）</li>
<li>数据库：interview_agent</li>
<li>健康检查：MySQL ping 命令</li>
<li>持久化：命名卷 mysql-data</li>
</ul>
<h4 data-id="heading-11">Redis 配置</h4>
<ul>
<li>版本：7-alpine</li>
<li>端口：6379</li>
<li>持久化：启用 AOF</li>
<li>健康检查：Redis ping 命令</li>
<li>持久化：命名卷 redis-data</li>
</ul>
<h3 data-id="heading-12">Nginx 配置</h3>
<p>Nginx 反向代理 nginx.conf 提供：</p>
<ul>
<li>API 路由：/api/* → backend:8888</li>
<li>前端路由：/* → frontend:3000</li>
<li>WebSocket 支持：Upgrade 头部</li>
<li>SSE 支持：禁用流式传输的缓冲</li>
<li>健康检查：/health 端点</li>
</ul>
<h2 data-id="heading-13">环境变量</h2>
<h3 data-id="heading-14">必需变量</h3>
<p>在项目根目录创建 .env 文件：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 数据库配置</span>
DB_PASSWORD=your_secure_password
DB_USER=root
DB_NAME=interview_agent 
<span class="hljs-comment"># Redis 配置  </span>
REDIS_PASSWORD=your_redis_password 
<span class="hljs-comment"># API 配置</span>
NEXT_PUBLIC_API_BASE_URL=http://your-domain:8888/api 
<span class="hljs-comment"># AI 服务（可选）</span>
EMBEDDING_API_KEY=your_embedding_key
EMBEDDING_MODEL=your_model_id
EMBEDDING_BASE_URL=https://api.example.com
MILVUS_ADDRESS=milvus:19530
</code></pre>
<h3 data-id="heading-15">配置文件</h3>
<p>后端使用 config.example.yaml 作为模板。复制并自定义：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cp</span> backend/config.example.yaml backend/config.yaml
</code></pre>
<p>关键配置部分：</p>
<ul>
<li>数据库：MySQL 连接设置</li>
<li>Redis：缓存配置</li>
<li>安全：JWT 密钥和 CORS 设置</li>
<li>AI 服务：OpenAI、Embedding 和 Milvus 设置</li>
</ul>
<h2 data-id="heading-16">部署流程</h2>
<h3 data-id="heading-17">步骤 1：准备工作</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 克隆并进入项目</span>
git <span class="hljs-built_in">clone</span> &lt;repository-url&gt;
<span class="hljs-built_in">cd</span> go-eino-interview-agent 
<span class="hljs-comment"># 创建环境文件</span>
<span class="hljs-built_in">cp</span> .env.example .<span class="hljs-built_in">env</span>
<span class="hljs-comment"># 使用你的值编辑 .env </span>
<span class="hljs-comment"># 准备后端配置</span>
<span class="hljs-built_in">cp</span> backend/config.example.yaml backend/config.yaml
<span class="hljs-comment"># 使用你的设置编辑 config.yaml</span>
</code></pre>
<h3 data-id="heading-18">步骤 2：构建和部署</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 构建并启动所有服务</span>
docker compose -f docker-compose.yml up -d --build 
<span class="hljs-comment"># 监控部署进度</span>
docker compose logs -f 
<span class="hljs-comment"># 检查服务健康状态</span>
docker compose ps
</code></pre>
<h3 data-id="heading-19">步骤 3：验证</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 测试后端健康状态</span>
curl http://localhost/health 
<span class="hljs-comment"># 测试前端访问  </span>
curl -I http://localhost 
<span class="hljs-comment"># 检查数据库连接</span>
docker compose <span class="hljs-built_in">exec</span> backend ./main -check-db
</code></pre>
<h2 data-id="heading-20">故障排除</h2>
<h3 data-id="heading-21">常见问题</h3>

























<table><thead><tr><th>问题</th><th>解决方案</th></tr></thead><tbody><tr><td>端口冲突</td><td>在 docker-compose.yml 中更改外部端口</td></tr><tr><td>数据库连接错误</td><td>验证 MySQL 健康状态和凭据</td></tr><tr><td>构建失败</td><td>检查 Docker 守护进程和可用磁盘空间</td></tr><tr><td>权限错误</td><td>确保卷权限正确设置</td></tr></tbody></table>
<h3 data-id="heading-22">健康检查命令</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查所有服务状态</span>
docker compose ps 
<span class="hljs-comment"># 查看服务日志</span>
docker compose logs backend
docker compose logs frontend
docker compose logs mysql 
<span class="hljs-comment"># 访问服务 Shell</span>
docker compose <span class="hljs-built_in">exec</span> backend sh
docker compose <span class="hljs-built_in">exec</span> mysql mysql -u root -p
</code></pre>
<h2 data-id="heading-23">性能监控</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 监控资源使用</span>
docker stats 
<span class="hljs-comment"># 检查容器健康状态</span>
docker compose <span class="hljs-built_in">exec</span> backend curl localhost:8888/health
docker compose <span class="hljs-built_in">exec</span> frontend curl localhost:3000
</code></pre>
<h2 data-id="heading-24">高级配置</h2>
<h3 data-id="heading-25">Milvus 向量数据库（可选）</h3>
<p>要启用 AI 功能，请在 docker-compose.yml 中取消注释以下服务：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 取消注释这些服务</span>
<span class="hljs-attr">milvus:</span>
  <span class="hljs-attr">image:</span> <span class="hljs-string">milvusdb/milvus:v2.4.0</span>
  <span class="hljs-comment"># ... 配置 ... </span>
<span class="hljs-attr">attu:</span>
  <span class="hljs-attr">image:</span> <span class="hljs-string">zilliz/attu:v2.3.4</span>  
  <span class="hljs-comment"># ... 配置 ...</span>
</code></pre>
<h3 data-id="heading-26">自定义网络</h3>
<p>部署使用自定义桥接网络 app-network 进行服务隔离：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">networks:</span>
  <span class="hljs-attr">app-network:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">bridge</span>
</code></pre>
<h3 data-id="heading-27">卷管理</h3>
<p>持久化数据存储在命名卷中：</p>

























<table><thead><tr><th>卷</th><th>用途</th></tr></thead><tbody><tr><td>mysql-data</td><td>MySQL 数据库文件</td></tr><tr><td>redis-data</td><td>Redis AOF 文件</td></tr><tr><td>etcd-data</td><td>Etcd 集群数据</td></tr><tr><td>milvus-data</td><td>向量数据库（可选）</td></tr></tbody></table>
<h2 data-id="heading-28">生产最佳实践</h2>
<p>对于生产部署，建议使用密钥管理、外部数据库，并在负载均衡器级别配置适当的 SSL/TLS 终止。</p>
<h3 data-id="heading-29">安全考虑</h3>
<ol>
<li>使用非 root 用户（已配置）</li>
<li>实施密钥管理保护敏感数据</li>
<li>启用 SSL/TLS 终止</li>
<li>定期安全更新基础镜像</li>
<li>网络分段保护敏感服务</li>
</ol>
<h3 data-id="heading-30">性能优化</h3>
<ol>
<li>为容器设置资源限制</li>
<li>数据库访问使用连接池</li>
<li>频繁访问数据采用缓存策略</li>
<li>设置监控和告警</li>
</ol>
<h3 data-id="heading-31">备份策略</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 数据库备份</span>
docker compose <span class="hljs-built_in">exec</span> mysql mysqldump -u root -p interview_agent &gt; backup.sql 
<span class="hljs-comment"># 卷备份</span>
docker run --<span class="hljs-built_in">rm</span> -v mysql-data:/data -v $(<span class="hljs-built_in">pwd</span>):/backup alpine tar czf /backup/mysql-backup.tar.gz -C /data .
</code></pre>
<h2 data-id="heading-32">后续步骤</h2>
<p>成功部署后，你可能想要探索：</p>
<ul>
<li>架构概述 - 了解系统设计</li>
<li>开发环境设置 - 本地开发配置</li>
<li>Kubernetes 部署 - 扩展到生产集群</li>
<li>监控和可观测性 - 生产监控设置</li>
</ul>
<h2 data-id="heading-33">一起学习进步</h2>
<p>对这个项目感兴趣的朋友欢迎关注我，私信我，免费领取学习资料，一起成长进步。</p>
<p>系列教程查看下方专栏即可：</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《闭包、RAG与AI面试官：一个前端程序员的奇幻LangChain之旅》]]></title>    <link>https://juejin.cn/post/7586922268022947876</link>    <guid>https://juejin.cn/post/7586922268022947876</guid>    <pubDate>2025-12-23T09:08:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586922268022947876" data-draft-id="7586922268022915108" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《闭包、RAG与AI面试官：一个前端程序员的奇幻LangChain之旅》"/> <meta itemprop="keywords" content="前端,面试,LangChain"/> <meta itemprop="datePublished" content="2025-12-23T09:08:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Yira"/> <meta itemprop="url" content="https://juejin.cn/user/262123324974122"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《闭包、RAG与AI面试官：一个前端程序员的奇幻LangChain之旅》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/262123324974122/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Yira
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T09:08:08.000Z" title="Tue Dec 23 2025 09:08:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">《闭包、RAG与AI面试官：一个前端程序员的奇幻LangChain之旅》</h2>
<p>在某个风和日丽的下午，小李——一位自诩“能用一行代码解决的问题绝不用两行”的前端工程师——正坐在工位上，盯着屏幕上一行报错发呆。他不是在调试React组件，也不是在修复CSS样式错乱，而是在尝试用AI模型回答一个看似简单却深不见底的问题：“<strong>什么是闭包？</strong> ”</p>
<p>但别误会，这不是一篇枯燥的技术教程。这是一场融合了<strong>LangChain魔法、DeepSeek大模型、提示词工程、工作流编排</strong>以及一点点程序员幽默感的奇妙冒险。我们将从一行<code>import</code>开始，穿越提示词模板、链式调用、序列化流程，最终抵达AI驱动的智能应用新大陆。准备好了吗？系好安全带，我们的LangChain飞船即将升空！</p>
<hr/>
<h3 data-id="heading-1">第一幕：环境变量——AI世界的“启动密钥”</h3>
<p>一切的起点，都始于那句神秘的咒语：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">import</span> <span class="hljs-string">'dotenv/config'</span>;
</code></pre>
<p>对，就是它！这行代码仿佛打开了通往异世界的传送门，把藏在 <code>.env</code> 文件里的 <code>DEEPSEEK_API_KEY</code> 唤醒。没有它，AI就像没插电的机器人——再聪明也动不了。小李深知：<strong>在AI时代，API密钥就是你的魔法杖</strong>。</p>
<blockquote>
<p>小知识：<code>.env</code> 文件通常包含敏感信息（如密钥、数据库密码），绝不能提交到Git！记得把它加入 <code>.gitignore</code>。</p>
</blockquote>
<p>接着，他召唤出了今天的主角之一：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatDeepSeek</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/deepseek'</span>;
</code></pre>
<p><code>ChatDeepSeek</code> 是 LangChain 为 DeepSeek 大模型提供的官方适配器。LangChain 的伟大之处在于——它用“适配器模式”帮我们屏蔽了不同大模型（LLM）之间的差异。换句话说，<strong>你不用再为每个模型重写一套调用逻辑</strong>。今天用 DeepSeek，明天换通义千问？只要接口一致，几乎无缝切换。</p>
<p>这省下的时间，足够你多喝三杯咖啡，或者多摸五分钟鱼——而后者，往往是程序员真正的刚需。</p>
<hr/>
<h3 data-id="heading-2">第二幕：提示词——给AI戴上“人设面具”</h3>
<p>小李知道，直接问AI“什么是闭包？”太粗暴了。AI可能会给你一段教科书式的定义，也可能突然开始讲哲学，甚至反问你：“你确定要听真话吗？”</p>
<p>于是，他祭出了 <strong>PromptTemplate</strong> ——LangChain 中的提示词模板神器。</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">prompt</span> = PromptTemplate.fromTemplate(`
    你是一个{role},
    请用不超过{limit}字回答以下问题:
    {question}
`)<span class="hljs-comment">;</span>
</code></pre>
<p>看，这不只是提问，这是在<strong>给AI分配角色</strong>！你可以让它扮演“毒舌面试官”、“耐心导师”，甚至是“脱口秀演员”。在这个例子中，小李设定了：</p>
<ul>
<li><code>role: '前端面试官'</code></li>
<li><code>limit: '50'</code></li>
<li><code>question: '什么是闭包'</code></li>
</ul>
<p>然后格式化：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">promptStr</span> = await prompt.<span class="hljs-title function_ invoke__">format</span>({
    <span class="hljs-attr">role</span>:<span class="hljs-string">'前端面试官'</span>,
    <span class="hljs-attr">limit</span>:<span class="hljs-string">'50'</span>,
    <span class="hljs-attr">question</span>:<span class="hljs-string">'什么是闭包'</span>
});
</code></pre>
<p>结果？AI秒回一句精准又犀利的回答：</p>
<blockquote>
<p>“闭包是函数记住并访问其词法作用域的能力，即使在函数外部执行。”</p>
</blockquote>
<p><strong>50字，不多不少，面试官看了直呼内行</strong>。</p>
<blockquote>
<p>提示词工程（Prompt Engineering）的本质，就是“如何优雅地指挥AI”。你不是在写代码，你是在写剧本。而好的提示词，就是让AI入戏的导演手记。</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">第三幕：单步调用 vs 链式思维——从“问答机”到“思考者”</h3>
<p>但小李不满足于一次性的问答。他想让AI先详细解释概念，再提炼要点，最后生成学习建议。这怎么办？总不能手动复制粘贴三次吧？</p>
<p>这时候，LangChain 的 <strong>Chain（链）</strong> 概念闪亮登场。</p>
<h4 data-id="heading-4">简单链：Pipe 一下，世界清净了</h4>
<p>最基础的链，用 <code>.pipe()</code> 连接提示词和模型：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">chain</span> = prompt.pipe(model)<span class="hljs-comment">;</span>
const <span class="hljs-attr">response</span> = await chain.invoke({ topic: <span class="hljs-string">'什么是闭包'</span> })<span class="hljs-comment">;</span>
</code></pre>
<p>这里，<code>prompt</code> 是输入模板，<code>model</code> 是语言模型，<code>pipe</code> 把它们串成流水线。输入 <code>{topic}</code>，输出 AI 回答。<strong>简洁、优雅、可复用</strong>。</p>
<p>这就像你点奶茶：选口味（prompt）→ 加糖（参数）→ 出杯（invoke）。全程自动化，无需人工干预。</p>
<h4 data-id="heading-5">复杂链：RunnableSequence——AI的“多工序车间”</h4>
<p>但真实业务往往更复杂。比如小李的需求：</p>
<ol>
<li>先让AI详细解释“闭包”；</li>
<li>再让另一个提示词把解释总结成三个要点；</li>
<li>最后拼接成完整报告。</li>
</ol>
<p>LangChain 提供了 <code>RunnableSequence</code> 来实现这种多步骤流程：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> fullChain = <span class="hljs-title class_">RunnableSequence</span>.<span class="hljs-title function_">from</span>([
    <span class="hljs-function">(<span class="hljs-params">input</span>) =&gt;</span> explainChain.<span class="hljs-title function_">invoke</span>({<span class="hljs-attr">topic</span>: input.<span class="hljs-property">topic</span>}).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-property">text</span>),
    <span class="hljs-function">(<span class="hljs-params">explanation</span>) =&gt;</span> summaryChain.<span class="hljs-title function_">invoke</span>({<span class="hljs-attr">explain</span>: explanation}).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-string">`知识点总结: ...`</span>)
]);
</code></pre>
<p>注意：每一步都是异步的，且前一步的输出自动成为后一步的输入。<strong>整个过程像一条装配线，原料进去，成品出来</strong>。</p>
<p>运行结果令人惊喜：</p>
<ul>
<li>第一阶段输出300字内的专业解释；</li>
<li>第二阶段自动生成如“1. 函数携带作用域 2. 延长变量生命周期 3. 可能导致内存泄漏”这样的干货总结；</li>
<li>最终返回结构化文本，可直接用于教学或笔记。</li>
</ul>
<p><strong>这哪是AI？这分明是你的私人学习助理+内容编辑+知识萃取师</strong>！</p>
<hr/>
<h3 data-id="heading-6">第四幕：RAG？一句话说清！——测试AI的“基本功”</h3>
<p>当然，小李也没忘了测试AI的基础能力。他直接问：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">res</span> = await model.invoke(<span class="hljs-string">'用一句话解释什么是RAG?'</span>)<span class="hljs-comment">;</span>
console.log(res.content)<span class="hljs-comment">;</span>
</code></pre>
<p>AI答：“RAG（检索增强生成）是一种结合外部知识库与大语言模型的技术，通过检索相关信息来增强生成内容的准确性。”</p>
<p><strong>一句话，准确、简洁、无废话</strong>。温度（temperature）设为0，确保AI不“放飞自我”。</p>
<blockquote>
<p>温度是什么？简单说，温度越高，AI越“有创意”（也越可能胡说八道）；温度越低，越“严谨”（但也可能死板）。面试场景？当然选0.7左右，既专业又不死板。写诗？那就拉到1.2，让它尽情发挥！</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">第五幕：为什么LangChain是AI应用的“乐高积木”？</h3>
<p>看到这里，你可能想问：<strong>为什么不用原生API直接调用？</strong></p>
<p>答案是：<strong>复杂业务需要工程化</strong>。</p>
<p>想象一下，你要做一个“智能面试系统”：</p>
<ul>
<li>用户输入问题；</li>
<li>AI先判断问题领域（前端/后端/算法）；</li>
<li>然后切换不同角色回答；</li>
<li>再根据用户水平调整解释深度；</li>
<li>最后生成学习路径+相关练习题。</li>
</ul>
<p>如果全用手写Promise链，代码会变成意大利面条，维护成本爆炸。而LangChain的 <strong>Runnable、Chain、Agent、Memory</strong> 等抽象，让你像搭乐高一样组合功能模块。</p>
<p>更重要的是——<strong>每一步都可测试、可替换、可复用</strong>。今天用DeepSeek，明天换Claude？只要接口一致，几乎不用改代码！</p>
<p>LangChain 的哲学是：<strong>不要重复造轮子，而是把轮子组装成车</strong>。</p>
<hr/>
<h3 data-id="heading-8">第六幕：闭包的隐喻——程序员与AI的共生关系</h3>
<p>回到最初的问题：“什么是闭包？”</p>
<p>对小李来说，闭包不仅是JavaScript的一个特性，更是一种隐喻：<strong>函数携带着它诞生时的环境，在陌生的地方依然能访问“家”中的变量</strong>。</p>
<p>而LangChain，就像是那个“环境”——它包裹着大模型的能力，让我们在复杂的AI应用世界中，依然能保持代码的清晰与可控。</p>
<p>我们写的每一行提示词，都是在为AI“注入上下文”；每一个Chain，都是在构建“认知流水线”。<strong>我们不是在取代AI，而是在与AI协同进化</strong>。</p>
<hr/>
<h3 data-id="heading-9">终章：从玩具到生产——LangChain的实战价值</h3>
<p>别以为这只是玩具代码。在真实项目中，LangChain 已被广泛应用于：</p>
<ul>
<li>智能客服（自动问答+意图识别）</li>
<li>文档摘要（上传PDF → 自动生成摘要）</li>
<li>代码助手（自然语言生成SQL/React组件）</li>
<li>教育工具（自动生成习题+解析）</li>
</ul>
<p>而这一切的核心，正是我们今天演示的：<strong>提示词 + 模型 + 链式编排</strong>。</p>
<p>所以，下次当你被问到“什么是闭包”时，不妨笑着回答：</p>
<blockquote>
<p>“闭包，就是一个函数带着它的‘童年回忆’闯荡江湖。而我，用LangChain给AI装上了‘回忆提取器’，让它不仅能答题，还能当老师、做总结、甚至讲段子。”</p>
</blockquote>
<p>技术很酷，但更酷的是——<strong>我们正在用代码，重新定义人与智能的关系</strong>。</p>
<hr/>
<h3 data-id="heading-10">彩蛋：避坑指南 &amp; 最佳实践</h3>
<ol>
<li>
<p><strong>不要在一个文件里重复导入</strong><br/>
你提供的代码片段中有多个 <code>import 'dotenv/config'</code> 和重复的模型初始化。实际项目中应拆分为模块，避免冲突。</p>
</li>
<li>
<p><strong>合理使用 .gitignore</strong><br/>
确保 <code>.env</code> 不被提交！否则你的API密钥将公之于众。</p>
</li>
<li>
<p><strong>温度控制很重要</strong></p>
<ul>
<li><code>temperature: 0</code> → 确定性输出（适合事实问答）</li>
<li><code>temperature: 0.7</code> → 平衡创意与准确（适合创作、解释）</li>
<li><code>temperature: 1.0+</code> → 放飞自我（适合诗歌、故事）</li>
</ul>
</li>
<li>
<p><strong>Chain 可嵌套</strong><br/>
你可以把一个Chain作为另一个Chain的节点，构建树状工作流。</p>
</li>
<li>
<p><strong>监控与日志</strong><br/>
在生产环境中，记得记录每一步的输入输出，便于调试和优化提示词。</p>
</li>
</ol>
<hr/>
<p>Happy Coding，愿你的AI永远不胡说，你的闭包永不泄漏，你的Chain永远畅通无阻！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SystemServer类 与 system_server进程]]></title>    <link>https://juejin.cn/post/7586902693857247274</link>    <guid>https://juejin.cn/post/7586902693857247274</guid>    <pubDate>2025-12-23T08:44:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586902693857247274" data-draft-id="7586889698242297919" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SystemServer类 与 system_server进程"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-23T08:44:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="StarShip"/> <meta itemprop="url" content="https://juejin.cn/user/3790771820172391"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SystemServer类 与 system_server进程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3790771820172391/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    StarShip
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T08:44:11.000Z" title="Tue Dec 23 2025 08:44:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><ul>
<li><strong><code>system_server</code></strong>：是一个 <strong>进程名</strong>，指系统中那条最关键的 Java 进程。</li>
<li><strong><code>SystemServer</code></strong>：是一个 <strong>Java 类</strong>（<code>com.android.server.SystemServer</code>），在 <code>system_server</code> 进程里运行，负责在这个进程中 <strong>创建并启动各种系统服务</strong>。</li>
</ul>
<hr/>
<h2 data-id="heading-0"><strong>一、各自是什么？</strong></h2>
<h3 data-id="heading-1"><strong>1.</strong> <strong><code>system_server</code></strong> <strong>是什么？</strong></h3>
<ul>
<li>
<p><strong>身份</strong>：Linux 用户空间里的 <strong>一个进程</strong>，进程名是 <code>system_server</code>。</p>
</li>
<li>
<p><strong>来源</strong>：由 <strong>Zygote</strong> 通过 <code>forkSystemServer()</code> fork 出来。</p>
</li>
<li>
<p><strong>作用</strong>：承载绝大部分 <strong>Framework 层 Java 系统服务</strong> 的运行环境。</p>
</li>
<li>
<p><strong>特征</strong>：</p>
<ul>
<li>运行用户：一般是 <strong>system UID</strong>；</li>
<li>在 <code>ps</code> / <code>top</code> / <code>dumpsys</code> / <code>logcat</code> 等工具中，以 <strong>进程实体</strong> 的形式出现；</li>
<li>一旦这个进程崩溃，整个 Android Framework 基本算“挂了”。</li>
</ul>
</li>
</ul>
<p>可以把它理解为： <strong>“系统服务 Java 世界的大房子”</strong> 。</p>
<h3 data-id="heading-2"><strong>2.</strong> <strong><code>SystemServer</code></strong> <strong>是什么？</strong></h3>
<ul>
<li>
<p><strong>身份</strong>：一个 <strong>Java 类</strong>，完整类名为： <strong><code>com.android.server.SystemServer</code></strong>。</p>
</li>
<li>
<p><strong>所在进程</strong>：这段代码在 <strong><code>system_server</code></strong> <strong>进程内部执行</strong>。</p>
</li>
<li>
<p><strong>作用</strong>：在 <code>run()</code> 方法里去：</p>
<ul>
<li>创建各种系统服务对象（如 AMS、PMS、WMS 等）；</li>
<li>调用它们的 <code>onStart()</code> 之类方法；</li>
<li>把它们注册进 <code>ServiceManager</code>；</li>
<li>最后进入主线程消息循环，维持整个系统服务运行。</li>
</ul>
</li>
</ul>
<p>可以把它理解为： <strong>“在 system_server 这个房子里跑起来的主程序/管家”</strong> 。</p>
<h2 data-id="heading-3"><strong>二、两者的关系：谁在谁里面？</strong></h2>
<p>用一句话描述关系：</p>
<blockquote>
<p><strong><code>system_server</code></strong> <strong>= 进程容器，</strong> <strong><code>SystemServer</code></strong> <strong>= 这个进程里跑的入口类。</strong></p>
</blockquote>
<p>更具体一点的启动链（简化版）：</p>
<ol>
<li>
<p><strong>ZygoteInit.main()</strong> （在 zygote 进程里）</p>
<ol>
<li>调用 <code>startSystemServer()</code>；</li>
</ol>
</li>
<li>
<p><strong>startSystemServer()</strong></p>
<ol>
<li>通过 <code>forkSystemServer()</code> → 从 Zygote fork 出一个子进程；</li>
<li>为这个子进程设置进程名为 <strong><code>system_server</code></strong>；</li>
</ol>
</li>
<li>
<p><strong>子进程（也就是 system_server 进程）启动后</strong></p>
<ol>
<li>执行 <code>com.android.internal.os.RuntimeInit</code> 相关初始化；</li>
<li>再调用 <strong><code>com.android.server.</code></strong> <strong><code>SystemServer.main</code></strong> <strong><code>()</code></strong> ；</li>
</ol>
</li>
<li>
<p><strong>SystemServer.main()</strong></p>
<ol>
<li>new 一个 <code>SystemServer</code> 对象，调用 <code>run()</code>；</li>
<li>在里面执行 <code>startBootstrapServices()</code> / <code>startCoreServices()</code> / <code>startOtherServices()</code> 启动各个 service。</li>
</ol>
</li>
</ol>
<p>所以关系图可以理解为：</p>
<ul>
<li><strong>进程级</strong>：<code>zygote</code> → fork → <strong><code>system_server</code></strong> <strong>进程</strong></li>
<li><strong>进程内部代码入口</strong>：<code>SystemServer.main()</code> → <code>SystemServer.run()</code> → 启动各个系统服务</li>
</ul>
<h2 data-id="heading-4"><strong>三、核心区别：视角与关注点的不同</strong></h2>
<ol>
<li><strong>从系统 / 内核视角</strong></li>
</ol>
<ul>
<li>你看到的是：<strong>有一个叫</strong> <strong><code>system_server</code></strong> <strong>的进程</strong>，占用 CPU/内存，是内核调度的对象。</li>
</ul>
<p>崩溃日志里 top line 一般写的是：</p>
<p>Process: system_server</p>
<ul>
<li>相当于“操作系统观”下的实体。</li>
</ul>
<ol start="2">
<li><strong>从 Java / Framework 开发者视角</strong></li>
</ol>
<ul>
<li>
<p>你在源码里看到的是：<strong>有一个</strong> <strong><code>SystemServer</code></strong> <strong>类</strong>，负责系统服务的启动。</p>
</li>
<li>
<p>工作内容主要是：</p>
<ul>
<li>在 <code>SystemServer</code> 里加/改系统服务的创建顺序、参数、依赖；</li>
<li>调整某个服务何时由 <code>SystemServer</code> 拉起。</li>
</ul>
</li>
</ul>
<ol start="3">
<li><strong>从调试/排查问题视角</strong></li>
</ol>
<ul>
<li><strong>进程级问题</strong>（如 OOM、native crash、Watchdog 卡死）： 你关注的是 <strong><code>system_server</code></strong> <strong>tombstone</strong> <strong>、ANR traces、进程优先级、CPU/memory</strong>。</li>
<li><strong>服务启动/依赖顺序问题</strong>（比如某个 Service 没有正常启动、死在启动流程里）： 你更多会去看 <strong><code>SystemServer.startBootstrapServices/startOtherServices</code></strong> <strong>里的代码与日志</strong>。</li>
</ul>
<h2 data-id="heading-5"><strong>四、联系总结（可以记住的一句对照）</strong></h2>
<ul>
<li>
<p><strong><code>system_server</code></strong> <strong>：</strong></p>
<ul>
<li>概念：进程名</li>
<li>角色：承载 Framework Java 服务的 <strong>进程容器</strong></li>
<li>对象：操作系统 / 内核 / 调度</li>
</ul>
</li>
<li>
<p><strong><code>SystemServer</code></strong> <strong>：</strong></p>
<ul>
<li>概念：Java 类</li>
<li>角色：在 <code>system_server</code> 进程里负责 <strong>启动所有系统服务的入口类</strong></li>
<li>对象：Framework 开发 / 系统服务逻辑</li>
</ul>
</li>
</ul>
<p><strong>可以类比成：</strong></p>
<ul>
<li><code>system_server</code> ≈ “整栋大楼（进程）”</li>
<li><code>SystemServer</code> ≈ “负责把楼里各个部门（服务）都组织起来运转的物业/总管程序”</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[拆解指数加权平均：5 分钟看懂机器学习的 “数据平滑神器”]]></title>    <link>https://juejin.cn/post/7586622708999454760</link>    <guid>https://juejin.cn/post/7586622708999454760</guid>    <pubDate>2025-12-23T07:49:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586622708999454760" data-draft-id="7586622708999438376" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="拆解指数加权平均：5 分钟看懂机器学习的 “数据平滑神器”"/> <meta itemprop="keywords" content="机器学习,人工智能"/> <meta itemprop="datePublished" content="2025-12-23T07:49:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Narrastory"/> <meta itemprop="url" content="https://juejin.cn/user/4355593566170010"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            拆解指数加权平均：5 分钟看懂机器学习的 “数据平滑神器”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4355593566170010/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Narrastory
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:49:30.000Z" title="Tue Dec 23 2025 07:49:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">拆解指数加权平均：5 分钟看懂机器学习的 “数据平滑神器”</h2>
<p><code>Ming | 2025.12</code></p>
<hr/>
<div align="center">
  <img align="center" src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/017af1e2a1eb4ab5a0a43a2d3bdc1880~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080970&amp;x-signature=d%2F05QcLxv2ohejCYN1L1hO5gRGU%3D" alt="AI Generated Art" width="90%" loading="lazy"/>
</div>
<p>什么是指数加权平均？简单来说，它是一种用于将序列数据变得更加平滑的经典方法。在机器学习中，我们经常会遇到来自传感器、实验或训练过程的噪声数据，这些数据波动很大，不容易直接观察趋势。指数加权平均就像一个“数据平滑神器”，能够有效过滤短期波动，突出长期趋势，帮助我们更好地理解数据变化。</p>
<p>例如，下面是一个带有噪声的原始序列：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c2ea5dcfc3d4c00b610cc9f2ecbdc86~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080970&amp;x-signature=3cyqRXdYrytnmcd7fDTGTAz%2BVEA%3D" alt="c1.jpg" loading="lazy"/></p>
<p>在使用不同平滑参数 β 的指数加权平均后，我们可以得到平滑程度各异的序列：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5de4f0e67314e7991481793bef600fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080970&amp;x-signature=gAOxfpfh7IH8dR4Y7Ii17P67BtE%3D" alt="c2.jpg" loading="lazy"/></p>
<p>如果是了解过股票交易的朋友，应该对“移动平均线”（Moving Average）这个概念非常熟悉。它常被用于观察股价的趋势，帮助投资者过滤短期市场的“噪声”，把握中长期的走势方向。其实，指数加权平均正是股票技术分析中“指数移动平均线”（Exponential Moving Average, EMA）的核心计算方法。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f5b21c8647548a0b4e532990ad1815d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080970&amp;x-signature=lQogsUfvPp0Bt7Sh647X10MFEGQ%3D" alt="c5.jpg" loading="lazy"/></p>
<p>指数加权平均的实现非常简单，其本质是对历史数据进行加权组合，且权重随时间指数衰减。</p>
<p>假设我们有一个原始序列 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>a</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>a</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">a_1, a_2, …, a_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，我们希望得到一个平滑后的序列 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>b</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>b</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">b_1, b_2, …, b_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>。</p>
<p>通常我们令初始平滑值 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mn>0</mn></msub><mo>=</mo><msub><mi>a</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">b_0 = a_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，然后从 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">n=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span> 开始迭代计算：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>b</mi><mi>n</mi></msub><mo>=</mo><mi>β</mi><msub><mi>b</mi><mrow><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>+</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>β</mi><mo stretchy="false">)</mo><msub><mi>a</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">b_{n} = \beta b_{n-1} +(1-\beta)a_{n}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.9028em;vertical-align:-0.2083em;"/><span class="mord mathnormal" style="margin-right:0.05278em;">β</span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.05278em;">β</span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></div>
<p>其中，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>β</mi></mrow><annotation encoding="application/x-tex">\beta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05278em;">β</span></span></span></span></span> 是一个介于 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span> 之间的平滑因子。β 越大，曲线越平滑，但也会对最新数据的反应变得“迟钝”；β 越小，平滑后的曲线越接近原始数据，保留的细节也越多。公式可以直观理解为：每一步的平滑值 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">b_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 是上一时刻平滑值 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mrow><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">b_{n-1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9028em;vertical-align:-0.2083em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span></span></span></span></span> 与当前观测值 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">a_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 的加权平均。</p>
<p>假设我们有一个长度为 5 的序列：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>a</mi><mo>=</mo><mo stretchy="false">[</mo><mn>10</mn><mo separator="true">,</mo><mn>8</mn><mo separator="true">,</mo><mn>12</mn><mo separator="true">,</mo><mn>9</mn><mo separator="true">,</mo><mn>11</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">a=[10,8,12,9,11]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">10</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">8</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">12</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">9</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">11</span><span class="mclose">]</span></span></span></span></span></div>
<p>并取 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>β</mi><mo>=</mo><mn>0.8</mn></mrow><annotation encoding="application/x-tex">\beta = 0.8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05278em;">β</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0.8</span></span></span></span></span>，初始值 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mn>0</mn></msub><mo>=</mo><msub><mi>a</mi><mn>0</mn></msub><mo>=</mo><mn>10</mn></mrow><annotation encoding="application/x-tex">b_0 = a_0 = 10</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">10</span></span></span></span></span>。我们一步步来计算 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">b_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 到 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mn>5</mn></msub></mrow><annotation encoding="application/x-tex">b_5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：</p>
<ol>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mn>1</mn></msub><mo>=</mo><mn>0.8</mn><mo>×</mo><mn>10</mn><mo>+</mo><mn>0.2</mn><mo>×</mo><mn>8</mn><mo>=</mo><mn>8</mn><mo>+</mo><mn>1.6</mn><mo>=</mo><mn>9.6</mn></mrow><annotation encoding="application/x-tex">b_1 = 0.8 \times 10 + 0.2 \times 8 = 8 + 1.6 = 9.6</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">0.8</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">10</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">0.2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">8</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">8</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1.6</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">9.6</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mn>2</mn></msub><mo>=</mo><mn>0.8</mn><mo>×</mo><mn>9.6</mn><mo>+</mo><mn>0.2</mn><mo>×</mo><mn>12</mn><mo>=</mo><mn>7.68</mn><mo>+</mo><mn>2.4</mn><mo>=</mo><mn>10.08</mn></mrow><annotation encoding="application/x-tex">b_2 = 0.8 \times 9.6 + 0.2 \times 12 = 7.68 + 2.4 = 10.08</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">0.8</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">9.6</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">0.2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">12</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">7.68</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2.4</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">10.08</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mn>3</mn></msub><mo>=</mo><mn>0.8</mn><mo>×</mo><mn>10.08</mn><mo>+</mo><mn>0.2</mn><mo>×</mo><mn>9</mn><mo>=</mo><mn>8.064</mn><mo>+</mo><mn>1.8</mn><mo>=</mo><mn>9.864</mn></mrow><annotation encoding="application/x-tex">b_3 = 0.8 \times 10.08 + 0.2 \times 9 = 8.064 + 1.8 = 9.864</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">0.8</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">10.08</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">0.2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">9</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">8.064</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1.8</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">9.864</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mn>4</mn></msub><mo>=</mo><mn>0.8</mn><mo>×</mo><mn>9.864</mn><mo>+</mo><mn>0.2</mn><mo>×</mo><mn>11</mn><mo>=</mo><mn>7.8912</mn><mo>+</mo><mn>2.2</mn><mo>=</mo><mn>10.0912</mn></mrow><annotation encoding="application/x-tex">b_4 = 0.8 \times 9.864 + 0.2 \times 11 = 7.8912 + 2.2 = 10.0912</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">0.8</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">9.864</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">0.2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">11</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">7.8912</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2.2</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">10.0912</span></span></span></span></span></li>
</ol>
<p>最终平滑后的序列约为：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>b</mi><mo>=</mo><mo stretchy="false">[</mo><mn>9.6</mn><mo separator="true">,</mo><mn>10.08</mn><mo separator="true">,</mo><mn>9.864</mn><mo separator="true">,</mo><mn>10.0912</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">b=[9.6,10.08,9.864,10.0912]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">9.6</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">10.08</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">9.864</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">10.0912</span><span class="mclose">]</span></span></span></span></span></div>
<p>可以看出，原本波动较大的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>8</mn><mo separator="true">,</mo><mn>12</mn><mo separator="true">,</mo><mn>9</mn><mo separator="true">,</mo><mn>11</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[8, 12, 9, 11]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">8</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">12</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">9</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">11</span><span class="mclose">]</span></span></span></span></span> 被平滑为一个变化更缓和的序列。</p>
<p>为什么这个公式能让一个曲线变得更加平滑呢？其实很好理解，从“惯性”的角度来看。当 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>β</mi></mrow><annotation encoding="application/x-tex">\beta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05278em;">β</span></span></span></span></span> 很大（比如 0.9）时，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mrow><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">b_{n-1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9028em;vertical-align:-0.2083em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span></span></span></span></span> 在更新中占据很大比重，当前的新值 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">a_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 只占很小的比例，这意味着平滑序列 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span> 具有强烈的“记忆”能力，不会因为某一点的突变而产生剧烈波动。反之，如果 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>β</mi></mrow><annotation encoding="application/x-tex">\beta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05278em;">β</span></span></span></span></span> 很小（比如 0.1），则平滑序列会更紧密地跟踪原始数据的变化，适应更快，但平滑效果减弱。</p>
<p>不知道到这里你发现没有，上面的式子虽然能很好的平滑序列，但是有一个缺点，就是在序列刚开始的时候容易“失真”。从上面的展开式也可以看出，在序列开始时，我们令<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mn>0</mn></msub><mo>=</mo><msub><mi>a</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">b_0 = a_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，由于历史数据较少，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">b_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 的权重 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>β</mi></mrow><annotation encoding="application/x-tex">\beta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05278em;">β</span></span></span></span></span> 较大，若 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">b_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 与 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>a</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo></mrow><annotation encoding="application/x-tex">a_1, a_2, …</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">…</span></span></span></span></span> 差异明显，就会导致平滑序列初期出现“失真”。下面这张图就清晰展示了这个问题：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd8a0a6dd9984587b801b071ec9791fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080970&amp;x-signature=Nczhtvds9i134sD98T4vVvE9eck%3D" alt="c3.jpg" loading="lazy"/></p>
<p>蓝色是原始曲线，红色是指数加权平均后的曲线。明显可见，红色曲线在开始阶段比蓝色高出不少，这是因为我们初始设置 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mn>0</mn></msub><mo>=</mo><msub><mi>a</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">b_0 = a_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，而 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">a_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 可能恰是一个较大或较小的异常值，影响了后续若干点的平滑结果。</p>
<p>那么如何解决这种失真呢，方法有很多，常用的解决方法之一是<strong>使用序列前若干点的平均值作为初始值</strong>，而不是直接使用 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">a_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>。</p>
<p>具体做法是：</p>
<ol>
<li>选取一个合适的初始窗口长度 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span>（例如 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>=</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">k=5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">5</span></span></span></span></span> 或 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>=</mo><mn>10</mn></mrow><annotation encoding="application/x-tex">k=10</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">10</span></span></span></span></span>，根据序列总体长度和噪声情况决定）。</li>
<li>计算前 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span> 个原始数据的平均值：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mn>0</mn></msub><mo>=</mo><mfrac><mn>1</mn><mi>k</mi></mfrac><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>k</mi></msubsup><msub><mi>a</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">b_{0} = \frac{1}{k}\sum_{i=1}^{k}a_{i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.334em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.989em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></li>
</ol>
<p>这样做的优点是能够抵消个别异常点对平滑初期的影响，使平滑曲线从一开始就更贴合数据的整体趋势。一般来说，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span> 不宜过大，否则会引入不必要的滞后；如果数据在开始阶段变化剧烈，也可适当缩小 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span>，让平滑过程更快适应当前趋势。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da406e11240c4f8ea7fe0b39fc3b3ef5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080970&amp;x-signature=d2mEb3xH99mi3fkf%2FcougtEuaKI%3D" alt="c4.jpg" loading="lazy"/></p>
<hr/>
<p>接下来，我们用Python来实际操作演示一下指数加权平均的效果。这个例子会用到NumPy和Matplotlib库，我们将一步步生成带噪声的序列，并用不同参数进行平滑处理。</p>
<p>首先，引入必要的库，并定义一个用于生成平滑随机序列的辅助类<code>SmoothRandomSequence</code></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">import</span> random

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SmoothRandomSequence</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, low, high, initial_value=<span class="hljs-literal">None</span>, max_step=<span class="hljs-literal">None</span></span>):
        self.low = low
        self.high = high
        self.range_width = high - low
        <span class="hljs-keyword">if</span> initial_value <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            self.current = random.uniform(low, high)
        <span class="hljs-keyword">else</span>:
            self.current = <span class="hljs-built_in">min</span>(high, <span class="hljs-built_in">max</span>(low, initial_value)) 
        <span class="hljs-keyword">if</span> max_step <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            self.max_step = self.range_width * <span class="hljs-number">0.1</span>  
        <span class="hljs-keyword">else</span>:
            self.max_step = max_step
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">next</span>(<span class="hljs-params">self</span>):
        step = random.uniform(-self.max_step, self.max_step)
        next_value = self.current + step
        <span class="hljs-keyword">if</span> next_value &lt; self.low:
            next_value = self.low + (self.low - next_value) 
        <span class="hljs-keyword">elif</span> next_value &gt; self.high:
            next_value = self.high - (next_value - self.high)  
        next_value = <span class="hljs-built_in">max</span>(self.low, <span class="hljs-built_in">min</span>(self.high, next_value))
        self.current = next_value
        <span class="hljs-keyword">return</span> next_value
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_sequence</span>(<span class="hljs-params">self, n</span>):
        sequence = [self.current]
        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n - <span class="hljs-number">1</span>):
            sequence.append(self.<span class="hljs-built_in">next</span>())
        <span class="hljs-keyword">return</span> sequence
</code></pre>
<p>这个<code>SmoothRandomSequence</code>类的具体实现细节不重要，你只需要知道它能生成一个在指定范围内波动、变化相对平滑的随机序列，模拟真实场景中带有噪声的数据。</p>
<p>现在，让我们使用这个类来生成一个包含300个数据点的原始序列：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 创建平滑随机数生成器实例</span>
<span class="hljs-comment"># 设置范围0到60，初始值20，最大步长3</span>
generator = SmoothRandomSequence(low=<span class="hljs-number">0</span>, high=<span class="hljs-number">60</span>, initial_value=<span class="hljs-number">20</span>, max_step=<span class="hljs-number">3</span>)

<span class="hljs-comment"># 生成300个随机数的原始序列</span>
noise_array = np.array(generator.generate_sequence(<span class="hljs-number">300</span>))

<span class="hljs-comment"># 绘图</span>
fig, ax = plt.subplots(figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">3</span>))
ax.plot(noise_array)
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92011f6bdc2349c18bc1d0e7a2a69f33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080970&amp;x-signature=Yx%2Bih1h7KXZxdalMLa9dnsMPbko%3D" alt="c6.jpg" loading="lazy"/></p>
<p>然后写一个名为<code>exponential_weighted_average</code>的函数，这个函数需要传入一个原始numpy序列，beta值和初始窗口大小<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span>就可以返回平滑后的序列，返回的序列类型也是numpy序列</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">exponential_weighted_average</span>(<span class="hljs-params">sequence, beta, initial_window=<span class="hljs-literal">None</span></span>):
    <span class="hljs-string">"""
    参数:
    sequence: numpy数组，原始序列
    beta: 平滑因子，取值范围0~1
    initial_window: 用于计算初始平均值的窗口大小

    返回:
    平滑后的序列，长度与原始序列相同
    """</span>
    n = <span class="hljs-built_in">len</span>(sequence)
    smoothed = np.zeros(n)

    <span class="hljs-comment"># 计算初始值</span>
    <span class="hljs-keyword">if</span> initial_window <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> initial_window &gt; <span class="hljs-number">0</span>:
        k = <span class="hljs-built_in">min</span>(initial_window, n)
        smoothed[<span class="hljs-number">0</span>] = np.mean(sequence[:k])
    <span class="hljs-keyword">else</span>:
        smoothed[<span class="hljs-number">0</span>] = sequence[<span class="hljs-number">0</span>]

    <span class="hljs-comment"># 迭代计算指数加权平均</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, n):
        smoothed[i] = beta * smoothed[i - <span class="hljs-number">1</span>] + (<span class="hljs-number">1</span> - beta) * sequence[i]

    <span class="hljs-keyword">return</span> smoothed
</code></pre>
<p>最后，我们使用上面定义的<code>exponential_weighted_average</code>函数，来计算并且绘制三种不同<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>β</mi></mrow><annotation encoding="application/x-tex">\beta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05278em;">β</span></span></span></span></span>下的平滑后的曲线</p>
<pre><code class="hljs language-python" lang="python">fig, ax = plt.subplots(figsize=(<span class="hljs-number">12</span>, <span class="hljs-number">3</span>))

<span class="hljs-comment"># 计算三种不同beta下的平滑结果</span>
array1 = exponential_weighted_average(noise_array,beta = <span class="hljs-number">0.95</span>,initial_window=<span class="hljs-number">4</span>)
array2 = exponential_weighted_average(noise_array,beta = <span class="hljs-number">0.9</span>,initial_window=<span class="hljs-number">4</span>)
array3 = exponential_weighted_average(noise_array,beta = <span class="hljs-number">0.8</span>,initial_window=<span class="hljs-number">4</span>)

<span class="hljs-comment"># 绘制</span>
ax.plot(noise_array)
ax.plot(array1, label=<span class="hljs-string">r"$\beta$=0.95"</span>)
ax.plot(array2, label=<span class="hljs-string">r"$\beta$=0.9"</span>)
ax.plot(array3, label=<span class="hljs-string">r"$\beta$=0.8"</span>)
ax.legend()
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4b73f0b350446cf9290896b6eee913e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080970&amp;x-signature=qOnAxiMS2uD%2Bt%2F%2FgqGy39NK0xfg%3D" alt="c7.jpg" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[慢 SQL 诊断准确率 99.99%，天翼云基于 Apache Doris MCP 的 AI 智能运维实践]]></title>    <link>https://juejin.cn/post/7586890269699653686</link>    <guid>https://juejin.cn/post/7586890269699653686</guid>    <pubDate>2025-12-23T09:28:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586890269699653686" data-draft-id="7586889698242756671" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="慢 SQL 诊断准确率 99.99%，天翼云基于 Apache Doris MCP 的 AI 智能运维实践"/> <meta itemprop="keywords" content="数据库,Apache,人工智能"/> <meta itemprop="datePublished" content="2025-12-23T09:28:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SelectDB"/> <meta itemprop="url" content="https://juejin.cn/user/3189021726222904"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            慢 SQL 诊断准确率 99.99%，天翼云基于 Apache Doris MCP 的 AI 智能运维实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3189021726222904/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SelectDB
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T09:28:00.000Z" title="Tue Dec 23 2025 09:28:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>天翼云是中国电信旗下一家科技型、平台型、服务型公司，以“云网融合、安全可信、绿色低碳、生态开放”四大优势，为客户提供公有云、私有云、专属云、混合云、边缘云全栈云服务。<strong>天翼云在 Apache Doris 上的应用规模庞大，已在生产环境中落地超 30 个项目，覆盖广泛的业务场景，展现出大规模、多类型场景并行运行的特征</strong>。</p>
<p>而在大规模集群部署的背景下，我们在运维上面临以下几项挑战：</p>
<ul>
<li><strong>故障频发，排查费时费力</strong>：集群数量庞大，场景应用复杂，故障和问题频发（日均 10+）。问题可能出现在不同层面（如硬件、网络、软件等），快速定位及解决问题需要较高技术能力和丰富经验，耗费大量人力和时间。</li>
<li><strong>运维负担重，问题发现滞后</strong>：运维人员需投入大量精力和时间分析集群的健康指标，不仅工作效率低下，且难以发现潜在问题及隐患，集群稳定性堪忧。</li>
<li><strong>监控告警过载</strong>：在管理众多的 Doris 集群时，运维团队常面临告警过载的问题，这使运维人员难以区分真实故障和误报，重要告警可能被忽视。</li>
<li><strong>版本升级风险高</strong>：不同集群可能运行着不同的版本，这使维护一致性和兼容性变得复杂。同时，升级过程的不稳定性可能导致功能失效或数据丢失，严重影响业务连续性。</li>
</ul>
<h2 data-id="heading-0">Apache Doris MCP Server</h2>
<p>在当前大规模生产环境中，运维团队在日常问题处理上资源紧张，人力长期处于捉襟见肘的状态。为应对这一挑战，团队经过持续探索，<strong>逐步明确了通过</strong> <strong>AI</strong> <strong>技术提升运维效率的方向，旨在构建智能运维体系，实现整体效率的提升</strong>。</p>
<p>2024 年下半年，Anthropic 公司发布了 MCP 协议。通过 MCP 协议，AI Agent 可以实现智能工具调用，可根据运维场景自动选择和组合多个监控、诊断、治理工具，形成完整的运维治理工作流。</p>
<p>面对 Data Agent 时代的巨大机遇，各大数据库厂商纷纷推出了自己的 MCP Server 解决方案。然而，通过深入的技术分析和实际测试，我们发现这些解决方案在功能完整性、技术先进性和企业适用性方面存在巨大差异。</p>
<p>Apache Doris MCP Server 以其卓越的技术实力和完整的功能体系，成为了 Data Agent 时代的完美答案。Apache Doris MCP Server 不仅在数量上提供了业界最丰富的 25 个专业工具，更重要的是在质量和深度上实现了全面超越。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aaa367024669425c86b611bdccdecbd0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=iQbbFIKEhmzxbRuVyWTpKzE2o8k%3D" alt="Apache Doris MCP Server.PNG" loading="lazy"/></p>
<p>Apache Doris MCP  Server 是一个基于 Python 和 FastAPI 构建的后端服务，支持客户端通过已定义的“工具”与其进行交互。该服务主要用于连接 Apache Doris 数据库，并利用大语言模型（LLM）执行多种任务，例如将自然语言查询转换为 SQL（NL2SQL）、执行查询，以及进行元数据管理与分析。</p>
<blockquote>
<p>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fapache%2Fdoris-mcp-server" target="_blank" title="https://github.com/apache/doris-mcp-server" ref="nofollow noopener noreferrer">github.com/apache/dori…</a></p>
</blockquote>
<p><strong>在天翼云智能运维体系的搭建中，主要依赖于 Apache Doris MCP 完成，尤其是在任务智能诊断及集群健康诊断这两项主要能力</strong>。接下来将对具体的实现及重难点进行详细介绍。</p>
<h2 data-id="heading-1">基于 Doris + AI 的智能运维体系</h2>
<h3 data-id="heading-2">1. 任务智能诊断</h3>
<p>任务诊断的核心在于如何有效利用人力资源，高效应对大量生产集群持续出现的问题，降低排查门槛，使更多人员甚至客户能具体问题排查及分析的能力。同时，由于客户对 Apache Doris 的使用经验有限，就需要提供工具化手段、缩短问题排查时间、提升整体运维效率。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a5dd78239f548a29532610613d96f52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=SRfl32iR2%2FyNEQzG2pc%2BMNci%2FxA%3D" alt="任务智能诊断.PNG" loading="lazy"/></p>
<p>任务诊断的第一步，是基于策略或 AI 对集群内所有任务（包括运行中和历史任务）进行综合分析，以识别出应优先处理的 Top-N 任务。之所以需要这一筛选，是因为在实际操作中难以逐一排查所有任务，因此该步骤成为保障诊断效率的必经环节。</p>
<p><strong>筛选手段包括 AI 分析和基于 MCP 工具的手段，目前阶段我们主要依赖扩展后的</strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.selectdb.com%2Fblog%2F1430" target="_blank" title="https://www.selectdb.com/blog/1430" ref="nofollow noopener noreferrer"> Apache Doris MCP 工具</a><strong>，以获取 Top-N 任务</strong>。在识别目标任务后，需要进一步获取与任务分析相关的运行时信息，包括 Profile 信息、任务信息、审计数据及相关监控指标等。根据这些信息，任务诊断分为两个层面的评估：</p>
<ul>
<li><strong>任务整体评估</strong>：对所有入选任务进行整体分析，包括运行时间、CPU 及内存资源消耗、数据扫描情况及其对集群整体的影响，并基于此生成统一的综合评估报告和优化建议。</li>
<li><strong>任务级细化分析</strong>：针对筛选出的 Top-N 任务，进行深入的单任务分析，关注其 Pipeline 运行情况和算子执行情况等更细粒度的信息。基于这些指标，系统将生成更具针对性的优化建议，帮助进一步定位性能瓶颈或运行异常。</li>
</ul>
<h4 data-id="heading-3">1.1 提升 AI 精确度</h4>
<p>虽然 AI 在很多常见场景中已取得广泛成功，但在专业性较强、知识体系复杂的领域，其表现仍显不足。尤其在直接向模型提问时，常常会生成不够准确，甚至偏差或不相关的回答。因此，<strong>提升 AI 在专业场景中的准确性成为首要挑战</strong>。为提升 AI 精确度，我们主要采取两类手段：</p>
<p><strong>A. 提示词（SOP）</strong>：</p>
<p>通过提供清晰且结构化的提示词，可以规范 AI 的分析路径。例如，</p>
<ul>
<li><strong>在提取 Top-N 任务时</strong>，为 AI 提供相应的提示词；在执行整体评估时，通过明确的提示词指引 AI 的分析思路，而非让其自由发挥。</li>
<li><strong>在任务评估时</strong>，要求 AI 针对特定维度进行分析，如运行时间、资源消耗（CPU 和内存）、数据扫描情况及其对集群的影响等。通过结构化的 SOP 限制 AI 的分析框架，使其在指定范围内输出更稳定、可靠的评估内容。</li>
<li><strong>在单任务分析时</strong>，同样采取类似方式，通过提示词引导其从 Pipeline 运行情况和算子执行等细粒度角度进行分析。</li>
</ul>
<p>如下图所示，展示了提供给 AI 的提示词结构。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f57a42f39eb4003bf6bb52ae7ab39be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=aTTWEJLBdWyusJRFAsU1%2FaL65Mk%3D" alt="任务智能诊断-1.png" loading="lazy"/></p>
<p>然而，单靠 SOP 仍不足以保障准确性，原因是未经训练的 AI 模型通常缺乏专业知识，对领域概念的理解有限，容易生成模棱两可或仅停留在通用层面的回答，这与生产环境需求存在明显差距。因此，需要为 AI 提供专业知识的载体。</p>
<p><strong>B. MCP:</strong></p>
<p>当前较为有效的方式是引入 MCP，其具有两个核心特性：专业性和集成性。</p>
<ul>
<li>专业性体现在可以针对不同领域构建相应的 MCP，提供所需的专业知识与工具能力；</li>
<li>集成性意味着 MCP 能作为能力接口，将外部工具、文档和知识库接入，为 AI 提供可调用的专业支持。通过这两个特性，MCP 有效补充了模型在专业场景中的知识缺失。</li>
</ul>
<p>在本场景中，团队主要使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.selectdb.com%2Fblog%2F1404" target="_blank" title="https://www.selectdb.com/blog/1404" ref="nofollow noopener noreferrer">Apache Doris 的 MCP</a>，并进行了大量优化，以满足实际需求。例如，增加了用于获取 Profile 的工具、提取 Task 信息的工具及分析审计记录的工具。同时，还将这些工具与自研的 Profile 可视化工具集成到 MCP 中，使其可在 MCP 体系内被调用。<strong>下图展示了 MCP 工具扩展的部分示例</strong>：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40dcd14307ff45f3bc9759b3c434a4e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=ZWYMWDTKEtLqbLH1wg72D%2FiXWJE%3D" alt="任务智能诊断-2.png" loading="lazy"/></p>
<h4 data-id="heading-4">1.2 解决超时与渲染问题</h4>
<p>在提升 AI 诊断能力精准度之后，继而发现这一过程仍存在新的挑战。<strong>由于任务本身具有较高复杂度，若将完整诊断流程以一次性方式交由 AI 执行，往往会因上下文长度过长、分析逻辑过于复杂、生成内容体量较大等因素，导致模型处理超时或中断</strong>。因此，仅依赖单轮交互难以稳定支撑完整诊断过程。</p>
<p>为解决这一问题，我们引入了“分治”的思路，<strong>将原本体量庞大、结构复杂的诊断任务拆解为多个规模更小、边界更清晰的子任务，并通过多次与 AI 交互逐步完成整个诊断流程</strong>。首先通过一定策略锚定慢查询和大导入的任务列表，然后对 TopN 的任务做一个整体的评估，最后在对单任务逐个进行分析。</p>
<p>拆分过程需遵循明确的方法，避免随意切分。核心原则是尽量降低子任务之间的关联度，以防上下文依赖过强而增加负担。<strong>分治策略还带来另一项收益——并行化处理</strong>，拆解后的任务可以进行独立诊断，彼此不存在依赖关系，因此能够并行提交多次请求，让 AI 同时处理多个分析任务。此外，列表提取、整体评估和子任务诊断等流程也可拆分为相互独立的步骤，在并行执行后显著缩短整体诊断耗时。</p>
<p>另一方面，AI 生成的诊断结果通常以大段文字呈现，阅读效率较低，不利于快速理解。<strong>因此需要进一步提升结果呈现方式的可读性与表现力</strong>。为此，利用 AI 提供的格式化输出能力，通过提示词要求模型按指定结构返回数据。通过动态渲染工具把任务表格、任务整体评估报告、单任务的报告一并连接起来，结合图表的强表现力合并成一个完整的分析报告。</p>
<p>示例展示了为 AI 定义的输出格式，用于规范 AI 生成报告的结构。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aaaefe6ba7404f34b68989d04ceac5b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=fa6E38kVxER0sGvNQ2CKd4ccESY%3D" alt="任务智能诊断-3.png" loading="lazy"/></p>
<h4 data-id="heading-5">1.3 实践案例</h4>
<p>在前述优化方案实施后，团队对任务诊断分析的实际效果进行了评估。在下方示例中，诊断了三个具体任务，随后进行整体评估，基于这一组任务生成综合报告。</p>
<ol>
<li><strong>TopN 列表</strong>：首先通过 AI 获取当前集群的慢任务列表，即 Top-N 的慢查询任务。</li>
<li><strong>整体评估</strong>：涵盖多个维度，包括任务执行时间的统计分析、资源消耗的总体情况、数据扫描情况以及任务重分布的相关信息。根据这些信息对该批任务运行状况的全局判断。</li>
<li><strong>综合报告</strong>：借助图表展示任务执行时间分布、CPU 和内存使用情况，使诊断结果更加直观易懂。整体评估中还包含总结性结论与优化建议，为后续的优化工作提供指导。</li>
<li><strong>单任务分析</strong>：进一步对单任务深入分析，包括 Top-10 耗时算子、各算子的执行时长与平均时长，以及任务执行过程中的资源消耗和扫描数据量等。这些信息共同构成了单任务级别的执行报告。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb9c797a3cc44c2fafb12e8647a15d25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=LfMo5Y1%2FWhRaxFR40sdQACElaJU%3D" alt="任务智能诊断-4.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5b6eba97ecf412f8f0ca832a3569525~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=I6d6k2Vx%2B6BqwriDmz1U0hAQmok%3D" alt="任务智能诊断-5.png" loading="lazy"/></p>
<h4 data-id="heading-6">1.4 使用收益</h4>
<p>过去如果需要对一个集群的慢 SQL 进行全面分析，即便投入一到两小时也未必能够完成。而在引入  Doris MCP Server + AI 之后，<strong>慢 SQL 的分析结果基本能够在 5 分钟内生成，执行效率提升约为 95.8%，准确率从 80% 提升至于 99.99%</strong>，这一数值同样较为保守，人工排查很多情况下准确率不足 60% ，且花费时间更长。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ace44e6515294703a5a951f9a2922a1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=dmUFMpSxq%2BRm%2BuAIg36po%2FMG9XM%3D" alt="任务智能诊断-6.png" loading="lazy"/></p>
<h3 data-id="heading-7">2. 集群健康诊断</h3>
<p>基于 AI 的智能运维体系中，另一项关键任务是集群健康诊断。这项工作旨在应对监控告警过载和问题发现滞后带来的运维负担以及业务稳定性挑战，从而提升运维效率和响应速度。</p>
<p><strong>集群健康的诊断主要分为两种</strong>：</p>
<ul>
<li><strong>被动式监控告警触发</strong>：首先将监控告警输入 AI，AI 通过分析告警和相关处理 SOP，决定对集群的哪些方面进行评估，并提供修复建议。</li>
<li><strong>主动式定期体检</strong>：定期对集群进行体检，包括任务运行情况、集群节点的 CPU/内存使用情况、表健康度以及数据压缩（compaction）等。</li>
</ul>
<p>集群诊断能力同样依赖 MCP 和 SOP，以确保诊断的准确性。在这一环节中，我们进一步扩展了多个 MCP 工具，使 AI 能够更精准地完成专业分析任务。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7a1f2fee9104346ab6029de68ff1cb6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=QbOWd1jsEP5Lqi44TEJ9OgtC5Cs%3D" alt="集群健康诊断.png" loading="lazy"/></p>
<h4 data-id="heading-8">2.1 集群智能诊断的关键</h4>
<p>如何评估 Apache Doris 中表的健康度？这一过程需要专业知识。表的健康度评估包括多个维度，如分区情况、tablet 状态、版本健康度、副本健康度及 segment 数量等。这与机器健康、存储健康和压缩的评估方法相似，都依赖特定公式将相关指标组合，计算出健康度结果。</p>
<p>以表级健康度为例，尽管流程概述简单，但其内部包含复杂的计算逻辑。</p>
<blockquote>
<p>公式如下： <strong>表健康度 = 分区健康度 * 0.05 + tablet 健康度 * 0.3 + 版本健康度 * 0.25 + 副本健康度 * 0.3 + segment 健康度 * 0.1</strong></p>
</blockquote>
<p>在评估 tablet 健康度时，我们统计表级的分桶总数和最大分桶大小，并计算标准方差，以识别潜在的数据倾斜情况。例如，某些分桶过大而另一些过小时，需要结合方差值进行判断。此外，最大分桶的大小也需关注，因为分桶过大会影响查询效率，而分桶过小则可能导致 segment 数量过多，进而影响查询性能。查询效率与典型的“漏斗模型”密切相关，过多的 segment 会加重查询负担。</p>
<p>进一步分析涉及 segment 健康度的计算逻辑。整体而言，健康度计算依赖专业知识，通过精确计算得出真实反映对象健康状况的评分，从而帮助发现潜在问题。</p>
<p>具体的计算公式可见：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba3782287c594db5bdc3447c937f7150~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=qKo2TfJo4Vr9CrxoGaBYD2DFk%2B0%3D" alt="集群健康诊断-1.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f89fb3eb3eb4e01858399f1d11b5ef1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=guCTXk7eLvQIxeZv0D0ii6MD9lY%3D" alt="集群健康诊断-2.png" loading="lazy"/></p>
<h4 data-id="heading-9">2.2 实践案例</h4>
<p>具体可见下方示例：</p>
<ul>
<li>导入任务及热点表分析：包括导入任务数量、写入文件总数、写入总行数以及写入数据的总体大小等指标。可识别哪些表被频繁导入，以及这些表的版本变化趋势。相关信息通过可视化图表进行呈现，以增强诊断结果的表达效果。</li>
<li>表级健康诊断：以表健康度为例，体现了 AI 基于这些信息生成的诊断结果，包含分区健康度、tablet 健康度、版本健康度、副本健康度以及 segment 健康度。基于上述各项指标，汇总计算出该表的整体健康度。</li>
<li>热点表及图表呈现：热点表的效果图，用于呈现热点查询等相关情况。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88975fb2ad9f47219587767905667428~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=k%2F9pYPNk9Shz%2FYGDpnCFhQEvsZ8%3D" alt="集群健康诊断-3.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df8342f0d65a499aa75b6e2345ea63df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=ZIiYroigg5kI5DSKkc9cPJwHH0U%3D" alt="集群健康诊断-4.png" loading="lazy"/></p>
<h4 data-id="heading-10">2.3 使用收益</h4>
<p>过去依赖人工进行分析。若对一个集群进行巡检并分析结果，需要检查多项指标并、逐个排查各组件和模块，整个流程需要六个小时才能完成，还需形成诊断结论。在使用 AI 之后，<strong>这一过程的整体耗时大幅缩短，完整的集群诊断基本可在 10 分钟左右完成</strong>，并能够提前发现潜在问题，无需等到故障发生后再进行处理。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc6a7dd63ae449aaba62144187f0a550~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=kbiwepCvj9lhKdqLcB3T6CVB02E%3D" alt="集群健康诊断-5.png" loading="lazy"/></p>
<h3 data-id="heading-11">版本质量保障</h3>
<p>我们建立了一套自动化质量评估体系，主要用于解决前文提到的版本数量多、发版风险高等问题，避免新版本对生产环境造成影响。该体系的主要思想就是在版本发布之后通过自动化流程把 UT、集成测试、性能测试、用户核心 case 都回归测试，再由 AI 对这些结果进行分析，输出诊断结论及相应的优化建议。</p>
<h4 data-id="heading-12">3.1 具体方案：</h4>
<ul>
<li>构建一体化的 CICD 流水线（编译、打包、部署）。</li>
<li>在 UT 和集成测试集成到 CICD 流水线中，采集数据和异常情况并持久化。</li>
<li>自动化部署到 POC 环境后跑 1T 数据规模的 TPC-H 和 TPC-DS，采集数据并持久化。</li>
<li>针对用户核心场景采用一定调度策略（串行、并行）在 POC 上做回归测试，采集测试的结果数据并持久化。</li>
<li>通过 AI 的能力，智能分析所有数据并输出分析报告。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c14b09a15234bc587373fa14ddd173b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=KEO3BcgAJ6lf3JWWyKO6CmYgsc4%3D" alt="版本质量保障.png" loading="lazy"/></p>
<blockquote>
<p>需要说明的是，真实业务场景通常较为复杂，可能同时涉及数据导入、查询，以及查询之间的串行或并行运行模式。在不同场景下，某些查询组合在并行状态下可能会出现问题，而这些组合关系本身具有一定讲究。因此，未来可以通过引入更多策略，让 AI 根据用户用例自动完成任务调度设计，例如根据已有用户用例自动规划任务组合，以便更有效地暴露潜在问题。</p>
</blockquote>
<p>质量报告的示例中包含多类测试的结论。例如，UT 测试结论以及与历史版本之间的对比结果都会在报告中呈现，测试的结论、性能测试的结果以及相关的测试图表。通过这些测试数据，AI 会生成关于整体质量状况的分析及优化建议。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37c12af8604e4799a95e8bbde769c7ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=WvSVJE6FhUSfNNR8Q1xMRgDVljM%3D" alt="版本质量保障-1.png" loading="lazy"/></p>
<h4 data-id="heading-13">3.2 使用收益</h4>
<p><strong>在版本质量方面</strong>，以前发布新版本时，需执行单元测试、部署至 POC 环境并进行测试等多个步骤，这些流程都需要投入大量人力和时间。此外，测试结果的分析同样需要手工完成，整体资源消耗较大。</p>
<p>在自动化体系建立后，这些流程均可由系统自动执行。尽管完整流程大约需要 5 个小时，但在<strong>此期间几乎不需要人工干预，只需一键触发等待结果</strong>。5 个小时主要是在单元测试、数据导入以及与 POC 环境的集成。如果环境资源充足，编译和单元测试执行速度更快，整体耗时有望进一步降低。</p>
<p><strong>在质量保障方面</strong>，过去的代码合并和 BUG 发现主要依赖人工，可控性较低。引入 AI 后，这些过程得以统一处理，<strong>质量评估准确率可达 80%</strong>。如果用户用例模型更加完善，测试场景更丰富，并允许 AI 自主组合用例进行测试，则潜在问题更可能提前暴露，进一步提升质量保障能力。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/146b3526c6904744923286fd40f681a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=uoZL4gnf%2FWF7%2FfnydmWs0xzCNsE%3D" alt="版本质量保障-2.png" loading="lazy"/></p>
<h2 data-id="heading-14">未来规划</h2>
<p>当前，基于 AI 的智能运维主要落地在上述三个场景中，未来我们还将进一步推广至更丰富场景中。不仅如此，未来在能力的扩展下，我们还将进行以下工作：</p>
<ul>
<li>智能运维：持续完善和优化智能运维的工具，并通过优化 MCP 和 Doris 内核来提升 AI 诊断的准确率和性能问题。</li>
<li>智能咨询：通过 AI 的能力+专业知识库向用户提供专业的咨询能力。</li>
<li>内核优化：持续完善和优化 Doris 内核的功能和性能。</li>
<li>存算分离：推出 3.x 的版本来解决用户对存算分离的需求包括多 AZ 的容灾、数据共享、湖仓一体等。
长按下方二维码，回复「<strong>1218</strong>」加入 Doris 社区交流群，并<strong>免费领取 Doris x Al 和100+ 企业实践案例集</strong>，获取技术帮助、了解最新动态，并与更多开发者和用户互动。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fdc045240464e04abb85054a60d90c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=Vpcw0G%2BQS%2BHIqfxMUSbqsAJQYZI%3D" alt="Doris 小助手二维码" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[当中断绑核遇上大模型推理：HostBound 问题优化全解析（昇腾深度实战版）]]></title>    <link>https://juejin.cn/post/7586610067569229824</link>    <guid>https://juejin.cn/post/7586610067569229824</guid>    <pubDate>2025-12-23T08:43:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586610067569229824" data-draft-id="7586687526867140623" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="当中断绑核遇上大模型推理：HostBound 问题优化全解析（昇腾深度实战版）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-23T08:43:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="扑克中的黑桃A"/> <meta itemprop="url" content="https://juejin.cn/user/1106580348609019"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            当中断绑核遇上大模型推理：HostBound 问题优化全解析（昇腾深度实战版）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1106580348609019/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    扑克中的黑桃A
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T08:43:19.000Z" title="Tue Dec 23 2025 08:43:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a83cd56a850c426eaa9c2018996799d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5omR5YWL5Lit55qE6buR5qGDQQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084199&amp;x-signature=XelnrMD3oZ1ryI7t5taPZ0SU9ig%3D" alt="" loading="lazy"/></p>
<hr/>
<p>在大模型推理性能调优的过程中，我们经常会遇到一个令人头疼的现象——<strong>HostBound</strong>。CPU 明明没有满载，但推理速度就是慢，Profiling 一看，全是“空泡”。 调试分析之后有点发现，最终我发现问题是在一个经常被忽略的角落：<strong>IRQ</strong>** 中断机制与中断绑核**。</p>
<p>因此本文结合<strong>昇腾平台</strong>的实际测试，从 IRQ 工作机制、irqbalance 调度策略，到如何通过绑核优化推理性能，完整还原这次 HostBound 问题的排查与优化过程。</p>
<hr/>
<h2 data-id="heading-0">一、背景：从 HostBound 说起</h2>
<p>在大模型推理时，Host 侧算子进入下发队列后，会依次触发两个关键中断事件：</p>
<ul>
<li><code>sq_send_trigger_irq</code>：算子下发触发；</li>
<li><code>cq_update_irq</code>：算子执行完成后上报。</li>
</ul>
<p>这两个中断的发生 CPU 核通常是固定的。 而如果此时业务线程恰好也绑定在相同的 CPU 核上，就会出现频繁的任务打断，导致 CPU 空泡显著增加，形成典型的 <strong>HostBound 问题</strong>。</p>
<p>在默认情况下，如果系统安装并启用了 <code>irqbalance</code> 服务，它会定期（默认 10 秒）重新分配中断，使中断均衡分布在多个 CPU 上。 但对于推理这种极端计算密集型场景，这种“自动平衡”反而可能带来性能抖动甚至劣化。</p>
<hr/>
<h3 data-id="heading-1">为什么在昇腾平台上 HostBound 更明显？</h3>
<p>与 GPU 不同，昇腾 NPU 采用 <strong>Host/NPU 协同执行架构</strong>。在整个模型推理过程中，CPU 承担了以下关键角色：</p>
<ol>
<li><strong>算子编排、调度与 TaskGen（<strong><strong>CANN</strong></strong> Runtime）</strong></li>
<li><strong>向 AscendCL/DevDrv 下发任务，触发 sq_send_trigger_irq</strong></li>
<li><strong>等待 <strong><strong>NPU</strong></strong> 完成 cq_update_irq <strong><strong>回调</strong></strong>，用于同步下一步调度</strong></li>
<li><strong>部分算子的 Host 侧逻辑，如 shape 计算、LayerNorm 前置操作等</strong></li>
</ol>
<p>昇腾框架（CANN + torch-npu）比 GPU 更依赖 CPU 的调度链路，因此 CPU 不仅需要供能（Host Control），还承担巨量 Host 侧同步逻辑。</p>
<p><strong>NPU</strong>** 每执行一次算子 → 至少两次 <strong><strong>IRQ</strong></strong>：**</p>
<ul>
<li><code>sq_send_trigger_irq</code>（下发）</li>
<li><code>cq_update_irq</code>（完成）</li>
</ul>
<p>而大模型推理 <strong>每生成一个 token 会触发数百到上千个算子调度</strong>，即会产生成千上万次中断。</p>
<p>因此，昇腾平台比 GPU 更容易出现一个现象：</p>
<p><strong>CPU 被高频中断打断，导致 HostBound，即使 CPU 利用率不高，也会出现严重空泡。</strong></p>
<hr/>
<h2 data-id="heading-2">二、了解 IRQ 与 irqbalance 的机制</h2>
<h3 data-id="heading-3">1. 什么是硬件中断？</h3>
<p>**中断（Interrupt）**是一种“打断当前程序执行”的机制。 当外设（如 NPU、网卡、定时器）有事件发生时，会通知 CPU 中断当前任务，执行一段专门的“中断服务程序（ISR）”。 这样可以保证 CPU 能及时响应设备请求，而不是傻等。</p>
<p>举个例子，当 NPU 执行完算子后，需要告诉 CPU “我完成了”，这个信号就是一次中断。 如果中断太频繁，CPU 就会被不断“打断”，算子调度效率明显下降。</p>
<hr/>
<h3 data-id="heading-4">2. 中断的注册与维护</h3>
<p>设备驱动加载时会通过 <code>request_irq()</code> 注册中断，系统会分配一个 IRQ ID。 所有中断状态都可以在 <code>/proc/interrupts</code> 中查看，例如：</p>






























































































































<table><thead><tr><th><strong>IRQ</strong>** ID**</th><th><strong>CPU0</strong></th><th><strong>CPU1</strong></th><th><strong>CPU2</strong></th><th><strong>CPU3</strong></th><th><strong>控制器类型</strong></th><th><strong>硬件中断号</strong></th><th><strong>触发方式</strong></th><th><strong>中断源</strong>**/设备**</th></tr></thead><tbody><tr><td>8</td><td>0</td><td>0</td><td>0</td><td>0</td><td>GICv3</td><td>22</td><td>Level</td><td>vgic</td></tr><tr><td>9</td><td>0</td><td>12</td><td>0</td><td>0</td><td>GICv3</td><td>28</td><td>Level</td><td>kvm guest ptimer</td></tr><tr><td>10</td><td>45</td><td>0</td><td>0</td><td>0</td><td>GICv3</td><td>29</td><td>Level</td><td>kvm guest vtimer</td></tr><tr><td>11</td><td>256</td><td>0</td><td>0</td><td>432</td><td>GICv3</td><td>30</td><td>Level</td><td>arch_timer</td></tr><tr><td>12</td><td>0</td><td>0</td><td>0</td><td>0</td><td>GICv3</td><td>140</td><td>Edge</td><td>uart-pl011</td></tr><tr><td>15</td><td>0</td><td>0</td><td>0</td><td>0</td><td>GICv3</td><td>490</td><td>Level</td><td>HISI0173:00</td></tr><tr><td>16</td><td>0</td><td>0</td><td>0</td><td>0</td><td>GICv3</td><td>482</td><td>Level</td><td>HISI02A2:00</td></tr><tr><td>17</td><td>0</td><td>0</td><td>0</td><td>0</td><td>GICv3</td><td>25</td><td>Level</td><td>arm-pmu</td></tr><tr><td>19</td><td>0</td><td>0</td><td>0</td><td>0</td><td>ITS-MSI</td><td>0</td><td>Edge</td><td>PCIe PME</td></tr><tr><td>20</td><td>0</td><td>0</td><td>0</td><td>0</td><td>ITS-MSI</td><td>1</td><td>Edge</td><td>aerdrv</td></tr></tbody></table>
<p>从上表我们可以看出系统中不同中断事件的触发情况：</p>
<ul>
<li><strong>IRQ</strong>** ID（中断号）**：表示系统为每个硬件设备或虚拟设备分配的中断标识符。</li>
<li><strong>CPU0-CPU3 列</strong>：表示各个 CPU 核上处理该中断的次数。 例如，<code>arch_timer</code> 中断在 CPU0 上触发了 256 次、CPU3 上触发了 432 次，而其他核几乎没有触发。</li>
<li><strong>控制器类型（<strong><strong>Controller</strong></strong> Type）</strong>：例如 <code>GICv3</code> 或 <code>ITS-MSI</code>，代表不同类型的中断控制器（前者常见于 ARM 架构，后者用于 PCIe 设备等）。</li>
<li><strong>触发方式（Trigger Type）</strong>：<code>Level</code> 表示电平触发，<code>Edge</code> 表示边沿触发。不同触发方式对应不同的中断响应机制。</li>
<li><strong>中断源</strong>**/设备（<strong><strong>Source</strong></strong>）**：表示是谁产生了中断，比如定时器、串口、PCIe 设备等。</li>
</ul>
<p>在实际大模型推理环境中，你可以通过 <code>cat /proc/interrupts</code> 实时观察到某些中断（例如 <code>sq_send_trigger_irq</code>、<code>cq_update_irq</code>）在某几个 CPU 上触发频率极高。 这通常说明这些中断源被固定绑定在特定 CPU 核上，如果你的推理线程也恰好绑定在同一核，就会造成频繁的中断抢占，进而引起 <strong>HostBound 性能瓶颈</strong>。</p>
<p>因此，在性能优化时，理解并分析这张表非常关键。 它能帮助你判断是否存在“中断集中于少数 CPU 核”的情况，为后续的绑核优化提供数据依据。</p>
<hr/>
<h3 data-id="heading-5">3. irqbalance 的执行逻辑</h3>
<p><code>irqbalance</code> 是 Linux 系统中一个非常重要的后台服务，它的主要职责是——<strong>在多核 CPU 系统中自动平衡中断的分布</strong>，防止某个 CPU 因为频繁处理中断而成为瓶颈。</p>
<p>我们可以这样理解： 如果把每次中断看成“系统电话”，那么 <code>irqbalance</code> 就像一个总机调度员，负责把电话均匀分配给不同的“接线员”（CPU 核心），避免某一个人被电话打爆，而其他人却闲着。</p>
<hr/>
<h4 data-id="heading-6">（1）irqbalance 的工作方式</h4>
<p>irqbalance 每隔一段时间（默认 10 秒）会自动执行以下几个步骤：</p>
<ol>
<li><strong>读取中断分布信息</strong> 它会扫描 <code>/proc/interrupts</code> 文件，统计每个中断号（IRQ ID）在各个 CPU 核上的触发次数。 比如发现 IRQ 1021 在 CPU10 上触发了 10 万次，而其他核几乎为 0，这说明中断分布不均。</li>
<li><strong>分析负载与 NUMA 拓扑</strong> irqbalance 并不会“盲目均衡”，它会考虑 NUMA 拓扑结构，尽量让中断分配在<strong>距离设备最近的 CPU 节点</strong>上。 这样可以减少跨 NUMA 节点访问内存的延迟，兼顾“负载平衡”和“访问效率”。</li>
<li><strong>重新分配中断绑定关系</strong> 通过修改 <code>/proc/irq/&lt;IRQ_ID&gt;/smp_affinity</code> 文件中的掩码值，实现把某个中断“绑”到其他 CPU 核上。 例如，如果 smp_affinity 的值是 <code>0x400</code>，表示该中断仅绑定在 CPU10（第 10 个核）上。</li>
<li><strong>周期性重复评估</strong> irqbalance 会不断循环以上步骤——分析 → 决策 → 调整，从而保持系统的中断分布动态平衡。</li>
</ol>
<hr/>
<h4 data-id="heading-7">（2）irqbalance 的策略特点</h4>
<ul>
<li>它关注的是<strong>中断负载均衡</strong>，而非 CPU 使用率。 即使某个 CPU 正在执行高负载任务，只要它的中断次数较少，irqbalance 仍可能把新的中断分配过去。</li>
<li>对于部分“高频设备”或特殊场景（如 NPU、NVMe SSD），这种自动均衡反而可能带来性能抖动。 因为中断被频繁迁移，会导致 CPU Cache 失效、NUMA 远程访问增加，甚至打断关键计算线程。</li>
<li>irqbalance 的评估周期可调节，通过修改服务参数可实现更细粒度的控制，例如：</li>
</ul>
<pre><code class="hljs language-plain" lang="plain">systemctl edit irqbalance
</code></pre>
<pre><code class="hljs language-plain" lang="plain">[Service]
ExecStart=
ExecStart=/usr/sbin/irqbalance --interval=300
</code></pre>
<ul>
<li>这段配置把默认 10 秒的检测周期改成了 300 秒，从而让中断分配更稳定。</li>
</ul>
<hr/>
<h4 data-id="heading-8">（3）irqbalance 的两种典型用法</h4>
<ul>
<li><strong>通用场景</strong>：默认开启 irqbalance，让它自动维护系统中断均衡，适合普通服务器或多任务场景。</li>
<li><strong>性能敏感场景（如大模型推理）</strong>：手动调整 irqbalance 的策略，或者直接关闭自动调度，通过 <code>--banirq</code> 参数屏蔽关键中断，让开发者自行绑定中断与 CPU 核，实现更可控的性能调优。</li>
</ul>
<hr/>
<p><code>irqbalance</code> 的本意是“让中断更公平”，但在性能调优的世界里，“公平”并不总是“高效”。 理解它的调度逻辑，有助于我们在特定场景下做出更合理的决策。 <strong>什么时候让它自动跑，什么时候让它安静下来。</strong></p>
<h4 data-id="heading-9">（4）查看 /proc/interrupts</h4>
<p>实时监控 IRQ 的命令</p>
<pre><code class="hljs language-plain" lang="plain">watch -n 1 cat /proc/interrupts
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f50f02142ab54911b83b0bd161fa7dba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5omR5YWL5Lit55qE6buR5qGDQQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084199&amp;x-signature=4FpVMvV6koOrtyKYbjsAK4vKEK4%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-10">三、大模型推理中的中断问题</h2>
<p>在大模型推理或训练场景中，NPU 与 CPU 间通信极为频繁。 当中断发生在业务线程所在的 CPU 核上时，推理过程会被频繁打断。Profiling 结果通常表现为：</p>
<ul>
<li><strong>Node@launch 时间增加</strong></li>
<li><strong>CPU 空泡率上升</strong></li>
<li><strong>decode 阶段耗时增长明显</strong></li>
</ul>
<p>如果统计 <code>/proc/interrupts</code>，你甚至会看到“一秒内发生两万次中断”的惊人现象。</p>
<h4 data-id="heading-11">中断频率统计代码</h4>
<pre><code class="hljs language-plain" lang="plain">import time

def read_irq(irq_id):
    with open("/proc/interrupts", "r") as f:
        for line in f:
            if line.strip().startswith(str(irq_id)):
                return list(map(int, line.split()[1:5]))  # CPU0~CPU3
    return None

irq_id = 1014   # 这里填你的 sq_send_trigger_irq
interval = 0.5

prev = read_irq(irq_id)
print(f"监控 IRQ {irq_id} 触发频率... Ctrl+C 退出")

while True:
    time.sleep(interval)
    curr = read_irq(irq_id)
    diff = [c - p for c, p in zip(curr, prev)]
    print(f"{diff} 次 / {interval}s")
    prev = curr
</code></pre>
<p>示例运行效果如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a787aa40f126446598a9a35f9eb07bad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5omR5YWL5Lit55qE6buR5qGDQQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084199&amp;x-signature=blaKMQg4QArfOhEnRZhLud0WxvU%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-12">四、实验验证：中断绑核前后对比</h2>
<p>为了验证中断分布对大模型推理性能的影响，本文在 <strong>昇腾 800I（A2-A+K 架构，8 卡 * 64GB）平台</strong> 上做了一个对比实验，目标是：</p>
<p><strong>通过中断绑核，观察 HostBound 现象是否得到改善。</strong></p>
<hr/>
<h3 data-id="heading-13">1. 实验环境配置</h3>













































<table><thead><tr><th>组件</th><th>版本/说明</th></tr></thead><tbody><tr><td><strong>服务器硬件</strong></td><td>Ascend 800I（A2-A+K）</td></tr><tr><td><strong>操作系统</strong></td><td>openEuler 22.03 LTS</td></tr><tr><td><strong>驱动版本</strong></td><td>25.0.rc1.1（昇腾 DevDrv 驱动）</td></tr><tr><td><strong>CANN（Compute Architecture for Neural Networks）</strong></td><td>8.2.RC1（昇腾算子库与运行时框架）</td></tr><tr><td><strong>PyTorch</strong></td><td>2.1.0</td></tr><tr><td><strong>torch-npu</strong></td><td>2.1.0.post13.dev20250722（昇腾后端模块，实现 PyTorch→NPU 映射）</td></tr><tr><td><strong>MindIE</strong></td><td>2.1.RC1-800I-A2-py311-openeuler24.03-lts（昇腾推理引擎）</td></tr><tr><td><strong>模型</strong></td><td>Qwen2.5-7B</td></tr><tr><td><strong>Python</strong></td><td>3.11.10</td></tr></tbody></table>
<h3 data-id="heading-14">2. 确定中断分布与 NPU 对应关系</h3>
<p>首先，我们要找到每个 NPU 对应的中断号（IRQ ID）。 通过以下命令查看系统中各 NPU 注册的起始中断号：</p>
<pre><code class="hljs language-plain" lang="plain">cat /proc/interrupts | grep devdrv_load_irq | cut -d: -f1
</code></pre>
<p>输出：</p>
<p>1014 1271 1529 1785 2041 2297 2553 2809</p>
<p>这些数字代表了每个 NPU 模块注册的中断起始编号。</p>
<p>接着，通过 <code>npu-smi info</code> 命令可查看设备的 Bus ID 与注册顺序：</p>
<pre><code class="hljs language-plain" lang="plain">npu-smi info
</code></pre>
<p>输出结果中，每个 NPU 的 Bus ID 和注册顺序可以一一对应，例如：</p>


















































<table><thead><tr><th><strong>NPU ID</strong></th><th><strong>Bus ID</strong></th><th><strong>驱动注册顺序</strong></th></tr></thead><tbody><tr><td>4</td><td>0000:01:00.0</td><td>第 1 个注册</td></tr><tr><td>5</td><td>0000:02:00.0</td><td>第 2 个注册</td></tr><tr><td>6</td><td>0000:41:00.0</td><td>第 3 个注册</td></tr><tr><td>7</td><td>0000:42:00.0</td><td>第 4 个注册</td></tr><tr><td>2</td><td>0000:81:00.0</td><td>第 5 个注册</td></tr><tr><td>3</td><td>0000:82:00.0</td><td>第 6 个注册</td></tr><tr><td>0</td><td>0000:C1:00.0</td><td>第 7 个注册</td></tr><tr><td>1</td><td>0000:C2:00.0</td><td>第 8 个注册</td></tr></tbody></table>
<p>通过对比可以推测，<strong>中断号 1014~1271 属于 NPU0</strong>，以此类推。</p>
<hr/>
<h3 data-id="heading-15">3. 查看目标中断的分布情况</h3>
<p>例如，我们关心某个 NPU 对应的 <code>sq_send_trigger_irq</code> 与 <code>cq_update_irq</code> 中断，可在 <code>/proc/interrupts</code> 中查看这些中断的分布：</p>
<pre><code class="hljs language-plain" lang="plain">grep -E "sq_send_trigger_irq|cq_update_irq" /proc/interrupts
</code></pre>
<p>输出结果如下表：</p>






































<table><thead><tr><th><strong>IRQ ID</strong></th><th><strong>CPU6</strong></th><th><strong>CPU7</strong></th><th><strong>CPU8</strong></th><th><strong>CPU9</strong></th><th><strong>CPU10</strong></th><th><strong>控制器</strong></th><th><strong>触发方式</strong></th><th><strong>中断源</strong></th></tr></thead><tbody><tr><td>1032</td><td>2652</td><td>1426098</td><td>0</td><td>0</td><td>195</td><td>ITS-MSI</td><td>Edge</td><td>sq_send_trigger_irq</td></tr><tr><td>1033</td><td>0</td><td>0</td><td>0</td><td>889344</td><td>0</td><td>ITS-MSI</td><td>Edge</td><td>cq_update_irq</td></tr></tbody></table>
<p>从结果中可以看到，这些中断集中在 CPU7 和 CPU9 上触发非常频繁，这意味着这两个核心在推理过程中被大量中断打断。</p>
<hr/>
<h3 data-id="heading-16">4. 中断绑核方法</h3>
<p>为了减少中断对推理任务的影响，我们将频繁触发的中断绑定到不执行推理线程的 CPU 核上。 操作方法如下：</p>
<ol>
<li><strong>关闭 irqbalance 服务</strong>（防止它自动重新分配中断）：</li>
</ol>
<pre><code class="hljs language-plain" lang="plain">systemctl stop irqbalance
</code></pre>
<ol>
<li><strong>修改中断的 smp_affinity 值</strong>：</li>
<li>例如，将 IRQ 1032 绑定到 CPU10：</li>
</ol>
<pre><code class="hljs language-plain" lang="plain">echo 0x400 &gt; /proc/irq/1032/smp_affinity
</code></pre>
<ol>
<li>（<code>0x400</code> 表示第 10 个 CPU 核）</li>
<li><strong>设置算子执行绑核</strong>（指定 NPU 对应的 CPU 核）：</li>
</ol>
<pre><code class="hljs language-plain" lang="plain">export CPU_AFFINITY_CONF=1,npu2:10,npu3:11
</code></pre>
<ol>
<li>这样，NPU2 的算子绑定在 CPU10，而其中断（如 sq_send_trigger_irq）则绑定在其他 CPU 上，确保两者分离。</li>
</ol>
<hr/>
<h3 data-id="heading-17">5. 实验过程与测试脚本</h3>
<p>为了观察中断频率，我们编写了一个简单脚本模拟高频推理请求：</p>
<pre><code class="hljs language-plain" lang="plain">#!/bin/bash
LOOPS=100000
IRQ_ID="1032"

echo "开始高频推理测试，共 $LOOPS 次请求..."
for ((i=1; i&lt;=LOOPS; i++))
do
  curl -s -X POST -d '{"model": "qwen2.5_7B", "messages": [{"role": "user","content": "请介绍一下QwQ？"}], "max_tokens": 32768, "stream": false}' http://127.0.0.1:3125/v1/chat/completions &gt; /dev/null

  if (( $i % 100 == 0 )); then
    echo "已完成 $i 次请求，中断分布如下："
    grep -E "^$IRQ_ID:" /proc/interrupts
    echo "-----------------------------"
  fi
done
</code></pre>
<p>通过该脚本，我们可以实时观察中断在各个 CPU 上的触发次数随推理进程变化的趋势。</p>
<hr/>
<h3 data-id="heading-18">6. 实验结果对比</h3>
<h4 data-id="heading-19">场景一：算子与中断分离（未在同核）</h4>
<ul>
<li>中断绑定在与算子执行线程不同的 CPU 核。</li>
<li>Profiling 结果显示：
<ul>
<li><strong>Node@launch 时间稳定</strong>；</li>
<li><strong>CPU 空泡较少</strong>；</li>
<li><strong>推理耗时正常</strong>。</li>
</ul>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e94269869c1d4dde9ee4df3ee9801a90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5omR5YWL5Lit55qE6buR5qGDQQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084199&amp;x-signature=g5ghvpTQQHh4wfMZP%2FnwVDXmjzU%3D" alt="" loading="lazy"/></p>
<p>正常情况下的 Profiling</p>
<h4 data-id="heading-20">场景二：算子与中断共用同一 CPU 核（在同核）</h4>
<ul>
<li>将中断和算子线程同时绑定在 CPU10 上。</li>
<li>Profiling 结果显示：
<ul>
<li><strong>Node@launch 时间略有延长</strong>；</li>
<li><strong>CPU 空泡显著增多</strong>；</li>
<li><strong>decode 阶段耗时变长</strong>；</li>
<li>单秒中断次数高达 2 万次以上。</li>
</ul>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a1c154074164d2890a6b69da0cd15e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5omR5YWL5Lit55qE6buR5qGDQQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084199&amp;x-signature=CszUkK7fupSZky%2B8zsqihBnpbcw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ccaa245325d0422fa5b985db297bcca3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5omR5YWL5Lit55qE6buR5qGDQQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084199&amp;x-signature=x%2FpX%2FBfldIyL4kJHrZMRI4KYG5g%3D" alt="" loading="lazy"/></p>
<p>中断过多时的 Profiling 截图</p>
<p>这说明：当中断和业务线程争抢同一个核心时，即便中断处理只需微秒级时间，也会造成频繁的任务中断和缓存失效，从而让整体推理时间变长。</p>
<hr/>
<h3 data-id="heading-21">7. 结果分析与结论</h3>
<p>通过对比我们可以得出：</p>
<ul>
<li>中断频率高并非主要问题，<strong>关键在于中断与计算任务是否抢占同一 CPU</strong>；</li>
<li>合理的绑核策略（让算子与中断分离）能有效减少 CPU 抢占和 cache 抖动；</li>
<li>禁用 irqbalance 或配置 <code>--banirq</code> 参数，可防止系统在高负载下频繁调整中断分布。</li>
</ul>
<p>最终结论：</p>
<p><strong>中断绑核是一种低成本、高收益的性能优化手段，尤其在大模型推理场景中，可显著缓解 HostBound 问题。</strong></p>
<hr/>
<h2 data-id="heading-22">五、经验建议</h2>
<ol>
<li><strong>识别关键中断源</strong>：重点关注 <code>sq_send_trigger_irq</code> 与 <code>cq_update_irq</code> 等高频 NPU 中断。</li>
<li><strong>业务与中断分核执行</strong>：确保业务线程与频繁中断不在同一 CPU 核。</li>
<li><strong>NUMA 一致性优先</strong>：绑核时尽量保持任务与中断在同一 NUMA 节点内，减少跨节点访问延迟。</li>
<li><strong>irqbalance 可调节而非一刀切</strong>：
<ol>
<li>可通过 <code>--banirq</code> 精准屏蔽特定中断；</li>
<li>或延长评估周期，让其更“稳定”地运行。</li>
</ol>
</li>
</ol>
<hr/>
<h2 data-id="heading-23">六、结语</h2>
<p>这次 HostBound 调优让可以让我们认识到： <strong>中断并非只是底层系统事件，它对高性能计算任务的干扰可能远超想象。</strong></p>
<p>对于大模型推理、训练这类 CPU 与 NPU 高度耦合的场景，理解并合理利用中断绑核，是性能优化中不可忽视的一环。</p>
<p>当性能陷入瓶颈时，不妨看一眼 <code>/proc/interrupts</code> —— 也许真正打断你的，不是程序本身，而是那些“悄无声息的中断”。</p>
<p>注明：昇腾PAE案例库对本文写作亦有帮助。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[实战复盘：我为什么把 TypeScript 写的 CLI 工具用 Rust 重写了一遍？]]></title>    <link>https://juejin.cn/post/7586879894207889471</link>    <guid>https://juejin.cn/post/7586879894207889471</guid>    <pubDate>2025-12-23T09:10:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586879894207889471" data-draft-id="7586879894207856703" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="实战复盘：我为什么把 TypeScript 写的 CLI 工具用 Rust 重写了一遍？"/> <meta itemprop="keywords" content="前端,后端,Rust"/> <meta itemprop="datePublished" content="2025-12-23T09:10:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="七月丶"/> <meta itemprop="url" content="https://juejin.cn/user/3685218705751325"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            实战复盘：我为什么把 TypeScript 写的 CLI 工具用 Rust 重写了一遍？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3685218705751325/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    七月丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T09:10:24.000Z" title="Tue Dec 23 2025 09:10:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>仓库地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnianyi778%2Fgix-cli" target="_blank" title="https://github.com/nianyi778/gix-cli" ref="nofollow noopener noreferrer">github.com/nianyi778/g…</a></p>
</blockquote>
<h2 data-id="heading-0">前言</h2>
<p>作为一个开发者，我们每天都在和 Git 打交道。为了简化一些繁琐的 Git 流程（比如合并多个 commit、交互式 rebase、清理工作区），我之前用 TypeScript 写了一个名为 <strong>gix</strong> 的 CLI 工具。</p>
<p>它工作得很好，但随着时间的推移，我开始思考：<strong>是不是可以用 Rust 重写它？</strong></p>
<p>这不仅仅是为了蹭 "Rewrite it in Rust" 的热度，更是为了解决 Node.js CLI 工具的一些原生痛点，同时探索 Rust 在命令行工具开发领域的强大能力。</p>
<p>今天就来复盘一下，我是如何将 <code>gix</code> 从 TypeScript 迁移到 Rust，以及在这个过程中踩过的坑和收获的经验。</p>
<h2 data-id="heading-1">为什么要重写？</h2>
<p>TypeScript 版本虽然开发效率高，但作为 CLI 工具，它有几个无法忽视的短板：</p>
<ol>
<li><strong>环境依赖</strong>：用户必须安装 Node.js 才能运行。这对于非前端开发者来说是一个额外的负担。</li>
<li><strong>分发困难</strong>：虽然可以通过 npm 安装，但生成的 <code>node_modules</code> 体积庞大。</li>
<li><strong>启动速度</strong>：Node.js 的运行时启动虽然不慢，但相比于 Rust 编译后的原生二进制，还是有肉眼可见的差距。</li>
</ol>
<p>而 Rust 完美解决了这些问题：</p>
<ul>
<li><strong>零依赖</strong>：编译成单个二进制文件，扔到哪里都能跑。</li>
<li><strong>高性能</strong>：启动瞬间完成，内存占用极低。</li>
<li><strong>类型安全</strong>：比 TypeScript 更严格的类型系统，在编译阶段就能拦截绝大多数错误。</li>
</ul>
<h2 data-id="heading-2">技术栈对比</h2>
<p>在重写过程中，我寻找了 TypeScript 生态中对应库的 Rust 替代品，发现 Rust 的 CLI 生态简直太丰富了：</p>



































<table><thead><tr><th align="left">功能</th><th align="left">TypeScript 方案</th><th align="left">Rust 方案</th><th align="left">体验对比</th></tr></thead><tbody><tr><td align="left"><strong>CLI 框架</strong></td><td align="left"><code>commander</code></td><td align="left"><strong><code>clap</code></strong></td><td align="left"><code>clap</code> 的 Derive 宏简直是魔法，直接通过结构体定义参数，自动生成帮助文档。</td></tr><tr><td align="left"><strong>交互式提示</strong></td><td align="left"><code>inquirer</code></td><td align="left"><strong><code>inquire</code></strong></td><td align="left">类型更安全，API 设计非常直观。</td></tr><tr><td align="left"><strong>终端颜色</strong></td><td align="left"><code>chalk</code></td><td align="left"><strong><code>colored</code></strong></td><td align="left">用法几乎一致，简单易用。</td></tr><tr><td align="left"><strong>Git 执行</strong></td><td align="left"><code>child_process</code></td><td align="left"><strong><code>std::process::Command</code></strong></td><td align="left">Rust 的标准库对进程控制提供了更细粒度的支持。</td></tr></tbody></table>
<h2 data-id="heading-3">核心架构设计</h2>
<h3 data-id="heading-4">1. Monorepo 结构</h3>
<p>为了平滑过渡，我采用了 Monorepo 结构，同时保留了 <code>typescript</code> 和 <code>rust</code> 两个目录。这样老用户可以继续使用 npm 版本，新用户可以尝试 Rust 版本。</p>
<pre><code class="hljs language-text" lang="text">.
├── rust/           # Rust 实现 (新)
│   ├── src/
│   │   ├── commands/   # 独立的命令模块
│   │   └── main.rs     # 入口分发
│   └── Cargo.toml
├── typescript/     # TypeScript 实现 (旧)
└── .github/        # CI/CD 工作流
</code></pre>
<h3 data-id="heading-5">2. 命令模式 (Command Pattern)</h3>
<p>在 Rust 版本中，我利用 <code>clap</code> 的子命令功能，将每个功能（merge, rebase, doctor 等）封装成独立的模块。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// main.rs</span>
<span class="hljs-meta">#[derive(Subcommand)]</span>
<span class="hljs-keyword">enum</span> <span class="hljs-title class_">Commands</span> {
    <span class="hljs-comment">/// Merge multiple git commits</span>
    <span class="hljs-title function_ invoke__">Merge</span>(merge::MergeArgs),
    <span class="hljs-comment">/// Rebase current branch onto upstream</span>
    <span class="hljs-title function_ invoke__">Rebase</span>(rebase::RebaseArgs),
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>每个命令模块都遵循统一的接口：定义参数结构体 -&gt; 实现 <code>execute</code> 函数。这种结构非常清晰，添加新命令只需“填空”即可。</p>
<h2 data-id="heading-6">踩坑与亮点</h2>
<h3 data-id="heading-7">1. 交互式 Git 命令的“黑魔法”</h3>
<p>在 CLI 中执行 <code>git rebase -i</code> 或 <code>git commit</code> 时，Git 可能会唤起编辑器（如 Vim）。在 Node.js 中处理这个需要一些技巧，而在 Rust 中，我们需要正确处理 <code>stdio</code>。</p>
<p>如果直接用 <code>.output()</code>，用户是看不到 Vim 界面的。必须使用 <code>.status()</code> 并继承父进程的 stdio：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">exec_git_interactive</span>(args: &amp;[&amp;<span class="hljs-type">str</span>]) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;()&gt; {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">status</span> = Command::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">"git"</span>)
        .<span class="hljs-title function_ invoke__">args</span>(args)
        <span class="hljs-comment">// 关键：让子进程直接使用当前的终端输入输出</span>
        .<span class="hljs-title function_ invoke__">status</span>()
        .<span class="hljs-title function_ invoke__">map_err</span>(|e| <span class="hljs-built_in">format!</span>(<span class="hljs-string">"❌ Failed to execute git command: {}"</span>, e))?;

    <span class="hljs-keyword">if</span> !status.<span class="hljs-title function_ invoke__">success</span>() {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Err</span>(<span class="hljs-string">"❌ Git command failed"</span>.<span class="hljs-title function_ invoke__">to_string</span>());
    }
    <span class="hljs-title function_ invoke__">Ok</span>(())
}
</code></pre>
<h3 data-id="heading-8">2. 严格的开发工作流 (Copilot 辅助)</h3>
<p>为了保证代码质量，我制定了一套严格的 <strong>"Design-Approve-Implement"</strong> 工作流，并写进了 <code>.github/instructions/copilot-instructions.md</code> 给 AI 助手看。</p>
<ol>
<li><strong>Design</strong>: 先写 Markdown 设计文档，定义参数、流程、异常处理。</li>
<li><strong>Approve</strong>: <strong>必须</strong>等待我回复“批准”才能开始写代码。</li>
<li><strong>Implement</strong>: 编写 Rust 代码。</li>
<li><strong>Verify</strong>: 运行 <code>cargo clippy</code> 和 <code>cargo fmt</code>，<strong>必须</strong>等待我回复“测试通过”才能提交。</li>
</ol>
<p>这套流程极大地减少了返工，比如最新的 <code>gix rebase</code> 功能就是完全按照这个流程一次性开发成功的。</p>
<h3 data-id="heading-9">3. 自动化的 CI/CD</h3>
<p>为了省事，我配置了 GitHub Actions 实现全自动发版：</p>
<ul>
<li><strong>TypeScript</strong>: 监听 <code>typescript/package.json</code> 变化，自动发布到 npm。</li>
<li><strong>Rust</strong>: 监听 <code>rust/Cargo.toml</code> 变化，自动打 Tag -&gt; 编译 Release -&gt; 发布到 GitHub Releases。</li>
</ul>
<p>特别是 Rust 的自动打标流程，通过解析 <code>Cargo.toml</code> 版本号，自动判断是否需要创建 Git Tag，实现了“改个版本号就发版”的丝滑体验。</p>
<h2 data-id="heading-10">总结</h2>
<p>从 TypeScript 到 Rust 的重写过程，不仅让 <code>gix</code> 变得更快、更轻，也让我深刻体会到了 Rust 在工程化方面的优势。</p>
<ul>
<li><strong>Clap</strong> 让 CLI 开发变成了一种享受。</li>
<li><strong>Rust 的类型系统</strong> 让我在重构时充满信心，不用担心运行时莫名其妙的 <code>undefined</code>。</li>
<li><strong>Cargo</strong> 的构建和依赖管理体验一流。</li>
</ul>
<p>如果你也在维护 CLI 工具，强烈建议尝试用 Rust 重写一下，绝对会有意想不到的收获！</p>
<hr/>
<p><strong>欢迎 Star 和试用：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnianyi778%2Fgix-cli" target="_blank" title="https://github.com/nianyi778/gix-cli" ref="nofollow noopener noreferrer">github.com/nianyi778/g…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Golang框架封神榜！GitHub星标TOP8大比拼，选对框架少走3年弯路]]></title>    <link>https://juejin.cn/post/7586902693857591338</link>    <guid>https://juejin.cn/post/7586902693857591338</guid>    <pubDate>2025-12-23T09:30:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586902693857591338" data-draft-id="7586890269699620918" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Golang框架封神榜！GitHub星标TOP8大比拼，选对框架少走3年弯路"/> <meta itemprop="keywords" content="后端,Go,面试"/> <meta itemprop="datePublished" content="2025-12-23T09:30:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="王中阳讲AI编程"/> <meta itemprop="url" content="https://juejin.cn/user/2189882892232029"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Golang框架封神榜！GitHub星标TOP8大比拼，选对框架少走3年弯路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2189882892232029/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    王中阳讲AI编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T09:30:29.000Z" title="Tue Dec 23 2025 09:30:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;font-weight:400;line-height:2;font-size:17px;overflow-x:hidden;color:#000}.markdown-body strong{padding:1px;color:#ee3f4d}.markdown-body em{padding:0 2px;color:#f33b1f}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:30px;margin-bottom:20px;line-height:1.5;font-weight:700}.markdown-body h1{text-align:center;padding-bottom:5px;font-size:32px;color:#ac1f18}.markdown-body h1:after{content:"";display:block;margin:4px auto 0;width:100px;height:2px;border-bottom:2px solid #f33b1f}.markdown-body h2{font-size:28px;border-bottom:1px solid #f33b1f}.markdown-body h2:before{content:"# "!important;color:#f33b1f}.markdown-body h3{font-size:24px;padding-left:9px;border-left:6px solid #f33b1f}.markdown-body h4{font-size:20px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #bbb;margin:16px 0}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f9f1db;color:#ee2746;border-radius:2px;font-size:16px;padding:1px 2px}.markdown-body code,.markdown-body pre{font-family:-apple-system,-apple-system-body,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,PingFang SC,思源黑体 CN,思源黑体,JetBrains Mono,Fira Code,Menlo,Ubuntu Mono,Consolas,sans-serif}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{margin:12px 0!important;border-radius:3px;font-size:15px;padding:16px 12px;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f7f7f7}.markdown-body a{text-decoration:none;color:#1781b5;padding:0 2px;border-bottom:1px solid #1781b5}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #f33b1f;color:#ac1f18}.markdown-body blockquote{color:#3d3d3d;background-color:#fff9f9;padding:6px 16px;margin:16px 0;border-left:3px solid #f07c82}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:6px 0}.markdown-body ol,.markdown-body ul{padding-left:30px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:6px}.markdown-body ol li{padding-left:6px}.markdown-body ::marker{color:#f33b1f}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body .task-list-item input[type=checkbox]{position:relative}.markdown-body .task-list-item input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:#fff;border:1px solid #f07c82;border-radius:3px;box-sizing:border-box;z-index:1}.markdown-body .task-list-item input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-5px;left:0;right:0;bottom:0;width:0;height:0;color:#f33b1f;font-size:16px;font-weight:700;z-index:2}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table thead{background:#fff9f9;color:#000;text-align:left;font-size:15px}.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table tr:hover{background-color:#fff9f9}.markdown-body table td,.markdown-body table th{padding:12px 7px;line-height:24px;border:1px solid #f9f1db}.markdown-body table td{min-width:120px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><blockquote>
<p>兄弟们，谁懂啊！用Golang开发最纠结的不是语法有多绕，而是框架选到秃头！</p>
</blockquote>
<p>毕竟Go生态里的框架五花八门，有的主打极致性能，有的号称全栈全能，新手看着一堆仓库直接懵圈，老鸟也得纠结半天适配度。</p>
<p>今天不整虚的！直接扒了GitHub上Golang框架的星标数据，整理出<strong>星标TOP8封神榜</strong>，从性能、适用场景到坑点全拆解。更关键的是，文末埋了个争议话题——“Golang框架选轻量还是全栈？”，欢迎各位Goer来Battle！</p>
<h2 data-id="heading-0">先划重点：榜单核心规则</h2>
<ol>
<li>
<p>数据来源：GitHub官方，截止2025年12月23日，星标数量实时变动但排名基本稳定；</p>
</li>
<li>
<p>筛选标准：仅收录主流Web/微服务框架，排除单一功能库（如纯ORM、纯路由库）；</p>
</li>
<li>
<p>排名依据：星标数量从高到低，星标相同则参考活跃贡献者数量；</p>
</li>
<li>
<p>实用导向：每个框架都附“一句话选型建议”，小白直接抄作业。</p>
</li>
</ol>
<h2 data-id="heading-1">Golang框架封神榜（GitHub星标TOP8）</h2>
<h3 data-id="heading-2">No.1 王者宝座：Gin（gin-gonic/gin）—— 星标87.3K+</h3>
<p>【标签】性能王者·轻量之王·新手友好</p>
<p>谁还没听过Gin的大名？Go生态的顶流框架，星标直接甩开第二名近50K，字节跳动、腾讯都在大规模使用，说是“Goer人手必备”毫不夸张。</p>
<p>核心优势：基于定制的HTTP路由器，性能比标准库快40倍，高并发场景下稳如老狗；API设计极简直观，新手写个/ping接口3行代码搞定，中间件生态超丰富，JWT、CORS、日志这些刚需功能直接开箱即用。</p>
<p>坑点预警：没有内置ORM，需要自己集成GORM之类的库；功能比较精简，复杂业务场景需要额外搭组件。</p>
<p>一句话选型：做RESTful API、微服务接口、高并发实时服务，选它准没错！</p>
<p>入门代码（感受下极简）：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main
<span class="hljs-keyword">import</span> <span class="hljs-string">"github.com/gin-gonic/gin"</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    r := gin.Default()
    r.GET(<span class="hljs-string">"/ping"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> {
        c.JSON(<span class="hljs-number">200</span>, gin.H{<span class="hljs-string">"message"</span>: <span class="hljs-string">"pong"</span>})
    })
    r.Run(<span class="hljs-string">":8080"</span>)
}
</code></pre>
<h3 data-id="heading-3">No.2 黑马挑战者：Fiber（go-fiber/fiber）—— 星标38.7K+</h3>
<p>【标签】极致性能·Express平替·内存杀手</p>
<p>近几年异军突起的黑马框架，星标增长速度快到惊人！主打“Go版Express”，API设计和Node.js的Express几乎一模一样，前端转Go的开发者无缝衔接。</p>
<p>核心优势：基于Fasthttp引擎，性能比Gin还猛，零内存分配热路径，处理数十万并发连接毫无压力；内置WebSocket支持，做实时聊天、游戏服务器超合适；内存占用极低，轻量部署无压力。</p>
<p>坑点预警：因为用了非标准库的Fasthttp，和部分标准库生态的包兼容性一般；社区比Gin年轻，部分小众需求的解决方案较少。</p>
<p>一句话选型：做超高并发服务、实时应用、轻量API，或者前端转Go的团队，优先选它！</p>
<h3 data-id="heading-4">No.3 全能老将：Beego（beego/beego）—— 星标32.3K+</h3>
<p>【标签】全栈全能·企业级·MVC架构</p>
<p>Go生态的老牌全栈框架，灵感来自Django，走“一站式解决方案”路线，把ORM、路由、会话管理、缓存、自动化文档全打包了，不用开发者到处找组件搭架子。</p>
<p>核心优势：内置ORM支持多种数据库，不用手写SQL；MVC架构清晰，适合大型团队协作；自带CLI代码生成器，bee new命令一键生成项目骨架，开发效率拉满。</p>
<p>坑点预警：功能太全导致性能不如Gin、Fiber；学习曲线较陡，新手要理解MVC、ORM等一堆概念；近几年更新速度变慢。</p>
<p>一句话选型：做大型企业级Web应用、后台管理系统，需要快速搭建完整技术栈的项目，选它！</p>
<h3 data-id="heading-5">No.4 微服务新星：Go-Zero（zero-micro/go-zero）—— 星标32.2K+</h3>
<p>【标签】微服务神器·高并发·代码生成狂魔</p>
<p>专门为微服务而生的框架，星标和Beego咬得极近，字节跳动内部孵化的框架，自带“大厂基因”，在微服务领域口碑超好。</p>
<p>核心优势：基于Fasthttp，QPS比同类微服务框架高50%，高并发场景下性能拉满；自带goctl代码生成工具，API和RPC代码自动生成，不用手写重复代码；内置熔断、限流、负载均衡，微服务治理刚需功能全搞定。</p>
<p>坑点预警：生态比较封闭，依赖官方工具链，自定义扩展需要了解框架内部实现；文档不够完善，新手入门有点难。</p>
<p>一句话选型：做高并发微服务架构、电商平台、社交App后端，选它！</p>
<h3 data-id="heading-6">No.5 极简先锋：Echo（labstack/echo）—— 星标31.9K+</h3>
<p>【标签】极简主义·性能能打·中间件灵活</p>
<p>和Gin齐名的轻量框架，主打“简约而不简单”，性能和Gin不相上下，都是高并发场景的优质选择。</p>
<p>核心优势：路由引擎优化到位，处理请求延迟极低；中间件机制超灵活，支持动态路由和路由分组；内置Swagger集成，自动生成API文档，团队协作超方便。</p>
<p>坑点预警：学习曲线比Gin稍陡；集成第三方中间件时可能遇到兼容性问题。</p>
<p>一句话选型：想要比Gin更灵活的中间件机制，又不想牺牲性能，选Echo！</p>
<h3 data-id="heading-7">No.6 微服务元老：Go-Kit（go-kit/kit）—— 星标27.5K+</h3>
<p>【标签】微服务标准库·组件化·跨语言友好</p>
<p>Go微服务生态的“元老级”框架，堪称“微服务标准库”，组件化设计理念深入人心，适合复杂的跨语言微服务架构。</p>
<p>核心优势：组件化程度高，服务发现、负载均衡、编解码这些核心组件都可插拔，支持Consul、Etcd等多种注册中心；原生支持HTTP、gRPC、MQTT等多种协议，跨语言协作无压力。</p>
<p>坑点预警：学习曲线巨陡，新手要理解一堆微服务概念；配置复杂，需要手动搭很多组件。</p>
<p>一句话选型：做复杂跨语言微服务架构、对服务治理要求高的企业级应用，选它！</p>
<h3 data-id="heading-8">No.7 云原生新秀：Go-Kratos（go-kratos/kratos）—— 星标25.2K+</h3>
<p>【标签】云原生·大厂背书·全链路治理</p>
<p>B站开源的微服务框架，近几年势头很猛，星标稳定增长，主打“云原生时代的微服务框架”，适配K8s、Docker等容器化部署。</p>
<p>核心优势：全链路治理能力强，包含服务注册发现、熔断限流、监控追踪等功能；支持Protobuf定义API，自动生成代码；云原生友好，部署灵活。</p>
<p>坑点预警：社区规模比Go-Micro、Go-Zero小；部分功能需要结合B站生态的组件。</p>
<p>一句话选型：做云原生微服务、需要全链路治理的项目，尤其是B站生态相关的团队，优先考虑！</p>
<h3 data-id="heading-9">No.8 经典老将：Gorilla Mux（gorilla/mux）—— 星标21.7K+</h3>
<p>【标签】经典路由·稳定可靠·生态兼容</p>
<p>Go生态的经典路由框架，虽然现在被Gin、Fiber抢了风头，但胜在稳定可靠，生态兼容性拉满，很多老项目还在继续使用。</p>
<p>核心优势：路由功能强大，支持正则表达式、路由参数、子路由；完全兼容标准库net/http，和其他标准库生态的包无缝衔接；稳定运行多年，bug极少。</p>
<p>坑点预警：性能不如Gin、Fiber；功能比较基础，很多功能需要自己扩展。</p>
<p>一句话选型：维护老项目、需要兼容大量标准库包、对路由灵活性要求高的场景，选它！</p>
<h2 data-id="heading-10">争议话题引爆：Golang框架，选轻量还是全栈？</h2>
<p>看完成绩单，想必大家心里都有个疑问：到底该选Gin、Fiber这种轻量框架，还是Beego这种全栈框架？</p>
<p>支持轻量派说：轻量框架性能好、灵活度高，按需集成组件，不会有冗余功能，后期维护成本低；</p>
<p>支持全栈派说：全栈框架开箱即用，不用浪费时间搭基础架构，开发效率高，适合快速落地项目，尤其是团队规模小的时候；</p>
<p>我先抛砖引玉：小型项目、追求极致性能、微服务场景，选轻量框架；大型企业级应用、需要快速落地、团队新手多，选全栈框架。</p>
<p>欢迎评论区Battle！说说你用过最顺手的Golang框架，或者你踩过哪些框架的坑？</p>
<h2 data-id="heading-11">最后总结：新手避坑选型指南</h2>
<ol>
<li>
<p>新手入门：优先选Gin，学习成本最低，生态最完善，遇到问题随便搜都有答案；</p>
</li>
<li>
<p>高并发API/微服务：Gin、Fiber二选一，追求极致性能选Fiber，追求生态选Gin；</p>
</li>
<li>
<p>企业级全栈应用：Beego，一站式解决方案，不用到处找组件；</p>
</li>
<li>
<p>复杂微服务架构：Go-Zero（高并发）、Go-Kit（跨语言）、Go-Kratos（云原生）；</p>
</li>
<li>
<p>老项目维护：Gorilla Mux，稳定兼容第一。</p>
</li>
</ol>
<p>框架没有最好的，只有最适合的！选对框架能让开发效率翻倍，少走很多弯路。收藏这篇文章，下次选框架直接对照看～</p>
<p>觉得有用的话，点赞+关注走一波，后续还会分享更多Golang实战干货！</p>
<blockquote>
<p>还有哪些被榜单遗漏的宝藏Go框架，欢迎评论区补充提名！另外，评论区留言“已关注”，我会随机抽3位兄弟，额外赠送《Go实战项目源码合集》！</p>
</blockquote>
<blockquote>
<p>关注公众号【王中阳】回复“Go框架”领干货，加绿泡泡wangzhongyang1993，进实战交流群，咱们一起深耕Go开发～</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么"API"很重要？——从封闭系统到开放生态]]></title>    <link>https://juejin.cn/post/7586687526867451919</link>    <guid>https://juejin.cn/post/7586687526867451919</guid>    <pubDate>2025-12-23T09:47:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586687526867451919" data-draft-id="7586687526867369999" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么&quot;API&quot;很重要？——从封闭系统到开放生态"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-23T09:47:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无限大6"/> <meta itemprop="url" content="https://juejin.cn/user/2865758605422890"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么"API"很重要？——从封闭系统到开放生态
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2865758605422890/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无限大6
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T09:47:20.000Z" title="Tue Dec 23 2025 09:47:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🔌 为什么"API"很重要？——从封闭系统到开放生态 🌐</h2>
<blockquote>
<p>大家好，我是无限大，欢迎收看十万个为什么系列文章</p>
<p>希望今天的内容能对大家有所帮助</p>
</blockquote>
<p>今天咱们来聊聊API这个"软件世界的连接器"！想象一下，你打开外卖APP，就能看到附近的餐厅、实时配送状态；你用打车APP，就能看到司机位置、预计到达时间——这些功能之所以能实现，全靠API在背后默默工作！</p>
<h3 data-id="heading-1">🤔 核心问题：API的作用是什么？为什么现代软件都依赖API？</h3>
<p>很多人觉得API是"高大上的技术名词"，其实API离我们很近！API就像"软件之间的翻译官"，让不同的软件能够互相交流、共享数据和功能。</p>
<h4 data-id="heading-2">API的本质</h4>
<p>API（Application Programming Interface）是一种<strong>软件接口</strong>，定义了不同软件之间如何互相通信。它就像"餐厅的菜单"，告诉你可以点什么菜（调用什么功能），但不告诉你厨房是怎么做的（内部实现）。</p>
<h4 data-id="heading-3">为什么现代软件都依赖API？</h4>
<ul>
<li>🔗 <strong>连接一切</strong>：让不同的软件、服务、设备能够互相通信</li>
<li>🚀 <strong>快速开发</strong>：直接调用现成的API，不用重复造轮子</li>
<li>💡 <strong>创新生态</strong>：基于API可以构建全新的应用和服务</li>
<li>💰 <strong>商业价值</strong>：通过API可以实现数据和服务的商业化</li>
</ul>
<h3 data-id="heading-4">📜 API的"进化史"：从封闭到开放</h3>
<h4 data-id="heading-5">1. 🔒 早期内部接口："闭门造车"</h4>
<p>20世纪80-90年代，软件都是独立的"孤岛"，每个软件都有自己的内部接口，只供自己使用。</p>
<p>这就像"每个家庭都有自己的语言"，互相之间无法交流。如果你想让两个软件合作，只能重写代码，非常麻烦！</p>
<h4 data-id="heading-6">2. 🌉 公开API萌芽："打开大门"</h4>
<p>2000年后，一些互联网公司开始对外开放API，比如Google Maps API（2005年）、Twitter API（2006年）。</p>
<p>这就像"家庭开始学习通用语言"，不同软件之间可以互相交流了。开发者可以基于这些API构建全新的应用，比如基于Google Maps的导航APP。</p>
<h4 data-id="heading-7">3. 🌐 API生态爆发："互联互通"</h4>
<p>2010年后，API进入爆发期。几乎所有互联网公司都对外开放API，形成了庞大的API生态。</p>
<p>这就像"全球都使用同一种语言"，软件之间可以自由交流、互相调用。我们现在使用的大多数互联网服务，都是通过API连接起来的！</p>
<h3 data-id="heading-8">🔧 技术原理：API的核心技术</h3>
<h4 data-id="heading-9">1. 📋 API设计原则："好用的API是什么样的？"</h4>
<p>一个好的API需要遵循以下原则：</p>
<ul>
<li>🎯 <strong>简洁性</strong>：接口设计简单明了，容易理解和使用</li>
<li>📱 <strong>一致性</strong>：命名规范一致，返回格式统一</li>
<li>🔒 <strong>安全性</strong>：有完善的认证和授权机制</li>
<li>📈 <strong>可扩展性</strong>：支持版本升级，不破坏现有功能</li>
<li>⚡ <strong>高性能</strong>：响应速度快，支持高并发</li>
</ul>
<h4 data-id="heading-10">2. 🌿 RESTful API规范："最流行的API设计风格"</h4>
<p>RESTful API是目前最流行的API设计风格，它基于HTTP协议，使用GET、POST、PUT、DELETE等HTTP方法来表示不同的操作。</p>
<p><strong>RESTful API的核心概念</strong>：</p>
<ul>
<li>📍 <strong>资源</strong>：用URL表示（比如 <code>/users</code> 表示用户资源）</li>
<li>🔧 <strong>操作</strong>：用HTTP方法表示（GET获取，POST创建，PUT更新，DELETE删除）</li>
<li>📦 <strong>数据格式</strong>：通常使用JSON格式</li>
</ul>
<p><strong>代码实例</strong>：用Python调用RESTful API</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> json

<span class="hljs-comment"># API端点（获取GitHub用户信息）</span>
url = <span class="hljs-string">"https://api.github.com/users/octocat"</span>

<span class="hljs-comment"># 发送GET请求</span>
response = requests.get(url)

<span class="hljs-comment"># 检查响应状态码</span>
<span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:
    <span class="hljs-comment"># 解析JSON响应</span>
    user_data = response.json()
    
    <span class="hljs-comment"># 打印用户信息</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ GitHub用户信息："</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"用户名：<span class="hljs-subst">{user_data[<span class="hljs-string">'login'</span>]}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"姓名：<span class="hljs-subst">{user_data[<span class="hljs-string">'name'</span>]}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"仓库数量：<span class="hljs-subst">{user_data[<span class="hljs-string">'public_repos'</span>]}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"关注者数量：<span class="hljs-subst">{user_data[<span class="hljs-string">'followers'</span>]}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"个人主页：<span class="hljs-subst">{user_data[<span class="hljs-string">'html_url'</span>]}</span>"</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"❌ 请求失败，状态码：<span class="hljs-subst">{response.status_code}</span>"</span>)
</code></pre>
<p><strong>运行结果</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">✅ GitHub用户信息：
用户名：octocat
姓名：The Octocat
仓库数量：<span class="hljs-number">8</span>
关注者数量：<span class="hljs-number">899000</span>
个人主页：https:<span class="hljs-comment">//github.com/octocat</span>
</code></pre>
<h4 data-id="heading-11">3. 🏰 API网关和管理："API的管家"</h4>
<p>API网关是管理API的"管家"，负责：</p>
<ul>
<li>🔐 <strong>认证授权</strong>：验证API调用者的身份和权限</li>
<li>⚡ <strong>负载均衡</strong>：将请求分发到不同的服务器</li>
<li>📊 <strong>监控统计</strong>：记录API调用情况，分析性能和使用情况</li>
<li>🛡️ <strong>安全防护</strong>：防止API被恶意攻击</li>
<li>📝 <strong>限流熔断</strong>：防止请求过多导致服务器崩溃</li>
</ul>
<h3 data-id="heading-12">📊 趣味对比：无API系统 vs 有API系统</h3>













































<table><thead><tr><th>对比项</th><th>无API系统</th><th>有API系统</th></tr></thead><tbody><tr><td><strong>系统集成</strong></td><td>困难（需要重写代码）</td><td>简单（直接调用API）</td></tr><tr><td><strong>开发速度</strong></td><td>慢（几个月）</td><td>快（几天到几周）</td></tr><tr><td><strong>创新能力</strong></td><td>弱（只能自己开发）</td><td>强（可以基于现有API构建新应用）</td></tr><tr><td><strong>数据共享</strong></td><td>几乎不可能</td><td>轻松实现（通过API共享数据）</td></tr><tr><td><strong>扩展性</strong></td><td>差（无法快速扩展功能）</td><td>好（可以随时添加新API）</td></tr><tr><td><strong>商业价值</strong></td><td>低（只能靠自身功能）</td><td>高（可以通过API实现商业化）</td></tr><tr><td><strong>用户体验</strong></td><td>单一（只能使用自身功能）</td><td>丰富（可以集成多种服务）</td></tr></tbody></table>
<h3 data-id="heading-13">🏢 API的应用场景：无处不在的API</h3>
<p>API已经渗透到我们生活的方方面面，被称为"互联网的基础设施"：</p>








































<table><thead><tr><th>应用场景</th><th>举例</th><th>API的作用</th></tr></thead><tbody><tr><td>🛒 电商平台</td><td>淘宝、京东</td><td>调用支付API、物流API、短信API</td></tr><tr><td>🚕 打车APP</td><td>滴滴、高德打车</td><td>调用地图API、定位API、支付API</td></tr><tr><td>🍔 外卖APP</td><td>美团外卖、饿了么</td><td>调用餐厅API、配送API、支付API</td></tr><tr><td>📱 移动应用</td><td>微信、抖音</td><td>调用登录API、分享API、支付API</td></tr><tr><td>☁️ 云服务</td><td>AWS、阿里云</td><td>提供各种云服务API（计算、存储、数据库）</td></tr><tr><td>📊 数据分析</td><td>百度统计、Google Analytics</td><td>提供数据分析API</td></tr></tbody></table>
<h3 data-id="heading-14">⚠️ 常见误区纠正</h3>
<h4 data-id="heading-15">1. "API就是接口，没什么特别的？"</h4>
<p>不！API不仅是接口，更是一种<strong>服务理念</strong>。它代表了软件的开放程度和生态建设能力。</p>
<h4 data-id="heading-16">2. "API越多越好？"</h4>
<p>不！API的质量比数量更重要。一个设计糟糕的API，可能比没有API更糟糕。</p>
<h4 data-id="heading-17">3. "API只对开发者有用？"</h4>
<p>不！API最终受益的是<strong>普通用户</strong>。我们使用的几乎所有互联网服务，都依赖API在背后工作。</p>
<h4 data-id="heading-18">4. "API是免费的？"</h4>
<p>不一定！很多API是收费的，尤其是高质量、高价值的API。比如Google Maps API、OpenAI API等。</p>
<h3 data-id="heading-19">🔮 未来展望：API的发展趋势</h3>
<h4 data-id="heading-20">1. 🤖 AI驱动的API</h4>
<p>AI将融入API的各个环节，包括智能API设计、自动生成API文档、智能调试和监控等。</p>
<h4 data-id="heading-21">2. 🌐 全球API网络</h4>
<p>API将形成一个全球性的网络，不同国家、不同行业的API可以互相调用，实现真正的"互联互通"。</p>
<h4 data-id="heading-22">3. 🔒 更安全的API</h4>
<p>随着网络安全问题的日益严重，API安全将成为重中之重，包括更强大的认证授权机制、更严格的访问控制等。</p>
<h4 data-id="heading-23">4. 📱 低代码/无代码API</h4>
<p>低代码/无代码平台将让非技术人员也能轻松创建和使用API，进一步降低API的使用门槛。</p>
<h3 data-id="heading-24">🎓 互动小测验：你答对了吗？</h3>



































<table><thead><tr><th>问题</th><th>答案</th><th>你答对了吗？</th></tr></thead><tbody><tr><td>API的全称是什么？</td><td>Application Programming Interface</td><td>✅/❌</td></tr><tr><td>最流行的API设计风格是什么？</td><td>RESTful API</td><td>✅/❌</td></tr><tr><td>全球API数量超过多少？</td><td>2000万个</td><td>✅/❌</td></tr><tr><td>API调用量年增长率是多少？</td><td>超过30%</td><td>✅/❌</td></tr><tr><td>API网关的作用是什么？</td><td>管理和保护API</td><td>✅/❌</td></tr></tbody></table>
<h3 data-id="heading-25">🎯 结语：API连接世界</h3>
<p>API就像"软件世界的高速公路"，让不同的软件能够快速、安全地互相通信。没有API，就没有今天丰富多彩的互联网服务；没有API，就没有快速发展的软件生态。</p>
<p>下次使用手机APP时，不妨想想背后有多少API在默默工作——正是这些"看不见的连接器"，让我们的数字生活变得更加便捷和丰富！</p>
<hr/>
<h3 data-id="heading-26">💬 互动话题</h3>
<ol>
<li>你使用过哪些基于API的服务？</li>
<li>你觉得未来API会如何改变我们的生活？</li>
<li>如果你是开发者，你最想调用哪个API？</li>
</ol>
<p>快来评论区聊聊你的想法！💬 点赞收藏不迷路，咱们下期继续探索计算机的"十万个为什么"！🎉</p>
<p><strong>关注我</strong>，下期带你解锁更多计算机的"奇葩冷知识"！🤓</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[DataWorks 又又又升级了，这次我们通过 Arrow 列存格式让数据同步速度提升10倍！]]></title>    <link>https://juejin.cn/post/7586973107321339944</link>    <guid>https://juejin.cn/post/7586973107321339944</guid>    <pubDate>2025-12-23T09:49:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586973107321339944" data-draft-id="7586869907065978915" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="DataWorks 又又又升级了，这次我们通过 Arrow 列存格式让数据同步速度提升10倍！"/> <meta itemprop="keywords" content="人工智能,大数据"/> <meta itemprop="datePublished" content="2025-12-23T09:49:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云大数据AI技术"/> <meta itemprop="url" content="https://juejin.cn/user/2414974667341287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            DataWorks 又又又升级了，这次我们通过 Arrow 列存格式让数据同步速度提升10倍！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2414974667341287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云大数据AI技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T09:49:21.000Z" title="Tue Dec 23 2025 09:49:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在大数据时代，数据集成作为企业数据流转的核心枢纽，承担着异构数据源之间高效同步的重要职责。随着数据量的爆炸式增长，传统的行存同步方式在面对大规模列存数据处理时，逐渐显露出性能瓶颈。</p>
<p>为解决这一挑战，DataWorks数据集成推出基于Apache Arrow列存格式的高性能同步能力，实现从“行式传输”到“列式直通”的技术跃迁。通过引入零拷贝、列式内存标准Apache Arrow，DataWorks实现了跨数据源的列存到列存高效同步，性能提升最高达10倍以上，助力企业实现数据流转的“高速通道”。</p>
<h2 data-id="heading-1">技术创新：基于Arrow的列存同步方案</h2>
<h3 data-id="heading-2">Apache Arrow：下一代数据处理的“通用语言”</h3>
<p>Apache Arrow是一项由Apache基金会主导的跨语言、高性能列式内存数据标准，被广泛应用于大数据生态（如Spark、Flink、Presto等）。核心优势在于：</p>
<ul>
<li>
<p>零序列化/反序列化：数据以内存二进制块直接传输，避免格式转换开销</p>
</li>
<li>
<p>零拷贝（Zero-Copy）：跨进程/跨系统共享内存，极大降低CPU与内存消耗</p>
</li>
<li>
<p>CPU缓存友好：列式存储提升缓存命中率，优化计算效率</p>
</li>
<li>
<p>统一类型系统：支持复杂嵌套结构，保障跨平台类型兼容性</p>
</li>
</ul>
<p>简单来说：Arrow让数据“原样流动”，不再“反复翻译”。</p>
<h3 data-id="heading-3">传统架构 vs Arrow架构：从“搬砖”到“高速专列”</h3>
<p>当前大多数数据集成工具仍基于“行存驱动”设计：</p>
<ul>
<li>
<p>Reader读取列存文件 → 解码成单行Record对象；</p>
</li>
<li>
<p>框架传递Record → Writer再将其编码回目标列存格式。</p>
</li>
</ul>
<p>这一过程存在严重性能浪费：</p>
<ul>
<li>
<p>多次类型转换与对象创建（如String → BigDecimal）</p>
</li>
<li>
<p>高频GC压力导致频繁Stop-The-World</p>
</li>
<li>
<p>内存带宽利用率低下</p>
</li>
</ul>
<p>而Arrow则彻底改变了这一流程：Reader直接输出列式Batch → Writer直接消费列式Batch，中间无需任何转换，真正实现“端到端列式流水线”。</p>
<h4 data-id="heading-4">传统行存同步架构：</h4>
<p>面向单行行存的格式设计，每一个Record对象定义了若干个Column，每个Column包含当前行对应该列的列值Value。以MaxCompute(ODPS)列存数据同步到MaxCompute(ODPS)列存为例：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e696fb70eb89405f884643c91229f5be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767088161&amp;x-signature=6AdfGCyOgPNVjjww1No1xJcygtY%3D" alt="image.png" loading="lazy"/></p>
<p>MaxCompute表数据可能以ORC、Parquet等列存格式存储的数据，同步核心流程分为：</p>
<ol>
<li>通过MaxCompute Tunnel将数据按行读取出来，并转为MaxCompute Record对象；</li>
<li>MaxCompute Reader将MaxCompute Record转换为同步引擎的Record对象，投递给框架；</li>
<li>框架收到Record放入缓存队列;</li>
<li>Writer从框架接收引擎Record，再转换为MaxCompute Record，并通过Tunnel client将数据进行序列化后通过网络传输给Tunnel server。</li>
</ol>
<h4 data-id="heading-5">数据集成Arrow列存同步架构：</h4>
<p>当列存到列存同步场景下，将列存先转为行存格式，再将行存格式转为列存格式，中间多了不必要的转换及序列化操作。通过构建全新的 ArrowTabularRecord 数据结构，DataWorks实现了对Arrow列式数据的原生支持，跳过行式转换环节，实现端到端列存“短路同步”，大幅提升吞吐、降低延迟。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6465ce9b4464c32ad0af4787c681209~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767088161&amp;x-signature=6TzGH8im9%2B7SSwxQvuRffkqTiKM%3D" alt="image.png" loading="lazy"/></p>
<p>同步引擎基于新的面向Arrow列存格式的ArrowTabularRecord，列存到列存数据流转如下：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e73b29747ea44cbb5e8cbb687a6e19f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767088161&amp;x-signature=TD%2FWxq8cu274omqOkNUK2hHsIZk%3D" alt="image.png" loading="lazy"/></p>
<p>同步核心流程如下：</p>
<ol>
<li>
<p>通过MaxCompute Tunnel Arrow API将数据直接按照Arrow列存格式读取出来，并存入ArrowTabularRecord，投递给框架；</p>
</li>
<li>
<p>框架收到Record放入缓存队列;</p>
</li>
<li>
<p>Writer从框架收到引擎ArrowTabularRecord，直接通过Tunnel Arrow API将数据基于Arrow格式，省去做序列化的开销，直接将内存二进制数据传输给Tunnel Server。</p>
</li>
</ol>
<h2 data-id="heading-6">核心能力：全链路列式加速，支持主流数据源</h2>
<p>DataWorks数据集成现已全面支持 <strong>MaxCompute、Hologres、Hive/OSS/HDFS（Parquet/ORC）</strong> 等主流列存数据源的Arrow读写能力，用户仅需在任务配置中添加 "useArrow": true 即可一键启用。</p>
<h3 data-id="heading-7">列存直读直写，显著提升性能</h3>

























<table><thead><tr><th><strong>数据源</strong></th><th><strong>支持能力</strong></th><th><strong>同步性能提升</strong></th></tr></thead><tbody><tr><td><strong>MaxCompute</strong></td><td>通过Tunnel Arrow API直读列存数据</td><td>同步性能提升 <strong>200%</strong></td></tr><tr><td><strong>Hologres</strong></td><td>支持Arrow格式导出，避免JDBC行式瓶颈</td><td>同步性能提升 <strong>95%</strong></td></tr><tr><td><strong>Hive\OSS\HDFS</strong>等分布式文件</td><td>直接读取Parquet/ORC底层Arrow格式数据</td><td>PARQUET同步性能提升<strong>5.55倍</strong>ORC同步性能提升 <strong>9.85倍</strong></td></tr></tbody></table>
<p><strong>示例：Hive ORC → MaxCompute 写入，原需数小时的任务，现可在数十分钟内完成。</strong></p>
<h3 data-id="heading-8">性能压测报告</h3>
<p>我们对多个典型场景进行了端到端性能测试，同步性能显著提升，可实现<strong>从小时级到分钟级</strong>的数据同步周期提升：</p>
<h4 data-id="heading-9">场景一：MaxCompute列存短路同步（Arrow → Arrow）</h4>





























<table><thead><tr><th><strong>并发数</strong></th><th><strong>传统行存</strong></th><th><strong>Arrow列存</strong></th><th><strong>性能提升</strong></th></tr></thead><tbody><tr><td>1</td><td>67.8 MB/s<br/>3740 R/s</td><td>212.6 MB/s<br/>11462 R/s</td><td><strong>+206.5%</strong></td></tr><tr><td>3</td><td>185.6 MB/s<br/>10226 R/s</td><td>569.9 MB/s<br/>30728 R/s</td><td><strong>+200.5%</strong></td></tr><tr><td>8</td><td>462.1 MB/s<br/>25467 R/s</td><td>1321.0 MB/s<br/>71143 R/s</td><td><strong>+197.4%</strong></td></tr></tbody></table>
<h4 data-id="heading-10">场景二：Hologres → MaxCompute 同步</h4>























<table><thead><tr><th><strong>并发数</strong></th><th><strong>传统同步</strong></th><th><strong>Arrow同步</strong></th><th><strong>性能提升</strong></th></tr></thead><tbody><tr><td>4</td><td>439.1 MB/s<br/>216480 R/s</td><td>906.1 MB/s<br/>404270 R/s</td><td><strong>+87%</strong></td></tr><tr><td>8</td><td>773.3 MB/s<br/>381300 R/s</td><td>1669.1 MB/s<br/>745654 R/s</td><td><strong>+95%</strong></td></tr></tbody></table>
<h4 data-id="heading-11">场景三：Parquet/ORC → MaxCompute 同步</h4>























<table><thead><tr><th><strong>并发数</strong></th><th><strong>传统同步</strong></th><th><strong>Arrow同步</strong></th><th><strong>性能提升</strong></th></tr></thead><tbody><tr><td>Parquet</td><td>26.1 MB/s<br/>35631 R/s</td><td>1198.1 MB/s<br/>233587 R/s</td><td><strong>5.55倍</strong></td></tr><tr><td>ORC</td><td>21.4 MB/s<br/>27661 R/s</td><td>3256.3 MB/s<br/>300326 R/s</td><td><strong>9.85倍</strong></td></tr></tbody></table>
<p>备注：Parquet、ORC文件可以在HDFS、OSS等分布式文件系统中</p>
<h2 data-id="heading-12">核心优势：不止于快，更稳、更低成本</h2>

























<table><thead><tr><th><strong>特性</strong></th><th><strong>价值说明</strong></th></tr></thead><tbody><tr><td><strong>高性能</strong></td><td>吞吐量提升最高达10倍，适合宽表、大数据量搬站同步</td></tr><tr><td><strong>低资源消耗</strong></td><td>零拷贝 + 内存复用，降低GC压力，节省计算成本</td></tr><tr><td><strong>高兼容性</strong></td><td>支持MaxCompute、Hologres、Hive等主流列存系统</td></tr><tr><td><strong>易用性</strong></td><td>仅需配置useArrow: true，无需代码改造</td></tr></tbody></table>
<h2 data-id="heading-13">典型应用场景：释放数据流转的无限可能</h2>
<h3 data-id="heading-14">场景一：大数据搬站迁移</h3>
<p><strong>痛点</strong>：从Hive向MaxCompute迁移数百TB数据，耗时较久，影响业务上线 <strong>方案</strong>：启用Arrow同步，列存直传，避免格式转换 <strong>成果</strong>：迁移时间从<strong>小时级同步缩短至分钟级</strong>，效率提升<strong>10倍以上</strong></p>
<h3 data-id="heading-15">场景二：异构数据源融合与湖仓一体化</h3>
<p>支持Hive（湖）与Hologres/MaxCompute（仓）之间的列存高效互通，为<strong>数据湖仓一体架构</strong>提供核心数据流转引擎，实现“一数多用、湖仓协同”。</p>
<h2 data-id="heading-16">如何使用？一步开启Arrow加速</h2>
<h3 data-id="heading-17">整库解决方案</h3>
<p>数据集成已经发布Hive-&gt;MaxCompute整库同步功能，默认会自动根据同步字段类型，渲染开启Arrow高性能同步能力。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc8b5382ecb040a09dfd13c2ed3b489b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767088161&amp;x-signature=QFcx7sxCZ4gxwzZDzTqNnOW7I2w%3D" alt="image.png" loading="lazy"/></p>
<p>💡 <strong>无需代码改造，无需理解底层细节，一键开启高性能同步</strong>。</p>
<h3 data-id="heading-18">单表离线同步</h3>
<p>DataWorks数据集成单表离线任务，在reader和writer parameter下添加 useArrow: true 参数，即可开启列式加速（由于是列存格式直读直写，开启前提是需要保证源端和目标端列类型保持一致）：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"job"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"steps"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"stepType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"hive"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"parameter"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"useArrow"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"datasource"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my_datasource"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"column"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-string">"col1"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-string">"col2"</span>
        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"readMode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"hdfs"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"table"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"table"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Reader"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"category"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"reader"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"stepType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"odps"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"parameter"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"useArrow"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"truncate"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"datasource"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"odps_test"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"column"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-string">"col1"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-string">"col2"</span>
        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"table"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"table"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Writer"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"category"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"writer"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"setting"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"speed"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"concurrent"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-19">未来演进：构建更强大的数据同步生态</h2>
<p>DataWorks将持续深化Arrow能力，打造企业级高性能数据流转平台：</p>
<ul>
<li>
<p><strong>更多数据源支持</strong>：扩展至HDFS、Paimon、ClickHouse、Iceberg等；</p>
</li>
<li>
<p><strong>智能调度优化</strong>：根据数据特征自动选择Arrow或行式模式；</p>
</li>
<li>
<p><strong>生态融合</strong>：为DataWorks数据搬站，提供端到端数据解决方案</p>
</li>
</ul>
<h2 data-id="heading-20">结语：让数据真正高性能“跑”起来</h2>
<p>DataWorks数据集成引入Apache Arrow列存同步能力，列式、零拷贝、内存级传输为同步性能带来显著提升。DataWorks数据集成正以技术创新为引擎，帮助企业打破数据孤岛、消除性能瓶颈，让数据在湖仓之间、系统之间、业务之间高速、稳定、低成本流动。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Xcode 26 Debug view hierarchy 不显示隐藏视图问题]]></title>    <link>https://juejin.cn/post/7586851351469555752</link>    <guid>https://juejin.cn/post/7586851351469555752</guid>    <pubDate>2025-12-23T09:58:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586851351469555752" data-draft-id="7586869907066175523" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Xcode 26 Debug view hierarchy 不显示隐藏视图问题"/> <meta itemprop="keywords" content="Xcode"/> <meta itemprop="datePublished" content="2025-12-23T09:58:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xiAo_Ju"/> <meta itemprop="url" content="https://juejin.cn/user/3966693681926029"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Xcode 26 Debug view hierarchy 不显示隐藏视图问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3966693681926029/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xiAo_Ju
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T09:58:13.000Z" title="Tue Dec 23 2025 09:58:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aecb1be6633d45589698f5cb888c0956~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGlBb19KdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767088693&amp;x-signature=NaD62bgDM8JxZN9n1pGamc2Xipc%3D" alt="Screenshot 2025-12-23 at 17.54.44.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零构建基于 RAG 的 AI 对话系统：Ollama + Python + 知识库实战]]></title>    <link>https://juejin.cn/post/7586622708999634984</link>    <guid>https://juejin.cn/post/7586622708999634984</guid>    <pubDate>2025-12-23T08:05:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586622708999634984" data-draft-id="7586687526866845711" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零构建基于 RAG 的 AI 对话系统：Ollama + Python + 知识库实战"/> <meta itemprop="keywords" content="人工智能,Python"/> <meta itemprop="datePublished" content="2025-12-23T08:05:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武当王丶也"/> <meta itemprop="url" content="https://juejin.cn/user/4424090519351374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零构建基于 RAG 的 AI 对话系统：Ollama + Python + 知识库实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4424090519351374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武当王丶也
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T08:05:45.000Z" title="Tue Dec 23 2025 08:05:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>如何用本地模型打造一个懂你业务的 AI 助手？本文手把手教你从零搭建一个生产级 RAG 对话系统</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db8d7fff456046858cf4579c6594f51b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5b2T546L5Li25Lmf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081944&amp;x-signature=E%2BeugeJRxjz5Cyy%2Fl%2BpU8WrGVKs%3D" alt="AI Chat" loading="lazy"/> <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6145682cd8714d40bb97e3d4390dcfc3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5b2T546L5Li25Lmf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081944&amp;x-signature=cWaoYgT0qcBSK9tVLxFvAyExkyE%3D" alt="RAG" loading="lazy"/> <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/125fb793a9094222b1a36b26703f347b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5b2T546L5Li25Lmf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081944&amp;x-signature=N%2FOhgUR25la6GP%2F4yxQpIRHNJsg%3D" alt="Python" loading="lazy"/> <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8997801e0da34575a7e719d7fa08e7d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5b2T546L5Li25Lmf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081944&amp;x-signature=3vmGVQ29O2e52IhT2WStvS4GVd4%3D" alt="FastAPI" loading="lazy"/></p>
<h2 data-id="heading-0">前言</h2>
<p>最近 AI 大模型火爆出圈，ChatGPT、Claude 等产品让对话式 AI 成为可能。但企业落地时面临一个核心痛点：<strong>通用大模型不懂你的业务数据</strong>。</p>
<p>比如你问："我们公司的请假流程是怎样的？" —— ChatGPT 只能给你通用回答，而无法基于你公司的员工手册来回答。</p>
<p><strong>RAG（检索增强生成）技术正是为此而生</strong>。它让 AI 能够"外挂"知识库，先检索相关文档，再基于检索结果生成答案。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7a4f36cbcd14835b5d731cd9e375d3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5b2T546L5Li25Lmf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081944&amp;x-signature=OtgMAT9juTuibyZdbyY0BFcXK%2F8%3D" alt="Gemini_Generated_Image_rdztwkrdztwkrdzt.png" loading="lazy"/></p>
<p>本文将详细介绍如何从零构建一个生产级的 RAG 对话系统 <strong>Ace AI</strong>，涵盖：</p>
<ul>
<li>使用 <strong>Ollama</strong> 本地部署 AI 模型</li>
<li>使用 <strong>Python + FastAPI</strong> 编写后端服务</li>
<li>使用 <strong>ChromaDB</strong> 构建向量知识库</li>
<li>前端对接实现 AI 对话窗口</li>
<li>Docker 容器化部署</li>
</ul>
<p>在线体验地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwangcaiyuan.com%2Fchat" target="_blank" title="https://wangcaiyuan.com/chat" ref="nofollow noopener noreferrer">wangcaiyuan.com/chat</a></p>
<p>GitHub 源码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Face0109%2Face-ai" target="_blank" title="https://github.com/ace0109/ace-ai" ref="nofollow noopener noreferrer">github.com/ace0109/ace…</a> ⭐</p>
<hr/>
<h2 data-id="heading-1">一、RAG 技术原理</h2>
<h3 data-id="heading-2">1.1 什么是 RAG？</h3>
<p>RAG（Retrieval-Augmented Generation，检索增强生成）是一种结合信息检索和文本生成的技术架构：</p>
<pre><code class="hljs language-sql" lang="sql">┌─────────────────────────────────────────────────────────────────┐
│                        RAG 工作流程                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  用户问题                                                       │
│     │                                                          │
│     ▼                                                          │
│  ┌─────────────┐                                               │
│  │ 向量检索    │ ──────► 从知识库中检索最相关的文档片段          │
│  └─────────────┘                                               │
│     │                                                          │
│     ▼                                                          │
│  ┌─────────────┐                                               │
│  │ 提示词构造  │ ──────► 将检索结果融入 <span class="hljs-keyword">System</span> Prompt          │
│  └─────────────┘                                               │
│     │                                                          │
│     ▼                                                          │
│  ┌─────────────┐                                               │
│  │ LLM 生成    │ ──────► 基于上下文生成答案                   │
│  └─────────────┘                                               │
│     │                                                          │
│     ▼                                                          │
│  流式返回给用户                                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-3">1.2 核心组件</h3>



































<table><thead><tr><th>组件</th><th>作用</th><th>技术选型</th></tr></thead><tbody><tr><td><strong>LLM</strong></td><td>对话生成</td><td>Ollama (qwen3-coder)</td></tr><tr><td><strong>Embedding 模型</strong></td><td>文本向量化</td><td>Ollama (nomic-embed-text)</td></tr><tr><td><strong>向量数据库</strong></td><td>存储和检索文档</td><td>ChromaDB</td></tr><tr><td><strong>文本分割器</strong></td><td>文档切分</td><td>LangChain RecursiveCharacterTextSplitter</td></tr><tr><td><strong>后端框架</strong></td><td>API 服务</td><td>FastAPI</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-4">二、项目结构</h2>
<pre><code class="hljs language-bash" lang="bash">ace-ai/
├── app/
│   ├── main.py                   <span class="hljs-comment"># FastAPI 应用入口</span>
│   ├── services/
│   │   └── rag.py               <span class="hljs-comment"># RAG 服务实现</span>
│   ├── api/routes/
│   │   ├── chat.py              <span class="hljs-comment"># 聊天接口</span>
│   │   └── documents.py         <span class="hljs-comment"># 文档上传</span>
│   └── core/
│       └── auth.py              <span class="hljs-comment"># API Key 认证</span>
├── data/                         <span class="hljs-comment"># 数据存储</span>
├── chroma_db/                    <span class="hljs-comment"># 向量数据库</span>
└── Dockerfile
</code></pre>
<hr/>
<h2 data-id="heading-5">三、Ollama 部署 AI 模型</h2>
<h3 data-id="heading-6">3.1 安装 Ollama</h3>
<p>Ollama 是一个本地运行大模型的工具，支持 macOS、Linux 和 Windows。</p>
<p><strong>macOS / Linux:</strong></p>
<pre><code class="hljs language-bash" lang="bash">curl -fsSL https://ollama.com/install.sh | sh
</code></pre>
<p><strong>Windows:</strong> 下载安装包 <a href="https://link.juejin.cn?target=https%3A%2F%2Follama.com" target="_blank" title="https://ollama.com" ref="nofollow noopener noreferrer">ollama.com</a></p>
<h3 data-id="heading-7">3.2 拉取所需模型</h3>
<p>Ace AI 需要两类模型：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. Chat 模型 - 用于对话生成</span>
ollama pull qwen3-coder:480b-cloud

<span class="hljs-comment"># 2. Embedding 模型 - 用于文本向量化</span>
ollama pull nomic-embed-text
</code></pre>
<h3 data-id="heading-8">3.3 验证 Ollama 服务</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查 Ollama 是否正常运行</span>
curl http://localhost:11434/api/tags

<span class="hljs-comment"># 测试 Chat 模型</span>
curl http://localhost:11434/api/generate -d <span class="hljs-string">'{
  "model": "qwen3-coder:480b-cloud",
  "prompt": "Hello, how are you?"
}'</span>
</code></pre>
<hr/>
<h2 data-id="heading-9">四、后端服务实现</h2>
<h3 data-id="heading-10">4.1 RAG 服务核心实现</h3>
<p>RAG 服务是整个系统的核心，负责文档向量化、存储和检索。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># app/services/rag.py</span>

<span class="hljs-keyword">from</span> langchain_ollama <span class="hljs-keyword">import</span> OllamaEmbeddings
<span class="hljs-keyword">from</span> langchain_chroma <span class="hljs-keyword">import</span> Chroma
<span class="hljs-keyword">from</span> langchain_core.documents <span class="hljs-keyword">import</span> Document
<span class="hljs-keyword">import</span> threading

<span class="hljs-keyword">class</span> <span class="hljs-title class_">RAGService</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 线程锁，保护向量存储操作</span>
        self._lock = threading.RLock()

        <span class="hljs-comment"># 初始化 Embedding 模型</span>
        self.embeddings = OllamaEmbeddings(
            model=<span class="hljs-string">"nomic-embed-text"</span>,
            base_url=<span class="hljs-string">"http://localhost:11434"</span>,
        )

        <span class="hljs-comment"># 初始化向量数据库</span>
        self.vector_store = Chroma(
            persist_directory=<span class="hljs-string">"./chroma_db"</span>,
            embedding_function=self.embeddings
        )

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_documents</span>(<span class="hljs-params">self, texts, metadatas=<span class="hljs-literal">None</span>, ids=<span class="hljs-literal">None</span></span>):
        <span class="hljs-string">"""将文档存入向量数据库"""</span>
        documents = [
            Document(page_content=text, metadata=metadatas[i] <span class="hljs-keyword">if</span> metadatas <span class="hljs-keyword">else</span> {})
            <span class="hljs-keyword">for</span> i, text <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(texts)
        ]
        <span class="hljs-keyword">with</span> self._lock:
            self.vector_store.add_documents(documents, ids=ids)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">query</span>(<span class="hljs-params">self, query_text: <span class="hljs-built_in">str</span>, k: <span class="hljs-built_in">int</span> = <span class="hljs-number">3</span></span>):
        <span class="hljs-string">"""根据问题检索最相关的 k 个文档片段"""</span>
        <span class="hljs-keyword">with</span> self._lock:
            <span class="hljs-keyword">return</span> self.vector_store.similarity_search(query_text, k=k)
</code></pre>
<h3 data-id="heading-11">4.2 文档上传处理</h3>
<p>当用户上传文档时，需要经过解析、分块、向量化三个步骤：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># app/api/routes/documents.py</span>

<span class="hljs-keyword">from</span> langchain_text_splitters <span class="hljs-keyword">import</span> RecursiveCharacterTextSplitter

<span class="hljs-comment"># 文本分割器配置</span>
text_splitter = RecursiveCharacterTextSplitter(
    chunk_size=<span class="hljs-number">1000</span>,        <span class="hljs-comment"># 每块最大字符数</span>
    chunk_overlap=<span class="hljs-number">200</span>,      <span class="hljs-comment"># 块之间重叠字符数</span>
    separators=[<span class="hljs-string">"\n\n"</span>, <span class="hljs-string">"\n"</span>, <span class="hljs-string">"。"</span>, <span class="hljs-string">"！"</span>, <span class="hljs-string">"？"</span>, <span class="hljs-string">"."</span>, <span class="hljs-string">"!"</span>, <span class="hljs-string">"?"</span>, <span class="hljs-string">" "</span>, <span class="hljs-string">""</span>]
)

<span class="hljs-meta">@router.post(<span class="hljs-params"><span class="hljs-string">"/upload"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">upload_document</span>(<span class="hljs-params">file: UploadFile</span>):
    <span class="hljs-comment"># 1. 解析文件内容 (支持 PDF/TXT/MD)</span>
    text = parse_file_content(<span class="hljs-keyword">await</span> file.read(), file.filename)

    <span class="hljs-comment"># 2. 文本分块</span>
    chunks = text_splitter.split_text(text)

    <span class="hljs-comment"># 3. 生成唯一 ID 和元数据</span>
    base_id = <span class="hljs-built_in">str</span>(uuid.uuid4())
    chunk_ids = [<span class="hljs-string">f"<span class="hljs-subst">{base_id}</span>_chunk_<span class="hljs-subst">{i}</span>"</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(chunks))]
    metadatas = [
        {
            <span class="hljs-string">"source"</span>: file.filename,
            <span class="hljs-string">"upload_time"</span>: datetime.now(timezone.utc).isoformat(),
            <span class="hljs-string">"chunk_index"</span>: i,
        }
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(chunks))
    ]

    <span class="hljs-comment"># 4. 存入向量数据库</span>
    rag_service.add_documents(chunks, metadatas=metadatas, ids=chunk_ids)

    <span class="hljs-keyword">return</span> {<span class="hljs-string">"message"</span>: <span class="hljs-string">f"Document uploaded successfully, <span class="hljs-subst">{<span class="hljs-built_in">len</span>(chunks)}</span> chunks created"</span>}
</code></pre>
<h3 data-id="heading-12">4.3 聊天接口实现</h3>
<p>聊天接口支持流式响应（SSE），让用户实时看到 AI 的回答：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># app/api/routes/chat.py</span>

<span class="hljs-meta">@router.post(<span class="hljs-params"><span class="hljs-string">""</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">chat_with_ollama</span>(<span class="hljs-params">messageBody: MessageBody</span>):
    <span class="hljs-comment"># 1. 处理会话 (创建新会话或使用已有会话)</span>
    session_id = messageBody.session_id <span class="hljs-keyword">or</span> create_new_session()

    <span class="hljs-comment"># 2. 保存用户消息</span>
    chat_store.add_message(session_id, <span class="hljs-string">"user"</span>, messageBody.message)

    <span class="hljs-comment"># 3. 获取历史消息 (最近 10 条)</span>
    history = chat_store.get_messages(session_id)[-<span class="hljs-number">10</span>:]

    <span class="hljs-comment"># 4. RAG 检索相关文档</span>
    <span class="hljs-keyword">try</span>:
        relevant_docs = rag_service.query(messageBody.message, k=<span class="hljs-number">3</span>)
        context_text = <span class="hljs-string">"\n\n"</span>.join([doc.page_content <span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> relevant_docs])
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        context_text = <span class="hljs-string">""</span>  <span class="hljs-comment"># 降级：不使用 RAG 上下文</span>

    <span class="hljs-comment"># 5. 构造提示词</span>
    system_prompt = <span class="hljs-string">"用中文回复。"</span>
    <span class="hljs-keyword">if</span> context_text:
        system_prompt += <span class="hljs-string">f"""
请基于以下【已知信息】回答用户的问题。如果没有已知信息，才按照你的知识回答。

【已知信息】:
<span class="hljs-subst">{context_text}</span>
"""</span>

    <span class="hljs-comment"># 6. 流式生成响应</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">stream_response</span>():
        <span class="hljs-keyword">yield</span> <span class="hljs-string">f"data: {{'session_id': '<span class="hljs-subst">{session_id}</span>'}}\n\n"</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> llm.astream(messages):
            <span class="hljs-keyword">yield</span> <span class="hljs-string">f"data: <span class="hljs-subst">{json.dumps(chunk)}</span>\n\n"</span>

    <span class="hljs-keyword">return</span> StreamingResponse(stream_response(), media_type=<span class="hljs-string">"text/event-stream"</span>)
</code></pre>
<h3 data-id="heading-13">4.4 API Key 认证</h3>
<p>为了保护 API 安全，实现了基于 API Key 的认证机制：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># app/core/auth.py</span>

<span class="hljs-keyword">import</span> hashlib

<span class="hljs-keyword">def</span> <span class="hljs-title function_">verify_api_key</span>(<span class="hljs-params">raw_key: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-built_in">dict</span>]:
    <span class="hljs-string">"""验证 API Key"""</span>
    key_hash = hashlib.sha256(raw_key.encode()).hexdigest()
    cursor.execute(
        <span class="hljs-string">"SELECT id, role, label FROM api_keys WHERE key_hash = ?"</span>,
        (key_hash,)
    )
    <span class="hljs-keyword">return</span> cursor.fetchone()

<span class="hljs-comment"># API 路由认证依赖</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">require_api_key</span>(<span class="hljs-params">request: Request</span>):
    api_key = request.headers.get(<span class="hljs-string">"X-API-Key"</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> api_key:
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">401</span>, detail=<span class="hljs-string">"API Key required"</span>)

    key_record = verify_api_key(api_key)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> key_record:
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">403</span>, detail=<span class="hljs-string">"Invalid API Key"</span>)

    request.state.api_key_record = key_record
    <span class="hljs-keyword">return</span> key_record
</code></pre>
<hr/>
<h2 data-id="heading-14">五、前端对接实现</h2>
<p>前端通过 SSE（Server-Sent Events）接收流式响应：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 前端调用示例</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendMessage</span>(<span class="hljs-params">message, sessionId</span>) {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'http://localhost:8888/api/chat'</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
      <span class="hljs-string">'X-API-Key'</span>: <span class="hljs-string">'your-api-key-here'</span>
    },
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ message, <span class="hljs-attr">session_id</span>: sessionId })
  });

  <span class="hljs-keyword">const</span> reader = response.<span class="hljs-property">body</span>.<span class="hljs-title function_">getReader</span>();
  <span class="hljs-keyword">const</span> decoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>();

  <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
    <span class="hljs-keyword">const</span> { done, value } = <span class="hljs-keyword">await</span> reader.<span class="hljs-title function_">read</span>();
    <span class="hljs-keyword">if</span> (done) <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">const</span> chunk = decoder.<span class="hljs-title function_">decode</span>(value);
    <span class="hljs-keyword">const</span> lines = chunk.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n'</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> line <span class="hljs-keyword">of</span> lines) {
      <span class="hljs-keyword">if</span> (line.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'data: '</span>)) {
        <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(line.<span class="hljs-title function_">slice</span>(<span class="hljs-number">6</span>));

        <span class="hljs-comment">// 第一个数据包包含 session_id</span>
        <span class="hljs-keyword">if</span> (data.<span class="hljs-property">session_id</span>) {
          sessionId = data.<span class="hljs-property">session_id</span>;
          <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-comment">// 后续数据包是 AI 的回复内容</span>
        <span class="hljs-keyword">if</span> (data.<span class="hljs-property">content</span>) {
          <span class="hljs-title function_">appendToChat</span>(data.<span class="hljs-property">content</span>);  <span class="hljs-comment">// 追加到聊天窗口</span>
        }
      }
    }
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-15">六、Docker 部署</h2>
<h3 data-id="heading-16">6.1 Dockerfile</h3>
<pre><code class="hljs language-dockerfile" lang="dockerfile">FROM python:3.11-slim

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

WORKDIR /app

# 安装依赖
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 拷贝代码
COPY app app

# 预创建运行时目录
RUN mkdir -p /app/data /app/chroma_db /app/logs

EXPOSE 8888

CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8888"]
</code></pre>
<h3 data-id="heading-17">6.2 构建和运行</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 构建镜像</span>
docker build -t ace-ai:latest .

<span class="hljs-comment"># 2. 运行容器</span>
docker run -d \
  --name ace-ai \
  --network host \
  -v $(<span class="hljs-built_in">pwd</span>)/data:/app/data \
  -v $(<span class="hljs-built_in">pwd</span>)/chroma_db:/app/chroma_db \
  -v $(<span class="hljs-built_in">pwd</span>)/logs:/app/logs \
  -e TZ=Asia/Shanghai \
  -e OLLAMA_BASE_URL=http://127.0.0.1:11434 \
  --restart unless-stopped \
  ace-ai:latest

<span class="hljs-comment"># 3. 获取超级管理员 API Key</span>
<span class="hljs-built_in">cat</span> data/initial_superadmin_key.txt

<span class="hljs-comment"># 4. 访问 API 文档</span>
open http://localhost:8888/docs
</code></pre>
<hr/>
<h2 data-id="heading-18">七、效果展示</h2>
<h3 data-id="heading-19">7.1 上传文档构建知识库</h3>
<pre><code class="hljs language-bash" lang="bash">curl -X POST http://localhost:8888/api/documents/upload \
  -H <span class="hljs-string">"X-API-Key: your-api-key"</span> \
  -F <span class="hljs-string">"file=@employee_handbook.pdf"</span>
</code></pre>
<h3 data-id="heading-20">7.2 进行对话</h3>
<pre><code class="hljs language-bash" lang="bash">curl -X POST http://localhost:8888/api/chat \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -H <span class="hljs-string">"X-API-Key: your-api-key"</span> \
  -d <span class="hljs-string">'{"message": "年假怎么申请？"}'</span>
</code></pre>
<h3 data-id="heading-21">7.3 在线体验</h3>
<p>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwangcaiyuan.com%2Fchat" target="_blank" title="https://wangcaiyuan.com/chat" ref="nofollow noopener noreferrer">wangcaiyuan.com/chat</a> 即可体验完整的 RAG 对话系统。</p>
<hr/>
<h2 data-id="heading-22">八、技术栈</h2>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">后端: Python 3.11 + FastAPI</span>
<span class="hljs-section">向量库: ChromaDB</span>
<span class="hljs-section">LLM: Ollama (qwen3-coder:480b-cloud)</span>
<span class="hljs-section">Embedding: Ollama (nomic-embed-text)</span>
<span class="hljs-section">容器: Docker</span>
</code></pre>
<h3 data-id="heading-23">主要特性</h3>
<ul>
<li><strong>SSE 流式响应</strong>：实时返回 AI 回复</li>
<li><strong>API Key 认证</strong>：保护接口安全</li>
<li><strong>文档解析</strong>：支持 PDF、TXT、Markdown</li>
<li><strong>Docker 部署</strong>：一键启动</li>
</ul>
<hr/>
<h2 data-id="heading-24">九、总结</h2>
<p>本文介绍了如何快速搭建一个基于 RAG 的 AI 对话系统，核心就是：</p>
<ol>
<li><strong>Ollama</strong> 本地运行 LLM</li>
<li><strong>ChromaDB</strong> 存储向量知识库</li>
<li><strong>FastAPI</strong> 提供 API 接口</li>
<li><strong>前端</strong> 通过 SSE 实现流式对话</li>
</ol>
<p><strong>GitHub 地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Face0109%2Face-ai" target="_blank" title="https://github.com/ace0109/ace-ai" ref="nofollow noopener noreferrer">github.com/ace0109/ace…</a> ⭐</p>
<p><strong>在线体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwangcaiyuan.com%2Fchat" target="_blank" title="https://wangcaiyuan.com/chat" ref="nofollow noopener noreferrer">wangcaiyuan.com/chat</a></p>
<p>有问题欢迎在评论区讨论！</p>
<hr/>
<p><strong>参考链接</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Follama.com" target="_blank" title="https://ollama.com" ref="nofollow noopener noreferrer">Ollama 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpython.langchain.com" target="_blank" title="https://python.langchain.com" ref="nofollow noopener noreferrer">LangChain 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.trychroma.com" target="_blank" title="https://docs.trychroma.com" ref="nofollow noopener noreferrer">ChromaDB 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ffastapi.tiangolo.com" target="_blank" title="https://fastapi.tiangolo.com" ref="nofollow noopener noreferrer">FastAPI 文档</a></li>
</ul>
<blockquote>
<p>本文首发于掘金，转载请注明出处。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[1、为什么说精通 Python 就等于握住了 AI 时代的全栈通行证？]]></title>    <link>https://juejin.cn/post/7586610067569131520</link>    <guid>https://juejin.cn/post/7586610067569131520</guid>    <pubDate>2025-12-23T08:23:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586610067569131520" data-draft-id="7586687526866829327" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="1、为什么说精通 Python 就等于握住了 AI 时代的全栈通行证？"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-23T08:23:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金詹姆斯"/> <meta itemprop="url" content="https://juejin.cn/user/2289608413155021"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            1、为什么说精通 Python 就等于握住了 AI 时代的全栈通行证？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2289608413155021/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金詹姆斯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T08:23:48.000Z" title="Tue Dec 23 2025 08:23:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">1、前言</h2>
<p>Python 在当前 <strong>AI 全栈开发</strong> 中扮演着<strong>核心且不可替代</strong>的角色，其重要性体现在从<strong>数据处理、模型训练、API 构建到前端交互和部署运维</strong>的每一个环节。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6dc5ff91b92a4b9b8a54276d684bcaa8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6Km55aeG5pav:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083027&amp;x-signature=28C7x3Vk3%2F%2FfWnZhWdot8uLSxh4%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">2、全栈开发中的“全”在 AI 场景下的新定义</h2>
<p>传统全栈 = 前端 + 后端 + 数据库</p>
<p><strong>AI 全栈</strong> = 数据工程 + 模型开发 + API服务 + 应用集成 + 部署监控</p>
<p><strong>Python 凭借其统一技术栈能力，几乎贯穿整个 AI 全流程：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b7f3e9092754c2ea7ec1b682903771c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6Km55aeG5pav:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083027&amp;x-signature=5aaIqO2IsgzAWkQSCzHWhMFC4B0%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">3、为什么其他语言难以替代？</h2>
<p><strong>生态完整性</strong></p>
<ul>
<li>几乎所有主流 AI 框架（PyTorch/TensorFlow/JAX）<strong>原生优先支持 Python</strong></li>
<li>Hugging Face、LangChain 等新兴 AI 工具链 <strong>以 Python 为默认接口</strong></li>
<li>连 OpenAI、Anthropic、Google DeepMind 的官方 SDK 都是 <strong>Python-first</strong></li>
</ul>
<p><strong>开发效率碾压</strong></p>
<ul>
<li>用 FastAPI + PyTorch 可在 <strong>10 行代码内</strong> 暴露一个大模型推理接口</li>
<li>Gradio 三行代码生成 Web UI，用于<strong>快速验证</strong> AI 功能</li>
<li>相比 Rust/C++，Python 让开发者聚焦 “<strong>做什么”而非“怎么做内存管理</strong>”</li>
</ul>
<p><strong>社区与人才储备</strong></p>
<ul>
<li>全球超 <strong>75% 的 AI/ML 岗位明确要求 Python</strong></li>
<li>GitHub 上 AI 相关项目 <strong>80%+ 使用 Python</strong></li>
<li>高校 AI 课程普遍以 Python 为教学语言，形成<strong>人才正循环</strong></li>
</ul>
<h2 data-id="heading-3">4、典型 AI 全栈项目中的 Python 实践</h2>
<p>假设你要开发一个 智能客服问答系统 ：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 1. 数据加载（pandas）</span>
df = pd.read_csv(<span class="hljs-string">"faq_data.csv"</span>)

<span class="hljs-comment"># 2. 向量检索（sentence-transformers + FAISS）</span>
<span class="hljs-keyword">from</span> sentence_transformers <span class="hljs-keyword">import</span> SentenceTransformer
model = SentenceTransformer(<span class="hljs-string">'all-MiniLM-L6-v2'</span>)
vectors = model.encode(df[<span class="hljs-string">'question'</span>].tolist())

<span class="hljs-comment"># 3. 构建 RAG（LangChain）</span>
<span class="hljs-keyword">from</span> langchain.chains <span class="hljs-keyword">import</span> RetrievalQA
qa_chain = RetrievalQA.from_chain_type(llm, retriever=faiss_retriever)

<span class="hljs-comment"># 4. 提供 API（FastAPI）</span>
<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/ask"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">ask</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-keyword">return</span> qa_chain.run(query)

<span class="hljs-comment"># 5. 快速演示（Gradio）</span>
gr.Interface(fn=ask, inputs=<span class="hljs-string">"text"</span>, outputs=<span class="hljs-string">"text"</span>).launch()
</code></pre>
<h2 data-id="heading-4">5、未来趋势：Python 仍是 AI 全栈的“中枢神经”</h2>
<ul>
<li><strong>多模态 AI</strong>（文本+图像+语音）：Transformers + OpenCV + librosa 全在 Python 生态</li>
<li><strong>AI Agent 开发</strong>：LangChain、AutoGen 等框架完全基于 Python</li>
<li><strong>MLOps 工具链</strong>：MLflow、Weights &amp; Biases、DVC 均提供 Python SDK</li>
</ul>
<h2 data-id="heading-5">6、结论</h2>
<blockquote>
<p><strong>Python 不仅是 AI 开发的语言，更是 AI 全栈开发的“操作系统”</strong></p>
</blockquote>
<blockquote>
<p><strong>成为当前 AI 工程师必须掌握的核心技能。无论你是算法研究员、后端工程师还是创业者，精通 Python 就等于握住了 AI 时代的全栈通行证</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript中的迭代器和生成器]]></title>    <link>https://juejin.cn/post/7586622708999847976</link>    <guid>https://juejin.cn/post/7586622708999847976</guid>    <pubDate>2025-12-23T08:35:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586622708999847976" data-draft-id="7586617459488882740" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript中的迭代器和生成器"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-12-23T08:35:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户31305008627"/> <meta itemprop="url" content="https://juejin.cn/user/2455641727456105"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript中的迭代器和生成器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2455641727456105/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户31305008627
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T08:35:27.000Z" title="Tue Dec 23 2025 08:35:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">先讲迭代器（Iterator）：就是“能一个个往外拿东西的容器”</h2>
<p>你可以把迭代器想象成自动售货机：</p>
<ul>
<li>你先有一堆商品（比如数组 [1,2,3]），把它们放进售货机里，这个售货机就是迭代器；</li>
<li>你每次按“出货”按钮（调用 <code>next()</code> 方法），它就给你出一个商品，出完一个就少一个；</li>
<li>等商品出完了，再按按钮就会返回 <code>{ value: undefined, done: true }</code>（提示“没货了”）；</li>
<li>而且它只能单向前进，出了2就回不到1了，不能倒着拿。</li>
</ul>
<h3 data-id="heading-1">JavaScript 迭代器的简单例子</h3>
<pre><code class="hljs language-vbscript" lang="vbscript">// <span class="hljs-number">1.</span> 先准备一个数组（一堆商品）
<span class="hljs-keyword">const</span> nums = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];

// <span class="hljs-number">2.</span> 把数组变成迭代器（装进售货机）
<span class="hljs-keyword">const</span> it = nums[Symbol.iterator]();

// <span class="hljs-number">3.</span> 按按钮拿东西（调用 <span class="hljs-keyword">next</span>()）
console.<span class="hljs-built_in">log</span>(it.<span class="hljs-keyword">next</span>()); // 输出 { value: <span class="hljs-number">1</span>, done: <span class="hljs-literal">false</span> }（拿第一个）
console.<span class="hljs-built_in">log</span>(it.<span class="hljs-keyword">next</span>()); // 输出 { value: <span class="hljs-number">2</span>, done: <span class="hljs-literal">false</span> }（拿第二个）
console.<span class="hljs-built_in">log</span>(it.<span class="hljs-keyword">next</span>()); // 输出 { value: <span class="hljs-number">3</span>, done: <span class="hljs-literal">false</span> }（拿第三个）
console.<span class="hljs-built_in">log</span>(it.<span class="hljs-keyword">next</span>()); // 输出 { value: undefined, done: <span class="hljs-literal">true</span> }（没货了）
</code></pre>
<h3 data-id="heading-2">迭代器的核心特点</h3>
<ol>
<li>必须有一个 <code>next()</code> 方法，调用后返回固定格式：<code>{ value: 具体值, done: 是否迭代完 }</code>；</li>
<li>惰性获取：只有调用 <code>next()</code> 才会返回下一个值，不会一次性把所有值加载到内存；</li>
<li>用完就没：只能往前，不能回头，也不能重复用。</li>
</ol>
<h3 data-id="heading-3">手动实现一个简单迭代器（理解原理）</h3>
<p>就像自己造一个简易售货机：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 手动实现迭代器：模拟售货机逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createIterator</span>(<span class="hljs-params">arr</span>) {
  <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>; <span class="hljs-comment">// 记录当前拿到第几个</span>
  <span class="hljs-keyword">return</span> {
    <span class="hljs-comment">// 核心的 next() 方法</span>
    <span class="hljs-attr">next</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 如果没拿完，返回当前值 + 未完成；否则返回 undefined + 已完成</span>
      <span class="hljs-keyword">if</span> (index &lt; arr.<span class="hljs-property">length</span>) {
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">value</span>: arr[index++], <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span> };
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">value</span>: <span class="hljs-literal">undefined</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">true</span> };
      }
    }
  };
}

<span class="hljs-comment">// 使用这个自定义迭代器</span>
<span class="hljs-keyword">const</span> myIt = <span class="hljs-title function_">createIterator</span>([<span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span>]);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myIt.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// { value: 10, done: false }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myIt.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// { value: 20, done: false }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myIt.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// { value: 30, done: false }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myIt.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// { value: undefined, done: true }</span>
</code></pre>
<h2 data-id="heading-4">再讲生成器：“自动造东西的迭代器”</h2>
<p>生成器是迭代器的升级版，你可以把它想象成现做现卖的小吃摊：</p>
<ul>
<li>迭代器是“先把所有东西准备好再往外拿”（比如先把1、2、3都放进售货机）；</li>
<li>生成器是“你要一个，我才做一个”（比如你要第一个包子，我才包第一个，要第二个才包第二个）；</li>
<li>它不用提前把所有数据存在内存里，而是“按需生成”，特别省内存。</li>
</ul>
<h3 data-id="heading-5">JavaScript 生成器的核心：<code>function*</code> + <code>yield</code></h3>
<p><code>function*</code> 是生成器函数的标识（注意多了个 <code>*</code>），<code>yield</code> 就是“暂停并返回”的意思——比如你去小吃摊买包子，老板包一个给你，然后暂停，等你要下一个再继续包。</p>
<h3 data-id="heading-6">生成器的完整例子（最常用）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定义生成器函数（注意 function* 和 yield）</span>
<span class="hljs-keyword">function</span>* <span class="hljs-title function_">makeBuns</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"开始包第一个包子"</span>);
  <span class="hljs-keyword">yield</span> <span class="hljs-number">1</span>; <span class="hljs-comment">// 包好第一个，返回，暂停</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"开始包第二个包子"</span>);
  <span class="hljs-keyword">yield</span> <span class="hljs-number">2</span>; <span class="hljs-comment">// 继续，包第二个，返回，暂停</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"开始包第三个包子"</span>);
  <span class="hljs-keyword">yield</span> <span class="hljs-number">3</span>; <span class="hljs-comment">// 继续，包第三个，返回，暂停</span>
}

<span class="hljs-comment">// 调用函数，得到生成器（此时函数不会执行，只是创建生成器）</span>
<span class="hljs-keyword">const</span> bunGen = <span class="hljs-title function_">makeBuns</span>();

<span class="hljs-comment">// 第一次拿：执行到第一个yield，返回 { value: 1, done: false }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bunGen.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// 输出：开始包第一个包子 → { value: 1, done: false }</span>
<span class="hljs-comment">// 第二次拿：从暂停的地方继续，执行到第二个yield</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bunGen.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// 输出：开始包第二个包子 → { value: 2, done: false }</span>
<span class="hljs-comment">// 第三次拿：继续，执行到第三个yield</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bunGen.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// 输出：开始包第三个包子 → { value: 3, done: false }</span>
<span class="hljs-comment">// 第四次拿：没包子了，返回 done: true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bunGen.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// 输出：{ value: undefined, done: true }</span>
</code></pre>
<h3 data-id="heading-7">生成器的实用场景：按需生成大量数据</h3>
<p>比如要生成 100 万个数字，用数组会占满内存，但生成器只在需要时计算：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 生成器：按需生成数字，不占内存</span>
<span class="hljs-keyword">function</span>* <span class="hljs-title function_">generateBigNumbers</span>(<span class="hljs-params">max</span>) {
  <span class="hljs-keyword">let</span> num = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">while</span> (num &lt;= max) {
    <span class="hljs-keyword">yield</span> num++; <span class="hljs-comment">// 要一个，生成一个</span>
  }
}

<span class="hljs-comment">// 生成 100 万个数字的生成器（此时还没生成任何数字）</span>
<span class="hljs-keyword">const</span> bigNumGen = <span class="hljs-title function_">generateBigNumbers</span>(<span class="hljs-number">1000000</span>);

<span class="hljs-comment">// 只拿前3个，后面的不会生成</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bigNumGen.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// 1</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bigNumGen.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// 2</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bigNumGen.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// 3</span>
</code></pre>
<h2 data-id="heading-8">迭代器 vs 生成器 一句话区分（JS 版本）</h2>
<ul>
<li>迭代器：已有数据的“搬运工”（把现成的东西一个个拿出来，比如数组迭代器）；</li>
<li>生成器：按需生成数据的“生产者”（没有现成数据，要的时候才造，用 <code>function*</code> + <code>yield</code>）；</li>
<li>生成器本质上是一种“自动实现了迭代器接口”的迭代器，写起来比手动迭代器简单 10 倍。</li>
</ul>
<hr/>
<h3 data-id="heading-9">总结</h3>
<ol>
<li>迭代器：像自动售货机，提前装好物，按一次出一个，出完为止，核心是“遍历已有数据”；</li>
<li>生成器：像现做现卖的小吃摊，不用提前备货，要一个做一个，核心是“按需生成数据”，更省内存；</li>
<li>JS 里迭代器靠 <code>next()</code> 方法和 <code>{ value, done }</code> 格式，生成器靠 <code>function*</code> + <code>yield</code>，两者都是“惰性计算”，适合处理大数据。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>