<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[AI概念扫盲：LoRA微调原理是什么？]]></title>    <link>https://juejin.cn/post/7585463195201962034</link>    <guid>https://juejin.cn/post/7585463195201962034</guid>    <pubDate>2025-12-20T14:05:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463195201962034" data-draft-id="7585686247285211187" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI概念扫盲：LoRA微调原理是什么？"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2025-12-20T14:05:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="智泊AI"/> <meta itemprop="url" content="https://juejin.cn/user/3572727470361578"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI概念扫盲：LoRA微调原理是什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3572727470361578/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    智泊AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T14:05:17.000Z" title="Sat Dec 20 2025 14:05:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>LoRA(Low-Rank Adaptation)是一种用于微调大型语言模型(LLM)的高效方法，能够在不大幅增加计算资源的情况下，让模型快速适应新任务或新领域。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51c4da85ec324fbcbbca748dfb4ed30e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766844317&amp;x-signature=poOcH1riiDt6MBN5ltewyT48%2FJo%3D" alt="图片" loading="lazy"/></p>
<p><strong>1.背景: 为什么需要 LoRA?</strong></p>
<p>想象一下，大型语言模型(比如 GPT-3、LLaMA)就像一辆超级跑车，里面有几十亿甚至上千亿个零件(参数)。</p>
<p>这些模型在通用任务上很强，但如果你想让它专门处理某个新任务(比如医疗问答、金融分析)，传统方法是把整个型的参数重新调整一遍。</p>
<p>这就像为了让跑车跑得更快，把发动机、轮胎、底盘全拆了重装一遍，费时费力还费钱。</p>
<p>但现实中，我们往往没有那么多资源--训练一个大模型需要超级计算机和海量时间。</p>
<p>于是，LORA 出现了。它的核心思路是: 不用动整个模型，只调整一小部分参数，就能让模型适应新任务。</p>
<p>这就像在跑车上加个小涡轮增压器，既省钱又省力，效果还不错。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer"><strong>更多AI大模型学习视频及资源，都在智泊AI。</strong></a></p>
<p><strong>2.LoRA 的原理: 低秩适配是什么?</strong></p>
<p>翻译成中文就是“低秩适配”。这个名LORA 的全称是 Low-Rank Adaptation,字听起来有点学术，但其实原理很简单。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/656443e03f4d4622858a9edc27be0c14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766844317&amp;x-signature=Vf8M4WilOvs68f%2B03pEGB2dvxrw%3D" alt="图片" loading="lazy"/></p>
<p><strong>模型的参数是大矩阵</strong></p>
<p>大型语言模型的参数很多是以矩阵形式存在的，比如自注意力层里的权重矩阵。这些矩阵很大，包含了模型的核心知识。</p>
<p><strong>低秩分解: 精简更新</strong></p>
<p>LORA 的聪明之处在于，它认为你不需要更新整个大矩阵，而是可以用一个“精简版“来代替。这个精简版叫“低秩矩阵”，它捕捉了大矩阵里最核心的变化信息，但参数量小得多。</p>
<p>具体操作是这样的:</p>
<p>在原始的权重矩阵(记为(W))旁边，加两个小矩阵(A)和(B); (A)和(B)的“秩”(rank)很低(比如8或16)，参数量远小于(W); 微调时，原始矩阵(W)不动，只更新(A)和(B)。</p>
<p>最后，模型的输出变成 w+AxB，这里的 AxB就像一个小助手，帮原始模型适应新任务。</p>
<p><strong>通俗比喻</strong></p>
<p>想象你有个大公司(原始模型)，要接手一个新业务。传统方法是把所有部门都改组，太麻烦。</p>
<p>LORA则是派一个小团队((A)和(B))，专门负责新业务，既高效又不影响公司核心运作。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ae1e471ff73457e934f270f6065129c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766844317&amp;x-signature=Zk8ei4w9KS8jpvO0JgPuxmD8ewA%3D" alt="图片" loading="lazy"/></p>
<p><strong>3.LoRA 的优势: 为什么这么受欢迎?</strong></p>
<p>LoRA 能火起来，是因为它有几个特别牛的优势</p>
<p>参数超少: 传统微调要更新全部参数(比如几十亿个)LORA 只更新一小部分(通常是原始模型的 0.01%到1%)存储和计算成本大幅降低。</p>
<p>训练超快: 参数少，训练自然快，普通 GPU就能跑，不用超算。</p>
<p>部署超方便: LoRA 模块像“插件“一样，可以随时插拔。比如一个基础模型，可以加载不同的 LoRA 模块来处理不同任务。</p>
<p>效果还不错: 虽然参数少，但在很多任务上，LORA的表现和全参数微调差不多，甚至更好。</p>
<p><strong>通俗比喻</strong></p>
<p>LORA 就像给手机装个小应用。不用换新手机，只需下载个插件，就能让手机多会几招，既省钱又方便。</p>
<p><strong>4. LoRA 的应用场景: 能干啥?</strong></p>
<p>LoRA 在实际中用途很广，尤其是在自然语言处理(NLP)领域。以下是几个典型场景:</p>
<p>领域适配:让通用模型变成“专家”。比如拿医疗数据微调一个 LoRA 模块，模型就能回答医学问题。</p>
<p>多任务学习:一个基础模型，通过不同 LoRA 模块处理不同任务，比如翻译、对话、文本生成。</p>
<p>个性化定制:为特定用户或场景定制模型，比如让聊天机器人模仿你的语言风格。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dbcaed83281249d3813cc03f842536b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766844317&amp;x-signature=77osFiTC1IElKvqlgBjZL1t7Yh0%3D" alt="图片" loading="lazy"/></p>
<p><strong>实际例子</strong></p>
<p>假设你有个通用聊天机器人，想让它在金融领域表现更好。传统方法是用金融数据重训整个模型，费时费力。</p>
<p>LORA 则是训练一个金融领域的 LoRA 模块，插到原始模型上，机器人立马变成“金融专家”。</p>
<p><strong>5.LoRA 的工作流程: 怎么用?</strong></p>
<p>LoRA 的使用过程很简单，步骤如下</p>
<p>1.选个基础模型: 比如一个预训练好的大模型(LLaMA、GPT等)</p>
<p>2.加 LoRA 模块: 在模型的某些层(比如自注意力层)旁边加两个小矩阵(A)和(B)。</p>
<p>冻结原始参数: 训练时，原始模型的参数不动，只更新(A)和(B)。</p>
<p>微调: 用新任务的数据训练(A)和(B)，让它们学会A.新技能。</p>
<p>推理: 用的时候，把 LoRA 模块加到原始模型上，模型就能干新活了。</p>
<p><strong>通俗比喻</strong></p>
<p>你有个智能音箱，想让它会讲笑话。不用把音箱拆了重装，只需下载个“笑话插件”(LORA 模块)，插上就能讲笑话。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec0d84a409ff41248552b1ed4f4183f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766844317&amp;x-signature=8MB5XxUXZYsLD1izuPg9%2FZv05Js%3D" alt="图片" loading="lazy"/></p>
<p><strong>6.LoRA 的数学细节: 想深入了解?</strong></p>
<p>如果你对数学感兴趣，可以看看 LoRA 的简单原理(不感兴趣可以跳过)</p>
<p>原始权重矩阵(W)是dxd的，参数量是 d^2(比如，d=1000 参数量就是 100 万)。</p>
<p>LORA加了Delta(w)=AxB，其中(A)是d x r(B)是rxd,(r)很小(比如8)。参数量变成 2xdxr(比如)2x1000 x8=16000 ，远小于 d^2</p>
<p>简单说，LoRA 用很少的参数(比如1.6万个)代替了更新全部参数(100 万个)，但效果依然很好。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71f936604d384417bbd7bedc1c648e36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766844317&amp;x-signature=4dQUjGpQb88rj17gtFl%2BMrir2vw%3D" alt="图片" loading="lazy"/></p>
<p><strong>7.LoRA 的局限性: 有啥不足?</strong></p>
<p>LORA 虽然好用，但也不是万能的:</p>
<p>效果有限: 某些复杂任务上，LORA 可能不如全参数微调。</p>
<p>超参数麻烦: 比如秩(r)的选择，太小效果不好，太大参数又多，需要试错。</p>
<p>位置选择: LORA 加在哪些层效果最好，靠经验或实验。</p>
<p>为了改进这些问题，出现了 LORA+、DORA 等升级版性能更强，适应性更好。</p>
<p><strong>8.总结: LORA 到底是啥?</strong></p>
<p>LoRA 是一种高效微调大型语言模型的方法，通过在原始模型旁边加两个小矩阵(低秩矩阵)，让模型快速适应新任务。</p>
<p>它的优势是参数少、训练快、部署方便，特别适合资源有限或需要快速适应的场景。</p>
<p>简单来说，LoRA 就像给模型装了个“外挂”，不用大动干戈，就能让模型学会新技能。</p>
<p><strong>通俗总结</strong></p>
<p>LORA 是模型的“涡轮增压器”，小投入大回报，让微调变得像装插件一样简单。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer"><strong>更多AI大模型学习视频及资源，都在智泊AI。</strong></a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[现在还有Java面试者不会开发Starter组件]]></title>    <link>https://juejin.cn/post/7585534343561396274</link>    <guid>https://juejin.cn/post/7585534343561396274</guid>    <pubDate>2025-12-20T14:21:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585534343561396274" data-draft-id="7585706951603175450" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="现在还有Java面试者不会开发Starter组件"/> <meta itemprop="keywords" content="后端,面试,架构"/> <meta itemprop="datePublished" content="2025-12-20T14:21:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱海贼的无处不在"/> <meta itemprop="url" content="https://juejin.cn/user/2359988032644541"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            现在还有Java面试者不会开发Starter组件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2359988032644541/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱海贼的无处不在
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T14:21:46.000Z" title="Sat Dec 20 2025 14:21:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、背景说明：真实的面试感受</h2>
<p>最近在公司面试了一批 <strong>4–7 年开发经验</strong>的后端工程师，简历整体并不差，做过的项目也不少，但有一个问题让我印象非常深刻：</p>
<blockquote>
<p><strong>几乎没有人能把「如何开发一个 Spring Boot Starter」以及相关原理说清楚。</strong></p>
</blockquote>
<p>进一步交流后发现，这类候选人普遍有一个共同点：<br/>
<strong>长期处在外包环境或业务高度固化的项目中</strong>，技术使用停留在“会用框架”，但很少去思考：</p>
<ul>
<li>
<p>框架能力是如何被封装出来的</p>
</li>
<li>
<p>通用技术能力如何被复用、标准化</p>
</li>
<li>
<p>一个组件是如何做到“即插即用、不侵入业务”的</p>
</li>
</ul>
<p>在面试中，这直接体现在：<br/>
<strong>对 Spring Boot Starter 的理解模糊、表达混乱、缺乏工程抽象意识</strong>，最终只能给出不通过的结论。</p>
<p>其实，<strong>开发一个 Spring Boot Starter 本身并不难</strong>。<br/>
真正难的不是 API，而是：</p>
<blockquote>
<p><strong>你有没有在技术领域进行持续、主动的学习和抽象。</strong></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7bedfdcbc0094013a52562f03151ed91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766845306&amp;x-signature=FfBPUgluilk9Bl0SH%2F8DH%2B%2FgpVY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">二、开发 Spring Boot Starter 的核心步骤</h2>
<p>我认为<strong>任何一个后端工程师都应该能说清楚、并且实践过的</strong> Starter 开发流程。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6861139e51a404085ca0d39df3f9d8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766845306&amp;x-signature=o7Q%2F1RSRjud3JGp77BU6XbM9nwE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">第一步：明确 Starter 提供的技术能力及其边界</h3>
<p>在写任何代码之前，首先要想清楚三件事：</p>
<ul>
<li>
<p>Starter <strong>解决什么技术问题</strong></p>
</li>
<li>
<p>Starter <strong>不解决什么问题</strong></p>
</li>
<li>
<p>Starter 是否只是提供 <strong>默认能力</strong>，而不是强制能力</p>
</li>
</ul>
<h3 data-id="heading-3">第二步：创建 xxx-spring-boot-starter 包</h3>
<p>Starter 本身是一个<strong>对外暴露的入口模块</strong>，它的职责非常简单：</p>
<ul>
<li>
<p>作为业务系统的依赖入口</p>
</li>
<li>
<p>聚合所需的依赖</p>
</li>
<li>
<p>不承载具体实现逻辑</p>
</li>
</ul>
<p>这一层存在的意义是：<br/>
<strong>让使用方“只引一个依赖”就能获得能力</strong>。</p>
<h3 data-id="heading-4">第三步：创建 XxxxProperties 与 XxxxAutoConfiguration</h3>
<p>这是 Starter 的核心实现部分：</p>
<ul>
<li>
<p><code>XxxxProperties</code>：</p>
<ul>
<li>
<p>用于绑定外部配置</p>
</li>
<li>
<p>定义统一的配置前缀</p>
</li>
<li>
<p>提供默认配置值</p>
</li>
</ul>
</li>
<li>
<p><code>XxxxAutoConfiguration</code>：</p>
<ul>
<li>
<p>作为自动装配入口</p>
</li>
<li>
<p>负责初始化 Starter 提供的技术能力</p>
</li>
<li>
<p>向 Spring 容器注册默认 Bean</p>
</li>
</ul>
</li>
</ul>
<p>这一层的关键目标只有一个：<br/>
<strong>让技术能力在合适的时机被自动注入到容器中。</strong></p>
<h3 data-id="heading-5">第四步：通过条件控制 Starter 是否生效</h3>
<p>一个合格的 Starter <strong>一定不是无条件生效的</strong>。</p>
<p>常见的控制方式包括：</p>
<ul>
<li>
<p>是否开启：<code>enabled</code> 总开关</p>
</li>
<li>
<p>是否存在某些依赖</p>
</li>
<li>
<p>用户是否已经定义了同类 Bean</p>
</li>
<li>
<p>当前运行环境是否满足要求</p>
</li>
</ul>
<p>核心原则只有一句话：</p>
<blockquote>
<p><strong>Starter 提供的是“兜底能力”，不是“强制接管”。</strong></p>
</blockquote>
<h3 data-id="heading-6">第五步：通过 spring.factories 声明自动装配类</h3>
<p>要让 Spring Boot 在启动过程中发现你的自动配置类，需要：</p>
<ul>
<li>
<p>在指定位置声明自动配置入口</p>
</li>
<li>
<p>让其参与 Spring Boot 的自动装配流程</p>
</li>
</ul>
<p>这一步的作用是：<br/>
<strong>把你的 Starter 挂载到 Spring Boot 的自动配置体系中。</strong></p>
<h3 data-id="heading-7">第六步：验证三种关键使用场景</h3>
<p>一个 Starter 是否合格，至少要验证三种场景：</p>
<ol>
<li>
<p><strong>完全不写任何配置</strong>，应用是否能正常启动</p>
</li>
<li>
<p><strong>用户自定义 Bean</strong>，是否优先生效</p>
</li>
<li>
<p><strong>关闭 enabled 开关</strong>，Starter 是否彻底失效</p>
</li>
</ol>
<h2 data-id="heading-8">三、面试中我重点关注的几个问题</h2>
<p>在面试中，我通常会围绕 Starter 追问下面这些问题，用来判断候选人是否真正理解过。</p>
<ul>
<li>
<p><strong>Starter 和普通 jar 的核心区别是什么？</strong></p>
</li>
<li>
<p><strong>Spring Boot 是如何发现并加载 Starter 的？</strong></p>
</li>
<li>
<p><strong>如果用户自己定义了相同类似的 Bean，你的 Starter 如何处理？</strong></p>
</li>
<li>
<p><strong>Starter 为什么一定要有 enabled 开关？</strong></p>
</li>
<li>
<p><strong>如何避免 Starter 对业务产生侵入？</strong></p>
</li>
<li>
<p><strong>你在写 Starter 时遇到过什么问题？</strong></p>
</li>
<li>
<p><strong>Starter 组件中的 <code>spring.factories</code> 是否有必要存在？为什么？</strong></p>
</li>
</ul>
<p>这些问题的目的并不是刁难人，而是判断：</p>
<blockquote>
<p>你是“用过 Starter”，还是“设计过 Starter”。</p>
</blockquote>
<h2 data-id="heading-9">四、技术能力来自持续学习与拆解优秀项目</h2>
<p>技术能力并不是只靠项目堆出来的。<br/>
<strong>长期在固定模式的项目里，很容易形成技术惰性。</strong></p>
<p>如果想真正理解 Starter、自动装配、组件化设计，<strong>最有效的方式就是看成熟项目的实现</strong>。</p>
<p>比如这个非常值得学习的项目：</p>
<blockquote>
<p><strong>admin4j-framework</strong><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fadmin4j%2Fadmin4j-framework" target="_blank" title="https://github.com/admin4j/admin4j-framework" ref="nofollow noopener noreferrer">github.com/admin4j/adm…</a></p>
</blockquote>
<p>这个项目本身就是一个 <strong>Starter 组件集合</strong>，涵盖了：</p>
<ul>
<li>
<p>安全</p>
</li>
<li>
<p>日志追踪</p>
</li>
<li>
<p>多租户</p>
</li>
<li>
<p>数据脱敏</p>
</li>
<li>
<p>中间件集成</p>
</li>
</ul>
<p>非常适合用来学习：</p>
<ul>
<li>
<p>Starter 的模块拆分方式</p>
</li>
<li>
<p>自动配置的设计思路</p>
</li>
<li>
<p>条件化生效与边界控制</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d519b2016044647afbfe302ca70a2f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766845306&amp;x-signature=LmyW6wzTjJTAQk3GprY8eDpVltY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">五、结语</h2>
<p>Spring Boot Starter 不是一个“高难度技术点”，<br/>
但它是一个<strong>非常好的工程能力分水岭</strong>。</p>
<blockquote>
<p><strong>是否愿意把“用的技术”，变成“可复用的能力”，<br/>
往往决定了一个工程师能走多远。</strong></p>
</blockquote>
<p>如果你记住上面这 6 步，并且自己完整动手实现过一次，<br/>
无论是面试，还是日常架构设计，都会明显不一样。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 大厂的“护城河”，也会成为它们的束缚]]></title>    <link>https://juejin.cn/post/7585485074038145030</link>    <guid>https://juejin.cn/post/7585485074038145030</guid>    <pubDate>2025-12-20T14:46:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585485074038145030" data-draft-id="7585474459776958500" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 大厂的“护城河”，也会成为它们的束缚"/> <meta itemprop="keywords" content="人工智能,创业"/> <meta itemprop="datePublished" content="2025-12-20T14:46:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="飞哥数智谈"/> <meta itemprop="url" content="https://juejin.cn/user/3825956195409223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 大厂的“护城河”，也会成为它们的束缚
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3825956195409223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    飞哥数智谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T14:46:36.000Z" title="Sat Dec 20 2025 14:46:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近，我的一个根深蒂固的认知被轻轻撬动了一下。</p>
<p>长久以来，我一直笃信一个“常识”：<strong>一旦大厂下场做 AI，创业团队基本就凉了</strong>。</p>
<p>理由很朴素——大厂有钱、有人、有数据、有算力，还有现成的用户和生态。它们只要看中某个方向，调集资源一压，创业公司那点微弱的火苗，不是被扑灭，就是被收编。</p>
<p>这种“大厂碾压论”在很多领域都成立，久而久之，我甚至把它当成了默认逻辑。</p>
<p>但前几天看到一个观点，让我愣了一下：</p>
<p>“<strong>大厂有自有模型的优势，但也被自己的模型‘绑架’了。</strong>”</p>
<p>这句话乍听简单，细想却很有嚼头。</p>
<p>比如 <code>OpenAI</code>，哪怕它私下承认 <code>Claude</code> 在某些任务上更稳、推理更清晰、幻觉更少，它也不可能在自家产品里调用 <code>Anthropic</code> 的 <code>API</code>。</p>
<p>不是技术不行，而是身份不允许。</p>
<p>它的整个品牌、叙事、估值，都建立在“我们拥有世界最好的模型”这个前提上。一旦它开始用别人的模型，等于动摇了自己的根基。</p>
<p>而创业团队恰恰相反 —— 它们没有“必须用自己模型”的包袱。谁家模型效果好、成本低、响应快，就用谁的。今天用 GPT，明天切 Claude，后天试试 DeepSeek。</p>
<p>甚至，都可以在一个业务流程的<strong>不同阶段调用不同的模型</strong>，达到各家产品<strong>优势的充分利用</strong>。</p>
<p>换句话说，大厂要证明“我的引擎天下第一”，而创业团队只需回答“这辆车能不能把你安全快速地送到目的地”。</p>
<p>原来不是赛道被封死，而是我看窄了。</p>
<p>大厂忙着造自己的航母，而我们可以自由拼装引擎、船体和导航系统——用最好的零件，造一艘真正服务用户的快艇。</p>
<p>也许，我们还能更快到对岸呢~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React Hooks 深度理解：useState / useEffect 如何管理副作用与内存]]></title>    <link>https://juejin.cn/post/7585484081436033075</link>    <guid>https://juejin.cn/post/7585484081436033075</guid>    <pubDate>2025-12-20T13:32:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585484081436033075" data-draft-id="7585686247270006793" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React Hooks 深度理解：useState / useEffect 如何管理副作用与内存"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2025-12-20T13:32:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="白兰地空瓶"/> <meta itemprop="url" content="https://juejin.cn/user/191753514127514"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React Hooks 深度理解：useState / useEffect 如何管理副作用与内存
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/191753514127514/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    白兰地空瓶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T13:32:06.000Z" title="Sat Dec 20 2025 13:32:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🤯你以为 React Hooks 只是语法糖？</h2>
<h3 data-id="heading-1">不——它们是在帮你对抗「副作用」和「内存泄漏」</h3>
<blockquote>
<p><strong>如果你只把 Hooks 当成“不用 class 了”，<br/>
那你可能只理解了 React 的 10%。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-2">🚀 一、一个“看起来毫无问题”的组件</h3>
<p>我们先从一个你我都写过无数次的组件开始：</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">App</span>() {
  const <span class="hljs-selector-attr">[num, setNum]</span> = <span class="hljs-built_in">useState</span>(<span class="hljs-number">0</span>)

  return (
    &lt;div onClick={() =&gt; <span class="hljs-built_in">setNum</span>(num + <span class="hljs-number">1</span>)}&gt;
      {num}
    &lt;/<span class="hljs-selector-tag">div</span>&gt;
  )
}
</code></pre>
<p>看起来非常完美：</p>
<ul>
<li>✅ 没有 class</li>
<li>✅ 没有 this</li>
<li>✅ 就是一个普通函数</li>
</ul>
<p>但问题是：</p>
<blockquote>
<p><strong>React 为什么要发明 Hooks？</strong><br/>
<strong>useState / useEffect 到底解决了什么“本质问题”？</strong></p>
</blockquote>
<p>答案其实只有一个关键词👇</p>
<hr/>
<h3 data-id="heading-3">💣 二、React 世界的终极敌人：副作用（Side Effect）</h3>
<p>React 背后有一个<strong>很少被明说，但极其重要的信仰</strong>：</p>
<blockquote>
<p><strong>组件 ≈ 纯函数</strong></p>
</blockquote>
<h4 data-id="heading-4">🧠 什么是纯函数？</h4>
<ul>
<li>相同输入 → 永远相同输出</li>
<li>不依赖外部变量</li>
<li>不产生额外影响（I/O、定时器、请求）</li>
</ul>
<pre><code class="hljs language-css" lang="css">function add(<span class="hljs-selector-tag">a</span>, <span class="hljs-selector-tag">b</span>) {
  return <span class="hljs-selector-tag">a</span> + <span class="hljs-selector-tag">b</span>
}
</code></pre>
<p>而理想中的 React 组件是：</p>
<pre><code class="hljs language-perl" lang="perl">(props + <span class="hljs-keyword">state</span>) → JSX
</code></pre>
<blockquote>
<p><strong>React 希望你“只负责算 UI”，<br/>
而不是在渲染时干别的事。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-5">⚠️ 但现实是：你必须干“坏事”</h3>
<p>真实业务中，你不可避免要做这些事：</p>
<ul>
<li>🌐 请求接口</li>
<li>⏱️ 设置定时器</li>
<li>🎧 事件监听</li>
<li>📦 订阅 / 取消订阅</li>
<li>🧱 操作 DOM</li>
</ul>
<p>这些行为有一个共同点👇</p>
<blockquote>
<p>❌ <strong>它们都不是纯函数行为</strong><br/>
✅ <strong>它们都是副作用</strong></p>
</blockquote>
<p>如果你直接把副作用写进组件函数，会发生什么？</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>) <span class="hljs-comment">// ❌</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> /&gt;</span></span>
}
</code></pre>
<p>👉 每一次 render 都请求<br/>
👉 状态更新 → 再 render → 再请求<br/>
👉 <strong>组件直接失控</strong></p>
<hr/>
<h3 data-id="heading-6">🧯 三、useEffect：副作用的“隔离区”</h3>
<p><code>useEffect</code> 的存在，本质只干一件事：</p>
<blockquote>
<p><strong>把副作用从“渲染阶段”挪走</strong></p>
</blockquote>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {
  <span class="hljs-comment">// 副作用逻辑</span>
}, <span class="hljs-selector-attr">[]</span>)
</code></pre>
<p>💡 <strong>一句话理解：</strong></p>
<blockquote>
<p><strong>render 阶段必须纯，<br/>
effect 阶段允许脏。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-7">📦 四、依赖数组不是细节，而是“副作用边界”</h3>
<h4 data-id="heading-8">1️⃣ 只执行一次（挂载）</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {
  console<span class="hljs-selector-class">.log</span>('mounted')
}, <span class="hljs-selector-attr">[]</span>)
</code></pre>
<ul>
<li>只在组件挂载时执行</li>
<li>类似 Vue 的 <code>onMounted</code></li>
</ul>
<hr/>
<h4 data-id="heading-9">2️⃣ 依赖变化才执行</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {
  console<span class="hljs-selector-class">.log</span>(num)
}, <span class="hljs-selector-attr">[num]</span>)
</code></pre>
<ul>
<li><code>num</code> 变化 → 执行</li>
<li>不变 → 不执行</li>
</ul>
<blockquote>
<p><strong>依赖数组的本质是：<br/>
“这个副作用依赖谁？”</strong></p>
</blockquote>
<hr/>
<h4 data-id="heading-10">3️⃣ 不写依赖项？</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'every render'</span>)
})
</code></pre>
<p>👉 每次 render 都执行<br/>
👉 <strong>99% 的时候是性能陷阱</strong></p>
<hr/>
<h3 data-id="heading-11">💥 五、90% 新手都会踩的坑：内存泄漏</h3>
<p>来看一个<strong>极其经典</strong>的 Hooks 错误写法👇</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {
  const timer = <span class="hljs-built_in">setInterval</span>(() =&gt; {
    console<span class="hljs-selector-class">.log</span>(num)
  }, <span class="hljs-number">1000</span>)
}, <span class="hljs-selector-attr">[num]</span>)
</code></pre>
<p>你觉得这段代码有问题吗？</p>
<blockquote>
<p><strong>有，而且非常致命。</strong></p>
</blockquote>
<hr/>
<h4 data-id="heading-12">❌ 问题在哪里？</h4>
<ul>
<li><code>num</code> 每变一次</li>
<li>effect 重新执行</li>
<li>新建一个定时器</li>
<li>❗旧定时器还活着</li>
</ul>
<p>结果就是：</p>
<ul>
<li>⏱️ 定时器越来越多</li>
<li>📈 内存持续上涨</li>
<li>💥 控制台疯狂打印</li>
<li>🧠 <strong>内存泄漏</strong></li>
</ul>
<hr/>
<h3 data-id="heading-13">🧹 六、useEffect return：副作用的“善终机制”</h3>
<p>React 给你准备了一个<strong>官方清理通道</strong>👇</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {
  const timer = <span class="hljs-built_in">setInterval</span>(() =&gt; {
    console<span class="hljs-selector-class">.log</span>(num)
  }, <span class="hljs-number">1000</span>)

  return () =&gt; {
    <span class="hljs-built_in">clearInterval</span>(timer)
  }
}, <span class="hljs-selector-attr">[num]</span>)
</code></pre>
<h4 data-id="heading-14">⚠️ 重点来了</h4>
<blockquote>
<p><strong>return 的函数不是“卸载时才执行”</strong></p>
</blockquote>
<p>而是：</p>
<blockquote>
<p><strong>下一次 effect 执行前，一定会先执行它</strong></p>
</blockquote>
<p>React 内部顺序是这样的：</p>
<ol>
<li>执行上一次 effect 的 cleanup</li>
<li>再执行新的 effect</li>
</ol>
<p>👉 <strong>这就是 Hooks 防内存泄漏的核心设计</strong></p>
<hr/>
<h3 data-id="heading-15">🧠 七、useState：为什么初始化不能异步？</h3>
<p>你在学习 Hooks 时，一定问过这个问题👇</p>
<blockquote>
<p>❓ 我能不能在 useState 初始化时请求接口？</p>
</blockquote>
<pre><code class="hljs language-kotlin" lang="kotlin">useState(async () =&gt; {
  <span class="hljs-keyword">const</span> <span class="hljs-keyword">data</span> = await fetchData()
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">data</span>
})
</code></pre>
<p>答案很干脆：</p>
<blockquote>
<p>❌ <strong>不行</strong></p>
</blockquote>
<hr/>
<h4 data-id="heading-16">🤔 为什么不行？</h4>
<p>因为 React 必须保证：</p>
<ul>
<li>首次 render <strong>立即有确定的 state</strong></li>
<li>异步结果是不确定的</li>
<li>state 一旦初始化，必须是同步值</li>
</ul>
<p>React 允许的只有这种👇</p>
<pre><code class="hljs language-css" lang="css">useState(() =&gt; {
  const <span class="hljs-selector-tag">a</span> = <span class="hljs-number">1</span> + <span class="hljs-number">2</span>
  const <span class="hljs-selector-tag">b</span> = <span class="hljs-number">2</span> + <span class="hljs-number">3</span>
  return <span class="hljs-selector-tag">a</span> + <span class="hljs-selector-tag">b</span>
})
</code></pre>
<p>💡 这叫 <strong>惰性初始化</strong><br/>
💡 但前提是：<strong>同步 + 纯函数</strong></p>
<hr/>
<h3 data-id="heading-17">🌐 八、那异步请求到底该写哪？</h3>
<p>答案只有一个地方：</p>
<blockquote>
<p><strong>useEffect</strong></p>
</blockquote>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {
  async function <span class="hljs-built_in">query</span>() {
    const data = await <span class="hljs-built_in">queryData</span>()
    <span class="hljs-built_in">setNum</span>(data)
  }
  <span class="hljs-built_in">query</span>()
}, <span class="hljs-selector-attr">[]</span>)
</code></pre>
<p>🎯 <strong>这是 React 官方推荐模式</strong></p>
<ul>
<li>state 初始化 → 确定</li>
<li>异步请求 → 副作用</li>
<li>数据回来 → 更新状态</li>
</ul>
<hr/>
<h3 data-id="heading-18">🔄 九、为什么 setState 可以传函数？</h3>
<pre><code class="hljs language-ini" lang="ini">setNum(<span class="hljs-attr">prev</span> =&gt; prev + <span class="hljs-number">1</span>)
</code></pre>
<p>这不是“花里胡哨”，而是<strong>并发安全设计</strong>。</p>
<p>React 内部可能会：</p>
<ul>
<li>合并多次更新</li>
<li>延迟执行 setState</li>
</ul>
<p>如果你直接用 <code>num + 1</code>，很可能拿到的是旧值。</p>
<blockquote>
<p><strong>函数式 setState = 永远安全</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-19">🏁 十、Hooks 的真正价值（总结）</h3>
<p>如果你只把 Hooks 当成：</p>
<blockquote>
<p>“不用写 class 了”</p>
</blockquote>
<p>那你只看到了表面。</p>
<h4 data-id="heading-20">Hooks 真正解决的是：</h4>
<ul>
<li>🧩 <strong>状态如何在函数中稳定存在</strong></li>
<li>🧯 <strong>副作用如何被精确控制</strong></li>
<li>🧠 <strong>生命周期如何显式建模</strong></li>
<li>🔒 <strong>内存泄漏如何被主动规避</strong></li>
</ul>
<hr/>
<h3 data-id="heading-21">✨ 最后的掘金金句</h3>
<blockquote>
<p><strong>useState 解决的是：数据如何“活着”</strong><br/>
<strong>useEffect 解决的是：副作用如何“善终”</strong></p>
<p>React Hooks 不只是语法升级，<br/>
而是一场从“命令式生命周期”<br/>
到“声明式副作用管理”的革命。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI Agent 介绍]]></title>    <link>https://juejin.cn/post/7585458459166359586</link>    <guid>https://juejin.cn/post/7585458459166359586</guid>    <pubDate>2025-12-20T12:18:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585458459166359586" data-draft-id="7585476892976070690" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI Agent 介绍"/> <meta itemprop="keywords" content="前端,后端,人工智能"/> <meta itemprop="datePublished" content="2025-12-20T12:18:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="子洋"/> <meta itemprop="url" content="https://juejin.cn/user/1099167359835015"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI Agent 介绍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1099167359835015/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    子洋
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T12:18:00.000Z" title="Sat Dec 20 2025 12:18:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{font-family:-apple-system,BlinkMacSystemFont,PingFang SC,Helvetica Neue,Helvetica,Arial,sans-serif;word-break:break-word;line-height:1.75;font-weight:200;font-size:16px;overflow-x:hidden;color:#666;letter-spacing:.5px}.markdown-body a{text-decoration:none;color:#0064c8;position:relative}.markdown-body a:after{content:"";position:absolute;bottom:-2px;left:0;width:100%;height:1px;background-color:rgba(0,100,200,.7);transform:scale(0);transition:all .4s ease-in-out}.markdown-body a:link:hover:after{transform:scale(1)}.markdown-body code{padding:2px 4px;font-size:.9em;font-family:Menlo,Monaco,Consolas,Courier New,monospace;border-radius:2px;background-color:rgba(0,46,70,.0431);color:#39f}.markdown-body strong{font-weight:400}.markdown-body em{color:#ff6a00}.markdown-body del,.markdown-body s{color:#bbb}.markdown-body small{font-size:.8em;color:#bbb}.markdown-body kbd{margin:0 .1em;padding:5px 8px 3px;border:1px solid #d1d5d9;border-radius:3px;box-shadow:0 1px 0 0 #e3e4e6,inset 0 0 0 2px #fff;background-color:#eee;font-weight:600;font-size:.8em;font-family:Arial,Helvetica Neue,Helvetica,sans-serif;white-space:nowrap;color:#666}.markdown-body kbd:first-child{margin-left:0}.markdown-body kbd:last-child{margin-right:0}.markdown-body img{display:block;border:0;max-width:calc(100% - 20px);min-width:20px;min-height:20px;margin:0 10px;box-shadow:0 2px 8px 2px rgba(0,0,0,.2);transition:all .25s ease-in-out}.markdown-body img:hover{transform:translateY(-4px)}.markdown-body blockquote,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{line-height:inherit;font-size:inherit;color:inherit}.markdown-body blockquote:first-child,.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child,.markdown-body ol:first-child,.markdown-body p:first-child,.markdown-body pre:first-child,.markdown-body table:first-child,.markdown-body ul:first-child{margin-top:0}.markdown-body blockquote:last-child,.markdown-body h1:last-child,.markdown-body h2:last-child,.markdown-body h3:last-child,.markdown-body h4:last-child,.markdown-body h5:last-child,.markdown-body h6:last-child,.markdown-body ol:last-child,.markdown-body p:last-child,.markdown-body pre:last-child,.markdown-body table:last-child,.markdown-body ul:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:1.6em 0 .6em;color:#333;font-weight:400;position:relative}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{position:absolute;left:-2em}.markdown-body h1{font-size:1.75em}.markdown-body h1:before{content:"#"}.markdown-body h1:first-child{margin-top:0}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.35em}.markdown-body h4{font-size:1.2em}.markdown-body h5{font-size:1.1em}.markdown-body h6{font-size:1em}.markdown-body blockquote,.markdown-body ol,.markdown-body pre,.markdown-body table,.markdown-body ul{margin:1em 0}.markdown-body p{margin:.7em 0;word-break:break-word}.markdown-body pre{padding:8px 12px;color:#666;background-color:rgba(0,46,70,.0431);border:1px solid #ebebeb;tab-size:4;white-space:pre-wrap;line-height:1.4}.markdown-body pre code{color:inherit;background-color:transparent;padding:0}.markdown-body ol,.markdown-body ul{margin:1em 0 1em 2em;padding:0;line-height:1.5!important;font-size:inherit;color:inherit}.markdown-body ol:first-child,.markdown-body ul:first-child{margin-top:0}.markdown-body ol:last-child,.markdown-body ul:last-child{margin-bottom:0}.markdown-body ol li,.markdown-body ul li{margin:.5em 0;list-style:inherit}.markdown-body ul{list-style:disc outside}.markdown-body ul ul{list-style-type:circle}.markdown-body ul ul ul{list-style-type:square}.markdown-body ol{list-style:decimal outside}.markdown-body ol ol{list-style-type:lower-alpha}.markdown-body ol ol ol{list-style-type:lower-roman}.markdown-body blockquote{font-size:.9em;padding:8px 20px 8px 15px;color:#666;border-left:5px solid rgba(0,100,200,.7);background-color:rgba(0,100,200,.1)}.markdown-body table{border-collapse:collapse;border-spacing:0;max-width:100%;min-width:50%;word-wrap:break-word;color:inherit}.markdown-body table thead tr{background-color:#f4f6f7}.markdown-body table td,.markdown-body table th{padding:4px 16px;font-size:.95em;text-align:left;color:inherit;border:0;min-width:72px}.markdown-body table td[align=center],.markdown-body table th[align=center]{text-align:center}.markdown-body table td[align=right],.markdown-body table th[align=right]{text-align:right}.markdown-body table th{border-bottom:2px solid #e3e4e6;color:#333;font-weight:400;white-space:nowrap}.markdown-body table td{border-bottom:1px solid #ebebeb}.markdown-body hr{margin:1.5em 0;padding:0;border:0;background:linear-gradient(90deg,rgba(0,46,70,.0431),#ebebeb 50%,rgba(0,46,70,.0431));height:1px}.markdown-body br{content:"";display:block}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">前言</h2>
<p>这周在组内做了一次关于 <strong>Agent 设计模式</strong> 的分享，主要介绍和讲解了 <strong>ReAct 模式</strong> 与 <strong>P&amp;A（Plan and Execute）模式</strong>。我计划将这次分享拆分为三篇文章，对我在组会中讲解的内容进行更加系统和细致的整理。</p>
<p>在正式进入具体的 Agent 模式实现之前，有一个绕不开的问题需要先回答清楚：</p>
<blockquote>
<p><strong>什么是 AI Agent？它解决了什么问题？以及在近几年 AI 技术与应用快速演进的过程中，AI 应用的开发范式经历了哪些关键变化？</strong></p>
</blockquote>
<p>这一篇将不直接展开某一种 Agent 模式的实现细节，而是先回到更宏观的视角，从 <strong>AI 应用形态与工程范式的演进</strong> 入手，梳理 Agent 出现的技术背景与必然性。</p>
<p>需要说明的是，下文对 AI 应用演进阶段的划分，是一种<strong>以“应用开发范式”为核心的抽象总结</strong>。真实的技术演进在时间上存在明显重叠，但这种阶段化的叙述有助于我们理解：<strong>为什么 Agent 会在当下成为主流方向</strong>。</p>
<h2 data-id="heading-1">AI 应用的发展历程</h2>
<h3 data-id="heading-2">第一阶段：提示词工程</h3>
<p>2022 年 11 月，GPT-3.5 发布后，大模型开始从研究领域进入大众视野。对开发者来说，这是第一次可以在实际产品中直接使用通用语言模型。</p>
<p>这一阶段的 AI 应用形态非常简单，大多数产品本质上都是一个对话界面：<code>用户输入问题</code> → <code>模型生成回答</code> → <code>结束</code>。</p>
<p>很快，围绕 Prompt 的工程实践开始出现。由于模型对上下文非常敏感，<strong>系统提示词（System Prompt）成为当时最直接、也最有效的控制手段</strong>。常见的做法是通过提示词约束模型的角色、输出形式和关注重点，例如：</p>
<blockquote>
<p>“你是一个资深的前端开发工程师，请严格以 JSON 格式输出结果……”</p>
</blockquote>
<p>这类“身份面具”式的提示，本质上是通过上下文约束来减少模型输出的发散性，让结果更贴近预期。在这一阶段，也陆续出现了 <strong>Chain-of-Thought、Few-shot Prompting</strong> 等推理增强技巧，但它们依然属于<strong>单次生成模式</strong>：模型在一次调用中完成全部推理，过程中无法获得外部反馈，也无法根据中间结果调整策略。</p>
<h3 data-id="heading-3">第二阶段：RAG</h3>
<p>当 AI 开始被用于真实业务场景时，很快暴露出两个问题：<strong>模型不了解私有知识</strong>，以及<strong>生成结果难以校验</strong>。以 GPT-3.5 为例，它的训练数据截止在 21 年左右，对于新技术以及企业内部文档、业务规则更是不了解，直接使用往往不可控。</p>
<p>RAG（Retrieval-Augmented Generation）是在这种背景下被广泛采用的方案。它的核心做法是：</p>
<ul>
<li>将私有知识进行切分和向量化存储；</li>
<li>用户提问时，先进行相似度检索；</li>
<li>将命中的内容作为上下文提供给模型，再由模型完成生成。</li>
</ul>
<p>通过这种方式，模型不需要记住所有知识，而是在生成时按需获取参考信息。</p>
<p>RAG 的价值不仅在于补充新知识，更重要的是带来了<strong>可控性和可追溯性</strong>：生成内容可以明确对应到原始文档，这一点在企业场景中尤为关键。</p>
<h3 data-id="heading-4">第三阶段：Tool Calling</h3>
<p>如果说 RAG 让模型能够“查资料”，那么 <strong>Function / Tool Calling</strong> 则让模型开始能够“做事情”。</p>
<p>在这一阶段，开发者会把可用能力（如查询数据库、调用接口、执行脚本）以结构化的方式提供给模型，包括函数名、参数说明和功能描述。模型在理解用户意图后，可以返回一个明确的工具调用请求，再由程序完成实际执行。</p>
<p>这一能力的出现，标志着 <strong>AI 第一次在工程上具备了可靠调用外部系统的能力</strong>。它不再只是一个聊天机器人，而是一个可以触发真实世界动作的“控制器”，这也是后续 Agent 能够落地的关键技术支撑。</p>
<h3 data-id="heading-5">第四阶段：AI Workflow</h3>
<p>当 RAG 能力和 Tool Calling 能力逐渐成熟后，开发者开始尝试把多个步骤组合起来，形成完整的业务流程。这催生了以 Dify、Coze 为代表的 <strong>AI Workflow</strong> 范式。</p>
<p>在 Workflow 模式下，一个 AI 应用会被拆解为多个固定节点，并按照预设顺序执行，例如：检索 → 判断 → 工具调用 → 汇总输出。</p>
<p>Workflow 的优势非常明显：</p>
<ul>
<li>流程清晰，行为可预期；</li>
<li>易于测试和运营；</li>
<li>对非工程人员友好。</li>
</ul>
<p>但问题也同样明显：流程完全由人设计，模型只是执行者。无论问题复杂与否，都必须走完整条路径。这种方式在应对高度动态或非标准任务时，灵活性有限。</p>
<h3 data-id="heading-6">第五阶段：Agent</h3>
<p>在 Agent 出现之前，大多数 AI 应用仍然遵循一种典型模式：<code>输入</code> → <code>单次/编排好的推理</code> → <code>输出</code>。</p>
<p>而 Agent 的出现，本质上是<strong>将“任务编排”的控制权从人类手中交还给了 AI</strong>。在 Agent 架构下，AI 不再是被动执行一段代码，而是一个具备以下核心能力的闭环系统：</p>
<ul>
<li>将复杂目标拆解为多个可执行步骤；</li>
<li>根据工具执行结果调整后续行动；</li>
<li>在失败时尝试修正策略；</li>
<li>在多步过程中维护上下文状态。</li>
</ul>
<p>这些能力并不是一次模型调用完成的，而是通过多轮推理与执行形成闭环。也正是在这一点上，Agent 与前面的应用形态拉开了差距。</p>
<h2 data-id="heading-7">Agent 设计模式解决的问题</h2>
<p>当 Agent 开始承担更复杂的任务时，问题也随之出现：</p>
<ul>
<li>多步推理容易跑偏；</li>
<li>执行失败后缺乏统一的修正策略；</li>
<li>成本和稳定性难以控制。</li>
</ul>
<p><strong>Agent 设计模式的作用，就是把这些反复出现的问题抽象成可复用的结构。</strong></p>
<p>无论是 <strong>ReAct</strong>，还是 <strong>Plan and Execute</strong>，它们关注的核心并不是“让模型更聪明”，而是：<strong>如何在工程上组织模型的推理、行动和反馈过程，使系统整体可控、可维护。</strong></p>
<p>理解这些模式，有助于我们在构建 Agent 系统时少走弯路，而不是每一次都从零开始设计整套交互与控制逻辑。</p>
<h2 data-id="heading-8">结语</h2>
<p>从最初基于 Prompt 的简单对话，到如今具备一定自主能力的 Agent，我们看到的不只是模型能力的提升，更是 AI 在实际使用方式上的变化。</p>
<p>回顾整个过程会发现，很多关键技术并不是最近才出现的。RAG 的核心思路早在几年前就已经被提出，ReAct 也并非新概念，只是在最近随着模型推理能力提升、工具链逐渐成熟，才真正具备了工程落地的条件。很多时候，并不是想法不存在，而是时机还没到。</p>
<p>理解这些演进背景，有助于我们判断哪些能力是短期噱头，哪些是长期方向。下一篇文章将聚焦 Agent 设计模式中最常见、也最实用的 ReAct 模式，结合实际实现，看看它是如何让 AI 在执行任务的过程中逐步思考、不断调整策略的。</p>
<h2 data-id="heading-9">参考资料</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.promptingguide.ai%2F" target="_blank" title="https://www.promptingguide.ai/" ref="nofollow noopener noreferrer">提示工程指南</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bohrium.com%2Fpaper%2Fread%3FlibraryId%3D8578838" target="_blank" title="https://www.bohrium.com/paper/read?libraryId=8578838" ref="nofollow noopener noreferrer">Chain-of-Thought Prompting Elicits Reasoning in Large Language Models.</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bohrium.com%2Fpaper%2Fread%3FlibraryId%3D8579062" target="_blank" title="https://www.bohrium.com/paper/read?libraryId=8579062" ref="nofollow noopener noreferrer">Language Models are Few-Shot Learners</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bohrium.com%2Fpaper%2Fread%3FlibraryId%3D8578906%26activeReadTab%3Dchat" target="_blank" title="https://www.bohrium.com/paper/read?libraryId=8578906&amp;activeReadTab=chat" ref="nofollow noopener noreferrer">Retrieval-Augmented Generation for Knowledge-Intensive NLP Tasks.</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bohrium.com%2Fpaper%2Fread%3FlibraryId%3D8578958%26activeReadTab%3Dchat" target="_blank" title="https://www.bohrium.com/paper/read?libraryId=8578958&amp;activeReadTab=chat" ref="nofollow noopener noreferrer">Toolformer: Language Models Can Teach Themselves to Use Tools.</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bohrium.com%2Fpaper%2Fread%3FlibraryId%3D8578981" target="_blank" title="https://www.bohrium.com/paper/read?libraryId=8578981" ref="nofollow noopener noreferrer">A Survey on Large Language Model based Autonomous Agents.</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【节点】[LinearToGammaSpaceExact节点]原理解析与实际应用]]></title>    <link>https://juejin.cn/post/7585484081435639859</link>    <guid>https://juejin.cn/post/7585484081435639859</guid>    <pubDate>2025-12-20T11:07:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585484081435639859" data-draft-id="7585463258691174409" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【节点】[LinearToGammaSpaceExact节点]原理解析与实际应用"/> <meta itemprop="keywords" content="游戏开发,图形学,Unity3D"/> <meta itemprop="datePublished" content="2025-12-20T11:07:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SmalBox"/> <meta itemprop="url" content="https://juejin.cn/user/2218166695237532"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【节点】[LinearToGammaSpaceExact节点]原理解析与实际应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2218166695237532/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SmalBox
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T11:07:21.000Z" title="Sat Dec 20 2025 11:07:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13074589.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13074589%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13074589.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13074589&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【Unity Shader Graph 使用与特效实现】</a><strong>专栏-直达</strong></p>
</blockquote>
<h2 data-id="heading-0">线性颜色空间与伽马颜色空间基础概念</h2>
<p>在计算机图形学中，颜色空间的管理是渲染流程中至关重要的环节。理解线性颜色空间和伽马颜色空间的区别对于创建逼真的渲染效果至关重要。</p>
<p>线性颜色空间指的是颜色数值与实际物理光强呈线性关系的颜色表示方式。在这种空间中，颜色值0.5表示的光强正好是颜色值1.0的一半。这种表示方式符合物理世界的真实光照行为，在渲染计算中能够产生准确的数学结果。</p>
<p>伽马颜色空间则是为了适应传统显示设备的非线性特性而设计的颜色表示系统。由于CRT显示器以及其他显示设备对输入信号的响应不是线性的，实际上显示设备会对输入信号进行伽马变换。在伽马空间中，颜色数值与最终显示的亮度之间不是简单的线性关系，而是遵循一个幂函数关系。</p>
<h3 data-id="heading-1">伽马校正的历史背景</h3>
<p>伽马校正的概念起源于早期的CRT显示器时代。CRT显示器具有固有的非线性响应特性，其亮度输出与输入电压之间的关系大致符合幂函数规律，指数约为2.2。这意味着即使输入线性的颜色信号，显示器也会自动应用一个近似的伽马变换。</p>
<p>为了补偿这种非线性，图像和视频内容在创建时就会预先应用一个反向的伽马变换（指数约为1/2.2），这样当内容在显示器上显示时，两者的变换相互抵消，最终用户看到的就是正确的线性亮度关系。这种预处理过程就是所谓的伽马校正。</p>
<h3 data-id="heading-2">现代渲染中的伽马处理</h3>
<p>在现代渲染管线中，虽然CRT显示器已逐渐被LCD、OLED等新技术取代，但伽马校正的概念仍然非常重要。主要原因包括：</p>
<ul>
<li>向后兼容性：大量现有的图像内容和标准都是基于伽马空间设计的</li>
<li>感知均匀性：人类视觉系统对亮度的感知也是非线性的，伽马编码可以更有效地利用有限的比特深度</li>
<li>行业标准：sRGB等现代颜色标准仍然建立在伽马编码的基础上</li>
</ul>
<h2 data-id="heading-3">LinearToGammaSpaceExact节点核心功能</h2>
<p>LinearToGammaSpaceExact节点是Unity URP Shader Graph中专门用于颜色空间转换的工具节点。该节点执行从线性颜色空间到伽马颜色空间的精确数学转换，确保颜色数据在不同空间之间的准确转换。</p>
<h3 data-id="heading-4">数学原理</h3>
<p>LinearToGammaSpaceExact节点实现的数学转换基于标准的sRGB伽马校正公式。转换过程使用分段函数来精确处理整个数值范围：</p>
<p>对于输入值小于或等于0.0031308的情况：</p>
<pre><code class="hljs">伽马值 = 12.92 × 线性值
</code></pre>
<p>对于输入值大于0.0031308的情况：</p>
<pre><code class="hljs language-scss" lang="scss">伽马值 = <span class="hljs-number">1.055</span> × 线性值^(<span class="hljs-number">1</span>/<span class="hljs-number">2.4</span>) - <span class="hljs-number">0.055</span>
</code></pre>
<p>这种分段处理确保了在低亮度区域的线性关系和较高亮度区域的幂函数关系之间的平滑过渡，符合sRGB标准规范。</p>
<h3 data-id="heading-5">与近似方法的区别</h3>
<p>Unity提供了两种伽马转换方法：LinearToGammaSpaceExact和LinearToGammaSpace。两者的主要区别在于精度和性能：</p>
<ul>
<li>LinearToGammaSpaceExact：使用精确的sRGB转换公式，计算结果准确但计算量稍大</li>
<li>LinearToGammaSpace：使用近似的转换公式（通常为线性值^(1/2.2)），计算速度快但精度略低</li>
</ul>
<p>在大多数情况下，两种方法的视觉差异不大，但在需要严格颜色准确性的场景中（如专业图像处理、颜色分级等），应优先使用Exact版本。</p>
<h2 data-id="heading-6">节点接口详解</h2>
<p><img src="https://docs.unity.cn/cn/Packages-cn/com.unity.shadergraph@14.0/manual/images/LinearToGammaSpaceExactNodeThumb.png" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">输入端口</h3>
<p>In输入端口接收Float类型的数值，代表线性颜色空间中的颜色分量。该端口可以接受以下类型的数值：</p>
<ul>
<li>单个浮点数值：表示单颜色通道的线性值</li>
<li>二维向量：表示两个颜色通道的线性值</li>
<li>三维向量：表示RGB颜色的线性值</li>
<li>四维向量：表示RGBA颜色的线性值，包括透明度</li>
</ul>
<p>输入值的有效范围通常是[0,1]，但节点也可以处理超出此范围的HDR值，转换时会保持数值的相对关系。</p>
<h3 data-id="heading-8">输出端口</h3>
<p>Out输出端口返回转换后的Float类型数值，表示伽马颜色空间中的颜色分量。输出值的范围与输入相对应：</p>
<ul>
<li>对于标准范围[0,1]的输入，输出也在[0,1]范围内</li>
<li>对于HDR值（大于1），输出会保持相应的相对亮度关系</li>
</ul>
<p>输出数据类型与输入保持一致，如果输入是向量类型，输出也是相应的向量类型，每个分量都独立进行伽马转换。</p>
<h2 data-id="heading-9">实际应用场景</h2>
<h3 data-id="heading-10">后处理效果中的颜色校正</h3>
<p>在后处理渲染中，LinearToGammaSpaceExact节点常用于将线性空间的计算结果转换为适合显示的伽马空间。例如，在实现色彩分级、色调映射或Bloom效果时：</p>
<ul>
<li>在色调映射过程中，首先在线性空间中进行亮度压缩和颜色调整</li>
<li>使用LinearToGammaSpaceExact将结果转换到伽马空间</li>
<li>最终输出到屏幕缓冲区，确保显示设备能正确呈现</li>
</ul>
<p>这种工作流程保证了颜色处理的准确性，避免了因颜色空间不匹配导致的颜色失真。</p>
<h3 data-id="heading-11">UI元素与渲染结果的混合</h3>
<p>当需要将3D渲染结果与UI元素结合时，正确管理颜色空间至关重要：</p>
<ul>
<li>3D渲染通常在线性空间中进行计算</li>
<li>UI元素和纹理通常存储在伽马空间中</li>
<li>使用LinearToGammaSpaceExact可以将渲染结果转换到与UI一致的颜色空间</li>
<li>确保混合后的视觉效果颜色一致，没有明显的界限或差异</li>
</ul>
<h3 data-id="heading-12">自定义光照模型开发</h3>
<p>在开发自定义光照模型时，正确管理颜色空间是保证光照计算准确性的关键：</p>
<ul>
<li>光照计算在线性空间中执行，符合物理规律</li>
<li>使用LinearToGammaSpaceExact将最终光照结果转换到显示空间</li>
<li>确保光照的亮度和颜色关系在显示时保持正确</li>
</ul>
<p>特别是在实现复杂的PBR材质时，颜色空间的正确转换对于金属度、粗糙度等参数的准确表现尤为重要。</p>
<h2 data-id="heading-13">使用示例与案例分析</h2>
<h3 data-id="heading-14">基础颜色空间转换</h3>
<p>以下是一个简单的Shader Graph设置，演示如何使用LinearToGammaSpaceExact节点进行基本的颜色空间转换：</p>
<ul>
<li>创建Color节点作为线性空间的颜色输入</li>
<li>将Color节点连接到LinearToGammaSpaceExact节点的In端口</li>
<li>将LinearToGammaSpaceExact节点的Out端口连接到主节点的Base Color输入</li>
<li>通过调节输入颜色，观察转换前后颜色的变化</li>
</ul>
<p>这种基础设置可以帮助理解线性空间与伽马空间之间颜色表现的差异，特别是在中等亮度区域，差异最为明显。</p>
<h3 data-id="heading-15">HDR颜色处理案例</h3>
<p>在处理高动态范围颜色时，LinearToGammaSpaceExact节点的行为值得特别关注：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 假设在线性空间中有以下HDR颜色值</span>
float3 linearColor = <span class="hljs-built_in">float3</span>(<span class="hljs-number">2.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">0.5</span>);

<span class="hljs-comment">// 应用LinearToGammaSpaceExact转换</span>
float3 gammaColor = <span class="hljs-built_in">LinearToGammaSpaceExact</span>(linearColor);

<span class="hljs-comment">// 结果会保持相对的亮度关系</span>
<span class="hljs-comment">// 但数值可能超出标准[0,1]范围</span>
</code></pre>
<p>在实际应用中，通常会在伽马转换前先进行色调映射，将HDR值压缩到显示设备能够处理的范围内。</p>
<h3 data-id="heading-16">自定义后处理效果实现</h3>
<p>下面是一个实现简单颜色分级效果的Shader Graph示例：</p>
<ul>
<li>使用Scene Color节点获取当前渲染的线性空间颜色</li>
<li>应用颜色调整节点（如对比度、饱和度、色相调整）</li>
<li>所有调整在线性空间中执行，保证计算准确性</li>
<li>使用LinearToGammaSpaceExact节点将结果转换到伽马空间</li>
<li>输出到Blit命令或后处理堆栈</li>
</ul>
<p>这种方法确保了颜色调整的物理准确性，避免了在伽马空间中进行调整可能引入的数学错误。</p>
<h2 data-id="heading-17">性能考量与优化建议</h2>
<h3 data-id="heading-18">计算开销分析</h3>
<p>LinearToGammaSpaceExact节点的计算开销主要来自幂函数计算和条件判断。虽然单个节点的开销不大，但在像素着色器中大量使用时仍需注意：</p>
<ul>
<li>每个像素至少需要执行一次条件判断和一次幂运算</li>
<li>在高分辨率渲染中，这些操作会累积成可观的计算量</li>
<li>在移动平台或性能受限的环境中应谨慎使用</li>
</ul>
<h3 data-id="heading-19">优化策略</h3>
<p>针对性能敏感的场景，可以考虑以下优化策略：</p>
<ul>
<li>在顶点着色器中进行转换：如果颜色数据在顶点间变化不大，可以在顶点阶段进行转换</li>
<li>使用近似版本：在视觉要求不高的场景中，使用LinearToGammaSpace替代Exact版本</li>
<li>批量处理：将多个颜色通道的转换合并处理，减少条件判断次数</li>
<li>LUT优化：对于固定的颜色转换，可以使用查找表替代实时计算</li>
</ul>
<h3 data-id="heading-20">平台特异性考虑</h3>
<p>不同硬件平台对超越函数（如幂运算）的支持程度不同：</p>
<ul>
<li>现代桌面GPU通常有专门的硬件单元处理这类运算，效率较高</li>
<li>移动GPU可能通过软件模拟，效率相对较低</li>
<li>在针对多平台开发时，应测试目标平台的性能表现</li>
</ul>
<h2 data-id="heading-21">常见问题与解决方案</h2>
<h3 data-id="heading-22">颜色显示不一致问题</h3>
<p>在使用LinearToGammaSpaceExact节点时，可能会遇到颜色显示不一致的问题：</p>
<ul>
<li>问题表现：在不同设备或不同查看条件下颜色显示有差异</li>
<li>可能原因：颜色空间配置错误、显示器校准不一致、图像格式不匹配</li>
<li>解决方案：确保整个渲染管线颜色空间设置一致，使用标准颜色配置文件，定期校准显示设备</li>
</ul>
<h3 data-id="heading-23">性能瓶颈识别与解决</h3>
<p>如果发现使用LinearToGammaSpaceExact节点后性能下降：</p>
<ul>
<li>使用Unity Profiler分析着色器执行时间</li>
<li>检查是否在不需要精确转换的地方使用了Exact版本</li>
<li>考虑将转换移到渲染管线的后期阶段，减少重复计算</li>
<li>评估是否可以使用更简化的颜色空间处理方案</li>
</ul>
<h3 data-id="heading-24">HDR与LDR工作流切换</h3>
<p>在HDR和LDR渲染管线之间切换时，颜色空间处理需要特别注意：</p>
<ul>
<li>HDR管线通常在线性空间中处理更多计算</li>
<li>LDR管线可能混合使用线性和伽马空间</li>
<li>使用LinearToGammaSpaceExact节点时应明确当前的颜色空间状态</li>
<li>建立统一的颜色空间管理策略，确保在不同管线间的一致性</li>
</ul>
<h2 data-id="heading-25">最佳实践总结</h2>
<p>正确使用LinearToGammaSpaceExact节点需要遵循一系列最佳实践：</p>
<ul>
<li>始终了解数据当前所处的颜色空间，在线性空间中进行光照和颜色计算</li>
<li>仅在最终输出到屏幕或非浮点格式纹理时进行伽马转换</li>
<li>在需要最高颜色准确性的场景中使用Exact版本，其他情况可考虑使用近似版本</li>
<li>建立项目统一的颜色空间管理规范，避免混乱的颜色空间使用</li>
<li>定期测试在不同显示设备上的颜色表现，确保一致性</li>
<li>文档化颜色空间决策，便于团队协作和后续维护</li>
</ul>
<p>通过遵循这些实践原则，可以确保渲染结果的视觉准确性，同时在性能和画质之间取得良好平衡。LinearToGammaSpaceExact节点作为颜色管理工具箱中的重要组件，在正确的使用场景下能够显著提升渲染质量。</p>
<hr/>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13074589.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13074589%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13074589.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13074589&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【Unity Shader Graph 使用与特效实现】</a><strong>专栏-直达</strong>
（欢迎<em>点赞留言</em>探讨，更多人加入进来能更加完善这个探索的过程，🙏）</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[15 Go Eino AI应用开发实战 | 性能优化]]></title>    <link>https://juejin.cn/post/7585468725332475958</link>    <guid>https://juejin.cn/post/7585468725332475958</guid>    <pubDate>2025-12-20T09:57:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585468725332475958" data-draft-id="7585474459776450596" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="15 Go Eino AI应用开发实战 | 性能优化"/> <meta itemprop="keywords" content="后端,面试,Go"/> <meta itemprop="datePublished" content="2025-12-20T09:57:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="王中阳讲AI编程"/> <meta itemprop="url" content="https://juejin.cn/user/2189882892232029"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            15 Go Eino AI应用开发实战 | 性能优化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2189882892232029/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    王中阳讲AI编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T09:57:57.000Z" title="Sat Dec 20 2025 09:57:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;font-weight:400;line-height:2;font-size:17px;overflow-x:hidden;color:#000}.markdown-body strong{padding:1px;color:#ee3f4d}.markdown-body em{padding:0 2px;color:#f33b1f}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:30px;margin-bottom:20px;line-height:1.5;font-weight:700}.markdown-body h1{text-align:center;padding-bottom:5px;font-size:32px;color:#ac1f18}.markdown-body h1:after{content:"";display:block;margin:4px auto 0;width:100px;height:2px;border-bottom:2px solid #f33b1f}.markdown-body h2{font-size:28px;border-bottom:1px solid #f33b1f}.markdown-body h2:before{content:"# "!important;color:#f33b1f}.markdown-body h3{font-size:24px;padding-left:9px;border-left:6px solid #f33b1f}.markdown-body h4{font-size:20px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #bbb;margin:16px 0}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f9f1db;color:#ee2746;border-radius:2px;font-size:16px;padding:1px 2px}.markdown-body code,.markdown-body pre{font-family:-apple-system,-apple-system-body,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,PingFang SC,思源黑体 CN,思源黑体,JetBrains Mono,Fira Code,Menlo,Ubuntu Mono,Consolas,sans-serif}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{margin:12px 0!important;border-radius:3px;font-size:15px;padding:16px 12px;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f7f7f7}.markdown-body a{text-decoration:none;color:#1781b5;padding:0 2px;border-bottom:1px solid #1781b5}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #f33b1f;color:#ac1f18}.markdown-body blockquote{color:#3d3d3d;background-color:#fff9f9;padding:6px 16px;margin:16px 0;border-left:3px solid #f07c82}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:6px 0}.markdown-body ol,.markdown-body ul{padding-left:30px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:6px}.markdown-body ol li{padding-left:6px}.markdown-body ::marker{color:#f33b1f}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body .task-list-item input[type=checkbox]{position:relative}.markdown-body .task-list-item input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:#fff;border:1px solid #f07c82;border-radius:3px;box-sizing:border-box;z-index:1}.markdown-body .task-list-item input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-5px;left:0;right:0;bottom:0;width:0;height:0;color:#f33b1f;font-size:16px;font-weight:700;z-index:2}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table thead{background:#fff9f9;color:#000;text-align:left;font-size:15px}.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table tr:hover{background-color:#fff9f9}.markdown-body table td,.markdown-body table th{padding:12px 7px;line-height:24px;border:1px solid #f9f1db}.markdown-body table td{min-width:120px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><blockquote>
<p>声明：本AI应用开发系列教程首发在同名公众号：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F5DYsyMKh9cDJdVvs_Mn9_Q" target="_blank" title="https://mp.weixin.qq.com/s/5DYsyMKh9cDJdVvs_Mn9_Q" ref="nofollow noopener noreferrer">王中阳</a>，未经授权禁止转载。</p>
</blockquote>
<p>Go-Eino Interview Agent 平台的性能优化专注于实现高吞吐量、低延迟和高效资源利用，涵盖数据库连接、缓存策略、消息队列和向量搜索操作。这种综合方法确保系统能够处理并发面试会话，同时保持响应式 AI 交互。</p>
<h2 data-id="heading-0">数据库连接池优化</h2>
<p>数据库层采用复杂的连接池技术来高效管理 MySQL 连接。系统使用 GORM 配合优化的连接参数，平衡资源使用与性能需求。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 来自 database.go 的连接池配置</span>
sqlDB.SetMaxIdleConns(dbConfig.MaxIdleConns)
sqlDB.SetMaxOpenConns(dbConfig.MaxOpenConns)
<span class="hljs-keyword">if</span> dbConfig.ConnMaxLifetime != <span class="hljs-string">""</span> {
    connMaxLifetime, err := time.ParseDuration(dbConfig.ConnMaxLifetime)
    <span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> {
        sqlDB.SetConnMaxLifetime(connMaxLifetime)
    }
}
</code></pre>
<p>该配置支持通过 YAML 配置文件动态调整连接池参数，允许基于生产工作负载模式进行微调。系统维护全局数据库实例，在所有服务组件间复用连接，最小化连接开销。</p>
<blockquote>
<p><strong>优化建议</strong>：应根据实际数据库指标监控并调整连接池参数。在典型面试工作负载下，将 <code>MaxIdleConns</code> 设置为 <code>MaxOpenConns</code> 的 20-30% 可获得最佳性能。</p>
</blockquote>
<h2 data-id="heading-1">Redis 缓存策略</h2>
<p>Redis 作为缓存层和消息队列基础设施，为频繁访问的数据提供亚毫秒级访问。缓存实现专注于会话管理、面试状态持久化和 AI 生成内容的临时存储。</p>
<p><strong>来源</strong>：redis.go</p>
<p>Redis 客户端配置通过底层 go-redis 库支持连接池，具有自动连接复用和故障转移处理功能。缓存层实现了简单的键值接口，支持可配置的过期时间：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 支持上下文的缓存操作</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SetCache</span><span class="hljs-params">(ctx context.Context, key <span class="hljs-type">string</span>, value <span class="hljs-keyword">interface</span>{}, expiration <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">error</span> {
    <span class="hljs-keyword">return</span> RedisClient.Set(ctx, key, value, <span class="hljs-number">0</span>).Err()
}
</code></pre>
<p>系统利用 Redis pub/sub 功能在面试组件间实时分发消息，当面试状态变化时能够立即更新连接的客户端。</p>
<h2 data-id="heading-2">消息队列性能</h2>
<p>基于 Redis 的消息队列实现为计算密集型操作（如 AI 模型推理和评估报告生成）提供异步处理能力。队列架构确保非阻塞请求处理，同时维护消息顺序和交付保证。</p>
<p><strong>来源</strong>：redis_queue.go</p>
<p>队列系统实现了基于 goroutine 的处理器的并发消息处理：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 并发消息处理</span>
<span class="hljs-keyword">for</span> _, h := <span class="hljs-keyword">range</span> handlers {
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(handler MessageHandler, m *Message)</span></span> {
        <span class="hljs-keyword">if</span> err := handler(ctx, m); err != <span class="hljs-literal">nil</span> {
            log.Printf(<span class="hljs-string">"[RedisQueue] Error processing message: %v, type: %s"</span>, err, m.Type)
        }
    }(h, &amp;message)
}
</code></pre>
<p>基于通道的消息路由确保根据消息类型高效分发到相应处理器，而 pub/sub 机制为订阅组件提供实时交付。</p>
<h2 data-id="heading-3">向量搜索优化</h2>
<p>Milvus 向量数据库集成实现了针对简历匹配和问题检索的优化相似性搜索。系统专注于最小化查询延迟，同时保持面试相关内容的高召回率。</p>
<p><strong>来源</strong>：milvus_retriever_tool.go</p>
<p>向量搜索工作流程包括：</p>
<ol>
<li><strong>查询预处理</strong>：输入验证和嵌入生成</li>
<li><strong>索引选择</strong>：基于数据特征自动选择最优索引</li>
<li><strong>相似性搜索</strong>：高效 ANN（近似最近邻）搜索，支持可配置的 top-k 结果</li>
<li><strong>结果格式化</strong>：包含相似度分数和元数据的结构化输出</li>
</ol>
<p>检索器服务实现了连接池和查询批处理，以在面试高峰期最大化吞吐量。</p>
<h2 data-id="heading-4">模型管理性能</h2>
<p>静态模型管理器实现了 AI 模型配置的高效内存缓存，具有 O(1) 查找性能。系统使用读写互斥锁确保线程安全，同时最小化锁争用。</p>
<p><strong>来源</strong>：manager_impl.go</p>
<p>模型管理架构支持：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 支持映射优化的线程安全模型查找</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *staticManager)</span></span> Get(ctx context.Context, id <span class="hljs-type">int64</span>) (*InternalModel, <span class="hljs-type">error</span>) {
    s.mu.RLock()
    <span class="hljs-keyword">defer</span> s.mu.RUnlock()
    
    <span class="hljs-keyword">if</span> m, ok := s.mapping[id]; ok {
        <span class="hljs-keyword">return</span> m, <span class="hljs-literal">nil</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>
}
</code></pre>
<p>批量操作（MGet）通过单次操作检索多个模型来最小化数据库往返，而 list 函数支持分页和过滤以减少内存占用。</p>
<h2 data-id="heading-5">内存管理和并发</h2>
<p>系统采用多种内存优化策略：</p>
<ul>
<li><strong>对象池</strong>：复用频繁分配的对象以减少 GC 压力</li>
<li><strong>流式处理</strong>：分块处理大型文档以最小化内存使用</li>
<li><strong>Goroutine 管理</strong>：控制 goroutine 生命周期以防止资源泄漏</li>
<li><strong>缓冲区管理</strong>：为 I/O 操作使用大小合适的缓冲区以平衡内存使用和性能</li>
</ul>
<p>并发架构使用 <code>sync.RWMutex</code> 处理读密集型操作（如模型查找），使用 <code>sync.Mutex</code> 处理写操作，确保在混合读写工作负载下的最佳性能。</p>
<h2 data-id="heading-6">性能监控和指标</h2>
<p>虽然基础基础设施已就位，但生产环境应实施全面的性能监控：</p>
<ol>
<li>数据库查询延迟和连接池指标</li>
<li>Redis 缓存命中率和内存使用情况</li>
<li>消息队列吞吐量和处理延迟</li>
<li>向量搜索查询时间和准确性指标</li>
<li>AI 模型推理延迟和资源利用率</li>
</ol>
<p>实施带有关联 ID 的结构化日志记录，以追踪面试处理管道中的性能瓶颈。这有助于对端到端延迟进行详细分析。</p>
<h2 data-id="heading-7">优化建议</h2>
<p>基于当前架构，考虑以下性能增强措施：</p>
<ol>
<li><strong>数据库索引</strong>：为面试记录和用户会话中的频繁查询模式添加复合索引</li>
<li><strong>缓存预热</strong>：将频繁访问的面试模板和问题集预加载到 Redis 缓存中</li>
<li><strong>连接池调优</strong>：根据并发用户指标调整数据库和 Redis 连接池</li>
<li><strong>批处理</strong>：为 AI 模型推理实现批处理操作以提高 GPU 利用率</li>
<li><strong>CDN 集成</strong>：通过 CDN 提供静态资源和缓存响应以减少延迟</li>
</ol>
<p>性能优化基础为处理不断增长的面试工作负载提供了可扩展的基础，同时保持系统响应性和可靠性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[三种依赖注入详解]]></title>    <link>https://juejin.cn/post/7585463195201519666</link>    <guid>https://juejin.cn/post/7585463195201519666</guid>    <pubDate>2025-12-20T10:05:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463195201519666" data-draft-id="7585463258690977801" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="三种依赖注入详解"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-20T10:05:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="L0CK"/> <meta itemprop="url" content="https://juejin.cn/user/3555195572989993"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            三种依赖注入详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3555195572989993/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    L0CK
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T10:05:03.000Z" title="Sat Dec 20 2025 10:05:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Spring 框架中，将一个 Bean 注入到另一个 Bean 里，主要有三种方式。</p>
<hr/>
<h2 data-id="heading-0">1. 属性注入 (Field Injection)</h2>
<p>这是初学阶段和各种教程中最常见的方式。直接在成员变量上加 <code>@Autowired</code>。</p>
<p><strong>代码示例：</strong></p>
<p>Java</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {

    <span class="hljs-meta">@Autowired</span> <span class="hljs-comment">// 核心动作：直接在属性上点名</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">UserService</span> userService;

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">list</span>(<span class="hljs-params"/>) {
        userService.<span class="hljs-title function_">findAll</span>();
    }
}
</code></pre>
<ul>
<li>
<p><strong>优点</strong>：代码最简洁，看起来非常干净。</p>
</li>
<li>
<p><strong>缺点</strong>：</p>
<ul>
<li><strong>难以脱离容器使用</strong>：如果你想在没有 Spring 环境的情况下（比如写纯 Java 的单元测试）手动 new 这个对象，你没法给 <code>userService</code> 赋值。</li>
<li><strong>容易循环依赖</strong>：如果 A 注入 B，B 又注入 A，这种方式有时会掩盖代码设计的缺陷。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-1">2. Setter 方法注入 (Setter Injection)</h2>
<p>通过类的 Setter 方法来完成注入。</p>
<p><strong>代码示例：</strong></p>
<p>Java</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-title class_">UserService</span> userService;

    <span class="hljs-meta">@Autowired</span> <span class="hljs-comment">// 核心动作：在 Setter 方法上点名</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setUserService</span>(<span class="hljs-params">UserService userService</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">userService</span> = userService;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">list</span>(<span class="hljs-params"/>) {
        userService.<span class="hljs-title function_">findAll</span>();
    }
}
</code></pre>
<ul>
<li>
<p><strong>优点</strong>：比较灵活，可以在对象创建后重新修改注入的实例。</p>
</li>
<li>
<p><strong>缺点</strong>：</p>
<ul>
<li><strong>安全性较低</strong>：对象在被调用时，可能还没有被注入（比如有人不小心改了值），导致空指针异常。</li>
<li><strong>代码冗长</strong>：每个属性都要写一套 Setter。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-2">3. 构造器注入 (Constructor Injection) —— <strong>官方推荐</strong></h2>
<p>通过类的构造方法来完成注入。这是 Spring 官方目前最推荐的方式。</p>
<p><strong>代码示例：</strong></p>
<p>Java</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserService userService; <span class="hljs-comment">// 甚至可以加 final，保证不可变</span>

    <span class="hljs-comment">// 核心动作：在构造函数上注入（Spring 4.3后，如果只有一个构造函数，@Autowired可省略）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserController</span><span class="hljs-params">(UserService userService)</span> {
        <span class="hljs-built_in">this</span>.userService = userService;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">list</span><span class="hljs-params">()</span> {
        userService.findAll();
    }
}
</code></pre>
<ul>
<li>
<p><strong>优点</strong>：</p>
<ol>
<li><strong>保证不为空</strong>：对象一出生（构造时）就必须把依赖传进来，否则编译报错。</li>
<li><strong>不可变性</strong>：可以使用 <code>final</code> 关键字，防止以后被修改。</li>
<li><strong>利于测试</strong>：即便没有 Spring，你也可以轻松地通过 <code>new UserController(mockService)</code> 来进行测试。</li>
</ol>
</li>
<li>
<p><strong>缺点</strong>：当依赖非常多（比如有 10 个）时，构造函数的参数列表会非常长。</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-3">总结：面试怎么答？</h2>

























<table><thead><tr><th><strong>方式</strong></th><th><strong>推荐程度</strong></th><th><strong>理由</strong></th></tr></thead><tbody><tr><td><strong>构造器注入</strong></td><td>⭐⭐⭐⭐⭐</td><td>官方推荐，安全、可靠、方便测试，保证对象状态完整。</td></tr><tr><td><strong>属性注入</strong></td><td>⭐⭐⭐</td><td>开发快，代码省事，但在大型项目和严格测试中不推荐。</td></tr><tr><td><strong>Setter 注入</strong></td><td>⭐⭐</td><td>除非需要在运行期间动态改变依赖，否则很少使用。</td></tr></tbody></table>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Linux入侵挖矿处理记录]]></title>    <link>https://juejin.cn/post/7585412203979096107</link>    <guid>https://juejin.cn/post/7585412203979096107</guid>    <pubDate>2025-12-20T10:05:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585412203979096107" data-draft-id="7585412203979079723" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Linux入侵挖矿处理记录"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-20T10:05:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="平凡的运维之路"/> <meta itemprop="url" content="https://juejin.cn/user/917424464473512"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Linux入侵挖矿处理记录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/917424464473512/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    平凡的运维之路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T10:05:29.000Z" title="Sat Dec 20 2025 10:05:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">Linux入侵挖矿处理记录</h3>
<ul>
<li>突然收到系统告警，cpu使用超50%以上，实际周末业务低谷期，不会使用这么高的cpu使用率。</li>
</ul>
<h4 data-id="heading-1">解决思路</h4>
<ul>
<li>
<p>系统基础命令被替换导致，无法展示隐藏的进程或者其他信息，使用BusyBox 命令代替基础命令，能输出完整信息。</p>
<ul>
<li>下载地址 <code>https://www.busybox.net/downloads/binaries/1.30.0-i686/busybox</code></li>
</ul>
</li>
<li>
<p>使用busybox top命令</p>
<ul>
<li>使用busybox top命令，可以清楚发现异常进程占用cpu超50%,</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e923f90398e24bb38cb1bc02a0ed04e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bmz5Yeh55qE6L-Q57u05LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766829929&amp;x-signature=BXOQitlP3GekJ8aMv0s%2Ba7omr4s%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>找到进程文件，清理该文件
<ul>
<li>进入/proc目录下找到对应pid，查看environ文件，SSC_ARGV0=就是程序本身，删除该文件后，重启服务器看是否还会有异常进程。</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/feb6d0e294604584b578e445bc80cd89~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bmz5Yeh55qE6L-Q57u05LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766829929&amp;x-signature=WSmx8bJ0rh7h11v90efV5UmB57Y%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Strapi 5 怎么用才够爽？这款插件带你实现“建站自由”]]></title>    <link>https://juejin.cn/post/7585452404113227791</link>    <guid>https://juejin.cn/post/7585452404113227791</guid>    <pubDate>2025-12-20T09:10:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585452404113227791" data-draft-id="7585452404113195023" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Strapi 5 怎么用才够爽？这款插件带你实现“建站自由”"/> <meta itemprop="keywords" content="后端,Node.js"/> <meta itemprop="datePublished" content="2025-12-20T09:10:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="知航驿站"/> <meta itemprop="url" content="https://juejin.cn/user/4125023356335576"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Strapi 5 怎么用才够爽？这款插件带你实现“建站自由”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4125023356335576/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    知航驿站
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T09:10:10.000Z" title="Sat Dec 20 2025 09:10:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><p>Strapi 5 是一个优秀的基石，而 <strong>strapi-plugin-bag</strong> 则是其上的“精装修”方案。我们致力于解决开发者在商业化交付过程中的那些重复劳动，让大家能把精力集中在真正的业务逻辑上。</p>
<p>本项目已在 GitHub 开源，并基于 <strong>Turborepo</strong> 维护，包含了完整的文档和前后端代码。</p>
<ul>
<li><strong>GitHub 仓库</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhangjob%2Fstrapi-plugin-bag" target="_blank" title="https://github.com/hangjob/strapi-plugin-bag" ref="nofollow noopener noreferrer">github.com/hangjob/str…</a></li>
<li><strong>在线文档</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhangjob.github.io%2Fstrapi-plugin-bag%2F" target="_blank" title="https://hangjob.github.io/strapi-plugin-bag/" ref="nofollow noopener noreferrer">hangjob.github.io/strapi-plug…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3be8cfd60d9942b08d2b6f5cd91cc7c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-l6Iiq6am_56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766826610&amp;x-signature=vqmEgr8EqX9brTXu41eqHLr%2BkEQ%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">核心特性</h2>
<ul>
<li>🛡️ <strong>安全防御</strong>：内置动态 IP 黑白名单、多重验证码拦截逻辑。</li>
<li>🔐 <strong>隐私加固</strong>：一键启用 RSA 2048 与 AES 256 数据加密服务。</li>
<li>📰 <strong>内容生态</strong>：完善的文章、分类、标签管理，内置 SEO 与阅读量统计。</li>
<li>🗺️ <strong>可视化运营</strong>：可视化管理多级菜单、幻灯片、友情链接。</li>
<li>💬 <strong>互动交互</strong>：强大的多级评论审核机制与独立留言板。</li>
<li>🚀 <strong>极速交付</strong>：全中文适配，深度优化 Strapi 5 操作体验。</li>
<li/>
</ul>
<h2 data-id="heading-1">环境要求</h2>
<p>在开始之前，请确保您的开发环境满足以下要求：</p>
<ul>
<li><strong>Strapi 版本</strong>: <code>^5.0.0</code> (支持最新的 Strapi 5 架构)</li>
<li><strong>Node.js 版本</strong>: <code>&gt;=22.10.0</code></li>
<li><strong>数据库</strong>: MySQL, PostgreSQL 或 SQLite</li>
</ul>
<h2 data-id="heading-2">安装步骤</h2>
<p>您可以使用您喜欢的包管理器将插件添加到您的 Strapi 项目中。</p>
<pre><code class="hljs language-bash" lang="bash">pnpm add strapi-plugin-bag
</code></pre>
<h2 data-id="heading-3">启用插件</h2>
<p>安装完成后，您需要手动在 Strapi 的配置文件中启用该插件。</p>
<p>编辑或创建项目根目录下的 <code>config/plugins.js</code> (或 <code>config/plugins.ts</code>) 文件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">(<span class="hljs-params">{ env }</span>) =&gt;</span> ({
  <span class="hljs-comment">// ... 其他插件配置</span>
  <span class="hljs-string">"strapi-plugin-bag"</span>: {
    <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span>,
  },
});
</code></pre>
<h2 data-id="heading-4">重新构建</h2>
<p>为了让插件的后台管理界面生效，您需要重新构建 Strapi 的管理面板并重启服务：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 构建管理面板</span>
npm run build

<span class="hljs-comment"># 启动开发服务器</span>
npm run dev
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98a42f9b6b8c4bfab6fa57256a876ebf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-l6Iiq6am_56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766826610&amp;x-signature=AyHO1SHMe%2Fv2P9ts4dI%2BLF9PsI4%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">权限配置</h2>
<p>启用插件后，您需要为相应的角色配置 API 访问权限：</p>
<ol>
<li>登录 Strapi 管理后台。</li>
<li>前往 <strong>Settings (设置)</strong> -&gt; <strong>Users &amp; Permissions Plugin</strong> -&gt; <strong>Roles (角色)</strong>。</li>
<li>选择您想要配置的角色（如 <code>Public</code> 或 <code>Authenticated</code>）。</li>
<li>在 <strong>Permissions (权限)</strong> 列表中找到 <strong>Strapi-plugin-bag</strong>。</li>
<li>勾选您需要开放的 API 权限（如 <code>article.find</code>, <code>menu.findOne</code> 等）。</li>
<li>点击右上角的 <strong>Save (保存)</strong>。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7481680accff4270b0df50836742b563~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-l6Iiq6am_56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766826610&amp;x-signature=8%2FSWWqCtXMnQcYAESliBfHl91RI%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-6">环境可视化配置</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff3db7f4873f4ab38d1dbec6fd4914c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-l6Iiq6am_56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766826610&amp;x-signature=c%2ByHVcnSweVJqau6aANHwykrmhY%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[脚手架开发工具——dotenv]]></title>    <link>https://juejin.cn/post/7585474459776466980</link>    <guid>https://juejin.cn/post/7585474459776466980</guid>    <pubDate>2025-12-20T08:58:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585474459776466980" data-draft-id="7585485074037456902" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="脚手架开发工具——dotenv"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T08:58:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="code_YuJun"/> <meta itemprop="url" content="https://juejin.cn/user/3615612462441358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            脚手架开发工具——dotenv
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3615612462441358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    code_YuJun
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:58:20.000Z" title="Sat Dec 20 2025 08:58:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">简介</h2>
<p>dotenv 是一个<strong>轻量级的 Node.js 环境变量管理工具</strong>，其核心作用是：<strong>从项目根目录的 <code>.env</code> 文件中加载自定义的环境变量，并将它们注入到 Node.js 的 <code>process.env</code> 对象中</strong>，使得我们可以在项目代码中统一通过 <code>process.env.XXX</code> 的方式获取这些环境配置，无需手动在系统环境中配置临时变量或永久变量。</p>
<h2 data-id="heading-1">核心工作原理</h2>
<ol>
<li>当在项目中引入并执行 dotenv 时，它会自动查找项目根目录下的 <code>.env</code> 文件（该文件为纯文本格式，采用键值对配置）；</li>
<li>它会解析 <code>.env</code> 文件中的每一行配置（格式通常为 <code>KEY=VALUE</code>）；</li>
<li>将解析后的键值对逐一挂载到 Node.js 内置的 <code>process.env</code> 对象上（<code>process.env</code> 原本用于存储系统级环境变量，dotenv 为其扩展了项目自定义环境变量）；</li>
<li>之后在项目的任意代码文件中，都可以通过 <code>process.env.KEY</code> 的形式获取对应的值。</li>
</ol>
<h2 data-id="heading-2">使用示例</h2>
<pre><code class="hljs language-css" lang="css">npm install dotenv <span class="hljs-attr">--save</span>
</code></pre>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># .env 文件内容 当前用户路径下创建 `.env` 文件</span>
<span class="hljs-attr">PORT</span>=<span class="hljs-number">3000</span>
<span class="hljs-attr">DB_HOST</span>=localhost
<span class="hljs-attr">DB_USER</span>=root
<span class="hljs-attr">DB_PASSWORD</span>=<span class="hljs-number">123456</span>
<span class="hljs-attr">API_KEY</span>=abcdefg123456
</code></pre>
<pre><code class="hljs language-js" lang="js">    <span class="hljs-keyword">const</span> dotenv = <span class="hljs-built_in">require</span>(<span class="hljs-string">'dotenv'</span>);
    <span class="hljs-keyword">const</span> dotenvPath = path.<span class="hljs-title function_">resolve</span>(userHome, <span class="hljs-string">'.env'</span>); <span class="hljs-comment">// /Users/***/.env</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">pathExists</span>(dotenvPath)) {
        dotenv.<span class="hljs-title function_">config</span>({
            <span class="hljs-attr">path</span>: dotenvPath,
        });
    }
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《Flutter全栈开发实战指南：从零到高级》- 26 -持续集成与部署]]></title>    <link>https://juejin.cn/post/7585463195201404978</link>    <guid>https://juejin.cn/post/7585463195201404978</guid>    <pubDate>2025-12-20T08:56:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463195201404978" data-draft-id="7585686247269548041" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《Flutter全栈开发实战指南：从零到高级》- 26 -持续集成与部署"/> <meta itemprop="keywords" content="Flutter,Android,iOS"/> <meta itemprop="datePublished" content="2025-12-20T08:56:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="QuantumLeap丶"/> <meta itemprop="url" content="https://juejin.cn/user/1767603104125197"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《Flutter全栈开发实战指南：从零到高级》- 26 -持续集成与部署
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1767603104125197/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    QuantumLeap丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:56:38.000Z" title="Sat Dec 20 2025 08:56:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<blockquote>
<p>代码写得再好，没有自动化的流水线，就像法拉利引擎装在牛车上！！！</p>
</blockquote>
<p><strong>什么是持续集成与部署？简单说就是：</strong></p>
<ul>
<li>你写代码 → 自动测试 → 自动打包 → 自动发布</li>
<li>就像工厂的流水线，代码进去，App出来</li>
</ul>
<p>今天我们一起来搭建这条"代码流水线"，让你的开发效率大幅提升！</p>
<h3 data-id="heading-1">一：CI/CD到底是什么？为什么每个团队都需要？</h3>
<h4 data-id="heading-2">1.1 从手动操作到自动化流水线</h4>
<p>先看看传统开发流程的痛点：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 传统发布流程（手动版）</span>
  <span class="hljs-number">1.</span> 本地运行测试();       <span class="hljs-comment">// 某些测试可能忘记运行</span>
  <span class="hljs-number">2.</span> 手动打包Android();    <span class="hljs-comment">// 配置证书、签名、版本号...</span>
  <span class="hljs-number">3.</span> 手动打包iOS();        <span class="hljs-comment">// 证书、描述文件、上架截图...</span>
  <span class="hljs-number">4.</span> 上传到测试平台();     <span class="hljs-comment">// 找测试妹子要手机号</span>
  <span class="hljs-number">5.</span> 收集反馈修复bug();    <span class="hljs-comment">// 来回沟通，效率低下</span>
  <span class="hljs-number">6.</span> 重复步骤<span class="hljs-number">1</span><span class="hljs-number">-5</span>();        <span class="hljs-comment">// 无限循环...</span>
</code></pre>
<p>再看自动化流水线：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 自动化发布流程（CI/CD版）</span>
<span class="hljs-string">流程:</span>
  <span class="hljs-number">1</span><span class="hljs-string">.</span> <span class="hljs-string">推送代码到GitHub/Gitlab</span> <span class="hljs-string">→</span> <span class="hljs-string">自动触发</span>
  <span class="hljs-number">2</span><span class="hljs-string">.</span> <span class="hljs-string">运行所有测试</span> <span class="hljs-string">→</span> <span class="hljs-string">失败自动通知</span>
  <span class="hljs-number">3</span><span class="hljs-string">.</span> <span class="hljs-string">打包所有平台</span> <span class="hljs-string">→</span> <span class="hljs-string">同时进行</span>
  <span class="hljs-number">4</span><span class="hljs-string">.</span> <span class="hljs-string">分发到测试环境</span> <span class="hljs-string">→</span> <span class="hljs-string">自动分发给测试人员</span>
  <span class="hljs-number">5</span><span class="hljs-string">.</span> <span class="hljs-string">发布到应用商店</span> <span class="hljs-string">→</span> <span class="hljs-string">条件触发</span>
</code></pre>
<h4 data-id="heading-3">1.2 CI/CD的核心价值</h4>
<p>很多新手觉得CI/CD是"大公司才需要的东西"，其实完全错了！它解决的是这些痛点：</p>
<p><strong>问题1：环境不一致</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">本地环境: Flutter 3.10, Dart 2.18, Mac M1</span>
<span class="hljs-section">测试环境: Flutter 3.7, Dart 2.17, Windows</span>
<span class="hljs-section">生产环境: ???</span>
</code></pre>
<p><strong>问题2：手动操作容易出错</strong>
之前遇到过同事把debug包发给了用户，因为打包时选错了构建变体。</p>
<p><strong>问题3：反馈周期太长</strong>
代码提交 → 手动打包 → 发给测试 → 发现问题 → 已经过了半天</p>
<h4 data-id="heading-4">1.3 CI/CD的三个核心概念</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[代码提交] --&gt; B[持续集成 CI]
    B --&gt; C[持续交付 CD]
    C --&gt; D[持续部署 CD]
    
    B --&gt; E[自动构建]
    B --&gt; F[自动测试]
    
    C --&gt; G[自动打包]
    C --&gt; H[自动发布到测试]
    
    D --&gt; I[自动发布到生产]
    
    style A fill:#e3f2fd
    style B fill:#f3e5f5
    style C fill:#e8f5e8
    style D fill:#fff3e0
</code></pre>
<p><strong>持续集成（CI）</strong>：频繁集成代码到主干，每次集成都通过自动化测试</p>
<p><strong>持续交付（CD）</strong>：自动将代码打包成可部署的产物</p>
<p><strong>持续部署（CD）</strong>：自动将产物部署到生产环境</p>
<blockquote>
<p>注意：两个CD虽然缩写一样，但含义不同。Continuous Delivery（持续交付）和 Continuous Deployment（持续部署）</p>
</blockquote>
<h3 data-id="heading-5">二：GitHub Actions</h3>
<p>我们以github为例，当然各公司有单独部署的gitlab，大同小异这里不在赘述。。。</p>
<h4 data-id="heading-6">2.1 GitHub Actions工作原理</h4>
<p>GitHub Actions不是魔法，而是GitHub提供的<strong>自动化执行环境</strong>。想象一下：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[你的代码仓库] --&gt; B[事件推送/PR]
    B --&gt; C[GitHub Actions服务器]
    C --&gt; D[分配虚拟机]
    D --&gt; E[你的工作流]
    E --&gt; F[运行你的脚本]

    style A fill:#f9f,stroke:#333,stroke-width:1px
    style C fill:#9f9,stroke:#333,stroke-width:1px
    style E fill:#99f,stroke:#333,stroke-width:1px
</code></pre>
<p><strong>核心组件解析</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 工作流组件关系图</span>
<span class="hljs-string">工作流文件</span> <span class="hljs-string">(.github/workflows/ci.yml)</span>
    <span class="hljs-string">├──</span> <span class="hljs-string">触发器:</span> <span class="hljs-string">什么情况下运行</span> <span class="hljs-string">(push,</span> <span class="hljs-string">pull_request)</span>
    <span class="hljs-string">├──</span> <span class="hljs-string">任务:</span> <span class="hljs-string">在什么环境下运行</span> <span class="hljs-string">(ubuntu-latest)</span>
    <span class="hljs-string">└──</span> <span class="hljs-string">步骤:</span> <span class="hljs-string">具体执行什么</span> <span class="hljs-string">(安装Flutter、运行测试)</span>
</code></pre>
<h4 data-id="heading-7">2.2 创建你的第一个工作流</h4>
<p>别被吓到，其实创建一个基础的CI流程只需要5分钟：</p>
<ol>
<li><strong>在项目根目录创建文件夹</strong>：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> -p .github/workflows
</code></pre>
<ol start="2">
<li><strong>创建CI配置文件</strong>：</li>
</ol>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># .github/workflows/flutter-ci.yml</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">Flutter</span> <span class="hljs-string">CI</span>  <span class="hljs-comment"># 工作流名称</span>

<span class="hljs-comment"># 触发条件：当有代码推送到main分支，或者有PR时</span>
<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span> [ <span class="hljs-string">main</span>, <span class="hljs-string">develop</span> ]
  <span class="hljs-attr">pull_request:</span>
    <span class="hljs-attr">branches:</span> [ <span class="hljs-string">main</span> ]

<span class="hljs-comment"># 设置权限</span>
<span class="hljs-attr">permissions:</span>
  <span class="hljs-attr">contents:</span> <span class="hljs-string">read</span>  <span class="hljs-comment"># 只读权限，保证安全</span>

<span class="hljs-comment"># 工作流中的任务</span>
<span class="hljs-attr">jobs:</span>
  <span class="hljs-comment"># 任务1：运行测试</span>
  <span class="hljs-attr">test:</span>
    <span class="hljs-comment"># 运行在Ubuntu最新版</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-comment"># 任务步骤</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-comment"># 步骤1：检出代码</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
        
      <span class="hljs-comment"># 步骤2：安装Flutter</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Flutter</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">subosito/flutter-action@v2</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">flutter-version:</span> <span class="hljs-string">'3.10.x'</span>  <span class="hljs-comment"># 指定Flutter版本</span>
          <span class="hljs-attr">channel:</span> <span class="hljs-string">'stable'</span>          <span class="hljs-comment"># 稳定版</span>
        
      <span class="hljs-comment"># 步骤3：获取依赖</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Get</span> <span class="hljs-string">dependencies</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">flutter</span> <span class="hljs-string">pub</span> <span class="hljs-string">get</span>
        
      <span class="hljs-comment"># 步骤4：运行测试</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">tests</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">flutter</span> <span class="hljs-string">test</span>
        
      <span class="hljs-comment"># 步骤5：检查代码格式</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Check</span> <span class="hljs-string">formatting</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">flutter</span> <span class="hljs-string">format</span> <span class="hljs-string">--set-exit-if-changed</span> <span class="hljs-string">.</span>
        
      <span class="hljs-comment"># 步骤6：静态分析</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Analyze</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">flutter</span> <span class="hljs-string">analyze</span>
</code></pre>
<ol start="3">
<li><strong>提交并推送代码</strong>：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">git add .github/workflows/flutter-ci.yml
git commit -m <span class="hljs-string">"添加CI工作流"</span>
git push origin main
</code></pre>
<p>推送到GitHub后，打开你的仓库页面，点击"Actions"标签，你会看到一个工作流正在运行！</p>
<h4 data-id="heading-8">2.3 GitHub Actions架构</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph &amp;#34;GitHub Actions架构&amp;#34;
        A[你的代码仓库] --&gt; B[触发事件]
        B --&gt; C[GitHub Actions Runner]
        
        subgraph &amp;#34;Runner执行环境&amp;#34;
            C --&gt; D[创建虚拟机]
            D --&gt; E[执行工作流]
            
            subgraph &amp;#34;工作流步骤&amp;#34;
                E --&gt; F[检出代码]
                F --&gt; G[环境配置]
                G --&gt; H[执行脚本]
                H --&gt; I[产出物]
            end
        end
        
        I --&gt; J[结果反馈]
        J --&gt; K[GitHub UI显示]
        J --&gt; L[邮件/通知]
    end
    
    style A fill:#e3f2fd
    style C fill:#f3e5f5
    style E fill:#e8f5e8
    style I fill:#fff3e0
</code></pre>
<p><strong>核心概念解释</strong>：</p>
<ol>
<li><strong>Runner</strong>：GitHub提供的虚拟机（或你自己的服务器），用来执行工作流</li>
<li><strong>Workflow</strong>：工作流，一个完整的自动化流程</li>
<li><strong>Job</strong>：任务，工作流中的独立单元</li>
<li><strong>Step</strong>：步骤，任务中的具体操作</li>
<li><strong>Action</strong>：可复用的操作单元，如"安装Flutter"</li>
</ol>
<h3 data-id="heading-9">三：自动化测试流水线</h3>
<h4 data-id="heading-10">3.1 为什么自动化测试如此重要？</h4>
<p>功能上线前，全部功能手动测试耗时长，易出bug。加入自动化测试，有效减少bug率。</p>
<p><strong>测试金字塔理论</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">        /\
       /  \      E2E测试（少量）
      /____\     
     /      \    集成测试（适中）
    /________\
   /          \  单元测试（大量）
  /____________\
</code></pre>
<p>对于Flutter，测试分为三层：</p>
<h4 data-id="heading-11">3.2 配置单元测试</h4>
<p>单元测试是最基础的，测试单个函数或类：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># .github/workflows/unit-tests.yml</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">Unit</span> <span class="hljs-string">Tests</span>

<span class="hljs-attr">on:</span> [<span class="hljs-string">push</span>, <span class="hljs-string">pull_request</span>]

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">unit-tests:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-attr">strategy:</span>
      <span class="hljs-attr">matrix:</span>
        <span class="hljs-comment"># 在不同版本的Flutter上运行测试</span>
        <span class="hljs-attr">flutter:</span> [<span class="hljs-string">'3.7.x'</span>, <span class="hljs-string">'3.10.x'</span>]
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Flutter</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.flutter</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">subosito/flutter-action@v2</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">flutter-version:</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.flutter</span> <span class="hljs-string">}}</span>
          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Get</span> <span class="hljs-string">dependencies</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">flutter</span> <span class="hljs-string">pub</span> <span class="hljs-string">get</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">unit</span> <span class="hljs-string">tests</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # 运行所有单元测试
          flutter test
</span>          
          <span class="hljs-comment"># 生成测试覆盖率报告</span>
          <span class="hljs-string">flutter</span> <span class="hljs-string">test</span> <span class="hljs-string">--coverage</span>
          
          <span class="hljs-comment"># 上传覆盖率报告</span>
          <span class="hljs-string">bash</span> <span class="hljs-string">&lt;(curl</span> <span class="hljs-string">-s</span> <span class="hljs-string">https://codecov.io/bash)</span>
</code></pre>
<p><strong>单元测试</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// test/calculator_test.dart</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter_test/flutter_test.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:my_app/utils/calculator.dart'</span>;

<span class="hljs-keyword">void</span> main() {
  group(<span class="hljs-string">'以Calculator测试为例'</span>, () {
    <span class="hljs-keyword">late</span> Calculator calculator;
    
    <span class="hljs-comment">// 准备工作</span>
    setUp(() {
      calculator = Calculator();
    });
    
    test(<span class="hljs-string">'两个正数相加'</span>, () {
      expect(calculator.add(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>), <span class="hljs-number">5</span>);
    });
    
    test(<span class="hljs-string">'正数与负数相加'</span>, () {
      expect(calculator.add(<span class="hljs-number">5</span>, <span class="hljs-number">-3</span>), <span class="hljs-number">2</span>);
    });
    
    test(<span class="hljs-string">'除以零应该抛出异常'</span>, () {
      expect(() =&gt; calculator.divide(<span class="hljs-number">10</span>, <span class="hljs-number">0</span>), throwsA(isA&lt;ArgumentError&gt;()));
    });
  });
}
</code></pre>
<h4 data-id="heading-12">3.3 配置集成测试</h4>
<p>集成测试测试多个组件的交互：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 集成测试工作流</span>
<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">integration-tests:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">macos-latest</span>  <span class="hljs-comment"># iOS集成测试需要macOS</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Flutter</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">subosito/flutter-action@v2</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Get</span> <span class="hljs-string">dependencies</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">flutter</span> <span class="hljs-string">pub</span> <span class="hljs-string">get</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">integration</span> <span class="hljs-string">tests</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # 启动模拟器
          # flutter emulators --launch flutter_emulator
</span>          
          <span class="hljs-comment"># 运行集成测试</span>
          <span class="hljs-string">flutter</span> <span class="hljs-string">test</span> <span class="hljs-string">integration_test/</span>
          
      <span class="hljs-comment"># 如果集成测试失败，上传截图辅助调试</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">screenshots</span> <span class="hljs-string">on</span> <span class="hljs-string">failure</span>
        <span class="hljs-attr">if:</span> <span class="hljs-string">failure()</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/upload-artifact@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">integration-test-screenshots</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">screenshots/</span>
</code></pre>
<h4 data-id="heading-13">3.4 配置Widget测试</h4>
<p>Widget测试测试UI组件：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">widget-tests:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Flutter</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">subosito/flutter-action@v2</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">dependencies</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          flutter pub get
</span>          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">widget</span> <span class="hljs-string">tests</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # 运行所有widget测试
          flutter test test/widget_test.dart
</span>          
          <span class="hljs-comment"># 或者运行特定目录</span>
          <span class="hljs-string">flutter</span> <span class="hljs-string">test</span> <span class="hljs-string">test/widgets/</span>
</code></pre>
<h4 data-id="heading-14">3.5 测试流水线</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant D as 开发者
    participant G as Git仓库
    participant CI as CI服务器
    participant UT as 单元测试服务
    participant WT as Widget测试服务
    participant IT as 集成测试服务
    participant R as 报告服务
    participant N as 通知服务
    
    D-&gt;&gt;G: 推送代码
    G-&gt;&gt;CI: 触发Webhook
    
    CI-&gt;&gt;CI: 解析工作流配置
    CI-&gt;&gt;CI: 分配测试资源
    
    par 并行执行
        CI-&gt;&gt;UT: 启动单元测试
        UT-&gt;&gt;UT: 准备环境
        UT-&gt;&gt;UT: 执行测试
        UT-&gt;&gt;UT: 分析覆盖率
        UT--&gt;&gt;CI: 返回结果
    and
        CI-&gt;&gt;WT: 启动Widget测试
        WT-&gt;&gt;WT: 准备UI环境
        WT-&gt;&gt;WT: 执行测试
        WT-&gt;&gt;WT: 截图对比
        WT--&gt;&gt;CI: 返回结果
    and
        CI-&gt;&gt;IT: 启动集成测试
        IT-&gt;&gt;IT: 准备设备
        IT-&gt;&gt;IT: 执行测试
        IT-&gt;&gt;IT: 端到端验证
        IT--&gt;&gt;CI: 返回结果
    end
    
    CI-&gt;&gt;CI: 收集所有结果
    
    alt 所有测试通过
        CI-&gt;&gt;R: 请求生成报告
        R-&gt;&gt;R: 生成详细报告
        R--&gt;&gt;CI: 返回报告
        CI-&gt;&gt;N: 发送成功通知
        N--&gt;&gt;D: 通知开发者
    else 有测试失败
        CI-&gt;&gt;R: 请求生成错误报告
        R-&gt;&gt;R: 生成错误报告
        R--&gt;&gt;CI: 返回报告
        CI-&gt;&gt;N: 发送失败通知
        N--&gt;&gt;D: 警报开发者
    end
</code></pre>
<h3 data-id="heading-15">四：自动打包与发布流水线</h3>
<h4 data-id="heading-16">4.1 Android自动打包</h4>
<p>Android打包相对简单，但要注意签名问题：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># .github/workflows/android-build.yml</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">Android</span> <span class="hljs-string">Build</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">tags:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">'v*'</span>  <span class="hljs-comment"># 只有打tag时才触发打包</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">build-android:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Java</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-java@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">distribution:</span> <span class="hljs-string">'temurin'</span>
          <span class="hljs-attr">java-version:</span> <span class="hljs-string">'17'</span>
          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Flutter</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">subosito/flutter-action@v2</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Get</span> <span class="hljs-string">dependencies</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">flutter</span> <span class="hljs-string">pub</span> <span class="hljs-string">get</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">keystore</span>
        <span class="hljs-comment"># 从GitHub Secrets读取签名密钥</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          echo "${{ secrets.ANDROID_KEYSTORE }}" &gt; android/app/key.jks.base64
          base64 -d android/app/key.jks.base64 &gt; android/app/key.jks
</span>          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">APK</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # 构建Release版APK
          flutter build apk --release \
            --dart-define=APP_VERSION=${{ github.ref_name }} \
            --dart-define=BUILD_NUMBER=${{ github.run_number }}
            
</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">App</span> <span class="hljs-string">Bundle</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # 构建App Bundle
          flutter build appbundle --release
</span>          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">artifacts</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/upload-artifact@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">android-build-${{</span> <span class="hljs-string">github.run_number</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">|
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/bundle/release/app-release.aab
</span></code></pre>
<h4 data-id="heading-17">4.2 iOS自动打包</h4>
<p>iOS打包相对复杂，需要苹果开发者账号：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># .github/workflows/ios-build.yml</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">iOS</span> <span class="hljs-string">Build</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">tags:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">'v*'</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">build-ios:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">macos-latest</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Flutter</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">subosito/flutter-action@v2</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">CocoaPods</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          cd ios
          pod install
</span>          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Xcode</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # 设置Xcode版本
          sudo xcode-select -s /Applications/Xcode_14.2.app
</span>          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">provisioning</span> <span class="hljs-string">profiles</span>
        <span class="hljs-comment"># 配置证书和描述文件</span>
        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">BUILD_CERTIFICATE_BASE64:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.BUILD_CERTIFICATE</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">P12_PASSWORD:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.P12_PASSWORD</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">BUILD_PROVISION_PROFILE_BASE64:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.BUILD_PROVISION_PROFILE</span> <span class="hljs-string">}}</span>
          
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # 导入证书
          echo $BUILD_CERTIFICATE_BASE64 | base64 --decode &gt; certificate.p12
</span>          
          <span class="hljs-comment"># 创建钥匙链</span>
          <span class="hljs-string">security</span> <span class="hljs-string">create-keychain</span> <span class="hljs-string">-p</span> <span class="hljs-string">""</span> <span class="hljs-string">build.keychain</span>
          <span class="hljs-string">security</span> <span class="hljs-string">default-keychain</span> <span class="hljs-string">-s</span> <span class="hljs-string">build.keychain</span>
          <span class="hljs-string">security</span> <span class="hljs-string">unlock-keychain</span> <span class="hljs-string">-p</span> <span class="hljs-string">""</span> <span class="hljs-string">build.keychain</span>
          
          <span class="hljs-comment"># 导入证书到钥匙链</span>
          <span class="hljs-string">security</span> <span class="hljs-string">import</span> <span class="hljs-string">certificate.p12</span> <span class="hljs-string">-k</span> <span class="hljs-string">build.keychain</span> <span class="hljs-string">\</span>
            <span class="hljs-string">-P</span> <span class="hljs-string">$P12_PASSWORD</span> <span class="hljs-string">-T</span> <span class="hljs-string">/usr/bin/codesign</span>
          
          <span class="hljs-comment"># 导入描述文件</span>
          <span class="hljs-string">echo</span> <span class="hljs-string">$BUILD_PROVISION_PROFILE_BASE64</span> <span class="hljs-string">|</span> <span class="hljs-string">base64</span> <span class="hljs-string">--decode</span> <span class="hljs-string">&gt;</span> <span class="hljs-string">profile.mobileprovision</span>
          <span class="hljs-string">mkdir</span> <span class="hljs-string">-p</span> <span class="hljs-string">~/Library/MobileDevice/Provisioning\</span> <span class="hljs-string">Profiles</span>
          <span class="hljs-string">cp</span> <span class="hljs-string">profile.mobileprovision</span> <span class="hljs-string">~/Library/MobileDevice/Provisioning\</span> <span class="hljs-string">Profiles/</span>
          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">iOS</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # 构建iOS应用
          flutter build ipa --release \
            --export-options-plist=ios/ExportOptions.plist \
            --dart-define=APP_VERSION=${{ github.ref_name }} \
            --dart-define=BUILD_NUMBER=${{ github.run_number }}
            
</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">IPA</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/upload-artifact@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">ios-build-${{</span> <span class="hljs-string">github.run_number</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">build/ios/ipa/*.ipa</span>
</code></pre>
<h4 data-id="heading-18">4.3 多环境构建配置</h4>
<p>真实的项目通常有多个环境：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 多环境构建配置</span>
<span class="hljs-attr">env:</span>
  <span class="hljs-comment"># 根据分支选择环境</span>
  <span class="hljs-attr">APP_ENV:</span> <span class="hljs-string">${{</span> <span class="hljs-string">github.ref</span> <span class="hljs-string">==</span> <span class="hljs-string">'refs/heads/main'</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">'production'</span> <span class="hljs-string">||</span> <span class="hljs-string">'staging'</span> <span class="hljs-string">}}</span>
  <span class="hljs-attr">APP_NAME:</span> <span class="hljs-string">${{</span> <span class="hljs-string">github.ref</span> <span class="hljs-string">==</span> <span class="hljs-string">'refs/heads/main'</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">'生产'</span> <span class="hljs-string">||</span> <span class="hljs-string">'测试'</span> <span class="hljs-string">}}</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">build:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-attr">strategy:</span>
      <span class="hljs-attr">matrix:</span>
        <span class="hljs-comment"># 同时构建多个Flavor</span>
        <span class="hljs-attr">flavor:</span> [<span class="hljs-string">development</span>, <span class="hljs-string">staging</span>, <span class="hljs-string">production</span>]
        <span class="hljs-attr">platform:</span> [<span class="hljs-string">android</span>, <span class="hljs-string">ios</span>]
        
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Flutter</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">subosito/flutter-action@v2</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.platform</span> <span class="hljs-string">}}</span> <span class="hljs-string">for</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.flavor</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          if [ "${{ matrix.platform }}" = "android" ]; then
            flutter build apk --flavor ${{ matrix.flavor }} --release
          else
            flutter build ipa --flavor ${{ matrix.flavor }} --release
          fi
</span>          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.flavor</span> <span class="hljs-string">}}</span> <span class="hljs-string">build</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/upload-artifact@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.platform</span> <span class="hljs-string">}}-${{</span> <span class="hljs-string">matrix.flavor</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">|
            build/app/outputs/flutter-apk/app-${{ matrix.flavor }}-release.apk
            build/ios/ipa/*.ipa
</span></code></pre>
<h4 data-id="heading-19">4.4 自动化发布到测试平台</h4>
<p>构建完成后，自动分发给测试人员：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 分发到测试平台</span>
<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">distribute:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">needs:</span> [<span class="hljs-string">build</span>]  <span class="hljs-comment"># 依赖build任务</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Download</span> <span class="hljs-string">artifacts</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/download-artifact@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">artifacts/</span>
          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">to</span> <span class="hljs-string">Firebase</span> <span class="hljs-string">App</span> <span class="hljs-string">Distribution</span>
        <span class="hljs-comment"># 分发到Firebase</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # 安装Firebase CLI
          curl -sL https://firebase.tools | bash
</span>          
          <span class="hljs-comment"># 登录Firebase</span>
          <span class="hljs-string">echo</span> <span class="hljs-string">"$<span class="hljs-template-variable">{{ secrets.FIREBASE_TOKEN }}</span>"</span> <span class="hljs-string">&gt;</span> <span class="hljs-string">firebase_token.json</span>
          
          <span class="hljs-comment"># 分发Android APK</span>
          <span class="hljs-string">firebase</span> <span class="hljs-string">appdistribution:distribute</span> <span class="hljs-string">artifacts/android-production/app-release.apk</span> <span class="hljs-string">\</span>
            <span class="hljs-string">--app</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.FIREBASE_ANDROID_APP_ID</span> <span class="hljs-string">}}</span> <span class="hljs-string">\</span>
            <span class="hljs-string">--groups</span> <span class="hljs-string">"testers"</span> <span class="hljs-string">\</span>
            <span class="hljs-string">--release-notes-file</span> <span class="hljs-string">CHANGELOG.md</span>
            
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">to</span> <span class="hljs-string">TestFlight</span>
        <span class="hljs-comment"># iOS上传到TestFlight</span>
        <span class="hljs-attr">if:</span> <span class="hljs-string">matrix.platform</span> <span class="hljs-string">==</span> <span class="hljs-string">'ios'</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # 使用altool上传到App Store Connect
          xcrun altool --upload-app \
            -f artifacts/ios-production/*.ipa \
            -t ios \
            --apiKey ${{ secrets.APPSTORE_API_KEY }} \
            --apiIssuer ${{ secrets.APPSTORE_API_ISSUER }}
            
</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Notify</span> <span class="hljs-string">testers</span>
        <span class="hljs-comment"># 通知测试人员</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">8398a7/action-slack@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">status:</span> <span class="hljs-string">${{</span> <span class="hljs-string">job.status</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">fields:</span> <span class="hljs-string">repo,message,commit,author,action,eventName,ref,workflow,job,took</span>
        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">SLACK_WEBHOOK_URL:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.SLACK_WEBHOOK_URL</span> <span class="hljs-string">}}</span>
</code></pre>
<h4 data-id="heading-20">4.5 打包发布流水线</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">gantt
    title Flutter打包发布流水线
    dateFormat HH:mm
    axisFormat %H:%M
    
    section 触发与准备
    代码提交检测 :00:00, 2m
    环境初始化 :00:02, 3m
    依赖安装 :00:05, 4m
    
    section Android构建
    Android环境准备 :00:05, 2m
    Android代码编译 :00:07, 6m
    Android代码签名 :00:13, 3m
    Android打包 :00:16, 2m
    
    section iOS构建
    iOS环境准备 :00:05, 3m
    iOS代码编译 :00:08, 8m
    iOS证书配置 :00:16, 4m
    iOS打包 :00:20, 3m
    
    section 测试分发
    上传到测试平台 :00:23, 5m
    测试人员通知 :00:28, 2m
    测试执行周期 :00:30, 30m
    
    section 生产发布
    测试结果评估 :01:00, 3m
    生产环境准备 :01:03, 5m
    提交到应用商店 :01:08, 10m
    商店审核等待 :01:18, 30m
    发布完成通知 :01:48, 2m
    
    section 环境配置管理
    密钥加载 :00:02, 3m
    环境变量设置 :00:05, 2m
    配置文件解析 :00:07, 3m
    版本号处理 :00:10, 2m
</code></pre>
<h3 data-id="heading-21">五：环境配置管理</h3>
<h4 data-id="heading-22">5.1 为什么需要环境配置管理？</h4>
<p>先看一个反面教材：我们项目早期，不同环境的API地址是硬编码的：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 不推荐：硬编码配置</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ApiConfig</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">String</span> baseUrl = <span class="hljs-string">'https://api.production.com'</span>;
  <span class="hljs-comment">// 测试时需要手动改成：'https://api.staging.com'</span>
  <span class="hljs-comment">// 很容易忘记改回来！</span>
}
</code></pre>
<p>结果就是：测试时调用了生产接口，把测试数据插到了生产数据库！💥</p>
<h4 data-id="heading-23">5.2 多环境配置方案</h4>
<p><strong>方案一：基于Flavor的配置</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// lib/config/flavors.dart</span>
<span class="hljs-keyword">enum</span> AppFlavor {
  development,
  staging,
  production,
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppConfig</span> </span>{
  <span class="hljs-keyword">final</span> AppFlavor flavor;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> appName;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> apiBaseUrl;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> enableAnalytics;
  
  AppConfig({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.flavor,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.appName,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.apiBaseUrl,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.enableAnalytics,
  });
  
  <span class="hljs-comment">// 根据Flavor创建配置</span>
  <span class="hljs-keyword">factory</span> AppConfig.fromFlavor(AppFlavor flavor) {
    <span class="hljs-keyword">switch</span> (flavor) {
      <span class="hljs-keyword">case</span> AppFlavor.development:
        <span class="hljs-keyword">return</span> AppConfig(
          flavor: flavor,
          appName: <span class="hljs-string">'MyApp Dev'</span>,
          apiBaseUrl: <span class="hljs-string">'https://api.dev.xxxx.com'</span>,
          enableAnalytics: <span class="hljs-keyword">false</span>,
        );
      <span class="hljs-keyword">case</span> AppFlavor.staging:
        <span class="hljs-keyword">return</span> AppConfig(
          flavor: flavor,
          appName: <span class="hljs-string">'MyApp Staging'</span>,
          apiBaseUrl: <span class="hljs-string">'https://api.staging.xxxx.com'</span>,
          enableAnalytics: <span class="hljs-keyword">true</span>,
        );
      <span class="hljs-keyword">case</span> AppFlavor.production:
        <span class="hljs-keyword">return</span> AppConfig(
          flavor: flavor,
          appName: <span class="hljs-string">'MyApp'</span>,
          apiBaseUrl: <span class="hljs-string">'https://api.xxxx.com'</span>,
          enableAnalytics: <span class="hljs-keyword">true</span>,
        );
    }
  }
}
</code></pre>
<p><strong>方案二：使用dart-define传入配置</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># CI配置中传入环境变量</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">with</span> <span class="hljs-string">environment</span> <span class="hljs-string">variables</span>
  <span class="hljs-attr">run:</span> <span class="hljs-string">|
    flutter build apk --release \
      --dart-define=APP_FLAVOR=production \
      --dart-define=API_BASE_URL=https://api.xxxx.com \
      --dart-define=ENABLE_ANALYTICS=true
</span></code></pre>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 在代码中读取环境变量</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EnvConfig</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">String</span> flavor = <span class="hljs-built_in">String</span>.fromEnvironment(<span class="hljs-string">'APP_FLAVOR'</span>);
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">String</span> apiBaseUrl = <span class="hljs-built_in">String</span>.fromEnvironment(<span class="hljs-string">'API_BASE_URL'</span>);
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">bool</span> enableAnalytics = <span class="hljs-built_in">bool</span>.fromEnvironment(<span class="hljs-string">'ENABLE_ANALYTICS'</span>);
}
</code></pre>
<h4 data-id="heading-24">5.3 管理敏感信息</h4>
<p>敏感信息绝不能写在代码里！</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 使用GitHub Secrets</span>
<span class="hljs-attr">steps:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Use</span> <span class="hljs-string">secrets</span>
    <span class="hljs-attr">env:</span>
      <span class="hljs-comment"># 从Secrets读取</span>
      <span class="hljs-attr">API_KEY:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.API_KEY</span> <span class="hljs-string">}}</span>
      <span class="hljs-attr">DATABASE_URL:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.DATABASE_URL</span> <span class="hljs-string">}}</span>
      <span class="hljs-attr">SIGNING_KEY:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.ANDROID_SIGNING_KEY</span> <span class="hljs-string">}}</span>
      
    <span class="hljs-attr">run:</span> <span class="hljs-string">|
      # 在脚本中使用
      echo "API Key: $API_KEY"
</span>      
      <span class="hljs-comment"># 写入到配置文件</span>
      <span class="hljs-string">echo</span> <span class="hljs-string">"{ \"apiKey\": \"$API_KEY\" }"</span> <span class="hljs-string">&gt;</span> <span class="hljs-string">config.json</span>
</code></pre>
<p><strong>如何设置Secrets</strong>：</p>
<ol>
<li>打开GitHub仓库 → Settings → Secrets and variables → Actions</li>
<li>点击"New repository secret"</li>
<li>输入名称和值</li>
</ol>
<h4 data-id="heading-25">5.4 配置文件管理</h4>
<p>推荐以下分层配置策略：</p>
<pre><code class="hljs language-bash" lang="bash">config/
├── .env.example          <span class="hljs-comment"># 示例文件，不含真实值</span>
├── .env.development      <span class="hljs-comment"># 开发环境配置</span>
├── .env.staging          <span class="hljs-comment"># 测试环境配置</span>
├── .env.production       <span class="hljs-comment"># 生产环境配置</span>
└── config_loader.dart    <span class="hljs-comment"># 配置加载器</span>
</code></pre>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// config/config_loader.dart</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter_dotenv/flutter_dotenv.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConfigLoader</span> </span>{
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-keyword">void</span>&gt; load(<span class="hljs-built_in">String</span> env) <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 根据环境加载对应的配置文件</span>
    <span class="hljs-keyword">await</span> dotenv.load(fileName: <span class="hljs-string">'.env.<span class="hljs-subst">$env</span>'</span>);
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-built_in">String</span> <span class="hljs-keyword">get</span> apiBaseUrl =&gt; dotenv.<span class="hljs-keyword">get</span>(<span class="hljs-string">'API_BASE_URL'</span>);
  <span class="hljs-keyword">static</span> <span class="hljs-built_in">String</span> <span class="hljs-keyword">get</span> apiKey =&gt; dotenv.<span class="hljs-keyword">get</span>(<span class="hljs-string">'API_KEY'</span>);
  <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isDebug =&gt; dotenv.<span class="hljs-keyword">get</span>(<span class="hljs-string">'DEBUG'</span>) == <span class="hljs-string">'true'</span>;
}

<span class="hljs-comment">// main.dart</span>
<span class="hljs-keyword">void</span> main() <span class="hljs-keyword">async</span> {
  <span class="hljs-comment">// 根据编译模式选择环境</span>
  <span class="hljs-keyword">const</span> flavor = <span class="hljs-built_in">String</span>.fromEnvironment(<span class="hljs-string">'FLAVOR'</span>, defaultValue: <span class="hljs-string">'development'</span>);
  
  <span class="hljs-keyword">await</span> ConfigLoader.load(flavor);
  
  runApp(MyApp());
}
</code></pre>
<h4 data-id="heading-26">5.5 设计环境配置</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph &amp;#34;环境配置管理架构&amp;#34;
        A[配置来源] --&gt; B[优先级]
        
        subgraph &amp;#34;B[优先级]&amp;#34;
            B1[1. 运行时环境变量] --&gt; B2[最高优先级]
            B3[2. 配置文件] --&gt; B4[中等优先级]
            B5[3. 默认值] --&gt; B6[最低优先级]
        end
        
        A --&gt; C[敏感信息处理]
        
        subgraph &amp;#34;C[敏感信息处理]&amp;#34;
            C1[密钥/密码] --&gt; C2[GitHub Secrets]
            C3[API令牌] --&gt; C4[环境变量注入]
            C5[数据库连接] --&gt; C6[运行时获取]
        end
        
        A --&gt; D[环境类型]
        
        subgraph &amp;#34;D[环境类型]&amp;#34;
            D1[开发环境] --&gt; D2[本地调试]
            D3[测试环境] --&gt; D4[CI/CD测试]
            D5[预发环境] --&gt; D6[生产前验证]
            D7[生产环境] --&gt; D8[线上用户]
        end
        
        B --&gt; E[配置合并]
        C --&gt; E
        D --&gt; E
        
        E --&gt; F[最终配置]
        
        F --&gt; G[应用启动]
        F --&gt; H[API调用]
        F --&gt; I[功能开关]
    end
    
    subgraph &amp;#34;安全实践&amp;#34;
        J[永远不要提交] --&gt; K[.env文件到Git]
        L[使用.gitignore] --&gt; M[忽略敏感文件]
        N[定期轮换] --&gt; O[密钥和令牌]
        P[最小权限原则] --&gt; Q[仅授予必要权限]
    end
    
    style A fill:#e3f2fd
    style C fill:#f3e5f5
    style D fill:#e8f5e8
    style J fill:#fff3e0
</code></pre>
<h3 data-id="heading-27">六：常见CI/CD技巧</h3>
<h4 data-id="heading-28">6.1 使用缓存加速构建</h4>
<p>Flutter项目依赖下载很慢，使用缓存可以大幅提速：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">build:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Cache</span> <span class="hljs-string">Flutter</span> <span class="hljs-string">dependencies</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/cache@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">|
            /opt/hostedtoolcache/flutter
            ${{ github.workspace }}/.pub-cache
            ${{ github.workspace }}/build
</span>          <span class="hljs-attr">key:</span> <span class="hljs-string">${{</span> <span class="hljs-string">runner.os</span> <span class="hljs-string">}}-flutter-${{</span> <span class="hljs-string">hashFiles('pubspec.lock')</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">restore-keys:</span> <span class="hljs-string">|
            ${{ runner.os }}-flutter-
</span>            
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Cache</span> <span class="hljs-string">Android</span> <span class="hljs-string">dependencies</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/cache@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">|
            ~/.gradle/caches
            ~/.gradle/wrapper
</span>          <span class="hljs-attr">key:</span> <span class="hljs-string">${{</span> <span class="hljs-string">runner.os</span> <span class="hljs-string">}}-gradle-${{</span> <span class="hljs-string">hashFiles('**/*.gradle*',</span> <span class="hljs-string">'**/gradle-wrapper.properties'</span><span class="hljs-string">)</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">restore-keys:</span> <span class="hljs-string">|
            ${{ runner.os }}-gradle-
</span></code></pre>
<h4 data-id="heading-29">6.2 构建策略</h4>
<p>同时测试多个配置组合：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">test:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.os</span> <span class="hljs-string">}}</span>
    
    <span class="hljs-attr">strategy:</span>
      <span class="hljs-attr">matrix:</span>
        <span class="hljs-comment"># 定义</span>
        <span class="hljs-attr">os:</span> [<span class="hljs-string">ubuntu-latest</span>, <span class="hljs-string">macos-latest</span>]
        <span class="hljs-attr">flutter-version:</span> [<span class="hljs-string">'3.7.x'</span>, <span class="hljs-string">'3.10.x'</span>]
    
        <span class="hljs-attr">exclude:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">os:</span> <span class="hljs-string">macos-latest</span>
            <span class="hljs-attr">flutter-version:</span> <span class="hljs-string">'3.7.x'</span>
        <span class="hljs-comment"># 包含特定组合</span>
        <span class="hljs-attr">include:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">os:</span> <span class="hljs-string">windows-latest</span>
            <span class="hljs-attr">flutter-version:</span> <span class="hljs-string">'3.10.x'</span>
            <span class="hljs-attr">channel:</span> <span class="hljs-string">'beta'</span>
            
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Test</span> <span class="hljs-string">on</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.os</span> <span class="hljs-string">}}</span> <span class="hljs-string">with</span> <span class="hljs-string">Flutter</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.flutter-version</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">echo</span> <span class="hljs-string">"Running tests..."</span>
</code></pre>
<h4 data-id="heading-30">6.3 条件执行与工作流控制</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">deploy:</span>
    <span class="hljs-comment"># 只有特定分支才执行</span>
    <span class="hljs-attr">if:</span> <span class="hljs-string">github.ref</span> <span class="hljs-string">==</span> <span class="hljs-string">'refs/heads/main'</span>
    
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Check</span> <span class="hljs-string">changed</span> <span class="hljs-string">files</span>
        <span class="hljs-comment"># 只有特定文件改动才执行</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">dorny/paths-filter@v2</span>
        <span class="hljs-attr">id:</span> <span class="hljs-string">changes</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">filters:</span> <span class="hljs-string">|
            src:
              - 'src/**'
            configs:
              - 'config/**'
              
</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">if</span> <span class="hljs-string">src</span> <span class="hljs-string">changed</span>
        <span class="hljs-attr">if:</span> <span class="hljs-string">steps.changes.outputs.src</span> <span class="hljs-string">==</span> <span class="hljs-string">'true'</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">echo</span> <span class="hljs-string">"Source code changed"</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Skip</span> <span class="hljs-string">if</span> <span class="hljs-string">only</span> <span class="hljs-string">docs</span> <span class="hljs-string">changed</span>
        <span class="hljs-attr">if:</span> <span class="hljs-string">github.event_name</span> <span class="hljs-string">==</span> <span class="hljs-string">'pull_request'</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">contains(github.event.pull_request.title,</span> <span class="hljs-string">'[skip-ci]'</span><span class="hljs-string">)</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          echo "Skipping CI due to [skip-ci] in PR title"
          exit 0
</span></code></pre>
<h4 data-id="heading-31">6.4 自定义Actions</h4>
<p>当通用Actions不够用时，可以自定义：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># .github/actions/flutter-setup/action.yml</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">'Flutter Setup with Custom Options'</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">'Setup Flutter environment with custom configurations'</span>

<span class="hljs-attr">inputs:</span>
  <span class="hljs-attr">flutter-version:</span>
    <span class="hljs-attr">description:</span> <span class="hljs-string">'Flutter version'</span>
    <span class="hljs-attr">required:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">default:</span> <span class="hljs-string">'stable'</span>
  <span class="hljs-attr">channel:</span>
    <span class="hljs-attr">description:</span> <span class="hljs-string">'Flutter channel'</span>
    <span class="hljs-attr">required:</span> <span class="hljs-literal">false</span>
    <span class="hljs-attr">default:</span> <span class="hljs-string">'stable'</span>
  <span class="hljs-attr">enable-web:</span>
    <span class="hljs-attr">description:</span> <span class="hljs-string">'Enable web support'</span>
    <span class="hljs-attr">required:</span> <span class="hljs-literal">false</span>
    <span class="hljs-attr">default:</span> <span class="hljs-string">'false'</span>

<span class="hljs-attr">runs:</span>
  <span class="hljs-attr">using:</span> <span class="hljs-string">"composite"</span>
  <span class="hljs-attr">steps:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Flutter</span>
      <span class="hljs-attr">uses:</span> <span class="hljs-string">subosito/flutter-action@v2</span>
      <span class="hljs-attr">with:</span>
        <span class="hljs-attr">flutter-version:</span> <span class="hljs-string">${{</span> <span class="hljs-string">inputs.flutter-version</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">channel:</span> <span class="hljs-string">${{</span> <span class="hljs-string">inputs.channel</span> <span class="hljs-string">}}</span>
        
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Enable</span> <span class="hljs-string">web</span> <span class="hljs-string">if</span> <span class="hljs-string">needed</span>
      <span class="hljs-attr">if:</span> <span class="hljs-string">${{</span> <span class="hljs-string">inputs.enable-web</span> <span class="hljs-string">==</span> <span class="hljs-string">'true'</span> <span class="hljs-string">}}</span>
      <span class="hljs-attr">shell:</span> <span class="hljs-string">bash</span>
      <span class="hljs-attr">run:</span> <span class="hljs-string">flutter</span> <span class="hljs-string">config</span> <span class="hljs-string">--enable-web</span>
      
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">licenses</span>
      <span class="hljs-attr">shell:</span> <span class="hljs-string">bash</span>
      <span class="hljs-attr">run:</span> <span class="hljs-string">flutter</span> <span class="hljs-string">doctor</span> <span class="hljs-string">--android-licenses</span>
</code></pre>
<h3 data-id="heading-32">七：为现有项目添加CI/CD</h3>
<h4 data-id="heading-33">7.1 分析现有项目</h4>
<p>如果我们有一个现成的Flutter应用，需要添加CI/CD：</p>
<pre><code class="hljs language-bash" lang="bash">项目结构：
my_flutter_app/
├── lib/
├── <span class="hljs-built_in">test</span>/
├── android/
├── ios/
└── pubspec.yaml
</code></pre>
<p><strong>当前问题</strong>：</p>
<ol>
<li>手动测试，经常漏测</li>
<li>打包需要20分钟，且容易出错</li>
<li>不同开发者环境不一致</li>
<li>发布流程繁琐</li>
</ol>
<h4 data-id="heading-34">7.2 分阶段实施自动化</h4>
<p><strong>第一阶段：实现基础CI</strong></p>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 添加基础测试流水线</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 代码质量检查</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 配置GitHub Actions</li>
</ul>
<p><strong>第二阶段：自动化构建</strong></p>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> Android自动打包</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> iOS自动打包</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 多环境配置</li>
</ul>
<p><strong>第三阶段：自动化发布</strong></p>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 测试环境自动分发</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 生产环境自动发布</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 监控与告警</li>
</ul>
<h4 data-id="heading-35">7.3 配置文件</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># .github/workflows/ecommerce-ci.yml</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">E-commerce</span> <span class="hljs-string">App</span> <span class="hljs-string">CI/CD</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span> [<span class="hljs-string">develop</span>]
  <span class="hljs-attr">pull_request:</span>
    <span class="hljs-attr">branches:</span> [<span class="hljs-string">main</span>, <span class="hljs-string">develop</span>]
  <span class="hljs-attr">schedule:</span>
    <span class="hljs-comment"># 每天凌晨2点跑一遍测试</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">cron:</span> <span class="hljs-string">'0 2 * * *'</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-comment"># 代码质量</span>
  <span class="hljs-attr">quality-gate:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-attr">outputs:</span>
      <span class="hljs-attr">passed:</span> <span class="hljs-string">${{</span> <span class="hljs-string">steps.quality-check.outputs.passed</span> <span class="hljs-string">}}</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Quality</span> <span class="hljs-string">Check</span>
        <span class="hljs-attr">id:</span> <span class="hljs-string">quality-check</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # 代码规范检查
          flutter analyze . || echo "::warning::Code analysis failed"
</span>          
          <span class="hljs-comment"># 检查测试覆盖率</span>
          <span class="hljs-string">flutter</span> <span class="hljs-string">test</span> <span class="hljs-string">--coverage</span>
          <span class="hljs-string">PERCENTAGE=$(lcov</span> <span class="hljs-string">--summary</span> <span class="hljs-string">coverage/lcov.info</span> <span class="hljs-string">|</span> <span class="hljs-string">grep</span> <span class="hljs-string">lines</span> <span class="hljs-string">|</span> <span class="hljs-string">awk</span> <span class="hljs-string">'{print $4}'</span> <span class="hljs-string">|</span> <span class="hljs-string">sed</span> <span class="hljs-string">'s/%//'</span><span class="hljs-string">)</span>
          <span class="hljs-string">if</span> <span class="hljs-string">((</span> <span class="hljs-string">$(echo</span> <span class="hljs-string">"$PERCENTAGE &lt; 80"</span> <span class="hljs-string">|</span> <span class="hljs-string">bc</span> <span class="hljs-string">-l)</span> <span class="hljs-string">));</span> <span class="hljs-string">then</span>
            <span class="hljs-string">echo</span> <span class="hljs-string">"::error::Test coverage $PERCENTAGE% is below 80% threshold"</span>
            <span class="hljs-string">echo</span> <span class="hljs-string">"passed=false"</span> <span class="hljs-string">&gt;&gt;</span> <span class="hljs-string">$GITHUB_OUTPUT</span>
          <span class="hljs-string">else</span>
            <span class="hljs-string">echo</span> <span class="hljs-string">"passed=true"</span> <span class="hljs-string">&gt;&gt;</span> <span class="hljs-string">$GITHUB_OUTPUT</span>
          <span class="hljs-string">fi</span>
          
  <span class="hljs-comment"># 集成测试</span>
  <span class="hljs-attr">integration-test:</span>
    <span class="hljs-attr">needs:</span> <span class="hljs-string">quality-gate</span>
    <span class="hljs-attr">if:</span> <span class="hljs-string">needs.quality-gate.outputs.passed</span> <span class="hljs-string">==</span> <span class="hljs-string">'true'</span>
    
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">macos-latest</span>
    
    <span class="hljs-attr">services:</span>
      <span class="hljs-comment"># 启动测试数据库</span>
      <span class="hljs-attr">postgres:</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">postgres:14</span>
        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">POSTGRES_PASSWORD:</span> <span class="hljs-string">postgres</span>
        <span class="hljs-attr">options:</span> <span class="hljs-string">&gt;-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
</span>          
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Flutter</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">subosito/flutter-action@v2</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">integration</span> <span class="hljs-string">tests</span> <span class="hljs-string">with</span> <span class="hljs-string">database</span>
        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">DATABASE_URL:</span> <span class="hljs-string">postgres://postgres:postgres@postgres:5432/test_db</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          flutter test integration_test/ --dart-define=DATABASE_URL=$DATABASE_URL
</span>          
  <span class="hljs-comment"># 性能测试</span>
  <span class="hljs-attr">performance-test:</span>
    <span class="hljs-attr">needs:</span> <span class="hljs-string">integration-test</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">performance</span> <span class="hljs-string">benchmarks</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # 运行性能测试
          flutter drive --target=test_driver/app_perf.dart
</span>          
          <span class="hljs-comment"># 分析性能数据</span>
          <span class="hljs-string">dart</span> <span class="hljs-string">analyze_performance.dart</span> <span class="hljs-string">perf_data.json</span>
          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">performance</span> <span class="hljs-string">report</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/upload-artifact@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">performance-report</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">perf_report.json</span>
          
  <span class="hljs-comment"># 安全扫描</span>
  <span class="hljs-attr">security-scan:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">security</span> <span class="hljs-string">scan</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">snyk/actions/dart@master</span>
        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">SNYK_TOKEN:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.SNYK_TOKEN</span> <span class="hljs-string">}}</span>
          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Check</span> <span class="hljs-string">for</span> <span class="hljs-string">secrets</span> <span class="hljs-string">in</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">trufflesecurity/trufflehog@main</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">./</span>
          
  <span class="hljs-comment"># 报告</span>
  <span class="hljs-attr">report:</span>
    <span class="hljs-attr">needs:</span> [<span class="hljs-string">quality-gate</span>, <span class="hljs-string">integration-test</span>, <span class="hljs-string">performance-test</span>, <span class="hljs-string">security-scan</span>]
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-attr">if:</span> <span class="hljs-string">always()</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Generate</span> <span class="hljs-string">CI/CD</span> <span class="hljs-string">Report</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          echo "# CI/CD Run Report" &gt; report.md
          echo "## Run: ${{ github.run_id }}" &gt;&gt; report.md
          echo "## Status: ${{ job.status }}" &gt;&gt; report.md
          echo "## Jobs:" &gt;&gt; report.md
          echo "- Quality Gate: ${{ needs.quality-gate.result }}" &gt;&gt; report.md
          echo "- Integration Test: ${{ needs.integration-test.result }}" &gt;&gt; report.md
          echo "- Performance Test: ${{ needs.performance-test.result }}" &gt;&gt; report.md
          echo "- Security Scan: ${{ needs.security-scan.result }}" &gt;&gt; report.md
</span>          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">report</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/upload-artifact@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">ci-cd-report</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">report.md</span>
</code></pre>
<h4 data-id="heading-36">7.4 流程优化</h4>
<p>CI/CD不是一次性的，需要持续优化：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 监控CI/CD性能</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">CI/CD</span> <span class="hljs-string">Performance</span> <span class="hljs-string">Monitoring</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">workflow_run:</span>
    <span class="hljs-attr">workflows:</span> [<span class="hljs-string">"E-commerce App CI/CD"</span>]
    <span class="hljs-attr">types:</span> [<span class="hljs-string">completed</span>]

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">analyze-performance:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Download</span> <span class="hljs-string">workflow</span> <span class="hljs-string">artifacts</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/github-script@v6</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">script:</span> <span class="hljs-string">|
            const { data: artifacts } = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id,
            });
</span>            
            <span class="hljs-string">//</span> <span class="hljs-string">分析执行时间</span>
            <span class="hljs-string">const</span> <span class="hljs-string">runDuration</span> <span class="hljs-string">=</span> <span class="hljs-string">new</span> <span class="hljs-string">Date(context.payload.workflow_run.updated_at)</span> <span class="hljs-bullet">-</span> 
                               <span class="hljs-string">new</span> <span class="hljs-string">Date(context.payload.workflow_run.run_started_at);</span>
            
            <span class="hljs-string">console.log(`Workflow</span> <span class="hljs-string">took</span> <span class="hljs-string">${runDuration</span> <span class="hljs-string">/</span> <span class="hljs-number">1000</span><span class="hljs-string">}</span> <span class="hljs-string">seconds`);</span>
            
            <span class="hljs-string">//</span> <span class="hljs-string">发送到监控系统</span>
            <span class="hljs-string">//</span> <span class="hljs-string">...</span>
            
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Send</span> <span class="hljs-string">to</span> <span class="hljs-string">monitoring</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # 发送指标到Prometheus/Grafana
          echo "ci_duration_seconds $DURATION" | \
            curl -X POST -H "Content-Type: text/plain" \
            --data-binary @- http://monitoring.xxxx.com/metrics
</span></code></pre>
<h3 data-id="heading-37">八：常见问题</h3>
<h4 data-id="heading-38">8.1 GitHub Actions常见问题</h4>
<p><strong>Q：工作流运行太慢怎么办？</strong></p>
<p>A：优化手段：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 1. 使用缓存</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/cache@v3</span>
  <span class="hljs-attr">with:</span>
    <span class="hljs-attr">path:</span> <span class="hljs-string">~/.pub-cache</span>
    <span class="hljs-attr">key:</span> <span class="hljs-string">${{</span> <span class="hljs-string">runner.os</span> <span class="hljs-string">}}-pub-${{</span> <span class="hljs-string">hashFiles('pubspec.lock')</span> <span class="hljs-string">}}</span>

<span class="hljs-comment"># 2. 并行执行独立任务</span>
<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">test-android:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
  <span class="hljs-attr">test-ios:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">macos-latest</span>
  <span class="hljs-comment"># 两个任务会并行执行</span>

<span class="hljs-comment"># 3. 项目大可以考虑使用自托管Runner</span>
<span class="hljs-attr">runs-on:</span> [<span class="hljs-string">self-hosted</span>, <span class="hljs-string">linux</span>, <span class="hljs-string">x64</span>]
</code></pre>
<p><strong>Q：iOS构建失败，证书问题？</strong></p>
<p>A：iOS证书配置流程：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 导出开发证书</span>
openssl pkcs12 -<span class="hljs-keyword">in</span> certificate.p12 -out certificate.pem -nodes

<span class="hljs-comment"># 2. 在GitHub Secrets中存储</span>
<span class="hljs-comment"># 使用base64编码</span>
<span class="hljs-built_in">base64</span> -i certificate.p12 &gt; certificate.txt

<span class="hljs-comment"># 3. 在CI中还原</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">${{ secrets.IOS_CERTIFICATE }</span>}"</span> | <span class="hljs-built_in">base64</span> --decode &gt; certificate.p12
security import certificate.p12 -k build.keychain -P <span class="hljs-string">"<span class="hljs-variable">${{ secrets.CERT_PASSWORD }</span>}"</span>
</code></pre>
<p><strong>Q：如何调试失败的CI？</strong></p>
<p>A：调试技巧：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 1. 启用调试日志</span>
<span class="hljs-attr">run:</span> <span class="hljs-string">|
  # 显示详细日志
  flutter build apk --verbose
</span>  
  <span class="hljs-comment"># 或使用环境变量</span>
  <span class="hljs-attr">env:</span>
    <span class="hljs-attr">FLUTTER_VERBOSE:</span> <span class="hljs-literal">true</span>

<span class="hljs-comment"># 2. 上传构建日志</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">build</span> <span class="hljs-string">logs</span>
  <span class="hljs-attr">if:</span> <span class="hljs-string">failure()</span>
  <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/upload-artifact@v3</span>
  <span class="hljs-attr">with:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">build-logs</span>
    <span class="hljs-attr">path:</span> <span class="hljs-string">|
      ~/flutter/bin/cache/
      build/
</span>      
<span class="hljs-comment"># 3. 使用tmate进行SSH调试</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">tmate</span> <span class="hljs-string">session</span>
  <span class="hljs-attr">uses:</span> <span class="hljs-string">mxschmitt/action-tmate@v3</span>
  <span class="hljs-attr">if:</span> <span class="hljs-string">failure()</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">github.ref</span> <span class="hljs-string">==</span> <span class="hljs-string">'refs/heads/main'</span>
</code></pre>
<h4 data-id="heading-39">8.2 Flutter问题</h4>
<p><strong>Q：不同版本兼容性？</strong></p>
<p>A：版本管理策略：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 使用版本测试兼容性</span>
<span class="hljs-attr">strategy:</span>
  <span class="hljs-attr">matrix:</span>
    <span class="hljs-attr">flutter-version:</span> [<span class="hljs-string">'3.7.x'</span>, <span class="hljs-string">'3.10.x'</span>, <span class="hljs-string">'stable'</span>]
    
<span class="hljs-comment"># 在代码中检查版本</span>
<span class="hljs-string">void</span> <span class="hljs-string">checkFlutterVersion()</span> {
  <span class="hljs-string">const</span> <span class="hljs-string">minVersion</span> <span class="hljs-string">=</span> <span class="hljs-string">'3.7.0'</span><span class="hljs-string">;</span>
  <span class="hljs-string">final</span> <span class="hljs-string">currentVersion</span> <span class="hljs-string">=</span> <span class="hljs-string">FlutterVersion.instance.version;</span>
  
  <span class="hljs-string">if</span> <span class="hljs-string">(Version.parse(currentVersion)</span> <span class="hljs-string">&lt;</span> <span class="hljs-string">Version.parse(minVersion))</span> {
    <span class="hljs-string">throw</span> <span class="hljs-string">Exception('Flutter</span> <span class="hljs-string">version</span> <span class="hljs-string">$minVersion</span> <span class="hljs-string">or</span> <span class="hljs-string">higher</span> <span class="hljs-string">required');</span>
  }
}
</code></pre>
<p><strong>Q：Web构建失败？</strong></p>
<p>A：Web构建配置：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 确保启用Web支持</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Enable</span> <span class="hljs-string">web</span>
  <span class="hljs-attr">run:</span> <span class="hljs-string">flutter</span> <span class="hljs-string">config</span> <span class="hljs-string">--enable-web</span>

<span class="hljs-comment"># 构建Web版本</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">for</span> <span class="hljs-string">web</span>
  <span class="hljs-attr">run:</span> <span class="hljs-string">|
    flutter build web \
      --web-renderer canvaskit \
      --release \
      --dart-define=FLUTTER_WEB_USE_SKIA=true
      
</span><span class="hljs-comment"># 处理Web特定问题</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Fix</span> <span class="hljs-string">web</span> <span class="hljs-string">issues</span>
  <span class="hljs-attr">run:</span> <span class="hljs-string">|
    # 清理缓存
    flutter clean
</span>    
    <span class="hljs-comment"># 更新Web引擎</span>
    <span class="hljs-string">flutter</span> <span class="hljs-string">precache</span> <span class="hljs-string">--web</span>
</code></pre>
<h4 data-id="heading-40">8.3 安全与权限问题</h4>
<p><strong>Q：如何管理敏感信息？</strong></p>
<p>A：安全实践：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 1. 使用环境级别的Secrets</span>
<span class="hljs-attr">env:</span>
  <span class="hljs-attr">SUPER_SECRET_KEY:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.PRODUCTION_KEY</span> <span class="hljs-string">}}</span>

<span class="hljs-comment"># 2. 最小权限原则</span>
<span class="hljs-attr">permissions:</span>
  <span class="hljs-attr">contents:</span> <span class="hljs-string">read</span>
  <span class="hljs-attr">packages:</span> <span class="hljs-string">write</span>  <span class="hljs-comment"># 只有需要时才写</span>
  
<span class="hljs-comment"># 3. 使用临时凭证</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Configure</span> <span class="hljs-string">AWS</span> <span class="hljs-string">credentials</span>
  <span class="hljs-attr">uses:</span> <span class="hljs-string">aws-actions/configure-aws-credentials@v1</span>
  <span class="hljs-attr">with:</span>
    <span class="hljs-attr">aws-access-key-id:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.AWS_ACCESS_KEY_ID</span> <span class="hljs-string">}}</span>
    <span class="hljs-attr">aws-secret-access-key:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.AWS_SECRET_ACCESS_KEY</span> <span class="hljs-string">}}</span>
    <span class="hljs-attr">aws-region:</span> <span class="hljs-string">us-east-1</span>
    
<span class="hljs-comment"># 4. 定期轮换密钥</span>
<span class="hljs-comment"># 设置提醒每月更新一次Secrets</span>
</code></pre>
<h3 data-id="heading-41">最后</h3>
<p>通过这篇教程我们掌握了Flutter CI/CD的核心知识，一个完美的流水线是一次次迭代出来的，需要不断优化。<strong>如果觉得文章对你有帮助，别忘了一键三连，支持一下</strong></p>
<hr/>
<p><strong>有任何问题或想法，欢迎在评论区交流讨论。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Gemini简直无敌了】掌间星河：通过MediaPipe实现手势控制粒子]]></title>    <link>https://juejin.cn/post/7585463258690863113</link>    <guid>https://juejin.cn/post/7585463258690863113</guid>    <pubDate>2025-12-20T09:15:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463258690863113" data-draft-id="7585706951583416329" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Gemini简直无敌了】掌间星河：通过MediaPipe实现手势控制粒子"/> <meta itemprop="keywords" content="Gemini,React.js"/> <meta itemprop="datePublished" content="2025-12-20T09:15:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小鱼小鱼干"/> <meta itemprop="url" content="https://juejin.cn/user/2162083945256777"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Gemini简直无敌了】掌间星河：通过MediaPipe实现手势控制粒子
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2162083945256777/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小鱼小鱼干
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T09:15:45.000Z" title="Sat Dec 20 2025 09:15:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>受掘金大佬“不如摸鱼去”的启发，我也试试 Gemini 3做一下手势+粒子交互， 确实学到了不少东西，在这里简单的分享下。
github地址：掌间星河：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhuijieya%2FGesture-Galaxy.git" target="_blank" title="https://github.com/huijieya/Gesture-Galaxy.git" ref="nofollow noopener noreferrer">github.com/huijieya/Ge…</a></p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25f905388d114ac69818a85dd2cf3cf5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6bG85bCP6bG85bmy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766826945&amp;x-signature=lrD0UZyeu9uscVe8UxT8t66b%2FIE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<pre><code class="hljs language-javascript" lang="javascript">基于原生h5、浏览器、<span class="hljs-variable constant_">PC</span>摄像头实现手势控制粒子特效交互的逻辑，粒子默认离散，类似银河系分布缓慢移动，同时有<span class="hljs-number">5</span>种手势：

手势<span class="hljs-number">1</span>: 握拳，握拳后粒子聚拢显示爱心的形状

手势<span class="hljs-number">2</span>: 展开手掌并挥手，展开手掌挥手后粒子从当前状态恢复到离散状态

手势<span class="hljs-number">3</span>: 👆 比 <span class="hljs-number">1</span> ：只有食指伸直，其他 <span class="hljs-number">3</span> 根弯曲，此时粒子聚拢显示第一句话：春来夏往

手势<span class="hljs-number">4</span>: ✌ 比 <span class="hljs-number">2</span> ：只有食指和中指伸直，其他 <span class="hljs-number">2</span> 根弯曲手此时粒子聚拢显示第二句话： 秋收冬藏

手势<span class="hljs-number">5</span>: 👌 比 <span class="hljs-number">3</span> ：只有中指、无名指、小指伸直，食指弯曲，此时粒子聚拢显示第三句话：我们来日方长
</code></pre>
<h2 data-id="heading-0">效果展示</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/692793d7f1254e37a0fa1f4787aa72a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6bG85bCP6bG85bmy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766826945&amp;x-signature=AUwLnI1AilLfnzkzxYmDz7tjPvI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-1">源码地址</h2>
<p>掌间星河：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhuijieya%2FGesture-Galaxy.git" target="_blank" title="https://github.com/huijieya/Gesture-Galaxy.git" ref="nofollow noopener noreferrer">github.com/huijieya/Ge…</a></p>
<h2 data-id="heading-2">源码分析</h2>
<h3 data-id="heading-3">手势识别流程</h3>
<h4 data-id="heading-4">1. 手部检测初始化</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// HandTracker.tsx 中初始化 MediaPipe Hands</span>
<span class="hljs-keyword">const</span> hands = <span class="hljs-keyword">new</span> (<span class="hljs-variable language_">window</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-title class_">Hands</span>({
  <span class="hljs-attr">locateFile</span>: <span class="hljs-function">(<span class="hljs-params">file: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-string">`https://cdn.jsdelivr.net/npm/@mediapipe/hands/<span class="hljs-subst">${file}</span>`</span>
});

hands.<span class="hljs-title function_">setOptions</span>({
  <span class="hljs-attr">maxNumHands</span>: <span class="hljs-number">1</span>,           <span class="hljs-comment">// 最多检测一只手</span>
  <span class="hljs-attr">modelComplexity</span>: <span class="hljs-number">1</span>,       <span class="hljs-comment">// 模型复杂度</span>
  <span class="hljs-attr">minDetectionConfidence</span>: <span class="hljs-number">0.7</span>,  <span class="hljs-comment">// 最小检测置信度</span>
  <span class="hljs-attr">minTrackingConfidence</span>: <span class="hljs-number">0.7</span>    <span class="hljs-comment">// 最小跟踪置信度</span>
});
</code></pre>
<h4 data-id="heading-5">2. 手部关键点获取</h4>
<p>MediaPipe 会检测手部的21个关键点（landmarks），每个关键点包含 x, y, z 坐标：</p>
<ul>
<li>指尖: 4(拇指), 8(食指), 12(中指), 16(无名指), 20(小指)</li>
<li>指关节: 用于判断手指是否伸直</li>
</ul>
<h4 data-id="heading-6">3. 手势分类逻辑</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// gestureLogic.ts 中的 classifyGesture 函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">isExtended</span> = (<span class="hljs-params">tipIdx: <span class="hljs-built_in">number</span>, mcpIdx: <span class="hljs-built_in">number</span></span>) =&gt; landmarks[tipIdx].<span class="hljs-property">y</span> &lt; landmarks[mcpIdx].<span class="hljs-property">y</span>;

<span class="hljs-comment">// 判断各手指是否伸直</span>
<span class="hljs-keyword">const</span> indexExt = <span class="hljs-title function_">isExtended</span>(<span class="hljs-number">8</span>, <span class="hljs-number">5</span>);   <span class="hljs-comment">// 食指</span>
<span class="hljs-keyword">const</span> middleExt = <span class="hljs-title function_">isExtended</span>(<span class="hljs-number">12</span>, <span class="hljs-number">9</span>); <span class="hljs-comment">// 中指</span>
<span class="hljs-keyword">const</span> ringExt = <span class="hljs-title function_">isExtended</span>(<span class="hljs-number">16</span>, <span class="hljs-number">13</span>);  <span class="hljs-comment">// 无名指</span>
<span class="hljs-keyword">const</span> pinkyExt = <span class="hljs-title function_">isExtended</span>(<span class="hljs-number">20</span>, <span class="hljs-number">17</span>); <span class="hljs-comment">// 小指</span>

<span class="hljs-comment">// 根据手指状态识别不同手势</span>
<span class="hljs-keyword">if</span> (!indexExt &amp;&amp; !middleExt &amp;&amp; !ringExt &amp;&amp; !pinkyExt) {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">GestureType</span>.<span class="hljs-property">HEART</span>; <span class="hljs-comment">// 握拳 - 显示爱心</span>
}
<span class="hljs-keyword">if</span> (indexExt &amp;&amp; middleExt &amp;&amp; ringExt &amp;&amp; pinkyExt) {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">GestureType</span>.<span class="hljs-property">GALAXY</span>; <span class="hljs-comment">// 手掌展开 - 银河状态</span>
}
<span class="hljs-comment">// ... 其他手势判断</span>
</code></pre>
<h3 data-id="heading-7">粒子绘制机制</h3>
<h4 data-id="heading-8">1. 粒子系统初始化</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ParticleCanvas.tsx 中初始化粒子</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">particles</span>: <span class="hljs-title class_">Particle</span>[] = [];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable constant_">PARTICLE_COUNT</span>; i++) {
    particles.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">x</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>,     <span class="hljs-comment">// 随机初始位置</span>
      <span class="hljs-attr">y</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>,
      <span class="hljs-attr">targetX</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-comment">// 目标位置</span>
      <span class="hljs-attr">targetY</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>,
      <span class="hljs-attr">vx</span>: <span class="hljs-number">0</span>,                                    <span class="hljs-comment">// 速度</span>
      <span class="hljs-attr">vy</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">size</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">1.5</span> + <span class="hljs-number">0.5</span>,          <span class="hljs-comment">// 大小</span>
      <span class="hljs-attr">color</span>: <span class="hljs-variable constant_">COLORS</span>[<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-variable constant_">COLORS</span>.<span class="hljs-property">length</span>)], <span class="hljs-comment">// 颜色</span>
      <span class="hljs-attr">alpha</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.4</span> + <span class="hljs-number">0.4</span>,         <span class="hljs-comment">// 透明度</span>
    });
  }
  particlesRef.<span class="hljs-property">current</span> = particles;
}, []);
</code></pre>
<h4 data-id="heading-9">2. 形状生成算法</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> getShapePoints = (<span class="hljs-attr">type</span>: <span class="hljs-title class_">GestureType</span>, <span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">Point</span>[] =&gt; {
  <span class="hljs-keyword">const</span> centerX = width / <span class="hljs-number">2</span>;
  <span class="hljs-keyword">const</span> centerY = height / <span class="hljs-number">2</span>;
  
  <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">GestureType</span>.<span class="hljs-property">HEART</span>: 
      <span class="hljs-comment">// 心形方程参数化生成点</span>
      <span class="hljs-comment">// x = 16sin³(t)</span>
      <span class="hljs-comment">// y = 13cos(t) - 5cos(2t) - 2cos(3t) - cos(4t)</span>
      
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">GestureType</span>.<span class="hljs-property">TEXT_1</span>/<span class="hljs-number">2</span>/<span class="hljs-number">3</span>:
      <span class="hljs-comment">// 使用 Canvas 绘制文字并提取像素点</span>
      
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">GestureType</span>.<span class="hljs-property">GALAXY</span>:
    <span class="hljs-attr">default</span>:
      <span class="hljs-comment">// 螺旋银河形状</span>
      <span class="hljs-keyword">const</span> angle = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>;
      <span class="hljs-keyword">const</span> r = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>(), <span class="hljs-number">0.7</span>) * maxRadius;
      <span class="hljs-keyword">const</span> spiralFactor = <span class="hljs-number">2.0</span>;
      <span class="hljs-keyword">const</span> offset = r * (spiralFactor / maxRadius) * <span class="hljs-number">5</span>;
      points.<span class="hljs-title function_">push</span>({ 
        <span class="hljs-attr">x</span>: centerX + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(angle + offset) * r, 
        <span class="hljs-attr">y</span>: centerY + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(angle + offset) * r 
      });
  }
}
</code></pre>
<h4 data-id="heading-10">3. 粒子动画更新</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 粒子运动和渲染循环</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">render</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 半透明背景覆盖产生拖尾效果</span>
  ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'rgba(0, 0, 0, 0.18)'</span>;
  ctx.<span class="hljs-title function_">fillRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, canvas.<span class="hljs-property">width</span>, canvas.<span class="hljs-property">height</span>);
  
  particlesRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> {
    <span class="hljs-comment">// 平滑插值移动到目标位置</span>
    p.<span class="hljs-property">x</span> += (tx - p.<span class="hljs-property">x</span>) * <span class="hljs-variable constant_">LERP_FACTOR</span>;
    p.<span class="hljs-property">y</span> += (ty - p.<span class="hljs-property">y</span>) * <span class="hljs-variable constant_">LERP_FACTOR</span>;
    
    <span class="hljs-comment">// 手势交互影响粒子位置</span>
    <span class="hljs-keyword">if</span> (hPos &amp;&amp; canInteract) {
      <span class="hljs-keyword">const</span> dx = p.<span class="hljs-property">x</span> - hPos.<span class="hljs-property">x</span>;
      <span class="hljs-keyword">const</span> dy = p.<span class="hljs-property">y</span> - hPos.<span class="hljs-property">y</span>;
      <span class="hljs-keyword">const</span> distSq = dx * dx + dy * dy;
      <span class="hljs-keyword">if</span> (distSq &lt; <span class="hljs-variable constant_">INTERACTION_RADIUS</span> * <span class="hljs-variable constant_">INTERACTION_RADIUS</span>) {
        <span class="hljs-comment">// 排斥力计算</span>
        <span class="hljs-keyword">const</span> dist = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(distSq);
        <span class="hljs-keyword">const</span> force = (<span class="hljs-number">1</span> - dist / <span class="hljs-variable constant_">INTERACTION_RADIUS</span>) * <span class="hljs-variable constant_">INTERACTION_STRENGTH</span>;
        p.<span class="hljs-property">x</span> += dx * force;
        p.<span class="hljs-property">y</span> += dy * force;
      }
    }
    
    <span class="hljs-comment">// 添加随机扰动使粒子更生动</span>
    p.<span class="hljs-property">x</span> += (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">0.5</span>) * <span class="hljs-number">0.6</span>;
    p.<span class="hljs-property">y</span> += (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">0.5</span>) * <span class="hljs-number">0.6</span>;
    
    <span class="hljs-comment">// 绘制粒子</span>
    ctx.<span class="hljs-property">fillStyle</span> = p.<span class="hljs-property">color</span>;
    ctx.<span class="hljs-property">globalAlpha</span> = p.<span class="hljs-property">alpha</span>;
    ctx.<span class="hljs-title function_">beginPath</span>();
    ctx.<span class="hljs-title function_">arc</span>(p.<span class="hljs-property">x</span>, p.<span class="hljs-property">y</span>, p.<span class="hljs-property">size</span>, <span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>);
    ctx.<span class="hljs-title function_">fill</span>();
  });
  
  animationRef.<span class="hljs-property">current</span> = <span class="hljs-title function_">requestAnimationFrame</span>(render);
};
</code></pre>
<h4 data-id="heading-11">4. 银河旋转效果</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 银河状态下的旋转动画</span>
galaxyAngleRef.<span class="hljs-property">current</span> += <span class="hljs-variable constant_">GALAXY_ROTATION_SPEED</span>;
<span class="hljs-keyword">const</span> cosA = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(galaxyAngleRef.<span class="hljs-property">current</span>);
<span class="hljs-keyword">const</span> sinA = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(galaxyAngleRef.<span class="hljs-property">current</span>);

<span class="hljs-comment">// 对每个粒子应用旋转变换</span>
<span class="hljs-keyword">const</span> dx = p.<span class="hljs-property">targetX</span> - cx;
<span class="hljs-keyword">const</span> dy = p.<span class="hljs-property">targetY</span> - cy;
tx = cx + dx * cosA - dy * sinA;
ty = cy + dx * sinA + dy * cosA;
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ConcurrentHashMap实现原理]]></title>    <link>https://juejin.cn/post/7585468725332394038</link>    <guid>https://juejin.cn/post/7585468725332394038</guid>    <pubDate>2025-12-20T09:20:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585468725332394038" data-draft-id="7585412203978948651" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ConcurrentHashMap实现原理"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-12-20T09:20:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="無量"/> <meta itemprop="url" content="https://juejin.cn/user/1116759546145086"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ConcurrentHashMap实现原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759546145086/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    無量
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T09:20:39.000Z" title="Sat Dec 20 2025 09:20:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读30分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、理论知识与核心概念</h2>
<h3 data-id="heading-1">1.1 为什么需要ConcurrentHashMap？</h3>
<p>在多线程环境下，我们经常需要使用Map来存储共享数据。但普通的<code>HashMap</code>并不是线程安全的，在高并发场景下会出现严重问题。</p>
<p><strong>HashMap的线程不安全问题：</strong></p>
<ol>
<li>
<p><strong>数据丢失</strong>：多个线程同时put，可能导致一个线程的数据被覆盖</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 线程1和线程2同时执行put</span>
Thread-<span class="hljs-number">1</span>: put(<span class="hljs-string">"key1"</span>, <span class="hljs-string">"value1"</span>)  <span class="hljs-comment">// 计算到index=5</span>
Thread-<span class="hljs-number">2</span>: put(<span class="hljs-string">"key2"</span>, <span class="hljs-string">"value2"</span>)  <span class="hljs-comment">// 也计算到index=5</span>
<span class="hljs-comment">// 结果：只有一个数据被保存，另一个丢失</span>
</code></pre>
</li>
<li>
<p><strong>死循环问题（JDK 1.7）</strong>：扩容时多线程并发导致链表成环</p>
<ul>
<li>线程A扩容到一半被挂起</li>
<li>线程B完成扩容，链表反转</li>
<li>线程A恢复执行，形成环形链表</li>
<li>get操作时CPU 100%，无限循环</li>
</ul>
</li>
<li>
<p><strong>数据不一致</strong>：size()返回值不准确，迭代过程中数据变化</p>
</li>
</ol>
<h3 data-id="heading-2">1.2 Hashtable的性能问题</h3>
<p><code>Hashtable</code>通过对所有方法加<code>synchronized</code>实现线程安全，但性能极差：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> { ... }
<span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> V <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> { ... }
</code></pre>
<p><strong>性能问题</strong>：</p>
<ul>
<li><strong>全表锁</strong>：无论操作哪个桶，都要锁住整个表</li>
<li><strong>读写互斥</strong>：即使只是读取，也需要等待写操作释放锁</li>
<li><strong>并发度为1</strong>：同一时刻只允许一个线程访问</li>
</ul>
<p><strong>性能测试数据</strong>：</p>
<ul>
<li>单线程：HashMap ≈ Hashtable</li>
<li>10线程并发：HashMap不安全，Hashtable吞吐量仅为HashMap的1/10</li>
</ul>
<h3 data-id="heading-3">1.3 Collections.synchronizedMap的局限性</h3>
<p><code>Collections.synchronizedMap</code>是对Map的简单包装：</p>
<pre><code class="hljs language-java" lang="java">Map&lt;K,V&gt; syncMap = Collections.synchronizedMap(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;());

<span class="hljs-comment">// 底层实现</span>
<span class="hljs-keyword">public</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> {
    <span class="hljs-keyword">synchronized</span> (mutex) {  <span class="hljs-comment">// mutex = this</span>
        <span class="hljs-keyword">return</span> m.put(key, value);
    }
}
</code></pre>
<p><strong>局限性</strong>：</p>
<ul>
<li>本质仍是<strong>全表锁</strong>，性能与Hashtable类似</li>
<li>迭代时需要手动加锁，否则抛<code>ConcurrentModificationException</code></li>
<li>复合操作（如putIfAbsent）不是原子的，需要额外加锁</li>
</ul>
<h3 data-id="heading-4">1.4 ConcurrentHashMap的设计目标</h3>
<p>为了解决上述问题，<code>ConcurrentHashMap</code>应运而生，设计目标：</p>
<ol>
<li><strong>高并发</strong>：支持高并发读写，锁粒度细化</li>
<li><strong>高性能</strong>：读操作无锁，写操作局部锁</li>
<li><strong>线程安全</strong>：保证数据一致性</li>
<li><strong>弱一致性</strong>：允许读到稍旧的数据，换取性能</li>
</ol>
<p><strong>核心思想</strong>：</p>
<ul>
<li><strong>分段锁（JDK 1.7）</strong>：将Map分为多个Segment，每个Segment独立加锁</li>
<li><strong>CAS + synchronized（JDK 1.8）</strong>：更细粒度的锁，锁定单个Node</li>
</ul>
<hr/>
<h2 data-id="heading-5">二、原理深度剖析</h2>
<h3 data-id="heading-6">2.1 JDK 1.7 Segment分段锁机制</h3>
<h4 data-id="heading-7">2.1.1 Segment数组结构</h4>
<p>JDK 1.7的<code>ConcurrentHashMap</code>采用<strong>Segment数组 + HashEntry数组 + 链表</strong>的结构：</p>
<pre><code class="hljs language-css" lang="css">ConcurrentHashMap
    |
    +-- Segment<span class="hljs-selector-attr">[0]</span> (extends ReentrantLock)
    |       |
    |       +-- HashEntry<span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">table</span>
    |               |
    |               +-- HashEntry -&gt; HashEntry -&gt; null (链表)
    |
    +-- Segment<span class="hljs-selector-attr">[1]</span>
    |       |
    |       +-- HashEntry<span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">table</span>
    |
    +-- Segment<span class="hljs-selector-attr">[15]</span>  (默认<span class="hljs-number">16</span>个Segment)
            |
            +-- HashEntry<span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">table</span>
</code></pre>
<p><strong>核心数据结构：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;K,V&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMap</span>&lt;K,V&gt; {
    <span class="hljs-comment">// Segment数组</span>
    <span class="hljs-keyword">final</span> Segment&lt;K,V&gt;[] segments;

    <span class="hljs-comment">// Segment继承ReentrantLock</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Segment</span>&lt;K,V&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ReentrantLock</span> {
        <span class="hljs-keyword">transient</span> <span class="hljs-keyword">volatile</span> HashEntry&lt;K,V&gt;[] table;  <span class="hljs-comment">// HashEntry数组</span>
        <span class="hljs-keyword">transient</span> <span class="hljs-type">int</span> count;  <span class="hljs-comment">// Segment中元素数量</span>
        <span class="hljs-keyword">transient</span> <span class="hljs-type">int</span> modCount;  <span class="hljs-comment">// 修改次数</span>
        <span class="hljs-keyword">transient</span> <span class="hljs-type">int</span> threshold;  <span class="hljs-comment">// 扩容阈值</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">float</span> loadFactor;  <span class="hljs-comment">// 加载因子</span>
    }

    <span class="hljs-comment">// HashEntry节点</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HashEntry</span>&lt;K,V&gt; {
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> hash;
        <span class="hljs-keyword">final</span> K key;
        <span class="hljs-keyword">volatile</span> V value;
        <span class="hljs-keyword">volatile</span> HashEntry&lt;K,V&gt; next;  <span class="hljs-comment">// volatile保证可见性</span>
    }
}
</code></pre>
<p><strong>关键参数：</strong></p>
<ul>
<li><strong>concurrencyLevel（并发度）</strong>：Segment数组长度，默认16</li>
<li><strong>initialCapacity</strong>：初始容量，默认16</li>
<li><strong>loadFactor</strong>：加载因子，默认0.75</li>
</ul>
<h4 data-id="heading-8">2.1.2 put操作流程</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> {
    Segment&lt;K,V&gt; s;
    <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>)
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>();  <span class="hljs-comment">// value不允许null</span>

    <span class="hljs-comment">// 1. 计算hash值</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> hash(key);

    <span class="hljs-comment">// 2. 定位Segment (hash &gt;&gt;&gt; segmentShift) &amp; segmentMask</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> (hash &gt;&gt;&gt; segmentShift) &amp; segmentMask;

    <span class="hljs-comment">// 3. 获取Segment</span>
    <span class="hljs-keyword">if</span> ((s = (Segment&lt;K,V&gt;)UNSAFE.getObject(segments, (j &lt;&lt; SSHIFT) + SBASE)) == <span class="hljs-literal">null</span>)
        s = ensureSegment(j);  <span class="hljs-comment">// 延迟初始化Segment</span>

    <span class="hljs-comment">// 4. 调用Segment的put方法</span>
    <span class="hljs-keyword">return</span> s.put(key, hash, value, <span class="hljs-literal">false</span>);
}

<span class="hljs-comment">// Segment的put方法</span>
<span class="hljs-keyword">final</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, <span class="hljs-type">int</span> hash, V value, <span class="hljs-type">boolean</span> onlyIfAbsent)</span> {
    <span class="hljs-comment">// 1. 尝试获取锁(tryLock)</span>
    HashEntry&lt;K,V&gt; node = tryLock() ? <span class="hljs-literal">null</span> :
        scanAndLockForPut(key, hash, value);  <span class="hljs-comment">// 失败则自旋获取锁</span>

    V oldValue;
    <span class="hljs-keyword">try</span> {
        HashEntry&lt;K,V&gt;[] tab = table;
        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> (tab.length - <span class="hljs-number">1</span>) &amp; hash;  <span class="hljs-comment">// 定位桶</span>
        HashEntry&lt;K,V&gt; first = entryAt(tab, index);  <span class="hljs-comment">// 获取链表头</span>

        <span class="hljs-comment">// 2. 遍历链表</span>
        <span class="hljs-keyword">for</span> (HashEntry&lt;K,V&gt; e = first;;) {
            <span class="hljs-keyword">if</span> (e != <span class="hljs-literal">null</span>) {
                K k;
                <span class="hljs-comment">// 找到相同key，替换value</span>
                <span class="hljs-keyword">if</span> ((k = e.key) == key ||
                    (e.hash == hash &amp;&amp; key.equals(k))) {
                    oldValue = e.value;
                    <span class="hljs-keyword">if</span> (!onlyIfAbsent) {
                        e.value = value;
                        ++modCount;
                    }
                    <span class="hljs-keyword">break</span>;
                }
                e = e.next;
            }
            <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 3. 插入新节点</span>
                <span class="hljs-keyword">if</span> (node != <span class="hljs-literal">null</span>)
                    node.setNext(first);  <span class="hljs-comment">// 头插法</span>
                <span class="hljs-keyword">else</span>
                    node = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashEntry</span>&lt;K,V&gt;(hash, key, value, first);

                <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> count + <span class="hljs-number">1</span>;
                <span class="hljs-comment">// 4. 判断是否需要扩容</span>
                <span class="hljs-keyword">if</span> (c &gt; threshold &amp;&amp; tab.length &lt; MAXIMUM_CAPACITY)
                    rehash(node);
                <span class="hljs-keyword">else</span>
                    setEntryAt(tab, index, node);
                ++modCount;
                count = c;
                oldValue = <span class="hljs-literal">null</span>;
                <span class="hljs-keyword">break</span>;
            }
        }
    } <span class="hljs-keyword">finally</span> {
        unlock();  <span class="hljs-comment">// 释放锁</span>
    }
    <span class="hljs-keyword">return</span> oldValue;
}
</code></pre>
<p><strong>流程总结：</strong></p>
<ol>
<li>计算hash，定位Segment</li>
<li>Segment加锁（ReentrantLock）</li>
<li>定位HashEntry桶位置</li>
<li>遍历链表，找到则替换，否则头插法插入</li>
<li>判断是否扩容</li>
<li>释放锁</li>
</ol>
<h4 data-id="heading-9">2.1.3 get操作</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> V <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> {
    Segment&lt;K,V&gt; s;
    HashEntry&lt;K,V&gt;[] tab;

    <span class="hljs-comment">// 1. 计算hash</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> hash(key);

    <span class="hljs-comment">// 2. 定位Segment</span>
    <span class="hljs-type">long</span> <span class="hljs-variable">u</span> <span class="hljs-operator">=</span> (((h &gt;&gt;&gt; segmentShift) &amp; segmentMask) &lt;&lt; SSHIFT) + SBASE;

    <span class="hljs-comment">// 3. 无锁获取Segment和table</span>
    <span class="hljs-keyword">if</span> ((s = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(segments, u)) != <span class="hljs-literal">null</span> &amp;&amp;
        (tab = s.table) != <span class="hljs-literal">null</span>) {

        <span class="hljs-comment">// 4. 遍历链表查找（无锁）</span>
        <span class="hljs-keyword">for</span> (HashEntry&lt;K,V&gt; e = (HashEntry&lt;K,V&gt;) UNSAFE.getObjectVolatile
                 (tab, ((<span class="hljs-type">long</span>)(((tab.length - <span class="hljs-number">1</span>) &amp; h)) &lt;&lt; TSHIFT) + TBASE);
             e != <span class="hljs-literal">null</span>; e = e.next) {
            K k;
            <span class="hljs-keyword">if</span> ((k = e.key) == key || (e.hash == h &amp;&amp; key.equals(k)))
                <span class="hljs-keyword">return</span> e.value;  <span class="hljs-comment">// volatile读，保证可见性</span>
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<p><strong>关键点：</strong></p>
<ul>
<li><strong>无锁读取</strong>：get不加锁，依赖volatile保证可见性</li>
<li><strong>UNSAFE操作</strong>：直接从内存读取，保证读到最新值</li>
<li><strong>性能极高</strong>：并发读不会阻塞</li>
</ul>
<h4 data-id="heading-10">2.1.4 扩容机制</h4>
<p><strong>Segment独立扩容</strong>：</p>
<ul>
<li>只扩容单个Segment，不影响其他Segment</li>
<li>扩容时持有Segment锁，阻塞该Segment的写操作</li>
<li>读操作仍可并发进行</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rehash</span><span class="hljs-params">(HashEntry&lt;K,V&gt; node)</span> {
    HashEntry&lt;K,V&gt;[] oldTable = table;
    <span class="hljs-type">int</span> <span class="hljs-variable">oldCapacity</span> <span class="hljs-operator">=</span> oldTable.length;

    <span class="hljs-comment">// 扩容为2倍</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">newCapacity</span> <span class="hljs-operator">=</span> oldCapacity &lt;&lt; <span class="hljs-number">1</span>;
    threshold = (<span class="hljs-type">int</span>)(newCapacity * loadFactor);

    HashEntry&lt;K,V&gt;[] newTable =
        (HashEntry&lt;K,V&gt;[]) <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashEntry</span>[newCapacity];
    <span class="hljs-type">int</span> <span class="hljs-variable">sizeMask</span> <span class="hljs-operator">=</span> newCapacity - <span class="hljs-number">1</span>;

    <span class="hljs-comment">// 遍历旧table，重新分配节点</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; oldCapacity ; i++) {
        HashEntry&lt;K,V&gt; e = oldTable[i];

        <span class="hljs-keyword">if</span> (e != <span class="hljs-literal">null</span>) {
            HashEntry&lt;K,V&gt; next = e.next;
            <span class="hljs-type">int</span> <span class="hljs-variable">idx</span> <span class="hljs-operator">=</span> e.hash &amp; sizeMask;

            <span class="hljs-keyword">if</span> (next == <span class="hljs-literal">null</span>)  <span class="hljs-comment">// 单节点直接放入</span>
                newTable[idx] = e;
            <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 遍历链表，重新hash分配</span>
                HashEntry&lt;K,V&gt; lastRun = e;
                <span class="hljs-type">int</span> <span class="hljs-variable">lastIdx</span> <span class="hljs-operator">=</span> idx;
                <span class="hljs-keyword">for</span> (HashEntry&lt;K,V&gt; last = next;
                     last != <span class="hljs-literal">null</span>;
                     last = last.next) {
                    <span class="hljs-type">int</span> <span class="hljs-variable">k</span> <span class="hljs-operator">=</span> last.hash &amp; sizeMask;
                    <span class="hljs-keyword">if</span> (k != lastIdx) {
                        lastIdx = k;
                        lastRun = last;
                    }
                }
                newTable[lastIdx] = lastRun;

                <span class="hljs-comment">// Clone remaining nodes</span>
                <span class="hljs-keyword">for</span> (HashEntry&lt;K,V&gt; p = e; p != lastRun; p = p.next) {
                    <span class="hljs-type">V</span> <span class="hljs-variable">v</span> <span class="hljs-operator">=</span> p.value;
                    <span class="hljs-type">int</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> p.hash;
                    <span class="hljs-type">int</span> <span class="hljs-variable">k</span> <span class="hljs-operator">=</span> h &amp; sizeMask;
                    HashEntry&lt;K,V&gt; n = newTable[k];
                    newTable[k] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashEntry</span>&lt;K,V&gt;(h, p.key, v, n);
                }
            }
        }
    }

    <span class="hljs-comment">// 插入新节点</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">nodeIndex</span> <span class="hljs-operator">=</span> node.hash &amp; sizeMask;
    node.setNext(newTable[nodeIndex]);
    newTable[nodeIndex] = node;
    table = newTable;
}
</code></pre>
<h4 data-id="heading-11">2.1.5 size()方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">final</span> Segment&lt;K,V&gt;[] segments = <span class="hljs-built_in">this</span>.segments;
    <span class="hljs-type">int</span> size;
    <span class="hljs-type">boolean</span> overflow;
    <span class="hljs-type">long</span> sum;
    <span class="hljs-type">long</span> <span class="hljs-variable">last</span> <span class="hljs-operator">=</span> <span class="hljs-number">0L</span>;
    <span class="hljs-type">int</span> <span class="hljs-variable">retries</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;

    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">for</span> (;;) {
            <span class="hljs-comment">// 1. 尝试2次无锁统计</span>
            <span class="hljs-keyword">if</span> (retries++ == RETRIES_BEFORE_LOCK) {
                <span class="hljs-comment">// 2. 失败则锁定所有Segment</span>
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; segments.length; ++j)
                    ensureSegment(j).lock();
            }

            sum = <span class="hljs-number">0L</span>;
            size = <span class="hljs-number">0</span>;
            overflow = <span class="hljs-literal">false</span>;

            <span class="hljs-comment">// 3. 累加所有Segment的count</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; segments.length; ++j) {
                Segment&lt;K,V&gt; seg = segmentAt(segments, j);
                <span class="hljs-keyword">if</span> (seg != <span class="hljs-literal">null</span>) {
                    sum += seg.modCount;
                    <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> seg.count;
                    <span class="hljs-keyword">if</span> (c &lt; <span class="hljs-number">0</span> || (size += c) &lt; <span class="hljs-number">0</span>)
                        overflow = <span class="hljs-literal">true</span>;
                }
            }

            <span class="hljs-comment">// 4. modCount未变化，说明期间没有修改，返回</span>
            <span class="hljs-keyword">if</span> (sum == last)
                <span class="hljs-keyword">break</span>;
            last = sum;
        }
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-keyword">if</span> (retries &gt; RETRIES_BEFORE_LOCK) {
            <span class="hljs-comment">// 释放所有Segment锁</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; segments.length; ++j)
                segmentAt(segments, j).unlock();
        }
    }
    <span class="hljs-keyword">return</span> overflow ? Integer.MAX_VALUE : size;
}
</code></pre>
<p><strong>策略：</strong></p>
<ul>
<li>先尝试2次无锁统计，通过比较<code>modCount</code>判断是否有修改</li>
<li>如果2次统计结果一致，说明期间无修改，直接返回</li>
<li>否则锁定所有Segment，再次统计</li>
</ul>
<h4 data-id="heading-12">2.1.6 优缺点分析</h4>
<p><strong>优点：</strong></p>
<ul>
<li>✅ 分段锁，并发度高（默认16）</li>
<li>✅ 读操作无锁，性能好</li>
<li>✅ 写操作只锁单个Segment，不影响其他Segment</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>❌ Segment粒度较粗，并发度受限于Segment数量</li>
<li>❌ 扩容时需要锁定Segment</li>
<li>❌ 结构复杂，内存占用较大</li>
</ul>
<hr/>
<h3 data-id="heading-13">2.2 JDK 1.8 CAS + synchronized实现原理</h3>
<h4 data-id="heading-14">2.2.1 数据结构变化</h4>
<p>JDK 1.8完全重构，<strong>取消Segment</strong>，改为<strong>Node数组 + 链表/红黑树</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">ConcurrentHashMap
    |
    +-- Node<span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">table</span>
            |
            +-- Node<span class="hljs-selector-attr">[0]</span> -&gt; Node -&gt; Node (链表)
            |
            +-- Node<span class="hljs-selector-attr">[1]</span> -&gt; TreeNode (红黑树)
            |                 / \
            |                /   \
            |           TreeNode TreeNode
            |
            +-- Node<span class="hljs-selector-attr">[2]</span> -&gt; ForwardingNode (扩容标记)
</code></pre>
<p><strong>核心数据结构：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;K,V&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMap</span>&lt;K,V&gt; {
    <span class="hljs-keyword">transient</span> <span class="hljs-keyword">volatile</span> Node&lt;K,V&gt;[] table;  <span class="hljs-comment">// Node数组</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> <span class="hljs-keyword">volatile</span> Node&lt;K,V&gt;[] nextTable;  <span class="hljs-comment">// 扩容时的新表</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">long</span> baseCount;  <span class="hljs-comment">// 元素数量基数</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> sizeCtl;  <span class="hljs-comment">// 控制标识符</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> <span class="hljs-keyword">volatile</span> CounterCell[] counterCells;  <span class="hljs-comment">// 计数数组</span>

    <span class="hljs-comment">// Node节点（链表）</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span>&lt;K,V&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Map</span>.Entry&lt;K,V&gt; {
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> hash;
        <span class="hljs-keyword">final</span> K key;
        <span class="hljs-keyword">volatile</span> V val;  <span class="hljs-comment">// volatile保证可见性</span>
        <span class="hljs-keyword">volatile</span> Node&lt;K,V&gt; next;
    }

    <span class="hljs-comment">// TreeNode（红黑树）</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TreeNode</span>&lt;K,V&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Node</span>&lt;K,V&gt; {
        TreeNode&lt;K,V&gt; parent;
        TreeNode&lt;K,V&gt; left;
        TreeNode&lt;K,V&gt; right;
        TreeNode&lt;K,V&gt; prev;
        <span class="hljs-type">boolean</span> red;
    }

    <span class="hljs-comment">// ForwardingNode（扩容标记节点）</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ForwardingNode</span>&lt;K,V&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Node</span>&lt;K,V&gt; {
        <span class="hljs-keyword">final</span> Node&lt;K,V&gt;[] nextTable;
        ForwardingNode(Node&lt;K,V&gt;[] tab) {
            <span class="hljs-built_in">super</span>(MOVED, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);  <span class="hljs-comment">// hash = MOVED = -1</span>
            <span class="hljs-built_in">this</span>.nextTable = tab;
        }
    }
}
</code></pre>
<p><strong>关键变化：</strong></p>
<ul>
<li><strong>Node数组</strong>：取代Segment数组，直接存储Node</li>
<li><strong>TreeNode</strong>：链表长度≥8且数组长度≥64时，转为红黑树</li>
<li><strong>ForwardingNode</strong>：标记正在迁移的桶，hash值为-1</li>
</ul>
<h4 data-id="heading-15">2.2.2 put操作详细流程</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> {
    <span class="hljs-keyword">return</span> putVal(key, value, <span class="hljs-literal">false</span>);
}

<span class="hljs-keyword">final</span> V <span class="hljs-title function_">putVal</span><span class="hljs-params">(K key, V value, <span class="hljs-type">boolean</span> onlyIfAbsent)</span> {
    <span class="hljs-keyword">if</span> (key == <span class="hljs-literal">null</span> || value == <span class="hljs-literal">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>();

    <span class="hljs-comment">// 1. 计算hash（扰动函数）</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> spread(key.hashCode());
    <span class="hljs-type">int</span> <span class="hljs-variable">binCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

    <span class="hljs-keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) {
        Node&lt;K,V&gt; f; <span class="hljs-type">int</span> n, i, fh;

        <span class="hljs-comment">// 情况1: table未初始化</span>
        <span class="hljs-keyword">if</span> (tab == <span class="hljs-literal">null</span> || (n = tab.length) == <span class="hljs-number">0</span>)
            tab = initTable();

        <span class="hljs-comment">// 情况2: 桶为空，CAS插入（无锁）</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((f = tabAt(tab, i = (n - <span class="hljs-number">1</span>) &amp; hash)) == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">if</span> (casTabAt(tab, i, <span class="hljs-literal">null</span>,
                         <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>&lt;K,V&gt;(hash, key, value, <span class="hljs-literal">null</span>)))
                <span class="hljs-keyword">break</span>;  <span class="hljs-comment">// CAS成功，插入完成</span>
        }

        <span class="hljs-comment">// 情况3: 正在扩容（hash == MOVED）</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((fh = f.hash) == MOVED)
            tab = helpTransfer(tab, f);  <span class="hljs-comment">// 帮助扩容</span>

        <span class="hljs-comment">// 情况4: hash冲突，synchronized锁定桶</span>
        <span class="hljs-keyword">else</span> {
            <span class="hljs-type">V</span> <span class="hljs-variable">oldVal</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">synchronized</span> (f) {  <span class="hljs-comment">// 锁定链表/树的头节点</span>
                <span class="hljs-keyword">if</span> (tabAt(tab, i) == f) {  <span class="hljs-comment">// 双重检查</span>
                    <span class="hljs-keyword">if</span> (fh &gt;= <span class="hljs-number">0</span>) {  <span class="hljs-comment">// 链表</span>
                        binCount = <span class="hljs-number">1</span>;
                        <span class="hljs-keyword">for</span> (Node&lt;K,V&gt; e = f;; ++binCount) {
                            K ek;
                            <span class="hljs-comment">// 找到相同key，替换value</span>
                            <span class="hljs-keyword">if</span> (e.hash == hash &amp;&amp;
                                ((ek = e.key) == key ||
                                 (ek != <span class="hljs-literal">null</span> &amp;&amp; key.equals(ek)))) {
                                oldVal = e.val;
                                <span class="hljs-keyword">if</span> (!onlyIfAbsent)
                                    e.val = value;
                                <span class="hljs-keyword">break</span>;
                            }
                            Node&lt;K,V&gt; pred = e;
                            <span class="hljs-comment">// 到达链表尾部，插入新节点</span>
                            <span class="hljs-keyword">if</span> ((e = e.next) == <span class="hljs-literal">null</span>) {
                                pred.next = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>&lt;K,V&gt;(hash, key,
                                                          value, <span class="hljs-literal">null</span>);
                                <span class="hljs-keyword">break</span>;
                            }
                        }
                    }
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (f <span class="hljs-keyword">instanceof</span> TreeBin) {  <span class="hljs-comment">// 红黑树</span>
                        Node&lt;K,V&gt; p;
                        binCount = <span class="hljs-number">2</span>;
                        <span class="hljs-keyword">if</span> ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,
                                                       value)) != <span class="hljs-literal">null</span>) {
                            oldVal = p.val;
                            <span class="hljs-keyword">if</span> (!onlyIfAbsent)
                                p.val = value;
                        }
                    }
                }
            }  <span class="hljs-comment">// 释放synchronized锁</span>

            <span class="hljs-keyword">if</span> (binCount != <span class="hljs-number">0</span>) {
                <span class="hljs-comment">// 链表长度 &gt;= 8，尝试树化</span>
                <span class="hljs-keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)
                    treeifyBin(tab, i);
                <span class="hljs-keyword">if</span> (oldVal != <span class="hljs-literal">null</span>)
                    <span class="hljs-keyword">return</span> oldVal;
                <span class="hljs-keyword">break</span>;
            }
        }
    }

    <span class="hljs-comment">// 增加计数</span>
    addCount(<span class="hljs-number">1L</span>, binCount);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<p><strong>流程图：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c69b728f5be43718222afb43c84e796~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Sh6YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766827239&amp;x-signature=FOA7KKkZWmPXNHFgQ%2BGa379lN2k%3D" alt="concurrenthashmap-put-flow.svg" loading="lazy"/></p>
<p><strong>关键点：</strong></p>
<ul>
<li><strong>桶为空</strong>：直接CAS插入，无需加锁</li>
<li><strong>正在扩容</strong>：帮助扩容，协作完成</li>
<li><strong>hash冲突</strong>：synchronized锁定<strong>头节点</strong>，粒度极细</li>
<li><strong>树化条件</strong>：链表长度≥8 <strong>且</strong> 数组长度≥64</li>
</ul>
<h4 data-id="heading-16">2.2.3 get操作</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> V <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> {
    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; e, p; <span class="hljs-type">int</span> n, eh; K ek;

    <span class="hljs-comment">// 1. 计算hash</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> spread(key.hashCode());

    <span class="hljs-comment">// 2. table不为空 且 桶不为空</span>
    <span class="hljs-keyword">if</span> ((tab = table) != <span class="hljs-literal">null</span> &amp;&amp; (n = tab.length) &gt; <span class="hljs-number">0</span> &amp;&amp;
        (e = tabAt(tab, (n - <span class="hljs-number">1</span>) &amp; h)) != <span class="hljs-literal">null</span>) {

        <span class="hljs-comment">// 3. 检查头节点</span>
        <span class="hljs-keyword">if</span> ((eh = e.hash) == h) {
            <span class="hljs-keyword">if</span> ((ek = e.key) == key || (ek != <span class="hljs-literal">null</span> &amp;&amp; key.equals(ek)))
                <span class="hljs-keyword">return</span> e.val;
        }
        <span class="hljs-comment">// 4. hash &lt; 0: 红黑树或ForwardingNode</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (eh &lt; <span class="hljs-number">0</span>)
            <span class="hljs-keyword">return</span> (p = e.find(h, key)) != <span class="hljs-literal">null</span> ? p.val : <span class="hljs-literal">null</span>;

        <span class="hljs-comment">// 5. 遍历链表</span>
        <span class="hljs-keyword">while</span> ((e = e.next) != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">if</span> (e.hash == h &amp;&amp;
                ((ek = e.key) == key || (ek != <span class="hljs-literal">null</span> &amp;&amp; key.equals(ek))))
                <span class="hljs-keyword">return</span> e.val;
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<p><strong>关键点：</strong></p>
<ul>
<li><strong>无锁读取</strong>：完全不加锁，依赖volatile保证可见性</li>
<li><strong>ForwardingNode处理</strong>：扩容时通过<code>find()</code>方法在新表中查找</li>
<li><strong>性能极高</strong>：并发读不会阻塞</li>
</ul>
<h4 data-id="heading-17">2.2.4 扩容机制详解</h4>
<p><strong>多线程协作扩容</strong>是JDK 1.8的亮点，核心思想：</p>
<ul>
<li>将扩容任务拆分为多个小任务</li>
<li>多个线程并发迁移不同区间的数据</li>
<li>使用<code>ForwardingNode</code>标记已迁移的桶</li>
</ul>
<p><strong>关键变量：</strong></p>
<ul>
<li><code>sizeCtl</code>：控制标识符
<ul>
<li><code>-1</code>：正在初始化</li>
<li><code>-(1 + nThreads)</code>：正在扩容，nThreads为参与扩容的线程数</li>
<li><code>&gt; 0</code>：下次扩容阈值</li>
</ul>
</li>
<li><code>transferIndex</code>：下一个待迁移的桶索引</li>
<li><code>stride</code>：每个线程处理的桶数量（最小16）</li>
</ul>
<p><strong>扩容流程：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transfer</span><span class="hljs-params">(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt;[] nextTab)</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> tab.length, stride;

    <span class="hljs-comment">// 1. 计算每个线程处理的桶数（stride）</span>
    <span class="hljs-keyword">if</span> ((stride = (NCPU &gt; <span class="hljs-number">1</span>) ? (n &gt;&gt;&gt; <span class="hljs-number">3</span>) / NCPU : n) &lt; MIN_TRANSFER_STRIDE)
        stride = MIN_TRANSFER_STRIDE;

    <span class="hljs-comment">// 2. 初始化新表</span>
    <span class="hljs-keyword">if</span> (nextTab == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">try</span> {
            Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>&lt;?,?&gt;[n &lt;&lt; <span class="hljs-number">1</span>];  <span class="hljs-comment">// 2倍扩容</span>
            nextTab = nt;
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            sizeCtl = Integer.MAX_VALUE;
            <span class="hljs-keyword">return</span>;
        }
        nextTable = nextTab;
        transferIndex = n;  <span class="hljs-comment">// 从后往前迁移</span>
    }

    <span class="hljs-type">int</span> <span class="hljs-variable">nextn</span> <span class="hljs-operator">=</span> nextTab.length;
    ForwardingNode&lt;K,V&gt; fwd = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ForwardingNode</span>&lt;K,V&gt;(nextTab);
    <span class="hljs-type">boolean</span> <span class="hljs-variable">advance</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
    <span class="hljs-type">boolean</span> <span class="hljs-variable">finishing</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// 3. 循环处理每个桶</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, bound = <span class="hljs-number">0</span>;;) {
        Node&lt;K,V&gt; f; <span class="hljs-type">int</span> fh;

        <span class="hljs-comment">// 3.1 领取任务：CAS获取[bound, i]区间</span>
        <span class="hljs-keyword">while</span> (advance) {
            <span class="hljs-type">int</span> nextIndex, nextBound;
            <span class="hljs-keyword">if</span> (--i &gt;= bound || finishing)
                advance = <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((nextIndex = transferIndex) &lt;= <span class="hljs-number">0</span>) {
                i = -<span class="hljs-number">1</span>;
                advance = <span class="hljs-literal">false</span>;
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (U.compareAndSwapInt
                     (<span class="hljs-built_in">this</span>, TRANSFERINDEX, nextIndex,
                      nextBound = (nextIndex &gt; stride ?
                                   nextIndex - stride : <span class="hljs-number">0</span>))) {
                bound = nextBound;
                i = nextIndex - <span class="hljs-number">1</span>;
                advance = <span class="hljs-literal">false</span>;
            }
        }

        <span class="hljs-comment">// 3.2 完成检查</span>
        <span class="hljs-keyword">if</span> (i &lt; <span class="hljs-number">0</span> || i &gt;= n || i + n &gt;= nextn) {
            <span class="hljs-type">int</span> sc;
            <span class="hljs-keyword">if</span> (finishing) {
                nextTable = <span class="hljs-literal">null</span>;
                table = nextTab;
                sizeCtl = (n &lt;&lt; <span class="hljs-number">1</span>) - (n &gt;&gt;&gt; <span class="hljs-number">1</span>);  <span class="hljs-comment">// 0.75 * 2n</span>
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-comment">// 当前线程完成，扩容线程数-1</span>
            <span class="hljs-keyword">if</span> (U.compareAndSwapInt(<span class="hljs-built_in">this</span>, SIZECTL, sc = sizeCtl, sc - <span class="hljs-number">1</span>)) {
                <span class="hljs-keyword">if</span> ((sc - <span class="hljs-number">2</span>) != resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT)
                    <span class="hljs-keyword">return</span>;
                finishing = advance = <span class="hljs-literal">true</span>;
                i = n;
            }
        }

        <span class="hljs-comment">// 3.3 桶为空，放置ForwardingNode</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((f = tabAt(tab, i)) == <span class="hljs-literal">null</span>)
            advance = casTabAt(tab, i, <span class="hljs-literal">null</span>, fwd);

        <span class="hljs-comment">// 3.4 已经处理过（ForwardingNode）</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((fh = f.hash) == MOVED)
            advance = <span class="hljs-literal">true</span>;

        <span class="hljs-comment">// 3.5 迁移数据</span>
        <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">synchronized</span> (f) {  <span class="hljs-comment">// 锁定旧桶</span>
                <span class="hljs-keyword">if</span> (tabAt(tab, i) == f) {
                    Node&lt;K,V&gt; ln, hn;
                    <span class="hljs-keyword">if</span> (fh &gt;= <span class="hljs-number">0</span>) {  <span class="hljs-comment">// 链表</span>
                        <span class="hljs-comment">// 根据hash &amp; n 分为高位和低位链表</span>
                        <span class="hljs-type">int</span> <span class="hljs-variable">runBit</span> <span class="hljs-operator">=</span> fh &amp; n;
                        Node&lt;K,V&gt; lastRun = f;
                        <span class="hljs-keyword">for</span> (Node&lt;K,V&gt; p = f.next; p != <span class="hljs-literal">null</span>; p = p.next) {
                            <span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> p.hash &amp; n;
                            <span class="hljs-keyword">if</span> (b != runBit) {
                                runBit = b;
                                lastRun = p;
                            }
                        }
                        <span class="hljs-keyword">if</span> (runBit == <span class="hljs-number">0</span>) {
                            ln = lastRun;
                            hn = <span class="hljs-literal">null</span>;
                        }
                        <span class="hljs-keyword">else</span> {
                            hn = lastRun;
                            ln = <span class="hljs-literal">null</span>;
                        }

                        <span class="hljs-keyword">for</span> (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) {
                            <span class="hljs-type">int</span> <span class="hljs-variable">ph</span> <span class="hljs-operator">=</span> p.hash; <span class="hljs-type">K</span> <span class="hljs-variable">pk</span> <span class="hljs-operator">=</span> p.key; <span class="hljs-type">V</span> <span class="hljs-variable">pv</span> <span class="hljs-operator">=</span> p.val;
                            <span class="hljs-keyword">if</span> ((ph &amp; n) == <span class="hljs-number">0</span>)
                                ln = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>&lt;K,V&gt;(ph, pk, pv, ln);
                            <span class="hljs-keyword">else</span>
                                hn = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>&lt;K,V&gt;(ph, pk, pv, hn);
                        }

                        <span class="hljs-comment">// 低位链表放在原位置 i</span>
                        setTabAt(nextTab, i, ln);
                        <span class="hljs-comment">// 高位链表放在 i + n</span>
                        setTabAt(nextTab, i + n, hn);
                        <span class="hljs-comment">// 旧表该位置放ForwardingNode</span>
                        setTabAt(tab, i, fwd);
                        advance = <span class="hljs-literal">true</span>;
                    }
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (f <span class="hljs-keyword">instanceof</span> TreeBin) {  <span class="hljs-comment">// 红黑树</span>
                        <span class="hljs-comment">// 树的迁移逻辑（省略）</span>
                        ...
                    }
                }
            }
        }
    }
}
</code></pre>
<p><strong>扩容流程图：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83d524c07c84415f8e5ee366db93ccb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Sh6YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766827239&amp;x-signature=syyvRCDAs%2FqgY%2FkFZE%2B5oRApr9I%3D" alt="concurrenthashmap-resize-flow.svg" loading="lazy"/></p>
<p><strong>关键点：</strong></p>
<ul>
<li><strong>任务分配</strong>：CAS获取待迁移区间，避免重复</li>
<li><strong>ForwardingNode</strong>：标记已迁移，get时重定向到新表</li>
<li><strong>并发安全</strong>：迁移时锁定旧桶，不影响其他桶</li>
<li><strong>高效协作</strong>：put遇到扩容时会<code>helpTransfer()</code>帮忙</li>
</ul>
<h4 data-id="heading-18">2.2.5 size()方法</h4>
<p>JDK 1.8使用<strong>LongAdder思想</strong>实现高性能计数：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span> {
    <span class="hljs-type">long</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> sumCount();
    <span class="hljs-keyword">return</span> ((n &lt; <span class="hljs-number">0L</span>) ? <span class="hljs-number">0</span> :
            (n &gt; (<span class="hljs-type">long</span>)Integer.MAX_VALUE) ? Integer.MAX_VALUE :
            (<span class="hljs-type">int</span>)n);
}

<span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-title function_">sumCount</span><span class="hljs-params">()</span> {
    CounterCell[] as = counterCells; CounterCell a;
    <span class="hljs-type">long</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> baseCount;
    <span class="hljs-keyword">if</span> (as != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 累加所有CounterCell</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; as.length; ++i) {
            <span class="hljs-keyword">if</span> ((a = as[i]) != <span class="hljs-literal">null</span>)
                sum += a.value;
        }
    }
    <span class="hljs-keyword">return</span> sum;
}

<span class="hljs-comment">// 增加计数</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addCount</span><span class="hljs-params">(<span class="hljs-type">long</span> x, <span class="hljs-type">int</span> check)</span> {
    CounterCell[] as; <span class="hljs-type">long</span> b, s;

    <span class="hljs-comment">// 尝试CAS更新baseCount</span>
    <span class="hljs-keyword">if</span> ((as = counterCells) != <span class="hljs-literal">null</span> ||
        !U.compareAndSwapLong(<span class="hljs-built_in">this</span>, BASECOUNT, b = baseCount, s = b + x)) {

        CounterCell a; <span class="hljs-type">long</span> v; <span class="hljs-type">int</span> m;
        <span class="hljs-type">boolean</span> <span class="hljs-variable">uncontended</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;

        <span class="hljs-comment">// CAS失败，更新CounterCell</span>
        <span class="hljs-keyword">if</span> (as == <span class="hljs-literal">null</span> || (m = as.length - <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span> ||
            (a = as[ThreadLocalRandom.getProbe() &amp; m]) == <span class="hljs-literal">null</span> ||
            !(uncontended =
              U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x))) {
            fullAddCount(x, uncontended);  <span class="hljs-comment">// 扩容CounterCell数组</span>
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">if</span> (check &lt;= <span class="hljs-number">1</span>)
            <span class="hljs-keyword">return</span>;
        s = sumCount();
    }

    <span class="hljs-comment">// 检查是否需要扩容</span>
    <span class="hljs-keyword">if</span> (check &gt;= <span class="hljs-number">0</span>) {
        ...
    }
}
</code></pre>
<p><strong>计数原理：</strong></p>
<ul>
<li><strong>baseCount</strong>：基础计数</li>
<li><strong>CounterCell[]</strong>：分段计数数组，减少CAS冲突</li>
<li><strong>总数 = baseCount + Σ(counterCells[i].value)</strong></li>
</ul>
<p><strong>优点</strong>：</p>
<ul>
<li>高并发下性能优秀，避免单点CAS竞争</li>
<li>size()直接求和，无需加锁</li>
</ul>
<h4 data-id="heading-19">2.2.6 为什么放弃分段锁？</h4>













































<table><thead><tr><th>对比项</th><th>JDK 1.7 Segment</th><th>JDK 1.8 CAS + synchronized</th></tr></thead><tbody><tr><td><strong>锁粒度</strong></td><td>Segment级别（粗）</td><td>Node级别（细）</td></tr><tr><td><strong>并发度</strong></td><td>Segment数量（默认16）</td><td>数组长度（动态）</td></tr><tr><td><strong>扩容</strong></td><td>单Segment扩容</td><td>全表扩容，多线程协作</td></tr><tr><td><strong>结构复杂度</strong></td><td>三层结构（Segment-HashEntry-链表）</td><td>二层结构（Node-链表/树）</td></tr><tr><td><strong>内存占用</strong></td><td>较大（Segment开销）</td><td>较小</td></tr><tr><td><strong>读性能</strong></td><td>高（volatile）</td><td>高（volatile）</td></tr><tr><td><strong>写性能</strong></td><td>中（ReentrantLock）</td><td>高（CAS + synchronized优化）</td></tr></tbody></table>
<p><strong>放弃原因：</strong></p>
<ol>
<li><strong>Segment粒度过粗</strong>：并发度受限，最多16个线程并发写</li>
<li><strong>synchronized优化</strong>：JDK 1.6后synchronized性能大幅提升（锁消除、锁粗化、偏向锁、轻量级锁）</li>
<li><strong>CAS无锁更快</strong>：桶为空时CAS直接插入，性能更高</li>
<li><strong>扩容更高效</strong>：多线程协作扩容，比单Segment扩容快</li>
</ol>
<hr/>
<h3 data-id="heading-20">2.3 与其他线程安全Map对比</h3>





















































































<table><thead><tr><th>特性</th><th>HashMap</th><th>Hashtable</th><th>synchronizedMap</th><th>ConcurrentHashMap 1.7</th><th>ConcurrentHashMap 1.8</th></tr></thead><tbody><tr><td><strong>线程安全</strong></td><td>❌ 否</td><td>✅ 是</td><td>✅ 是</td><td>✅ 是</td><td>✅ 是</td></tr><tr><td><strong>锁粒度</strong></td><td>-</td><td>全表锁</td><td>全表锁</td><td>Segment锁</td><td>Node锁</td></tr><tr><td><strong>并发度</strong></td><td>-</td><td>1</td><td>1</td><td>16（默认）</td><td>数组长度</td></tr><tr><td><strong>key允许null</strong></td><td>✅ 是</td><td>❌ 否</td><td>✅ 是</td><td>❌ 否</td><td>❌ 否</td></tr><tr><td><strong>value允许null</strong></td><td>✅ 是</td><td>❌ 否</td><td>✅ 是</td><td>❌ 否</td><td>❌ 否</td></tr><tr><td><strong>迭代器</strong></td><td>fail-fast</td><td>fail-fast</td><td>fail-fast</td><td>fail-safe</td><td>fail-safe</td></tr><tr><td><strong>性能（单线程）</strong></td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐</td><td>⭐⭐⭐</td><td>⭐⭐⭐⭐</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><strong>性能（并发）</strong></td><td>-</td><td>⭐</td><td>⭐</td><td>⭐⭐⭐</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><strong>适用场景</strong></td><td>单线程</td><td>低并发</td><td>低并发</td><td>中高并发</td><td>高并发</td></tr></tbody></table>
<p><strong>性能对比（10线程并发put 100万次）：</strong></p>



































<table><thead><tr><th>实现</th><th>耗时</th><th>吞吐量</th></tr></thead><tbody><tr><td>HashMap</td><td>不安全</td><td>-</td></tr><tr><td>Hashtable</td><td>8500ms</td><td>11.7万/s</td></tr><tr><td>synchronizedMap</td><td>8200ms</td><td>12.2万/s</td></tr><tr><td>ConcurrentHashMap 1.7</td><td>2800ms</td><td>35.7万/s</td></tr><tr><td>ConcurrentHashMap 1.8</td><td>1500ms</td><td>66.7万/s</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-21">三、实战场景应用</h2>
<h3 data-id="heading-22">3.1 场景1：高并发本地缓存实现</h3>
<h4 data-id="heading-23">3.1.1 业务背景</h4>
<p>电商平台的商品基础信息（如类目、品牌）变化频率低，但查询频繁，适合使用本地缓存减轻数据库压力。</p>
<p><strong>需求：</strong></p>
<ul>
<li>读多写少（读写比 100:1）</li>
<li>支持高并发访问</li>
<li>数据定期刷新</li>
<li>支持手动失效</li>
</ul>
<h4 data-id="heading-24">3.1.2 技术方案</h4>
<p>使用<code>ConcurrentHashMap</code>作为缓存容器：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.*;
<span class="hljs-keyword">import</span> java.util.function.Function;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;

<span class="hljs-comment">/**
 * 本地缓存工具类
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalCache</span>&lt;K, V&gt; {
    <span class="hljs-comment">// 缓存容器</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;K, CacheValue&lt;V&gt;&gt; cache;

    <span class="hljs-comment">// 定时刷新任务</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ScheduledExecutorService scheduler;

    <span class="hljs-comment">// 过期时间（毫秒）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> expireTime;

    <span class="hljs-comment">// 缓存值包装类</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheValue</span>&lt;V&gt; {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> V value;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> createTime;

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">CacheValue</span><span class="hljs-params">(V value)</span> {
            <span class="hljs-built_in">this</span>.value = value;
            <span class="hljs-built_in">this</span>.createTime = System.currentTimeMillis();
        }

        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isExpired</span><span class="hljs-params">(<span class="hljs-type">long</span> expireTime)</span> {
            <span class="hljs-keyword">return</span> System.currentTimeMillis() - createTime &gt; expireTime;
        }

        <span class="hljs-keyword">public</span> V <span class="hljs-title function_">getValue</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> value;
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">LocalCache</span><span class="hljs-params">(<span class="hljs-type">int</span> initialCapacity, <span class="hljs-type">long</span> expireTime)</span> {
        <span class="hljs-built_in">this</span>.cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;(initialCapacity);
        <span class="hljs-built_in">this</span>.expireTime = expireTime;
        <span class="hljs-built_in">this</span>.scheduler = Executors.newScheduledThreadPool(<span class="hljs-number">1</span>);

        <span class="hljs-comment">// 启动定期清理过期数据任务</span>
        startCleanupTask();
    }

    <span class="hljs-comment">/**
     * 获取缓存，不存在则加载
     */</span>
    <span class="hljs-keyword">public</span> V <span class="hljs-title function_">get</span><span class="hljs-params">(K key, Function&lt;K, V&gt; loader)</span> {
        CacheValue&lt;V&gt; cacheValue = cache.get(key);

        <span class="hljs-comment">// 缓存存在且未过期</span>
        <span class="hljs-keyword">if</span> (cacheValue != <span class="hljs-literal">null</span> &amp;&amp; !cacheValue.isExpired(expireTime)) {
            <span class="hljs-keyword">return</span> cacheValue.getValue();
        }

        <span class="hljs-comment">// 缓存不存在或已过期，重新加载</span>
        <span class="hljs-comment">// 使用computeIfAbsent保证只加载一次</span>
        <span class="hljs-keyword">return</span> cache.compute(key, (k, oldValue) -&gt; {
            <span class="hljs-comment">// 双重检查：其他线程可能已经加载</span>
            <span class="hljs-keyword">if</span> (oldValue != <span class="hljs-literal">null</span> &amp;&amp; !oldValue.isExpired(expireTime)) {
                <span class="hljs-keyword">return</span> oldValue;
            }

            <span class="hljs-comment">// 加载数据</span>
            <span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> loader.apply(k);
            <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <span class="hljs-comment">// 不缓存null</span>
            }

            log.info(<span class="hljs-string">"缓存加载: key={}"</span>, k);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheValue</span>&lt;&gt;(value);
        }).getValue();
    }

    <span class="hljs-comment">/**
     * 主动设置缓存
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> {
        <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) {
            cache.put(key, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheValue</span>&lt;&gt;(value));
        }
    }

    <span class="hljs-comment">/**
     * 使缓存失效
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invalidate</span><span class="hljs-params">(K key)</span> {
        cache.remove(key);
        log.info(<span class="hljs-string">"缓存失效: key={}"</span>, key);
    }

    <span class="hljs-comment">/**
     * 清空所有缓存
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> {
        cache.clear();
        log.info(<span class="hljs-string">"缓存已清空"</span>);
    }

    <span class="hljs-comment">/**
     * 获取缓存大小
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> cache.size();
    }

    <span class="hljs-comment">/**
     * 启动定期清理任务
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startCleanupTask</span><span class="hljs-params">()</span> {
        scheduler.scheduleAtFixedRate(() -&gt; {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">int</span> <span class="hljs-variable">cleanCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
                <span class="hljs-type">long</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> System.currentTimeMillis();

                <span class="hljs-comment">// 遍历清理过期数据</span>
                <span class="hljs-keyword">for</span> (K key : cache.keySet()) {
                    CacheValue&lt;V&gt; value = cache.get(key);
                    <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span> &amp;&amp; value.isExpired(expireTime)) {
                        cache.remove(key);
                        cleanCount++;
                    }
                }

                <span class="hljs-keyword">if</span> (cleanCount &gt; <span class="hljs-number">0</span>) {
                    log.info(<span class="hljs-string">"清理过期缓存: count={}, size={}"</span>, cleanCount, cache.size());
                }
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.error(<span class="hljs-string">"清理缓存异常"</span>, e);
            }
        }, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, TimeUnit.MINUTES);  <span class="hljs-comment">// 每分钟清理一次</span>
    }

    <span class="hljs-comment">/**
     * 关闭缓存
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shutdown</span><span class="hljs-params">()</span> {
        scheduler.shutdown();
        cache.clear();
    }
}
</code></pre>
<h4 data-id="heading-25">3.1.3 使用示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {
    <span class="hljs-comment">// 商品类目缓存，过期时间10分钟</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> LocalCache&lt;Long, Category&gt; categoryCache =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalCache</span>&lt;&gt;(<span class="hljs-number">1000</span>, <span class="hljs-number">10</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>);

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> CategoryMapper categoryMapper;

    <span class="hljs-comment">/**
     * 查询类目（带缓存）
     */</span>
    <span class="hljs-keyword">public</span> Category <span class="hljs-title function_">getCategory</span><span class="hljs-params">(Long categoryId)</span> {
        <span class="hljs-keyword">return</span> categoryCache.get(categoryId, id -&gt; {
            <span class="hljs-comment">// 缓存不存在时，从数据库加载</span>
            <span class="hljs-type">Category</span> <span class="hljs-variable">category</span> <span class="hljs-operator">=</span> categoryMapper.selectById(id);
            log.info(<span class="hljs-string">"从数据库加载类目: id={}"</span>, id);
            <span class="hljs-keyword">return</span> category;
        });
    }

    <span class="hljs-comment">/**
     * 更新类目（失效缓存）
     */</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateCategory</span><span class="hljs-params">(Category category)</span> {
        categoryMapper.updateById(category);
        <span class="hljs-comment">// 更新后立即失效缓存</span>
        categoryCache.invalidate(category.getId());
    }

    <span class="hljs-comment">/**
     * 预热缓存
     */</span>
    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">warmUpCache</span><span class="hljs-params">()</span> {
        List&lt;Category&gt; categories = categoryMapper.selectAll();
        <span class="hljs-keyword">for</span> (Category category : categories) {
            categoryCache.put(category.getId(), category);
        }
        log.info(<span class="hljs-string">"类目缓存预热完成: size={}"</span>, categoryCache.size());
    }
}
</code></pre>
<h4 data-id="heading-26">3.1.4 为什么不用Guava Cache？</h4>
<p><strong>场景对比：</strong></p>








































<table><thead><tr><th>场景</th><th>ConcurrentHashMap</th><th>Guava Cache</th></tr></thead><tbody><tr><td><strong>简单缓存，手动控制</strong></td><td>✅ 推荐</td><td>❌ 过度设计</td></tr><tr><td><strong>需要自动过期</strong></td><td>⚠️ 需手动实现</td><td>✅ 推荐</td></tr><tr><td><strong>需要LRU淘汰</strong></td><td>❌ 不支持</td><td>✅ 推荐</td></tr><tr><td><strong>需要缓存统计</strong></td><td>❌ 不支持</td><td>✅ 推荐</td></tr><tr><td><strong>最大容量限制</strong></td><td>⚠️ 需手动实现</td><td>✅ 推荐</td></tr><tr><td><strong>性能要求极高</strong></td><td>✅ 更轻量</td><td>⚠️ 略重</td></tr></tbody></table>
<p><strong>推荐使用Guava Cache的改进版本：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductServiceWithGuava</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> LoadingCache&lt;Long, Category&gt; categoryCache = CacheBuilder.newBuilder()
        .maximumSize(<span class="hljs-number">1000</span>)  <span class="hljs-comment">// 最大容量</span>
        .expireAfterWrite(<span class="hljs-number">10</span>, TimeUnit.MINUTES)  <span class="hljs-comment">// 写入10分钟后过期</span>
        .recordStats()  <span class="hljs-comment">// 记录统计信息</span>
        .build(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheLoader</span>&lt;Long, Category&gt;() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> Category <span class="hljs-title function_">load</span><span class="hljs-params">(Long id)</span> {
                <span class="hljs-keyword">return</span> categoryMapper.selectById(id);
            }
        });

    <span class="hljs-keyword">public</span> Category <span class="hljs-title function_">getCategory</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> categoryCache.get(id);
        } <span class="hljs-keyword">catch</span> (ExecutionException e) {
            log.error(<span class="hljs-string">"加载缓存失败"</span>, e);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    }
}
</code></pre>
<h4 data-id="heading-27">3.1.5 性能测试数据</h4>
<p><strong>测试场景</strong>：100个线程并发查询1000个商品类目</p>





























<table><thead><tr><th>实现</th><th>数据库查询次数</th><th>平均响应时间</th><th>QPS</th></tr></thead><tbody><tr><td><strong>无缓存</strong></td><td>100,000</td><td>50ms</td><td>2000</td></tr><tr><td><strong>ConcurrentHashMap缓存</strong></td><td>1,000</td><td>0.5ms</td><td>200,000</td></tr><tr><td><strong>Guava Cache</strong></td><td>1,000</td><td>0.6ms</td><td>166,667</td></tr></tbody></table>
<p><strong>结论</strong>：本地缓存性能提升<strong>100倍</strong>，数据库压力降低<strong>99%</strong></p>
<hr/>
<h3 data-id="heading-28">3.2 场景2：统计在线用户数</h3>
<h4 data-id="heading-29">3.2.1 业务背景</h4>
<p>需要实时统计当前在线用户数，用户登录时添加，退出或超时时移除。</p>
<h4 data-id="heading-30">3.2.2 错误方案：AtomicLong</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误方案</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OnlineUserCounter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicLong</span> <span class="hljs-variable">onlineCount</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0</span>);

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">userLogin</span><span class="hljs-params">(Long userId)</span> {
        onlineCount.incrementAndGet();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">userLogout</span><span class="hljs-params">(Long userId)</span> {
        onlineCount.decrementAndGet();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getOnlineCount</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> onlineCount.get();
    }
}
</code></pre>
<p><strong>问题</strong>：</p>
<ol>
<li>❌ 无法判断用户是否真的在线（重复登录会重复计数）</li>
<li>❌ 无法获取在线用户列表</li>
<li>❌ 无法区分用户登录和退出</li>
</ol>
<h4 data-id="heading-31">3.2.3 正确方案：ConcurrentHashMap</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.*;
<span class="hljs-keyword">import</span> java.time.LocalDateTime;
<span class="hljs-keyword">import</span> lombok.Data;

<span class="hljs-comment">/**
 * 在线用户管理
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OnlineUserManager</span> {
    <span class="hljs-comment">// 在线用户Map: userId -&gt; Session</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;Long, UserSession&gt; onlineUsers =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;(<span class="hljs-number">10000</span>);

    <span class="hljs-comment">// 定时清理超时用户</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ScheduledExecutorService</span> <span class="hljs-variable">scheduler</span> <span class="hljs-operator">=</span>
        Executors.newScheduledThreadPool(<span class="hljs-number">1</span>);

    <span class="hljs-comment">// 超时时间（30分钟）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">TIMEOUT_MILLIS</span> <span class="hljs-operator">=</span> <span class="hljs-number">30</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>;

    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserSession</span> {
        <span class="hljs-keyword">private</span> Long userId;
        <span class="hljs-keyword">private</span> String sessionId;
        <span class="hljs-keyword">private</span> String ip;
        <span class="hljs-keyword">private</span> LocalDateTime loginTime;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">long</span> lastActiveTime;  <span class="hljs-comment">// volatile保证可见性</span>

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserSession</span><span class="hljs-params">(Long userId, String sessionId, String ip)</span> {
            <span class="hljs-built_in">this</span>.userId = userId;
            <span class="hljs-built_in">this</span>.sessionId = sessionId;
            <span class="hljs-built_in">this</span>.ip = ip;
            <span class="hljs-built_in">this</span>.loginTime = LocalDateTime.now();
            <span class="hljs-built_in">this</span>.lastActiveTime = System.currentTimeMillis();
        }

        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isTimeout</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> System.currentTimeMillis() - lastActiveTime &gt; TIMEOUT_MILLIS;
        }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateActiveTime</span><span class="hljs-params">()</span> {
            <span class="hljs-built_in">this</span>.lastActiveTime = System.currentTimeMillis();
        }
    }

    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 启动定期清理超时用户</span>
        scheduler.scheduleAtFixedRate(() -&gt; {
            <span class="hljs-keyword">try</span> {
                cleanTimeoutUsers();
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.error(<span class="hljs-string">"清理超时用户失败"</span>, e);
            }
        }, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, TimeUnit.MINUTES);
    }

    <span class="hljs-comment">/**
     * 用户登录
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">userLogin</span><span class="hljs-params">(Long userId, String sessionId, String ip)</span> {
        <span class="hljs-type">UserSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserSession</span>(userId, sessionId, ip);

        <span class="hljs-comment">// putIfAbsent: 只有不存在时才添加</span>
        <span class="hljs-type">UserSession</span> <span class="hljs-variable">oldSession</span> <span class="hljs-operator">=</span> onlineUsers.putIfAbsent(userId, session);

        <span class="hljs-keyword">if</span> (oldSession != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 用户已在线，更新session（踢出旧登录）</span>
            onlineUsers.put(userId, session);
            log.info(<span class="hljs-string">"用户重新登录: userId={}, oldSessionId={}, newSessionId={}"</span>,
                userId, oldSession.getSessionId(), sessionId);
        } <span class="hljs-keyword">else</span> {
            log.info(<span class="hljs-string">"用户登录: userId={}, sessionId={}, onlineCount={}"</span>,
                userId, sessionId, onlineUsers.size());
        }
    }

    <span class="hljs-comment">/**
     * 用户登出
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">userLogout</span><span class="hljs-params">(Long userId)</span> {
        <span class="hljs-type">UserSession</span> <span class="hljs-variable">removed</span> <span class="hljs-operator">=</span> onlineUsers.remove(userId);
        <span class="hljs-keyword">if</span> (removed != <span class="hljs-literal">null</span>) {
            log.info(<span class="hljs-string">"用户登出: userId={}, sessionId={}, onlineCount={}"</span>,
                userId, removed.getSessionId(), onlineUsers.size());
        }
    }

    <span class="hljs-comment">/**
     * 更新用户活跃时间（心跳）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUserActiveTime</span><span class="hljs-params">(Long userId)</span> {
        <span class="hljs-type">UserSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> onlineUsers.get(userId);
        <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
            session.updateActiveTime();
        }
    }

    <span class="hljs-comment">/**
     * 判断用户是否在线
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isOnline</span><span class="hljs-params">(Long userId)</span> {
        <span class="hljs-keyword">return</span> onlineUsers.containsKey(userId);
    }

    <span class="hljs-comment">/**
     * 获取在线用户数
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getOnlineCount</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> onlineUsers.size();
    }

    <span class="hljs-comment">/**
     * 获取所有在线用户
     */</span>
    <span class="hljs-keyword">public</span> List&lt;UserSession&gt; <span class="hljs-title function_">getOnlineUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(onlineUsers.values());
    }

    <span class="hljs-comment">/**
     * 清理超时用户
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cleanTimeoutUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">cleanCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

        <span class="hljs-keyword">for</span> (Long userId : onlineUsers.keySet()) {
            <span class="hljs-type">UserSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> onlineUsers.get(userId);

            <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span> &amp;&amp; session.isTimeout()) {
                <span class="hljs-comment">// 超时，移除用户</span>
                <span class="hljs-keyword">if</span> (onlineUsers.remove(userId, session)) {  <span class="hljs-comment">// CAS删除</span>
                    cleanCount++;
                    log.info(<span class="hljs-string">"清理超时用户: userId={}, sessionId={}"</span>,
                        userId, session.getSessionId());
                }
            }
        }

        <span class="hljs-keyword">if</span> (cleanCount &gt; <span class="hljs-number">0</span>) {
            log.info(<span class="hljs-string">"清理超时用户完成: cleanCount={}, onlineCount={}"</span>,
                cleanCount, onlineUsers.size());
        }
    }

    <span class="hljs-comment">/**
     * 获取用户在线时长（分钟）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getOnlineDuration</span><span class="hljs-params">(Long userId)</span> {
        <span class="hljs-type">UserSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> onlineUsers.get(userId);
        <span class="hljs-keyword">if</span> (session == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        }

        <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> System.currentTimeMillis() -
            session.getLoginTime().atZone(ZoneId.systemDefault())
                .toInstant().toEpochMilli();
        <span class="hljs-keyword">return</span> duration / <span class="hljs-number">60000</span>;
    }

    <span class="hljs-meta">@PreDestroy</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> {
        scheduler.shutdown();
        onlineUsers.clear();
    }
}
</code></pre>
<h4 data-id="heading-32">3.2.4 使用示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/api/user")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OnlineUserManager onlineUserManager;

    <span class="hljs-comment">/**
     * 用户登录
     */</span>
    <span class="hljs-meta">@PostMapping("/login")</span>
    <span class="hljs-keyword">public</span> Response&lt;Void&gt; <span class="hljs-title function_">login</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> LoginRequest request,
                                HttpServletRequest httpRequest)</span> {
        <span class="hljs-comment">// 验证用户名密码...</span>
        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> authenticate(request);

        <span class="hljs-comment">// 添加到在线用户</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">sessionId</span> <span class="hljs-operator">=</span> httpRequest.getSession().getId();
        <span class="hljs-type">String</span> <span class="hljs-variable">ip</span> <span class="hljs-operator">=</span> httpRequest.getRemoteAddr();
        onlineUserManager.userLogin(userId, sessionId, ip);

        <span class="hljs-keyword">return</span> Response.success();
    }

    <span class="hljs-comment">/**
     * 用户登出
     */</span>
    <span class="hljs-meta">@PostMapping("/logout")</span>
    <span class="hljs-keyword">public</span> Response&lt;Void&gt; <span class="hljs-title function_">logout</span><span class="hljs-params">(<span class="hljs-meta">@RequestHeader("userId")</span> Long userId)</span> {
        onlineUserManager.userLogout(userId);
        <span class="hljs-keyword">return</span> Response.success();
    }

    <span class="hljs-comment">/**
     * 心跳接口（定期调用，如每5分钟）
     */</span>
    <span class="hljs-meta">@PostMapping("/heartbeat")</span>
    <span class="hljs-keyword">public</span> Response&lt;Void&gt; <span class="hljs-title function_">heartbeat</span><span class="hljs-params">(<span class="hljs-meta">@RequestHeader("userId")</span> Long userId)</span> {
        onlineUserManager.updateUserActiveTime(userId);
        <span class="hljs-keyword">return</span> Response.success();
    }

    <span class="hljs-comment">/**
     * 获取在线用户数
     */</span>
    <span class="hljs-meta">@GetMapping("/online-count")</span>
    <span class="hljs-keyword">public</span> Response&lt;Integer&gt; <span class="hljs-title function_">getOnlineCount</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> onlineUserManager.getOnlineCount();
        <span class="hljs-keyword">return</span> Response.success(count);
    }

    <span class="hljs-comment">/**
     * 获取在线用户列表（管理员）
     */</span>
    <span class="hljs-meta">@GetMapping("/online-users")</span>
    <span class="hljs-keyword">public</span> Response&lt;List&lt;UserSession&gt;&gt; <span class="hljs-title function_">getOnlineUsers</span><span class="hljs-params">()</span> {
        List&lt;UserSession&gt; users = onlineUserManager.getOnlineUsers();
        <span class="hljs-keyword">return</span> Response.success(users);
    }
}
</code></pre>
<h4 data-id="heading-33">3.2.5 性能对比</h4>
<p><strong>测试场景</strong>：10000个用户并发登录/登出</p>



































<table><thead><tr><th>指标</th><th>AtomicLong方案</th><th>ConcurrentHashMap方案</th></tr></thead><tbody><tr><td><strong>准确性</strong></td><td>❌ 不准确（重复计数）</td><td>✅ 准确</td></tr><tr><td><strong>功能性</strong></td><td>❌ 只能计数</td><td>✅ 可查询用户、判断在线、超时清理</td></tr><tr><td><strong>登录耗时</strong></td><td>0.01ms</td><td>0.05ms</td></tr><tr><td><strong>查询耗时</strong></td><td>0.001ms</td><td>0.01ms</td></tr><tr><td><strong>内存占用</strong></td><td>8 bytes</td><td>~10MB（1万用户）</td></tr></tbody></table>
<p><strong>结论</strong>：ConcurrentHashMap功能更强大，性能损失可接受</p>
<hr/>
<h2 data-id="heading-34">四、生产案例与故障排查</h2>
<h3 data-id="heading-35">4.1 案例1：本地缓存未设上限导致OOM</h3>
<h4 data-id="heading-36">4.1.1 故障现象</h4>
<p>某电商平台商品服务在运行一周后突然出现：</p>
<ul>
<li>Java进程OOM: <code>java.lang.OutOfMemoryError: Java heap space</code></li>
<li>频繁Full GC，每次GC后老年代回收很少</li>
<li>服务响应变慢，最终不可用</li>
</ul>
<h4 data-id="heading-37">4.1.2 排查过程</h4>
<p><strong>Step 1: 获取堆dump</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 找到进程ID</span>
jps -l

<span class="hljs-comment"># 2. 生成堆dump</span>
jmap -dump:live,format=b,file=heap.hprof &lt;pid&gt;

<span class="hljs-comment"># 3. 使用MAT分析</span>
<span class="hljs-comment"># Eclipse Memory Analyzer Tool</span>
</code></pre>
<p><strong>Step 2: MAT分析</strong></p>
<p>打开<code>heap.hprof</code>，查看Dominator Tree：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">Class Name                           Objects   Shallow Heap   Retained Heap
-----------------------------------------------------------------------------</span>
ConcurrentHashMap                        1         48 bytes    3.2 GB !!!
  |- Node[]                              1       800 MB        3.2 GB
<span class="hljs-code">      |- Product (自定义类)          500,000     80 MB         2.4 GB
</span></code></pre>
<p>发现：</p>
<ul>
<li><code>ConcurrentHashMap</code>占用<strong>3.2GB</strong>内存</li>
<li>存储了<strong>50万个</strong>Product对象</li>
<li>占用了堆内存的<strong>80%</strong></li>
</ul>
<p><strong>Step 3: 查看代码</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 问题代码</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {
    <span class="hljs-comment">// ❌ 没有容量限制的缓存</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;Long, Product&gt; productCache =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProduct</span><span class="hljs-params">(Long productId)</span> {
        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> productCache.get(productId);
        <span class="hljs-keyword">if</span> (product == <span class="hljs-literal">null</span>) {
            product = productMapper.selectById(productId);
            <span class="hljs-comment">// ❌ 只put不remove，持续增长</span>
            productCache.put(productId, product);
        }
        <span class="hljs-keyword">return</span> product;
    }
}
</code></pre>
<h4 data-id="heading-38">4.1.3 问题分析</h4>
<p><strong>根本原因：</strong></p>
<ol>
<li>❌ <strong>只put不remove</strong>：每次查询新商品都会缓存，从不删除</li>
<li>❌ <strong>没有过期策略</strong>：旧数据永远不会过期</li>
<li>❌ <strong>没有容量限制</strong>：缓存无限增长</li>
</ol>
<p><strong>增长趋势：</strong></p>
<ul>
<li>商品总数：100万</li>
<li>每天访问不同商品：5万</li>
<li>7天后缓存商品数：35万</li>
<li>按每个Product 5KB计算：35万 * 5KB = 1.75GB</li>
</ul>
<h4 data-id="heading-39">4.1.4 解决方案</h4>
<p><strong>方案A：使用Guava Cache（推荐）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {
    <span class="hljs-comment">// ✅ 使用Guava Cache，自动过期和容量限制</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> LoadingCache&lt;Long, Product&gt; productCache = CacheBuilder.newBuilder()
        .maximumSize(<span class="hljs-number">10000</span>)  <span class="hljs-comment">// 最大缓存10000个商品</span>
        .expireAfterWrite(<span class="hljs-number">1</span>, TimeUnit.HOURS)  <span class="hljs-comment">// 1小时后过期</span>
        .recordStats()  <span class="hljs-comment">// 记录缓存统计</span>
        .build(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheLoader</span>&lt;Long, Product&gt;() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">load</span><span class="hljs-params">(Long id)</span> {
                <span class="hljs-keyword">return</span> productMapper.selectById(id);
            }
        });

    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProduct</span><span class="hljs-params">(Long productId)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> productCache.get(productId);
        } <span class="hljs-keyword">catch</span> (ExecutionException e) {
            log.error(<span class="hljs-string">"加载商品缓存失败: productId={}"</span>, productId, e);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    }

    <span class="hljs-comment">// 查看缓存统计</span>
    <span class="hljs-meta">@Scheduled(fixedRate = 60000)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logCacheStats</span><span class="hljs-params">()</span> {
        <span class="hljs-type">CacheStats</span> <span class="hljs-variable">stats</span> <span class="hljs-operator">=</span> productCache.stats();
        log.info(<span class="hljs-string">"商品缓存统计: hitRate={}, size={}, evictionCount={}"</span>,
            stats.hitRate(), productCache.size(), stats.evictionCount());
    }
}
</code></pre>
<p><strong>方案B：ConcurrentHashMap + 定期清理 + LRU</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductServiceWithLRU</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">EXPIRE_TIME</span> <span class="hljs-operator">=</span> <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>;  <span class="hljs-comment">// 1小时</span>

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;Long, CacheEntry&lt;Product&gt;&gt; productCache =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-comment">// LRU队列（访问顺序）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentLinkedDeque&lt;Long&gt; lruQueue =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentLinkedDeque</span>&lt;&gt;();

    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheEntry</span>&lt;T&gt; {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> T value;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> createTime;

        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isExpired</span><span class="hljs-params">(<span class="hljs-type">long</span> expireTime)</span> {
            <span class="hljs-keyword">return</span> System.currentTimeMillis() - createTime &gt; expireTime;
        }
    }

    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProduct</span><span class="hljs-params">(Long productId)</span> {
        CacheEntry&lt;Product&gt; entry = productCache.get(productId);

        <span class="hljs-comment">// 缓存命中且未过期</span>
        <span class="hljs-keyword">if</span> (entry != <span class="hljs-literal">null</span> &amp;&amp; !entry.isExpired(EXPIRE_TIME)) {
            <span class="hljs-comment">// 更新LRU</span>
            lruQueue.remove(productId);
            lruQueue.offerLast(productId);
            <span class="hljs-keyword">return</span> entry.getValue();
        }

        <span class="hljs-comment">// 缓存不存在或已过期，加载数据</span>
        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> productMapper.selectById(productId);
        <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) {
            put(productId, product);
        }

        <span class="hljs-keyword">return</span> product;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(Long key, Product value)</span> {
        <span class="hljs-comment">// 容量检查，超过则移除最久未使用的</span>
        <span class="hljs-keyword">if</span> (productCache.size() &gt;= MAX_SIZE) {
            <span class="hljs-type">Long</span> <span class="hljs-variable">oldest</span> <span class="hljs-operator">=</span> lruQueue.pollFirst();
            <span class="hljs-keyword">if</span> (oldest != <span class="hljs-literal">null</span>) {
                productCache.remove(oldest);
            }
        }

        productCache.put(key, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheEntry</span>&lt;&gt;(value, System.currentTimeMillis()));
        lruQueue.offerLast(key);
    }

    <span class="hljs-comment">// 定期清理过期数据</span>
    <span class="hljs-meta">@Scheduled(fixedRate = 60000)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cleanExpired</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">cleanCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (Long key : productCache.keySet()) {
            CacheEntry&lt;Product&gt; entry = productCache.get(key);
            <span class="hljs-keyword">if</span> (entry != <span class="hljs-literal">null</span> &amp;&amp; entry.isExpired(EXPIRE_TIME)) {
                productCache.remove(key);
                lruQueue.remove(key);
                cleanCount++;
            }
        }
        <span class="hljs-keyword">if</span> (cleanCount &gt; <span class="hljs-number">0</span>) {
            log.info(<span class="hljs-string">"清理过期缓存: count={}, size={}"</span>, cleanCount, productCache.size());
        }
    }
}
</code></pre>
<p><strong>方案C：限制最大容量（简单版）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductServiceSimple</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;Long, Product&gt; productCache =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProduct</span><span class="hljs-params">(Long productId)</span> {
        <span class="hljs-keyword">return</span> productCache.computeIfAbsent(productId, id -&gt; {
            <span class="hljs-comment">// 容量检查</span>
            <span class="hljs-keyword">if</span> (productCache.size() &gt;= MAX_SIZE) {
                log.warn(<span class="hljs-string">"缓存已满，拒绝新增: size={}"</span>, productCache.size());
                <span class="hljs-keyword">return</span> productMapper.selectById(id);  <span class="hljs-comment">// 不缓存，直接返回</span>
            }

            <span class="hljs-keyword">return</span> productMapper.selectById(id);
        });
    }
}
</code></pre>
<h4 data-id="heading-40">4.1.5 最佳实践</h4>
<p><strong>本地缓存使用规范：</strong></p>
<ol>
<li>✅ <strong>必须设置容量上限</strong>（maximumSize）</li>
<li>✅ <strong>必须设置过期时间</strong>（expireAfterWrite/expireAfterAccess）</li>
<li>✅ <strong>优先使用Guava Cache</strong>，而非裸用ConcurrentHashMap</li>
<li>✅ <strong>定期清理过期数据</strong></li>
<li>✅ <strong>监控缓存命中率</strong>和容量</li>
<li>✅ <strong>压测验证内存占用</strong></li>
</ol>
<hr/>
<h3 data-id="heading-41">4.2 案例2：ConcurrentHashMap的size()方法性能问题</h3>
<h4 data-id="heading-42">4.2.1 业务场景</h4>
<p>某监控系统需要频繁调用<code>size()</code>统计缓存大小，用于告警：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Scheduled(fixedRate = 1000)</span>  <span class="hljs-comment">// 每秒执行一次</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">monitorCacheSize</span><span class="hljs-params">()</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> cache.size();
    <span class="hljs-keyword">if</span> (size &gt; <span class="hljs-number">100000</span>) {
        alertService.send(<span class="hljs-string">"缓存容量告警: "</span> + size);
    }
}
</code></pre>
<h4 data-id="heading-43">4.2.2 性能问题</h4>
<p><strong>问题分析：</strong></p>
<p><code>ConcurrentHashMap</code>的<code>size()</code>方法需要遍历<strong>所有Node</strong>进行累加：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span> {
    <span class="hljs-type">long</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> sumCount();
    <span class="hljs-keyword">return</span> ((n &lt; <span class="hljs-number">0L</span>) ? <span class="hljs-number">0</span> :
            (n &gt; (<span class="hljs-type">long</span>)Integer.MAX_VALUE) ? Integer.MAX_VALUE :
            (<span class="hljs-type">int</span>)n);
}

<span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-title function_">sumCount</span><span class="hljs-params">()</span> {
    CounterCell[] as = counterCells; CounterCell a;
    <span class="hljs-type">long</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> baseCount;
    <span class="hljs-keyword">if</span> (as != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 遍历所有CounterCell累加</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; as.length; ++i) {
            <span class="hljs-keyword">if</span> ((a = as[i]) != <span class="hljs-literal">null</span>)
                sum += a.value;
        }
    }
    <span class="hljs-keyword">return</span> sum;
}
</code></pre>
<p>虽然JDK 1.8使用<code>CounterCell</code>数组分段计数，但仍需<strong>遍历数组</strong>，数据量大时有性能开销。</p>
<p><strong>性能测试：</strong></p>






























<table><thead><tr><th>缓存大小</th><th>size()耗时</th><th>每秒调用1000次影响</th></tr></thead><tbody><tr><td>1万</td><td>0.01ms</td><td>可忽略</td></tr><tr><td>10万</td><td>0.05ms</td><td>50ms/s</td></tr><tr><td>100万</td><td>0.2ms</td><td>200ms/s</td></tr><tr><td>1000万</td><td>1ms</td><td>1000ms/s（1秒）</td></tr></tbody></table>
<p>当缓存达到<strong>百万级</strong>时，频繁调用<code>size()</code>会显著影响性能。</p>
<h4 data-id="heading-44">4.2.3 解决方案</h4>
<p><strong>使用AtomicLong单独计数</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MonitoredCache</span>&lt;K, V&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;K, V&gt; cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-comment">// ✅ 单独维护计数器</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicLong</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0</span>);

    <span class="hljs-keyword">public</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> {
        <span class="hljs-type">V</span> <span class="hljs-variable">oldValue</span> <span class="hljs-operator">=</span> cache.put(key, value);
        <span class="hljs-keyword">if</span> (oldValue == <span class="hljs-literal">null</span>) {
            count.incrementAndGet();  <span class="hljs-comment">// 新增</span>
        }
        <span class="hljs-keyword">return</span> oldValue;
    }

    <span class="hljs-keyword">public</span> V <span class="hljs-title function_">putIfAbsent</span><span class="hljs-params">(K key, V value)</span> {
        <span class="hljs-type">V</span> <span class="hljs-variable">oldValue</span> <span class="hljs-operator">=</span> cache.putIfAbsent(key, value);
        <span class="hljs-keyword">if</span> (oldValue == <span class="hljs-literal">null</span>) {
            count.incrementAndGet();  <span class="hljs-comment">// 新增</span>
        }
        <span class="hljs-keyword">return</span> oldValue;
    }

    <span class="hljs-keyword">public</span> V <span class="hljs-title function_">remove</span><span class="hljs-params">(K key)</span> {
        <span class="hljs-type">V</span> <span class="hljs-variable">removed</span> <span class="hljs-operator">=</span> cache.remove(key);
        <span class="hljs-keyword">if</span> (removed != <span class="hljs-literal">null</span>) {
            count.decrementAndGet();  <span class="hljs-comment">// 删除</span>
        }
        <span class="hljs-keyword">return</span> removed;
    }

    <span class="hljs-keyword">public</span> V <span class="hljs-title function_">get</span><span class="hljs-params">(K key)</span> {
        <span class="hljs-keyword">return</span> cache.get(key);
    }

    <span class="hljs-comment">/**
     * 快速获取大小（O(1)）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> count.get();
    }

    <span class="hljs-comment">/**
     * 精确大小（需要时调用）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">actualSize</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> cache.size();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> {
        cache.clear();
        count.set(<span class="hljs-number">0</span>);
    }
}
</code></pre>
<h4 data-id="heading-45">4.2.4 性能对比</h4>























<table><thead><tr><th>方案</th><th>获取大小耗时</th><th>100万数据</th><th>1000万数据</th></tr></thead><tbody><tr><td><code>cache.size()</code></td><td>遍历累加</td><td>0.2ms</td><td>1ms</td></tr><tr><td><code>count.get()</code></td><td><strong>O(1)</strong></td><td><strong>0.001ms</strong></td><td><strong>0.001ms</strong></td></tr></tbody></table>
<p><strong>性能提升：200倍</strong></p>
<h4 data-id="heading-46">4.2.5 注意事项</h4>
<p><strong>为什么不能完全替代size()？</strong></p>
<ul>
<li><code>AtomicLong</code>计数可能不精确（并发remove时）</li>
<li>需要在所有修改方法中同步更新计数</li>
<li>适用于<strong>读多写少</strong>的场景</li>
</ul>
<p><strong>推荐使用场景：</strong></p>
<ul>
<li>✅ 监控告警（允许轻微误差）</li>
<li>✅ 统计大盘数据</li>
<li>❌ 需要精确计数的业务逻辑</li>
</ul>
<hr/>
<h2 data-id="heading-47">五、常见问题与避坑指南</h2>
<h3 data-id="heading-48">5.1 ConcurrentHashMap为什么key和value不允许null？</h3>
<p><strong>原因：二义性问题</strong></p>
<p>在并发环境下，如果允许null会产生歧义：</p>
<pre><code class="hljs language-java" lang="java">ConcurrentHashMap&lt;String, String&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

<span class="hljs-comment">// 假设允许null value</span>
<span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> map.get(<span class="hljs-string">"key"</span>);
<span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// 问题：无法区分以下两种情况</span>
    <span class="hljs-comment">// 1. key不存在</span>
    <span class="hljs-comment">// 2. key存在，但value为null</span>
}

<span class="hljs-comment">// HashMap可以用containsKey()判断，但ConcurrentHashMap不行</span>
<span class="hljs-keyword">if</span> (map.containsKey(<span class="hljs-string">"key"</span>)) {
    <span class="hljs-comment">// 在containsKey()和get()之间，其他线程可能remove了key</span>
    <span class="hljs-comment">// 导致判断失效</span>
}
</code></pre>
<p><strong>HashMap为什么可以？</strong></p>
<ul>
<li>HashMap是非线程安全的，单线程环境下可以用<code>containsKey()</code>准确判断</li>
<li>ConcurrentHashMap在并发环境下，<code>containsKey()</code>和<code>get()</code>之间状态可能变化</li>
</ul>
<p><strong>源码验证：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> {
    <span class="hljs-keyword">if</span> (key == <span class="hljs-literal">null</span> || value == <span class="hljs-literal">null</span>)
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>();  <span class="hljs-comment">// 直接抛异常</span>
    ...
}
</code></pre>
<hr/>
<h3 data-id="heading-49">5.2 ConcurrentHashMap是强一致性的吗？</h3>
<p><strong>答案：不是，是弱一致性</strong></p>
<p><strong>弱一致性表现：</strong></p>
<ol>
<li>
<p><strong>size()方法</strong>：返回的是<strong>近似值</strong>，可能不准确</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 线程1</span>
map.put(<span class="hljs-string">"k1"</span>, <span class="hljs-string">"v1"</span>);

<span class="hljs-comment">// 线程2（同时）</span>
<span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> map.size();  <span class="hljs-comment">// 可能看不到线程1的put</span>
</code></pre>
</li>
<li>
<p><strong>迭代器</strong>：返回的是<strong>某一时刻的快照</strong>，不保证实时性</p>
<pre><code class="hljs language-java" lang="java">Iterator&lt;String&gt; it = map.keySet().iterator();
<span class="hljs-keyword">while</span> (it.hasNext()) {
    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> it.next();
    <span class="hljs-comment">// 迭代过程中，其他线程的put/remove不一定能看到</span>
}
</code></pre>
</li>
<li>
<p><strong>聚合操作</strong>：如<code>putAll()</code>, <code>clear()</code>，不是原子的</p>
<pre><code class="hljs language-java" lang="java">map.putAll(otherMap);  <span class="hljs-comment">// 不是原子操作，中间状态可见</span>
</code></pre>
</li>
</ol>
<p><strong>为什么不是强一致？</strong></p>
<ul>
<li><strong>性能优先</strong>：强一致需要全局锁，性能损失大</li>
<li><strong>实际需求</strong>：大多数场景下弱一致性足够</li>
</ul>
<p><strong>需要强一致性怎么办？</strong></p>
<ul>
<li>使用<code>Collections.synchronizedMap()</code></li>
<li>或在外部加锁</li>
</ul>
<hr/>
<h3 data-id="heading-50">5.3 为什么链表长度阈值是8，树退化阈值是6？</h3>
<p><strong>树化阈值为8的原因：</strong></p>
<p>根据<strong>泊松分布</strong>，hash碰撞达到8个节点的概率极低：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">0:    0.60653066</span>
<span class="hljs-section">1:    0.30326533</span>
<span class="hljs-section">2:    0.07581633</span>
<span class="hljs-section">3:    0.01263606</span>
<span class="hljs-section">4:    0.00157952</span>
<span class="hljs-section">5:    0.00015795</span>
<span class="hljs-section">6:    0.00001316</span>
<span class="hljs-section">7:    0.00000094</span>
<span class="hljs-section">8:    0.00000006  // 千万分之一</span>
</code></pre>
<p>即使hash算法一般，链表长度也很难达到8，因此8是一个合理的阈值。</p>
<p><strong>为什么不是7或9？</strong></p>
<ul>
<li><strong>性能平衡</strong>：链表遍历O(n)，红黑树O(logn)，当n=8时性能差异显著</li>
<li><strong>内存开销</strong>：TreeNode占用空间是Node的<strong>2倍</strong>，过早树化浪费内存</li>
</ul>
<p><strong>树退化阈值为6的原因：</strong></p>
<p><strong>防止频繁树化/退化</strong>：</p>
<ul>
<li>如果阈值都是8，在7-8之间反复增删会导致频繁树化和退化</li>
<li>设置为6提供了一个<strong>缓冲区间</strong>[6, 8]，避免抖动</li>
</ul>

<pre><code class="hljs language-rust" lang="rust">链表长度变化:
  <span class="hljs-number">7</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">8</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">7</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">8</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">7</span>  (如果阈值都是<span class="hljs-number">8</span>)
  频繁树化 ↔ 退化（性能差）

  <span class="hljs-number">7</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">8</span>（树化） <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">7</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">6</span>（退化） <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">7</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">8</span>（树化）
  缓冲区间[<span class="hljs-number">6</span>,<span class="hljs-number">8</span>]，减少转换次数
</code></pre>
<hr/>
<h3 data-id="heading-51">5.4 ConcurrentHashMap的并发度是什么？如何设置？</h3>
<p><strong>并发度（concurrencyLevel）：</strong></p>
<ul>
<li>
<p><strong>JDK 1.7</strong>：Segment数组长度，默认16</p>
<ul>
<li>表示最多<strong>16个线程</strong>可以同时修改（每个Segment一个）</li>
<li>初始化时指定：<code>new ConcurrentHashMap&lt;&gt;(16, 0.75f, 16)</code></li>
</ul>
</li>
<li>
<p><strong>JDK 1.8</strong>：已废弃，并发度动态等于<strong>数组长度</strong></p>
<ul>
<li>数组扩容时并发度自动翻倍</li>
<li>理论上可以有<strong>数组长度</strong>个线程同时修改不同桶</li>
</ul>
</li>
</ul>
<p><strong>如何设置？</strong></p>
<p>JDK 1.8中不需要设置，只需指定<code>initialCapacity</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 推荐方式</span>
ConcurrentHashMap&lt;K, V&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;(initialCapacity);

<span class="hljs-comment">// initialCapacity建议设置为预期元素数量 / 0.75</span>
<span class="hljs-type">int</span> <span class="hljs-variable">expectedSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;
<span class="hljs-type">int</span> <span class="hljs-variable">initialCapacity</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (expectedSize / <span class="hljs-number">0.75</span>) + <span class="hljs-number">1</span>;
ConcurrentHashMap&lt;K, V&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;(initialCapacity);
</code></pre>
<hr/>
<h3 data-id="heading-52">5.5 迭代ConcurrentHashMap时能修改吗？</h3>
<p><strong>答案：可以，但要小心</strong></p>
<p><strong>ConcurrentHashMap的迭代器是fail-safe的：</strong></p>
<pre><code class="hljs language-java" lang="java">ConcurrentHashMap&lt;String, String&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
map.put(<span class="hljs-string">"k1"</span>, <span class="hljs-string">"v1"</span>);
map.put(<span class="hljs-string">"k2"</span>, <span class="hljs-string">"v2"</span>);

<span class="hljs-comment">// ✅ 迭代时可以修改，不会抛异常</span>
<span class="hljs-keyword">for</span> (String key : map.keySet()) {
    map.put(<span class="hljs-string">"k3"</span>, <span class="hljs-string">"v3"</span>);  <span class="hljs-comment">// 允许</span>
    map.remove(<span class="hljs-string">"k2"</span>);     <span class="hljs-comment">// 允许</span>
}

<span class="hljs-comment">// HashMap会抛ConcurrentModificationException</span>
HashMap&lt;String, String&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
<span class="hljs-keyword">for</span> (String key : hashMap.keySet()) {
    hashMap.put(<span class="hljs-string">"k3"</span>, <span class="hljs-string">"v3"</span>);  <span class="hljs-comment">// ❌ 抛异常</span>
}
</code></pre>
<p><strong>注意事项：</strong></p>
<ol>
<li><strong>新增的元素可能看不到</strong>：迭代器返回的是某一时刻的快照</li>
<li><strong>删除的元素可能还能看到</strong>：迭代器已经缓存</li>
<li><strong>不保证迭代顺序</strong></li>
</ol>
<p><strong>安全的迭代方式：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 方式1：先复制，再迭代</span>
List&lt;String&gt; keys = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(map.keySet());
<span class="hljs-keyword">for</span> (String key : keys) {
    map.remove(key);  <span class="hljs-comment">// 安全</span>
}

<span class="hljs-comment">// 方式2：使用Iterator.remove()</span>
Iterator&lt;String&gt; it = map.keySet().iterator();
<span class="hljs-keyword">while</span> (it.hasNext()) {
    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> it.next();
    it.remove();  <span class="hljs-comment">// 安全</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-53">5.6 compute/computeIfAbsent的线程安全问题</h3>
<p><strong>compute系列方法是原子的：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✅ computeIfAbsent是原子操作</span>
map.computeIfAbsent(<span class="hljs-string">"key"</span>, k -&gt; expensiveCompute());

<span class="hljs-comment">// ❌ 错误：非原子，可能多次计算</span>
<span class="hljs-keyword">if</span> (map.get(<span class="hljs-string">"key"</span>) == <span class="hljs-literal">null</span>) {
    map.put(<span class="hljs-string">"key"</span>, expensiveCompute());  <span class="hljs-comment">// 可能被多个线程执行</span>
}
</code></pre>
<p><strong>源码分析：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> V <span class="hljs-title function_">computeIfAbsent</span><span class="hljs-params">(K key, Function&lt;? <span class="hljs-built_in">super</span> K, ? extends V&gt; mappingFunction)</span> {
    ...
    <span class="hljs-keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) {
        ...
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((f = tabAt(tab, i = (n - <span class="hljs-number">1</span>) &amp; h)) == <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 桶为空，CAS插入</span>
            Node&lt;K,V&gt; r = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReservationNode</span>&lt;K,V&gt;();
            <span class="hljs-keyword">synchronized</span> (r) {  <span class="hljs-comment">// 临时节点加锁</span>
                <span class="hljs-keyword">if</span> (casTabAt(tab, i, <span class="hljs-literal">null</span>, r)) {
                    <span class="hljs-keyword">try</span> {
                        <span class="hljs-type">V</span> <span class="hljs-variable">v</span> <span class="hljs-operator">=</span> mappingFunction.apply(key);  <span class="hljs-comment">// 只计算一次</span>
                        ...
                    }
                }
            }
        }
        <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">synchronized</span> (f) {  <span class="hljs-comment">// 锁定桶</span>
                ...
                <span class="hljs-keyword">if</span> (binCount != <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)
                        treeifyBin(tab, i);
                    <span class="hljs-keyword">if</span> (oldVal != <span class="hljs-literal">null</span>)
                        <span class="hljs-keyword">return</span> oldVal;
                    <span class="hljs-keyword">break</span>;
                }
            }
        }
    }
    ...
}
</code></pre>
<p><strong>关键点：</strong></p>
<ul>
<li><code>mappingFunction.apply()</code>只会被<strong>一个线程执行</strong></li>
<li>其他线程会等待第一个线程完成</li>
</ul>
<p><strong>⚠️ 注意死锁风险：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 可能死锁</span>
map.computeIfAbsent(<span class="hljs-string">"key1"</span>, k -&gt; {
    <span class="hljs-keyword">return</span> map.computeIfAbsent(<span class="hljs-string">"key2"</span>, k2 -&gt; <span class="hljs-string">"value"</span>);  <span class="hljs-comment">// 嵌套锁</span>
});
</code></pre>
<p><strong>正确用法：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✅ 避免嵌套</span>
<span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> map.computeIfAbsent(<span class="hljs-string">"key"</span>, k -&gt; computeValue());
</code></pre>
<hr/>
<h3 data-id="heading-54">5.7 putIfAbsent vs computeIfAbsent的区别</h3>






























<table><thead><tr><th>对比项</th><th>putIfAbsent</th><th>computeIfAbsent</th></tr></thead><tbody><tr><td><strong>参数</strong></td><td><code>putIfAbsent(K key, V value)</code></td><td><code>computeIfAbsent(K key, Function&lt;K, V&gt; f)</code></td></tr><tr><td><strong>计算时机</strong></td><td><strong>立即计算</strong>value</td><td><strong>延迟计算</strong>，key不存在时才计算</td></tr><tr><td><strong>性能</strong></td><td>浪费计算（value已计算好）</td><td><strong>懒加载</strong>，性能更好</td></tr><tr><td><strong>适用场景</strong></td><td>value已准备好</td><td>value计算昂贵</td></tr></tbody></table>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 场景1：value已准备好 → putIfAbsent</span>
<span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-string">"computed-value"</span>;
map.putIfAbsent(<span class="hljs-string">"key"</span>, value);

<span class="hljs-comment">// 场景2：value需要计算 → computeIfAbsent（推荐）</span>
map.computeIfAbsent(<span class="hljs-string">"key"</span>, k -&gt; {
    <span class="hljs-comment">// 只有key不存在时才执行</span>
    <span class="hljs-keyword">return</span> expensiveCompute();
});

<span class="hljs-comment">// ❌ 错误用法：提前计算浪费</span>
<span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> expensiveCompute();  <span class="hljs-comment">// key存在时白算了</span>
map.putIfAbsent(<span class="hljs-string">"key"</span>, value);
</code></pre>
<hr/>
<h3 data-id="heading-55">5.8 如何正确统计ConcurrentHashMap的元素数量？</h3>
<p><strong>方法1：size()（推荐）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> map.size();  <span class="hljs-comment">// O(counterCells.length)</span>
</code></pre>
<p><strong>优点</strong>：</p>
<ul>
<li>✅ 实现简单</li>
<li>✅ 性能尚可（遍历counterCells数组）</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>❌ 返回<strong>近似值</strong>，不保证精确</li>
<li>❌ 数据量大时有性能开销</li>
</ul>
<p><strong>方法2：AtomicLong计数（精确）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicLong</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0</span>);

<span class="hljs-keyword">public</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> {
    <span class="hljs-type">V</span> <span class="hljs-variable">oldValue</span> <span class="hljs-operator">=</span> map.put(key, value);
    <span class="hljs-keyword">if</span> (oldValue == <span class="hljs-literal">null</span>) {
        count.incrementAndGet();
    }
    <span class="hljs-keyword">return</span> oldValue;
}

<span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> count.get();  <span class="hljs-comment">// O(1)</span>
}
</code></pre>
<p><strong>优点</strong>：</p>
<ul>
<li>✅ O(1)性能</li>
<li>✅ 实时精确</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>❌ 需要在所有修改方法中同步更新</li>
<li>❌ 代码侵入性强</li>
</ul>
<p><strong>方法3：mappingCount()（JDK 1.8推荐）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> map.mappingCount();  <span class="hljs-comment">// 返回long，避免溢出</span>
</code></pre>
<p><strong>区别：</strong></p>
<ul>
<li><code>size()</code>返回<code>int</code>，最大<code>Integer.MAX_VALUE</code></li>
<li><code>mappingCount()</code>返回<code>long</code>，支持更大容量</li>
</ul>
<p><strong>推荐：</strong></p>
<ul>
<li>普通场景：<code>size()</code></li>
<li>超大容量：<code>mappingCount()</code></li>
<li>性能敏感：<code>AtomicLong</code></li>
</ul>
<hr/>
<h2 data-id="heading-56">六、最佳实践与总结</h2>
<h3 data-id="heading-57">6.1 什么场景使用ConcurrentHashMap？</h3>
<p><strong>适用场景：</strong></p>
<ol>
<li>✅ <strong>高并发读写</strong>：多线程频繁读写共享Map</li>
<li>✅ <strong>读多写少</strong>：如配置缓存、用户session</li>
<li>✅ <strong>无需强一致性</strong>：允许读到稍旧的数据</li>
<li>✅ <strong>需要高性能</strong>：Hashtable性能不满足需求</li>
</ol>
<p><strong>不适用场景：</strong></p>
<ol>
<li>❌ <strong>单线程</strong>：HashMap性能更好</li>
<li>❌ <strong>需要强一致性</strong>：使用<code>Collections.synchronizedMap()</code></li>
<li>❌ <strong>需要排序</strong>：使用<code>ConcurrentSkipListMap</code></li>
<li>❌ <strong>key/value允许null</strong>：使用<code>Collections.synchronizedMap(new HashMap&lt;&gt;())</code></li>
</ol>
<hr/>
<h3 data-id="heading-58">6.2 如何正确使用ConcurrentHashMap？</h3>
<p><strong>1. 选择合适的初始容量</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✅ 推荐：预估元素数量，避免扩容</span>
<span class="hljs-type">int</span> <span class="hljs-variable">expectedSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;
<span class="hljs-type">int</span> <span class="hljs-variable">initialCapacity</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (expectedSize / <span class="hljs-number">0.75</span>) + <span class="hljs-number">1</span>;
ConcurrentHashMap&lt;K, V&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;(initialCapacity);

<span class="hljs-comment">// ❌ 不推荐：默认容量16，频繁扩容</span>
ConcurrentHashMap&lt;K, V&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
</code></pre>
<p><strong>2. 使用compute系列方法保证原子性</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✅ 原子操作</span>
map.computeIfAbsent(<span class="hljs-string">"key"</span>, k -&gt; computeValue());

<span class="hljs-comment">// ❌ 非原子</span>
<span class="hljs-keyword">if</span> (!map.containsKey(<span class="hljs-string">"key"</span>)) {
    map.put(<span class="hljs-string">"key"</span>, computeValue());
}
</code></pre>
<p><strong>3. 避免在compute中嵌套修改</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 可能死锁</span>
map.computeIfAbsent(<span class="hljs-string">"key1"</span>, k -&gt; map.get(<span class="hljs-string">"key2"</span>));

<span class="hljs-comment">// ✅ 先获取，再计算</span>
<span class="hljs-type">String</span> <span class="hljs-variable">key2Value</span> <span class="hljs-operator">=</span> map.get(<span class="hljs-string">"key2"</span>);
map.computeIfAbsent(<span class="hljs-string">"key1"</span>, k -&gt; process(key2Value));
</code></pre>
<p><strong>4. 使用mappingCount()替代size()</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✅ 支持long，避免溢出</span>
<span class="hljs-type">long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> map.mappingCount();

<span class="hljs-comment">// ⚠️ 返回int，可能溢出</span>
<span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> map.size();
</code></pre>
<hr/>
<h3 data-id="heading-59">6.3 性能优化建议</h3>
<p><strong>1. 合理设置初始容量和加载因子</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 场景：预期10000个元素，读多写少</span>
ConcurrentHashMap&lt;K, V&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;(
    <span class="hljs-number">16384</span>,  <span class="hljs-comment">// initialCapacity: 10000 / 0.75 ≈ 13333，向上取2的幂次 = 16384</span>
    <span class="hljs-number">0.75f</span>   <span class="hljs-comment">// loadFactor: 默认0.75即可</span>
);
</code></pre>
<p><strong>2. 避免频繁size()调用</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 每次都调用size()</span>
<span class="hljs-keyword">for</span> (...) {
    <span class="hljs-keyword">if</span> (map.size() &gt; <span class="hljs-number">10000</span>) {
        ...
    }
}

<span class="hljs-comment">// ✅ 缓存size()结果</span>
<span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> map.size();
<span class="hljs-keyword">for</span> (...) {
    <span class="hljs-keyword">if</span> (size &gt; <span class="hljs-number">10000</span>) {
        ...
    }
}
</code></pre>
<p><strong>3. 批量操作使用putAll()</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 逐个put</span>
<span class="hljs-keyword">for</span> (Entry&lt;K, V&gt; entry : entries) {
    map.put(entry.getKey(), entry.getValue());
}

<span class="hljs-comment">// ✅ 批量putAll</span>
map.putAll(otherMap);
</code></pre>
<hr/>
<h3 data-id="heading-60">6.4 常见错误用法</h3>
<p><strong>错误1：当作强一致性容器</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误：以为是原子操作</span>
<span class="hljs-keyword">if</span> (map.size() &gt; <span class="hljs-number">100</span>) {
    map.remove(oldestKey);  <span class="hljs-comment">// size()和remove()之间，size可能已变化</span>
}

<span class="hljs-comment">// ✅ 正确：单独维护计数</span>
<span class="hljs-keyword">if</span> (count.get() &gt; <span class="hljs-number">100</span>) {
    removeOldest();
}
</code></pre>
<p><strong>错误2：依赖迭代顺序</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误：ConcurrentHashMap不保证顺序</span>
<span class="hljs-keyword">for</span> (String key : map.keySet()) {
    <span class="hljs-comment">// 期望按插入顺序...</span>
}

<span class="hljs-comment">// ✅ 正确：使用ConcurrentSkipListMap（有序）</span>
ConcurrentNavigableMap&lt;K, V&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentSkipListMap</span>&lt;&gt;();
</code></pre>
<p><strong>错误3：忘记处理null</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误：忘记判null</span>
<span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> map.get(<span class="hljs-string">"key"</span>);
value.toString();  <span class="hljs-comment">// NPE</span>

<span class="hljs-comment">// ✅ 正确：判空或使用getOrDefault</span>
<span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> map.getOrDefault(<span class="hljs-string">"key"</span>, defaultValue);
</code></pre>
<hr/>
<h3 data-id="heading-61">6.5 线程安全容器选型指南</h3>









































<table><thead><tr><th>需求</th><th>推荐容器</th></tr></thead><tbody><tr><td><strong>高并发读写Map</strong></td><td><code>ConcurrentHashMap</code></td></tr><tr><td><strong>有序Map</strong></td><td><code>ConcurrentSkipListMap</code></td></tr><tr><td><strong>高并发List</strong></td><td><code>CopyOnWriteArrayList</code>（读多写少）</td></tr><tr><td><strong>高并发Set</strong></td><td><code>ConcurrentHashMap.newKeySet()</code></td></tr><tr><td><strong>高并发Queue</strong></td><td><code>ConcurrentLinkedQueue</code>（无界）<br/><code>LinkedBlockingQueue</code>（有界）</td></tr><tr><td><strong>延迟队列</strong></td><td><code>DelayQueue</code></td></tr><tr><td><strong>优先级队列</strong></td><td><code>PriorityBlockingQueue</code></td></tr><tr><td><strong>强一致性Map</strong></td><td><code>Collections.synchronizedMap()</code></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-62">总结</h2>
<p><code>ConcurrentHashMap</code>是Java并发包中最重要的容器之一，经历了从**分段锁（JDK 1.7）<strong>到</strong>CAS + synchronized（JDK 1.8）**的演进，在保证线程安全的同时实现了极高的并发性能。</p>
<p><strong>核心要点回顾：</strong></p>
<ol>
<li><strong>设计目标</strong>：高并发、高性能、线程安全、弱一致性</li>
<li><strong>JDK 1.7</strong>：Segment分段锁，并发度受限于Segment数量（默认16）</li>
<li><strong>JDK 1.8</strong>：Node数组 + 链表/红黑树，CAS + synchronized，并发度等于数组长度</li>
<li><strong>关键机制</strong>：
<ul>
<li>桶为空：CAS插入（无锁）</li>
<li>正在扩容：协助扩容（多线程协作）</li>
<li>hash冲突：synchronized锁头节点（细粒度锁）</li>
</ul>
</li>
<li><strong>扩容优化</strong>：多线程协作迁移，ForwardingNode标记已迁移桶</li>
<li><strong>计数优化</strong>：baseCount + CounterCell[]，LongAdder思想</li>
</ol>
<p><strong>最佳实践：</strong></p>
<ul>
<li>✅ 预估容量，避免频繁扩容</li>
<li>✅ 使用compute系列方法保证原子性</li>
<li>✅ 使用mappingCount()替代size()</li>
<li>✅ 适用于读多写少、弱一致性场景</li>
<li>❌ 不要在compute中嵌套修改</li>
<li>❌ 不要依赖迭代顺序</li>
<li>❌ 不要频繁调用size()</li>
</ul>
<p><code>ConcurrentHashMap</code>是并发编程的基础组件，深入理解其原理和正确使用方式，对构建高性能并发系统至关重要。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[09 Go Eino AI应用开发实战 | Hertz Web 框架搭建]]></title>    <link>https://juejin.cn/post/7585474459776630820</link>    <guid>https://juejin.cn/post/7585474459776630820</guid>    <pubDate>2025-12-20T09:43:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585474459776630820" data-draft-id="7585390679398858758" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="09 Go Eino AI应用开发实战 | Hertz Web 框架搭建"/> <meta itemprop="keywords" content="后端,人工智能,Go"/> <meta itemprop="datePublished" content="2025-12-20T09:43:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="王中阳讲AI编程"/> <meta itemprop="url" content="https://juejin.cn/user/2189882892232029"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            09 Go Eino AI应用开发实战 | Hertz Web 框架搭建
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2189882892232029/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    王中阳讲AI编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T09:43:30.000Z" title="Sat Dec 20 2025 09:43:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;font-weight:400;line-height:2;font-size:17px;overflow-x:hidden;color:#000}.markdown-body strong{padding:1px;color:#ee3f4d}.markdown-body em{padding:0 2px;color:#f33b1f}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:30px;margin-bottom:20px;line-height:1.5;font-weight:700}.markdown-body h1{text-align:center;padding-bottom:5px;font-size:32px;color:#ac1f18}.markdown-body h1:after{content:"";display:block;margin:4px auto 0;width:100px;height:2px;border-bottom:2px solid #f33b1f}.markdown-body h2{font-size:28px;border-bottom:1px solid #f33b1f}.markdown-body h2:before{content:"# "!important;color:#f33b1f}.markdown-body h3{font-size:24px;padding-left:9px;border-left:6px solid #f33b1f}.markdown-body h4{font-size:20px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #bbb;margin:16px 0}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f9f1db;color:#ee2746;border-radius:2px;font-size:16px;padding:1px 2px}.markdown-body code,.markdown-body pre{font-family:-apple-system,-apple-system-body,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,PingFang SC,思源黑体 CN,思源黑体,JetBrains Mono,Fira Code,Menlo,Ubuntu Mono,Consolas,sans-serif}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{margin:12px 0!important;border-radius:3px;font-size:15px;padding:16px 12px;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f7f7f7}.markdown-body a{text-decoration:none;color:#1781b5;padding:0 2px;border-bottom:1px solid #1781b5}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #f33b1f;color:#ac1f18}.markdown-body blockquote{color:#3d3d3d;background-color:#fff9f9;padding:6px 16px;margin:16px 0;border-left:3px solid #f07c82}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:6px 0}.markdown-body ol,.markdown-body ul{padding-left:30px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:6px}.markdown-body ol li{padding-left:6px}.markdown-body ::marker{color:#f33b1f}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body .task-list-item input[type=checkbox]{position:relative}.markdown-body .task-list-item input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:#fff;border:1px solid #f07c82;border-radius:3px;box-sizing:border-box;z-index:1}.markdown-body .task-list-item input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-5px;left:0;right:0;bottom:0;width:0;height:0;color:#f33b1f;font-size:16px;font-weight:700;z-index:2}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table thead{background:#fff9f9;color:#000;text-align:left;font-size:15px}.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table tr:hover{background-color:#fff9f9}.markdown-body table td,.markdown-body table th{padding:12px 7px;line-height:24px;border:1px solid #f9f1db}.markdown-body table td{min-width:120px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><blockquote>
<p>声明：本AI应用开发系列教程首发在同名公众号：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F5DYsyMKh9cDJdVvs_Mn9_Q" target="_blank" title="https://mp.weixin.qq.com/s/5DYsyMKh9cDJdVvs_Mn9_Q" ref="nofollow noopener noreferrer">王中阳</a>，未经授权禁止转载。</p>
</blockquote>
<p>Hertz Web 框架作为 AI Interview Agent 平台的核心支柱，提供高性能的 HTTP 路由、中间件编排和请求处理能力。本指南涵盖 Hertz 在项目架构中的完整设置和配置。</p>
<h2 data-id="heading-0">框架初始化</h2>
<p>Hertz 服务器在主应用程序入口点初始化，通过包含配置加载、数据库连接和中间件注册的完整设置序列 [main.go#L101-L175]。</p>
<p>服务器初始化遵循以下关键模式：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 使用配置中的主机和端口初始化 Hertz 服务器</span>
s := server.Default(server.WithHostPorts(fmt.Sprintf(<span class="hljs-string">"%s:%d"</span>, cfg.Host, cfg.Port)))
</code></pre>
<h2 data-id="heading-1">中间件架构</h2>
<p>Hertz 实现了分层中间件架构来处理横切关注点：</p>
<h3 data-id="heading-2">恢复中间件</h3>
<p>恢复中间件捕获 panic 并防止服务器崩溃，提供结构化错误响应 [recovery.go#L15-L35]：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Recovery</span><span class="hljs-params">()</span></span> app.HandlerFunc {
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, c *app.RequestContext)</span></span> {
        <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
            <span class="hljs-keyword">if</span> r := <span class="hljs-built_in">recover</span>(); r != <span class="hljs-literal">nil</span> {
                stack := debug.Stack()
                log.Printf(<span class="hljs-string">"[PANIC] Recovered: %v\n%s"</span>, r, stack)
                <span class="hljs-comment">// 返回结构化错误响应</span>
            }
        }()
        c.Next(ctx)
    }
}
</code></pre>
<h3 data-id="heading-3">CORS 配置</h3>
<p>全局 CORS 中间件通过全面的头部配置处理跨域请求 [main.go#L113-L127]：</p>






























<table><thead><tr><th>Header</th><th>Value</th><th>Purpose</th></tr></thead><tbody><tr><td>Access-Control-Allow-Origin</td><td>*</td><td>允许所有来源</td></tr><tr><td>Access-Control-Allow-Methods</td><td>GET, POST, PUT, DELETE, OPTIONS</td><td>允许的 HTTP 方法</td></tr><tr><td>Access-Control-Allow-Headers</td><td>Content-Type, Authorization, X-Requested-With, Cache-Control, X-Auth-Token</td><td>允许的请求头</td></tr><tr><td>Access-Control-Max-Age</td><td>86400</td><td>预检请求缓存 24 小时</td></tr></tbody></table>
<h3 data-id="heading-4">JWT 认证</h3>
<p>JWT 中间件提供基于令牌的认证，支持可配置的路由跳过 [jwt.go#L37-L79]。绕过认证的公共路由包括：</p>
<ul>
<li><code>/api/user/login</code></li>
<li><code>/api/user/register</code></li>
<li><code>/api/user/logout</code></li>
<li><code>/api/user/wechat/login</code></li>
<li><code>/api/user/wechat/callback</code></li>
<li><code>/api/demo/create/model</code></li>
</ul>
<h2 data-id="heading-5">路由注册系统</h2>
<p>Hertz 使用基于 IDL 定义的自动生成路由注册系统 [register.go#L11-L16]。路由层次遵循结构化模式：</p>
<pre><code class="hljs language-bash" lang="bash">/
├── /api/
    ├── /interview/
    │   ├── /records (GET)
    │   └── /stream/
    │       └── /start (POST)
    ├── /mianshi/
    │   ├── /answer-record (GET)
    │   ├── /evaluation (GET)
    │   ├── /records (GET)
    │   ├── /answer/
    │   │   └── /submit (POST)
    │   ├── /interview/
    │   │   └── /end (POST)
    │   ├── /session/
    │   │   └── /info (GET)
    │   └── /stream/
    │       └── /start (POST)
    ├── /prediction/
    │   ├── /:<span class="hljs-built_in">id</span> (GET)
    │   ├── /list (GET)
    │   └── /start (POST)
    ├── /resume/
    │   ├── /default (GET)
    │   ├── /list (GET)
    │   ├── /:resume_id (GET, PUT, DELETE)
    │   ├── /set-default (POST)
    │   └── /upload (POST)
    └── /user/
        ├── /login (POST)
        ├── /register (POST)
        ├── /profile (GET, PUT)
        ├── /create/model (POST)
        ├── /model/
        │   ├── /check (GET)
        │   ├── /list (GET)
        │   ├── /delete/:<span class="hljs-built_in">id</span> (DELETE)
        │   ├── /details/:<span class="hljs-built_in">id</span> (GET)
        │   └── /update/:<span class="hljs-built_in">id</span> (PUT)
        └── /wechat/
            ├── /login (GET)
            └── /callback (GET)
</code></pre>
<p>路由注册是使用 Hertz 生成器从 IDL 定义自动生成的。手动修改生成的文件将在更新时被覆盖。</p>
<h2 data-id="heading-6">配置集成</h2>
<p>Hertz 配置与应用程序的集中式配置系统集成 [config.go#L75-L83]：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> HertzConfig <span class="hljs-keyword">struct</span> {
    Host         <span class="hljs-type">string</span>        <span class="hljs-string">`yaml:"host"`</span>
    Port         <span class="hljs-type">int</span>           <span class="hljs-string">`yaml:"port"`</span>
    ReadTimeout  time.Duration <span class="hljs-string">`yaml:"read_timeout"`</span>
    WriteTimeout time.Duration <span class="hljs-string">`yaml:"write_timeout"`</span>
    IdleTimeout  time.Duration <span class="hljs-string">`yaml:"idle_timeout"`</span>
}
</code></pre>
<p>服务器使用环境变量扩展，允许通过 YAML 文件中的 <code>${VAR_NAME}</code> 语法进行灵活配置。</p>
<h2 data-id="heading-7">优雅关闭</h2>
<p>Hertz 实现了带有适当资源清理的优雅关闭 [main.go#L147-L175]：</p>
<ol>
<li><strong>信号处理</strong>：监听 SIGINT 和 SIGTERM 信号</li>
<li><strong>消费者关闭</strong>：停止消息队列消费者</li>
<li><strong>队列清理</strong>：关闭消息队列连接</li>
<li><strong>服务器关闭</strong>：在 5 秒超时内优雅关闭 HTTP 连接</li>
</ol>
<p>优雅关闭序列确保所有进行中的请求完成，同时阻止新请求，在重启期间维护数据完整性。</p>
<h2 data-id="heading-8">性能考虑</h2>
<p>Hertz 设置包括多项性能优化：</p>
<ul>
<li><strong>连接池</strong>：通过数据库和 Redis 连接设置配置</li>
<li><strong>请求超时</strong>：可配置的读取、写入和空闲超时防止资源泄漏</li>
<li><strong>中间件顺序</strong>：关键中间件（恢复、CORS）置于认证之前以获得最佳性能</li>
<li><strong>静态文件处理</strong>：通过 Hertz 内置的静态文件功能高效提供</li>
</ul>
<h2 data-id="heading-9">集成点</h2>
<p>Hertz 与其他系统组件无缝集成：</p>
<ul>
<li><strong>消息队列</strong>：基于 Redis 的异步处理队列</li>
<li><strong>数据库</strong>：GORM 集成用于数据持久化</li>
<li><strong>AI 服务</strong>：Eino 框架集成用于 AI Agent 编排</li>
<li><strong>文件存储</strong>：简历上传和管理能力</li>
</ul>
<p>框架的模块化设计允许轻松扩展和维护，同时为 AI Interview Agent 平台保持高性能和可靠性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redisson分布式锁实现原理]]></title>    <link>https://juejin.cn/post/7585463195201339442</link>    <guid>https://juejin.cn/post/7585463195201339442</guid>    <pubDate>2025-12-20T08:01:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463195201339442" data-draft-id="7585446706327388169" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redisson分布式锁实现原理"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-20T08:01:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sir761"/> <meta itemprop="url" content="https://juejin.cn/user/1285746184422272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redisson分布式锁实现原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1285746184422272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sir761
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:01:18.000Z" title="Sat Dec 20 2025 08:01:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>说到redis的分布式锁容易想到了setNx，好处是实现简单，但是会有一些问题比如误删锁问题、锁不可重入问题。所以Redisson并没有通过setNx命令来实现加锁，而是自己实现了一套完成的加锁的逻辑</p>
<h3 data-id="heading-0">加锁与解锁</h3>
<p>RLock继承了Java的lock接口，RedissonLock继承自RedissonBaseLock（抽象类），而RedissonBaseLock又实现了RLock。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">//调用getLock时候就是new了一个RedissonLock</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">RLock</span> <span class="hljs-title function_">getLock</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> name</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedissonLock</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">commandExecutor</span>, name);
}
</code></pre>
<p>我们重点看lock方法：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> void lock() {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">this</span>.lock(-<span class="hljs-number">1L</span>, (TimeUnit)<span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>);
    } <span class="hljs-keyword">catch</span> (InterruptedException var2) {
        <span class="hljs-keyword">throw</span> new IllegalStateException();
    }
}
​
<span class="hljs-keyword">private</span> void lock(long leaseTime, TimeUnit unit, boolean interruptibly) throws InterruptedException {
    long threadId = Thread.currentThread().getId();
    <span class="hljs-comment">//调用了tryAcquire获取锁，这里传入了-1L代表没有指定锁的释放时间，正常情况下如果不释放是永久持有。</span>
    <span class="hljs-built_in">Long</span> ttl = <span class="hljs-keyword">this</span>.tryAcquire(-<span class="hljs-number">1L</span>, leaseTime, unit, threadId);
    <span class="hljs-comment">//以下代码先忽略</span>
    <span class="hljs-comment">//.....</span>
}
​
<span class="hljs-keyword">private</span> <span class="hljs-built_in">Long</span> tryAcquire(long waitTime, long leaseTime, TimeUnit unit, long threadId) {
    <span class="hljs-comment">//这里调用get，等待future返回。</span>
    <span class="hljs-keyword">return</span> (<span class="hljs-built_in">Long</span>)<span class="hljs-keyword">this</span>.<span class="hljs-keyword">get</span>(<span class="hljs-keyword">this</span>.tryAcquireAsync0(waitTime, leaseTime, unit, threadId));
}
​
<span class="hljs-keyword">private</span> RFuture&lt;<span class="hljs-built_in">Long</span>&gt; tryAcquireAsync0(long waitTime, long leaseTime, TimeUnit unit, long threadId) {
    <span class="hljs-comment">//使用了线程池去获取锁</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getServiceManager().execute(() -&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.tryAcquireAsync(waitTime, leaseTime, unit, threadId);
    });
}
<span class="hljs-comment">//重点方法来了</span>
<span class="hljs-keyword">private</span> RFuture&lt;<span class="hljs-built_in">Long</span>&gt; tryAcquireAsync(long waitTime, long leaseTime, TimeUnit unit, long threadId) {
    RFuture ttlRemainingFuture;
    <span class="hljs-keyword">if</span> (leaseTime &gt; <span class="hljs-number">0L</span>) {
        <span class="hljs-comment">//如果这里leaseTime不为0说明用户设置了锁的租约时间直接传入。</span>
        ttlRemainingFuture = <span class="hljs-keyword">this</span>.tryLockInnerAsync(waitTime, leaseTime, unit, threadId, RedisCommands.EVAL_LONG);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">//如果这里leaseTime为0说明用户没有限制锁的租约时间，但是这里仍然会传30秒的持有时间</span>
        ttlRemainingFuture = <span class="hljs-keyword">this</span>.tryLockInnerAsync(waitTime, <span class="hljs-keyword">this</span>.internalLockLeaseTime, TimeUnit.MILLISECONDS, threadId, RedisCommands.EVAL_LONG);
    }
​
    CompletionStage&lt;<span class="hljs-built_in">Long</span>&gt; s = <span class="hljs-keyword">this</span>.handleNoSync(threadId, ttlRemainingFuture);
    RFuture&lt;<span class="hljs-built_in">Long</span>&gt; ttlRemainingFuture = new CompletableFutureWrapper(s);
    CompletionStage&lt;<span class="hljs-built_in">Long</span>&gt; f = ttlRemainingFuture.thenApply((ttlRemaining) -&gt; {
        <span class="hljs-comment">//如果为空说明lua获取锁脚本获得了锁</span>
        <span class="hljs-keyword">if</span> (ttlRemaining == <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">//判断是否开启看门狗机制。</span>
            <span class="hljs-keyword">if</span> (leaseTime &gt; <span class="hljs-number">0L</span>) {
                <span class="hljs-keyword">this</span>.internalLockLeaseTime = unit.toMillis(leaseTime);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">this</span>.scheduleExpirationRenewal(threadId);
            }
        }
​
        <span class="hljs-keyword">return</span> ttlRemaining;
    });
    <span class="hljs-keyword">return</span> new CompletableFutureWrapper(f);
}
&lt;T&gt; RFuture&lt;T&gt; tryLockInnerAsync(long waitTime, long leaseTime, TimeUnit unit, long threadId, RedisStrictCommand&lt;T&gt; command) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.evalWriteSyncedNoRetryAsync(<span class="hljs-keyword">this</span>.getRawName(), LongCodec.INSTANCE, command, 
    <span class="hljs-string">"if ((redis.call('exists', KEYS[1]) == 0) or (redis.call('hexists', KEYS[1], ARGV[2]) == 1)) then "</span> +
        <span class="hljs-string">"redis.call('hincrby', KEYS[1], ARGV[2], 1); "</span> +
        <span class="hljs-string">"redis.call('pexpire', KEYS[1], ARGV[1]); "</span>+
        <span class="hljs-string">"return nil; "</span>+ 
    <span class="hljs-string">"end;"</span>+
    <span class="hljs-comment">//返回锁的过期时间。</span>
    <span class="hljs-string">"return redis.call('pttl', KEYS[1]);"</span>, 
    Collections.singletonList(<span class="hljs-keyword">this</span>.getRawName()), new Object[]{unit.toMillis(leaseTime), <span class="hljs-keyword">this</span>.getLockName(threadId)});
}
</code></pre>
<p>获取锁的整个逻辑是：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7303c1cfaf4549c39ec9472e6462b533~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2lyNzYx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766822478&amp;x-signature=QQsH%2FZidVMS0dKLq54qchV%2F1e0E%3D" alt="分布式锁获取过程.drawio-1764576921173-4.png" loading="lazy"/>
首先，如果用户调用获取锁时候没有限制租约时间，redisson会自动给tryLockInnerAsync加上一个30秒的租约时间，并调用scheduleExpirationRenewal进行看门狗机制</p>
<p>tryLockInnerAsync是执行了一个lua脚本，首先redisson他采用的是hash来存放这个锁，key是锁的名字，field由UUID和线程id组成（UUID是区分不同客户端，防止不同客户端但是线程名恰好相同），value是锁的重入次数。这样就避免了锁的误删，重入和死锁问题了。lua的大致流程为：</p>
<ol>
<li>先判断当前锁是否被持有或者持有者是否是当前线程，如果是的话重入次数加1，并设置/重置整个锁 Key 的过期时间（防止死锁）然后返回。</li>
<li>如果上面if不成立说明锁被<strong>别人</strong>持有了，则返回当前锁剩余的存活时间（TTL）。客户端拿到这个时间后，会等待这么久再重试。</li>
</ol>
<p>回到刚刚我们忽略的代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">(<span class="hljs-type">long</span> leaseTime, TimeUnit unit, <span class="hljs-type">boolean</span> interruptibly)</span> <span class="hljs-keyword">throws</span> InterruptedException {
    <span class="hljs-type">long</span> <span class="hljs-variable">threadId</span> <span class="hljs-operator">=</span> Thread.currentThread().getId();
    <span class="hljs-type">Long</span> <span class="hljs-variable">ttl</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.tryAcquire(-<span class="hljs-number">1L</span>, leaseTime, unit, threadId);
    <span class="hljs-comment">//如果这里ttl不为空说明锁被人占有了。</span>
    <span class="hljs-keyword">if</span> (ttl != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">//此时使用pub/sub订阅这个管道</span>
        CompletableFuture&lt;RedissonLockEntry&gt; future = <span class="hljs-built_in">this</span>.subscribe(threadId);
        <span class="hljs-built_in">this</span>.pubSub.timeout(future);
        <span class="hljs-comment">//内部维护了一个Semaphore用于控制本地线程的阻塞和唤醒</span>
        RedissonLockEntry entry;
        <span class="hljs-keyword">if</span> (interruptibly) {
            entry = (RedissonLockEntry)<span class="hljs-built_in">this</span>.commandExecutor.getInterrupted(future);
        } <span class="hljs-keyword">else</span> {
            entry = (RedissonLockEntry)<span class="hljs-built_in">this</span>.commandExecutor.get(future);
        }
​
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">//死循环直到获取锁或者被中断</span>
            <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) {
                <span class="hljs-comment">//先乐观查询一次</span>
                ttl = <span class="hljs-built_in">this</span>.tryAcquire(-<span class="hljs-number">1L</span>, leaseTime, unit, threadId);
                <span class="hljs-keyword">if</span> (ttl == <span class="hljs-literal">null</span>) {
                    <span class="hljs-keyword">return</span>;
                }
               <span class="hljs-comment">//仍然没有获取到锁则进入阻塞阶段</span>
                <span class="hljs-keyword">if</span> (ttl &gt;= <span class="hljs-number">0L</span>) {
                    <span class="hljs-keyword">try</span> {
                        <span class="hljs-comment">//通过ttl时间判断锁还有多久释放，从而判断阻塞多久，避免cpu空转带来性能消耗，精准在锁释放时候唤醒</span>
                        <span class="hljs-comment">//当有人释放锁了,redisson监听到了之后调用entry.getLatch().release(),或者到达ttl了都会使线程被唤醒</span>
                        entry.getLatch().tryAcquire(ttl, TimeUnit.MILLISECONDS);
                    } <span class="hljs-keyword">catch</span> (InterruptedException var14) {
                        <span class="hljs-type">InterruptedException</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> var14;
                        <span class="hljs-keyword">if</span> (interruptibly) {
                            <span class="hljs-keyword">throw</span> e;
                        }
                        <span class="hljs-comment">//出现异常了，重新抢锁</span>
                        entry.getLatch().tryAcquire(ttl, TimeUnit.MILLISECONDS);
                    }
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (interruptibly) {
                    entry.getLatch().acquire();
                } <span class="hljs-keyword">else</span> {
                    entry.getLatch().acquireUninterruptibly();
                }
            }
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">//最后终止订阅。</span>
            <span class="hljs-built_in">this</span>.unsubscribe(entry, threadId);
        }
    }
}
</code></pre>
<p>解锁的逻辑：</p>
<p>跟加锁逻辑一样都是异步转换同步。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> RFuture&lt;Void&gt; <span class="hljs-title function_">unlockAsync</span><span class="hljs-params">(<span class="hljs-type">long</span> threadId)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">requestId</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getServiceManager().generateId();
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getServiceManager().execute(() -&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.unlockAsync0(threadId, requestId);
    });
}
​
<span class="hljs-keyword">private</span> RFuture&lt;Void&gt; <span class="hljs-title function_">unlockAsync0</span><span class="hljs-params">(<span class="hljs-type">long</span> threadId, String requestId)</span> {
    CompletionStage&lt;Boolean&gt; future = <span class="hljs-built_in">this</span>.unlockInnerAsync(threadId, requestId);
    <span class="hljs-comment">//处理异常</span>
    CompletionStage&lt;Void&gt; f = future.handle((res, e) -&gt; {
        <span class="hljs-built_in">this</span>.cancelExpirationRenewal(threadId, res);
        <span class="hljs-keyword">if</span> (e != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> CompletionException) {
                <span class="hljs-keyword">throw</span> (CompletionException)e;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletionException</span>(e);
            }
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (res == <span class="hljs-literal">null</span>) {
            <span class="hljs-type">IllegalMonitorStateException</span> <span class="hljs-variable">cause</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalMonitorStateException</span>(<span class="hljs-string">"attempt to unlock lock, not locked by current thread by node id: "</span> + <span class="hljs-built_in">this</span>.id + <span class="hljs-string">" thread-id: "</span> + threadId);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletionException</span>(cause);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    });
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletableFutureWrapper</span>(f);
}
​
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> RFuture&lt;Boolean&gt; <span class="hljs-title function_">unlockInnerAsync</span><span class="hljs-params">(<span class="hljs-type">long</span> threadId, String requestId)</span> {
    <span class="hljs-keyword">if</span> (requestId == <span class="hljs-literal">null</span>) {
        requestId = <span class="hljs-built_in">this</span>.getServiceManager().generateId();
    }
​
    <span class="hljs-type">MasterSlaveServersConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getServiceManager().getConfig();
    <span class="hljs-type">long</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> ((<span class="hljs-type">long</span>)config.getTimeout() + config.getRetryDelay().calcDelay(config.getRetryAttempts()).toMillis()) * (<span class="hljs-type">long</span>)config.getRetryAttempts();
    timeout = Math.max(timeout, <span class="hljs-number">1L</span>);
    <span class="hljs-comment">//异步释放锁</span>
    RFuture&lt;Boolean&gt; r = <span class="hljs-built_in">this</span>.unlockInnerAsync(threadId, requestId, (<span class="hljs-type">int</span>)timeout);
    CompletionStage&lt;Boolean&gt; ff = r.thenApply((v) -&gt; {
        <span class="hljs-type">CommandAsyncExecutor</span> <span class="hljs-variable">ce</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.commandExecutor;
        <span class="hljs-keyword">if</span> (ce <span class="hljs-keyword">instanceof</span> CommandBatchService) {
            ce = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandBatchService</span>(<span class="hljs-built_in">this</span>.commandExecutor);
        }
​
        ((CommandAsyncExecutor)ce).writeAsync(<span class="hljs-built_in">this</span>.getRawName(), LongCodec.INSTANCE, RedisCommands.DEL, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{<span class="hljs-built_in">this</span>.getUnlockLatchName(<span class="hljs-built_in">this</span>.id)});
        <span class="hljs-keyword">if</span> (ce <span class="hljs-keyword">instanceof</span> CommandBatchService) {
            ((CommandBatchService)ce).executeAsync();
        }
​
        <span class="hljs-keyword">return</span> v;
    });
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletableFutureWrapper</span>(ff);
}
​
<span class="hljs-keyword">protected</span> RFuture&lt;Boolean&gt; <span class="hljs-title function_">unlockInnerAsync</span><span class="hljs-params">(<span class="hljs-type">long</span> threadId, String requestId, <span class="hljs-type">int</span> timeout)</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.evalWriteSyncedNoRetryAsync(<span class="hljs-built_in">this</span>.getRawName(), LongCodec.INSTANCE, RedisCommands.EVAL_BOOLEAN,
<span class="hljs-comment">//防重检查（幂等性）</span>
<span class="hljs-string">"local val = redis.call('get', KEYS[3]);"</span>+
<span class="hljs-string">"if val ~= false then "</span>+
    <span class="hljs-string">"return tonumber(val);"</span>+
<span class="hljs-string">"end;"</span>+
<span class="hljs-comment">//判断是否持有锁</span>
<span class="hljs-string">"if (redis.call('hexists', KEYS[1], ARGV[3]) == 0) then "</span>+
    <span class="hljs-string">"return nil;"</span>+
<span class="hljs-string">"end; "</span>+
<span class="hljs-comment">//扣减重入次数</span>
<span class="hljs-string">"local counter = redis.call('hincrby', KEYS[1], ARGV[3], -1); "</span>+
<span class="hljs-comment">//判断是“重入释放”还是“彻底释放”</span>
<span class="hljs-string">"if (counter &gt; 0) then "</span>+
    <span class="hljs-comment">//重入次数减1</span>
    <span class="hljs-string">"redis.call('pexpire', KEYS[1], ARGV[2]); "</span>+
    <span class="hljs-string">"redis.call('set', KEYS[3], 0, 'px', ARGV[5]); "</span>+
<span class="hljs-string">"return 0; "</span>+
<span class="hljs-string">"else "</span>+
    <span class="hljs-comment">//彻底释放锁</span>
    <span class="hljs-string">"redis.call('del', KEYS[1]); "</span>+
    <span class="hljs-comment">//发送队列消息</span>
    <span class="hljs-string">"redis.call(ARGV[4], KEYS[2], ARGV[1]); "</span>+
    <span class="hljs-string">"redis.call('set', KEYS[3], 1, 'px', ARGV[5]); "</span>+
    <span class="hljs-string">"return 1; "</span>+
<span class="hljs-string">"end; "</span>,
Arrays.asList(<span class="hljs-built_in">this</span>.getRawName(), <span class="hljs-built_in">this</span>.getChannelName(), <span class="hljs-built_in">this</span>.getUnlockLatchName(requestId)), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{LockPubSub.UNLOCK_MESSAGE, <span class="hljs-built_in">this</span>.internalLockLeaseTime, <span class="hljs-built_in">this</span>.getLockName(threadId), <span class="hljs-built_in">this</span>.getSubscribeService().getPublishCommand(), timeout});
}
</code></pre>
<p>lua的流程为：</p>
<p>先去查一下 KEYS[3]（查看解锁请求的结果缓存）是否存在。如果存在，说明<strong>这个请求之前已经处理过了</strong>（可能是网络波动导致客户端以为超时了，重发了请求）。直接返回之前缓存的结果（0 或 1），不需要再执行后面的逻辑。这保证了<strong>幂等性</strong>。</p>
<ol start="0">
<li>检查 Hash KEYS[1] 中是否存在当前线程 ARGV[3]。如果不存在（== 0），说明当前线程根本没有持有这把锁。返回 nil（Java 客户端会抛出 IllegalMonitorStateException）。</li>
<li>将该线程的加锁计数器减 1，counter 是减完之后剩下的次数。</li>
<li>如果counter &gt; 0，说明锁重入了。pexpire：刷新锁的过期时间（看门狗时间），只要锁还没彻底释放，就得给它续命。set KEYS[3] 0：记录本次请求结果为 0（表示未完全释放）。返回 0，代表还未释放锁。</li>
<li>如果counter&lt;=0，说明锁此时可以释放了，这里会先删除这个锁对应的key，然后调用<code>redis.call(ARGV[4], KEYS[2], ARGV[1]);</code>这里ARGC[4]其实通常是publish发送消息，之所以不写死是因为集群下可以用spublish加快性能。这里发送消息是为了前文提到的，告诉监听者锁已经释放。set KEYS[3] 1：缓存本次请求结果为 1，并将1返回，代表锁成功释放了</li>
</ol>
<p>这里之所以要多出一个KEY[3]是为了<strong>做幂等</strong>。KEY[3]命名一般为{锁前缀}:{锁名}:{requestId}，每次请求时候都会带上不同的requestId，vlaue是requestId请求的解锁结果</p>
<p>存在一种可能，客户端重入了2次锁，客户端第一次调用unlock时候，redis正常执行了解锁逻辑，并扣减了1次锁记录，但是由于网络波动，响应丢失了，此时客户端会重新发起一次请求，导致重复扣减。为了解决这个问题，就利用key[3]，判断一下相同的请求id是否有记录如果是就代表确实发送了响应丢失，直接将上次的数据返回，避免重复解锁。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eedf6a2fdad34405a4e6a6423c17e22a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2lyNzYx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766822478&amp;x-signature=KTTnPGHIo7Up7jT%2F0NvTi7QGW1I%3D" alt="Redisson锁数据结构.drawio.png" loading="lazy"/></p>
<h3 data-id="heading-1">公平锁</h3>
<p>以上锁是默认非公平锁，所有线程都去争抢锁，而公平锁则是进入队列等待，防止饥饿问题。</p>
<p>当我们getFairLock时候其实是new了一个RedissonFairLock</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-title class_">RLock</span> <span class="hljs-title function_">getFairLock</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> name</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedissonFairLock</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">commandExecutor</span>, name);
}
</code></pre>
<p>RedissonFairLock继承自RedissonLock也就是说加锁的流程都是大致相同的。RedissonFairLock重写了tryLockInnerAsync方法</p>
<pre><code class="hljs language-ini" lang="ini">&lt;T&gt; RFuture&lt;T&gt; tryLockInnerAsync(long waitTime, long leaseTime, TimeUnit unit, long threadId, RedisStrictCommand&lt;T&gt; command) {
    long <span class="hljs-attr">wait</span> = this.threadWaitTime<span class="hljs-comment">;</span>
    if (waitTime &gt; 0L) {
        <span class="hljs-attr">wait</span> = unit.toMillis(waitTime)<span class="hljs-comment">;</span>
    }
​
    long <span class="hljs-attr">currentTime</span> = System.currentTimeMillis()<span class="hljs-comment">;</span>
    if (<span class="hljs-attr">command</span> == RedisCommands.EVAL_NULL_BOOLEAN) {
        return this.commandExecutor.syncedEvalNoRetry(
            this.getRawName(),
            LongCodec.INSTANCE,
            command,
            // Lua脚本 - 用于获取锁
            "while true do " +
            "    local <span class="hljs-attr">firstThreadId2</span> = redis.call(<span class="hljs-string">'lindex'</span>, KEYS[<span class="hljs-number">2</span>], <span class="hljs-number">0</span>)<span class="hljs-comment">; " +</span>
            "    if <span class="hljs-attr">firstThreadId2</span> == <span class="hljs-literal">false</span> then <span class="hljs-string">" +
            "</span>        break<span class="hljs-comment">; " +</span>
            "    end<span class="hljs-comment">; " +</span>
            "    local <span class="hljs-attr">timeout</span> = redis.call(<span class="hljs-string">'zscore'</span>, KEYS[<span class="hljs-number">3</span>], firstThreadId2)<span class="hljs-comment">; " +</span>
            "    if timeout ~= false and tonumber(timeout) &lt;= tonumber(ARGV<span class="hljs-section">[3]</span>) then " +
            "        redis.call('zrem', KEYS<span class="hljs-section">[3]</span>, firstThreadId2)<span class="hljs-comment">; " +</span>
            "        redis.call('lpop', KEYS<span class="hljs-section">[2]</span>)<span class="hljs-comment">; " +</span>
            "    else " +
            "        break<span class="hljs-comment">; " +</span>
            "    end<span class="hljs-comment">; " +</span>
            "end<span class="hljs-comment">; " +</span>
            "if (redis.call('exists', KEYS<span class="hljs-section">[1]</span>) == 0) and ((redis.call('exists', KEYS<span class="hljs-section">[2]</span>) == 0) or (redis.call('lindex', KEYS<span class="hljs-section">[2]</span>, 0) == ARGV<span class="hljs-section">[2]</span>)) then " +
            "    redis.call('lpop', KEYS<span class="hljs-section">[2]</span>)<span class="hljs-comment">; " +</span>
            "    redis.call('zrem', KEYS<span class="hljs-section">[3]</span>, ARGV<span class="hljs-section">[2]</span>)<span class="hljs-comment">; " +</span>
            "    local <span class="hljs-attr">keys</span> = redis.call(<span class="hljs-string">'zrange'</span>, KEYS[<span class="hljs-number">3</span>], <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>)<span class="hljs-comment">; " +</span>
            "    for <span class="hljs-attr">i</span> = <span class="hljs-number">1</span>, <span class="hljs-comment">#keys, 1 do " +</span>
            "        redis.call('zincrby', KEYS<span class="hljs-section">[3]</span>, -tonumber(ARGV<span class="hljs-section">[4]</span>), keys<span class="hljs-section">[i]</span>)<span class="hljs-comment">; " +</span>
            "    end<span class="hljs-comment">; " +</span>
            "    redis.call('hset', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[2]</span>, 1)<span class="hljs-comment">; " +</span>
            "    redis.call('pexpire', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[1]</span>)<span class="hljs-comment">; " +</span>
            "    return nil<span class="hljs-comment">; " +</span>
            "end<span class="hljs-comment">; " +</span>
            "if (redis.call('hexists', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[2]</span>) == 1) then " +
            "    redis.call('hincrby', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[2]</span>, 1)<span class="hljs-comment">; " +</span>
            "    redis.call('pexpire', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[1]</span>)<span class="hljs-comment">; " +</span>
            "    return nil<span class="hljs-comment">; " +</span>
            "end<span class="hljs-comment">; " +</span>
            "return 1<span class="hljs-comment">;",</span>
            Arrays.asList(this.getRawName(), this.threadsQueueName, this.timeoutSetName),
            new Object<span class="hljs-section">[]</span>{unit.toMillis(leaseTime), this.getLockName(threadId), currentTime, wait}
        )<span class="hljs-comment">;</span>
    } else if (<span class="hljs-attr">command</span> == RedisCommands.EVAL_LONG) {
        return this.commandExecutor.syncedEvalNoRetry(
            this.getRawName(),
            LongCodec.INSTANCE,
            command,
            // Lua脚本 - 用于尝试获取锁并返回TTL
            "while true do " +
            "    local <span class="hljs-attr">firstThreadId2</span> = redis.call(<span class="hljs-string">'lindex'</span>, KEYS[<span class="hljs-number">2</span>], <span class="hljs-number">0</span>)<span class="hljs-comment">; " +</span>
            "    if <span class="hljs-attr">firstThreadId2</span> == <span class="hljs-literal">false</span> then <span class="hljs-string">" +
            "</span>        break<span class="hljs-comment">; " +</span>
            "    end<span class="hljs-comment">; " +</span>
            "    local <span class="hljs-attr">timeout</span> = redis.call(<span class="hljs-string">'zscore'</span>, KEYS[<span class="hljs-number">3</span>], firstThreadId2)<span class="hljs-comment">; " +</span>
            "    if timeout ~= false and tonumber(timeout) &lt;= tonumber(ARGV<span class="hljs-section">[4]</span>) then " +
            "        redis.call('zrem', KEYS<span class="hljs-section">[3]</span>, firstThreadId2)<span class="hljs-comment">; " +</span>
            "        redis.call('lpop', KEYS<span class="hljs-section">[2]</span>)<span class="hljs-comment">; " +</span>
            "    else " +
            "        break<span class="hljs-comment">; " +</span>
            "    end<span class="hljs-comment">; " +</span>
            "end<span class="hljs-comment">; " +</span>
            "if (redis.call('exists', KEYS<span class="hljs-section">[1]</span>) == 0) and ((redis.call('exists', KEYS<span class="hljs-section">[2]</span>) == 0) or (redis.call('lindex', KEYS<span class="hljs-section">[2]</span>, 0) == ARGV<span class="hljs-section">[2]</span>)) then " +
            "    redis.call('lpop', KEYS<span class="hljs-section">[2]</span>)<span class="hljs-comment">; " +</span>
            "    redis.call('zrem', KEYS<span class="hljs-section">[3]</span>, ARGV<span class="hljs-section">[2]</span>)<span class="hljs-comment">; " +</span>
            "    local <span class="hljs-attr">keys</span> = redis.call(<span class="hljs-string">'zrange'</span>, KEYS[<span class="hljs-number">3</span>], <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>)<span class="hljs-comment">; " +</span>
            "    for <span class="hljs-attr">i</span> = <span class="hljs-number">1</span>, <span class="hljs-comment">#keys, 1 do " +</span>
            "        redis.call('zincrby', KEYS<span class="hljs-section">[3]</span>, -tonumber(ARGV<span class="hljs-section">[3]</span>), keys<span class="hljs-section">[i]</span>)<span class="hljs-comment">; " +</span>
            "    end<span class="hljs-comment">; " +</span>
            "    redis.call('hset', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[2]</span>, 1)<span class="hljs-comment">; " +</span>
            "    redis.call('pexpire', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[1]</span>)<span class="hljs-comment">; " +</span>
            "    return nil<span class="hljs-comment">; " +</span>
            "end<span class="hljs-comment">; " +</span>
            "if redis.call('hexists', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[2]</span>) == 1 then " +
            "    redis.call('hincrby', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[2]</span>, 1)<span class="hljs-comment">; " +</span>
            "    redis.call('pexpire', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[1]</span>)<span class="hljs-comment">; " +</span>
            "    return nil<span class="hljs-comment">; " +</span>
            "end<span class="hljs-comment">; " +</span>
            "local <span class="hljs-attr">timeout</span> = redis.call(<span class="hljs-string">'zscore'</span>, KEYS[<span class="hljs-number">3</span>], ARGV[<span class="hljs-number">2</span>])<span class="hljs-comment">; " +</span>
            "if timeout ~= false then " +
            "    local <span class="hljs-attr">ttl</span> = redis.call(<span class="hljs-string">'pttl'</span>, KEYS[<span class="hljs-number">1</span>])<span class="hljs-comment">; " +</span>
            "    return math.max(0, ttl)<span class="hljs-comment">; " +</span>
            "end<span class="hljs-comment">; " +</span>
            "local <span class="hljs-attr">lastThreadId</span> = redis.call(<span class="hljs-string">'lindex'</span>, KEYS[<span class="hljs-number">2</span>], -<span class="hljs-number">1</span>)<span class="hljs-comment">; " +</span>
            "local ttl<span class="hljs-comment">; " +</span>
            "if lastThreadId ~= false and lastThreadId ~= ARGV<span class="hljs-section">[2]</span> and redis.call('zscore', KEYS<span class="hljs-section">[3]</span>, lastThreadId) ~= false then " +
            "    <span class="hljs-attr">ttl</span> = tonumber(redis.call(<span class="hljs-string">'zscore'</span>, KEYS[<span class="hljs-number">3</span>], lastThreadId)) - tonumber(ARGV[<span class="hljs-number">4</span>])<span class="hljs-comment">; " +</span>
            "else " +
            "    <span class="hljs-attr">ttl</span> = redis.call(<span class="hljs-string">'pttl'</span>, KEYS[<span class="hljs-number">1</span>])<span class="hljs-comment">; " +</span>
            "end<span class="hljs-comment">; " +</span>
            "local <span class="hljs-attr">timeout</span> = ttl + tonumber(ARGV[<span class="hljs-number">3</span>]) + tonumber(ARGV[<span class="hljs-number">4</span>])<span class="hljs-comment">; " +</span>
            "if redis.call('zadd', KEYS<span class="hljs-section">[3]</span>, timeout, ARGV<span class="hljs-section">[2]</span>) == 1 then " +
            "    redis.call('rpush', KEYS<span class="hljs-section">[2]</span>, ARGV<span class="hljs-section">[2]</span>)<span class="hljs-comment">; " +</span>
            "end<span class="hljs-comment">; " +</span>
            "return ttl<span class="hljs-comment">;",</span>
            Arrays.asList(this.getRawName(), this.threadsQueueName, this.timeoutSetName),
            new Object<span class="hljs-section">[]</span>{unit.toMillis(leaseTime), this.getLockName(threadId), wait, currentTime}
        )<span class="hljs-comment">;</span>
    } else {
        throw new IllegalArgumentException()<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p>这里有俩段lua脚本，第一段对应的是无参的tryLock（）方法，进行一次快速尝试，如果获取不到锁直接返回。第二段对应的是tryLock(waitTime)/lock这俩个阻塞等锁的方法。这里我们重点看第二段lua脚本，第一个lua脚本和第二个类似：</p>
<pre><code class="hljs language-java" lang="java">--循环的判断是否有waitTime已经超过的节点，如果有就剔除掉，防止占用着队列
<span class="hljs-keyword">while</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">do</span> 
    --查询等待队列头节点是什么
    <span class="hljs-type">local</span> <span class="hljs-variable">firstThreadId2</span> <span class="hljs-operator">=</span> redis.call(<span class="hljs-string">'lindex'</span>, KEYS[<span class="hljs-number">2</span>], <span class="hljs-number">0</span>); 
    --如果等待队列为空则跳出循环
    <span class="hljs-keyword">if</span> firstThreadId2 == <span class="hljs-literal">false</span> then 
        <span class="hljs-keyword">break</span>; 
    end; 
    --不为空，判断一下是否超过了超时时间，如果是就删除掉，没有就跳出循环
    <span class="hljs-type">local</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> redis.call(<span class="hljs-string">'zscore'</span>, KEYS[<span class="hljs-number">3</span>], firstThreadId2); 
    <span class="hljs-keyword">if</span> timeout ~= <span class="hljs-literal">false</span> and <span class="hljs-title function_">tonumber</span><span class="hljs-params">(timeout)</span> &lt;= tonumber(ARGV[<span class="hljs-number">4</span>]) then 
        redis.call(<span class="hljs-string">'zrem'</span>, KEYS[<span class="hljs-number">3</span>], firstThreadId2); 
        redis.call(<span class="hljs-string">'lpop'</span>, KEYS[<span class="hljs-number">2</span>]); 
    <span class="hljs-keyword">else</span> 
        <span class="hljs-keyword">break</span>; 
    end; 
end; 
--判断一下锁是否没有被其他线程持有并且等待队列不存在（等待队列为空）或者对头是此线程，如果是则进入抢锁。
<span class="hljs-keyword">if</span> (redis.call(<span class="hljs-string">'exists'</span>, KEYS[<span class="hljs-number">1</span>]) == <span class="hljs-number">0</span>) and ((redis.call(<span class="hljs-string">'exists'</span>, KEYS[<span class="hljs-number">2</span>]) == <span class="hljs-number">0</span>) or (redis.call(<span class="hljs-string">'lindex'</span>, KEYS[<span class="hljs-number">2</span>], <span class="hljs-number">0</span>) == ARGV[<span class="hljs-number">2</span>])) then 
    --将自己从队列移除
    redis.call(<span class="hljs-string">'lpop'</span>, KEYS[<span class="hljs-number">2</span>]); 
    redis.call(<span class="hljs-string">'zrem'</span>, KEYS[<span class="hljs-number">3</span>], ARGV[<span class="hljs-number">2</span>]); 
    <span class="hljs-type">local</span> <span class="hljs-variable">keys</span> <span class="hljs-operator">=</span> redis.call(<span class="hljs-string">'zrange'</span>, KEYS[<span class="hljs-number">3</span>], <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>); 
    --循环整个队列，更新所有节点的超时时间（减少等待预算）
    <span class="hljs-type">for</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>, #keys, <span class="hljs-number">1</span> <span class="hljs-keyword">do</span> 
        redis.call(<span class="hljs-string">'zincrby'</span>, KEYS[<span class="hljs-number">3</span>], -tonumber(ARGV[<span class="hljs-number">3</span>]), keys[i]); 
    end; 
    --真正的加锁逻辑，加锁后直接返回。
    redis.call(<span class="hljs-string">'hset'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">2</span>], <span class="hljs-number">1</span>); 
    redis.call(<span class="hljs-string">'pexpire'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">1</span>]); 
    --返回nil说明抢锁成功
    <span class="hljs-keyword">return</span> nil; 
end; 
--前面判断为<span class="hljs-literal">false</span>，说明锁被持有了，判断一下锁是否被本线程持有，如果是重入加<span class="hljs-number">1</span>并返回
<span class="hljs-keyword">if</span> redis.call(<span class="hljs-string">'hexists'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">2</span>]) == <span class="hljs-number">1</span> then 
    redis.call(<span class="hljs-string">'hincrby'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">2</span>], <span class="hljs-number">1</span>); 
    redis.call(<span class="hljs-string">'pexpire'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">1</span>]); 
    <span class="hljs-keyword">return</span> nil; 
end; 
--走到这里说明锁被其他人持有了，此时判断一下本线程是否已经在排队了
<span class="hljs-type">local</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> redis.call(<span class="hljs-string">'zscore'</span>, KEYS[<span class="hljs-number">3</span>], ARGV[<span class="hljs-number">2</span>]); 
<span class="hljs-keyword">if</span> timeout ~= <span class="hljs-literal">false</span> then 
    --如果在排队了，则返回锁的剩余持有时间
    <span class="hljs-type">local</span> <span class="hljs-variable">ttl</span> <span class="hljs-operator">=</span> redis.call(<span class="hljs-string">'pttl'</span>, KEYS[<span class="hljs-number">1</span>]); 
    <span class="hljs-keyword">return</span> math.max(<span class="hljs-number">0</span>, ttl); 
end; 
--走到这里说明没有入队，先查看一下队尾节点
<span class="hljs-type">local</span> <span class="hljs-variable">lastThreadId</span> <span class="hljs-operator">=</span> redis.call(<span class="hljs-string">'lindex'</span>, KEYS[<span class="hljs-number">2</span>], -<span class="hljs-number">1</span>); 
local ttl; 
--如果队尾节点存在（锁被持有，有线程等待抢锁）则ttl是钱一个人的超时时间-当前时间。
<span class="hljs-keyword">if</span> lastThreadId ~= <span class="hljs-literal">false</span> and lastThreadId ~= ARGV[<span class="hljs-number">2</span>] and redis.call(<span class="hljs-string">'zscore'</span>, KEYS[<span class="hljs-number">3</span>], lastThreadId) ~= <span class="hljs-literal">false</span> <span class="hljs-type">then</span> 
    <span class="hljs-variable">ttl</span> <span class="hljs-operator">=</span> tonumber(redis.call(<span class="hljs-string">'zscore'</span>, KEYS[<span class="hljs-number">3</span>], lastThreadId)) - tonumber(ARGV[<span class="hljs-number">4</span>]); 
<span class="hljs-keyword">else</span> 
    --如果队尾节点不存在（锁被持有，且没有线程等待抢锁）则ttl就是锁的过期时间
    ttl = redis.call(<span class="hljs-string">'pttl'</span>, KEYS[<span class="hljs-number">1</span>]); 
end; 
<span class="hljs-type">local</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> ttl + tonumber(ARGV[<span class="hljs-number">3</span>]) + tonumber(ARGV[<span class="hljs-number">4</span>]); 
--然后入队，将计算好的超时时间放入Zset，并将本线程放入队尾。
<span class="hljs-keyword">if</span> redis.call(<span class="hljs-string">'zadd'</span>, KEYS[<span class="hljs-number">3</span>], timeout, ARGV[<span class="hljs-number">2</span>]) == <span class="hljs-number">1</span> then 
    redis.call(<span class="hljs-string">'rpush'</span>, KEYS[<span class="hljs-number">2</span>], ARGV[<span class="hljs-number">2</span>]); 
end; 
--返回告诉客户端，还需要时间为ttl，使用Semaphore去阻塞。（唤醒过程和前文提到过的一样）
<span class="hljs-keyword">return</span> ttl;
</code></pre>
<p>此过程中用到了Zset，List，我们直到List用于存放资源争抢者，那Zset又是干嘛的？</p>
<p>List 虽然能完美实现 FIFO（先进先出），但它有2个致命弱点：</p>
<ul>
<li><strong>不好判断过期时间</strong>：List 只能告诉你谁排第一，但不能告诉你他还是不是活的（有没有超时），如果非要利用List存储过期时间就得通过value去分割，不仅需要占用cpu资源而且不好判断如何分割，万一用户命名不规范导致分割错误，此时需要Zset，它存储了每个人的“死亡时间”，用来在每次操作前清理 List 里的僵尸节点。member是uuid+线程id，score是过期时间</li>
<li><strong>不好判断是否当前线程在队列中</strong>：List需要O(n)判断，时间慢，通过Zset的dict数据结构O(1)判断。</li>
</ul>
<p>此外，由于每一个节点有可能是lock（）这种无等待时间，会阻塞到一直获取锁，在Zset中难道我们要将Zset的过期分数设置很大或者设置为-1代表没有过期时间吗？那如果客户端宕机了，该节点不就占用这个Zset和list的节点，且谁也清除不掉，导致内存泄露。且轮到它作为头节点时候，又不会抢锁，导致全部都在死等。</p>
<p>旧版本的redisson是默认给5秒过期时间，每次5秒后就刷新一下，如果客户端宕机了就不会刷新，这个节点会被清除掉。但是当竞争激烈的时候5秒获取不到锁时候大量的线程醒过来同时去更新过期时间，这个惊群效应会导致性能急剧下降，后续新版本改为了5分钟。</p>
<p>如图，比起非公平锁多了俩个数据结构</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fcdc19af5dd40fcb4c907beb88fa65c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2lyNzYx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766822478&amp;x-signature=fCOelRfQZtVqpd7k%2FW%2BCSTzULqE%3D" alt="分布式公平锁获取过程.drawio.png" loading="lazy"/></p>
<p>若有错误欢迎指出，将及时改正。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kibana：使用 ES|QL 构建地图，对国家或地区的指标进行对比]]></title>    <link>https://juejin.cn/post/7585474459776335908</link>    <guid>https://juejin.cn/post/7585474459776335908</guid>    <pubDate>2025-12-20T08:22:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585474459776335908" data-draft-id="7585474459776319524" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kibana：使用 ES|QL 构建地图，对国家或地区的指标进行对比"/> <meta itemprop="keywords" content="Elasticsearch"/> <meta itemprop="datePublished" content="2025-12-20T08:22:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Elasticsearch"/> <meta itemprop="url" content="https://juejin.cn/user/2612095360441448"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kibana：使用 ES|QL 构建地图，对国家或地区的指标进行对比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612095360441448/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Elasticsearch
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:22:04.000Z" title="Sat Dec 20 2025 08:22:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：来自 Elastic <a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscuss.elastic.co%2Fu%2Fnathan_reese" title="https://discuss.elastic.co/u/nathan_reese" target="_blank" ref="nofollow noopener noreferrer">Nathan_Reese</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/856719b33e094553a77f3f6a06f3920a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=sIwkFyIrQn5FbGU4%2Ful7xVJkdLg%3D" alt="" loading="lazy"/></p>
<p>Kibana 地图 教程 “<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fguide%2Fen%2Fkibana%2F8.19%2Fmaps-getting-started.html" title="https://www.elastic.co/guide/en/kibana/8.19/maps-getting-started.html" target="_blank" ref="nofollow noopener noreferrer">构建地图，用于按国家或地区对比指标</a>” 使用 Elasticsearch 的 DSL 查询 来创建地图。最近新增的 ES|QL 函数 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Fcommands%2Flookup-join" title="https://www.elastic.co/docs/reference/query-languages/esql/commands/lookup-join" target="_blank" ref="nofollow noopener noreferrer">LOOKUP JOIN</a>（ 8.18 ）和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Ffunctions-operators%2Fspatial-functions%23esql-st_geotile" title="https://www.elastic.co/docs/reference/query-languages/esql/functions-operators/spatial-functions#esql-st_geotile" target="_blank" ref="nofollow noopener noreferrer">ST_GEOTILE</a>（ 9.2 ）使得可以使用 ES|QL 重新创建该教程中的地图。</p>
<p>下面是使用 ES|QL 重新创建该教程地图的步骤。随后，这些步骤还超出了原始教程的能力范围，并按国家人口对分级设色图层进行归一化处理。</p>
<h2 data-id="heading-0">前提条件</h2>
<ul>
<li>如果你还没有 Kibana，请使用我们的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fcloud%2Felasticsearch-service%2Fsignup%3Fbaymax%3Ddocs-body%26elektra%3Ddocs" title="https://www.elastic.co/cloud/elasticsearch-service/signup?baymax=docs-body&amp;elektra=docs" target="_blank" ref="nofollow noopener noreferrer">免费试用</a> 进行设置。</li>
<li>本教程需要 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fguide%2Fen%2Fkibana%2F8.19%2Fget-started.html" title="https://www.elastic.co/guide/en/kibana/8.19/get-started.html" target="_blank" ref="nofollow noopener noreferrer">web logs 示例数据集</a>。</li>
<li>你必须具备创建地图和创建索引的正确权限。</li>
<li><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ee18d03841d4a7b96cdced29f035bb0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=6L9%2BwGiBlMHJT3I5WumIGOqBYNM%3D" alt="" loading="lazy"/></li>
</ul>
<h2 data-id="heading-1">步骤 1：创建 地图</h2>
<ul>
<li>前往 Dashboards。</li>
<li>点击 Create dashboard。</li>
<li>将时间范围设置为 Last 7 days。</li>
<li>点击 Add 按钮并选择 New panel，最后点击 Maps。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75fc5d68a38a40f792bc5d21960ce2fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=mJiW3kgJ8oYBKljJb4IvqZq81ls%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/299c6ca01e7841c8b6e1531d07ad0624~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=scm067o%2BWSNTSko5PB19C0sNp5Y%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fdad565309644328b1aaf0a42913a686~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=PtY7x5OTT9xrruWB1E2nPc8dI6I%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6bf44c4e950944ca850b10893148010d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=lw1aRSNzzIR4M%2FTiDrYGyyi4L3I%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77d62ab1b5054e3c8e88a8af9ef37d81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=nkla1tjbPRClZk0W0d0D4OzLjvI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c59530e10ed7425189a9495e511ae321~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=Ff2hpwV1S%2FqsEW9kp%2BWcWaYKlyA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">步骤 2. 添加一个 choropleth 图层</h2>
<p>你将添加的第一个图层是一个 choropleth 图层，用于按 web 日志流量为世界各国着色。较深的颜色表示 web 日志流量较多的国家，较浅的颜色表示流量较少的国家。</p>
<h3 data-id="heading-3">索引世界国家</h3>
<ul>
<li>下载<a href="https://link.juejin.cn?target=https%3A%2F%2Fmaps.elastic.co%2F%23file%2Fworld_countries" title="https://maps.elastic.co/#file/world_countries" target="_blank" ref="nofollow noopener noreferrer">世界国家 GeoJSON</a> 文件</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfefe39ae1fd487aa0309dddf21cd827~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=eACxlm%2BKon4ew2isg3ZK3iirlJw%3D" alt="" loading="lazy"/></p>
<ul>
<li>在 Kibana maps 中，点击 Add layer</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6248b5f4f086401e9d30e61074397de2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=1PagyFqjZttoljj5MD9LPscOGsw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/920a2f78b8384cf8b662807c1b109b30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=%2BbCKB6%2FzjuUt5rIvcVSHa4%2BnWGc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2521840315d547edb220d8935431def9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=Zl4BlgIF%2F0OOIPL0i6Ld6kN6U5M%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3077a8304ea04d90a34dcae0b504e448~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=mp%2BmwWXkFNUkH%2FNE%2FiBrxviIURM%3D" alt="" loading="lazy"/></p>
<ul>
<li>选择 Upload file</li>
<li>在文件选择器中选择世界国家 GeoJSON 文件</li>
<li>将 Index name 设置为 world_countries</li>
<li>打开 Advanced 部分</li>
<li>将 Index settings 设置为 { "index.mode": "lookup" }。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af35066cef874968a8f2ad7341c735bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=HzesTFW6kVSrmxME6gU7qTWCows%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">添加 choropleth 图层</h3>
<ul>
<li>点击 Add layer</li>
<li>选择 ES|QL</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0edb88e6558f4c88852224e928da565f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=6a5vS%2Bc2eTHqlcillFK5yzGRL7A%3D" alt="" loading="lazy"/></p>
<ul>
<li>将 ES|QL statement 设置为</li>
</ul>

<pre><code class="hljs language-vbnet" lang="vbnet">`

<span class="hljs-number">1</span>.  <span class="hljs-keyword">FROM</span> kibana_sample_data_logs 
<span class="hljs-number">2</span>.  | STATS count = COUNT() <span class="hljs-keyword">BY</span> geo.dest 
<span class="hljs-number">3</span>.  | RENAME geo.dest <span class="hljs-keyword">AS</span> iso2.keyword 
<span class="hljs-number">4</span>.  | LOOKUP <span class="hljs-keyword">JOIN</span> world_countries <span class="hljs-keyword">ON</span> iso2.keyword 
<span class="hljs-number">5</span>.  | RENAME iso2.keyword <span class="hljs-keyword">AS</span> geo.dest 
<span class="hljs-number">6</span>.  | KEEP count, geometry, geo.dest

`AI写代码
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2412b1d2aa71444a9fe534fd845acb2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=3ZPwYpEy%2BYvjLfGovf6N8EaRIv0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1cf38ada7d0845a5ba800dbe73770a4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=OC6es0DwoXsYv4FNwA1XpZUzQqY%3D" alt="" loading="lazy"/></p>
<ul>
<li>点击 Add and continue</li>
<li>在 Layer settings 中，设置：
<ul>
<li>将 Name 设置为 Total Requests by Destination。</li>
<li>将 Opacity 设置为 50%。</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/efe3b047e63e48edb6d1ea0fe2ad2d4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=v9G2LV%2FfNUpVGK7PEYlowcM4eBY%3D" alt="" loading="lazy"/></p>
<ul>
<li>在 Layer style 中
<ul>
<li>将 Fill color 设置为 By value by count。选择 “grey to black” 颜色渐变。</li>
<li>将 Border color 设置为 “white”。4.</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cc5319e4c22433494754567f7f74405~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=YUzd07oNYRMnCTSqkJaV%2F%2FSTvv4%3D" alt="" loading="lazy"/></p>
<ul>
<li>点击 Keep changes。你的地图现在应该看起来像</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fce6da60d5fe4a64802c857e2a2d6112~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=12N4r%2FY7slCp05qi3N%2FK5r1b9Pg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">步骤 3. 为 Elasticsearch 数据添加图层</h2>
<p>为了避免一次向用户展示过多数据，你将为 Elasticsearch 数据添加两个图层。第一个图层在用户放大地图时显示单个文档。第二个图层在用户缩小地图时显示聚合数据。</p>
<h3 data-id="heading-6">为单个文档添加图层</h3>
<p>此图层将 web 日志文档显示为点。<br/>
该图层仅在用户放大时可见。</p>
<ul>
<li>点击 Add layer</li>
<li>选择 ES|QL</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7195fa36fd744d3f9855a4cfabb3d640~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=gCo1jOY35J0wBj%2F0qorOOgWXYEg%3D" alt="" loading="lazy"/></p>
<ul>
<li>将 ES|QL statement 设置为</li>
</ul>

<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> kibana_sample_data_logs 
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> KEEP geo.coordinates, agent, bytes, clientip, 
<span class="hljs-number">3.</span>         host, machine.os, request, response, <span class="hljs-type">timestamp</span> 
<span class="hljs-number">4.</span>  <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">10000</span>

`AI写代码
</code></pre>
<ul>
<li>在 ES|QL 编辑器中点击 Run query</li>
<li>点击 Add and continue</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/730d8242b0514cb289a6009e5edb2f45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=IAa4srQhlXSDFk3eyMxnM4nDgSg%3D" alt="" loading="lazy"/></p>
<ul>
<li>在 Layer settings 中，设置：
<ul>
<li>将 Name 设置为 Actual Requests。</li>
<li>将 Visibility 设置为范围 [9, 24]。</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a28785535c8a4fe0b901ed166e835728~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=xnY1P%2BvT0tWOUUKOA3qxCy1F7KQ%3D" alt="" loading="lazy"/></p>
<ul>
<li>在 Layer style 中，设置：
<ul>
<li>将 Fill color 设置为 #2200FF。</li>
<li>将 Border width 设置为 0。</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c07660b51c74440f857eebcc605b9587~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=h578EnyVh%2FZ%2BDvoqvQreP4Q%2BsZc%3D" alt="" loading="lazy"/></p>
<ul>
<li>点击 Keep changes。你的地图现在应该看起来像</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff4d39c9221d44e1937a90308283b291~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=Dndj%2B%2F0T6IvXTXHZviJj8%2B2liSE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">为聚合数据添加图层</h3>
<p>你将创建一个聚合数据图层，并仅在地图缩小时显示。较深的颜色表示 web 日志流量更多的网格，较浅的颜色表示流量较少的网格。较大的圆表示传输总字节更多的网格，较小的圆表示字节较少的网格。</p>
<ul>
<li>点击 Add layer</li>
<li>选择 ES|QL</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26353c3fa7834282888e2f26d36aec0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=hQR3rEIMLEI%2B%2Fc8HzcqE6AB1CcI%3D" alt="" loading="lazy"/></p>
<ul>
<li>将 ES|QL statement 设置为</li>
</ul>

<pre><code class="hljs language-ini" lang="ini">`

1.  FROM kibana_sample_data_logs  
2.  | EVAL <span class="hljs-attr">geotile</span> = ST_GEOTILE(geo.coordinates, <span class="hljs-number">6</span>) 
3.  | STATS <span class="hljs-attr">count</span> = COUNT(geotile), 
<span class="hljs-attr">4.          sumOfBytes</span> = SUM(bytes), 
<span class="hljs-attr">5.          centroid</span> = ST_CENTROID_AGG(geo.coordinates) BY geotile

`AI写代码
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63cbfb4a468c4d9abb7b2c0a87b50320~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=tdOEyoqo1YDlLEb0j2xE4do33WE%3D" alt="" loading="lazy"/></p>
<ul>
<li>在 ES|QL 编辑器中点击 Run query</li>
<li>点击 Add 并继续</li>
<li>在 Layer settings 中，设置：
<ul>
<li>将 Name 设置为 Total Requests and Bytes。</li>
<li>将 Visibility 设置为范围 [0, 9]。</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8adbe05ff81480795b4230f56b6ccb6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=WzfyNO%2FWRy9KFKGGdTFvd1fJPrM%3D" alt="" loading="lazy"/></p>
<ul>
<li>在 Layer style 中，设置：
<ul>
<li>将 Fill color 设置为 By value by count</li>
<li>将 Border width 设置为 0。</li>
<li>将 Symbol size 设置为 By value by sumOfBytes。将最小尺寸设置为 7，最大尺寸设置为 25。</li>
<li>将 Label 设置为 By value by count</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1d9989a1d94426993b7a16386386185~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=nHcJDNQlFi7P%2F37bsJfSi7MIkSM%3D" alt="" loading="lazy"/></p>
<ul>
<li>点击 Keep changes。你的地图现在应该看起来像</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c273d329e9454d77883ac49f767a6d30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=MRF3qen00nX22RKWkyljk9T4jDs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">步骤 4. 按国家人口标准化 choropleth 图层</h2>
<p>第 2 步创建的 choropleth 图层按 web 日志流量为世界各国着色。由于各国人口不同，直接比较各国的计数并不公平。人口较多的国家可能有更多的 web 流量，而人口较少的国家流量较少。相反，你希望按人口调整后的 web 日志流量为世界各国着色。</p>
<p>ES|QL 可以通过考虑每个国家的总人口来对 web 日志计数进行标准化。我们将可视化每 100,000 人的 web 日志计数，而不是原始计数。现在，我们可以比较各国的标准化计数。</p>
<h3 data-id="heading-9">索引世界国家人口</h3>
<ul>
<li>下载 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnreese%2Fnotes%2Fraw%2Frefs%2Fheads%2Fmaster%2Fpopulations_2024.csv" title="https://github.com/nreese/notes/raw/refs/heads/master/populations_2024.csv" target="_blank" ref="nofollow noopener noreferrer">populations_2024.csv</a>文件。该文件来源于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdata.worldbank.org%2Findicator%2FSP.POP.TOTL" title="https://data.worldbank.org/indicator/SP.POP.TOTL" target="_blank" ref="nofollow noopener noreferrer">World Bank Group</a>。 下载完毕后，我们必须重新命名文件后缀为 .csv 而不是 .txt。</li>
<li>在 Kibana 中，通过全局搜索字段进入 File upload。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9427dce25b2d40b19f23333325109477~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=%2BP%2BpcFz4ng8SyOshN81%2FchfaYb8%3D" alt="" loading="lazy"/></p>
<ul>
<li>在文件选择器中选择 populations_2024.csv</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbbce9d5ad5b44ac99a3384511c1f9d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=6sZSjkloapPqJNPnUNct35TZXns%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d887ff51a0748e0918add6e011f0ad9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=9D%2BXR09h0e10Ujy40zE2pZ1lNDs%3D" alt="" loading="lazy"/></p>
<ul>
<li>将 New index name 设置为 populations</li>
<li>点击 Import</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d0645d5615f44ae8348b930b15be4d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=set59wxYd4DcSCXa8dEOARYIEw8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">向 world_countries 索引添加人口字段</h3>
<p>使用 enrich processor 将人口数据添加到世界国家集合中。</p>
<ul>
<li>通过导航菜单或全局搜索字段进入 Developer tools。</li>
<li>创建一个 match enrichment policy</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">`

1.  PUT /_enrich/policy/population_lookup
2.  {
3.    <span class="hljs-string">"match"</span>: {
4.      <span class="hljs-string">"indices"</span>: <span class="hljs-string">"populations"</span>,
5.      <span class="hljs-string">"match_field"</span>: <span class="hljs-string">"iso3"</span>,
6.      <span class="hljs-string">"enrich_fields"</span>: [ <span class="hljs-string">"population_2024"</span>]
7.    }
8.  }

`AI写代码
</code></pre>
<ul>
<li>要初始化该策略，运行：</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">`POST /_enrich/policy/population_lookup/_execute`AI写代码
</code></pre>
<ul>
<li>要创建一个 ingest pipeline，运行：</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">`

1.  PUT _ingest/pipeline/add_population_to_world_countries
2.  {
3.    <span class="hljs-string">"processors"</span>: [
4.      {
5.        <span class="hljs-string">"enrich"</span>: {
6.          <span class="hljs-string">"field"</span>: <span class="hljs-string">"iso3"</span>,
7.          <span class="hljs-string">"policy_name"</span>: <span class="hljs-string">"population_lookup"</span>,
8.          <span class="hljs-string">"target_field"</span>: <span class="hljs-string">"population"</span>,
9.          <span class="hljs-string">"ignore_missing"</span>: <span class="hljs-literal">true</span>,
10.          <span class="hljs-string">"ignore_failure"</span>: <span class="hljs-literal">true</span>
11.        }
12.      }
13.    ]
14.  }

`AI写代码![](https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<ul>
<li>要向 world_countries 添加人口数据，运行：</li>
</ul>

<pre><code class="hljs language-ini" lang="ini">`POST world_countries/_update_by_query?<span class="hljs-attr">pipeline</span>=add_population_to_world_countries`AI写代码
</code></pre>
<ul>
<li>在 Discover 中查看 world_countries 索引。每一行现在都包含 population.population_2024 列。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7a16b1b69204dffb9ac4dcb4a15e6d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=93zdsqE99lKpjSnBXp4yIFDaQEg%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">在 ES|QL statement 中按人口标准化计数</h3>
<ul>
<li>点击 Total Requests by Destination 图层的 edit 按钮。</li>
<li>将 ES|QL statement 替换为</li>
</ul>

<pre><code class="hljs language-vbnet" lang="vbnet">`

<span class="hljs-number">1</span>.  <span class="hljs-keyword">FROM</span> kibana_sample_data_logs 
<span class="hljs-number">2</span>.  | STATS count = COUNT() <span class="hljs-keyword">BY</span> geo.dest 
<span class="hljs-number">3</span>.  | RENAME geo.dest <span class="hljs-keyword">AS</span> iso2.keyword 
<span class="hljs-number">4</span>.  | LOOKUP <span class="hljs-keyword">JOIN</span> world_countries <span class="hljs-keyword">ON</span> iso2.keyword 
<span class="hljs-number">5</span>.  | RENAME iso2.keyword <span class="hljs-keyword">AS</span> geo.dest 
<span class="hljs-number">6</span>.  | KEEP count, geometry, geo.dest, population.population_2024 
<span class="hljs-number">7</span>.  | EVAL normalized_count = TO_DOUBLE(count) / population.population_2024 * <span class="hljs-number">100000</span>

`AI写代码
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e63741079f2141bd9030ad4edfa290ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=DBwGweAj8s76pmqMlOXkGeEk2k0%3D" alt="" loading="lazy"/></p>
<ul>
<li>在 ES|QL 编辑器中点击 Run query</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21e69d74f8de451280b14ae6d8c7ddce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=XzvV31MVsr8bO%2FhyYtP9RaNfOd4%3D" alt="" loading="lazy"/></p>
<ul>
<li>在 Layer style 中将 Fill color 设置为 By value by normalized_count。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86b8e174129f42f3a2aa1ac6a42dec6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=KQKsChdXQl1oDPyjGegXlVlsE60%3D" alt="" loading="lazy"/></p>
<ul>
<li>点击 Keep changes。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ad2ef7cbb0945448f6f5439bb833c9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=vIleNIwrAzdRPRsF88yAeHBtg2A%3D" alt="" loading="lazy"/></p>
<blockquote>
<p><strong>注意</strong>：你可能已经猜到，为什么不使用 lookup 设置导入 populations CSV 来对地图查询执行第二次 LOOKUP JOIN。那是可行的！但要注意，每增加一次 join 都会有性能开销。</p>
</blockquote>
<p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscuss.elastic.co%2Ft%2Fdec-14th-2025-en-build-a-map-to-compare-metrics-by-country-or-region-with-es-ql%2F383243" title="https://discuss.elastic.co/t/dec-14th-2025-en-build-a-map-to-compare-metrics-by-country-or-region-with-es-ql/383243" target="_blank" ref="nofollow noopener noreferrer">discuss.elastic.co/t/dec-14th-…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[脚手架开发工具——root-check]]></title>    <link>https://juejin.cn/post/7585474459776237604</link>    <guid>https://juejin.cn/post/7585474459776237604</guid>    <pubDate>2025-12-20T08:02:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585474459776237604" data-draft-id="7585463195201306674" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="脚手架开发工具——root-check"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T08:02:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="code_YuJun"/> <meta itemprop="url" content="https://juejin.cn/user/3615612462441358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            脚手架开发工具——root-check
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3615612462441358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    code_YuJun
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:02:32.000Z" title="Sat Dec 20 2025 08:02:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    21
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">简介</h2>
<p><code>root-check</code> 是一个 <strong>Node.js 工具包</strong>，核心作用是<strong>检测当前 Node.js 进程是否以 <code>root</code>（超级管理员）权限运行</strong>，并在检测到 <code>root</code> 权限时，自动降级为指定的普通用户权限运行，以此提升应用的安全性。</p>
<h3 data-id="heading-1">检测 root 权限</h3>
<p>它会判断当前进程的 <code>uid</code>（用户 ID）是否为 <code>0</code>（Unix/Linux 系统中 <code>root</code> 用户的 <code>uid</code> 固定为 <code>0</code>），以此识别是否为 <code>root</code> 权限运行。</p>
<h3 data-id="heading-2">自动降级权限</h3>
<p>如果检测到当前是 <code>root</code> 权限，它会尝试切换到一个<strong>非 root 普通用户</strong>的权限来运行后续代码。</p>
<ul>
<li>默认会尝试切换到 <code>nobody</code> 用户（Unix/Linux 系统中内置的无特权用户）。</li>
<li>也可以手动指定要切换的用户（通过用户名或 <code>uid</code>）。</li>
</ul>
<h3 data-id="heading-3">解决的核心问题</h3>
<p>在 Unix/Linux 系统中，以 <code>root</code> 权限运行 Node.js 应用存在<strong>极高的安全风险</strong>：一旦应用存在漏洞被攻击，攻击者将直接获得系统的最高权限，可能导致服务器被完全控制。<code>root-check</code> 的存在就是为了<strong>避免这种风险</strong>，强制应用以低权限运行，即使被攻击，影响范围也会被大幅限制。</p>
<h3 data-id="heading-4">适用场景</h3>
<ul>
<li>命令行工具（CLI）开发：很多 Node.js 命令行工具（如前端的构建工具、脚手架）会用到这个包，防止用户以 <code>root</code> 权限执行命令带来风险。</li>
<li>服务端应用：Node.js 编写的后端服务，部署时需要避免 root 权限运行，可通过此包自动降级。</li>
</ul>
<h3 data-id="heading-5">基本使用示例</h3>
<pre><code class="hljs language-js" lang="js">npm install root-check --save
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> rootCheck = <span class="hljs-built_in">require</span>(<span class="hljs-string">'root-check'</span>).<span class="hljs-property">default</span>;
<span class="hljs-comment">// 自动降级为 nobody 用户（如果当前是 root 权限）</span>
<span class="hljs-title function_">rootCheck</span>();
<span class="hljs-comment">// 或者手动指定要切换的用户</span>
<span class="hljs-comment">// rootCheck('www-data'); // 切换到 www-data 用户</span>
</code></pre>
<h3 data-id="heading-6">注意事项</h3>
<ul>
<li><strong>仅支持 Unix/Linux 系统</strong>：Windows 系统没有 <code>root</code>/<code>uid</code> 的概念，该包在 Windows 上会直接失效（无副作用）。</li>
<li><strong>降级失败会抛出错误</strong>：如果当前是 root 权限，但无法切换到目标用户（比如目标用户不存在），<code>rootCheck</code> 会抛出异常，需要手动捕获处理。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3条件渲染中v-if系列指令如何合理使用与规避错误？]]></title>    <link>https://juejin.cn/post/7585485284152295459</link>    <guid>https://juejin.cn/post/7585485284152295459</guid>    <pubDate>2025-12-20T08:13:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585485284152295459" data-draft-id="7585452404113129487" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3条件渲染中v-if系列指令如何合理使用与规避错误？    "/> <meta itemprop="keywords" content="前端,Trae,AI编程"/> <meta itemprop="datePublished" content="2025-12-20T08:13:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="kknone"/> <meta itemprop="url" content="https://juejin.cn/user/1366025597879930"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3条件渲染中v-if系列指令如何合理使用与规避错误？    
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1366025597879930/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    kknone
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:13:19.000Z" title="Sat Dec 20 2025 08:13:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、Vue3条件渲染的核心概念</h3>
<p>在Vue3中，<strong>条件渲染</strong>是指根据<strong>响应式数据的真假</strong>，决定是否在页面上渲染某个元素或组件。而<code>v-if</code>、<code>v-else</code>、<code>v-else-if</code>
这组指令，就是实现条件渲染的“核心工具”——它们像一套“逻辑开关”，帮你精准控制DOM的显示与隐藏。</p>
<h3 data-id="heading-1">二、v-if系列指令的语法与用法</h3>
<p>我们先逐个拆解每个指令的作用，再通过<strong>实际案例</strong>串起来用。</p>
<h4 data-id="heading-2">2.1 v-if：基础条件判断</h4>
<p><code>v-if</code>是最基础的条件指令，它的语法很简单：</p>
<pre><code class="hljs language-html" lang="html">
<span class="hljs-tag">&lt;<span class="hljs-name">元素</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"条件表达式"</span>&gt;</span>要渲染的内容<span class="hljs-tag">&lt;/<span class="hljs-name">元素</span>&gt;</span>
</code></pre>
<ul>
<li><strong>条件表达式</strong>：可以是任何返回<code>true</code>或<code>false</code>的JavaScript表达式（比如<code>isLogin</code>、<code>score &gt;= 90</code>）。</li>
<li><strong>惰性渲染</strong>：<code>v-if</code>是“懒”的——如果初始条件不满足（比如<code>isLogin = false</code>），元素<strong>不会被渲染到DOM中</strong>（连DOM节点都不会生成）；只有当条件变为
<code>true</code>时，才会“从零开始”创建元素及其子组件。</li>
</ul>
<p>举个例子：判断用户是否登录，显示不同的内容：</p>
<pre><code class="hljs language-vue" lang="vue">
&lt;script setup&gt;
  import {ref} from 'vue'

  const isLogin = ref(false) // 初始未登录
&lt;/script&gt;

&lt;template&gt;
  &lt;div&gt;
    &lt;!-- 登录后显示 --&gt;
    &lt;p v-if="isLogin"&gt;欢迎回来，用户！&lt;/p&gt;
    &lt;!-- 未登录显示 --&gt;
    &lt;button v-if="!isLogin" @click="isLogin = true"&gt;点击登录&lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<p>当点击按钮时，<code>isLogin</code>变为<code>true</code>，未登录的按钮会被销毁，同时渲染“欢迎”文本——这就是<code>v-if</code>的“销毁/重建”逻辑。</p>
<details>
<summary>往期文章归档</summary>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F218c3a59282c3b757447ee08a01937bb%2F" target="_blank" title="https://blog.cmdragon.cn/posts/218c3a59282c3b757447ee08a01937bb/" ref="nofollow noopener noreferrer">Vue3动态样式控制：ref、reactive、watch与computed的应用场景与区别是什么？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F1bab953e41f66ac53de099fa9fe76483%2F" target="_blank" title="https://blog.cmdragon.cn/posts/1bab953e41f66ac53de099fa9fe76483/" ref="nofollow noopener noreferrer">Vue3中动态样式数组的后项覆盖规则如何与计算属性结合实现复杂状态样式管理？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc85e1fe16a7ae45e965b4e2df4d9d2f4%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c85e1fe16a7ae45e965b4e2df4d9d2f4/" ref="nofollow noopener noreferrer">Vue浅响应式如何解决深层响应式的性能问题？适用场景有哪些？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbe04b02d2723994632de0d4ca22a3391%2F" target="_blank" title="https://blog.cmdragon.cn/posts/be04b02d2723994632de0d4ca22a3391/" ref="nofollow noopener noreferrer">Vue 3组合式API中ref与reactive的核心响应式差异及使用最佳实践是什么？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbe04b02d2723994632de0d4ca22a3391%2F" target="_blank" title="https://blog.cmdragon.cn/posts/be04b02d2723994632de0d4ca22a3391/" ref="nofollow noopener noreferrer">Vue 3组合式API中ref与reactive的核心响应式差异及使用最佳实践是什么？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa0af08dd60a37b9a890a9957f2cbfc9f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a0af08dd60a37b9a890a9957f2cbfc9f/" ref="nofollow noopener noreferrer">Vue3响应式系统中，对象新增属性、数组改索引、原始值代理的问题如何解决？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbc287e1e36287afd90750fd907eca85e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bc287e1e36287afd90750fd907eca85e/" ref="nofollow noopener noreferrer">Vue 3中watch侦听器的正确使用姿势你掌握了吗？深度监听、与watchEffect的差异及常见报错解析 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F654b9447ef1ba7ec1126a1bc26a4726d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/654b9447ef1ba7ec1126a1bc26a4726d/" ref="nofollow noopener noreferrer">Vue响应式声明的API差异、底层原理与常见陷阱你都搞懂了吗 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F654b9447ef1ba7ec1126a1bc26a4726d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/654b9447ef1ba7ec1126a1bc26a4726d/" ref="nofollow noopener noreferrer">Vue响应式声明的API差异、底层原理与常见陷阱你都搞懂了吗 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc405a8d9950af5b7c63b56c348ac36b6%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c405a8d9950af5b7c63b56c348ac36b6/" ref="nofollow noopener noreferrer">为什么Vue 3需要ref函数？它的响应式原理与正确用法是什么？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa7e9abb9691a81e4404d9facabe0f7c3%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a7e9abb9691a81e4404d9facabe0f7c3/" ref="nofollow noopener noreferrer">Vue 3中reactive函数如何通过Proxy实现响应式？使用时要避开哪些误区？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbd995ea45161727597fb85b62566c43d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bd995ea45161727597fb85b62566c43d/" ref="nofollow noopener noreferrer">Vue3响应式系统的底层原理与实践要点你真的懂吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F53e3f270a80675df662c6857a3332c0f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/53e3f270a80675df662c6857a3332c0f/" ref="nofollow noopener noreferrer">Vue 3模板如何通过编译三阶段实现从声明式语法到高效渲染的跨越 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fddbce4f2a23aa72c96b1c0473900321e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ddbce4f2a23aa72c96b1c0473900321e/" ref="nofollow noopener noreferrer">快速入门Vue模板引用：从收DOM“快递”到调子组件方法，你玩明白了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F23a2d5a334e15575277814c16e45df50%2F" target="_blank" title="https://blog.cmdragon.cn/posts/23a2d5a334e15575277814c16e45df50/" ref="nofollow noopener noreferrer">快速入门Vue模板里的JS表达式有啥不能碰？计算属性为啥比方法更能打？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6be38de6382e31d282659b689c5b17f0%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6be38de6382e31d282659b689c5b17f0/" ref="nofollow noopener noreferrer">快速入门Vue的v-model表单绑定：语法糖、动态值、修饰符的小技巧你都掌握了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F60ce517684f4a418f453d66aa805606c%2F" target="_blank" title="https://blog.cmdragon.cn/posts/60ce517684f4a418f453d66aa805606c/" ref="nofollow noopener noreferrer">快速入门Vue3事件处理的挑战题：v-on、修饰符、自定义事件你能通关吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fe4ae7d5e4a9205bb11b2baccb230c637%2F" target="_blank" title="https://blog.cmdragon.cn/posts/e4ae7d5e4a9205bb11b2baccb230c637/" ref="nofollow noopener noreferrer">快速入门Vue3的v-指令：数据和DOM的“翻译官”到底有多少本事？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F999ce4fb32259ff4fbf4bf7bcb851654%2F" target="_blank" title="https://blog.cmdragon.cn/posts/999ce4fb32259ff4fbf4bf7bcb851654/" ref="nofollow noopener noreferrer">快速入门Vue3，插值、动态绑定和避坑技巧你都搞懂了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa6997d81b49cd232b87e1cf603888ad1%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a6997d81b49cd232b87e1cf603888ad1/" ref="nofollow noopener noreferrer">想让PostgreSQL快到飞起？先找健康密码还是先换引擎？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F1fee7afbb9abd4540b8aa9c141d6845d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/1fee7afbb9abd4540b8aa9c141d6845d/" ref="nofollow noopener noreferrer">想让PostgreSQL查询快到飞起？分区表、物化视图、并行查询这三招灵不灵？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F79c590fbd87ece535b11a71c9667884f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/79c590fbd87ece535b11a71c9667884f/" ref="nofollow noopener noreferrer">子查询总拖慢查询？把它变成连接就能解决？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F748cdac2536008199abf8a8a2cd0ec85%2F" target="_blank" title="https://blog.cmdragon.cn/posts/748cdac2536008199abf8a8a2cd0ec85/" ref="nofollow noopener noreferrer">PostgreSQL全表扫描慢到崩溃？建索引+改查询+更统计信息三招能破？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F32ca943703226d317d4276a8fb53b0dd%2F" target="_blank" title="https://blog.cmdragon.cn/posts/32ca943703226d317d4276a8fb53b0dd/" ref="nofollow noopener noreferrer">复杂查询总拖后腿？PostgreSQL多列索引+覆盖索引的神仙技巧你get没？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fca93f1d53aa910e7ba5ffd8df611c12b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ca93f1d53aa910e7ba5ffd8df611c12b/" ref="nofollow noopener noreferrer">只给表子集建索引？用函数结果建索引？PostgreSQL这俩操作凭啥能省空间又加速？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Ff507856ebfddd592448813c510a53669%2F" target="_blank" title="https://blog.cmdragon.cn/posts/f507856ebfddd592448813c510a53669/" ref="nofollow noopener noreferrer">B-tree索引像字典查词一样工作？那哪些数据库查询它能加速，哪些不能？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb2213bfcb5b88a862f2138404c03d596%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b2213bfcb5b88a862f2138404c03d596/" ref="nofollow noopener noreferrer">想抓PostgreSQL里的慢SQL？pg_stat_statements基础黑匣子和pg_stat_monitor时间窗，谁能帮你更准揪出性能小偷？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F26614eb7da6c476dde41d367ad888d2f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/26614eb7da6c476dde41d367ad888d2f/" ref="nofollow noopener noreferrer">PostgreSQL的“时光机”MVCC和锁机制是怎么搞定高并发的？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F69f99bc6972a860d559c74aad7280da4%2F" target="_blank" title="https://blog.cmdragon.cn/posts/69f99bc6972a860d559c74aad7280da4/" ref="nofollow noopener noreferrer">PostgreSQL性能暴涨的关键？内存IO并发参数居然要这么设置？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F7b7053f392147a8b3b1a16bebeb08d0a%2F" target="_blank" title="https://blog.cmdragon.cn/posts/7b7053f392147a8b3b1a16bebeb08d0a/" ref="nofollow noopener noreferrer">大表查询慢到翻遍整个书架？PostgreSQL分区表教你怎么“分类”才高效</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc856e3cb073822349f3bf2d29995dcfc%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c856e3cb073822349f3bf2d29995dcfc/" ref="nofollow noopener noreferrer">PostgreSQL 查询慢？是不是忘了优化 GROUP BY、ORDER BY 和窗口函数？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc096347d18e67b7431faacd2c4757093%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c096347d18e67b7431faacd2c4757093/" ref="nofollow noopener noreferrer">PostgreSQL里的子查询和CTE居然在性能上“掐架”？到底该站哪边？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F2eca89463454fd4250d7b66243b9fe5a%2F" target="_blank" title="https://blog.cmdragon.cn/posts/2eca89463454fd4250d7b66243b9fe5a/" ref="nofollow noopener noreferrer">PostgreSQL选Join策略有啥小九九？Nested Loop/Merge/Hash谁是它的菜？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F068ecb772a87d7df20a8c9fb4b233f8e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/068ecb772a87d7df20a8c9fb4b233f8e/" ref="nofollow noopener noreferrer">PostgreSQL新手SQL总翻车？这7个性能陷阱你踩过没？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd498f63cd0a2d5a77e445c688a8b88db%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d498f63cd0a2d5a77e445c688a8b88db/" ref="nofollow noopener noreferrer">PostgreSQL索引选B-Tree还是GiST？“瑞士军刀”和“多面手”的差别你居然还不知道？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F9101b75bdec6faea9b35d54f14e37f36%2F" target="_blank" title="https://blog.cmdragon.cn/posts/9101b75bdec6faea9b35d54f14e37f36/" ref="nofollow noopener noreferrer">想知道数据库怎么给查询“算成本选路线”？EXPLAIN能帮你看明白？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd527f8ebb6e3dae2c7dfe4c8d8979444%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d527f8ebb6e3dae2c7dfe4c8d8979444/" ref="nofollow noopener noreferrer">PostgreSQL处理SQL居然像做蛋糕？解析到执行的4步里藏着多少查询优化的小心机？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6bfdae84f313cf7ad0bb7045c4392347%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6bfdae84f313cf7ad0bb7045c4392347/" ref="nofollow noopener noreferrer">PostgreSQL备份不是复制文件？物理vs逻辑咋选？误删还能精准恢复到1分钟前？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fde3672803de34dbad244d0a8d48b0eb5%2F" target="_blank" title="https://blog.cmdragon.cn/posts/de3672803de34dbad244d0a8d48b0eb5/" ref="nofollow noopener noreferrer">转账不翻车、并发不干扰，PostgreSQL的ACID特性到底有啥魔法？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fe463e8a2668abdf00a228c9b79324ded%2F" target="_blank" title="https://blog.cmdragon.cn/posts/e463e8a2668abdf00a228c9b79324ded/" ref="nofollow noopener noreferrer">银行转账不白扣钱、电商下单不超卖，PostgreSQL事务的诀窍是啥？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F5c967e595058c4a1fc4474a68e64031d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/5c967e595058c4a1fc4474a68e64031d/" ref="nofollow noopener noreferrer">PostgreSQL里的PL/pgSQL到底是啥？能让SQL从“说目标”变“讲步骤”？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F325047855e3e23b5ef82f7d2db134fbd%2F" target="_blank" title="https://blog.cmdragon.cn/posts/325047855e3e23b5ef82f7d2db134fbd/" ref="nofollow noopener noreferrer">PostgreSQL视图不存数据？那它怎么简化查询还能递归生成序列和控制权限？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd2dba50bb6e4df7b27e735245a06a2a2%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d2dba50bb6e4df7b27e735245a06a2a2/" ref="nofollow noopener noreferrer">PostgreSQL索引这么玩，才能让你的查询真的“飞”起来？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F849ae5bab0f8c66e94c2f6ad1bb798e3%2F" target="_blank" title="https://blog.cmdragon.cn/posts/849ae5bab0f8c66e94c2f6ad1bb798e3/" ref="nofollow noopener noreferrer">PostgreSQL的表关系和约束，咋帮你搞定用户订单不混乱、学生选课不重复？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fef4800975ffa84f1ca51976a70a1585b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ef4800975ffa84f1ca51976a70a1585b/" ref="nofollow noopener noreferrer">PostgreSQL查询的筛子、排序、聚合、分组？你会用它们搞定数据吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbf54711525c507c5eacfa7b0151c39d2%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bf54711525c507c5eacfa7b0151c39d2/" ref="nofollow noopener noreferrer">PostgreSQL数据类型怎么选才高效不踩坑？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F887809b3e0375f5956873cd442f516d8%2F" target="_blank" title="https://blog.cmdragon.cn/posts/887809b3e0375f5956873cd442f516d8/" ref="nofollow noopener noreferrer">想解锁PostgreSQL查询从基础到进阶的核心知识点？你都get了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F934be1203725e8be9d6f6e9104e5abcc%2F" target="_blank" title="https://blog.cmdragon.cn/posts/934be1203725e8be9d6f6e9104e5abcc/" ref="nofollow noopener noreferrer">PostgreSQL DELETE居然有这些操作？返回数据、连表删你试过没？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F0f0622e9b7402b599e618150d0596ffe%2F" target="_blank" title="https://blog.cmdragon.cn/posts/0f0622e9b7402b599e618150d0596ffe/" ref="nofollow noopener noreferrer">PostgreSQL UPDATE语句怎么玩？从改邮箱到批量更新的避坑技巧你都会吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F0e3bf7efc030b024ea67ee855a00f2de%2F" target="_blank" title="https://blog.cmdragon.cn/posts/0e3bf7efc030b024ea67ee855a00f2de/" ref="nofollow noopener noreferrer">PostgreSQL插入数据还在逐条敲？批量、冲突处理、返回自增ID的技巧你会吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb6cd3c86da6aac26ed829e472d34078e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b6cd3c86da6aac26ed829e472d34078e/" ref="nofollow noopener noreferrer">PostgreSQL的“仓库-房间-货架”游戏，你能建出电商数据库和表吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fba1f545a3410144552fbdbfcf31b5265%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ba1f545a3410144552fbdbfcf31b5265/" ref="nofollow noopener noreferrer">PostgreSQL 17安装总翻车？Windows/macOS/Linux避坑指南帮你搞定？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb5474d1480509c5072085abc80b3dd9f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b5474d1480509c5072085abc80b3dd9f/" ref="nofollow noopener noreferrer">能当关系型数据库还能玩对象特性，能拆复杂查询还能自动管库存，PostgreSQL凭什么这么香？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fcc098d8836e787baa8a4d92e4d56d5c5%2F" target="_blank" title="https://blog.cmdragon.cn/posts/cc098d8836e787baa8a4d92e4d56d5c5/" ref="nofollow noopener noreferrer">给接口加新字段又不搞崩老客户端？FastAPI的多版本API靠哪三招实现？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F46d05151c5bd31cf37a7bcf0b8f5b0b8%2F" target="_blank" title="https://blog.cmdragon.cn/posts/46d05151c5bd31cf37a7bcf0b8f5b0b8/" ref="nofollow noopener noreferrer">流量突增要搞崩FastAPI？熔断测试是怎么防系统雪崩的？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F65ce343cc5df9faf3a8e2eeaab42ae45%2F" target="_blank" title="https://blog.cmdragon.cn/posts/65ce343cc5df9faf3a8e2eeaab42ae45/" ref="nofollow noopener noreferrer">FastAPI秒杀库存总变负数？Redis分布式锁能帮你守住底线吗 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Feed6cd8985d9be0a4b092a7da38b3e0c%2F" target="_blank" title="https://blog.cmdragon.cn/posts/eed6cd8985d9be0a4b092a7da38b3e0c/" ref="nofollow noopener noreferrer">FastAPI的CI流水线怎么自动测端点，还能让Allure报告美到犯规？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6157d87338ce894d18c013c3c4777abb%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6157d87338ce894d18c013c3c4777abb/" ref="nofollow noopener noreferrer">如何用GitHub Actions为FastAPI项目打造自动化测试流水线？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Ffc4ef84559e04693a620d0714cb30787%2F" target="_blank" title="https://blog.cmdragon.cn/posts/fc4ef84559e04693a620d0714cb30787/" ref="nofollow noopener noreferrer">如何用Git Hook和CI流水线为FastAPI项目保驾护航？ - cmdragon's Blog</a></li>
</ul>
</details>
<details>
<summary>免费好用的热门在线工具</summary>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fraid-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/raid-calculator" ref="nofollow noopener noreferrer">RAID 计算器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fphotoshop-online" target="_blank" title="https://tools.cmdragon.cn/zh/apps/photoshop-online" ref="nofollow noopener noreferrer">在线PS - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmermaid-live-editor" target="_blank" title="https://tools.cmdragon.cn/zh/apps/mermaid-live-editor" ref="nofollow noopener noreferrer">Mermaid 在线编辑器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmath-solver-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/math-solver-calculator" ref="nofollow noopener noreferrer">数学求解计算器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsmart-teleprompter" target="_blank" title="https://tools.cmdragon.cn/zh/apps/smart-teleprompter" ref="nofollow noopener noreferrer">智能提词器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmagic-resume" target="_blank" title="https://tools.cmdragon.cn/zh/apps/magic-resume" ref="nofollow noopener noreferrer">魔法简历 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-puzzle-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-puzzle-tool" ref="nofollow noopener noreferrer">Image Puzzle Tool - 图片拼图工具 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsubtitle-downloader" target="_blank" title="https://tools.cmdragon.cn/zh/apps/subtitle-downloader" ref="nofollow noopener noreferrer">字幕下载工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Flyrics-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/lyrics-generator" ref="nofollow noopener noreferrer">歌词生成工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcloud-drive-search" target="_blank" title="https://tools.cmdragon.cn/zh/apps/cloud-drive-search" ref="nofollow noopener noreferrer">网盘资源聚合搜索 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fascii-art-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ascii-art-generator" ref="nofollow noopener noreferrer">ASCII字符画生成器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fjwt-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/jwt-tool" ref="nofollow noopener noreferrer">JSON Web Tokens 工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbcrypt-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/bcrypt-tool" ref="nofollow noopener noreferrer">Bcrypt 密码工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fgif-composer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/gif-composer" ref="nofollow noopener noreferrer">GIF 合成器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fgif-decomposer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/gif-decomposer" ref="nofollow noopener noreferrer">GIF 分解器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-steganography" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-steganography" ref="nofollow noopener noreferrer">文本隐写术 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh" target="_blank" title="https://tools.cmdragon.cn/zh" ref="nofollow noopener noreferrer">CMDragon 在线工具 - 高级AI工具箱与开发者套件 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%3Fcategory%3Dtrending" target="_blank" title="https://tools.cmdragon.cn/zh/apps?category=trending" ref="nofollow noopener noreferrer">应用商店 - 发现1000+提升效率与开发的AI工具和实用程序 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fchangelog" target="_blank" title="https://tools.cmdragon.cn/zh/changelog" ref="nofollow noopener noreferrer">CMDragon 更新日志 - 最新更新、功能与改进 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fsponsor" target="_blank" title="https://tools.cmdragon.cn/zh/sponsor" ref="nofollow noopener noreferrer">支持我们 - 成为赞助者 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-to-image-ai" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-to-image-ai" ref="nofollow noopener noreferrer">AI文本生成图像 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftemp-email" target="_blank" title="https://tools.cmdragon.cn/zh/apps/temp-email" ref="nofollow noopener noreferrer">临时邮箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fqrcode-parser" target="_blank" title="https://tools.cmdragon.cn/zh/apps/qrcode-parser" ref="nofollow noopener noreferrer">二维码解析器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-to-mindmap" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-to-mindmap" ref="nofollow noopener noreferrer">文本转思维导图 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fregex-visualizer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/regex-visualizer" ref="nofollow noopener noreferrer">正则表达式可视化工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsteganography-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/steganography-tool" ref="nofollow noopener noreferrer">文件隐写工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fiptv-explorer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/iptv-explorer" ref="nofollow noopener noreferrer">IPTV 频道探索器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsnapdrop" target="_blank" title="https://tools.cmdragon.cn/zh/apps/snapdrop" ref="nofollow noopener noreferrer">快传 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Flucky-draw" target="_blank" title="https://tools.cmdragon.cn/zh/apps/lucky-draw" ref="nofollow noopener noreferrer">随机抽奖工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fanime-scene-finder" target="_blank" title="https://tools.cmdragon.cn/zh/apps/anime-scene-finder" ref="nofollow noopener noreferrer">动漫场景查找器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftime-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/time-toolkit" ref="nofollow noopener noreferrer">时间工具箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fspeed-test" target="_blank" title="https://tools.cmdragon.cn/zh/apps/speed-test" ref="nofollow noopener noreferrer">网速测试 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbackground-remover" target="_blank" title="https://tools.cmdragon.cn/zh/apps/background-remover" ref="nofollow noopener noreferrer">AI 智能抠图工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbackground-replacer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/background-replacer" ref="nofollow noopener noreferrer">背景替换工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fartistic-qrcode" target="_blank" title="https://tools.cmdragon.cn/zh/apps/artistic-qrcode" ref="nofollow noopener noreferrer">艺术二维码生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fopen-graph-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/open-graph-generator" ref="nofollow noopener noreferrer">Open Graph 元标签生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-comparison" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-comparison" ref="nofollow noopener noreferrer">图像对比工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-compressor" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-compressor" ref="nofollow noopener noreferrer">图片压缩专业版 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fpassword-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/password-generator" ref="nofollow noopener noreferrer">密码生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsvg-optimizer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/svg-optimizer" ref="nofollow noopener noreferrer">SVG优化器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcolor-palette" target="_blank" title="https://tools.cmdragon.cn/zh/apps/color-palette" ref="nofollow noopener noreferrer">调色板生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fonline-metronome" target="_blank" title="https://tools.cmdragon.cn/zh/apps/online-metronome" ref="nofollow noopener noreferrer">在线节拍器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-geolocation" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-geolocation" ref="nofollow noopener noreferrer">IP归属地查询 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcss-grid-layout" target="_blank" title="https://tools.cmdragon.cn/zh/apps/css-grid-layout" ref="nofollow noopener noreferrer">CSS网格布局生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Femail-validator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/email-validator" ref="nofollow noopener noreferrer">邮箱验证工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcalligraphy-practice" target="_blank" title="https://tools.cmdragon.cn/zh/apps/calligraphy-practice" ref="nofollow noopener noreferrer">书法练习字帖 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ffinance-calculator-suite" target="_blank" title="https://tools.cmdragon.cn/zh/apps/finance-calculator-suite" ref="nofollow noopener noreferrer">金融计算器套件 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fchinese-kinship-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/chinese-kinship-calculator" ref="nofollow noopener noreferrer">中国亲戚关系计算器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fprotobuf-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/protobuf-toolkit" ref="nofollow noopener noreferrer">Protocol Buffer 工具箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-geolocation" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-geolocation" ref="nofollow noopener noreferrer">IP归属地查询 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-upscaler" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-upscaler" ref="nofollow noopener noreferrer">图片无损放大 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-compare" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-compare" ref="nofollow noopener noreferrer">文本比较工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-batch-lookup" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-batch-lookup" ref="nofollow noopener noreferrer">IP批量查询工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fdomain-finder" target="_blank" title="https://tools.cmdragon.cn/zh/apps/domain-finder" ref="nofollow noopener noreferrer">域名查询工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fdns-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/dns-toolkit" ref="nofollow noopener noreferrer">DNS工具箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ffavicon-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/favicon-generator" ref="nofollow noopener noreferrer">网站图标生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fsitemap_index.xml" target="_blank" title="https://tools.cmdragon.cn/sitemap_index.xml" ref="nofollow noopener noreferrer">XML Sitemap</a></li>
</ul>
</details>
<h4 data-id="heading-3">2.2 v-else：补充默认分支</h4>
<p>如果<code>v-if</code>的条件不满足，你可以用<code>v-else</code>添加一个“默认选项”。但要注意：<br/>
<strong><code>v-else</code>必须紧跟在<code>v-if</code>或<code>v-else-if</code>的后面，中间不能有其他兄弟元素</strong>（否则Vue无法识别它属于哪个条件）。</p>
<p>修改上面的例子，用<code>v-else</code>简化未登录的情况：</p>
<pre><code class="hljs language-html" lang="html">
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"isLogin"</span>&gt;</span>欢迎回来，用户！<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 直接跟在v-if后面，无需写条件 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">v-else</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"isLogin = true"</span>&gt;</span>点击登录<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<h4 data-id="heading-4">2.3 v-else-if：多分支条件判断</h4>
<p>当需要判断<strong>多个条件</strong>时，用<code>v-else-if</code>连接。它的语法是：</p>
<pre><code class="hljs language-html" lang="html">
<span class="hljs-tag">&lt;<span class="hljs-name">元素</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"条件1"</span>&gt;</span>内容1<span class="hljs-tag">&lt;/<span class="hljs-name">元素</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">元素</span> <span class="hljs-attr">v-else-if</span>=<span class="hljs-string">"条件2"</span>&gt;</span>内容2<span class="hljs-tag">&lt;/<span class="hljs-name">元素</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">元素</span> <span class="hljs-attr">v-else-if</span>=<span class="hljs-string">"条件3"</span>&gt;</span>内容3<span class="hljs-tag">&lt;/<span class="hljs-name">元素</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">元素</span> <span class="hljs-attr">v-else</span>&gt;</span>默认内容<span class="hljs-tag">&lt;/<span class="hljs-name">元素</span>&gt;</span>
</code></pre>
<p><strong>关键规则</strong>：Vue会按<strong>指令的顺序依次判断</strong>，满足第一个条件就停止（所以条件的顺序很重要！）。</p>
<p>比如根据分数显示等级（最常见的多分支场景）：</p>
<pre><code class="hljs language-vue" lang="vue">
&lt;script setup&gt;
  import {ref} from 'vue'

  const score = ref(85) // 响应式分数，初始85分
&lt;/script&gt;

&lt;template&gt;
  &lt;div class="score-level"&gt;
    &lt;h3&gt;你的分数：{{ score }}&lt;/h3&gt;
    &lt;!-- 顺序：从高到低 --&gt;
    &lt;p v-if="score &gt;= 90" class="excellent"&gt;等级：优秀（≥90）&lt;/p&gt;
    &lt;p v-else-if="score &gt;= 80" class="good"&gt;等级：良好（80-89）&lt;/p&gt;
    &lt;p v-else-if="score &gt;= 60" class="pass"&gt;等级：及格（60-79）&lt;/p&gt;
    &lt;p v-else class="fail"&gt;等级：不及格（&lt;60）&lt;/p&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
  .excellent {
    color: #4CAF50;
  }

  .good {
    color: #2196F3;
  }

  .pass {
    color: #FFC107;
  }

  .fail {
    color: #F44336;
  }
&lt;/style&gt;
</code></pre>
<p>运行这个组件，修改<code>score</code>的值（比如改成<code>95</code>或<code>50</code>），会看到等级自动切换——这就是多分支条件渲染的实际效果。</p>
<h3 data-id="heading-5">三、条件渲染的流程逻辑（附流程图）</h3>
<p>为了更直观理解<code>v-if</code>系列的执行顺序，我们画一个<strong>判断流程图</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[开始] --&gt; B{检查v-if条件}
    B --&gt;|满足| C[渲染v-if内容，结束]
    B --&gt;|不满足| D{检查下一个v-else-if条件}
    D --&gt;|满足| E[渲染对应内容，结束]
    D --&gt;|不满足| F{还有v-else-if吗?}
    F --&gt;|是| D
    F --&gt;|否| G[渲染v-else内容，结束]
</code></pre>
<p>简单来说：<strong>按顺序“闯关”，满足条件就“通关”，否则继续，直到最后一个v-else</strong>。</p>
<h3 data-id="heading-6">四、课后Quiz：巩固你的理解</h3>
<h4 data-id="heading-7">Quiz 1：v-if和v-show有什么区别？</h4>
<p><strong>问题</strong>：同样是“隐藏元素”，<code>v-if</code>和<code>v-show</code>的核心差异是什么？分别适合什么场景？</p>
<p><strong>答案解析</strong>（参考Vue官网）：</p>
<ul>
<li><code>v-if</code>：<strong>销毁/重建DOM</strong>——条件不满足时，元素从DOM中消失；条件满足时，重新创建。适合<strong>条件很少变化</strong>的场景（比如权限判断），因为初始渲染更省性能。</li>
<li><code>v-show</code>：<strong>修改CSS显示</strong>——无论条件如何，元素都会渲染到DOM，只是用<code>display: none</code>隐藏。适合<strong>条件频繁切换</strong>的场景（比如
tabs 切换），因为切换时无需销毁重建，更高效。</li>
</ul>
<h4 data-id="heading-8">Quiz 2：为什么v-else必须紧跟v-if？</h4>
<p><strong>问题</strong>：如果写<code>v-if</code>之后隔了一个<code>div</code>再写<code>v-else</code>，会报错吗？为什么？</p>
<p><strong>答案解析</strong>：<br/>
会报错！错误信息是“v-else has no adjacent v-if”。<br/>
原因：Vue需要明确<code>v-else</code>对应的“上级条件”——它必须与最近的<code>v-if/v-else-if</code><strong>直接相邻</strong>（中间不能有其他兄弟元素）。如果隔开，Vue无法识别两者的关联。</p>
<h3 data-id="heading-9">五、常见报错与解决方案</h3>
<p>在使用<code>v-if</code>系列时，新手常遇到以下问题，我们逐一解决：</p>
<h4 data-id="heading-10">1. 报错：“v-else/v-else-if has no adjacent v-if”</h4>
<ul>
<li><strong>原因</strong>：<code>v-else</code>或<code>v-else-if</code>没有紧跟对应的<code>v-if</code>（中间有其他元素）。<br/>
比如：
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"isShow"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>无关内容<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span> <span class="hljs-comment">&lt;!-- 中间的p元素导致错误 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
</li>
<li><strong>解决</strong>：删除中间的无关元素，让<code>v-else</code>直接紧跟<code>v-if</code>。</li>
<li><strong>预防</strong>：写<code>v-else</code>前，先检查前面的元素是否是<code>v-if</code>或<code>v-else-if</code>。</li>
</ul>
<h4 data-id="heading-11">2. 报错：“条件变化时，v-if内容不更新”</h4>
<ul>
<li><strong>原因</strong>：条件变量不是<strong>响应式</strong>的（比如用<code>let isShow = false</code>而不是<code>ref(false)</code>），Vue无法追踪其变化。</li>
<li><strong>解决</strong>：用<code>ref</code>（基本类型）或<code>reactive</code>（对象/数组）包裹条件变量：
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 错误写法</span>
<span class="hljs-keyword">let</span> isShow = <span class="hljs-literal">false</span> 
<span class="hljs-comment">// 正确写法</span>
<span class="hljs-keyword">const</span> isShow = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
</code></pre>
</li>
<li><strong>预防</strong>：所有需要“随数据变化而更新”的变量，都用Vue的响应式API（<code>ref</code>/<code>reactive</code>）定义。</li>
</ul>
<h4 data-id="heading-12">3. 逻辑错误：v-else-if顺序导致条件失效</h4>
<ul>
<li><strong>例子</strong>：先写<code>v-else-if="score &gt;= 60"</code>，再写<code>v-else-if="score &gt;= 80"</code>——此时<code>80分</code>会被第一个条件拦截，永远到不了第二个。</li>
<li><strong>原因</strong>：Vue按指令顺序判断，满足第一个条件就停止。</li>
<li><strong>解决</strong>：将<strong>更严格的条件</strong>放在前面（比如先<code>&gt;=90</code>，再<code>&gt;=80</code>，最后<code>&gt;=60</code>）。</li>
</ul>
<h3 data-id="heading-13">参考链接</h3>
<p>Vue官网条件渲染文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2Fguide%2Fessentials%2Fconditional.html" target="_blank" title="https://vuejs.org/guide/essentials/conditional.html" ref="nofollow noopener noreferrer">vuejs.org/guide/essen…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025-12-20 vue3中 eslint9+和prettier配置]]></title>    <link>https://juejin.cn/post/7585468725332197430</link>    <guid>https://juejin.cn/post/7585468725332197430</guid>    <pubDate>2025-12-20T08:19:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585468725332197430" data-draft-id="7585474459776090148" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025-12-20    vue3中 eslint9+和prettier配置"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T08:19:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Mr_Swilder"/> <meta itemprop="url" content="https://juejin.cn/user/3927901716878829"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025-12-20    vue3中 eslint9+和prettier配置
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3927901716878829/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Mr_Swilder
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:19:05.000Z" title="Sat Dec 20 2025 08:19:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>eslint 9+相较8版本使用<code>eslint.config.js</code>和扁平化配置方式。</p>
</blockquote>
<h3 data-id="heading-0">1.在项目根目录下安装所需的开发依赖包</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">核心代码检查与格式化工具</span>
pnpm add -D eslint prettier
<span class="hljs-meta prompt_">
# </span><span class="bash">Vue.js 语法支持</span>
pnpm add -D eslint-plugin-vue
<span class="hljs-meta prompt_">
# </span><span class="bash">Prettier 与 ESLint 集成</span>
pnpm add -D eslint-config-prettier eslint-plugin-prettier
</code></pre>
<h3 data-id="heading-1">💅 2. <code>prettier</code>配置</h3>
<p>在<code>vscode</code>中安装插件</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1742bb6496d4f07b32be2c2963d0580~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTXJfU3dpbGRlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823740&amp;x-signature=%2B2%2BlEqI6zH04b3JliMIuAzgjdfY%3D" alt="image.png" loading="lazy"/></p>
<p>根目录下新建配置文件 <code>.prettierrc</code></p>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-string">"semi"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">"singleQuote"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">"tabWidth"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"trailingComma"</span>: <span class="hljs-string">"es5"</span>,
  <span class="hljs-string">"printWidth"</span>: <span class="hljs-number">100</span>,
  <span class="hljs-string">"arrowParens"</span>: <span class="hljs-string">"avoid"</span>,
  <span class="hljs-string">"htmlWhitespaceSensitivity"</span>: <span class="hljs-string">"ignore"</span>
}
</code></pre>
<h3 data-id="heading-2">3.<code>eslint</code>配置并将<code>prettier</code>规则作为<code>eslint</code>一部分，对不符合要求的报错</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// eslint.config.js</span>
<span class="hljs-keyword">import</span> eslintPluginVue <span class="hljs-keyword">from</span> <span class="hljs-string">'eslint-plugin-vue'</span>
<span class="hljs-keyword">import</span> vueEslintParser <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-eslint-parser'</span>
<span class="hljs-keyword">import</span> eslintPluginPrettierRecommended <span class="hljs-keyword">from</span> <span class="hljs-string">'eslint-plugin-prettier/recommended'</span>
<span class="hljs-comment">// console.log(eslintPluginPrettierRecommended)</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> [
  <span class="hljs-comment">// 全局配置：指定环境、解析器选项</span>
  {
    <span class="hljs-attr">files</span>: [<span class="hljs-string">'**/*.js'</span>, <span class="hljs-string">'**/*.vue'</span>],
    <span class="hljs-attr">ignores</span>: [<span class="hljs-string">'vite.config.js'</span>, <span class="hljs-string">'node_modules/'</span>, <span class="hljs-string">'dist/'</span>, <span class="hljs-string">'public/'</span>],
    <span class="hljs-attr">languageOptions</span>: {
      <span class="hljs-attr">ecmaVersion</span>: <span class="hljs-string">'latest'</span>,
      <span class="hljs-attr">sourceType</span>: <span class="hljs-string">'module'</span>,
      <span class="hljs-attr">globals</span>: {
        <span class="hljs-attr">browser</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 浏览器环境全局变量</span>
        <span class="hljs-attr">node</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// Node.js 环境全局变量</span>
        <span class="hljs-attr">es2021</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// ES2021 语法支持</span>
      }
    },
    <span class="hljs-attr">rules</span>: {
      <span class="hljs-string">'no-console'</span>: <span class="hljs-string">'warn'</span>,
      <span class="hljs-string">'no-debugger'</span>: <span class="hljs-string">'error'</span>,
      <span class="hljs-string">'no-unused-vars'</span>: [<span class="hljs-string">'warn'</span>, { <span class="hljs-attr">varsIgnorePattern</span>: <span class="hljs-string">'^_'</span> }]
    }
  },

  <span class="hljs-comment">// Vue 单文件组件专属配置</span>
  {
    <span class="hljs-attr">files</span>: [<span class="hljs-string">'**/*.vue'</span>],
    <span class="hljs-comment">// 使用 vue-eslint-parser 解析 .vue 文件</span>
    <span class="hljs-attr">languageOptions</span>: {
      <span class="hljs-attr">parser</span>: vueEslintParser,
      <span class="hljs-attr">parserOptions</span>: {
        <span class="hljs-attr">parser</span>: <span class="hljs-string">'espree'</span>, <span class="hljs-comment">// 解析 &lt;script&gt; 块内的 JavaScript</span>
        <span class="hljs-attr">ecmaVersion</span>: <span class="hljs-string">'latest'</span>,
        <span class="hljs-attr">sourceType</span>: <span class="hljs-string">'module'</span>
      }
    },
    <span class="hljs-attr">plugins</span>: {
      <span class="hljs-attr">vue</span>: eslintPluginVue
    },
    <span class="hljs-attr">rules</span>: {
      <span class="hljs-comment">// 启用 Vue 官方推荐规则</span>
      ...eslintPluginVue.<span class="hljs-property">configs</span>[<span class="hljs-string">'flat/recommended'</span>].<span class="hljs-property">rules</span>,
      <span class="hljs-comment">// 自定义 Vue 规则</span>
      <span class="hljs-string">'vue/multi-word-component-names'</span>: <span class="hljs-string">'off'</span> <span class="hljs-comment">// 关闭组件名必须多单词的要求</span>
    }
  },
  <span class="hljs-comment">//prettier配置</span>
  eslintPluginPrettierRecommended
]
</code></pre>
<p>此时运行</p>
<pre><code class="hljs language-shell" lang="shell">npm run lint
</code></pre>
<p>可以对不符合规则的代码检查，包含不符合<code>eslint</code>规则的</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03c23319426b4f6d86115eea28bbe3b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTXJfU3dpbGRlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823740&amp;x-signature=5ietbj%2FFYai2fzTxhmmDQi%2Bv82I%3D" alt="image.png" loading="lazy"/></p>
<p>4.配置vscode插件<code>eslint</code>和<code>Prettier ESlint</code>，设置默认格式化工具为<code>Prettier ESlint</code>，让<code>eslint</code>直接报错<code>prettier</code>中的配置，有时修改了<code>.prettierrc</code>中的配置需要重启<code>Prettier ESlint</code>插件才能生效。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5991155e944d43e8a514563f1cf7d674~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTXJfU3dpbGRlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823740&amp;x-signature=WlILNcFyOppEaY4XsUO1tfyjRZM%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca06d152bbfe4152be64ba9accbe17ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTXJfU3dpbGRlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823740&amp;x-signature=H4K5RzLd9rlKbrhHdippKxV6dfM%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>对于<code>.eslintignore</code>文件缺失时<code>eslint</code>会使用<code>.gitignore</code>文件</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[XMLHttpRequest、AJAX、Fetch 与 Axios]]></title>    <link>https://juejin.cn/post/7585463195201355826</link>    <guid>https://juejin.cn/post/7585463195201355826</guid>    <pubDate>2025-12-20T08:20:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463195201355826" data-draft-id="7585686247269482505" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="XMLHttpRequest、AJAX、Fetch 与 Axios"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T08:20:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户5427784851540"/> <meta itemprop="url" content="https://juejin.cn/user/224762173330942"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            XMLHttpRequest、AJAX、Fetch 与 Axios
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/224762173330942/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户5427784851540
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:20:09.000Z" title="Sat Dec 20 2025 08:20:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在现代 Web 开发中，前端与后端的数据交互是构建动态应用的核心。围绕这一需求，诞生了多个关键技术与工具：<strong>XMLHttpRequest（XHR）</strong> 、<strong>AJAX</strong>、<strong>Axios</strong> 和 <strong>Fetch API</strong>。它们之间既有历史演进关系，也有功能重叠与互补。本文将系统梳理四者的关系，深入剖析 XHR 的工作机制与 Fetch 的底层原理，并结合 Vue 3 开发实践，提供一套完整的前端网络通信知识体系。</p>
<hr/>
<h2 data-id="heading-0">一、核心概念与层级关系</h2>
<h3 data-id="heading-1">1.1 AJAX：一种编程范式（不是技术）</h3>
<ul>
<li><strong>全称</strong>：Asynchronous JavaScript and XML</li>
<li><strong>本质</strong>：<strong>一种开发模式</strong>，指在不刷新页面的情况下，通过 JavaScript 异步与服务器交换数据并更新部分网页内容。</li>
<li><strong>核心思想</strong>：解耦 UI 更新与数据获取，提升用户体验。</li>
</ul>
<blockquote>
<p>✅ <strong>关键点</strong>：<br/>
AJAX 不是某个具体 API，而是一种<strong>使用现有技术实现异步通信的策略</strong>。<br/>
实现 AJAX 的核心技术就是 <code>XMLHttpRequest</code>。</p>
</blockquote>
<h3 data-id="heading-2">1.2 XMLHttpRequest（XHR）：浏览器原生 API</h3>
<ul>
<li>
<p><strong>角色</strong>：<strong>实现 AJAX 的底层工具</strong></p>
</li>
<li>
<p><strong>功能</strong>：提供浏览器与服务器进行 HTTP 通信的能力</p>
</li>
<li>
<p><strong>特点</strong>：</p>
<ul>
<li>基于回调（事件驱动）</li>
<li>支持进度监控、取消请求、上传/下载</li>
<li>兼容性极好（IE7+）</li>
</ul>
</li>
</ul>
<blockquote>
<p>📌 <strong>关系</strong>：<br/>
<strong>XHR 是 AJAX 的“引擎”</strong> 。没有 XHR，就没有现代意义上的 AJAX。</p>
</blockquote>
<h3 data-id="heading-3">1.3 Axios：基于 Promise 的 HTTP 客户端库</h3>
<ul>
<li>
<p><strong>定位</strong>：<strong>对 XHR 的封装与增强</strong></p>
</li>
<li>
<p><strong>核心特性</strong>：</p>
<ul>
<li>返回 Promise，支持 async/await</li>
<li>自动转换 JSON 数据</li>
<li>拦截器（请求/响应）</li>
<li>客户端支持 XSRF 防护</li>
<li>浏览器 + Node.js 双端支持</li>
</ul>
</li>
<li>
<p><strong>底层实现</strong>：在浏览器中<strong>默认使用 XHR</strong>，在 Node.js 中使用 <code>http</code> 模块</p>
</li>
</ul>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// Axios 内部简化逻辑</span>
function <span class="hljs-built_in">axios</span>(config) {
  return new <span class="hljs-built_in">Promise</span>((resolve, reject) =&gt; {
    const xhr = new <span class="hljs-built_in">XMLHttpRequest</span>();
    xhr<span class="hljs-selector-class">.open</span>(config.method, config.url);
    xhr<span class="hljs-selector-class">.send</span>(config.data);
    xhr<span class="hljs-selector-class">.onload</span> = () =&gt; <span class="hljs-built_in">resolve</span>(xhr.response);
    xhr<span class="hljs-selector-class">.onerror</span> = () =&gt; <span class="hljs-built_in">reject</span>(xhr.statusText);
  });
}
</code></pre>
<blockquote>
<p>✅ <strong>关系</strong>：<br/>
<strong>Axios 是 XHR 的现代化封装</strong>，让开发者用更简洁的语法享受 XHR 的全部能力。</p>
</blockquote>
<h3 data-id="heading-4">1.4 Fetch API：浏览器新一代原生 API</h3>
<ul>
<li>
<p><strong>定位</strong>：<strong>XHR 的官方继任者</strong></p>
</li>
<li>
<p><strong>设计目标</strong>：</p>
<ul>
<li>基于 Promise，符合现代 JS 编程习惯</li>
<li>更简洁的 API 设计</li>
<li>更好的流（Stream）支持</li>
<li>统一请求/响应模型（Request/Response 对象）</li>
</ul>
</li>
<li>
<p><strong>底层实现</strong>：<strong>并非基于 XHR</strong>，而是直接调用浏览器的网络层（如 Chromium 的 <code>blink::WebURLLoader</code>）</p>
</li>
</ul>
<blockquote>
<p>⚠️ <strong>重要区别</strong>：<br/>
Fetch <strong>不是 XHR 的封装</strong>，而是<strong>全新的底层实现</strong>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-5">二、四者关系图谱</h2>
<pre><code class="hljs language-scss" lang="scss">                          ┌──────────────┐
                          │    AJAX      │ ←── 编程范式（异步通信思想）
                          └──────┬───────┘
                                 │
         ┌───────────────────────┼───────────────────────┐
         │                       │                       │
┌────────▼────────┐   ┌──────────▼──────────┐   ┌────────▼────────┐
│ XMLHttpRequest  │   │       Fetch API     │   │      Axios      │
│ (原生, 回调式)   │   │ (原生, Promise式)   │   │ (第三方库, Promise)│
└────────┬────────┘   └─────────────────────┘   └────────┬────────┘
         │                                               │
         └───────────────────────┬───────────────────────┘
                                 │
                   ┌─────────────▼─────────────┐
                   │   现代 Web 应用数据通信    │
                   └───────────────────────────┘
</code></pre>
<blockquote>
<p>🔑 <strong>总结关系</strong>：</p>
<ul>
<li><strong>AJAX</strong> 是思想，<strong>XHR/Fetch</strong> 是实现该思想的原生工具</li>
<li><strong>Axios</strong> 是对 XHR（浏览器端）的高级封装</li>
<li><strong>Fetch</strong> 是浏览器提供的、与 XHR 并列的新一代原生 API</li>
</ul>
</blockquote>
<hr/>
<h2 data-id="heading-6">三、XMLHttpRequest 详解</h2>
<h3 data-id="heading-7">3.1 基本使用流程</h3>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">xhr</span> = new XMLHttpRequest()<span class="hljs-comment">;</span>
xhr.open('GET', '/api/users', true)<span class="hljs-comment">;</span>
xhr.setRequestHeader('Content-Type', 'application/json')<span class="hljs-comment">;</span>
<span class="hljs-attr">xhr.onreadystatechange</span> = function() {
  if (<span class="hljs-attr">xhr.readyState</span> === <span class="hljs-number">4</span> &amp;&amp; xhr.status === <span class="hljs-number">200</span>) {
    console.log(xhr.responseText)<span class="hljs-comment">;</span>
  }
}<span class="hljs-comment">;</span>
xhr.send()<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-8">3.2 核心属性</h3>





























<table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td><code>readyState</code></td><td>请求状态（0–4）</td></tr><tr><td><code>status</code> / <code>statusText</code></td><td>HTTP 状态码与描述</td></tr><tr><td><code>responseText</code></td><td>字符串响应体</td></tr><tr><td><code>response</code></td><td>根据 <code>responseType</code> 解析后的数据</td></tr><tr><td><code>responseType</code></td><td>响应类型（<code>json</code>、<code>blob</code>、<code>arraybuffer</code> 等）</td></tr></tbody></table>
<h3 data-id="heading-9">3.3 事件模型</h3>
<ul>
<li>
<p><strong>传统方式</strong>：<code>onreadystatechange</code>（需手动判断 <code>readyState</code>）</p>
</li>
<li>
<p><strong>现代方式</strong>（推荐）：</p>
<ul>
<li><code>onload</code>：请求完成</li>
<li><code>onerror</code>：网络错误</li>
<li><code>ontimeout</code>：超时</li>
<li><code>onabort</code>：被中止</li>
</ul>
</li>
</ul>
<h3 data-id="heading-10">3.4 高级功能</h3>
<ul>
<li><strong>超时控制</strong>：<code>xhr.timeout = 5000</code></li>
<li><strong>跨域凭据</strong>：<code>xhr.withCredentials = true</code></li>
<li><strong>上传进度</strong>：<code>xhr.upload.onprogress</code></li>
<li><strong>中止请求</strong>：<code>xhr.abort()</code></li>
</ul>
<h3 data-id="heading-11">3.5 实际应用场景</h3>
<h4 data-id="heading-12">文件上传（带进度）</h4>
<pre><code class="hljs language-ini" lang="ini">function uploadFile(file) {
  const <span class="hljs-attr">formData</span> = new FormData()<span class="hljs-comment">;</span>
  formData.append('file', file)<span class="hljs-comment">;</span>
  
  const <span class="hljs-attr">xhr</span> = new XMLHttpRequest()<span class="hljs-comment">;</span>
  xhr.open('POST', '/upload')<span class="hljs-comment">;</span>
  
  <span class="hljs-attr">xhr.upload.onprogress</span> = (e) =&gt; {
    if (e.lengthComputable) {
      const <span class="hljs-attr">percent</span> = (e.loaded / e.total) * <span class="hljs-number">100</span><span class="hljs-comment">;</span>
      updateProgress(percent)<span class="hljs-comment">;</span>
    }
  }<span class="hljs-comment">;</span>
  
  <span class="hljs-attr">xhr.onload</span> = () =&gt; {
    if (<span class="hljs-attr">xhr.status</span> === <span class="hljs-number">200</span>) showSuccess()<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
  
  xhr.send(formData)<span class="hljs-comment">;</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-13">四、Fetch API 原理深度解析</h2>
<h3 data-id="heading-14">4.1 核心设计：基于 Stream 的请求/响应模型</h3>
<p>Fetch 的核心是两个构造函数：</p>
<ul>
<li><code>Request</code>：表示 HTTP 请求</li>
<li><code>Response</code>：表示 HTTP 响应</li>
</ul>
<p>两者都实现了 <strong>Body mixin</strong>，包含可读流（ReadableStream）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(response.<span class="hljs-property">body</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">ReadableStream</span>); <span class="hljs-comment">// true</span>
    <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>(); <span class="hljs-comment">// 内部读取 body 流并解析</span>
  });
</code></pre>
<blockquote>
<p>💡 <strong>关键机制</strong>：<br/>
Fetch 将响应体视为<strong>流（Stream）</strong> ，支持边下载边处理，适合大文件或实时数据。</p>
</blockquote>
<h3 data-id="heading-15">4.2 执行流程（浏览器内部）</h3>
<p>以 Chromium 为例：</p>
<ol>
<li>调用 <code>fetch(url)</code> → 创建 <code>Request</code> 对象</li>
<li>浏览器主线程 → 网络服务线程（Network Service）</li>
<li>网络线程发起 HTTP 请求（复用连接池、DNS 缓存等）</li>
<li>收到响应头 → 立即 resolve Promise（返回 <code>Response</code> 对象）</li>
<li>响应体通过 <strong>ReadableStream</strong> 逐步传输到 JS 主线程</li>
<li>调用 <code>.json()</code> / <code>.text()</code> 等方法 → 消费流并解析</li>
</ol>
<h3 data-id="heading-16">4.3 与 XHR 的关键差异</h3>



































<table><thead><tr><th>特性</th><th>XHR</th><th>Fetch</th></tr></thead><tbody><tr><td><strong>错误处理</strong></td><td>网络错误 → <code>onerror</code>；HTTP 错误（404/500）→ <code>onload</code></td><td><strong>仅网络错误 reject</strong>；HTTP 错误仍 resolve（需手动检查 <code>response.ok</code>）</td></tr><tr><td><strong>Cookie 发送</strong></td><td>同域自动发送</td><td>需显式设置 <code>credentials: 'same-origin'</code></td></tr><tr><td><strong>取消请求</strong></td><td><code>xhr.abort()</code></td><td><code>AbortController</code></td></tr><tr><td><strong>上传进度</strong></td><td>原生 <code>upload.onprogress</code></td><td><strong>不支持</strong>（需自定义 <code>ReadableStream</code>，复杂）</td></tr><tr><td><strong>超时控制</strong></td><td><code>xhr.timeout</code></td><td>需配合 <code>AbortController</code> + <code>setTimeout</code></td></tr></tbody></table>
<h4 data-id="heading-17">错误处理对比示例：</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Fetch：HTTP 404 仍 resolve</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/not-found'</span>)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (!res.<span class="hljs-property">ok</span>) { <span class="hljs-comment">// 必须手动检查</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`HTTP <span class="hljs-subst">${res.status}</span>`</span>);
    }
  })
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
    <span class="hljs-comment">// 只有网络断开才会进入这里</span>
  });
</code></pre>
<h3 data-id="heading-18">4.4 Fetch 的局限性与解决方案</h3>
<h4 data-id="heading-19">问题 1：无法监控下载进度</h4>
<p><strong>解决方案</strong>：手动读取流并计算进度：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">response</span> = await fetch(<span class="hljs-string">'/large-file'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">contentLength</span> = +response.headers.get(<span class="hljs-string">'Content-Length'</span>)<span class="hljs-comment">;</span>
let <span class="hljs-attr">loaded</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>

const <span class="hljs-attr">reader</span> = response.body.getReader()<span class="hljs-comment">;</span>
while (true) {
  const { done, value } = await reader.read()<span class="hljs-comment">;</span>
  if (done) break<span class="hljs-comment">;</span>
  loaded += value.length<span class="hljs-comment">;</span>
  const <span class="hljs-attr">progress</span> = (loaded / contentLength) * <span class="hljs-number">100</span><span class="hljs-comment">;</span>
  updateProgress(progress)<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-20">问题 2：无内置超时</h4>
<p><strong>解决方案</strong>：结合 <code>AbortController</code>：</p>
<pre><code class="hljs language-scss" lang="scss">const controller = new <span class="hljs-built_in">AbortController</span>();
const timeoutId = <span class="hljs-built_in">setTimeout</span>(() =&gt; controller<span class="hljs-selector-class">.abort</span>(), <span class="hljs-number">5000</span>);

<span class="hljs-built_in">fetch</span>('/api/data', { signal: controller.signal })
  <span class="hljs-selector-class">.finally</span>(() =&gt; <span class="hljs-built_in">clearTimeout</span>(timeoutId));
</code></pre>
<hr/>
<h2 data-id="heading-21">五、Vue 3 中的网络通信实践</h2>
<p>虽然 Vue 本身不强制使用特定 HTTP 客户端，但其组合式 API 与现代请求库天然契合。</p>
<h3 data-id="heading-22">5.1 使用 Axios（推荐用于复杂项目）</h3>
<pre><code class="hljs language-ini" lang="ini">// composables/useApi.js
import axios from 'axios'<span class="hljs-comment">;</span>

const <span class="hljs-attr">api</span> = axios.create({
  baseURL: '/api',
  timeout: 10000,
  withCredentials: true
})<span class="hljs-comment">;</span>

// 请求拦截器
api.interceptors.request.use(<span class="hljs-attr">config</span> =&gt; {
  const <span class="hljs-attr">token</span> = localStorage.getItem(<span class="hljs-string">'token'</span>)<span class="hljs-comment">;</span>
  if (token) <span class="hljs-attr">config.headers.Authorization</span> = `Bearer <span class="hljs-variable">${token}</span>`<span class="hljs-comment">;</span>
  return config<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>

// 响应拦截器
api.interceptors.response.use(
  <span class="hljs-attr">response</span> =&gt; response.data,
  <span class="hljs-attr">error</span> =&gt; {
    if (error.response?.<span class="hljs-attr">status</span> === <span class="hljs-number">401</span>) {
      // 处理未授权
      router.push('/login')<span class="hljs-comment">;</span>
    }
    return Promise.reject(error)<span class="hljs-comment">;</span>
  }
)<span class="hljs-comment">;</span>

export default api<span class="hljs-comment">;</span>
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 在组件中使用 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> api <span class="hljs-keyword">from</span> <span class="hljs-string">'@/composables/useApi'</span>;

<span class="hljs-keyword">const</span> users = <span class="hljs-title function_">ref</span>([]);
<span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);

<span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchUsers</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">try</span> {
    users.<span class="hljs-property">value</span> = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/users'</span>);
  } <span class="hljs-keyword">finally</span> {
    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
  }
};

<span class="hljs-title function_">fetchUsers</span>();
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-23">5.2 使用 Fetch（轻量级项目）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// utils/request.js</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">request</span>(<span class="hljs-params">url, options = {}</span>) {
  <span class="hljs-keyword">const</span> config = {
    <span class="hljs-attr">credentials</span>: <span class="hljs-string">'include'</span>,
    ...options,
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
      ...options.<span class="hljs-property">headers</span>
    }
  };

  <span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
  <span class="hljs-keyword">const</span> timeoutId = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> controller.<span class="hljs-title function_">abort</span>(), <span class="hljs-number">10000</span>);
  
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(url, {
      ...config,
      <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span>
    });
    
    <span class="hljs-built_in">clearTimeout</span>(timeoutId);
    
    <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`HTTP <span class="hljs-subst">${response.status}</span>`</span>);
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-built_in">clearTimeout</span>(timeoutId);
    <span class="hljs-keyword">throw</span> error;
  }
}

<span class="hljs-keyword">export</span> { request };
</code></pre>
<h3 data-id="heading-24">5.3 封装为 Composable（最佳实践）</h3>
<pre><code class="hljs language-ini" lang="ini">// composables/useFetch.js
import { ref } from 'vue'<span class="hljs-comment">;</span>

export function useFetch(url) {
  const <span class="hljs-attr">data</span> = ref(null)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">loading</span> = ref(<span class="hljs-literal">false</span>)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">error</span> = ref(null)<span class="hljs-comment">;</span>

  const <span class="hljs-attr">execute</span> = async () =&gt; {
    <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">error.value</span> = null<span class="hljs-comment">;</span>
    
    try {
      const <span class="hljs-attr">res</span> = await fetch(url)<span class="hljs-comment">;</span>
      if (!res.ok) throw new Error(res.statusText)<span class="hljs-comment">;</span>
      <span class="hljs-attr">data.value</span> = await res.json()<span class="hljs-comment">;</span>
    } catch (err) {
      <span class="hljs-attr">error.value</span> = err<span class="hljs-comment">;</span>
    } finally {
      <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
    }
  }<span class="hljs-comment">;</span>

  return { data, loading, error, execute }<span class="hljs-comment">;</span>
}
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useFetch } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/composables/useFetch'</span>;

<span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: users, loading, execute } = <span class="hljs-title function_">useFetch</span>(<span class="hljs-string">'/api/users'</span>);
<span class="hljs-title function_">execute</span>();
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<hr/>
<h2 data-id="heading-25">六、如何选择？—— 使用场景建议</h2>








































<table><thead><tr><th>场景</th><th>推荐方案</th><th>理由</th></tr></thead><tbody><tr><td><strong>新项目（现代浏览器）</strong></td><td><code>fetch()</code> + 工具函数封装</td><td>原生支持，无依赖，符合标准</td></tr><tr><td><strong>需要上传/下载进度</strong></td><td><code>XMLHttpRequest</code> 或 Axios</td><td>原生支持 <code>onprogress</code>，简单可靠</td></tr><tr><td><strong>复杂拦截、转换、兼容 Node.js</strong></td><td><code>Axios</code></td><td>功能全面，生态成熟</td></tr><tr><td><strong>维护旧项目（IE11+）</strong></td><td><code>XMLHttpRequest</code> 或 Axios（带 polyfill）</td><td>最大兼容性</td></tr><tr><td><strong>轻量级应用，避免打包体积</strong></td><td><code>fetch()</code></td><td>无需引入第三方库</td></tr><tr><td><strong>Vue 3 项目</strong></td><td><strong>Axios（复杂）</strong> 或 <strong>Fetch + Composable（简单）</strong></td><td>与组合式 API 完美契合</td></tr></tbody></table>
<blockquote>
<p>📌 <strong>现代最佳实践</strong>：</p>
<ul>
<li>优先使用 <code>fetch()</code> 或 Axios</li>
<li>将网络逻辑封装为 Composable，实现逻辑复用</li>
<li>避免直接使用裸 XHR（除非特殊需求）</li>
</ul>
</blockquote>
<hr/>
<h2 data-id="heading-26">七、安全与性能注意事项</h2>
<h3 data-id="heading-27">7.1 安全</h3>
<ul>
<li><strong>XSS 防护</strong>：永远不要将响应直接插入 <code>innerHTML</code></li>
<li><strong>CSRF 防护</strong>：使用 anti-CSRF token，重要操作用非 GET 方法</li>
<li><strong>CORS 策略</strong>：服务器严格限制 <code>Access-Control-Allow-Origin</code></li>
<li><strong>敏感数据</strong>：使用 HTTPS，避免客户端存储密码/token</li>
</ul>
<h3 data-id="heading-28">7.2 性能</h3>
<ul>
<li><strong>缓存策略</strong>：合理设置 <code>Cache-Control</code> 头</li>
<li><strong>请求合并</strong>：避免频繁小请求</li>
<li><strong>懒加载</strong>：非关键数据延迟请求</li>
<li><strong>取消冗余请求</strong>：组件销毁时中止未完成的请求</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Vue 3 中取消请求</span>
<span class="hljs-keyword">import</span> { onUnmounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useFetch</span>(<span class="hljs-params">url</span>) {
  <span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
  
  <span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
    controller.<span class="hljs-title function_">abort</span>(); <span class="hljs-comment">// 组件卸载时取消请求</span>
  });
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">execute</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(url, { <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span> });
  };
  
  <span class="hljs-keyword">return</span> { execute };
}
</code></pre>
<hr/>
<h2 data-id="heading-29">结语</h2>
<p>理解 XHR、AJAX、Axios 与 Fetch 的关系，本质上是理解 Web 异步通信技术的演进史：</p>
<ul>
<li><strong>AJAX</strong> 提出了“异步更新”的思想</li>
<li><strong>XHR</strong> 提供了首个标准化实现</li>
<li><strong>Axios</strong> 在 XHR 基础上构建了开发者友好的抽象</li>
<li><strong>Fetch</strong> 则代表了浏览器厂商对下一代网络 API 的重新设计</li>
</ul>
<p>作为开发者，我们不必拘泥于某一种工具，而应根据项目需求、浏览器支持和功能复杂度做出合理选择。但无论使用哪种方式，其背后的核心原理——<strong>HTTP 协议、CORS 安全模型、异步编程范式</strong>——始终不变。</p>
<p>在 Vue 3 的组合式 API 时代，将网络逻辑封装为可复用的 Composable，不仅能提升代码可维护性，更能充分发挥现代 JavaScript 的表达力。掌握这些底层逻辑，才能在技术变迁中游刃有余，构建出高性能、高安全性的现代 Web 应用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[脚手架开发工具——判断文件是否存在 path-exists]]></title>    <link>https://juejin.cn/post/7585400495684124714</link>    <guid>https://juejin.cn/post/7585400495684124714</guid>    <pubDate>2025-12-20T08:23:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585400495684124714" data-draft-id="7585474459776286756" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="脚手架开发工具——判断文件是否存在  path-exists"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T08:23:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="code_YuJun"/> <meta itemprop="url" content="https://juejin.cn/user/3615612462441358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            脚手架开发工具——判断文件是否存在  path-exists
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3615612462441358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    code_YuJun
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:23:02.000Z" title="Sat Dec 20 2025 08:23:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">简介</h2>
<p><code>path-exists</code> 是一个轻量级的 Node.js npm 包，其<strong>核心作用是简便、高效地检查文件系统中指定的路径（文件或目录）是否存在</strong>，无需开发者手动封装原生文件操作的回调逻辑或错误处理，简化了 Node.js 中的路径存在性校验场景。</p>
<h3 data-id="heading-1">核心用法</h3>
<pre><code class="hljs language-lua" lang="lua">npm install <span class="hljs-built_in">path</span>-exists <span class="hljs-comment">--save</span>
</code></pre>
<ul>
<li>异步用法（推荐，非阻塞 I/O）</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> pathExists = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path-exists'</span>);

<span class="hljs-comment">// 异步检查文件路径是否存在</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">checkFilePath</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 传入要检查的文件/目录路径（相对路径或绝对路径均可）</span>
  <span class="hljs-keyword">const</span> isExist = <span class="hljs-keyword">await</span> <span class="hljs-title function_">pathExists</span>(<span class="hljs-string">'./test.txt'</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'文件是否存在：'</span>, isExist); <span class="hljs-comment">// 返回 true 或 false</span>
}

<span class="hljs-title function_">checkFilePath</span>();

<span class="hljs-comment">// 也可使用 Promise 链式调用（兼容旧版语法）</span>
<span class="hljs-title function_">pathExists</span>(<span class="hljs-string">'./dist/'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">exists</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'目录是否存在：'</span>, exists);
});
</code></pre>
<ul>
<li>同步用法（适用于简单脚本，阻塞 I/O）</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">pathExists</span> = require(<span class="hljs-string">'path-exists'</span>)<span class="hljs-comment">;</span>

// 同步检查目录路径是否存在
const <span class="hljs-attr">dirExists</span> = pathExists.sync(<span class="hljs-string">'./node_modules/'</span>)<span class="hljs-comment">;</span>
console.log('node_modules 目录是否存在：', dirExists)<span class="hljs-comment">; // 返回 true 或 false</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[linux搭建hadoop服务]]></title>    <link>https://juejin.cn/post/7585474459776385060</link>    <guid>https://juejin.cn/post/7585474459776385060</guid>    <pubDate>2025-12-20T08:27:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585474459776385060" data-draft-id="7585474459776172068" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="linux搭建hadoop服务"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-20T08:27:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苏三的开发日记"/> <meta itemprop="url" content="https://juejin.cn/user/4248949048749213"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            linux搭建hadoop服务
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4248949048749213/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苏三的开发日记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:27:37.000Z" title="Sat Dec 20 2025 08:27:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.创建xsync与jpsall</h2>
<p>mkdir -p /home/atguigu/bin</p>
<p>vim xsync</p>
<pre><code class="hljs language-js" lang="js">#!<span class="hljs-regexp">/bin/</span>bash

# <span class="hljs-number">1.</span> 判断参数个数
<span class="hljs-keyword">if</span> [ $# -lt <span class="hljs-number">1</span> ]; then
    echo <span class="hljs-string">"Not Enough Arguement!"</span>
    exit <span class="hljs-number">1</span>
fi

# <span class="hljs-number">2.</span> 遍历集群所有机器
<span class="hljs-keyword">for</span> host <span class="hljs-keyword">in</span> hadoop102 hadoop103 hadoop104; <span class="hljs-keyword">do</span>
    echo <span class="hljs-string">"==================== $host ===================="</span>

    # <span class="hljs-number">3.</span> 遍历所有目录，挨个发送
    <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> <span class="hljs-string">"$@"</span>; <span class="hljs-keyword">do</span>
        # <span class="hljs-number">4.</span> 判断文件是否存在
        <span class="hljs-keyword">if</span> [ -e <span class="hljs-string">"$file"</span> ]; then
            # <span class="hljs-number">5.</span> 获取父目录
            pdir=$(cd -P <span class="hljs-string">"$(dirname "</span>$file<span class="hljs-string">")"</span>; pwd)
            # <span class="hljs-number">6.</span> 获取当前文件的名称
            fname=$(basename <span class="hljs-string">"$file"</span>)

            ssh <span class="hljs-string">"$host"</span> <span class="hljs-string">"mkdir -p $pdir"</span>
            rsync -av <span class="hljs-string">"$pdir/$fname"</span> <span class="hljs-string">"$host:$pdir"</span>
        <span class="hljs-keyword">else</span>
            echo <span class="hljs-string">"$file does not exist!"</span>
        fi
    done
done
</code></pre>
<p>vim jpsall</p>
<pre><code class="hljs language-js" lang="js">#!<span class="hljs-regexp">/bin/</span>bash

<span class="hljs-keyword">for</span> host <span class="hljs-keyword">in</span> hadoop102 hadoop103 hadoop104

<span class="hljs-keyword">do</span>

echo =============== $host ===============

ssh $host jps

done
</code></pre>
<h2 data-id="heading-1">2.编辑/etc/profile.d/my_env.sh</h2>
<pre><code class="hljs language-js" lang="js">#<span class="hljs-variable constant_">JAVA_HOME</span>
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">JAVA_HOME</span>=<span class="hljs-regexp">/opt/m</span>odule/jdk1<span class="hljs-number">.8</span><span class="hljs-number">.0_212</span>
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">PATH</span>=<span class="hljs-attr">$PATH</span>:$JAVA_HOME/bin
#<span class="hljs-variable constant_">HADOOP_HOME</span>
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">HADOOP_HOME</span>=<span class="hljs-regexp">/opt/m</span>odule/hadoop-<span class="hljs-number">3.1</span><span class="hljs-number">.3</span>
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">PATH</span>=<span class="hljs-attr">$PATH</span>:$HADOOP_HOME/bin
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">PATH</span>=<span class="hljs-attr">$PATH</span>:$HADOOP_HOME/sbin
#<span class="hljs-variable constant_">KAFKA_HOME</span>
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">KAFKA_HOME</span>=<span class="hljs-regexp">/opt/m</span>odule/kafka
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">PATH</span>=<span class="hljs-attr">$PATH</span>:$KAFKA_HOME/bin

source /etc/profile.<span class="hljs-property">d</span>/my_env.<span class="hljs-property">sh</span>
</code></pre>
<h2 data-id="heading-2">3.修改文件组</h2>
<pre><code class="hljs language-js" lang="js">在 hadoop102、hadoop103、hadoop104 都已经创建好的/opt/<span class="hljs-variable language_">module</span> 并且已经把这个目录修改为 <span class="hljs-attr">atguigu</span>:atguigu

<span class="hljs-number">102</span>服务器: sudo chown <span class="hljs-attr">atguigu</span>:atguigu -R /opt/<span class="hljs-variable language_">module</span>

scp -r /opt/<span class="hljs-variable language_">module</span>/jdk1<span class="hljs-number">.8</span><span class="hljs-number">.0_212</span> atguigu@<span class="hljs-attr">hadoop103</span>:<span class="hljs-regexp">/opt/m</span>odule

scp -r /opt/<span class="hljs-variable language_">module</span>/jdk1<span class="hljs-number">.8</span><span class="hljs-number">.0_212</span> atguigu@<span class="hljs-attr">hadoop104</span>:<span class="hljs-regexp">/opt/m</span>odule
</code></pre>
<h2 data-id="heading-3">4.修改hadoop相关配置文件</h2>
<p>cd $HADOOP_HOME/etc/hadoop</p>
<p>编辑 core-site.xml</p>
<pre><code class="hljs language-js" lang="js">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;
&lt;?xml-stylesheet type=<span class="hljs-string">"text/xsl"</span> href=<span class="hljs-string">"configuration.xsl"</span>?&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- 指定 NameNode 的地址 --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>fs.defaultFS<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>hdfs://hadoop102:8020<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- 指定 hadoop 数据的存储目录 --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>hadoop.tmp.dir<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>/opt/module/hadoop-3.1.3/data<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- 配置 HDFS 网页登录使用的静态用户为 atguigu --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>hadoop.http.staticuser.user<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>atguigu<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span></span>
</code></pre>
<p>编辑 hdfs-site.xml</p>
<pre><code class="hljs language-js" lang="js">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;
&lt;?xml-stylesheet type=<span class="hljs-string">"text/xsl"</span> href=<span class="hljs-string">"configuration.xsl"</span>?&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
<span class="hljs-comment">&lt;!-- nn web 端访问地址--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>dfs.namenode.http-address<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>hadoop102:9870<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
<span class="hljs-comment">&lt;!-- 2nn web 端访问地址--&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>dfs.namenode.secondary.http-address<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>hadoop104:9868<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span></span>
</code></pre>
<p>编辑 yarn-site.xml</p>
<pre><code class="hljs language-js" lang="js">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;
&lt;?xml-stylesheet type=<span class="hljs-string">"text/xsl"</span> href=<span class="hljs-string">"configuration.xsl"</span>?&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- 指定 MR 走 shuffle --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.nodemanager.aux-services<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>mapreduce_shuffle<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- 指定 ResourceManager 的地址--&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.resourcemanager.hostname<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>hadoop103<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- 环境变量的继承 --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.nodemanager.env-whitelist<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>JAVA_HOME,HADOOP_COMMON_HOME,HADOOP_HDFS_HOME,HADOOP_CONF_DIR,CLASSPATH_PREPEND_DISTCACHE,HADOOP_YARN_HOME,HADOOP_MAPRED_HOME<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- 开启日志聚集功能 --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.log-aggregation-enable<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- 设置日志聚集服务器地址 --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span> 
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.log.server.url<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span> 
  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>http://hadoop102:19888/jobhistory/logs<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- 设置日志保留时间为 7 天 --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.log-aggregation.retain-seconds<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>604800<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-comment">&lt;!--是否启动一个线程检查每个任务正使用的物理内存量，如果任务超出分配值，则直接将其杀掉，默认是true --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.nodemanager.pmem-check-enabled<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-comment">&lt;!--是否启动一个线程检查每个任务正使用的虚拟内存量，如果任务超出分配值，则直接将其杀掉，默认是true --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.nodemanager.vmem-check-enabled<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>    
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.log.server.url<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>http://hadoop102:19888/jobhistory/logs<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span></span>
</code></pre>
<p>编辑 mapred-site.xml</p>
<pre><code class="hljs language-js" lang="js">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;
&lt;?xml-stylesheet type=<span class="hljs-string">"text/xsl"</span> href=<span class="hljs-string">"configuration.xsl"</span>?&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
<span class="hljs-comment">&lt;!-- 指定 MapReduce 程序运行在 Yarn 上 --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>mapreduce.framework.name<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>yarn<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- 历史服务器端地址 --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>mapreduce.jobhistory.address<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>hadoop102:10020<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
 <span class="hljs-comment">&lt;!-- 历史服务器 web 端地址 --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>mapreduce.jobhistory.webapp.address<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>hadoop102:19888<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span></span>
</code></pre>
<p>xsync同步文件</p>
<pre><code class="hljs language-js" lang="js">xsync /opt/<span class="hljs-variable language_">module</span>/hadoop-<span class="hljs-number">3.1</span><span class="hljs-number">.3</span>/etc/hadoop/
</code></pre>
<p>编辑 workers添加内容</p>
<pre><code class="hljs language-js" lang="js">hadoop102
hadoop103
hadoop104

注意：该文件中添加的内容结尾不允许有空格，文件中不允许有空行
</code></pre>
<h2 data-id="heading-4">5.编写hadoop集群管理脚本</h2>
<pre><code class="hljs language-js" lang="js">#!<span class="hljs-regexp">/bin/</span>bash

<span class="hljs-keyword">if</span> [ $# -lt <span class="hljs-number">1</span> ]; then
    echo <span class="hljs-string">"No Args Input..."</span>
    exit
fi

<span class="hljs-keyword">case</span> $1 <span class="hljs-keyword">in</span>
    <span class="hljs-string">"start"</span>)
        echo <span class="hljs-string">" =================== 启动 hadoop 集群 ==================="</span>
        echo <span class="hljs-string">" --------------- 启动 hdfs ---------------"</span>
        ssh hadoop102 <span class="hljs-string">"/opt/module/hadoop-3.1.3/sbin/start-dfs.sh"</span>
        echo <span class="hljs-string">" --------------- 启动 yarn ---------------"</span>
        ssh hadoop103 <span class="hljs-string">"/opt/module/hadoop-3.1.3/sbin/start-yarn.sh"</span>
        echo <span class="hljs-string">" --------------- 启动 historyserver ---------------"</span>
        ssh hadoop102 <span class="hljs-string">"/opt/module/hadoop-3.1.3/bin/mapred --daemon start historyserver"</span>
        ;;
    <span class="hljs-string">"stop"</span>)
        echo <span class="hljs-string">" =================== 关闭 hadoop 集群 ==================="</span>
        echo <span class="hljs-string">" --------------- 关闭 historyserver ---------------"</span>
        ssh hadoop102 <span class="hljs-string">"/opt/module/hadoop-3.1.3/bin/mapred --daemon stop historyserver"</span>
        echo <span class="hljs-string">" --------------- 关闭 yarn ---------------"</span>
        ssh hadoop103 <span class="hljs-string">"/opt/module/hadoop-3.1.3/sbin/stop-yarn.sh"</span>
        echo <span class="hljs-string">" --------------- 关闭 hdfs ---------------"</span>
        ssh hadoop102 <span class="hljs-string">"/opt/module/hadoop-3.1.3/sbin/stop-dfs.sh"</span>
        ;;
    *)
        echo <span class="hljs-string">"Input Args Error..."</span>
        ;;
esac
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Promise ：从基础原理到高级实践]]></title>    <link>https://juejin.cn/post/7585686247269515273</link>    <guid>https://juejin.cn/post/7585686247269515273</guid>    <pubDate>2025-12-20T08:35:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585686247269515273" data-draft-id="7585463195201388594" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Promise ：从基础原理到高级实践"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T08:35:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户5427784851540"/> <meta itemprop="url" content="https://juejin.cn/user/224762173330942"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Promise ：从基础原理到高级实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/224762173330942/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户5427784851540
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:35:42.000Z" title="Sat Dec 20 2025 08:35:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>Promise</code> 是 JavaScript 中处理异步操作的核心机制，它解决了传统回调函数（Callback）带来的“回调地狱”（Callback Hell）问题，使异步代码更清晰、可读、可维护。自 ES6（ECMAScript 2015）正式引入以来，Promise 已成为现代前端开发的基石，并为 <code>async/await</code> 语法提供了底层支持。</p>
<hr/>
<h2 data-id="heading-0">一、为什么需要 Promise？</h2>
<h3 data-id="heading-1">1.1 回调函数的局限性</h3>
<p>在 Promise 出现之前，异步操作主要通过回调函数实现：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 嵌套回调（回调地狱）</span>
<span class="hljs-title function_">getData</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">a</span>) {
  <span class="hljs-title function_">getMoreData</span>(a, <span class="hljs-keyword">function</span>(<span class="hljs-params">b</span>) {
    <span class="hljs-title function_">getEvenMoreData</span>(b, <span class="hljs-keyword">function</span>(<span class="hljs-params">c</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(c);
    });
  });
});
</code></pre>
<p><strong>问题</strong>：</p>
<ul>
<li>代码横向扩展，难以阅读和维护</li>
<li>错误处理分散，需在每个回调中重复写 <code>try/catch</code></li>
<li>无法使用 <code>return</code> 或 <code>throw</code> 控制流程</li>
<li>多个异步操作的组合（如并行、竞态）实现复杂</li>
</ul>
<h3 data-id="heading-2">1.2 Promise 的优势</h3>
<ul>
<li><strong>链式调用</strong>：通过 <code>.then()</code> 实现线性流程</li>
<li><strong>统一错误处理</strong>：通过 <code>.catch()</code> 捕获整个链中的错误</li>
<li><strong>组合能力</strong>：支持 <code>Promise.all</code>、<code>Promise.race</code> 等高级模式</li>
<li><strong>与 async/await 无缝集成</strong></li>
</ul>
<hr/>
<h2 data-id="heading-3">二、Promise 基础概念</h2>
<h3 data-id="heading-4">2.1 什么是 Promise？</h3>
<blockquote>
<p><strong>Promise 是一个表示异步操作最终完成或失败的对象。</strong></p>
</blockquote>
<p>它有三种状态（State）：</p>
<ul>
<li><strong>pending（待定）</strong> ：初始状态，既不是成功也不是失败</li>
<li><strong>fulfilled（已成功）</strong> ：操作成功完成</li>
<li><strong>rejected（已失败）</strong> ：操作失败</li>
</ul>
<blockquote>
<p>⚠️ <strong>状态不可逆</strong>：<br/>
一旦 Promise 从 <code>pending</code> 变为 <code>fulfilled</code> 或 <code>rejected</code>，状态将<strong>永久固定</strong>，不能再改变。</p>
</blockquote>
<h3 data-id="heading-5">2.2 创建 Promise</h3>
<p>使用 <code>new Promise(executor)</code> 构造函数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
  <span class="hljs-comment">// 异步操作</span>
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> success = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() &gt; <span class="hljs-number">0.5</span>;
    <span class="hljs-keyword">if</span> (success) {
      <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'操作成功！'</span>); <span class="hljs-comment">// 将状态变为 fulfilled</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'操作失败！'</span>)); <span class="hljs-comment">// 将状态变为 rejected</span>
    }
  }, <span class="hljs-number">1000</span>);
});
</code></pre>
<ul>
<li><code>resolve(value)</code>：标记 Promise 成功，传递结果值</li>
<li><code>reject(reason)</code>：标记 Promise 失败，传递错误原因（通常为 Error 对象）</li>
</ul>
<hr/>
<h2 data-id="heading-6">三、Promise 的基本用法</h2>
<h3 data-id="heading-7">3.1 链式调用（Chaining）</h3>
<p>通过 <code>.then(onFulfilled, onRejected)</code> 处理结果：</p>
<pre><code class="hljs language-javascript" lang="javascript">promise
  .<span class="hljs-title function_">then</span>(
    <span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'成功:'</span>, result); <span class="hljs-comment">// '操作成功！'</span>
      <span class="hljs-keyword">return</span> result.<span class="hljs-title function_">toUpperCase</span>(); <span class="hljs-comment">// 返回新值，传递给下一个 then</span>
    },
    <span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'失败:'</span>, error); <span class="hljs-comment">// 不会执行（除非上一步 reject）</span>
    }
  )
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">transformedResult</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'转换后:'</span>, transformedResult); <span class="hljs-comment">// '操作成功！'</span>
  })
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
    <span class="hljs-comment">// 捕获链中任何未处理的 reject</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'捕获错误:'</span>, error);
  });
</code></pre>
<blockquote>
<p>✅ <strong>关键规则</strong>：</p>
<ul>
<li><code>.then()</code> 总是返回一个新的 Promise</li>
<li>若 <code>onFulfilled</code> 返回普通值 → 新 Promise 状态为 <code>fulfilled</code></li>
<li>若 <code>onFulfilled</code> 抛出异常 → 新 Promise 状态为 <code>rejected</code></li>
<li>若 <code>onFulfilled</code> 返回另一个 Promise → 新 Promise 跟随该 Promise 的状态</li>
</ul>
</blockquote>
<h3 data-id="heading-8">3.2 错误处理：<code>.catch()</code></h3>
<p><code>.catch(onRejected)</code> 是 <code>.then(null, onRejected)</code> 的语法糖：</p>
<pre><code class="hljs language-ini" lang="ini">fetchUserData()
  .then(<span class="hljs-attr">user</span> =&gt; processUser(user))
  .then(<span class="hljs-attr">data</span> =&gt; saveToCache(data))
  .catch(<span class="hljs-attr">error</span> =&gt; {
    // 捕获 fetchUserData、processUser 或 saveToCache 中的任何错误
    console.error('操作失败:', error.message)<span class="hljs-comment">;</span>
    showErrorMessage()<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>
</code></pre>
<blockquote>
<p>📌 <strong>最佳实践</strong>：<br/>
在链的末尾使用 <code>.catch()</code> 统一处理错误，避免在每个 <code>.then()</code> 中写错误回调。</p>
</blockquote>
<hr/>
<h2 data-id="heading-9">四、Promise 的高级特性</h2>
<h3 data-id="heading-10">4.1 静态方法</h3>
<h4 data-id="heading-11"><code>Promise.resolve(value)</code></h4>
<p>将值转为已成功的 Promise：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">42</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(v)); <span class="hljs-comment">// 42</span>
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'hello'</span>)).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(v)); <span class="hljs-comment">// 'hello'</span>
</code></pre>
<h4 data-id="heading-12"><code>Promise.reject(reason)</code></h4>
<p>创建一个已失败的 Promise：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Oops!'</span>)).<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(e.<span class="hljs-property">message</span>));
</code></pre>
<h4 data-id="heading-13"><code>Promise.all(iterable)</code></h4>
<p><strong>并行执行多个 Promise，全部成功才成功</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">promises</span> = [
  fetch(<span class="hljs-string">'/api/users'</span>),
  fetch(<span class="hljs-string">'/api/posts'</span>),
  fetch(<span class="hljs-string">'/api/comments'</span>)
]<span class="hljs-comment">;</span>

Promise.all(promises)
  .then(<span class="hljs-attr">results</span> =&gt; {
    const <span class="hljs-section">[users, posts, comments]</span> = results<span class="hljs-comment">;</span>
    renderPage(users, posts, comments)<span class="hljs-comment">;</span>
  })
  .catch(<span class="hljs-attr">error</span> =&gt; {
    // 任一请求失败，立即 reject
    console.error('加载失败:', error)<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>
</code></pre>
<blockquote>
<p>⚠️ <strong>注意</strong>：若任一 Promise reject，<code>all</code> 立即 reject，其余 Promise 仍会执行但结果被忽略。</p>
</blockquote>
<h4 data-id="heading-14"><code>Promise.allSettled(iterable)</code></h4>
<p>等待所有 Promise 完成（无论成功或失败）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">allSettled</span>(promises)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">results</span> =&gt;</span> {
    results.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">result, i</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (result.<span class="hljs-property">status</span> === <span class="hljs-string">'fulfilled'</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`请求 <span class="hljs-subst">${i}</span> 成功:`</span>, result.<span class="hljs-property">value</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`请求 <span class="hljs-subst">${i}</span> 失败:`</span>, result.<span class="hljs-property">reason</span>);
      }
    });
  });
</code></pre>
<h4 data-id="heading-15"><code>Promise.race(iterable)</code></h4>
<p><strong>返回第一个完成的 Promise（无论成功或失败）</strong> ：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> timeout = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">_, reject</span>) =&gt;</span>
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'超时'</span>)), <span class="hljs-number">5000</span>)
);

<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">race</span>([<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>), timeout])
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'数据:'</span>, data))
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'失败或超时:'</span>, error));
</code></pre>
<h4 data-id="heading-16"><code>Promise.any(iterable)</code>（ES2021）</h4>
<p>返回第一个<strong>成功</strong>的 Promise（忽略失败）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">any</span>([
  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">'A 失败'</span>),
  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'B 成功'</span>),
  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">'C 失败'</span>)
]).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value)); <span class="hljs-comment">// 'B 成功'</span>
</code></pre>
<blockquote>
<p>❗ 若全部失败，则 reject 一个 <code>AggregateError</code>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-17">五、Promise 与 async/await</h2>
<p><code>async/await</code> 是 Promise 的语法糖，使异步代码看起来像同步代码。</p>
<h3 data-id="heading-18">5.1 基本用法</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>);
    <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'请求失败'</span>);
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
    <span class="hljs-keyword">return</span> data;
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'错误:'</span>, error);
    <span class="hljs-keyword">throw</span> error; <span class="hljs-comment">// 可选择重新抛出</span>
  }
}

<span class="hljs-comment">// 调用</span>
<span class="hljs-title function_">fetchData</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data));
</code></pre>
<h3 data-id="heading-19">5.2 关键规则</h3>
<ul>
<li><code>async</code> 函数<strong>总是返回 Promise</strong></li>
<li><code>await</code> 只能在 <code>async</code> 函数内使用</li>
<li><code>await</code> 后可跟 Promise 或普通值</li>
<li>错误可通过 <code>try/catch</code> 捕获</li>
</ul>
<h3 data-id="heading-20">5.3 并行 vs 串行</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 串行（慢）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">slow</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> a = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/a'</span>);
  <span class="hljs-keyword">const</span> b = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/b'</span>);
  <span class="hljs-keyword">const</span> c = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/c'</span>);
}

<span class="hljs-comment">// ✅ 并行（快）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fast</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [a, b, c] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([
    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/a'</span>),
    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/b'</span>),
    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/c'</span>)
  ]);
}
</code></pre>
<hr/>
<h2 data-id="heading-21">六、常见陷阱与最佳实践</h2>
<h3 data-id="heading-22">6.1 陷阱 1：忘记返回 Promise</h3>
<pre><code class="hljs language-ini" lang="ini">// ❌ 错误：第二个 then 无法获取数据
fetch('/api')
  .then(<span class="hljs-attr">res</span> =&gt; res.json())
  .then(<span class="hljs-attr">data</span> =&gt; {
    processData(data)<span class="hljs-comment">; // 忘记 return</span>
  })
  .then(<span class="hljs-attr">result</span> =&gt; {
    console.log(result)<span class="hljs-comment">; // undefined!</span>
  })<span class="hljs-comment">;</span>

// ✅ 正确
fetch('/api')
  .then(<span class="hljs-attr">res</span> =&gt; res.json())
  .then(<span class="hljs-attr">data</span> =&gt; {
    return processData(data)<span class="hljs-comment">; // 显式 return</span>
  })<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-23">6.2 陷阱 2：未处理拒绝（Uncaught Rejection）</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 危险：可能被忽略，导致静默失败</span>
somePromise.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {
  <span class="hljs-comment">// ...</span>
});

<span class="hljs-comment">// ✅ 安全：始终处理错误</span>
somePromise
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> { <span class="hljs-comment">/* ... */</span> })
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> { <span class="hljs-comment">/* 处理错误 */</span> });
</code></pre>
<blockquote>
<p>🔔 <strong>Node.js 提示</strong>：未处理的 Promise rejection 会导致进程警告（未来可能终止进程）。</p>
</blockquote>
<h3 data-id="heading-24">6.3 陷阱 3：在循环中使用 await（串行而非并行）</h3>
<pre><code class="hljs language-ini" lang="ini">// ❌ 串行执行（总耗时 = 所有请求时间之和）
for (const url of urls) {
  const <span class="hljs-attr">data</span> = await fetch(url)<span class="hljs-comment">;</span>
  results.push(data)<span class="hljs-comment">;</span>
}

// ✅ 并行执行（总耗时 ≈ 最长请求时间）
const <span class="hljs-attr">promises</span> = urls.map(url =&gt; fetch(url))<span class="hljs-comment">;</span>
const <span class="hljs-attr">results</span> = await Promise.all(promises)<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-25">6.4 最佳实践</h3>
<ol>
<li><strong>始终处理错误</strong>：使用 <code>.catch()</code> 或 <code>try/catch</code></li>
<li><strong>避免嵌套 Promise</strong>：使用链式调用或 async/await</li>
<li><strong>明确返回值</strong>：在 <code>.then()</code> 中显式 <code>return</code></li>
<li><strong>合理使用组合方法</strong>：<code>all</code>、<code>race</code>、<code>allSettled</code></li>
<li><strong>不要混合回调与 Promise</strong>：统一异步风格</li>
</ol>
<hr/>
<h2 data-id="heading-26">七、Promise 的内部原理（简要）</h2>
<p>虽然开发者通常无需实现 Promise，但理解其机制有助于调试：</p>
<pre><code class="hljs language-ini" lang="ini">// 极简 Promise 实现（仅演示思路）
class SimplePromise {
  constructor(executor) {
    <span class="hljs-attr">this.state</span> = <span class="hljs-string">'pending'</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">this.value</span> = undefined<span class="hljs-comment">;</span>
    <span class="hljs-attr">this.callbacks</span> = []<span class="hljs-comment">;</span>

    const <span class="hljs-attr">resolve</span> = value =&gt; {
      if (this.state !== 'pending') return<span class="hljs-comment">;</span>
      <span class="hljs-attr">this.state</span> = <span class="hljs-string">'fulfilled'</span><span class="hljs-comment">;</span>
      <span class="hljs-attr">this.value</span> = value<span class="hljs-comment">;</span>
      this.callbacks.forEach(<span class="hljs-attr">cb</span> =&gt; cb())<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>

    const <span class="hljs-attr">reject</span> = reason =&gt; {
      if (this.state !== 'pending') return<span class="hljs-comment">;</span>
      <span class="hljs-attr">this.state</span> = <span class="hljs-string">'rejected'</span><span class="hljs-comment">;</span>
      <span class="hljs-attr">this.value</span> = reason<span class="hljs-comment">;</span>
      this.callbacks.forEach(<span class="hljs-attr">cb</span> =&gt; cb())<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>

    executor(resolve, reject)<span class="hljs-comment">;</span>
  }

  then(onFulfilled) {
    return new SimplePromise((resolve) =&gt; {
      const <span class="hljs-attr">callback</span> = () =&gt; {
        if (<span class="hljs-attr">this.state</span> === <span class="hljs-string">'fulfilled'</span>) {
          const <span class="hljs-attr">result</span> = <span class="hljs-literal">on</span>Fulfilled(this.value)<span class="hljs-comment">;</span>
          resolve(result)<span class="hljs-comment">;</span>
        }
      }<span class="hljs-comment">;</span>
      if (<span class="hljs-attr">this.state</span> === <span class="hljs-string">'pending'</span>) {
        this.callbacks.push(callback)<span class="hljs-comment">;</span>
      } else {
        callback()<span class="hljs-comment">;</span>
      }
    })<span class="hljs-comment">;</span>
  }
}
</code></pre>
<blockquote>
<p>📚 <strong>真实 Promise 更复杂</strong>：需处理微任务队列（Microtask Queue）、thenable 对象、递归解析等。</p>
</blockquote>
<hr/>
<h2 data-id="heading-27">八、在 Vue 3 中的实践</h2>
<p>Vue 3 的组合式 API 与 Promise 天然契合：</p>
<pre><code class="hljs language-ini" lang="ini">// composables/useApi.js
import { ref } from 'vue'<span class="hljs-comment">;</span>

export function useApi(url) {
  const <span class="hljs-attr">data</span> = ref(null)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">loading</span> = ref(<span class="hljs-literal">false</span>)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">error</span> = ref(null)<span class="hljs-comment">;</span>

  const <span class="hljs-attr">execute</span> = async () =&gt; {
    <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">error.value</span> = null<span class="hljs-comment">;</span>
    try {
      const <span class="hljs-attr">res</span> = await fetch(url)<span class="hljs-comment">;</span>
      if (!res.ok) throw new Error(res.statusText)<span class="hljs-comment">;</span>
      <span class="hljs-attr">data.value</span> = await res.json()<span class="hljs-comment">;</span>
    } catch (err) {
      <span class="hljs-attr">error.value</span> = err<span class="hljs-comment">;</span>
    } finally {
      <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
    }
  }<span class="hljs-comment">;</span>

  return { data, loading, error, execute }<span class="hljs-comment">;</span>
}
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useApi } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/composables/useApi'</span>;

<span class="hljs-keyword">const</span> { data, loading, error, execute } = <span class="hljs-title function_">useApi</span>(<span class="hljs-string">'/api/users'</span>);
<span class="hljs-title function_">execute</span>();
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"loading"</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else-if</span>=<span class="hljs-string">"error"</span>&gt;</span>错误: {{ error.message }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">v-else</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"user in data"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"user.id"</span>&gt;</span>{{ user.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<blockquote>
<p>✅ <strong>优势</strong>：逻辑复用、状态管理、错误处理一体化。</p>
</blockquote>
<hr/>
<h2 data-id="heading-28">结语</h2>
<p>Promise 是 JavaScript 异步编程的里程碑，它不仅解决了回调地狱问题，还为现代异步语法（async/await）奠定了基础。掌握 Promise 的核心概念、链式调用、错误处理和组合方法，是成为高效前端开发者的必经之路。</p>
<p>记住：</p>
<ul>
<li><strong>Promise 是状态机</strong>：pending → fulfilled/rejected</li>
<li><strong>链式调用是核心</strong>：每个 <code>.then()</code> 返回新 Promise</li>
<li><strong>错误必须处理</strong>：避免静默失败</li>
<li><strong>组合优于嵌套</strong>：善用 <code>Promise.all</code> 等静态方法</li>
</ul>
<p>随着 Web 应用日益复杂，异步操作无处不在。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Koa 源码深度解析：带你理解 Koa 的设计哲学和核心实现原理]]></title>    <link>https://juejin.cn/post/7585412203978833963</link>    <guid>https://juejin.cn/post/7585412203978833963</guid>    <pubDate>2025-12-20T08:42:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585412203978833963" data-draft-id="7585390679399301126" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Koa 源码深度解析：带你理解 Koa 的设计哲学和核心实现原理"/> <meta itemprop="keywords" content="Node.js"/> <meta itemprop="datePublished" content="2025-12-20T08:42:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="趴在窗边数星星"/> <meta itemprop="url" content="https://juejin.cn/user/2283029051479357"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Koa 源码深度解析：带你理解 Koa 的设计哲学和核心实现原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2283029051479357/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    趴在窗边数星星
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:42:40.000Z" title="Sat Dec 20 2025 08:42:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Koa 源码深度解析：带你理解 Koa 的设计哲学和核心实现原理</h2>
<blockquote>
<p>注：本文只讲koa源码与核心实现，无应用层相关知识</p>
</blockquote>
<h3 data-id="heading-1">一、Koa 的设计哲学</h3>
<h4 data-id="heading-2">1.1 什么是koa</h4>
<p>Koa 是由 Express 原班人马打造的下一代 Node.js Web 框架。相比于 Express，Koa 利用 ES2017 的 async/await 特性，让异步代码的编写变得更加优雅和可维护。本文将深入解析 Koa 的核心源码，帮助你理解其设计哲学和实现原理。</p>
<h4 data-id="heading-3">1.2 核心设计理念</h4>
<p>Koa 的设计理念可以概括为：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Koa 应用本质上是一个包含中间件函数数组的对象</span>
<span class="hljs-comment">// 这些中间件以类似栈的方式组合和执行</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Koa</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'koa'</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Koa</span>();

<span class="hljs-comment">// 中间件以"洋葱模型"方式执行</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-keyword">async</span> (ctx, next) =&gt; {
  <span class="hljs-comment">// 请求阶段（向下）</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();
  <span class="hljs-comment">// 响应阶段（向上）</span>
});
</code></pre>
<p>官方文档这样描述：</p>
<blockquote>
<p>A Koa application is an object containing an array of middleware functions which are composed and executed in a stack-like manner upon request.</p>
</blockquote>
<h3 data-id="heading-4">二、源码核心流程解析</h3>
<p>在深入源码之前，我们先理解一下 Koa 应用从创建到处理请求的完整生命周期。一个典型的 Koa 应用会经历以下几个阶段：</p>
<ol>
<li><strong>创建应用实例</strong> - <code>new Koa()</code> 初始化应用对象</li>
<li><strong>注册中间件</strong> - <code>app.use()</code> 将中间件函数添加到数组</li>
<li><strong>启动监听</strong> - <code>app.listen()</code> 创建 HTTP 服务并开始监听</li>
<li><strong>处理请求</strong> - 当请求到来时，组合中间件并执行</li>
</ol>
<p>接下来我们逐步剖析每个阶段的源码实现。</p>
<h4 data-id="heading-5">2.1 创建Application</h4>
<p>当我们执行 <code>const app = new Koa()</code> 时，Koa 内部做了哪些初始化工作呢？让我们看看 <code>Application</code> 类的构造函数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Application</span> {

  <span class="hljs-title function_">constructor</span> (options) {
    ......
    options = options || {}
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">compose</span> = options.<span class="hljs-property">compose</span> || compose <span class="hljs-comment">// 组合中间件的函数，这是实现洋葱模型的关键</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">middleware</span> = []                      <span class="hljs-comment">// 中间件数组，所有通过 use() 注册的中间件都会存储在这里</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(context)     <span class="hljs-comment">// 上下文对象的原型，每个请求会基于它创建独立的 ctx</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">request</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(request)     <span class="hljs-comment">// 请求对象的原型，封装了对 Node.js 原生 req 的访问</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">response</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(response);  <span class="hljs-comment">// 响应对象的原型，封装了对 Node.js 原生 res 的访问</span>
    ......
   }
</code></pre>
<p><strong>为什么使用 <code>Object.create()</code> 而不是直接赋值？</strong></p>
<p>这是一个非常巧妙的设计。使用 <code>Object.create()</code> 创建原型链，意味着：</p>
<ul>
<li>每个应用实例都有自己独立的 <code>context</code>、<code>request</code>、<code>response</code> 对象</li>
<li>这些对象继承自共享的原型，既节省内存又保证了隔离性</li>
<li>可以在不同应用实例上挂载不同的扩展属性，互不影响</li>
</ul>
<h4 data-id="heading-6">2.2 注册中间件</h4>
<p>中间件是 Koa 的核心概念。通过 <code>app.use()</code> 方法，我们可以注册各种中间件来处理请求。让我们看一个实际例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 请求日志中间件：记录请求的 URL 和响应时间</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">logMiddleware</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">ctx, next</span>) =&gt; {
  <span class="hljs-keyword">const</span> start = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();  <span class="hljs-comment">// 记录开始时间</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();              <span class="hljs-comment">// 等待后续中间件执行完毕</span>
  <span class="hljs-keyword">const</span> end = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();    <span class="hljs-comment">// 记录结束时间</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${ctx.method}</span> <span class="hljs-subst">${ctx.url}</span> - <span class="hljs-subst">${end - start}</span>ms`</span>);
};

app.<span class="hljs-title function_">use</span>(logMiddleware);

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Application</span> {
  <span class="hljs-title function_">use</span>(<span class="hljs-params">fn</span>) {
    <span class="hljs-comment">// 注册中间件：将中间件函数添加到数组末尾</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">middleware</span>.<span class="hljs-title function_">push</span>(fn);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>; <span class="hljs-comment">// 返回 this 支持链式调用</span>
  }
}
</code></pre>
<p><strong><code>use()</code> 方法的设计亮点：</strong></p>
<ol>
<li><strong>简单直接</strong> - 只是将中间件函数 push 到数组，没有复杂的逻辑</li>
<li><strong>链式调用</strong> - 返回 <code>this</code> 使得可以连续调用 <code>app.use().use().use()</code></li>
<li><strong>顺序敏感</strong> - 中间件的执行顺序取决于注册顺序，这对理解洋葱模型很重要</li>
</ol>
<p>注意上面的日志中间件示例：<code>await next()</code> 是一个分水岭，它将中间件分为"请求阶段"和"响应阶段"。这正是洋葱模型的精髓所在。</p>
<h4 data-id="heading-7">2.3 创建context</h4>
<p>每当有新的 HTTP 请求到来时，Koa 都会为这个请求创建一个全新的 <code>context</code> 对象。这个对象是 Koa 最重要的创新之一，它封装了 Node.js 原生的 <code>req</code> 和 <code>res</code>，提供了更加便捷的 API。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">createContext</span>(<span class="hljs-params">req, res</span>) {
  <span class="hljs-comment">// 基于应用的 context 原型创建新的 context 实例</span>
  <span class="hljs-keyword">const</span> context = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);
  <span class="hljs-comment">// 基于应用的 request 和 response 原型创建新的实例</span>
  <span class="hljs-keyword">const</span> request = context.<span class="hljs-property">request</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">request</span>);
  <span class="hljs-keyword">const</span> response = context.<span class="hljs-property">response</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">response</span>);

  <span class="hljs-comment">// 建立各对象之间的引用关系</span>
  context.<span class="hljs-property">app</span> = request.<span class="hljs-property">app</span> = response.<span class="hljs-property">app</span> = <span class="hljs-variable language_">this</span>;        <span class="hljs-comment">// 都持有 app 实例的引用</span>
  context.<span class="hljs-property">req</span> = request.<span class="hljs-property">req</span> = response.<span class="hljs-property">req</span> = req;         <span class="hljs-comment">// 都持有 Node.js 原生 req 的引用</span>
  context.<span class="hljs-property">res</span> = request.<span class="hljs-property">res</span> = response.<span class="hljs-property">res</span> = res;         <span class="hljs-comment">// 都持有 Node.js 原生 res 的引用</span>

  <span class="hljs-comment">// 建立 context、request、response 之间的相互引用</span>
  request.<span class="hljs-property">ctx</span> = response.<span class="hljs-property">ctx</span> = context;                   <span class="hljs-comment">// request 和 response 都能访问 context</span>
  request.<span class="hljs-property">response</span> = response;                            <span class="hljs-comment">// request 能访问 response</span>
  response.<span class="hljs-property">request</span> = request;                             <span class="hljs-comment">// response 能访问 request</span>

  <span class="hljs-keyword">return</span> context;
}

</code></pre>
<p><strong>这个方法的精妙之处：</strong></p>
<ol>
<li><strong>原型继承</strong> - 使用 <code>Object.create()</code> 确保每个请求都有独立的 context，但共享原型上的方法</li>
<li><strong>四层封装</strong> - <code>context</code> → <code>request/response</code> → <code>req/res</code>，逐层抽象，提供更优雅的 API</li>
<li><strong>相互引用</strong> - 建立了复杂但合理的引用关系，使得在任何层级都能方便地访问其他对象</li>
<li><strong>内存优化</strong> - 通过原型链共享方法，避免每个请求都创建重复的方法副本</li>
</ol>
<p>这样设计的好处是，在中间件中我们可以灵活地访问：</p>
<ul>
<li><code>ctx.req</code> / <code>ctx.res</code> - 访问 Node.js 原生对象</li>
<li><code>ctx.request</code> / <code>ctx.response</code> - 访问 Koa 封装的对象</li>
<li><code>ctx.body</code> / <code>ctx.status</code> - 使用 Koa 的便捷属性（代理到 response）</li>
</ul>
<h4 data-id="heading-8">2.4 启动监听服务</h4>
<p>当所有中间件注册完成后，我们需要启动 HTTP 服务器开始监听请求。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 用户代码：启动服务器</span>
app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Server is running on port 3000'</span>);
});

<span class="hljs-comment">// Koa 内部实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Application</span> {
  listen (...args) {
    <span class="hljs-title function_">debug</span>(<span class="hljs-string">'listen'</span>)
    <span class="hljs-comment">// 创建 Node.js HTTP 服务器，传入 callback 作为请求处理函数</span>
    <span class="hljs-keyword">const</span> server = http.<span class="hljs-title function_">createServer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">callback</span>())
    <span class="hljs-keyword">return</span> server.<span class="hljs-title function_">listen</span>(...args) <span class="hljs-comment">// 返回 Node.js 的 http.Server 实例</span>
  }

  <span class="hljs-comment">// callback 方法返回一个符合 Node.js http.createServer 要求的请求处理函数</span>
  <span class="hljs-title function_">callback</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// ⭐️ 核心：使用 compose 将所有中间件组合成一个函数</span>
    <span class="hljs-comment">// 这就是洋葱模型的实现入口！</span>
    <span class="hljs-keyword">const</span> fn = <span class="hljs-title function_">compose</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">middleware</span>);

    <span class="hljs-comment">// 如果没有监听 error 事件，添加默认的错误处理器</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">listenerCount</span>(<span class="hljs-string">'error'</span>)) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onerror</span>);

    <span class="hljs-comment">// 返回请求处理函数，Node.js 会在每次请求到来时调用它</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
      <span class="hljs-comment">// 为这个请求创建独立的 context</span>
      <span class="hljs-keyword">const</span> ctx = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createContext</span>(req, res);
      <span class="hljs-comment">// 执行组合后的中间件函数，传入 context</span>
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleRequest</span>(ctx, fn);
    };
  }
}
</code></pre>
<p><strong>流程分解：</strong></p>
<ol>
<li><strong><code>app.listen()</code></strong> - 这只是对 Node.js 原生 API 的薄封装</li>
<li><strong><code>this.callback()</code></strong> - 这里是魔法发生的地方：
<ul>
<li>调用 <code>compose(this.middleware)</code> 将所有中间件组合成一个函数</li>
<li>返回一个闭包函数，每次请求时被调用</li>
</ul>
</li>
<li><strong>请求处理</strong> - 当请求到来时：
<ul>
<li>创建本次请求专属的 <code>ctx</code> 对象</li>
<li>执行组合后的中间件函数 <code>fn(ctx)</code></li>
<li>所有中间件共享同一个 <code>ctx</code></li>
</ul>
</li>
</ol>
<p><strong>关键点：<code>compose(this.middleware)</code></strong></p>
<p>这行代码是理解 Koa 的关键。它将一个中间件数组：</p>
<pre><code class="hljs language-javascript" lang="javascript">[middleware1, middleware2, middleware3]
</code></pre>
<p>转换成一个嵌套的调用链：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">middleware1</span>(ctx, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">middleware2</span>(ctx, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">middleware3</span>(ctx, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 最内层</span>
    })
  })
})
</code></pre>
<p>这就是著名的"洋葱模型"的实现基础。接下来我们将深入剖析 <code>compose</code> 函数的源码。</p>
<h3 data-id="heading-9">三、洋葱模型：中间件的优雅编排</h3>
<h4 data-id="heading-10">3.1 什么是洋葱模型？</h4>
<p>Koa 的中间件执行机制被形象地称为"洋葱模型"。中间件的执行过程类似于剥洋葱：</p>
<ol>
<li><strong>请求阶段</strong>（外层到内层）：从第一个中间件开始，遇到 <code>await next()</code> 就进入下一个中间件</li>
<li><strong>响应阶段</strong>（内层到外层）：最内层中间件执行完毕后，依次返回到外层中间件</li>
</ol>
<h4 data-id="heading-11">3.2 compose 源码解析与实现</h4>
<p><code>compose</code> 函数是 <code>koa-compose</code> 包提供的，它是实现洋葱模型的核心。让我们先看看官方源码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">compose</span>(<span class="hljs-params">middleware</span>) {
  <span class="hljs-comment">// compose 返回一个函数，这个函数接收 context 和一个可选的 next</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">context, next</span>) {
    <span class="hljs-keyword">let</span> index = -<span class="hljs-number">1</span>;  <span class="hljs-comment">// 用于记录当前执行到第几个中间件</span>

    <span class="hljs-comment">// dispatch 函数负责执行第 i 个中间件</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">dispatch</span>(<span class="hljs-params">i</span>) {
      <span class="hljs-comment">// 防止在同一个中间件中多次调用 next()</span>
      <span class="hljs-comment">// 如果 i &lt;= index，说明 next() 被调用了多次</span>
      <span class="hljs-keyword">if</span> (i &lt;= index) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'next() 被多次调用'</span>));
      }

      index = i; <span class="hljs-comment">// 更新当前中间件索引，用于防止 next 被多次调用</span>
      <span class="hljs-keyword">let</span> fn = middleware[i];  <span class="hljs-comment">// 获取当前要执行的中间件</span>

      <span class="hljs-comment">// 如果已经是最后一个中间件，fn 设为传入的 next（通常为 undefined）</span>
      <span class="hljs-keyword">if</span> (i === middleware.<span class="hljs-property">length</span>) fn = next;
      <span class="hljs-comment">// 如果 fn 不存在，说明已经到达末尾，返回一个 resolved 的 Promise</span>
      <span class="hljs-keyword">if</span> (!fn) <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>();

      <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// ⭐️ 核心逻辑：执行当前中间件，并将 dispatch(i + 1) 作为 next 参数传入</span>
        <span class="hljs-comment">// 这样当中间件调用 await next() 时，实际上是在调用 dispatch(i + 1)</span>
        <span class="hljs-comment">// 从而递归地执行下一个中间件</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">fn</span>(context, dispatch.<span class="hljs-title function_">bind</span>(<span class="hljs-literal">null</span>, i + <span class="hljs-number">1</span>)));
      } <span class="hljs-keyword">catch</span> (err) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(err);
      }
    }

    <span class="hljs-comment">// 从第一个中间件开始执行</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">dispatch</span>(<span class="hljs-number">0</span>);
  };
}
</code></pre>
<p><strong>这个函数的精妙之处：</strong></p>
<ol>
<li><strong>闭包保存状态</strong> - 通过闭包保存 <code>index</code>，防止 <code>next()</code> 被重复调用，这是一个重要的安全检查</li>
<li><strong>递归调用链</strong> - <code>dispatch(i)</code> 执行当前中间件，并将 <code>dispatch(i + 1)</code> 作为 <code>next</code> 传入</li>
<li><strong>Promise 包装</strong> - 所有中间件都被包装成 Promise，支持 async/await 语法</li>
<li><strong>懒执行</strong> - 只有当中间件调用 <code>await next()</code> 时，下一个中间件才会执行</li>
</ol>
<p><strong>执行流程可视化：</strong></p>
<p>假设有三个中间件 <code>[m1, m2, m3]</code>：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">dispatch</span>(<span class="hljs-number">0</span>) 执行 <span class="hljs-built_in">m1</span>(ctx, dispatch(<span class="hljs-number">1</span>))
  ↓
  m1 执行到 await <span class="hljs-built_in">next</span>()
  ↓
  <span class="hljs-built_in">dispatch</span>(<span class="hljs-number">1</span>) 执行 <span class="hljs-built_in">m2</span>(ctx, dispatch(<span class="hljs-number">2</span>))
    ↓
    m2 执行到 await <span class="hljs-built_in">next</span>()
    ↓
    <span class="hljs-built_in">dispatch</span>(<span class="hljs-number">2</span>) 执行 <span class="hljs-built_in">m3</span>(ctx, dispatch(<span class="hljs-number">3</span>))
      ↓
      m3 执行完毕
    ↓
    m2 的 <span class="hljs-built_in">next</span>() 后的代码执行
  ↓
  m1 的 <span class="hljs-built_in">next</span>() 后的代码执行
</code></pre>
<p>源码使用递归实现，初看可能有些难懂。没关系，下面我们来实现一个简化版本，帮助理解核心思想。</p>
<h4 data-id="heading-12">3.3 手写简易版 compose</h4>
<p>核心思想：<strong>在当前中间件执行过程中，让 <code>next()</code> 函数能够自动执行下一个中间件</strong>，直到最后一个。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">compose</span> = (<span class="hljs-params">middleware</span>) =&gt; {
  <span class="hljs-keyword">const</span> ctx = {};  <span class="hljs-comment">// 创建一个上下文对象</span>

  <span class="hljs-keyword">if</span> (middleware.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> fn = middleware[index]; <span class="hljs-comment">// 获取第一个中间件</span>
  <span class="hljs-title function_">fn</span>(ctx, next);                <span class="hljs-comment">// 手动执行第一个中间件</span>

  <span class="hljs-comment">// 实现 next() 函数</span>
  <span class="hljs-comment">// 核心是在当前中间件执行过程中，获取下一个中间件函数并自动执行，直到最后一个</span>
  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">next</span>(<span class="hljs-params"/>) {
    index++;  <span class="hljs-comment">// 移动到下一个中间件</span>

    <span class="hljs-comment">// 如果已经是最后一个中间件，直接返回</span>
    <span class="hljs-keyword">if</span> (index &gt;= middleware.<span class="hljs-property">length</span>) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">const</span> fn = middleware[index];  <span class="hljs-comment">// 获取下一个中间件</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-title function_">fn</span>(ctx, next);    <span class="hljs-comment">// 执行下一个中间件，并传入 next</span>
  }
};

<span class="hljs-comment">// 定义三个测试中间件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">middleware1</span> = (<span class="hljs-params">ctx, next</span>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"&gt;&gt; one"</span>);
  <span class="hljs-title function_">next</span>();                 <span class="hljs-comment">// 调用 next()，执行 middleware2</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"&lt;&lt; one"</span>);
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">middleware2</span> = (<span class="hljs-params">ctx, next</span>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"&gt;&gt; two"</span>);
  <span class="hljs-title function_">next</span>();                 <span class="hljs-comment">// 调用 next()，执行 middleware3</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"&lt;&lt; two"</span>);
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">middleware3</span> = (<span class="hljs-params">ctx, next</span>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"&gt;&gt; three"</span>);
  <span class="hljs-title function_">next</span>();                 <span class="hljs-comment">// 已经是最后一个，next() 直接返回</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"&lt;&lt; three"</span>);
};

<span class="hljs-comment">// 执行组合后的中间件</span>
<span class="hljs-title function_">compose</span>([middleware1, middleware2, middleware3]);

<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// &gt;&gt; one</span>
<span class="hljs-comment">// &gt;&gt; two</span>
<span class="hljs-comment">// &gt;&gt; three</span>
<span class="hljs-comment">// &lt;&lt; three</span>
<span class="hljs-comment">// &lt;&lt; two</span>
<span class="hljs-comment">// &lt;&lt; one</span>
</code></pre>
<p><strong>关键理解点：</strong></p>
<ol>
<li><strong>同步执行</strong> - 当 <code>middleware1</code> 调用 <code>next()</code> 时，<code>middleware2</code> 会立即开始执行</li>
<li><strong>栈式回溯</strong> - 当 <code>middleware3</code> 执行完毕后，控制权会依次返回到 <code>middleware2</code> 和 <code>middleware1</code> 的 <code>next()</code> 之后</li>
<li><strong>洋葱结构</strong> - 这就形成了"进入"和"退出"两个阶段，像剥洋葱一样</li>
</ol>
<p><strong>执行顺序详解：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> middleware1 开始执行 → 打印 "&gt;&gt; one"
<span class="hljs-bullet">2.</span> middleware1 调用 next() → 暂停，进入 middleware2
<span class="hljs-bullet">3.</span> middleware2 开始执行 → 打印 "&gt;&gt; two"
<span class="hljs-bullet">4.</span> middleware2 调用 next() → 暂停，进入 middleware3
<span class="hljs-bullet">5.</span> middleware3 开始执行 → 打印 "&gt;&gt; three"
<span class="hljs-bullet">6.</span> middleware3 调用 next() → 返回（已是最后一个）
<span class="hljs-bullet">7.</span> middleware3 继续执行 → 打印 "&lt;&lt; three"
<span class="hljs-bullet">8.</span> middleware3 执行完毕 → 返回到 middleware2
<span class="hljs-bullet">9.</span> middleware2 继续执行 → 打印 "&lt;&lt; two"
<span class="hljs-bullet">10.</span> middleware2 执行完毕 → 返回到 middleware1
<span class="hljs-bullet">11.</span> middleware1 继续执行 → 打印 "&lt;&lt; one"
</code></pre>
<p><strong>建议：</strong> 使用 VSCode 的断点调试功能，在每个中间件的 <code>next()</code> 前后打断点，单步执行体会代码的具体执行过程。这样能够更直观地理解洋葱模型的运作机制。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d68926e6e1eb4925b44a05a1692dc599~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6La05Zyo56qX6L655pWw5pif5pif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766824960&amp;x-signature=2O9KCiNJtD3y9zXPy72oxglmmTA%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-13">四、总结</h3>
<p>通过对 Koa 源码的深入分析，我们可以看到它的设计哲学：<strong>极简、优雅、灵活</strong>。</p>
<h3 data-id="heading-14">参考资源</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fkoajs.com%2F" target="_blank" title="https://koajs.com/" ref="nofollow noopener noreferrer">Koa 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkoajs%2Fkoa" target="_blank" title="https://github.com/koajs/koa" ref="nofollow noopener noreferrer">Koa GitHub 仓库</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkoajs%2Fcompose" target="_blank" title="https://github.com/koajs/compose" ref="nofollow noopener noreferrer">koa-compose 源码</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkoajs%2Fkoa%2Fwiki" target="_blank" title="https://github.com/koajs/koa/wiki" ref="nofollow noopener noreferrer">Koa 中间件列表</a></li>
</ul>
<hr/>
<p>如果觉得有帮助，欢迎点赞收藏，也欢迎在评论区交流讨论！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vscode没有js提示：配置jsconfig配置]]></title>    <link>https://juejin.cn/post/7585468725332279350</link>    <guid>https://juejin.cn/post/7585468725332279350</guid>    <pubDate>2025-12-20T08:44:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585468725332279350" data-draft-id="7585468725332262966" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vscode没有js提示：配置jsconfig配置"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T08:44:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Mr_Swilder"/> <meta itemprop="url" content="https://juejin.cn/user/3927901716878829"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vscode没有js提示：配置jsconfig配置
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3927901716878829/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Mr_Swilder
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:44:44.000Z" title="Sat Dec 20 2025 08:44:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>jsconfig.json</code>是一个配置文件，它的核心作用是告诉 Visual Studio Code（VSCode）当前目录是一个 <strong>JavaScript 项目的根目录</strong>，从而为你的代码提供更强大的智能感知（IntelliSense）和语言支持。</p>
<p>下面这个表格概括了它的主要作用：</p>






























<table><thead><tr><th>核心作用</th><th>解决的问题</th><th>简单示例</th></tr></thead><tbody><tr><td><strong>定义项目上下文</strong>​</td><td>没有它时，VSCode 将每个 JS 文件视为独立单元，文件间缺乏关联性。有了它，VSCode 能将整个项目作为一个整体理解。</td><td><code>{}</code>(一个空文件即可定义项目)</td></tr><tr><td><strong>配置路径别名映射</strong>​</td><td>当项目使用像 <code>@</code>这样的别名来代表 <code>src</code>目录时，VSCode 默认无法识别。配置后，可以实现<strong>路径的自动补全和点击跳转</strong>。</td><td><code>"paths": { "@/*": ["src/*"] }</code></td></tr><tr><td><strong>提升 IDE 性能</strong>​</td><td>通过排除不必要的文件（如 <code>node_modules</code>, <code>dist</code>），让语言服务专注于源代码，<strong>避免 IntelliSense 变慢</strong>。</td><td><code>"exclude": ["node_modules", "dist"]</code></td></tr><tr><td><strong>调整语言服务选项</strong>​</td><td>配置 JavaScript 的语言检查标准，例如启用实验性语法支持（如装饰器）或指定 ECMAScript 目标版本。</td><td><code>"experimentalDecorators": true</code></td></tr></tbody></table>
<h3 data-id="heading-0">💡 详细解读与配置</h3>
<ul>
<li>
<p><strong>定义项目上下文</strong>：在没有 <code>jsconfig.json</code>的“文件范围（File Scope）”模式下，VSCode 虽然能为单个文件提供基础语法高亮，但难以准确分析文件之间的模块引用关系。创建 <code>jsconfig.json</code>后，项目进入“显式项目（Explicit Project）”模式，VSCode 的语言服务能理解项目的整体结构，从而提供更精确的代码补全、类型推断和错误检查。</p>
</li>
<li>
<p><strong>配置路径映射（Paths Mapping）</strong> ：这是在前端项目中非常实用的功能。许多项目使用 Webpack 或 Vite 等构建工具配置了路径别名，但在代码编辑器中，这些别名默认无法被识别。通过在 <code>jsconfig.json</code>中配置 <code>paths</code>，即可让 VSCode 理解这些别名。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"baseUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 设置基础目录</span>
    <span class="hljs-attr">"paths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"@/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>    <span class="hljs-comment">// 将 @ 映射到 src 目录</span>
      <span class="hljs-attr">"components/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/components/*"</span><span class="hljs-punctuation">]</span> <span class="hljs-comment">// 配置其他别名</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>配置后，当你输入 <code>import App from '@/App'</code>，VSCode 就能知道 <code>@</code>指向 <code>src</code>目录，并提供自动补全和跳转功能。</p>
</li>
<li>
<p><strong>优化性能（Exclude）</strong> ：JavaScript 语言服务会分析项目中的文件来提供 IntelliSense。如果它去解析庞大的 <code>node_modules</code>或构建输出的 <code>dist</code>目录，会严重拖慢速度。使用 <code>exclude</code>属性可以告诉语言服务忽略这些目录。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"exclude"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"node_modules"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"dist"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"build"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"*.min.js"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-1">🛠️ 创建与配置示例</h3>
<p>你可以在项目的根目录下创建一个名为 <code>jsconfig.json</code>的文件。一个适用于现代前端项目（如 Vue、React）的常见配置如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"target"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ESNext"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ESNext"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"moduleResolution"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"baseUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"paths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"@/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/*"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"allowSyntheticDefaultImports"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"experimentalDecorators"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"lib"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"esnext"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"dom"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"dom.iterable"</span><span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"include"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/**/*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"exclude"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"node_modules"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"dist"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"build"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>配置项说明</strong>：</p>
<ul>
<li><code>compilerOptions</code>：虽然名字叫“编译选项”，但它主要用于配置 VSCode 的 JavaScript 语言服务行为，因为 <code>jsconfig.json</code>源自 TypeScript 的 <code>tsconfig.json</code>。</li>
<li><code>include</code>：明确指定哪些文件属于项目。如果未设置，则默认包含所有子目录下的文件。</li>
<li><code>exclude</code>：指定要排除的文件和文件夹。</li>
</ul>
<h3 data-id="heading-2">💎 总结</h3>
<p>总而言之，<code>jsconfig.json</code>就像是你在 VSCode 中的<strong>项目地图和说明书</strong>。它通过定义项目根目录、映射路径别名、排除无关文件等方式，显著提升了代码编辑的智能体验、导航效率和整体性能。对于任何有一定规模的 JavaScript/TypeScript 项目，配置一个 <code>jsconfig.json</code>都是非常值得的。</p>
<p>希望这些信息能帮助你更好地理解和使用 <code>jsconfig.json</code>。如果你在配置过程中遇到具体问题，例如如何为特定框架进行优化，我很乐意提供进一步的帮助。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别代码屎山！UniApp + Vue3 自动化规范：ESLint 9+ 扁平化配置全指南]]></title>    <link>https://juejin.cn/post/7585463195201126450</link>    <guid>https://juejin.cn/post/7585463195201126450</guid>    <pubDate>2025-12-20T06:40:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463195201126450" data-draft-id="7585446706327076873" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别代码屎山！UniApp + Vue3 自动化规范：ESLint 9+ 扁平化配置全指南"/> <meta itemprop="keywords" content="JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-12-20T06:40:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="幼儿园老大"/> <meta itemprop="url" content="https://juejin.cn/user/1574156383555415"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别代码屎山！UniApp + Vue3 自动化规范：ESLint 9+ 扁平化配置全指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1574156383555415/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    幼儿园老大
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T06:40:20.000Z" title="Sat Dec 20 2025 06:40:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>配置初衷是为了保证，团队开发中的代码规范问题。
以下是全部配置过程，我的项目是npm创建的，并非hbuilder创建的。如果你的项目的hbuilder创建的，需要执行下 <code>npm init -y</code>。</p>
<p>配置后想要达到的效果：</p>
<ul>
<li>保证缩进统一性</li>
<li>vue组件多个属性可以自动换行。</li>
<li>在代码里用了 <code>uni.showToast</code>，ESLint 却疯狂报错 <code>uni is not defined</code>。</li>
</ul>
<p>2025 年，ESLint 迎来了史上最大变革——<strong>Flat Config（扁平化配置）</strong>  时代。今天，我们就用一套最硬核的方案，把 <strong>Vue3、TypeScript、SCSS</strong> 和 <strong>Git 自动化</strong> 全部打通！</p>
<h2 data-id="heading-0">一、 为什么 2025 年要用 ESLint 9+ ？</h2>
<p>传统的 <code>.eslintrc.js</code> 采用的是“层级继承”逻辑，配置多了就像迷宫。而 <strong>ESLint 9+ 的 Flat Config (<code>eslint.config.mjs</code>)</strong>  采用纯 JavaScript 数组对象，逻辑更扁平、加载更快速、对 ESM 原生支持更好。</p>
<h2 data-id="heading-1">二、 核心依赖安装：一步到位</h2>
<p>首先，清理掉项目里的旧配置文件，然后在根目录执行这行“全家桶”安装命令：</p>
<pre><code class="hljs language-bash" lang="bash">npm install eslint @eslint/js typescript-eslint eslint-plugin-vue globals eslint-config-prettier eslint-plugin-prettier prettier husky lint-staged --save-dev
</code></pre>
<h2 data-id="heading-2">三、 配置实战：三剑客齐聚</h2>
<ol>
<li>魔法启动：生成 ESLint 9 配置文件</li>
</ol>
<p>新版 ESLint 推荐通过交互式命令生成基础框架，但针对 UniApp，我们建议直接创建 <code>eslint.config.mjs</code> 以获得极致控制力。</p>
<p><strong>核心逻辑：</strong></p>
<ul>
<li><strong>2 空格缩进</strong>：强迫症的福音。</li>
<li><strong>属性换行</strong>：组件属性 &gt; 3 个自动起新行。</li>
<li><strong>多语言全开</strong>：JS / TS / Vue / CSS / SCSS 完美兼容。</li>
</ul>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">/* eslint.config.mjs */</span>
import js <span class="hljs-keyword">from</span> <span class="hljs-string">'@eslint/js'</span>;
import tseslint <span class="hljs-keyword">from</span> <span class="hljs-string">'typescript-eslint'</span>;
import pluginVue <span class="hljs-keyword">from</span> <span class="hljs-string">'eslint-plugin-vue'</span>;
import pluginPrettierRecommended <span class="hljs-keyword">from</span> <span class="hljs-string">'eslint-plugin-prettier/recommended'</span>;
import globals <span class="hljs-keyword">from</span> <span class="hljs-string">'globals'</span>;

export <span class="hljs-keyword">default</span> tseslint.<span class="hljs-title function_ invoke__">config</span>(
  // 【<span class="hljs-number">1</span>】配置忽略名单：不检查编译后的代码
  { <span class="hljs-attr">ignores</span>: [<span class="hljs-string">'dist/**'</span>, <span class="hljs-string">'unpackage/**'</span>, <span class="hljs-string">'node_modules/**'</span>, <span class="hljs-string">'static/**'</span>] },

  // 【<span class="hljs-number">2</span>】JS 基础规则 &amp; UniApp 全局变量支持
  js.configs.recommended,
  {
    <span class="hljs-attr">languageOptions</span>: {
      <span class="hljs-attr">ecmaVersion</span>: <span class="hljs-string">'latest'</span>,
      <span class="hljs-attr">sourceType</span>: <span class="hljs-string">'module'</span>,
      <span class="hljs-attr">globals</span>: {
        ...globals.browser, ...globals.node,
        <span class="hljs-attr">uni</span>: <span class="hljs-string">'readonly'</span>, <span class="hljs-attr">wx</span>: <span class="hljs-string">'readonly'</span>, <span class="hljs-attr">plus</span>: <span class="hljs-string">'readonly'</span> // 解决 uni 报错
      },
    },
  },

  // 【<span class="hljs-number">3</span>】TypeScript 强类型支持
  ...tseslint.configs.recommended,

  // 【<span class="hljs-number">4</span>】Vue <span class="hljs-number">3</span> 核心规范（属性换行策略）
  ...pluginVue.configs[<span class="hljs-string">'flat/recommended'</span>],
  {
    <span class="hljs-attr">files</span>: [<span class="hljs-string">'**/*.vue'</span>],
    <span class="hljs-attr">languageOptions</span>: {
      <span class="hljs-attr">parserOptions</span>: { <span class="hljs-attr">parser</span>: tseslint.parser } // Vue 模板内支持 TS
    },
    <span class="hljs-attr">rules</span>: {
      <span class="hljs-string">'vue/multi-word-component-names'</span>: <span class="hljs-string">'off'</span>, // 适配 UniApp 页面名
      <span class="hljs-string">'vue/html-indent'</span>: [<span class="hljs-string">'error'</span>, <span class="hljs-number">2</span>],         // 模板强制 <span class="hljs-number">2</span> 空格
      <span class="hljs-string">'vue/max-attributes-per-line'</span>: [<span class="hljs-string">'error'</span>, {
        <span class="hljs-attr">singleline</span>: { <span class="hljs-attr">max</span>: <span class="hljs-number">3</span> }, // 超过 <span class="hljs-number">3</span> 个属性就换行
        <span class="hljs-attr">multiline</span>: { <span class="hljs-attr">max</span>: <span class="hljs-number">1</span> }   // 多行模式下每行只能有一个属性
      }],
      <span class="hljs-string">'vue/first-attribute-linebreak'</span>: [<span class="hljs-string">'error'</span>, {
        <span class="hljs-attr">singleline</span>: <span class="hljs-string">'beside'</span>, <span class="hljs-attr">multiline</span>: <span class="hljs-string">'below'</span>
      }]
    }
  },

  // 【<span class="hljs-number">5</span>】Prettier 冲突处理：必须放在数组最后一行！
  pluginPrettierRecommended,
);
</code></pre>
<ol start="2">
<li>视觉统领：<code>.prettierrc</code></li>
</ol>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"semi"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"singleQuote"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"tabWidth"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"useTabs"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"printWidth"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"trailingComma"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"all"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"endOfLine"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"auto"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ol start="3">
<li>编辑器底层逻辑：<code>.editorconfig</code></li>
</ol>
<p>让 IDEA 和 VS Code 在你打字的第一秒就明白：缩进只要两个空格。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">root</span> = <span class="hljs-literal">true</span>
<span class="hljs-section">[*]</span>
<span class="hljs-attr">indent_style</span> = space
<span class="hljs-attr">indent_size</span> = <span class="hljs-number">2</span>
<span class="hljs-attr">end_of_line</span> = lf
<span class="hljs-attr">insert_final_newline</span> = <span class="hljs-literal">true</span>
</code></pre>
<p>四、 极速体验：让工具为你打工</p>
<ol>
<li>IDEA / WebStorm 深度联动</li>
</ol>
<p>别再手动敲 <code>Ctrl+Alt+L</code> 了！</p>
<ul>
<li>进入 <strong>Settings -&gt; ESLint</strong>，勾选 <strong>Run eslint --fix on save</strong>。</li>
<li>进入 <strong>Settings -&gt; Prettier</strong>，勾选 <strong>Run on save</strong>。<br/>
<em>IDEA 2024+ 会完美识别你的 <code>eslint.config.mjs</code>。</em></li>
</ul>
<ol start="2">
<li>Git 提交自动“洗地” (Husky + lint-staged)</li>
</ol>
<p>想要代码仓库永远干干净净？在 <code>package.json</code> 中加入这道闸门：</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"lint-staged"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"*.{js,ts,vue}"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"eslint --fix"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"prettier --write"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"*.{css,scss,json,md}"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"prettier --write"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>执行 <code>npx husky init</code> 并将 <code>.husky/pre-commit</code> 改为 <code>npx lint-staged</code>。现在，任何不符合规则的代码都别想溜进 Git 仓库！</p>
<h2 data-id="heading-3">五、 结语</h2>
<p>规范不是为了限制自由，而是为了让开发者在 2025 年繁重的业务中，能拥有一份优雅的代码底座。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RAG实战|8种RAG架构浅析]]></title>    <link>https://juejin.cn/post/7585390679399333894</link>    <guid>https://juejin.cn/post/7585390679399333894</guid>    <pubDate>2025-12-20T07:02:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585390679399333894" data-draft-id="7585382553290686500" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RAG实战|8种RAG架构浅析"/> <meta itemprop="keywords" content="AIGC,LangChain"/> <meta itemprop="datePublished" content="2025-12-20T07:02:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="周末程序猿"/> <meta itemprop="url" content="https://juejin.cn/user/3245414056989757"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RAG实战|8种RAG架构浅析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3245414056989757/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    周末程序猿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T07:02:08.000Z" title="Sat Dec 20 2025 07:02:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>因为项目的需要，之前研究了一段时间的<code>RAG</code>，于是本文总结 8 种 <code>RAG</code> 架构，对每种架构进行简要介绍，并用 <code>langchain</code> 实现其参考代码。</p>
<h2 data-id="heading-0">1. Naive RAG</h2>
<p><strong>简介：</strong></p>
<p>Naive RAG 是最基础的检索增强生成架构，采用“索引-检索-生成”的经典流程。<strong>架构：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a791bbe7f4524e51b74053ad63de110f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766818928&amp;x-signature=ku0AJbn3D7xRqqygvjDvDp5jEfs%3D" alt="图片" loading="lazy"/></p>
<p><strong>实现步骤：</strong></p>
<ul>
<li>数据加载 ：收集数据并进行清洗，比如各个文档格式的转换，OCR 文字提取等</li>
<li>分块和 embedding ：将文档拆分更小的 chunk，一方面让 embedding 更好转换语义信息，另一方面解决LLM的上下文长度限制问题</li>
<li>向量存储：将 embedding 存储到向量数据库中，方便快速搜索</li>
<li>search 和 Prompt工程：对于查找的问题先通过向量数据库检索，然后将召回的文件原文，通过 Prompt 加工提供给LLM</li>
<li>输出答案：LLM 根据 Prompt 生成答案输出</li>
</ul>
<p><strong>参考代码：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_huggingface <span class="hljs-keyword">import</span> HuggingFaceEmbeddings
<span class="hljs-keyword">from</span> langchain_community.vectorstores <span class="hljs-keyword">import</span> LanceDB
<span class="hljs-keyword">from</span> langchain.schema <span class="hljs-keyword">import</span> Document
<span class="hljs-keyword">from</span> langchain.chains <span class="hljs-keyword">import</span> RetrievalQA
<span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> PromptTemplate
<span class="hljs-keyword">import</span> lancedb

<span class="hljs-keyword">class</span> <span class="hljs-title class_">NaiveRAG</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.llm = ChatOpenAI(model=<span class="hljs-string">"gpt-5"</span>, temperature=<span class="hljs-number">0</span>)
        <span class="hljs-comment"># 使用轻量级的all-MiniLM-L6-v2模型，仅80MB</span>
        self.embeddings = HuggingFaceEmbeddings(
            model_name=<span class="hljs-string">"sentence-transformers/all-MiniLM-L6-v2"</span>,
            model_kwargs={<span class="hljs-string">"device"</span>: <span class="hljs-string">"cpu"</span>},
            encode_kwargs={<span class="hljs-string">"normalize_embeddings"</span>: <span class="hljs-literal">True</span>}
        )
        self.db = lancedb.connect(<span class="hljs-string">"/tmp/lancedb_naive_rag"</span>)
        self.vectorstore = <span class="hljs-literal">None</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_index</span>(<span class="hljs-params">self, documents: <span class="hljs-built_in">list</span></span>):
        <span class="hljs-string">"""构建向量索引"""</span>
        docs = [Document(page_content=d) <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> documents]
        self.vectorstore = LanceDB.from_documents(
            docs, 
            self.embeddings,
            connection=self.db,
            table_name=<span class="hljs-string">"naive_rag_docs"</span>
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">query</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""执行检索并生成答案"""</span>
        <span class="hljs-comment"># 创建检索链</span>
        retriever = self.vectorstore.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">3</span>})
        
        prompt_template = PromptTemplate(
            input_variables=[<span class="hljs-string">"context"</span>, <span class="hljs-string">"question"</span>],
            template=<span class="hljs-string">"""基于以下上下文回答问题：
            上下文: {context}
            问题: {question}
            答案:"""</span>
        )
        
        qa_chain = RetrievalQA.from_chain_type(
            llm=self.llm,
            chain_type=<span class="hljs-string">"stuff"</span>,
            retriever=retriever,
            chain_type_kwargs={<span class="hljs-string">"prompt"</span>: prompt_template}
        )
        
        <span class="hljs-keyword">return</span> qa_chain.invoke({<span class="hljs-string">"query"</span>: question})[<span class="hljs-string">"result"</span>]

<span class="hljs-comment"># 使用示例</span>
naive_rag = NaiveRAG()
naive_rag.build_index([<span class="hljs-string">"文档1内容..."</span>, <span class="hljs-string">"文档2内容..."</span>, <span class="hljs-string">"文档3内容..."</span>])
answer = naive_rag.query(<span class="hljs-string">"What is issue date of lease?"</span>)
<span class="hljs-built_in">print</span>(answer)
</code></pre>
<h2 data-id="heading-1">2. Multi-Head RAG</h2>
<p><strong>简介：</strong></p>
<p>Multi-Head RAG 借鉴了 Transformer 的多头注意力机制，利用模型不同注意力头捕获的多样化语义特征进行并行检索。</p>
<p><strong>架构：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2d889c3e8cf46d9a2bf9be204b3dbec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766818928&amp;x-signature=YUXFtx%2FXAO9Q0PjbKx6buyMl9UY%3D" alt="图片" loading="lazy"/></p>
<p><strong>实现步骤：</strong></p>
<ul>
<li>多头注意力Embedding：利用 Transformer 模型的多头注意力层（而非最后一层）生成多个embedding，每个头捕获不同的语义特征</li>
<li>多向量索引构建：为每个注意力头构建独立的向量索引，存储不同维度的语义信息</li>
<li>并行检索：针对查询，在多个索引上并行检索，每个头返回最相关的文档片段</li>
<li>结果融合：将多个头的检索结果进行去重和融合，综合考虑不同语义维度的相关性</li>
<li>上下文生成：将融合后的文档片段组装成上下文，输入LLM生成答案</li>
</ul>
<p><strong>相关参考如下：</strong></p>
<p>论文：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2406.05085" target="_blank" title="https://arxiv.org/pdf/2406.05085" ref="nofollow noopener noreferrer">arxiv.org/pdf/2406.05…</a></p>
<p>代码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fspcl%2FMRAG" target="_blank" title="https://github.com/spcl/MRAG" ref="nofollow noopener noreferrer">github.com/spcl/MRAG</a></p>
<p><strong>参考代码：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_community.vectorstores <span class="hljs-keyword">import</span> LanceDB
<span class="hljs-keyword">from</span> langchain.schema <span class="hljs-keyword">import</span> Document
<span class="hljs-keyword">from</span> langchain.embeddings.base <span class="hljs-keyword">import</span> Embeddings
<span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> AutoModel, AutoTokenizer
<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> lancedb
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiHeadEmbeddings</span>(<span class="hljs-title class_ inherited__">Embeddings</span>):
    <span class="hljs-string">"""自定义多头注意力Embedding，继承LangChain的Embeddings基类"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, model_name=<span class="hljs-string">"bert-base-uncased"</span>, head_index=<span class="hljs-number">0</span>, num_heads=<span class="hljs-number">12</span></span>):
        self.tokenizer = AutoTokenizer.from_pretrained(model_name)
        self.model = AutoModel.from_pretrained(model_name, output_hidden_states=<span class="hljs-literal">True</span>)
        self.head_index = head_index
        self.num_heads = num_heads
        self.head_dim = <span class="hljs-number">768</span> // num_heads  <span class="hljs-comment"># BERT hidden size / num_heads</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_head_embedding</span>(<span class="hljs-params">self, texts: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">float</span>]]:
        <span class="hljs-string">"""获取指定头的embedding"""</span>
        inputs = self.tokenizer(texts, return_tensors=<span class="hljs-string">"pt"</span>, padding=<span class="hljs-literal">True</span>, truncation=<span class="hljs-literal">True</span>)
        <span class="hljs-keyword">with</span> torch.no_grad():
            outputs = self.model(**inputs, output_hidden_states=<span class="hljs-literal">True</span>)
        hidden_states = outputs.hidden_states[-<span class="hljs-number">2</span>]  <span class="hljs-comment"># 倒数第二层</span>
        start = self.head_index * self.head_dim
        end = (self.head_index + <span class="hljs-number">1</span>) * self.head_dim
        head_emb = hidden_states[:, <span class="hljs-number">0</span>, start:end].numpy()
        <span class="hljs-keyword">return</span> head_emb.tolist()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">embed_documents</span>(<span class="hljs-params">self, texts: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">float</span>]]:
        <span class="hljs-keyword">return</span> self._get_head_embedding(texts)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">embed_query</span>(<span class="hljs-params">self, text: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">float</span>]:
        <span class="hljs-keyword">return</span> self._get_head_embedding([text])[<span class="hljs-number">0</span>]

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiHeadRAG</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, num_heads=<span class="hljs-number">12</span></span>):
        self.llm = ChatOpenAI(model=<span class="hljs-string">"gpt-5"</span>, temperature=<span class="hljs-number">0</span>)
        self.num_heads = num_heads
        self.db = lancedb.connect(<span class="hljs-string">"/tmp/lancedb_multihead_rag"</span>)
        self.vectorstores = []  <span class="hljs-comment"># 每个头一个向量存储</span>
        self.documents = []
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_index</span>(<span class="hljs-params">self, documents: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>):
        <span class="hljs-string">"""为每个头构建独立的LanceDB向量存储"""</span>
        self.documents = documents
        docs = [Document(page_content=d) <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> documents]
        
        <span class="hljs-keyword">for</span> head_idx <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(self.num_heads):
            embeddings = MultiHeadEmbeddings(head_index=head_idx, num_heads=self.num_heads)
            vectorstore = LanceDB.from_documents(
                docs, 
                embeddings,
                connection=self.db,
                table_name=<span class="hljs-string">f"head_<span class="hljs-subst">{head_idx}</span>_docs"</span>
            )
            self.vectorstores.append(vectorstore)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">search</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, top_k: <span class="hljs-built_in">int</span> = <span class="hljs-number">3</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:
        <span class="hljs-string">"""多头并行检索并融合结果"""</span>
        all_results = <span class="hljs-built_in">set</span>()
        <span class="hljs-keyword">for</span> vectorstore <span class="hljs-keyword">in</span> self.vectorstores:
            docs = vectorstore.similarity_search(query, k=top_k)
            <span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> docs:
                all_results.add(doc.page_content)
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">list</span>(all_results)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">query</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""检索并生成答案"""</span>
        retrieved_docs = self.search(question)
        context = <span class="hljs-string">"\n\n"</span>.join(retrieved_docs)
        
        <span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""基于以下多维度检索的上下文回答问题：
            上下文: {context}
            问题: {question}
            答案:"""</span>
        )
        chain = prompt | self.llm
        response = chain.invoke({<span class="hljs-string">"context"</span>: context, <span class="hljs-string">"question"</span>: question})
        <span class="hljs-keyword">return</span> response.content

<span class="hljs-comment"># 使用示例</span>
mrag = MultiHeadRAG(num_heads=<span class="hljs-number">12</span>)
documents = [<span class="hljs-string">"文档1的内容..."</span>, <span class="hljs-string">"文档2的内容..."</span>, <span class="hljs-string">"文档3的内容..."</span>]
mrag.build_index(documents)
answer = mrag.query(<span class="hljs-string">"查询问题"</span>)
<span class="hljs-built_in">print</span>(answer)
</code></pre>
<h2 data-id="heading-2">3. Corrective RAG</h2>
<p><strong>简介：</strong></p>
<p>Corrective RAG 在传统 RAG 基础上引入了文档质量评估和自我修正机制。对检索到的每个文档进行相关性评分（Correct/Incorrect/Ambiguous），对于质量不足的检索结果，搜索外部知识源进行补充。</p>
<p><strong>架构：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe0109c62e3e43f68ce49846a9450b74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766818928&amp;x-signature=Wei8vQwsNIC1FczlF8K80NbNPsE%3D" alt="图片" loading="lazy"/></p>
<p><strong>实现步骤：</strong></p>
<ul>
<li>初始检索：使用向量检索获取与查询相关的候选文档</li>
<li>相关性评估：使用LLM或专门的评估模型对每个检索到的文档进行相关性评分（Correct/Incorrect/Ambiguous）</li>
<li>知识修正：对于评估为不相关或模糊的文档，触发知识修正机制</li>
<li>网络搜索增强：当本地知识库文档质量不足时，调用外部搜索引擎获取补充信息</li>
<li>文档重组：将评估为相关的文档和补充搜索结果重新组织，去除冗余信息</li>
<li>答案生成：基于修正后的高质量上下文生成最终答案</li>
</ul>
<p><strong>参考代码：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_huggingface <span class="hljs-keyword">import</span> HuggingFaceEmbeddings
<span class="hljs-keyword">from</span> langchain_community.vectorstores <span class="hljs-keyword">import</span> LanceDB
<span class="hljs-keyword">from</span> langchain_community.tools <span class="hljs-keyword">import</span> TavilySearchResults
<span class="hljs-keyword">from</span> langchain.schema <span class="hljs-keyword">import</span> Document
<span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser
<span class="hljs-keyword">import</span> lancedb
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CorrectiveRAG</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.llm = ChatOpenAI(model=<span class="hljs-string">"gpt-5"</span>, temperature=<span class="hljs-number">0</span>)
        self.embeddings = HuggingFaceEmbeddings(
            model_name=<span class="hljs-string">"sentence-transformers/all-MiniLM-L6-v2"</span>,
            model_kwargs={<span class="hljs-string">"device"</span>: <span class="hljs-string">"cpu"</span>},
            encode_kwargs={<span class="hljs-string">"normalize_embeddings"</span>: <span class="hljs-literal">True</span>}
        )
        self.db = lancedb.connect(<span class="hljs-string">"/tmp/lancedb_corrective_rag"</span>)
        self.vectorstore = <span class="hljs-literal">None</span>
        <span class="hljs-comment"># 使用Tavily进行网络搜索</span>
        self.web_search = TavilySearchResults(max_results=<span class="hljs-number">3</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_index</span>(<span class="hljs-params">self, documents: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>):
        <span class="hljs-string">"""构建向量索引"""</span>
        docs = [Document(page_content=d) <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> documents]
        self.vectorstore = LanceDB.from_documents(
            docs, 
            self.embeddings,
            connection=self.db,
            table_name=<span class="hljs-string">"corrective_rag_docs"</span>
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate_relevance</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, document: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""评估文档与查询的相关性"""</span>
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""评估以下文档与查询的相关性。
            查询: {query}
            文档: {document}
            
            请回答: CORRECT(相关), INCORRECT(不相关), 或 AMBIGUOUS(模糊)
            只返回一个词。"""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        response = chain.invoke({<span class="hljs-string">"query"</span>: query, <span class="hljs-string">"document"</span>: document})
        <span class="hljs-keyword">return</span> response.strip().upper()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">search_web</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:
        <span class="hljs-string">"""当本地文档不足时进行网络搜索"""</span>
        <span class="hljs-keyword">try</span>:
            results = self.web_search.invoke(query)
            <span class="hljs-keyword">return</span> [r[<span class="hljs-string">"content"</span>] <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> results <span class="hljs-keyword">if</span><span class="hljs-string">"content"</span><span class="hljs-keyword">in</span> r]
        <span class="hljs-keyword">except</span>:
            <span class="hljs-keyword">return</span> []
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">retrieve_and_correct</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, top_k: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:
        <span class="hljs-string">"""检索并修正文档"""</span>
        <span class="hljs-comment"># 1. 初始检索</span>
        retriever = self.vectorstore.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: top_k})
        docs = retriever.invoke(query)
        
        <span class="hljs-comment"># 2. 评估每个文档的相关性</span>
        correct_docs = []
        need_web_search = <span class="hljs-literal">True</span>
        
        <span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> docs:
            relevance = self.evaluate_relevance(query, doc.page_content)
            <span class="hljs-keyword">if</span> relevance == <span class="hljs-string">"CORRECT"</span>:
                correct_docs.append(doc.page_content)
                need_web_search = <span class="hljs-literal">False</span>
            <span class="hljs-keyword">elif</span> relevance == <span class="hljs-string">"AMBIGUOUS"</span>:
                <span class="hljs-comment"># 对模糊文档进行知识精炼</span>
                refined = self.refine_document(query, doc.page_content)
                correct_docs.append(refined)
        
        <span class="hljs-comment"># 3. 必要时进行网络搜索补充</span>
        <span class="hljs-keyword">if</span> need_web_search <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(correct_docs) &lt; <span class="hljs-number">2</span>:
            web_results = self.search_web(query)
            correct_docs.extend(web_results)
        
        <span class="hljs-keyword">return</span> correct_docs
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">refine_document</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, document: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""精炼文档，提取与查询相关的部分"""</span>
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""从以下文档中提取与查询最相关的信息：
            查询: {query}
            文档: {document}
            
            请只返回相关的精炼内容："""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        <span class="hljs-keyword">return</span> chain.invoke({<span class="hljs-string">"query"</span>: query, <span class="hljs-string">"document"</span>: document})
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">query</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""生成最终答案"""</span>
        corrected_docs = self.retrieve_and_correct(question)
        context = <span class="hljs-string">"\n\n"</span>.join(corrected_docs)
        
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""基于以下经过修正的上下文回答问题：
            上下文: {context}
            问题: {question}
            答案:"""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        <span class="hljs-keyword">return</span> chain.invoke({<span class="hljs-string">"context"</span>: context, <span class="hljs-string">"question"</span>: question})

<span class="hljs-comment"># 使用示例</span>
crag = CorrectiveRAG()
crag.build_index([<span class="hljs-string">"文档1..."</span>, <span class="hljs-string">"文档2..."</span>, <span class="hljs-string">"文档3..."</span>])
answer = crag.query(<span class="hljs-string">"你的问题是什么？"</span>)
<span class="hljs-built_in">print</span>(answer)
</code></pre>
<h2 data-id="heading-3">4. Agentic RAG</h2>
<p><strong>简介：</strong></p>
<p>Agentic RAG（智能体RAG）将 AI Agent 的规划和推理能力与 RAG 相结合。<br/>
Agent 可以自主分析查询、制定检索策略、选择合适的工具（语义搜索、关键词搜索、计算器等），并根据中间结果进行迭代优化。</p>
<p><strong>架构：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2d4ac2fafbf4f2f8a4549436c5adc3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766818928&amp;x-signature=nzUF6IDJ6xHC4IINPGVnM04N3Ig%3D" alt="图片" loading="lazy"/></p>
<p><strong>实现步骤：</strong></p>
<ul>
<li>Agent初始化：创建具有推理和规划能力的AI Agent，配备检索工具</li>
<li>任务分解：Agent分析用户查询，将复杂问题分解为多个子任务</li>
<li>工具选择：Agent根据子任务特点选择合适的工具（检索、计算、API调用等）</li>
<li>迭代检索：Agent可以根据中间结果决定是否需要进一步检索或调整查询策略</li>
<li>推理整合：Agent对多轮检索和工具调用的结果进行推理和整合</li>
<li>自我反思：Agent评估答案质量，必要时进行自我修正</li>
<li>最终输出：生成完整、准确的答案</li>
</ul>
<p><strong>参考代码：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_huggingface <span class="hljs-keyword">import</span> HuggingFaceEmbeddings
<span class="hljs-keyword">from</span> langchain_community.vectorstores <span class="hljs-keyword">import</span> LanceDB
<span class="hljs-keyword">from</span> langchain.schema <span class="hljs-keyword">import</span> Document
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> AgentExecutor, create_tool_calling_agent
<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate, MessagesPlaceholder
<span class="hljs-keyword">import</span> lancedb
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AgenticRAG</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.llm = ChatOpenAI(model=<span class="hljs-string">"gpt-4"</span>, temperature=<span class="hljs-number">0</span>)
        <span class="hljs-comment"># 使用轻量级的all-MiniLM-L6-v2模型，仅80MB</span>
        self.embeddings = HuggingFaceEmbeddings(
            model_name=<span class="hljs-string">"sentence-transformers/all-MiniLM-L6-v2"</span>,
            model_kwargs={<span class="hljs-string">"device"</span>: <span class="hljs-string">"cpu"</span>},
            encode_kwargs={<span class="hljs-string">"normalize_embeddings"</span>: <span class="hljs-literal">True</span>}
        )
        self.db = lancedb.connect(<span class="hljs-string">"/tmp/lancedb_agentic_rag"</span>)
        self.vectorstore = <span class="hljs-literal">None</span>
        self.agent_executor = <span class="hljs-literal">None</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_index</span>(<span class="hljs-params">self, documents: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>):
        <span class="hljs-string">"""构建向量索引"""</span>
        docs = [Document(page_content=d) <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> documents]
        self.vectorstore = LanceDB.from_documents(
            docs, 
            self.embeddings,
            connection=self.db,
            table_name=<span class="hljs-string">"agentic_rag_docs"</span>
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">setup_agent</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""配置Agent和工具"""</span>
        vectorstore = self.vectorstore  <span class="hljs-comment"># 闭包引用</span>
        
        @tool
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">semantic_search</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
            <span class="hljs-string">"""用于语义搜索，当需要理解问题含义并查找相关文档时使用"""</span>
            docs = vectorstore.similarity_search(query, k=<span class="hljs-number">3</span>)
            <span class="hljs-keyword">return</span><span class="hljs-string">"\n"</span>.join([d.page_content <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> docs])
        
        @tool
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">keyword_search</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
            <span class="hljs-string">"""用于关键词搜索，当需要精确匹配特定术语时使用"""</span>
            docs = vectorstore.similarity_search(query, k=<span class="hljs-number">2</span>)
            <span class="hljs-keyword">return</span><span class="hljs-string">"\n"</span>.join([d.page_content <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> docs])
        
        @tool
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">calculator</span>(<span class="hljs-params">expression: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
            <span class="hljs-string">"""用于数学计算，输入数学表达式"""</span>
            <span class="hljs-keyword">try</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">str</span>(<span class="hljs-built_in">eval</span>(expression))
            <span class="hljs-keyword">except</span>:
                <span class="hljs-keyword">return</span><span class="hljs-string">"计算错误"</span>
        
        tools = [semantic_search, keyword_search, calculator]
        
        <span class="hljs-comment"># 使用新版本的Agent提示模板</span>
        prompt = ChatPromptTemplate.from_messages([
            (<span class="hljs-string">"system"</span>, <span class="hljs-string">"""你是一个智能助手，可以使用工具来回答问题。
            
            可用工具：
            - semantic_search: 用于语义搜索，查找相关文档
            - keyword_search: 用于关键词精确匹配
            - calculator: 用于数学计算
            
            请根据问题选择合适的工具，可以多次调用工具来获取完整信息。"""</span>),
            (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{input}"</span>),
            MessagesPlaceholder(variable_name=<span class="hljs-string">"agent_scratchpad"</span>)
        ])
        
        <span class="hljs-comment"># 创建Tool Calling Agent</span>
        agent = create_tool_calling_agent(self.llm, tools, prompt)
        self.agent_executor = AgentExecutor(
            agent=agent, 
            tools=tools, 
            verbose=<span class="hljs-literal">True</span>,
            max_iterations=<span class="hljs-number">5</span>,
            handle_parsing_errors=<span class="hljs-literal">True</span>
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">query</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""执行查询"""</span>
        ifnot self.agent_executor:
            self.setup_agent()
        result = self.agent_executor.invoke({<span class="hljs-string">"input"</span>: question})
        <span class="hljs-keyword">return</span> result[<span class="hljs-string">"output"</span>]

<span class="hljs-comment"># 使用示例</span>
arag = AgenticRAG()
arag.build_index([<span class="hljs-string">"产品A价格100元..."</span>, <span class="hljs-string">"产品B价格200元..."</span>, <span class="hljs-string">"优惠政策..."</span>])
answer = arag.query(<span class="hljs-string">"产品A和产品B的总价是多少？有什么优惠？"</span>)
<span class="hljs-built_in">print</span>(answer)
</code></pre>
<h2 data-id="heading-4">5. Graph RAG</h2>
<p><strong>简介：</strong></p>
<p>Graph RAG 将知识图谱技术与 RAG 相结合，通过从文档中抽取实体和关系构建知识图谱，并进行社区检测和摘要生成。</p>
<p><strong>架构：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/156a00f8228c4cd6ad9d9a913b14922b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766818928&amp;x-signature=1qbByKhMhrVkeQ42ZSiqfMkGUbc%3D" alt="图片" loading="lazy"/></p>
<p><strong>实现步骤：</strong></p>
<ul>
<li>实体抽取：使用NER或LLM从文档中抽取实体（人物、地点、概念等）</li>
<li>关系抽取：识别实体之间的关系，构建三元组（实体-关系-实体）</li>
<li>知识图谱构建：将实体和关系存储到图数据库中（如Neo4j）</li>
<li>社区检测：对图进行社区划分，识别主题聚类</li>
<li>社区摘要：为每个社区生成摘要描述</li>
<li>图检索：根据查询在知识图谱中检索相关子图和社区摘要</li>
<li>答案生成：结合图结构信息和社区摘要生成更全面的答案</li>
</ul>
<p><strong>参考代码：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_community.graphs <span class="hljs-keyword">import</span> Neo4jGraph
<span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser, JsonOutputParser
<span class="hljs-keyword">import</span> networkx <span class="hljs-keyword">as</span> nx
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>
<span class="hljs-keyword">import</span> json

<span class="hljs-keyword">class</span> <span class="hljs-title class_">GraphRAG</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, neo4j_uri=<span class="hljs-string">"bolt://localhost:7687"</span>, 
                 neo4j_user=<span class="hljs-string">"neo4j"</span>, neo4j_password=<span class="hljs-string">"password"</span></span>):
        self.llm = ChatOpenAI(model=<span class="hljs-string">"gpt-5"</span>, temperature=<span class="hljs-number">0</span>)
        <span class="hljs-comment"># 使用LangChain的Neo4j集成</span>
        self.graph_db = Neo4jGraph(
            url=neo4j_uri, 
            username=neo4j_user, 
            password=neo4j_password
        )
        self.nx_graph = nx.Graph()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_entities_and_relations</span>(<span class="hljs-params">self, text: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Dict</span>:
        <span class="hljs-string">"""使用LLM抽取实体和关系"""</span>
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""从以下文本中抽取实体和关系，返回JSON格式：
            文本: {text}
            
            返回格式(只返回JSON):
            {{
                "entities": ["实体1", "实体2", ...],
                "relations": [["实体1", "关系", "实体2"], ...]
            }}"""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        response = chain.invoke({<span class="hljs-string">"text"</span>: text})
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">return</span> json.loads(response)
        <span class="hljs-keyword">except</span>:
            <span class="hljs-keyword">return</span> {<span class="hljs-string">"entities"</span>: [], <span class="hljs-string">"relations"</span>: []}
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_knowledge_graph</span>(<span class="hljs-params">self, documents: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>):
        <span class="hljs-string">"""构建知识图谱"""</span>
        <span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> documents:
            extracted = self.extract_entities_and_relations(doc)
            
            <span class="hljs-comment"># 添加到NetworkX图</span>
            <span class="hljs-keyword">for</span> entity <span class="hljs-keyword">in</span> extracted[<span class="hljs-string">"entities"</span>]:
                self.nx_graph.add_node(entity)
            
            <span class="hljs-keyword">for</span> rel <span class="hljs-keyword">in</span> extracted[<span class="hljs-string">"relations"</span>]:
                <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(rel) == <span class="hljs-number">3</span>:
                    self.nx_graph.add_edge(rel[<span class="hljs-number">0</span>], rel[<span class="hljs-number">2</span>], relation=rel[<span class="hljs-number">1</span>])
            
            <span class="hljs-comment"># 存储到Neo4j</span>
            <span class="hljs-keyword">for</span> entity <span class="hljs-keyword">in</span> extracted[<span class="hljs-string">"entities"</span>]:
                self.graph_db.query(
                    <span class="hljs-string">"MERGE (e:Entity {name: $name})"</span>, 
                    {<span class="hljs-string">"name"</span>: entity}
                )
            <span class="hljs-keyword">for</span> rel <span class="hljs-keyword">in</span> extracted[<span class="hljs-string">"relations"</span>]:
                <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(rel) == <span class="hljs-number">3</span>:
                    self.graph_db.query(
                        <span class="hljs-string">"""MATCH (a:Entity {name: $from})
                           MATCH (b:Entity {name: $to})
                           MERGE (a)-[r:RELATED {type: $rel}]-&gt;(b)"""</span>,
                        {<span class="hljs-string">"from"</span>: rel[<span class="hljs-number">0</span>], <span class="hljs-string">"to"</span>: rel[<span class="hljs-number">2</span>], <span class="hljs-string">"rel"</span>: rel[<span class="hljs-number">1</span>]}
                    )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">detect_communities</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]]:
        <span class="hljs-string">"""社区检测"""</span>
        <span class="hljs-keyword">from</span> networkx.algorithms <span class="hljs-keyword">import</span> community
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.nx_graph.nodes()) == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">return</span> []
        communities = community.louvain_communities(self.nx_graph)
        <span class="hljs-keyword">return</span> [<span class="hljs-built_in">list</span>(c) <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> communities]
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_community_summaries</span>(<span class="hljs-params">self, communities: <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]]</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>]:
        <span class="hljs-string">"""为每个社区生成摘要"""</span>
        summaries = []
        <span class="hljs-keyword">for</span> i, comm <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(communities):
            subgraph = self.nx_graph.subgraph(comm)
            edges_info = [(u, v, d.get(<span class="hljs-string">'relation'</span>, <span class="hljs-string">''</span>)) 
                         <span class="hljs-keyword">for</span> u, v, d <span class="hljs-keyword">in</span> subgraph.edges(data=<span class="hljs-literal">True</span>)]
            
            prompt = ChatPromptTemplate.from_template(
                <span class="hljs-string">"""为以下实体群组生成简短摘要：
                实体: {entities}
                关系: {relations}
                摘要:"""</span>
            )
            chain = prompt | self.llm | StrOutputParser()
            summary = chain.invoke({<span class="hljs-string">"entities"</span>: comm, <span class="hljs-string">"relations"</span>: edges_info})
            summaries.append({<span class="hljs-string">"community"</span>: i, <span class="hljs-string">"entities"</span>: comm, <span class="hljs-string">"summary"</span>: summary})
        <span class="hljs-keyword">return</span> summaries
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">query</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""基于图的检索和回答"""</span>
        <span class="hljs-comment"># 1. 从问题中提取关键实体</span>
        entities = self.extract_entities_and_relations(question)[<span class="hljs-string">"entities"</span>]
        
        <span class="hljs-comment"># 2. 在Neo4j中查找相关子图</span>
        graph_context = self.graph_db.query(
            <span class="hljs-string">"""MATCH (e:Entity)-[r]-(related)
               WHERE e.name IN $entities
               RETURN e.name AS entity, type(r) AS rel_type, 
                      r.type AS relation, related.name AS related_entity
               LIMIT 20"""</span>,
            {<span class="hljs-string">"entities"</span>: entities}
        )
        
        <span class="hljs-comment"># 3. 获取社区摘要</span>
        communities = self.detect_communities()
        summaries = self.generate_community_summaries(communities[:<span class="hljs-number">3</span>])
        
        <span class="hljs-comment"># 4. 生成答案</span>
        context = <span class="hljs-string">f"图关系: <span class="hljs-subst">{graph_context}</span>\n社区摘要: <span class="hljs-subst">{summaries}</span>"</span>
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""基于以下知识图谱信息回答问题：
            {context}
            
            问题: {question}
            答案:"""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        <span class="hljs-keyword">return</span> chain.invoke({<span class="hljs-string">"context"</span>: context, <span class="hljs-string">"question"</span>: question})

<span class="hljs-comment"># 使用示例</span>
grag = GraphRAG()
grag.build_knowledge_graph([
    <span class="hljs-string">"张三是ABC公司的CEO，该公司位于北京"</span>,
    <span class="hljs-string">"李四是ABC公司的CTO，他与张三是大学同学"</span>,
    <span class="hljs-string">"ABC公司开发了产品X，市场份额领先"</span>
])
answer = grag.query(<span class="hljs-string">"ABC公司的领导层有哪些人？"</span>)
<span class="hljs-built_in">print</span>(answer)
</code></pre>
<h2 data-id="heading-5">6. Self RAG</h2>
<p><strong>简介：</strong></p>
<p>Self RAG 提供给模型自我评估和决策能力，它通过四个反思标记（Retrieve/ISREL/ISSUP/ISUSE）来判断：是否需要检索、文档是否相关、答案是否被支持、答案是否有用，模型会生成多个候选答案并综合评分，选择最优结果输出。</p>
<p><strong>架构：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f305a7dcc64a4d119b93fc171c739451~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766818928&amp;x-signature=568LwX2VOeLFWFTprYECRBOGzH0%3D" alt="图片" loading="lazy"/></p>
<p><strong>实现步骤：</strong></p>
<ul>
<li>检索决策：模型首先判断是否需要检索（生成Retrieve标记）</li>
<li>按需检索：如果需要检索，从知识库中获取相关文档</li>
<li>相关性评估：模型评估检索到的文档是否与查询相关（生成ISREL标记）</li>
<li>支持度评估：模型评估生成的内容是否被检索文档支持（生成ISSUP标记）</li>
<li>有用性评估：模型评估生成的回答是否对用户有用（生成ISUSE标记）</li>
<li>自适应生成：基于以上评估标记，模型决定是否使用检索内容、重新检索或直接生成</li>
<li>输出最优答案：选择评分最高的生成结果作为最终输出</li>
</ul>
<p><strong>参考代码：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_huggingface <span class="hljs-keyword">import</span> HuggingFaceEmbeddings
<span class="hljs-keyword">from</span> langchain_community.vectorstores <span class="hljs-keyword">import</span> LanceDB
<span class="hljs-keyword">from</span> langchain.schema <span class="hljs-keyword">import</span> Document
<span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser
<span class="hljs-keyword">import</span> lancedb
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Tuple</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SelfRAG</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.llm = ChatOpenAI(model=<span class="hljs-string">"gpt-4"</span>, temperature=<span class="hljs-number">0</span>)
        <span class="hljs-comment"># 使用轻量级的all-MiniLM-L6-v2模型，仅80MB</span>
        self.embeddings = HuggingFaceEmbeddings(
            model_name=<span class="hljs-string">"sentence-transformers/all-MiniLM-L6-v2"</span>,
            model_kwargs={<span class="hljs-string">"device"</span>: <span class="hljs-string">"cpu"</span>},
            encode_kwargs={<span class="hljs-string">"normalize_embeddings"</span>: <span class="hljs-literal">True</span>}
        )
        self.db = lancedb.connect(<span class="hljs-string">"/tmp/lancedb_self_rag"</span>)
        self.vectorstore = <span class="hljs-literal">None</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_index</span>(<span class="hljs-params">self, documents: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>):
        <span class="hljs-string">"""构建向量索引"""</span>
        docs = [Document(page_content=d) <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> documents]
        self.vectorstore = LanceDB.from_documents(
            docs, 
            self.embeddings,
            connection=self.db,
            table_name=<span class="hljs-string">"self_rag_docs"</span>
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">should_retrieve</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-string">"""判断是否需要检索 (Retrieve标记)"""</span>
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""判断以下问题是否需要检索外部知识来回答。
            问题: {query}
            
            如果问题需要事实性知识、最新信息或特定领域知识，回答YES。
            如果问题是通用问题或推理问题，回答NO。
            只回答YES或NO:"""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        response = chain.invoke({<span class="hljs-string">"query"</span>: query}).strip().upper()
        <span class="hljs-keyword">return</span><span class="hljs-string">"YES"</span><span class="hljs-keyword">in</span> response
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate_relevance</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, document: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-built_in">bool</span>, <span class="hljs-built_in">float</span>]:
        <span class="hljs-string">"""评估文档相关性 (ISREL标记)"""</span>
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""评估文档与问题的相关性，打分1-5分。
            问题: {query}
            文档: {document}
            
            返回格式: 分数|理由
            示例: 4|文档直接回答了问题的核心内容"""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        response = chain.invoke({<span class="hljs-string">"query"</span>: query, <span class="hljs-string">"document"</span>: document})
        <span class="hljs-keyword">try</span>:
            score = <span class="hljs-built_in">int</span>(response.split(<span class="hljs-string">"|"</span>)[<span class="hljs-number">0</span>].strip())
            <span class="hljs-keyword">return</span> score &gt;= <span class="hljs-number">3</span>, score / <span class="hljs-number">5.0</span>
        <span class="hljs-keyword">except</span>:
            returnTrue, <span class="hljs-number">0.6</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate_support</span>(<span class="hljs-params">self, document: <span class="hljs-built_in">str</span>, answer: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-built_in">bool</span>, <span class="hljs-built_in">float</span>]:
        <span class="hljs-string">"""评估答案是否被文档支持 (ISSUP标记)"""</span>
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""评估答案是否被文档内容支持，打分1-5分。
            文档: {document}
            答案: {answer}
            
            返回格式: 分数|理由"""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        response = chain.invoke({<span class="hljs-string">"document"</span>: document, <span class="hljs-string">"answer"</span>: answer})
        <span class="hljs-keyword">try</span>:
            score = <span class="hljs-built_in">int</span>(response.split(<span class="hljs-string">"|"</span>)[<span class="hljs-number">0</span>].strip())
            <span class="hljs-keyword">return</span> score &gt;= <span class="hljs-number">3</span>, score / <span class="hljs-number">5.0</span>
        <span class="hljs-keyword">except</span>:
            returnTrue, <span class="hljs-number">0.6</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate_usefulness</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, answer: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-built_in">bool</span>, <span class="hljs-built_in">float</span>]:
        <span class="hljs-string">"""评估答案有用性 (ISUSE标记)"""</span>
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""评估答案对用户问题的有用程度，打分1-5分。
            问题: {query}
            答案: {answer}
            
            返回格式: 分数|理由"""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        response = chain.invoke({<span class="hljs-string">"query"</span>: query, <span class="hljs-string">"answer"</span>: answer})
        <span class="hljs-keyword">try</span>:
            score = <span class="hljs-built_in">int</span>(response.split(<span class="hljs-string">"|"</span>)[<span class="hljs-number">0</span>].strip())
            <span class="hljs-keyword">return</span> score &gt;= <span class="hljs-number">3</span>, score / <span class="hljs-number">5.0</span>
        <span class="hljs-keyword">except</span>:
            returnTrue, <span class="hljs-number">0.6</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_with_context</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, context: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""基于上下文生成答案"""</span>
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""基于以下上下文回答问题。如果上下文不足以回答，请说明。
            上下文: {context}
            问题: {query}
            答案:"""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        <span class="hljs-keyword">return</span> chain.invoke({<span class="hljs-string">"context"</span>: context, <span class="hljs-string">"query"</span>: query})
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_without_context</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""不使用检索直接生成"""</span>
        prompt = ChatPromptTemplate.from_template(<span class="hljs-string">"请回答以下问题: {query}"</span>)
        chain = prompt | self.llm | StrOutputParser()
        <span class="hljs-keyword">return</span> chain.invoke({<span class="hljs-string">"query"</span>: query})
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">query</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""Self-RAG主流程"""</span>
        <span class="hljs-comment"># 1. 检索决策</span>
        need_retrieval = self.should_retrieve(question)
        
        ifnot need_retrieval:
            <span class="hljs-comment"># 直接生成</span>
            answer = self.generate_without_context(question)
            _, usefulness = self.evaluate_usefulness(question, answer)
            <span class="hljs-keyword">return</span> answer
        
        <span class="hljs-comment"># 2. 检索文档</span>
        retriever = self.vectorstore.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">3</span>})
        docs = retriever.invoke(question)
        
        <span class="hljs-comment"># 3. 对每个文档生成候选答案并评分</span>
        candidates = []
        <span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> docs:
            <span class="hljs-comment"># 评估相关性 (ISREL)</span>
            is_relevant, rel_score = self.evaluate_relevance(question, doc.page_content)
            ifnot is_relevant:
                <span class="hljs-keyword">continue</span>
            
            <span class="hljs-comment"># 生成答案</span>
            answer = self.generate_with_context(question, doc.page_content)
            
            <span class="hljs-comment"># 评估支持度 (ISSUP)</span>
            is_supported, sup_score = self.evaluate_support(doc.page_content, answer)
            
            <span class="hljs-comment"># 评估有用性 (ISUSE)</span>
            is_useful, use_score = self.evaluate_usefulness(question, answer)
            
            <span class="hljs-comment"># 综合评分</span>
            total_score = rel_score * <span class="hljs-number">0.3</span> + sup_score * <span class="hljs-number">0.4</span> + use_score * <span class="hljs-number">0.3</span>
            candidates.append((answer, total_score))
        
        <span class="hljs-comment"># 4. 选择最佳答案</span>
        <span class="hljs-keyword">if</span> candidates:
            candidates.sort(key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">1</span>], reverse=<span class="hljs-literal">True</span>)
            <span class="hljs-keyword">return</span> candidates[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># 如果没有合适的检索结果，直接生成</span>
            <span class="hljs-keyword">return</span> self.generate_without_context(question)

<span class="hljs-comment"># 使用示例</span>
srag = SelfRAG()
srag.build_index([<span class="hljs-string">"文档1内容..."</span>, <span class="hljs-string">"文档2内容..."</span>, <span class="hljs-string">"文档3内容..."</span>])
answer = srag.query(<span class="hljs-string">"你的问题是什么？"</span>)
<span class="hljs-built_in">print</span>(answer)
</code></pre>
<h2 data-id="heading-6">7. Adaptive RAG</h2>
<p><strong>简介：</strong></p>
<p>Adaptive RAG 根据查询的类型和复杂度动态选择最优的处理策略。</p>
<p><strong>架构：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/867cf90ae2aa496eb94c184bbfc132a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766818928&amp;x-signature=n8LHCBmrPpc99fZg4kO7JcJl4h0%3D" alt="图片" loading="lazy"/></p>
<p><strong>实现步骤：</strong></p>
<ul>
<li>查询分类：分析用户查询的类型和复杂度（简单事实/多跳推理/开放性问题）</li>
<li>策略选择：根据查询类型选择最优的RAG策略</li>
<li>
<ul>
<li>简单查询：直接LLM回答或单次检索</li>
<li>复杂查询：多轮迭代检索</li>
<li>开放性问题：结合网络搜索</li>
</ul>
</li>
<li>动态路由：将查询路由到对应的处理流程</li>
<li>自适应检索：根据中间结果动态调整检索深度和范围</li>
<li>结果整合：整合不同策略的结果生成最终答案</li>
</ul>
<p><strong>参考代码：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_huggingface <span class="hljs-keyword">import</span> HuggingFaceEmbeddings
<span class="hljs-keyword">from</span> langchain_community.vectorstores <span class="hljs-keyword">import</span> LanceDB
<span class="hljs-keyword">from</span> langchain.schema <span class="hljs-keyword">import</span> Document
<span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser
<span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnableLambda, RunnablePassthrough
<span class="hljs-keyword">import</span> lancedb
<span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> Enum
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">QueryType</span>(<span class="hljs-title class_ inherited__">Enum</span>):
    SIMPLE = <span class="hljs-string">"simple"</span>           <span class="hljs-comment"># 简单事实查询</span>
    MULTI_HOP = <span class="hljs-string">"multi_hop"</span>     <span class="hljs-comment"># 多跳推理查询</span>
    OPEN_ENDED = <span class="hljs-string">"open_ended"</span>   <span class="hljs-comment"># 开放性问题</span>
    NO_RETRIEVAL = <span class="hljs-string">"no_retrieval"</span><span class="hljs-comment"># 不需要检索</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AdaptiveRAG</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.llm = ChatOpenAI(model=<span class="hljs-string">"gpt-4"</span>, temperature=<span class="hljs-number">0</span>)
        <span class="hljs-comment"># 使用轻量级的all-MiniLM-L6-v2模型，仅80MB</span>
        self.embeddings = HuggingFaceEmbeddings(
            model_name=<span class="hljs-string">"sentence-transformers/all-MiniLM-L6-v2"</span>,
            model_kwargs={<span class="hljs-string">"device"</span>: <span class="hljs-string">"cpu"</span>},
            encode_kwargs={<span class="hljs-string">"normalize_embeddings"</span>: <span class="hljs-literal">True</span>}
        )
        self.db = lancedb.connect(<span class="hljs-string">"/tmp/lancedb_adaptive_rag"</span>)
        self.vectorstore = <span class="hljs-literal">None</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_index</span>(<span class="hljs-params">self, documents: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>):
        <span class="hljs-string">"""构建向量索引"""</span>
        docs = [Document(page_content=d) <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> documents]
        self.vectorstore = LanceDB.from_documents(
            docs, 
            self.embeddings,
            connection=self.db,
            table_name=<span class="hljs-string">"adaptive_rag_docs"</span>
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">classify_query</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span></span>) -&gt; QueryType:
        <span class="hljs-string">"""分类查询类型"""</span>
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""分析以下查询的类型，返回对应类别：
            查询: {query}
            
            类别说明:
            - SIMPLE: 简单的事实性问题，可以直接从单个文档找到答案
            - MULTI_HOP: 需要综合多个信息源进行推理的复杂问题
            - OPEN_ENDED: 开放性问题，需要广泛的知识和创造性思考
            - NO_RETRIEVAL: 通用知识问题，不需要检索即可回答
            
            只返回类别名称(SIMPLE/MULTI_HOP/OPEN_ENDED/NO_RETRIEVAL):"""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        response = chain.invoke({<span class="hljs-string">"query"</span>: query}).strip().upper()
        mapping = {
            <span class="hljs-string">"SIMPLE"</span>: QueryType.SIMPLE,
            <span class="hljs-string">"MULTI_HOP"</span>: QueryType.MULTI_HOP,
            <span class="hljs-string">"OPEN_ENDED"</span>: QueryType.OPEN_ENDED,
            <span class="hljs-string">"NO_RETRIEVAL"</span>: QueryType.NO_RETRIEVAL
        }
        <span class="hljs-keyword">return</span> mapping.get(response, QueryType.SIMPLE)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">simple_rag</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""简单RAG：单次检索"""</span>
        retriever = self.vectorstore.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">2</span>})
        
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"基于以下内容回答问题：\n{context}\n\n问题：{question}\n答案："</span>
        )
        
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">format_docs</span>(<span class="hljs-params">docs</span>):
            <span class="hljs-keyword">return</span><span class="hljs-string">"\n"</span>.join([d.page_content <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> docs])
        
        chain = (
            {<span class="hljs-string">"context"</span>: retriever | format_docs, <span class="hljs-string">"question"</span>: RunnablePassthrough()}
            | prompt
            | self.llm
            | StrOutputParser()
        )
        <span class="hljs-keyword">return</span> chain.invoke(query)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">multi_hop_rag</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, max_hops: <span class="hljs-built_in">int</span> = <span class="hljs-number">3</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""多跳RAG：迭代检索"""</span>
        accumulated_context = []
        current_query = query
        retriever = self.vectorstore.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">2</span>})
        
        <span class="hljs-keyword">for</span> hop <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(max_hops):
            <span class="hljs-comment"># 检索</span>
            docs = retriever.invoke(current_query)
            accumulated_context.extend([d.page_content <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> docs])
            
            <span class="hljs-comment"># 检查是否已有足够信息</span>
            context = <span class="hljs-string">"\n"</span>.join(accumulated_context)
            check_prompt = ChatPromptTemplate.from_template(
                <span class="hljs-string">"""基于当前收集的信息，判断是否足够回答问题。
                收集的信息: {context}
                问题: {query}
                
                回答YES如果信息足够，回答NO如果需要更多信息。
                如果回答NO，请提供下一步应该搜索的子问题。
                格式: YES 或 NO|子问题"""</span>
            )
            check_chain = check_prompt | self.llm | StrOutputParser()
            check_response = check_chain.invoke({<span class="hljs-string">"context"</span>: context, <span class="hljs-string">"query"</span>: query})
            
            <span class="hljs-keyword">if</span> check_response.strip().upper().startswith(<span class="hljs-string">"YES"</span>):
                <span class="hljs-keyword">break</span>
            eli<span class="hljs-string">f"|"</span><span class="hljs-keyword">in</span> check_response:
                current_query = check_response.split(<span class="hljs-string">"|"</span>)[<span class="hljs-number">1</span>].strip()
        
        <span class="hljs-comment"># 生成最终答案</span>
        final_context = <span class="hljs-string">"\n"</span>.join(accumulated_context)
        final_prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"综合以下信息回答问题：\n{context}\n\n问题：{question}\n答案："</span>
        )
        final_chain = final_prompt | self.llm | StrOutputParser()
        <span class="hljs-keyword">return</span> final_chain.invoke({<span class="hljs-string">"context"</span>: final_context, <span class="hljs-string">"question"</span>: query})
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">open_ended_rag</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""开放性RAG：广泛检索+创造性生成"""</span>
        <span class="hljs-comment"># 扩展查询</span>
        expand_prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"为以下问题生成3个相关的搜索查询：\n{query}\n查询列表："</span>
        )
        expand_chain = expand_prompt | self.llm | StrOutputParser()
        expanded = expand_chain.invoke({<span class="hljs-string">"query"</span>: query})
        queries = [query] + [q.strip() <span class="hljs-keyword">for</span> q <span class="hljs-keyword">in</span> expanded.split(<span class="hljs-string">"\n"</span>) <span class="hljs-keyword">if</span> q.strip()][:<span class="hljs-number">3</span>]
        
        <span class="hljs-comment"># 多查询检索</span>
        retriever = self.vectorstore.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">2</span>})
        all_docs = []
        <span class="hljs-keyword">for</span> q <span class="hljs-keyword">in</span> queries:
            docs = retriever.invoke(q)
            all_docs.extend([d.page_content <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> docs])
        
        <span class="hljs-comment"># 去重</span>
        unique_docs = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">set</span>(all_docs))
        context = <span class="hljs-string">"\n"</span>.join(unique_docs[:<span class="hljs-number">5</span>])
        
        final_prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""基于以下信息，对问题给出全面、有见地的回答：
            信息: {context}
            问题: {question}
            
            请提供详细的分析和见解："""</span>
        )
        final_chain = final_prompt | self.llm | StrOutputParser()
        <span class="hljs-keyword">return</span> final_chain.invoke({<span class="hljs-string">"context"</span>: context, <span class="hljs-string">"question"</span>: query})
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">no_retrieval_generate</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""直接生成：不使用检索"""</span>
        prompt = ChatPromptTemplate.from_template(<span class="hljs-string">"请回答：{query}"</span>)
        chain = prompt | self.llm | StrOutputParser()
        <span class="hljs-keyword">return</span> chain.invoke({<span class="hljs-string">"query"</span>: query})
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">query</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""自适应查询主流程 - 使用LangChain路由"""</span>
        <span class="hljs-comment"># 1. 分类查询</span>
        query_type = self.classify_query(question)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"查询类型: <span class="hljs-subst">{query_type.value}</span>"</span>)
        
        <span class="hljs-comment"># 2. 路由到对应策略</span>
        routing_map = {
            QueryType.SIMPLE: self.simple_rag,
            QueryType.MULTI_HOP: self.multi_hop_rag,
            QueryType.OPEN_ENDED: self.open_ended_rag,
            QueryType.NO_RETRIEVAL: self.no_retrieval_generate
        }
        <span class="hljs-keyword">return</span> routing_map[query_type](question)

<span class="hljs-comment"># 使用示例</span>
arag = AdaptiveRAG()
arag.build_index([<span class="hljs-string">"公司财报数据..."</span>, <span class="hljs-string">"市场分析报告..."</span>, <span class="hljs-string">"行业趋势..."</span>])
answer = arag.query(<span class="hljs-string">"分析公司未来的发展前景"</span>)  <span class="hljs-comment"># 会被识别为OPEN_ENDED</span>
<span class="hljs-built_in">print</span>(answer)
</code></pre>
<h2 data-id="heading-7">8. SFR RAG</h2>
<p><strong>简介：</strong></p>
<p>SFR RAG（Salesforce Research RAG）是工业级高质量 RAG 的最佳实践。它采用经过指令微调的高性能 embedding 模型（如 BGE），结合 Cross-Encoder 重排序、上下文压缩、引用生成和质量验证等多项优化技术。</p>
<p><strong>架构：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad02654af9d646f2854979047c43080d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766818928&amp;x-signature=zLZu5nudCscefZbhgOBpnlaA%2BKA%3D" alt="图片" loading="lazy"/></p>
<p><strong>实现步骤：</strong></p>
<ul>
<li>高质量Embedding：使用SFR（Salesforce Research）的高性能embedding模型进行文档和查询编码</li>
<li>指令微调检索：使用指令微调的检索模型，支持多种检索任务（问答、摘要、事实核查等）</li>
<li>上下文压缩：对检索到的文档进行智能压缩，去除冗余信息</li>
<li>重排序：使用专门的重排序模型对候选文档进行精细排序</li>
<li>引用生成：生成答案时附带引用来源，提高可信度</li>
<li>质量控制：对生成结果进行事实性检验和质量评估</li>
</ul>
<p><strong>参考代码：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_community.embeddings <span class="hljs-keyword">import</span> HuggingFaceBgeEmbeddings
<span class="hljs-keyword">from</span> langchain_community.vectorstores <span class="hljs-keyword">import</span> LanceDB
<span class="hljs-keyword">from</span> langchain_community.cross_encoders <span class="hljs-keyword">import</span> HuggingFaceCrossEncoder
<span class="hljs-keyword">from</span> langchain.retrievers.document_compressors <span class="hljs-keyword">import</span> CrossEncoderReranker
<span class="hljs-keyword">from</span> langchain.retrievers <span class="hljs-keyword">import</span> ContextualCompressionRetriever
<span class="hljs-keyword">from</span> langchain.schema <span class="hljs-keyword">import</span> Document
<span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser
<span class="hljs-keyword">import</span> lancedb
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SFRRAG</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 使用BGE高质量Embedding模型</span>
        self.embeddings = HuggingFaceBgeEmbeddings(
            model_name=<span class="hljs-string">"BAAI/bge-large-en-v1.5"</span>,
            model_kwargs={<span class="hljs-string">"device"</span>: <span class="hljs-string">"cpu"</span>},
            encode_kwargs={<span class="hljs-string">"normalize_embeddings"</span>: <span class="hljs-literal">True</span>},
            query_instruction=<span class="hljs-string">"为检索任务生成查询表示: "</span>
        )
        <span class="hljs-comment"># 重排序模型</span>
        self.reranker_model = HuggingFaceCrossEncoder(
            model_name=<span class="hljs-string">"cross-encoder/ms-marco-MiniLM-L-6-v2"</span>
        )
        self.llm = ChatOpenAI(model=<span class="hljs-string">"gpt-5"</span>, temperature=<span class="hljs-number">0</span>)
        self.db = lancedb.connect(<span class="hljs-string">"./lancedb_sfr_rag"</span>)
        self.vectorstore = <span class="hljs-literal">None</span>
        self.documents = []
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_index</span>(<span class="hljs-params">self, documents: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>):
        <span class="hljs-string">"""构建高质量向量索引"""</span>
        self.documents = documents
        docs = [Document(page_content=d) <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> documents]
        self.vectorstore = LanceDB.from_documents(
            docs, 
            self.embeddings,
            connection=self.db,
            table_name=<span class="hljs-string">"sfr_rag_docs"</span>
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_retriever_with_reranker</span>(<span class="hljs-params">self, top_k: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span></span>):
        <span class="hljs-string">"""创建带重排序的检索器"""</span>
        <span class="hljs-comment"># 基础检索器</span>
        base_retriever = self.vectorstore.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">10</span>})
        
        <span class="hljs-comment"># 重排序压缩器</span>
        reranker = CrossEncoderReranker(
            model=self.reranker_model, 
            top_n=top_k
        )
        
        <span class="hljs-comment"># 组合检索器</span>
        <span class="hljs-keyword">return</span> ContextualCompressionRetriever(
            base_compressor=reranker,
            base_retriever=base_retriever
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress_context</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, documents: <span class="hljs-type">List</span>[Document]</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""上下文压缩"""</span>
        doc_texts = <span class="hljs-string">"\n"</span>.join([<span class="hljs-string">f"[<span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>] <span class="hljs-subst">{doc.page_content}</span>"</span>
                              <span class="hljs-keyword">for</span> i, doc <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(documents)])
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""提取以下文档中与问题相关的关键信息：
            问题: {query}
            
            文档:
            {documents}
            
            请返回压缩后的关键信息，保留文档编号以便引用："""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        <span class="hljs-keyword">return</span> chain.invoke({<span class="hljs-string">"query"</span>: query, <span class="hljs-string">"documents"</span>: doc_texts})
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_with_citations</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, context: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""生成带引用的答案"""</span>
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""基于以下上下文回答问题，并标注引用来源[1][2]等。
            
            上下文: {context}
            
            问题: {query}
            
            要求：
            1. 准确回答问题
            2. 在相关陈述后标注引用来源
            3. 如果上下文不足以回答，请说明
            
            答案："""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        <span class="hljs-keyword">return</span> chain.invoke({<span class="hljs-string">"context"</span>: context, <span class="hljs-string">"query"</span>: query})
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">verify_answer</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, answer: <span class="hljs-built_in">str</span>, documents: <span class="hljs-type">List</span>[Document]</span>) -&gt; <span class="hljs-type">Dict</span>:
        <span class="hljs-string">"""验证答案质量"""</span>
        doc_contents = [doc.page_content <span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> documents]
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"""评估以下答案的质量：
            问题: {query}
            答案: {answer}
            参考文档: {documents}
            
            评估维度(1-5分)：
            1. 准确性：答案是否被文档支持
            2. 完整性：答案是否全面回答了问题
            3. 相关性：答案是否紧扣问题
            
            返回格式: 准确性分数|完整性分数|相关性分数|总评"""</span>
        )
        chain = prompt | self.llm | StrOutputParser()
        response = chain.invoke({
            <span class="hljs-string">"query"</span>: query, 
            <span class="hljs-string">"answer"</span>: answer, 
            <span class="hljs-string">"documents"</span>: doc_contents
        })
        <span class="hljs-keyword">try</span>:
            parts = response.split(<span class="hljs-string">"|"</span>)
            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">"accuracy"</span>: <span class="hljs-built_in">int</span>(parts[<span class="hljs-number">0</span>].strip()),
                <span class="hljs-string">"completeness"</span>: <span class="hljs-built_in">int</span>(parts[<span class="hljs-number">1</span>].strip()),
                <span class="hljs-string">"relevance"</span>: <span class="hljs-built_in">int</span>(parts[<span class="hljs-number">2</span>].strip()),
                <span class="hljs-string">"summary"</span>: parts[<span class="hljs-number">3</span>].strip() <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) &gt; <span class="hljs-number">3</span><span class="hljs-keyword">else</span><span class="hljs-string">""</span>
            }
        <span class="hljs-keyword">except</span>:
            <span class="hljs-keyword">return</span> {<span class="hljs-string">"accuracy"</span>: <span class="hljs-number">3</span>, <span class="hljs-string">"completeness"</span>: <span class="hljs-number">3</span>, <span class="hljs-string">"relevance"</span>: <span class="hljs-number">3</span>, <span class="hljs-string">"summary"</span>: <span class="hljs-string">""</span>}
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">query</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Dict</span>:
        <span class="hljs-string">"""SFR-RAG主流程"""</span>
        <span class="hljs-comment"># 1. 初始检索 + 重排序</span>
        retriever = self.get_retriever_with_reranker(top_k=<span class="hljs-number">5</span>)
        docs = retriever.invoke(question)
        
        <span class="hljs-comment"># 2. 上下文压缩</span>
        compressed_context = self.compress_context(question, docs)
        
        <span class="hljs-comment"># 3. 生成带引用的答案</span>
        answer = self.generate_with_citations(question, compressed_context)
        
        <span class="hljs-comment"># 4. 质量验证</span>
        quality = self.verify_answer(question, answer, docs)
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"answer"</span>: answer,
            <span class="hljs-string">"sources"</span>: [{<span class="hljs-string">"content"</span>: doc.page_content[:<span class="hljs-number">100</span>]} <span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> docs],
            <span class="hljs-string">"quality"</span>: quality
        }

<span class="hljs-comment"># 使用示例</span>
sfr_rag = SFRRAG()
sfr_rag.build_index([
    <span class="hljs-string">"人工智能是计算机科学的一个分支..."</span>,
    <span class="hljs-string">"机器学习是AI的核心技术之一..."</span>,
    <span class="hljs-string">"深度学习使用神经网络进行学习..."</span>
])
result = sfr_rag.query(<span class="hljs-string">"什么是人工智能？"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"答案: <span class="hljs-subst">{result[<span class="hljs-string">'answer'</span>]}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"质量评估: <span class="hljs-subst">{result[<span class="hljs-string">'quality'</span>]}</span>"</span>)
</code></pre>
<h2 data-id="heading-8">参考</h2>
<p>（1）<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Foverview" target="_blank" title="https://docs.langchain.com/oss/python/langchain/overview" ref="nofollow noopener noreferrer">docs.langchain.com/oss/python/…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解决Tailwind任意值滥用：规范化CSS开发体验]]></title>    <link>https://juejin.cn/post/7585382553290752036</link>    <guid>https://juejin.cn/post/7585382553290752036</guid>    <pubDate>2025-12-20T07:15:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585382553290752036" data-draft-id="7585031571889930283" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解决Tailwind任意值滥用：规范化CSS开发体验"/> <meta itemprop="keywords" content="前端,CSS,ESLint"/> <meta itemprop="datePublished" content="2025-12-20T07:15:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="远山无期"/> <meta itemprop="url" content="https://juejin.cn/user/1310273590526728"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解决Tailwind任意值滥用：规范化CSS开发体验
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1310273590526728/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    远山无期
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T07:15:30.000Z" title="Sat Dec 20 2025 07:15:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>背景 <code>eslint-plugin-tailwindcss</code>插件的<code>no-unnecessary-arbitrary-value</code>无法对所有的任意值进行校验，比如<code>h-[48px]</code>、<code>text-[#f5f5f5]</code>无法校验出来。但tailwindcss的预设值太多了，一个不小心可能就又写了一个没有必要的任意值。为了避免这种情况，我们需要自己实现一个检测任意值的eslint插件。</p>
</blockquote>
<h2 data-id="heading-0">插件地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Feslint-plugin-tailwind-no-preset-class" target="_blank" title="https://www.npmjs.com/package/eslint-plugin-tailwind-no-preset-class" ref="nofollow noopener noreferrer">eslint-plugin-tailwind-no-preset-class</a></h2>
<h2 data-id="heading-1">首先来看下效果</h2>
<h3 data-id="heading-2">no-unnecessary-arbitrary-value 无法检测的情况</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/043c2b930ece4a7285c452a827c0d3aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-c5bGx5peg5pyf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766819730&amp;x-signature=F%2B9oCeYocy4yAlLcoktqfAdeMLM%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">使用自定义的：eslint-plugin-tailwind-no-preset-class插件，完美完成了校验</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ead78aa0a4746c48b6f75e2552a51b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-c5bGx5peg5pyf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766819730&amp;x-signature=NCb9n8Gm87M%2Bb83i5qxtHcHHrFk%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">创建eslint插件标准目录结构</h2>
<ul>
<li>安装Yeoman</li>
</ul>
<pre><code class="hljs language-sh" lang="sh">npm install -g yo
</code></pre>
<ul>
<li>安装Yeoman generator-eslint</li>
</ul>
<pre><code class="hljs language-sh" lang="sh">npm install -g generator-eslint
</code></pre>
<ul>
<li>创建项目</li>
</ul>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-built_in">mkdir</span> eslint-plugin-my-plugin
yo eslint:plugin
</code></pre>
<p>生成目录结构如下：</p>
<pre><code class="hljs language-perl" lang="perl">eslint-plugin-<span class="hljs-keyword">my</span>-plugin/
├── lib/                    <span class="hljs-comment"># 核心源代码目录</span>
│   ├── index.js           <span class="hljs-comment"># 插件的入口文件，在这里导出所有规则</span>
│   └── rules/             <span class="hljs-comment"># 存放所有自定义规则的目录</span>
│       └── <span class="hljs-keyword">my</span>-rule.js     <span class="hljs-comment"># 生成器为你创建的一条示例规则文件</span>
├── tests/                 <span class="hljs-comment"># 测试文件目录</span>
│   └── lib/
│       └── rules/
│           └── <span class="hljs-keyword">my</span>-rule.js <span class="hljs-comment"># 示例规则对应的测试文件</span>
├── package.json           <span class="hljs-comment"># 项目的 npm 配置文件，依赖和元信息都在这里</span>
└── README.md              <span class="hljs-comment"># 项目说明文档</span>
</code></pre>
<h2 data-id="heading-5">根据实际项目的tailwindcss配置文件和tailwindcss默认配置生成全量定制化配置，用于后续eslint插件的校验依据</h2>
<h3 data-id="heading-6">实现配置文件生成并加载方法：</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// lib/tailwind-config-loader.js</span>
<span class="hljs-comment">// 配置文件生成</span>
...
...
<span class="hljs-comment">// 动态加载 Tailwind 预设配置</span>
<span class="hljs-keyword">let</span> tailwindPresetConfig = <span class="hljs-literal">null</span>;
...
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">generateTailwindConfig</span>(<span class="hljs-params">projectRootPath</span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 动态导入tailwindcss</span>
    <span class="hljs-keyword">const</span> resolveConfigModule = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'tailwindcss/lib/public/resolve-config.js'</span>);
    <span class="hljs-keyword">const</span> resolveConfig = resolveConfigModule.<span class="hljs-property">default</span>.<span class="hljs-property">default</span>
    <span class="hljs-comment">// 尝试加载项目配置</span>
    <span class="hljs-keyword">let</span> projectConfig = {};
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> projectConfigPath = <span class="hljs-title function_">join</span>(projectRootPath||process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'tailwind.config.js'</span>);
      <span class="hljs-keyword">const</span> projectConfigModule = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(projectConfigPath);
      projectConfig = projectConfigModule.<span class="hljs-property">default</span> || projectConfigModule;
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'⚠️ 未找到项目 tailwind.config.js，使用默认配置'</span>);
      <span class="hljs-keyword">throw</span> error;
    }

    <span class="hljs-comment">// 使用tailwindcss的resolveConfig函数</span>
    <span class="hljs-keyword">const</span> finalConfig = <span class="hljs-title function_">resolveConfig</span>(projectConfig);

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'✅ Tailwind preset config generated successfully!'</span>);
    
    <span class="hljs-keyword">return</span> finalConfig;
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'❌ 生成Tailwind配置失败:'</span>, error.<span class="hljs-property">message</span>);
    <span class="hljs-keyword">throw</span> error;
  }
}


<span class="hljs-comment">// 加载配置到内存中</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadTailwindPresetConfig</span>(<span class="hljs-params">projectRootPath</span>) {
  <span class="hljs-keyword">if</span> (configLoading) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'⏳ 配置正在加载中，跳过重复请求'</span>);
    <span class="hljs-keyword">return</span>;
  }

  configLoading = <span class="hljs-literal">true</span>;

  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 直接动态生成配置</span>
    tailwindPresetConfig = <span class="hljs-keyword">await</span> <span class="hljs-title function_">generateTailwindConfig</span>(projectRootPath);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'✅ Tailwind 预设配置已动态生成并加载'</span>);
    <span class="hljs-title function_">onConfigLoaded</span>();
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'❌ 动态生成 Tailwind 预设配置失败:'</span>, error.<span class="hljs-property">message</span>);
    <span class="hljs-title function_">onConfigLoadFailed</span>(error);
    <span class="hljs-keyword">throw</span> error;
  }
}


...
<span class="hljs-comment">// 导出配置</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">TailwindConfigLoader</span> = {
  <span class="hljs-attr">getConfig</span>: <span class="hljs-function">() =&gt;</span> tailwindPresetConfig,
  <span class="hljs-attr">isLoaded</span>: <span class="hljs-function">() =&gt;</span> configLoaded,
  <span class="hljs-attr">ensureLoaded</span>: ensureConfigLoaded,
  <span class="hljs-attr">reload</span>: loadTailwindPresetConfig,
  <span class="hljs-attr">generateConfig</span>: generateTailwindConfig
};
...
...

</code></pre>
<h3 data-id="heading-7">创建校验规则函数</h3>
<ul>
<li>实现校验规则函数<code>checkAndReport</code></li>
</ul>
<pre><code class="hljs language-js" lang="js">...
<span class="hljs-comment">// 使用 WeakMap 来跟踪每个文件的已报告类名，避免重复报告</span>
<span class="hljs-keyword">const</span> reportedClassesMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>();
...
<span class="hljs-comment">// 检查并报告</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">checkAndReport</span>(<span class="hljs-params">context, node, className</span>) {
  <span class="hljs-comment">// 如果配置尚未加载，尝试等待加载</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">TailwindConfigLoader</span>.<span class="hljs-title function_">isLoaded</span>()) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> projectRootPath = context.<span class="hljs-title function_">getCwd</span>();
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`正在等待加载配置文件 <span class="hljs-subst">${projectRootPath}</span>...`</span>);
      <span class="hljs-keyword">const</span> loaded = <span class="hljs-keyword">await</span> <span class="hljs-title class_">TailwindConfigLoader</span>.<span class="hljs-title function_">ensureLoaded</span>(projectRootPath);
      <span class="hljs-keyword">if</span> (!loaded) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'⚠️ Tailwind 预设配置尚未加载，跳过检查'</span>);
        <span class="hljs-keyword">return</span>;
      }
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'⚠️ 配置加载失败，跳过检查'</span>);
      <span class="hljs-keyword">return</span>;
    }
  }

  <span class="hljs-keyword">const</span> filePath = context.<span class="hljs-title function_">getFilename</span>();
  <span class="hljs-keyword">const</span> filePathWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilePathWrapper</span>(filePath);

  <span class="hljs-keyword">if</span> (!reportedClassesMap.<span class="hljs-title function_">has</span>(filePathWrapper)) {
    reportedClassesMap.<span class="hljs-title function_">set</span>(filePathWrapper, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>());
  }
  <span class="hljs-keyword">const</span> reportedClasses = reportedClassesMap.<span class="hljs-title function_">get</span>(filePathWrapper);

  <span class="hljs-keyword">if</span> (reportedClasses.<span class="hljs-title function_">has</span>(className)) {
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">const</span> propertyInfo = <span class="hljs-title function_">extractProperty</span>(className);
  <span class="hljs-keyword">if</span> (!propertyInfo) {
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">const</span> { property, value, originalPrefix } = propertyInfo;

  <span class="hljs-comment">// 只检查任意值</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isArbitraryValue</span>(value)) {
    <span class="hljs-keyword">const</span> arbitraryValue = value.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>);
    <span class="hljs-keyword">const</span> presetClass = <span class="hljs-title function_">findPresetClass</span>(property, arbitraryValue);

    <span class="hljs-keyword">if</span> (presetClass) {
      reportedClasses.<span class="hljs-title function_">add</span>(className);
      <span class="hljs-comment">// 使用原始前缀显示正确的类名格式（如 h-14 而不是 height-14）</span>
      <span class="hljs-keyword">const</span> suggestedClass = <span class="hljs-string">`<span class="hljs-subst">${originalPrefix}</span><span class="hljs-subst">${presetClass}</span>`</span>;
      context.<span class="hljs-title function_">report</span>({
        node,
        <span class="hljs-attr">message</span>: <span class="hljs-string">`类名 "<span class="hljs-subst">${className}</span>" 使用了任意值，但存在对应的预设类名 "<span class="hljs-subst">${suggestedClass}</span>"。请使用预设类名替代。`</span>,
      });
    }
  }
}

</code></pre>
<ul>
<li>实现属性提取，将classname解析为tailwindcss的property和value</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 提取属性值</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">extractProperty</span>(<span class="hljs-params">className</span>) {
  <span class="hljs-comment">// 处理响应式前缀（如 max-md:, md:, lg: 等）</span>
  <span class="hljs-keyword">const</span> responsivePrefixes = [
    <span class="hljs-string">'max-sm:'</span>,
    <span class="hljs-string">'max-md:'</span>,
    <span class="hljs-string">'max-lg:'</span>,
    <span class="hljs-string">'max-xl:'</span>,
    <span class="hljs-string">'max-2xl:'</span>,
    <span class="hljs-string">'max-'</span>,
    <span class="hljs-string">'min-'</span>,
    <span class="hljs-string">'sm:'</span>,
    <span class="hljs-string">'md:'</span>,
    <span class="hljs-string">'lg:'</span>,
    <span class="hljs-string">'xl:'</span>,
    <span class="hljs-string">'2xl:'</span>,
  ];

  <span class="hljs-comment">// 移除响应式前缀，保留核心类名</span>
  <span class="hljs-keyword">let</span> coreClassName = className;
  <span class="hljs-keyword">let</span> responsivePrefix = <span class="hljs-string">''</span>;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> prefix <span class="hljs-keyword">of</span> responsivePrefixes) {
    <span class="hljs-keyword">if</span> (className.<span class="hljs-title function_">startsWith</span>(prefix)) {
      responsivePrefix = prefix;
      coreClassName = className.<span class="hljs-title function_">slice</span>(prefix.<span class="hljs-property">length</span>);
      <span class="hljs-keyword">break</span>;
    }
  }

  <span class="hljs-comment">// 按前缀长度降序排序，优先匹配更长的前缀</span>
  <span class="hljs-keyword">const</span> sortedPrefixes = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(prefixToProperty).<span class="hljs-title function_">sort</span>(
    <span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> b.<span class="hljs-property">length</span> - a.<span class="hljs-property">length</span>
  );

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> prefix <span class="hljs-keyword">of</span> sortedPrefixes) {
    <span class="hljs-keyword">if</span> (coreClassName.<span class="hljs-title function_">startsWith</span>(prefix)) {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">property</span>: prefixToProperty[prefix],
        <span class="hljs-attr">value</span>: coreClassName.<span class="hljs-title function_">slice</span>(prefix.<span class="hljs-property">length</span>),
        <span class="hljs-attr">originalPrefix</span>: responsivePrefix + prefix, <span class="hljs-comment">// 包含响应式前缀</span>
      };
    }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<ul>
<li>将提取的property和前面生成的全量的tailwindcss进行映射</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 简化属性映射，只保留常用的属性</span>
<span class="hljs-keyword">const</span> prefixToProperty = {
  <span class="hljs-comment">// 尺寸相关</span>
  <span class="hljs-string">"w-"</span>: <span class="hljs-string">"width"</span>,
  <span class="hljs-string">"h-"</span>: <span class="hljs-string">"height"</span>,
  <span class="hljs-string">"min-w-"</span>: <span class="hljs-string">"minWidth"</span>,
  <span class="hljs-string">"min-h-"</span>: <span class="hljs-string">"minHeight"</span>,
  <span class="hljs-string">"max-w-"</span>: <span class="hljs-string">"maxWidth"</span>,
  <span class="hljs-string">"max-h-"</span>: <span class="hljs-string">"maxHeight"</span>,

  <span class="hljs-comment">// 间距相关</span>
  <span class="hljs-string">"m-"</span>: <span class="hljs-string">"margin"</span>,
  <span class="hljs-string">"mt-"</span>: <span class="hljs-string">"marginTop"</span>,
  <span class="hljs-string">"mr-"</span>: <span class="hljs-string">"marginRight"</span>,
  <span class="hljs-string">"mb-"</span>: <span class="hljs-string">"marginBottom"</span>,
  <span class="hljs-string">"ml-"</span>: <span class="hljs-string">"marginLeft"</span>,
  <span class="hljs-string">"mx-"</span>: <span class="hljs-string">"margin"</span>,
  <span class="hljs-string">"my-"</span>: <span class="hljs-string">"margin"</span>,
  <span class="hljs-string">"p-"</span>: <span class="hljs-string">"padding"</span>,
  <span class="hljs-string">"pt-"</span>: <span class="hljs-string">"paddingTop"</span>,
  <span class="hljs-string">"pr-"</span>: <span class="hljs-string">"paddingRight"</span>,
  <span class="hljs-string">"pb-"</span>: <span class="hljs-string">"paddingBottom"</span>,
  <span class="hljs-string">"pl-"</span>: <span class="hljs-string">"paddingLeft"</span>,
  <span class="hljs-string">"px-"</span>: <span class="hljs-string">"padding"</span>,
  <span class="hljs-string">"py-"</span>: <span class="hljs-string">"padding"</span>,

  <span class="hljs-comment">// 边框相关（新增）</span>
  <span class="hljs-string">"border-"</span>: <span class="hljs-string">"borderWidth;borderColor"</span>,
  <span class="hljs-string">"border-t-"</span>: <span class="hljs-string">"borderWidth;borderColor"</span>,
  <span class="hljs-string">"border-r-"</span>: <span class="hljs-string">"borderWidth;borderColor"</span>,
  <span class="hljs-string">"border-b-"</span>: <span class="hljs-string">"borderWidth;borderColor"</span>,
  <span class="hljs-string">"border-l-"</span>: <span class="hljs-string">"borderWidth;borderColor"</span>,
  <span class="hljs-string">"border-x-"</span>: <span class="hljs-string">"borderWidth;borderColor"</span>,
  <span class="hljs-string">"border-y-"</span>: <span class="hljs-string">"borderWidth;borderColor"</span>,

  <span class="hljs-comment">// 圆角相关（新增）</span>
  <span class="hljs-string">"rounded-"</span>: <span class="hljs-string">"borderRadius"</span>,
  <span class="hljs-string">"rounded-t-"</span>: <span class="hljs-string">"borderRadius"</span>,
  <span class="hljs-string">"rounded-r-"</span>: <span class="hljs-string">"borderRadius"</span>,
  <span class="hljs-string">"rounded-b-"</span>: <span class="hljs-string">"borderRadius"</span>,
  <span class="hljs-string">"rounded-l-"</span>: <span class="hljs-string">"borderRadius"</span>,
  <span class="hljs-string">"rounded-tl-"</span>: <span class="hljs-string">"borderRadius"</span>,
  <span class="hljs-string">"rounded-tr-"</span>: <span class="hljs-string">"borderRadius"</span>,
  <span class="hljs-string">"rounded-br-"</span>: <span class="hljs-string">"borderRadius"</span>,
  <span class="hljs-string">"rounded-bl-"</span>: <span class="hljs-string">"borderRadius"</span>,

  <span class="hljs-comment">// 文字相关</span>
  <span class="hljs-string">"text-"</span>: <span class="hljs-string">"fontSize;color"</span>,
  <span class="hljs-string">"leading-"</span>: <span class="hljs-string">"lineHeight"</span>,
  <span class="hljs-string">"tracking-"</span>: <span class="hljs-string">"letterSpacing"</span>,
  <span class="hljs-string">"font-"</span>: <span class="hljs-string">"fontWeight"</span>,

  <span class="hljs-comment">// 背景相关</span>
  <span class="hljs-string">"bg-"</span>: <span class="hljs-string">"backgroundColor"</span>,

  <span class="hljs-comment">// SVG相关</span>
  <span class="hljs-string">"fill-"</span>: <span class="hljs-string">"fill"</span>,
  <span class="hljs-string">"stroke-"</span>: <span class="hljs-string">"stroke"</span>,
  <span class="hljs-string">"stroke-w-"</span>: <span class="hljs-string">"strokeWidth"</span>,

  <span class="hljs-comment">// 定位相关</span>
  <span class="hljs-string">"z-"</span>: <span class="hljs-string">"zIndex"</span>,
  <span class="hljs-string">"inset-"</span>: <span class="hljs-string">"inset"</span>,
  <span class="hljs-string">"top-"</span>: <span class="hljs-string">"top"</span>,
  <span class="hljs-string">"right-"</span>: <span class="hljs-string">"right"</span>,
  <span class="hljs-string">"bottom-"</span>: <span class="hljs-string">"bottom"</span>,
  <span class="hljs-string">"left-"</span>: <span class="hljs-string">"left"</span>,

  <span class="hljs-comment">// 布局相关（新增）</span>
  <span class="hljs-string">"gap-"</span>: <span class="hljs-string">"gap"</span>,
  <span class="hljs-string">"gap-x-"</span>: <span class="hljs-string">"gap"</span>,
  <span class="hljs-string">"gap-y-"</span>: <span class="hljs-string">"gap"</span>,
  <span class="hljs-string">"space-x-"</span>: <span class="hljs-string">"gap"</span>,
  <span class="hljs-string">"space-y-"</span>: <span class="hljs-string">"gap"</span>,

  <span class="hljs-comment">// 透明度</span>
  <span class="hljs-string">"opacity-"</span>: <span class="hljs-string">"opacity"</span>,

  <span class="hljs-comment">// 变换相关（新增）</span>
  <span class="hljs-string">"scale-"</span>: <span class="hljs-string">"scale"</span>,
  <span class="hljs-string">"scale-x-"</span>: <span class="hljs-string">"scale"</span>,
  <span class="hljs-string">"scale-y-"</span>: <span class="hljs-string">"scale"</span>,
  <span class="hljs-string">"rotate-"</span>: <span class="hljs-string">"rotate"</span>,
  <span class="hljs-string">"translate-x-"</span>: <span class="hljs-string">"translate"</span>,
  <span class="hljs-string">"translate-y-"</span>: <span class="hljs-string">"translate"</span>,
  <span class="hljs-string">"skew-x-"</span>: <span class="hljs-string">"skew"</span>,
  <span class="hljs-string">"skew-y-"</span>: <span class="hljs-string">"skew"</span>,

  <span class="hljs-comment">// 阴影相关（新增）</span>
  <span class="hljs-string">"shadow-"</span>: <span class="hljs-string">"boxShadow"</span>,

  <span class="hljs-comment">// 网格相关（新增）</span>
  <span class="hljs-string">"grid-cols-"</span>: <span class="hljs-string">"gridTemplateColumns"</span>,
  <span class="hljs-string">"grid-rows-"</span>: <span class="hljs-string">"gridTemplateRows"</span>,
  <span class="hljs-string">"col-"</span>: <span class="hljs-string">"gridColumn"</span>,
  <span class="hljs-string">"row-"</span>: <span class="hljs-string">"gridRow"</span>,
  <span class="hljs-string">"col-start-"</span>: <span class="hljs-string">"gridColumnStart"</span>,
  <span class="hljs-string">"col-end-"</span>: <span class="hljs-string">"gridColumnEnd"</span>,
  <span class="hljs-string">"row-start-"</span>: <span class="hljs-string">"gridRowStart"</span>,
  <span class="hljs-string">"row-end-"</span>: <span class="hljs-string">"gridRowEnd"</span>,

  <span class="hljs-comment">// Flexbox相关（新增）</span>
  <span class="hljs-string">"flex-"</span>: <span class="hljs-string">"flex"</span>,
  <span class="hljs-string">"basis-"</span>: <span class="hljs-string">"flexBasis"</span>,
  <span class="hljs-string">"grow-"</span>: <span class="hljs-string">"flexGrow"</span>,
  <span class="hljs-string">"shrink-"</span>: <span class="hljs-string">"flexShrink"</span>,
  <span class="hljs-string">"order-"</span>: <span class="hljs-string">"order"</span>,

  <span class="hljs-comment">// 动画相关（新增）</span>
  <span class="hljs-string">"duration-"</span>: <span class="hljs-string">"transitionDuration"</span>,
  <span class="hljs-string">"delay-"</span>: <span class="hljs-string">"transitionDelay"</span>,
  <span class="hljs-string">"ease-"</span>: <span class="hljs-string">"transitionTimingFunction"</span>,

  <span class="hljs-comment">// 其他（新增）</span>
  <span class="hljs-string">"aspect-"</span>: <span class="hljs-string">"aspectRatio"</span>,
  <span class="hljs-string">"cursor-"</span>: <span class="hljs-string">"cursor"</span>,
};

<span class="hljs-comment">// 动态构建支持的 Tailwind 属性映射</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getSupportedProperties</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> config = <span class="hljs-title class_">TailwindConfigLoader</span>.<span class="hljs-title function_">getConfig</span>();
  <span class="hljs-keyword">if</span> (!config) {
    <span class="hljs-keyword">return</span> {};
  }

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">width</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">width</span>,
    <span class="hljs-attr">height</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">height</span>,
    <span class="hljs-attr">minWidth</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">minWidth</span>,
    <span class="hljs-attr">minHeight</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">minHeight</span>,
    <span class="hljs-attr">maxWidth</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">maxWidth</span>,
    <span class="hljs-attr">maxHeight</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">maxHeight</span>,
    <span class="hljs-attr">margin</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">margin</span>,
    <span class="hljs-attr">marginTop</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">margin</span>,
    <span class="hljs-attr">marginRight</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">margin</span>,
    <span class="hljs-attr">marginBottom</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">margin</span>,
    <span class="hljs-attr">marginLeft</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">margin</span>,
    <span class="hljs-attr">padding</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">padding</span>,
    <span class="hljs-attr">paddingTop</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">padding</span>,
    <span class="hljs-attr">paddingRight</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">padding</span>,
    <span class="hljs-attr">paddingBottom</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">padding</span>,
    <span class="hljs-attr">paddingLeft</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">padding</span>,
    <span class="hljs-attr">fontSize</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">fontSize</span>,
    <span class="hljs-attr">lineHeight</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">lineHeight</span>,
    <span class="hljs-attr">borderRadius</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">borderRadius</span>,
    <span class="hljs-attr">color</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">colors</span>,
    <span class="hljs-attr">backgroundColor</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">backgroundColor</span>,
    <span class="hljs-attr">borderColor</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">borderColor</span>,
    <span class="hljs-attr">fill</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">fill</span>,
    <span class="hljs-attr">stroke</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">stroke</span>,
    <span class="hljs-attr">borderWidth</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">borderWidth</span>,
    <span class="hljs-attr">zIndex</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">zIndex</span>,
    <span class="hljs-attr">gap</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">gap</span>,
    <span class="hljs-attr">inset</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">inset</span>,
    <span class="hljs-attr">top</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">spacing</span>,
    <span class="hljs-attr">right</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">spacing</span>,
    <span class="hljs-attr">bottom</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">spacing</span>,
    <span class="hljs-attr">left</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">spacing</span>,
    <span class="hljs-attr">opacity</span>: config.<span class="hljs-property">theme</span>.<span class="hljs-property">opacity</span>,
  };
}
</code></pre>
<h2 data-id="heading-8">整体实现流程</h2>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[ESLint 执行插件] --&gt; B[遍历代码中的类名]
    B --&gt; C{是否为 Tailwind 类名?}
    C --&gt;|否| D[跳过检查]
    C --&gt;|是| E{是否包含任意值?}
    E --&gt;|否| F[使用预设值 通过检查]
    E --&gt;|是| G[提取类名前缀和任意值]
    
    G --&gt; H[通过 prefixToProperty 映射到CSS属性]
    H --&gt; I[检查Tailwind配置是否已加载]
    I --&gt;|已加载| J[获取支持的属性预设值]
    I --&gt;|未加载| K[加载项目Tailwind配置]
    
    K --&gt; L[读取项目tailwind.config.js]
    L --&gt; M{配置是否存在?}
    M --&gt;|不存在| N[使用Tailwind默认配置]
    M --&gt;|存在| O[解析项目配置]
    
    O --&gt; P[合并默认配置和项目配置]
    N --&gt; P
    
    P --&gt; Q[生成全量Tailwind配置]
    Q --&gt; R[缓存配置到内存]
    R --&gt; J
    
    J --&gt; S{判断属性类型}
    S --&gt;|颜色相关| T[调用 findColorPreset]
    S --&gt;|数值相关| U[调用 findNumericPreset]
    
    T --&gt; V{是否匹配预设?}
    U --&gt; V
    
    V --&gt;|是| W[找到对应预设类名]
    V --&gt;|否| X[未找到预设类名]
    
    W --&gt; Y[生成建议消息]
    X --&gt; Z[通过检查 无匹配预设]
    
    Y --&gt; AA[报告建议]
    Z --&gt; BB[检查完成]
    
    AA --&gt; BB
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[windows系统搭建kafka环境]]></title>    <link>https://juejin.cn/post/7585397173023735827</link>    <guid>https://juejin.cn/post/7585397173023735827</guid>    <pubDate>2025-12-20T07:21:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585397173023735827" data-draft-id="7585382553290719268" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="windows系统搭建kafka环境"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-20T07:21:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苏三的开发日记"/> <meta itemprop="url" content="https://juejin.cn/user/4248949048749213"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            windows系统搭建kafka环境
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4248949048749213/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苏三的开发日记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T07:21:34.000Z" title="Sat Dec 20 2025 07:21:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>kafka内置zk，因此没必要安装zk。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fkafka.apache.org%2Fcommunity%2Fdownloads%2F" target="_blank" title="https://kafka.apache.org/community/downloads/" ref="nofollow noopener noreferrer">kafka.apache.org/community/d…</a></p>
<p>1.修改zookeeper.properties文件</p>
<pre><code class="hljs language-js" lang="js">dataDir=<span class="hljs-attr">E</span>:<span class="hljs-regexp">/kafka_2.12-3.6.1/</span>data/zk
</code></pre>
<p>2.修改server.properties文件</p>
<pre><code class="hljs language-js" lang="js">log.<span class="hljs-property">dirs</span>=<span class="hljs-attr">e</span>:<span class="hljs-regexp">/kafka/</span>data/kafka
</code></pre>
<p>3.配置zk.cmd</p>
<pre><code class="hljs language-js" lang="js">call bin/windows/kafka-server-start.<span class="hljs-property">bat</span> config/server.<span class="hljs-property">properties</span>
</code></pre>
<p>4.配置kafka.cmd</p>
<pre><code class="hljs language-js" lang="js">call bin/windows/zookeeper-server-start.<span class="hljs-property">bat</span> config/zookeeper.<span class="hljs-property">properties</span>
</code></pre>
<p>5.一些常用的命令</p>
<pre><code class="hljs language-js" lang="js">kafka-topics.<span class="hljs-property">bat</span> 相关

 --bootstrap-server : 把当前的<span class="hljs-variable constant_">DOS</span>窗口当成<span class="hljs-title class_">Kafka</span>的客户端
 --create : 表示对主题的创建操作，是个操作参数，后面无需增加参数值
 --topic : 主题的名称
 --list : 表示对所有主题的查询操作，是个操作参数，后面无需增加参数值
 --describe : 查看主题的详细信息
 --alter : 表示对所有主题的查询操作，是个操作参数，后面无需增加参数值
--partitions : 修改的配置参数：分区数量
 --<span class="hljs-attr">delete</span>: 表示对主题的删除操作，是个操作参数，后面无需增加参数值。默认情况下，删除操作是逻辑删除，也就是说数据存储的文件依然存在，
但是通过指令查询不出来。如果想要直接删除，需要在server.<span class="hljs-property">properties</span>文件中设置参数<span class="hljs-keyword">delete</span>.<span class="hljs-property">topic</span>.<span class="hljs-property">enable</span>=<span class="hljs-literal">true</span>

kafka-topics.<span class="hljs-property">bat</span> --bootstrap-server <span class="hljs-attr">localhost</span>:<span class="hljs-number">9092</span> --create --topic test
kafka-topics.<span class="hljs-property">bat</span> --bootstrap-server <span class="hljs-attr">localhost</span>:<span class="hljs-number">9092</span> --list
kafka-topics.<span class="hljs-property">bat</span> --bootstrap-server <span class="hljs-attr">localhost</span>:<span class="hljs-number">9092</span> --describe --topic test
kafka-topics.<span class="hljs-property">bat</span> --bootstrap-server <span class="hljs-attr">localhost</span>:<span class="hljs-number">9092</span> --topic test --alter --partitions <span class="hljs-number">2</span>
kafka-topics.<span class="hljs-property">bat</span> --bootstrap-server <span class="hljs-attr">localhost</span>:<span class="hljs-number">9092</span> --topic test --<span class="hljs-keyword">delete</span>

<span class="hljs-attr">notice</span>:
windows系统中由于权限或进程锁定的问题，删除topic会导致kafka服务节点异常关闭。

kafka-<span class="hljs-variable language_">console</span>-producer.<span class="hljs-property">bat</span> 相关

kafka-<span class="hljs-variable language_">console</span>-producer.<span class="hljs-property">bat</span> --bootstrap-server <span class="hljs-attr">localhost</span>:<span class="hljs-number">9092</span> --topic test

typing message you want to send

kafka-<span class="hljs-variable language_">console</span>-consumer.<span class="hljs-property">bat</span> 相关

--<span class="hljs-keyword">from</span>-beginning : 从第一条数据开始消费，无参数值，是一个标记参数

kafka-<span class="hljs-variable language_">console</span>-consumer.<span class="hljs-property">bat</span> --bootstrap-server <span class="hljs-attr">localhost</span>:<span class="hljs-number">9092</span> --topic test --<span class="hljs-keyword">from</span>-beginning

</code></pre>
<p>6.windows端模拟集群服务的搭建</p>
<pre><code class="hljs language-js" lang="js">解压kafka_2<span class="hljs-number">.12</span>-<span class="hljs-number">3.6</span><span class="hljs-number">.1</span>.<span class="hljs-property">tgz</span> 分别生成<span class="hljs-number">4</span>个文件夹 node-<span class="hljs-number">1</span>,node-<span class="hljs-number">2</span>,node-<span class="hljs-number">3</span>,zookeeper


node-<span class="hljs-number">1</span> 修改server.<span class="hljs-property">properties</span>
broker.<span class="hljs-property">id</span>=<span class="hljs-number">1</span>
listeners=<span class="hljs-attr">PLAINTEXT</span>:<span class="hljs-comment">//:9091 log.dirs=E:/kafka/node-1/data zookeeper.connect=localhost:2181/kafka</span>

node-<span class="hljs-number">2</span> 修改server.<span class="hljs-property">properties</span> 
broker.<span class="hljs-property">id</span>=<span class="hljs-number">2</span> 
listeners=<span class="hljs-attr">PLAINTEXT</span>:<span class="hljs-comment">//:9092 log.dirs=E:/kafka/node-2/data zookeeper.connect=localhost:2181/kafka</span>

node-<span class="hljs-number">3</span> 修改server.<span class="hljs-property">properties</span>
broker.<span class="hljs-property">id</span>=<span class="hljs-number">3</span> 
listeners=<span class="hljs-attr">PLAINTEXT</span>:<span class="hljs-comment">//:9093 log.dirs=E:/kafka/node-3/data zookeeper.connect=localhost:2181/kafka</span>


zookeeper文件夹添加zk.<span class="hljs-property">cmd</span>
zk.<span class="hljs-property">cmd</span>内容：
call bin/windows/zookeeper-server-start.<span class="hljs-property">bat</span> config/zookeeper.<span class="hljs-property">properties</span>



node-<span class="hljs-number">1</span> node-<span class="hljs-number">2</span> node-<span class="hljs-number">3</span> 添加kafka.<span class="hljs-property">cmd</span>
kafka.<span class="hljs-property">cmd</span>内容：
call bin/windows/kafka-server-start.<span class="hljs-property">bat</span> config/server.<span class="hljs-property">properties</span>

node-<span class="hljs-number">1</span> 同级别路径添加cluster.<span class="hljs-property">cmd</span> cluster-clear.<span class="hljs-property">cmd</span>
</code></pre>
<p>7.cluster.cmd</p>
<pre><code class="hljs language-js" lang="js">cd zookeeper
start zk.<span class="hljs-property">cmd</span>
ping <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> -n <span class="hljs-number">10</span> &gt;nul
cd ../node-<span class="hljs-number">1</span>
start kafka.<span class="hljs-property">cmd</span>
cd ../node-<span class="hljs-number">2</span>
start kafka.<span class="hljs-property">cmd</span>
cd ../node-<span class="hljs-number">3</span>
start kafka.<span class="hljs-property">cmd</span>
</code></pre>
<p>8.cluster-clear.cmd</p>
<pre><code class="hljs language-js" lang="js">cd zookeeper
rd /s /q data
cd ../node-<span class="hljs-number">1</span>
rd /s /q data
cd ../node-<span class="hljs-number">2</span>
rd /s /q data
cd ../node-<span class="hljs-number">3</span>
rd /s /q data
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PyTorch动态图编程与自定义网络层实战教程]]></title>    <link>https://juejin.cn/post/7585446706327322633</link>    <guid>https://juejin.cn/post/7585446706327322633</guid>    <pubDate>2025-12-20T07:21:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585446706327322633" data-draft-id="7585706951583334409" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PyTorch动态图编程与自定义网络层实战教程"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-20T07:21:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="test管家"/> <meta itemprop="url" content="https://juejin.cn/user/2763513988408746"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PyTorch动态图编程与自定义网络层实战教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2763513988408746/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    test管家
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T07:21:14.000Z" title="Sat Dec 20 2025 07:21:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在深度学习框架的发展中，PyTorch凭借<strong>动态计算图</strong>的灵活性成为科研和工程领域的主流选择，其动态图机制打破了静态图框架的编译限制，让开发者能以更贴近Python的编程习惯构建模型。而在实际项目中，面对个性化的业务需求（如定制化激活函数、特殊卷积操作），PyTorch内置的网络层往往无法满足要求，此时掌握<strong>自定义网络层</strong>的实现方法就成为进阶的关键。</p>
<h2 data-id="heading-0">一、PyTorch动态图编程：原理与实战</h2>
<h3 data-id="heading-1">1.1 动态图与静态图的核心差异</h3>
<p>深度学习中的计算图是对模型运算流程的可视化抽象，本质是由节点（张量运算）和边（张量数据）组成的有向图。PyTorch的动态图（Dynamic Computational Graph）与TensorFlow1.x的静态图（Static Computational Graph）核心区别在于<strong>图的构建时机</strong>：</p>
<ul>
<li><strong>静态图</strong>：先定义完整的计算图结构，再将数据喂入执行，图的结构一旦确定无法实时修改，优势是编译优化后执行效率高，但调试和动态逻辑实现难度大。</li>
<li><strong>动态图</strong>：随代码执行<strong>即时构建</strong>计算图，每运行一行运算代码，就向图中添加一个节点，图的结构可根据输入数据或条件判断动态调整，支持Python原生的循环、分支等控制流，调试时能像普通Python代码一样逐行查看张量值。</li>
</ul>
<p>PyTorch的动态图机制基于<strong>Autograd</strong>（自动求导引擎）实现，Autograd会记录张量的所有运算操作，并在反向传播时自动计算梯度，这也是动态图能够支持实时求导的核心。</p>
<h3 data-id="heading-2">1.2 动态图的自动求导基础</h3>
<p>PyTorch中只有设置<code>requires_grad=True</code>的张量，才会被Autograd追踪运算并构建计算图。我们通过简单的张量运算示例，直观理解动态图的构建与求导过程：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> torch

<span class="hljs-comment"># 定义需要求导的张量</span>
x = torch.tensor([<span class="hljs-number">2.0</span>], requires_grad=<span class="hljs-literal">True</span>)
y = torch.tensor([<span class="hljs-number">3.0</span>], requires_grad=<span class="hljs-literal">True</span>)

<span class="hljs-comment"># 动态构建计算图：z = x² + 2xy + y³</span>
z = x ** <span class="hljs-number">2</span> + <span class="hljs-number">2</span> * x * y + y ** <span class="hljs-number">3</span>

<span class="hljs-comment"># 反向传播，计算z对x和y的梯度</span>
z.backward()

<span class="hljs-comment"># 打印梯度结果</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"dz/dx: <span class="hljs-subst">{x.grad.item()}</span>"</span>)  <span class="hljs-comment"># 理论值：2x+2y = 4+6=10</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"dz/dy: <span class="hljs-subst">{y.grad.item()}</span>"</span>)  <span class="hljs-comment"># 理论值：2x+3y² =4+27=31</span>
</code></pre>
<p>运行结果会输出<code>dz/dx: 10.0</code>和<code>dz/dy: 31.0</code>，与理论计算一致。这里需要注意：Autograd构建的计算图是<strong>动态临时</strong>的，每次<code>backward()</code>后，计算图会被释放，若需重复求导需设置<code>retain_graph=True</code>。</p>
<h3 data-id="heading-3">1.3 动态控制流的实现</h3>
<p>动态图的核心优势是支持Python原生控制流，比如根据张量的值动态选择运算分支。以下示例模拟一个“根据输入值决定循环次数”的动态运算，展示动态图的灵活性：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">dynamic_operation</span>(<span class="hljs-params">x</span>):
    <span class="hljs-comment"># 初始化输出张量</span>
    out = torch.tensor([<span class="hljs-number">0.0</span>], requires_grad=<span class="hljs-literal">True</span>)
    <span class="hljs-comment"># 根据x的数值动态确定循环次数</span>
    loop_times = <span class="hljs-built_in">int</span>(x.item()) <span class="hljs-keyword">if</span> x.item() &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>
    
    <span class="hljs-comment"># 动态循环构建计算图</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(loop_times):
        out = out + x * (i + <span class="hljs-number">1</span>)
    <span class="hljs-keyword">return</span> out

<span class="hljs-comment"># 测试不同输入的动态运算</span>
x1 = torch.tensor([<span class="hljs-number">2.0</span>], requires_grad=<span class="hljs-literal">True</span>)
res1 = dynamic_operation(x1)
res1.backward()
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"输入x=2时，梯度为：<span class="hljs-subst">{x1.grad.item()}</span>"</span>)  <span class="hljs-comment"># 循环2次：1*2 + 2*2 =6，梯度为3</span>

x2 = torch.tensor([-<span class="hljs-number">1.0</span>], requires_grad=<span class="hljs-literal">True</span>)
res2 = dynamic_operation(x2)
res2.backward()
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"输入x=-1时，梯度为：<span class="hljs-subst">{x2.grad.item()}</span>"</span>)  <span class="hljs-comment"># 循环1次：1*(-1)，梯度为1</span>
</code></pre>
<p>上述代码中，循环次数由输入张量<code>x</code>的数值决定，静态图框架需通过特殊算子实现此类逻辑，而PyTorch的动态图可直接使用Python循环，大幅降低代码复杂度。</p>
<h3 data-id="heading-4">1.4 实战：动态图实现线性回归</h3>
<p>我们结合动态图和Autograd，实现一个简单的线性回归模型，完整展示动态图的建模、训练流程：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

<span class="hljs-comment"># 1. 生成模拟数据</span>
torch.manual_seed(<span class="hljs-number">42</span>)  <span class="hljs-comment"># 固定随机种子</span>
x = torch.randn(<span class="hljs-number">100</span>, <span class="hljs-number">1</span>)  <span class="hljs-comment"># 特征：100个样本，1个特征</span>
y = <span class="hljs-number">3</span> * x + <span class="hljs-number">2</span> + torch.randn(<span class="hljs-number">100</span>, <span class="hljs-number">1</span>) * <span class="hljs-number">0.5</span>  <span class="hljs-comment"># 标签：y=3x+2+噪声</span>

<span class="hljs-comment"># 2. 定义模型参数（需要求导）</span>
w = torch.tensor([<span class="hljs-number">1.0</span>], requires_grad=<span class="hljs-literal">True</span>)
b = torch.tensor([<span class="hljs-number">0.0</span>], requires_grad=<span class="hljs-literal">True</span>)

<span class="hljs-comment"># 3. 定义线性回归前向传播（动态构建计算图）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">linear_model</span>(<span class="hljs-params">x</span>):
    <span class="hljs-keyword">return</span> w * x + b

<span class="hljs-comment"># 4. 定义损失函数（均方误差）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">mse_loss</span>(<span class="hljs-params">y_pred, y_true</span>):
    <span class="hljs-keyword">return</span> torch.mean((y_pred - y_true) ** <span class="hljs-number">2</span>)

<span class="hljs-comment"># 5. 训练模型（动态图实时更新）</span>
learning_rate = <span class="hljs-number">0.1</span>
loss_list = []
<span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">100</span>):
    <span class="hljs-comment"># 前向传播：动态构建计算图</span>
    y_pred = linear_model(x)
    loss = mse_loss(y_pred, y)
    
    <span class="hljs-comment"># 反向传播：自动计算梯度</span>
    loss.backward()
    
    <span class="hljs-comment"># 更新参数（需禁用梯度追踪，避免加入计算图）</span>
    <span class="hljs-keyword">with</span> torch.no_grad():
        w -= learning_rate * w.grad
        b -= learning_rate * b.grad
        <span class="hljs-comment"># 清空梯度，避免累积</span>
        w.grad.zero_()
        b.grad.zero_()
    
    loss_list.append(loss.item())
    <span class="hljs-keyword">if</span> (epoch + <span class="hljs-number">1</span>) % <span class="hljs-number">10</span> == <span class="hljs-number">0</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Epoch <span class="hljs-subst">{epoch+<span class="hljs-number">1</span>}</span>, Loss: <span class="hljs-subst">{loss.item():<span class="hljs-number">.4</span>f}</span>, w: <span class="hljs-subst">{w.item():<span class="hljs-number">.4</span>f}</span>, b: <span class="hljs-subst">{b.item():<span class="hljs-number">.4</span>f}</span>"</span>)

<span class="hljs-comment"># 6. 可视化损失变化</span>
plt.plot(loss_list)
plt.xlabel(<span class="hljs-string">"Epoch"</span>)
plt.ylabel(<span class="hljs-string">"MSE Loss"</span>)
plt.title(<span class="hljs-string">"Training Loss Curve"</span>)
plt.show()
</code></pre>
<p>训练完成后，<code>w</code>会趋近于3，<code>b</code>趋近于2，完美拟合模拟数据的线性关系。整个过程中，计算图随每次前向传播动态构建，反向传播后自动释放，体现了PyTorch动态图“随用随建”的特点。</p>
<h2 data-id="heading-5">二、PyTorch自定义网络层：从简单到复杂</h2>
<p>PyTorch的<code>torch.nn</code>模块提供了丰富的内置层（如<code>nn.Linear</code>、<code>nn.Conv2d</code>），但面对定制化需求时，我们需要基于<code>nn.Module</code>或<code>nn.Function</code>实现自定义层。其中<code>nn.Module</code>是PyTorch中所有网络层和模型的基类，封装了参数管理、设备迁移、前向传播等核心功能，是自定义层的首选方式。</p>
<h3 data-id="heading-6">2.1 自定义网络层的核心：继承nn.Module</h3>
<p>所有自定义网络层都需要继承<code>nn.Module</code>，并实现**<code>forward()</code>方法**（定义前向传播逻辑）。<code>nn.Module</code>会自动处理参数的注册、梯度计算和设备迁移，核心要点：</p>
<ol>
<li>可学习参数需用<code>nn.Parameter</code>封装（会被自动注册到模型的<code>parameters()</code>中）；</li>
<li>非可学习参数可直接定义为张量（需设置<code>requires_grad=False</code>）；</li>
<li><code>forward()</code>方法中实现张量的运算逻辑。</li>
</ol>
<h3 data-id="heading-7">2.2 无参数自定义层：定制化激活函数</h3>
<p>首先实现一个无参数的自定义层——<strong>带阈值的ReLU激活层</strong>（ReLU-Threshold），当输入值大于阈值时输出原值，否则输出0：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ReLUThreshold</span>(nn.Module):
    <span class="hljs-string">"""自定义带阈值的ReLU激活层"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, threshold=<span class="hljs-number">0.5</span></span>):
        <span class="hljs-built_in">super</span>(ReLUThreshold, self).__init__()
        <span class="hljs-comment"># 无学习参数，直接定义为实例变量</span>
        self.threshold = threshold
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-comment"># 前向传播逻辑：x &gt; threshold 则输出x，否则输出0</span>
        <span class="hljs-keyword">return</span> torch.where(x &gt; self.threshold, x, torch.tensor(<span class="hljs-number">0.0</span>, device=x.device))

<span class="hljs-comment"># 测试自定义激活层</span>
relu_thresh = ReLUThreshold(threshold=<span class="hljs-number">0.3</span>)
x = torch.tensor([-<span class="hljs-number">0.2</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">0.4</span>, <span class="hljs-number">1.0</span>])
output = relu_thresh(x)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"自定义激活层输出：<span class="hljs-subst">{output}</span>"</span>)  <span class="hljs-comment"># 输出：tensor([0.0000, 0.0000, 0.4000, 1.0000])</span>
</code></pre>
<p>该层无需要学习的参数，仅需在<code>__init__</code>中定义阈值，<code>forward</code>中实现核心运算即可。需要注意的是，使用<code>torch.where</code>时要保证张量的设备一致性（<code>device=x.device</code>），避免CPU/GPU张量混合运算的错误。</p>
<h3 data-id="heading-8">2.3 带参数自定义层：自定义全连接层</h3>
<p>接下来实现带可学习参数的自定义层——<strong>自定义全连接层</strong>（CustomLinear），模拟<code>nn.Linear</code>的功能，手动实现权重和偏置的参数注册与前向运算：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomLinear</span>(nn.Module):
    <span class="hljs-string">"""自定义全连接层"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, in_features, out_features</span>):
        <span class="hljs-built_in">super</span>(CustomLinear, self).__init__()
        <span class="hljs-comment"># 注册可学习参数：权重和偏置（nn.Parameter会自动加入参数列表）</span>
        self.weight = nn.Parameter(torch.randn(out_features, in_features))
        self.bias = nn.Parameter(torch.randn(out_features))
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-comment"># 前向传播：y = x @ W.T + b</span>
        <span class="hljs-keyword">return</span> torch.matmul(x, self.weight.t()) + self.bias

<span class="hljs-comment"># 测试自定义全连接层</span>
custom_linear = CustomLinear(in_features=<span class="hljs-number">5</span>, out_features=<span class="hljs-number">3</span>)
<span class="hljs-comment"># 查看层的可学习参数</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"自定义全连接层参数："</span>)
<span class="hljs-keyword">for</span> name, param <span class="hljs-keyword">in</span> custom_linear.named_parameters():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{name}</span>: <span class="hljs-subst">{param.shape}</span>"</span>)

<span class="hljs-comment"># 输入测试：1个样本，5个特征</span>
x = torch.randn(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>)
output = custom_linear(x)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"自定义全连接层输出形状：<span class="hljs-subst">{output.shape}</span>"</span>)  <span class="hljs-comment"># 输出：torch.Size([1, 3])</span>
</code></pre>
<p>这里<code>nn.Parameter</code>是关键，它继承自<code>torch.Tensor</code>，但会被<code>nn.Module</code>自动识别为可学习参数，在训练时参与梯度更新。如果直接使用<code>torch.tensor</code>定义权重，参数不会被注册，反向传播时无法计算梯度。</p>
<h3 data-id="heading-9">2.4 进阶：自定义卷积层（深度可分离卷积）</h3>
<p>在计算机视觉任务中，深度可分离卷积（Depthwise Separable Convolution）是轻量化模型的常用操作，PyTorch虽有<code>nn.Conv2d</code>，但我们可以自定义实现该层，理解其核心原理：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DepthwiseSeparableConv</span>(nn.Module):
    <span class="hljs-string">"""自定义深度可分离卷积层"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, in_channels, out_channels, kernel_size=<span class="hljs-number">3</span>, stride=<span class="hljs-number">1</span>, padding=<span class="hljs-number">1</span></span>):
        <span class="hljs-built_in">super</span>(DepthwiseSeparableConv, self).__init__()
        <span class="hljs-comment"># 深度卷积：逐通道卷积，不改变通道数</span>
        self.depthwise = nn.Conv2d(
            in_channels=in_channels,
            out_channels=in_channels,
            kernel_size=kernel_size,
            stride=stride,
            padding=padding,
            groups=in_channels  <span class="hljs-comment"># groups等于通道数实现逐通道卷积</span>
        )
        <span class="hljs-comment"># 点卷积：1x1卷积，调整通道数</span>
        self.pointwise = nn.Conv2d(
            in_channels=in_channels,
            out_channels=out_channels,
            kernel_size=<span class="hljs-number">1</span>,
            stride=<span class="hljs-number">1</span>,
            padding=<span class="hljs-number">0</span>
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-comment"># 前向传播：深度卷积 -&gt; 点卷积</span>
        x = self.depthwise(x)
        x = self.pointwise(x)
        <span class="hljs-keyword">return</span> x

<span class="hljs-comment"># 测试深度可分离卷积层</span>
ds_conv = DepthwiseSeparableConv(in_channels=<span class="hljs-number">3</span>, out_channels=<span class="hljs-number">16</span>)
<span class="hljs-comment"># 输入：1个样本，3通道，224x224的图像</span>
x = torch.randn(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">224</span>, <span class="hljs-number">224</span>)
output = ds_conv(x)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"深度可分离卷积输出形状：<span class="hljs-subst">{output.shape}</span>"</span>)  <span class="hljs-comment"># 输出：torch.Size([1, 16, 224, 224])</span>
</code></pre>
<p>该层通过组合内置的<code>nn.Conv2d</code>实现自定义功能，体现了PyTorch模块化编程的灵活性。深度可分离卷积将标准卷积拆分为深度卷积和点卷积，大幅减少了参数量和计算量，是MobileNet等轻量模型的核心组件。</p>
<h3 data-id="heading-10">2.5 底层自定义：基于nn.Function实现运算</h3>
<p>如果需要更精细地控制梯度的计算过程（比如手动实现反向传播），可以基于<code>nn.Function</code>实现自定义运算。<code>nn.Function</code>是PyTorch中更底层的接口，需同时实现<code>forward()</code>和<code>backward()</code>方法，适合对求导逻辑有特殊定制的场景。</p>
<p>以下实现一个简单的平方运算层，手动定义前向和反向传播：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SquareFunction</span>(torch.autograd.Function):
    <span class="hljs-string">"""基于nn.Function的自定义平方运算"""</span>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">ctx, x</span>):
        <span class="hljs-comment"># 前向传播：保存输入张量到ctx，供反向传播使用</span>
        ctx.save_for_backward(x)
        <span class="hljs-keyword">return</span> x ** <span class="hljs-number">2</span>
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">backward</span>(<span class="hljs-params">ctx, grad_output</span>):
        <span class="hljs-comment"># 反向传播：计算梯度，grad_output是上游梯度</span>
        x, = ctx.saved_tensors
        grad_x = <span class="hljs-number">2</span> * x * grad_output  <span class="hljs-comment"># 平方的导数是2x，乘以上游梯度</span>
        <span class="hljs-keyword">return</span> grad_x

<span class="hljs-comment"># 封装为nn.Module层（方便与其他层组合）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SquareLayer</span>(nn.Module):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-keyword">return</span> SquareFunction.apply(x)

<span class="hljs-comment"># 测试自定义运算的梯度计算</span>
square_layer = SquareLayer()
x = torch.tensor([<span class="hljs-number">3.0</span>], requires_grad=<span class="hljs-literal">True</span>)
y = square_layer(x)
y.backward()
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"平方运算输出：<span class="hljs-subst">{y.item()}</span>"</span>)  <span class="hljs-comment"># 输出：9.0</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"平方运算梯度：<span class="hljs-subst">{x.grad.item()}</span>"</span>)  <span class="hljs-comment"># 输出：6.0（2*3）</span>
</code></pre>
<p><code>nn.Function</code>的<code>forward</code>方法通过<code>ctx.save_for_backward()</code>保存张量，<code>backward</code>方法接收上游梯度并计算当前层的梯度。需要注意的是，<code>nn.Function</code>的方法必须是静态的，且通过<code>apply()</code>方法调用。</p>
<h3 data-id="heading-11">2.6 实战：组合自定义层构建完整模型</h3>
<p>最后，我们将前面实现的自定义层组合起来，构建一个简单的图像分类模型，展示自定义层在实际模型中的应用：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomModel</span>(nn.Module):
    <span class="hljs-string">"""组合自定义层的图像分类模型"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, num_classes=<span class="hljs-number">10</span></span>):
        <span class="hljs-built_in">super</span>(CustomModel, self).__init__()
        <span class="hljs-comment"># 自定义深度可分离卷积层</span>
        self.ds_conv1 = DepthwiseSeparableConv(in_channels=<span class="hljs-number">3</span>, out_channels=<span class="hljs-number">32</span>)
        self.ds_conv2 = DepthwiseSeparableConv(in_channels=<span class="hljs-number">32</span>, out_channels=<span class="hljs-number">64</span>)
        <span class="hljs-comment"># 自定义激活层</span>
        self.relu_thresh = ReLUThreshold(threshold=<span class="hljs-number">0.1</span>)
        <span class="hljs-comment"># 池化层</span>
        self.pool = nn.MaxPool2d(kernel_size=<span class="hljs-number">2</span>, stride=<span class="hljs-number">2</span>)
        <span class="hljs-comment"># 自定义全连接层</span>
        self.fc1 = CustomLinear(in_features=<span class="hljs-number">64</span>*<span class="hljs-number">56</span>*<span class="hljs-number">56</span>, out_features=<span class="hljs-number">128</span>)
        self.fc2 = CustomLinear(in_features=<span class="hljs-number">128</span>, out_features=num_classes)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-comment"># 卷积层 + 激活 + 池化</span>
        x = self.pool(self.relu_thresh(self.ds_conv1(x)))
        x = self.pool(self.relu_thresh(self.ds_conv2(x)))
        <span class="hljs-comment"># 展平</span>
        x = x.view(x.size(<span class="hljs-number">0</span>), -<span class="hljs-number">1</span>)
        <span class="hljs-comment"># 全连接层</span>
        x = self.relu_thresh(self.fc1(x))
        x = self.fc2(x)
        <span class="hljs-keyword">return</span> x

<span class="hljs-comment"># 测试自定义模型</span>
model = CustomModel(num_classes=<span class="hljs-number">10</span>)
<span class="hljs-comment"># 输入：2个样本，3通道，224x224的图像</span>
x = torch.randn(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">224</span>, <span class="hljs-number">224</span>)
output = model(x)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"自定义模型输出形状：<span class="hljs-subst">{output.shape}</span>"</span>)  <span class="hljs-comment"># 输出：torch.Size([2, 10])</span>

<span class="hljs-comment"># 查看模型的所有参数</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n模型参数列表："</span>)
<span class="hljs-keyword">for</span> name, param <span class="hljs-keyword">in</span> model.named_parameters():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{name}</span>: <span class="hljs-subst">{param.shape}</span>"</span>)
</code></pre>
<p>该模型组合了深度可分离卷积、自定义激活层和全连接层，完全基于PyTorch的模块化机制构建，可像内置模型一样进行训练、保存和加载。</p>
<h2 data-id="heading-12">三、自定义层的常见问题与优化技巧</h2>
<h3 data-id="heading-13">3.1 参数注册的注意事项</h3>
<ul>
<li>必须使用<code>nn.Parameter</code>封装可学习参数，否则参数不会被加入<code>model.parameters()</code>，训练时无法更新；</li>
<li>若需定义多个参数，可使用<code>nn.ParameterList</code>或<code>nn.ParameterDict</code>批量注册，例如：
<pre><code class="hljs language-python" lang="python">self.params = nn.ParameterList([nn.Parameter(torch.randn(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>)) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>)])
</code></pre>
</li>
</ul>
<h3 data-id="heading-14">3.2 设备迁移的正确性</h3>
<p>自定义层中的张量（如非参数的常量）需与输入张量的设备保持一致，可通过<code>x.device</code>获取输入设备，避免“CPU张量与CUDA张量混合运算”的错误。也可在模型初始化时指定设备，或使用<code>model.to(device)</code>自动迁移参数（<code>nn.Parameter</code>会被自动迁移）。</p>
<h3 data-id="heading-15">3.3 提升自定义层的执行效率</h3>
<ul>
<li>尽量使用PyTorch的内置张量运算（如<code>torch.matmul</code>、<code>torch.conv2d</code>），避免Python原生循环（效率极低）；</li>
<li>对于重复的运算逻辑，可封装为<code>nn.functional</code>中的函数（如<code>F.relu</code>、<code>F.max_pool2d</code>），减少代码冗余；</li>
<li>若自定义层需在GPU上加速，确保所有运算都使用CUDA张量，可通过<code>torch.cuda.is_available()</code>判断设备并自动切换。</li>
</ul>
<h3 data-id="heading-16">3.4 梯度验证</h3>
<p>自定义层（尤其是基于<code>nn.Function</code>的层）需验证梯度计算的正确性，可使用<code>torch.autograd.gradcheck</code>工具进行梯度检查：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 梯度检查：验证SquareFunction的梯度是否正确</span>
x = torch.tensor([<span class="hljs-number">3.0</span>], dtype=torch.double, requires_grad=<span class="hljs-literal">True</span>)
test = torch.autograd.gradcheck(SquareFunction.apply, x, eps=<span class="hljs-number">1e-6</span>, atol=<span class="hljs-number">1e-4</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"梯度检查结果：<span class="hljs-subst">{test}</span>"</span>)  <span class="hljs-comment"># 输出True表示梯度正确</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java方法（函数）完全指南：初学者的第一个"工具箱"]]></title>    <link>https://juejin.cn/post/7585412203978637355</link>    <guid>https://juejin.cn/post/7585412203978637355</guid>    <pubDate>2025-12-20T07:21:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585412203978637355" data-draft-id="7585382553290784804" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java方法（函数）完全指南：初学者的第一个&quot;工具箱&quot;"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-20T07:21:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吃西红柿长大的番茄"/> <meta itemprop="url" content="https://juejin.cn/user/3097787706900985"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java方法（函数）完全指南：初学者的第一个"工具箱"
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3097787706900985/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吃西红柿长大的番茄
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T07:21:23.000Z" title="Sat Dec 20 2025 07:21:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAABWVJREFUWAnlVktsVFUY/s85997pC9BOTKxRWnEKsXWlxjWJj0RWJjrFAAXjAlewYWOkgauACVu7a2IiNUEyExM3yoZE3Wmi7qgPJthJBDE6JUNpO3Mf5/j95/bOTOcBlBgXejJ37rn/Of/7O/9/iP7vQ/zTAcjnC4ry+a5ii1OkiYTpuvjvEc0Gp51uivP+ZW+QBuSW4QjW5rptAa1Ey0uOGKOxwPetVyafN6p/52/PkNBbjdAhGaGEpMRjLZTryB8+9MUSYSGNRIcBvm8kBAY9tHYlHz78nTs392xIkwv9FA3Oe33bdoX1ZZKOS0bH0CXI6RugYLW6BwIu5gskkQ4sEG0wYF25PjBzbZfSYY6kDLUmWMt7FR7Lw3xYUkaTdjxHfTPnPwav0iEGYADVa9XIRIEyxrAA0jIQxgFL22gYwF7A8/DAzNVdksJvJaTEUZ2kYnZWziN5s1ADPHneEIXByotYuMSrf9JEbbsuv7VcvbaKML8plXtQR0EdIYDqWEmtOgAomZFH8EjWSnek2ulmtljljttHbmaIHCCCHzd9MjwfsmscBeZH9Jyd10nMvz92UQrtCBKvMF06mQy0SiEdRMEGg8mN0YjAlgoDDkPrMI5qJKSkKKydpbB2CZjJkhIBvOBw2CGQgii85bpx//dMqFRKam5uvH7w+K97oe+Cl0HO68uIBH0qyEzpOMwIbZIcFq0I+9cwoElizCjk2KFI1y7Nnx614W1db58fOXIlMzs7Xn/jeDmvBV2Q0mXjGf554O/m4LZHp2N8r61WPMvLZWLdiC4GMAk5BjeeB5lhv39l6+BIbu3m760hXMDKBD08XBKzR8fr04nygnIypOOAJUx/fHrsi0Mnys+vVK+V4VUohaiyPCo2Q9DFALvF/ikw8WS4QvVZALS5ksw47/7R8ejgTPk1UFqU6/3zp8bOM7B/kdu/fkguPGU5JibW+F0sTjWOUw8DklRrg4BiLGeBqbaRLxjlT4no0InFV402RcftJz41cH/f/JnHP3kZaaF6VX/liwist9vYG5+NU9Cg3MNkt/+lU5wS8fTxq3mc7ILjDlAE4CJpe89BOWPiIjBhi9O6PI4G1jsc6RGB3lZwmS76k8H0zOKTkFboG8jS2krFKCX2fvTeaPHIBwAkMHHgncURnL3nuCSnxSopdIzN5th0BIonJ0Lf9yUA9iMkzdRWl3BixOusfDcwQVcS4UKIFwYfGPnM8wY/DyP9NFMXaTE5BU39tGkDgGZz+fJJG0oYcSaOafLcqdECY4LzfSObSzyUOgxqtyisr8SSNOOAkubWoh3TTaeA2YtFEXPnm5x81/j+6MI6JqyS25WSNU6hbCMKHG84marJbdR+vwakRhQLRuQpbzHRLjmpmijI+OmWCtq+LzWtnX5v30gHSsqmWne74DtiACi2+Wz0iXbuLt9D2cDyoPEkWOiyp5XUIwLMi/wJY1FbH5B9ONtdC1KrsD/Q0MCQAS0wccILORDW25amAeOtooAj/KQxfzF17uwTSQ1v3dJ7jnLINwdZYRDa4tPU0sHVXFo/vxFF5BqFqxRfOmgPCk4ft2NgKTCy2Y47JIEg+MIhjYsLy5I25qUYTQlCjMRHsr/UwdYwIK33UO1J5fFNB9XNO6akcywJofVmXQDP2wfrSPcI2xG5BSs3I+IosHr4EtvO1TDAu16xHQq5+ykMblfRXLbhEoFIdDTBdhldvzl+3CMg60ZktI2vNzLW6IIp0waLklot9L63yzuUp8dJd7bglPFe3hIXstBEP58/s6Ocyr4rH2+866ZNbriTzA0RSOWCwakMl1QJgculxPt8Z7O5GLdtW6bvU8R/nO1vb+hMExVAVtEAAAAASUVORK5CYII=");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"•";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAhRJREFUeAHtnLEuBFEUhs9cu7JCskEhIrZAgYZGoREPwBuIygOoPITKA6jEG/AAolFoaFCgICIKZBNiY8Pyz5rNOWe9wNz5T7N3Z2eT/b/7zZlpziat3xKWBDJoEyh5EDd3DTk5r8vV7Yc8vzbl6zvfwvSERIYHyzI90SeLc1WZrFV85PR9oi+N/YMnOT6t/3tiLAeXFqqytjrSFacDYmfvQS6u37tOiPHA7FS/bK6PmWhpj4AJRYGA9MiKzLpK6An+cqiNVmRleUhArrec6PNzt/5sttLgh0cvcvfY6Px+ZNY9I6Ax6gKErY1xmZ8ZyD0E5MJGIgsyIZsunT3g7qALJuTdAp0nWyMTsunS2QNukbpwOcRaPpvOHvxzQow2ZBvrs+nsfLL8o0QQBJFdMO1XGkEjaIQlQCMsD/YIGkEjLAEaYXmwR9AIGmEJ0AjLgz2CRtAIS4BGWB7sETSCRlgCNMLyYI+gETTCEqARlgd7BI2gEZYAjbA82CNoBI2wBGiE5cEeQSNohCVAIywP9ggaQSMsARphebBH0AgaYQnQCMsjYC5SF2agYi2fTWcPGA7VFfO0n8+mswdMyOrCNJwnpz/P6xqZkE2Xzh4w8qcLI4Hbu/dydvkWBRAAQBZk0uOOyKyzp5PARRiF1puNtR+NTh+oMCvtJ+D8F2N6j6x+PrwzG46gRTDDm5BtsAGBg0X924Qfj7i23p7HNgQAAAAASUVORK5CYII=");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAABMtJREFUeAHtXM2KFDEQzrQKruIu4mEXRFlUVLz4A4K7B99AcO8io0/gwQfxDVzFuwu+gQf34EG8iOAPKAh6EFlBFMSf/qa2uqszlVR6ZtYxM5PDJNVVSer78nU6KrHzpyxuVlwx44AY2O0T8eb9D7f5fMu9fPvdff7y0/36nbdgdhUdd+jgHnf62JxbObvgjh/d60Pu2R35ajx49Mk9frqlBk7Kw8sXF9y1K4t9cCoi7tz/4F68/tYXMIkPzpzY725dP9yA1tsjoIRpIQHogRWYZSmwJ4Reh06nI2Nd7rYEA8zAzqXAxhgq/pc1d9vHKbEX+Dr4JbzypJDc/YxXYi/wifRLeOXpU5q7n/FK7EXsnBBeeRoqd7/EHj1ZhleeiMjdz8pArRKR+0pb+UsCuK0SkftKW/kzeFmrRHCAxWzufsaJOkqExWzufpOI8EpP1jnCJCK80pN1jjCJ4ICwMigidz/jRD3bI7bZUInIfaWt/KUSuK0SEd4jqFvufgYva5UIDrCYzd3POFFHifhfV/7k8lwPw7D5mUSEV3r854ju2pK7ffOIWzk/X+Go803Lr+ooGqoiwkyP9xzRXVt0q9sE3CgJYTLqfNPyE/irpkoEe2um6ck4bSiBSeD8JBl41jY/Hgd1lIiaaeoyLlsjgUGAjEH3DB4DtUpEW2Z3Mj5GAgA8efbVvXpX/200nln5IMYvKhHDrvylcwdc9+pSNdeg46WQsP7wo2s7fpWYaPT926fw9ZiVk4BpywYJkGuvlJs4EuWS0p/HTyHh3kbzH2najM85cR0lgpPiYMtukFB26m1u5Ua+vkFkWP3Zn0KCJDg1Px6f42Wtvhrhdyz8ncanrFKCmGH1wrwDMCrh/uxPIUFTAvdHbeVPsc1fVRE+c7Ud/k6fWt7XHFlYqcqQ5wTRvWpiY4wrIZwfDUL+akDRUBXB/jCzFCH9SHCzTDRUmsro7z+cEvrHwxOZn2ZTL/pVFcEBtRLoiWXfxQ5ehvoHHx4vpIwUEuJKSMvPz5/zQq0qwmIy5m+rjBQSwnsCQYnlgwjfT72av6oifOba2qnKcOXeGVIP0rT3BALTNr8mBWSpRHAgmJSTtLGhDHwj+A9GPCbX2DNiBSRoShg0H8zl5y/njxIhJ0WntralDJmIbO+UEvz85Zwt9wj7HIDB5Ttp7RkyGbRDSqC49vOjX50P9aexmr+qInzmajvtO13H02SpyrCVMNj8dT7/4BwByDXzRIC0LWXEldA/njVfip9GpV9VERxQM0lPhrVDyrCVMJr5/fwZJ+qWewR1lSuNJ21sXxnjVgIhck5VhM/cqG1WBpIAMX4Z9Xz+eP58sFUiOBArLQcZpQ0CNCXt1HzA5OfPOFGrrwYHyKTwbNJsxolaJUJbKeo0mu/4uMeXBHBbJSK88qP5jo97fAYva5UIDgivHEXk7mecqKNEhFeOhsjdbxKR+0pb+UsCuK0qIveVtvJn8LJWieAAi9nc/YwTdZQIi9nc/SYR4ZWenSO2yZvgcwTuRYZKWBnUI3e/xF7gcmio5L4HWPlL7AVuyPol95W28me8EnuBa8J+sZjM3c94JfYCd6VxTXjaCjDLe+K9cwTuSuOa8LQUYPXvh1d3w0HC7JK8kMK0/rcJfwHkVMYgi4xhOgAAAABJRU5ErkJggg==");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p>在Java编程中，方法就像是你的个人工具箱里的各种工具——锤子用来钉钉子，螺丝刀用来拧螺丝，每个工具都有专门的用途。今天，我们来学习如何创建和使用自己的"编程工具"！</p>
<h2 data-id="heading-0">引入：为什么需要方法？</h2>
<p>想象一下，你正在写一个学生成绩管理系统：
<strong>没有方法的情况：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
    <span class="hljs-comment">// 计算第一个学生的总分</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">score1</span> <span class="hljs-operator">=</span> <span class="hljs-number">85</span>;
    <span class="hljs-type">int</span> <span class="hljs-variable">score2</span> <span class="hljs-operator">=</span> <span class="hljs-number">90</span>;
    <span class="hljs-type">int</span> <span class="hljs-variable">score3</span> <span class="hljs-operator">=</span> <span class="hljs-number">78</span>;
    <span class="hljs-type">int</span> <span class="hljs-variable">total1</span> <span class="hljs-operator">=</span> score1 + score2 + score3;
    <span class="hljs-type">double</span> <span class="hljs-variable">average1</span> <span class="hljs-operator">=</span> total1 / <span class="hljs-number">3.0</span>;
    System.out.println(<span class="hljs-string">"第一个学生平均分："</span> + average1);
    
    <span class="hljs-comment">// 计算第二个学生的总分（重复写一遍！）</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">score4</span> <span class="hljs-operator">=</span> <span class="hljs-number">92</span>;
    <span class="hljs-type">int</span> <span class="hljs-variable">score5</span> <span class="hljs-operator">=</span> <span class="hljs-number">88</span>;
    <span class="hljs-type">int</span> <span class="hljs-variable">score6</span> <span class="hljs-operator">=</span> <span class="hljs-number">95</span>;
    <span class="hljs-type">int</span> <span class="hljs-variable">total2</span> <span class="hljs-operator">=</span> score4 + score5 + score6;
    <span class="hljs-type">double</span> <span class="hljs-variable">average2</span> <span class="hljs-operator">=</span> total2 / <span class="hljs-number">3.0</span>;
    System.out.println(<span class="hljs-string">"第二个学生平均分："</span> + average2);
    
    <span class="hljs-comment">// 计算第三个学生的总分（又重复写一遍！）</span>
    <span class="hljs-comment">// ... 太麻烦了！</span>
}
</code></pre>
<p><strong>使用方法的情况：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
    <span class="hljs-comment">// 只需要调用方法，代码变得超级简洁！</span>
    calculateAverage(<span class="hljs-number">85</span>, <span class="hljs-number">90</span>, <span class="hljs-number">78</span>, <span class="hljs-string">"第一个学生"</span>);
    calculateAverage(<span class="hljs-number">92</span>, <span class="hljs-number">88</span>, <span class="hljs-number">95</span>, <span class="hljs-string">"第二个学生"</span>);
    calculateAverage(<span class="hljs-number">76</span>, <span class="hljs-number">85</span>, <span class="hljs-number">90</span>, <span class="hljs-string">"第三个学生"</span>);
}

<span class="hljs-comment">// 定义一个计算平均分的方法</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">calculateAverage</span><span class="hljs-params">(<span class="hljs-type">int</span> score1, <span class="hljs-type">int</span> score2, <span class="hljs-type">int</span> score3, String name)</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> score1 + score2 + score3;
    <span class="hljs-type">double</span> <span class="hljs-variable">average</span> <span class="hljs-operator">=</span> total / <span class="hljs-number">3.0</span>;
    System.out.println(name + <span class="hljs-string">"平均分："</span> + average);
}
</code></pre>
<p>看到区别了吗？方法让代码更简洁、更易读、更易维护！</p>
<h2 data-id="heading-1">一、方法基础：什么是方法？</h2>
<h3 data-id="heading-2">1.1 方法的通俗理解</h3>
<p><strong>方法（Method）</strong>  就是一段有名字的代码块，可以重复使用。你可以把它想象成：</p>
<ul>
<li><strong>一个魔法咒语</strong>：念出咒语（调用方法），就会发生特定的魔法效果（执行代码）</li>
<li><strong>一个厨房食谱</strong>：按照食谱（方法）的步骤，就能做出美味的菜（得到结果）</li>
<li><strong>一个数学公式</strong>：比如 "圆的面积 = π × r²"，这就是一个方法</li>
</ul>
<h3 data-id="heading-3">1.2 方法的组成部分</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 访问修饰符 返回值类型 方法名(参数列表) {</span>
<span class="hljs-comment">//     方法体</span>
<span class="hljs-comment">//     返回值（如果需要）</span>
<span class="hljs-comment">// }</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> a + b;
    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<h2 data-id="heading-4">二、创建和使用方法</h2>
<h3 data-id="heading-5">2.1 最简单的无参方法</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleMethod</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 最简单的无参方法 ===\n"</span>);
        
        <span class="hljs-comment">// 调用方法：就像喊朋友的名字</span>
        sayHello();      <span class="hljs-comment">// 第一次调用</span>
        sayHello();      <span class="hljs-comment">// 第二次调用</span>
        sayHello();      <span class="hljs-comment">// 可以无限次调用！</span>
    }
    
    <span class="hljs-comment">// 定义一个无参方法：向世界问好</span>
    <span class="hljs-comment">// static：表示这是静态方法，可以在main中直接调用</span>
    <span class="hljs-comment">// void：表示这个方法不返回任何值</span>
    <span class="hljs-comment">// sayHello：方法名（我们自己取的）</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"你好，Java世界！"</span>);
        System.out.println(<span class="hljs-string">"我正在学习Java方法！"</span>);
        System.out.println(<span class="hljs-string">"------------------"</span>);
    }
}
</code></pre>
<h3 data-id="heading-6">2.2 带参数的方法（让方法更灵活）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodWithParameters</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 带参数的方法 ===\n"</span>);
        
        <span class="hljs-comment">// 传递不同的参数，得到不同的结果</span>
        greet(<span class="hljs-string">"小明"</span>);          <span class="hljs-comment">// 向小明问好</span>
        greet(<span class="hljs-string">"小红"</span>);          <span class="hljs-comment">// 向小红问好</span>
        greet(<span class="hljs-string">"李老师"</span>);        <span class="hljs-comment">// 向李老师问好</span>
        
        <span class="hljs-comment">// 计算不同数字的和</span>
        printSum(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>);        <span class="hljs-comment">// 计算5+3</span>
        printSum(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>);      <span class="hljs-comment">// 计算10+20</span>
        printSum(<span class="hljs-number">100</span>, <span class="hljs-number">200</span>);    <span class="hljs-comment">// 计算100+200</span>
    }
    
    <span class="hljs-comment">// 带一个参数的方法：向指定的人问好</span>
    <span class="hljs-comment">// name：参数，调用时需要传入</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">greet</span><span class="hljs-params">(String name)</span> {
        System.out.println(<span class="hljs-string">"你好，"</span> + name + <span class="hljs-string">"！"</span>);
        System.out.println(<span class="hljs-string">"欢迎来到Java课堂！"</span>);
        System.out.println();
    }
    
    <span class="hljs-comment">// 带两个参数的方法：计算两个数的和</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printSum</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> a + b;
        System.out.println(a + <span class="hljs-string">" + "</span> + b + <span class="hljs-string">" = "</span> + sum);
    }
}
</code></pre>
<h3 data-id="heading-7">2.3 有返回值的方法（方法可以"给出答案"）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodWithReturn</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 有返回值的方法 ===\n"</span>);
        
        <span class="hljs-comment">// 调用方法并接收返回值</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">result1</span> <span class="hljs-operator">=</span> add(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>);      <span class="hljs-comment">// 调用add方法，得到返回值8</span>
        System.out.println(<span class="hljs-string">"5 + 3 = "</span> + result1);
        
        <span class="hljs-type">int</span> <span class="hljs-variable">result2</span> <span class="hljs-operator">=</span> add(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>);    <span class="hljs-comment">// 再次调用，得到30</span>
        System.out.println(<span class="hljs-string">"10 + 20 = "</span> + result2);
        
        <span class="hljs-comment">// 返回值可以直接使用</span>
        System.out.println(<span class="hljs-string">"7 + 8 = "</span> + add(<span class="hljs-number">7</span>, <span class="hljs-number">8</span>));
        
        <span class="hljs-comment">// 使用返回值进行进一步计算</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> add(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>) + add(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>) + add(<span class="hljs-number">5</span>, <span class="hljs-number">6</span>);
        System.out.println(<span class="hljs-string">"1+2 + 3+4 + 5+6 = "</span> + total);
        
        <span class="hljs-comment">// 不同类型的方法</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isAdult</span> <span class="hljs-operator">=</span> checkAge(<span class="hljs-number">20</span>);
        System.out.println(<span class="hljs-string">"20岁是成年人吗？"</span> + isAdult);
        
        <span class="hljs-type">double</span> <span class="hljs-variable">area</span> <span class="hljs-operator">=</span> calculateCircleArea(<span class="hljs-number">5.0</span>);
        System.out.println(<span class="hljs-string">"半径为5的圆面积："</span> + area);
    }
    
    <span class="hljs-comment">// 有返回值的方法：返回两个数的和</span>
    <span class="hljs-comment">// int：表示这个方法返回一个整数</span>
    <span class="hljs-comment">// return：返回计算结果</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> a + b;   <span class="hljs-comment">// 计算和</span>
        <span class="hljs-keyword">return</span> sum;        <span class="hljs-comment">// 返回结果</span>
    }
    
    <span class="hljs-comment">// 检查年龄是否成年</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> {
        <span class="hljs-keyword">if</span> (age &gt;= <span class="hljs-number">18</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;   <span class="hljs-comment">// 返回true</span>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// 返回false</span>
        }
        <span class="hljs-comment">// 注意：一个方法必须保证在所有情况下都有返回值</span>
    }
    
    <span class="hljs-comment">// 计算圆面积</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateCircleArea</span><span class="hljs-params">(<span class="hljs-type">double</span> radius)</span> {
        <span class="hljs-type">double</span> <span class="hljs-variable">area</span> <span class="hljs-operator">=</span> <span class="hljs-number">3.14159</span> * radius * radius;
        <span class="hljs-keyword">return</span> area;  <span class="hljs-comment">// 返回double类型</span>
    }
}
</code></pre>
<h3 data-id="heading-8">2.4 方法参数传递的细节</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ParameterDetails</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 方法参数细节 ===\n"</span>);
        
        <span class="hljs-comment">// 基本类型参数传递（传值）</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;
        System.out.println(<span class="hljs-string">"修改前 x = "</span> + x);
        changeNumber(x);  <span class="hljs-comment">// 把x的值10传给方法</span>
        System.out.println(<span class="hljs-string">"修改后 x = "</span> + x);
        System.out.println(<span class="hljs-string">"结论：基本类型参数不会改变原变量\n"</span>);
        
        <span class="hljs-comment">// 数组参数传递（传引用）</span>
        <span class="hljs-type">int</span>[] scores = {<span class="hljs-number">85</span>, <span class="hljs-number">90</span>, <span class="hljs-number">78</span>};
        System.out.println(<span class="hljs-string">"修改前 scores[0] = "</span> + scores[<span class="hljs-number">0</span>]);
        changeArrayElement(scores);  <span class="hljs-comment">// 把数组的"地址"传给方法</span>
        System.out.println(<span class="hljs-string">"修改后 scores[0] = "</span> + scores[<span class="hljs-number">0</span>]);
        System.out.println(<span class="hljs-string">"结论：数组参数会改变原数组内容\n"</span>);
        
        <span class="hljs-comment">// 多个参数示例</span>
        printStudentInfo(<span class="hljs-string">"张三"</span>, <span class="hljs-number">18</span>, <span class="hljs-number">95.5</span>);
        printStudentInfo(<span class="hljs-string">"李四"</span>, <span class="hljs-number">20</span>, <span class="hljs-number">88.0</span>);
        
        <span class="hljs-comment">// 可变参数（参数数量可变）</span>
        System.out.println(<span class="hljs-string">"\n=== 可变参数 ==="</span>);
        System.out.println(<span class="hljs-string">"平均分1："</span> + calculateAverage(<span class="hljs-number">85</span>, <span class="hljs-number">90</span>, <span class="hljs-number">78</span>));
        System.out.println(<span class="hljs-string">"平均分2："</span> + calculateAverage(<span class="hljs-number">92</span>, <span class="hljs-number">88</span>, <span class="hljs-number">95</span>, <span class="hljs-number">76</span>, <span class="hljs-number">85</span>));
        System.out.println(<span class="hljs-string">"平均分3："</span> + calculateAverage(<span class="hljs-number">100</span>, <span class="hljs-number">95</span>));  <span class="hljs-comment">// 两个参数也可以</span>
    }
    
    <span class="hljs-comment">// 尝试修改基本类型参数</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">changeNumber</span><span class="hljs-params">(<span class="hljs-type">int</span> num)</span> {
        num = <span class="hljs-number">100</span>;  <span class="hljs-comment">// 只修改了方法内的副本</span>
        System.out.println(<span class="hljs-string">"方法内 num = "</span> + num);
    }
    
    <span class="hljs-comment">// 修改数组元素</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">changeArrayElement</span><span class="hljs-params">(<span class="hljs-type">int</span>[] arr)</span> {
        <span class="hljs-keyword">if</span> (arr.length &gt; <span class="hljs-number">0</span>) {
            arr[<span class="hljs-number">0</span>] = <span class="hljs-number">100</span>;  <span class="hljs-comment">// 修改了原数组的内容</span>
        }
    }
    
    <span class="hljs-comment">// 多个参数的方法</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printStudentInfo</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age, <span class="hljs-type">double</span> score)</span> {
        System.out.println(<span class="hljs-string">"姓名："</span> + name + <span class="hljs-string">"，年龄："</span> + age + <span class="hljs-string">"，成绩："</span> + score);
    }
    
    <span class="hljs-comment">// 可变参数：可以接受任意数量的参数</span>
    <span class="hljs-comment">// 语法：类型... 参数名</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateAverage</span><span class="hljs-params">(<span class="hljs-type">int</span>... scores)</span> {
        <span class="hljs-keyword">if</span> (scores.length == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0.0</span>;
        }
        
        <span class="hljs-type">int</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> score : scores) {
            sum += score;
        }
        <span class="hljs-keyword">return</span> (<span class="hljs-type">double</span>) sum / scores.length;
    }
}
</code></pre>
<h2 data-id="heading-9">三、方法重载：同名不同"参"</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodOverloading</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 方法重载 ===\n"</span>);
        
        <span class="hljs-comment">// 方法重载：方法名相同，但参数列表不同</span>
        <span class="hljs-comment">// Java会根据你传入的参数自动选择合适的版本</span>
        
        System.out.println(<span class="hljs-string">"整数相加: "</span> + add(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>));
        System.out.println(<span class="hljs-string">"小数相加: "</span> + add(<span class="hljs-number">5.5</span>, <span class="hljs-number">3.3</span>));
        System.out.println(<span class="hljs-string">"三个数相加: "</span> + add(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>));
        System.out.println(<span class="hljs-string">"字符串连接: "</span> + add(<span class="hljs-string">"Hello, "</span>, <span class="hljs-string">"Java!"</span>));
        
        <span class="hljs-comment">// 实际应用：计算不同图形的面积</span>
        System.out.println(<span class="hljs-string">"\n=== 计算图形面积 ==="</span>);
        System.out.println(<span class="hljs-string">"正方形面积（边长5）: "</span> + calculateArea(<span class="hljs-number">5</span>));
        System.out.println(<span class="hljs-string">"长方形面积（长5宽3）: "</span> + calculateArea(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>));
        System.out.println(<span class="hljs-string">"圆面积（半径4）: "</span> + calculateArea(<span class="hljs-number">4.0</span>));
        
        <span class="hljs-comment">// 注意：返回值类型不同不能构成重载！</span>
        <span class="hljs-comment">// 重载只看参数类型、数量、顺序，不看返回值</span>
    }
    
    <span class="hljs-comment">// 版本1：两个整数相加</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> {
        System.out.print(<span class="hljs-string">"调用int版本："</span>);
        <span class="hljs-keyword">return</span> a + b;
    }
    
    <span class="hljs-comment">// 版本2：三个整数相加（参数数量不同）</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b, <span class="hljs-type">int</span> c)</span> {
        System.out.print(<span class="hljs-string">"调用三个参数版本："</span>);
        <span class="hljs-keyword">return</span> a + b + c;
    }
    
    <span class="hljs-comment">// 版本3：两个小数相加（参数类型不同）</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">double</span> a, <span class="hljs-type">double</span> b)</span> {
        System.out.print(<span class="hljs-string">"调用double版本："</span>);
        <span class="hljs-keyword">return</span> a + b;
    }
    
    <span class="hljs-comment">// 版本4：字符串连接（完全不同类型）</span>
    <span class="hljs-keyword">static</span> String <span class="hljs-title function_">add</span><span class="hljs-params">(String a, String b)</span> {
        System.out.print(<span class="hljs-string">"调用String版本："</span>);
        <span class="hljs-keyword">return</span> a + b;
    }
    
    <span class="hljs-comment">// 版本5：整数和小数相加（参数顺序不同）</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">double</span> b)</span> {
        System.out.print(<span class="hljs-string">"调用int-double版本："</span>);
        <span class="hljs-keyword">return</span> a + b;
    }
    
    <span class="hljs-comment">// 版本6：小数和整数相加（参数顺序不同）</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">double</span> a, <span class="hljs-type">int</span> b)</span> {
        System.out.print(<span class="hljs-string">"调用double-int版本："</span>);
        <span class="hljs-keyword">return</span> a + b;
    }
    
    <span class="hljs-comment">// 图形面积计算方法（重载示例）</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calculateArea</span><span class="hljs-params">(<span class="hljs-type">int</span> side)</span> {
        <span class="hljs-keyword">return</span> side * side;  <span class="hljs-comment">// 正方形</span>
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calculateArea</span><span class="hljs-params">(<span class="hljs-type">int</span> length, <span class="hljs-type">int</span> width)</span> {
        <span class="hljs-keyword">return</span> length * width;  <span class="hljs-comment">// 长方形</span>
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateArea</span><span class="hljs-params">(<span class="hljs-type">double</span> radius)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-number">3.14159</span> * radius * radius;  <span class="hljs-comment">// 圆形</span>
    }
}
</code></pre>
<h2 data-id="heading-10">四、方法的最佳实践和常见错误</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodBestPractices</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 方法的最佳实践 ===\n"</span>);
        
        <span class="hljs-comment">// ✅ 好方法：单一职责，只做一件事</span>
        printWelcomeMessage();
        <span class="hljs-type">int</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> calculateSum(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>);
        System.out.println(<span class="hljs-string">"计算结果："</span> + sum);
        
        <span class="hljs-comment">// ✅ 好方法：有意义的命名</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isValid</span> <span class="hljs-operator">=</span> isValidEmail(<span class="hljs-string">"test@example.com"</span>);
        System.out.println(<span class="hljs-string">"邮箱是否有效："</span> + isValid);
        
        <span class="hljs-comment">// ❌ 常见错误演示</span>
        System.out.println(<span class="hljs-string">"\n=== 常见错误 ==="</span>);
        
        <span class="hljs-comment">// 错误1：方法太长（应该拆分成小方法）</span>
        <span class="hljs-comment">// 错误2：方法名无意义（如 doSomething、process）</span>
        <span class="hljs-comment">// 错误3：参数太多（超过3个要考虑封装成对象）</span>
        <span class="hljs-comment">// 错误4：副作用太多（一个方法做了太多事情）</span>
        
        <span class="hljs-comment">// 实用示例：学生管理系统</span>
        System.out.println(<span class="hljs-string">"\n=== 学生管理系统示例 ==="</span>);
        
        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">"张三"</span>;
        <span class="hljs-type">int</span>[] scores = {<span class="hljs-number">85</span>, <span class="hljs-number">90</span>, <span class="hljs-number">78</span>};
        
        <span class="hljs-comment">// 使用多个小方法，代码清晰易读</span>
        printStudentHeader(name);
        <span class="hljs-type">double</span> <span class="hljs-variable">average</span> <span class="hljs-operator">=</span> calculateAverage(scores);
        <span class="hljs-type">String</span> <span class="hljs-variable">grade</span> <span class="hljs-operator">=</span> calculateGrade(average);
        printStudentResult(average, grade);
    }
    
    <span class="hljs-comment">// ✅ 好例子：方法名清晰，功能单一</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printWelcomeMessage</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"=== 欢迎使用学生管理系统 ==="</span>);
        System.out.println();
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calculateSum</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> {
        <span class="hljs-keyword">return</span> a + b;
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValidEmail</span><span class="hljs-params">(String email)</span> {
        <span class="hljs-comment">// 简单的邮箱验证（实际应该用正则表达式）</span>
        <span class="hljs-keyword">return</span> email != <span class="hljs-literal">null</span> &amp;&amp; 
               email.contains(<span class="hljs-string">"@"</span>) &amp;&amp; 
               email.contains(<span class="hljs-string">"."</span>);
    }
    
    <span class="hljs-comment">// 学生管理相关方法</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printStudentHeader</span><span class="hljs-params">(String name)</span> {
        System.out.println(<span class="hljs-string">"学生姓名："</span> + name);
        System.out.println(<span class="hljs-string">"------------"</span>);
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateAverage</span><span class="hljs-params">(<span class="hljs-type">int</span>[] scores)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> score : scores) {
            sum += score;
        }
        <span class="hljs-keyword">return</span> (<span class="hljs-type">double</span>) sum / scores.length;
    }
    
    <span class="hljs-keyword">static</span> String <span class="hljs-title function_">calculateGrade</span><span class="hljs-params">(<span class="hljs-type">double</span> average)</span> {
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">90</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"A"</span>;
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">80</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"B"</span>;
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">70</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"C"</span>;
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">60</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"D"</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-string">"F"</span>;
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printStudentResult</span><span class="hljs-params">(<span class="hljs-type">double</span> average, String grade)</span> {
        System.out.printf(<span class="hljs-string">"平均分：%.2f\n"</span>, average);
        System.out.println(<span class="hljs-string">"等级："</span> + grade);
        System.out.println();
    }
    
    <span class="hljs-comment">// 📝 方法命名规范：</span>
    <span class="hljs-comment">// 1. 动词开头：get、set、calculate、print、check等</span>
    <span class="hljs-comment">// 2. 驼峰命名法：calculateAverageScore</span>
    <span class="hljs-comment">// 3. 见名知义：不要用a、b、c这种无意义的名字</span>
    
    <span class="hljs-comment">// 📝 方法设计原则：</span>
    <span class="hljs-comment">// 1. 一个方法只做一件事</span>
    <span class="hljs-comment">// 2. 方法不要太长（一般不超过50行）</span>
    <span class="hljs-comment">// 3. 参数不要太多（最好不超过3个）</span>
    <span class="hljs-comment">// 4. 避免副作用（不要修改不应该修改的东西）</span>
}
</code></pre>
<h2 data-id="heading-11">五、递归方法：自己调用自己</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RecursionDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 递归方法 ===\n"</span>);
        
        <span class="hljs-comment">// 递归：方法自己调用自己</span>
        <span class="hljs-comment">// 注意：必须有结束条件，否则会无限循环！</span>
        
        System.out.println(<span class="hljs-string">"计算5的阶乘："</span>);
        <span class="hljs-type">int</span> <span class="hljs-variable">factorial</span> <span class="hljs-operator">=</span> calculateFactorial(<span class="hljs-number">5</span>);
        System.out.println(<span class="hljs-string">"5! = "</span> + factorial);
        
        System.out.println(<span class="hljs-string">"\n计算斐波那契数列："</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">10</span>; i++) {
            System.out.println(<span class="hljs-string">"fib("</span> + i + <span class="hljs-string">") = "</span> + fibonacci(i));
        }
        
        System.out.println(<span class="hljs-string">"\n递归实现数字倒序："</span>);
        printReverse(<span class="hljs-number">12345</span>);
    }
    
    <span class="hljs-comment">// 计算阶乘：n! = n × (n-1) × ... × 1</span>
    <span class="hljs-comment">// 例如：5! = 5 × 4 × 3 × 2 × 1 = 120</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calculateFactorial</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> {
        <span class="hljs-comment">// 结束条件：0的阶乘是1</span>
        <span class="hljs-keyword">if</span> (n == <span class="hljs-number">0</span> || n == <span class="hljs-number">1</span>) {
            System.out.println(<span class="hljs-string">"到达结束条件：factorial("</span> + n + <span class="hljs-string">") = 1"</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        } <span class="hljs-keyword">else</span> {
            System.out.println(<span class="hljs-string">"计算 factorial("</span> + n + <span class="hljs-string">") = "</span> + n + <span class="hljs-string">" × factorial("</span> + (n-<span class="hljs-number">1</span>) + <span class="hljs-string">")"</span>);
            <span class="hljs-keyword">return</span> n * calculateFactorial(n - <span class="hljs-number">1</span>);
        }
    }
    
    <span class="hljs-comment">// 斐波那契数列：每个数是前两个数之和</span>
    <span class="hljs-comment">// fib(0)=0, fib(1)=1, fib(2)=1, fib(3)=2, fib(4)=3, ...</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">fibonacci</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> {
        <span class="hljs-keyword">if</span> (n == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (n == <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> fibonacci(n - <span class="hljs-number">1</span>) + fibonacci(n - <span class="hljs-number">2</span>);
        }
    }
    
    <span class="hljs-comment">// 递归打印数字倒序</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printReverse</span><span class="hljs-params">(<span class="hljs-type">int</span> number)</span> {
        <span class="hljs-keyword">if</span> (number &lt; <span class="hljs-number">10</span>) {
            <span class="hljs-comment">// 只有一位数，直接打印</span>
            System.out.print(number);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 打印最后一位数</span>
            System.out.print(number % <span class="hljs-number">10</span>);
            <span class="hljs-comment">// 递归处理剩下的数字</span>
            printReverse(number / <span class="hljs-number">10</span>);
        }
    }
}
</code></pre>
<h2 data-id="heading-12">六、实用案例：学生成绩管理系统</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentGradeSystem</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 学生成绩管理系统 ===\n"</span>);
        
        <span class="hljs-comment">// 学生数据</span>
        String[] names = {<span class="hljs-string">"张三"</span>, <span class="hljs-string">"李四"</span>, <span class="hljs-string">"王五"</span>, <span class="hljs-string">"赵六"</span>};
        <span class="hljs-type">int</span>[][] scores = {
            {<span class="hljs-number">85</span>, <span class="hljs-number">90</span>, <span class="hljs-number">78</span>},  <span class="hljs-comment">// 张三的成绩</span>
            {<span class="hljs-number">92</span>, <span class="hljs-number">88</span>, <span class="hljs-number">95</span>},  <span class="hljs-comment">// 李四的成绩</span>
            {<span class="hljs-number">76</span>, <span class="hljs-number">85</span>, <span class="hljs-number">90</span>},  <span class="hljs-comment">// 王五的成绩</span>
            {<span class="hljs-number">88</span>, <span class="hljs-number">92</span>, <span class="hljs-number">86</span>}   <span class="hljs-comment">// 赵六的成绩</span>
        };
        
        <span class="hljs-comment">// 处理每个学生</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; names.length; i++) {
            processStudent(names[i], scores[i]);
        }
        
        <span class="hljs-comment">// 找出最高分的学生</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">topStudent</span> <span class="hljs-operator">=</span> findTopStudent(names, scores);
        System.out.println(<span class="hljs-string">"\n⭐ 最高分学生："</span> + topStudent);
        
        <span class="hljs-comment">// 统计各分数段人数</span>
        printGradeDistribution(scores);
    }
    
    <span class="hljs-comment">// 处理单个学生信息</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processStudent</span><span class="hljs-params">(String name, <span class="hljs-type">int</span>[] studentScores)</span> {
        printDivider();
        System.out.println(<span class="hljs-string">"学生："</span> + name);
        
        <span class="hljs-type">double</span> <span class="hljs-variable">average</span> <span class="hljs-operator">=</span> calculateAverage(studentScores);
        <span class="hljs-type">String</span> <span class="hljs-variable">grade</span> <span class="hljs-operator">=</span> getGradeLetter(average);
        <span class="hljs-type">String</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> getStatus(average);
        
        System.out.printf(<span class="hljs-string">"平均分：%.2f\n"</span>, average);
        System.out.println(<span class="hljs-string">"等级："</span> + grade);
        System.out.println(<span class="hljs-string">"状态："</span> + status);
        
        printScores(studentScores);
    }
    
    <span class="hljs-comment">// 计算平均分</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateAverage</span><span class="hljs-params">(<span class="hljs-type">int</span>[] scores)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> score : scores) {
            sum += score;
        }
        <span class="hljs-keyword">return</span> (<span class="hljs-type">double</span>) sum / scores.length;
    }
    
    <span class="hljs-comment">// 获取等级（A-F）</span>
    <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getGradeLetter</span><span class="hljs-params">(<span class="hljs-type">double</span> average)</span> {
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">90</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"A"</span>;
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">80</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"B"</span>;
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">70</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"C"</span>;
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">60</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"D"</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-string">"F"</span>;
    }
    
    <span class="hljs-comment">// 获取状态（优秀/良好等）</span>
    <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getStatus</span><span class="hljs-params">(<span class="hljs-type">double</span> average)</span> {
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">90</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"优秀"</span>;
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">80</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"良好"</span>;
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">70</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"中等"</span>;
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">60</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"及格"</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-string">"不及格"</span>;
    }
    
    <span class="hljs-comment">// 打印分数详情</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printScores</span><span class="hljs-params">(<span class="hljs-type">int</span>[] scores)</span> {
        System.out.print(<span class="hljs-string">"各科分数："</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; scores.length; i++) {
            System.out.print(<span class="hljs-string">"科目"</span> + (i+<span class="hljs-number">1</span>) + <span class="hljs-string">":"</span> + scores[i]);
            <span class="hljs-keyword">if</span> (i &lt; scores.length - <span class="hljs-number">1</span>) {
                System.out.print(<span class="hljs-string">", "</span>);
            }
        }
        System.out.println();
    }
    
    <span class="hljs-comment">// 找出最高分学生</span>
    <span class="hljs-keyword">static</span> String <span class="hljs-title function_">findTopStudent</span><span class="hljs-params">(String[] names, <span class="hljs-type">int</span>[][] allScores)</span> {
        <span class="hljs-type">double</span> <span class="hljs-variable">highestAverage</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">topStudent</span> <span class="hljs-operator">=</span> <span class="hljs-string">""</span>;
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; names.length; i++) {
            <span class="hljs-type">double</span> <span class="hljs-variable">average</span> <span class="hljs-operator">=</span> calculateAverage(allScores[i]);
            <span class="hljs-keyword">if</span> (average &gt; highestAverage) {
                highestAverage = average;
                topStudent = names[i];
            }
        }
        
        <span class="hljs-keyword">return</span> topStudent + String.format(<span class="hljs-string">" (%.2f分)"</span>, highestAverage);
    }
    
    <span class="hljs-comment">// 统计分数分布</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printGradeDistribution</span><span class="hljs-params">(<span class="hljs-type">int</span>[][] allScores)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">excellent</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, good = <span class="hljs-number">0</span>, medium = <span class="hljs-number">0</span>, pass = <span class="hljs-number">0</span>, fail = <span class="hljs-number">0</span>;
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span>[] scores : allScores) {
            <span class="hljs-type">double</span> <span class="hljs-variable">average</span> <span class="hljs-operator">=</span> calculateAverage(scores);
            <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">90</span>) excellent++;
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">80</span>) good++;
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">70</span>) medium++;
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">60</span>) pass++;
            <span class="hljs-keyword">else</span> fail++;
        }
        
        printDivider();
        System.out.println(<span class="hljs-string">"📊 分数分布统计："</span>);
        System.out.println(<span class="hljs-string">"优秀（90+）: "</span> + excellent + <span class="hljs-string">"人"</span>);
        System.out.println(<span class="hljs-string">"良好（80-89）: "</span> + good + <span class="hljs-string">"人"</span>);
        System.out.println(<span class="hljs-string">"中等（70-79）: "</span> + medium + <span class="hljs-string">"人"</span>);
        System.out.println(<span class="hljs-string">"及格（60-69）: "</span> + pass + <span class="hljs-string">"人"</span>);
        System.out.println(<span class="hljs-string">"不及格（&lt;60）: "</span> + fail + <span class="hljs-string">"人"</span>);
    }
    
    <span class="hljs-comment">// 打印分隔线</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printDivider</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"----------------------------"</span>);
    }
}
</code></pre>
<h2 data-id="heading-13">七、总结：最重要的知识点</h2>
<h3 data-id="heading-14">🎯 核心要点总结：</h3>
<ol>
<li>
<p><strong>方法是代码的积木块</strong>：把常用的代码封装成方法，让程序更清晰、更易维护</p>
</li>
<li>
<p><strong>方法三要素</strong>：</p>
<ul>
<li><strong>方法名</strong>：要见名知义，用动词开头（如calculate、print、get）</li>
<li><strong>参数列表</strong>：方法需要的输入信息</li>
<li><strong>返回值</strong>：方法执行后给出的结果（没有返回值用void）</li>
</ul>
</li>
<li>
<p><strong>方法调用</strong>：使用方法名加括号，传入需要的参数</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 定义方法</span>
<span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> {
    <span class="hljs-keyword">return</span> a + b;
}

<span class="hljs-comment">// 调用方法</span>
<span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> add(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>);
</code></pre>
</li>
<li>
<p><strong>方法重载</strong>：同一个方法名，不同的参数列表</p>
<pre><code class="hljs language-java" lang="java">add(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>);      <span class="hljs-comment">// 调用int版本</span>
add(<span class="hljs-number">5.5</span>, <span class="hljs-number">3.3</span>);  <span class="hljs-comment">// 调用double版本</span>
</code></pre>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[linux端进行kafka集群服务的搭建]]></title>    <link>https://juejin.cn/post/7585397173023768595</link>    <guid>https://juejin.cn/post/7585397173023768595</guid>    <pubDate>2025-12-20T07:39:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585397173023768595" data-draft-id="7585382553290801188" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="linux端进行kafka集群服务的搭建"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-20T07:39:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苏三的开发日记"/> <meta itemprop="url" content="https://juejin.cn/user/4248949048749213"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            linux端进行kafka集群服务的搭建
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4248949048749213/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苏三的开发日记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T07:39:09.000Z" title="Sat Dec 20 2025 07:39:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.环境变量的配置</h2>
<h5 data-id="heading-1">1.1 修改/etc/hosts</h5>
<pre><code class="hljs language-js" lang="js"><span class="hljs-number">192.168</span><span class="hljs-number">.220</span><span class="hljs-number">.102</span> hadoop102
<span class="hljs-number">192.168</span><span class="hljs-number">.220</span><span class="hljs-number">.103</span> hadoop103
<span class="hljs-number">192.168</span><span class="hljs-number">.220</span><span class="hljs-number">.104</span> hadoop104
</code></pre>
<h5 data-id="heading-2">1.2 修改/etc/hostname</h5>
<pre><code class="hljs language-js" lang="js">hadoop102
</code></pre>
<h5 data-id="heading-3">1.3 添加文件/etc/profile.d/my_env.sh</h5>
<pre><code class="hljs language-js" lang="js">#<span class="hljs-variable constant_">JAVA_HOME</span>
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">JAVA_HOME</span>=<span class="hljs-regexp">/opt/m</span>odule/jdk1<span class="hljs-number">.8</span><span class="hljs-number">.0_212</span>
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">PATH</span>=<span class="hljs-attr">$PATH</span>:$JAVA_HOME/bin
#<span class="hljs-variable constant_">HADOOP_HOME</span>
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">HADOOP_HOME</span>=<span class="hljs-regexp">/opt/m</span>odule/hadoop-<span class="hljs-number">3.1</span><span class="hljs-number">.3</span>
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">PATH</span>=<span class="hljs-attr">$PATH</span>:$HADOOP_HOME/bin
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">PATH</span>=<span class="hljs-attr">$PATH</span>:$HADOOP_HOME/sbin
#<span class="hljs-variable constant_">KAFKA_HOME</span>
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">KAFKA_HOME</span>=<span class="hljs-regexp">/opt/m</span>odule/kafka
<span class="hljs-keyword">export</span> <span class="hljs-variable constant_">PATH</span>=<span class="hljs-attr">$PATH</span>:$KAFKA_HOME/bin

保存之后 source /etc/profile.<span class="hljs-property">d</span>/my_env.<span class="hljs-property">sh</span>
</code></pre>
<h2 data-id="heading-4">2.SSH之间进行无密登录访问</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-number">1.</span>使用hadoop102 进行演示

登录虚拟机hadoop102
ssh-keygen -t rsa 
然后敲（三个回车），就会生成两个文件id_rsa（私钥）、id_rsa.<span class="hljs-property">pub</span>（公钥）

ssh-copy-id hadoop102
ssh-copy-id hadoop103
ssh-copy-id hadoop104
</code></pre>
<h2 data-id="heading-5">3.zookeeper安装</h2>
<pre><code class="hljs language-js" lang="js">在/opt/<span class="hljs-variable language_">module</span>/zookeeper/目录下创建zkData
# 创建myid文件内容如下
<span class="hljs-number">1</span>

# 进入cd /opt/<span class="hljs-variable language_">module</span>/zookeeper/conf文件目录
cd /opt/<span class="hljs-variable language_">module</span>/zookeeper/conf

# 修改文件名称
mv zoo_sample.<span class="hljs-property">cfg</span> zoo.<span class="hljs-property">cfg</span>

# 修改文件内容
vim zoo.<span class="hljs-property">cfg</span>

# 以下内容为修改内容
dataDir=<span class="hljs-regexp">/opt/m</span>odule/zookeeper/zkData
server<span class="hljs-number">.1</span>=<span class="hljs-attr">hadoop102</span>:<span class="hljs-number">2888</span>:<span class="hljs-number">3888</span>
server<span class="hljs-number">.2</span>=<span class="hljs-attr">hadoop103</span>:<span class="hljs-number">2888</span>:<span class="hljs-number">3888</span>
server<span class="hljs-number">.3</span>=<span class="hljs-attr">hadoop104</span>:<span class="hljs-number">2888</span>:<span class="hljs-number">3888</span>

# 进入/opt/<span class="hljs-variable language_">module</span>路径
cd /opt/<span class="hljs-variable language_">module</span>

# 调用分发脚本将本机得<span class="hljs-title class_">ZooKeeper</span>安装包分发到其他两台机器
xsync zookeeper
</code></pre>
<h2 data-id="heading-6">4.zookeeper启动脚本</h2>
<pre><code class="hljs language-js" lang="js">#!<span class="hljs-regexp">/bin/</span>bash

<span class="hljs-keyword">case</span> $1 <span class="hljs-keyword">in</span>
<span class="hljs-string">"start"</span>){
	<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> hadoop102 hadoop103 hadoop104
	<span class="hljs-keyword">do</span>
        echo ---------- zookeeper $i 启动 ------------
		ssh $i <span class="hljs-string">"/opt/module/zookeeper/bin/zkServer.sh start"</span>
	done
};;
<span class="hljs-string">"stop"</span>){
	<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> hadoop102 hadoop103 hadoop104
	<span class="hljs-keyword">do</span>
        echo ---------- zookeeper $i 停止 ------------    
		ssh $i <span class="hljs-string">"/opt/module/zookeeper/bin/zkServer.sh stop"</span>
	done
};;
<span class="hljs-string">"status"</span>){
	<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> hadoop102 hadoop103 hadoop104
	<span class="hljs-keyword">do</span>
        echo ---------- zookeeper $i 状态 ------------    
		ssh $i <span class="hljs-string">"/opt/module/zookeeper/bin/zkServer.sh status"</span>
	done
};;
esac
</code></pre>
<h2 data-id="heading-7">5.kafka安装</h2>
<pre><code class="hljs language-js" lang="js">vim server.<span class="hljs-property">properties</span>

#broker的全局唯一编号，每个服务节点不能重复，只能是数字。
broker.<span class="hljs-property">id</span>=<span class="hljs-number">1</span> #(hadoop102-&gt;<span class="hljs-number">1</span> hadoop103-&gt;<span class="hljs-number">2</span> hadoop104-&gt;<span class="hljs-number">3</span>)

#broker对外暴露的<span class="hljs-variable constant_">IP</span>和端口 （每个节点单独配置）
advertised.<span class="hljs-property">listeners</span>=<span class="hljs-attr">PLAINTEXT</span>:<span class="hljs-comment">//hadoop102:9092 #(hadoop102-&gt;hadoop102:9092 hadoop103-&gt;hadoop103:9092 hadoop104-&gt;hadoop104:9092)</span>

路径，路径与路径之间可以用<span class="hljs-string">"，"</span>分隔
log.<span class="hljs-property">dirs</span>=<span class="hljs-regexp">/opt/m</span>odule/kafka/datas

#配置连接<span class="hljs-title class_">Zookeeper</span>集群地址（在zk根目录下创建/kafka，方便管理）
zookeeper.<span class="hljs-property">connect</span>=<span class="hljs-attr">hadoop102</span>:<span class="hljs-number">2181</span>,<span class="hljs-attr">hadoop103</span>:<span class="hljs-number">2181</span>,<span class="hljs-attr">hadoop104</span>:<span class="hljs-number">2181</span>/kafka

</code></pre>
<h2 data-id="heading-8">6.kafka启动脚本</h2>
<pre><code class="hljs language-js" lang="js">#! <span class="hljs-regexp">/bin/</span>bash

<span class="hljs-keyword">case</span> $1 <span class="hljs-keyword">in</span>
<span class="hljs-string">"start"</span>){
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> hadoop102 hadoop103 hadoop104
    <span class="hljs-keyword">do</span>
        echo <span class="hljs-string">" --------启动 $i Kafka-------"</span>
        ssh $i <span class="hljs-string">"/opt/module/kafka/bin/kafka-server-start.sh -daemon /opt/module/kafka/config/server.properties"</span>
    done
};;
<span class="hljs-string">"stop"</span>){
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> hadoop102 hadoop103 hadoop104
    <span class="hljs-keyword">do</span>
        echo <span class="hljs-string">" --------停止 $i Kafka-------"</span>
        ssh $i <span class="hljs-string">"/opt/module/kafka/bin/kafka-server-stop.sh "</span>
    done
};;
esac
</code></pre>
<h2 data-id="heading-9">7.cluster管理脚本</h2>
<pre><code class="hljs language-js" lang="js">#!<span class="hljs-regexp">/bin/</span>bash

<span class="hljs-keyword">case</span> $1 <span class="hljs-keyword">in</span>
<span class="hljs-string">"start"</span>){
        echo ================== 启动 <span class="hljs-title class_">Kafka</span>集群 ==================
        #启动 <span class="hljs-title class_">Zookeeper</span>集群
        zk.<span class="hljs-property">sh</span> start

        #启动 <span class="hljs-title class_">Kafka</span>采集集群
        kafka.<span class="hljs-property">sh</span> start

        };;
<span class="hljs-string">"stop"</span>){
        echo ================== 停止 <span class="hljs-title class_">Kafka</span>集群 ==================

        #停止 <span class="hljs-title class_">Kafka</span>采集集群
        kafka.<span class="hljs-property">sh</span> stop

		#循环直至 <span class="hljs-title class_">Kafka</span> 集群进程全部停止
		kafka_count=$(xcall jps | grep <span class="hljs-title class_">Kafka</span> | wc -l)
		<span class="hljs-keyword">while</span> [ $kafka_count -gt <span class="hljs-number">0</span> ]
		<span class="hljs-keyword">do</span>
			sleep <span class="hljs-number">1</span>
			kafka_count=$(xcall | grep <span class="hljs-title class_">Kafka</span> | wc -l)
            echo <span class="hljs-string">"当前未停止的 Kafka 进程数为 $kafka_count"</span>
		done

        #停止 <span class="hljs-title class_">Zookeeper</span>集群
        zk.<span class="hljs-property">sh</span> stop
};;
esac
</code></pre>
<h2 data-id="heading-10">8.xcall与xsync脚本</h2>
<h5 data-id="heading-11">8.1 xcall</h5>
<pre><code class="hljs language-js" lang="js">#!<span class="hljs-regexp">/bin/</span>bash

# ====== 节点列表（按你集群实际修改）======
<span class="hljs-variable constant_">HOSTS</span>=(<span class="hljs-string">"hadoop102"</span> <span class="hljs-string">"hadoop103"</span> <span class="hljs-string">"hadoop104"</span>)

# ====== 参数校验 ======
<span class="hljs-keyword">if</span> [ $# -lt <span class="hljs-number">1</span> ]; then
  echo <span class="hljs-string">"Usage: xcall &lt;command&gt;"</span>
  exit <span class="hljs-number">1</span>
fi

# ====== 执行 ======
<span class="hljs-keyword">for</span> host <span class="hljs-keyword">in</span> <span class="hljs-string">"${HOSTS[@]}"</span>; <span class="hljs-keyword">do</span>
  echo <span class="hljs-string">"==================== $host ===================="</span>
  ssh $host <span class="hljs-string">"$@"</span>
done
</code></pre>
<h5 data-id="heading-12">8.2 xsync</h5>
<pre><code class="hljs language-js" lang="js">#!<span class="hljs-regexp">/bin/</span>bash

# <span class="hljs-number">1.</span> 判断参数个数
<span class="hljs-keyword">if</span> [ $# -lt <span class="hljs-number">1</span> ]; then
    echo <span class="hljs-string">"Not Enough Arguement!"</span>
    exit <span class="hljs-number">1</span>
fi

# <span class="hljs-number">2.</span> 遍历集群所有机器
<span class="hljs-keyword">for</span> host <span class="hljs-keyword">in</span> hadoop102 hadoop103 hadoop104; <span class="hljs-keyword">do</span>
    echo <span class="hljs-string">"==================== $host ===================="</span>

    # <span class="hljs-number">3.</span> 遍历所有目录，挨个发送
    <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> <span class="hljs-string">"$@"</span>; <span class="hljs-keyword">do</span>
        # <span class="hljs-number">4.</span> 判断文件是否存在
        <span class="hljs-keyword">if</span> [ -e <span class="hljs-string">"$file"</span> ]; then
            # <span class="hljs-number">5.</span> 获取父目录
            pdir=$(cd -P <span class="hljs-string">"$(dirname "</span>$file<span class="hljs-string">")"</span>; pwd)
            # <span class="hljs-number">6.</span> 获取当前文件的名称
            fname=$(basename <span class="hljs-string">"$file"</span>)

            ssh <span class="hljs-string">"$host"</span> <span class="hljs-string">"mkdir -p $pdir"</span>
            rsync -av <span class="hljs-string">"$pdir/$fname"</span> <span class="hljs-string">"$host:$pdir"</span>
        <span class="hljs-keyword">else</span>
            echo <span class="hljs-string">"$file does not exist!"</span>
        fi
    done
done
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从Activity.setContentView()开始]]></title>    <link>https://juejin.cn/post/7585397173023850515</link>    <guid>https://juejin.cn/post/7585397173023850515</guid>    <pubDate>2025-12-20T07:49:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585397173023850515" data-draft-id="7585468725332049974" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从Activity.setContentView()开始"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-20T07:49:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="StarShip"/> <meta itemprop="url" content="https://juejin.cn/user/3790771820172391"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从Activity.setContentView()开始
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3790771820172391/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    StarShip
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T07:49:48.000Z" title="Sat Dec 20 2025 07:49:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、从 Activity.setContentView() 开始的调用链</h2>
<pre><code class="hljs language-scss" lang="scss">Activity<span class="hljs-selector-class">.setContentView</span>(layoutId)
    ↓
PhoneWindow<span class="hljs-selector-class">.setContentView</span>(view)
    ↓
创建 / 装配 DecorView
    ↓
WindowManager<span class="hljs-selector-class">.addView</span>(DecorView, params)
    ↓
WindowManagerGlobal<span class="hljs-selector-class">.addView</span>(...)
    ↓
new <span class="hljs-built_in">ViewRootImpl</span>(...)
    ↓
ViewRootImpl<span class="hljs-selector-class">.setView</span>(DecorView, params)
    ↓
<span class="hljs-built_in">requestLayout</span>() → <span class="hljs-built_in">scheduleTraversals</span>()
    ↓
<span class="hljs-built_in">doTraversal</span>() → <span class="hljs-built_in">performMeasure</span>() / <span class="hljs-built_in">performLayout</span>() / <span class="hljs-built_in">performDraw</span>()
    ↓
View 树 <span class="hljs-built_in">onDraw</span>(Canvas)
    ↓
<span class="hljs-selector-tag">Canvas</span> → Skia → (OpenGL ES / 软件渲染)
    ↓
绘制到 Surface 的 Buffer
</code></pre>
<hr/>
<h2 data-id="heading-1">二、Activity, Window, DecorView：界面“外壳结构”</h2>
<ol>
<li>
<h3 data-id="heading-2">Activity：逻辑入口 + 拥有一个 Window</h3>
</li>
</ol>
<ul>
<li>每个 Activity 内部都持有一个 Window（通常是 <code>PhoneWindow</code>）。</li>
<li>当你调用：setContentView(R.layout.activity_main);</li>
</ul>
<p>其实是</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">setContentView</span>(<span class="hljs-variable">@LayoutRes</span> int layoutResID) {
    <span class="hljs-selector-tag">getWindow</span>()<span class="hljs-selector-class">.setContentView</span>(layoutResID); <span class="hljs-comment">// 交给 PhoneWindow</span>
}
</code></pre>
<ol start="2">
<li>
<h3 data-id="heading-3">Window / PhoneWindow：管理 DecorView 的“窗口对象”</h3>
</li>
</ol>
<ul>
<li>
<p>Window 是一个抽象类，PhoneWindow 是常见实现。</p>
</li>
<li>
<p>它负责：</p>
<ul>
<li>创建并管理 DecorView（整个窗口的根视图）；</li>
<li>处理标题栏、状态栏适配等“窗口装饰”。</li>
</ul>
</li>
</ul>
<p>简化的调用链：</p>
<pre><code class="hljs language-scss" lang="scss">Activity<span class="hljs-selector-class">.setContentView</span>()
    └─ PhoneWindow<span class="hljs-selector-class">.setContentView</span>()
            ├─ <span class="hljs-built_in">ensureDecor</span>()  <span class="hljs-comment">// 确保 DecorView 已创建</span>
            │     └─ <span class="hljs-built_in">installDecor</span>()
            │          └─ mDecor = new <span class="hljs-built_in">DecorView</span>(...)
            └─ 将 layoutId inflate 成 View，并添加到 mDecor 的 <span class="hljs-attribute">content</span> 区域
</code></pre>
<ol start="3">
<li>
<h3 data-id="heading-4">DecorView &amp; View / ViewGroup：UI 树结构</h3>
</li>
</ol>
<ul>
<li>
<p>DecorView：</p>
<ul>
<li>继承自 ViewGroup；</li>
<li>是当前 Window 的 根 View；</li>
<li>内含状态栏/标题栏区域 + 内容区域。</li>
</ul>
</li>
<li>
<p>XML 布局最终会成为：</p>
</li>
</ul>
<pre><code class="hljs language-scss" lang="scss">DecorView (FrameLayout)
    └─ contentParent (id=android.R.id.content)
          └─ 你的根 ViewGroup (例如 ConstraintLayout)
                └─ 若干子 View / ViewGroup
</code></pre>
<p>这些 View/ViewGroup 负责在三大阶段中工作：</p>
<ul>
<li><code>onMeasure()</code>：计算大小；</li>
<li><code>onLayout()</code>：确定位置；</li>
<li><code>onDraw(Canvas)</code>：在 Canvas 上画出自己。</li>
</ul>
<p>这一切目前 还只是在<strong>内存结构</strong>上建立，还没有真正“出现在屏幕上”。</p>
<h2 data-id="heading-5">三、WindowManager / WMS / ViewRootImpl：把 DecorView 挂到窗口 &amp; Surface 上</h2>
<ol>
<li>
<h3 data-id="heading-6">WindowManager：应用侧窗口管理接口</h3>
</li>
</ol>
<ul>
<li>Activity 内可以调用 <code>getWindowManager()</code> 或使用 <code>WindowManager</code> 添加/更新 View（如 Dialog、Toast）。</li>
<li>当 <code>PhoneWindow.setContentView()</code> 完成 DecorView 构造后，Activity/系统会调用：</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">WindowManager <span class="hljs-attr">wm</span> = getWindowManager()<span class="hljs-comment">;</span>
wm.addView(decorView, layoutParams)<span class="hljs-comment">;</span>
</code></pre>
<ol start="2">
<li>
<h3 data-id="heading-7">WindowManagerGlobal / ViewRootImpl：建立与 WMS 的连接</h3>
</li>
</ol>
<p><code>WindowManager.addView()</code> 内部最终走到：</p>
<pre><code class="hljs language-scss" lang="scss">WindowManagerGlobal<span class="hljs-selector-class">.addView</span>(view, params)
    ├─ 创建 ViewRootImpl root = new <span class="hljs-built_in">ViewRootImpl</span>(context, display)
    ├─ root<span class="hljs-selector-class">.setView</span>(view, params)
    └─ 记录 (view ↔ root) 映射关系
</code></pre>
<p>此时几个关键点：</p>
<ul>
<li>ViewRootImpl 被创建；</li>
<li>DecorView 被交给 ViewRootImpl 管理；</li>
<li>ViewRootImpl 通过 Binder 与 WMS（WindowManagerService） 通信，申请窗口、布局、Surface 等。</li>
</ul>
<ol start="3">
<li>
<h3 data-id="heading-8">WMS（WindowManagerService）：系统级窗口管理</h3>
</li>
</ol>
<p>在 系统进程 中运行，统一管理所有 app 的窗口：</p>
<ul>
<li>决定窗口的位置、尺寸、Z 轴顺序；</li>
<li>为窗口分配/更新对应的 Surface；</li>
<li>将窗口信息提供给 SurfaceFlinger 刷新显示。</li>
</ul>
<p>关系图（结构视角）：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[ Activity ]</span>
    └─ <span class="hljs-selector-attr">[ Window (PhoneWindow) ]</span>
            └─ <span class="hljs-selector-attr">[ DecorView (ViewGroup 根) ]</span>
                    ↑
                    │ <span class="hljs-built_in">setContentView</span>()
                    │
<span class="hljs-selector-attr">[ WindowManagerImpl ]</span> (App进程)
    └─ <span class="hljs-selector-attr">[ WindowManagerGlobal ]</span>
            └─ new <span class="hljs-built_in">ViewRootImpl</span>(...)
                    └─ <span class="hljs-built_in">setView</span>(DecorView, params)
                           ↕ Binder
                     <span class="hljs-selector-attr">[ WMS (系统进程) ]</span>
                           └─ 管理 Window、分配 Surface
</code></pre>
<h2 data-id="heading-9">四、Surface：ViewRootImpl 与图形系统的“接缝处”</h2>
<ol>
<li>
<h3 data-id="heading-10">Surface：底层缓冲队列的 Java 封装</h3>
</li>
</ol>
<ul>
<li>
<p>每个 Window 在 WMS/SurfaceFlinger 侧都会有一个 Surface 对应；</p>
</li>
<li>
<p>对 ViewRootImpl 来说，它持有一个 <code>Surface mSurface</code>：</p>
<ul>
<li>这是它绘制输出的目标；</li>
<li>内部与 BufferQueue 关联，生产者是当前窗口（App 侧），消费者是 SurfaceFlinger。</li>
</ul>
</li>
</ul>
<ol start="2">
<li>
<h3 data-id="heading-11">ViewRootImpl.setView() &amp; requestLayout()</h3>
</li>
</ol>
<p><code>ViewRootImpl.setView()</code> 完成：</p>
<ul>
<li>保存根 View = DecorView；</li>
<li>向 WMS 注册窗口；</li>
<li>初始化 <code>Surface</code>；</li>
<li>调用 <code>requestLayout()</code>，触发第一次测量/布局/绘制。</li>
</ul>
<p><code>requestLayout()</code> 内部最终会走到：</p>
<pre><code class="hljs language-scss" lang="scss">ViewRootImpl<span class="hljs-selector-class">.requestLayout</span>()
    └─ <span class="hljs-built_in">scheduleTraversals</span>()
           └─ mChoreographer<span class="hljs-selector-class">.postCallback</span>(TRAVERSAL, mTraversalRunnable, ...)
</code></pre>
<p>这里就引出了 Choreographer。</p>
<h2 data-id="heading-12">五、Choreographer + Handler：VSync 驱动的 UI 刷新</h2>
<ol>
<li>
<h3 data-id="heading-13">Handler / Looper：消息循环基础</h3>
</li>
</ol>
<ul>
<li>
<p>UI 线程拥有 Looper + MessageQueue；</p>
</li>
<li>
<p>Handler 用来：</p>
<ul>
<li>发送消息、投递 Runnable；</li>
<li>在 UI 线程执行各种回调（包括 ViewRootImpl 的刷新逻辑）。</li>
</ul>
</li>
</ul>
<ol start="2">
<li>
<h3 data-id="heading-14">Choreographer：基于 VSync 的帧调度器</h3>
</li>
</ol>
<ul>
<li>
<p>Choreographer 挂在 UI 线程上；</p>
</li>
<li>
<p><code>scheduleTraversals()</code> 会通过 Choreographer 在 下一个 VSync 时 执行 <code>doTraversal()</code>，而不是立刻执行：</p>
<ul>
<li>这样能保证所有 <code>requestLayout()/invalidate()</code> 合并到下一帧统一处理；</li>
<li>避免“抖动”和无意义重复绘制。</li>
</ul>
</li>
</ul>
<p>简化版时序：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">requestLayout</span>() / <span class="hljs-built_in">invalidate</span>()
    ↓
ViewRootImpl<span class="hljs-selector-class">.scheduleTraversals</span>()
    ↓
Choreographer<span class="hljs-selector-class">.postCallback</span>(TRAVERSAL, doTraversal)
    ↓   (等到下一次 VSync)
Choreographer<span class="hljs-selector-id">#doFrame</span>()
    └─ <span class="hljs-built_in">doTraversal</span>()  <span class="hljs-comment">// 核心渲染流程</span>
</code></pre>
<h2 data-id="heading-15">六、ViewRootImpl.doTraversal()：三大流程 + Canvas / Skia / OpenGL ES</h2>
<p><code>doTraversal()</code> 里会顺序执行：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">performMeasure</span>() → <span class="hljs-built_in">performLayout</span>() → <span class="hljs-built_in">performDraw</span>()
</code></pre>
<ol>
<li>
<h3 data-id="heading-16">performMeasure()</h3>
</li>
</ol>
<ul>
<li>
<p>从 DecorView 开始向下：</p>
<ul>
<li>调用每个 View / ViewGroup 的 <code>onMeasure()</code>；</li>
<li>计算 width/height。</li>
</ul>
</li>
</ul>
<ol start="2">
<li>
<h3 data-id="heading-17">performLayout()</h3>
</li>
</ol>
<ul>
<li>
<p>对根 View 调用 <code>layout(l, t, r, b)</code>：</p>
<ul>
<li>ViewGroup 会在 <code>onLayout()</code> 中安排子 View 的位置；</li>
<li>整个树的几何结构确定。</li>
</ul>
</li>
</ul>
<ol start="3">
<li>
<h3 data-id="heading-18">performDraw()：真正的绘制</h3>
</li>
</ol>
<p>核心逻辑类似：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">performDraw</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 省略前置逻辑</span>
    <span class="hljs-title function_">draw</span>(fullRedrawNeeded);
}

<span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">draw</span>(<span class="hljs-params"><span class="hljs-built_in">boolean</span> fullRedrawNeeded</span>) {
    <span class="hljs-comment">// 获取/准备 Canvas</span>
    <span class="hljs-comment">// 调用 DecorView.draw(canvas)</span>
}
</code></pre>
<p>调用链：</p>
<pre><code class="hljs language-scss" lang="scss">ViewRootImpl<span class="hljs-selector-class">.performDraw</span>()
    └─ DecorView<span class="hljs-selector-class">.draw</span>(Canvas)
          └─ <span class="hljs-built_in">drawBackground</span>()
          └─ <span class="hljs-built_in">onDraw</span>(Canvas)
          └─ <span class="hljs-built_in">dispatchDraw</span>(Canvas)  <span class="hljs-comment">// 调子 View 的 draw()</span>
                 └─ 每个子 View 的 <span class="hljs-built_in">onDraw</span>(Canvas)
</code></pre>
<ol start="4">
<li>
<h3 data-id="heading-19">Canvas / Skia / OpenGL ES</h3>
</li>
</ol>
<p>在 <code>onDraw(Canvas)</code> 中，开发者用 <code>Canvas</code> 提供的 API 绘制：</p>
<pre><code class="hljs language-css" lang="css">protected void onDraw(<span class="hljs-selector-tag">Canvas</span> <span class="hljs-selector-tag">canvas</span>) {
    <span class="hljs-selector-tag">canvas</span><span class="hljs-selector-class">.drawRect</span>(...);
    <span class="hljs-selector-tag">canvas</span><span class="hljs-selector-class">.drawText</span>(...);
    <span class="hljs-selector-tag">canvas</span><span class="hljs-selector-class">.drawBitmap</span>(...);
}
</code></pre>
<p>底层发生了：</p>
<pre><code class="hljs language-arduino" lang="arduino">Canvas API
    ↓
<span class="hljs-built_in">Skia</span> (<span class="hljs-number">2</span>D 引擎)
    ↓
※ 若软件渲染：在 CPU 内存 buffer 中画像素
※ 若硬件加速(HWUI + OpenGL ES/Vulkan)：
       Skia 将绘制指令转换为 GPU 命令
           ↓
       通过 OpenGL ES / Vulkan 调 GPU 渲染
           ↓
       GPU 把结果写入当前 Surface 的 buffer
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Coze编程首测：我用大白话搭了个“AI漫剧流水线”，太离谱了！]]></title>    <link>https://juejin.cn/post/7585463258690600969</link>    <guid>https://juejin.cn/post/7585463258690600969</guid>    <pubDate>2025-12-20T06:04:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463258690600969" data-draft-id="7585686247269154825" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Coze编程首测：我用大白话搭了个“AI漫剧流水线”，太离谱了！"/> <meta itemprop="keywords" content="Coze,人工智能,AIGC"/> <meta itemprop="datePublished" content="2025-12-20T06:04:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="后端小肥肠"/> <meta itemprop="url" content="https://juejin.cn/user/2966945320667536"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Coze编程首测：我用大白话搭了个“AI漫剧流水线”，太离谱了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2966945320667536/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    后端小肥肠
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T06:04:49.000Z" title="Sat Dec 20 2025 06:04:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是小肥肠！今天我们将硬核实战 <strong>Coze 编程</strong>，打造一套全自动的 <strong>AI 漫剧分镜图片生成</strong> <strong>工作流</strong>。从一段小说原文到精美分镜图一键直出，全程保姆级教程，快来码住跟练，搭建属于你的自动化视觉流水线吧~</p>
<h2 data-id="heading-0">1. 前言</h2>
<p>最近AI漫剧爆火，我也在带着社群的朋友做这块的内容，之前的文章已经解决了AI漫剧版权的问题：<a href="https://juejin.cn/post/7582561515816484927" target="_blank" title="https://juejin.cn/post/7582561515816484927">突破 LLM 极限！n8n + MemMachine 打造“无限流”小说生成器</a>，<a href="https://juejin.cn/post/7580378958072610826" target="_blank" title="https://juejin.cn/post/7580378958072610826">通吃网文投稿+AI漫剧版权！我用 n8n+飞书搭了个“万字爆款小说流水线”</a>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01e81656088d44cf89b833244974ac95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766815489&amp;x-signature=%2BMocmb7BaaqP31Q06U8EyFWMALg%3D" alt="" loading="lazy"/></p>
<p><strong>今天将给大家带来进一步的内容，将小说原文转换为动画分镜图，只需要略加一点动态提示词到AI视频软件就可以产出AI漫剧了。</strong></p>
<p><strong>就在昨天，Coze 编程功能重磅发布，它最大的黑科技在于支持基于自然语言搭建</strong> <strong>工作流</strong> <strong>。</strong> 我抱着试一试的心态，直接把我的需求<strong>丢</strong>给它，结果出乎意料——它竟然秒懂，并直接帮我生成了完整的工作流！整个过程丝滑无比，只需要输入小说内容，点击【试运行】，几分钟后，契合度极高的人物分镜图就诞生了。接下来，我就带大家实操这套<strong>有手就行</strong>的 AI 漫剧分镜流。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc91b20159e14457975b792c0d0b766b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766815489&amp;x-signature=%2Fj8e5mlULfTwGUKjhCycZa%2F3b6s%3D" alt="" loading="lazy"/></p>
<p>下面正式开始教程，文末还送工作流生成提示词，感兴趣就码住跟练~</p>
<h2 data-id="heading-1">2. Coze编程工作流实现</h2>
<p>基于Coze编程创建ai动漫分镜稿的步骤非常简单，首先打开网页<a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.coze.cn%2Fhome%25EF%25BC%258C%25E8%25BE%2593%25E5%2585%25A5%25E6%258F%2590%25E7%25A4%25BA%25E8%25AF%258D%25E5%2590%258E%25E7%2582%25B9%25E5%2587%25BB%25E5%258F%2591%25E9%2580%2581%25E3%2580%2582" target="_blank" title="https://code.coze.cn/home%EF%BC%8C%E8%BE%93%E5%85%A5%E6%8F%90%E7%A4%BA%E8%AF%8D%E5%90%8E%E7%82%B9%E5%87%BB%E5%8F%91%E9%80%81%E3%80%82" ref="nofollow noopener noreferrer">code.coze.cn/home，输入提示词后…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b874cff035b4696bee5566273902c78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766815489&amp;x-signature=J0TRgzsgmdX3WsvVbsWbNBXSi14%3D" alt="" loading="lazy"/></p>
<p><strong>提示词编写思路：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 提取小说内容生成短剧剧本
<span class="hljs-bullet">2.</span> 基于短剧剧本构建角色描述
<span class="hljs-bullet">3.</span> 生成分镜文生图提示词
<span class="hljs-bullet">4.</span> 调用生图模型生成分镜图
</code></pre>
<p>只需要把这四点逻辑告诉 Coze，就可以开始工作流的构建了。构建完成后，右侧界面会自动生成完整的工作流：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/791b103d180d45cbaf70b0394b7f4b72~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766815489&amp;x-signature=7FSFVMQHHtlnMtY3S44L4mZHrFI%3D" alt="" loading="lazy"/></p>
<p>点击右上角【试运行】按钮，输入小说文本内容后再点击底部【试运行】按钮，等待几分钟后就可以看到成品分镜图。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/375ecebc39764d21a3f89ad5ade3ead3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766815489&amp;x-signature=LEL4dvzfvgPfdYDM7oGSqjEDAzI%3D" alt="" loading="lazy"/></p>
<p>打开图片看一下，<strong>人物一致性</strong>保持得很不错！主要是我完全没进行复杂的精调，全是 Coze 自动理解生成的，这个契合度已经非常惊人了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3db1029308e147fc99e03401bb00c8f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766815489&amp;x-signature=ONcaipd%2BCH%2BEAAbGn1%2FhqGz%2B6i4%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0fc134d51ec483b9e0278e79502d8a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766815489&amp;x-signature=8lPFFqpZtE09Ax4abcfRXBXtUuI%3D" alt="" loading="lazy"/></p>
<p>以上就是本期教程的完整内容。本文中生成工作流的提示词限时派送，限量30份，评论区留言ai漫剧即可获取。</p>
<h2 data-id="heading-2">3. 结语</h2>
<p>这次 Coze 编程的更新，最大的意义不在于工具本身，而在于它再次降低了 AI 内容创作的门槛。<strong>以前我们需要学习如何搭建</strong> <strong>工作流</strong> <strong>，现在我们只需要学会如何清晰地表达需求。</strong> 本文搭建的工作流对于想做 AI 漫剧却苦于没有美术基础、或者觉得分镜耗时太长的朋友来说，这绝对是一个提效利器。</p>
<p><strong>如本次分享对你有帮助，麻烦一键三连支持一下小肥肠，我们下期再见~</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb8c39c5529840c38aea5bfdfadae0b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766815489&amp;x-signature=7AKXNIR2fD4oNgW%2BEqtmftvo7P8%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【轻松掌握通信协议】C#的通信过程与协议实操 | 2024全新]]></title>    <link>https://juejin.cn/post/7585382553290473508</link>    <guid>https://juejin.cn/post/7585382553290473508</guid>    <pubDate>2025-12-20T05:58:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585382553290473508" data-draft-id="7585412203978309675" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【轻松掌握通信协议】C#的通信过程与协议实操 | 2024全新"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-20T05:58:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="子元youkeit_xyz"/> <meta itemprop="url" content="https://juejin.cn/user/4469936823730986"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【轻松掌握通信协议】C#的通信过程与协议实操 | 2024全新
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4469936823730986/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    子元youkeit_xyz
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T05:58:33.000Z" title="Sat Dec 20 2025 05:58:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>C<strong>QF 量化金融中文版（23 版）硬核资料｜6 万价值，量化投资通关秘籍</strong></p>
<p>在量化金融的世界里，理论与代码从来不分家。CQF（Certificate in Quantitative Finance）作为全球顶尖的量化金融认证课程，其核心不仅在于随机微积分、衍生品定价和风险管理等高深理论，更在于如何将这些模型转化为可运行、可验证、可交易的代码系统。2023 年新版 CQF 课程进一步强化了机器学习、高频数据处理与 Python 工程实践的比重，对学员的编程能力提出了更高要求。</p>
<p>本文结合《CQF 量化金融中文版（23 版）》硬核资料包中的核心内容，通过<strong>真实代码示例</strong>，带你一窥量化建模的关键环节——从 Black-Scholes 定价到蒙特卡洛模拟，再到使用 LSTM 预测波动率，真正实现“理论落地、代码驱动”。</p>
<hr/>
<h3 data-id="heading-0">一、Black-Scholes 期权定价：理论的第一行代码</h3>
<p>Black-Scholes 模型是 CQF 第一模块的基石。其解析解虽简洁，但理解其实现逻辑至关重要。</p>
<pre><code class="hljs language-python" lang="python">python
编辑
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">from</span> scipy.stats <span class="hljs-keyword">import</span> norm

<span class="hljs-keyword">def</span> <span class="hljs-title function_">black_scholes_call</span>(<span class="hljs-params">S, K, T, r, sigma</span>):
    <span class="hljs-string">"""
    计算欧式看涨期权的 Black-Scholes 价格
    :param S: 标的资产当前价格
    :param K: 行权价
    :param T: 到期时间（年）
    :param r: 无风险利率
    :param sigma: 波动率
    :return: 期权价格
    """</span>
    d1 = (np.log(S / K) + (r + <span class="hljs-number">0.5</span> * sigma**<span class="hljs-number">2</span>) * T) / (sigma * np.sqrt(T))
    d2 = d1 - sigma * np.sqrt(T)
    call_price = S * norm.cdf(d1) - K * np.exp(-r * T) * norm.cdf(d2)
    <span class="hljs-keyword">return</span> call_price

<span class="hljs-comment"># 示例：S=100, K=100, T=1年, r=5%, sigma=20%</span>
price = black_scholes_call(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0.05</span>, <span class="hljs-number">0.2</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Call Option Price: <span class="hljs-subst">{price:<span class="hljs-number">.4</span>f}</span>"</span>)
</code></pre>
<p>这段代码不仅是公式翻译，更是后续 Greeks（Delta、Gamma 等）计算和对冲策略的基础。CQF 资料包中提供了完整的敏感性分析模板，助你理解“为什么波动率是期权的命脉”。</p>
<hr/>
<h3 data-id="heading-1">二、蒙特卡洛模拟：为路径依赖型衍生品定价</h3>
<p>对于亚式期权、回望期权等无解析解的产品，蒙特卡洛方法是 CQF 强调的核心数值技术。</p>
<pre><code class="hljs language-ini" lang="ini">python
编辑
def monte_carlo_asian_call(S0, K, T, r, sigma, <span class="hljs-attr">N</span>=<span class="hljs-number">1000</span>, M=<span class="hljs-number">10000</span>):
    """
    蒙特卡洛模拟亚式看涨期权（算术平均）
    :param N: 时间步数
    :param M: 模拟路径数
    """
    <span class="hljs-attr">dt</span> = T / N
    <span class="hljs-attr">drift</span> = (r - <span class="hljs-number">0.5</span> * sigma**<span class="hljs-number">2</span>) * dt
    <span class="hljs-attr">diffusion</span> = sigma * np.sqrt(dt)
    
    <span class="hljs-attr">payoffs</span> = []
    for _ in range(M):
        <span class="hljs-attr">path</span> = [S0]
        for _ in range(N):
            <span class="hljs-attr">Z</span> = np.random.normal()
            <span class="hljs-attr">St</span> = path[-<span class="hljs-number">1</span>] * np.exp(drift + diffusion * Z)
            path.append(St)
        <span class="hljs-attr">avg_price</span> = np.mean(path[<span class="hljs-number">1</span>:])  <span class="hljs-comment"># 算术平均</span>
        <span class="hljs-attr">payoff</span> = max(avg_price - K, <span class="hljs-number">0</span>)
        payoffs.append(payoff)
    
    <span class="hljs-attr">option_price</span> = np.exp(-r * T) * np.mean(pay<span class="hljs-literal">off</span>s)
    return option_price

<span class="hljs-attr">price_mc</span> = monte_carlo_asian_call(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0.05</span>, <span class="hljs-number">0.2</span>, N=<span class="hljs-number">252</span>, M=<span class="hljs-number">50000</span>)
print(f"Asian Call (MC): {price_mc:.4f}")
</code></pre>
<p>CQF 资料包进一步引入<strong>方差缩减技术</strong>（如控制变量法、对偶变量法），将模拟效率提升数倍——这正是实战与玩具代码的区别。</p>
<hr/>
<h3 data-id="heading-2">三、用 GARCH 模型动态预测波动率</h3>
<p>CQF 第四模块深入讲解波动率建模。GARCH(1,1) 是业界标准，用于捕捉波动率聚集效应。</p>
<pre><code class="hljs language-ini" lang="ini">python
编辑
import arch

<span class="hljs-comment"># 假设已有股票日收益率序列 returns（pandas Series）</span>
def fit_garch(returns):
    <span class="hljs-attr">model</span> = arch.arch_model(returns, vol=<span class="hljs-string">'Garch'</span>, p=<span class="hljs-number">1</span>, q=<span class="hljs-number">1</span>, dist=<span class="hljs-string">'Normal'</span>)
    <span class="hljs-attr">fitted</span> = model.fit(disp=<span class="hljs-string">'off'</span>)
    <span class="hljs-attr">forecast</span> = fitted.forecast(horizon=<span class="hljs-number">1</span>)
    <span class="hljs-comment"># 预测未来1天的条件方差</span>
    <span class="hljs-attr">cond_vol</span> = np.sqrt(forecast.variance.values[-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>])
    return cond_vol

<span class="hljs-comment"># 示例（需真实数据）</span>
<span class="hljs-comment"># daily_returns = get_stock_returns('AAPL')</span>
<span class="hljs-comment"># vol_forecast = fit_garch(daily_returns)</span>
<span class="hljs-comment"># print(f"Predicted Volatility: {vol_forecast:.4f}")</span>
</code></pre>
<p>资料包提供完整 A 股/美股数据获取脚本，并对比 GARCH 与隐含波动率（IV）的预测能力，助你构建更稳健的期权交易策略。</p>
<hr/>
<h3 data-id="heading-3">四、LSTM 预测股价方向（CQF 23 版新增 AI 模块）</h3>
<p>2023 版 CQF 新增“AI in Finance”专题，强调深度学习在 alpha 挖掘中的应用。</p>
<pre><code class="hljs language-ini" lang="ini">python
编辑
from tensorflow.keras.models import Sequential
from tensorflow.keras.layers import LSTM, Dense
from sklearn.preprocessing import MinMaxScaler

def build_lstm_model(X_train):
    <span class="hljs-attr">model</span> = Sequential([
        LSTM(<span class="hljs-number">50</span>, return_sequences=<span class="hljs-literal">True</span>, input_shape=(X_train.shape[<span class="hljs-number">1</span>], <span class="hljs-number">1</span>)),
        LSTM(<span class="hljs-number">50</span>),
        Dense(<span class="hljs-number">1</span>, activation=<span class="hljs-string">'tanh'</span>)  <span class="hljs-comment"># 输出 -1 到 1，代表涨跌方向</span>
    ])
    model.compile(<span class="hljs-attr">optimizer</span>=<span class="hljs-string">'adam'</span>, loss=<span class="hljs-string">'mse'</span>)
    return model

<span class="hljs-comment"># 数据预处理（简化）</span>
<span class="hljs-attr">scaler</span> = MinMaxScaler()
<span class="hljs-attr">scaled_prices</span> = scaler.fit_transform(price_series.reshape(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>))

<span class="hljs-comment"># 构造 X, y：用过去60天预测第61天的收益率符号</span>
X, <span class="hljs-attr">y</span> = [], []
for i in range(60, len(scaled_prices)):
    X.append(scaled_prices<span class="hljs-section">[i-60:i, 0]</span>)
    <span class="hljs-attr">ret</span> = (price_series[i] - price_series[i-<span class="hljs-number">1</span>]) / price_series[i-<span class="hljs-number">1</span>]
    y.append(np.sign(ret))  <span class="hljs-comment"># +1 或 -1</span>

X, <span class="hljs-attr">y</span> = np.array(X), np.array(y)
<span class="hljs-attr">X</span> = np.reshape(X, (X.shape[<span class="hljs-number">0</span>], X.shape[<span class="hljs-number">1</span>], <span class="hljs-number">1</span>))

<span class="hljs-comment"># 训练</span>
<span class="hljs-attr">model</span> = build_lstm_model(X)
model.fit(X, y, <span class="hljs-attr">epochs</span>=<span class="hljs-number">10</span>, batch_size=<span class="hljs-number">32</span>, verbose=<span class="hljs-number">1</span>)
</code></pre>
<p>CQF 资料包强调：<strong>AI 不是魔法，而是特征工程 + 经济逻辑 + 严谨回测的结合体</strong>。课程提供完整的回测框架，避免“过拟合陷阱”。</p>
<hr/>
<h3 data-id="heading-4">五、为什么这套资料值 6 万元？</h3>
<p>《CQF 量化金融中文版（23 版）硬核资料包》并非简单翻译，而是由多位 CQF 持证人、对冲基金量化研究员联合打造，包含：</p>
<ul>
<li><strong>全六模块精讲笔记 + 中文推导手稿</strong>；</li>
<li><strong>200+ Jupyter Notebook 实战项目</strong>（含上述所有代码）；</li>
<li><strong>QuantLib、Pyfolio、Backtrader 高级用法指南</strong>；</li>
<li><strong>Final Project 选题库与评审标准</strong>（如加密货币波动率曲面建模、ESG 因子多空策略）；</li>
<li><strong>面试真题与简历优化建议</strong>（覆盖 Citadel、Two Sigma、国内顶级私募）。</li>
</ul>
<p>对于立志进入量化交易、风险管理或金融科技领域的你，这不仅是通关 CQF 的利器，更是踏入高薪行业的敲门砖。</p>
<hr/>
<h3 data-id="heading-5">结语</h3>
<p>量化金融的本质，是用数学描述市场，用代码验证逻辑，用纪律执行策略。CQF 教给你的不是“必胜公式”，而是一套<strong>严谨、可证伪、可迭代的科学方法论</strong>。而《23 版中文硬核资料包》，就是将这套方法论从英文文献、复杂公式转化为你指尖可运行、可调试、可盈利的生产力工具。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ESM 模块（ECMAScript Module）详解]]></title>    <link>https://juejin.cn/post/7585463195200995378</link>    <guid>https://juejin.cn/post/7585463195200995378</guid>    <pubDate>2025-12-20T05:53:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463195200995378" data-draft-id="7585463258690568201" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ESM 模块（ECMAScript Module）详解"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T05:53:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户5427784851540"/> <meta itemprop="url" content="https://juejin.cn/user/224762173330942"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ESM 模块（ECMAScript Module）详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/224762173330942/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户5427784851540
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T05:53:52.000Z" title="Sat Dec 20 2025 05:53:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>ECMAScript 模块（ECMAScript Modules，简称 ESM）是 JavaScript 语言官方标准化的模块系统，自 ECMAScript 2015（ES6）起正式引入，并在后续版本中不断完善。作为现代 Web 开发的基石，ESM 不仅解决了长期以来 JavaScript 缺乏原生模块化支持的问题，还为构建高性能、可维护的前端和后端应用提供了统一标准。</p>
<hr/>
<p> </p>
<h2 data-id="heading-0">一、JavaScript 模块化的历史演进</h2>
<p>在 ESM 出现之前，JavaScript 社区长期缺乏官方模块系统，开发者依赖各种“约定”或工具实现模块化：</p>
<ul>
<li><strong>全局变量模式</strong>：将功能挂载到全局对象（如 <code>window.MyLib</code>），极易造成命名冲突。</li>
<li><strong>IIFE（立即调用函数表达式）</strong> ：通过闭包实现私有作用域，但无法跨文件共享。</li>
<li><strong>CommonJS</strong>：Node.js 采用的同步 <code>require/module.exports</code> 模式，适合服务端，但无法直接用于浏览器。</li>
<li><strong>AMD（Asynchronous Module Definition）</strong> ：如 RequireJS，支持异步加载，但语法复杂。</li>
<li><strong>UMD（Universal Module Definition）</strong> ：兼容 CommonJS、AMD 和全局变量的混合方案。</li>
</ul>
<p>这些方案互不兼容，导致生态碎片化。开发者不得不依赖打包工具（如 Webpack、Browserify）将模块转换为目标环境可执行的代码。这种“编译时模块系统”虽解决了问题，但也带来了构建复杂度高、启动慢等弊端。</p>
<p>ESM 的出现，标志着 JavaScript 终于拥有了<strong>语言层面、运行时支持、跨平台统一</strong>的模块标准。</p>
<hr/>
<p> </p>
<h2 data-id="heading-1">二、ESM 的核心语法与特性</h2>
<p>ESM 采用声明式语法，强调<strong>静态结构</strong>和<strong>显式依赖</strong>。</p>
<h3 data-id="heading-2">1. 导出（Export）</h3>
<h4 data-id="heading-3">命名导出（Named Exports）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// math.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PI</span> = <span class="hljs-number">3.14159</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>) { <span class="hljs-keyword">return</span> a + b; }
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Calculator</span> { <span class="hljs-comment">/* ... */</span> }


<span class="hljs-comment">// 或批量导出</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">subtract</span> = (<span class="hljs-params">a, b</span>) =&gt; a - b;
<span class="hljs-keyword">const</span> <span class="hljs-title function_">multiply</span> = (<span class="hljs-params">a, b</span>) =&gt; a * b;
<span class="hljs-keyword">export</span> { subtract, multiply };
</code></pre>
<h4 data-id="heading-4">默认导出（Default Export）</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// App.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">App</span> {
  <span class="hljs-comment">// 一个模块只能有一个 default export</span>
}
</code></pre>
<blockquote>
<p>✅ <strong>关键区别</strong>：命名导出可有多个，导入时需用相同名称（或重命名），默认导出无名称，导入时可任意命名</p>
</blockquote>
<h3 data-id="heading-5">2. 导入（Import）</h3>
<h4 data-id="heading-6">导入命名导出</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">PI</span>, add } <span class="hljs-keyword">from</span> <span class="hljs-string">'./math.js'</span>;
<span class="hljs-keyword">import</span> { subtract <span class="hljs-keyword">as</span> minus } <span class="hljs-keyword">from</span> <span class="hljs-string">'./math.js'</span>; <span class="hljs-comment">// 重命名</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">MathUtils</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./math.js'</span>; <span class="hljs-comment">// 导入所有为命名空间对象</span>
</code></pre>
<h4 data-id="heading-7">导入默认导出</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.js'</span>; <span class="hljs-comment">// 无需花括号</span>
</code></pre>
<h4 data-id="heading-8">混合导入</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
</code></pre>
<h4 data-id="heading-9">副作用导入（仅执行模块，不导入绑定）</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">import</span> <span class="hljs-string">'./polyfills.js'</span>; <span class="hljs-comment">// 初始化全局补丁</span>
</code></pre>
<h3 data-id="heading-10">3. 动态导入（Dynamic Import）</h3>
<p>ES2020 引入 <code>import()</code> 表达式，支持运行时按需加载：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 条件加载</span>
<span class="hljs-keyword">if</span> (user.<span class="hljs-property">isAdmin</span>) {
  <span class="hljs-keyword">const</span> adminModule = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./admin.js'</span>);
  adminModule.<span class="hljs-title function_">init</span>();
}


<span class="hljs-comment">// 路由懒加载（React/Vue 中常见）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">HomePage</span> = <span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./HomePage'</span>));
</code></pre>
<blockquote>
<p>⚠️ 注意：<code>import()</code> 返回 Promise，而静态 <code>import</code> 必须位于顶层作用域。</p>
</blockquote>
<hr/>
<p> </p>
<h2 data-id="heading-11">三、ESM 的核心特性与设计哲学</h2>
<h3 data-id="heading-12">1. 静态分析（Static Analyzability）</h3>
<p>ESM 的 <code>import</code>/<code>export</code> 语句<strong>必须是顶层的、字面量的</strong>，不能出现在条件语句或函数中：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 非法</span>
<span class="hljs-keyword">if</span> (condition) {
  <span class="hljs-keyword">import</span> utils <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils.js'</span>; <span class="hljs-comment">// SyntaxError</span>
}
</code></pre>
<p>这一限制使得引擎能在<strong>代码执行前</strong>解析整个依赖图，带来三大优势：</p>
<ul>
<li><strong>Tree Shaking</strong>：打包工具可精准移除未使用的导出（如 Rollup、Webpack）</li>
<li><strong>循环依赖检测</strong>：在编译阶段发现潜在问题</li>
<li><strong>性能优化</strong>：浏览器可并行预加载依赖</li>
</ul>
<h3 data-id="heading-13">2. 实时绑定（Live Bindings）</h3>
<p>ESM 导出的是<strong>绑定（binding）</strong> ，而非值的拷贝：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// counter.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) { count++; }


<span class="hljs-comment">// main.js</span>
<span class="hljs-keyword">import</span> { count, increment } <span class="hljs-keyword">from</span> <span class="hljs-string">'./counter.js'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count); <span class="hljs-comment">// 0</span>
<span class="hljs-title function_">increment</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count); <span class="hljs-comment">// 1 —— 自动同步！</span>
</code></pre>
<p>这与 CommonJS 的“值拷贝”形成鲜明对比，避免了状态不一致问题。</p>
<h3 data-id="heading-14">3. 单例语义（Singleton Semantics）</h3>
<p>每个模块在单个运行时环境中<strong>只执行一次</strong>，后续导入返回同一实例：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// config.js</span>
console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'Config loaded!'</span>);
<span class="hljs-keyword">export</span> <span class="hljs-type">const</span> settings = { theme: <span class="hljs-string">'dark'</span> };


<span class="hljs-comment">// a.js 和 b.js 都 import config.js</span>
<span class="hljs-comment">// "Config loaded!" 仅打印一次</span>
</code></pre>
<p>这保证了模块状态的全局唯一性，适用于配置、缓存等场景。</p>
<hr/>
<p> </p>
<h2 data-id="heading-15">四、ESM 在浏览器中的运行机制</h2>
<h3 data-id="heading-16">1. 启用方式</h3>
<p>在 HTML 中通过 <code>&lt;script type="module"&gt;</code> 启用：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./main.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-comment">&lt;!-- 或内联 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">import</span> { greet } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils.js'</span>;
  <span class="hljs-title function_">greet</span>();
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<blockquote>
</blockquote>
<blockquote>
<p>🔒 <strong>安全限制</strong>：</p>
</blockquote>
<blockquote>
</blockquote>
<blockquote>
<p>模块脚本默认启用 <strong>CORS</strong>，跨域需服务器设置 <code>Access-Control-Allow-Origin</code></p>
</blockquote>
<blockquote>
<p>无法在 <code>file://</code> 协议下运行（需本地服务器）</p>
</blockquote>
<blockquote>
</blockquote>
<h3 data-id="heading-17">2. 加载与执行流程</h3>
<p>当浏览器遇到模块脚本时：</p>
<ol>
<li><strong>解析依赖</strong>：递归解析所有 <code>import</code> 语句，构建依赖图</li>
<li><strong>并行下载</strong>：通过 HTTP/2 多路复用并行请求所有模块</li>
<li><strong>拓扑排序</strong>：按依赖顺序确定执行顺序（无依赖的先执行）</li>
<li><strong>执行模块</strong>：每个模块仅执行一次，导出绑定供其他模块使用</li>
</ol>
<blockquote>
</blockquote>
<blockquote>
<p>💡 <strong>性能优势</strong>： 无需打包即可按需加载，浏览器缓存粒度更细（单个模块级别）</p>
</blockquote>
<h3 data-id="heading-18">3. MIME 类型要求</h3>
<p>服务器必须为 <code>.js</code> 文件返回正确的 MIME 类型：</p>
<pre><code class="hljs language-bash" lang="bash">Content-Type: application/javascript
</code></pre>
<p>否则浏览器会拒绝执行。</p>
<hr/>
<p> </p>
<h2 data-id="heading-19">五、ESM 在 Node.js 中的支持</h2>
<p>Node.js 自 v12 起原生支持 ESM，但需注意与 CommonJS 的互操作性。</p>
<h3 data-id="heading-20">1. 启用方式</h3>
<ul>
<li>文件扩展名 <code>.mjs</code></li>
<li>或在 <code>package.json</code> 中设置 <code>"type": "module"</code></li>
<li>或使用 <code>--input-type=module</code> 标志运行字符串代码</li>
</ul>
<h3 data-id="heading-21">2. 与 CommonJS 互操作</h3>
<h4 data-id="heading-22">ESM 导入 CommonJS</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// CommonJS 模块导出的是 module.exports 对象</span>
<span class="hljs-keyword">import</span> pkg <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash'</span>; <span class="hljs-comment">// 默认导入整个对象</span>
<span class="hljs-keyword">import</span> { debounce } <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash'</span>; <span class="hljs-comment">// 命名导入（需支持）</span>
</code></pre>
<blockquote>
<p>⚠️ 限制：CommonJS 模块的动态属性无法被静态分析，命名导入可能失败。</p>
</blockquote>
<h4 data-id="heading-23">CommonJS 导入 ESM（Node.js v14.13+）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用 async/await</span>
<span class="hljs-keyword">const</span> myModule = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./my-esm-module.js'</span>);
</code></pre>
<h3 data-id="heading-24">3. 路径解析差异</h3>
<p>ESM <strong>必须使用完整路径</strong>（包括扩展名）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 正确</span>
<span class="hljs-keyword">import</span> { foo } <span class="hljs-keyword">from</span> <span class="hljs-string">'./foo.js'</span>;
<span class="hljs-keyword">import</span> { bar } <span class="hljs-keyword">from</span> <span class="hljs-string">'./bar/index.js'</span>;


<span class="hljs-comment">// ❌ 错误（Node.js 不自动补全 .js）</span>
<span class="hljs-keyword">import</span> { foo } <span class="hljs-keyword">from</span> <span class="hljs-string">'./foo'</span>;
</code></pre>
<blockquote>
<p>🛠 解决方案：使用 <code>--experimental-specifier-resolution=node</code> 或构建工具处理。</p>
</blockquote>
<hr/>
<p> </p>
<h2 data-id="heading-25">六、ESM vs CommonJS：关键差异对比</h2>








































<table><thead><tr><th>特性</th><th>ESM</th><th>CommonJS</th></tr></thead><tbody><tr><td><strong>加载时机</strong></td><td>异步（浏览器并行加载）</td><td>同步（Node.js 逐行执行）</td></tr><tr><td><strong>导出本质</strong></td><td>实时绑定（Live Binding）</td><td>值拷贝（Copy of Value）</td></tr><tr><td><strong>this 指向</strong></td><td>undefined</td><td>module.exports</td></tr><tr><td><strong>循环依赖</strong></td><td>支持（绑定未初始化时为 undefined）</td><td>支持（返回部分初始化对象）</td></tr><tr><td><strong>Tree Shaking</strong></td><td>原生支持</td><td>需工具模拟</td></tr><tr><td><strong>顶层 await</strong></td><td>支持（ES2022）</td><td>不支持（需 IIFE 包裹）</td></tr></tbody></table>
<hr/>
<p> </p>
<h2 data-id="heading-26">七、ESM 的实际应用场景</h2>
<h3 data-id="heading-27">1. 前端开发：Vite、Snowpack 等现代构建工具</h3>
<p>Vite 利用浏览器原生 ESM，实现<strong>无打包开发</strong>：</p>
<ul>
<li>开发阶段直接 serve 源码</li>
<li>依赖预构建为 ESM</li>
<li>HMR 基于模块图精准更新</li>
</ul>
<h3 data-id="heading-28">2. 微前端架构</h3>
<p>通过动态 <code>import()</code> 实现子应用按需加载：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">loadMicroApp</span> = async (name) =&gt; {
  const <span class="hljs-attr">app</span> = await import(`https://cdn.com/<span class="hljs-variable">${name}</span>/entry.js`)<span class="hljs-comment">;</span>
  app.bootstrap()<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-29">3. CDN 直接分发</h3>
<p>现代 CDN（如 Skypack、esm.sh）将 npm 包自动转换为 ESM：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'https://esm.sh/react'</span>;
<span class="hljs-keyword">import</span> { createRoot } <span class="hljs-keyword">from</span> <span class="hljs-string">'https://esm.sh/react-dom/client'</span>;
</code></pre>
<h3 data-id="heading-30">4. Web Workers 与 Service Workers</h3>
<p>Workers 支持 ESM 模块：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 主线程</span>
<span class="hljs-keyword">const</span> worker = <span class="hljs-built_in">new</span> Worker(<span class="hljs-string">'./worker.js'</span>, { <span class="hljs-keyword">type</span>: <span class="hljs-string">'module'</span> });


<span class="hljs-comment">// worker.js</span>
<span class="hljs-keyword">import</span> { heavyTask } from <span class="hljs-string">'./utils.js'</span>;
</code></pre>
<hr/>
<p> </p>
<h2 data-id="heading-31">八、未来展望</h2>
<p>ESM 生态仍在快速发展：</p>
<p><strong>Import Maps</strong>：允许在 HTML 中定义模块标识符映射，解决裸模块（bare specifiers）问题</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"importmap"</span>&gt;</span><span class="javascript">
{
  <span class="hljs-string">"imports"</span>: {
    <span class="hljs-string">"lodash"</span>: <span class="hljs-string">"/node_modules/lodash-es/lodash.js"</span>
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<ul>
<li/>
<li><strong>Top-Level Await</strong>：已在 ES2022 标准化，简化异步模块初始化</li>
<li><strong>JSON Modules</strong>：提案阶段，允许直接 <code>import data from './config.json'</code></li>
</ul>
<hr/>
<p> </p>
<h2 data-id="heading-32">结语</h2>
<p>ECMAScript 模块不仅是 JavaScript 语言的一次重要进化，更是现代 Web 开发生态的基础设施。它通过静态分析、实时绑定、单例语义等设计，为构建高性能、可维护的应用提供了坚实基础。随着浏览器和 Node.js 的全面支持，以及 Vite 等工具的普及，ESM 正逐步取代历史遗留的模块方案，成为事实上的标准。</p>
<p>对于开发者而言，深入理解 ESM 的工作机制，不仅能写出更高效的代码，更能充分利用现代工具链的优势，在工程化实践中游刃有余。正如 TC39 委员会所倡导的：“ESM is the future of JavaScript modularity.” —— 拥抱 ESM，就是拥抱 JavaScript 的未来。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Nginx 为什么能进行静态资源托管]]></title>    <link>https://juejin.cn/post/7585706951583186953</link>    <guid>https://juejin.cn/post/7585706951583186953</guid>    <pubDate>2025-12-20T05:59:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585706951583186953" data-draft-id="7585706951583170569" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Nginx 为什么能进行静态资源托管"/> <meta itemprop="keywords" content="Nginx"/> <meta itemprop="datePublished" content="2025-12-20T05:59:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户5427784851540"/> <meta itemprop="url" content="https://juejin.cn/user/224762173330942"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Nginx 为什么能进行静态资源托管
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/224762173330942/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户5427784851540
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T05:59:37.000Z" title="Sat Dec 20 2025 05:59:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Nginx 本质是一个<strong>高性能的 HTTP 服务器</strong>，其核心能力之一就是直接读取服务器本地文件并通过 HTTP 协议返回给客户端。具体来说，它通过以下机制实现静态资源托管：</p>
<h4 data-id="heading-0">1. <strong>事件驱动架构（非阻塞 I/O）</strong></h4>
<p>Nginx 采用 <strong>epoll/kqueue</strong> 等 I/O 多路复用技术，能在单个进程内高效处理<strong>数万并发连接</strong>，而不会为每个连接创建新进程/线程（避免资源开销）。</p>
<ul>
<li><strong>对比 Apache</strong>：传统 Apache 采用多进程/多线程模型，并发量高时会因进程切换导致性能下降。</li>
<li><strong>优势</strong>：处理静态资源时，Nginx 能以极小的内存占用和 CPU 消耗支持高并发请求。</li>
</ul>
<h4 data-id="heading-1">2. <strong>文件系统直接读取</strong></h4>
<p>Nginx 可直接操作服务器文件系统，通过配置 <code>root</code> 或 <code>alias</code> 指令指定静态资源目录，例如：</p>
<pre><code class="hljs language-bash" lang="bash">server {
  root /usr/local/frontend/dist; <span class="hljs-comment"># 静态资源根目录</span>
  location /images/ {
    <span class="hljs-built_in">alias</span> /data/pictures/; <span class="hljs-comment"># 别名目录（与 root 区别：会替换 URL 中的 /images/）</span>
  }
}
</code></pre>
<p>当客户端请求 <code>http://example.com/index.html</code> 时，Nginx 会直接读取 <code>/usr/local/frontend/dist/index.html</code> 并返回。</p>
<h4 data-id="heading-2">3. <strong>HTTP 协议实现</strong></h4>
<p>Nginx 内置完整的 HTTP 协议解析器，能正确处理：</p>
<ul>
<li>请求方法（GET/HEAD 等，静态资源常用 GET）</li>
<li>请求头（如 <code>Range</code> 断点续传）</li>
<li>响应头（如 <code>Content-Type</code>、<code>Cache-Control</code>）</li>
<li>状态码（200/404/304 等）</li>
</ul>
<p>例如，请求图片时自动返回 <code>Content-Type: image/png</code>，浏览器据此正确渲染资源。</p>
<p> </p>
<h3 data-id="heading-3">⚡ 静态资源托管的核心配置指令</h3>
<p>Nginx 通过以下关键指令控制静态资源的读取和响应行为：</p>
<h4 data-id="heading-4">1. <code>root</code> <strong>：指定资源根目录</strong></h4>
<pre><code class="hljs language-arduino" lang="arduino">location /<span class="hljs-type">static</span>/ {
  root /usr/share/nginx/; 
  # 请求 /<span class="hljs-type">static</span>/logo.png → 实际读取 /usr/share/nginx/<span class="hljs-type">static</span>/logo.png
}
</code></pre>
<h4 data-id="heading-5">2. <code>alias</code> <strong>：替换 URL 路径（与</strong> <code>root</code> <strong>区别）</strong></h4>
<pre><code class="hljs language-bash" lang="bash">location /static/ {
  <span class="hljs-built_in">alias</span> /usr/share/nginx/files/; 
  <span class="hljs-comment"># 请求 /static/logo.png → 实际读取 /usr/share/nginx/files/logo.png（注意 alias 路径末尾的 /）</span>
}
</code></pre>
<h4 data-id="heading-6">3. <code>index</code> <strong>：默认主页文件</strong></h4>
<pre><code class="hljs language-ini" lang="ini">server {
  index index.html index.htm<span class="hljs-comment">; </span>
  <span class="hljs-comment"># 请求 / → 自动返回 /index.html（按顺序查找）</span>
}
</code></pre>
<h4 data-id="heading-7">4. <code>try_files</code> <strong>：按顺序尝试读取文件</strong></h4>
<p>解决 SPA（单页应用）路由刷新 404 问题：</p>
<pre><code class="hljs language-bash" lang="bash">location / {
  try_files <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span>/ /index.html; 
  <span class="hljs-comment"># 尝试读取请求的文件 → 目录 → 最后返回 index.html</span>
}
</code></pre>
<h5 data-id="heading-8">🧩 <code>try_files $uri $uri/ /index.html;</code> 的核心作用</h5>
<p><strong>一句话概括</strong>：当用户访问一个路径时，Nginx 会按顺序尝试查找文件或目录，找不到就兜底返回 <code>index.html</code>（前端 SPA 的入口文件）。</p>
<h6 data-id="heading-9">适用场景：</h6>
<p>单页应用（如 Vue/React/Angular），这类应用的路由由前端 JavaScript 控制（如 <code>vue-router</code> 的 <code>history</code> 模式），而非传统的后端路由。</p>
<h5 data-id="heading-10">🔍 逐段解析：三个参数的含义</h5>
<h6 data-id="heading-11">a. <code>$uri</code> <strong>：尝试访问请求的文件</strong></h6>
<ul>
<li><code>$uri</code> 是 Nginx 的内置变量，表示当前请求的 <strong>文件路径</strong>（不包含查询参数）。</li>
<li>例如：<br/>
用户请求 <code>http://example.com/about</code> → <code>$uri</code> 是 <code>/about</code><br/>
Nginx 会先检查服务器上是否存在 <code>/usr/local/frontend/dist/about</code> <strong>文件</strong>（假设 <code>root</code> 指向 <code>dist</code> 目录）。</li>
</ul>
<h6 data-id="heading-12">b. <code>$uri/</code> <strong>：尝试访问请求的目录</strong></h6>
<ul>
<li>如果 <code>$uri</code> 对应的文件不存在，Nginx 会尝试将其作为 <strong>目录</strong> 访问（添加 <code>/</code>）。</li>
<li>例如：<br/>
请求 <code>http://example.com/about</code> → 检查 <code>/usr/local/frontend/dist/about/</code> 目录是否存在，以及该目录下是否有 <code>index.html</code>（由 <code>index</code> 指令配置，如 <code>index index.html</code>）。</li>
</ul>
<h6 data-id="heading-13">c. <code>/index.html</code> <strong>：兜底返回前端入口文件</strong></h6>
<ul>
<li>如果前两个尝试都失败（文件和目录都不存在），Nginx 会直接返回 <code>root</code> 目录下的 <code>index.html</code>（即前端 SPA 的入口文件）。</li>
<li>此时，前端路由（如 <code>vue-router</code>）会根据 URL 中的路径（如 <code>/about</code>）渲染对应的页面组件，从而避免 404 错误。</li>
</ul>
<h6 data-id="heading-14">d. <code>history</code> <strong>模式 vs</strong> <code>hash</code> <strong>模式</strong></h6>
<ul>
<li><code>hash</code> <strong>模式</strong>（如 <code>http://example.com/#/about</code> ）：哈希部分（<code>#/about</code>）不会发送到服务器，因此无需 <code>try_files</code> 也能正常刷新。</li>
<li><code>history</code> <strong>模式</strong>（如 <code>http://example.com/about</code> ）：URL 路径会发送到服务器，必须配置 <code>try_files</code> 才能避免 404。</li>
<li><strong>推荐</strong>：<code>history</code> 模式（URL 更美观）+ <code>try_files</code> 配置。</li>
</ul>
<h5 data-id="heading-15">📝 为什么需要这行配置？</h5>
<p>单页应用的路由是“前端接管”的，所有页面实际上都通过 <code>index.html</code> 加载，再由 JavaScript 根据 URL 动态渲染内容。</p>
<h5 data-id="heading-16"><code>try_files $uri $uri/ /index.html;</code> 的作用就是告诉 Nginx：“如果用户访问的路径不是真实存在的文件/目录，就把处理权交还给前端路由（通过返回 <code>index.html</code>）”。</h5>
<h4 data-id="heading-17">5. <code>expires</code> <strong>与</strong> <code>Cache-Control</code> <strong>：缓存控制</strong></h4>
<pre><code class="hljs language-ruby" lang="ruby">nginx
复制
location ~* .(js|<span class="hljs-params">css</span>|png)<span class="hljs-variable">$ </span>{
  expires 30d; <span class="hljs-comment"># 浏览器缓存 30 天</span>
  add_header <span class="hljs-title class_">Cache</span>-<span class="hljs-title class_">Control</span> <span class="hljs-string">"public, max-age=2592000, immutable"</span>;
}
</code></pre>
<p> </p>
<h3 data-id="heading-18">🚀 Nginx 静态资源托管的性能优化手段</h3>
<p>除了基础能力，Nginx 还提供多种优化策略，让静态资源加载更快：</p>
<h4 data-id="heading-19">1. <strong>启用</strong> <code>gzip</code> <strong>压缩</strong></h4>
<p>压缩 JS/CSS/HTML 等文本资源，减少传输体积：</p>
<pre><code class="hljs language-bash" lang="bash">nginx
复制
gzip on;
gzip_types text/css application/javascript text/html;
gzip_comp_level 5; <span class="hljs-comment"># 压缩等级（1-9，越高压缩率越好但耗 CPU）</span>
</code></pre>
<h4 data-id="heading-20">2. <code>sendfile</code> <strong>零拷贝技术</strong></h4>
<p>跳过用户态与内核态的数据拷贝，直接从磁盘读取文件发送到网络：</p>
<pre><code class="hljs language-csharp" lang="csharp">nginx
复制
sendfile <span class="hljs-keyword">on</span>; <span class="hljs-meta"># 启用零拷贝</span>
tcp_nopush <span class="hljs-keyword">on</span>; <span class="hljs-meta"># 配合 sendfile 使用，减少网络包数量</span>
</code></pre>
<h4 data-id="heading-21">3. <code>open_file_cache</code> <strong>缓存文件元信息</strong></h4>
<p>缓存文件的 inode、大小、修改时间等信息，避免重复 stat 系统调用：</p>
<pre><code class="hljs language-ini" lang="ini">nginx
复制
open_file_cache <span class="hljs-attr">max</span>=<span class="hljs-number">1000</span> inactive=<span class="hljs-number">20</span>s<span class="hljs-comment">;</span>
open_file_cache_valid 30s<span class="hljs-comment">;</span>
open_file_cache_min_uses 2<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-22">4. <strong>限制请求速率（防滥用）</strong></h4>
<pre><code class="hljs language-ini" lang="ini">nginx
复制
limit_rate 100k<span class="hljs-comment">; # 单连接限速 100KB/s</span>
limit_conn_zone $binary_remote_addr <span class="hljs-attr">zone</span>=addr:<span class="hljs-number">10</span>m<span class="hljs-comment">;</span>
limit_conn addr 10<span class="hljs-comment">; # 单 IP 最多 10 个并发连接</span>
</code></pre>
<p> </p>
<h3 data-id="heading-23">📚 为什么不直接用浏览器打开 <code>dist</code> 目录的 HTML 文件？</h3>
<p>虽然 <code>dist</code> 目录包含静态文件，但直接通过 <code>file:///path/to/dist/index.html</code> 打开会有问题：</p>
<ol>
<li><strong>跨域限制</strong>：浏览器禁止 <code>file://</code> 协议下的 AJAX 请求（安全策略）。</li>
<li><strong>路径错误</strong>：相对路径（如 <code>./js/app.js</code>）会被解析为 <code>file://</code> 协议，而非服务器 URL。</li>
<li><strong>路由失效</strong>：SPA 路由（如 <code>/about</code>）会被浏览器视为本地文件路径，导致 404。</li>
</ol>
<p>而 Nginx 提供了标准的 <code>http://</code> 协议环境，完美解决以上问题。</p>
<hr/>
<p> </p>
<h3 data-id="heading-24">📝 总结：Nginx 静态资源托管的核心优势</h3>

























<table><thead><tr><th>优势</th><th>具体说明</th></tr></thead><tbody><tr><td><strong>高性能</strong></td><td>事件驱动架构 + 零拷贝技术，支持高并发低延迟</td></tr><tr><td><strong>配置灵活</strong></td><td>root/alias/try_files 等指令适配各种场景</td></tr><tr><td><strong>功能丰富</strong></td><td>内置缓存、压缩、限速、SSL 等能力</td></tr><tr><td><strong>轻量稳定</strong></td><td>内存占用低，故障率极低，7x24 小时运行无压力</td></tr></tbody></table>
<p>简单说，Nginx 就像一个<strong>高效的"文件快递员"</strong> ：既能快速找到服务器上的静态文件，又能通过各种优化手段把文件"快递"到用户浏览器，还能顺便处理缓存、压缩等"增值服务"。这也是它成为静态资源托管首选工具的根本原因！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在Android开发中阅读源码的指导思路]]></title>    <link>https://juejin.cn/post/7585382553290506276</link>    <guid>https://juejin.cn/post/7585382553290506276</guid>    <pubDate>2025-12-20T06:12:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585382553290506276" data-draft-id="7585412203978276907" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在Android开发中阅读源码的指导思路"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T06:12:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Poorguy9527"/> <meta itemprop="url" content="https://juejin.cn/user/1746465251931063"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在Android开发中阅读源码的指导思路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1746465251931063/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Poorguy9527
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T06:12:17.000Z" title="Sat Dec 20 2025 06:12:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>阅读源码是研究技术底层实现逻辑的必由之路
，也是开发者成长路上必备的一课</p>
</blockquote>
<p>阅读Android源码（尤其是像Kotlin协程这样的复杂框架）需要有系统的方法和清晰的思路。以下是高效阅读源码的指导思路，并以Kotlin协程为例说明具体实施步骤：</p>
<h2 data-id="heading-0">📚 <strong>一、通用源码阅读方法论</strong></h2>
<h3 data-id="heading-1">1. <strong>明确阅读目标</strong></h3>
<pre><code class="hljs language-text" lang="text">初级：理解基本用法和工作原理
中级：掌握内部机制和设计思想
高级：能修改扩展或解决深层次问题
</code></pre>
<h3 data-id="heading-2">2. <strong>分层渐进策略</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 推荐阅读顺序</span>
<span class="hljs-number">1.</span> 官方文档和示例
<span class="hljs-number">2.</span> 关键API使用
<span class="hljs-number">3.</span> 架构概览
<span class="hljs-number">4.</span> 核心流程跟踪
<span class="hljs-number">5.</span> 深入细节实现
</code></pre>
<h2 data-id="heading-3">🔍 <strong>二、具体到Kotlin协程源码</strong></h2>
<h3 data-id="heading-4"><strong>第一步：准备工作</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 搭建调试环境</span>
dependencies {
    implementation(<span class="hljs-string">"org.jetbrains.kotlinx:kotlinx-coroutines-core:1.7.3"</span>)
    implementation(<span class="hljs-string">"org.jetbrains.kotlinx:kotlinx-coroutines-debug:1.7.3"</span>)
}

<span class="hljs-comment">// 2. 使用协程调试工具</span>
CoroutineScope(Dispatchers.Default + CoroutineName(<span class="hljs-string">"test"</span>)).launch {
    debugCoroutine()  <span class="hljs-comment">// 自定义调试函数</span>
}
</code></pre>
<h3 data-id="heading-5"><strong>第二步：由浅入深四层阅读法</strong></h3>
<h4 data-id="heading-6"><strong>第1层：入口和核心接口</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 先看这几个核心接口/类</span>
<span class="hljs-number">1.</span> CoroutineScope - 协程作用域
<span class="hljs-number">2.</span> CoroutineContext - 协程上下文
<span class="hljs-number">3.</span> Continuation - 续体（核心抽象）
<span class="hljs-number">4.</span> CoroutineDispatcher - 调度器
<span class="hljs-number">5.</span> Job/Deferred - 协程任务

<span class="hljs-comment">// 阅读路径建议：</span>
kotlinx.coroutines/
├── CoroutineScope.kt
├── CoroutineContext.kt
├── Continuation.kt
└── AbstractCoroutine.kt
</code></pre>
<h4 data-id="heading-7"><strong>第2层：启动流程分析</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 跟踪 launch/async 执行流程</span>
launch { 
    <span class="hljs-comment">// 代码块</span>
}

<span class="hljs-comment">// 阅读顺序：</span>
<span class="hljs-number">1.</span> CoroutineScope.launch() 扩展函数
<span class="hljs-number">2.</span> StandaloneCoroutine / LazyStandaloneCoroutine
<span class="hljs-number">3.</span> start() -&gt; resumeWith()
<span class="hljs-number">4.</span> 调度器分配逻辑
</code></pre>
<h4 data-id="heading-8"><strong>第3层：调度器实现</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 重点阅读：</span>
<span class="hljs-number">1.</span> Dispatchers.Main/Default/IO/Unconfined
<span class="hljs-number">2.</span> CoroutineScheduler.kt (线程池核心)
<span class="hljs-number">3.</span> 任务窃取算法

<span class="hljs-comment">// 调试技巧：切换调度器观察线程变化</span>
withContext(Dispatchers.IO) {
    println(<span class="hljs-string">"Thread: <span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
}
</code></pre>
<h4 data-id="heading-9"><strong>第4层：挂起机制</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 深入理解 suspend 原理</span>
<span class="hljs-number">1.</span> suspendCoroutine{} / suspendCancellableCoroutine{}
<span class="hljs-number">2.</span> ContinuationImpl
<span class="hljs-number">3.</span> BaseContinuationImpl.resumeWith()
<span class="hljs-number">4.</span> SafeContinuator

<span class="hljs-comment">// 关键文件：</span>
kotlinx.coroutines.intrinsics/
├── Cancellable.kt
└── ContinuationImpl.kt
</code></pre>
<h3 data-id="heading-10"><strong>第三步：实用调试技巧</strong></h3>
<h4 data-id="heading-11"><strong>1. 使用协程调试模式</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 启动时添加VM参数</span>
-Dkotlinx.coroutines.debug=on

<span class="hljs-comment">// 输出包含协程名的堆栈</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    launch(CoroutineName(<span class="hljs-string">"my-coroutine"</span>)) {
        println(<span class="hljs-string">"Running in <span class="hljs-subst">${coroutineContext[CoroutineName]}</span>"</span>)
    }
}
</code></pre>
<h4 data-id="heading-12"><strong>2. 关键断点设置</strong></h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 建议断点位置：</span>
1. AbstractCoroutine.resumeWith()  <span class="hljs-comment"># 协程恢复点</span>
2. CoroutineScheduler.dispatch()   <span class="hljs-comment"># 任务调度点</span>
3. ContinuationImpl.invokeSuspend() <span class="hljs-comment"># 挂起函数执行点</span>
4. JobSupport.cancel()            <span class="hljs-comment"># 取消逻辑</span>
</code></pre>
<h4 data-id="heading-13"><strong>3. 时序图绘制工具</strong></h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
launch -&gt; CoroutineScope: 创建协程
CoroutineScope -&gt; CoroutineScheduler: 提交任务
CoroutineScheduler -&gt; Worker: 分配线程
Worker -&gt; Continuation: 执行续体
Continuation -&gt; suspend: 遇到挂起点
suspend -&gt; dispatch: 释放线程

</code></pre>
<h2 data-id="heading-14">🛠️ <strong>三、高效工具链</strong></h2>
<h3 data-id="heading-15"><strong>1. IDE配置</strong></h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">Android Studio / IntelliJ IDEA:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">安装</span> <span class="hljs-string">"Kotlin"</span> <span class="hljs-string">插件</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">启用</span> <span class="hljs-string">"Kotlin协程调试器"</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">配置源码跳转:</span> <span class="hljs-string">Ctrl+Click</span> <span class="hljs-string">-&gt;</span> <span class="hljs-string">Download</span> <span class="hljs-string">Sources</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">使用</span> <span class="hljs-string">"Structure"</span> <span class="hljs-string">视图查看类层次</span>
</code></pre>
<h3 data-id="heading-16"><strong>2. 命令行工具</strong></h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 生成依赖图</span>
./gradlew :app:dependencies

<span class="hljs-comment"># 反编译查看字节码</span>
javap -c MyCoroutine.class

<span class="hljs-comment"># 使用Kotlin编译器插件</span>
kotlinc -Xcoroutines=<span class="hljs-built_in">enable</span>
</code></pre>
<h3 data-id="heading-17"><strong>3. 可视化工具</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 协程堆栈分析</span>
<span class="hljs-keyword">val</span> stackTrace = Thread.currentThread().stackTrace
stackTrace.forEach { 
    <span class="hljs-keyword">if</span> (it.className.contains(<span class="hljs-string">"coroutine"</span>)) {
        println(<span class="hljs-string">"Coroutine related: <span class="hljs-variable">$it</span>"</span>)
    }
}
</code></pre>
<h2 data-id="heading-18">📝 <strong>四、具体实践：分析一个挂起函数</strong></h2>
<h3 data-id="heading-19"><strong>案例：delay() 实现</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 阅读路径：</span>
<span class="hljs-number">1.</span> kotlinx.coroutines.Delay.kt
<span class="hljs-number">2.</span> kotlinx.coroutines.Delay.delay()
<span class="hljs-number">3.</span> kotlinx.coroutines.EventLoopImplBase.delayNanos()
<span class="hljs-number">4.</span> kotlinx.coroutines.DelayQueue

<span class="hljs-comment">// 关键理解点：</span>
- 如何实现非阻塞延迟
- 与Handler/Looper的集成
- 取消机制的实现
</code></pre>
<h2 data-id="heading-20">🔧 <strong>五、问题导向阅读法</strong></h2>
<p>当遇到问题时，按这个流程：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
A[实际问题] --&gt; B[定位相关类]
B --&gt; C{是否需要深入?}
C --&gt;|是| D[阅读核心方法]
C --&gt;|否| E[查看API文档]
D --&gt; F[绘制调用关系]
F --&gt; G[验证猜想]
</code></pre>
<h2 data-id="heading-21">💡 <strong>六、学习建议</strong></h2>
<ol>
<li><strong>先会用再读源码</strong> - 熟练掌握API后再深入</li>
<li><strong>带着问题读</strong> - 每次解决一个具体疑问</li>
<li><strong>做笔记画图</strong> - 用图表记录核心流程</li>
<li><strong>写测试验证</strong> - 通过单元测试理解行为</li>
<li><strong>参与社区</strong> - 关注Kotlin协程的GitHub Issues</li>
</ol>
<h2 data-id="heading-22">📚 <strong>七、推荐阅读材料</strong></h2>
<pre><code class="hljs language-text" lang="text">官方文档:
- Kotlin协程指南: https://kotlinlang.org/docs/coroutines-guide.html
- 设计文档: https://github.com/Kotlin/kotlinx.coroutines/blob/master/docs/topics/coroutines-design.md

源码位置:
- GitHub: kotlinx.coroutines
- 包结构: kotlinx.coroutines.*
</code></pre>
<p>记住：<strong>不要试图一次性理解所有代码</strong>。协程源码有2万+行，应该分模块、分层次逐步深入。建议先从 <code>kotlinx.coroutines.core</code> 开始，理解基本模型后再看 <code>kotlinx.coroutines.android</code> 等平台特定实现。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[支付成功订单却没了？MyBatis连接池的坑我踩了]]></title>    <link>https://juejin.cn/post/7585446706327126025</link>    <guid>https://juejin.cn/post/7585446706327126025</guid>    <pubDate>2025-12-20T06:25:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585446706327126025" data-draft-id="7585463258690650121" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="支付成功订单却没了？MyBatis连接池的坑我踩了"/> <meta itemprop="keywords" content="后端,面试,Java"/> <meta itemprop="datePublished" content="2025-12-20T06:25:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="9号达人"/> <meta itemprop="url" content="https://juejin.cn/user/2450136052270077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            支付成功订单却没了？MyBatis连接池的坑我踩了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2450136052270077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    9号达人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T06:25:35.000Z" title="Sat Dec 20 2025 06:25:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">事故现场</h2>
<p>上周线上炸了。</p>
<p>支付业务出了问题，用户支付成功，但订单表没数据。更诡异的是，修改订单时有时也会提示获取锁超时。</p>
<p>DBA看了一眼数据库连接，发现几个事务一直没提交，锁着订单表的几行数据。</p>
<p>排查半天，最后发现是某个业务接口忘了提交事务。</p>
<p>按理说,事务没提交应该很容易发现。但这个bug就比较隐蔽。</p>
<p><strong>4个反常识的现象：</strong></p>
<ol>
<li><strong>业务代码正常执行完毕</strong> 没有任何报错，日志也正常打印。</li>
<li><strong>日志显示事务已提交</strong> commit方法被调用了，但数据库里没数据。</li>
<li><strong>偶尔会成功</strong> 大部分时候失败，但偶尔能正常插入订单。</li>
</ol>
<p>这种情况让人摸不着头脑。代码没报错，日志也正常，为啥数据就是不入库?</p>
<h2 data-id="heading-1">应急处理</h2>
<p>线上出问题，那肯定先恢复业务再说。</p>
<p>最快的办法就是重启应用，强制释放这些连接。</p>
<p>重启完，支付功能恢复正常。但问题还是要找到</p>
<p>重启只能暂时缓解，得找到到底哪个业务出了问题。</p>
<p>对比了最近的上线记录，发现有个新业务刚上线。检查代码，果然发现了问题：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SomeService</span> {

    <span class="hljs-keyword">public</span> void handleSpecialCase() {
        <span class="hljs-comment">// 开启事务</span>
        sqlSession.connection.setAutoCommit(<span class="hljs-literal">false</span>);

        <span class="hljs-comment">// 执行SQL</span>
        mapper.insert(<span class="hljs-keyword">data</span>);

        <span class="hljs-comment">// 特殊情况下，忘记commit了！</span>
        <span class="hljs-keyword">if</span> (specialCondition) {
            <span class="hljs-comment">// 某些情况下会return，但没commit</span>
            <span class="hljs-keyword">return</span>;
        }

        sqlSession.commit();
    }
}
</code></pre>
<p>特殊分支直接return了，commit没执行。</p>
<h3 data-id="heading-2">快速修复</h3>
<p>立即补上commit，重新上线：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SomeService</span> {

    <span class="hljs-keyword">public</span> void handleSpecialCase() {
        <span class="hljs-keyword">try</span> {
            sqlSession.connection.setAutoCommit(<span class="hljs-literal">false</span>);
            mapper.insert(<span class="hljs-keyword">data</span>);

            <span class="hljs-keyword">if</span> (specialCondition) {
                sqlSession.commit(); <span class="hljs-comment">// 补上！</span>
                <span class="hljs-keyword">return</span>;
            }

            sqlSession.commit();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            sqlSession.rollback();
            <span class="hljs-keyword">throw</span> e;
        }
    }
}
</code></pre>
<p>上线后验证，问题解决。</p>
<h2 data-id="heading-3">事后复盘</h2>
<p>问题虽然解决了，但还是很奇怪：为啥一个业务的事务没提交，会影响到其他完全不相关的支付业务？</p>
<p>周末花了半天debug源码，终于搞清楚了。</p>
<h3 data-id="heading-4">断点打在getTransaction</h3>
<p>首先在Spring的<code>getTransaction</code>方法打断点，发现出问题的请求都会走到这里：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">final</span> <span class="hljs-selector-tag">TransactionStatus</span> <span class="hljs-selector-tag">getTransaction</span>(<span class="hljs-variable">@Nullable</span> TransactionDefinition definition)
        <span class="hljs-selector-tag">throws</span> <span class="hljs-selector-tag">TransactionException</span> {

    <span class="hljs-comment">// 使用默认的事务定义</span>
    <span class="hljs-selector-tag">TransactionDefinition</span> <span class="hljs-selector-tag">def</span> = (definition != null ? <span class="hljs-attribute">definition </span>: TransactionDefinition.<span class="hljs-built_in">withDefaults</span>());

    <span class="hljs-comment">// 关键：获取当前事务对象</span>
    <span class="hljs-selector-tag">Object</span> <span class="hljs-selector-tag">transaction</span> = <span class="hljs-selector-tag">doGetTransaction</span>();
    <span class="hljs-selector-tag">boolean</span> <span class="hljs-selector-tag">debugEnabled</span> = <span class="hljs-selector-tag">logger</span><span class="hljs-selector-class">.isDebugEnabled</span>();

    <span class="hljs-comment">// 判断是否是已存在的事务</span>
    <span class="hljs-selector-tag">if</span> (<span class="hljs-built_in">isExistingTransaction</span>(transaction)) {
        <span class="hljs-comment">// 发现已存在的事务，直接返回</span>
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">handleExistingTransaction</span>(def, transaction, debugEnabled);
    }

    <span class="hljs-comment">// 创建新事务的逻辑...</span>
}
</code></pre>
<p>问题就出在<code>doGetTransaction</code>这个方法。</p>
<h3 data-id="heading-5">doGetTransaction会复用连接</h3>
<p>点开<code>doGetTransaction</code>，会发现：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">doGetTransaction</span><span class="hljs-params">()</span> {
    <span class="hljs-type">DataSourceTransactionObject</span> <span class="hljs-variable">txObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataSourceTransactionObject</span>();
    txObject.setSavepointAllowed(<span class="hljs-built_in">this</span>.isNestedTransactionAllowed());

    <span class="hljs-comment">// 关键：从TransactionSynchronizationManager获取连接</span>
    <span class="hljs-type">ConnectionHolder</span> <span class="hljs-variable">conHolder</span> <span class="hljs-operator">=</span> (ConnectionHolder) TransactionSynchronizationManager.getResource(<span class="hljs-built_in">this</span>.obtainDataSource());

    txObject.setConnectionHolder(conHolder, <span class="hljs-literal">false</span>);
    <span class="hljs-keyword">return</span> txObject;
}
</code></pre>
<p><code>TransactionSynchronizationManager.getResource</code>会从连接池拿连接。如果拿到一个被污染的连接（上一个事务没提交），<code>ConnectionHolder</code>里就带着上一个事务的状态。</p>
<h3 data-id="heading-6">isExistingTransaction的判断</h3>
<p>然后<code>isExistingTransaction</code>会检查这个连接：</p>
<pre><code class="hljs language-scss" lang="scss">protected boolean <span class="hljs-built_in">isExistingTransaction</span>(Object transaction) {
    DataSourceTransactionObject txObject = (DataSourceTransactionObject)transaction;
    return txObject<span class="hljs-selector-class">.hasConnectionHolder</span>() &amp;&amp; txObject<span class="hljs-selector-class">.getConnectionHolder</span>()<span class="hljs-selector-class">.isTransactionActive</span>();
}
</code></pre>
<p>如果连接上有事务标记(<code>isTransactionActive()</code>)，就认为是已存在的事务，不会创建新事务。</p>
<p>问题来了：如果上一个业务用完连接后，事务没提交也没回滚，<code>ConnectionHolder</code>的事务标记还在。下一个业务通过<code>doGetTransaction</code>从<code>TransactionSynchronizationManager</code>拿到这个<code>ConnectionHolder</code>，就被当成已存在的事务了。</p>
<h3 data-id="heading-7">被污染的连接是怎么来的</h3>
<p>回顾前面应急处理时找到的那段demo代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SomeService</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleSpecialCase</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 开启事务</span>
        <span class="hljs-type">TransactionStatus</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> transactionManager.getTransaction(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultTransactionDefinition</span>());

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 执行SQL</span>
            mapper.insert(data);

            <span class="hljs-comment">// 特殊分支：直接return，没commit！</span>
            <span class="hljs-keyword">if</span> (specialCondition) {
                <span class="hljs-keyword">return</span>;
            }

            transactionManager.commit(status);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            transactionManager.rollback(status);
            <span class="hljs-keyword">throw</span> e;
        }
    }
}
</code></pre>
<p>当走到特殊分支return时：</p>
<ul>
<li><code>ConnectionHolder</code>已经被标记为有事务（<code>isTransactionActive() = true</code>）</li>
<li>但事务既没commit，也没rollback</li>
<li>方法结束后，连接归还到<code>TransactionSynchronizationManager</code></li>
<li><code>ConnectionHolder</code>的事务标记还在</li>
</ul>
<p>这个连接就被污染了。</p>
<h3 data-id="heading-8">复用导致的问题</h3>
<p>其他业务刚好复用到了这个被污染的连接：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentService</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-comment">// 手动开启事务</span>
        <span class="hljs-type">TransactionStatus</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> transactionManager.getTransaction(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultTransactionDefinition</span>());

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 插入订单</span>
            orderMapper.insert(order);

            <span class="hljs-comment">// 提交事务</span>
            transactionManager.commit(status);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            transactionManager.rollback(status);
            <span class="hljs-keyword">throw</span> e;
        }
    }
}
</code></pre>
<p>看起来没问题，对吧？但当这个方法获取到被污染的连接时：</p>
<ol>
<li><code>getTransaction</code>判断<code>isExistingTransaction</code>为true</li>
<li>走进<code>handleExistingTransaction</code>方法</li>
<li>根据事务传播行为，可能会加入现有事务，而不是创建新事务</li>
<li>最后commit时，因为不是事务发起者，不会真正提交</li>
</ol>
<h3 data-id="heading-9">processCommit的判断</h3>
<p>继续debug到commit方法，发现会执行processCommit去完成提交：</p>
<pre><code class="hljs language-scss" lang="scss">private void <span class="hljs-built_in">processCommit</span>(DefaultTransactionStatus status) throws TransactionException {
    try {
        boolean beforeCompletionInvoked = false;

        try {
            <span class="hljs-built_in">prepareForCommit</span>(status);
            <span class="hljs-built_in">triggerBeforeCommit</span>(status);
            <span class="hljs-built_in">triggerBeforeCompletion</span>(status);
            beforeCompletionInvoked = true;

            if (status.hasSavepoint()) {
                status<span class="hljs-selector-class">.releaseHeldSavepoint</span>();
            }
            <span class="hljs-comment">// 关键判断：只有新事务才真正提交</span>
            else if (status.isNewTransaction()) {
                if (status.isDebug()) {
                    logger<span class="hljs-selector-class">.debug</span>("Initiating transaction commit");
                }
                <span class="hljs-comment">// 真正执行数据库commit</span>
                <span class="hljs-built_in">doCommit</span>(status);
            }
            <span class="hljs-comment">// 如果不是新事务，什么都不做！</span>

        } catch (UnexpectedRollbackException ex) {
            <span class="hljs-comment">// ...</span>
        }

    } finally {
        <span class="hljs-built_in">cleanupAfterCompletion</span>(status);
    }
}
</code></pre>
<p>因为<code>status.isNewTransaction()</code>返回false（这是个加入的事务，不是新事务），所以<code>doCommit(status)</code>根本不会执行。</p>
<p>真正的<code>connection.commit()</code>根本没执行。</p>
<h3 data-id="heading-10">完整的问题链路</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/949f8bc5fad646ce99fe08ea931a121b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgOeWPt-i-vuS6ug==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766816735&amp;x-signature=eaui1jMxdtT2JMmKe2B7tW5yA9M%3D" alt="" loading="lazy"/></p>
<ol>
<li><code>SomeService.handleSpecialCase()</code>特殊分支没提交事务</li>
<li>方法结束，<code>ConnectionHolder</code>归还到<code>TransactionSynchronizationManager</code>，但事务标记<code>isTransactionActive()</code>还是true</li>
<li><code>PaymentService.createOrder()</code>调用<code>doGetTransaction()</code></li>
<li><code>doGetTransaction</code>从<code>TransactionSynchronizationManager</code>拿到被污染的<code>ConnectionHolder</code></li>
<li><code>isExistingTransaction</code>判断为true，认为已有事务</li>
<li>走<code>handleExistingTransaction</code>流程，加入现有事务（<code>isNewTransaction = false</code>）</li>
<li>业务代码执行完，调用<code>commit</code></li>
<li><code>processCommit</code>中判断<code>isNewTransaction()</code>为false，跳过<code>doCommit</code></li>
<li>数据没入库，<code>ConnectionHolder</code>继续待在<code>TransactionSynchronizationManager</code>，继续污染下一个业务</li>
</ol>
<h2 data-id="heading-11">为什么偶尔会成功？</h2>
<p>因为<code>TransactionSynchronizationManager</code>是ThreadLocal实现的，每个线程有独立的资源。</p>
<p>如果支付请求分配到一个干净的线程（没有被污染的<code>ConnectionHolder</code>），就能正常工作。但只要分配到被污染的线程，就会出问题。</p>
<p>这就是为什么这个bug这么难发现：</p>
<ul>
<li>不是100%复现（取决于线程池调度）</li>
<li>没有报错信息</li>
<li>日志看起来正常</li>
</ul>
<h2 data-id="heading-12">预防措施</h2>
<p>经过这次事故，我们加了几个预防措施。</p>
<h3 data-id="heading-13">1. 连接池健康检查</h3>
<p>配置连接池的连接校验：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">hikari:</span>
      <span class="hljs-string">connection-test-query:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span>
      <span class="hljs-string">validation-timeout:</span> <span class="hljs-number">3000</span>
      <span class="hljs-comment"># 从池子取连接前先测试</span>
      <span class="hljs-string">connection-init-sql:</span> <span class="hljs-string">SET</span> <span class="hljs-string">autocommit=1</span>
</code></pre>
<p><code>connection-init-sql</code>会在每次从池子取连接时重置状态，避免被污染的连接影响业务。</p>
<h3 data-id="heading-14">2. 监控告警</h3>
<p>增加数据库长事务监控：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查找执行超过30秒的事务</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span> information_schema.innodb_trx
<span class="hljs-keyword">WHERE</span> TIME_TO_SEC(TIMEDIFF(NOW(), trx_started)) <span class="hljs-operator">&gt;</span> <span class="hljs-number">30</span>;
</code></pre>
<p>配置告警规则，超过30秒的事务立即报警。</p>
<h2 data-id="heading-15">踩坑总结</h2>
<p>这次事故让我明白了几点。</p>
<h3 data-id="heading-16">1. 连接池不只是性能优化</h3>
<p>之前我一直觉得连接池就是提升性能的。这次才懂，连接池还会带来状态复用的坑。</p>
<p>一个连接的问题，会影响后面所有复用这个连接的业务。</p>
<h3 data-id="heading-17">2. 事务管理要写清楚</h3>
<p>手动管理事务，一定要写清楚commit和rollback：</p>
<ul>
<li>commit写在try块末尾</li>
<li>rollback写在catch块</li>
<li>finally块关闭资源</li>
</ul>
<p>别偷懒省这几行代码。一个遗漏的commit，就可能导致线上事故。</p>
<h3 data-id="heading-18">3. 监控要覆盖到数据库层</h3>
<p>应用层日志正常，不代表数据库层没问题。</p>
<p>必须要有数据库层面的监控：</p>
<ul>
<li>慢查询</li>
<li>长事务</li>
<li>锁等待</li>
<li>连接数</li>
</ul>
<h3 data-id="heading-19">4. 源码不能只看，要调试</h3>
<p>看源码很多时候看不出问题。这次是真的打断点一步步走，才发现<code>getTransaction</code>方法里有个<code>isExistingTransaction</code>的判断。</p>
<p>遇到诡异问题，直接上断点调试。看调用栈，看变量值，比看文档快多了。</p>
<h2 data-id="heading-20">写在最后</h2>
<p>这个bug修复后，我跟同事也分享了一下。记录了问题现象、排查过程、根本原因、解决方案和预防措施。</p>
<p>不是为了甩锅，是为了让团队其他人避免踩同样的坑。</p>
<p>技术债不可怕，可怕的是踩坑了还不总结。</p>
<p>生产环境的每一次事故，都是学习的机会。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AQS抽象队列同步器原理与应用]]></title>    <link>https://juejin.cn/post/7585382553290604580</link>    <guid>https://juejin.cn/post/7585382553290604580</guid>    <pubDate>2025-12-20T06:40:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585382553290604580" data-draft-id="7585171571129876516" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AQS抽象队列同步器原理与应用"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-20T06:40:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="無量"/> <meta itemprop="url" content="https://juejin.cn/user/1116759546145086"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AQS抽象队列同步器原理与应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759546145086/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    無量
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T06:40:38.000Z" title="Sat Dec 20 2025 06:40:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读33分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、理论知识与核心概念</h2>
<h3 data-id="heading-1">1.1 什么是AQS?</h3>
<p>AQS(AbstractQueuedSynchronizer,抽象队列同步器)是Java并发包(JUC)中最核心的基础框架之一,由Doug Lea大师设计并实现。它为构建锁和同步器提供了一套通用的框架,通过<strong>内置的FIFO双向队列</strong>来管理线程的竞争和等待。</p>
<p>简单来说,AQS解决了实现同步器时的大量通用性工作,包括:</p>
<ul>
<li><strong>同步状态的原子性管理</strong></li>
<li><strong>线程的阻塞与唤醒</strong></li>
<li><strong>等待队列的维护</strong></li>
</ul>
<p>开发者只需要继承AQS并实现特定的几个方法,就能构建出各种功能强大的同步工具。</p>
<h3 data-id="heading-2">1.2 AQS在Java并发包中的地位</h3>
<p>AQS是整个JUC包的基石,以下同步工具都基于AQS实现:</p>
<p><strong>独占锁:</strong></p>
<ul>
<li><code>ReentrantLock</code> - 可重入独占锁</li>
<li><code>ReentrantReadWriteLock.WriteLock</code> - 写锁</li>
</ul>
<p><strong>共享锁:</strong></p>
<ul>
<li><code>Semaphore</code> - 信号量</li>
<li><code>CountDownLatch</code> - 倒计数门闩</li>
<li><code>ReentrantReadWriteLock.ReadLock</code> - 读锁</li>
</ul>
<p><strong>其他同步工具:</strong></p>
<ul>
<li><code>CyclicBarrier</code> - 循环屏障(基于ReentrantLock+Condition)</li>
<li><code>ThreadPoolExecutor.Worker</code> - 线程池工作线程(内部使用AQS)</li>
</ul>
<p>可以说,掌握AQS原理是深入理解Java并发编程的必经之路。</p>
<h3 data-id="heading-3">1.3 AQS的设计思想:模板方法模式</h3>
<p>AQS采用了<strong>模板方法设计模式</strong>:</p>
<p><strong>AQS定义了同步器的骨架流程:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 模板方法 - 获取锁的标准流程</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquire</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">if</span> (!tryAcquire(arg) &amp;&amp;           <span class="hljs-comment">// 尝试获取(子类实现)</span>
        acquireQueued(                <span class="hljs-comment">// 进入队列等待(AQS实现)</span>
            addWaiter(Node.EXCLUSIVE), arg)) <span class="hljs-comment">// 加入队列(AQS实现)</span>
        selfInterrupt();
}
</code></pre>
<p><strong>子类只需实现具体的获取/释放逻辑:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();
}
</code></pre>
<p>这种设计让AQS复用了线程调度、队列管理等复杂逻辑,子类只关注业务语义。</p>
<h3 data-id="heading-4">1.4 同步器与锁的关系</h3>
<p><strong>锁是面向使用者的API</strong>, 而<strong>同步器是面向锁实现者的框架</strong>:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 锁 - 对外API</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReentrantLock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Lock</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Sync sync;  <span class="hljs-comment">// 内部同步器</span>

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span> {
        sync.acquire(<span class="hljs-number">1</span>);  <span class="hljs-comment">// 委托给同步器</span>
    }
}

<span class="hljs-comment">// 同步器 - 实现细节</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> {
    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span>;

    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
        <span class="hljs-comment">// 具体的锁获取逻辑</span>
    }
}
</code></pre>
<p><strong>关键区别:</strong></p>
<ul>
<li>锁定义了<code>lock()/unlock()</code>等用户友好的API</li>
<li>同步器负责实际的线程竞争、排队、唤醒等底层机制</li>
<li>一个锁可以有多种同步器实现(如公平锁/非公平锁)</li>
</ul>
<hr/>
<h2 data-id="heading-5">二、原理深度剖析</h2>
<h3 data-id="heading-6">2.1 AQS核心设计思想</h3>
<h4 data-id="heading-7">2.1.1 同步状态(state)</h4>
<p>AQS使用一个<code>volatile int</code>类型的成员变量<code>state</code>来表示同步状态:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> state;

<span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getState</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> state;
}

<span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setState</span><span class="hljs-params">(<span class="hljs-type">int</span> newState)</span> {
    state = newState;
}

<span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">compareAndSetState</span><span class="hljs-params">(<span class="hljs-type">int</span> expect, <span class="hljs-type">int</span> update)</span> {
    <span class="hljs-keyword">return</span> unsafe.compareAndSwapInt(<span class="hljs-built_in">this</span>, stateOffset, expect, update);
}
</code></pre>
<p><strong>state的语义由子类定义:</strong></p>






























<table><thead><tr><th>同步器</th><th>state含义</th><th>获取条件</th></tr></thead><tbody><tr><td>ReentrantLock</td><td>重入次数</td><td>state=0表示未锁定</td></tr><tr><td>Semaphore</td><td>剩余许可数</td><td>state&gt;0表示有许可</td></tr><tr><td>CountDownLatch</td><td>倒计数值</td><td>state=0表示门闩打开</td></tr><tr><td>ReentrantReadWriteLock</td><td>高16位:读锁数<br/>低16位:写锁数</td><td>复合判断</td></tr></tbody></table>
<p><strong>CAS操作保证原子性:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 非公平锁的快速获取</span>
<span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">nonfairTryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
    <span class="hljs-keyword">final</span> <span class="hljs-type">Thread</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> Thread.currentThread();
    <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> getState();
    <span class="hljs-keyword">if</span> (c == <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// CAS原子操作抢占锁</span>
        <span class="hljs-keyword">if</span> (compareAndSetState(<span class="hljs-number">0</span>, acquires)) {
            setExclusiveOwnerThread(current);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<h4 data-id="heading-8">2.1.2 CLH队列锁</h4>
<p>AQS内部维护了一个基于<strong>CLH(Craig, Landin, and Hagersten)队列锁</strong>的变体:</p>
<p><strong>原始CLH队列特点:</strong></p>
<ul>
<li>自旋锁,基于链表</li>
<li>每个节点自旋检查前驱节点的状态</li>
<li>前驱释放锁时,后继自动获得锁</li>
</ul>
<p><strong>AQS的改进:</strong></p>
<ul>
<li>使用双向链表(便于取消操作)</li>
<li>节点不再自旋,而是阻塞等待(park/unpark)</li>
<li>前驱节点负责唤醒后继节点</li>
</ul>
<p><strong>Node节点结构:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span> {
    <span class="hljs-comment">// 模式</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Node</span> <span class="hljs-variable">SHARED</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>();    <span class="hljs-comment">// 共享模式</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Node</span> <span class="hljs-variable">EXCLUSIVE</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;       <span class="hljs-comment">// 独占模式</span>

    <span class="hljs-comment">// 等待状态</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">CANCELLED</span> <span class="hljs-operator">=</span>  <span class="hljs-number">1</span>;  <span class="hljs-comment">// 线程已取消</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SIGNAL</span>    <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;  <span class="hljs-comment">// 后继需要唤醒</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">CONDITION</span> <span class="hljs-operator">=</span> -<span class="hljs-number">2</span>;  <span class="hljs-comment">// 在条件队列中等待</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">PROPAGATE</span> <span class="hljs-operator">=</span> -<span class="hljs-number">3</span>;  <span class="hljs-comment">// 共享模式下传播唤醒</span>

    <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> waitStatus;        <span class="hljs-comment">// 当前节点状态</span>
    <span class="hljs-keyword">volatile</span> Node prev;             <span class="hljs-comment">// 前驱节点</span>
    <span class="hljs-keyword">volatile</span> Node next;             <span class="hljs-comment">// 后继节点</span>
    <span class="hljs-keyword">volatile</span> Thread thread;         <span class="hljs-comment">// 等待的线程</span>
    Node nextWaiter;               <span class="hljs-comment">// 条件队列下一个节点/模式标记</span>
}
</code></pre>
<p><strong>队列结构示意(见下图):</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f298f64fc56845e5b5e3301549ee0481~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Sh6YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766817638&amp;x-signature=7svwD2YJSrjKJGMFGzM25Q%2FlZF4%3D" alt="aqs-queue-structure.svg" loading="lazy"/>
<strong>双向链表的维护:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 入队 - 通过CAS将节点加到队尾</span>
<span class="hljs-keyword">private</span> Node <span class="hljs-title function_">enq</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Node node)</span> {
    <span class="hljs-keyword">for</span> (;;) {
        <span class="hljs-type">Node</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> tail;
        <span class="hljs-keyword">if</span> (t == <span class="hljs-literal">null</span>) {  <span class="hljs-comment">// 队列为空,初始化</span>
            <span class="hljs-keyword">if</span> (compareAndSetHead(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>()))
                tail = head;
        } <span class="hljs-keyword">else</span> {
            node.prev = t;
            <span class="hljs-keyword">if</span> (compareAndSetTail(t, node)) {  <span class="hljs-comment">// CAS设置tail</span>
                t.next = node;
                <span class="hljs-keyword">return</span> t;
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-9">2.1.3 独占模式与共享模式</h4>
<p><strong>独占模式(Exclusive):</strong></p>
<ul>
<li>同一时刻只有一个线程能持有锁</li>
<li>典型应用:ReentrantLock、WriteLock</li>
</ul>
<p><strong>共享模式(Shared):</strong></p>
<ul>
<li>同一时刻允许多个线程同时持有</li>
<li>典型应用:Semaphore、ReadLock、CountDownLatch</li>
</ul>
<p><strong>实现差异:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 独占模式 - 获取成功后只唤醒一个后继</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setHead</span><span class="hljs-params">(Node node)</span> {
    head = node;
    node.thread = <span class="hljs-literal">null</span>;
    node.prev = <span class="hljs-literal">null</span>;
}

<span class="hljs-comment">// 共享模式 - 获取成功后传播唤醒</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setHeadAndPropagate</span><span class="hljs-params">(Node node, <span class="hljs-type">int</span> propagate)</span> {
    <span class="hljs-type">Node</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> head;
    setHead(node);

    <span class="hljs-comment">// 如果还有剩余资源,继续唤醒后继</span>
    <span class="hljs-keyword">if</span> (propagate &gt; <span class="hljs-number">0</span> || h == <span class="hljs-literal">null</span> || h.waitStatus &lt; <span class="hljs-number">0</span> ||
        (h = head) == <span class="hljs-literal">null</span> || h.waitStatus &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-type">Node</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> node.next;
        <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">null</span> || s.isShared())
            doReleaseShared();  <span class="hljs-comment">// 传播唤醒</span>
    }
}
</code></pre>
<h3 data-id="heading-10">2.2 AQS核心方法源码剖析</h3>
<h4 data-id="heading-11">2.2.1 acquire(int arg) - 独占式获取</h4>
<p><strong>完整流程:</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62192b2f43e44181a3dd38ece2359787~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Sh6YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766817638&amp;x-signature=fkHI5VbjDn8QxCaSrChzzf6cvRI%3D" alt="aqs-acquire-flow.svg" loading="lazy"/></p>
<p><strong>源码分析:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 独占模式获取,忽略中断
 * 1. 尝试获取(tryAcquire)
 * 2. 失败则加入队列并阻塞(acquireQueued)
 * 3. 被唤醒后重新尝试获取
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquire</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">if</span> (!tryAcquire(arg) &amp;&amp;                    <span class="hljs-comment">// ①尝试获取</span>
        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))  <span class="hljs-comment">// ②入队+自旋</span>
        selfInterrupt();                        <span class="hljs-comment">// ③补偿中断</span>
}

<span class="hljs-comment">// ① tryAcquire - 子类实现,定义获取语义</span>
<span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();
}

<span class="hljs-comment">// ② addWaiter - 创建节点并加入队尾</span>
<span class="hljs-keyword">private</span> Node <span class="hljs-title function_">addWaiter</span><span class="hljs-params">(Node mode)</span> {
    <span class="hljs-type">Node</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>(Thread.currentThread(), mode);
    <span class="hljs-type">Node</span> <span class="hljs-variable">pred</span> <span class="hljs-operator">=</span> tail;

    <span class="hljs-comment">// 快速入队尝试</span>
    <span class="hljs-keyword">if</span> (pred != <span class="hljs-literal">null</span>) {
        node.prev = pred;
        <span class="hljs-keyword">if</span> (compareAndSetTail(pred, node)) {
            pred.next = node;
            <span class="hljs-keyword">return</span> node;
        }
    }

    <span class="hljs-comment">// 快速失败,调用完整入队逻辑</span>
    enq(node);
    <span class="hljs-keyword">return</span> node;
}

<span class="hljs-comment">// ③ acquireQueued - 在队列中自旋获取</span>
<span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">acquireQueued</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Node node, <span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-type">boolean</span> <span class="hljs-variable">failed</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">try</span> {
        <span class="hljs-type">boolean</span> <span class="hljs-variable">interrupted</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">for</span> (;;) {  <span class="hljs-comment">// 自旋</span>
            <span class="hljs-keyword">final</span> <span class="hljs-type">Node</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> node.predecessor();

            <span class="hljs-comment">// 前驱是head才有资格尝试获取</span>
            <span class="hljs-keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) {
                setHead(node);      <span class="hljs-comment">// 获取成功,设为新head</span>
                p.next = <span class="hljs-literal">null</span>;      <span class="hljs-comment">// 帮助GC</span>
                failed = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">return</span> interrupted;
            }

            <span class="hljs-comment">// 检查是否需要阻塞</span>
            <span class="hljs-keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;
                parkAndCheckInterrupt())  <span class="hljs-comment">// 阻塞等待</span>
                interrupted = <span class="hljs-literal">true</span>;
        }
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-keyword">if</span> (failed)
            cancelAcquire(node);  <span class="hljs-comment">// 异常情况取消获取</span>
    }
}

<span class="hljs-comment">// 判断是否应该阻塞</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">shouldParkAfterFailedAcquire</span><span class="hljs-params">(Node pred, Node node)</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">ws</span> <span class="hljs-operator">=</span> pred.waitStatus;

    <span class="hljs-keyword">if</span> (ws == Node.SIGNAL)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 前驱状态为SIGNAL,可以安心阻塞</span>

    <span class="hljs-keyword">if</span> (ws &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// 前驱已取消,跳过所有已取消的节点</span>
        <span class="hljs-keyword">do</span> {
            node.prev = pred = pred.prev;
        } <span class="hljs-keyword">while</span> (pred.waitStatus &gt; <span class="hljs-number">0</span>);
        pred.next = node;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 设置前驱状态为SIGNAL</span>
        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}

<span class="hljs-comment">// 阻塞当前线程</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">parkAndCheckInterrupt</span><span class="hljs-params">()</span> {
    LockSupport.park(<span class="hljs-built_in">this</span>);  <span class="hljs-comment">// 阻塞</span>
    <span class="hljs-keyword">return</span> Thread.interrupted();  <span class="hljs-comment">// 返回中断状态并清除中断标志</span>
}
</code></pre>
<p><strong>关键点:</strong></p>
<ol>
<li><strong>自旋与阻塞结合</strong>: 先自旋几次,失败后才阻塞,减少线程切换</li>
<li><strong>只有head的后继能尝试获取</strong>: 保证FIFO公平性</li>
<li><strong>前驱负责唤醒后继</strong>: 通过waitStatus=SIGNAL标识</li>
<li><strong>中断处理</strong>: 获取过程中不响应中断,只记录标志,最后补偿</li>
</ol>
<h4 data-id="heading-12">2.2.2 release(int arg) - 独占式释放</h4>
<p><strong>完整流程:</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3bbb8fd5b8d848fda72108834ec7d602~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Sh6YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766817638&amp;x-signature=%2BpC%2FhgrD3axW4acoeizR3Td8zDY%3D" alt="aqs-release-flow.svg" loading="lazy"/></p>
<p><strong>源码分析:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 独占模式释放
 * 1. 尝试释放(tryRelease)
 * 2. 成功则唤醒后继节点
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">release</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">if</span> (tryRelease(arg)) {           <span class="hljs-comment">// ①尝试释放</span>
        <span class="hljs-type">Node</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> head;
        <span class="hljs-keyword">if</span> (h != <span class="hljs-literal">null</span> &amp;&amp; h.waitStatus != <span class="hljs-number">0</span>)
            unparkSuccessor(h);      <span class="hljs-comment">// ②唤醒后继</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}

<span class="hljs-comment">// ① tryRelease - 子类实现</span>
<span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryRelease</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();
}

<span class="hljs-comment">// ② unparkSuccessor - 唤醒后继节点</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unparkSuccessor</span><span class="hljs-params">(Node node)</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">ws</span> <span class="hljs-operator">=</span> node.waitStatus;
    <span class="hljs-keyword">if</span> (ws &lt; <span class="hljs-number">0</span>)
        compareAndSetWaitStatus(node, ws, <span class="hljs-number">0</span>);  <span class="hljs-comment">// 清除信号</span>

    <span class="hljs-type">Node</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> node.next;

    <span class="hljs-comment">// 如果后继为空或已取消,从tail向前找最近的有效节点</span>
    <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">null</span> || s.waitStatus &gt; <span class="hljs-number">0</span>) {
        s = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">Node</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> tail; t != <span class="hljs-literal">null</span> &amp;&amp; t != node; t = t.prev)
            <span class="hljs-keyword">if</span> (t.waitStatus &lt;= <span class="hljs-number">0</span>)
                s = t;
    }

    <span class="hljs-keyword">if</span> (s != <span class="hljs-literal">null</span>)
        LockSupport.unpark(s.thread);  <span class="hljs-comment">// 唤醒线程</span>
}
</code></pre>
<p><strong>为什么从tail向前遍历?</strong></p>
<p>考虑并发入队场景:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// addWaiter中的入队操作</span>
node.prev = pred;                    <span class="hljs-comment">// ①设置prev</span>
<span class="hljs-keyword">if</span> (compareAndSetTail(pred, node)) { <span class="hljs-comment">// ②CAS设置tail</span>
    pred.next = node;                <span class="hljs-comment">// ③设置next</span>
    <span class="hljs-keyword">return</span> node;
}
</code></pre>
<p>在②③之间,<code>next</code>指针尚未设置,但<code>prev</code>已经设置。从后向前遍历能保证找到所有已入队的节点。</p>
<h4 data-id="heading-13">2.2.3 acquireShared(int arg) - 共享式获取</h4>
<p><strong>源码分析:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">if</span> (tryAcquireShared(arg) &lt; <span class="hljs-number">0</span>)  <span class="hljs-comment">// 返回值:负数-失败,0-成功但无剩余,正数-成功且有剩余</span>
        doAcquireShared(arg);
}

<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doAcquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">final</span> <span class="hljs-type">Node</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> addWaiter(Node.SHARED);  <span class="hljs-comment">// 共享模式节点</span>
    <span class="hljs-type">boolean</span> <span class="hljs-variable">failed</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">try</span> {
        <span class="hljs-type">boolean</span> <span class="hljs-variable">interrupted</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">for</span> (;;) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">Node</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> node.predecessor();
            <span class="hljs-keyword">if</span> (p == head) {
                <span class="hljs-type">int</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> tryAcquireShared(arg);
                <span class="hljs-keyword">if</span> (r &gt;= <span class="hljs-number">0</span>) {
                    setHeadAndPropagate(node, r);  <span class="hljs-comment">// 关键:传播唤醒</span>
                    p.next = <span class="hljs-literal">null</span>;
                    <span class="hljs-keyword">if</span> (interrupted)
                        selfInterrupt();
                    failed = <span class="hljs-literal">false</span>;
                    <span class="hljs-keyword">return</span>;
                }
            }
            <span class="hljs-keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;
                parkAndCheckInterrupt())
                interrupted = <span class="hljs-literal">true</span>;
        }
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-keyword">if</span> (failed)
            cancelAcquire(node);
    }
}

<span class="hljs-comment">// 共享模式的核心:传播唤醒</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setHeadAndPropagate</span><span class="hljs-params">(Node node, <span class="hljs-type">int</span> propagate)</span> {
    <span class="hljs-type">Node</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> head;
    setHead(node);

    <span class="hljs-comment">// propagate &gt; 0表示还有剩余资源,继续唤醒后继</span>
    <span class="hljs-keyword">if</span> (propagate &gt; <span class="hljs-number">0</span> || h == <span class="hljs-literal">null</span> || h.waitStatus &lt; <span class="hljs-number">0</span> ||
        (h = head) == <span class="hljs-literal">null</span> || h.waitStatus &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-type">Node</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> node.next;
        <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">null</span> || s.isShared())
            doReleaseShared();  <span class="hljs-comment">// 释放共享锁,唤醒后继</span>
    }
}
</code></pre>
<p><strong>共享模式与独占模式的关键区别:</strong></p>
<ul>
<li>独占: 只唤醒一个后继,后继成为新head</li>
<li>共享: 唤醒后继,后继继续唤醒下一个,形成<strong>传播链</strong></li>
</ul>
<h4 data-id="heading-14">2.2.4 条件队列(Condition)</h4>
<p><strong>ConditionObject实现原理:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConditionObject</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Condition</span> {
    <span class="hljs-comment">// 条件队列头尾指针(单向链表)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> Node firstWaiter;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> Node lastWaiter;

    <span class="hljs-comment">// await - 释放锁,加入条件队列,等待signal</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">await</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
        <span class="hljs-keyword">if</span> (Thread.interrupted())
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterruptedException</span>();

        <span class="hljs-type">Node</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> addConditionWaiter();    <span class="hljs-comment">// ①加入条件队列</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">savedState</span> <span class="hljs-operator">=</span> fullyRelease(node); <span class="hljs-comment">// ②完全释放锁</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">interruptMode</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

        <span class="hljs-comment">// ③不在同步队列中则阻塞</span>
        <span class="hljs-keyword">while</span> (!isOnSyncQueue(node)) {
            LockSupport.park(<span class="hljs-built_in">this</span>);
            <span class="hljs-keyword">if</span> ((interruptMode = checkInterruptWhileWaiting(node)) != <span class="hljs-number">0</span>)
                <span class="hljs-keyword">break</span>;
        }

        <span class="hljs-comment">// ④被signal后,重新竞争锁</span>
        <span class="hljs-keyword">if</span> (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)
            interruptMode = REINTERRUPT;

        <span class="hljs-keyword">if</span> (node.nextWaiter != <span class="hljs-literal">null</span>)
            unlinkCancelledWaiters();  <span class="hljs-comment">// 清理取消节点</span>

        <span class="hljs-keyword">if</span> (interruptMode != <span class="hljs-number">0</span>)
            reportInterruptAfterWait(interruptMode);
    }

    <span class="hljs-comment">// signal - 将条件队列头节点转移到同步队列</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">signal</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (!isHeldExclusively())
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalMonitorStateException</span>();

        <span class="hljs-type">Node</span> <span class="hljs-variable">first</span> <span class="hljs-operator">=</span> firstWaiter;
        <span class="hljs-keyword">if</span> (first != <span class="hljs-literal">null</span>)
            doSignal(first);  <span class="hljs-comment">// 转移到同步队列</span>
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doSignal</span><span class="hljs-params">(Node first)</span> {
        <span class="hljs-keyword">do</span> {
            <span class="hljs-keyword">if</span> ((firstWaiter = first.nextWaiter) == <span class="hljs-literal">null</span>)
                lastWaiter = <span class="hljs-literal">null</span>;
            first.nextWaiter = <span class="hljs-literal">null</span>;
        } <span class="hljs-keyword">while</span> (!transferForSignal(first) &amp;&amp;  <span class="hljs-comment">// 转移节点</span>
                 (first = firstWaiter) != <span class="hljs-literal">null</span>);
    }
}

<span class="hljs-comment">// 将节点从条件队列转移到同步队列</span>
<span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">transferForSignal</span><span class="hljs-params">(Node node)</span> {
    <span class="hljs-comment">// CAS修改状态从CONDITION到0</span>
    <span class="hljs-keyword">if</span> (!compareAndSetWaitStatus(node, Node.CONDITION, <span class="hljs-number">0</span>))
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// 加入同步队列</span>
    <span class="hljs-type">Node</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> enq(node);
    <span class="hljs-type">int</span> <span class="hljs-variable">ws</span> <span class="hljs-operator">=</span> p.waitStatus;

    <span class="hljs-comment">// 如果前驱已取消或设置SIGNAL失败,直接唤醒</span>
    <span class="hljs-keyword">if</span> (ws &gt; <span class="hljs-number">0</span> || !compareAndSetWaitStatus(p, ws, Node.SIGNAL))
        LockSupport.unpark(node.thread);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p><strong>条件队列 vs 同步队列:</strong></p>



































<table><thead><tr><th>维度</th><th>条件队列</th><th>同步队列</th></tr></thead><tbody><tr><td>数据结构</td><td>单向链表</td><td>双向链表</td></tr><tr><td>节点状态</td><td>CONDITION(-2)</td><td>SIGNAL(-1)等</td></tr><tr><td>触发条件</td><td>await()主动进入</td><td>锁竞争失败进入</td></tr><tr><td>退出条件</td><td>signal()唤醒</td><td>前驱释放锁</td></tr><tr><td>多条件支持</td><td>一个Lock多个Condition</td><td>一个同步队列</td></tr></tbody></table>
<p><strong>Condition使用场景:</strong></p>
<p>生产者-消费者模式:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BoundedBuffer</span> {
    <span class="hljs-keyword">final</span> <span class="hljs-type">Lock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();
    <span class="hljs-keyword">final</span> <span class="hljs-type">Condition</span> <span class="hljs-variable">notFull</span>  <span class="hljs-operator">=</span> lock.newCondition();  <span class="hljs-comment">// 非满条件</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">Condition</span> <span class="hljs-variable">notEmpty</span> <span class="hljs-operator">=</span> lock.newCondition();  <span class="hljs-comment">// 非空条件</span>

    <span class="hljs-keyword">final</span> Object[] items = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">100</span>];
    <span class="hljs-type">int</span> putptr, takeptr, count;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(Object x)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        lock.lock();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">while</span> (count == items.length)
                notFull.await();  <span class="hljs-comment">// 队列满,等待notFull信号</span>

            items[putptr] = x;
            <span class="hljs-keyword">if</span> (++putptr == items.length) putptr = <span class="hljs-number">0</span>;
            ++count;
            notEmpty.signal();  <span class="hljs-comment">// 通知消费者</span>
        } <span class="hljs-keyword">finally</span> {
            lock.unlock();
        }
    }

    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">take</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
        lock.lock();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">while</span> (count == <span class="hljs-number">0</span>)
                notEmpty.await();  <span class="hljs-comment">// 队列空,等待notEmpty信号</span>

            <span class="hljs-type">Object</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> items[takeptr];
            <span class="hljs-keyword">if</span> (++takeptr == items.length) takeptr = <span class="hljs-number">0</span>;
            --count;
            notFull.signal();  <span class="hljs-comment">// 通知生产者</span>
            <span class="hljs-keyword">return</span> x;
        } <span class="hljs-keyword">finally</span> {
            lock.unlock();
        }
    }
}
</code></pre>
<h3 data-id="heading-15">2.3 ReentrantLock vs synchronized深度对比</h3>
<h4 data-id="heading-16">2.3.1 功能对比</h4>























































<table><thead><tr><th>功能</th><th>synchronized</th><th>ReentrantLock</th></tr></thead><tbody><tr><td>可重入性</td><td>✅支持</td><td>✅支持</td></tr><tr><td>公平性选择</td><td>❌不支持(非公平)</td><td>✅支持公平/非公平</td></tr><tr><td>可中断获取</td><td>❌不支持</td><td>✅lockInterruptibly()</td></tr><tr><td>超时获取</td><td>❌不支持</td><td>✅tryLock(timeout)</td></tr><tr><td>非阻塞获取</td><td>❌不支持</td><td>✅tryLock()</td></tr><tr><td>条件变量</td><td>❌只有一个(wait/notify)</td><td>✅多个Condition</td></tr><tr><td>锁绑定</td><td>❌绑定对象</td><td>✅可绑定任意对象</td></tr><tr><td>自动释放</td><td>✅JVM自动</td><td>❌需手动unlock</td></tr><tr><td>死锁检测</td><td>✅JVM支持</td><td>❌需自行实现</td></tr></tbody></table>
<p><strong>代码示例对比:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// synchronized - 简洁但功能受限</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 业务逻辑</span>
}

<span class="hljs-comment">// ReentrantLock - 灵活但需手动管理</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>(<span class="hljs-literal">true</span>);  <span class="hljs-comment">// 公平锁</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span> {
    lock.lock();
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 业务逻辑</span>
    } <span class="hljs-keyword">finally</span> {
        lock.unlock();  <span class="hljs-comment">// 必须在finally中释放</span>
    }
}

<span class="hljs-comment">// 可中断获取</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">methodWithInterrupt</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
    lock.lockInterruptibly();
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 长时间操作</span>
    } <span class="hljs-keyword">finally</span> {
        lock.unlock();
    }
}

<span class="hljs-comment">// 超时获取</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">methodWithTimeout</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (lock.tryLock(<span class="hljs-number">3</span>, TimeUnit.SECONDS)) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 业务逻辑</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">finally</span> {
            lock.unlock();
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// 获取锁超时</span>
}
</code></pre>
<h4 data-id="heading-17">2.3.2 性能对比</h4>
<p><strong>JDK 1.6之前:</strong></p>
<ul>
<li>synchronized是重量级锁,完全依赖操作系统互斥量</li>
<li>ReentrantLock完全在用户态实现,性能明显优于synchronized</li>
</ul>
<p><strong>JDK 1.6之后(锁优化):</strong></p>
<ul>
<li>synchronized引入偏向锁、轻量级锁、自旋锁等优化</li>
<li>低竞争场景下,synchronized性能与ReentrantLock相当甚至更好</li>
</ul>
<p><strong>性能测试(JDK 17):</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@BenchmarkMode(Mode.Throughput)</span>
<span class="hljs-meta">@Warmup(iterations = 3)</span>
<span class="hljs-meta">@Measurement(iterations = 5)</span>
<span class="hljs-meta">@State(Scope.Benchmark)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LockBenchmark</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">syncLock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">reentrantLock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

    <span class="hljs-comment">// 低竞争场景(1线程)</span>
    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-meta">@Threads(1)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">synchronizedLowContention</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">synchronized</span> (syncLock) {
            count++;
        }
    }

    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-meta">@Threads(1)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reentrantLockLowContention</span><span class="hljs-params">()</span> {
        reentrantLock.lock();
        <span class="hljs-keyword">try</span> {
            count++;
        } <span class="hljs-keyword">finally</span> {
            reentrantLock.unlock();
        }
    }

    <span class="hljs-comment">// 高竞争场景(16线程)</span>
    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-meta">@Threads(16)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">synchronizedHighContention</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">synchronized</span> (syncLock) {
            count++;
        }
    }

    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-meta">@Threads(16)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reentrantLockHighContention</span><span class="hljs-params">()</span> {
        reentrantLock.lock();
        <span class="hljs-keyword">try</span> {
            count++;
        } <span class="hljs-keyword">finally</span> {
            reentrantLock.unlock();
        }
    }
}
</code></pre>
<p><strong>测试结果(ops/s,越高越好):</strong></p>























<table><thead><tr><th>场景</th><th>synchronized</th><th>ReentrantLock(非公平)</th><th>ReentrantLock(公平)</th></tr></thead><tbody><tr><td>低竞争(1线程)</td><td>120M</td><td>115M</td><td>110M</td></tr><tr><td>高竞争(16线程)</td><td>8M</td><td>12M</td><td>6M</td></tr></tbody></table>
<p><strong>结论:</strong></p>
<ul>
<li><strong>低竞争</strong>: synchronized略优(JVM优化好)</li>
<li><strong>高竞争</strong>: ReentrantLock非公平模式最优</li>
<li><strong>公平锁</strong>: 性能明显下降(需维护FIFO顺序)</li>
</ul>
<h4 data-id="heading-18">2.3.3 使用场景选择</h4>
<p><strong>选择synchronized的场景:</strong></p>
<ul>
<li>✅ 简单的互斥访问</li>
<li>✅ 不需要高级特性(中断、超时、公平性)</li>
<li>✅ 代码简洁性优先</li>
<li>✅ 兼容旧代码</li>
</ul>
<p><strong>选择ReentrantLock的场景:</strong></p>
<ul>
<li>✅ 需要公平锁(避免线程饥饿)</li>
<li>✅ 需要可中断获取(如超时取消)</li>
<li>✅ 需要尝试获取(tryLock)</li>
<li>✅ 需要多个条件变量(复杂等待通知)</li>
<li>✅ 需要锁投票、定时、可中断的锁获取</li>
</ul>
<p><strong>决策树:</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">需要高级特性?
├─ 是 → ReentrantLock
│   ├─ 需要公平性? → <span class="hljs-keyword">new</span> <span class="hljs-built_in">ReentrantLock</span>(<span class="hljs-literal">true</span>)
│   └─ 性能优先? → <span class="hljs-keyword">new</span> <span class="hljs-built_in">ReentrantLock</span>(<span class="hljs-literal">false</span>)
└─ 否 → <span class="hljs-keyword">synchronized</span>
</code></pre>
<h3 data-id="heading-19">2.4 其他AQS同步工具实现原理</h3>
<h4 data-id="heading-20">2.4.1 CountDownLatch - 倒计数门闩</h4>
<p><strong>实现原理:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CountDownLatch</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> {
        Sync(<span class="hljs-type">int</span> count) {
            setState(count);  <span class="hljs-comment">// state=倒计数初始值</span>
        }

        <span class="hljs-comment">// 共享式获取:state=0时成功</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">tryAcquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
            <span class="hljs-keyword">return</span> (getState() == <span class="hljs-number">0</span>) ? <span class="hljs-number">1</span> : -<span class="hljs-number">1</span>;
        }

        <span class="hljs-comment">// 共享式释放:递减state</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryReleaseShared</span><span class="hljs-params">(<span class="hljs-type">int</span> releases)</span> {
            <span class="hljs-keyword">for</span> (;;) {
                <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> getState();
                <span class="hljs-keyword">if</span> (c == <span class="hljs-number">0</span>)
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// 已经为0,无需释放</span>

                <span class="hljs-type">int</span> <span class="hljs-variable">nextc</span> <span class="hljs-operator">=</span> c - <span class="hljs-number">1</span>;
                <span class="hljs-keyword">if</span> (compareAndSetState(c, nextc))
                    <span class="hljs-keyword">return</span> nextc == <span class="hljs-number">0</span>;  <span class="hljs-comment">// 减到0时返回true,触发唤醒</span>
            }
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Sync sync;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CountDownLatch</span><span class="hljs-params">(<span class="hljs-type">int</span> count)</span> {
        <span class="hljs-keyword">if</span> (count &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"count &lt; 0"</span>);
        <span class="hljs-built_in">this</span>.sync = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sync</span>(count);
    }

    <span class="hljs-comment">// 等待state减到0</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">await</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
        sync.acquireSharedInterruptibly(<span class="hljs-number">1</span>);
    }

    <span class="hljs-comment">// 递减state</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">countDown</span><span class="hljs-params">()</span> {
        sync.releaseShared(<span class="hljs-number">1</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getCount</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sync.getState();
    }
}
</code></pre>
<p><strong>关键点:</strong></p>
<ul>
<li>state表示倒计数值</li>
<li><code>await()</code>在state&gt;0时阻塞,state=0时所有线程一起被唤醒</li>
<li><code>countDown()</code>每次递减state,减到0时唤醒所有等待线程</li>
<li><strong>一次性使用</strong>: state减到0后无法重置</li>
</ul>
<h4 data-id="heading-21">2.4.2 CyclicBarrier - 循环屏障</h4>
<p><strong>实现原理(基于ReentrantLock + Condition):</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CyclicBarrier</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Condition</span> <span class="hljs-variable">trip</span> <span class="hljs-operator">=</span> lock.newCondition();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> parties;        <span class="hljs-comment">// 参与线程数</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Runnable barrierCommand;  <span class="hljs-comment">// 屏障动作</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> count;                <span class="hljs-comment">// 剩余等待数</span>

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Generation</span> {
        <span class="hljs-type">boolean</span> <span class="hljs-variable">broken</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;       <span class="hljs-comment">// 屏障是否被破坏</span>
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">Generation</span> <span class="hljs-variable">generation</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Generation</span>();

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CyclicBarrier</span><span class="hljs-params">(<span class="hljs-type">int</span> parties, Runnable barrierAction)</span> {
        <span class="hljs-keyword">if</span> (parties &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>();
        <span class="hljs-built_in">this</span>.parties = parties;
        <span class="hljs-built_in">this</span>.count = parties;
        <span class="hljs-built_in">this</span>.barrierCommand = barrierAction;
    }

    <span class="hljs-comment">// 到达屏障点并等待</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">await</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException, BrokenBarrierException {
        <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.lock;
        lock.lock();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">final</span> <span class="hljs-type">Generation</span> <span class="hljs-variable">g</span> <span class="hljs-operator">=</span> generation;

            <span class="hljs-keyword">if</span> (g.broken)
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BrokenBarrierException</span>();

            <span class="hljs-keyword">if</span> (Thread.interrupted()) {
                breakBarrier();
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterruptedException</span>();
            }

            <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> --count;
            <span class="hljs-keyword">if</span> (index == <span class="hljs-number">0</span>) {  <span class="hljs-comment">// 最后一个到达</span>
                <span class="hljs-type">boolean</span> <span class="hljs-variable">ranAction</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">final</span> <span class="hljs-type">Runnable</span> <span class="hljs-variable">command</span> <span class="hljs-operator">=</span> barrierCommand;
                    <span class="hljs-keyword">if</span> (command != <span class="hljs-literal">null</span>)
                        command.run();  <span class="hljs-comment">// 执行屏障动作</span>
                    ranAction = <span class="hljs-literal">true</span>;
                    nextGeneration();   <span class="hljs-comment">// 开启下一代</span>
                    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
                } <span class="hljs-keyword">finally</span> {
                    <span class="hljs-keyword">if</span> (!ranAction)
                        breakBarrier();
                }
            }

            <span class="hljs-comment">// 不是最后一个,循环等待</span>
            <span class="hljs-keyword">for</span> (;;) {
                <span class="hljs-keyword">try</span> {
                    trip.await();  <span class="hljs-comment">// 等待signal</span>
                    <span class="hljs-keyword">break</span>;
                } <span class="hljs-keyword">catch</span> (InterruptedException ie) {
                    <span class="hljs-keyword">if</span> (g == generation &amp;&amp; !g.broken) {
                        breakBarrier();
                        <span class="hljs-keyword">throw</span> ie;
                    } <span class="hljs-keyword">else</span> {
                        Thread.currentThread().interrupt();
                    }
                }

                <span class="hljs-keyword">if</span> (g.broken)
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BrokenBarrierException</span>();

                <span class="hljs-keyword">if</span> (g != generation)
                    <span class="hljs-keyword">return</span> index;
            }
        } <span class="hljs-keyword">finally</span> {
            lock.unlock();
        }
    }

    <span class="hljs-comment">// 开启下一代(重置count,唤醒所有等待线程)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">nextGeneration</span><span class="hljs-params">()</span> {
        trip.signalAll();
        count = parties;
        generation = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Generation</span>();
    }
}
</code></pre>
<p><strong>CountDownLatch vs CyclicBarrier:</strong></p>








































<table><thead><tr><th>维度</th><th>CountDownLatch</th><th>CyclicBarrier</th></tr></thead><tbody><tr><td>底层实现</td><td>AQS共享模式</td><td>ReentrantLock + Condition</td></tr><tr><td>可重用性</td><td>❌一次性</td><td>✅可重置</td></tr><tr><td>等待角色</td><td>一组等一组</td><td>互相等待</td></tr><tr><td>计数方向</td><td>递减到0</td><td>递增到N</td></tr><tr><td>屏障动作</td><td>❌不支持</td><td>✅支持barrierAction</td></tr><tr><td>典型场景</td><td>主线程等所有子线程完成</td><td>多线程互相等待同步点</td></tr></tbody></table>
<h4 data-id="heading-22">2.4.3 Semaphore - 信号量</h4>
<p><strong>实现原理:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Semaphore</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">java</span>.io.Serializable {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Sync sync;

    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> {
        Sync(<span class="hljs-type">int</span> <span class="hljs-keyword">permits</span>) {
            setState(<span class="hljs-keyword">permits</span>);  <span class="hljs-comment">// state=许可数</span>
        }

        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getPermits</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> getState();
        }

        <span class="hljs-comment">// 非公平获取</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">nonfairTryAcquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
            <span class="hljs-keyword">for</span> (;;) {
                <span class="hljs-type">int</span> <span class="hljs-variable">available</span> <span class="hljs-operator">=</span> getState();
                <span class="hljs-type">int</span> <span class="hljs-variable">remaining</span> <span class="hljs-operator">=</span> available - acquires;
                <span class="hljs-keyword">if</span> (remaining &lt; <span class="hljs-number">0</span> ||
                    compareAndSetState(available, remaining))
                    <span class="hljs-keyword">return</span> remaining;
            }
        }

        <span class="hljs-comment">// 释放许可</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryReleaseShared</span><span class="hljs-params">(<span class="hljs-type">int</span> releases)</span> {
            <span class="hljs-keyword">for</span> (;;) {
                <span class="hljs-type">int</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> getState();
                <span class="hljs-type">int</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> current + releases;
                <span class="hljs-keyword">if</span> (next &lt; current)  <span class="hljs-comment">// 溢出检查</span>
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Maximum permit count exceeded"</span>);
                <span class="hljs-keyword">if</span> (compareAndSetState(current, next))
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
        }
    }

    <span class="hljs-comment">// 非公平版本</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NonfairSync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Sync</span> {
        NonfairSync(<span class="hljs-type">int</span> <span class="hljs-keyword">permits</span>) {
            <span class="hljs-built_in">super</span>(<span class="hljs-keyword">permits</span>);
        }

        <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">tryAcquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
            <span class="hljs-keyword">return</span> nonfairTryAcquireShared(acquires);
        }
    }

    <span class="hljs-comment">// 公平版本</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FairSync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Sync</span> {
        FairSync(<span class="hljs-type">int</span> <span class="hljs-keyword">permits</span>) {
            <span class="hljs-built_in">super</span>(<span class="hljs-keyword">permits</span>);
        }

        <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">tryAcquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
            <span class="hljs-keyword">for</span> (;;) {
                <span class="hljs-comment">// 公平性:检查队列中是否有等待线程</span>
                <span class="hljs-keyword">if</span> (hasQueuedPredecessors())
                    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;

                <span class="hljs-type">int</span> <span class="hljs-variable">available</span> <span class="hljs-operator">=</span> getState();
                <span class="hljs-type">int</span> <span class="hljs-variable">remaining</span> <span class="hljs-operator">=</span> available - acquires;
                <span class="hljs-keyword">if</span> (remaining &lt; <span class="hljs-number">0</span> ||
                    compareAndSetState(available, remaining))
                    <span class="hljs-keyword">return</span> remaining;
            }
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Semaphore</span><span class="hljs-params">(<span class="hljs-type">int</span> <span class="hljs-keyword">permits</span>, <span class="hljs-type">boolean</span> fair)</span> {
        sync = fair ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">FairSync</span>(<span class="hljs-keyword">permits</span>) : <span class="hljs-keyword">new</span> <span class="hljs-title class_">NonfairSync</span>(<span class="hljs-keyword">permits</span>);
    }

    <span class="hljs-comment">// 获取许可</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquire</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
        sync.acquireSharedInterruptibly(<span class="hljs-number">1</span>);
    }

    <span class="hljs-comment">// 释放许可</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">release</span><span class="hljs-params">()</span> {
        sync.releaseShared(<span class="hljs-number">1</span>);
    }
}
</code></pre>
<p><strong>应用场景:</strong></p>
<ul>
<li>限流(控制并发访问数)</li>
<li>资源池(数据库连接池、线程池)</li>
</ul>
<h4 data-id="heading-23">2.4.4 ReadWriteLock - 读写锁</h4>
<p><strong>实现原理(state的位运算):</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> {
    <span class="hljs-comment">// state的位划分</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SHARED_SHIFT</span>   <span class="hljs-operator">=</span> <span class="hljs-number">16</span>;
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SHARED_UNIT</span>    <span class="hljs-operator">=</span> (<span class="hljs-number">1</span> &lt;&lt; SHARED_SHIFT);  <span class="hljs-comment">// 65536</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_COUNT</span>      <span class="hljs-operator">=</span> (<span class="hljs-number">1</span> &lt;&lt; SHARED_SHIFT) - <span class="hljs-number">1</span>;  <span class="hljs-comment">// 65535</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">EXCLUSIVE_MASK</span> <span class="hljs-operator">=</span> (<span class="hljs-number">1</span> &lt;&lt; SHARED_SHIFT) - <span class="hljs-number">1</span>;  <span class="hljs-comment">// 低16位掩码</span>

    <span class="hljs-comment">// 读锁计数(高16位)</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">sharedCount</span><span class="hljs-params">(<span class="hljs-type">int</span> c)</span>    { <span class="hljs-keyword">return</span> c &gt;&gt;&gt; SHARED_SHIFT; }

    <span class="hljs-comment">// 写锁计数(低16位)</span>
    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">exclusiveCount</span><span class="hljs-params">(<span class="hljs-type">int</span> c)</span> { <span class="hljs-keyword">return</span> c &amp; EXCLUSIVE_MASK; }

    <span class="hljs-comment">// 获取写锁</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
        <span class="hljs-type">Thread</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> Thread.currentThread();
        <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> getState();
        <span class="hljs-type">int</span> <span class="hljs-variable">w</span> <span class="hljs-operator">=</span> exclusiveCount(c);  <span class="hljs-comment">// 写锁数</span>

        <span class="hljs-keyword">if</span> (c != <span class="hljs-number">0</span>) {
            <span class="hljs-comment">// state!=0,存在读锁或写锁</span>
            <span class="hljs-keyword">if</span> (w == <span class="hljs-number">0</span> || current != getExclusiveOwnerThread())
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// 存在读锁或其他线程持有写锁</span>

            <span class="hljs-keyword">if</span> (w + exclusiveCount(acquires) &gt; MAX_COUNT)
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Maximum lock count exceeded"</span>);

            setState(c + acquires);  <span class="hljs-comment">// 重入</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }

        <span class="hljs-keyword">if</span> (writerShouldBlock() ||
            !compareAndSetState(c, c + acquires))
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

        setExclusiveOwnerThread(current);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-comment">// 获取读锁</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">tryAcquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
        <span class="hljs-type">Thread</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> Thread.currentThread();
        <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> getState();

        <span class="hljs-comment">// 存在写锁且不是当前线程持有</span>
        <span class="hljs-keyword">if</span> (exclusiveCount(c) != <span class="hljs-number">0</span> &amp;&amp;
            getExclusiveOwnerThread() != current)
            <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;

        <span class="hljs-type">int</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> sharedCount(c);
        <span class="hljs-keyword">if</span> (!readerShouldBlock() &amp;&amp;
            r &lt; MAX_COUNT &amp;&amp;
            compareAndSetState(c, c + SHARED_UNIT)) {  <span class="hljs-comment">// 高16位+1</span>

            <span class="hljs-keyword">if</span> (r == <span class="hljs-number">0</span>) {
                firstReader = current;
                firstReaderHoldCount = <span class="hljs-number">1</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (firstReader == current) {
                firstReaderHoldCount++;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 使用ThreadLocal记录每个线程的读锁重入次数</span>
                <span class="hljs-type">HoldCounter</span> <span class="hljs-variable">rh</span> <span class="hljs-operator">=</span> cachedHoldCounter;
                <span class="hljs-keyword">if</span> (rh == <span class="hljs-literal">null</span> || rh.tid != getThreadId(current))
                    cachedHoldCounter = rh = readHolds.get();
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rh.count == <span class="hljs-number">0</span>)
                    readHolds.set(rh);
                rh.count++;
            }
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        }

        <span class="hljs-keyword">return</span> fullTryAcquireShared(current);
    }
}
</code></pre>
<p><strong>锁降级机制:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 正确的锁降级示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CachedData</span> {
    Object data;
    <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> cacheValid;
    <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantReadWriteLock</span> <span class="hljs-variable">rwl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantReadWriteLock</span>();

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">processCachedData</span><span class="hljs-params">()</span> {
        rwl.readLock().lock();
        <span class="hljs-keyword">if</span> (!cacheValid) {
            <span class="hljs-comment">// 需要更新缓存</span>
            rwl.readLock().unlock();  <span class="hljs-comment">// ①释放读锁</span>
            rwl.writeLock().lock();   <span class="hljs-comment">// ②获取写锁</span>
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 再次检查(其他线程可能已更新)</span>
                <span class="hljs-keyword">if</span> (!cacheValid) {
                    data = loadData();
                    cacheValid = <span class="hljs-literal">true</span>;
                }

                <span class="hljs-comment">// ③锁降级:在持有写锁的情况下获取读锁</span>
                rwl.readLock().lock();
            } <span class="hljs-keyword">finally</span> {
                rwl.writeLock().unlock();  <span class="hljs-comment">// ④释放写锁</span>
            }
        }

        <span class="hljs-keyword">try</span> {
            use(data);
        } <span class="hljs-keyword">finally</span> {
            rwl.readLock().unlock();  <span class="hljs-comment">// ⑤释放读锁</span>
        }
    }
}
</code></pre>
<p><strong>为什么没有锁升级?</strong></p>
<p>锁升级(读锁→写锁)会导致死锁:</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">线程A: 持有读锁 → 想升级为写锁 → 等待其他读锁释放</span>
<span class="hljs-section">线程B: 持有读锁 → 想升级为写锁 → 等待其他读锁释放</span>
→ 死锁!
</code></pre>
<p>锁降级(写锁→读锁)是安全的:</p>
<pre><code class="hljs language-css" lang="css">线程<span class="hljs-selector-tag">A</span>: 持有写锁 → 获取读锁 → 释放写锁
此时无其他线程持有任何锁,不会死锁
</code></pre>
<hr/>
<h2 data-id="heading-24">三、实战场景应用</h2>
<h3 data-id="heading-25">3.1 场景1: 分布式任务协调中的CountDownLatch应用</h3>
<h4 data-id="heading-26">业务背景</h4>
<p>电商平台需要批量导入订单数据,每批次1000个订单。为提高效率,采用多线程并行导入:</p>
<ul>
<li>将1000个订单分成10组,每组100个</li>
<li>10个线程并行导入</li>
<li>主线程需要等待所有子线程完成后,汇总导入结果并发送通知</li>
</ul>
<h4 data-id="heading-27">方案设计</h4>
<p>使用<code>CountDownLatch</code>实现主线程等待:</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f84c1a6010c43e2a08482a69cb32605~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Sh6YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766817638&amp;x-signature=nGYvSUPm%2FybNvRl3WTHIMhuUlF0%3D" alt="countdownlatch-scenario.svg" loading="lazy"/></p>
<h4 data-id="heading-28">完整代码实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 订单批量导入服务
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderBatchImportService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderRepository orderRepository;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> NotificationService notificationService;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);

    <span class="hljs-comment">/**
     * 批量导入订单
     * <span class="hljs-doctag">@param</span> orders 待导入订单列表
     * <span class="hljs-doctag">@return</span> 导入结果统计
     */</span>
    <span class="hljs-keyword">public</span> ImportResult <span class="hljs-title function_">batchImport</span><span class="hljs-params">(List&lt;OrderDTO&gt; orders)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">batchSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">totalBatches</span> <span class="hljs-operator">=</span> (orders.size() + batchSize - <span class="hljs-number">1</span>) / batchSize;

        <span class="hljs-comment">// ①创建CountDownLatch</span>
        <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(totalBatches);

        <span class="hljs-comment">// 结果收集器(线程安全)</span>
        ConcurrentHashMap&lt;String, AtomicInteger&gt; resultMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
        resultMap.put(<span class="hljs-string">"success"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>));
        resultMap.put(<span class="hljs-string">"failed"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>));

        log.info(<span class="hljs-string">"开始批量导入订单,总数:{},分{}批"</span>, orders.size(), totalBatches);

        <span class="hljs-comment">// ②提交子任务</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; totalBatches; i++) {
            <span class="hljs-type">int</span> <span class="hljs-variable">fromIndex</span> <span class="hljs-operator">=</span> i * batchSize;
            <span class="hljs-type">int</span> <span class="hljs-variable">toIndex</span> <span class="hljs-operator">=</span> Math.min(fromIndex + batchSize, orders.size());
            List&lt;OrderDTO&gt; batch = orders.subList(fromIndex, toIndex);

            executor.submit(() -&gt; {
                <span class="hljs-keyword">try</span> {
                    importBatch(batch, resultMap);
                } <span class="hljs-keyword">catch</span> (Exception e) {
                    log.error(<span class="hljs-string">"批次导入失败"</span>, e);
                    resultMap.get(<span class="hljs-string">"failed"</span>).addAndGet(batch.size());
                } <span class="hljs-keyword">finally</span> {
                    latch.countDown();  <span class="hljs-comment">// ③完成后countDown</span>
                    log.info(<span class="hljs-string">"批次完成,剩余批次:{}"</span>, latch.getCount());
                }
            });
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// ④主线程等待所有子线程完成(超时30秒)</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">finished</span> <span class="hljs-operator">=</span> latch.await(<span class="hljs-number">30</span>, TimeUnit.SECONDS);

            <span class="hljs-keyword">if</span> (!finished) {
                log.error(<span class="hljs-string">"批量导入超时,已完成批次:{}"</span>, totalBatches - latch.getCount());
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"批量导入超时"</span>);
            }

            <span class="hljs-comment">// ⑤汇总结果</span>
            <span class="hljs-type">ImportResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ImportResult</span>();
            result.setTotalCount(orders.size());
            result.setSuccessCount(resultMap.get(<span class="hljs-string">"success"</span>).get());
            result.setFailedCount(resultMap.get(<span class="hljs-string">"failed"</span>).get());

            log.info(<span class="hljs-string">"批量导入完成:{}"</span>, result);

            <span class="hljs-comment">// ⑥发送通知</span>
            notificationService.sendImportResult(result);

            <span class="hljs-keyword">return</span> result;

        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"批量导入被中断"</span>, e);
        }
    }

    <span class="hljs-comment">/**
     * 导入单个批次
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">importBatch</span><span class="hljs-params">(List&lt;OrderDTO&gt; batch,
                           ConcurrentHashMap&lt;String, AtomicInteger&gt; resultMap)</span> {
        <span class="hljs-keyword">for</span> (OrderDTO orderDTO : batch) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> convertToEntity(orderDTO);
                orderRepository.save(order);
                resultMap.get(<span class="hljs-string">"success"</span>).incrementAndGet();
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.error(<span class="hljs-string">"订单导入失败,orderId:{}"</span>, orderDTO.getOrderId(), e);
                resultMap.get(<span class="hljs-string">"failed"</span>).incrementAndGet();
            }
        }
    }

    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ImportResult</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> totalCount;
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> successCount;
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> failedCount;

        <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getSuccessRate</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> totalCount == <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : (<span class="hljs-type">double</span>) successCount / totalCount * <span class="hljs-number">100</span>;
        }
    }
}
</code></pre>
<h4 data-id="heading-29">错误处理:子任务异常的兜底方案</h4>
<p><strong>问题:</strong> 如果子任务抛出异常未捕获,可能导致<code>countDown()</code>未执行,主线程永久阻塞。</p>
<p><strong>解决方案:</strong></p>
<pre><code class="hljs language-java" lang="java">executor.submit(() -&gt; {
    <span class="hljs-keyword">try</span> {
        importBatch(batch, resultMap);
    } <span class="hljs-keyword">catch</span> (Exception e) {
        log.error(<span class="hljs-string">"批次导入失败"</span>, e);
        resultMap.get(<span class="hljs-string">"failed"</span>).addAndGet(batch.size());
    } <span class="hljs-keyword">finally</span> {
        latch.countDown();  <span class="hljs-comment">// finally确保一定执行</span>
    }
});
</code></pre>
<h4 data-id="heading-30">超时控制</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 带超时的await</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">finished</span> <span class="hljs-operator">=</span> latch.await(<span class="hljs-number">30</span>, TimeUnit.SECONDS);

<span class="hljs-keyword">if</span> (!finished) {
    <span class="hljs-comment">// 超时处理</span>
    log.error(<span class="hljs-string">"部分任务未完成,已完成:{}/{}"</span>,
             totalBatches - latch.getCount(), totalBatches);

    <span class="hljs-comment">// 取消未完成的任务</span>
    executor.shutdownNow();

    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"批量导入超时"</span>);
}
</code></pre>
<h3 data-id="heading-31">3.2 场景2: 使用Semaphore限流</h3>
<h4 data-id="heading-32">业务背景</h4>
<p>电商平台需要限制数据库连接池的并发访问数量:</p>
<ul>
<li>数据库最大连接数20</li>
<li>应用服务器有100个工作线程</li>
<li>需要控制同时访问数据库的线程数≤20</li>
</ul>
<h4 data-id="heading-33">方案设计</h4>
<p>使用<code>Semaphore(20)</code>限制并发:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 基于Semaphore的数据库连接池
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseConnectionPool</span> {

    <span class="hljs-comment">// 实际连接池</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BlockingQueue&lt;Connection&gt; connections;

    <span class="hljs-comment">// 信号量控制并发数</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Semaphore semaphore;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String jdbcUrl;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String username;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String password;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DatabaseConnectionPool</span><span class="hljs-params">(String jdbcUrl, String username, String password,
                                 <span class="hljs-type">int</span> maxConnections, <span class="hljs-type">boolean</span> fair)</span> {
        <span class="hljs-built_in">this</span>.jdbcUrl = jdbcUrl;
        <span class="hljs-built_in">this</span>.username = username;
        <span class="hljs-built_in">this</span>.password = password;
        <span class="hljs-built_in">this</span>.connections = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(maxConnections);
        <span class="hljs-built_in">this</span>.semaphore = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Semaphore</span>(maxConnections, fair);  <span class="hljs-comment">// 公平/非公平可选</span>

        <span class="hljs-comment">// 初始化连接</span>
        initConnections(maxConnections);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initConnections</span><span class="hljs-params">(<span class="hljs-type">int</span> count)</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; count; i++) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> DriverManager.getConnection(jdbcUrl, username, password);
                connections.offer(conn);
            } <span class="hljs-keyword">catch</span> (SQLException e) {
                log.error(<span class="hljs-string">"初始化连接失败"</span>, e);
            }
        }
        log.info(<span class="hljs-string">"数据库连接池初始化完成,连接数:{}"</span>, connections.size());
    }

    <span class="hljs-comment">/**
     * 获取连接(阻塞等待)
     */</span>
    <span class="hljs-keyword">public</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
        <span class="hljs-comment">// ①获取许可</span>
        semaphore.acquire();

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// ②从池中取连接</span>
            <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> connections.poll(<span class="hljs-number">10</span>, TimeUnit.SECONDS);
            <span class="hljs-keyword">if</span> (conn == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"获取连接超时"</span>);
            }

            log.debug(<span class="hljs-string">"获取连接成功,剩余许可:{}"</span>, semaphore.availablePermits());
            <span class="hljs-keyword">return</span> conn;

        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 异常时需要释放许可</span>
            semaphore.release();
            <span class="hljs-keyword">throw</span> e;
        }
    }

    <span class="hljs-comment">/**
     * 获取连接(超时等待)
     */</span>
    <span class="hljs-keyword">public</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">(<span class="hljs-type">long</span> timeout, TimeUnit unit)</span>
            <span class="hljs-keyword">throws</span> InterruptedException, TimeoutException {

        <span class="hljs-comment">// ①尝试获取许可(超时)</span>
        <span class="hljs-keyword">if</span> (!semaphore.tryAcquire(timeout, unit)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TimeoutException</span>(<span class="hljs-string">"获取连接超时,等待时间:"</span> + timeout + unit);
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> connections.poll(timeout, unit);
            <span class="hljs-keyword">if</span> (conn == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TimeoutException</span>(<span class="hljs-string">"连接池为空"</span>);
            }
            <span class="hljs-keyword">return</span> conn;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            semaphore.release();
            <span class="hljs-keyword">throw</span> e;
        }
    }

    <span class="hljs-comment">/**
     * 释放连接
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">releaseConnection</span><span class="hljs-params">(Connection conn)</span> {
        <span class="hljs-keyword">if</span> (conn != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// ①归还连接到池</span>
                <span class="hljs-keyword">if</span> (!connections.offer(conn, <span class="hljs-number">5</span>, TimeUnit.SECONDS)) {
                    log.error(<span class="hljs-string">"归还连接失败,连接池已满"</span>);
                    conn.close();  <span class="hljs-comment">// 关闭连接</span>
                }
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.error(<span class="hljs-string">"归还连接异常"</span>, e);
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-comment">// ②释放许可(必须执行)</span>
                semaphore.release();
                log.debug(<span class="hljs-string">"释放连接,剩余许可:{}"</span>, semaphore.availablePermits());
            }
        }
    }

    <span class="hljs-comment">/**
     * 获取连接池状态
     */</span>
    <span class="hljs-keyword">public</span> PoolStats <span class="hljs-title function_">getStats</span><span class="hljs-params">()</span> {
        <span class="hljs-type">PoolStats</span> <span class="hljs-variable">stats</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PoolStats</span>();
        stats.setMaxConnections(semaphore.availablePermits() + semaphore.getQueueLength());
        stats.setAvailableConnections(semaphore.availablePermits());
        stats.setWaitingThreads(semaphore.getQueueLength());
        stats.setActiveConnections(stats.getMaxConnections() - stats.getAvailableConnections());
        <span class="hljs-keyword">return</span> stats;
    }

    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PoolStats</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> maxConnections;
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> availableConnections;
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> activeConnections;
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> waitingThreads;
    }
}
</code></pre>
<h4 data-id="heading-34">使用示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> DatabaseConnectionPool connectionPool;

    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">queryOrder</span><span class="hljs-params">(Long orderId)</span> {
        <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 获取连接(最多等待3秒)</span>
            conn = connectionPool.getConnection(<span class="hljs-number">3</span>, TimeUnit.SECONDS);

            <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">ps</span> <span class="hljs-operator">=</span> conn.prepareStatement(
                <span class="hljs-string">"SELECT * FROM t_order WHERE id = ?"</span>);
            ps.setLong(<span class="hljs-number">1</span>, orderId);

            <span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> ps.executeQuery();
            <span class="hljs-keyword">if</span> (rs.next()) {
                <span class="hljs-keyword">return</span> mapToOrder(rs);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

        } <span class="hljs-keyword">catch</span> (TimeoutException e) {
            log.error(<span class="hljs-string">"获取数据库连接超时,orderId:{}"</span>, orderId);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"系统繁忙,请稍后重试"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"查询订单失败,orderId:{}"</span>, orderId, e);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"查询失败"</span>, e);
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 必须释放连接</span>
            connectionPool.releaseConnection(conn);
        }
    }
}
</code></pre>
<h4 data-id="heading-35">公平与非公平的选择</h4>
<p><strong>非公平模式(默认):</strong></p>
<ul>
<li>新到达的线程可能直接获取许可,无需排队</li>
<li>吞吐量高,但可能导致饥饿</li>
</ul>
<p><strong>公平模式:</strong></p>
<ul>
<li>严格按照FIFO顺序分配许可</li>
<li>避免饥饿,但性能稍差</li>
</ul>
<p><strong>性能测试对比:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@BenchmarkMode(Mode.Throughput)</span>
<span class="hljs-meta">@State(Scope.Benchmark)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SemaphoreBenchmark</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-type">Semaphore</span> <span class="hljs-variable">fairSemaphore</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Semaphore</span>(<span class="hljs-number">20</span>, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">private</span> <span class="hljs-type">Semaphore</span> <span class="hljs-variable">unfairSemaphore</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Semaphore</span>(<span class="hljs-number">20</span>, <span class="hljs-literal">false</span>);

    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-meta">@Threads(100)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testFair</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
        fairSemaphore.acquire();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 模拟业务操作</span>
            Thread.sleep(<span class="hljs-number">1</span>);
        } <span class="hljs-keyword">finally</span> {
            fairSemaphore.release();
        }
    }

    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-meta">@Threads(100)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testUnfair</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
        unfairSemaphore.acquire();
        <span class="hljs-keyword">try</span> {
            Thread.sleep(<span class="hljs-number">1</span>);
        } <span class="hljs-keyword">finally</span> {
            unfairSemaphore.release();
        }
    }
}

<span class="hljs-comment">// 结果(ops/s):</span>
<span class="hljs-comment">// testFair:    12000</span>
<span class="hljs-comment">// testUnfair:  18000  (提升50%)</span>
</code></pre>
<p><strong>选择建议:</strong></p>
<ul>
<li>高吞吐场景 → 非公平模式</li>
<li>需要避免饥饿 → 公平模式</li>
</ul>
<h3 data-id="heading-36">3.3 场景3: 使用ReadWriteLock优化缓存</h3>
<h4 data-id="heading-37">业务背景</h4>
<p>电商平台的商品服务需要缓存热门商品信息:</p>
<ul>
<li>缓存读操作占99%,写操作占1%</li>
<li>使用<code>synchronized</code>导致读操作也串行化,性能瓶颈明显</li>
</ul>
<h4 data-id="heading-38">使用synchronized的性能问题</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 基于synchronized的缓存(性能差)
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductCacheSynchronized</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Long, ProductDTO&gt; cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

    <span class="hljs-comment">// 读操作也需要加锁,导致串行化</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> ProductDTO <span class="hljs-title function_">get</span><span class="hljs-params">(Long productId)</span> {
        <span class="hljs-keyword">return</span> cache.get(productId);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(Long productId, ProductDTO product)</span> {
        cache.put(productId, product);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">remove</span><span class="hljs-params">(Long productId)</span> {
        cache.remove(productId);
    }
}
</code></pre>
<p><strong>性能问题:</strong></p>
<ul>
<li>读操作占99%,但也需要获取独占锁</li>
<li>100个线程同时读取,也会串行执行</li>
<li>吞吐量严重受限</li>
</ul>
<h4 data-id="heading-39">ReadWriteLock改造</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 基于ReadWriteLock的缓存(性能优)
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductCacheReadWriteLock</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Long, ProductDTO&gt; cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ReadWriteLock</span> <span class="hljs-variable">rwLock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantReadWriteLock</span>();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Lock</span> <span class="hljs-variable">readLock</span> <span class="hljs-operator">=</span> rwLock.readLock();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Lock</span> <span class="hljs-variable">writeLock</span> <span class="hljs-operator">=</span> rwLock.writeLock();

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ProductRepository productRepository;

    <span class="hljs-comment">/**
     * 读取缓存(多线程并发读)
     */</span>
    <span class="hljs-keyword">public</span> ProductDTO <span class="hljs-title function_">get</span><span class="hljs-params">(Long productId)</span> {
        readLock.lock();  <span class="hljs-comment">// 读锁</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">ProductDTO</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> cache.get(productId);
            <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) {
                log.debug(<span class="hljs-string">"缓存命中,productId:{}"</span>, productId);
                <span class="hljs-keyword">return</span> product;
            }
        } <span class="hljs-keyword">finally</span> {
            readLock.unlock();
        }

        <span class="hljs-comment">// 缓存未命中,需要从数据库加载</span>
        <span class="hljs-keyword">return</span> loadFromDB(productId);
    }

    <span class="hljs-comment">/**
     * 从数据库加载并更新缓存(锁降级)
     */</span>
    <span class="hljs-keyword">private</span> ProductDTO <span class="hljs-title function_">loadFromDB</span><span class="hljs-params">(Long productId)</span> {
        writeLock.lock();  <span class="hljs-comment">// ①获取写锁</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// ②双重检查(其他线程可能已加载)</span>
            <span class="hljs-type">ProductDTO</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> cache.get(productId);
            <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> product;
            }

            <span class="hljs-comment">// ③从数据库加载</span>
            log.info(<span class="hljs-string">"从数据库加载商品,productId:{}"</span>, productId);
            product = productRepository.findById(productId);

            <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) {
                cache.put(productId, product);
            }

            <span class="hljs-keyword">return</span> product;

        } <span class="hljs-keyword">finally</span> {
            writeLock.unlock();
        }
    }

    <span class="hljs-comment">/**
     * 更新缓存(独占写)
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(Long productId, ProductDTO product)</span> {
        writeLock.lock();
        <span class="hljs-keyword">try</span> {
            cache.put(productId, product);
            log.info(<span class="hljs-string">"更新缓存,productId:{}"</span>, productId);
        } <span class="hljs-keyword">finally</span> {
            writeLock.unlock();
        }
    }

    <span class="hljs-comment">/**
     * 删除缓存
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">remove</span><span class="hljs-params">(Long productId)</span> {
        writeLock.lock();
        <span class="hljs-keyword">try</span> {
            cache.remove(productId);
            log.info(<span class="hljs-string">"删除缓存,productId:{}"</span>, productId);
        } <span class="hljs-keyword">finally</span> {
            writeLock.unlock();
        }
    }

    <span class="hljs-comment">/**
     * 批量预热缓存(锁降级示例)
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">warmUp</span><span class="hljs-params">(List&lt;Long&gt; productIds)</span> {
        writeLock.lock();  <span class="hljs-comment">// ①获取写锁</span>
        <span class="hljs-keyword">try</span> {
            log.info(<span class="hljs-string">"开始预热缓存,商品数:{}"</span>, productIds.size());

            List&lt;ProductDTO&gt; products = productRepository.findByIds(productIds);
            <span class="hljs-keyword">for</span> (ProductDTO product : products) {
                cache.put(product.getProductId(), product);
            }

            <span class="hljs-comment">// ②锁降级:获取读锁</span>
            readLock.lock();

        } <span class="hljs-keyword">finally</span> {
            writeLock.unlock();  <span class="hljs-comment">// ③释放写锁</span>
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// ④持有读锁,允许其他线程并发读取</span>
            log.info(<span class="hljs-string">"缓存预热完成,当前缓存数:{}"</span>, cache.size());
        } <span class="hljs-keyword">finally</span> {
            readLock.unlock();  <span class="hljs-comment">// ⑤释放读锁</span>
        }
    }

    <span class="hljs-comment">/**
     * 获取缓存统计
     */</span>
    <span class="hljs-keyword">public</span> CacheStats <span class="hljs-title function_">getStats</span><span class="hljs-params">()</span> {
        readLock.lock();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">CacheStats</span> <span class="hljs-variable">stats</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheStats</span>();
            stats.setCacheSize(cache.size());
            <span class="hljs-keyword">return</span> stats;
        } <span class="hljs-keyword">finally</span> {
            readLock.unlock();
        }
    }

    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheStats</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> cacheSize;
    }
}
</code></pre>
<h4 data-id="heading-40">性能提升数据对比</h4>
<p><strong>测试代码:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@BenchmarkMode(Mode.Throughput)</span>
<span class="hljs-meta">@Warmup(iterations = 3)</span>
<span class="hljs-meta">@Measurement(iterations = 5)</span>
<span class="hljs-meta">@State(Scope.Benchmark)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheBenchmark</span> {

    <span class="hljs-keyword">private</span> ProductCacheSynchronized syncCache;
    <span class="hljs-keyword">private</span> ProductCacheReadWriteLock rwCache;

    <span class="hljs-meta">@Setup</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setup</span><span class="hljs-params">()</span> {
        syncCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductCacheSynchronized</span>();
        rwCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductCacheReadWriteLock</span>();

        <span class="hljs-comment">// 预热缓存</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">long</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">1000</span>; i++) {
            <span class="hljs-type">ProductDTO</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductDTO</span>();
            product.setProductId(i);
            product.setProductName(<span class="hljs-string">"商品"</span> + i);

            syncCache.put(i, product);
            rwCache.put(i, product);
        }
    }

    <span class="hljs-comment">// 读多写少场景(99%读,1%写)</span>
    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-meta">@Threads(100)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSynchronizedRead</span><span class="hljs-params">()</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">productId</span> <span class="hljs-operator">=</span> ThreadLocalRandom.current().nextLong(<span class="hljs-number">1</span>, <span class="hljs-number">1001</span>);

        <span class="hljs-keyword">if</span> (ThreadLocalRandom.current().nextInt(<span class="hljs-number">100</span>) &lt; <span class="hljs-number">99</span>) {
            <span class="hljs-comment">// 99%读操作</span>
            syncCache.get(productId);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 1%写操作</span>
            <span class="hljs-type">ProductDTO</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductDTO</span>();
            product.setProductId(productId);
            syncCache.put(productId, product);
        }
    }

    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-meta">@Threads(100)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testReadWriteLockRead</span><span class="hljs-params">()</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">productId</span> <span class="hljs-operator">=</span> ThreadLocalRandom.current().nextLong(<span class="hljs-number">1</span>, <span class="hljs-number">1001</span>);

        <span class="hljs-keyword">if</span> (ThreadLocalRandom.current().nextInt(<span class="hljs-number">100</span>) &lt; <span class="hljs-number">99</span>) {
            rwCache.get(productId);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-type">ProductDTO</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductDTO</span>();
            product.setProductId(productId);
            rwCache.put(productId, product);
        }
    }
}
</code></pre>
<p><strong>测试结果(JDK 17, ops/s):</strong></p>



































<table><thead><tr><th>并发线程数</th><th>synchronized</th><th>ReadWriteLock</th><th>提升倍数</th></tr></thead><tbody><tr><td>10</td><td>850K</td><td>2.1M</td><td>2.5x</td></tr><tr><td>50</td><td>420K</td><td>3.8M</td><td>9.0x</td></tr><tr><td>100</td><td>280K</td><td>4.2M</td><td>15.0x</td></tr><tr><td>200</td><td>190K</td><td>4.5M</td><td>23.7x</td></tr></tbody></table>
<p><strong>结论:</strong></p>
<ul>
<li>读多写少场景下,ReadWriteLock性能提升显著</li>
<li>并发度越高,性能优势越明显</li>
<li>100线程时性能提升<strong>15倍</strong></li>
</ul>
<hr/>
<h2 data-id="heading-41">四、生产案例与故障排查</h2>
<h3 data-id="heading-42">4.1 案例1: AQS在高并发场景的应用</h3>
<h4 data-id="heading-43">业务场景:秒杀系统库存扣减</h4>
<p>电商平台秒杀活动,需要保证:</p>
<ul>
<li>库存扣减的原子性(不能超卖)</li>
<li>高并发(QPS 10000+)</li>
<li>低延迟(P99 &lt; 50ms)</li>
</ul>
<h4 data-id="heading-44">为什么不用synchronized?</h4>
<p><strong>synchronized的问题:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用synchronized的库存扣减</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">deductStock</span><span class="hljs-params">(Long skuId, <span class="hljs-type">int</span> quantity)</span> {
    <span class="hljs-type">Integer</span> <span class="hljs-variable">stock</span> <span class="hljs-operator">=</span> stockMap.get(skuId);
    <span class="hljs-keyword">if</span> (stock == <span class="hljs-literal">null</span> || stock &lt; quantity) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// 库存不足</span>
    }

    stockMap.put(skuId, stock - quantity);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p><strong>性能瓶颈:</strong></p>
<ul>
<li>锁粒度太粗: 所有SKU共用一把锁</li>
<li>SKU A的扣减会阻塞SKU B的扣减</li>
<li>高并发下吞吐量受限</li>
</ul>
<h4 data-id="heading-45">技术方案:分段锁 + ReentrantLock</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 高性能库存扣减服务
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StockDeductionService</span> {

    <span class="hljs-comment">// SKU维度的分段锁(降低锁竞争)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;Long, ReentrantLock&gt; skuLocks = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-comment">// 库存缓存(Caffeine本地缓存 + Redis分布式缓存)</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> Cache&lt;Long, Integer&gt; localCache;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, Integer&gt; redisTemplate;

    <span class="hljs-comment">/**
     * 扣减库存
     * <span class="hljs-doctag">@param</span> skuId 商品SKU ID
     * <span class="hljs-doctag">@param</span> quantity 扣减数量
     * <span class="hljs-doctag">@return</span> 是否扣减成功
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">deductStock</span><span class="hljs-params">(Long skuId, <span class="hljs-type">int</span> quantity)</span> {
        <span class="hljs-comment">// ①获取SKU维度的锁(分段锁,降低竞争)</span>
        <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> skuLocks.computeIfAbsent(skuId,
            k -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>(<span class="hljs-literal">false</span>));  <span class="hljs-comment">// 非公平锁,性能优先</span>

        <span class="hljs-comment">// ②尝试获取锁(超时100ms)</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (!lock.tryLock(<span class="hljs-number">100</span>, TimeUnit.MILLISECONDS)) {
                log.warn(<span class="hljs-string">"获取库存锁超时,skuId:{}"</span>, skuId);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// ③先查本地缓存</span>
            <span class="hljs-type">Integer</span> <span class="hljs-variable">stock</span> <span class="hljs-operator">=</span> localCache.getIfPresent(skuId);

            <span class="hljs-keyword">if</span> (stock == <span class="hljs-literal">null</span>) {
                <span class="hljs-comment">// ④本地缓存未命中,查Redis</span>
                <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"stock:"</span> + skuId;
                stock = redisTemplate.opsForValue().get(redisKey);

                <span class="hljs-keyword">if</span> (stock == <span class="hljs-literal">null</span>) {
                    <span class="hljs-comment">// ⑤Redis也未命中,查数据库</span>
                    stock = loadStockFromDB(skuId);
                    <span class="hljs-keyword">if</span> (stock == <span class="hljs-literal">null</span>) {
                        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// 商品不存在</span>
                    }

                    <span class="hljs-comment">// 回写缓存</span>
                    redisTemplate.opsForValue().set(redisKey, stock, <span class="hljs-number">60</span>, TimeUnit.SECONDS);
                }

                <span class="hljs-comment">// 回写本地缓存</span>
                localCache.put(skuId, stock);
            }

            <span class="hljs-comment">// ⑥检查库存</span>
            <span class="hljs-keyword">if</span> (stock &lt; quantity) {
                log.warn(<span class="hljs-string">"库存不足,skuId:{},当前库存:{},扣减数量:{}"</span>,
                        skuId, stock, quantity);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }

            <span class="hljs-comment">// ⑦扣减库存(本地缓存 + Redis)</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">newStock</span> <span class="hljs-operator">=</span> stock - quantity;
            localCache.put(skuId, newStock);

            <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"stock:"</span> + skuId;
            redisTemplate.opsForValue().set(redisKey, newStock, <span class="hljs-number">60</span>, TimeUnit.SECONDS);

            <span class="hljs-comment">// ⑧异步更新数据库(MQ)</span>
            sendStockUpdateMessage(skuId, newStock);

            log.info(<span class="hljs-string">"库存扣减成功,skuId:{},扣减:{},剩余:{}"</span>, skuId, quantity, newStock);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// ⑨释放锁(必须在finally中)</span>
            lock.unlock();
        }
    }

    <span class="hljs-comment">/**
     * 从数据库加载库存
     */</span>
    <span class="hljs-keyword">private</span> Integer <span class="hljs-title function_">loadStockFromDB</span><span class="hljs-params">(Long skuId)</span> {
        <span class="hljs-comment">// 实际实现省略</span>
        <span class="hljs-keyword">return</span> <span class="hljs-number">1000</span>;
    }

    <span class="hljs-comment">/**
     * 异步更新数据库库存(通过MQ)
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendStockUpdateMessage</span><span class="hljs-params">(Long skuId, <span class="hljs-type">int</span> newStock)</span> {
        <span class="hljs-comment">// 发送MQ消息,异步更新数据库</span>
        <span class="hljs-comment">// 实际实现省略</span>
    }

    <span class="hljs-comment">/**
     * 定时清理空闲锁对象(防止内存泄漏)
     */</span>
    <span class="hljs-meta">@Scheduled(fixedRate = 60000)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cleanIdleLocks</span><span class="hljs-params">()</span> {
        skuLocks.entrySet().removeIf(entry -&gt; {
            <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> entry.getValue();
            <span class="hljs-comment">// 尝试获取锁,获取成功说明无人使用</span>
            <span class="hljs-keyword">if</span> (lock.tryLock()) {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 移除</span>
                } <span class="hljs-keyword">finally</span> {
                    lock.unlock();
                }
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// 保留</span>
        });

        log.info(<span class="hljs-string">"清理空闲锁完成,当前锁数量:{}"</span>, skuLocks.size());
    }
}
</code></pre>
<h4 data-id="heading-46">压测数据与优化过程</h4>
<p><strong>优化前(synchronized):</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">并发:1000</span>
<span class="hljs-section">QPS: 2800</span>
<span class="hljs-section">P99延迟: 350ms</span>
<span class="hljs-section">错误率: 15% (超时)</span>
</code></pre>
<p><strong>优化后(ReentrantLock分段锁):</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">并发:1000</span>
<span class="hljs-section">QPS: 12000  (提升4.3倍)</span>
<span class="hljs-section">P99延迟: 45ms  (降低87%)</span>
<span class="hljs-section">错误率: 0.1%</span>
</code></pre>
<p><strong>优化关键点:</strong></p>
<ol>
<li><strong>分段锁</strong>: 每个SKU独立锁,降低竞争</li>
<li><strong>非公平锁</strong>: 性能优先,避免线程切换</li>
<li><strong>超时机制</strong>: <code>tryLock(100ms)</code>,避免无限等待</li>
<li><strong>多级缓存</strong>: 本地缓存(Caffeine) + Redis,降低DB压力</li>
<li><strong>异步更新DB</strong>: 通过MQ异步,不阻塞主流程</li>
</ol>
<h3 data-id="heading-47">4.2 案例2: CountDownLatch超时未释放导致的线程泄漏</h3>
<h4 data-id="heading-48">故障现象</h4>
<p>生产环境发现线程池线程数持续增长,最终耗尽:</p>
<pre><code class="hljs language-arduino" lang="arduino">[ERROR] ThreadPoolExecutor: Worker creation failed
[WARN] ThreadPoolExecutor: Pool size: <span class="hljs-number">200</span>/<span class="hljs-number">200</span> (max)
</code></pre>
<h4 data-id="heading-49">问题分析</h4>
<p><strong>排查过程:</strong></p>
<ol>
<li><strong>线程dump分析</strong></li>
</ol>
<pre><code class="hljs language-bash" lang="bash">jstack &lt;pid&gt; &gt; thread_dump.txt
</code></pre>
<p>发现大量线程阻塞在<code>CountDownLatch.await()</code>:</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-string">"batch-import-1"</span> <span class="hljs-comment">#123 prio=5 os_prio=0 waiting on condition</span>
   java.lang.Thread.State: <span class="hljs-title function_ invoke__">WAITING</span> (parking)
        at sun.misc.Unsafe.<span class="hljs-title function_ invoke__">park</span>(Native Method)
        at java.util.concurrent.locks.LockSupport.<span class="hljs-title function_ invoke__">park</span>(LockSupport.<span class="hljs-attr">java</span>:<span class="hljs-number">175</span>)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt
        at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireSharedInterruptibly
        at java.util.concurrent.CountDownLatch.<span class="hljs-title function_ invoke__">await</span>(CountDownLatch.<span class="hljs-attr">java</span>:<span class="hljs-number">231</span>)
        at com.example.service.BatchService.<span class="hljs-title function_ invoke__">importData</span>(BatchService.<span class="hljs-attr">java</span>:<span class="hljs-number">45</span>)
</code></pre>
<p>2.  <strong>代码审查</strong></p>
<p>发现问题代码:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌错误代码</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchImport</span><span class="hljs-params">(List&lt;Data&gt; dataList)</span> {
    <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">10</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
        executor.submit(() -&gt; {
            processData(dataList.get(i));  <span class="hljs-comment">// 可能抛异常</span>
            latch.countDown();  <span class="hljs-comment">// 异常时未执行!</span>
        });
    }

    latch.await();  <span class="hljs-comment">// 永久阻塞!</span>
}
</code></pre>
<p><strong>根因:</strong></p>
<ul>
<li>子任务抛出异常时,<code>countDown()</code>未执行</li>
<li>主线程<code>await()</code>永久阻塞</li>
<li>线程池线程被占用,最终耗尽</li>
</ul>
<h4 data-id="heading-50">解决方案</h4>
<p><strong>方案1: finally块保证countDown</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✅正确代码</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchImport</span><span class="hljs-params">(List&lt;Data&gt; dataList)</span> {
    <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">10</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> i;
        executor.submit(() -&gt; {
            <span class="hljs-keyword">try</span> {
                processData(dataList.get(index));
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.error(<span class="hljs-string">"处理失败,index:{}"</span>, index, e);
            } <span class="hljs-keyword">finally</span> {
                latch.countDown();  <span class="hljs-comment">// 必定执行</span>
            }
        });
    }

    <span class="hljs-comment">// 增加超时保护</span>
    <span class="hljs-type">boolean</span> <span class="hljs-variable">finished</span> <span class="hljs-operator">=</span> latch.await(<span class="hljs-number">30</span>, TimeUnit.SECONDS);
    <span class="hljs-keyword">if</span> (!finished) {
        log.error(<span class="hljs-string">"批量处理超时"</span>);
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"批量处理超时"</span>);
    }
}
</code></pre>
<p><strong>方案2: 使用CompletableFuture(推荐)</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✅更优方案:使用CompletableFuture</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchImport</span><span class="hljs-params">(List&lt;Data&gt; dataList)</span> {
    <span class="hljs-comment">// 创建异步任务</span>
    List&lt;CompletableFuture&lt;Void&gt;&gt; futures = dataList.stream()
        .map(data -&gt; CompletableFuture.runAsync(() -&gt; {
            processData(data);
        }, executor))
        .collect(Collectors.toList());

    <span class="hljs-comment">// 等待所有任务完成(带超时)</span>
    <span class="hljs-keyword">try</span> {
        CompletableFuture.allOf(futures.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletableFuture</span>[<span class="hljs-number">0</span>]))
            .get(<span class="hljs-number">30</span>, TimeUnit.SECONDS);
        log.info(<span class="hljs-string">"批量处理完成"</span>);
    } <span class="hljs-keyword">catch</span> (TimeoutException e) {
        log.error(<span class="hljs-string">"批量处理超时"</span>);
        <span class="hljs-comment">// 取消未完成的任务</span>
        futures.forEach(f -&gt; f.cancel(<span class="hljs-literal">true</span>));
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"批量处理超时"</span>, e);
    } <span class="hljs-keyword">catch</span> (Exception e) {
        log.error(<span class="hljs-string">"批量处理失败"</span>, e);
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"批量处理失败"</span>, e);
    }
}
</code></pre>
<p><strong>CompletableFuture的优势:</strong></p>
<ul>
<li>✅ 异常自动传播,不会丢失</li>
<li>✅ 支持链式调用,代码更优雅</li>
<li>✅ 支持超时取消</li>
<li>✅ 支持组合多个异步任务</li>
</ul>
<h4 data-id="heading-51">改进方案对比</h4>

























<table><thead><tr><th>方案</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>CountDownLatch + finally</td><td>简单直接</td><td>异常处理复杂,需手动管理</td></tr><tr><td>CompletableFuture</td><td>异常自动处理,API丰富</td><td>学习成本稍高</td></tr><tr><td>CompletableFuture + 超时</td><td>完善的异常和超时处理</td><td>-</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-52">五、常见问题与避坑指南</h2>
<h3 data-id="heading-53">5.1 AQS的state字段为什么用volatile?</h3>
<p><strong>原因1: 保证可见性</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 线程A</span>
state = <span class="hljs-number">1</span>;  <span class="hljs-comment">// 释放锁</span>

<span class="hljs-comment">// 线程B</span>
<span class="hljs-keyword">if</span> (state == <span class="hljs-number">0</span>) {  <span class="hljs-comment">// 获取锁</span>
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>如果<code>state</code>不是<code>volatile</code>,线程B可能读取到旧值(缓存),导致:</p>
<ul>
<li>看到state=0(实际已被修改为1)</li>
<li>重复获取锁,破坏互斥性</li>
</ul>
<p><strong>原因2: 配合CAS保证原子性</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">compareAndSetState</span><span class="hljs-params">(<span class="hljs-type">int</span> expect, <span class="hljs-type">int</span> update)</span> {
    <span class="hljs-keyword">return</span> unsafe.compareAndSwapInt(<span class="hljs-built_in">this</span>, stateOffset, expect, update);
}
</code></pre>
<p>CAS操作本身是原子的,但需要<code>volatile</code>保证:</p>
<ul>
<li>读取最新值进行比较</li>
<li>修改后立即对其他线程可见</li>
</ul>
<p><strong>原因3: 禁止重排序</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 获取锁的典型流程</span>
<span class="hljs-keyword">if</span> (compareAndSetState(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)) {  <span class="hljs-comment">// ①CAS获取锁</span>
    setExclusiveOwnerThread(current);  <span class="hljs-comment">// ②设置持有线程</span>
    <span class="hljs-comment">// ③执行临界区代码</span>
}
</code></pre>
<p><code>volatile</code>的内存屏障保证:</p>
<ul>
<li>①②不会重排序到③之后</li>
<li>其他线程看到state=1时,必定也能看到owner线程的设置</li>
</ul>
<h3 data-id="heading-54">5.2 为什么需要CLH队列?直接自旋不行吗?</h3>
<p><strong>纯自旋的问题:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 纯自旋锁</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpinLock</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">AtomicBoolean</span> <span class="hljs-variable">locked</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicBoolean</span>(<span class="hljs-literal">false</span>);

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">while</span> (!locked.compareAndSet(<span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>)) {
            <span class="hljs-comment">// 不断自旋,浪费CPU</span>
        }
    }
}
</code></pre>
<p><strong>问题:</strong></p>
<ol>
<li><strong>CPU空转</strong>: 高竞争下,大量线程自旋,CPU利用率100%但无效</li>
<li><strong>不公平</strong>: 无法保证FIFO顺序,可能饥饿</li>
<li><strong>无法支持中断/超时</strong>: 自旋过程无法响应中断</li>
</ol>
<p><strong>CLH队列的优势:</strong></p>
<ol>
<li><strong>自旋+阻塞结合</strong>: 先自旋几次,失败后阻塞(park),避免CPU空转</li>
<li><strong>FIFO公平性</strong>: 队列天然保证先进先出</li>
<li><strong>支持中断/超时</strong>: <code>parkNanos</code>/<code>parkUntil</code>支持超时,<code>park</code>可被中断</li>
<li><strong>节点状态管理</strong>: <code>waitStatus</code>记录节点状态,优化唤醒流程</li>
</ol>
<h3 data-id="heading-55">5.3 CountDownLatch vs CyclicBarrier如何选择?</h3>
<p><strong>CountDownLatch场景:</strong></p>
<ul>
<li>✅ 一组线程等待另一组线程完成</li>
<li>✅ 一次性使用(无需重置)</li>
<li>✅ 等待者与执行者角色明确</li>
</ul>
<p><strong>示例:</strong> 主线程等待所有子线程完成</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">10</span>);

<span class="hljs-comment">// 主线程</span>
latch.await();

<span class="hljs-comment">// 子线程</span>
latch.countDown();
</code></pre>
<p><strong>CyclicBarrier场景:</strong></p>
<ul>
<li>✅ 多个线程相互等待</li>
<li>✅ 需要重复使用</li>
<li>✅ 到达屏障点后执行共同动作</li>
</ul>
<p><strong>示例:</strong> 多线程计算,每轮同步</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">CyclicBarrier</span> <span class="hljs-variable">barrier</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CyclicBarrier</span>(<span class="hljs-number">3</span>, () -&gt; {
    System.out.println(<span class="hljs-string">"一轮计算完成"</span>);
});

<span class="hljs-comment">// 每个线程</span>
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">round</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; round &lt; <span class="hljs-number">10</span>; round++) {
    compute(round);
    barrier.await();  <span class="hljs-comment">// 等待其他线程</span>
}
</code></pre>
<p><strong>决策表:</strong></p>






























<table><thead><tr><th>需求</th><th>CountDownLatch</th><th>CyclicBarrier</th></tr></thead><tbody><tr><td>重复使用</td><td>❌</td><td>✅</td></tr><tr><td>角色分离(等待者vs执行者)</td><td>✅</td><td>❌</td></tr><tr><td>屏障动作</td><td>❌</td><td>✅</td></tr><tr><td>底层实现</td><td>AQS</td><td>ReentrantLock</td></tr></tbody></table>
<h3 data-id="heading-56">5.4 ReentrantLock为什么推荐在finally中unlock?</h3>
<p><strong>错误示例:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌错误:unlock不在finally中</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transfer</span><span class="hljs-params">(Account from, Account to, <span class="hljs-type">int</span> amount)</span> {
    lock.lock();

    <span class="hljs-keyword">if</span> (from.getBalance() &lt; amount) {
        lock.unlock();  <span class="hljs-comment">// ①提前返回时释放</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InsufficientBalanceException</span>();
    }

    from.deduct(amount);
    to.add(amount);  <span class="hljs-comment">// ②如果这里抛异常,锁永不释放!</span>

    lock.unlock();  <span class="hljs-comment">// ③正常流程释放</span>
}
</code></pre>
<p><strong>问题:</strong></p>
<ul>
<li>如果②抛出异常,③不会执行,锁永不释放</li>
<li>其他线程永久阻塞,导致死锁</li>
</ul>
<p><strong>正确示例:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✅正确:unlock在finally中</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transfer</span><span class="hljs-params">(Account from, Account to, <span class="hljs-type">int</span> amount)</span> {
    lock.lock();
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">if</span> (from.getBalance() &lt; amount) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InsufficientBalanceException</span>();
        }

        from.deduct(amount);
        to.add(amount);
    } <span class="hljs-keyword">finally</span> {
        lock.unlock();  <span class="hljs-comment">// 无论如何都会释放</span>
    }
}
</code></pre>
<p><strong>原则:</strong></p>
<ul>
<li><code>lock()</code>和<code>unlock()</code>必须配对</li>
<li><code>unlock()</code>必须在<code>finally</code>块中</li>
<li>避免在<code>try</code>块外<code>lock()</code>(可能异常导致未lock就unlock)</li>
</ul>
<h3 data-id="heading-57">5.5 Semaphore的公平与非公平模式性能差异多大?</h3>
<p>前面的测试结果显示:</p>
<ul>
<li><strong>非公平模式吞吐量提升约50%</strong></li>
<li><strong>公平模式延迟更稳定,避免饥饿</strong></li>
</ul>
<p><strong>适用场景:</strong></p>
<ul>
<li><strong>高吞吐业务</strong>: 非公平模式(如接口限流)</li>
<li><strong>关键业务</strong>: 公平模式(如任务调度,避免饥饿)</li>
</ul>
<h3 data-id="heading-58">5.6 ReadWriteLock的锁降级是什么?如何实现?</h3>
<p><strong>锁降级:</strong> 持有写锁时获取读锁,然后释放写锁</p>
<p><strong>正确示例:</strong></p>
<pre><code class="hljs language-java" lang="java">rwLock.writeLock().lock();  <span class="hljs-comment">// ①获取写锁</span>
<span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 更新数据</span>
    data = newData;

    rwLock.readLock().lock();  <span class="hljs-comment">// ②获取读锁(锁降级)</span>
} <span class="hljs-keyword">finally</span> {
    rwLock.writeLock().unlock();  <span class="hljs-comment">// ③释放写锁</span>
}

<span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// ④使用数据(持有读锁)</span>
    use(data);
} <span class="hljs-keyword">finally</span> {
    rwLock.readLock().unlock();  <span class="hljs-comment">// ⑤释放读锁</span>
}
</code></pre>
<p><strong>为什么需要锁降级?</strong></p>
<ul>
<li>保证数据一致性: ②③之间,其他线程无法修改数据</li>
<li>提高并发性: 释放写锁后,其他线程可以并发读</li>
</ul>
<h3 data-id="heading-59">5.7 为什么没有锁升级?</h3>
<p><strong>锁升级(读锁→写锁)会导致死锁:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌死锁示例</span>
<span class="hljs-comment">// 线程A</span>
readLock.lock();
<span class="hljs-comment">// ... 想升级为写锁</span>
writeLock.lock();  <span class="hljs-comment">// 阻塞,等待读锁释放</span>

<span class="hljs-comment">// 线程B</span>
readLock.lock();
<span class="hljs-comment">// ... 想升级为写锁</span>
writeLock.lock();  <span class="hljs-comment">// 阻塞,等待读锁释放</span>

<span class="hljs-comment">// 死锁! 两个线程都持有读锁,都等待对方释放</span>
</code></pre>
<p><strong>正确做法: 先释放读锁,再获取写锁</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✅正确</span>
readLock.lock();
<span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 读取数据</span>
    <span class="hljs-keyword">if</span> (needUpdate) {
        readLock.unlock();  <span class="hljs-comment">// ①释放读锁</span>

        writeLock.lock();  <span class="hljs-comment">// ②获取写锁</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// ③双重检查</span>
            <span class="hljs-keyword">if</span> (needUpdate) {
                <span class="hljs-comment">// 更新数据</span>
            }
        } <span class="hljs-keyword">finally</span> {
            writeLock.unlock();
        }
    }
} <span class="hljs-keyword">finally</span> {
    <span class="hljs-keyword">if</span> (readLock.isHeldByCurrentThread()) {
        readLock.unlock();
    }
}
</code></pre>
<h3 data-id="heading-60">5.8 Condition vs wait/notify的区别?</h3>













































<table><thead><tr><th>特性</th><th>wait/notify</th><th>Condition</th></tr></thead><tbody><tr><td>绑定对象</td><td>任意Object</td><td>Lock</td></tr><tr><td>条件数量</td><td>1个(对象监视器)</td><td>多个(一个Lock多个Condition)</td></tr><tr><td>唤醒精确性</td><td>❌notify随机唤醒</td><td>✅signal精确唤醒</td></tr><tr><td>支持中断</td><td>✅</td><td>✅</td></tr><tr><td>支持超时</td><td>✅</td><td>✅</td></tr><tr><td>必须在同步块</td><td>✅必须在synchronized</td><td>✅必须持有Lock</td></tr><tr><td>虚假唤醒</td><td>⚠️存在</td><td>⚠️存在</td></tr></tbody></table>
<p><strong>Condition的优势:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 多条件示例:生产者-消费者</span>
<span class="hljs-type">Lock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();
<span class="hljs-type">Condition</span> <span class="hljs-variable">notFull</span> <span class="hljs-operator">=</span> lock.newCondition();   <span class="hljs-comment">// 条件1</span>
<span class="hljs-type">Condition</span> <span class="hljs-variable">notEmpty</span> <span class="hljs-operator">=</span> lock.newCondition();  <span class="hljs-comment">// 条件2</span>

<span class="hljs-comment">// 生产者</span>
lock.lock();
<span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">while</span> (count == capacity) {
        notFull.await();  <span class="hljs-comment">// 等待notFull条件</span>
    }
    <span class="hljs-comment">// 生产</span>
    notEmpty.signal();  <span class="hljs-comment">// 精确唤醒消费者</span>
} <span class="hljs-keyword">finally</span> {
    lock.unlock();
}

<span class="hljs-comment">// 消费者</span>
lock.lock();
<span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">while</span> (count == <span class="hljs-number">0</span>) {
        notEmpty.await();  <span class="hljs-comment">// 等待notEmpty条件</span>
    }
    <span class="hljs-comment">// 消费</span>
    notFull.signal();  <span class="hljs-comment">// 精确唤醒生产者</span>
} <span class="hljs-keyword">finally</span> {
    lock.unlock();
}
</code></pre>
<hr/>
<h2 data-id="heading-61">六、最佳实践与总结</h2>
<h3 data-id="heading-62">6.1 如何选择合适的同步工具?</h3>
<p><strong>决策树:</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">需要互斥访问?
├─ 是 → 需要高级特性(中断/超时/公平/多条件)?
│   ├─ 是 → ReentrantLock
│   └─ 否 → <span class="hljs-keyword">synchronized</span>
└─ 否 → 需要什么样的协调?
    ├─ 限制并发数 → Semaphore
    ├─ 等待多个线程完成 → CountDownLatch
    ├─ 多线程互相等待同步点 → CyclicBarrier
    ├─ 读多写少 → ReadWriteLock
    └─ 生产者-消费者 → BlockingQueue
</code></pre>
<h3 data-id="heading-63">6.2 AQS自定义同步器的实现步骤</h3>
<p><strong>步骤1: 继承AQS</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyLock</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> {
        <span class="hljs-comment">// 实现同步逻辑</span>
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Sync</span> <span class="hljs-variable">sync</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sync</span>();
}
</code></pre>
<p><strong>步骤2: 定义state语义</strong></p>
<ul>
<li>独占锁: state=0未锁,state=1已锁</li>
<li>共享锁: state=剩余许可数</li>
<li>信号量: state=可用资源数</li>
</ul>
<p><strong>步骤3: 实现tryAcquire/tryRelease(独占模式)</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">if</span> (compareAndSetState(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)) {
        setExclusiveOwnerThread(Thread.currentThread());
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}

<span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryRelease</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    setExclusiveOwnerThread(<span class="hljs-literal">null</span>);
    setState(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p><strong>步骤4: 实现tryAcquireShared/tryReleaseShared(共享模式)</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">tryAcquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">for</span> (;;) {
        <span class="hljs-type">int</span> <span class="hljs-variable">available</span> <span class="hljs-operator">=</span> getState();
        <span class="hljs-type">int</span> <span class="hljs-variable">remaining</span> <span class="hljs-operator">=</span> available - arg;
        <span class="hljs-keyword">if</span> (remaining &lt; <span class="hljs-number">0</span> || compareAndSetState(available, remaining))
            <span class="hljs-keyword">return</span> remaining;
    }
}

<span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryReleaseShared</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">for</span> (;;) {
        <span class="hljs-type">int</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> getState();
        <span class="hljs-type">int</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> current + arg;
        <span class="hljs-keyword">if</span> (compareAndSetState(current, next))
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<p><strong>步骤5: 提供Lock API</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span> {
    sync.acquire(<span class="hljs-number">1</span>);
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span> {
    sync.release(<span class="hljs-number">1</span>);
}

<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> sync.tryAcquire(<span class="hljs-number">1</span>);
}
</code></pre>
<h3 data-id="heading-64">6.3 同步工具使用原则</h3>
<ol>
<li>
<p><strong>优先使用高级工具</strong></p>
<ul>
<li>使用<code>java.util.concurrent</code>包提供的工具</li>
<li>避免直接使用<code>wait/notify</code></li>
</ul>
</li>
<li>
<p><strong>锁的粒度要合适</strong></p>
<ul>
<li>锁粒度太粗 → 并发度低</li>
<li>锁粒度太细 → 复杂度高,容易死锁</li>
</ul>
</li>
<li>
<p><strong>避免锁嵌套</strong></p>
<ul>
<li>容易死锁</li>
<li>难以维护</li>
</ul>
</li>
<li>
<p><strong>及时释放锁</strong></p>
<ul>
<li>锁保护的临界区尽量小</li>
<li><code>unlock()</code>必须在<code>finally</code>块</li>
</ul>
</li>
<li>
<p><strong>优先使用非阻塞算法</strong></p>
<ul>
<li>CAS、原子类、无锁数据结构</li>
<li>性能更好,无死锁风险</li>
</ul>
</li>
</ol>
<h3 data-id="heading-65">6.4 性能优化建议</h3>
<ol>
<li>
<p><strong>减少锁竞争</strong></p>
<ul>
<li>缩小临界区</li>
<li>锁分段(ConcurrentHashMap)</li>
<li>读写分离(ReadWriteLock)</li>
</ul>
</li>
<li>
<p><strong>选择合适的锁类型</strong></p>
<ul>
<li>低竞争 → synchronized</li>
<li>高竞争 → ReentrantLock(非公平)</li>
<li>读多写少 → ReadWriteLock</li>
</ul>
</li>
<li>
<p><strong>避免锁的不必要获取</strong></p>
<ul>
<li>双重检查锁定(DCL)</li>
<li><code>tryLock()</code>尝试获取</li>
</ul>
</li>
<li>
<p><strong>使用并发容器</strong></p>
<ul>
<li><code>ConcurrentHashMap</code> 代替 <code>Hashtable</code></li>
<li><code>CopyOnWriteArrayList</code> 代替 <code>Vector</code></li>
</ul>
</li>
</ol>
<h3 data-id="heading-66">6.5 常见陷阱总结</h3>













































<table><thead><tr><th>陷阱</th><th>后果</th><th>避免方法</th></tr></thead><tbody><tr><td>unlock()不在finally</td><td>锁泄漏,死锁</td><td>必须在finally中unlock</td></tr><tr><td>CountDownLatch未countDown</td><td>线程永久阻塞</td><td>finally保证countDown</td></tr><tr><td>Semaphore获取后未释放</td><td>资源泄漏</td><td>finally保证release</td></tr><tr><td>锁重入未正确计数</td><td>锁提前释放</td><td>使用ReentrantLock</td></tr><tr><td>读锁升级为写锁</td><td>死锁</td><td>先释放读锁再获取写锁</td></tr><tr><td>synchronized(this)</td><td>锁粗粒度</td><td>使用私有锁对象</td></tr><tr><td>wait()不在while循环</td><td>虚假唤醒</td><td>用while检查条件</td></tr></tbody></table>
<h3 data-id="heading-67">6.6 总结</h3>
<p>AQS是Java并发编程的基石,深入理解AQS能够:</p>
<ol>
<li><strong>掌握JUC核心工具原理</strong>: ReentrantLock、Semaphore、CountDownLatch等</li>
<li><strong>提升并发编程能力</strong>: 选择合适的同步工具,避免常见陷阱</li>
<li><strong>优化系统性能</strong>: 根据场景选择最优方案,如读写锁、分段锁等</li>
<li><strong>自定义同步器</strong>: 在特殊场景下实现定制化同步逻辑</li>
</ol>
<p><strong>核心要点回顾:</strong></p>
<ul>
<li><strong>AQS核心</strong>: state(同步状态) + CLH队列(等待线程) + CAS(原子操作)</li>
<li><strong>独占vs共享</strong>: 独占一次唤醒一个,共享传播唤醒</li>
<li><strong>Condition</strong>: 一个Lock多个条件,精确唤醒</li>
<li><strong>ReentrantLock vs synchronized</strong>: 功能丰富 vs 简洁易用</li>
<li><strong>读写锁</strong>: 读多写少场景性能提升显著</li>
<li><strong>最佳实践</strong>: 锁粒度适中、及时释放、避免嵌套、优先非阻塞</li>
</ul>
<p>掌握AQS,你已经迈入Java并发编程高级阶段!</p>
<pre><code class="hljs"/></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 3 中开发高阶组件（HOC）与 Renderless 组件]]></title>    <link>https://juejin.cn/post/7585446706327093257</link>    <guid>https://juejin.cn/post/7585446706327093257</guid>    <pubDate>2025-12-20T06:23:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585446706327093257" data-draft-id="7585706951583219721" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 3 中开发高阶组件（HOC）与 Renderless 组件"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T06:23:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户5427784851540"/> <meta itemprop="url" content="https://juejin.cn/user/224762173330942"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 3 中开发高阶组件（HOC）与 Renderless 组件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/224762173330942/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户5427784851540
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T06:23:44.000Z" title="Sat Dec 20 2025 06:23:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Vue 3 的组合式 API（Composition API）时代，虽然官方更推荐使用 Composables（组合函数） 来复用逻辑，但理解 高阶组件（Higher-Order Component, HOC） 和 Renderless 组件（无渲染组件） 仍然具有重要价值。它们不仅是 React 生态中的经典模式，在 Vue 中也有其适用场景，尤其在需要封装复杂状态逻辑并以组件形式暴露时。</p>
<p>本文将深入讲解如何在 Vue 3 中实现这两种模式，并通过实际案例展示其用法、优势与注意事项。</p>
<hr/>
<p> </p>
<h2 data-id="heading-0">一、概念澄清</h2>
<h3 data-id="heading-1">1. 高阶组件（HOC）</h3>
<blockquote>
<p>接收一个组件作为参数，返回一个新组件的函数。</p>
</blockquote>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">withLoading</span> = (<span class="hljs-params">WrappedComponent</span>) =&gt; {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-title function_">setup</span>(<span class="hljs-params">props, { slots }</span>) {
      <span class="hljs-comment">// 添加 loading 逻辑</span>
      <span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">true</span>);
      
      <span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>, <span class="hljs-number">1000</span>);
      });
      
      <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">h</span>(<span class="hljs-title class_">WrappedComponent</span>, {
        ...props,
        <span class="hljs-attr">loading</span>: loading.<span class="hljs-property">value</span>
      });
    }
  };
};
</code></pre>
<h3 data-id="heading-2">2. Renderless 组件（无渲染组件）</h3>
<blockquote>
<p>不包含任何 DOM 结构，只提供逻辑和数据，通过作用域插槽（scoped slot）将状态传递给子组件。</p>
</blockquote>
<pre><code class="hljs language-ini" lang="ini">&lt;template&gt;
  &lt;slot 
    :<span class="hljs-attr">loading</span>=<span class="hljs-string">"loading"</span> 
    :<span class="hljs-attr">startLoading</span>=<span class="hljs-string">"startLoading"</span>
  /&gt;
&lt;/template&gt;


&lt;script setup&gt;
import { ref } from 'vue'<span class="hljs-comment">;</span>


const <span class="hljs-attr">loading</span> = ref(<span class="hljs-literal">false</span>)<span class="hljs-comment">;</span>


const <span class="hljs-attr">startLoading</span> = () =&gt; {
  <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
  setTimeout(() =&gt; <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">false</span>, <span class="hljs-number">1000</span>)<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
&lt;/script&gt;
</code></pre>
<blockquote>
<p>✅ 关键区别：HOC：包装现有组件，注入 props，Renderless：自身不渲染 UI，通过 <code>&lt;slot&gt;</code> 暴露逻辑</p>
</blockquote>
<hr/>
<p> </p>
<h2 data-id="heading-3">二、实战：开发一个通用数据加载 HOC</h2>
<h3 data-id="heading-4">场景</h3>
<p>为任意组件添加自动数据加载能力，无需重复编写 <code>loading</code>、<code>error</code>、<code>data</code> 状态管理。</p>
<h3 data-id="heading-5">步骤 1：定义 HOC 函数</h3>
<pre><code class="hljs language-ini" lang="ini">// hoc/withAsyncData.js
import { defineComponent, ref, onMounted, h } from 'vue'<span class="hljs-comment">;</span>


/**
 * 高阶组件：为组件注入异步数据加载能力
 * @param {Function} fetchFn - 数据获取函数 (返回 Promise)
 * @param {Object} options - 配置项
 * @returns {Component} 新组件
 */
export function withAsyncData(fetchFn, <span class="hljs-attr">options</span> = {}) {
  const {
    <span class="hljs-attr">loadingProp</span> = <span class="hljs-string">'loading'</span>,
    <span class="hljs-attr">dataProp</span> = <span class="hljs-string">'data'</span>,
    <span class="hljs-attr">errorProp</span> = <span class="hljs-string">'error'</span>,
    <span class="hljs-attr">autoLoad</span> = <span class="hljs-literal">true</span>
  } = options<span class="hljs-comment">;</span>


  return (WrappedComponent) =&gt; {
    return defineComponent({
      name: `WithAsyncData(${WrappedComponent.name || 'Anonymous'})`,
      
      props: WrappedComponent.props ? { ...WrappedComponent.props } : {},
      
      setup(props, { attrs, slots }) {
        const <span class="hljs-attr">loading</span> = ref(<span class="hljs-literal">false</span>)<span class="hljs-comment">;</span>
        const <span class="hljs-attr">data</span> = ref(null)<span class="hljs-comment">;</span>
        const <span class="hljs-attr">error</span> = ref(null)<span class="hljs-comment">;</span>


        const <span class="hljs-attr">loadData</span> = async () =&gt; {
          <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
          <span class="hljs-attr">error.value</span> = null<span class="hljs-comment">;</span>
          
          try {
            const <span class="hljs-attr">result</span> = await fetchFn()<span class="hljs-comment">;</span>
            <span class="hljs-attr">data.value</span> = result<span class="hljs-comment">;</span>
          } catch (err) {
            <span class="hljs-attr">error.value</span> = err<span class="hljs-comment">;</span>
          } finally {
            <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
          }
        }<span class="hljs-comment">;</span>


        if (autoLoad) {
          onMounted(loadData)<span class="hljs-comment">;</span>
        }


        // 将状态作为 props 注入 WrappedComponent
        const <span class="hljs-attr">injectedProps</span> = {
          <span class="hljs-section">[loadingProp]</span>: loading.value,
          <span class="hljs-section">[dataProp]</span>: data.value,
          <span class="hljs-section">[errorProp]</span>: error.value,
          // 提供重新加载方法
          reload: loadData
        }<span class="hljs-comment">;</span>


        return () =&gt; h(
          WrappedComponent,
          {
            ...props,
            ...attrs,
            ...injectedProps
          },
          slots
        )<span class="hljs-comment">;</span>
      }
    })<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
}
</code></pre>
<h3 data-id="heading-6">步骤 2：使用 HOC</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- UserList.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"loading"</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else-if</span>=<span class="hljs-string">"error"</span>&gt;</span>错误: {{ error.message }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">v-else</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"user in data"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"user.id"</span>&gt;</span>{{ user.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"reload"</span>&gt;</span>刷新<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>


<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { defineComponent } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;


<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineComponent</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'UserList'</span>,
  <span class="hljs-attr">props</span>: [<span class="hljs-string">'loading'</span>, <span class="hljs-string">'data'</span>, <span class="hljs-string">'error'</span>, <span class="hljs-string">'reload'</span>] <span class="hljs-comment">// 接收 HOC 注入的 props</span>
});
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p> </p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- App.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">UserListWithAsyncData</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>


<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">UserList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./UserList.vue'</span>;
<span class="hljs-keyword">import</span> { withAsyncData } <span class="hljs-keyword">from</span> <span class="hljs-string">'./hoc/withAsyncData'</span>;


<span class="hljs-comment">// 创建增强后的组件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">UserListWithAsyncData</span> = <span class="hljs-title function_">withAsyncData</span>(
  <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/users'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>()),
  { <span class="hljs-attr">autoLoad</span>: <span class="hljs-literal">true</span> }
)(<span class="hljs-title class_">UserList</span>);


<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">components</span>: {
    <span class="hljs-title class_">UserListWithAsyncData</span>
  }
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<blockquote>
<p>✅ 优势：
逻辑复用：任何列表组件都可快速获得加载能力；
类型安全：通过 props 明确接口；
可配置：支持自定义 prop 名称</p>
</blockquote>
<hr/>
<p> </p>
<h2 data-id="heading-7">三、实战：开发 Renderless 组件</h2>
<h3 data-id="heading-8">场景</h3>
<p>创建一个通用的计数器逻辑组件，不关心 UI 如何展示。</p>
<h3 data-id="heading-9">步骤 1：创建 Renderless 组件</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- renderless/CounterProvider.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 无任何 DOM，只暴露逻辑 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> 
    <span class="hljs-attr">:count</span>=<span class="hljs-string">"count"</span>
    <span class="hljs-attr">:increment</span>=<span class="hljs-string">"increment"</span>
    <span class="hljs-attr">:decrement</span>=<span class="hljs-string">"decrement"</span>
    <span class="hljs-attr">:reset</span>=<span class="hljs-string">"reset"</span>
    <span class="hljs-attr">:isEven</span>=<span class="hljs-string">"isEven"</span>
  /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>


<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;


<span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>({
  <span class="hljs-attr">initialCount</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">Number</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-number">0</span>
  },
  <span class="hljs-attr">min</span>: <span class="hljs-title class_">Number</span>,
  <span class="hljs-attr">max</span>: <span class="hljs-title class_">Number</span>
});


<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(props.<span class="hljs-property">initialCount</span>);


<span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (props.<span class="hljs-property">max</span> === <span class="hljs-literal">undefined</span> || count.<span class="hljs-property">value</span> &lt; props.<span class="hljs-property">max</span>) {
    count.<span class="hljs-property">value</span>++;
  }
};


<span class="hljs-keyword">const</span> <span class="hljs-title function_">decrement</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (props.<span class="hljs-property">min</span> === <span class="hljs-literal">undefined</span> || count.<span class="hljs-property">value</span> &gt; props.<span class="hljs-property">min</span>) {
    count.<span class="hljs-property">value</span>--;
  }
};


<span class="hljs-keyword">const</span> <span class="hljs-title function_">reset</span> = (<span class="hljs-params"/>) =&gt; {
  count.<span class="hljs-property">value</span> = props.<span class="hljs-property">initialCount</span>;
};


<span class="hljs-keyword">const</span> isEven = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> count.<span class="hljs-property">value</span> % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>);
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-10">步骤 2：使用 Renderless 组件</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- App.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 方式1：基础用法 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">CounterProvider</span> <span class="hljs-attr">v-slot</span>=<span class="hljs-string">"{ count, increment, decrement }"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前计数: {{ count }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"increment"</span>&gt;</span>+1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"decrement"</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">CounterProvider</span>&gt;</span>


    <span class="hljs-comment">&lt;!-- 方式2：高级用法（带限制） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">CounterProvider</span> 
      <span class="hljs-attr">:initial-count</span>=<span class="hljs-string">"10"</span> 
      <span class="hljs-attr">:min</span>=<span class="hljs-string">"0"</span> 
      <span class="hljs-attr">:max</span>=<span class="hljs-string">"20"</span>
      <span class="hljs-attr">v-slot</span>=<span class="hljs-string">"{ count, increment, decrement, isEven }"</span>
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"{ even: isEven }"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>受限计数器 (0~20)<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ count }} {{ isEven ? '(偶数)' : '(奇数)' }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"increment"</span> <span class="hljs-attr">:disabled</span>=<span class="hljs-string">"count &gt;= 20"</span>&gt;</span>+1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"decrement"</span> <span class="hljs-attr">:disabled</span>=<span class="hljs-string">"count &lt;= 0"</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">CounterProvider</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>


<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">CounterProvider</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./renderless/CounterProvider.vue'</span>;
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>


<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.even</span> { <span class="hljs-attribute">color</span>: green; }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<blockquote>
<p>✅ 优势：
完全解耦逻辑与 UI；
灵活组合：同一个逻辑可适配多种 UI；
类型推导：IDE 可自动提示 slot 属性；</p>
</blockquote>
<hr/>
<p> </p>
<h2 data-id="heading-11">四、HOC vs Renderless vs Composables 对比</h2>









































<table><thead><tr><th>特性</th><th>HOC</th><th>Renderless 组件</th><th>Composables</th></tr></thead><tbody><tr><td>复用方式</td><td>包装组件</td><td>作用域插槽</td><td>函数调用</td></tr><tr><td>模板侵入性</td><td>低（使用者无感知）</td><td>中（需写 ）</td><td>无</td></tr><tr><td>逻辑复杂度</td><td>适合简单 props 注入</td><td>适合状态+方法暴露</td><td>最灵活</td></tr><tr><td>TypeScript 支持</td><td>需手动处理类型</td><td>自动推导 slot 类型</td><td>最佳</td></tr><tr><td>Vue 3 推荐度</td><td>⭐⭐</td><td>⭐⭐⭐</td><td>⭐⭐⭐⭐⭐</td></tr></tbody></table>
<p>📌 建议：</p>
<blockquote>
<p>Vue 3 中优先使用 Composables，仅在以下情况考虑 HOC/Renderless：
需要以组件形式分发（如 UI 库）；
与第三方组件集成（无法修改其内部逻辑）；
团队习惯类 React 的开发模式；</p>
</blockquote>
<hr/>
<p> </p>
<h2 data-id="heading-12">五、Composables 替代方案（推荐）</h2>
<p>上述功能用 Composables 实现更简洁：</p>
<pre><code class="hljs language-ini" lang="ini">// composables/useCounter.js
import { ref, computed, watch } from 'vue'<span class="hljs-comment">;</span>


export function useCounter(<span class="hljs-attr">initialValue</span> = <span class="hljs-number">0</span>, { min, max } = {}) {
  const <span class="hljs-attr">count</span> = ref(initialValue)<span class="hljs-comment">;</span>
  
  const <span class="hljs-attr">increment</span> = () =&gt; {
    if (<span class="hljs-attr">max</span> === undefined || count.value &lt; max) count.value++<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
  
  const <span class="hljs-attr">decrement</span> = () =&gt; {
    if (<span class="hljs-attr">min</span> === undefined || count.value &gt; min) count.value--<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
  
  const <span class="hljs-attr">reset</span> = () =&gt; count.value = initialValue<span class="hljs-comment">;</span>
  
  const <span class="hljs-attr">isEven</span> = computed(() =&gt; count.value % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
  
  // 监听 initialValue 变化
  watch(() =&gt; initialValue, (newVal) =&gt; {
    <span class="hljs-attr">count.value</span> = newVal<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>
  
  return {
    count,
    increment,
    decrement,
    reset,
    isEven
  }<span class="hljs-comment">;</span>
}
</code></pre>
<p> </p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 使用 Composables --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useCounter } <span class="hljs-keyword">from</span> <span class="hljs-string">'./composables/useCounter'</span>;


<span class="hljs-keyword">const</span> { count, increment, decrement } = <span class="hljs-title function_">useCounter</span>(<span class="hljs-number">0</span>, { <span class="hljs-attr">min</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">max</span>: <span class="hljs-number">10</span> });
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>


<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ count }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"increment"</span>&gt;</span>+1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"decrement"</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p> </p>
<hr/>
<h2 data-id="heading-13">六、最佳实践与注意事项</h2>
<h3 data-id="heading-14">1. HOC 注意事项</h3>
<ul>
<li>透传 Props/Attrs/Slots：确保包装组件的行为与原组件一致</li>
<li>命名规范：使用 <code>WithXxx</code> 前缀（如 <code>WithLoading</code>）</li>
<li>避免嵌套过深：HOC 嵌套会导致调试困难</li>
</ul>
<h3 data-id="heading-15">2. Renderless 组件注意事项</h3>
<ul>
<li>明确 Slot 接口：使用 TypeScript 定义 slot props 类型</li>
<li>避免过度设计：简单逻辑直接用 Composables</li>
<li>文档说明：清晰标注暴露的 slot 属性</li>
</ul>
<h3 data-id="heading-16">3. 性能优化</h3>
<ul>
<li>缓存计算属性：使用 <code>computed</code> 而非方法</li>
<li>按需响应：只暴露必要的状态</li>
<li>清理副作用：在 <code>onUnmounted</code> 中清理定时器等</li>
</ul>
<hr/>
<p> </p>
<h2 data-id="heading-17">结语</h2>
<p>虽然 Vue 3 的 Composition API 使得 Composables 成为逻辑复用的首选，但理解 HOC 和 Renderless 组件仍有其价值：</p>
<ul>
<li>HOC 适合对现有组件进行“装饰”，尤其在无法修改组件源码时</li>
<li>Renderless 组件 在构建 UI 库时非常有用，允许用户完全控制渲染</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解析Android内存分析的指标]]></title>    <link>https://juejin.cn/post/7585446706326781961</link>    <guid>https://juejin.cn/post/7585446706326781961</guid>    <pubDate>2025-12-20T05:10:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585446706326781961" data-draft-id="7585463258690273289" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解析Android内存分析的指标"/> <meta itemprop="keywords" content="Android,APP"/> <meta itemprop="datePublished" content="2025-12-20T05:10:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="愤怒的代码"/> <meta itemprop="url" content="https://juejin.cn/user/4125023358426190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解析Android内存分析的指标
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4125023358426190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    愤怒的代码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T05:10:11.000Z" title="Sat Dec 20 2025 05:10:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Android 系统开发中，为了精准衡量进程的内存消耗，通常会使用 <strong>VSS、RSS、PSS、USS</strong> 这四个指标。由于内存共享机制的存在，单一的“内存占用”数字往往无法真实反映进程对系统的影响，因此这四个指标提供了不同维度的观察视角。</p>
<h2 data-id="heading-0">0x00 核心含义详解</h2>
<p>我们可以通过一个简单的模型来理解：假设进程 A 使用了 <strong>50MB 私有内存</strong>，并与进程 B 共享一个 <strong>20MB 的动态库</strong>。</p>
<h3 data-id="heading-1"><strong>VSS (Virtual Set Size) - 虚拟耗用内存</strong></h3>
<ul>
<li><strong>含义</strong>：进程能访问到的全部虚拟地址空间大小。</li>
<li><strong>包含</strong>：已分配但未实际使用的内存、映射到磁盘的文件、共享库占用的全部空间等。</li>
<li><strong>特点</strong>：数值最大。它不代表真实的物理内存消耗，对于<strong>性能分析意义较小</strong>。</li>
</ul>
<h3 data-id="heading-2"><strong>RSS (Resident Set Size) - 实际使用物理内存</strong></h3>
<ul>
<li><strong>含义</strong>：进程当前实际占用的物理内存（RAM）。</li>
<li><strong>包含</strong>：进程的私有内存 + <strong>共享库的全部大小</strong>。</li>
<li><strong>缺点</strong>：存在“重复计算”。如果有 10 个进程都用了那个 20MB 的共享库，每个进程的 RSS 都会计入这 20MB。将所有进程的 RSS 相加，会远大于系统总内存。</li>
</ul>
<h3 data-id="heading-3"><strong>PSS (Proportional Set Size) - 比例分配内存</strong></h3>
<ul>
<li><strong>含义</strong>：将共享库的大小按共享进程的数量<strong>均摊</strong>。</li>
<li><strong>计算</strong>：私有内存 + (共享库大小 / 共享该库的进程数)。</li>
<li><strong>优点</strong>：<strong>最客观的指标</strong>。如果将系统中所有进程的 PSS 相加，结果几乎等于系统实际消耗的总内存。它是衡量进程系统级负担的最佳标准。</li>
</ul>
<h3 data-id="heading-4"><strong>USS (Unique Set Size) - 进程独占内存（最常用）</strong></h3>
<ul>
<li><strong>含义</strong>：进程完全独占的物理内存。</li>
<li><strong>包含</strong>：只有该进程能访问到的 RAM 区域。</li>
<li><strong>优点</strong>：<strong>分析内存泄露的核心指标</strong>。它表示如果杀死该进程，系统能立刻回收的内存量。</li>
</ul>
<h2 data-id="heading-5">0x01 核心判断标准：为什么 USS 是“金标准”？</h2>
<p>在分析泄漏时，我们通常遵循这个优先级：<strong>USS &gt; PSS &gt; RSS &gt; VSS</strong>。</p>
<ul>
<li><strong>VSS 和 RSS 的局限性</strong>：由于 RSS 包含了共享库内存，当系统其他进程加载或卸载共享库时，你的进程 RSS 可能会波动，这会产生“伪泄漏”的干扰。</li>
<li><strong>PSS 的参考意义</strong>：PSS 能够反映你的进程对系统总内存的真实贡献。如果 PSS 持续上涨，说明你的应用正在拖慢系统。</li>
<li><strong>USS 的决定性作用</strong>：<strong>USS 只包含进程完全独占的内存。</strong> 内存泄漏本质上是进程内部的对象无法被回收，因此<strong>内存泄漏一定会直接反映在 USS 的上涨上</strong>。</li>
</ul>
<h2 data-id="heading-6">0x02 分析内存泄漏分析的流程</h2>
<h3 data-id="heading-7">第一步：建立基准线 (Baseline)</h3>
<p>在应用启动并进入主界面稳定后，记录当前的内存状态。</p>
<pre><code class="hljs language-shell" lang="shell">adb shell dumpsys meminfo &lt;your_package_name&gt;
</code></pre>
<p>重点记录：<code>TOTAL Pss</code> 和 <code>Private Dirty</code>（后者非常接近 USS）。</p>
<h3 data-id="heading-8">第二步：执行重复性操作 (Stress Test)</h3>
<p>内存泄漏通常发生在 Activity 销毁或长生命周期对象（如 Singleton、Thread）中。执行以下操作：</p>
<ol>
<li>进入一个怀疑有泄漏的页面，再退出。</li>
<li>重复上述过程 <strong>10 次以上</strong>。</li>
<li>手动触发几次 GC（在 Android Studio Profiler 中点击小垃圾桶图标，或通过 <code>adb shell cmd activity gc</code>）。</li>
</ol>
<h3 data-id="heading-9">第三步：对比观测</h3>
<p>再次运行 <code>adb shell dumpsys meminfo &lt;your_package_name&gt;</code>，观察数据变化：</p>
<ul>
<li><strong>如果 USS (Private Dirty) 阶梯式上升</strong>：说明存在<strong>私有内存泄漏</strong>（通常是 Java 对象、Bitmap 或 Native 堆内存）。</li>
<li><strong>如果 PSS 上升但 USS 稳定</strong>：这种情况极少见，可能意味着你调用的系统共享资源（如某些系统服务的缓存）在增加，而不是你进程内部的泄漏。</li>
<li><strong>如果 PSS/USS 均不增加，但 VSS 疯狂增长</strong>：说明你在不断地申请虚拟地址空间（例如创建了大量线程，每个线程占用 1MB 虚拟栈空间，但实际还没开始使用物理内存）。</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">Applications Memory Usage (in Kilobytes):
Uptime: 102275 Realtime: 102275

** MEMINFO in pid 3069 [com.android.launcher3] **
                   Pss  Private  Private     Swap      Rss     Heap     Heap     Heap
                 Total    Dirty    Clean    Dirty    Total     Size    Alloc     Free
                ------   ------   ------   ------   ------   ------   ------   ------
  Native Heap    11128    11060        0        0    13796    19812    13511     2600
  Dalvik Heap     2316     2188        0        0     6620    27729     3153    24576
 Dalvik Other     2587     2264        0        0     3528                           
        Stack      736      736        0        0      740                           
       Ashmem        2        0        0        0        8                           
      Gfx dev     1244     1244        0        0     1244                           
    Other dev       36        0       36        0      284                           
     .so mmap     6076      212      128        0    54512                           
    .jar mmap     1922        0        0        0    26648                           
    .apk mmap    14824        0    13900        0    38756                           
    .ttf mmap       54        0        0        0      228                           
    .dex mmap      213        4        0        0      504                           
    .oat mmap       55        0        0        0     2044                           
    .art mmap     7794     7404        4        0    20040                           
   Other mmap     1179        4       32        0     4984                           
   EGL mtrack    40288    40288        0        0    40288                           
    GL mtrack     6104     6104        0        0     6104                           
      Unknown      466      448        0        0     1100                           
        TOTAL    97024    71956    14100        0    97024    47541    16664    27176
 
 App Summary
                       Pss(KB)                        Rss(KB)
                        ------                         ------
           Java Heap:     9596                          26660
         Native Heap:    11060                          13796
                Code:    14256                         123424
               Stack:      736                            740
            Graphics:    47636                          47636
       Private Other:     2772
              System:    10968
             Unknown:                                    9172
 
           TOTAL PSS:    97024            TOTAL RSS:   221428      TOTAL SWAP (KB):        0
 
...

</code></pre>
<h2 data-id="heading-10">0x03 针对不同类型的泄漏分析</h2>
<h3 data-id="heading-11">A. Java 层泄漏 (Activity/Fragment)</h3>
<ul>
<li>
<p><strong>现象</strong>：<code>TOTAL Pss</code> 和 <code>Java Heap</code> 持续增长。</p>
</li>
<li>
<p><strong>分析</strong>：查看 <code>dumpsys meminfo</code> 最后的 <code>Objects</code> 部分。</p>
<ul>
<li><code>Views</code> 和 <code>Activities</code> 的数量。如果你退出了页面，<code>Activities</code> 数量没有减少，那就是典型的 Activity 泄漏。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-12">B. Native 层泄漏 (C++/JNI)</h3>
<ul>
<li><strong>现象</strong>：<code>Native Heap</code> 指标持续增长，且 <code>USS</code> 同步上涨。</li>
<li><strong>分析</strong>：如果你在 JNI 中使用了 <code>malloc</code> 或 <code>new</code> 但没有 <code>free</code>，这部分内存会体现在 <code>Native Heap</code> 中。</li>
</ul>
<h3 data-id="heading-13">C. 共享内存/文件描述符泄漏 (SharedMemory/FD)</h3>
<p>如果 SharedMemory 没有被正确关闭：</p>
<ul>
<li>
<p><strong>现象</strong>：<code>USS</code> 可能不会显著增长（如果你已经 <code>munmap</code> 了），但<strong>文件描述符 (FD)</strong> 会耗尽。</p>
</li>
<li>
<p><strong>检查方式</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">adb shell <span class="hljs-built_in">ls</span> -l /proc/&lt;pid&gt;/fd | <span class="hljs-built_in">wc</span> -l
</code></pre>
<p>例如检查<code>3069</code>号进程(<code>com.android.launcher3</code>)</p>
<pre><code class="hljs language-shell" lang="shell">adb root
adb shell ls -l /proc/3069/fd | wc -l
<span class="hljs-meta prompt_">
# </span><span class="bash">输出</span>
<span class="hljs-meta prompt_"># </span><span class="bash">82</span>
</code></pre>
<p>重复操作后，如果 FD 数量不断增加，说明你的 <code>SharedMemory</code> 或 <code>ParcelFileDescriptor</code> 没有执行 <code>close()</code>。</p>
</li>
</ul>
<h2 data-id="heading-14">0x04 自动化检测工具推荐</h2>
<p>虽然手动分析 <code>dumpsys</code> 很有帮助，但在实际开发中，建议配合以下工具：</p>





















<table><thead><tr><th><strong>工具</strong></th><th><strong>优势</strong></th></tr></thead><tbody><tr><td><strong>LeakCanary</strong></td><td>自动化程度最高，直接在手机端弹窗告知 Java 泄漏引用链。</td></tr><tr><td><strong>Android Studio Profiler</strong></td><td>可视化实时查看 PSS 分布，支持 Capture Heap Dump 分析堆快照。</td></tr><tr><td><strong>Perfetto / Systrace</strong></td><td>适合分析 Native 层和系统级的内存分配行为。</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 Node.js Elasticsearch 客户端索引大型 CSV 文件]]></title>    <link>https://juejin.cn/post/7585390679398957062</link>    <guid>https://juejin.cn/post/7585390679398957062</guid>    <pubDate>2025-12-20T04:10:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585390679398957062" data-draft-id="7585412203978162219" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 Node.js Elasticsearch 客户端索引大型 CSV 文件"/> <meta itemprop="keywords" content="Elasticsearch"/> <meta itemprop="datePublished" content="2025-12-20T04:10:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Elasticsearch"/> <meta itemprop="url" content="https://juejin.cn/user/2612095360441448"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 Node.js Elasticsearch 客户端索引大型 CSV 文件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612095360441448/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Elasticsearch
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T04:10:45.000Z" title="Sat Dec 20 2025 04:10:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：来自 Elastic <a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscuss.elastic.co%2Fu%2Fjoshmock" title="https://discuss.elastic.co/u/joshmock" target="_blank" ref="nofollow noopener noreferrer">joshmock</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a63db05724934ee494f54a3ab790d1a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766808645&amp;x-signature=3Ak4aLkmgmzCh6BMEheIyUvXemY%3D" alt="" loading="lazy"/></p>
<p>使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fapi%2Fdoc%2Felasticsearch%2Foperation%2Foperation-bulk" title="https://www.elastic.co/docs/api/doc/elasticsearch/operation/operation-bulk" target="_blank" ref="nofollow noopener noreferrer">bulk API</a> 可以轻松地将大量文档索引到 Elasticsearch：将你的数据记录转换为 JSON 文档，并插入指示它们应该添加到哪个索引的指令，然后将这个大的换行分隔 JSON blob 作为请求体，通过单个 HTTP 请求发送到 Elasticsearch 集群。或者，使用 Node.js 客户端的 bulk 函数。</p>
<p>更多阅读：E<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F124318170" title="https://elasticstack.blog.csdn.net/article/details/124318170" target="_blank" ref="nofollow noopener noreferrer">lasticsearch：使用最新的 Nodejs client 8.x 来创建索引并搜索</a></p>
<p>下面演示如何读取 CSV 文件，将其行转换为 JSON 对象，并进行索引：</p>
<pre><code class="hljs language-php" lang="php">`

<span class="hljs-number">1</span>.  import { Client } <span class="hljs-keyword">from</span> <span class="hljs-string">'@elastic/elasticsearch'</span>
<span class="hljs-number">2</span>.  import { parse } <span class="hljs-keyword">from</span> <span class="hljs-string">"csv-parse/sync"</span>
<span class="hljs-number">3</span>.  import { readFileSync } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:fs'</span>

<span class="hljs-number">5</span>.  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">csv</span> = <span class="hljs-title function_ invoke__">parse</span>(<span class="hljs-title function_ invoke__">readFileSync</span>(<span class="hljs-string">'data.csv'</span>, <span class="hljs-string">'utf8'</span>), { <span class="hljs-attr">columns</span>: <span class="hljs-literal">true</span> })
<span class="hljs-number">6</span>.  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">operations</span> = csv.<span class="hljs-title function_ invoke__">flatMap</span>(row =&gt; [
<span class="hljs-number">7</span>.    { <span class="hljs-attr">index</span>: { <span class="hljs-attr">_index</span>: <span class="hljs-string">"my_index"</span> } },
<span class="hljs-number">8</span>.    row
<span class="hljs-number">9</span>.  ])

<span class="hljs-number">11</span>.  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">client</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Client</span>({ node: <span class="hljs-string">'http://localhost:9200'</span> })
<span class="hljs-number">12</span>.  await client.<span class="hljs-title function_ invoke__">bulk</span>({ operations })

`AI写代码![](https:<span class="hljs-comment">//csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)</span>
</code></pre>
<p>但是，如果你需要发送的数据量超过 Elasticsearch 单次请求能接收的大小，或者你的 CSV 文件太大，无法一次性全部加载到内存中，该怎么办？这时可以使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Felasticsearch%2Fclients%2Fjavascript%2Fclient-helpers%23bulk-helper" title="https://www.elastic.co/docs/reference/elasticsearch/clients/javascript/client-helpers#bulk-helper" target="_blank" ref="nofollow noopener noreferrer">bulk helper</a>！</p>
<p>虽然 bulk API 本身已经很简单，但对于更复杂的场景，helper 提供了对流式输入的支持，可以将大型数据集拆分为多个请求等。</p>
<p>例如，如果你的 Elasticsearch 服务器只能接收小于 10MB 的 HTTP 请求，你可以通过设置 flushBytes 值来指示 bulk helper 拆分数据。每当请求即将超过设置值时，就会发送一次 bulk 请求：</p>
<pre><code class="hljs language-php" lang="php">`

<span class="hljs-number">1</span>.  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">csv</span> = <span class="hljs-title function_ invoke__">parse</span>(<span class="hljs-title function_ invoke__">readFileSync</span>(<span class="hljs-string">'data.csv'</span>, <span class="hljs-string">'utf8'</span>), { <span class="hljs-attr">columns</span>: <span class="hljs-literal">true</span> })
<span class="hljs-number">2</span>.  await client.helpers.<span class="hljs-title function_ invoke__">bulk</span>({
<span class="hljs-number">3</span>.    <span class="hljs-attr">datasource</span>: csv,
<span class="hljs-number">4</span>.    <span class="hljs-title function_ invoke__">onDocument</span>(doc) {
<span class="hljs-number">5</span>.      <span class="hljs-keyword">return</span> { <span class="hljs-attr">index</span>: { <span class="hljs-attr">_index</span>: <span class="hljs-string">"my_index"</span> } }
<span class="hljs-number">6</span>.    },
<span class="hljs-number">7</span>.    // send a bulk request <span class="hljs-keyword">for</span> every <span class="hljs-number">9.5</span>MB
<span class="hljs-number">8</span>.    <span class="hljs-attr">flushBytes</span>: <span class="hljs-number">9500000</span>
<span class="hljs-number">9</span>.  })

`AI写代码
</code></pre>
<p>或者，如果你的 CSV 文件太大无法一次性加载到内存中，helper 可以将<a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2Fapi%2Fstream.html" title="https://nodejs.org/api/stream.html" target="_blank" ref="nofollow noopener noreferrer">流</a>作为数据源，而不是使用数组：</p>
<pre><code class="hljs language-php" lang="php">`

<span class="hljs-number">1</span>.  import { createReadStream } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:fs'</span>
<span class="hljs-number">2</span>.  import { parse } <span class="hljs-keyword">from</span> <span class="hljs-string">'csv-parse'</span>

<span class="hljs-number">4</span>.  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">parser</span> = <span class="hljs-title function_ invoke__">parse</span>({ <span class="hljs-attr">columns</span>: <span class="hljs-literal">true</span> })
<span class="hljs-number">5</span>.  await client.helpers.<span class="hljs-title function_ invoke__">bulk</span>({
<span class="hljs-number">6</span>.    <span class="hljs-attr">datasource</span>: <span class="hljs-title function_ invoke__">createReadStream</span>(<span class="hljs-string">'data.csv'</span>).<span class="hljs-title function_ invoke__">pipe</span>(parser),
<span class="hljs-number">7</span>.    <span class="hljs-title function_ invoke__">onDocument</span>(doc) {
<span class="hljs-number">8</span>.      <span class="hljs-keyword">return</span> { <span class="hljs-attr">index</span>: { <span class="hljs-attr">_index</span>: <span class="hljs-string">"my_index"</span> } }
<span class="hljs-number">9</span>.    }
<span class="hljs-number">10</span>.  })

`AI写代码![](https:<span class="hljs-comment">//csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)</span>
</code></pre>
<p>这会将 CSV 文件中的行缓冲到内存中，解析为 JSON 对象，并让 helper 将结果刷新为一个或多个 HTTP 请求发送出去。这个解决方案不仅节省内存，而且阅读起来也和将整个文件加载到内存中的方法一样简单！</p>
<p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscuss.elastic.co%2Ft%2Fdec-9th-2025-en-use-the-node-js-elasticsearch-client-to-index-large-csv-files%2F382901" title="https://discuss.elastic.co/t/dec-9th-2025-en-use-the-node-js-elasticsearch-client-to-index-large-csv-files/382901" target="_blank" ref="nofollow noopener noreferrer">discuss.elastic.co/t/dec-9th-2…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[面试官问Redis主从延迟导致脏数据读怎么解决？]]></title>    <link>https://juejin.cn/post/7585686247269187593</link>    <guid>https://juejin.cn/post/7585686247269187593</guid>    <pubDate>2025-12-20T05:02:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585686247269187593" data-draft-id="7585382553290342436" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="面试官问Redis主从延迟导致脏数据读怎么解决？"/> <meta itemprop="keywords" content="后端,Redis,面试"/> <meta itemprop="datePublished" content="2025-12-20T05:02:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="想用offer打牌"/> <meta itemprop="url" content="https://juejin.cn/user/578781641968972"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            面试官问Redis主从延迟导致脏数据读怎么解决？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/578781641968972/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    想用offer打牌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T05:02:26.000Z" title="Sat Dec 20 2025 05:02:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.8;font-weight:400;font-size:16px;word-spacing:2px;letter-spacing:2px;overflow-x:hidden;color:#3e3e3e;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:1.2em;border-bottom:2px solid #ef7060;word-spacing:0!important;letter-spacing:0!important;font-size:inherit;line-height:inherit;display:block;font-weight:400;background:#ef7060;color:#fff;padding:10px;border-top-right-radius:3px;border-top-left-radius:3px;margin-right:3px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<blockquote>
<p>大家好啊，今天给大家带来一个面试常问题：redis主从数据同步延迟，担心从节点读到脏数据，怎么办？Redis 主从复制默认是<strong>异步</strong>的，这意味着在 CAP 理论中，Redis 默认保证的是 <strong>AP（可用性 + 分区容错性）</strong> ，而不是 CP（强一致性）。因此，主从延迟导致的“读脏数据”（Stale Data）在理论上无法完全避免，只能通过业务策略或技术手段来缓解</p>
</blockquote>
<h2 data-id="heading-1">Redis主从架构</h2>
<p>要先弄明白为什么redis主从架构会出现脏数据读，我们才能想出对应的缓解之策。</p>
<p>举一个栗子：redis一主二从架构，主节点负责变更数据，然后同步给从节点。从节点负责读数据。因此从这样的架构来说，出现脏数据读从理论上说是不可避免的，因为主从节点数据同步无法做到零延迟。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/beb441caceb446e68c34d30d982c22cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oOz55Sob2ZmZXLmiZPniYw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766811746&amp;x-signature=8RnX77VUEIrXkT2iFv%2B%2FZcIR00Q%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">Redis主从数据同步延迟很大的常见原因</h2>
<h3 data-id="heading-3">复制积压堆积</h3>
<p>主节点每秒处理大量写操作（如高频 SET、INCR、LPUSH 等），产生大量复制流，从节点消费速度跟不上主节点生产速度，导致复制积压堆积。</p>
<p><code>lave0</code>/<code>slave1</code> 的 <code>offset</code> 与主节点 <code>master_repl_offset</code> 的差值就是是否复制积压堆积的标准。若差值持续增大，说明复制追不上。</p>
<h3 data-id="heading-4">BigKey</h3>
<p>Redis的BigKey传输是导致主从延迟最常见的原因。
Master 传输一个几十 MB 的 List 或 Hash 给 Slave，网络被占用，解析被阻塞，导致后续命令瞬间堆积延迟。</p>
<h3 data-id="heading-5">网络与硬件</h3>
<ul>
<li>
<p><strong>同局域网:</strong> 确保主从在同一机房/局域网，跨公域网同步延迟极大。</p>
</li>
<li>
<p><strong>机器负载:</strong> 检查 Slave 节点的 AOF 重写（Rewrite）或 RDB 生成是否导致 CPU 飙升，阻塞了主线程的同步回放</p>
</li>
</ul>
<h2 data-id="heading-6">解决方法</h2>
<p>我从<strong>业务容忍度</strong>、<strong>代码逻辑</strong>和<strong>运维配置</strong>三个层面来解决这个问题。</p>
<p>关键是不要试图全局解决“0延迟”，而是根据数据敏感度拆分策略。</p>
<h3 data-id="heading-7">关键业务强制读主 (Read from Master)</h3>
<p>这是最简单且最有效的方案。对于必须准确的数据，不要走读写分离的逻辑，直接路由到 Master 节点。
比如余额，库存扣减，订单状态等等。</p>
<p>在Java中，可以类似这样写：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">if</span> (isCriticalData) {
    redisTemplate.opsForValue().get(key); <span class="hljs-comment">// 配置为主库连接</span>
} <span class="hljs-keyword">else</span> {
    redisReadReplicaTemplate.opsForValue().get(key); <span class="hljs-comment">// 配置为从库连接</span>
}
</code></pre>
<h3 data-id="heading-8">使用 <code>WAIT</code> 命令 (强一致性折衷,不推荐)</h3>
<p>Redis 支持 <code>WAIT</code> 命令，它可以阻塞当前写操作的客户端，直到写操作被同步到指定数量的从节点。</p>
<ul>
<li><strong>命令:</strong> <code>WAIT numreplicas timeout</code></li>
<li><strong>逻辑:</strong> 只有当至少 <code>numreplicas</code> 个从节点确认接收到写操作后，Master 才会返回成功。</li>
<li><strong>代价:</strong> <strong>严重牺牲写性能</strong>。如果从节点故障或网络抖动，写操作会阻塞直到超时。</li>
<li><strong>适用:</strong> 极其重要且写频率较低的数据</li>
</ul>
<h3 data-id="heading-9">业务层校验 "版本号" 或 "时间戳"</h3>
<p>如果你必须读从库，但又想知道数据是否过期：</p>
<ol>
<li><strong>写入时:</strong> 在 Value 中写入一个时间戳或版本号 <code>v1</code>。</li>
<li><strong>另外存储:</strong> 将该 Key 的最新版本号 <code>v1</code> 存入一个高可用的缓存（如 Zookeeper、Etcd 或 Redis Master 的一个专用 Key）。</li>
<li><strong>读取时:</strong> 读取从库数据，对比其中的版本号与 Master/中心存储的版本号。如果不一致，说明延迟了，触发<strong>回源读主库</strong></li>
</ol>
<h3 data-id="heading-10">杜绝BigKey等</h3>
<p>还有很多策略，比如代码层我们要拆分bigkey，监控主从复制偏移量等等</p>
<h2 data-id="heading-11">总结</h2>
<p>我们要根据业务敏感度来解决这个问题，根据数据敏感度来拆分策略：</p>

























<table><thead><tr><th><strong>场景</strong></th><th><strong>示例</strong></th><th><strong>推荐策略</strong></th></tr></thead><tbody><tr><td><strong>强一致性</strong></td><td>余额、库存扣减、订单状态</td><td><strong>强制读主库 (Master)</strong></td></tr><tr><td><strong>最终一致性</strong></td><td>用户昵称、非实时排行榜、历史记录</td><td><strong>读从库 + 监控/重试</strong></td></tr><tr><td><strong>高敏感度</strong></td><td>秒杀资格、配置开关</td><td><strong>使用 <code>WAIT</code> 命令或分布式锁</strong></td></tr></tbody></table>
<ul>
<li>
<p><strong>最高优先级:</strong> 梳理业务。将<strong>必须强一致</strong>的读请求（如金额），在代码层面指定<strong>直接读 Master</strong>。这是最稳妥的。</p>
</li>
<li>
<p><strong>次优先级:</strong> 检查是否有 <strong>BigKey</strong> 阻塞了同步链路。</p>
</li>
<li>
<p><strong>可选策略:</strong> 如果必须读从库且要求较高一致性，实现一个简单的<strong>监控熔断机制</strong>（通过 Java/Go 定时检查 Offset），自动隔离高延迟的从节点</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零搭一个 Vue 小家：用 Vite + 路由轻松入门现代前端开发]]></title>    <link>https://juejin.cn/post/7585400495683665962</link>    <guid>https://juejin.cn/post/7585400495683665962</guid>    <pubDate>2025-12-20T04:08:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585400495683665962" data-draft-id="7585400495683026986" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零搭一个 Vue 小家：用 Vite + 路由轻松入门现代前端开发"/> <meta itemprop="keywords" content="Vue.js,前端框架,面试"/> <meta itemprop="datePublished" content="2025-12-20T04:08:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鱼鱼块"/> <meta itemprop="url" content="https://juejin.cn/user/4302802432307224"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零搭一个 Vue 小家：用 Vite + 路由轻松入门现代前端开发
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4302802432307224/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鱼鱼块
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T04:08:42.000Z" title="Sat Dec 20 2025 04:08:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从零开始，轻松走进 Vue 的世界：一个“全家桶”小项目的搭建之旅</h2>
<p>如果你刚刚接触前端开发，听到“Vue”、“Vite”、“路由”这些词时是不是有点懵？别担心！我们可以把写代码想象成<strong>搭积木、装修房子、甚至安排一场家庭旅行</strong>。今天，我们就通过一个名为 <code>all-vue</code> 的小项目，带你一步步理解现代 Vue 应用是怎么“搭起来”的。</p>
<hr/>
<h3 data-id="heading-1">🏠 第一步：选好地基——用 Vite 快速建项目</h3>
<h4 data-id="heading-2"><strong>什么是vite？</strong></h4>
<blockquote>
<p><strong>Vite</strong>（法语，意为“快”）是一个由 Vue.js 作者 <strong>尤雨溪（Evan You）</strong> 主导开发的现代化前端构建工具。它旨在解决传统打包工具（如 Webpack）在开发阶段启动慢、热更新（HMR）延迟高等问题，提供极速的开发体验。</p>
</blockquote>
<p>想象你要盖一栋房子。传统方式可能要先打地基、砌砖、铺电线……繁琐又耗时。而 <strong>Vite</strong> 就像一位超级高效的建筑承包商，你只要说一句：“我要一个 Vue 房子”，它立刻给你搭好框架，连水电都通好了！</p>
<p>在终端里运行：</p>
<pre><code class="hljs language-sql" lang="sql">npm init vite<span class="hljs-variable">@latest</span> <span class="hljs-keyword">all</span><span class="hljs-operator">-</span>vue <span class="hljs-comment">-- --template vue</span>
</code></pre>
<p>几秒钟后，你就得到了一个结构清晰的项目目录。其中最关键的是：</p>
<ul>
<li><code>index.html</code>：这是你房子的“大门”，浏览器一打开就看到它。</li>
<li><code>src/main.js</code>：这是整栋房子的“总开关”，负责启动整个应用。</li>
<li><code>src/App.vue</code>：这是“客厅”，所有房间（页面）都要从这里进出。</li>
</ul>
<p>Vite 的优势在于<strong>快</strong>——修改代码后，浏览器几乎瞬间刷新，就像你换了个沙发，家人马上就能坐上去试舒服不舒服。</p>
<hr/>
<h3 data-id="heading-3">🏗️ 第二步：认识整栋楼——项目结构概览</h3>
<p>运行 <code>npm init vite@latest all-vue -- --template vue</code> 后，你会得到这样一栋“数字公寓”：</p>
<p>项目结构简略预览：</p>
<pre><code class="hljs language-bash" lang="bash">/all-vue
├── public/            <span class="hljs-comment"># 公共资源（如 logo.png）</span>
├── src/
│   ├── assets/        <span class="hljs-comment"># 图片、字体等静态资源</span>
│   ├── components/    <span class="hljs-comment"># 可复用的小部件（按钮、卡片等）</span>
│   ├── views/         <span class="hljs-comment"># 独立页面（首页、关于页等）</span>
|   |     |—— About.vue <span class="hljs-comment"># 关于页面的Vue组件</span>
|   |     |—— Home.vue <span class="hljs-comment"># 主页的vue组件</span>
│   ├── router/        <span class="hljs-comment"># 室内导航系统</span>
|   |     |—— index.js <span class="hljs-comment"># 路由总控</span>
│   ├── App.vue        <span class="hljs-comment"># 中央控制台（客厅）</span>
│   └── main.js        <span class="hljs-comment"># 智能钥匙</span>
├── index.html         <span class="hljs-comment"># 入户大门</span>
├── package.json       <span class="hljs-comment"># 公寓的“住户手册 + 装修清单”</span>
└── vite.config.js     <span class="hljs-comment"># 建筑规范说明书</span>
</code></pre>
<p>其中，<code>package.json</code> 就像这栋楼的<strong>住户手册 + 装修材料清单</strong>。打开它，你会看到：</p>
<pre><code class="hljs language-perl" lang="perl">{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"all-vue"</span>,
  <span class="hljs-string">"version"</span>: <span class="hljs-string">"0.0.0"</span>,
  <span class="hljs-string">"scripts"</span>: {
    <span class="hljs-string">"dev"</span>: <span class="hljs-string">"vite"</span>,
    <span class="hljs-string">"build"</span>: <span class="hljs-string">"vite build"</span>,
    <span class="hljs-string">"preview"</span>: <span class="hljs-string">"vite preview"</span>
  },
  <span class="hljs-string">"dependencies"</span>: {
    <span class="hljs-string">"vue"</span>: <span class="hljs-string">"^3.4.0"</span>,
    <span class="hljs-string">"vue-router"</span>: <span class="hljs-string">"^4.3.0"</span>
  },
  <span class="hljs-string">"devDependencies"</span>: {
    <span class="hljs-string">"@vitejs/plugin-vue"</span>: <span class="hljs-string">"^5.0.0"</span>,
    <span class="hljs-string">"vite"</span>: <span class="hljs-string">"^5.0.0"</span>
  }
}
</code></pre>
<ul>
<li><strong><code>dependencies</code></strong>：这是“入住必需品”，比如 Vue 框架本身、路由系统——没有它们，房子没法正常运转；</li>
<li><strong><code>devDependencies</code></strong>：这是“装修工具包”，只在开发时用（比如 Vite 构建工具），住户入住后就不需要了；</li>
<li><strong><code>scripts</code></strong>：这是“快捷指令”，比如 <code>npm run dev</code> 就是“启动预览模式”，<code>npm run build</code> 是“打包交付”。</li>
</ul>
<p>有了这份清单，任何开发者都能一键还原你的整套环境——就像照着宜家说明书组装家具一样可靠。</p>
<hr/>
<h3 data-id="heading-4">🚪 第三步：认识“大门”——index.html 的两个秘密</h3>
<p>虽然现代 Vue 应用的逻辑几乎全在 JavaScript 和 <code>.vue</code> 文件里，但一切的起点，其实是这个看似简单的 <code>index.html</code>：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"icon"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"image/svg+xml"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/vite.svg"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>all-vue<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/src/main.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>别小看这十几行代码，它藏着两个关键设计：</p>
<h4 data-id="heading-5">🔌 1. <code>&lt;div id="app"&gt;&lt;/div&gt;</code>：Vue 的“插座”</h4>
<p>你可以把它想象成墙上预留的一个<strong>智能插座面板</strong>。它本身空无一物，但一旦通电（Vue 应用启动），就会自动“投影”出整个用户界面。</p>
<p>在 <code>main.js</code> 中，我们这样写：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<p>这句话的意思就是：“请把 <code>App.vue</code> 这个‘客厅’的内容，投射到 id 为 <code>app</code> 的那个插座上。”<br/>
没有这个插座，Vue 再厉害也无处施展；有了它，动态内容才能在静态 HTML 中生根发芽。</p>
<h4 data-id="heading-6">⚡ 2. <code>&lt;script type="module" src="/src/main.js"&gt;&lt;/script&gt;</code>：原生 ES 模块的魔法</h4>
<p>注意这里的 <code>type="module"</code>。这是现代浏览器支持的一种<strong>原生模块加载方式</strong>。传统脚本是“一股脑全塞进来”，而模块化脚本则像快递包裹——每个文件独立打包，按需引用，互不干扰。</p>
<p>Vite 正是利用了这一特性，<strong>无需打包即可直接在浏览器中运行模块化的代码</strong>。这意味着：</p>
<ul>
<li>开发时启动飞快（冷启动快）；</li>
<li>修改文件后热更新极快（HMR 精准替换）；</li>
<li>代码结构清晰，符合现代工程规范。</li>
</ul>
<p>所以，<code>index.html</code> 不仅是入口，更是连接<strong>静态 HTML 世界</strong>与<strong>动态 Vue 世界</strong>的桥梁。</p>
<hr/>
<h3 data-id="heading-7">🔑 第四步：打造“钥匙”——main.js 如何启动应用</h3>
<p>有了大门，就得有钥匙。<code>main.js</code> 就是这把精密的电子钥匙，负责激活整套智能家居系统：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>
<span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">'./router'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./style.css'</span>

<span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>).<span class="hljs-title function_">use</span>(router).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<p>这段代码做了三件事，环环相扣：</p>
<ol>
<li><strong>引入核心模块</strong>：从 Vue 拿到“造房子”的工具（<code>createApp</code>），从本地拿到“客厅设计图”（<code>App.vue</code>）和“导航系统”（<code>router</code>）；</li>
<li><strong>组装系统</strong>：用 <code>.use(router)</code> 把导航插件装进主程序；</li>
<li><strong>插入插座</strong>：<code>.mount('#app')</code> 表示：“请把这套系统通电安装在 <code>index.html</code> 中 id 为 <code>app</code> 的插座上。”</li>
</ol>
<p>没有这把钥匙，再漂亮的客厅也只是一堆图纸；有了它，整个房子才真正“活”起来。</p>
<hr/>
<h3 data-id="heading-8">💡 第五步：点亮客厅——根组件 App.vue</h3>
<p>钥匙转动，门开了，我们走进 <code>App.vue</code> —— 这是所有功能的总控中心：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">router-link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/"</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">router-link</span>&gt;</span> |
      <span class="hljs-tag">&lt;<span class="hljs-name">router-link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/about"</span>&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">router-link</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">router-view</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<blockquote>
<p>多人一开始会直接写 <code>&lt;div&gt;Home | About&lt;/div&gt;</code>，但这只是静态文字。要让它们变成可点击的导航，就得用 Vue Router 提供的 <code>&lt;router-link&gt;</code> 组件。</p>
</blockquote>
<p>这里有两个核心元素：</p>
<ul>
<li><strong><code>&lt;router-link&gt;</code></strong> ：智能门把手，点击不刷新页面，只切换内容；</li>
<li><strong><code>&lt;router-view /&gt;</code></strong> ：魔法地板，当前该展示哪个房间，它就实时投影出来。</li>
</ul>
<p>虽然原始文件只写了 <code>HomeAbout</code>，但正确的写法应如上所示——让文字变成可交互的导航。</p>
<hr/>
<h3 data-id="heading-9">🗺️ 第六步：装上导航系统——配置 Vue Router</h3>
<p>路由，就像是你家里的<strong>智能导航系统</strong>。没有它，你只能待在客厅；有了它，你才能自由穿梭于各个房间。</p>
<p>我们在 <code>src/router/index.js</code> 中这样配置：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { createRouter, createWebHashHistory } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Home</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../views/Home.vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">About</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../views/About.vue'</span>

<span class="hljs-keyword">const</span> routes = [
  { <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Home'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">Home</span> },
  { <span class="hljs-attr">path</span>: <span class="hljs-string">'/about'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'About'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">About</span> }
]

<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createRouter</span>({
  <span class="hljs-attr">history</span>: <span class="hljs-title function_">createWebHashHistory</span>(),
  routes
})

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router
</code></pre>
<p>这段代码的意思是：</p>
<ul>
<li>当用户访问 <code>/</code>（也就是主页），就显示 <code>Home.vue</code> 这个房间；</li>
<li>当用户访问 <code>/about</code>，就带他去 <code>About.vue</code> 那个房间。</li>
</ul>
<p>注意这里用了 <code>createWebHashHistory()</code>，这意味着网址会变成 <code>http://localhost:5173/#/about</code>。那个 <code>#</code> 就像门牌号里的“分隔符”，告诉系统：“后面的部分是内部房间号，不是新地址”。</p>
<hr/>
<h3 data-id="heading-10">🛋️ 第七步：布置房间——编写页面组件</h3>
<p>现在，我们来装修两个房间。</p>
<h4 data-id="heading-11">首页（Home.vue）</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<h4 data-id="heading-12">关于页（About.vue）</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>每个 <code>.vue</code> 文件都是一个自包含的“功能单元”：有自己的结构（template）、逻辑（script）和样式（style）。它们彼此隔离，却能通过路由无缝切换。</p>
<hr/>
<h3 data-id="heading-13">🎨 第八步：美化家园——全局样式 style.css</h3>
<p>虽然功能齐备，但房子还是灰扑扑的。这时候，<code>style.css</code> 就派上用场了。你可以在这里写：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">body</span> {
  <span class="hljs-attribute">font-family</span>: <span class="hljs-string">'Arial'</span>, sans-serif;
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f5f5f5</span>;
}

<span class="hljs-selector-tag">nav</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">1rem</span>;
  <span class="hljs-attribute">background</span>: white;
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">4px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>);
}
</code></pre>
<p>就像给墙壁刷漆、给地板打蜡，让整个家更温馨舒适。</p>
<hr/>
<h3 data-id="heading-14">▶️ 最后一步：启动你的 Vue 家园！</h3>
<p>现在，所有“装修材料”都已就位——地基打好了（Vite 项目）、大门装上了（<code>index.html</code>）、钥匙配好了（<code>main.js</code>）、客厅布置妥当（<code>App.vue</code>），连房间（<code>Home.vue</code>、<code>About.vue</code>）和导航系统（Vue Router）也都调试完毕。是时候打开电闸，点亮整栋房子了！</p>
<p>请在终端（命令行）中依次执行以下两条命令（确保你已在 <code>all-vue</code> 项目目录下）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 第一步：安装“住户手册”里列出的所有依赖（比如 Vue 和路由）</span>
npm install

<span class="hljs-comment"># 第二步：启动开发服务器——相当于按下“智能家居总开关”</span>
npm run dev
</code></pre>
<p>运行成功后，你会看到类似这样的提示：</p>
<pre><code class="hljs language-arduino" lang="arduino">  VITE v5<span class="hljs-number">.0</span><span class="hljs-number">.0</span>  ready in <span class="hljs-number">320</span> ms

  ➜  Local:   http:<span class="hljs-comment">//localhost:5173/</span>
  ➜  Network: use --host to expose
</code></pre>
<p>这时，只需打开浏览器，访问 <strong><a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A5173%2F" target="_blank" title="http://localhost:5173/" ref="nofollow noopener noreferrer">http://localhost:5173/</a></strong> （端口号可能略有不同），就能看到你的 Vue 小家啦！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/440dcba58617403380171870481fdee4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG86bG85Z2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766808522&amp;x-signature=PS6EH4QoNScSUb1Hfyz%2Ff%2FzfYA0%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>点击 <strong>Home</strong>，客厅中央显示 “Home”；</li>
<li>点击 <strong>About</strong>，瞬间切换到 “About” 页面——<strong>全程无需刷新</strong>，就像在家自由走动一样丝滑。</li>
</ul>
<p>🎉 <strong>恭喜你！你不仅看懂了代码，还亲手让它跑起来了！</strong></p>
<p>这不再是一堆抽象的文件，而是一个真正能交互的 Web 应用。你已经完成了从“零”到“一”的飞跃——而这，正是所有伟大项目的起点。</p>
<hr/>
<h3 data-id="heading-15">🧩 总结：Vue 项目的“生活化”逻辑链</h3>
<p>让我们用一次智能家居入住体验来串起全过程：</p>
<ol>
<li><strong>Vite 是开发商</strong>：提供标准化精装修样板间；</li>
<li><strong>index.html 是入户门</strong>：设有智能插座（<code>#app</code>）和模块化接线口（<code>type="module"</code>）；</li>
<li><strong>main.js 是电子钥匙</strong>：插入后激活整套系统；</li>
<li><strong>App.vue 是中央控制台</strong>：集成导航与内容展示区；</li>
<li><strong>Vue Router 是室内导航图</strong>：定义各房间路径；</li>
<li><strong>Home.vue / About.vue 是功能房间</strong>：各自独立，按需进入；</li>
<li><strong>style.css 是全屋软装方案</strong>：统一视觉风格。</li>
</ol>
<h3 data-id="heading-16">✨ 写在最后：你已经站在 Vue 的门口</h3>
<p>这个 <code>all-vue</code> 项目虽小，却包含了现代 Vue 应用的核心骨架：<strong>组件化 + 路由 + 响应式 + 工程化构建</strong>。你不需要一开始就懂所有细节，就像学骑自行车，先扶稳车把，再慢慢蹬脚踏。</p>
<p>当你运行 <code>npm run dev</code>，看到浏览器里出现“Home”和“About”两个链接，并能自由切换时——恭喜你，你已经成功迈出了 Vue 开发的第一步！</p>
<p>接下来，你可以：</p>
<ul>
<li>在 Home 里加一张图片；</li>
<li>在 About 里写一段自我介绍；</li>
<li>用 CSS 让导航栏变彩色；</li>
<li>甚至添加第三个页面……</li>
</ul>
<p>编程不是魔法，而是一步步搭建的过程。而你，已经搭好了第一块积木。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android View框架概览]]></title>    <link>https://juejin.cn/post/7585382553290375204</link>    <guid>https://juejin.cn/post/7585382553290375204</guid>    <pubDate>2025-12-20T04:08:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585382553290375204" data-draft-id="7585400495683616810" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android View框架概览"/> <meta itemprop="keywords" content="Android,计算机图形学"/> <meta itemprop="datePublished" content="2025-12-20T04:08:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="StarShip"/> <meta itemprop="url" content="https://juejin.cn/user/3790771820172391"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android View框架概览
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3790771820172391/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    StarShip
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T04:08:17.000Z" title="Sat Dec 20 2025 04:08:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、整体分层总览</h2>
<p>先看一个“从 App 到 系统服务 到 显示系统”的文字架构图：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[ 应用进程 App Process ]</span>
    ├─ Activity
    │    └─ Window (PhoneWindow)
    │         └─ DecorView (根 ViewGroup)
    │               └─ ViewGroup ... View 树
    ├─ ViewRootImpl   (桥梁：View世界 ↔ Window/Surface世界)
    ├─ WindowManager  (Framework 接口，实现在 app 进程)
    ├─ Handler / Looper (UI线程消息循环)
    ├─ Choreographer  (基于 VSync 调度绘制/动画)
    ├─ <span class="hljs-selector-tag">Canvas</span>         (绘图 API 抽象，底层由 Skia 实现)
    ├─ Skia / HWUI    (<span class="hljs-number">2</span>D 图形引擎，生成 GPU/CPU 绘制命令)
    ├─ OpenGL ES (或 Vulkan) (与 GPU 交互接口)
    └─ Surface / SurfaceView / TextureView (图形缓冲队列的“端口”)

<span class="hljs-selector-attr">[ System Server 进程 ]</span>
    ├─ WindowManagerService (WMS)
    │    └─ 管理 Window 的层级、位置、可见、焦点等
    └─ SurfaceFlinger (图形合成服务，不在此问题核心，略提)

<span class="hljs-selector-attr">[ 显示子系统 / HAL / 驱动 ]</span>
    ├─ Hardware Composer (HWC)
    ├─ Gralloc / GPU 驱动
    └─ 显示驱动 / 屏幕
</code></pre>
<p>记住一件事：Activity 只管“想显示什么 View 树”，真正的窗口、Surface 和显示，都是 Window / WMS / Surface / ViewRootImpl 在干活。</p>
<h2 data-id="heading-1">二、UI 树相关核心概念：Activity → Window → DecorView → ViewGroup / View</h2>
<ol>
<li>
<h3 data-id="heading-2">Activity</h3>
</li>
</ol>
<ul>
<li>
<p>职责：</p>
<ul>
<li>管理一个屏幕界面的生命周期：<code>onCreate</code> / <code>onStart</code> / <code>onResume</code> 等；</li>
<li>通过 <code>setContentView()</code> 指定要显示的布局（View 树）。</li>
</ul>
</li>
<li>
<p>关键点：Activity 本身 不直接持有视图树，而是通过 Window 来间接管理 UI。</p>
</li>
</ul>
<ol start="2">
<li>
<h3 data-id="heading-3">Window &amp; WindowManager</h3>
</li>
</ol>
<ul>
<li>
<p>Window（通常是 PhoneWindow）</p>
<ul>
<li>
<p>Activity 调用 <code>getWindow()</code> 得到的就是它；</p>
</li>
<li>
<p>代表的是当前 Activity 的“窗口抽象”，负责管理：</p>
<ul>
<li>标题栏、状态栏占位、导航栏区域（需要时）；</li>
<li>内容视图（<code>setContentView()</code> 塞进去的 View 树）。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>WindowManager</p>
<ul>
<li>是一个 接口，应用通过它 添加/更新/删除 Window；</li>
<li>在应用进程中，<code>WindowManager</code> 的实现是 <code>WindowManagerImpl</code>；</li>
<li>内部最终会通过 Binder 跟系统进程的 WindowManagerService (WMS) 通信。</li>
</ul>
</li>
</ul>
<ol start="3">
<li>
<h3 data-id="heading-4">DecorView</h3>
</li>
</ol>
<ul>
<li>
<p>DecorView 是 整个窗口的根 View，是一个 特殊的 ViewGroup：</p>
<ul>
<li>顶层是窗口装饰（状态栏占位、标题栏、ActionBar 等）；</li>
<li>中间是内容区域：<code>android.R.id.content</code> 对应的区域；</li>
<li>Activity 的 <code>setContentView(layout)</code> 实际上是把你的布局添加到 DecorView 的内容区域。</li>
</ul>
</li>
<li>
<p>结构示意：</p>
</li>
</ul>
<pre><code class="hljs language-scss" lang="scss">DecorView (extends FrameLayout)
    ├─ StatusBar 占位（可选）
    ├─ TitleBar / Toolbar（可选）
    └─ contentParent (id=android.R.id.content)
          └─ 你的布局根 ViewGroup (LinearLayout / ConstraintLayout / ...)
                └─ 子 View / ViewGroup ...
</code></pre>
<ol start="4">
<li>
<h3 data-id="heading-5">View &amp; ViewGroup</h3>
</li>
</ol>
<ul>
<li>
<p>View</p>
<ul>
<li>
<p>UI 的最小单元：TextView、Button、ImageView 等都继承自它；</p>
</li>
<li>
<p>负责：</p>
<ul>
<li>测量：<code>onMeasure()</code>；</li>
<li>布局位置（由父布局决定）：<code>onLayout()</code>；</li>
<li>绘制：<code>onDraw(Canvas canvas)</code>。</li>
</ul>
</li>
</ul>
</li>
</ul>
<ol start="5">
<li>
<h3 data-id="heading-6">ViewGroup</h3>
</li>
</ol>
<ul>
<li>
<p>继承自 View，是各种布局容器的基类（LinearLayout、RelativeLayout、ConstraintLayout 等）；</p>
</li>
<li>
<p>负责：</p>
<ul>
<li>管理子 View 的添加/删除；</li>
<li>在 <code>onLayout()</code> 中排列子 View</li>
</ul>
</li>
</ul>
<h2 data-id="heading-7">三、ViewRootImpl：Java View 世界 ↔ Window/Surface 世界的桥梁</h2>
<p>核心：ViewRootImpl 把 View 树绑定到一个 Window/Surface 上，并驱动 measure/layout/draw。</p>
<ol>
<li>
<h3 data-id="heading-8">ViewRootImpl 是谁创建的？</h3>
</li>
</ol>
<ul>
<li>
<p>当 Activity 第一次 <code>setContentView()</code>，并通过 <code>WindowManager.addView(DecorView, params)</code> 时：</p>
<ul>
<li><code>WindowManagerGlobal</code> 会为这个 DecorView 创建一个 ViewRootImpl 实例；</li>
<li>并把 DecorView 作为 ViewRootImpl 的“根 View”。</li>
</ul>
</li>
</ul>
<ol start="2">
<li>
<h3 data-id="heading-9">ViewRootImpl 的职责</h3>
</li>
</ol>
<ul>
<li>
<p>接收来自 WMS 的回调（比如窗口尺寸改变、可见性改变等）；</p>
</li>
<li>
<p>在 UI 线程上驱动 View 树的三大流程：</p>
<ul>
<li>
<p><code>performTraversals()</code>：</p>
<ul>
<li><code>performMeasure()</code> → 根 View 的 <code>onMeasure()</code> 链；</li>
<li><code>performLayout()</code> → 根 View 的 <code>onLayout()</code> 链；</li>
<li><code>performDraw()</code> → 根 View 的 <code>draw()</code> 链。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>管理与 Surface 的绑定（通过 <code>SurfaceHolder</code>/<code>Surface</code>，与底层 BufferQueue 对接）；</p>
</li>
<li>
<p>把 <code>invalidate()</code> / <code>requestLayout()</code> 产生的重绘/重布局请求归一，在合适的 VSync 时机刷新。</p>
</li>
</ul>
<ol start="3">
<li>
<h3 data-id="heading-10">ViewRootImpl、Window、WMS 的关系图</h3>
</li>
</ol>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[ Activity ]</span>
    └─ <span class="hljs-selector-attr">[ Window (PhoneWindow) ]</span>
            └─ <span class="hljs-selector-attr">[ DecorView (根 ViewGroup) ]</span>

<span class="hljs-selector-attr">[ WindowManagerImpl ]</span>  (app 进程)
    └─ <span class="hljs-built_in">addView</span>(DecorView, params)
         └─ <span class="hljs-selector-attr">[ ViewRootImpl ]</span> ←→ <span class="hljs-selector-attr">[ WMS (系统进程) ]</span>
              └─ 持有 DecorView 作为 mView
              └─ 持有 Surface (mSurface)
              └─ 负责 measure/layout/draw
</code></pre>
<h2 data-id="heading-11">四、WindowManagerService（WMS）：系统级的窗口管理者</h2>
<ul>
<li>
<p>运行在 System Server 进程；</p>
</li>
<li>
<p>管理整个系统所有窗口（应用 Window、系统栏、Dialog 等）的：</p>
<ul>
<li>Z 轴顺序（谁在上谁在下）；</li>
<li>尺寸/位置/可见性；</li>
<li>焦点、输入事件目标窗口等。</li>
</ul>
</li>
<li>
<p><code>WindowManager</code>（应用侧）所有操作最终都会通过 Binder 调用 WMS，例如：</p>
<ul>
<li><code>addView(...)</code> → <code>WMS.addWindow(...)</code>；</li>
<li><code>updateViewLayout(...)</code> → <code>WMS.relayoutWindow(...)</code>；</li>
<li><code>removeView(...)</code> → <code>WMS.removeWindow(...)</code>。</li>
</ul>
</li>
<li>
<p>WMS 决定每个 Window 拥有一个什么样的 Surface（大小、格式等），然后通知对应的 ViewRootImpl 进行渲染。</p>
</li>
</ul>
<h2 data-id="heading-12">五、Surface / Canvas / SurfaceView：图像输出的“终端”</h2>
<ol>
<li>
<h3 data-id="heading-13">Surface：显示的“画布缓冲管道”--数据驱动，以画布数据为中心，承上启下了</h3>
</li>
</ol>
<ul>
<li>
<p>Surface 本质上是一个与底层 BufferQueue 绑定的对象：</p>
<ul>
<li>上层（应用 / RenderThread / SurfaceView 的绘制线程）作为 Producer 往里写图像；</li>
<li>下层（SurfaceFlinger）作为 Consumer 从中取图像做合成。</li>
</ul>
</li>
<li>
<p>每个窗口通常对应一个 Surface：</p>
<ul>
<li>ViewRootImpl 通过 <code>mSurface</code> 把 View 的绘制结果输出到这个 Surface。</li>
</ul>
</li>
</ul>
<ol start="2">
<li>
<h3 data-id="heading-14">Canvas：提供给 View 使用的二维绘图接口</h3>
</li>
</ol>
<ul>
<li>
<p>在 <code>View#onDraw(Canvas canvas)</code> 里使用；</p>
</li>
<li>
<p>Canvas 底层其实是 调用 Skia：</p>
<ul>
<li>软件渲染：Skia 在 CPU 内存里画；</li>
<li>硬件加速：Skia 生成 GPU 绘图指令（最终通过 OpenGL ES/Vulkan 执行）。</li>
</ul>
</li>
</ul>
<ol start="3">
<li>
<h3 data-id="heading-15">SurfaceView：一个“特殊的 View”，自己有独立 Surface</h3>
</li>
</ol>
<ul>
<li>
<p>普通 View：</p>
<ul>
<li>最终都绘制到所在窗口的 同一个 Surface；</li>
<li>先由 UI 渲染生成一个层，之后由 SurfaceFlinger 合成。</li>
</ul>
</li>
<li>
<p>SurfaceView：</p>
<ul>
<li>
<p>内部会创建一个 独立的 Surface（通常是直接由系统合成到屏幕，支持视频、游戏等高性能场景）；</p>
</li>
<li>
<p>其子 View 显示区域只是一个“洞”：</p>
<ul>
<li>Window 的主 Surface 挖一个透明区域；</li>
<li>SurfaceView 专用的 Surface 显示在这个洞里。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>特点：</p>
<ul>
<li>支持 单独的绘制线程（后台线程），不占用 UI 线程；</li>
<li>常用于：视频播放、相机预览、需要自定义渲染的游戏。</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[ Window 的主 Surface ]</span>      <span class="hljs-selector-attr">[ SurfaceView 专用 Surface ]</span>
    ┌──────────────────┐       ┌──────────────────┐
    │ 其他普通 View 绘制 │       │   视频/游戏内容    │
    │   (UI 线程绘制)   │       │ (渲染线程绘制)     │
    │  <span class="hljs-selector-attr">[挖一个洞区域]</span>   │◀─────▶│ 对应屏幕某块区域   │
    └──────────────────┘       └──────────────────┘
</code></pre>
<h2 data-id="heading-16">六、消息、节奏与动画：Handler / Choreographer / VSync</h2>
<ol>
<li>
<h3 data-id="heading-17">Handler：UI 线程的消息驱动机制</h3>
</li>
</ol>
<ul>
<li>
<p>UI 线程有一个 Looper + MessageQueue：</p>
<ul>
<li>Handler 是发送/处理消息的工具；</li>
</ul>
</li>
<li>
<p>ViewRootImpl 的很多操作都是通过 Handler 投递到 UI 线程执行：</p>
<ul>
<li>比如 <code>requestLayout()</code> / <code>invalidate()</code> 最终会排队一个“重新测量/布局/绘制”的消息。</li>
</ul>
</li>
</ul>
<ol start="2">
<li>
<h3 data-id="heading-18">Choreographer：基于 VSync 的统一调度器</h3>
</li>
</ol>
<ul>
<li>
<p>Choreographer 挂在 UI 线程上，使用 Handler 驱动；</p>
</li>
<li>
<p>每次屏幕发出一帧 VSync 信号 时：</p>
<ul>
<li>
<p>Choreographer 收到回调，在 同一个 frame 内按顺序触发：</p>
<ul>
<li>输入处理（Input）；</li>
<li>动画（Animation）；</li>
<li>View 树绘制（Traversal → ViewRootImpl#doTraversal）。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>作用：保证 UI 绘制和动画跟屏幕刷新同步，减少撕裂与抖动。</p>
</li>
</ul>
<ol start="3">
<li>
<h3 data-id="heading-19">三者关系图（UI 线程上）：</h3>
</li>
</ol>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[VSync 信号]</span> ──► <span class="hljs-selector-attr">[Choreographer#doFrame()]</span>
                      │
                      ├─ 处理输入事件
                      ├─ 计算动画 (ValueAnimator, ViewPropertyAnimator...)
                      └─ 调用 ViewRootImpl<span class="hljs-selector-class">.scheduleTraversals</span>()
                               │
                               └─ Handler<span class="hljs-selector-class">.post</span>(...) -&gt; <span class="hljs-built_in">doTraversal</span>()
                                       ├─ <span class="hljs-built_in">measure</span>()
                                       ├─ <span class="hljs-built_in">layout</span>()
                                       └─ <span class="hljs-built_in">draw</span>()  (生成绘制命令 / DisplayList)
</code></pre>
<h2 data-id="heading-20">七、Skia / OpenGL ES：View 的绘制到底是怎么画出来的？</h2>
<ol>
<li>
<h3 data-id="heading-21">Skia：2D 图形引擎</h3>
</li>
</ol>
<ul>
<li>
<p>Android 中 <code>Canvas</code> 的真正执行者；</p>
</li>
<li>
<p>提供：</p>
<ul>
<li>画线、画矩形、画圆、画文本；</li>
<li>画 Bitmap、裁剪、变换等；</li>
</ul>
</li>
<li>
<p>在 Android 的 硬件加速 UI 管线（HWUI） 中：</p>
<ul>
<li>Skia 不会直接在 CPU 内存画像素；</li>
<li>而是把绘制操作转换为 GPU 命令，交给 OpenGL ES/Vulkan 执行。</li>
</ul>
</li>
</ul>
<ol start="2">
<li>
<h3 data-id="heading-22">OpenGL ES：与 GPU 对话的 API</h3>
</li>
</ol>
<ul>
<li>
<p>图形硬件标准接口；</p>
</li>
<li>
<p>在 Android 中：</p>
<ul>
<li>
<p>Skia 会调用 OpenGL ES，实现：</p>
<ul>
<li>几何变换（平移/缩放/旋转）；</li>
<li>纹理绘制（View 内容作为纹理贴在矩形上）；</li>
<li>alpha 混合、阴影、圆角等效果。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>GLSurfaceView / 游戏引擎 等也会直接使用 OpenGL ES 绘制自己的内容到 Surface。</p>
</li>
</ul>
<ol start="3">
<li>
<h3 data-id="heading-23">View 绘制调用链（硬件加速时，简化版）</h3>
</li>
</ol>
<pre><code class="hljs language-scss" lang="scss">ViewRootImpl<span class="hljs-selector-class">.performDraw</span>()
    └─ DecorView<span class="hljs-selector-class">.draw</span>(canvas)
         └─ 各 View 的 <span class="hljs-built_in">onDraw</span>(canvas)
               └─ 调用 <span class="hljs-selector-tag">Canvas</span> API (drawRect/drawText/drawBitmap...)
                     └─ <span class="hljs-selector-tag">Canvas</span> → Skia
                           └─ Skia 生成 GPU 命令
                               └─ 通过 OpenGL ES / Vulkan 调用 GPU
                                   └─ GPU 在 Surface 对应的 buffer 中生成最终像素
</code></pre>
<h2 data-id="heading-24">八、综合关系大图（简化版）</h2>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-attr">[ Activity ]</span>
    └─ 持有 <span class="hljs-selector-attr">[Window (PhoneWindow)]</span>
            └─ <span class="hljs-selector-attr">[DecorView: 根 ViewGroup]</span>
                    └─ <span class="hljs-selector-tag">ViewGroup</span> / <span class="hljs-selector-tag">View</span> 树
                          └─ <span class="hljs-selector-tag">onDraw</span>(Canvas) → <span class="hljs-selector-tag">Canvas</span> → <span class="hljs-selector-tag">Skia</span> → <span class="hljs-selector-tag">OpenGL</span> <span class="hljs-selector-tag">ES</span>

<span class="hljs-selector-attr">[ WindowManager ]</span>
    └─ <span class="hljs-selector-tag">addView</span>(DecorView, params)
          └─ 创建 <span class="hljs-selector-attr">[ViewRootImpl]</span>
                ├─ 持有 <span class="hljs-selector-tag">DecorView</span>
                ├─ 持有 <span class="hljs-selector-tag">Surface</span>
                ├─ 通过 <span class="hljs-selector-tag">Handler</span> 在 <span class="hljs-selector-tag">UI</span> 线程 <span class="hljs-selector-tag">scheduleTraversals</span>()
                └─ 和 <span class="hljs-selector-attr">[WMS]</span> 通信（窗口大小/位置/<span class="hljs-selector-tag">Surface</span> 等）

<span class="hljs-selector-attr">[ Handler / Looper / Choreographer ]</span>
    ├─ <span class="hljs-selector-tag">Looper</span> 负责 <span class="hljs-selector-tag">UI</span> 线程消息循环
    ├─ <span class="hljs-selector-tag">Handler</span> 投递 <span class="hljs-selector-tag">measure</span>/<span class="hljs-selector-tag">layout</span>/<span class="hljs-selector-tag">draw</span> 等消息
    └─ <span class="hljs-selector-tag">Choreographer</span> 使用 <span class="hljs-selector-tag">VSync</span> 回调统一驱动:
           <span class="hljs-selector-tag">Input</span> → <span class="hljs-selector-tag">Animation</span> → <span class="hljs-selector-tag">Traversal</span> (ViewRootImpl.doTraversal)

<span class="hljs-selector-attr">[ WMS (WindowManagerService) ]</span>
    └─ 管理所有 <span class="hljs-selector-tag">Window</span>
    └─ 为 <span class="hljs-selector-tag">Window</span> 分配 <span class="hljs-selector-tag">Surface</span>
    └─ 告诉 <span class="hljs-selector-tag">app</span> 端 <span class="hljs-selector-tag">ViewRootImpl</span> 窗口变化等信息

<span class="hljs-selector-attr">[ Surface / SurfaceView ]</span>
    ├─ <span class="hljs-selector-tag">Surface</span>: 与 <span class="hljs-selector-tag">BufferQueue</span> 相连，<span class="hljs-selector-tag">ViewRootImpl</span>/<span class="hljs-selector-tag">RenderThread</span> 渲染目标
    └─ <span class="hljs-selector-tag">SurfaceView</span>: 特殊 <span class="hljs-selector-tag">View</span>，自有 <span class="hljs-selector-tag">Surface</span>，可由单独线程/<span class="hljs-selector-tag">GL</span> 渲染

<span class="hljs-selector-attr">[ Skia / OpenGL ES ]</span>
    ├─ <span class="hljs-selector-tag">Skia</span>: <span class="hljs-selector-tag">Canvas</span> 的实现，生成绘制命令
    └─ <span class="hljs-selector-tag">OpenGL</span> <span class="hljs-selector-tag">ES</span>: 交给 <span class="hljs-selector-tag">GPU</span> 执行绘图，硬件加速路径
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 四大组件与 AMS 交互的完整对比]]></title>    <link>https://juejin.cn/post/7585463258690224137</link>    <guid>https://juejin.cn/post/7585463258690224137</guid>    <pubDate>2025-12-20T04:15:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463258690224137" data-draft-id="7585227038992269350" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 四大组件与 AMS 交互的完整对比"/> <meta itemprop="keywords" content="面试"/> <meta itemprop="datePublished" content="2025-12-20T04:15:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="懒猫爱上鱼"/> <meta itemprop="url" content="https://juejin.cn/user/325111174151821"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 四大组件与 AMS 交互的完整对比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/325111174151821/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    懒猫爱上鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T04:15:20.000Z" title="Sat Dec 20 2025 04:15:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>Android 系统通过 ActivityManagerService（AMS）统一管理四大组件的生命周期和交互。虽然都是通过 Binder 与 AMS 通信，但四大组件在交互方式、生命周期管理、进程优先级等方面存在显著差异。本文将分析这些差异，帮助开发者更好地理解 Android 系统架构。</p>
<h2 data-id="heading-1">四大组件与 AMS 交互对比表</h2>


















































<table><thead><tr><th>组件</th><th>启动/注册模式</th><th>AMS数据结构</th><th>生命周期管理</th><th>进程交互</th><th>优先级管理</th><th>主要特点</th></tr></thead><tbody><tr><td>Activity</td><td>显式/隐式 Intent</td><td>ActivityStack/Task/ActivityRecord</td><td>栈式管理，AMS 严格控制状态转换</td><td>强绑定，每个状态变化都通知 AMS</td><td>前台/可见进程，由任务栈位置决定</td><td>用户交互界面，AMS 管理窗口、输入焦点</td></tr><tr><td>Service</td><td>startService()/bindService()</td><td>ServiceRecord/ConnectionRecord</td><td>启动/绑定两套生命周期，AMS 协调进程优先级</td><td>启动/停止/绑定/解绑时交互</td><td>动态变化（前台/可见/服务进程）</td><td>后台执行，AMS 管理进程保活和绑定关系</td></tr><tr><td>BroadcastReceiver</td><td>静态注册/动态注册</td><td>BroadcastQueue/ReceiverList/BroadcastRecord</td><td>瞬时执行，无持久状态，AMS 管理分发队列</td><td>发送/接收时交互，执行完即结束</td><td>无独立优先级，依赖宿主进程</td><td>事件驱动，AMS 处理权限和有序分发</td></tr><tr><td>ContentProvider</td><td>自动发布</td><td>ProviderMap/ContentProviderRecord</td><td>持久存在，与应用进程同生命周期</td><td>查询/插入/更新/删除时交互</td><td>依赖宿主进程，但 AMS 管理访问权限</td><td>数据共享，AMS 路由 URI 和权限控制</td></tr></tbody></table>
<h2 data-id="heading-2">详细交互机制分析</h2>
<h3 data-id="heading-3">1. Activity 与 AMS 交互</h3>
<p><strong>核心交互流程</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 启动流程</span>
应用进程 → <span class="hljs-attr">AMS</span>: <span class="hljs-title function_">startActivity</span>(intent)  <span class="hljs-comment">// 启动请求</span>
<span class="hljs-variable constant_">AMS</span> → 应用进程: <span class="hljs-title function_">scheduleLaunchActivity</span>()  <span class="hljs-comment">// 调度启动</span>
应用进程 → <span class="hljs-attr">AMS</span>: <span class="hljs-title function_">activityPaused</span>()  <span class="hljs-comment">// 状态同步</span>
<span class="hljs-variable constant_">AMS</span> → 其他应用进程: <span class="hljs-title function_">schedulePauseActivity</span>()  <span class="hljs-comment">// 暂停其他Activity</span>
<span class="hljs-variable constant_">AMS</span> → 应用进程: <span class="hljs-title function_">scheduleResumeActivity</span>()  <span class="hljs-comment">// 恢复当前Activity</span>
</code></pre>
<p><strong>AMS 管理要点：</strong></p>
<ul>
<li>维护 ActivityStack 和 Task 的任务栈结构</li>
<li>控制 Back Stack 回退逻辑</li>
<li>管理 Activity 的启动模式（standard、singleTop 等）</li>
<li>处理多窗口模式下的可见性</li>
<li>协调 Activity 转场动画</li>
</ul>
<p><strong>进程优先级：</strong> Activity 所在进程优先级由其在任务栈中的位置决定：</p>
<ul>
<li>前台 Activity → 前台进程（adj=0）</li>
<li>可见但不在前台 → 可见进程（adj=100）</li>
<li>完全不可见 → 缓存进程（adj=900+）</li>
</ul>
<h3 data-id="heading-4">2. Service 与 AMS 交互</h3>
<p><strong>启动服务流程：</strong></p>
<pre><code class="hljs language-js" lang="js">应用进程 → <span class="hljs-attr">AMS</span>: <span class="hljs-title function_">startService</span>(intent)
<span class="hljs-variable constant_">AMS</span> → 应用进程: <span class="hljs-title function_">scheduleCreateService</span>() → <span class="hljs-title function_">scheduleServiceArgs</span>()
<span class="hljs-comment">// 绑定服务流程</span>
应用进程 → <span class="hljs-attr">AMS</span>: <span class="hljs-title function_">bindService</span>(intent, conn, flags)
<span class="hljs-variable constant_">AMS</span> → 服务端进程: <span class="hljs-title function_">scheduleBindService</span>()
<span class="hljs-variable constant_">AMS</span> → 客户端进程: 返回 <span class="hljs-title class_">IBinder</span>
</code></pre>
<p><strong>AMS 管理要点：</strong></p>
<ul>
<li>维护 ServiceRecord 记录服务状态</li>
<li>管理 ConnectionRecord 绑定关系</li>
<li>控制服务进程的优先级</li>
<li>处理前台服务通知</li>
<li>协调跨进程服务绑定</li>
</ul>
<p><strong>进程优先级动态变化：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// AMS 动态调整服务进程优先级</span>
<span class="hljs-keyword">if</span> (service.isForeground) {
    <span class="hljs-comment">// 前台服务，优先级最高</span>
    process.setAdj(ProcessList.FOREGROUND_APP_ADJ);  <span class="hljs-comment">// 0</span>
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (process.hasVisibleActivities()) {
    <span class="hljs-comment">// 绑定到可见Activity，优先级较高</span>
    process.setAdj(ProcessList.VISIBLE_APP_ADJ);  <span class="hljs-comment">// 100</span>
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (process.hasServices()) {
    <span class="hljs-comment">// 只有服务，无可见组件</span>
    process.setAdj(ProcessList.SERVICE_ADJ);  <span class="hljs-comment">// 500</span>
} <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 无活跃组件，优先级最低</span>
    process.setAdj(ProcessList.CACHED_APP_MIN_ADJ);  <span class="hljs-comment">// 900+</span>
}
</code></pre>
<h3 data-id="heading-5">3. BroadcastReceiver 与 AMS 交互</h3>
<p><strong>注册和发送流程：</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 注册流程</span>
应用进程 → <span class="hljs-attr">AMS</span>: <span class="hljs-title function_">registerReceiver</span>(receiver, filter)
<span class="hljs-comment">// 发送流程</span>
应用进程 → <span class="hljs-attr">AMS</span>: <span class="hljs-title function_">sendBroadcast</span>(intent)
<span class="hljs-variable constant_">AMS</span> → 接收进程: <span class="hljs-title function_">scheduleReceiver</span>()  <span class="hljs-comment">// 异步分发</span>
<span class="hljs-comment">// 执行完成后</span>
接收进程 → <span class="hljs-attr">AMS</span>: 无回调，执行完即结束
</code></pre>
<p><strong>AMS 管理要点：</strong></p>
<ul>
<li>维护广播队列（有序/无序）</li>
<li>处理粘性广播缓存</li>
<li>检查发送和接收权限</li>
<li>控制广播超时</li>
<li>管理进程优先级临时提升</li>
</ul>
<p><strong>广播执行特点：</strong></p>
<ul>
<li>瞬时执行，无生命周期状态维护</li>
<li>AMS 不跟踪接收器执行状态</li>
<li>异步分发，可能延迟或丢弃</li>
<li>可并行执行多个无序广播</li>
</ul>
<h3 data-id="heading-6">4. ContentProvider 与 AMS 交互</h3>
<p><strong>发布和查询流程：</strong></p>
<pre><code class="hljs language-js" lang="js">/ 发布流程
应用进程 → <span class="hljs-attr">AMS</span>: <span class="hljs-title function_">publishContentProviders</span>(providers)
<span class="hljs-comment">// 查询流程</span>
客户端进程 → <span class="hljs-attr">AMS</span>: <span class="hljs-title function_">getContentProvider</span>(name)
<span class="hljs-variable constant_">AMS</span> → 服务端进程: 无直接调用，返回已发布的<span class="hljs-title class_">Provider</span>接口
客户端进程 → 服务端进程: 直接调用<span class="hljs-title class_">IContentProvider</span>.<span class="hljs-title function_">query</span>()
</code></pre>
<p><strong>AMS 管理要点：</strong></p>
<ul>
<li>维护 ProviderMap 路由表</li>
<li>检查跨进程访问权限</li>
<li>管理 Provider 引用计数</li>
<li>处理 Provider 进程死亡</li>
<li>协调 URI 权限授权</li>
</ul>
<p><strong>数据共享模型：</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// AMS 中的Provider路由</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ProviderMap</span> {
    <span class="hljs-comment">// authority → ContentProviderRecord</span>
    <span class="hljs-title class_">ArrayMap</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">ContentProviderRecord</span>&gt; mProvidersByName;
    <span class="hljs-comment">// component → ContentProviderRecord  </span>
    <span class="hljs-title class_">ArrayMap</span>&lt;<span class="hljs-title class_">ComponentName</span>, <span class="hljs-title class_">ContentProviderRecord</span>&gt; mProvidersByClass;
}

<span class="hljs-comment">// ContentProviderRecord</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ContentProviderRecord</span> {
    <span class="hljs-title class_">IContentProvider</span> provider;  <span class="hljs-comment">// 真正的Provider接口</span>
    <span class="hljs-title class_">ProcessRecord</span> app;          <span class="hljs-comment">// 所在进程</span>
    int externalProcessNo;      <span class="hljs-comment">// 外部进程引用计数</span>
    <span class="hljs-comment">// 当引用计数为0时，AMS可通知进程清理Provider</span>
}
</code></pre>
<h2 data-id="heading-7">跨进程通信差异</h2>
<h3 data-id="heading-8">1. Binder 通信频率</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// Activity: 高频通信</span>
<span class="hljs-comment">// 每个生命周期变化都要通信</span>
<span class="hljs-title function_">onCreate</span>() ↔ <span class="hljs-title function_">onCreate</span>() 通知
<span class="hljs-title function_">onStart</span>()  ↔ <span class="hljs-title function_">onStart</span>() 通知  
<span class="hljs-title function_">onResume</span>() ↔ <span class="hljs-title function_">onResume</span>() 通知
<span class="hljs-title function_">onPause</span>()  ↔ <span class="hljs-title function_">onPause</span>() 通知
<span class="hljs-title function_">onStop</span>()   ↔ <span class="hljs-title function_">onStop</span>() 通知
<span class="hljs-title function_">onDestroy</span>()↔ <span class="hljs-title function_">onDestroy</span>() 通知

<span class="hljs-comment">// Service: 中频通信</span>
<span class="hljs-comment">// 启动/停止/绑定/解绑时通信</span>
<span class="hljs-title function_">onCreate</span>() ↔ 启动时通信
<span class="hljs-title function_">onStartCommand</span>() ↔ 每次启动通信
<span class="hljs-title function_">onBind</span>() ↔ 绑定时通信
<span class="hljs-title function_">onUnbind</span>() ↔ 解绑时通信

<span class="hljs-comment">// Broadcast: 低频通信</span>
<span class="hljs-comment">// 注册/发送时通信</span>
<span class="hljs-title function_">registerReceiver</span>() ↔ 注册时通信
<span class="hljs-title function_">sendBroadcast</span>() ↔ 发送时通信
<span class="hljs-comment">// onReceive() 执行无需回调AMS</span>

<span class="hljs-comment">// ContentProvider: 按需通信</span>
<span class="hljs-comment">// 获取Provider时通信一次</span>
<span class="hljs-title function_">getContentProvider</span>() ↔ 获取时通信
<span class="hljs-comment">// 后续操作直接与Provider进程通信</span>

</code></pre>
<h3 data-id="heading-9">2. 数据传输量</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// Activity: 大量数据</span>
<span class="hljs-comment">// 传递整个ActivityRecord，包含Intent、Options等</span>
data.<span class="hljs-title function_">writeParcelable</span>(activityRecord);

<span class="hljs-comment">// Service: 中等数据  </span>
<span class="hljs-comment">// 传递Intent和启动参数</span>
data.<span class="hljs-title function_">writeParcelable</span>(service);
data.<span class="hljs-title function_">writeInt</span>(flags);
data.<span class="hljs-title function_">writeInt</span>(startId);

<span class="hljs-comment">// Broadcast: 小量数据</span>
<span class="hljs-comment">// 主要传递Intent</span>
data.<span class="hljs-title function_">writeParcelable</span>(intent);

<span class="hljs-comment">// ContentProvider: 变长数据</span>
<span class="hljs-comment">// 传递URI和查询参数</span>
data.<span class="hljs-title function_">writeParcelable</span>(uri);
data.<span class="hljs-title function_">writeStringArray</span>(projection);
data.<span class="hljs-title function_">writeString</span>(selection);
data.<span class="hljs-title function_">writeStringArray</span>(selectionArgs);

</code></pre>
<h2 data-id="heading-10">生命周期管理深度</h2>
<h3 data-id="heading-11">1. Activity 生命周期（AMS 完全控制）</h3>
<p>这个生命周期是没有设置configChanges参数。主要简单介绍一下AMS是如何参与到Activity的生命周期中的。设置了configChanges参数的有兴趣的可以单独搜索一下相关文档。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e23535642b09449584b9c9ac713780f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS54yr54ix5LiK6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766808919&amp;x-signature=LVjOadSv9XLB97Ih4n8A4rU%2Fqpc%3D" alt="Activity 生命周期.png" loading="lazy"/></p>
<h3 data-id="heading-12">2. Service 生命周期（AMS 部分控制）</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 启动式服务</span>
<span class="hljs-attr">AMS</span>: 启动服务 → 应用: <span class="hljs-title function_">onCreate</span>() → <span class="hljs-title function_">onStartCommand</span>() → 运行
      ↓
<span class="hljs-attr">AMS</span>: 停止服务 → 应用: <span class="hljs-title function_">onDestroy</span>()

<span class="hljs-comment">// 绑定式服务  </span>
<span class="hljs-attr">AMS</span>: 绑定服务 → 应用: <span class="hljs-title function_">onCreate</span>() → <span class="hljs-title function_">onBind</span>() → 服务绑定
      ↓
<span class="hljs-attr">AMS</span>: 所有客户端解绑 → 应用: <span class="hljs-title function_">onUnbind</span>() → <span class="hljs-title function_">onDestroy</span>()
</code></pre>
<h3 data-id="heading-13">3. BroadcastReceiver 生命周期（AMS 不管理）</h3>
<pre><code class="hljs language-js" lang="js">/ <span class="hljs-variable constant_">AMS</span>只管理分发，不管理执行状态
<span class="hljs-attr">AMS</span>: 收到广播 → 查找接收器 → 分发到进程
应用进程: 创建<span class="hljs-title class_">Receiver</span>实例 → <span class="hljs-title function_">onReceive</span>() → 销毁实例
<span class="hljs-comment">// 执行完毕即结束，无状态跟踪</span>
</code></pre>
<h3 data-id="heading-14">4. ContentProvider 生命周期（与应用进程绑定）</h3>
<pre><code class="hljs language-js" lang="js">/ <span class="hljs-title class_">Provider</span>生命周期跟随应用进程
应用进程启动 → <span class="hljs-title function_">onCreate</span>() → 运行
      ↓
应用进程死亡 → <span class="hljs-title function_">onDestroy</span>()

<span class="hljs-comment">// AMS只管理Provider的发布和引用</span>
<span class="hljs-attr">AMS</span>: 发布<span class="hljs-title class_">Provider</span> → 增加引用 → 减少引用 → 通知清理

</code></pre>
<h2 data-id="heading-15">AMS 中的调度策略</h2>
<h3 data-id="heading-16">1. 优先级调度差异</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// Activity调度：基于任务栈</span>
<span class="hljs-title class_">ActivityStack</span>.<span class="hljs-title function_">getNextActivityToResume</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 总是恢复栈顶Activity</span>
    <span class="hljs-keyword">return</span> mActivities.<span class="hljs-title function_">get</span>(mActivities.<span class="hljs-title function_">size</span>() - <span class="hljs-number">1</span>);
}

<span class="hljs-comment">// Service调度：基于进程状态</span>
<span class="hljs-title function_">updateServiceProcessLocked</span>(<span class="hljs-params">ServiceRecord sr</span>) {
    <span class="hljs-keyword">if</span> (sr.<span class="hljs-property">isForeground</span>) {
        <span class="hljs-comment">// 前台服务，保持进程存活</span>
        <span class="hljs-title function_">keepProcessAlive</span>(sr.<span class="hljs-property">app</span>);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sr.<span class="hljs-property">bindings</span>.<span class="hljs-title function_">size</span>() &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// 有绑定，适当保活</span>
        <span class="hljs-title function_">adjustProcessAdj</span>(sr.<span class="hljs-property">app</span>, <span class="hljs-title class_">ProcessList</span>.<span class="hljs-property">SERVICE_ADJ</span>);
    }
}

<span class="hljs-comment">// Broadcast调度：基于队列</span>
<span class="hljs-title class_">BroadcastQueue</span>.<span class="hljs-title function_">scheduleBroadcastsLocked</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 顺序处理队列中的广播</span>
    <span class="hljs-title function_">processNextBroadcast</span>(<span class="hljs-literal">true</span>);
}

<span class="hljs-comment">// ContentProvider调度：基于需求</span>
<span class="hljs-title function_">getContentProviderImpl</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-comment">// 按需启动Provider进程</span>
    <span class="hljs-keyword">if</span> (provider == <span class="hljs-literal">null</span>) {
        <span class="hljs-title function_">startProcessLocked</span>(cpr.<span class="hljs-property">processName</span>, ...);
    }
}

</code></pre>
<h3 data-id="heading-17">2. 内存管理策略</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 四大组件的内存回收优先级</span>
boolean <span class="hljs-title function_">shouldKillProcess</span>(<span class="hljs-params">ProcessRecord app</span>) {
    <span class="hljs-comment">// 计算进程重要性</span>
    int importance = <span class="hljs-title function_">calculateImportance</span>(app);
    
    <span class="hljs-comment">// 判断标准（简化）：</span>
    <span class="hljs-comment">// 1. 有前台Activity的进程最后杀</span>
    <span class="hljs-comment">// 2. 有可见Activity的进程次之</span>
    <span class="hljs-comment">// 3. 有前台Service的进程再次</span>
    <span class="hljs-comment">// 4. 有普通Service的进程</span>
    <span class="hljs-comment">// 5. 有缓存Provider的进程</span>
    <span class="hljs-comment">// 6. 只有BroadcastReceiver的进程最先杀</span>
    
    <span class="hljs-keyword">return</span> importance &lt; threshold;
}

</code></pre>
<h2 data-id="heading-18">总结</h2>
<p>四大组件与 AMS 的交互体现了 Android 系统的分层设计：</p>
<ol>
<li><strong>Activity​ - 用户界面层：</strong> AMS 严格管理，确保用户体验</li>
<li><strong>Service​ - 后台任务层：</strong> AMS 协调进程优先级，平衡性能</li>
<li><strong>BroadcastReceiver​ - 事件通信层：</strong> AMS 负责路由，解耦组件</li>
<li><strong>ContentProvider​ - 数据共享层：</strong> AMS 控制访问，保证安全</li>
</ol>
<p>关键区别在于：</p>
<ul>
<li><strong>控制粒度：</strong> Activity 最细，Broadcast 最粗</li>
<li><strong>状态管理：</strong> Activity 和 Service 有状态，Broadcast 无状态</li>
<li><strong>进程影响：</strong> Activity 和前台 Service 可提升进程优先级</li>
<li><strong>通信模式：</strong> Activity/Service 双向，Broadcast 单向，Provider 按需</li>
</ul>
<p>AMS 作为系统协调者，针对不同组件的特性采用不同的管理策略，确保系统高效、稳定运行。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[[macos系统]我用的是苹果电脑, 终端的shell是zsh,而不是bash, 那我在执行.sh文件的时候, 是bash xxx.sh还是zsh xxx.sh]]></title>    <link>https://juejin.cn/post/7585382553290391588</link>    <guid>https://juejin.cn/post/7585382553290391588</guid>    <pubDate>2025-12-20T04:18:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585382553290391588" data-draft-id="7585400495683698730" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="[macos系统]我用的是苹果电脑, 终端的shell是zsh,而不是bash, 那我在执行.sh文件的时候, 是bash xxx.sh还是zsh xxx.sh"/> <meta itemprop="keywords" content="Shell"/> <meta itemprop="datePublished" content="2025-12-20T04:18:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="import_random"/> <meta itemprop="url" content="https://juejin.cn/user/2013961033882312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            [macos系统]我用的是苹果电脑, 终端的shell是zsh,而不是bash, 那我在执行.sh文件的时候, 是bash xxx.sh还是zsh xxx.sh
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2013961033882312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    import_random
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T04:18:07.000Z" title="Sat Dec 20 2025 04:18:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 macOS 的 zsh 终端中执行 .sh 文件时，<strong>取决于你的需求和脚本的 shebang（第一行声明）</strong>。以下是几种情况和建议：</p>
<h2 data-id="heading-0">1. <strong>如果脚本有 shebang（推荐）</strong></h2>
<p>脚本第一行指定了解释器，例如：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
</code></pre>
<p>或</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/zsh</span>
</code></pre>
<p>可以直接执行：</p>
<pre><code class="hljs language-bash" lang="bash">./xxx.sh
</code></pre>
<p>系统会自动使用 shebang 指定的解释器。</p>
<h2 data-id="heading-1">2. <strong>如果想显式指定解释器</strong></h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 用 bash 执行</span>
bash xxx.sh

<span class="hljs-comment"># 用 zsh 执行</span>
zsh xxx.sh
</code></pre>
<h2 data-id="heading-2">3. <strong>重要区别</strong></h2>
<ul>
<li><strong>bash xxx.sh</strong>：强制使用 bash 解释器</li>
<li><strong>zsh xxx.sh</strong>：强制使用 zsh 解释器</li>
<li><strong>./xxx.sh</strong>：使用 shebang 指定的解释器（需要文件有执行权限）</li>
</ul>
<h2 data-id="heading-3">4. <strong>给脚本添加执行权限</strong></h2>
<p>如果经常执行，建议：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">chmod</span> +x xxx.sh
./xxx.sh
</code></pre>
<h2 data-id="heading-4">5. <strong>最佳实践</strong></h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 先检查脚本 shebang</span>
<span class="hljs-built_in">head</span> -1 xxx.sh

<span class="hljs-comment"># 如果有 shebang，确保有执行权限</span>
<span class="hljs-built_in">chmod</span> +x xxx.sh
./xxx.sh

<span class="hljs-comment"># 如果没有 shebang或想强制使用特定shell</span>
bash xxx.sh   <span class="hljs-comment"># 用 bash 执行</span>
zsh xxx.sh    <span class="hljs-comment"># 用 zsh 执行</span>
</code></pre>
<h2 data-id="heading-5">6. <strong>判断当前默认shell</strong></h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-variable">$SHELL</span>  <span class="hljs-comment"># 显示默认登录shell</span>
<span class="hljs-built_in">echo</span> <span class="hljs-variable">$0</span>      <span class="hljs-comment"># 显示当前使用的shell</span>
</code></pre>
<p><strong>简单建议</strong>：如果脚本是 bash 写的（多数情况），用 <code>bash xxx.sh</code>；如果是 zsh 写的，用 <code>zsh xxx.sh</code>。最好给脚本加上正确的 shebang。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>