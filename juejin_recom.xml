<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[HarmonyOS：User-Agent开发指导]]></title>    <link>https://juejin.cn/post/7590681158716407848</link>    <guid>https://juejin.cn/post/7590681158716407848</guid>    <pubDate>2026-01-04T01:35:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590681158716407848" data-draft-id="7590597231707979811" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS：User-Agent开发指导"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2026-01-04T01:35:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ChinaDragon"/> <meta itemprop="url" content="https://juejin.cn/user/3966693681410840"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS：User-Agent开发指导
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3966693681410840/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ChinaDragon
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T01:35:05.000Z" title="Sun Jan 04 2026 01:35:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、简介</h3>
<blockquote>
<p>User-Agent（简称UA）是一个特殊的字符串，包含设备类型、操作系统及版本等关键信息。在Web开发中，这个字符串使服务器能够识别请求的来源设备及其特性，从而根据这些信息提供定制化的内容和服务。如果页面无法正确识别UA，可能会导致多种异常情况。例如，为移动设备优化的页面布局可能会在桌面设备上显示错乱，反之亦然。此外，某些特定的浏览器功能或CSS样式可能仅在特定的浏览器版本中受支持，如果页面无法根据UA字符串做出正确的判断，就可能导致渲染问题或逻辑错误。</p>
</blockquote>
<h3 data-id="heading-1">二、默认User-Agent结构</h3>
<h4 data-id="heading-2">2.1 默认User-Agent定义</h4>
<pre><code class="hljs language-bash" lang="bash">Mozilla/5.0 ({DeviceType}; {OSName} {OSVersion}) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/{ChromeCompatibleVersion}.0.0.0 Safari/537.36  ArkWeb/{ArkWeb VersionCode} {DeviceCompat} {扩展区}
</code></pre>
<p><strong>举例说明</strong></p>
<pre><code class="hljs language-bash" lang="bash">Mozilla/5.0 (Phone; OpenHarmony 5.0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36  ArkWeb/4.1.6.1 Mobile
</code></pre>
<p><strong>字段说明</strong></p>





































<table><thead><tr><th align="left">字段</th><th align="left">含义</th></tr></thead><tbody><tr><td align="left">DeviceType</td><td align="left">当前的设备类型。取值范围：<br/>- Phone：手机设备<br/>- Tablet：平板设备<br/>- PC：2in1设备</td></tr><tr><td align="left">OSName</td><td align="left">基础操作系统名称。<br/>默认取值：OpenHarmony</td></tr><tr><td align="left">OSVersion</td><td align="left">基础操作系统版本，两位数字，M.S。<br/>通过系统参数const.ohos.fullname解析版本号得到，取版本号部分M.S前两位。<br/>默认取值：例如5.0</td></tr><tr><td align="left">ChromeCompatibleVersion</td><td align="left">兼容Chrome主版本的版本号，从114版本开始演进。<br/>默认取值：114</td></tr><tr><td align="left">ArkWeb</td><td align="left">HarmonyOS版本Web内核名称。<br/>默认取值：ArkWeb<br/> ArkWeb VersionCode	<br/>ArkWeb版本号，格式a.b.c.d。<br/>默认取值：例如4.1.6.1</td></tr><tr><td align="left">DeviceCompat</td><td align="left">前向兼容字段。<br/> 默认取值：Mobile</td></tr><tr><td align="left">扩展区</td><td align="left">三方应用可以扩展的字段。 <br/> 三方应用使用ArkWeb组件时，可以做UA扩展，例如加入APP相关信息标识。</td></tr></tbody></table>
<blockquote>
<p><strong>说明</strong></p>
<ul>
<li>当前默认User-Agent的ArkWeb字段前有两个空格。</li>
<li>当前通过User-Agent中是否含有"Mobile"字段来判断是否开启前端HTML页面中meta标签的viewport属性。当User-Agent中不含有"Mobile"字段时，meta标签中viewport属性默认关闭，此时可通过显性设置metaViewport属性为true来覆盖关闭状态。</li>
<li>建议通过OpenHarmony关键字识别是否是HarmonyOS设备，同时可以通过DeviceType识别设备类型用于不同设备上的页面显示（ArkWeb关键字表示设备使用的web内核，OpenHarmony关键字表示设备使用的操作系统，因此推荐通过OpenHarmony关键字识别是否是HarmonyOS设备）。</li>
<li>{DistributionOSName}和{DistributionOSVersion}字段在API version 15之前的版本中未启用，从API version 15版本开始不在默认User-Agent中体现。</li>
</ul>
</blockquote>
<h3 data-id="heading-3">三、自定义User-Agent结构</h3>
<blockquote>
<p>在下面的示例中，通过调用getUserAgent()接口获取当前默认的用户代理（User-Agent）字符串。这一接口提供的默认User-Agent信息为开发者提供了基础，使开发者能够基于这个默认信息进行定制或扩展。</p>
</blockquote>
<blockquote>
<p><strong>示例效果图</strong> <br/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71420fa5f35244979d079e52ced04b75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hpbmFEcmFnb24=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095305&amp;x-signature=DUg4OrnR7wjfoS7I7MMGKxE%2Bh9c%3D" alt="在这里插入图片描述" loading="lazy"/></p>
</blockquote>
<p><strong>示例代码</strong></p>
<pre><code class="hljs language-bash" lang="bash">
import { webview } from <span class="hljs-string">'@kit.ArkWeb'</span>;
import { BusinessError } from <span class="hljs-string">'@kit.BasicServicesKit'</span>;

@Entry
@Component
struct TestUserAgent {
  @State message: string = <span class="hljs-string">'getUserAgent'</span>;
  controller: webview.WebviewController = new webview.WebviewController()

  <span class="hljs-function"><span class="hljs-title">build</span></span>() {
    Column({space: 20}) {
      Button(this.message)
        .<span class="hljs-built_in">id</span>(<span class="hljs-string">'TestUserAgentHelloWorld'</span>)
        .fontSize(<span class="hljs-variable">$r</span>(<span class="hljs-string">'app.float.page_text_font_20fp'</span>))
        .fontWeight(FontWeight.Bold)
        .onClick(() =&gt; {
          try {
            let userAgent = this.controller.getUserAgent();
            console.log("获取 userAgent: " + userAgent);
          } catch (error) {
            console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })
      Web({ src: 'www.baidu.com', controller: this.controller })
    }
    .height('<span class="hljs-number">100</span>%')
    .width('<span class="hljs-number">100</span>%')
  }
}
</code></pre>
<blockquote>
<p>以下示例通过 <strong>setCustomUserAgent()</strong> 接口设置自定义用户代理，但请注意，此操作会覆盖系统的用户代理。因此，我们建议将扩展字段追加在默认用户代理的末尾，比如三方应用程序的开发场景，可以在系统默认用户代理字符串的末尾追加特定的APP标识，这样既能保留原有用户代理信息，又能增加自定义的应用识别信息。 <br/>
当Web组件src设置了url时，建议在<strong>onControllerAttached</strong>回调事件中设置User-Agent，设置方式请参考示例。不建议将User-Agent设置在onLoadIntercept回调事件中，会概率性出现设置失败。如果未在onControllerAttached回调事件中设置User-Agent。再调用setCustomUserAgent方法时，可能会出现加载的页面与实际设置User-Agent不符的异常现象。 <br/>
当Web组件src设置为空字符串时，建议先调用setCustomUserAgent方法设置User-Agent，再通过loadUrl加载具体页面。</p>
</blockquote>
<blockquote>
<p><strong>示例效果图</strong> <br/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23cd7366741a43a7b418c27a3224231f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hpbmFEcmFnb24=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095305&amp;x-signature=RQ9Z0rczoOyRY1BH4Gv8OAJpkTk%3D" alt="在这里插入图片描述" loading="lazy"/></p>
</blockquote>
<p><strong>示例代码</strong></p>
<pre><code class="hljs language-bash" lang="bash">
import { webview } from <span class="hljs-string">'@kit.ArkWeb'</span>;
import { BusinessError } from <span class="hljs-string">'@kit.BasicServicesKit'</span>;

const TAG = <span class="hljs-string">"TestUserAgent"</span>
@Entry
@Component
struct TestUserAgent {
  @State message: string = <span class="hljs-string">'getUserAgent'</span>;
  controller: webview.WebviewController = new webview.WebviewController()
  // 三方应用相关信息标识
  @State customUserAgent: string = <span class="hljs-string">' DemoApp 自定义用户代理'</span>;

  <span class="hljs-function"><span class="hljs-title">build</span></span>() {
    Column({space: 20}) {
      Button(this.message)
        .<span class="hljs-built_in">id</span>(<span class="hljs-string">'TestUserAgentHelloWorld'</span>)
        .fontSize(<span class="hljs-variable">$r</span>(<span class="hljs-string">'app.float.page_text_font_20fp'</span>))
        .fontWeight(FontWeight.Bold)
        .onClick(() =&gt; {
          try {
            let userAgent = this.controller.getUserAgent();
            let customUserAgent = this.controller.getCustomUserAgent()
            console.log("获取 userAgent: " + userAgent);
            console.log("获取 customUserAgent: " + customUserAgent);
          } catch (error) {
            console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })
      Web({ src: 'https://www.baidu.com/', controller: this.controller })
        .domStorageAccess(true)
        .onControllerAttached(() =&gt;{
          console.log("执行了 onControllerAttached 回调");
          try {
            let userAgent = this.controller.getUserAgent()+ this.customUserAgent
            this.controller.setCustomUserAgent(userAgent)
          }catch (error){
            console.error(TAG, `ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })
    }
    .height('<span class="hljs-number">100</span>%')
    .width('<span class="hljs-number">100</span>%')
  }
}
</code></pre>
<blockquote>
<p>从<strong>API version 20</strong>开始，可通过 <strong>setAppCustomUserAgent()</strong> 接口设置应用级自定义用户代理，或者通过 <strong>setUserAgentForHosts()</strong> 对特定网站设置应用级自定义用户代理，覆盖系统的用户代理，应用内所有Web组件生效。 <br/>
建议在Web组件创建前先调用静态接口getDefaultUserAgent获取默认的用户代理（User-Agent）字符串，然后调用setAppCustomUserAgent，setUserAgentForHosts方法设置User-Agent，再创建指定src的Web组件或通过loadUrl加载具体页面。</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash">
import { webview } from <span class="hljs-string">'@kit.ArkWeb'</span>;
import { BusinessError } from <span class="hljs-string">'@kit.BasicServicesKit'</span>;

@Entry
@Component
struct TestUserAgent2 {
  controller: webview.WebviewController = new webview.WebviewController();
  @State userAgent: string = <span class="hljs-string">''</span>;

  aboutToAppear(): void {
    try {
      webview.WebviewController.initializeWebEngine();
      <span class="hljs-built_in">let</span> defaultUserAgent = webview.WebviewController.getDefaultUserAgent();
      <span class="hljs-built_in">let</span> appUA = defaultUserAgent + <span class="hljs-string">" appUA "</span>;
      webview.WebviewController.setAppCustomUserAgent(appUA+<span class="hljs-string">" application"</span>);
      webview.WebviewController.setUserAgentForHosts(
        appUA + <span class="hljs-string">"specific_net"</span>,
        [
          <span class="hljs-string">"developer.huawei.com"</span>,
          <span class="hljs-string">"www.deepseek.com"</span>,
          <span class="hljs-string">"www.baidu.com"</span>
        ]
      );
    } catch (error) {
      console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
    }
  }

  <span class="hljs-function"><span class="hljs-title">build</span></span>() {
    Column({space: 20}) {
      Button(<span class="hljs-string">'getCustomUserAgent'</span>)
        .onClick(() =&gt; {
          try {
            this.userAgent = this.controller.getCustomUserAgent();
            console.log("通过getCustomUserAgent()接口获取自定义用户代理 userAgent: " + this.userAgent);
          } catch (error) {
            console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })
      Web({ src: 'https://www.baidu.com', controller: this.controller })
    }
  }
}
</code></pre>
<blockquote>
<p>在下面的示例中，通过getCustomUserAgent()接口获取自定义用户代理。</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash">
import { webview } from <span class="hljs-string">'@kit.ArkWeb'</span>;
import { BusinessError } from <span class="hljs-string">'@kit.BasicServicesKit'</span>;

@Entry
@Component
struct TestUserAgent2 {
  controller: webview.WebviewController = new webview.WebviewController();
  @State userAgent: string = <span class="hljs-string">''</span>;

  aboutToAppear(): void {
    try {
      webview.WebviewController.initializeWebEngine();
      <span class="hljs-built_in">let</span> defaultUserAgent = webview.WebviewController.getDefaultUserAgent();
      <span class="hljs-built_in">let</span> appUA = defaultUserAgent + <span class="hljs-string">" appUA "</span>;
      webview.WebviewController.setAppCustomUserAgent(appUA+<span class="hljs-string">" application"</span>);
      webview.WebviewController.setUserAgentForHosts(
        appUA + <span class="hljs-string">"spefical_net"</span>,
        [
          <span class="hljs-string">"developer.huawei.com"</span>,
          <span class="hljs-string">"www.deepseek.com"</span>,
          <span class="hljs-string">"www.baidu.com"</span>
        ]
      );
    } catch (error) {
      console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
    }
  }

  <span class="hljs-function"><span class="hljs-title">build</span></span>() {
    Column({space: 20}) {
      Button(<span class="hljs-string">'getCustomUserAgent'</span>)
        .onClick(() =&gt; {
          try {
            this.userAgent = this.controller.getCustomUserAgent();
            console.log("通过getCustomUserAgent()接口获取自定义用户代理 userAgent: " + this.userAgent);
          } catch (error) {
            console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })
      Web({ src: 'https://www.baidu.com', controller: this.controller })
    }
  }
}
</code></pre>
<h3 data-id="heading-4">四、相关User-Agent接口优先级</h3>






























<table><thead><tr><th align="left">接口名称</th><th align="left">优先级</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">setCustomUserAgent</td><td align="left">最高</td><td align="left">对调用的Web组件生效。</td></tr><tr><td align="left">setUserAgentForHosts</td><td align="left">低于setCustomUserAgent</td><td align="left">对应用中所有Web组件访问指定网站生效。</td></tr><tr><td align="left">setAppCustomUserAgent</td><td align="left">低于setUserAgentForHosts</td><td align="left">对应用中所有Web组件生效。</td></tr><tr><td align="left">ArkWeb默认UA</td><td align="left">最低</td><td align="left">对应用中所有Web组件生效，只读，通过getDefaultUserAgent获取。</td></tr></tbody></table>
<h3 data-id="heading-5">五、常见问题</h3>
<h4 data-id="heading-6">5.1 如何通过User-Agent来识别HarmonyOS操作系统中不同设备</h4>
<blockquote>
<p>HarmonyOS设备的识别主要通过User-Agent中的系统、系统版本和设备类型三个维度来判断。建议同时检查系统、系统版本和设备类型，以确保更准确的设备识别。</p>
</blockquote>
<h5 data-id="heading-7">5.1.1 系统识别</h5>
<blockquote>
<p>通过User-Agent中的{OSName}字段识别HarmonyOS系统。</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash">const isHarmonyOS = () =&gt; /OpenHarmony/i.test(navigator.userAgent);   
</code></pre>
<h5 data-id="heading-8">5.1.2 系统版本识别</h5>
<blockquote>
<p>通过User-Agent中的{OSName}和{OSVersion}字段识别HarmonyOS系统及系统版本。格式为：OpenHarmony + 版本号。</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash">// 检测是否是HarmonyOS系统
const matches = navigator.userAgent.match(/OpenHarmony (\d+\.?\d*)/);  
matches?.length &amp;&amp; Number(matches[1]) &gt; 0
// 检测是否是HarmonyOS NEXT系统
const matches = navigator.userAgent.match(/OpenHarmony (\d+\.?\d*)/);  
matches?.length &amp;&amp; Number(matches[1]) &gt;= 5;   
</code></pre>
<h5 data-id="heading-9">5.1.3 设备类型识别</h5>
<blockquote>
<p>通过deviceType字段来识别不同设备类型。</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash">// 检测是否为手机设备
const isPhone = () =&gt; /Phone/i.test(navigator.userAgent);

// 检测是否为平板设备  
const isTablet = () =&gt; /Tablet/i.test(navigator.userAgent);

// 检测是否为2in1设备  
const is2in1 = () =&gt; /PC/i.test(navigator.userAgent);
</code></pre>
<h4 data-id="heading-10">5.2 如何模拟HarmonyOS操作系统的User-Agent进行前端调试</h4>
<blockquote>
<p>在Windows/Mac/Linux等操作系统中，可以通过Chrome/Edge/Firefox等浏览器DevTools提供的User-Agent复写能力，模拟HarmonyOS User-Agent。</p>
</blockquote>
<h4 data-id="heading-11">5.3 如何在HarmonyOS中自定义User-Agent以实现H5兼容性</h4>
<blockquote>
<p>HarmonyOS提供setCustomUserAgent接口以支持User-Agent的自定义设置。为适配移动端H5页面通常依赖的UA标识检测（如Mobile、Android等），并确保不覆盖系统默认UA信息，推荐按如下方式操作：首先通过setCustomUserAgent()接口获取系统默认User-Agent字符串，随后将H5兼容所需的自定义标识字段追加至该字符串末尾，最后调用setCustomUserAgent接口设置修改后的完整UA字符串。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[简析 Kotlin 内联函数：与inline相关的关键字]]></title>    <link>https://juejin.cn/post/7590957076630552622</link>    <guid>https://juejin.cn/post/7590957076630552622</guid>    <pubDate>2026-01-04T01:38:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590957076630552622" data-draft-id="7590929624743395378" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="简析 Kotlin 内联函数：与inline相关的关键字"/> <meta itemprop="keywords" content="Java,Android,Kotlin"/> <meta itemprop="datePublished" content="2026-01-04T01:38:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="愤怒的代码"/> <meta itemprop="url" content="https://juejin.cn/user/4125023358426190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            简析 Kotlin 内联函数：与inline相关的关键字
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4125023358426190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    愤怒的代码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T01:38:23.000Z" title="Sun Jan 04 2026 01:38:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我们知道 <code>inline</code> 函数的作用是可以在调用处替换为函数体实现，可以减少函数调用栈的使用，从而提升效率，本文会一起看看跟 <code>inline</code> 一起配合使用的几个关键字</p>
<h2 data-id="heading-0">0x00 inline + reified</h2>
<p>在Kotlin中经常会看到一些内联函数是配合 reified 关键字使用</p>
<ul>
<li>保留运行时的类型</li>
<li>原理是在调用处将范型替换为实际类型</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">checkType</span><span class="hljs-params">(obj: <span class="hljs-type">Any</span>)</span></span> {
    <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">is</span> T) { <span class="hljs-comment">// ❌ 这里会编译出错！</span>
				println(<span class="hljs-string">"<span class="hljs-subst">${obj}</span> 是 <span class="hljs-subst">${T::class.simpleName}</span> 类型"</span>)
		}
}
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 添加 reified 关键字（必须配合 inline 使用）</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;<span class="hljs-keyword">reified</span> T&gt;</span> <span class="hljs-title">checkType</span><span class="hljs-params">(obj: <span class="hljs-type">Any</span>)</span></span> {
    <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">is</span> T) { <span class="hljs-comment">// ✅ 现在可以了！</span>
        println(<span class="hljs-string">"<span class="hljs-subst">${obj}</span> 是 <span class="hljs-subst">${T::class.simpleName}</span> 类型"</span>)
    }
}

<span class="hljs-comment">// 使用示例</span>
checkType&lt;String&gt;(<span class="hljs-string">"Hello"</span>)  <span class="hljs-comment">// 输出：Hello 是 String 类型</span>
checkType&lt;<span class="hljs-built_in">Int</span>&gt;(<span class="hljs-string">"Text"</span>)      <span class="hljs-comment">// 无输出，类型不匹配</span>
</code></pre>
<h3 data-id="heading-1"><strong>简化Activity启动（无需传递Class参数）</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用 reified 的优雅方式</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;<span class="hljs-keyword">reified</span> T : Activity&gt;</span> Context.<span class="hljs-title">startActivity</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> intent = Intent(<span class="hljs-keyword">this</span>, T::<span class="hljs-keyword">class</span>.java) <span class="hljs-comment">// 直接访问泛型类型的Class</span>
    startActivity(intent)
}
<span class="hljs-comment">// 调用 - 类型清晰，无需::class.java</span>
startActivity&lt;DetailActivity&gt;()
</code></pre>
<h3 data-id="heading-2"><strong>Retrofit + reified 简化API响应处理</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 传统方式：需要传递Type</span>
apiService.getUser().enqueue(<span class="hljs-keyword">object</span> : Callback&lt;User&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onResponse</span><span class="hljs-params">(call: <span class="hljs-type">Call</span>&lt;<span class="hljs-type">User</span>&gt;, response: <span class="hljs-type">Response</span>&lt;<span class="hljs-type">User</span>&gt;)</span></span> {
        <span class="hljs-comment">// 处理响应</span>
    }
})

<span class="hljs-comment">// 使用 reified 的扩展函数</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;<span class="hljs-keyword">reified</span> T&gt;</span> Call<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">enqueueSimplified</span><span class="hljs-params">(
    <span class="hljs-keyword">crossinline</span> onSuccess: (<span class="hljs-type">T</span>) -&gt; <span class="hljs-type">Unit</span>,
    <span class="hljs-keyword">crossinline</span> onError: (<span class="hljs-type">Throwable</span>) -&gt; <span class="hljs-type">Unit</span>
)</span></span> {
    enqueue(<span class="hljs-keyword">object</span> : Callback&lt;T&gt; {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onResponse</span><span class="hljs-params">(call: <span class="hljs-type">Call</span>&lt;<span class="hljs-type">T</span>&gt;, response: <span class="hljs-type">Response</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span> {
            <span class="hljs-keyword">if</span> (response.isSuccessful) {
                onSuccess(response.body()!!)
            }
        }
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onFailure</span><span class="hljs-params">(call: <span class="hljs-type">Call</span>&lt;<span class="hljs-type">T</span>&gt;, t: <span class="hljs-type">Throwable</span>)</span></span> {
            onError(t)
        }
    })
}

<span class="hljs-comment">// 调用更加简洁</span>
apiService.getUser().enqueueSimplified(
    onSuccess = { user -&gt; showUser(user) },
    onError = { error -&gt; showError(error) }
)
</code></pre>
<h2 data-id="heading-3">0x01 <strong><code>noinline</code>：阻止内联</strong></h2>
<p><strong>为什么需要它？<strong>当一个 Lambda 参数需要被</strong>存储</strong>、<strong>传递</strong>给其他非内联函数，或在<strong>非内联上下文中调用</strong>时，就必须使用 <code>noinline</code>.</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 示例：需要存储 Lambda</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doSomething</span><span class="hljs-params">(
    <span class="hljs-keyword">crossinline</span> onStart: () -&gt; <span class="hljs-type">Unit</span>, <span class="hljs-comment">// 这个会被内联</span>
    <span class="hljs-keyword">noinline</span> onComplete: () -&gt; <span class="hljs-type">Unit</span>   <span class="hljs-comment">// 这个不会被内联</span>
)</span></span> {
    <span class="hljs-comment">// 1. onStart 可以直接调用（内联）</span>
    onStart()
    
    <span class="hljs-comment">// 2. onComplete 需要被存储或传递</span>
    <span class="hljs-keyword">val</span> completionCallback = onComplete  <span class="hljs-comment">// ✅ 可以存储，因为它是 noinline</span>
    runLater(completionCallback)         <span class="hljs-comment">// ✅ 可以传递给普通函数</span>
    
    <span class="hljs-comment">// 3. 尝试存储 onStart 会报错</span>
    <span class="hljs-comment">// val startCallback = onStart  // ❌ 错误：不能存储 crossinline lambda</span>
}

<span class="hljs-comment">// 一个普通（非内联）函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">runLater</span><span class="hljs-params">(callback: () -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    <span class="hljs-comment">// 稍后执行...</span>
}·
</code></pre>
<p><strong>关键特性</strong>：</p>
<ul>
<li>变为普通函数对象，有内存开销</li>
<li>可以传递给其他非内联函数</li>
<li>可以存储在变量或属性中</li>
<li><strong>不支持非局部返回</strong>（因为它已经不是内联的了）</li>
</ul>
<h2 data-id="heading-4">0x02 <strong><code>crossinline</code>：禁止非局部返回</strong></h2>
<p><strong>作用</strong>：允许 Lambda 被内联，但<strong>禁止在 Lambda 内部使用非局部返回</strong>（即直接 <code>return</code>）。</p>
<p><strong>为什么需要它？</strong></p>
<p>当 Lambda 参数在另一个执行上下文中被调用时（如嵌套函数、另一个 Lambda），直接 <code>return</code> 会变得语义模糊，因此需要禁止</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 示例：Lambda 在嵌套上下文中执行</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">runInBackground</span><span class="hljs-params">(<span class="hljs-keyword">crossinline</span> task: () -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    <span class="hljs-comment">// 将 task 传递给另一个执行上下文</span>
    Thread {
        task()  <span class="hljs-comment">// 这里 task 是在新线程中执行，不是从 runInBackground 返回</span>
    }.start()
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testFunction</span><span class="hljs-params">()</span></span> {
    runInBackground {
        println(<span class="hljs-string">"在后台执行"</span>)
        <span class="hljs-comment">// return  // ❌ 如果允许，这个 return 是要从 testFunction 返回，还是从 Lambda 返回？</span>
        <span class="hljs-comment">// 编译器禁止这种模糊的语义，必须使用：</span>
        <span class="hljs-keyword">return</span><span class="hljs-symbol">@runInBackground</span>  <span class="hljs-comment">// ✅ 明确表示从 Lambda 返回</span>
    }
    println(<span class="hljs-string">"这行会被执行"</span>)
}
</code></pre>
<p><strong>典型应用场景</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Android 中的 View.post 就是一个典型例子</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> View.<span class="hljs-title">post</span><span class="hljs-params">(<span class="hljs-keyword">crossinline</span> action: () -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    <span class="hljs-keyword">val</span> runnable = Runnable { action() }  <span class="hljs-comment">// action 在 Runnable 中执行</span>
    handler.post(runnable)
}

<span class="hljs-comment">// 使用</span>
view.post {
    updateUI()
    <span class="hljs-comment">// 不能直接 return，必须用 return@post</span>
    <span class="hljs-keyword">if</span> (condition) <span class="hljs-keyword">return</span><span class="hljs-symbol">@post</span>  <span class="hljs-comment">// ✅ 局部返回</span>
}
</code></pre>
<p><strong>场景：结合使用多个修饰符</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">processData</span><span class="hljs-params">(
    <span class="hljs-keyword">data</span>: <span class="hljs-type">String</span>,
    <span class="hljs-keyword">noinline</span> validator: (<span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Boolean</span>, <span class="hljs-comment">// 需要传递给普通函数</span>
    <span class="hljs-keyword">crossinline</span> onSuccess: (<span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Unit</span>, <span class="hljs-comment">// 在回调中执行，禁止非局部返回</span>
    onError: (<span class="hljs-type">Exception</span>) -&gt; <span class="hljs-type">Unit</span> <span class="hljs-comment">// 默认内联，允许非局部返回</span>
)</span></span> {
    <span class="hljs-comment">// validator 被传递给普通函数</span>
    <span class="hljs-keyword">if</span> (!validateInput(<span class="hljs-keyword">data</span>, validator)) {
        onError(IllegalArgumentException(<span class="hljs-string">"无效数据"</span>))
        <span class="hljs-keyword">return</span>
    }
    
    <span class="hljs-comment">// onSuccess 在异步回调中执行</span>
    doAsyncWork(<span class="hljs-keyword">data</span>) { result -&gt;
        onSuccess(result)  <span class="hljs-comment">// 这里禁止非局部返回</span>
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">validateInput</span><span class="hljs-params">(input: <span class="hljs-type">String</span>, validator: (<span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Boolean</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">return</span> validator(input)  <span class="hljs-comment">// 普通函数接收 noinline lambda</span>
}
</code></pre>
<h2 data-id="heading-5">0x03 <strong>核心总结</strong></h2>
<ol>
<li><strong><code>noinline</code> 是“功能开关”</strong>：关闭内联，换取存储/传递能力</li>
<li><strong><code>crossinline</code> 是“安全限制”</strong>：保持内联，但禁止模糊的返回语义</li>
<li><strong>默认行为是最灵活的</strong>：既内联又允许非局部返回，但限制最多</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS：管理Cookie及数据存储]]></title>    <link>https://juejin.cn/post/7590433626560905251</link>    <guid>https://juejin.cn/post/7590433626560905251</guid>    <pubDate>2026-01-04T01:39:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590433626560905251" data-draft-id="7590433626560839715" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS：管理Cookie及数据存储"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2026-01-04T01:39:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ChinaDragon"/> <meta itemprop="url" content="https://juejin.cn/user/3966693681410840"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS：管理Cookie及数据存储
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3966693681410840/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ChinaDragon
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T01:39:54.000Z" title="Sun Jan 04 2026 01:39:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、 概述</h3>
<blockquote>
<p>Cookie是服务端发送客户端的数据。客户端持有Cookie，便于服务端快速识别身份和状态。 <br/>
当Cookie的SameSite属性未指定时，默认值为SameSite=Lax。这种设置下，Cookie仅在用户导航到其源站点时发送，不会在跨站请求中发送。</p>
</blockquote>
<h3 data-id="heading-1">二、Cookie管理</h3>
<blockquote>
<p>Web组件提供WebCookieManager类来管理Cookie信息。Cookie信息存储在应用沙箱路径下/proc/{pid}/root/data/storage/el2/base/cache/web/Cookies的文件中。 <br/>
下面以configCookieSync()接口为例，为“<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.baidu.com%25E2%2580%259D%25E8%25AE%25BE%25E7%25BD%25AE%25E5%258D%2595%25E4%25B8%25AACookie%25E7%259A%2584%25E5%2580%25BC%25E2%2580%259Cvalue%3Dtest%25E2%2580%259D%25E3%2580%2582%25E5%2585%25B6%25E4%25BB%2596Cookie%25E7%259A%2584%25E7%259B%25B8%25E5%2585%25B3%25E5%258A%259F%25E8%2583%25BD%25E5%258F%258A%25E4%25BD%25BF%25E7%2594%25A8%25EF%25BC%258C%25E8%25AF%25B7%25E5%258F%2582%25E8%2580%2583WebCookieManager()%25E6%258E%25A5%25E5%258F%25A3%25E6%2596%2587%25E6%25A1%25A3%25E3%2580%2582" target="_blank" title="http://www.baidu.com%E2%80%9D%E8%AE%BE%E7%BD%AE%E5%8D%95%E4%B8%AACookie%E7%9A%84%E5%80%BC%E2%80%9Cvalue=test%E2%80%9D%E3%80%82%E5%85%B6%E4%BB%96Cookie%E7%9A%84%E7%9B%B8%E5%85%B3%E5%8A%9F%E8%83%BD%E5%8F%8A%E4%BD%BF%E7%94%A8%EF%BC%8C%E8%AF%B7%E5%8F%82%E8%80%83WebCookieManager()%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3%E3%80%82" ref="nofollow noopener noreferrer">www.baidu.com”设置单个Cookie的值“value=test”。其他Cookie的相关功能及使用，请参考WebCookieManager()接口文档。</a></p>
</blockquote>
<p><strong>示例代码</strong></p>
<pre><code class="hljs language-bash" lang="bash">
 import { webview } from <span class="hljs-string">'@kit.ArkWeb'</span>;
 import { BusinessError } from <span class="hljs-string">'@kit.BasicServicesKit'</span>;

 @Entry
 @Component
 struct TestCookie {
   controller: webview.WebviewController = new webview.WebviewController();

   <span class="hljs-function"><span class="hljs-title">build</span></span>() {
     <span class="hljs-function"><span class="hljs-title">Column</span></span>() {
       Button(<span class="hljs-string">'configCookieSync'</span>)
         .onClick(() =&gt; {
           try {
             webview.WebCookieManager.configCookieSync('https://www.baidu.com', 'value=test123sa');
           } catch (error) {
             console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
           }
         })
       Web({ src: 'https://www.baidu.com', controller: this.controller })
     }
   }
 }
</code></pre>
<blockquote>
<p><strong>说明</strong>
Cookie每30s周期性保存到磁盘中，也可以使用接口saveCookieAsync进行强制落盘（PC/2in1和Tablet设备不会持久化session cookie，即使调用saveCookieAsync，也不会将session cookie写入磁盘）。</p>
</blockquote>
<h3 data-id="heading-2">三、缓存与存储管理</h3>
<blockquote>
<p>在访问网站时，网络资源请求通常需要较长的时间。开发者可以通过Cache和Dom Storage等手段将资源保存到本地，以提高访问同一网站的速度。</p>
</blockquote>
<h4 data-id="heading-3">3.1 Cache</h4>
<blockquote>
<p>使用 <strong>cacheMode()</strong> 配置页面资源的缓存模式，Web组件为开发者提供四种缓存模式，分别为：</p>
<ul>
<li>Default：优先使用未过期的缓存。如果缓存不存在，则从网络获取。</li>
<li>None：加载资源使用缓存。如果缓存中无该资源，则从网络中获取。</li>
<li>Online：加载资源不使用缓存。全部从网络中获取。</li>
<li>Only：只从缓存中加载资源。</li>
</ul>
</blockquote>
<p><strong>在下面的示例中，缓存设置为None模式。</strong></p>
<pre><code class="hljs language-bash" lang="bash">
 import { webview } from <span class="hljs-string">'@kit.ArkWeb'</span>;
 import { BusinessError } from <span class="hljs-string">'@kit.BasicServicesKit'</span>;

 @Entry
 @Component
 struct TestCookie {
   controller: webview.WebviewController = new webview.WebviewController();
   @State mode: CacheMode = CacheMode.None;
   <span class="hljs-function"><span class="hljs-title">build</span></span>() {
     <span class="hljs-function"><span class="hljs-title">Column</span></span>() {
       Button(<span class="hljs-string">'configCookieSync'</span>)
         .onClick(() =&gt; {
           try {
             webview.WebCookieManager.configCookieSync('https://www.baidu.com', 'value=test123sa');
           } catch (error) {
             console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
           }
         })
       Web({ src: 'https://www.baidu.com', controller: this.controller })
         .cacheMode(this.mode)
     }
   }
 }

</code></pre>
<p><strong>为了获取最新资源，开发者可以通过removeCache()接口清除已经缓存的资源，示例代码如下：</strong></p>
<pre><code class="hljs language-bash" lang="bash">import { webview } from <span class="hljs-string">'@kit.ArkWeb'</span>;
import { BusinessError } from <span class="hljs-string">'@kit.BasicServicesKit'</span>;

@Entry
@Component
struct TestCookie {
  controller: webview.WebviewController = new webview.WebviewController();
  @State mode: CacheMode = CacheMode.None;

  <span class="hljs-function"><span class="hljs-title">build</span></span>() {
    Column({ space: 20 }) {
      Button(<span class="hljs-string">'configCookieSync'</span>)
        .onClick(() =&gt; {
          try {
            webview.WebCookieManager.configCookieSync('https://www.baidu.com', 'value=test123sa');
          } catch (error) {
            console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })
      Button('removeCache')
        .onClick(() =&gt; {
          try {
            // 设置为true时同时清除rom和ram中的缓存，设置为false时只清除ram中的缓存
            this.controller.removeCache(true);
          } catch (error) {
            console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })

      Web({ src: 'https://www.baidu.com', controller: this.controller })
        .cacheMode(this.mode)
    }
  }
}

</code></pre>
<h4 data-id="heading-4">3.2 Dom Storage</h4>
<blockquote>
<p>Dom Storage包含了Session Storage和Local Storage两类。Session Storage为临时数据，其存储与释放跟随会话生命周期；Local Storage为持久化数据，保存在应用目录下。两者的数据均通过Key-Value的形式存储，在访问需要客户端存储的页面时使用。开发者可以通过Web组件的属性接口domStorageAccess()进行使能配置，示例如下：</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash">import { webview } from <span class="hljs-string">'@kit.ArkWeb'</span>;
import { BusinessError } from <span class="hljs-string">'@kit.BasicServicesKit'</span>;

@Entry
@Component
struct TestCookie {
  controller: webview.WebviewController = new webview.WebviewController();
  @State mode: CacheMode = CacheMode.None;

  <span class="hljs-function"><span class="hljs-title">build</span></span>() {
    Column({ space: 20 }) {
      Button(<span class="hljs-string">'configCookieSync'</span>)
        .onClick(() =&gt; {
          try {
            webview.WebCookieManager.configCookieSync('https://www.baidu.com', 'value=test123sa');
          } catch (error) {
            console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })
      Button('removeCache')
        .onClick(() =&gt; {
          try {
            // 设置为true时同时清除rom和ram中的缓存，设置为false时只清除ram中的缓存
            this.controller.removeCache(true);
          } catch (error) {
            console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })

      Web({ src: 'https://www.baidu.com', controller: this.controller })
        .cacheMode(this.mode)
        .domStorageAccess(true)
    }
  }
}

</code></pre>
<h3 data-id="heading-5">四、获取指定url对应cookie的值</h3>
<blockquote>
<p>fetchCookieSync
获取指定url对应cookie的值。</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash">static fetchCookieSync(url: string, incognito?: boolean): string
</code></pre>
<blockquote>
<p><strong>说明</strong>
系统会自动清理过期的cookie，对于同名key的数据，新数据将会覆盖前一个数据。 <br/>
为了获取可正常使用的cookie值，fetchCookieSync需传入完整链接。 <br/>
fetchCookieSync用于获取所有的cookie值，每条cookie值之间会通过"; "进行分隔，但无法单独获取某一条特定的cookie值。</p>
</blockquote>
<blockquote>
<p><strong>系统能力</strong>： SystemCapability.Web.Webview.Core</p>
</blockquote>
<p><strong>参数</strong></p>























<table><thead><tr><th align="left">参数名</th><th align="left">类型</th><th align="left">必填</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">url</td><td align="left">string</td><td align="left">是</td><td align="left">要获取的cookie所属的url，建议使用完整的url。</td></tr><tr><td align="left">incognito</td><td align="left">boolean</td><td align="left">否</td><td align="left">true表示获取隐私模式下webview的内存cookies，false表示正常非隐私模式下的cookies。<br/>默认值：false。</td></tr></tbody></table>
<p><strong>返回值：</strong></p>













<table><thead><tr><th align="left">类型</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">string</td><td align="left">指定url对应的cookie的值。</td></tr></tbody></table>
<blockquote>
<p><strong>示例效果图</strong> <br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17e1560d4ff840c78c1a1a30dcc464c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hpbmFEcmFnb24=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095606&amp;x-signature=dqHU%2FITycjvt81CyQvj8lqyCxdU%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7df999876564b2f9407cc8112fec54a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hpbmFEcmFnb24=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095606&amp;x-signature=fPQ4yCIuoA86SQFP%2BXwquMzG5AI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
</blockquote>
<p><strong>示例代码</strong></p>
<pre><code class="hljs language-bash" lang="bash">import { webview } from <span class="hljs-string">'@kit.ArkWeb'</span>;
import { BusinessError } from <span class="hljs-string">'@kit.BasicServicesKit'</span>;

@Entry
@Component
struct TestCookie {
  controller: webview.WebviewController = new webview.WebviewController();
  @State mode: CacheMode = CacheMode.None;

  <span class="hljs-function"><span class="hljs-title">build</span></span>() {
    Column({ space: 20 }) {
      Button(<span class="hljs-string">'configCookieSync'</span>)
        .onClick(() =&gt; {
          try {
            webview.WebCookieManager.configCookieSync('https://www.baidu.com', 'value=test123sa');
          } catch (error) {
            console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })

      Button('fetchCookieSync')
        .onClick(() =&gt; {
          try {
            let value = webview.WebCookieManager.fetchCookieSync('https://www.baidu.com');
            console.info("获取指定url对应cookie的值 fetchCookieSync cookie = " + value);
          } catch (error) {
            console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })

      Button('removeCache')
        .onClick(() =&gt; {
          try {
            // 设置为true时同时清除rom和ram中的缓存，设置为false时只清除ram中的缓存
            this.controller.removeCache(true);
          } catch (error) {
            console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })

      Web({ src: 'https://www.baidu.com', controller: this.controller })
        .cacheMode(this.mode)
        .domStorageAccess(true)
    }
  }
}

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C# 串口通信不再踩坑：一次发送、分包接收的零丢失实战秘籍]]></title>    <link>https://juejin.cn/post/7590403249560928271</link>    <guid>https://juejin.cn/post/7590403249560928271</guid>    <pubDate>2026-01-03T12:21:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590403249560928271" data-draft-id="7587261929383968820" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C# 串口通信不再踩坑：一次发送、分包接收的零丢失实战秘籍"/> <meta itemprop="keywords" content="后端,C#,.NET"/> <meta itemprop="datePublished" content="2026-01-03T12:21:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小码编匠"/> <meta itemprop="url" content="https://juejin.cn/user/1308876155395739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C# 串口通信不再踩坑：一次发送、分包接收的零丢失实战秘籍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1308876155395739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小码编匠
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T12:21:39.000Z" title="Sat Jan 03 2026 12:21:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>工业控制、物联网设备通信中，是否遇到过这样的场景：向设备发送一个简单的查询指令，却发现返回的数据总是"分批到达"？明明应该收到完整的20字节响应，却只能收到几个零散的数据包？</p>
<p><strong>别急，这不是你的代码有问题！</strong></p>
<p>这是串口通信中最常见的"分包接收"现象。设备可能一次发送10字节，下一次发送剩余的10字节，而我们的程序却不知道什么时候才算接收完成。</p>
<p>今天我们就来彻底解决这个让无数 C# 开发头疼的问题！</p>
<h3 data-id="heading-1">为什么会分包接收？</h3>
<h4 data-id="heading-2">根本原因</h4>
<p>串口通信是<strong>异步</strong>的，数据传输会受到以下因素影响：</p>
<p><strong>硬件缓冲区大小限制</strong></p>
<p><strong>设备处理速度差异</strong></p>
<p><strong>网络延迟</strong>（对于串口转以太网设备）</p>
<p><strong>系统调度</strong></p>
<p>这些因素导致原本连续的数据流被操作系统或中间设备拆分成多个小块，逐次送达应用程序。</p>
<h4 data-id="heading-3">传统方案的痛点</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// ❌ 错误示例：只能收到第一包数据</span>
serialPort.Write(command, <span class="hljs-number">0</span>, command.Length);
Thread.Sleep(<span class="hljs-number">100</span>); <span class="hljs-comment">// 固定等待时间</span>
<span class="hljs-built_in">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">1024</span>];
<span class="hljs-built_in">int</span> count = serialPort.Read(buffer, <span class="hljs-number">0</span>, <span class="hljs-number">1024</span>); <span class="hljs-comment">// 可能只读到部分数据</span>
</code></pre>
<p>这种写法的问题包括：</p>
<p>固定等待时间不可靠</p>
<p>无法判断数据是否接收完整</p>
<p>容易丢失后续数据包</p>
<h3 data-id="heading-4">四种灵活接收策略</h3>
<p>为应对不同应用场景，我们设计了以下四种策略：</p>
<h4 data-id="heading-5">方案一：数据间隔超时判断（⭐推荐）</h4>
<p><strong>适用场景</strong>：不知道数据长度，但设备发送完毕后会有明显时间间隔。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">SendQueryWithGapTimeout</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] command, <span class="hljs-built_in">int</span> gapTimeoutMs = <span class="hljs-number">100</span>, <span class="hljs-built_in">int</span> maxWaitMs = <span class="hljs-number">3000</span></span>)</span>
{
    <span class="hljs-comment">// 清空缓冲区并开始接收</span>
    <span class="hljs-keyword">lock</span> (bufferLock)
    {
        receivedBuffer.Clear();
        isWaitingForResponse = <span class="hljs-literal">true</span>;
        lastReceiveTime = DateTime.Now;
    }
    <span class="hljs-comment">// 发送指令</span>
    serialPort.Write(command, <span class="hljs-number">0</span>, command.Length);
    
    DateTime startTime = DateTime.Now;
    
    <span class="hljs-keyword">while</span> ((DateTime.Now - startTime).TotalMilliseconds &lt; maxWaitMs)
    {
        Thread.Sleep(<span class="hljs-number">10</span>);
        
        <span class="hljs-keyword">lock</span> (bufferLock)
        {
            <span class="hljs-comment">// 🔥 关键逻辑：有数据且间隔超时则认为接收完成</span>
            <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt; <span class="hljs-number">0</span> &amp;&amp; 
                (DateTime.Now - lastReceiveTime).TotalMilliseconds &gt; gapTimeoutMs)
            {
                isWaitingForResponse = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">return</span> receivedBuffer.ToArray();
            }
        }
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<blockquote>
<p>实际业务中，这个能解决大部分问题。</p>
</blockquote>
<h4 data-id="heading-6">方案二：结束符判断</h4>
<p><strong>适用场景</strong>：数据以特定字符结尾（如 <code>\r\n</code>、<code>\0</code> 等）。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">SendQueryWithEndMarker</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] command, <span class="hljs-built_in">byte</span>[] endMarker, <span class="hljs-built_in">int</span> maxWaitMs = <span class="hljs-number">3000</span></span>)</span>
{
    <span class="hljs-comment">// ... 发送逻辑相同 ...</span>
    
    <span class="hljs-keyword">while</span> ((DateTime.Now - startTime).TotalMilliseconds &lt; maxWaitMs)
    {
        <span class="hljs-keyword">lock</span> (bufferLock)
        {
            <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt;= endMarker.Length)
            {
                <span class="hljs-comment">// 🔥 检查缓冲区末尾是否包含结束标记</span>
                <span class="hljs-built_in">bool</span> foundEndMarker = <span class="hljs-literal">true</span>;
                <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; endMarker.Length; i++)
                {
                    <span class="hljs-keyword">if</span> (receivedBuffer[receivedBuffer.Count - endMarker.Length + i] != endMarker[i])
                    {
                        foundEndMarker = <span class="hljs-literal">false</span>;
                        <span class="hljs-keyword">break</span>;
                    }
                }
                
                <span class="hljs-keyword">if</span> (foundEndMarker)
                {
                    <span class="hljs-keyword">return</span> receivedBuffer.ToArray();
                }
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-7">方案三：协议帧结构判断</h4>
<p><strong>适用场景</strong>：数据有固定帧头和长度字段（如 Modbus 协议）。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">SendQueryWithFrameProtocol</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] command, <span class="hljs-built_in">byte</span> frameHeader, <span class="hljs-built_in">int</span> lengthFieldOffset, <span class="hljs-built_in">int</span> lengthFieldSize = <span class="hljs-number">1</span></span>)</span>
{
    <span class="hljs-comment">// ... 发送逻辑 ...</span>
    
    <span class="hljs-keyword">while</span> (<span class="hljs-comment">/* 超时检查 */</span>)
    {
        <span class="hljs-keyword">lock</span> (bufferLock)
        {
            <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt; lengthFieldOffset + lengthFieldSize)
            {
                <span class="hljs-comment">// 检查帧头</span>
                <span class="hljs-keyword">if</span> (receivedBuffer[<span class="hljs-number">0</span>] == frameHeader)
                {
                    <span class="hljs-comment">// 🔥 从长度字段获取数据长度</span>
                    <span class="hljs-built_in">int</span> dataLength = lengthFieldSize == <span class="hljs-number">1</span> ? 
                        receivedBuffer[lengthFieldOffset] : 
                        (receivedBuffer[lengthFieldOffset] &lt;&lt; <span class="hljs-number">8</span>) | receivedBuffer[lengthFieldOffset + <span class="hljs-number">1</span>];
                    
                    <span class="hljs-built_in">int</span> expectedFrameLength = lengthFieldOffset + lengthFieldSize + dataLength;
                    
                    <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt;= expectedFrameLength)
                    {
                        <span class="hljs-keyword">return</span> receivedBuffer.Take(expectedFrameLength).ToArray();
                    }
                }
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-8">方案四：组合策略（⭐⭐推荐）</h4>
<p><strong>最灵活的方案</strong>，同时使用多种判断条件：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">SendQueryWithCombinedStrategy</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] command,
    <span class="hljs-built_in">int</span> gapTimeoutMs = <span class="hljs-number">100</span>,     // 数据间隔超时
    <span class="hljs-built_in">byte</span>[] endMarker = <span class="hljs-literal">null</span>,    // 结束标记  
    <span class="hljs-built_in">int</span>? maxLength = <span class="hljs-literal">null</span>,      // 最大长度限制
    <span class="hljs-built_in">int</span> maxWaitMs = <span class="hljs-number">3000</span></span>)       <span class="hljs-comment">// 总超时时间</span></span>
{
    <span class="hljs-comment">// ... 发送逻辑 ...</span>
    
    <span class="hljs-keyword">while</span> (<span class="hljs-comment">/* 总超时检查 */</span>)
    {
        <span class="hljs-keyword">lock</span> (bufferLock)
        {
            <span class="hljs-keyword">if</span> (receivedBuffer.Count == <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;
            
            <span class="hljs-comment">// 🔥 条件1：达到最大长度限制</span>
            <span class="hljs-keyword">if</span> (maxLength.HasValue &amp;&amp; receivedBuffer.Count &gt;= maxLength.Value)
                <span class="hljs-keyword">return</span> receivedBuffer.ToArray();
            
            <span class="hljs-comment">// 🔥 条件2：发现结束标记</span>
            <span class="hljs-keyword">if</span> (endMarker != <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-comment">/* 检查结束标记逻辑 */</span>)
                <span class="hljs-keyword">return</span> receivedBuffer.ToArray();
            
            <span class="hljs-comment">// 🔥 条件3：数据间隔超时</span>
            <span class="hljs-keyword">if</span> ((DateTime.Now - lastReceiveTime).TotalMilliseconds &gt; gapTimeoutMs)
                <span class="hljs-keyword">return</span> receivedBuffer.ToArray();
        }
    }
}
</code></pre>
<h3 data-id="heading-9">核心机制：数据接收事件</h3>
<p>所有策略都依赖于统一的数据接收事件处理：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnDataReceived</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> sender, SerialDataReceivedEventArgs e</span>)</span>
{
    <span class="hljs-keyword">if</span> (!isWaitingForResponse) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">try</span>
    {
        <span class="hljs-built_in">int</span> bytesToRead = serialPort.BytesToRead;
        <span class="hljs-keyword">if</span> (bytesToRead &gt; <span class="hljs-number">0</span>)
        {
            <span class="hljs-built_in">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[bytesToRead];
            <span class="hljs-built_in">int</span> bytesRead = serialPort.Read(buffer, <span class="hljs-number">0</span>, bytesToRead);
            <span class="hljs-keyword">lock</span> (bufferLock)
            {
                receivedBuffer.AddRange(buffer);
                lastReceiveTime = DateTime.Now; <span class="hljs-comment">// 🔥 更新最后接收时间</span>
                Console.WriteLine(<span class="hljs-string">$"收到数据包 (<span class="hljs-subst">{bytesRead}</span> 字节): <span class="hljs-subst">{BitConverter.ToString(buffer, <span class="hljs-number">0</span>, bytesRead)}</span>"</span>);
            }
        }
    }
    <span class="hljs-keyword">catch</span> (Exception ex)
    {
        Console.WriteLine(<span class="hljs-string">$"数据接收异常: <span class="hljs-subst">{ex.Message}</span>"</span>);
    }
}
</code></pre>
<h3 data-id="heading-10">完整代码</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> System.IO.Ports;
<span class="hljs-keyword">using</span> System.Linq;
<span class="hljs-keyword">using</span> System.Text;
<span class="hljs-keyword">using</span> System.Threading.Tasks;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">AppFlexSerialPort</span>
{
    <span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title">FlexibleSerialPort</span>
    {
        <span class="hljs-keyword">private</span> SerialPort serialPort;
        <span class="hljs-keyword">private</span> List&lt;<span class="hljs-built_in">byte</span>&gt; receivedBuffer;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">object</span> bufferLock = <span class="hljs-keyword">new</span> <span class="hljs-built_in">object</span>();
        <span class="hljs-keyword">private</span> Timer timeoutTimer;
        <span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span> isWaitingForResponse = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">private</span> DateTime lastReceiveTime;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> dataGapTimeout = <span class="hljs-number">100</span>; <span class="hljs-comment">// 数据间隔超时时间(ms)</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">FlexibleSerialPort</span>()</span>
        {
            receivedBuffer = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">byte</span>&gt;();
        }

        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 初始化串口</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">InitializePort</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> portName = <span class="hljs-string">"COM1"</span>, <span class="hljs-built_in">int</span> baudRate = <span class="hljs-number">9600</span>,
            Parity parity = Parity.None, <span class="hljs-built_in">int</span> dataBits = <span class="hljs-number">8</span>, StopBits stopBits = StopBits.One</span>)</span>
        {
            <span class="hljs-keyword">try</span>
            {
                serialPort = <span class="hljs-keyword">new</span> SerialPort(portName, baudRate, parity, dataBits, stopBits);
                serialPort.ReadTimeout = <span class="hljs-number">1000</span>;
                serialPort.WriteTimeout = <span class="hljs-number">1000</span>;
                serialPort.DataReceived += OnDataReceived;
                serialPort.Open();
                Console.WriteLine(<span class="hljs-string">$"串口 <span class="hljs-subst">{portName}</span> 已成功打开"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
            <span class="hljs-keyword">catch</span> (Exception ex)
            {
                Console.WriteLine(<span class="hljs-string">$"串口初始化失败: <span class="hljs-subst">{ex.Message}</span>"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        }

        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 方案1: 基于数据间隔超时判断接收完成</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 适用于：不知道数据长度，但设备发送完后会有明显的时间间隔</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">SendQueryWithGapTimeout</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] command, <span class="hljs-built_in">int</span> gapTimeoutMs = <span class="hljs-number">100</span>, <span class="hljs-built_in">int</span> maxWaitMs = <span class="hljs-number">3000</span></span>)</span>
        {
            <span class="hljs-keyword">if</span> (serialPort == <span class="hljs-literal">null</span> || !serialPort.IsOpen)
            {
                Console.WriteLine(<span class="hljs-string">"串口未打开"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
            <span class="hljs-keyword">lock</span> (bufferLock)
            {
                receivedBuffer.Clear();
                isWaitingForResponse = <span class="hljs-literal">true</span>;
                lastReceiveTime = DateTime.Now;
            }
            <span class="hljs-keyword">try</span>
            {
                <span class="hljs-comment">// 发送查询指令</span>
                serialPort.Write(command, <span class="hljs-number">0</span>, command.Length);
                Console.WriteLine(<span class="hljs-string">$"已发送查询指令: <span class="hljs-subst">{BitConverter.ToString(command)}</span>"</span>);
                DateTime startTime = DateTime.Now;
                DateTime lastCheckTime = DateTime.Now;
                <span class="hljs-built_in">int</span> lastBufferSize = <span class="hljs-number">0</span>;
                <span class="hljs-keyword">while</span> ((DateTime.Now - startTime).TotalMilliseconds &lt; maxWaitMs)
                {
                    Thread.Sleep(<span class="hljs-number">10</span>);
                    <span class="hljs-keyword">lock</span> (bufferLock)
                    {
                        <span class="hljs-comment">// 如果有数据且数据间隔超过指定时间，认为接收完成</span>
                        <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt; <span class="hljs-number">0</span> &amp;&amp;
                            (DateTime.Now - lastReceiveTime).TotalMilliseconds &gt; gapTimeoutMs)
                        {
                            isWaitingForResponse = <span class="hljs-literal">false</span>;
                            <span class="hljs-built_in">byte</span>[] result = receivedBuffer.ToArray();
                            Console.WriteLine(<span class="hljs-string">$"基于间隔超时判断接收完成，共收到 <span class="hljs-subst">{result.Length}</span> 字节"</span>);
                            <span class="hljs-keyword">return</span> result;
                        }
                    }
                }
                <span class="hljs-comment">// 最大等待时间超时</span>
                isWaitingForResponse = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">lock</span> (bufferLock)
                {
                    <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt; <span class="hljs-number">0</span>)
                    {
                        <span class="hljs-built_in">byte</span>[] result = receivedBuffer.ToArray();
                        Console.WriteLine(<span class="hljs-string">$"最大等待时间超时，收到 <span class="hljs-subst">{result.Length}</span> 字节"</span>);
                        <span class="hljs-keyword">return</span> result;
                    }
                }
                Console.WriteLine(<span class="hljs-string">"接收超时，未收到任何数据"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
            <span class="hljs-keyword">catch</span> (Exception ex)
            {
                Console.WriteLine(<span class="hljs-string">$"发送指令失败: <span class="hljs-subst">{ex.Message}</span>"</span>);
                isWaitingForResponse = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
        }

        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 方案2: 基于结束符判断接收完成</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 适用于：数据以特定字符或字节序列结尾</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">SendQueryWithEndMarker</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] command, <span class="hljs-built_in">byte</span>[] endMarker, <span class="hljs-built_in">int</span> maxWaitMs = <span class="hljs-number">3000</span></span>)</span>
        {
            <span class="hljs-keyword">if</span> (serialPort == <span class="hljs-literal">null</span> || !serialPort.IsOpen)
            {
                Console.WriteLine(<span class="hljs-string">"串口未打开"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
            <span class="hljs-keyword">lock</span> (bufferLock)
            {
                receivedBuffer.Clear();
                isWaitingForResponse = <span class="hljs-literal">true</span>;
            }
            <span class="hljs-keyword">try</span>
            {
                serialPort.Write(command, <span class="hljs-number">0</span>, command.Length);
                Console.WriteLine(<span class="hljs-string">$"已发送查询指令: <span class="hljs-subst">{BitConverter.ToString(command)}</span>"</span>);
                DateTime startTime = DateTime.Now;
                <span class="hljs-keyword">while</span> ((DateTime.Now - startTime).TotalMilliseconds &lt; maxWaitMs)
                {
                    Thread.Sleep(<span class="hljs-number">10</span>);
                    <span class="hljs-keyword">lock</span> (bufferLock)
                    {
                        <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt;= endMarker.Length)
                        {
                            <span class="hljs-comment">// 检查缓冲区末尾是否包含结束标记</span>
                            <span class="hljs-built_in">bool</span> foundEndMarker = <span class="hljs-literal">true</span>;
                            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; endMarker.Length; i++)
                            {
                                <span class="hljs-keyword">if</span> (receivedBuffer[receivedBuffer.Count - endMarker.Length + i] != endMarker[i])
                                {
                                    foundEndMarker = <span class="hljs-literal">false</span>;
                                    <span class="hljs-keyword">break</span>;
                                }
                            }
                            <span class="hljs-keyword">if</span> (foundEndMarker)
                            {
                                isWaitingForResponse = <span class="hljs-literal">false</span>;
                                <span class="hljs-built_in">byte</span>[] result = receivedBuffer.ToArray();
                                Console.WriteLine(<span class="hljs-string">$"发现结束标记，接收完成，共收到 <span class="hljs-subst">{result.Length}</span> 字节"</span>);
                                <span class="hljs-keyword">return</span> result;
                            }
                        }
                    }
                }
                <span class="hljs-comment">// 超时处理</span>
                isWaitingForResponse = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">lock</span> (bufferLock)
                {
                    <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt; <span class="hljs-number">0</span>)
                    {
                        <span class="hljs-built_in">byte</span>[] result = receivedBuffer.ToArray();
                        Console.WriteLine(<span class="hljs-string">$"等待结束标记超时，收到 <span class="hljs-subst">{result.Length}</span> 字节"</span>);
                        <span class="hljs-keyword">return</span> result;
                    }
                }
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
            <span class="hljs-keyword">catch</span> (Exception ex)
            {
                Console.WriteLine(<span class="hljs-string">$"发送指令失败: <span class="hljs-subst">{ex.Message}</span>"</span>);
                isWaitingForResponse = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
        }

        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 方案3: 基于协议帧结构判断接收完成</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 适用于：数据有固定的帧头和长度字段</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">SendQueryWithFrameProtocol</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] command, <span class="hljs-built_in">byte</span> frameHeader, <span class="hljs-built_in">int</span> lengthFieldOffset,
            <span class="hljs-built_in">int</span> lengthFieldSize = <span class="hljs-number">1</span>, <span class="hljs-built_in">int</span> maxWaitMs = <span class="hljs-number">3000</span></span>)</span>
        {
            <span class="hljs-keyword">if</span> (serialPort == <span class="hljs-literal">null</span> || !serialPort.IsOpen)
            {
                Console.WriteLine(<span class="hljs-string">"串口未打开"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
            <span class="hljs-keyword">lock</span> (bufferLock)
            {
                receivedBuffer.Clear();
                isWaitingForResponse = <span class="hljs-literal">true</span>;
            }
            <span class="hljs-keyword">try</span>
            {
                serialPort.Write(command, <span class="hljs-number">0</span>, command.Length);
                Console.WriteLine(<span class="hljs-string">$"已发送查询指令: <span class="hljs-subst">{BitConverter.ToString(command)}</span>"</span>);
                DateTime startTime = DateTime.Now;
                <span class="hljs-keyword">while</span> ((DateTime.Now - startTime).TotalMilliseconds &lt; maxWaitMs)
                {
                    Thread.Sleep(<span class="hljs-number">10</span>);
                    <span class="hljs-keyword">lock</span> (bufferLock)
                    {
                        <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt; lengthFieldOffset + lengthFieldSize)
                        {
                            <span class="hljs-comment">// 检查帧头</span>
                            <span class="hljs-keyword">if</span> (receivedBuffer[<span class="hljs-number">0</span>] == frameHeader)
                            {
                                <span class="hljs-comment">// 获取数据长度</span>
                                <span class="hljs-built_in">int</span> dataLength = <span class="hljs-number">0</span>;
                                <span class="hljs-keyword">if</span> (lengthFieldSize == <span class="hljs-number">1</span>)
                                {
                                    dataLength = receivedBuffer[lengthFieldOffset];
                                }
                                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (lengthFieldSize == <span class="hljs-number">2</span>)
                                {
                                    dataLength = (receivedBuffer[lengthFieldOffset] &lt;&lt; <span class="hljs-number">8</span>) | receivedBuffer[lengthFieldOffset + <span class="hljs-number">1</span>];
                                }
                                <span class="hljs-built_in">int</span> expectedFrameLength = lengthFieldOffset + lengthFieldSize + dataLength;
                                <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt;= expectedFrameLength)
                                {
                                    isWaitingForResponse = <span class="hljs-literal">false</span>;
                                    <span class="hljs-built_in">byte</span>[] result = receivedBuffer.Take(expectedFrameLength).ToArray();
                                    Console.WriteLine(<span class="hljs-string">$"根据帧长度判断接收完成，共收到 <span class="hljs-subst">{result.Length}</span> 字节"</span>);
                                    <span class="hljs-keyword">return</span> result;
                                }
                            }
                        }
                    }
                }
                <span class="hljs-comment">// 超时处理</span>
                isWaitingForResponse = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">lock</span> (bufferLock)
                {
                    <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt; <span class="hljs-number">0</span>)
                    {
                        <span class="hljs-built_in">byte</span>[] result = receivedBuffer.ToArray();
                        Console.WriteLine(<span class="hljs-string">$"帧协议解析超时，收到 <span class="hljs-subst">{result.Length}</span> 字节"</span>);
                        <span class="hljs-keyword">return</span> result;
                    }
                }
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
            <span class="hljs-keyword">catch</span> (Exception ex)
            {
                Console.WriteLine(<span class="hljs-string">$"发送指令失败: <span class="hljs-subst">{ex.Message}</span>"</span>);
                isWaitingForResponse = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
        }

        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 方案4: 组合策略 - 最灵活的方案</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 同时使用多种判断条件，任一条件满足就结束接收</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">SendQueryWithCombinedStrategy</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] command,
            <span class="hljs-built_in">int</span> gapTimeoutMs = <span class="hljs-number">100</span>,
            <span class="hljs-built_in">byte</span>[] endMarker = <span class="hljs-literal">null</span>,
            <span class="hljs-built_in">int</span>? maxLength = <span class="hljs-literal">null</span>,
            <span class="hljs-built_in">int</span> maxWaitMs = <span class="hljs-number">3000</span></span>)</span>
        {
            <span class="hljs-keyword">if</span> (serialPort == <span class="hljs-literal">null</span> || !serialPort.IsOpen)
            {
                Console.WriteLine(<span class="hljs-string">"串口未打开"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
            <span class="hljs-keyword">lock</span> (bufferLock)
            {
                receivedBuffer.Clear();
                isWaitingForResponse = <span class="hljs-literal">true</span>;
                lastReceiveTime = DateTime.Now;
            }
            <span class="hljs-keyword">try</span>
            {
                serialPort.Write(command, <span class="hljs-number">0</span>, command.Length);
                Console.WriteLine(<span class="hljs-string">$"已发送查询指令: <span class="hljs-subst">{BitConverter.ToString(command)}</span>"</span>);
                DateTime startTime = DateTime.Now;
                <span class="hljs-keyword">while</span> ((DateTime.Now - startTime).TotalMilliseconds &lt; maxWaitMs)
                {
                    Thread.Sleep(<span class="hljs-number">10</span>);
                    <span class="hljs-keyword">lock</span> (bufferLock)
                    {
                        <span class="hljs-keyword">if</span> (receivedBuffer.Count == <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;
                        <span class="hljs-comment">// 条件1: 检查最大长度限制</span>
                        <span class="hljs-keyword">if</span> (maxLength.HasValue &amp;&amp; receivedBuffer.Count &gt;= maxLength.Value)
                        {
                            isWaitingForResponse = <span class="hljs-literal">false</span>;
                            <span class="hljs-built_in">byte</span>[] result = receivedBuffer.ToArray();
                            Console.WriteLine(<span class="hljs-string">$"达到最大长度限制，接收完成，共收到 <span class="hljs-subst">{result.Length}</span> 字节"</span>);
                            <span class="hljs-keyword">return</span> result;
                        }
                        <span class="hljs-comment">// 条件2: 检查结束标记</span>
                        <span class="hljs-keyword">if</span> (endMarker != <span class="hljs-literal">null</span> &amp;&amp; receivedBuffer.Count &gt;= endMarker.Length)
                        {
                            <span class="hljs-built_in">bool</span> foundEndMarker = <span class="hljs-literal">true</span>;
                            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; endMarker.Length; i++)
                            {
                                <span class="hljs-keyword">if</span> (receivedBuffer[receivedBuffer.Count - endMarker.Length + i] != endMarker[i])
                                {
                                    foundEndMarker = <span class="hljs-literal">false</span>;
                                    <span class="hljs-keyword">break</span>;
                                }
                            }
                            <span class="hljs-keyword">if</span> (foundEndMarker)
                            {
                                isWaitingForResponse = <span class="hljs-literal">false</span>;
                                <span class="hljs-built_in">byte</span>[] result = receivedBuffer.ToArray();
                                Console.WriteLine(<span class="hljs-string">$"发现结束标记，接收完成，共收到 <span class="hljs-subst">{result.Length}</span> 字节"</span>);
                                <span class="hljs-keyword">return</span> result;
                            }
                        }
                        <span class="hljs-comment">// 条件3: 检查数据间隔超时</span>
                        <span class="hljs-keyword">if</span> ((DateTime.Now - lastReceiveTime).TotalMilliseconds &gt; gapTimeoutMs)
                        {
                            isWaitingForResponse = <span class="hljs-literal">false</span>;
                            <span class="hljs-built_in">byte</span>[] result = receivedBuffer.ToArray();
                            Console.WriteLine(<span class="hljs-string">$"数据间隔超时，接收完成，共收到 <span class="hljs-subst">{result.Length}</span> 字节"</span>);
                            <span class="hljs-keyword">return</span> result;
                        }
                    }
                }
                <span class="hljs-comment">// 最大等待时间超时</span>
                isWaitingForResponse = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">lock</span> (bufferLock)
                {
                    <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt; <span class="hljs-number">0</span>)
                    {
                        <span class="hljs-built_in">byte</span>[] result = receivedBuffer.ToArray();
                        Console.WriteLine(<span class="hljs-string">$"最大等待时间超时，收到 <span class="hljs-subst">{result.Length}</span> 字节"</span>);
                        <span class="hljs-keyword">return</span> result;
                    }
                }
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
            <span class="hljs-keyword">catch</span> (Exception ex)
            {
                Console.WriteLine(<span class="hljs-string">$"发送指令失败: <span class="hljs-subst">{ex.Message}</span>"</span>);
                isWaitingForResponse = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
        }

        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 数据接收事件处理</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnDataReceived</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> sender, SerialDataReceivedEventArgs e</span>)</span>
        {
            <span class="hljs-keyword">if</span> (!isWaitingForResponse) <span class="hljs-keyword">return</span>;
            <span class="hljs-keyword">try</span>
            {
                <span class="hljs-built_in">int</span> bytesToRead = serialPort.BytesToRead;
                <span class="hljs-keyword">if</span> (bytesToRead &gt; <span class="hljs-number">0</span>)
                {
                    <span class="hljs-built_in">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[bytesToRead];
                    <span class="hljs-built_in">int</span> bytesRead = serialPort.Read(buffer, <span class="hljs-number">0</span>, bytesToRead);
                    <span class="hljs-keyword">lock</span> (bufferLock)
                    {
                        receivedBuffer.AddRange(buffer);
                        lastReceiveTime = DateTime.Now; <span class="hljs-comment">// 更新最后接收时间</span>
                        Console.WriteLine(<span class="hljs-string">$"收到数据包 (<span class="hljs-subst">{bytesRead}</span> 字节): <span class="hljs-subst">{BitConverter.ToString(buffer, <span class="hljs-number">0</span>, bytesRead)}</span>"</span>);
                        Console.WriteLine(<span class="hljs-string">$"当前缓冲区总计: <span class="hljs-subst">{receivedBuffer.Count}</span> 字节"</span>);
                    }
                }
            }
            <span class="hljs-keyword">catch</span> (Exception ex)
            {
                Console.WriteLine(<span class="hljs-string">$"数据接收处理异常: <span class="hljs-subst">{ex.Message}</span>"</span>);
            }
        }

        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 关闭串口</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Close</span>()</span>
        {
            <span class="hljs-keyword">try</span>
            {
                isWaitingForResponse = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">if</span> (serialPort != <span class="hljs-literal">null</span> &amp;&amp; serialPort.IsOpen)
                {
                    serialPort.Close();
                    Console.WriteLine(<span class="hljs-string">"串口已关闭"</span>);
                }
            }
            <span class="hljs-keyword">catch</span> (Exception ex)
            {
                Console.WriteLine(<span class="hljs-string">$"关闭串口异常: <span class="hljs-subst">{ex.Message}</span>"</span>);
            }
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span>[] <span class="hljs-title">GetAvailablePorts</span>()</span>
        {
            <span class="hljs-keyword">return</span> SerialPort.GetPortNames();
        }
    }
}
</code></pre>
<h3 data-id="heading-11">完整代码</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">AppFlexSerialPort</span>
{
    <span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span>
    {
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-built_in">string</span>[] args</span>)</span>
        {
            FlexibleSerialPort comm = <span class="hljs-keyword">new</span> FlexibleSerialPort();
            <span class="hljs-keyword">try</span>
            {
                <span class="hljs-keyword">if</span> (comm.InitializePort(<span class="hljs-string">"COM1"</span>, <span class="hljs-number">9600</span>))
                {
                    <span class="hljs-built_in">byte</span>[] queryCommand = { <span class="hljs-number">0x01</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x84</span>, <span class="hljs-number">0x0A</span> };
                    Console.WriteLine(<span class="hljs-string">"=== 方案1: 基于数据间隔判断 ==="</span>);
                    <span class="hljs-built_in">byte</span>[] response1 = comm.SendQueryWithGapTimeout(queryCommand, <span class="hljs-number">150</span>, <span class="hljs-number">3000</span>);
                    Thread.Sleep(<span class="hljs-number">1000</span>);
                    Console.WriteLine(<span class="hljs-string">"\n=== 方案2: 基于结束符判断 ==="</span>);
                    <span class="hljs-built_in">byte</span>[] endMarker = { <span class="hljs-number">0x0D</span>, <span class="hljs-number">0x0A</span> }; <span class="hljs-comment">// CR LF</span>
                    <span class="hljs-built_in">byte</span>[] response2 = comm.SendQueryWithEndMarker(queryCommand, endMarker);
                    Thread.Sleep(<span class="hljs-number">1000</span>);
                    Console.WriteLine(<span class="hljs-string">"\n=== 方案3: 基于协议帧结构判断 ==="</span>);
                    <span class="hljs-built_in">byte</span>[] response3 = comm.SendQueryWithFrameProtocol(queryCommand, <span class="hljs-number">0x01</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>);
                    Thread.Sleep(<span class="hljs-number">1000</span>);
                    Console.WriteLine(<span class="hljs-string">"\n=== 方案4: 组合策略 ==="</span>);
                    <span class="hljs-built_in">byte</span>[] response4 = comm.SendQueryWithCombinedStrategy(
                        queryCommand,
                        gapTimeoutMs: <span class="hljs-number">100</span>,           <span class="hljs-comment">// 数据间隔100ms</span>
                        endMarker: <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[] { <span class="hljs-number">0x0A</span> }, <span class="hljs-comment">// 或者以LF结尾</span>
                        maxLength: <span class="hljs-number">50</span>,               <span class="hljs-comment">// 或者最多50字节</span>
                        maxWaitMs: <span class="hljs-number">3000</span>              <span class="hljs-comment">// 最多等待3秒</span>
                    );
                }
                Console.WriteLine(<span class="hljs-string">"按任意键退出..."</span>);
                Console.ReadKey();
            }
            <span class="hljs-keyword">catch</span> (Exception ex)
            {
                Console.WriteLine(<span class="hljs-string">$"程序异常: <span class="hljs-subst">{ex.Message}</span>"</span>);
            }
            <span class="hljs-keyword">finally</span>
            {
                comm.Close();
            }
        }
    }
}
</code></pre>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/D1DJjmDXQdnFmJFU5J5rlfxb5AhPOUuHwlNHbtd3ficlnibmicicobrAiba2qciaD3dwekVo4FZNsq0GREL2dfia4lRsQ/640?wx_fmt=png&amp;from=appmsg" alt="" title="null" loading="lazy"/></p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/D1DJjmDXQdnFmJFU5J5rlfxb5AhPOUuHMsvyqeGaTfgknLgoDprObt1cODjBMggygP1yTC9ylaRK5etf3FO6qQ/640?wx_fmt=png&amp;from=appmsg" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">性能优化与实践</h3>
<h4 data-id="heading-13">关键参数调优</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// ✅ 推荐配置</span>
<span class="hljs-built_in">int</span> gapTimeoutMs = <span class="hljs-number">100</span>;    <span class="hljs-comment">// 100-200ms适合大多数设备</span>
<span class="hljs-built_in">int</span> maxWaitMs = <span class="hljs-number">3000</span>;      <span class="hljs-comment">// 总超时3秒，避免程序卡死</span>
Thread.Sleep(<span class="hljs-number">10</span>);          <span class="hljs-comment">// 轮询间隔10ms，平衡CPU占用和响应速度</span>
</code></pre>
<h4 data-id="heading-14">线程安全保障</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">object</span> bufferLock = <span class="hljs-keyword">new</span> <span class="hljs-built_in">object</span>();
<span class="hljs-comment">// 所有缓冲区操作都要加锁</span>
<span class="hljs-keyword">lock</span> (bufferLock)
{
    receivedBuffer.Clear();
    receivedBuffer.AddRange(buffer);
    <span class="hljs-comment">// ... 其他缓冲区操作</span>
}
</code></pre>
<h4 data-id="heading-15">常见提醒</h4>
<p>1、忘记清空缓冲区：每次查询前必须 <code>receivedBuffer.Clear()</code></p>
<p>2、超时时间设置不当：间隔超时太短会截断数据，太长会影响响应速度</p>
<p>3、线程安全问题：<code>DataReceived</code> 事件在不同线程中执行，必须加锁保护</p>
<p>4、资源释放：程序结束前记得调用 <code>Close()</code> 方法</p>
<h3 data-id="heading-16">适用场景对比</h3>



































<table><thead><tr><th align="left">方案</th><th align="left">适用场景</th><th align="left">优点</th><th align="left">缺点</th></tr></thead><tbody><tr><td align="left">间隔超时</td><td align="left">通用场景</td><td align="left">简单可靠</td><td align="left">需要调试最佳间隔时间</td></tr><tr><td align="left">结束符判断</td><td align="left">文本协议</td><td align="left">精确判断</td><td align="left">需要明确的结束符</td></tr><tr><td align="left">帧结构判断</td><td align="left">二进制协议</td><td align="left">最精确</td><td align="left">需要了解协议细节</td></tr><tr><td align="left">组合策略</td><td align="left">复杂场景</td><td align="left">最灵活</td><td align="left">代码稍复杂</td></tr></tbody></table>
<h3 data-id="heading-17">总结</h3>
<p>1、选择合适的策略：对于90%的场景，<strong>数据间隔超时判断</strong>就足够了</p>
<p>2、参数调优很重要：100-200ms 的间隔超时是经验值，需要根据实际设备调整</p>
<p>3、组合策略是王道：当单一策略无法满足需求时，组合策略提供了最大的灵活性</p>
<p>通过本文介绍的四种策略，开发者可以根据具体通信协议灵活选择最适合的接收方式，彻底告别"分包接收"带来的困扰。</p>
<h3 data-id="heading-18">关键词</h3>
<p>串口通信、分包接收、C#、SerialPort、数据间隔超时、结束符判断、协议帧结构、组合策略、线程安全、工业控制</p>
<h3 data-id="heading-19">最后</h3>
<p>如果你觉得这篇文章对你有帮助，不妨点个赞支持一下！你的支持是我继续分享知识的动力。如果有任何疑问或需要进一步的帮助，欢迎随时留言。</p>
<p>也可以加入微信公众号 <strong>[DotNet技术匠]</strong> 社区，与其他热爱技术的同行一起交流心得，共同成长！</p>
<p><strong>优秀是一种习惯，欢迎大家留言学习！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解构内存迷宫：串联虚拟地址、页表与内存使用（一）]]></title>    <link>https://juejin.cn/post/7590705425134305289</link>    <guid>https://juejin.cn/post/7590705425134305289</guid>    <pubDate>2026-01-03T12:48:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590705425134305289" data-draft-id="7590608345923239962" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解构内存迷宫：串联虚拟地址、页表与内存使用（一）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-03T12:48:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风的归宿55"/> <meta itemprop="url" content="https://juejin.cn/user/2840793779297303"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解构内存迷宫：串联虚拟地址、页表与内存使用（一）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2840793779297303/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风的归宿55
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T12:48:55.000Z" title="Sat Jan 03 2026 12:48:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">介绍</h4>
<p>说到内存，读者之前可能听说过很多概念，比如虚拟地址，虚拟内存，页表，内核，物理内存管理等，各个概念可能听上去都知道，但是却很少有文章将这些内存相关的概念串联起来，这篇文章就是通过几个使用场景将这些概念串联起来，让读者能更清楚的了解这些概念的同时，对内存使用的流程有个整体上的了解。 让我们开始吧，一起去探索 程序的一页数据是如何在计算机内存中“安家落户”的。</p>
<h4 data-id="heading-1">物理内存和物理地址</h4>
<p>我们先从物理内存说起，他是一个物理介质，在通电的情况下可以存储数据，而物理地址就是内存的一个坐标，我们可以通过提供一个物理地址和一个长度来读取内存上对应区域存储的数据。 我们程序在运行时，就经常需要使用内存来写入和读取数据，比如a=0 就是把a变量映射成了一个物理地址，然后在物理地址对应的内存区域上写上0，这样在读取a这个变量时，就可以通过a的物理地址从内存中找到0这个数据，就读取到了变量的值。</p>
<p>这个是理想情况，但是实际上操作系统并不会像是这样直接使用物理地址，而是<strong>使用一个称为虚拟地址的方式存储变量的地址，然后要访问变量值时，使用这个虚拟地址，加上一个称为页表的映射结构，转换成物理地址</strong>，然后再到对应的内存区域中获取变量的值。</p>
<h6 data-id="heading-2">使用物理地址的问题</h6>
<p>为什么要特意加上这个转换逻辑呢，直接使用物理地址存储不行么？ 其实早期是有直接使用物理内存存储数据的机器的，但是他有几个问题：</p>
<ol>
<li>安全问题：进程没有隔离，系统安全性大为下降，因为所有进程使用一个相同的“地址空间”，有可能恶意进程会访问不属于他的物理地址，造成权限问题，或者不小心覆盖了不属于他的数据，甚至是操作系统数据。</li>
<li>内存碎片问题：比如一个进程申请100M的空间，用完后释放了，但是这块内存地址的前后内存块都被使用了，这时候有个进程申请120M的连续内存，这100M就无法被使用，因为他前后的内存已经被占用了，这就造成操作系统上有很多内存空洞，空闲的内存总量是够用的，但是无法分配一个较大的连续内存，这就是内存碎片。</li>
<li>易用性问题：编程与管理的复杂度高，因为程序员或者编译器必须自己管理物理内存，每次程序启动的变量内存地址都不一样，很容易出错。</li>
<li>灵活性问题：内存共享与稀疏存储，很难实现内存共享，比如很多程序都需要用到标准库（如libc），使用物理内存的话，只能每个进程都在物理内存中保留一份，造成浪费。</li>
</ol>
<h4 data-id="heading-3">虚拟地址和页表</h4>
<p>那么，虚拟地址和页表是如何解决这些问题的呢？首先介绍下这两个概念，<strong>虚拟地址是每个进程都拥有的，从0开始的连续的内存地址空间</strong>，之所以称为虚拟，是因为程序使用这个地址访问时，并不是访问这个地址对应的物理内存。而页表，则是将虚拟地址映射成一个物理地址的数据结构。 <strong>需要注意的是，页表是一个数据结构，因此页表也是需要存在物理内存上的，会占用一定内存空间</strong>，你可以理解为类似一个java中的map，输入虚拟地址a，通过查询页表，可以一步一步找到a对应的物理地址b。</p>
<p>还有一个需要说明的是<strong>页</strong>这个概念，操作系统是将内存以4k大小为一个最小分配单位，每次进程申请内存时，就会分配多个4k大小的空闲内存页给进程。比如进程申请15k的内存，操作系统就会给他分配4个4k的内存块，然后在页表中增加四个页表项，将4个内存块的虚拟地址映射到实际的物理内存地址。页表页表，顾名思义，就是页的映射表。</p>
<h6 data-id="heading-4">虚拟地址的使用</h6>
<p>有了虚拟地址后，<strong>操作系统只会让程序使用虚拟地址，他会在进程启动时为每个进程生成一个独立的页表</strong>，之后不管程序访问什么地址，操作系统都会把这个地址当成虚拟地址，通过程序的页表进行转换成物理地址，然后再进行访问。</p>
<p>举个例子，比如进程访问一个地址为a的虚拟地址，操作系统并不会去访问b这个物理内存地址，而是会去查询页表，找到对应的物理内存b，然后访问b地址中的内存的数据。而且这个b地址不是固定的，他是随机的，是在程序申请a地址的内存时，操作系统取查找空闲的内存页，然后配置到页表上的。</p>
<h6 data-id="heading-5">虚拟地址和页表的好处</h6>
<p>使用虚拟地址和页表为什么能解决上述问题呢？</p>
<ol>
<li>安全问题：使用虚拟地址后，每个程序访问的地址都被当做虚拟地址处理，然后通过页表转换成物理地址，而页表的数据只有操作系统能管理，这样只要操作系统做好内存管理，不要把同一块空闲内存分配个多个进程，就能确保进程之间的隔离性，即使恶意进程想要访问一个别的进程使用的物理地址，他的访问地址也会被当做虚拟地址处理，访问到分配给他的一个他自己的空闲内存上。</li>
<li>内存碎片问题：在虚拟地址空间中，进程以为自己拥有一段非常长的连续内存，比如他认为自己有1G的连续空间，但是实际上，操作系统通过页表将这1G空间映射到物理内存中分散的内存块上，这样就能通过复用小块内存避免内存碎片问题，因为任何空闲的物理页都能被利用，大大提高了内存利用率</li>
<li>易用性问题：每个进程都从固定的地址（如0x400000）开始加载代码。链接器和编译器可以提前确定很多地址，编程模型简单统一。</li>
<li>灵活性问题：共享内存实现起来很简单，比如对于一些标准库，操作系统可以将其在内存中存储一份，然后在启动程序时，如果他们需要标准库的代码，就可以在进程启动时，让操作系统将不同进程的存储标准库代码的虚拟地址页表项映射到同一个物理页，这样，系统的动态链接库只需要在物理内存中保存一份，所有进程共享，节省大量内存。</li>
</ol>
<h4 data-id="heading-6">多级页表</h4>
<p>之前介绍了使用页表的原因，但是如果页表的实现只是单纯的将一个虚拟地址映射到另外一个物理地址，这也是有问题的，这种方式被称为单级页表，相当于每个虚拟地址是页表这个map的key，它对应的物理地址，也就是value可以不存在，但是每个key必须存在，所以操作系统必须为每一个虚拟地址生成一个页表项，这就会导致一个程序的页表项太多。之前说过，页表是个数据结构，他本身也是占用一定内存大小的，页表项太多的话就会占用较大内存。</p>
<p>这里有个地方需要注意下，因为linux系统是以4k为最小的内存分配单位，因此单级页表中的每个页表项指向的也是一个4k的内存，所以<strong>一个单级页表的总项目数量是 最大物理内存大小(字节) / (4*1024) 字节，比所有地址的数量要少</strong> 。两个连续的页表项之间相隔4kb，不是每个字节都有对应的页表项，访问时找的是根据虚拟地址计算出的他所属于的那个页的虚拟地址。</p>
<h6 data-id="heading-7">单级页表占用的内存</h6>
<p>假设使用的是一个32位的操作系统：</p>
<ol>
<li>一个进程的虚拟地址共有2^32=4G，这也是操作系统的最大内存。</li>
<li>换算成KB是： 4 GB = 4 × 1024 × 1024 KB = 4,194,304 KB</li>
<li>而一个系统的页大小是4KB，为了存储一个进程的所有虚拟地址，需要 4,194,304/4 = 1,048,576 个页表项。</li>
<li>每个页表项占用4字节，则 共需要 1,048,576*4/1024/1024=4M 的空间。</li>
<li>如果启动100个进程，别的内存不算，页表占用的内存就达到了4*100 = 400M,占了系统内存的10%，</li>
</ol>
<p>通过计算可以看出，单级页表造成了极大浪费，因为一般情况下进程不会使用到页表中大部分的虚拟地址空间。更糟糕的是，这4MB的页表必须是连续的物理内存，随着系统运行，分配一块连续的4MB内存会变得非常困难。</p>
<h6 data-id="heading-8">多级页表的优势</h6>
<p>那么使用多级页表是怎么解决这个问题的呢？首先介绍下多级页表，顾名思义，他就是采用了多个层级，当寻找一个虚拟地址对应的物理地址时，需要一级一级的查找，经过多次映射后才能找到对应的物理地址。就比如字典，查找一个字时，先找首字母，这个首字母就是顶级页表，找到后在字母中再根据拼音顺序找对应汉字，这个就是第二级，最后再是根据找到的页数，去对应页数找到汉字，这个就是通过三级页表找到了物理地址。</p>
<p>linux系统中一般默认使用四级页表，为了简化，我们假设使用二级列表来看下他是怎么节约内存的，以32位系统为例：</p>
<ol>
<li>我们将地址分为 10位（第1级索引） + 10位（第2级索引） + 12位（页内偏移）</li>
<li>前10位就是顶级页表，一共用了 2^10 = 1024 个条目</li>
<li>顶级页表的大小 = 1024 * 4字节 = 4KB（正好一页）。</li>
</ol>
<p>顶级页表是必须有的，但是二级列表可以等使用到内存时再分配，因此在一个程序启动时，只需要用到4k的页表项，这就比之前的4M要小的多了。</p>
<h6 data-id="heading-9">多级页表和单级页表的区别</h6>
<p>有人可能会问，为什么多级页表不需要提前存储后面几个层级的页表，而单级页表却需要存储所有页表项呢？因为单级页表是直接索引，虚拟地址直接作为索引，去一个巨大的、连续的数组中查找，为了能够通过索引直接定位，这个数组必须完整存在，所以单级页表不能缺少页表项。</p>
<p>而多级页表是间接索引，只要确保第一级存在，第二级可以在你需要用到时才去加载，这是一种“懒加载”策略。</p>
<p>举个例子，比如现在多级页表只有顶级页表，你需要存储一个数据时，输入指定虚拟地址去存数据，操作系统根据虚拟地址去顶级页表这个目录找到地址对应的二级页表地址时，发现二级页表的地址不存在，此时他就可以分配内存，生成需要访问的虚拟地址所在的二级页表的数据，即一个10位的二级页表，此时只是多了一个二级页表，即2^10* 4字节 = 4KB大小。</p>
<h4 data-id="heading-10">结语</h4>
<p>好了，先介绍到这里，本片文章主要讲解了虚拟地址和页表相关内容，后续内容在下一篇文章中呈现。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[登录验证全攻略：从会话技术到 JWT，结合过滤器与拦截器实战]]></title>    <link>https://juejin.cn/post/7590699877630574630</link>    <guid>https://juejin.cn/post/7590699877630574630</guid>    <pubDate>2026-01-03T13:13:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590699877630574630" data-draft-id="7590601860300587035" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="登录验证全攻略：从会话技术到 JWT，结合过滤器与拦截器实战"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-03T13:13:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员根根"/> <meta itemprop="url" content="https://juejin.cn/user/555679166786139"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            登录验证全攻略：从会话技术到 JWT，结合过滤器与拦截器实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/555679166786139/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员根根
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T13:13:02.000Z" title="Sat Jan 03 2026 13:13:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Web 应用中，<strong>登录验证</strong>是保障系统安全的第一道防线 —— 只有通过身份认证的用户，才能访问系统的核心资源（如员工管理、部门数据、个人中心等）。实现登录验证的核心技术包括 “会话管理” 和 “请求拦截”，从传统的 Session-Cookie，到如今流行的 JWT 令牌，再配合过滤器（Filter）与拦截器（Interceptor）实现全局校验，形成了一套完整的登录验证体系。本文将以 “后台管理系统” 为场景，全面讲解登录验证的实现思路、核心技术及实战落地。</p>
<h2 data-id="heading-0">一、登录验证的核心诉求：为什么需要它？</h2>
<p>想象一个没有登录验证的后台系统：任何人都可以直接访问<code>/emp/list</code>（员工列表）、<code>/dept/delete</code>（删除部门）等核心接口，这会导致数据泄露、恶意篡改等严重安全问题。</p>
<p>登录验证的核心诉求有 3 点：</p>
<ol>
<li><strong>身份认证</strong>：验证用户输入的账号密码是否正确，确认用户身份合法性；</li>
<li><strong>身份保持</strong>：用户登录成功后，在一段时间内无需重复登录，可正常访问系统资源（会话技术实现）；</li>
<li><strong>权限控制</strong>：拦截未登录用户的非法请求，拒绝其访问受保护资源（过滤器 / 拦截器实现）。</li>
</ol>
<h2 data-id="heading-1">二、会话技术：实现用户身份保持</h2>
<p>用户登录成功后，如何让系统 “记住” 用户身份？这就需要<strong>会话技术</strong>，主流方案分为两类：传统的<code>Session-Cookie</code>和现代的<code>JWT</code>（Json Web Token）。</p>
<h4 data-id="heading-2">1. 传统方案：Session-Cookie 会话管理</h4>
<h5 data-id="heading-3">核心原理</h5>
<p><code>Session-Cookie</code>是基于服务器端存储的会话方案，核心流程如下：</p>
<ol>
<li>用户提交账号密码登录，服务器验证通过后，创建<code>HttpSession</code>对象（存储用户信息，如用户 ID、用户名），并生成唯一的<code>SessionId</code>；</li>
<li>服务器将<code>SessionId</code>通过<code>Set-Cookie</code>响应头写入客户端浏览器；</li>
<li>客户端后续发起请求时，浏览器会自动携带该<code>Cookie</code>（包含<code>SessionId</code>）到服务器；</li>
<li>服务器通过<code>SessionId</code>查找对应的<code>HttpSession</code>对象，确认用户身份，实现 “免登录” 访问。</li>
</ol>
<h5 data-id="heading-4">实战演示（Java Web）</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 登录接口：验证账号密码，创建Session</span>
<span class="hljs-meta">@WebServlet("/login")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doPost</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException {
        req.setCharacterEncoding(<span class="hljs-string">"UTF-8"</span>);
        resp.setContentType(<span class="hljs-string">"application/json;charset=UTF-8"</span>);

        <span class="hljs-comment">// 获取前端提交的账号密码</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">"username"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">"password"</span>);

        <span class="hljs-comment">// 模拟账号密码验证（实际需查询数据库）</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"admin"</span>.equals(username) &amp;&amp; <span class="hljs-string">"123456"</span>.equals(password)) {
            <span class="hljs-comment">// 登录成功：创建Session，存储用户信息</span>
            <span class="hljs-type">HttpSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> req.getSession();
            session.setAttribute(<span class="hljs-string">"loginUser"</span>, username); <span class="hljs-comment">// 存储用户名</span>
            session.setMaxInactiveInterval(<span class="hljs-number">3600</span>); <span class="hljs-comment">// 设置Session过期时间：1小时（无操作超时）</span>

            resp.getWriter().write(<span class="hljs-string">"{"</span>code<span class="hljs-string">":200,"</span>msg<span class="hljs-string">":"</span>登录成功<span class="hljs-string">"}"</span>);
        } <span class="hljs-keyword">else</span> {
            resp.getWriter().write(<span class="hljs-string">"{"</span>code<span class="hljs-string">":500,"</span>msg<span class="hljs-string">":"</span>账号或密码错误<span class="hljs-string">"}"</span>);
        }
    }
}

<span class="hljs-comment">// 2. 核心资源接口：通过Session验证用户身份</span>
<span class="hljs-meta">@WebServlet("/emp/list")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmpListServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException {
        resp.setContentType(<span class="hljs-string">"application/json;charset=UTF-8"</span>);

        <span class="hljs-comment">// 获取Session中的用户信息</span>
        <span class="hljs-type">HttpSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> req.getSession(<span class="hljs-literal">false</span>); <span class="hljs-comment">// false：不存在则返回null，不创建新Session</span>
        <span class="hljs-keyword">if</span> (session == <span class="hljs-literal">null</span> || session.getAttribute(<span class="hljs-string">"loginUser"</span>) == <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 未登录：返回未授权提示</span>
            resp.getWriter().write(<span class="hljs-string">"{"</span>code<span class="hljs-string">":401,"</span>msg<span class="hljs-string">":"</span>请先登录<span class="hljs-string">"}"</span>);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 已登录：返回员工列表数据</span>
        resp.getWriter().write(<span class="hljs-string">"{"</span>code<span class="hljs-string">":200,"</span>data<span class="hljs-string">":[{"</span>id<span class="hljs-string">":1,"</span>name<span class="hljs-string">":"</span>张三<span class="hljs-string">"},{"</span>id<span class="hljs-string">":2,"</span>name<span class="hljs-string">":"</span>李四<span class="hljs-string">"}]}"</span>);
    }
}
</code></pre>
<h5 data-id="heading-5">Session-Cookie 的优缺点</h5>





















<table><thead><tr><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>安全性较高（用户信息存储在服务器端，不易被篡改）</td><td>服务器压力大（大量 Session 存储在服务器内存 / 缓存中，高并发场景不友好）</td></tr><tr><td>支持会话失效手动控制（如用户退出登录，直接销毁 Session）</td><td>不支持跨域（Cookie 默认不允许跨域携带，需额外配置）</td></tr><tr><td>实现简单，无需额外依赖</td><td>不支持分布式部署（Session 存储在单个服务器，集群环境下需做 Session 共享）</td></tr></tbody></table>
<h4 data-id="heading-6">2. 现代方案：JWT 令牌认证</h4>
<h5 data-id="heading-7">核心原理</h5>
<p>JWT（Json Web Token）是一种基于<strong>客户端存储</strong>的无状态令牌方案，无需服务器存储会话信息，核心流程如下：</p>
<ol>
<li>用户提交账号密码登录，服务器验证通过后，根据用户信息（如用户 ID、用户名）和密钥，生成 JWT 令牌（包含头部、载荷、签名三部分）；</li>
<li>服务器将 JWT 令牌返回给客户端（客户端可存储在 LocalStorage/SessionStorage/Cookie 中）；</li>
<li>客户端后续发起请求时，通过请求头（如<code>Authorization: Bearer &lt;JWT令牌&gt;</code>）携带令牌到服务器；</li>
<li>服务器接收令牌后，通过密钥验证令牌的合法性（是否过期、是否被篡改），验证通过则确认用户身份。</li>
</ol>
<h5 data-id="heading-8">JWT 令牌结构</h5>
<p>JWT 令牌是一个字符串，由三部分组成，用<code>.</code>分隔：</p>
<ol>
<li>
<p><strong>Header（头部）</strong> ：指定令牌类型（JWT）和加密算法（如 HS256），示例：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span><span class="hljs-attr">"alg"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"HS256"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"typ"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"JWT"</span><span class="hljs-punctuation">}</span>
</code></pre>
</li>
<li>
<p><strong>Payload（载荷）</strong> ：存储用户自定义信息（如用户 ID、用户名）和过期时间等元数据，示例：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span><span class="hljs-attr">"userId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"username"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"admin"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"exp"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1735689600</span><span class="hljs-punctuation">}</span>
</code></pre>
</li>
<li>
<p><strong>Signature（签名）</strong> ：服务器用头部指定的加密算法，将头部、载荷和密钥进行加密生成的签名，用于验证令牌是否被篡改。</p>
</li>
</ol>
<h5 data-id="heading-9">实战演示（Java + JJWT 依赖）</h5>
<h6 data-id="heading-10">（1）引入 JJWT 依赖（Maven）</h6>
<p>JJWT 是 Java 生态中常用的 JWT 工具库，简化 JWT 的生成与验证：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt-impl<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt-jackson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h6 data-id="heading-11">（2）JWT 工具类</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.jsonwebtoken.Claims;
<span class="hljs-keyword">import</span> io.jsonwebtoken.Jwts;
<span class="hljs-keyword">import</span> io.jsonwebtoken.security.Keys;
<span class="hljs-keyword">import</span> javax.crypto.SecretKey;
<span class="hljs-keyword">import</span> java.util.Date;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtUtils</span> {
    <span class="hljs-comment">// 密钥（生产环境需配置在配置文件中，且保证安全性）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SECRET_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">"my-secret-key-32bytes-long-12345678"</span>;
    <span class="hljs-comment">// 令牌过期时间：1小时（单位：毫秒）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">EXPIRE_TIME</span> <span class="hljs-operator">=</span> <span class="hljs-number">3600</span> * <span class="hljs-number">1000L</span>;

    <span class="hljs-comment">// 生成JWT令牌</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">generateToken</span><span class="hljs-params">(String username)</span> {
        <span class="hljs-comment">// 创建密钥（HS256算法要求密钥长度至少32位）</span>
        <span class="hljs-type">SecretKey</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> Keys.hmacShaKeyFor(SECRET_KEY.getBytes());
        <span class="hljs-comment">// 构建并生成令牌</span>
        <span class="hljs-keyword">return</span> Jwts.builder()
                .setSubject(username) <span class="hljs-comment">// 设置主题（存储用户名）</span>
                .setIssuedAt(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()) <span class="hljs-comment">// 设置签发时间</span>
                .setExpiration(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(System.currentTimeMillis() + EXPIRE_TIME)) <span class="hljs-comment">// 设置过期时间</span>
                .signWith(key) <span class="hljs-comment">// 使用密钥签名</span>
                .compact();
    }

    <span class="hljs-comment">// 验证JWT令牌合法性，并获取令牌中的用户信息</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Claims <span class="hljs-title function_">verifyToken</span><span class="hljs-params">(String token)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">SecretKey</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> Keys.hmacShaKeyFor(SECRET_KEY.getBytes());
            <span class="hljs-comment">// 验证令牌并解析载荷</span>
            <span class="hljs-keyword">return</span> Jwts.parserBuilder()
                    .setSigningKey(key)
                    .build()
                    .parseClaimsJws(token)
                    .getBody();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 令牌无效（过期、被篡改等），返回null</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    }

    <span class="hljs-comment">// 从令牌中获取用户名</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getUsernameFromToken</span><span class="hljs-params">(String token)</span> {
        <span class="hljs-type">Claims</span> <span class="hljs-variable">claims</span> <span class="hljs-operator">=</span> verifyToken(token);
        <span class="hljs-keyword">return</span> claims == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : claims.getSubject();
    }
}
</code></pre>
<h6 data-id="heading-12">（3）JWT 登录与验证接口</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@WebServlet("/jwt/login")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtLoginServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doPost</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException {
        req.setCharacterEncoding(<span class="hljs-string">"UTF-8"</span>);
        resp.setContentType(<span class="hljs-string">"application/json;charset=UTF-8"</span>);

        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">"username"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">"password"</span>);

        <span class="hljs-comment">// 模拟账号密码验证</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"admin"</span>.equals(username) &amp;&amp; <span class="hljs-string">"123456"</span>.equals(password)) {
            <span class="hljs-comment">// 生成JWT令牌</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> JwtUtil.generateToken(username);
            <span class="hljs-comment">// 返回令牌给客户端</span>
            resp.getWriter().write(<span class="hljs-string">"{"</span>code<span class="hljs-string">":200,"</span>msg<span class="hljs-string">":"</span>登录成功<span class="hljs-string">","</span>data<span class="hljs-string">":"</span><span class="hljs-string">" + token + "</span><span class="hljs-string">"}"</span>);
            <span class="hljs-keyword">return</span>;
        }

        resp.getWriter().write(<span class="hljs-string">"{"</span>code<span class="hljs-string">":500,"</span>msg<span class="hljs-string">":"</span>账号或密码错误<span class="hljs-string">"}"</span>);
    }
}

<span class="hljs-meta">@WebServlet("/jwt/emp/list")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtEmpListServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException {
        resp.setContentType(<span class="hljs-string">"application/json;charset=UTF-8"</span>);

        <span class="hljs-comment">// 获取请求头中的JWT令牌</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">authorization</span> <span class="hljs-operator">=</span> req.getHeader(<span class="hljs-string">"Authorization"</span>);
        <span class="hljs-keyword">if</span> (authorization == <span class="hljs-literal">null</span> || !authorization.startsWith(<span class="hljs-string">"Bearer "</span>)) {
            resp.getWriter().write(<span class="hljs-string">"{"</span>code<span class="hljs-string">":401,"</span>msg<span class="hljs-string">":"</span>请先登录<span class="hljs-string">"}"</span>);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 提取令牌（去除"Bearer "前缀）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> authorization.substring(<span class="hljs-number">7</span>);
        <span class="hljs-comment">// 验证令牌并获取用户名</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> JwtUtil.getUsernameFromToken(token);
        <span class="hljs-keyword">if</span> (username == <span class="hljs-literal">null</span>) {
            resp.getWriter().write(<span class="hljs-string">"{"</span>code<span class="hljs-string">":401,"</span>msg<span class="hljs-string">":"</span>令牌无效或已过期<span class="hljs-string">"}"</span>);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 令牌有效：返回员工列表</span>
        resp.getWriter().write(<span class="hljs-string">"{"</span>code<span class="hljs-string">":200,"</span>data<span class="hljs-string">":[{"</span>id<span class="hljs-string">":1,"</span>name<span class="hljs-string">":"</span>张三<span class="hljs-string">"},{"</span>id<span class="hljs-string">":2,"</span>name<span class="hljs-string">":"</span>李四<span class="hljs-string">"}]}"</span>);
    }
}
</code></pre>
<h5 data-id="heading-13">JWT 的优缺点</h5>





















<table><thead><tr><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>无状态（服务器无需存储会话信息，降低服务器压力）</td><td>安全性较低（令牌存储在客户端，若泄露可能被恶意使用，需配合 HTTPS）</td></tr><tr><td>支持跨域（令牌通过请求头携带，不受跨域限制）</td><td>令牌一旦生成，无法主动作废（除非设置短期过期，或维护黑名单）</td></tr><tr><td>支持分布式部署（任意服务器均可通过密钥验证令牌，无需 Session 共享）</td><td>载荷部分 Base64 编码（非加密），敏感信息不可直接存储</td></tr></tbody></table>
<h2 data-id="heading-14">三、请求拦截：实现全局登录验证</h2>
<p>无论是 Session-Cookie 还是 JWT，若每个接口都单独编写身份验证逻辑，会造成代码冗余。此时需要 <strong>过滤器（Filter）</strong> 和 <strong>拦截器（Interceptor）</strong> 实现全局请求拦截，统一处理登录验证。</p>
<h4 data-id="heading-15">1. 过滤器（Filter）：Servlet 规范中的全局拦截</h4>
<p>Filter 是 Java Servlet 规范定义的组件，运行在 Servlet 之前，可对请求和响应进行统一拦截处理，支持对所有 Web 资源（Servlet、JSP、静态资源）进行过滤。</p>
<h5 data-id="heading-16">实战演示：JWT 全局验证过滤器</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.tgt.filters;

<span class="hljs-keyword">import</span> cn.hutool.core.util.StrUtil;
<span class="hljs-keyword">import</span> com.tgt.utils.JwtUtils;
<span class="hljs-keyword">import</span> io.jsonwebtoken.Claims;
<span class="hljs-keyword">import</span> jakarta.servlet.*;
<span class="hljs-keyword">import</span> jakarta.servlet.annotation.WebFilter;
<span class="hljs-keyword">import</span> jakarta.servlet.http.HttpServletRequest;
<span class="hljs-keyword">import</span> jakarta.servlet.http.HttpServletResponse;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;

<span class="hljs-keyword">import</span> java.io.IOException;

<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@WebFilter("/*")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException {
        <span class="hljs-comment">//1.获取请求url。</span>
        <span class="hljs-comment">// servletRequest.getRequestURI() 这个api是子接口HttpServletRequest才有</span>
        <span class="hljs-comment">// 将父接口 ServletRequest 转换为 子接口HttpServletRequest</span>
        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> (HttpServletRequest) servletRequest;
        <span class="hljs-type">HttpServletResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> (HttpServletResponse) servletResponse;
        <span class="hljs-type">String</span> <span class="hljs-variable">uri</span> <span class="hljs-operator">=</span> request.getRequestURI();

        <span class="hljs-comment">//2.判断请求url中是否包含login，</span>
        <span class="hljs-keyword">if</span> (uri.contains(<span class="hljs-string">"/login"</span>)){
            <span class="hljs-comment">//如果包含，说明是登录操作，放行。</span>
            filterChain.doFilter(request,response);

            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">//3.获取请求头中的令牌（token）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"token"</span>);

        <span class="hljs-comment">//4.判断令牌是否存在，如果不存在，响应401。</span>
        <span class="hljs-keyword">if</span> (StrUtil.isEmpty(token)){
            response.setStatus(<span class="hljs-number">401</span>);

            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">//5.解析token，如果解析失败，响应401</span>
            <span class="hljs-type">Claims</span> <span class="hljs-variable">claims</span> <span class="hljs-operator">=</span> JwtUtils.parseJWT(token);<span class="hljs-comment">//如果篡改或过期会发生异常</span>
            
            <span class="hljs-comment">//6.放行。</span>
            filterChain.doFilter(request,response);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"登录校验失败，解析token失败："</span>,e);

            <span class="hljs-comment">//解析token失败 返回401</span>
            response.setStatus(<span class="hljs-number">401</span>);
        }
    }
}
</code></pre>
<h4 data-id="heading-17">2. 拦截器（Interceptor）：Spring 框架中的全局拦截</h4>
<p>Interceptor 是 Spring MVC 框架提供的组件，运行在 Controller 方法执行前后，仅对 Controller 请求进行拦截，功能更灵活（支持 Spring 容器管理，可注入 Service 等 Bean）。</p>
<h5 data-id="heading-18">实战演示：Spring MVC JWT 拦截器</h5>
<h6 data-id="heading-19">（1）编写 JWT 拦截器</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> cn.hutool.core.util.StrUtil;
<span class="hljs-keyword">import</span> com.tgt.utils.JwtUtils;
<span class="hljs-keyword">import</span> io.jsonwebtoken.Claims;
<span class="hljs-keyword">import</span> jakarta.servlet.http.HttpServletRequest;
<span class="hljs-keyword">import</span> jakarta.servlet.http.HttpServletResponse;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;
<span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;

<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginInterceptors</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception {

        <span class="hljs-comment">//3.获取请求头中的令牌（token）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"token"</span>);

        <span class="hljs-comment">//4.判断令牌是否存在，如果不存在，响应401。</span>
        <span class="hljs-keyword">if</span> (StrUtil.isEmpty(token)){
            response.setStatus(<span class="hljs-number">401</span>);

            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">//5.解析token，如果解析失败，响应401</span>
            <span class="hljs-type">Claims</span> <span class="hljs-variable">claims</span> <span class="hljs-operator">=</span> JwtUtils.parseJWT(token);<span class="hljs-comment">//如果篡改或过期会发生异常</span>

            <span class="hljs-type">Integer</span> <span class="hljs-variable">empId</span> <span class="hljs-operator">=</span> Integer.valueOf(claims.get(<span class="hljs-string">"empId"</span>).toString());

            log.info(<span class="hljs-string">"登录成功，用户id为：{}"</span>,empId);

            <span class="hljs-comment">//6.放行。</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"登录校验失败，解析token失败："</span>,e);

            <span class="hljs-comment">//解析token失败 返回401</span>
            response.setStatus(<span class="hljs-number">401</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
}
</code></pre>
<h6 data-id="heading-20">（2）配置拦截器（Spring MVC 配置类）</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> LoginInterceptors loginInterceptors;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> {
        <span class="hljs-comment">//注册拦截器并绑定拦截路径，注意 是两个*,代表任意路径</span>
        registry.addInterceptor(loginInterceptors)
                .addPathPatterns(<span class="hljs-string">"/**"</span>)
                .excludePathPatterns(<span class="hljs-string">"/login"</span>);
    }
}
</code></pre>
<h4 data-id="heading-21">3. 过滤器 vs 拦截器：核心区别</h4>








































<table><thead><tr><th>对比维度</th><th>过滤器（Filter）</th><th>拦截器（Interceptor）</th></tr></thead><tbody><tr><td>所属规范</td><td>Servlet 规范（Java EE 标准）</td><td>Spring MVC 框架自定义</td></tr><tr><td>拦截范围</td><td>所有 Web 资源（Servlet、JSP、静态资源）</td><td>仅拦截 Controller 请求</td></tr><tr><td>执行时机</td><td>运行在 Servlet 容器层面，早于 Interceptor</td><td>运行在 Spring MVC 层面，晚于 Filter</td></tr><tr><td>依赖容器</td><td>不依赖 Spring 容器，可独立使用</td><td>依赖 Spring 容器，可注入 Bean（Service/Mapper）</td></tr><tr><td>执行次数</td><td>一次请求只执行一次</td><td>若存在视图转发，会执行多次</td></tr><tr><td>功能灵活性</td><td>功能单一，仅支持请求 / 响应拦截</td><td>功能丰富，支持前置拦截、后置处理、视图渲染后处理</td></tr></tbody></table>
<h2 data-id="heading-22">四、完整登录验证流程（实战总结）</h2>
<p>以 “JWT + 拦截器” 为例，完整的登录验证流程如下：</p>
<ol>
<li>
<p><strong>用户登录</strong>：前端提交账号密码到<code>/jwt/login</code>接口，后端验证通过后生成 JWT 令牌，返回给前端；</p>
</li>
<li>
<p><strong>前端存储令牌</strong>：前端将 JWT 令牌存储在 LocalStorage 中；</p>
</li>
<li>
<p><strong>前端发起请求</strong>：前端后续访问核心接口（如<code>/emp/list</code>）时，通过<code>Authorization</code>请求头携带 JWT 令牌；</p>
</li>
<li>
<p><strong>全局拦截验证</strong>：后端拦截器拦截请求，提取并验证 JWT 令牌；</p>
</li>
<li>
<p><strong>请求放行 / 拦截</strong>：</p>
<ul>
<li>令牌有效：放行请求，Controller 处理业务并返回数据；</li>
<li>令牌无效 / 未携带：拦截请求，返回 401 未授权提示，前端跳转至登录页。</li>
</ul>
</li>
</ol>
<h2 data-id="heading-23">五、登录验证最佳实践</h2>
<ol>
<li>
<p><strong>令牌安全存储</strong>：</p>
<ul>
<li>JWT 令牌优先存储在<code>HttpOnly</code> Cookie 中（防止 XSS 攻击），其次存储在 LocalStorage（需做 XSS 防护）；</li>
<li>敏感信息不存储在 JWT 载荷中（载荷仅 Base64 编码，可被解码）。</li>
</ul>
</li>
<li>
<p><strong>设置合理过期时间</strong>：</p>
<ul>
<li>短期令牌：访问令牌（Access Token）过期时间设为 1 小时，减少令牌泄露风险；</li>
<li>长期令牌：刷新令牌（Refresh Token）过期时间设为 7 天，用于过期后重新获取访问令牌，无需用户重复登录。</li>
</ul>
</li>
<li>
<p><strong>HTTPS 传输</strong>：所有请求（尤其是登录请求和携带令牌的请求）使用 HTTPS 协议，防止令牌被中间人劫持。</p>
</li>
<li>
<p><strong>避免匿名访问</strong>：除登录接口、静态资源外，所有核心接口均需拦截验证，禁止匿名访问。</p>
</li>
<li>
<p><strong>令牌黑名单机制</strong>：若用户退出登录（令牌未过期），后端需维护 JWT 黑名单，拦截已注销的令牌。</p>
</li>
</ol>
<h2 data-id="heading-24">六、总结与拓展</h2>
<p>本文全面讲解了登录验证的核心技术，包括 Session-Cookie、JWT 两种会话方案，以及 Filter、Interceptor 两种全局拦截方案，核心要点总结：</p>
<ol>
<li><strong>会话方案选择</strong>：传统单体应用可使用 Session-Cookie，分布式 / 跨域应用优先使用 JWT；</li>
<li><strong>拦截方案选择</strong>：简单场景用 Filter，Spring Boot/Spring MVC 项目优先用 Interceptor（更灵活）；</li>
<li><strong>安全核心</strong>：令牌存储需防 XSS、传输需用 HTTPS、过期时间需合理设置；</li>
<li><strong>代码规范</strong>：全局拦截统一处理登录验证，避免接口内重复编写验证逻辑。</li>
</ol>
<h4 data-id="heading-25">拓展方向：</h4>
<ul>
<li><strong>权限细化</strong>：基于 RBAC 模型（角色 - 权限 - 用户），实现 “基于角色的访问控制”（如管理员可删除部门，普通用户仅可查看）；</li>
<li><strong>单点登录（SSO）</strong> ：基于 JWT 或 CAS 协议，实现多系统统一登录（一次登录，多系统免登）；</li>
<li><strong>令牌刷新机制</strong>：实现 Access Token 过期后，通过 Refresh Token 自动刷新令牌，提升用户体验；</li>
<li><strong>防暴力破解</strong>：登录接口添加验证码、限流机制，防止恶意账号密码爆破。</li>
</ul>
<p>登录验证是 Web 系统安全的基石，掌握本文的核心技术，可搭建一套高效、安全的登录验证体系，为系统的稳定运行提供保障。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ShardingSphere-JDBC 实战指南]]></title>    <link>https://juejin.cn/post/7590433626560266275</link>    <guid>https://juejin.cn/post/7590433626560266275</guid>    <pubDate>2026-01-03T13:36:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590433626560266275" data-draft-id="7590433626560167971" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ShardingSphere-JDBC 实战指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-03T13:36:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GKunLi"/> <meta itemprop="url" content="https://juejin.cn/user/430664725579725"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ShardingSphere-JDBC 实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/430664725579725/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GKunLi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T13:36:21.000Z" title="Sat Jan 03 2026 13:36:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">目录</h2>
<ul>
<li><a href="#%E4%B8%80%E5%89%8D%E8%A8%80" title="#%E4%B8%80%E5%89%8D%E8%A8%80">一、前言</a></li>
<li><a href="#%E4%BA%8C%E4%BB%80%E4%B9%88%E6%98%AFshardingsphere-jdbc" title="#%E4%BA%8C%E4%BB%80%E4%B9%88%E6%98%AFshardingsphere-jdbc">二、什么是ShardingSphere-JDBC</a></li>
<li><a href="#%E4%B8%89%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8" title="#%E4%B8%89%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8">三、为什么需要分库分表</a></li>
<li><a href="#%E5%9B%9B%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5" title="#%E5%9B%9B%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5">四、核心概念</a></li>
<li><a href="#%E4%BA%94%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B" title="#%E4%BA%94%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B">五、快速开始</a></li>
<li><a href="#%E5%85%AD%E5%88%86%E7%89%87%E7%AD%96%E7%95%A5%E8%AF%A6%E8%A7%A3" title="#%E5%85%AD%E5%88%86%E7%89%87%E7%AD%96%E7%95%A5%E8%AF%A6%E8%A7%A3">六、分片策略详解</a></li>
<li><a href="#%E4%B8%83%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7" title="#%E4%B8%83%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7">七、高级特性</a></li>
<li><a href="#%E5%85%AB%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5" title="#%E5%85%AB%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">八、生产环境最佳实践</a></li>
<li><a href="#%E4%B9%9D%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" title="#%E4%B9%9D%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">九、常见问题与解决方案</a></li>
</ul>
<hr/>
<h2 data-id="heading-1">一、前言</h2>
<p>随着业务数据量的增长,单库单表逐渐无法满足高并发、大数据量的需求。分库分表成为解决这一问题的有效方案。</p>
<p>ShardingSphere是Apache旗下的开源分布式数据库中间件,本文档基于实际项目,讲解ShardingSphere-JDBC的配置和使用方法。</p>
<hr/>
<h2 data-id="heading-2">二、什么是ShardingSphere-JDBC</h2>
<p>ShardingSphere-JDBC是Apache ShardingSphere的核心产品,定位为轻量级Java框架,在JDBC层提供分库分表服务。</p>
<p><strong>核心特点:</strong></p>
<ul>
<li><strong>透明化</strong> - 对业务代码零侵入,就像使用普通JDBC一样</li>
<li><strong>轻量级</strong> - 无需额外部署,仅作为JDBC驱动存在</li>
<li><strong>配置简单</strong> - 通过YAML配置即可实现分库分表</li>
</ul>
<p><strong>适用场景:</strong></p>
<ul>
<li>需要分库分表的应用</li>
<li>基于MyBatis、JPA等ORM框架的应用</li>
</ul>
<hr/>
<h2 data-id="heading-3">三、为什么需要分库分表</h2>
<h3 data-id="heading-4">3.1 单库单表的瓶颈</h3>
<p>当数据量达到千万级时,会遇到以下问题:</p>
<ol>
<li><strong>性能瓶颈</strong> - 单表数据量大,查询变慢</li>
<li><strong>存储瓶颈</strong> - 磁盘IO成为瓶颈</li>
<li><strong>连接限制</strong> - 数据库连接数不足</li>
</ol>
<h3 data-id="heading-5">3.2 分库分表的优势</h3>
<ol>
<li><strong>提升性能</strong> - 单表数据量减少,查询速度提升</li>
<li><strong>提高并发</strong> - 多库分担读写压力</li>
<li><strong>易于扩展</strong> - 可以动态增加数据源</li>
</ol>
<hr/>
<h2 data-id="heading-6">四、核心概念</h2>
<h3 data-id="heading-7">4.1 逻辑表与物理表</h3>
<p><strong>逻辑表</strong> - 应用层看到的表,比如<code>t_user</code></p>
<p><strong>物理表</strong> - 实际存储在数据库中的表,比如<code>t_user_0</code>、<code>t_user_1</code></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">t_user:</span>  <span class="hljs-comment"># 逻辑表</span>
  <span class="hljs-attr">actual-data-nodes:</span> <span class="hljs-string">ds$-&gt;{0..1}.t_user_$-&gt;{0..1}</span>  <span class="hljs-comment"># 物理表</span>
</code></pre>
<h3 data-id="heading-8">4.2 分片键</h3>
<p>决定数据路由到哪个分片的字段,必须包含在SQL中才能正确路由。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 正确:包含分片键,精确路由</span>
SELECT * FROM t_user <span class="hljs-type">WHERE</span> <span class="hljs-variable">user_id</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;

<span class="hljs-comment">// 错误:不包含分片键,全路由(查询所有分片)</span>
SELECT * FROM t_user <span class="hljs-type">WHERE</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> <span class="hljs-string">'zhangsan'</span>;
</code></pre>
<h3 data-id="heading-9">4.3 分片算法</h3>
<p>ShardingSphere通过分片算法决定数据路由到哪个分片。</p>




















<table><thead><tr><th>算法类型</th><th>说明</th><th>适用场景</th></tr></thead><tbody><tr><td>INLINE</td><td>基于Groovy表达式的简单算法</td><td>简单的取模分片</td></tr><tr><td>STANDARD</td><td>标准分片算法</td><td>需要精确和范围查询</td></tr></tbody></table>
<p><strong>本项目使用INLINE算法</strong>,配置简单,性能优秀。</p>
<h3 data-id="heading-10">4.4 主键生成器</h3>
<p>分布式环境下,需要全局唯一的主键生成策略。</p>















<table><thead><tr><th>生成器类型</th><th>说明</th><th>特点</th></tr></thead><tbody><tr><td>SNOWFLAKE</td><td>雪花算法</td><td>分布式、高性能、趋势递增</td></tr></tbody></table>
<h3 data-id="heading-11">4.5 广播表</h3>
<p>在所有数据源中都存在的表,数据完全一致。</p>
<p><strong>特点:</strong></p>
<ul>
<li>插入、更新、删除操作会在所有数据源执行</li>
<li>查询操作只在一个数据源执行</li>
<li>适用于字典表、配置表等小表</li>
</ul>
<p><strong>配置示例:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">broadcast-tables:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">t_dict</span>
</code></pre>
<h3 data-id="heading-12">4.6 绑定表</h3>
<p>多个表使用相同的分片键和分片算法,确保关联数据在同一分片。</p>
<p><strong>配置示例:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">binding-tables:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">t_order,t_order_item</span>
</code></pre>
<p><strong>优势:</strong></p>
<ul>
<li>避免跨库JOIN</li>
<li>提高查询性能</li>
<li>简化事务处理</li>
</ul>
<hr/>
<h2 data-id="heading-13">五、快速开始</h2>
<h3 data-id="heading-14">5.1 添加依赖</h3>
<p>在<code>pom.xml</code>中添加ShardingSphere-JDBC依赖:</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- ShardingSphere-JDBC核心依赖 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shardingsphere<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shardingsphere-jdbc-core-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.2.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- MySQL驱动 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- MyBatis --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- Lombok --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.18.38<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-15">5.2 配置数据源</h3>
<p>在<code>application.yml</code>中配置4个数据源:</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">datasource:</span>
      <span class="hljs-attr">names:</span> <span class="hljs-string">ds0,ds1,ds2,ds3</span>
      
      <span class="hljs-attr">ds0:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span>
        <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
        <span class="hljs-attr">jdbc-url:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3306/test_db1?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=GMT%2B8</span>
        <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
        <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
        <span class="hljs-attr">hikari:</span>
          <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">10</span>
          <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">50</span>
          <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
          <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">600000</span>
          <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">1800000</span>
          <span class="hljs-attr">connection-test-query:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span>
      
      <span class="hljs-attr">ds1:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span>
        <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
        <span class="hljs-attr">jdbc-url:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3306/test_db2?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=GMT%2B8</span>
        <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
        <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
        <span class="hljs-attr">hikari:</span>
          <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">10</span>
          <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">50</span>
          <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
          <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">600000</span>
          <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">1800000</span>
          <span class="hljs-attr">connection-test-query:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span>
      
      <span class="hljs-attr">ds2:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span>
        <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
        <span class="hljs-attr">jdbc-url:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3306/test_db3?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=GMT%2B8</span>
        <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
        <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
        <span class="hljs-attr">hikari:</span>
          <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">10</span>
          <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">50</span>
          <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
          <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">600000</span>
          <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">1800000</span>
          <span class="hljs-attr">connection-test-query:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span>
      
      <span class="hljs-attr">ds3:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span>
        <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
        <span class="hljs-attr">jdbc-url:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3306/test_db4?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=GMT%2B8</span>
        <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
        <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
        <span class="hljs-attr">hikari:</span>
          <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">10</span>
          <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">50</span>
          <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
          <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">600000</span>
          <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">1800000</span>
          <span class="hljs-attr">connection-test-query:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span>
</code></pre>
<p><strong>配置说明:</strong></p>
<ul>
<li><code>names</code> - 定义所有数据源的名称</li>
<li><code>hikari</code> - HikariCP连接池配置
<ul>
<li><code>minimum-idle</code> - 最小空闲连接数</li>
<li><code>maximum-pool-size</code> - 最大连接池大小</li>
<li><code>connection-timeout</code> - 连接超时时间(毫秒)</li>
</ul>
</li>
</ul>
<h3 data-id="heading-16">5.3 配置分片规则</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-attr">sharding:</span>
        <span class="hljs-attr">tables:</span>
          <span class="hljs-comment"># 用户表配置</span>
          <span class="hljs-attr">t_user:</span>
            <span class="hljs-comment"># 实际数据节点: ds0.t_user_0, ds0.t_user_1, ds1.t_user_0, ds1.t_user_1</span>
            <span class="hljs-attr">actual-data-nodes:</span> <span class="hljs-string">ds$-&gt;{0..1}.t_user_$-&gt;{0..1}</span>
            
            <span class="hljs-comment"># 分库策略</span>
            <span class="hljs-attr">database-strategy:</span>
              <span class="hljs-attr">standard:</span>
                <span class="hljs-attr">sharding-column:</span> <span class="hljs-string">user_id</span>
                <span class="hljs-attr">sharding-algorithm-name:</span> <span class="hljs-string">user-db-inline</span>
            
            <span class="hljs-comment"># 分表策略</span>
            <span class="hljs-attr">table-strategy:</span>
              <span class="hljs-attr">standard:</span>
                <span class="hljs-attr">sharding-column:</span> <span class="hljs-string">user_id</span>
                <span class="hljs-attr">sharding-algorithm-name:</span> <span class="hljs-string">user-table-inline</span>
            
            <span class="hljs-comment"># 主键生成策略</span>
            <span class="hljs-attr">key-generate-strategy:</span>
              <span class="hljs-attr">column:</span> <span class="hljs-string">user_id</span>
              <span class="hljs-attr">key-generator-name:</span> <span class="hljs-string">snowflake</span>
</code></pre>
<p><strong>配置说明:</strong></p>
<ul>
<li><code>actual-data-nodes</code> - 定义物理表的分布
<ul>
<li><code>ds$-&gt;{0..1}</code> - 表示ds0和ds1两个数据源</li>
<li><code>t_user_$-&gt;{0..1}</code> - 表示t_user_0和t_user_1两个表</li>
<li>组合后: ds0.t_user_0, ds0.t_user_1, ds1.t_user_0, ds1.t_user_1</li>
</ul>
</li>
</ul>
<h3 data-id="heading-17">5.4 配置分片算法</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-attr">sharding:</span>
        <span class="hljs-attr">sharding-algorithms:</span>
          <span class="hljs-comment"># 用户表分库算法</span>
          <span class="hljs-attr">user-db-inline:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">INLINE</span>
            <span class="hljs-attr">props:</span>
              <span class="hljs-attr">algorithm-expression:</span> <span class="hljs-string">'ds$-&gt;{ (Math.abs(user_id.hashCode()) % 4).intdiv(2) }'</span>
          
          <span class="hljs-comment"># 用户表分表算法</span>
          <span class="hljs-attr">user-table-inline:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">INLINE</span>
            <span class="hljs-attr">props:</span>
              <span class="hljs-attr">algorithm-expression:</span> <span class="hljs-string">'t_user_$-&gt;{ Math.abs(user_id.hashCode()) % 2 }'</span>
</code></pre>
<p><strong>算法说明:</strong></p>
<ol>
<li>
<p><strong>分库算法</strong>: <code>ds$-&gt;{ (Math.abs(user_id.hashCode()) % 4).intdiv(2) }</code></p>
<ul>
<li>计算user_id的hashCode取绝对值</li>
<li>对4取模,得到0、1、2、3</li>
<li>整除2,得到0、1</li>
<li>最终路由到ds0或ds1</li>
</ul>
</li>
<li>
<p><strong>分表算法</strong>: <code>t_user_$-&gt;{ Math.abs(user_id.hashCode()) % 2 }</code></p>
<ul>
<li>计算user_id的hashCode取绝对值</li>
<li>对2取模,得到0、1</li>
<li>最终路由到t_user_0或t_user_1</li>
</ul>
</li>
</ol>
<p><strong>数据分布示例:</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">user_id</span> = <span class="hljs-number">100</span>
- 分库: (100 % 4).intdiv(2) = 0 → ds0
- 分表: 100 % <span class="hljs-attr">2</span> = <span class="hljs-number">0</span> → t_user_0
- 最终路由: ds0.t_user_0
</code></pre>
<h3 data-id="heading-18">5.5 配置主键生成器</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-attr">sharding:</span>
        <span class="hljs-attr">key-generators:</span>
          <span class="hljs-attr">snowflake:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">SNOWFLAKE</span>
</code></pre>
<p><strong>雪花算法原理:</strong></p>
<ul>
<li>1位符号位</li>
<li>41位时间戳(毫秒级)</li>
<li>10位机器ID</li>
<li>12位序列号</li>
</ul>
<h3 data-id="heading-19">5.6 配置广播表和绑定表</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-attr">sharding:</span>
        <span class="hljs-comment"># 绑定表配置</span>
        <span class="hljs-attr">binding-tables:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">t_order,t_order_item</span>
        
        <span class="hljs-comment"># 广播表配置</span>
        <span class="hljs-attr">broadcast-tables:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">t_dict</span>
</code></pre>
<h3 data-id="heading-20">5.7 配置属性</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">props:</span>
      <span class="hljs-comment"># 显示SQL(生产环境建议关闭)</span>
      <span class="hljs-attr">sql-show:</span> <span class="hljs-literal">true</span>
      <span class="hljs-comment"># 允许没有分片列的插入通过主键生成器</span>
      <span class="hljs-attr">check-table-metadata-enabled:</span> <span class="hljs-literal">false</span>
</code></pre>
<h3 data-id="heading-21">5.8 创建实体类</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.demo.model;

<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> java.time.LocalDateTime;

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    
    <span class="hljs-comment">/**
     * 用户ID(主键,由ShardingSphere自动生成)
     */</span>
    <span class="hljs-keyword">private</span> Long userId;
    
    <span class="hljs-comment">/**
     * 用户名
     */</span>
    <span class="hljs-keyword">private</span> String username;
    
    <span class="hljs-comment">/**
     * 邮箱
     */</span>
    <span class="hljs-keyword">private</span> String email;
    
    <span class="hljs-comment">/**
     * 年龄
     */</span>
    <span class="hljs-keyword">private</span> Integer age;
    
    <span class="hljs-comment">/**
     * 创建时间
     */</span>
    <span class="hljs-keyword">private</span> LocalDateTime createdTime;
    
    <span class="hljs-comment">/**
     * 更新时间
     */</span>
    <span class="hljs-keyword">private</span> LocalDateTime updatedTime;
}
</code></pre>
<h3 data-id="heading-22">5.9 创建Mapper接口</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.demo.mapper;

<span class="hljs-keyword">import</span> com.example.demo.model.User;
<span class="hljs-keyword">import</span> org.apache.ibatis.annotations.*;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Mapper</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserMapper</span> {
    
    <span class="hljs-comment">/**
     * 插入用户
     * 注意:不包含user_id字段,由ShardingSphere自动生成
     */</span>
    <span class="hljs-meta">@Insert("INSERT INTO t_user (username, email, age) VALUES (#{username}, #{email}, #{age})")</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(User user)</span>;
    
    <span class="hljs-comment">/**
     * 根据ID更新用户
     */</span>
    <span class="hljs-meta">@Update("UPDATE t_user SET username = #{username}, email = #{email}, age = #{age} WHERE user_id = #{userId}")</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">updateById</span><span class="hljs-params">(User user)</span>;
    
    <span class="hljs-comment">/**
     * 根据ID查询用户
     */</span>
    <span class="hljs-meta">@Select("SELECT * FROM t_user WHERE user_id = #{userId}")</span>
    User <span class="hljs-title function_">selectById</span><span class="hljs-params">(Long userId)</span>;
    
    <span class="hljs-comment">/**
     * 根据用户名查询用户
     * 注意:此查询不包含分片键,会导致全路由
     */</span>
    <span class="hljs-meta">@Select("SELECT * FROM t_user WHERE username = #{username}")</span>
    User <span class="hljs-title function_">selectByUsername</span><span class="hljs-params">(String username)</span>;
    
    <span class="hljs-comment">/**
     * 查询所有用户
     * 注意:此查询不包含分片键,会导致全路由
     */</span>
    <span class="hljs-meta">@Select("SELECT * FROM t_user")</span>
    List&lt;User&gt; <span class="hljs-title function_">selectAll</span><span class="hljs-params">()</span>;
    
    <span class="hljs-comment">/**
     * 根据ID删除用户
     */</span>
    <span class="hljs-meta">@Delete("DELETE FROM t_user WHERE user_id = #{userId}")</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">deleteById</span><span class="hljs-params">(Long userId)</span>;
}
</code></pre>
<p><strong>重要说明:</strong></p>
<ul>
<li>INSERT语句中不包含分片键字段(user_id),由ShardingSphere自动生成</li>
<li>查询语句最好包含分片键,否则会导致全路由,性能较差</li>
</ul>
<h3 data-id="heading-23">5.10 创建Controller层</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.demo.controller;

<span class="hljs-keyword">import</span> com.example.demo.mapper.UserMapper;
<span class="hljs-keyword">import</span> com.example.demo.model.User;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserMapper userMapper;
    
    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">insert</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> userMapper.insert(user);
        <span class="hljs-keyword">return</span> result &gt; <span class="hljs-number">0</span> ? <span class="hljs-string">"User inserted successfully"</span> : <span class="hljs-string">"Failed to insert user"</span>;
    }
    
    <span class="hljs-meta">@PutMapping</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">update</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> userMapper.updateById(user);
        <span class="hljs-keyword">return</span> result &gt; <span class="hljs-number">0</span> ? <span class="hljs-string">"User updated successfully"</span> : <span class="hljs-string">"Failed to update user"</span>;
    }
    
    <span class="hljs-meta">@GetMapping("/{userId}")</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">selectById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long userId)</span> {
        <span class="hljs-keyword">return</span> userMapper.selectById(userId);
    }
    
    <span class="hljs-meta">@GetMapping("/username/{username}")</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">selectByUsername</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String username)</span> {
        <span class="hljs-keyword">return</span> userMapper.selectByUsername(username);
    }
    
    <span class="hljs-meta">@GetMapping</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">selectAll</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> userMapper.selectAll();
    }
    
    <span class="hljs-meta">@DeleteMapping("/{userId}")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">deleteById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long userId)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> userMapper.deleteById(userId);
        <span class="hljs-keyword">return</span> result &gt; <span class="hljs-number">0</span> ? <span class="hljs-string">"User deleted successfully"</span> : <span class="hljs-string">"Failed to delete user"</span>;
    }
}
</code></pre>
<h3 data-id="heading-24">5.11 初始化数据库</h3>
<p>执行SQL脚本创建数据库和表:</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建数据库</span>
<span class="hljs-keyword">CREATE</span> DATABASE IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> test_db1 <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_unicode_ci;
<span class="hljs-keyword">CREATE</span> DATABASE IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> test_db2 <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_unicode_ci;

<span class="hljs-comment">-- 创建用户表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> t_user_0
(
    user_id      <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    username     <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    email        <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>),
    age          <span class="hljs-type">INT</span>,
    created_time <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    updated_time <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
) ENGINE <span class="hljs-operator">=</span> InnoDB
  <span class="hljs-keyword">DEFAULT</span> CHARSET <span class="hljs-operator">=</span> utf8mb4
  <span class="hljs-keyword">COLLATE</span> <span class="hljs-operator">=</span> utf8mb4_unicode_ci;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> t_user_1
(
    user_id      <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    username     <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    email        <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>),
    age          <span class="hljs-type">INT</span>,
    created_time <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    updated_time <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
) ENGINE <span class="hljs-operator">=</span> InnoDB
  <span class="hljs-keyword">DEFAULT</span> CHARSET <span class="hljs-operator">=</span> utf8mb4
  <span class="hljs-keyword">COLLATE</span> <span class="hljs-operator">=</span> utf8mb4_unicode_ci;
</code></pre>
<h3 data-id="heading-25">5.12 启动项目</h3>
<pre><code class="hljs language-bash" lang="bash">mvn spring-boot:run
</code></pre>
<h3 data-id="heading-26">5.13 测试API</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 插入用户</span>
curl -X POST http://localhost:8080/users \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -d <span class="hljs-string">'{"username":"zhangsan","email":"zhangsan@example.com","age":25}'</span>

<span class="hljs-comment"># 根据ID查询用户</span>
curl http://localhost:8080/users/100

<span class="hljs-comment"># 根据用户名查询用户</span>
curl http://localhost:8080/users/username/zhangsan

<span class="hljs-comment"># 查询所有用户</span>
curl http://localhost:8080/users

<span class="hljs-comment"># 更新用户</span>
curl -X PUT http://localhost:8080/users \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -d <span class="hljs-string">'{"userId":100,"username":"lisi","email":"lisi@example.com","age":26}'</span>

<span class="hljs-comment"># 删除用户</span>
curl -X DELETE http://localhost:8080/users/100
</code></pre>
<hr/>
<h2 data-id="heading-27">六、分片策略详解</h2>
<h3 data-id="heading-28">6.1 标准分片策略</h3>
<p>标准分片策略是最常用的分片策略,支持精确分片和范围查询。</p>
<p><strong>配置示例:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">t_user:</span>
  <span class="hljs-attr">actual-data-nodes:</span> <span class="hljs-string">ds$-&gt;{0..1}.t_user_$-&gt;{0..1}</span>
  <span class="hljs-attr">database-strategy:</span>
    <span class="hljs-attr">standard:</span>
      <span class="hljs-attr">sharding-column:</span> <span class="hljs-string">user_id</span>
      <span class="hljs-attr">sharding-algorithm-name:</span> <span class="hljs-string">user-db-inline</span>
  <span class="hljs-attr">table-strategy:</span>
    <span class="hljs-attr">standard:</span>
      <span class="hljs-attr">sharding-column:</span> <span class="hljs-string">user_id</span>
      <span class="hljs-attr">sharding-algorithm-name:</span> <span class="hljs-string">user-table-inline</span>
</code></pre>
<h3 data-id="heading-29">6.2 行表达式分片算法</h3>
<p>行表达式分片算法是最简单的分片算法,使用Groovy表达式定义分片规则。</p>
<p><strong>配置示例:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-attr">sharding:</span>
        <span class="hljs-attr">sharding-algorithms:</span>
          <span class="hljs-attr">user-db-inline:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">INLINE</span>
            <span class="hljs-attr">props:</span>
              <span class="hljs-attr">algorithm-expression:</span> <span class="hljs-string">'ds$-&gt;{ (Math.abs(user_id.hashCode()) % 4).intdiv(2) }'</span>
          
          <span class="hljs-attr">user-table-inline:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">INLINE</span>
            <span class="hljs-attr">props:</span>
              <span class="hljs-attr">algorithm-expression:</span> <span class="hljs-string">'t_user_$-&gt;{ Math.abs(user_id.hashCode()) % 2 }'</span>
</code></pre>
<p><strong>常用表达式:</strong></p>






























<table><thead><tr><th>表达式</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>$-&gt;{column}</code></td><td>获取分片列的值</td><td><code>user_id</code></td></tr><tr><td><code>$-&gt;{column % n}</code></td><td>取模运算</td><td><code>user_id % 2</code></td></tr><tr><td><code>$-&gt;{Math.abs(column.hashCode())}</code></td><td>取绝对值</td><td><code>Math.abs(user_id.hashCode())</code></td></tr><tr><td><code>$-&gt;{column.intdiv(n)}</code></td><td>整除运算</td><td><code>(user_id % 4).intdiv(2)</code></td></tr></tbody></table>
<p><strong>示例:</strong></p>
<ol>
<li><strong>简单取模</strong></li>
</ol>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">algorithm-expression:</span> <span class="hljs-string">'t_user_$-&gt;{user_id % 2}'</span>
</code></pre>
<ol start="2">
<li><strong>Hash取模</strong></li>
</ol>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">algorithm-expression:</span> <span class="hljs-string">'t_user_$-&gt;{Math.abs(user_id.hashCode()) % 2}'</span>
</code></pre>
<p><strong>注意事项:</strong></p>
<ul>
<li>表达式必须返回字符串</li>
<li>表达式中的变量名必须与分片列名一致</li>
<li>复杂表达式建议使用自定义算法</li>
</ul>
<h3 data-id="heading-30">6.3 本项目分片策略总结</h3>
<p><strong>用户表 (t_user)</strong></p>
<ul>
<li>数据源: ds0, ds1 (对应数据库 test_db1, test_db2)</li>
<li>分片键: user_id</li>
<li>分库策略: 按 user_id % 4 后整除2 (偶数分到ds0, 奇数分到ds1)</li>
<li>分表策略: 按 user_id % 2 分表</li>
<li>表结构: 两个数据源共包含 t_user_0 和 t_user_1 四个分表</li>
</ul>
<p><strong>订单表 (t_order)</strong></p>
<ul>
<li>数据源: ds2, ds3 (对应数据库 test_db3, test_db4)</li>
<li>分片键: order_id</li>
<li>分库算法: 按 order_id % 2 映射到 ds2, ds3</li>
<li>分表算法: 按 order_id % 4 分片</li>
<li>表结构: 每个数据源包含 t_order_0 到 t_order_3 四个分表</li>
</ul>
<p><strong>订单项表 (t_order_item)</strong></p>
<ul>
<li>数据源: ds2, ds3 (对应数据库 test_db3, test_db4)</li>
<li>分片键: order_id</li>
<li>与订单表为绑定表关系</li>
</ul>
<p><strong>广播表 (t_dict)</strong></p>
<ul>
<li>在所有数据源中都存在</li>
<li>数据完全一致</li>
</ul>
<hr/>
<h2 data-id="heading-31">七、高级特性</h2>
<h3 data-id="heading-32">7.1 Hint分片策略</h3>
<p>Hint分片策略通过Hint指定分片，适用于需要强制路由的场景。</p>
<p><strong>使用场景:</strong></p>
<ul>
<li>批量操作时指定分片提高性能</li>
<li>需要强制路由到特定分片的场景</li>
<li>数据迁移场景</li>
</ul>
<p><strong>配置示例:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-attr">sharding:</span>
        <span class="hljs-attr">tables:</span>
          <span class="hljs-attr">t_order:</span>
            <span class="hljs-attr">actual-data-nodes:</span> <span class="hljs-string">ds$-&gt;{2..3}.t_order_$-&gt;{0..3}</span>
            <span class="hljs-attr">table-strategy:</span>
              <span class="hljs-attr">hint:</span>
                <span class="hljs-attr">sharding-algorithm-name:</span> <span class="hljs-string">order-hint</span>
        
        <span class="hljs-attr">sharding-algorithms:</span>
          <span class="hljs-attr">order-hint:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">INLINE</span>
            <span class="hljs-attr">props:</span>
              <span class="hljs-attr">algorithm-expression:</span> <span class="hljs-string">'t_order_$-&gt;{value}'</span>
</code></pre>
<p><strong>使用Hint路由:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.demo.controller;

<span class="hljs-keyword">import</span> com.example.demo.mapper.OrderMapper;
<span class="hljs-keyword">import</span> com.example.demo.model.Order;
<span class="hljs-keyword">import</span> org.apache.shardingsphere.infra.hint.HintManager;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/orders")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderMapper orderMapper;
    
    <span class="hljs-comment">/**
     * 使用Hint强制路由到指定分片查询
     * 
     * <span class="hljs-doctag">@param</span> orderId 订单ID
     * <span class="hljs-doctag">@param</span> tableIndex 表索引(0-3)
     * <span class="hljs-doctag">@return</span> 订单对象
     */</span>
    <span class="hljs-meta">@GetMapping("/hint/{orderId}/{tableIndex}")</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">selectByHint</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long orderId, <span class="hljs-meta">@PathVariable</span> <span class="hljs-type">int</span> tableIndex)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">HintManager</span> <span class="hljs-variable">hintManager</span> <span class="hljs-operator">=</span> HintManager.getInstance()) {
            <span class="hljs-comment">// 设置Hint值，指定路由到哪个分片</span>
            hintManager.addTableShardingValue(<span class="hljs-string">"t_order"</span>, tableIndex);
            <span class="hljs-keyword">return</span> orderMapper.selectById(orderId);
        }
    }
    
    <span class="hljs-comment">/**
     * 批量查询，指定多个分片
     * 
     * <span class="hljs-doctag">@param</span> tableIndices 表索引列表(0-3)
     * <span class="hljs-doctag">@return</span> 订单列表
     */</span>
    <span class="hljs-meta">@GetMapping("/hint/batch/{tableIndices}")</span>
    <span class="hljs-keyword">public</span> List&lt;Order&gt; <span class="hljs-title function_">batchSelectByHint</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> List&lt;Integer&gt; tableIndices)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">HintManager</span> <span class="hljs-variable">hintManager</span> <span class="hljs-operator">=</span> HintManager.getInstance()) {
            <span class="hljs-comment">// 设置多个Hint值</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> tableIndex : tableIndices) {
                hintManager.addTableShardingValue(<span class="hljs-string">"t_order"</span>, tableIndex);
            }
            <span class="hljs-keyword">return</span> orderMapper.selectAll();
        }
    }
}
</code></pre>
<p><strong>注意事项:</strong></p>
<ul>
<li>HintManager使用后需要关闭，可以使用try-with-resources</li>
<li>Hint只在当前线程有效</li>
<li>Hint优先级高于其他分片策略</li>
</ul>
<h3 data-id="heading-33">7.2 读写分离</h3>
<p>读写分离是提升系统性能的重要手段，将读操作分发到从库，写操作在主库执行。</p>
<p><strong>配置示例:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">datasource:</span>
      <span class="hljs-attr">names:</span> <span class="hljs-string">master,slave0,slave1</span>
      
      <span class="hljs-comment"># 主库配置</span>
      <span class="hljs-attr">master:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span>
        <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
        <span class="hljs-attr">jdbc-url:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3306/test_db?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=GMT%2B8</span>
        <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
        <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
        <span class="hljs-attr">hikari:</span>
          <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">10</span>
          <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">50</span>
          <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
      
      <span class="hljs-comment"># 从库0配置</span>
      <span class="hljs-attr">slave0:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span>
        <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
        <span class="hljs-attr">jdbc-url:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3307/test_db?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=GMT%2B8</span>
        <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
        <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
        <span class="hljs-attr">hikari:</span>
          <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">10</span>
          <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">50</span>
          <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
      
      <span class="hljs-comment"># 从库1配置</span>
      <span class="hljs-attr">slave1:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span>
        <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
        <span class="hljs-attr">jdbc-url:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3308/test_db?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=GMT%2B8</span>
        <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
        <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
        <span class="hljs-attr">hikari:</span>
          <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">10</span>
          <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">50</span>
          <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
    
    <span class="hljs-attr">rules:</span>
      <span class="hljs-comment"># 读写分离规则</span>
      <span class="hljs-attr">readwrite-splitting:</span>
        <span class="hljs-attr">data-sources:</span>
          <span class="hljs-comment"># 读写分离数据源配置</span>
          <span class="hljs-attr">readwrite_ds:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">Static</span>
            <span class="hljs-attr">props:</span>
              <span class="hljs-comment"># 写数据源</span>
              <span class="hljs-attr">write-data-source-name:</span> <span class="hljs-string">master</span>
              <span class="hljs-comment"># 读数据源列表</span>
              <span class="hljs-attr">read-data-source-names:</span> <span class="hljs-string">slave0,slave1</span>
              <span class="hljs-comment"># 负载均衡算法</span>
              <span class="hljs-attr">load-balancer-name:</span> <span class="hljs-string">round_robin</span>
        
        <span class="hljs-comment"># 负载均衡算法</span>
        <span class="hljs-attr">load-balancers:</span>
          <span class="hljs-attr">round_robin:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">ROUND_ROBIN</span>
          <span class="hljs-attr">random:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">RANDOM</span>
</code></pre>
<p><strong>负载均衡算法:</strong></p>




















<table><thead><tr><th>算法类型</th><th>说明</th><th>适用场景</th></tr></thead><tbody><tr><td>ROUND_ROBIN</td><td>轮询</td><td>从库性能相近</td></tr><tr><td>RANDOM</td><td>随机</td><td>从库性能相近</td></tr></tbody></table>
<p><strong>强制读主库:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.demo.controller;

<span class="hljs-keyword">import</span> com.example.demo.mapper.UserMapper;
<span class="hljs-keyword">import</span> com.example.demo.model.User;
<span class="hljs-keyword">import</span> org.apache.shardingsphere.infra.hint.HintManager;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;

<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserMapper userMapper;
    
    <span class="hljs-comment">/**
     * 强制从主库读取数据
     * 用于需要读取最新数据的场景
     * 
     * <span class="hljs-doctag">@param</span> userId 用户ID
     * <span class="hljs-doctag">@return</span> 用户对象
     */</span>
    <span class="hljs-meta">@GetMapping("/master/{userId}")</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">selectFromMaster</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long userId)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">HintManager</span> <span class="hljs-variable">hintManager</span> <span class="hljs-operator">=</span> HintManager.getInstance()) {
            <span class="hljs-comment">// 设置从主库读取</span>
            hintManager.setWriteRouteOnly();
            <span class="hljs-keyword">return</span> userMapper.selectById(userId);
        }
    }
}
</code></pre>
<p><strong>注意事项:</strong></p>
<ul>
<li>读写分离依赖MySQL主从复制</li>
<li>主从复制有延迟，可能读到旧数据</li>
<li>需要读取最新数据时，使用Hint强制读主库</li>
<li>确保从库数据与主库一致</li>
</ul>
<h3 data-id="heading-34">7.3 数据加密</h3>
<p>ShardingSphere支持数据加密，保护敏感数据。</p>
<p><strong>配置示例:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-comment"># 加密规则</span>
      <span class="hljs-attr">encrypt:</span>
        <span class="hljs-attr">tables:</span>
          <span class="hljs-attr">t_user:</span>
            <span class="hljs-attr">columns:</span>
              <span class="hljs-comment"># 邮箱加密配置</span>
              <span class="hljs-attr">email:</span>
                <span class="hljs-attr">cipher-column:</span> <span class="hljs-string">email_cipher</span>  <span class="hljs-comment"># 加密列</span>
                <span class="hljs-attr">assisted-query-column:</span> <span class="hljs-string">email_assisted</span>  <span class="hljs-comment"># 辅助查询列</span>
                <span class="hljs-attr">encryptor-name:</span> <span class="hljs-string">aes_encryptor</span>  <span class="hljs-comment"># 加密器名称</span>
              <span class="hljs-comment"># 手机号加密配置</span>
              <span class="hljs-attr">phone:</span>
                <span class="hljs-attr">cipher-column:</span> <span class="hljs-string">phone_cipher</span>
                <span class="hljs-attr">encryptor-name:</span> <span class="hljs-string">aes_encryptor</span>
        
        <span class="hljs-comment"># 加密器配置</span>
        <span class="hljs-attr">encryptors:</span>
          <span class="hljs-attr">aes_encryptor:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">AES</span>
            <span class="hljs-attr">props:</span>
              <span class="hljs-attr">aes-key-value:</span> <span class="hljs-number">1234567890123456</span>  <span class="hljs-comment"># AES密钥，16位</span>
</code></pre>
<p><strong>实体类调整:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.demo.model;

<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> java.time.LocalDateTime;

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    
    <span class="hljs-keyword">private</span> Long userId;
    <span class="hljs-keyword">private</span> String username;
    
    <span class="hljs-comment">/**
     * 邮箱（逻辑列，自动加密）
     */</span>
    <span class="hljs-keyword">private</span> String email;
    
    <span class="hljs-comment">/**
     * 手机号（逻辑列，自动加密）
     */</span>
    <span class="hljs-keyword">private</span> String phone;
    
    <span class="hljs-keyword">private</span> Integer age;
    <span class="hljs-keyword">private</span> LocalDateTime createdTime;
    <span class="hljs-keyword">private</span> LocalDateTime updatedTime;
}
</code></pre>
<p><strong>数据库表结构:</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> t_user_0
(
    user_id            <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    username           <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    email_cipher       <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>),  <span class="hljs-comment">-- 加密后的邮箱</span>
    email_assisted     <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>),  <span class="hljs-comment">-- 辅助查询列</span>
    phone_cipher       <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>),  <span class="hljs-comment">-- 加密后的手机号</span>
    age                <span class="hljs-type">INT</span>,
    created_time       <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    updated_time       <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
) ENGINE <span class="hljs-operator">=</span> InnoDB
  <span class="hljs-keyword">DEFAULT</span> CHARSET <span class="hljs-operator">=</span> utf8mb4
  <span class="hljs-keyword">COLLATE</span> <span class="hljs-operator">=</span> utf8mb4_unicode_ci;
</code></pre>
<p><strong>加密算法类型:</strong></p>




















<table><thead><tr><th>算法类型</th><th>说明</th><th>适用场景</th></tr></thead><tbody><tr><td>AES</td><td>AES加密</td><td>通用加密</td></tr><tr><td>MD5</td><td>MD5加密</td><td>不可逆加密</td></tr></tbody></table>
<p><strong>注意事项:</strong></p>
<ul>
<li>加密后无法直接查询，需要使用辅助查询列</li>
<li>加密会影响性能，谨慎使用</li>
<li>密钥需要安全存储，建议使用密钥管理服务</li>
</ul>
<h3 data-id="heading-35">7.4 分布式主键生成策略</h3>
<p>除了Snowflake算法，ShardingSphere还支持其他主键生成策略。</p>
<p><strong>配置示例:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-attr">sharding:</span>
        <span class="hljs-attr">key-generators:</span>
          <span class="hljs-comment"># 雪花算法</span>
          <span class="hljs-attr">snowflake:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">SNOWFLAKE</span>
            <span class="hljs-attr">props:</span>
              <span class="hljs-attr">max-vibration-offset:</span> <span class="hljs-number">1</span>  <span class="hljs-comment"># 最大抖动偏移量</span>
              <span class="hljs-attr">max-tolerate-time-difference-milliseconds:</span> <span class="hljs-number">10</span>  <span class="hljs-comment"># 最大容忍时间差(毫秒)</span>
</code></pre>
<p><strong>主键生成器类型:</strong></p>

























<table><thead><tr><th>生成器类型</th><th>说明</th><th>特点</th></tr></thead><tbody><tr><td>SNOWFLAKE</td><td>雪花算法</td><td>分布式、高性能、趋势递增</td></tr><tr><td>UUID</td><td>UUID</td><td>无序、长度长</td></tr><tr><td>NIL</td><td>不生成主键</td><td>需要手动指定</td></tr></tbody></table>
<p><strong>使用建议:</strong></p>
<ul>
<li>优先使用Snowflake算法</li>
<li>性能敏感场景考虑调整max-tolerate-time-difference-milliseconds</li>
<li>确保主键唯一性</li>
</ul>
<h3 data-id="heading-36">7.5 SQL解析与改写</h3>
<p>ShardingSphere支持SQL解析和改写，这是其核心能力之一。</p>
<p><strong>功能说明:</strong></p>
<ol>
<li><strong>自动路由</strong> - 根据分片键自动路由到目标分片</li>
<li><strong>结果归并</strong> - 合并多个分片的结果</li>
<li><strong>SQL改写</strong> - 修改SQL以适应分片场景</li>
</ol>
<p><strong>示例:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 原始SQL</span>
SELECT * FROM t_user <span class="hljs-type">WHERE</span> <span class="hljs-variable">user_id</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>

<span class="hljs-comment">// 改写后的SQL（路由到ds0.t_user_0）</span>
SELECT * FROM ds0.t_user_0 <span class="hljs-type">WHERE</span> <span class="hljs-variable">user_id</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>
</code></pre>
<p><strong>使用建议:</strong></p>
<ul>
<li>理解SQL改写原理，优化SQL语句</li>
<li>避免全路由查询，性能较差</li>
<li>使用绑定表避免跨库JOIN</li>
</ul>
<h3 data-id="heading-37">7.6 配置中心</h3>
<p>ShardingSphere支持配置中心，实现动态配置管理。</p>
<p><strong>支持的配置中心:</strong></p>
<ul>
<li>Zookeeper</li>
<li>Nacos</li>
<li>Etcd</li>
<li>Apollo</li>
</ul>
<p><strong>配置示例:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">mode:</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">Cluster</span>
      <span class="hljs-attr">repository:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">Zookeeper</span>
        <span class="hljs-attr">props:</span>
          <span class="hljs-attr">namespace:</span> <span class="hljs-string">sharding-sphere</span>
          <span class="hljs-attr">server-lists:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:2181</span>
          <span class="hljs-attr">retry-interval-milliseconds:</span> <span class="hljs-number">500</span>
          <span class="hljs-attr">max-retries:</span> <span class="hljs-number">3</span>
          <span class="hljs-attr">time-to-live-milliseconds:</span> <span class="hljs-number">5000</span>
</code></pre>
<p><strong>优势:</strong></p>
<ul>
<li>配置动态更新，无需重启</li>
<li>配置集中管理</li>
<li>配置版本控制</li>
</ul>
<p><strong>使用建议:</strong></p>
<ul>
<li>生产环境使用配置中心</li>
<li>配置变更需要灰度发布</li>
<li>配置需要备份</li>
</ul>
<hr/>
<h2 data-id="heading-38">八、生产环境最佳实践</h2>
<h3 data-id="heading-39">7.1 配置优化</h3>
<p><strong>数据源配置:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">datasource:</span>
      <span class="hljs-attr">ds0:</span>
        <span class="hljs-attr">hikari:</span>
          <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">10</span>
          <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">50</span>
          <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
          <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">600000</span>
          <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">1800000</span>
          <span class="hljs-attr">connection-test-query:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span>
</code></pre>
<p><strong>ShardingSphere配置:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">props:</span>
      <span class="hljs-comment"># 生产环境关闭SQL显示</span>
      <span class="hljs-attr">sql-show:</span> <span class="hljs-literal">false</span>
      <span class="hljs-comment"># 允许没有分片列的插入通过主键生成器</span>
      <span class="hljs-attr">check-table-metadata-enabled:</span> <span class="hljs-literal">false</span>
      <span class="hljs-comment"># 核心执行线程池大小</span>
      <span class="hljs-attr">kernel-executor-size:</span> <span class="hljs-number">16</span>
</code></pre>
<h3 data-id="heading-40">7.2 性能优化</h3>
<p><strong>1. 使用绑定表</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-attr">sharding:</span>
        <span class="hljs-attr">binding-tables:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">t_order,t_order_item</span>
</code></pre>
<p><strong>优势:</strong></p>
<ul>
<li>避免跨库JOIN</li>
<li>提高查询性能</li>
<li>简化事务处理</li>
</ul>
<p><strong>2. 避免全路由</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 不推荐:不包含分片键,全路由</span>
List&lt;User&gt; users = userMapper.selectAll();

<span class="hljs-comment">// 推荐:包含分片键,精确路由</span>
<span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.selectById(<span class="hljs-number">100L</span>);
</code></pre>
<p><strong>3. 合理使用索引</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 在分片键上创建索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_user_id <span class="hljs-keyword">ON</span> t_user(user_id);

<span class="hljs-comment">-- 在常用查询字段上创建索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_username <span class="hljs-keyword">ON</span> t_user(username);
</code></pre>
<h3 data-id="heading-41">7.3 监控告警</h3>
<p><strong>监控指标:</strong></p>
<ol>
<li>
<p><strong>数据库指标</strong></p>
<ul>
<li>连接数使用率</li>
<li>慢查询数量</li>
<li>锁等待时间</li>
</ul>
</li>
<li>
<p><strong>应用指标</strong></p>
<ul>
<li>SQL执行时间</li>
<li>SQL错误率</li>
<li>分片路由时间</li>
</ul>
</li>
<li>
<p><strong>业务指标</strong></p>
<ul>
<li>请求响应时间</li>
<li>请求成功率</li>
<li>请求吞吐量</li>
</ul>
</li>
</ol>
<h3 data-id="heading-42">7.4 安全加固</h3>
<p><strong>1. SQL注入防护</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 不推荐:字符串拼接SQL</span>
<span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT * FROM t_user WHERE username = '"</span> + username + <span class="hljs-string">"'"</span>;

<span class="hljs-comment">// 推荐:使用参数化查询</span>
<span class="hljs-meta">@Select("SELECT * FROM t_user WHERE username = #{username}")</span>
User <span class="hljs-title function_">selectByUsername</span><span class="hljs-params">(String username)</span>;
</code></pre>
<p><strong>2. 权限控制</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建只读用户</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'readonly'</span>@<span class="hljs-string">'%'</span> IDENTIFIED <span class="hljs-keyword">BY</span> <span class="hljs-string">'password'</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">ON</span> test_db.<span class="hljs-operator">*</span> <span class="hljs-keyword">TO</span> <span class="hljs-string">'readonly'</span>@<span class="hljs-string">'%'</span>;

<span class="hljs-comment">-- 创建读写用户</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'readwrite'</span>@<span class="hljs-string">'%'</span> IDENTIFIED <span class="hljs-keyword">BY</span> <span class="hljs-string">'password'</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span>, <span class="hljs-keyword">INSERT</span>, <span class="hljs-keyword">UPDATE</span>, <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">ON</span> test_db.<span class="hljs-operator">*</span> <span class="hljs-keyword">TO</span> <span class="hljs-string">'readwrite'</span>@<span class="hljs-string">'%'</span>;
</code></pre>
<h3 data-id="heading-43">7.5 运维建议</h3>
<p><strong>1. 定期备份</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 备份数据库</span>
mysqldump -h 127.0.0.1 -u root -p test_db1 &gt; test_db1_backup.sql

<span class="hljs-comment"># 恢复数据库</span>
mysql -h 127.0.0.1 -u root -p test_db1 &lt; test_db1_backup.sql
</code></pre>
<p><strong>2. 定期清理</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 清理过期数据</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> t_user <span class="hljs-keyword">WHERE</span> created_time <span class="hljs-operator">&lt;</span> DATE_SUB(NOW(), <span class="hljs-type">INTERVAL</span> <span class="hljs-number">1</span> <span class="hljs-keyword">YEAR</span>);

<span class="hljs-comment">-- 优化表</span>
OPTIMIZE <span class="hljs-keyword">TABLE</span> t_user_0;
OPTIMIZE <span class="hljs-keyword">TABLE</span> t_user_1;
</code></pre>
<hr/>
<h2 data-id="heading-44">九、常见问题与解决方案</h2>
<h3 data-id="heading-45">9.1 分片键自动生成问题</h3>
<p><strong>问题:</strong> INSERT语句不包含分片键,导致路由失败。</p>
<p><strong>解决方案:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">props:</span>
      <span class="hljs-attr">check-table-metadata-enabled:</span> <span class="hljs-literal">false</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Insert("INSERT INTO t_user (username, email, age) VALUES (#{username}, #{email}, #{age})")</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(User user)</span>;
</code></pre>
<h3 data-id="heading-46">9.2 全路由问题</h3>
<p><strong>问题:</strong> 查询不包含分片键,导致全路由,性能较差。</p>
<p><strong>解决方案:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 不推荐:全路由</span>
List&lt;User&gt; users = userMapper.selectAll();

<span class="hljs-comment">// 推荐:精确路由</span>
<span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.selectById(<span class="hljs-number">100L</span>);
</code></pre>
<h3 data-id="heading-47">9.3 跨库JOIN问题</h3>
<p><strong>问题:</strong> 跨库JOIN性能较差或无法执行。</p>
<p><strong>解决方案:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-attr">sharding:</span>
        <span class="hljs-attr">binding-tables:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">t_order,t_order_item</span>
</code></pre>
<h3 data-id="heading-48">9.4 主键冲突问题</h3>
<p><strong>问题:</strong> 分布式主键生成器配置错误,导致主键冲突。</p>
<p><strong>解决方案:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-attr">sharding:</span>
        <span class="hljs-attr">key-generators:</span>
          <span class="hljs-attr">snowflake:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">SNOWFLAKE</span>
</code></pre>
<h3 data-id="heading-49">9.5 连接池耗尽问题</h3>
<p><strong>问题:</strong> 连接池配置不合理,导致连接池耗尽。</p>
<p><strong>解决方案:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">datasource:</span>
      <span class="hljs-attr">ds0:</span>
        <span class="hljs-attr">hikari:</span>
          <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">10</span>
          <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">50</span>
          <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
</code></pre>
<h3 data-id="heading-50">9.6 Hint分片不生效问题</h3>
<p><strong>问题:</strong> 使用HintManager指定分片后，查询仍然路由到所有分片。</p>
<p><strong>解决方案:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 确保使用try-with-resources或手动关闭HintManager</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">HintManager</span> <span class="hljs-variable">hintManager</span> <span class="hljs-operator">=</span> HintManager.getInstance()) {
    hintManager.addTableShardingValue(<span class="hljs-string">"t_order"</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">return</span> orderMapper.selectById(orderId);
}

<span class="hljs-comment">// 或者手动关闭</span>
<span class="hljs-type">HintManager</span> <span class="hljs-variable">hintManager</span> <span class="hljs-operator">=</span> HintManager.getInstance();
<span class="hljs-keyword">try</span> {
    hintManager.addTableShardingValue(<span class="hljs-string">"t_order"</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">return</span> orderMapper.selectById(orderId);
} <span class="hljs-keyword">finally</span> {
    hintManager.close();
}
</code></pre>
<h3 data-id="heading-51">9.7 读写分离主从延迟问题</h3>
<p><strong>问题:</strong> 读写分离导致主从延迟，读取到旧数据。</p>
<p><strong>解决方案:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 强制读主库</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">HintManager</span> <span class="hljs-variable">hintManager</span> <span class="hljs-operator">=</span> HintManager.getInstance()) {
    hintManager.setWriteRouteOnly();
    <span class="hljs-keyword">return</span> userMapper.selectById(userId);
}
</code></pre>
<hr/>
<h2 data-id="heading-52">十、总结</h2>
<p>ShardingSphere-JDBC是一个功能强大的分库分表中间件,本文档详细介绍了其配置和使用方法。</p>
<p><strong>核心要点:</strong></p>
<ol>
<li><strong>分片键选择</strong> - 选择高频查询字段作为分片键</li>
<li><strong>分片算法</strong> - 使用INLINE算法,配置简单,性能优秀</li>
<li><strong>绑定表</strong> - 使用绑定表避免跨库JOIN</li>
<li><strong>主键生成</strong> - 使用Snowflake算法保证唯一性</li>
<li><strong>避免全路由</strong> - 查询语句最好包含分片键</li>
</ol>
<p><strong>最佳实践:</strong></p>
<ol>
<li>优先使用INLINE算法,性能好</li>
<li>避免全路由查询,性能差</li>
<li>使用绑定表,避免跨库操作</li>
<li>配置合理的连接池大小</li>
<li>生产环境关闭sql-show</li>
<li>定期备份,防止数据丢失</li>
</ol>
<p><strong>参考资料:</strong></p>
<ul>
<li>ShardingSphere官方文档: <a href="https://link.juejin.cn?target=https%3A%2F%2Fshardingsphere.apache.org%2F" target="_blank" title="https://shardingsphere.apache.org/" ref="nofollow noopener noreferrer">shardingsphere.apache.org/</a></li>
<li>ShardingSphere GitHub: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fapache%2Fshardingsphere" target="_blank" title="https://github.com/apache/shardingsphere" ref="nofollow noopener noreferrer">github.com/apache/shar…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大数据-202 sklearn 决策树实战：criterion、Graphviz 可视化与剪枝防过拟合]]></title>    <link>https://juejin.cn/post/7590957076630634542</link>    <guid>https://juejin.cn/post/7590957076630634542</guid>    <pubDate>2026-01-04T01:46:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590957076630634542" data-draft-id="7590849961727655963" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大数据-202 sklearn 决策树实战：criterion、Graphviz 可视化与剪枝防过拟合"/> <meta itemprop="keywords" content="后端,大数据,机器学习"/> <meta itemprop="datePublished" content="2026-01-04T01:46:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武子康"/> <meta itemprop="url" content="https://juejin.cn/user/149189314230039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大数据-202 sklearn 决策树实战：criterion、Graphviz 可视化与剪枝防过拟合
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189314230039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武子康
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T01:46:35.000Z" title="Sun Jan 04 2026 01:46:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TL;DR</h2>
<ul>
<li>场景：用 sklearn 在 Wine 数据集上训练 DecisionTreeClassifier，并用 Graphviz 导出可视化</li>
<li>结论：criterion 影响分裂度量（gini/entropy/log_loss），random_state 与 splitter 决定稳定性与随机性；剪枝靠 max_depth/min_samples_leaf/ccp_alpha</li>
<li>产出：可复现实验流程 + export_graphviz 参数要点 + 环境版本矩阵 + 常见报错定位表</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1a497d33a634769af93d49f2a219467~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=ccoxLVQotg6Js%2F9memyJJ0yNIv8%3D" alt="大数据-202 sklearn 决策树实战：criterion、Graphviz 可视化与剪枝防过拟合" loading="lazy"/></p>
<h2 data-id="heading-1">版本矩阵</h2>





















<table><thead><tr><th>组件</th><th>已验证说明</th></tr></thead><tbody><tr><td>scikit-learn 1.8.0</td><td>PyPI 声明2025-12-10 发布；Requires: Python&gt;=3.11；DecisionTreeClassifier 的 criterion 支持 gini/entropy/log_loss <a href="https://link.juejin.cn?target=https%3A%2F%2Fscikit-learn.org%2Fstable%2Fmodules%2Fgenerated%2Fsklearn.tree.DecisionTreeClassifier.html" target="_blank" title="https://scikit-learn.org/stable/modules/generated/sklearn.tree.DecisionTreeClassifier.html" ref="nofollow noopener noreferrer">DecisionTreeClassifier API官方文档</a>；splitter 支持 best/random；criterion 见上 <a href="https://link.juejin.cn?target=https%3A%2F%2Fscikit-learn.org%2Fstable%2Fmodules%2Fgenerated%2Fsklearn.tree.export_graphviz.html" target="_blank" title="https://scikit-learn.org/stable/modules/generated/sklearn.tree.export_graphviz.html" ref="nofollow noopener noreferrer">export_graphviz官方文档</a> 导出 DOT；配合 dot 命令可生成 PNG/SVG 等</td></tr><tr><td>python-graphviz 0.21</td><td>PyPI 声明Requires: Python&gt;=3.9；渲染仍依赖系统 Graphviz（dot）与 PATH</td></tr><tr><td>系统 Graphviz（dot）</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgraphviz.org%2F" target="_blank" title="https://graphviz.org/" ref="nofollow noopener noreferrer">官方站点</a>需单独安装（Windows/macOS/Linux 方式不同）</td></tr></tbody></table>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a3faf0f5190427892ebb8a183e2ef78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=vGI%2F6Re1A6uwODN55fXCoNXpMPc%3D" alt="大数据-202 sklearn 决策树实战：criterion、Graphviz 可视化与剪枝防过拟合" loading="lazy"/></p>
<h2 data-id="heading-2">使用sklearn实现决策树</h2>
<h3 data-id="heading-3">参数CRITERION</h3>
<p>criterion 这个参数使用来决定不纯度的计算方法，sklearn提供了两种选择：</p>
<ul>
<li>输入 entropy，使用信息熵（Entropy）</li>
<li>输入 gini，使用基尼系数（Gini Impurity）</li>
</ul>
<p>在机器学习中，基尼系数和信息熵都是常用的不纯度度量指标，用于决策树等算法的特征选择和节点划分。两者虽然计算方式和敏感性不同，但在实际应用中往往能达到相似的效果。</p>
<p>信息熵的计算公式为：H(X)=-Σp(x)log₂p(x)，其中p(x)是某个类别的概率。由于涉及对数运算，其计算复杂度比基尼系数要高。相比之下，基尼系数的计算公式Gini=1-Σp(x)²更加简单直接，不需要对数运算，因此计算速度更快。</p>
<p>具体来说，信息熵对数据不纯度的惩罚更强。例如：</p>
<ul>
<li>当某个节点中两个类别的样本比例为7:3时：
<ul>
<li>基尼系数=1-(0.7²+0.3²)=0.42</li>
<li>信息熵=-(0.7<em>log₂0.7+0.3</em>log₂0.3)≈0.88</li>
</ul>
</li>
<li>当比例变为8:2时：
<ul>
<li>基尼系数=0.32</li>
<li>信息熵≈0.72</li>
</ul>
</li>
</ul>
<p>这种敏感性差异导致：</p>
<ol>
<li>在高维数据场景下（如特征数超过1000），信息熵容易产生过拟合，因为它会倾向于选择更细粒度的划分方式。此时基尼系数表现更稳健。</li>
<li>在噪声数据较多时（如标签错误率超过10%），基尼系数的抗干扰能力更强。</li>
<li>当模型欠拟合时（训练集和测试集准确率都低于60%），使用信息熵可能获得更好的效果，因为它能驱动模型学习更精细的决策边界。</li>
</ol>
<p>实际应用建议：</p>
<ul>
<li>对于结构化数据（如表格数据），可以优先尝试基尼系数</li>
<li>在计算资源受限的实时系统中，基尼系数是更好的选择</li>
<li>当数据质量较高且维度适中时（如UCI数据集），可以比较两种指标的效果</li>
<li>在集成学习中（如随机森林），两种指标的差异通常会被弱化</li>
</ul>
<p>需要注意的是，这些规律并非绝对。在实践中，最好的方式是通过交叉验证来比较两种指标在特定数据集上的表现。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c877d721cc34e0aaee7244d9fb7bb7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=i%2BVS3AWfS4ubVO5WK4DrUUA8r84%3D" alt="sklearn实现决策树" loading="lazy"/></p>
<h2 data-id="heading-4">初步建模</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 导入需要的算法库和模块</span>
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
%matplotlib inline
<span class="hljs-keyword">from</span> sklearn <span class="hljs-keyword">import</span> tree
<span class="hljs-keyword">from</span> sklearn.datasets <span class="hljs-keyword">import</span> load_wine
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split
plt.rcParams[<span class="hljs-string">'font.sans-serif'</span>]=[<span class="hljs-string">'Simhei'</span>]
plt.rcParams[<span class="hljs-string">'axes.unicode_minus'</span>]=<span class="hljs-literal">False</span>
</code></pre>
<p>加载数据</p>
<pre><code class="hljs language-python" lang="python">wine = load_wine()
wine.data.shape
wine.target
</code></pre>
<p>执行结果如下所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/381e98d5f85e435aac734029558a64c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=%2FoHbEPMLI1qmWJWEbwmeSyRmXsA%3D" alt="sklearn实现决策树" loading="lazy"/>
如果是 wine 是一张表，应该长这样：</p>
<pre><code class="hljs language-python" lang="python">wine_pd=pd.concat([pd.DataFrame(wine.data),pd.DataFrame(wine.target)],axis=<span class="hljs-number">1</span>).head()
wine.feature_names.append(<span class="hljs-string">"result"</span>)
wine_pd.columns=wine.feature_names
wine_pd
</code></pre>
<p>执行结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/726d5daf9e8e48619a44ece8002a8551~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=q%2Fv0oSP1OqMOHpSWi4vwy1iA1QI%3D" alt="sklearn实现决策树" loading="lazy"/>
编写代码查看形状：</p>
<pre><code class="hljs language-python" lang="python">Xtrain, Xtest, Ytrain, ytest = train_test_split(wine.data,wine.target,test_size=<span class="hljs-number">0.3</span>,random_state=<span class="hljs-number">420</span>)
<span class="hljs-built_in">print</span>(Xtrain.shape)
<span class="hljs-built_in">print</span>(Xtest.shape)
</code></pre>
<p>执行结果如下所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbe0eecd47b84fe3b71973d6721d2bde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=ULqI3sMUG%2BXt1kZ6IX6%2BayP49BU%3D" alt="sklearn实现决策树" loading="lazy"/></p>
<h2 data-id="heading-5">建立模型</h2>
<pre><code class="hljs language-python" lang="python">clf = tree.DecisionTreeClassifier(criterion=<span class="hljs-string">"gini"</span>)
clf = clf.fit(Xtrain, Ytrain)
clf.score(Xtest, ytest) <span class="hljs-comment">#返回预测的准确度</span>
</code></pre>
<p>执行结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d78a27b69c24cc3a66fa96ed1424531~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=6ViGovnqiqD5Gisp%2F39EMjWvsK8%3D" alt="sklearn实现决策树 建立模型" loading="lazy"/></p>
<h2 data-id="heading-6">画决策树</h2>
<p>我们可以利用 Graphviz 模块导出决策树模型，第一次使用 Graphviz 之前需要进行安装，若是使用从 pip 安装：</p>
<pre><code class="hljs language-shell" lang="shell">!pip install graphviz
</code></pre>
<p>执行结果如下所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27cc0283bf334b5e90b3fdbca0f8db27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=WNkLu32Qw3DcpN%2Fgc90IqOW%2BJKM%3D" alt="决策树" loading="lazy"/>
对图案进行绘制：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">import</span> graphviz
<span class="hljs-keyword">from</span> sklearn <span class="hljs-keyword">import</span> tree


feature_name = [<span class="hljs-string">'酒精'</span>,<span class="hljs-string">'苹果酸'</span>,<span class="hljs-string">'灰'</span>,<span class="hljs-string">'灰的碱性'</span>,<span class="hljs-string">'镁'</span>,<span class="hljs-string">'总酚'</span>,<span class="hljs-string">'类黄酮'</span>,<span class="hljs-string">'非黄烷类酚类'</span>,<span class="hljs-string">'花青素'</span>,<span class="hljs-string">'颜色强度'</span>,<span class="hljs-string">'色调'</span>,<span class="hljs-string">'od280/od315 稀释葡萄酒'</span>,<span class="hljs-string">'脯氨酸'</span>]
dot_data = tree.export_graphviz(clf, out_file = <span class="hljs-literal">None</span>, feature_names= feature_name, class_names=[<span class="hljs-string">"琴酒"</span>,<span class="hljs-string">"雪莉"</span>,<span class="hljs-string">"贝尔摩德"</span>], filled=<span class="hljs-literal">True</span>, rounded=<span class="hljs-literal">True</span>)
graph = graphviz.Source(dot_data)
graph
</code></pre>
<p>执行结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d15822b692f4e93a0208ea0718c2d58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=ArBePPfg%2Fa%2FeW6NQ3x5s2lazNE0%3D" alt="sklearn实现决策树" loading="lazy"/>
绘制的图片如下所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a0fec3f96bf4c54a0c17a5393f0753e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=TtfY6gv7uQS86OUzlJL8d81SB5w%3D" alt="sklearn实现决策树 绘制" loading="lazy"/></p>
<p>export_graphviz 生成了一个 DOT 格式的决策树：</p>
<ul>
<li>feature_names：每个属性的名字</li>
<li>class_names：每个因变量类别的名字</li>
<li>label：是否显示不纯度信息的标签，默认为 all 表都显示，可以是root或 none</li>
<li>filled：是否给每个节点的主分类绘制不同的颜色，默认为 False</li>
<li>out_file：输出的 dot 文件的名字，默认为 None表示不输出文件，可以是自定义名字如“tree.dot”</li>
<li>rounded：默认为 True，表示对每个节点的边框加圆角，使用 Helvetica 字体</li>
</ul>
<h2 data-id="heading-7">防止过拟合</h2>
<p>在不加限制的情况下，一颗决策树会持续生长直到满足以下任一条件：</p>
<ol>
<li>所有叶节点的基尼系数（Gini impurity）或信息熵（information entropy）等不纯度指标达到最优（通常为0）</li>
<li>没有更多的特征可用于进一步分割数据</li>
<li>每个叶节点仅包含单一类别的样本</li>
</ol>
<p>这种不加限制的生长方式往往会导致严重的过拟合问题。具体表现为：</p>
<ul>
<li>在训练集上可能达到100%的准确率</li>
<li>但在测试集上表现显著下降（如准确率骤降20-30个百分点）</li>
</ul>
<p>造成这种现象的根本原因在于：</p>
<ol>
<li>样本偏差问题：我们收集的训练数据不可能完全代表整体数据分布，总会存在抽样偏差</li>
<li>噪声敏感问题：当决策树过度生长时：
<ul>
<li>会捕捉到训练数据中的随机噪声（如5%的错误标注样本）</li>
<li>为这些噪声创建特定的分裂规则（例如"当特征X=3.14159时预测类别A"）</li>
<li>导致模型泛化能力下降</li>
</ul>
</li>
</ol>
<p>典型示例：
在房价预测任务中，一棵过拟合的决策树可能会：</p>
<ul>
<li>为训练集中某个异常低价样本（如输入错误的$1元房价）创建特殊分支</li>
<li>在实际预测时，遇到类似特征组合的房屋就会错误预测极低价格</li>
</ul>
<p>解决方法通常包括：</p>
<ol>
<li>预剪枝（Pre-pruning）：
<ul>
<li>设置最大深度（如max_depth=5）</li>
<li>设置叶节点最小样本数（如min_samples_leaf=10）</li>
</ul>
</li>
<li>后剪枝（Post-pruning）：
<ul>
<li>使用代价复杂度剪枝（CCP）</li>
<li>基于验证集性能进行剪枝</li>
</ul>
</li>
<li>集成方法：
<ul>
<li>随机森林（通过多棵树投票降低过拟合风险）</li>
<li>梯度提升树（通过迭代优化减少单棵树的影响）</li>
</ul>
</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">#我们的树对训练集的拟合程度如何?</span>
score_train = clf.score(Xtrain, Ytrain)
score_train
</code></pre>
<p>执行结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ac58d4df39d49f8be14ef1785a1437f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=c%2BU0GuDSw9lqiYpvNdkMgP%2BRPcY%3D" alt="sklearn实现决策树 防止过拟合" loading="lazy"/>
为了让决策树有更好的泛化性，我们要对决策树进行剪枝。剪枝策略对决策树的影响巨大，正确的剪枝策略是优化决策树算法的核心。</p>
<h2 data-id="heading-8">random_state</h2>
<p>如果我们改动了 random_state，画出来的每一颗树都不一样，它为什么不稳定呢？如果使用其他数据集，它还会不稳定吗？
我们之前提过，无论决策树模型如何进化，在分支上的本质都还是追求某个不纯度相关的指标的优化，而正如我们提到的，不纯度是基于节点计算出来的，也就是说，决策树在建树时，是靠优化节点来追求一棵优化的树，但是最优的节点是能够保证最优的树吗？</p>
<p>集成算法被用来解决这个问题：sklearn 表示，既然一棵树不能保证最优，那就建更多不同的树，然后从中取最好的。怎么样从一组数据集中建不同的树呢？在每次分支的时候，不使用全部特征，而是随机选取一部分特征，从中选取不纯度相关指标最优的作为分支用的节点。
这样，每次生成的树叶不同了。</p>
<p>random_state 用来设置分支中的随机模型的参数，默认是 None，在高维度时随机性会表现更明显，低维度的数据随机性几乎不会显现。输入任意整数，会一直长出同一棵树，让模型稳定下来。</p>
<h2 data-id="heading-9">splitter</h2>
<p>splitter 也是用来控制决策树中随机选项的，有两种输入值：</p>
<ul>
<li>输入 best，决策树在分支时虽然随机，但是还是会优先选择更重要的特征进行分支（重要性可以通过属性 feature_importance 查看）</li>
<li>输入 random，决策树在分支时会更加随机，树会因为含有更多的不必要的信息而更深更大，并因为这些不必要信息而降低对训练集的拟合。这也是一种防止过拟合的方式。</li>
</ul>
<p>当你预测到你的模型会过拟合，用这两个参数来帮助你降低树建成之后的过拟合的可能性，当然，树一旦建成，我们依然是使用剪枝参数来防止拟合的。</p>
<pre><code class="hljs language-python" lang="python">clf = tree.DecisionTreeClassifier(criterion=<span class="hljs-string">"entropy"</span>,random_state=<span class="hljs-number">30</span>,splitter=<span class="hljs-string">"random"</span>)
clf = clf.fit(Xtrain, Ytrain)
score = clf.score(Xtest, ytest)
<span class="hljs-built_in">print</span>(score)
plt.rcParams[<span class="hljs-string">'font.sans-serif'</span>]=[<span class="hljs-string">'Simhei'</span>]
plt.rcParams[<span class="hljs-string">'axes.unicode_minus'</span>]=<span class="hljs-literal">False</span>
</code></pre>
<p>代码的执行结果如下所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31afe0d1e2194e20ae71bd34bee833d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=rBzxInKP0xM75G1VUXKTds8dEA0%3D" alt="sklearn实现决策树 决策树分支" loading="lazy"/></p>
<h2 data-id="heading-10">版本矩阵</h2>


















































<table><thead><tr><th>症状</th><th>根因定位</th><th>修复</th></tr></thead><tbody><tr><td>ModuleNotFoundError: No module named 'graphviz'</td><td>未安装 python-graphviz 包</td><td><code>python -c "import graphviz"</code><br/><code>pip install graphviz</code></td></tr><tr><td>ExecutableNotFound: failed to execute 'dot' / 渲染为空</td><td>只装了 python 包，未装系统 Graphviz 或 PATH 未配</td><td><code>dot -V</code> 是否可用<br/>安装系统 Graphviz，并把 dot 所在目录加入 PATH</td></tr><tr><td>ValueError: Length of feature_names ...</td><td>feature_names 数量与 X 特征列不一致</td><td>对比 Xtrain.shape[1] 与 len(feature_name)<br/>统一特征数；Wine 为 13 维时 feature_names 也应为 13</td></tr><tr><td>图里类别名/计数顺序不对</td><td>class_names 顺序与内部类别编码不一致</td><td>查看 tree 图首节点 value=[...] 顺序<br/>class_names 按类别编码升序传入（如 0/1/2 对应的名称顺序）</td></tr><tr><td>NameError: name 'Ytrain' is not defined</td><td>变量名大小写不一致/拷贝时漏段</td><td>搜索 Ytrain/ytrain<br/>统一命名（训练/测试标签用同一风格）</td></tr><tr><td>SyntaxError 出现在 %matplotlib inline</td><td>该语法仅适用于 Jupyter</td><td>运行环境是 .py / IDE 脚本<br/>脚本环境移除该魔法命令</td></tr><tr><td>训练集 1.0、测试集明显下降</td><td>树无约束生长导致过拟合</td><td>对比 clf.score(Xtrain, Ytrain) vs clf.score(Xtest, ytest)<br/>加 max_depth/min_samples_leaf/min_samples_split，或用 ccp_alpha 做后剪枝</td></tr><tr><td>InvalidParameterError: The 'criterion' parameter ...</td><td>sklearn 版本差异或参数拼写</td><td>sklearn.<strong>version</strong>；检查 criterion 值<br/>用官方支持值；新版本支持 gini/entropy/log_loss</td></tr></tbody></table>
<h2 data-id="heading-11">其他系列</h2>
<h3 data-id="heading-12">🚀 AI篇持续更新中（长期更新）</h3>
<p><strong>AI炼丹日志-29 - 字节跳动 DeerFlow 深度研究框<em>斜体样式</em>架 私有部署 测试上手 架构研究</strong>，持续打造实用AI工具指南！
<strong>AI研究-132 Java 生态前沿 2025：Spring、Quarkus、GraalVM、CRaC 与云原生落地</strong></p>
<h3 data-id="heading-13">💻 Java篇持续更新中（长期更新）</h3>
<p><strong>Java-218 RocketMQ Java API 实战：同步/异步 Producer 与 Pull/Push Consumer</strong>
MyBatis 已完结，Spring 已完结，Nginx已完结，Tomcat已完结，分布式服务已完结，Dubbo已完结，MySQL已完结，MongoDB已完结，Neo4j已完结，FastDFS 已完结，OSS已完结，GuavaCache已完结，EVCache已完结，RabbitMQ已完结，RocketMQ正在更新... 深入浅出助你打牢基础！</p>
<h3 data-id="heading-14">📊 大数据板块已完成多项干货更新（300篇）：</h3>
<p>包括 Hadoop、Hive、Kafka、Flink、ClickHouse、Elasticsearch 等二十余项核心组件，覆盖离线+实时数仓全栈！
<strong>大数据-278 Spark MLib - 基础介绍 机器学习算法 梯度提升树 GBDT案例 详解</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[useEffect详解]]></title>    <link>https://juejin.cn/post/7590303618429173795</link>    <guid>https://juejin.cn/post/7590303618429173795</guid>    <pubDate>2026-01-03T12:42:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590303618429173795" data-draft-id="7590433626560151587" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="useEffect详解"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-03T12:42:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="写代码的皮筏艇"/> <meta itemprop="url" content="https://juejin.cn/user/4196178024218520"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            useEffect详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4196178024218520/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    写代码的皮筏艇
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T12:42:55.000Z" title="Sat Jan 03 2026 12:42:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">React 中 useEffect 详解</h3>
<p><code>useEffect</code> 是 React Hooks 中用于处理<strong>副作用</strong>的核心 Hook，它替代了类组件中的生命周期方法（<code>componentDidMount</code>、<code>componentDidUpdate</code>、<code>componentWillUnmount</code>），让函数组件能够执行异步操作、修改 DOM、订阅事件、清理资源等副作用逻辑。而且现在函数组件才是主流，类组件多是一些老项目</p>
<h3 data-id="heading-1">一、核心概念：什么是 “副作用”？</h3>
<p>副作用（Side Effect）是指函数执行过程中，除了返回值之外对外部环境产生的影响，常见场景：</p>
<ul>
<li>数据请求（AJAX/fetch）</li>
<li>DOM 操作（修改样式、添加事件监听）</li>
<li>订阅 / 取消订阅（如 WebSocket、定时器）</li>
<li>本地存储（localStorage/sessionStorage）</li>
<li>手动修改 state（需谨慎）</li>
</ul>
<h3 data-id="heading-2">二、基本语法</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Component</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 基础用法</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 副作用逻辑（执行时机：组件挂载/更新后）</span>
    
    <span class="hljs-comment">// 可选：清理函数（执行时机：组件卸载/下一次副作用执行前）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 清理逻辑（如取消订阅、清除定时器）</span>
    };
  }, [依赖项数组]); <span class="hljs-comment">// 关键：依赖项决定副作用的执行时机</span>
}
</code></pre>
<h4 data-id="heading-3">语法拆解：</h4>
<ol>
<li>
<p><strong>第一个参数（必选）</strong> ：副作用函数</p>
<ul>
<li>可以是普通函数，执行核心的副作用逻辑；</li>
<li>可选返回一个<strong>清理函数</strong>（Cleanup Function），用于清除副作用（如取消定时器、解绑事件）。</li>
</ul>
</li>
<li>
<p><strong>第二个参数（可选）</strong> ：依赖项数组</p>
<ul>
<li>控制副作用的执行时机；</li>
<li>若省略：组件<strong>每次渲染后</strong>都会执行副作用；</li>
<li>若为空数组 <code>[]</code>：仅在组件<strong>挂载（mount）</strong>  时执行一次，清理函数在组件<strong>卸载（unmount）</strong>  时执行；</li>
<li>若包含依赖项（如 <code>[count, data]</code>）：仅在依赖项的值<strong>发生变化</strong>时执行副作用（挂载时执行第一次，后续仅依赖项变化触发）。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-4">三、执行时机</h3>
<p><code>useEffect</code> 的执行时机是<strong>组件渲染完成后</strong>（浏览器绘制 DOM 之后），属于异步执行，不会阻塞浏览器的渲染，这一点与类组件的 <code>componentDidMount</code>/<code>componentDidUpdate</code> 一致。</p>
<h4 data-id="heading-5">不同依赖项的执行行为对比：</h4>






























<table><thead><tr><th>依赖项写法</th><th>执行时机</th><th>对应类组件生命周期</th></tr></thead><tbody><tr><td>无依赖项</td><td>每次组件渲染后（挂载 + 每次更新）</td><td>componentDidMount + componentDidUpdate</td></tr><tr><td>空数组 <code>[]</code></td><td>仅挂载时执行一次</td><td>componentDidMount</td></tr><tr><td>含依赖项 <code>[a, b]</code></td><td>挂载时执行 + 依赖项 a/b 变化时执行</td><td>自定义 componentDidUpdate</td></tr><tr><td>清理函数</td><td>卸载时执行 + 下一次副作用执行前执行</td><td>componentWillUnmount</td></tr></tbody></table>
<h3 data-id="heading-6">四、常见使用场景</h3>
<h4 data-id="heading-7">场景 1：仅挂载时执行（初始化）</h4>
<p>比如请求初始数据、添加全局事件监听：</p>
<pre><code class="hljs language-ini" lang="ini">import { useEffect, useState } from 'react'<span class="hljs-comment">;</span>

function UserList() {
  const <span class="hljs-section">[users, setUsers]</span> = useState(<span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>

  // 仅挂载时请求数据（对应 componentDidMount）
  useEffect(() =&gt; {
    const <span class="hljs-attr">fetchUsers</span> = async () =&gt; {
      const <span class="hljs-attr">res</span> = await fetch(<span class="hljs-string">'https://api.example.com/users'</span>)<span class="hljs-comment">;</span>
      const <span class="hljs-attr">data</span> = await res.json()<span class="hljs-comment">;</span>
      setUsers(data)<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>
    fetchUsers()<span class="hljs-comment">;</span>
  }, <span class="hljs-section">[]</span>)<span class="hljs-comment">; // 空依赖：仅执行一次</span>

  return (
    &lt;ul&gt;
      {users.map(<span class="hljs-attr">user</span> =&gt; (
        &lt;li <span class="hljs-attr">key</span>={user.id}&gt;{user.name}&lt;/li&gt;
      ))}
    &lt;/ul&gt;
  )<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-8">场景 2：依赖项变化时执行</h4>
<p>比如根据输入关键词筛选数据、监听状态变化：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Search</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [keyword, setKeyword] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">const</span> [result, setResult] = <span class="hljs-title function_">useState</span>([]);

  <span class="hljs-comment">// 关键词变化时请求数据</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!keyword) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 无关键词时不请求</span>

    <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`https://api.example.com/search?kw=<span class="hljs-subst">${keyword}</span>`</span>);
      <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>();
      <span class="hljs-title function_">setResult</span>(data);
    }, <span class="hljs-number">300</span>); <span class="hljs-comment">// 防抖：300ms 后请求</span>

    <span class="hljs-comment">// 清理函数：取消定时器（关键词快速变化时避免无效请求）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearTimeout</span>(timer);
  }, [keyword]); <span class="hljs-comment">// 依赖：仅 keyword 变化时执行</span>

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{keyword}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setKeyword(e.target.value)} /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>{result.map(item =&gt; <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span>&gt;</span>{item.name}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>)}<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-9">场景 3：清理副作用（卸载时）</h4>
<p>比如清除定时器、取消 WebSocket 订阅、解绑事件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Timer</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 挂载时启动定时器</span>
    <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>);
    }, <span class="hljs-number">1000</span>);

    <span class="hljs-comment">// 清理函数：卸载时清除定时器（避免内存泄漏）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(timer);
  }, []); <span class="hljs-comment">// 仅挂载时执行</span>

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Count: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}

<span class="hljs-comment">// 父组件控制 Timer 的挂载/卸载</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [show, setShow] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setShow(!show)}&gt;Toggle Timer<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      {show &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">Timer</span> /&gt;</span>}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-10">五、关键注意事项</h3>
<h4 data-id="heading-11">1. 依赖项必须完整</h4>
<p>React 会根据依赖项数组的<strong>浅比较</strong>判断是否执行副作用，若依赖项缺失：</p>
<ul>
<li>副作用可能无法触发（依赖项变化但未声明）；</li>
<li>或捕获到过时的 state/prop（闭包陷阱）。</li>
</ul>
<p><strong>反例（错误）</strong> ：</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">BadExample</span>() {
  const <span class="hljs-selector-attr">[count, setCount]</span> = <span class="hljs-built_in">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-built_in">useEffect</span>(() =&gt; {
    <span class="hljs-comment">// 依赖 count，但未声明在数组中</span>
    const timer = <span class="hljs-built_in">setInterval</span>(() =&gt; {
      console<span class="hljs-selector-class">.log</span>(count); <span class="hljs-comment">// 始终打印 0（闭包捕获初始值）</span>
    }, <span class="hljs-number">1000</span>);
    return () =&gt; <span class="hljs-built_in">clearInterval</span>(timer);
  }, <span class="hljs-selector-attr">[]</span>); <span class="hljs-comment">// 错误：缺失 count 依赖</span>

  return &lt;<span class="hljs-selector-tag">button</span> onClick={() =&gt; <span class="hljs-built_in">setCount</span>(count + <span class="hljs-number">1</span>)}&gt;Click&lt;/<span class="hljs-selector-tag">button</span>&gt;;
}
</code></pre>
<p><strong>正例（正确）</strong> ：</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">GoodExample</span>() {
  const <span class="hljs-selector-attr">[count, setCount]</span> = <span class="hljs-built_in">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-built_in">useEffect</span>(() =&gt; {
    const timer = <span class="hljs-built_in">setInterval</span>(() =&gt; {
      console<span class="hljs-selector-class">.log</span>(count); <span class="hljs-comment">// 正确打印最新 count</span>
    }, <span class="hljs-number">1000</span>);
    return () =&gt; <span class="hljs-built_in">clearInterval</span>(timer);
  }, <span class="hljs-selector-attr">[count]</span>); <span class="hljs-comment">// 声明依赖 count</span>

  return &lt;<span class="hljs-selector-tag">button</span> onClick={() =&gt; <span class="hljs-built_in">setCount</span>(count + <span class="hljs-number">1</span>)}&gt;Click&lt;/<span class="hljs-selector-tag">button</span>&gt;;
}
</code></pre>
<h4 data-id="heading-12">2. 副作用函数不能是 async 函数</h4>
<p><code>useEffect</code> 的第一个参数若返回清理函数，则不能直接用 <code>async</code>（因为 <code>async</code> 函数返回 Promise，而非清理函数）。</p>
<p><strong>反例（错误）</strong> ：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(async () =&gt; {
  const res = await <span class="hljs-built_in">fetch</span>('/api/data');
  <span class="hljs-comment">// ...</span>
}, <span class="hljs-selector-attr">[]</span>); <span class="hljs-comment">// 错误：async 函数返回 Promise，无法返回清理函数</span>
</code></pre>
<p><strong>正例（正确）</strong> ：</p>
<pre><code class="hljs language-ini" lang="ini">useEffect(() =&gt; {
  // 内部定义 async 函数
  const <span class="hljs-attr">fetchData</span> = async () =&gt; {
    const <span class="hljs-attr">res</span> = await fetch(<span class="hljs-string">'/api/data'</span>)<span class="hljs-comment">;</span>
    // ...
  }<span class="hljs-comment">;</span>
  fetchData()<span class="hljs-comment">;</span>
}, <span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-13">3. 避免无限循环</h4>
<p>若副作用中修改了依赖项，且依赖项未正确控制，会导致无限执行：</p>
<p><strong>反例（错误）</strong> ：</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">LoopExample</span>() {
  const <span class="hljs-selector-attr">[data, setData]</span> = <span class="hljs-built_in">useState</span>({});

  <span class="hljs-built_in">useEffect</span>(() =&gt; {
    <span class="hljs-comment">// 每次渲染都会创建新对象，依赖项浅比较为 false，触发无限执行</span>
    <span class="hljs-built_in">setData</span>({ name: 'test' });
  }, <span class="hljs-selector-attr">[data]</span>); <span class="hljs-comment">// 依赖 data，但修改了 data</span>

  return &lt;<span class="hljs-selector-tag">div</span>&gt;{data<span class="hljs-selector-class">.name</span>}&lt;/<span class="hljs-selector-tag">div</span>&gt;;
}
</code></pre>
<p><strong>解决方法</strong>：</p>
<ul>
<li>避免修改依赖项，或调整依赖项（如仅依赖必要字段）；</li>
<li>若必须修改，可使用函数式更新（<code>setData(prev =&gt; ({ ...prev, name: 'test' }))</code>）。</li>
</ul>
<h4 data-id="heading-14">4. 清理函数的执行时机</h4>
<p>清理函数不仅在组件卸载时执行，还会在<strong>下一次副作用执行前</strong>执行（比如依赖项变化时），用于清除上一次的副作用残留。</p>
<h3 data-id="heading-15">六、与类组件生命周期的对比</h3>

























<table><thead><tr><th>类组件生命周期</th><th>useEffect 实现方式</th></tr></thead><tbody><tr><td>componentDidMount</td><td><code>useEffect(() =&gt; { ... }, [])</code></td></tr><tr><td>componentDidUpdate</td><td><code>useEffect(() =&gt; { ... }, [dep1, dep2])</code></td></tr><tr><td>componentWillUnmount</td><td><code>useEffect(() =&gt; { return () =&gt; { ... } }, [])</code></td></tr><tr><td>合并三者</td><td><code>useEffect(() =&gt; { ... })</code>（无依赖项）</td></tr></tbody></table>
<h3 data-id="heading-16">总结</h3>
<p><code>useEffect</code> 的核心是<strong>声明式</strong>地处理副作用：</p>
<ol>
<li>通过依赖项数组控制执行时机，替代类组件的多个生命周期；</li>
<li>清理函数用于消除副作用的副作用（避免内存泄漏）；</li>
<li>依赖项必须完整且准确，避免闭包陷阱和无限循环；</li>
<li>异步逻辑需在副作用函数内部定义 <code>async</code> 函数，而非直接返回 Promise。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[吃透 npm、pnpm、npx：区别与实战用法全解析]]></title>    <link>https://juejin.cn/post/7590421489998168083</link>    <guid>https://juejin.cn/post/7590421489998168083</guid>    <pubDate>2026-01-03T13:03:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590421489998168083" data-draft-id="7590159073988804660" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="吃透 npm、pnpm、npx：区别与实战用法全解析"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-03T13:03:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Maxkim"/> <meta itemprop="url" content="https://juejin.cn/user/2768993424260451"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            吃透 npm、pnpm、npx：区别与实战用法全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2768993424260451/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Maxkim
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T13:03:10.000Z" title="Sat Jan 03 2026 13:03:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAABWVJREFUWAnlVktsVFUY/s85997pC9BOTKxRWnEKsXWlxjWJj0RWJjrFAAXjAlewYWOkgauACVu7a2IiNUEyExM3yoZE3Wmi7qgPJthJBDE6JUNpO3Mf5/j95/bOTOcBlBgXejJ37rn/Of/7O/9/iP7vQ/zTAcjnC4ry+a5ii1OkiYTpuvjvEc0Gp51uivP+ZW+QBuSW4QjW5rptAa1Ey0uOGKOxwPetVyafN6p/52/PkNBbjdAhGaGEpMRjLZTryB8+9MUSYSGNRIcBvm8kBAY9tHYlHz78nTs392xIkwv9FA3Oe33bdoX1ZZKOS0bH0CXI6RugYLW6BwIu5gskkQ4sEG0wYF25PjBzbZfSYY6kDLUmWMt7FR7Lw3xYUkaTdjxHfTPnPwav0iEGYADVa9XIRIEyxrAA0jIQxgFL22gYwF7A8/DAzNVdksJvJaTEUZ2kYnZWziN5s1ADPHneEIXByotYuMSrf9JEbbsuv7VcvbaKML8plXtQR0EdIYDqWEmtOgAomZFH8EjWSnek2ulmtljljttHbmaIHCCCHzd9MjwfsmscBeZH9Jyd10nMvz92UQrtCBKvMF06mQy0SiEdRMEGg8mN0YjAlgoDDkPrMI5qJKSkKKydpbB2CZjJkhIBvOBw2CGQgii85bpx//dMqFRKam5uvH7w+K97oe+Cl0HO68uIBH0qyEzpOMwIbZIcFq0I+9cwoElizCjk2KFI1y7Nnx614W1db58fOXIlMzs7Xn/jeDmvBV2Q0mXjGf554O/m4LZHp2N8r61WPMvLZWLdiC4GMAk5BjeeB5lhv39l6+BIbu3m760hXMDKBD08XBKzR8fr04nygnIypOOAJUx/fHrsi0Mnys+vVK+V4VUohaiyPCo2Q9DFALvF/ikw8WS4QvVZALS5ksw47/7R8ejgTPk1UFqU6/3zp8bOM7B/kdu/fkguPGU5JibW+F0sTjWOUw8DklRrg4BiLGeBqbaRLxjlT4no0InFV402RcftJz41cH/f/JnHP3kZaaF6VX/liwist9vYG5+NU9Cg3MNkt/+lU5wS8fTxq3mc7ILjDlAE4CJpe89BOWPiIjBhi9O6PI4G1jsc6RGB3lZwmS76k8H0zOKTkFboG8jS2krFKCX2fvTeaPHIBwAkMHHgncURnL3nuCSnxSopdIzN5th0BIonJ0Lf9yUA9iMkzdRWl3BixOusfDcwQVcS4UKIFwYfGPnM8wY/DyP9NFMXaTE5BU39tGkDgGZz+fJJG0oYcSaOafLcqdECY4LzfSObSzyUOgxqtyisr8SSNOOAkubWoh3TTaeA2YtFEXPnm5x81/j+6MI6JqyS25WSNU6hbCMKHG84marJbdR+vwakRhQLRuQpbzHRLjmpmijI+OmWCtq+LzWtnX5v30gHSsqmWne74DtiACi2+Wz0iXbuLt9D2cDyoPEkWOiyp5XUIwLMi/wJY1FbH5B9ONtdC1KrsD/Q0MCQAS0wccILORDW25amAeOtooAj/KQxfzF17uwTSQ1v3dJ7jnLINwdZYRDa4tPU0sHVXFo/vxFF5BqFqxRfOmgPCk4ft2NgKTCy2Y47JIEg+MIhjYsLy5I25qUYTQlCjMRHsr/UwdYwIK33UO1J5fFNB9XNO6akcywJofVmXQDP2wfrSPcI2xG5BSs3I+IosHr4EtvO1TDAu16xHQq5+ykMblfRXLbhEoFIdDTBdhldvzl+3CMg60ZktI2vNzLW6IIp0waLklot9L63yzuUp8dJd7bglPFe3hIXstBEP58/s6Ocyr4rH2+866ZNbriTzA0RSOWCwakMl1QJgculxPt8Z7O5GLdtW6bvU8R/nO1vb+hMExVAVtEAAAAASUVORK5CYII=");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"•";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAhRJREFUeAHtnLEuBFEUhs9cu7JCskEhIrZAgYZGoREPwBuIygOoPITKA6jEG/AAolFoaFCgICIKZBNiY8Pyz5rNOWe9wNz5T7N3Z2eT/b/7zZlpziat3xKWBDJoEyh5EDd3DTk5r8vV7Yc8vzbl6zvfwvSERIYHyzI90SeLc1WZrFV85PR9oi+N/YMnOT6t/3tiLAeXFqqytjrSFacDYmfvQS6u37tOiPHA7FS/bK6PmWhpj4AJRYGA9MiKzLpK6An+cqiNVmRleUhArrec6PNzt/5sttLgh0cvcvfY6Px+ZNY9I6Ax6gKErY1xmZ8ZyD0E5MJGIgsyIZsunT3g7qALJuTdAp0nWyMTsunS2QNukbpwOcRaPpvOHvxzQow2ZBvrs+nsfLL8o0QQBJFdMO1XGkEjaIQlQCMsD/YIGkEjLAEaYXmwR9AIGmEJ0AjLgz2CRtAIS4BGWB7sETSCRlgCNMLyYI+gETTCEqARlgd7BI2gEZYAjbA82CNoBI2wBGiE5cEeQSNohCVAIywP9ggaQSMsARphebBH0AgaYQnQCMsjYC5SF2agYi2fTWcPGA7VFfO0n8+mswdMyOrCNJwnpz/P6xqZkE2Xzh4w8qcLI4Hbu/dydvkWBRAAQBZk0uOOyKyzp5PARRiF1puNtR+NTh+oMCvtJ+D8F2N6j6x+PrwzG46gRTDDm5BtsAGBg0X924Qfj7i23p7HNgQAAAAASUVORK5CYII=");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAABMtJREFUeAHtXM2KFDEQzrQKruIu4mEXRFlUVLz4A4K7B99AcO8io0/gwQfxDVzFuwu+gQf34EG8iOAPKAh6EFlBFMSf/qa2uqszlVR6ZtYxM5PDJNVVSer78nU6KrHzpyxuVlwx44AY2O0T8eb9D7f5fMu9fPvdff7y0/36nbdgdhUdd+jgHnf62JxbObvgjh/d60Pu2R35ajx49Mk9frqlBk7Kw8sXF9y1K4t9cCoi7tz/4F68/tYXMIkPzpzY725dP9yA1tsjoIRpIQHogRWYZSmwJ4Reh06nI2Nd7rYEA8zAzqXAxhgq/pc1d9vHKbEX+Dr4JbzypJDc/YxXYi/wifRLeOXpU5q7n/FK7EXsnBBeeRoqd7/EHj1ZhleeiMjdz8pArRKR+0pb+UsCuK0SkftKW/kzeFmrRHCAxWzufsaJOkqExWzufpOI8EpP1jnCJCK80pN1jjCJ4ICwMigidz/jRD3bI7bZUInIfaWt/KUSuK0SEd4jqFvufgYva5UIDrCYzd3POFFHifhfV/7k8lwPw7D5mUSEV3r854ju2pK7ffOIWzk/X+Go803Lr+ooGqoiwkyP9xzRXVt0q9sE3CgJYTLqfNPyE/irpkoEe2um6ck4bSiBSeD8JBl41jY/Hgd1lIiaaeoyLlsjgUGAjEH3DB4DtUpEW2Z3Mj5GAgA8efbVvXpX/200nln5IMYvKhHDrvylcwdc9+pSNdeg46WQsP7wo2s7fpWYaPT926fw9ZiVk4BpywYJkGuvlJs4EuWS0p/HTyHh3kbzH2najM85cR0lgpPiYMtukFB26m1u5Ua+vkFkWP3Zn0KCJDg1Px6f42Wtvhrhdyz8ncanrFKCmGH1wrwDMCrh/uxPIUFTAvdHbeVPsc1fVRE+c7Ud/k6fWt7XHFlYqcqQ5wTRvWpiY4wrIZwfDUL+akDRUBXB/jCzFCH9SHCzTDRUmsro7z+cEvrHwxOZn2ZTL/pVFcEBtRLoiWXfxQ5ehvoHHx4vpIwUEuJKSMvPz5/zQq0qwmIy5m+rjBQSwnsCQYnlgwjfT72av6oifOba2qnKcOXeGVIP0rT3BALTNr8mBWSpRHAgmJSTtLGhDHwj+A9GPCbX2DNiBSRoShg0H8zl5y/njxIhJ0WntralDJmIbO+UEvz85Zwt9wj7HIDB5Ttp7RkyGbRDSqC49vOjX50P9aexmr+qInzmajvtO13H02SpyrCVMNj8dT7/4BwByDXzRIC0LWXEldA/njVfip9GpV9VERxQM0lPhrVDyrCVMJr5/fwZJ+qWewR1lSuNJ21sXxnjVgIhck5VhM/cqG1WBpIAMX4Z9Xz+eP58sFUiOBArLQcZpQ0CNCXt1HzA5OfPOFGrrwYHyKTwbNJsxolaJUJbKeo0mu/4uMeXBHBbJSK88qP5jo97fAYva5UIDgivHEXk7mecqKNEhFeOhsjdbxKR+0pb+UsCuK0qIveVtvJn8LJWieAAi9nc/YwTdZQIi9nc/SYR4ZWenSO2yZvgcwTuRYZKWBnUI3e/xF7gcmio5L4HWPlL7AVuyPol95W28me8EnuBa8J+sZjM3c94JfYCd6VxTXjaCjDLe+K9cwTuSuOa8LQUYPXvh1d3w0HC7JK8kMK0/rcJfwHkVMYgi4xhOgAAAABJRU5ErkJggg==");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>hello，大家新年快乐呀，最近在学习Vue源码时候，需要使用Monorepo进行包管理，结果运用到了“npx tsx --init”这个命令，于是我就开始疑惑为什么有的命令用 <code>npm i</code>，有的用 <code>pnpm add</code>，还有的要加 <code>npx</code> 前缀？于是便自己总结了如下的内容，分享给大家！</p>
</blockquote>
<h2 data-id="heading-0">一、先立核心认知：三者不是同一类工具</h2>
<p>很多人会把三者混为一谈，其实它们的定位天差地别！先看一张表快速 get 核心区别：</p>





























<table><thead><tr><th>工具名</th><th>核心定位</th><th>本质 / 所属关系</th><th>核心职责</th></tr></thead><tbody><tr><td><code>npm</code></td><td>Node.js 官方默认包管理器</td><td>随 Node.js 一同安装，官方标配</td><td>管理项目依赖（安装 / 卸载 / 更新 / 发布）</td></tr><tr><td><code>pnpm</code></td><td>高性能第三方替代包管理器</td><td>第三方工具，需手动安装</td><td>同 <code>npm</code> 核心职责，优化性能与磁盘占用</td></tr><tr><td><code>npx</code></td><td>Node 包执行工具</td><td>随 <code>npm@5.2.0+</code> 自带，非包管理器</td><td>执行 Node 包的可执行文件，不管理依赖</td></tr></tbody></table>
<p>划重点：<strong><code>npm</code> 和 <code>pnpm</code> 是「包管理器」，负责 “存放和管理依赖”；<code>npx</code> 是「执行工具」，负责 “运行依赖包”，三者不是同一维度的工具！</strong></p>
<h2 data-id="heading-1">二、逐个拆解：功能详解 + 代码示例</h2>
<h3 data-id="heading-2">1. npm：官方默认，稳字当头</h3>
<p><code>npm</code>（Node Package Manager）是前端开发者的入门标配，它的核心作用就是帮我们管理项目的依赖包，是生态最成熟、兼容性最好的包管理器。</p>
<h4 data-id="heading-3">核心功能（附代码示例）</h4>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85c010baccff48848f77f0df48865660~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWF4a2lt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050191&amp;x-signature=TkbcibVbk5%2Faq%2BC5dVT3u5CQC8M%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-4">优点 &amp; 缺点</h4>
<ul>
<li>优点：兼容性拉满，无需额外配置，几乎支持所有 Node 项目，新手友好。</li>
<li>缺点：安装速度慢，磁盘占用高（嵌套 <code>node_modules</code>，依赖重复拷贝），部分场景会出现版本不一致问题，还可能产生幽灵依赖。</li>
</ul>
<h3 data-id="heading-5">2. pnpm：性能怪兽，省空间神器</h3>
<p><code>pnpm</code>（Performant npm）是针对 <code>npm</code> 痛点优化的第三方包管理器，核心功能和 <code>npm</code> 一致，但在「速度」和「磁盘占用」上实现了碾压级提升。而这一切的优势，都源于它的「全局缓存 + 硬链接 + 软链接」机制，同时它还能杜绝幽灵依赖。</p>
<h4 data-id="heading-6">核心优势（区别于 npm 的关键）</h4>
<ol>
<li><strong>安装速度超快</strong>：比 <code>npm</code> 快 2-5 倍，大型项目中差距更明显。</li>
<li><strong>极致省磁盘</strong>：采用「全局缓存 + 硬链接 / 符号链接」机制，同一个依赖的同一个版本，全局只存储 1 份，多个项目共享。比如：10 个项目都依赖 <code>react@18</code>，<code>npm</code> 会拷贝 10 份，<code>pnpm</code> 只存 1 份，大幅节省磁盘空间。</li>
<li><strong>杜绝幽灵依赖</strong>：<code>pnpm</code> 的 <code>node_modules</code> 结构更严谨，只有在 <code>package.json</code> 中声明的依赖才能被项目使用，避免隐式依赖问题。</li>
</ol>
<h4 data-id="heading-7">深度拆解：pnpm 核心机制（全局缓存 + 硬链接 + 软链接）</h4>
<p>在讲解之前，先给大家用通俗的语言解释两个概念，避免晦涩难懂：</p>
<ul>
<li><strong>硬链接（Hard Link）</strong> ：可以理解为「文件的副本快捷方式」,还可以直白理解成创建了一个word的副本，它和原文件共享同一份磁盘数据。比如你有一个文件 <code>A.txt</code>，给它创建一个硬链接 <code>B.txt</code>，修改 <code>A.txt</code> 内容，<code>B.txt</code> 也会同步变化；删除 <code>A.txt</code>，<code>B.txt</code> 依然可以正常使用（因为它指向的是磁盘数据，不是原文件本身）。</li>
<li><strong>软链接（Symbolic Link，也叫符号链接）</strong> ：可以理解为「Windows 的快捷方式 / Mac 的替身」，它本身不存储任何数据，只记录原文件的路径。比如给 <code>A.txt</code> 创建软链接 <code>C.txt</code>，打开 <code>C.txt</code> 其实是通过路径找到并打开 <code>A.txt</code>；如果删除 <code>A.txt</code>，<code>C.txt</code> 就会失效。</li>
<li><strong>全局缓存</strong>：<code>pnpm</code> 会在你的电脑上创建一个全局的缓存目录（Windows：<code>C:\Users&lt;用户名&gt;.pnpm-store</code>；Mac/Linux：<code>~/.pnpm-store</code>），所有通过 <code>pnpm</code> 下载的依赖包，都会先解压并存储到这个全局缓存中，同一个版本的依赖只存储一次。</li>
</ul>
<p>当你在项目中用 <code>pnpm add &lt;包名&gt;</code> 安装依赖时，<code>pnpm</code> 的工作流程是这样的：</p>
<ol>
<li>先检查全局缓存中是否存在该版本的依赖，如果不存在，就从 npm 仓库下载并存储到全局缓存；</li>
<li>在全局缓存中，给该依赖的文件创建「硬链接」到 <code>pnpm</code> 的虚拟存储目录；</li>
<li>在项目的 <code>node_modules</code> 中，创建「软链接」指向虚拟存储目录中的依赖文件；</li>
<li>最终项目的 <code>node_modules</code> 中，只有软链接，没有实际拷贝的依赖文件，实现了 “一份缓存，多项目共享”。</li>
</ol>
<p>通俗总结：<strong>全局缓存是 “仓库”，硬链接保证 “一份数据多处可用”，软链接负责 “项目找到依赖”，三者结合让 pnpm 既省空间又快。</strong></p>
<h4 data-id="heading-8">深度拆解：幽灵依赖（为什么 npm 有，pnpm 没有？）</h4>
<p>先明确：<strong>幽灵依赖（Phantom Dependency）就是项目中使用了没有在 <code>package.json</code> 中明确声明的依赖，但项目依然能正常运行的现象</strong>。</p>
<p>举个例子帮你理解：</p>
<ol>
<li>你在项目中用 <code>npm i react</code> 安装了 <code>react</code>，而 <code>react</code> 本身依赖 <code>react-dom</code>（这是 <code>react</code> 的依赖，不是你项目的直接依赖）；</li>
<li>由于 <code>npm</code> 会将所有依赖（直接依赖 + 间接依赖）扁平化到 <code>node_modules</code> 根目录，所以你在项目中即使没在 <code>package.json</code> 中声明 <code>react-dom</code>，也能直接导入并使用 <code>react-dom</code>；</li>
<li>这种情况就是幽灵依赖：你没明确安装 <code>react-dom</code>，却能使用它，看似方便，实则隐藏巨大风险 —— 如果某天 <code>react</code> 升级后不再依赖 <code>react-dom</code>，或者依赖的 <code>react-dom</code> 版本大幅变更，你的项目就会突然报错，难以排查。</li>
</ol>
<p>而 <code>pnpm</code> 为什么能杜绝幽灵依赖？因为 <code>pnpm</code> 的 <code>node_modules</code> 不是扁平化的，项目的 
<code>node_modules</code> 根目录下，只有你在 <code>package.json</code> 中明确声明的直接依赖，间接依赖会被放在虚拟存储目录中，项目无法直接访问未声明的间接依赖，自然就杜绝了幽灵依赖，让项目依赖更严谨、更可控。</p>
<h4 data-id="heading-9">核心功能（附代码示例，几乎兼容 npm 命令）</h4>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a3d17e711a649b294f667c8f7393b67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWF4a2lt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050191&amp;x-signature=O8n4Odc5s5Qh2Y7TSecJ66GVeJ8%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-10">优点 &amp; 缺点</h4>
<ul>
<li>优点：速度快、省磁盘、无幽灵依赖、完全兼容 <code>npm</code> 生态，依赖管理更严谨。</li>
<li>缺点：需要手动安装（非 Node 自带），极少数老旧项目可能存在兼容性问题（几乎可以忽略）。</li>
</ul>
<h3 data-id="heading-11">3. npx：包执行工具，告别全局安装</h3>
<p><code>npx</code> 最容易被误解为包管理器，但它<strong>根本不是用来管理依赖的</strong>，而是用来「执行 Node 包」的工具，解决了 <code>npm</code> 执行包的两大痛点。</p>
<h4 data-id="heading-12">解决的核心痛点</h4>
<ol>
<li>痛点 1：全局安装包容易导致版本冲突（比如 A 项目要 <code>create-react-app@5</code>，B 项目要 <code>create-react-app@4</code>）。</li>
<li>痛点 2：本地安装的包，无法直接在命令行执行（路径不在系统环境变量中）。</li>
</ol>
<h4 data-id="heading-13">核心功能（附代码示例，重点！）</h4>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bf9e7feb58c47ba9353c07d56a15f39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWF4a2lt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050191&amp;x-signature=xpHjaKeUVp8SZoSzscjYINVFsxI%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-14">核心特性</h4>
<ul>
<li>无需手动安装包，临时下载即执行。</li>
<li>优先使用本地包，避免版本冲突。</li>
<li>无需配置环境变量，自动识别可执行文件路径。</li>
</ul>
<h2 data-id="heading-15">三、实战场景：该用谁？怎么用？</h2>
<p>看完理论，我们结合实际开发场景，明确三者的使用选择：</p>








































<table><thead><tr><th>场景需求</th><th>推荐工具</th><th>命令示例</th></tr></thead><tbody><tr><td>新手入门、传统项目开发（追求兼容）</td><td>npm</td><td><code>npm i react</code>、<code>npm run dev</code></td></tr><tr><td>大型项目、多项目开发（追求性能 / 省空间 / 严谨性）</td><td>pnpm</td><td><code>pnpm add react</code>、<code>pnpm dev</code></td></tr><tr><td>临时执行脚手架（如 cra、vite）</td><td>npx</td><td><code>npx create-vite my-vite-app</code></td></tr><tr><td>临时运行 TS 文件、格式化代码等</td><td>npx</td><td><code>npx tsx src/index.ts</code>、<code>npx prettier --write .</code></td></tr><tr><td>执行本地安装的包（避免全局版本冲突）</td><td>npx</td><td><code>npx tsc --init</code>、<code>npx webpack</code></td></tr><tr><td>发布自己的 npm 包</td><td>npm/pnpm</td><td><code>npm publish</code>、<code>pnpm publish</code></td></tr></tbody></table>
<h2 data-id="heading-16">四、总结：核心区别一句话记牢</h2>
<ol>
<li><strong>身份差异</strong>：<code>npm</code>（官方包管理器）、<code>pnpm</code>（高性能包管理器）、<code>npx</code>（包执行工具，非包管理器）。</li>
<li><strong>职责差异</strong>：<code>npm</code>/<code>pnpm</code> 管「依赖的安装 / 卸载 / 管理」，<code>npx</code> 管「依赖的执行」。</li>
<li><strong>核心机制差异</strong>：<code>pnpm</code> 靠「全局缓存 + 硬链接 + 软链接」实现高性能和省磁盘，还能杜绝幽灵依赖；<code>npm</code> 无此机制，存在幽灵依赖风险。</li>
<li><strong>性能差异</strong>：<code>pnpm</code> &gt; <code>npm</code>（速度、磁盘占用全方位领先），<code>npx</code> 无此对比维度。</li>
<li><strong>使用差异</strong>：兼容优先用 <code>npm</code>，性能 / 严谨性优先用 <code>pnpm</code>，临时执行 / 避免版本冲突用 <code>npx</code>。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[自定义 Hooks 的用法和意义详解（结合案例）]]></title>    <link>https://juejin.cn/post/7590601860300619803</link>    <guid>https://juejin.cn/post/7590601860300619803</guid>    <pubDate>2026-01-03T13:13:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590601860300619803" data-draft-id="7590699877630558246" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="自定义 Hooks 的用法和意义详解（结合案例）"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2026-01-03T13:13:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冻梨政哥"/> <meta itemprop="url" content="https://juejin.cn/user/2373184444182659"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            自定义 Hooks 的用法和意义详解（结合案例）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2373184444182659/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冻梨政哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T13:13:45.000Z" title="Sat Jan 03 2026 13:13:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">自定义 Hooks 的用法和意义详解（结合案例）</h2>
<h5 data-id="heading-1">一、什么是自定义 Hooks？</h5>
<p>自定义 Hooks 是 React 中<strong>复用状态逻辑</strong>的一种机制，本质是一个以<code>use</code>开头的函数，内部可以调用其他 Hooks（包括内置 Hooks 如<code>useState</code>、<code>useEffect</code>或其他自定义 Hooks）。它的核心作用是将组件中重复的状态管理、副作用处理等逻辑提取出来，实现逻辑复用，让组件更专注于 UI 渲染。</p>
<h5 data-id="heading-2">二、案例解析：自定义 Hooks 的实现与使用</h5>
<h6 data-id="heading-3">1. 案例 1：<code>useMouse</code>—— 封装鼠标位置监听逻辑</h6>
<p><strong>功能</strong>：实时获取鼠标在页面上的坐标，并在组件卸载时自动清除事件监听，避免内存泄漏。</p>
<h6 data-id="heading-4">（1）<code>useMouse</code>的实现（<code>useMouse.js</code>）</h6>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>

<span class="hljs-comment">// 自定义Hooks必须以use开头</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useMouse</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 1. 用useState保存鼠标坐标状态</span>
  <span class="hljs-keyword">const</span> [x, setX] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> [y, setY] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-comment">// 2. 用useEffect处理副作用（添加/清除鼠标移动事件）</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 定义事件处理函数：更新鼠标坐标</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">update</span> = (<span class="hljs-params">event</span>) =&gt; {
      <span class="hljs-title function_">setX</span>(event.<span class="hljs-property">pageX</span>); <span class="hljs-comment">// 更新x坐标</span>
      <span class="hljs-title function_">setY</span>(event.<span class="hljs-property">pageY</span>); <span class="hljs-comment">// 更新y坐标</span>
    };

    <span class="hljs-comment">// 绑定鼠标移动事件</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousemove'</span>, update);

    <span class="hljs-comment">// 3. 清除副作用：组件卸载时移除事件监听（防止内存泄漏）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'mousemove'</span>, update);
    };
  }, []); <span class="hljs-comment">// 空依赖数组：只在组件挂载时执行一次</span>

  <span class="hljs-comment">// 4. 返回需要暴露的状态（鼠标坐标）</span>
  <span class="hljs-keyword">return</span> { x, y };
}
</code></pre>
<p>（2）<code>useMouse</code>的使用（<code>App.jsx</code>中的<code>MouseMove</code>组件）</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MouseMove</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 直接调用自定义Hooks，获取鼠标坐标</span>
  <span class="hljs-keyword">const</span> { x, y } = <span class="hljs-title function_">useMouse</span>();
  
  <span class="hljs-keyword">return</span>(
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      鼠标位置: {x} {y} {/* 只专注于UI渲染，无需关心事件逻辑 */}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<h6 data-id="heading-5">（3）逻辑解析</h6>
<ul>
<li><strong>复用性</strong>：如果其他组件也需要获取鼠标位置，直接调用<code>useMouse()</code>即可，无需重复编写事件绑定 / 清除逻辑。</li>
<li><strong>关注点分离</strong>：组件（<code>MouseMove</code>）只负责渲染 UI，鼠标监听的业务逻辑被封装在<code>useMouse</code>中，代码结构更清晰。</li>
<li><strong>避免内存泄漏</strong>：通过<code>useEffect</code>的返回函数清除事件监听，确保组件卸载后不再执行无用逻辑。</li>
</ul>
<h6 data-id="heading-6">2. 案例 2：<code>useTodos</code>—— 封装待办事项管理逻辑</h6>
<p><strong>功能</strong>：管理待办事项的增、删、改状态，并自动同步到<code>localStorage</code>（刷新页面后数据不丢失）。</p>
<h6 data-id="heading-7">（1）<code>useTodos</code>的实现（<code>useTodos.js</code>）</h6>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">STORAGE_KEY</span> = <span class="hljs-string">'todos'</span>; <span class="hljs-comment">// 本地存储的key（便于维护）</span>

<span class="hljs-comment">// 从localStorage加载待办事项</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">loadFromStorage</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> storedTodos = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-variable constant_">STORAGE_KEY</span>);
  <span class="hljs-keyword">return</span> storedTodos ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(storedTodos) : [];
}

<span class="hljs-comment">// 保存待办事项到localStorage</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">saveToStorage</span>(<span class="hljs-params">todos</span>) {
  <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-variable constant_">STORAGE_KEY</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(todos));
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useTodos</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 1. 用useState初始化待办事项（从本地存储加载）</span>
  <span class="hljs-keyword">const</span> [todos, setTodos] = <span class="hljs-title function_">useState</span>(loadFromStorage);

  <span class="hljs-comment">// 2. 用useEffect同步数据到localStorage（todos变化时触发）</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">saveToStorage</span>(todos);
  }, [todos]); <span class="hljs-comment">// 依赖todos：只有todos变化时才执行</span>

  <span class="hljs-comment">// 3. 定义添加待办事项的方法</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">addTodo</span> = (<span class="hljs-params">text</span>) =&gt; {
    <span class="hljs-title function_">setTodos</span>([
      ...todos,
      { <span class="hljs-attr">id</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(), text, <span class="hljs-attr">completed</span>: <span class="hljs-literal">false</span> } <span class="hljs-comment">// 生成新的待办项</span>
    ]);
  };

  <span class="hljs-comment">// 4. 定义切换待办事项完成状态的方法</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleTodo</span> = (<span class="hljs-params">id</span>) =&gt; {
    <span class="hljs-title function_">setTodos</span>(todos.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> 
      todo.<span class="hljs-property">id</span> === id ? { ...todo, <span class="hljs-attr">completed</span>: !todo.<span class="hljs-property">completed</span> } : todo
    ));
  };

  <span class="hljs-comment">// 5. 定义删除待办事项的方法</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">deleteTodo</span> = (<span class="hljs-params">id</span>) =&gt; {
    <span class="hljs-title function_">setTodos</span>(todos.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> todo.<span class="hljs-property">id</span> !== id));
  };

  <span class="hljs-comment">// 6. 返回状态和方法（供组件使用）</span>
  <span class="hljs-keyword">return</span> { todos, addTodo, toggleTodo, deleteTodo };
}
</code></pre>
<p>（2）<code>useTodos</code>的使用（<code>App.jsx</code>）</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useTodos } <span class="hljs-keyword">from</span> <span class="hljs-string">'./hooks/useTodos.js'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">TodoList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/TodoList.jsx'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">TodoInput</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/TodoInput.jsx'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 调用自定义Hooks，获取待办事项的状态和操作方法</span>
  <span class="hljs-keyword">const</span> { todos, addTodo, toggleTodo, deleteTodo } = <span class="hljs-title function_">useTodos</span>();

  <span class="hljs-keyword">return</span>(
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      {/* 传入addTodo方法给输入组件 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">TodoInput</span> <span class="hljs-attr">addTodo</span>=<span class="hljs-string">{addTodo}/</span>&gt;</span>
      {/* 根据todos状态渲染列表或提示文本 */}
      {
        todos.length &gt; 0 ? (
          <span class="hljs-tag">&lt;<span class="hljs-name">TodoList</span> 
            <span class="hljs-attr">onDelete</span>=<span class="hljs-string">{deleteTodo}</span>
            <span class="hljs-attr">onToggle</span>=<span class="hljs-string">{toggleTodo}</span>
            <span class="hljs-attr">todos</span>=<span class="hljs-string">{todos}</span>
          /&gt;</span>
        ) : (
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>暂无待办事项<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        )
      }
    <span class="hljs-tag">&lt;/&gt;</span></span>
  )
}
</code></pre>
<h6 data-id="heading-8">（3）逻辑解析</h6>
<ul>
<li><strong>状态复用</strong>：待办事项的加载、保存、增删改逻辑被完全封装，任何需要待办功能的组件都可以通过<code>useTodos</code>复用。</li>
<li><strong>简化组件</strong>：<code>App</code>组件无需关心<code>localStorage</code>操作、状态更新细节，只需调用方法和渲染 UI，代码量大幅减少。</li>
<li><strong>一致性</strong>：所有与待办相关的逻辑集中管理，避免多处重复代码导致的维护问题（如修改存储 key 时只需改一处）。</li>
</ul>
<h5 data-id="heading-9">三、自定义 Hooks 的核心意义</h5>
<ol>
<li><strong>逻辑复用</strong>解决了类组件中 “混入（mixin）” 带来的命名冲突、依赖混乱等问题，通过函数调用的方式优雅复用状态逻辑（如<code>useMouse</code>和<code>useTodos</code>可在任意组件中重复使用）。</li>
<li><strong>关注点分离</strong>将组件中的 “业务逻辑”（如事件监听、数据存储）与 “UI 渲染” 分离，使组件更简洁，便于阅读和维护（组件只关心渲染，Hooks 只关心逻辑）。</li>
<li><strong>可测试性</strong>自定义 Hooks 是纯函数，可独立于组件进行单元测试，验证逻辑正确性（如测试<code>useTodos</code>的<code>addTodo</code>方法是否正确添加数据）。</li>
<li><strong>代码一致性</strong>团队中可通过自定义 Hooks 统一业务逻辑的实现方式（如所有数据持久化都用类似<code>useTodos</code>的模式），降低协作成本。</li>
</ol>
<h5 data-id="heading-10">四、自定义 Hooks 的使用规范</h5>
<ul>
<li>必须以<code>use</code>开头（如<code>useMouse</code>、<code>useTodos</code>），React 通过命名识别 Hooks，确保 Hooks 的规则（如只能在顶层调用）被遵守。</li>
<li>内部可以调用其他 Hooks（内置或自定义），但不能在条件语句、循环中调用（需遵循 React Hooks 的调用规则）。</li>
<li>必须返回组件需要的状态或方法（通常是对象或数组，便于解构使用）。</li>
</ul>
<p>通过上述案例可以看出，自定义 Hooks 是 React 中提升代码复用性和可维护性的重要手段，尤其在中大型应用中能显著减少重复代码，让逻辑更清晰。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python 效率飞升术：3基础进阶小工具，少写 100 行循环]]></title>    <link>https://juejin.cn/post/7590676494924103718</link>    <guid>https://juejin.cn/post/7590676494924103718</guid>    <pubDate>2026-01-03T13:55:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590676494924103718" data-draft-id="7590699877630656550" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python 效率飞升术：3基础进阶小工具，少写 100 行循环"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-03T13:55:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AAA简单玩转程序设计"/> <meta itemprop="url" content="https://juejin.cn/user/4294056357689099"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python 效率飞升术：3基础进阶小工具，少写 100 行循环
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4294056357689099/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AAA简单玩转程序设计
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T13:55:10.000Z" title="Sat Jan 03 2026 13:55:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>还在手动写循环处理数据？Python 里这几个 “懒人神器”，看似基础却能直接拉高代码效率，新手也能秒上手！</p>
<h2 data-id="heading-0">1. <code>itertools</code> ：循环偷懒神器，少写 N 行重复代码</h2>
<p>处理迭代器时，<code>itertools</code> 里的方法能帮你实现各种花式循环，不用再手写嵌套逻辑。最常用的就是 <code>cycle</code>（无限循环）和 <code>chain</code>（拼接迭代器）。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> itertools

<span class="hljs-comment"># 需求1：循环遍历列表，到末尾后从头再来</span>
colors = [<span class="hljs-string">"red"</span>, <span class="hljs-string">"green"</span>, <span class="hljs-string">"blue"</span>]
color_cycle = itertools.cycle(colors)

<span class="hljs-comment"># 取前5个元素（演示用，实际可无限取）</span>
<span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(color_cycle))
<span class="hljs-comment"># 输出：red green blue red green</span>

<span class="hljs-comment"># 需求2：拼接多个列表，避免创建新列表占用内存</span>
list1 = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]
list2 = [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>]
combined = itertools.chain(list1, list2)

<span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> combined:
    <span class="hljs-built_in">print</span>(num, end=<span class="hljs-string">" "</span>)  <span class="hljs-comment"># 输出：1 2 3 4 5 6</span>
</code></pre>
<h2 data-id="heading-1">2. <code>collections.defaultdict</code> ：字典分组不翻车，告别 KeyError</h2>
<p>用普通字典分组时，得先判断键是否存在，而 <code>defaultdict</code> 能直接指定默认值类型，分组代码一步到位。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> defaultdict

<span class="hljs-comment"># 需求：把学生按成绩等级分组</span>
students = [
    (<span class="hljs-string">"小明"</span>, <span class="hljs-string">"A"</span>),
    (<span class="hljs-string">"小红"</span>, <span class="hljs-string">"B"</span>),
    (<span class="hljs-string">"小刚"</span>, <span class="hljs-string">"A"</span>),
    (<span class="hljs-string">"小美"</span>, <span class="hljs-string">"B"</span>)
]

<span class="hljs-comment"># 传统字典写法：繁琐且易出错</span>
grade_dict = {}
<span class="hljs-keyword">for</span> name, grade <span class="hljs-keyword">in</span> students:
    <span class="hljs-keyword">if</span> grade <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> grade_dict:
        grade_dict[grade] = []
    grade_dict[grade].append(name)
<span class="hljs-built_in">print</span>(grade_dict)  <span class="hljs-comment"># {'A': ['小明', '小刚'], 'B': ['小红', '小美']}</span>

<span class="hljs-comment"># defaultdict 写法：简洁高效</span>
default_grade = defaultdict(<span class="hljs-built_in">list</span>)
<span class="hljs-keyword">for</span> name, grade <span class="hljs-keyword">in</span> students:
    default_grade[grade].append(name)
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">dict</span>(default_grade))  <span class="hljs-comment"># 结果同上</span>
</code></pre>
<h2 data-id="heading-2">3. <code>enumerate</code> 进阶用法：自定义起始索引，循环更灵活</h2>
<p>基础的 <code>enumerate</code> 大家都会用，但自定义起始索引这个小细节，能让循环结果更贴合实际需求，不用再手动 <code>+1</code>。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 需求：打印学生排名，从1开始计数</span>
names = [<span class="hljs-string">"张三"</span>, <span class="hljs-string">"李四"</span>, <span class="hljs-string">"王五"</span>]

<span class="hljs-comment"># 基础用法：默认从0开始</span>
<span class="hljs-keyword">for</span> idx, name <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(names):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"第<span class="hljs-subst">{idx+<span class="hljs-number">1</span>}</span>名：<span class="hljs-subst">{name}</span>"</span>)  <span class="hljs-comment"># 手动+1，麻烦</span>

<span class="hljs-comment"># 进阶用法：指定start参数，直接从1开始</span>
<span class="hljs-keyword">for</span> idx, name <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(names, start=<span class="hljs-number">1</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"第<span class="hljs-subst">{idx}</span>名：<span class="hljs-subst">{name}</span>"</span>)
<span class="hljs-comment"># 输出：</span>
<span class="hljs-comment"># 第1名：张三</span>
<span class="hljs-comment"># 第2名：李四</span>
<span class="hljs-comment"># 第3名：王五</span>
</code></pre>
<hr/>
<h3 data-id="heading-3">小总结</h3>
<ol>
<li><code>itertools</code> 能简化迭代器操作，减少重复循环代码；</li>
<li><code>defaultdict</code> 是字典分组的 “利器”，避免手动判断键是否存在；</li>
<li><code>enumerate</code> 指定 <code>start</code> 参数，能直接得到符合需求的索引。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Monorepo 各包间正确的通信方式]]></title>    <link>https://juejin.cn/post/7590608345923452954</link>    <guid>https://juejin.cn/post/7590608345923452954</guid>    <pubDate>2026-01-03T14:10:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590608345923452954" data-draft-id="7590676494924038182" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Monorepo 各包间正确的通信方式"/> <meta itemprop="keywords" content="前端,架构,代码规范"/> <meta itemprop="datePublished" content="2026-01-03T14:10:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="在西安放羊的牛油果"/> <meta itemprop="url" content="https://juejin.cn/user/2946346894233133"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Monorepo 各包间正确的通信方式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2946346894233133/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    在西安放羊的牛油果
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T14:10:33.000Z" title="Sat Jan 03 2026 14:10:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>Monorepo（Monolithic Repository）指的是把多个包（项目）的代码，统一放在同一个代码仓库里进行管理的一种仓库组织方式。适合多个项目强相关且有大量共享代码的中大型项目。使用 Monorepo 管理项目的好处非常明显，它不用发 npm 包，不用来回同步版本，改完公共库，所有项目立即可用，使得共享代码更简单。
Monorepo 是存放多个包的仓库，包之间的通信方式至关重要，接下来我们以一个交易项目为例，一步一步了解 Monorepo 各包间正确的通信方式。</p>
<h2 data-id="heading-1">交易平台项目简述</h2>
<p>该项目是一个给用户提供股票交易服务的平台。项目包括交易（Trade）、资产（Portfolios）、行情（Quotes）、市场（Market）等模块。项目还有提供公共方法、UI、数据等公共模块。</p>
<h2 data-id="heading-2">交易平台各包之间的通信问题</h2>
<h3 data-id="heading-3">包之间的依赖关系不合理</h3>
<p>包之间出现循环依赖问题，业务包依赖业务包。</p>
<pre><code class="hljs language-ts" lang="ts">├── <span class="hljs-meta">@repo</span>/shared ←→ <span class="hljs-meta">@repo</span>/trade (循环依赖)
├── <span class="hljs-meta">@repo</span>/account → <span class="hljs-meta">@repo</span>/trade (不合理)
├── <span class="hljs-meta">@repo</span>/quote → <span class="hljs-meta">@repo</span>/trade (不合理)
├── <span class="hljs-meta">@repo</span>/portfolios → <span class="hljs-meta">@repo</span>/trade (不合理)
└── ...
</code></pre>
<h3 data-id="heading-4">封装性破坏：直接访问包内部实现</h3>
<p>直接导入其他包的内部路径</p>
<pre><code class="hljs language-ts" lang="ts">  <span class="hljs-comment">// packages/shared/utils/order.ts</span>
  <span class="hljs-keyword">import</span> { <span class="hljs-title class_">EOrderVerify</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/trade/data'</span>;
  <span class="hljs-keyword">import</span> { canFillSearch } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/trade/utils'</span>;
  
  <span class="hljs-comment">// packages/shared/reports/modules/trade.ts</span>
  <span class="hljs-keyword">import</span> { <span class="hljs-title class_">ECondOrderVerifyParaKey</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@pkg/trade/data/sensors'</span>;
  <span class="hljs-keyword">import</span> { getIsEntrustType } <span class="hljs-keyword">from</span> <span class="hljs-string">'@pkg/trade/utils/type'</span>;
  <span class="hljs-keyword">import</span> { useIndexSession, useNightTradeSession } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/trade/utils/hooks'</span>;
</code></pre>
<h3 data-id="heading-5">紧耦合：直接依赖应用层 stores</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/shared/utils/order.ts</span>
<span class="hljs-keyword">import</span> { useConfigStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/config'</span>;
<span class="hljs-keyword">import</span> { useMarketStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/market.ts'</span>;
<span class="hljs-keyword">import</span> { usePasswordStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/password'</span>;
<span class="hljs-keyword">import</span> { useTradeStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/trade'</span>;
<span class="hljs-keyword">import</span> { useUserStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/user'</span>;

<span class="hljs-comment">// packages/trade/utils/verify.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">EStatementType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/quote-statement.ts'</span>;

<span class="hljs-comment">// packages/portfolios/components/orders/index.vue</span>
<span class="hljs-keyword">import</span> { useMarketStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/market'</span>;
<span class="hljs-keyword">import</span> { useOrderStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/order'</span>;
</code></pre>
<h2 data-id="heading-6">项目包间正确通信方式</h2>
<h3 data-id="heading-7">一、依赖层次原则</h3>
<h4 data-id="heading-8">1.1 依赖层次结构</h4>
<pre><code class="hljs language-ts" lang="ts">┌─────────────────────────────────────┐
│         apps/web (应用层)            │
│  依赖所有业务包，负责组装和路由      │
└─────────────────────────────────────┘
              │
              ├─────────────────────────────────────┐
              │                                     │
┌─────────────▼──────────────┐  ┌──────────────────▼──────────────┐
│   业务包 (<span class="hljs-title class_">Business</span>)        │  │   基础包 (<span class="hljs-title class_">Foundation</span>)            │
│  - trade                   │  │  - shared (不依赖其他业务包)     │
│  - account                 │  │  - data-center                  │
│  - quote                   │  │  - ui                            │
│  - portfolios              │  │                                  │
│  - company                 │  │                                  │
│  - market                  │  │                                  │
│  - ...                     │  │                                  │
└────────────────────────────┘  └──────────────────────────────────┘
</code></pre>
<h4 data-id="heading-9">1.2 依赖规则</h4>
<h5 data-id="heading-10">✅ 允许的依赖方向</h5>
<ol>
<li><strong>应用层</strong> → 所有包</li>
<li><strong>业务包</strong> → 基础包（shared, data-center, ui）</li>
<li><strong>基础包</strong> → 只依赖更底层的基础包或外部库</li>
<li><strong>shared 包</strong> → 不依赖任何业务包</li>
</ol>
<h5 data-id="heading-11">❌ 禁止的依赖方向</h5>
<ol>
<li><strong>基础包</strong> → 业务包（如 shared → trade）</li>
<li><strong>业务包</strong> → 业务包（如 account → trade）</li>
<li><strong>循环依赖</strong>（如 shared ↔ trade）</li>
</ol>
<h4 data-id="heading-12">1.3 依赖层次示例</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// ✅ 正确：业务包依赖基础包</span>
<span class="hljs-comment">// packages/trade/package.json</span>
{
  <span class="hljs-string">"dependencies"</span>: {
    <span class="hljs-string">"@repo/shared"</span>: <span class="hljs-string">"workspace: "</span> ,
 <span class="hljs-string">"@repo/data-center"</span> :  <span class="hljs-string">"workspace: "</span>,
    <span class="hljs-string">"@repo/ui"</span>: <span class="hljs-string">"workspace:*"</span>
  }
}

<span class="hljs-comment">// ❌ 错误：基础包依赖业务包</span>
<span class="hljs-comment">// packages/shared/package.json</span>
{
  <span class="hljs-string">"dependencies"</span>: {
    <span class="hljs-string">"@repo/trade"</span>: <span class="hljs-string">"workspace:*"</span>  <span class="hljs-comment">// ❌ 不应该依赖业务包</span>
  }
}
</code></pre>
<h3 data-id="heading-13">二、通信模式</h3>
<h4 data-id="heading-14">2.1 事件通信模式（Event Bus）</h4>
<p><strong>适用场景</strong>：</p>
<ol>
<li>包间的松耦合通信</li>
<li>一对多的通知场景</li>
<li>异步事件通知</li>
</ol>
<p><strong>实现方式</strong>：</p>
<ol>
<li>定义事件类型（在 shared 包中）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/shared/events/index.ts</span>
<span class="hljs-keyword">import</span> mitt <span class="hljs-keyword">from</span> <span class="hljs-string">'mitt'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">EEventBusType</span> {
  <span class="hljs-variable constant_">ORDER_SUCCESS</span> = <span class="hljs-string">'orderSuccess'</span>,
  <span class="hljs-variable constant_">USER_LOGIN_SUCCESS</span> = <span class="hljs-string">'userLoginSuccess'</span>,
  <span class="hljs-comment">// ...</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">TEvents</span> = {
  [<span class="hljs-title class_">EEventBusType</span>.<span class="hljs-property">ORDER_SUCCESS</span>]?: {
    <span class="hljs-attr">orderId</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">orderType</span>: <span class="hljs-built_in">string</span>;
  };
  [<span class="hljs-title class_">EEventBusType</span>.<span class="hljs-property">USER_LOGIN_SUCCESS</span>]?: <span class="hljs-built_in">unknown</span>;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> eventBus = mitt&lt;<span class="hljs-title class_">TEvents</span>&gt;();
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> eventBus;
</code></pre>
<ol start="2">
<li>发送事件（在 trade 包中）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/trade/order/index.vue</span>
<span class="hljs-keyword">import</span> eventBus, { <span class="hljs-title class_">EEventBusType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/shared/events'</span>;

<span class="hljs-comment">// 下单成功后发送事件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleOrderSuccess</span> = (<span class="hljs-params"/>) =&gt; {
  eventBus.<span class="hljs-title function_">emit</span>(<span class="hljs-title class_">EEventBusType</span>.<span class="hljs-property">ORDER_SUCCESS</span>, {
    <span class="hljs-attr">orderId</span>: <span class="hljs-string">'123'</span>,
    <span class="hljs-attr">orderType</span>: <span class="hljs-string">'limit'</span>
  });
};
</code></pre>
<ol start="3">
<li>监听事件（在 portfolios 包中）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/portfolios/components/orders/index.vue</span>
<span class="hljs-keyword">import</span> eventBus, { <span class="hljs-title class_">EEventBusType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/shared/events'</span>;
<span class="hljs-keyword">import</span> { onMounted, onUnmounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">orderChangeCallBack</span> = (<span class="hljs-params">data: <span class="hljs-built_in">any</span></span>) =&gt; {
  <span class="hljs-comment">// 处理订单变化</span>
  <span class="hljs-title function_">refreshOrderList</span>();
};

<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  eventBus.<span class="hljs-title function_">on</span>(<span class="hljs-title class_">EEventBusType</span>.<span class="hljs-property">ORDER_SUCCESS</span>, orderChangeCallBack);
});

<span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
  eventBus.<span class="hljs-title function_">off</span>(<span class="hljs-title class_">EEventBusType</span>.<span class="hljs-property">ORDER_SUCCESS</span>, orderChangeCallBack);
});
</code></pre>
<p><strong>优点</strong>：</p>
<ol>
<li>解耦：发送者和接收者不需要直接依赖</li>
<li>灵活：可以动态添加/移除监听器</li>
<li>支持一对多通信</li>
</ol>
<p><strong>注意事项</strong>：</p>
<ol>
<li>事件类型定义应在 shared 包中，确保类型安全</li>
<li>及时清理事件监听器，避免内存泄漏</li>
<li>事件名称应清晰明确，避免命名冲突</li>
</ol>
<h4 data-id="heading-15">2.2 服务模式（Singleton Service）</h4>
<p><strong>适用场景</strong>：</p>
<ol>
<li>提供统一的数据访问接口</li>
<li>跨包共享服务实例</li>
<li>需要单例模式的服务</li>
<li/>
</ol>
<p><strong>实现方式</strong>：</p>
<ol>
<li>定义服务（在 data-center 包中）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/data-center/core/index.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Singleton</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/shared/utils/singleton'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataCenter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Singleton</span> {
  <span class="hljs-keyword">static</span> tag = <span class="hljs-string">'DataCenter'</span>;
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getStockInfo</span>(<span class="hljs-params">code: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-comment">// 获取股票信息</span>
  }
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getQuotes</span>(<span class="hljs-params">codes: <span class="hljs-built_in">string</span>[]</span>) {
    <span class="hljs-comment">// 获取行情数据</span>
  }
}

<span class="hljs-comment">// 2. 导出服务</span>
<span class="hljs-keyword">export</span> { <span class="hljs-title class_">DataCenter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./core'</span>;
</code></pre>
<ol start="2">
<li>使用服务（在任何包中）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/trade/utils/stock.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">DataCenter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/data-center'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">getStockData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">code: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-keyword">const</span> dataCenter = <span class="hljs-title class_">DataCenter</span>.<span class="hljs-title function_">getInstance</span>();
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> dataCenter.<span class="hljs-title function_">getStockInfo</span>(code);
};
</code></pre>
<p><strong>优点</strong>：</p>
<ol>
<li>统一接口：所有包通过相同的接口访问服务</li>
<li>单例保证：确保全局只有一个实例</li>
<li>易于测试：可以 mock 服务接口</li>
</ol>
<p><strong>注意事项</strong>：</p>
<ol>
<li>
<p>服务接口应稳定，避免频繁变更</p>
</li>
<li>
<p>服务应在 shared 或 data-center 等基础包中</p>
</li>
<li>
<p>避免在服务中直接依赖业务包</p>
</li>
</ol>
<h4 data-id="heading-16">2.3 共享类型和接口</h4>
<p><strong>适用场景</strong>：</p>
<ol>
<li>包间传递数据</li>
<li>定义公共接口</li>
<li>类型约束</li>
</ol>
<p><strong>实现方式</strong>：</p>
<ol>
<li>定义共享类型（在 shared 包中）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/shared/types/order.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IOrderForm</span> {
  <span class="hljs-attr">stockCode</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">stockName</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">entrustType</span>: <span class="hljs-title class_">EEntrustType</span>;
  <span class="hljs-comment">// ...</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IMaxAvailableAsset</span> {
  <span class="hljs-attr">cashAvailable</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">marginAvailable</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<ol start="2">
<li>使用共享类型（在 trade 包中）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/trade/order/index.vue</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">IOrderForm</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/shared/types/order'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-attr">form</span>: <span class="hljs-title class_">IOrderForm</span> = {
  <span class="hljs-attr">stockCode</span>: <span class="hljs-string">'AAPL'</span>,
  <span class="hljs-attr">stockName</span>: <span class="hljs-string">'Apple Inc.'</span>,
  <span class="hljs-comment">// ...</span>
};
</code></pre>
<ol start="3">
<li>使用共享类型（在 portfolios 包中）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/portfolios/components/orders/index.vue</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">IOrderForm</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/shared/types/order'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">displayOrder</span> = (<span class="hljs-params">order: IOrderForm</span>) =&gt; {
  <span class="hljs-comment">// 使用共享类型</span>
};
</code></pre>
<p><strong>优点</strong>：</p>
<ol>
<li>类型安全：TypeScript 提供编译时类型检查</li>
<li>一致性：确保数据结构一致</li>
<li>可维护性：类型定义集中管理</li>
</ol>
<p><strong>注意事项</strong>：</p>
<ol>
<li>共享类型应在 shared 包中定义</li>
<li>避免在业务包中定义共享类型</li>
<li>类型定义应向后兼容</li>
</ol>
<h4 data-id="heading-17">2.4 公共 API 导出模式</h4>
<p><strong>适用场景</strong>：</p>
<ol>
<li>包需要对外暴露功能</li>
<li>隐藏内部实现细节</li>
<li>提供稳定的接口</li>
</ol>
<p><strong>实现方式</strong>：</p>
<ol>
<li>建立公共 API（在 trade 包中）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/trade/index.ts</span>
<span class="hljs-comment">// 导出常量</span>
<span class="hljs-keyword">export</span> { <span class="hljs-title class_">EOrderVerify</span>, <span class="hljs-title class_">EOrderErrorCode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./data/constant'</span>;

<span class="hljs-comment">// 导出工具函数</span>
<span class="hljs-keyword">export</span> { canFillSearch, getOpenAccountUrl } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils'</span>;

<span class="hljs-comment">// 导出类型</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">IOrderForm</span>, <span class="hljs-title class_">IAttachedOrder</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./types'</span>;

<span class="hljs-comment">// 导出组件（如果需要）</span>
<span class="hljs-keyword">export</span> { <span class="hljs-keyword">default</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">OrderPanel</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./order/index.vue'</span>;
</code></pre>
<ol start="2">
<li>使用公共API（在其他包中）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// ✅ 正确：通过公共API导入</span>
<span class="hljs-keyword">import</span> { getOpenAccountUrl } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/trade'</span>;

<span class="hljs-comment">// ❌ 错误：直接访问内部实现</span>
<span class="hljs-keyword">import</span> { getOpenAccountUrl } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/trade/utils'</span>;
</code></pre>
<p><strong>优点</strong>：</p>
<ol>
<li>封装性：隐藏内部实现</li>
<li>稳定性：公共API相对稳定</li>
<li>可维护性：内部重构不影响外部使用</li>
</ol>
<p><strong>注意事项</strong>：</p>
<ol>
<li>
<p>每个包都应建立 index.ts 作为公共 API 入口</p>
</li>
<li>
<p>只导出需要对外暴露的功能</p>
</li>
<li>
<p>避免导出内部实现细节</p>
</li>
</ol>
<h4 data-id="heading-18">2.5 依赖注入模式</h4>
<p><strong>适用场景</strong>：</p>
<ol>
<li>需要解耦 stores 依赖</li>
<li>提高可测试性</li>
<li>支持不同的实现</li>
</ol>
<p><strong>实现方式</strong>：</p>
<ol>
<li>定义接口（在 shared 包中）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/shared/interfaces/stores.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IUserStore</span> {
  <span class="hljs-attr">logined</span>: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-attr">customerInfo</span>: <span class="hljs-built_in">any</span>;
  <span class="hljs-attr">goLogin</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IConfigStore</span> {
  <span class="hljs-attr">urlsConfig</span>: {
    <span class="hljs-attr">acOpen</span>: <span class="hljs-built_in">string</span>;
  };
}
</code></pre>
<ol start="2">
<li>通过参数注入（在 shared 包中）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/shared/utils/order.ts</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">IUserStore</span>, <span class="hljs-title class_">IConfigStore</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/shared/interfaces/stores'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">preVerify</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">
  userStore: IUserStore,
  configStore: IConfigStore
</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!userStore.<span class="hljs-property">logined</span>) {
    userStore.<span class="hljs-title function_">goLogin</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
  <span class="hljs-comment">// ...</span>
};
</code></pre>
<ol start="3">
<li>在应用层注入依赖（在 apps/web 中）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// apps/web/src/views/trade/index.vue</span>
<span class="hljs-keyword">import</span> { preVerify } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/shared/utils/order'</span>;
<span class="hljs-keyword">import</span> { useUserStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/user'</span>;
<span class="hljs-keyword">import</span> { useConfigStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/config'</span>;

<span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">useUserStore</span>();
<span class="hljs-keyword">const</span> configStore = <span class="hljs-title function_">useConfigStore</span>();

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handlePreVerify</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">preVerify</span>(userStore, configStore);
};
</code></pre>
<p><strong>优点</strong>：</p>
<ol>
<li>解耦：包不直接依赖 stores</li>
<li>可测试：可以轻松 mock 依赖</li>
<li>灵活：支持不同的实现</li>
</ol>
<p><strong>注意事项</strong>：</p>
<ol>
<li>
<p>接口定义应在 shared 包中</p>
</li>
<li>
<p>依赖注入会增加调用复杂度</p>
</li>
<li>
<p>适合复杂场景，简单场景可直接使用</p>
</li>
</ol>
<h4 data-id="heading-19">2.6 API Linker 模式</h4>
<p><strong>适用场景</strong>：</p>
<ol>
<li>通过 URL 参数调用 API</li>
<li>跨页面通信</li>
<li>外部系统集成</li>
</ol>
<p><strong>实现方式</strong>：</p>
<ol>
<li>注册 API（在 trade 包中）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/trade/utils/api-linker.ts</span>
<span class="hljs-keyword">import</span> apiLinker <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/shared/app/router/api-linker'</span>;

apiLinker.<span class="hljs-title function_">registerLinkerApi</span>({
  <span class="hljs-attr">openTradePanel</span>: <span class="hljs-keyword">async</span> (<span class="hljs-attr">params</span>: { <span class="hljs-attr">stockCode</span>: <span class="hljs-built_in">string</span> }) =&gt; {
    <span class="hljs-comment">// 打开交易面板</span>
  },
  <span class="hljs-attr">submitOrder</span>: <span class="hljs-keyword">async</span> (<span class="hljs-attr">params</span>: <span class="hljs-title class_">IOrderForm</span>) =&gt; {
    <span class="hljs-comment">// 提交订单</span>
  }
});
</code></pre>
<ol start="2">
<li>创建 API 链接（在其他包中）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/company/components/stock-card/index.vue</span>
<span class="hljs-keyword">import</span> apiLinker <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/shared/app/router/api-linker'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">openTrade</span> = (<span class="hljs-params">stockCode: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-keyword">const</span> url = apiLinker.<span class="hljs-title function_">createApiLink</span>(<span class="hljs-string">'/trade'</span>, {
    <span class="hljs-attr">apiNames</span>: [<span class="hljs-string">'openTradePanel'</span>],
    <span class="hljs-attr">apiOptions</span>: {
      <span class="hljs-attr">openTradePanel</span>: { stockCode }
    }
  });
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">open</span>(url);
};
</code></pre>
<p><strong>优点</strong>：</p>
<ol>
<li>跨页面通信</li>
<li>支持外部系统集成</li>
<li>解耦页面间依赖</li>
</ol>
<h3 data-id="heading-20">三、最佳实践</h3>
<h4 data-id="heading-21">3.1 包内导入规则</h4>
<h5 data-id="heading-22"><em>✅ 正确：包内使用相对路径</em></h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/trade/utils/verify.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">EOrderVerify</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../data/constant'</span>;
<span class="hljs-keyword">import</span> { canFillSearch } <span class="hljs-keyword">from</span> <span class="hljs-string">'./common'</span>;
</code></pre>
<h5 data-id="heading-23"><em>❌ 错误：包内使用包名路径</em></h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">EOrderVerify</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/trade/data/constant'</span>;

<span class="hljs-comment">// 讨论：是否可以使用 @pkg/trade</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">EOrderVerify</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">' @pkg/trade/data/constant'</span>;
</code></pre>
<h5 data-id="heading-24"><em>✅ 正确：跨包使用包名路径</em></h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// packages/account/index.vue</span>
<span class="hljs-keyword">import</span> { getOpenAccountUrl } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/trade'</span>;
<span class="hljs-keyword">import</span> { eventBus } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/shared/events'</span>;
</code></pre>
<h4 data-id="heading-25">3.2 类型定义规则</h4>
<h5 data-id="heading-26"><em>✅ 正确：共享类型在 shared 包中</em></h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/shared/types/order.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IOrderForm</span> {
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<h5 data-id="heading-27"><em>✅ 正确：业务特定类型在业务包中</em></h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/trade/types/condition.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IConditionOrder</span> {
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<h4 data-id="heading-28">3.3 常量定义规则</h4>
<h5 data-id="heading-29"><em>✅ 正确：通用常量在 shared 包中</em></h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/shared/constant/order.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">EEntrustType</span> {
  <span class="hljs-variable constant_">LIMIT</span> = <span class="hljs-number">1</span>,
  <span class="hljs-variable constant_">MARKET</span> = <span class="hljs-number">2</span>,
}
</code></pre>
<h5 data-id="heading-30"><em>✅ 正确：业务特定常量在业务包中</em></h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/trade/data/constant.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">EOrderVerify</span> {
  <span class="hljs-variable constant_">NOT_LOGIN</span> = <span class="hljs-string">'not_login'</span>,
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<h4 data-id="heading-31">3.4 工具函数规则</h4>
<h5 data-id="heading-32"><em>✅ 正确：通用工具函数在 shared 包中</em></h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/shared/utils/order.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">isTrue</span> = (<span class="hljs-params">flag: <span class="hljs-built_in">any</span></span>) =&gt; {
  <span class="hljs-comment">// 通用逻辑</span>
};
</code></pre>
<h5 data-id="heading-33"><em>✅ 正确：业务特定工具函数在业务包中</em></h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/trade/utils/verify.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">verifyOrder</span> = (<span class="hljs-params">order: IOrderForm</span>) =&gt; {
  <span class="hljs-comment">// 业务特定逻辑</span>
};
</code></pre>
<h3 data-id="heading-34">四、通信模式选择指南</h3>








































<table><thead><tr><th><strong>场景</strong></th><th><strong>推荐模式</strong></th><th><strong>示例</strong></th></tr></thead><tbody><tr><td>通知其他包某个事件发生</td><td>事件通信</td><td>订单成功、登录成功</td></tr><tr><td>获取共享数据</td><td>服务模式</td><td>获取股票信息、行情数据</td></tr><tr><td>传递数据</td><td>共享类型</td><td>订单表单、用户信息</td></tr><tr><td>调用其他包功能</td><td>公共 API</td><td>工具函数、组件</td></tr><tr><td>需要解耦 stores</td><td>依赖注入</td><td>验证函数、工具函数</td></tr><tr><td>跨页面通信</td><td>API Linker</td><td>打开交易面板</td></tr></tbody></table>
<h3 data-id="heading-35">五、重构建议</h3>
<h4 data-id="heading-36">5.1 解决循环依赖</h4>
<p><strong>步骤1：识别共享内容</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 找出 shared 包中使用的 trade 包内容</span>
<span class="hljs-comment">// packages/shared/utils/order.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">EOrderVerify</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/trade/data'</span>;  <span class="hljs-comment">// 需要移到shared</span>
<span class="hljs-keyword">import</span> { canFillSearch } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/trade/utils'</span>; <span class="hljs-comment">// 需要移到shared</span>
</code></pre>
<p><strong>步骤2：迁移到 shared 包</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/shared/constant/order.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">EOrderVerify</span> {
  <span class="hljs-variable constant_">NOT_LOGIN</span> = <span class="hljs-string">'not_login'</span>,
  <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// packages/shared/utils/order.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">canFillSearch</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">params: <span class="hljs-built_in">any</span></span>) =&gt; {
  <span class="hljs-comment">// 实现逻辑</span>
};
</code></pre>
<p><strong>步骤3：更新引用</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/trade/utils/verify.ts</span>
<span class="hljs-comment">// 从 shared 包导入</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">EOrderVerify</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/shared/constant/order'</span>;
<span class="hljs-keyword">import</span> { canFillSearch } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/shared/utils/order'</span>;
</code></pre>
<p><strong>步骤4：移除依赖</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/shared/package.json</span>
{
  <span class="hljs-string">"dependencies"</span>: {
    <span class="hljs-comment">// 移除 "@repo/trade": "workspace:*"</span>
  }
</code></pre>
<h4 data-id="heading-37">5.2 建立公共 API</h4>
<p><strong>步骤1：在各包的根目录创建 index.ts</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/trade/index.ts</span>
<span class="hljs-comment">// 导出常量</span>
<span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">'./data/constant'</span>;

<span class="hljs-comment">// 导出工具函数</span>
<span class="hljs-keyword">export</span> { canFillSearch } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils/verify'</span>;
<span class="hljs-keyword">export</span> { getOpenAccountUrl } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils/config'</span>;

<span class="hljs-comment">// 导出类型</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">IOrderForm</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./types'</span>;

<span class="hljs-comment">// 导出组件（可选）</span>
<span class="hljs-keyword">export</span> { <span class="hljs-keyword">default</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">OrderPanel</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./order/index.vue'</span>;
</code></pre>
<p><strong>步骤2：更新引用</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/account/index.vue （account 包）</span>
<span class="hljs-comment">// 其他包通过 trade 包的公共 API 访问</span>
<span class="hljs-keyword">import</span> { getOpenAccountUrl } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/trade'</span>;
</code></pre>
<h4 data-id="heading-38">5.3 解耦 stores 依赖</h4>
<p><strong>步骤1：定义接口</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/shared/interfaces/stores.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IUserStore</span> {
  <span class="hljs-attr">logined</span>: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-attr">customerInfo</span>: <span class="hljs-built_in">any</span>;
  <span class="hljs-attr">goLogin</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;
}
</code></pre>
<p><strong>步骤2：修改函数签名</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/shared/utils/order.ts</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">IUserStore</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/shared/interfaces/stores'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">preVerify</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">userStore: IUserStore</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!userStore.<span class="hljs-property">logined</span>) {
    userStore.<span class="hljs-title function_">goLogin</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
<span class="hljs-comment">// ... </span>
</code></pre>
<p><strong>步骤3：在应用层注入</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// apps/web/src/views/trade/index.vue</span>
<span class="hljs-keyword">import</span> { preVerify } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/shared/utils/order'</span>;
<span class="hljs-keyword">import</span> { useUserStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/user'</span>;

<span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">useUserStore</span>();
<span class="hljs-keyword">await</span> <span class="hljs-title function_">preVerify</span>(userStore);
</code></pre>
<h3 data-id="heading-39">六、检查清单</h3>
<p>在添加新的包间通信时，请检查：</p>
<ul>
<li>是否遵循依赖层次原则？</li>
<li>是否避免了循环依赖？</li>
<li>是否使用了合适的通信模式？</li>
<li>共享类型是否在 shared 包中？</li>
<li>是否建立了公共 API？</li>
<li>是否避免了直接访问内部实现？</li>
<li>是否避免了直接依赖 stores？</li>
<li>事件监听器是否及时清理？</li>
</ul>
<h3 data-id="heading-40">七、总结</h3>
<p>正确的包间通信应该是：</p>
<ol>
<li>
<p><strong>遵循依赖层次</strong>：基础包不依赖业务包</p>
</li>
<li>
<p><strong>使用合适的通信模式</strong>：根据场景选择事件、服务、类型等</p>
</li>
<li>
<p><strong>建立公共 API</strong>：通过 index.ts 导出，隐藏内部实现</p>
</li>
<li>
<p><strong>共享类型和常量</strong>：在 shared 包中定义</p>
</li>
<li>
<p><strong>解耦 stores</strong>：通过依赖注入或接口</p>
</li>
<li>
<p><strong>及时清理资源</strong>：事件监听器等</p>
</li>
</ol>
<p>遵循这些原则，可以确保包间的松耦合、高内聚，提高代码的可维护性和可测试性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【高斯泼溅】破解大规模3DGS落地卡点：高效数据组织让“最后一公里”变坦途]]></title>    <link>https://juejin.cn/post/7590597231708258339</link>    <guid>https://juejin.cn/post/7590597231708258339</guid>    <pubDate>2026-01-04T01:54:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590597231708258339" data-draft-id="7590292192989691944" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【高斯泼溅】破解大规模3DGS落地卡点：高效数据组织让“最后一公里”变坦途​"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-04T01:54:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Mapmost"/> <meta itemprop="url" content="https://juejin.cn/user/1679709496936343"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【高斯泼溅】破解大规模3DGS落地卡点：高效数据组织让“最后一公里”变坦途​
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1679709496936343/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Mapmost
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T01:54:35.000Z" title="Sun Jan 04 2026 01:54:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从分区训练到流式服务的最后一公里</h2>
<p>在3DGS专栏下的<a href="https://juejin.cn/post/7583892482599370767" target="_blank" title="https://juejin.cn/post/7583892482599370767">《Mapmost分区训练： 让大场景3DGS的建模从此高效且高质》</a>一文中，我们深入剖析了3DGS在应对大地理范围场景时所面临的显存与训练效率挑战，并提出通过<strong>空间分治策略</strong>实现可扩展建模。</p>
<p>然而，建模只是起点，<strong>高效使用才是关键</strong>。当用户期望在Web浏览器中流畅探索这些超大规模场景时，新的难题随之而来：<strong>如何让消费级显卡甚至移动设备，也能丝滑渲染远超本地显存容量的3DGS模型？</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35d399c7993b4bcfa81ee7a397d15256~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768096475&amp;x-signature=y7dgBP%2FzJiNHSMn4FbttJkrS4K8%3D" alt="" loading="lazy"/></p>
<p><em>大规模3DGS模型需在Web端流畅渲染</em></p>
<p>这一问题的答案指向<strong>服务化发布</strong>——本质上是一套涵盖<strong>数据组织、网络传输与客户端渲染</strong>的全链路协同优化系统工程。</p>
<p>而本文将聚焦其中最基础却至关重要的环节：<strong>数据侧的高效组织</strong>。借鉴倾斜摄影模型的发展路径，我们将围绕<strong>空间索引构建</strong>与<strong>多细节层次(LOD)划分</strong>两大核心，探讨面向大规模3DGS的数据结构设计。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d6f4a0eff134f8fa84498004a750cc7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768096475&amp;x-signature=qEtWcdJkbLS06Os753igTkXI3O0%3D" alt="" loading="lazy"/></p>
<p><em>空间网格构建与细节层级划分</em></p>
<h2 data-id="heading-1">分块化空间索引：将全局场景拆解为“数据砖块”</h2>
<h3 data-id="heading-2">01.分块索引的关键特性</h3>
<p>要实现大规模3DGS场景的服务化发布，意味着我们必须将一个动辄数十GB的“庞然大物”，拆解为一系列<strong>空间有序、粒度合理、可独立调度</strong>的**“数据砖块”**。</p>
<p>这种<strong>数据分块策略</strong>的核心目标，是通过空间逻辑切割，使每个单元具备以下特性：</p>
<ul>
<li>**大小均衡：**便于网络传输与内存管理；</li>
<li>**语义局部性：**单个块内包含完整的几何与外观信息；</li>
<li>**嵌入空间索引：**每个块可基于层次化索引结构快速查询；</li>
<li>**可独立加载与剔除：**支持按需流式渲染。</li>
</ul>
<p>其价值直接对应三大工程痛点：</p>
<ul>
<li>**突破网络瓶颈：**避免一次性传输GB级文件，实现“所见即所传”；</li>
<li>**缓解显存压力：**运行时仅驻留视域内数据，内存占用降低90%以上；</li>
<li>**消除加载卡顿：**小块并行预加载，首屏渲染从分钟级缩短至秒级。</li>
</ul>
<h3 data-id="heading-3">02.现有空间数据组织范式</h3>
<p>幸运的是，在智慧城市与高精地图等需求推动下，业界已发展出两类成熟的空间数据组织范式：</p>
<ul>
<li>**局部精细场景：**以Cesium 3D Tiles为代表，通过四叉树/八叉树构建带LOD的tile树，结合视锥剔除与屏幕空间误差(SSE)实现高效调度；</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30678ed313b84d689dd533fa1cc10a7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768096475&amp;x-signature=UyJOYl%2BLBXcL2mqbINqDsndxTLg%3D" alt="" loading="lazy"/></p>
<p><em>3D Tiles结构树</em></p>
<ul>
<li>**全球尺度覆盖：**采用 全球地理瓦片体系(如北斗网格、Google S2、Uber H3或OGC全球瓦片规范)，将地球表面划分为多层级规则网格，支持跨城市甚至全球范围的无缝索引。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d85d4fff9ab44829da056eca4ab8b99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768096475&amp;x-signature=mabI%2BgIbOfNZky3dlovAFHKWWfM%3D" alt="" loading="lazy"/></p>
<p><em>基于瓦片的地图组织方式</em></p>
<p>这些框架的共同优势在于<strong>与底层几何表示解耦</strong>：只要将数据按空间区域分块，并提供对应的包围体或地理边界，无论是三角网格、激光点云，还是3DGS中的高斯椭球，均可接入统一的索引与调度体系，为大规模3DGS的流式服务奠定基础。</p>
<h2 data-id="heading-4">多细节层次：给模型做"智能瘦身"，远近皆宜</h2>
<h3 data-id="heading-5">01.分多细节层次构建的必要性</h3>
<p>多细节层次(Level of Detail, LOD)的核心思想是 “近处精细、远处简化” ——根据相机距离与视觉贡献动态调整模型复杂度，避免将宝贵算力浪费在人眼无法感知的细节上。</p>
<p>对于3DGS而言，若全场景统一使用最高精度，将面临两大关键挑战：</p>
<ul>
<li>**视觉冗余：**远处高斯点密度过高，但单个点在屏幕上的覆盖率极低，人眼难以分辨；</li>
<li>**计算浪费：**大量远端高斯仍参与光栅化，却仅贡献零星像素，严重拖累渲染帧率。</li>
</ul>
<p>因此，构建高效的LOD体系，成为大规模3DGS流式服务的关键一环。</p>
<h3 data-id="heading-6">02.现有技术盘点：合并与抽稀</h3>
<p><strong><em>1. 高斯椭球合并</em></strong></p>
<p>这是目前较为主流的层次化压缩思路。其核心是将<strong>空间邻近、视觉相似</strong>的一组高斯椭球，<strong>融合为一个更具代表性的综合椭球</strong>，在视觉影响尽可能小的前提下显著降低数据密度。</p>
<ul>
<li>
<p>**融合逻辑：**不仅考虑位置、尺寸，还兼顾颜色、协方差方向与不透明度的一致性，确保合并后的椭球能有效“代理”原始群体的辐射贡献；</p>
</li>
<li>
<p><strong>优势：<strong>合并通过</strong>参数重拟合</strong>，在减少数量的同时保留了区域整体的光度与几何特征，更适合处理高斯密集、纹理连续的区域。</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/647f95b6a20e4da89b5c017595dfa9c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768096475&amp;x-signature=aAIC8SAKP65A2n2XyI80hEFF9lo%3D" alt="" loading="lazy"/></p>
<p><em>高斯椭球合并示意图（AHierarchical 3D Gaussian Representation for Real-Time Rendering of Very Large Datasets）</em></p>
<p><strong><em>2. 结构化抽稀</em></strong></p>
<p>不同于“以合代简”的思路，结构化抽稀采用重要性驱动的剪枝策略，通过评估每个高斯点对最终图像的贡献度，有选择地移除冗余项。</p>
<ul>
<li>**评估指标：**基于梯度、透明度、视距贡献度给每个高斯点评分；</li>
<li>**动态裁剪：**移除低分冗余点，保留视觉关键特征；</li>
<li>**优势：**在相同压缩率下，<strong>结构信息保留更完整</strong>，建筑边缘更清晰。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a7bb9950b444234bbf0c26e7bcd90ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768096475&amp;x-signature=kSu4Nj7ozjZZOkmMq%2B94uYpgK54%3D" alt="" loading="lazy"/></p>
<p><em>重要性驱动的3DGS剪枝示意图（LightGaussian: Unbounded 3D Gaussian Compression with 15x Reduction and 200+ FPS）</em></p>
<h2 data-id="heading-7">Mapmost高斯泼溅建模平台：一键发布，高效服务</h2>
<p>在可离线部署的<strong>Mapmost高斯泼溅建模平台</strong>，让超大规模3DGS场景的服务化发布变得前所未有的轻松——只需一次点击，让专业级3D应用触手可及。</p>
<p>平台核心能力包括：</p>
<ul>
<li>**统一空间索引：**基于地理一致的分块体系，支持跨区域场景无缝集成；</li>
<li>**自动LOD构建：**根据场景内容智能生成多级细节层次，兼顾视觉质量与运行效率；</li>
<li>**全链路优化：**从上传、处理到在线服务，实现分钟级发布与秒级加载。</li>
</ul>
<p>无需手动切块、调参或部署服务，<strong>Mapmost</strong>让超大规模3DGS真正“开箱即用”。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a73d80a888b45f5a548434460ecc569~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768096475&amp;x-signature=9KszEbylBkQSA6eDIU70BnnqFg0%3D" alt="" loading="lazy"/></p>
<p><em>离线版建模平台服务发布参数设置</em></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7de6a5f2fee64f5db3d5031bf0b202dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768096475&amp;x-signature=eBIKM3YbeXi9301eGITaSN4Hx1s%3D" alt="" loading="lazy"/></p>
<p><em>Mapmost SDK for WebGL 100km²大地理范围3DGS模型渲染</em></p>
<p>申请试用，请至<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.mapmost.com%2F%23%2F" target="_blank" title="https://www.mapmost.com/#/" ref="nofollow noopener noreferrer">Mapmost</a>官网联系客服</p>
<p><strong>Mapmost 3DGS Builder在线体验版已上线~</strong></p>
<p><strong>欢迎体验:</strong> <a href="https://link.juejin.cn?target=studio.mapmost.com%2F3dgs" target="_blank" title="studio.mapmost.com/3dgs" ref="nofollow noopener noreferrer">studio.mapmost.com/3dgs</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c970b8d47c8346128320dded0559885c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768096475&amp;x-signature=M59CL9OIH9Mz5%2FhNN5A9%2FGH01GI%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ng老狗的Vue 3 响应式系统源码分享]]></title>    <link>https://juejin.cn/post/7590654280900362283</link>    <guid>https://juejin.cn/post/7590654280900362283</guid>    <pubDate>2026-01-03T14:21:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590654280900362283" data-draft-id="7590330924001345599" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ng老狗的Vue 3 响应式系统源码分享"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2026-01-03T14:21:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="TTt102207"/> <meta itemprop="url" content="https://juejin.cn/user/3843548383283469"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ng老狗的Vue 3 响应式系统源码分享
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3843548383283469/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    TTt102207
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T14:21:26.000Z" title="Sat Jan 03 2026 14:21:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    16
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Ng老狗的Vue 3 响应式系统笔记</h2>
<p>响应式库 @vue/reactivity 学习记录</p>
<h3 data-id="heading-1">背景</h3>
<blockquote>
<p>作为一个多年Angular应用的开发者，提到响应式，第一反应就是Rxjs。</p>
</blockquote>
<p>相比于Promise的命令式编程分散的信号源，
Rxjs的声明式响应数据流，在 <strong>用户事件多样且频繁的组件</strong> 中，能更优雅地处理异步数据流，往往 <strong>一个Observable就能完整的体现整个数据流</strong> 。</p>
<blockquote>
<p>初见Vue 3的响应式，是一种既熟悉有新鲜的感觉。</p>
</blockquote>
<p>我不再需要各种各样的<code>Observable</code>, <code>Subject</code>, <code>BehaviorSubject</code> 来表达数据流，
而是通过简单的<code>ref</code>和<code>reactive</code>就能创建响应式数据;
我也不需要去订阅和取消订阅数据流，
Vue 3的响应式系统会 <strong>自动追踪依赖</strong>，并在数据变化时更新。</p>
<blockquote>
<p>响应式亦有不同</p>
</blockquote>
<p>诚然，Rxjs是一个强大的响应式编程库，适用于复杂的异步数据流处理，
而Vue 3的响应式系统更专注于UI层的数据绑定和状态管理，
在前端开发中，提供了极其便捷和高效的响应式编程体验。</p>
<p>Ps: Angular 16也引入了类似Vue 3的响应式系统，称为Signals。</p>
<h3 data-id="heading-2">基础概念</h3>
<blockquote>
<p>ref 和 reactive 对比 Observable</p>
</blockquote>
<p>reactivity中最重要的无疑是 <code>ref</code> 和 <code>reactive</code>，
他们类似 <code>Rxjs</code> 中的 <code>BehaviorSubject</code>,
用于收集下游事件，并在更新时 <strong>广播</strong> 订阅者。</p>
<p>而 <code>effect</code>, <code>computed</code> 则完成了响应式数据流的蜕变，
<strong>自动的依赖收集和触发</strong>，彻底摆脱了手动订阅和取消订阅的繁琐。</p>
<p>以自动加法，举一个栗子：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/************* <span class="hljs-doctag">@vue</span>/reactivity ***************/</span>
<span class="hljs-keyword">import</span> { ref, reactive, computed, effect } <span class="hljs-keyword">from</span> <span class="hljs-string">'@vue/reactivity'</span>;
<span class="hljs-keyword">const</span> a = <span class="hljs-title function_">ref</span>(<span class="hljs-number">1</span>);
<span class="hljs-keyword">const</span> b = <span class="hljs-title function_">ref</span>(<span class="hljs-number">2</span>);
<span class="hljs-comment">// 响应式数据流</span>
<span class="hljs-keyword">const</span> sum = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> a.<span class="hljs-property">value</span> + b.<span class="hljs-property">value</span>);
<span class="hljs-comment">// 触发</span>
a.<span class="hljs-property">value</span> = <span class="hljs-number">3</span>;

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(sum.<span class="hljs-property">value</span>); <span class="hljs-comment">// 3 + 2 = 5</span>

<span class="hljs-comment">/************* Rxjs **************************/</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">BehaviorSubject</span>, combineLatest } <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs'</span>;
<span class="hljs-keyword">import</span> { map } <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;
<span class="hljs-keyword">const</span> a$ = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BehaviorSubject</span>(<span class="hljs-number">1</span>);
<span class="hljs-keyword">const</span> b$ = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BehaviorSubject</span>(<span class="hljs-number">2</span>);
<span class="hljs-keyword">const</span> sum$ = <span class="hljs-title function_">combineLatest</span>([a$, b$]).<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">[a, b]</span>) =&gt;</span> a + b)
);

<span class="hljs-comment">// 触发</span>
a$.<span class="hljs-title function_">next</span>(<span class="hljs-number">3</span>);
<span class="hljs-comment">// 特别的数据流只有在订阅时, 才会触发上游计算</span>
sum$.<span class="hljs-title function_">subscribe</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">log</span>); <span class="hljs-comment">// 3 + 2 = 5</span>
</code></pre>
<h3 data-id="heading-3">源码阅读</h3>
<p>响应式系统的源码并不复杂，核心部分大约几百行代码。
主要包括以下几个模块：</p>
<ul>
<li>响应式数据创建：<code>ref</code>和<code>reactive</code>函数</li>
<li>依赖收集和触发：<code>effect</code>函数</li>
<li>计算属性：<code>computed</code>函数</li>
<li>响应式数据的代理和拦截：<code>Proxy</code>对象</li>
<li>响应式数据的只读和深度响应式：<code>readonly</code>和<code>shallowReactive</code>函数
...等等</li>
</ul>
<p>其中，依赖收集和触发是响应式系统的核心</p>
<h4 data-id="heading-4">一、依赖收集</h4>
<ul>
<li>看懂 <code>effect</code>，就基本了解依赖收集的核心原理</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">//  例如：</span>
<span class="hljs-keyword">import</span> { effect, ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'@vue/reactivity'</span>;
<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>);
<span class="hljs-title function_">effect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`count is: <span class="hljs-subst">${count.value}</span>`</span>);
});
</code></pre>
<p>在这里如果把 <code>.value</code> 不要看作字段的取值，而是看成 <code>.subscribe(currentEffect)</code> 方法的调用，整个事情就变得很清晰了。</p>
<p>我只需要在 <code>effect</code> 的函数中执行时，
添加一个 <strong>currentEffect的全局变量</strong> ，作为上下文，
每次 <code>.subscribe()</code> 的时候，把这个上下文添加到依赖列表中, 就很方便地完成了依赖收集。</p>
<p><code>computed</code> 和 <code>watch</code> 也是类似的原理。</p>
<h4 data-id="heading-5">二、依赖触发</h4>
<p>由于值更新的场景更灵活，依赖触发的设计也就更加复杂些。</p>
<p>Vue中按照 <code>基本数据类型</code> 和 <code>对象类型</code> 分别处理。<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvuejs%2Fcore%2Fblob%2Faac7e1898907445c8f89b22047a9bfcf0a6e91b8%2Fpackages%2Freactivity%2Fsrc%2Freactive.ts%23L421" target="_blank" title="https://github.com/vuejs/core/blob/aac7e1898907445c8f89b22047a9bfcf0a6e91b8/packages/reactivity/src/reactive.ts#L421" ref="nofollow noopener noreferrer">参考GitHub</a></p>
<ul>
<li>基本数据类型：直接在 <code>.value</code> 的 <code>setter</code> 中触发依赖 <a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">参考RefImpl</a></li>
<li>对象类型：通过 <code>Proxy</code> 的 <code>set</code> 拦截器触发依赖<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvuejs%2Fcore%2Fblob%2Faac7e1898907445c8f89b22047a9bfcf0a6e91b8%2Fpackages%2Freactivity%2Fsrc%2FbaseHandlers.ts%23L55" target="_blank" title="https://github.com/vuejs/core/blob/aac7e1898907445c8f89b22047a9bfcf0a6e91b8/packages/reactivity/src/baseHandlers.ts#L55" ref="nofollow noopener noreferrer">参考MutableReactiveHandler</a>。嵌套的对象会在 <code>get</code> 时递归地转换为响应式对象。<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvuejs%2Fcore%2Fblob%2Faac7e1898907445c8f89b22047a9bfcf0a6e91b8%2Fpackages%2Freactivity%2Fsrc%2FbaseHandlers.ts%23L126" target="_blank" title="https://github.com/vuejs/core/blob/aac7e1898907445c8f89b22047a9bfcf0a6e91b8/packages/reactivity/src/baseHandlers.ts#L126" ref="nofollow noopener noreferrer">参考BaseReactiveHandler</a></li>
</ul>
<p>当然，非必要的场景下，Vue 也提供了 <code>shallowReactive</code> 和 <code>shallowRef</code> 来创建浅响应式对象。</p>
<h4 data-id="heading-6">三、计算属性</h4>
<p>计算属性 <code>computed</code> 的实现也很巧妙。
它本质上是一个带有缓存的 <code>effect</code>。
当计算属性的依赖发生变化时，计算属性会重新计算值，
但只有在访问计算属性的值时才会触发重新计算。</p>
<p>这点和Rxjs中的 <code>shareReplay</code> 操作符有些类似。</p>
<h4 data-id="heading-7">四、总结</h4>
<p>通过阅读 <code>Vue 3</code> 响应式系统的源码，
对响应式编程的有了新的理解。</p>
<p>核心的依赖清单通过数组管理、 相似的触发逻辑
和响应式数据流的理念，等等保留了发布订阅的稳定设计。</p>
<p><code>Vue 3</code> 的响应式库，不拘泥于刻板的设计模式，
而是根据实际需求，灵活地设计了响应式数据的创建、依赖收集和触发机制，
从而实现了高效且易用的响应式编程体验。</p>
<p>Vue团队中Anthony Fu在<a href="https://link.juejin.cn?target=https%3A%2F%2Fantfu.me%2Fposts%2Fwatch-with-reactivity" target="_blank" title="https://antfu.me/posts/watch-with-reactivity" ref="nofollow noopener noreferrer">这篇文章</a>中对设计理念有更清晰的阐述，推荐一读。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[思维重构：为什么 Class Component 逐渐式微，而 Function Component 成为主流]]></title>    <link>https://juejin.cn/post/7590654281036890155</link>    <guid>https://juejin.cn/post/7590654281036890155</guid>    <pubDate>2026-01-03T15:21:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590654281036890155" data-draft-id="7590421489998282771" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="思维重构：为什么 Class Component 逐渐式微，而 Function Component 成为主流"/> <meta itemprop="keywords" content="React.js"/> <meta itemprop="datePublished" content="2026-01-03T15:21:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SakuraOnTheWay"/> <meta itemprop="url" content="https://juejin.cn/user/3035112839343709"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            思维重构：为什么 Class Component 逐渐式微，而 Function Component 成为主流
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3035112839343709/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SakuraOnTheWay
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T15:21:58.000Z" title="Sat Jan 03 2026 15:21:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在 <code>React 16.8</code> 发布 <code>Hooks</code> 以来， <code>class</code> 关键字在新建的项目中逐渐销声匿迹，取而代之的是更加简洁、轻量的 <code>Function Components</code>。</p>
<p>很多人认为这只是一次语法层面的“升级”——把 <code>render</code> 函数拆出来，把 <code>this.state</code> 换成 <code>useState</code>，一切就万事大吉了。</p>
<p>但事实并非如此。</p>
<p>如果你带着写 <code>Class</code> 组件的惯性思维（<code>Lifecycle Thinking</code>）去写 <code>Hooks</code>，你很快就会撞上一堵墙：无限循环的请求、过期的闭包变量（<code>Stale Closures</code>）、以及那个越写越长、让人望而生畏的 <code>useEffect</code> 依赖数组。</p>
<p>从 <code>Class</code> 到 <code>Function</code>，本质上不是语法的改变，而是心智模型（<code>Mental Model</code>）的重构：我们正在从“面向对象与生命周期”转向“函数式与逻辑聚合”。</p>
<p>在这篇文章中，我们将通过一个具体的 <code>WindowTracker</code> 案例，对比展示两种模式的本质差异；并且讨论如何避免 <code>useEffect</code> 陷阱。</p>
<h2 data-id="heading-1">1. 范式转移——从“生命周期”到“逻辑聚合”</h2>
<p>在 <code>Class</code> 组件时代，我们的代码组织方式是被 <code>React</code> 的<strong>生命周期方法（Lifecycle Methods）</strong> 强行切割的。为了说明这一点，我们来看一个经典的案例：<code>WindowTracker</code>（一个显示当前窗口宽度，并修改 <code>document.title</code> 的组件）。</p>
<h3 data-id="heading-2">1.1 Class Component：被割裂的逻辑</h3>
<p>我们先看看在<code>Class</code>组件中，这个需求是如何实现的</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowTracker</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">props</span>) {
    <span class="hljs-variable language_">super</span>(props);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = { <span class="hljs-attr">width</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> };
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleResize</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleResize</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>);
  }

  <span class="hljs-title function_">componentDidMount</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 🔴 逻辑 A 的开始：订阅事件</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleResize</span>);
    <span class="hljs-comment">// 🔵 逻辑 B 的开始：更新标题 --- 首次挂载</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">title</span> = <span class="hljs-string">`Width: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.state.width}</span>`</span>;
  }

  <span class="hljs-comment">// 🔵 逻辑 B 的重复：更新标题 --- state更新</span>
  <span class="hljs-title function_">componentDidUpdate</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">title</span> = <span class="hljs-string">`Width: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.state.width}</span>`</span>;
  }

  <span class="hljs-comment">// 🔴 逻辑 A 的结束：取消订阅</span>
  <span class="hljs-title function_">componentWillUnmount</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'resize'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleResize</span>);
  }

  <span class="hljs-title function_">handleResize</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>({ <span class="hljs-attr">width</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> });
  }

  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Current Width: {this.state.width}px<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  }
}
</code></pre>
<p>观察代码，你会发现<strong>相关的逻辑被强行拆分了</strong>，如果你想修改“更新标题”的逻辑，你必须同时修改 <code>DidMount</code> 和 <code>DidUpdate</code> 的代码。</p>
<p>这种 <strong>“关注点分离”（Scattered Concerns）</strong> 是导致大型 <code>Class</code> 组件难以维护的元凶。</p>
<h3 data-id="heading-3">1.2 Function Component： 逻辑的自然聚合 (Co-location)</h3>
<p><code>Hooks</code> 的出现，让我们得以按照<strong>代码的用途</strong>，而不是代码执行的时间点来组织逻辑。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">WindowTracker</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [width, setWidth] = <span class="hljs-title function_">useState</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>);

  <span class="hljs-comment">// 🔴 逻辑 A：完整的窗口订阅逻辑</span>
  <span class="hljs-comment">// 订阅和取消订阅在一起，像一个独立的单元</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleResize</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-title function_">setWidth</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>);
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, handleResize);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'resize'</span>, handleResize);
  }, []);

  <span class="hljs-comment">// 🔵 逻辑 B：完整的标题同步逻辑</span>
  <span class="hljs-comment">// 只要 width 变了，我就执行，不需要关心是 Mount 还是 Update</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">title</span> = <span class="hljs-string">`Width: <span class="hljs-subst">${width}</span>`</span>;
  }, [width]);

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Current Width: {width}px<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p>核心优势： 这就是 <code>Co-location</code>（同地协作）。我们不再思考“这个组件挂载了吗？”，我们思考的是“这个副作用依赖什么数据？”</p>
<h3 data-id="heading-4">1.3 自定义 Hook ：逻辑复用</h3>
<p>既然逻辑 A 已经聚合在一起了，我们就可以把提取一个自定义<code>hooks</code>出来以供服用：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// hooks/useWindowWidth.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useWindowWidth</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [width, setWidth] = <span class="hljs-title function_">useState</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>);
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleResize</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-title function_">setWidth</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>);
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, handleResize);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'resize'</span>, handleResize);
  }, []);
  <span class="hljs-keyword">return</span> width;
}

<span class="hljs-comment">// 组件代码缩减为：</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">WindowTracker</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> width = <span class="hljs-title function_">useWindowWidth</span>(); <span class="hljs-comment">// ✅ 逻辑复用，极度简洁</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-variable language_">document</span>.<span class="hljs-property">title</span> = <span class="hljs-string">`Width: <span class="hljs-subst">${width}</span>`</span>; }, [width]);
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Current Width: {width}px<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<h2 data-id="heading-5">2. 谨防Effect陷阱</h2>
<p>当你开始享受 <code>Function Component</code> 的简洁时，很快就会遇到新的挑战：<code>useEffect</code> 并不是 <code>componentDidMount</code> 的简单替代品。如果你还带着命令式的思维，你一定会掉进坑里。</p>
<h3 data-id="heading-6">2.1 陷阱一：闭包陷阱 (Stale Closures)</h3>
<p>新手最容易犯的错误，就是以为 <code>Effect</code> 里的变量会自动更新。</p>
<p>❌ 错误示范：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count); <span class="hljs-comment">// 永远打印 0！</span>
      <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>); <span class="hljs-comment">// 永远重置为 1</span>
    }, <span class="hljs-number">1000</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(id);
  }, []); <span class="hljs-comment">// 依赖为空，Effect 只运行一次</span>
}
</code></pre>
<p><code>JavaScript</code> 的闭包机制导致 <code>setInterval</code> 内部引用的 <code>count</code> 永远是第一次渲染时的那个值 <code>(0）</code>。它被“冻结”在过去的时间里了。</p>
<p>✅ 修正方案：函数式更新 我们不需要依赖当前的 <code>count</code>，而是告诉 <code>React</code> 如何计算下一个状态：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prevCount</span> =&gt;</span> prevCount + <span class="hljs-number">1</span>); <span class="hljs-comment">// ✅ 不需要依赖外部的 count 变量</span>
</code></pre>
<blockquote>
<p>这不仅仅是 React 的特性。
如果你用过 Jotai、Zustand 或 Redux，你会发现这种<strong>控制反转 (Inversion of Control)的设计模式</strong>无处不在。</p>
<p>在 Jotai 中，更新 Atom 时也是 set(atom, prev =&gt; prev + 1)。</p>
<p>在 Redux 中，Reducer 的 (state, action) =&gt; newState 也是同样的道理。</p>
</blockquote>
<h3 data-id="heading-7">2.2 陷阱二：依赖地狱 (Dependency Hell)</h3>
<p>随着业务逻辑变复杂，你的依赖数组可能会变得非常长：<code>[user, settings, history, socket, theme...]</code>。任何一个变量微小的变动，都会导致整个 <code>Effect</code> 重新执行。</p>
<p>面对“依赖地狱”，我们需要用三大原则进行逻辑拆解：</p>
<h4 data-id="heading-8">原则 A：按职责拆分 (Split by Concern)</h4>
<p>不要把所有逻辑塞进一个 <code>Effect</code>。</p>
<p>如果一个 <code>Effect</code> 既负责“埋点上报”又负责“连接 <code>WebSocket</code>”，请把它们拆成两个 <code>useEffect</code>。</p>
<h4 data-id="heading-9">原则 B：区分“事件”与“副作用” (Events vs Effects)</h4>
<p>这是最重要的原则。不要为了获取最新值，就把逻辑塞进 <code>Effect</code>。</p>
<p>❌ <strong>错误：</strong> 用户点击按钮提交，但我需要在 <code>Effect</code> 里监听 <code>isSubmitting</code> 状态来发送请求，导致不得不把所有表单数据加入依赖。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">LoginForm</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [text, setText] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">const</span> [isSubmitting, setIsSubmitting] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-comment">// ❌ 错误：滥用 Effect 处理交互</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 只有当开关被打开时，才发送请求</span>
    <span class="hljs-keyword">if</span> (isSubmitting) {
      <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">postData</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">login</span>(text);
        <span class="hljs-title function_">setIsSubmitting</span>(<span class="hljs-literal">false</span>); <span class="hljs-comment">// 请求完把开关关掉</span>
      }
      <span class="hljs-title function_">postData</span>();
    }
  }, [isSubmitting, text]); <span class="hljs-comment">// sos灾难：不得不把 text 也加入依赖！</span>

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 点击按钮时不直接发送，而是去拨动开关</span>
    <span class="hljs-title function_">setIsSubmitting</span>(<span class="hljs-literal">true</span>);
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{text}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> setText(e.target.value)} /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleSubmit}</span>&gt;</span>登录<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span>
  );
}
</code></pre>
<p>✅ <strong>正确：</strong> 回到最朴素的编程思维-“用户点击时，发送请求”。在 <code>onClick</code> 事件处理函数中直接读取 <code>State</code> 发送请求。<code>Effect</code> 应该只用于同步（比如根据 <code>ID</code> 获取数据），而不是用于处理交互。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">LoginForm</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [text, setText] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
  <span class="hljs-comment">// 不需要 isSubmitting 这个状态来做触发器（虽然可以用它来控制 Loading UI）</span>

  <span class="hljs-comment">// ✅ 正确：事件处理函数包含所有逻辑</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 1. 直接在这里读取最新的 state</span>
    <span class="hljs-comment">// 这里读取 text 不需要经过依赖数组，它是直接可用的</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'正在提交:'</span>, text);
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">login</span>(text);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'成功'</span>);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(e);
    }
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{text}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> setText(e.target.value)} /&gt;
      {/* 直接绑定事件处理函数 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleSubmit}</span>&gt;</span>登录<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-10">原则 C：使用 <code>Ref</code> 保持“沉默” (<code>Escape Hatch</code>)</h4>
<p>有时你确实需要在 <code>Effect</code> 中读取一个最新值，但不希望这个值的变化触发 <code>Effect</code> 重新执行。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 场景：聊天室连接后，记录当前的 theme，但切换 theme 不应该导致重连</span>
<span class="hljs-keyword">const</span> themeRef = <span class="hljs-title function_">useRef</span>(theme);

<span class="hljs-comment">// 保持 Ref 最新</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  themeRef.<span class="hljs-property">current</span> = theme;
});

<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>();
  connection.<span class="hljs-title function_">on</span>(<span class="hljs-string">'connected'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// ✅ 读取最新 theme，但不需要将 theme 加入依赖数组</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Connected with theme:'</span>, themeRef.<span class="hljs-property">current</span>);
  });
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> connection.<span class="hljs-title function_">disconnect</span>();
}, []); <span class="hljs-comment">// 只有挂载时连接一次</span>
</code></pre>
<h2 data-id="heading-11">结语：构建以“依赖”为核心的心智模型</h2>
<p>从 <code>Class Component</code> 到 <code>Function Component</code> 的迁移，表面上是一次语法的精简，实则是一场心智模型的彻底重构。</p>
<p>在 <code>Class</code> 时代，我们习惯于命令式地控制时间：</p>
<blockquote>
<p>“在组件挂载时（DidMount）做这件事，在更新时（DidUpdate）做那件事。”</p>
</blockquote>
<p>而在 <code>Hooks</code> 时代，<code>React</code> 强迫我们转向声明式的数据流：</p>
<blockquote>
<p>“在这个副作用中，我依赖了这些数据（Dependencies）。每当数据变化，副作用自然随之流转。”</p>
</blockquote>
<h3 data-id="heading-12">Hooks 的代价：手动管理“闭包的新鲜度”</h3>
<p>在 <code>Class</code> 组件中，<code>this.state</code> 像是一个永远指向最新值的全局指针，你随时去读，它都是实时的。</p>
<p>但在 <code>Function</code> 组件中，由于闭包的存在，每一次渲染都是一次独立的快照，每个 <code>Effect</code> 内部持有的数据都可能是“过期”的。</p>
<p><code>React</code> 无法在运行时通过静态分析知道你的闭包里引用了哪些外部变量。因此，依赖数组<code>（Dependency Array）</code> 本质上是你与 <code>React</code> 之间签署的一份 “缓存失效协议”。</p>
<p>你必须显式告诉 <code>React</code>：“当 <code>userId</code> 变化时，上一次的 <code>Effect</code> 闭包已经失效了（因为它引用的是旧的 <code>userId</code>），请销毁它，并运行本次渲染产生的新 <code>Effect</code>。”</p>
<p>这种机制虽然增加了心智负担，但它强迫我们将副作用与数据状态进行严格的同步绑定，从根本上消除了 <code>Class</code> 组件中常见的“数据已变但逻辑未响应”的一致性 <code>Bug</code>。</p>
<h3 data-id="heading-13">获得的巨大回报</h3>
<p>当你适应了这种 <strong>“数据驱动依赖”</strong> 的思维方式后，你会发现一个全新的世界：</p>
<ol>
<li>
<p><strong>逻辑高度内聚：</strong> 相关的业务代码终于可以摆脱生命周期的撕裂，聚合在一起<code>（Co-location）</code>。</p>
</li>
<li>
<p><strong>复用的极致：</strong> 提取一个 <code>useWindowWidth</code> 或 <code>useForm</code> 变得像提取一个普通函数一样简单，逻辑复用不再需要高阶组件的嵌套。</p>
</li>
<li>
<p><strong>原子化的思维：</strong> 正如我们在对比 <code>Jotai</code> 时所发现的，通过函数式更新<code>（prev =&gt; prev + 1）</code>，我们将状态管理的控制权交还给了框架，代码变得更加稳健和可预测。</p>
</li>
<li>
<p><strong>React</strong> 的进化方向很明确：<code>UI</code> 只是数据的投影，而副作用只是数据变化的涟漪。</p>
</li>
</ol>
<h3 data-id="heading-14">你的下一步 (Call to Action)</h3>
<p>不要试图一次性重构整个项目。</p>
<p>下次当你需要修改一个复杂的 <code>Class</code> 组件时，试着不只是“修补”它，而是用 <code>Hooks</code> “重写” 它。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android与JS交互]]></title>    <link>https://juejin.cn/post/7590292192989298728</link>    <guid>https://juejin.cn/post/7590292192989298728</guid>    <pubDate>2026-01-03T13:43:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590292192989298728" data-draft-id="7590403249560895503" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android与JS交互"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2026-01-03T13:43:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="XRay"/> <meta itemprop="url" content="https://juejin.cn/user/3966693685869288"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android与JS交互
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3966693685869288/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    XRay
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T13:43:45.000Z" title="Sat Jan 03 2026 13:43:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="github">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 交互方式总结</h2>
<p>Android 调用 JS 代码的方法有 2 种：</p>
<ol>
<li>通过 WebView 的 loadUrl();</li>
<li>通过 WebView 的 evaluateJavascript();</li>
</ol>
<p>JS 调用 Android 代码的方法有 3 种：</p>
<ol>
<li>通过 WebView 的 addJavascriptInterface() 进行对象映射;</li>
<li>通过 WebViewClient 的 shouldOverrideUrlLoading() 方法回调拦截 url;</li>
<li>通过 WebChromeClient 的 onJsAlert()、onJsConfirm()、onJsPrompt() 方法回调拦截 JS 对话框的alert()、confirm()、prompt() 消息;</li>
</ol>
<p>二者沟通的桥梁是 WebView。</p>
<h2 data-id="heading-1">2. Android 调用 JS 代码</h2>
<h3 data-id="heading-2">2.1 通过 WebView 的 loadUrl()</h3>
<p>需要加载的 html 文件——javascript.html，把该文件放到 assets 目录下。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>JS Interaction<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
        This is a Web View
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">callJS</span>(<span class="hljs-params"/>){
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Android 调用了 JS 的 callJS() 方法"</span>);
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>MainActivity.java:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.webviewtest;

<span class="hljs-keyword">import</span> android.os.Bundle;
<span class="hljs-keyword">import</span> android.view.View;
<span class="hljs-keyword">import</span> android.webkit.WebSettings;
<span class="hljs-keyword">import</span> android.webkit.WebView;
<span class="hljs-keyword">import</span> android.widget.Button;
<span class="hljs-keyword">import</span> androidx.appcompat.app.AppCompatActivity;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        <span class="hljs-type">WebView</span> <span class="hljs-variable">mWebView</span> <span class="hljs-operator">=</span> findViewById(R.id.webview);

        <span class="hljs-type">WebSettings</span> <span class="hljs-variable">webSettings</span> <span class="hljs-operator">=</span> mWebView.getSettings();

        <span class="hljs-comment">// 允许在 WebView 中执行 JS</span>
        webSettings.setJavaScriptEnabled(<span class="hljs-literal">true</span>);
        <span class="hljs-comment">// 载入 url</span>
        mWebView.loadUrl(<span class="hljs-string">"file:///android_asset/javascript.html"</span>);

        <span class="hljs-type">Button</span> <span class="hljs-variable">button</span> <span class="hljs-operator">=</span> findViewById(R.id.button);
        button.setOnClickListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">View</span>.OnClickListener() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">(View v)</span> {
                <span class="hljs-comment">// 调用 JS 的 callJS() 方法</span>
                mWebView.loadUrl(<span class="hljs-string">"javascript:callJS()"</span>);
            }
        });
    }
}
</code></pre>
<p>activity_main.xml:</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">RelativeLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">WebView</span>
        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/webview"</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"300dp"</span>/&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/button"</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:text</span>=<span class="hljs-string">"Call JS"</span>
        <span class="hljs-attr">android:textAllCaps</span>=<span class="hljs-string">"false"</span>
        <span class="hljs-attr">android:layout_below</span>=<span class="hljs-string">"@+id/webview"</span>
        <span class="hljs-attr">android:layout_marginTop</span>=<span class="hljs-string">"10dp"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">RelativeLayout</span>&gt;</span>
</code></pre>
<p>这里直接通过 WebView 的 loadUrl() 方法传入字符串 javascript:callJS() 即可调用 JS 中的 callJS() 方法，但是 loadUrl() 会使页面刷新，并且该方法拿不到 JS 的返回值。</p>
<h3 data-id="heading-3">2.2 通过 WebView 的 evaluateJavascript()</h3>
<p>该方法与第一种方法的区别是：</p>
<ol>
<li>该方法比第一种方法执行效率更高，因为该方法的执行不会使页面刷新；</li>
<li>该方法在 Android 4.4 及以后才可以使用；</li>
<li>该方法可以拿到 JS 的返回值；</li>
</ol>
<p>把第一种方法中的 JS 改成下面这样：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>JS Interaction<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
        This is a Web View
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">callJS</span>(<span class="hljs-params"/>){
            <span class="hljs-keyword">return</span> <span class="hljs-string">"Android 调用了 JS 的 callJS() 方法"</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>MainActivity.java 修改如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.webviewtest;

<span class="hljs-keyword">import</span> android.app.AlertDialog;
<span class="hljs-keyword">import</span> android.content.DialogInterface;
<span class="hljs-keyword">import</span> android.os.Bundle;
<span class="hljs-keyword">import</span> android.view.View;
<span class="hljs-keyword">import</span> android.webkit.ValueCallback;
<span class="hljs-keyword">import</span> android.webkit.WebSettings;
<span class="hljs-keyword">import</span> android.webkit.WebView;
<span class="hljs-keyword">import</span> android.widget.Button;

<span class="hljs-keyword">import</span> androidx.appcompat.app.AppCompatActivity;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        <span class="hljs-type">WebView</span> <span class="hljs-variable">mWebView</span> <span class="hljs-operator">=</span> findViewById(R.id.webview);

        <span class="hljs-type">WebSettings</span> <span class="hljs-variable">webSettings</span> <span class="hljs-operator">=</span> mWebView.getSettings();

        webSettings.setJavaScriptEnabled(<span class="hljs-literal">true</span>);

        mWebView.loadUrl(<span class="hljs-string">"file:///android_asset/javascript.html"</span>);

        <span class="hljs-type">Button</span> <span class="hljs-variable">button</span> <span class="hljs-operator">=</span> findViewById(R.id.button);

        button.setOnClickListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">View</span>.OnClickListener() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">(View v)</span> {

                mWebView.evaluateJavascript(<span class="hljs-string">"javascript:callJS()"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValueCallback</span>&lt;String&gt;() {
                    <span class="hljs-meta">@Override</span>
                    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceiveValue</span><span class="hljs-params">(String value)</span> {
                        <span class="hljs-comment">// values 是 JS 的返回</span>

                        <span class="hljs-comment">// evaluateJavascript() 方法返回的值会被封装成一个 JSON 格式的字符串，</span>
                        <span class="hljs-comment">// 如果 JS 函数返回 "Hello from JavaScript!"，</span>
                        <span class="hljs-comment">// Android 端会接收到 "\"Hello from JavaScript!"\" 这样的结果,</span>
                        <span class="hljs-comment">// 所以需要转换</span>
                        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> value != <span class="hljs-literal">null</span> ? value.replace(<span class="hljs-string">"\""</span>, <span class="hljs-string">""</span>) : <span class="hljs-string">""</span>;
                        AlertDialog.<span class="hljs-type">Builder</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AlertDialog</span>.Builder(MainActivity.<span class="hljs-built_in">this</span>);
                        b.setTitle(<span class="hljs-string">"Alert"</span>);
                        b.setMessage(result);
                        b.setPositiveButton(android.R.string.ok, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DialogInterface</span>.OnClickListener() {
                            <span class="hljs-meta">@Override</span>
                            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">(DialogInterface dialog, <span class="hljs-type">int</span> which)</span> {
                                dialog.dismiss();
                            }
                        });
                        b.setCancelable(<span class="hljs-literal">false</span>);
                        b.create().show();
                    }
                });
            }
        });

    }
}
</code></pre>
<p>evaluateJavascript() 方法有两个参数，第一个参数是要执行的 JS 方法，第二个参数是 JS 执行后触发的回调，在这里可以拿到 JS 方法的返回值。</p>
<p>建议在 Android 4.4 以下使用第一种方法，Android 4.4 及以上使用第二种方法。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">version</span> <span class="hljs-operator">=</span> Build.VERSION.SDK_INT;
<span class="hljs-keyword">if</span> (version &lt; Build.VERSION_CODES.KITKAT) {
        mWebView.loadUrl(<span class="hljs-string">"javascript:callJS()"</span>);
    } <span class="hljs-keyword">else</span> {
        mWebView.evaluateJavascript(<span class="hljs-string">"javascript:callJS()"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValueCallback</span>&lt;String&gt;() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceiveValue</span><span class="hljs-params">(String value)</span> {

            }
        });
}
</code></pre>
<p>注意，我这里都是在点击事件中调用 JS 的代码，最好等 WebView 页面加载完，在在 WebViewClient 的 onPageFinished() 方法中调用 JS 的代码。</p>
<h3 data-id="heading-4">2.3 两种方法的对比</h3>























<table><thead><tr><th>调用方式</th><th>优点</th><th>缺点</th><th>使用建议</th></tr></thead><tbody><tr><td>loadUrl()</td><td>简单</td><td>执行效率低，获取返回值麻烦</td><td>Android 4.4 以下用这个方法</td></tr><tr><td>evaluateJavascript()</td><td>执行效率高</td><td>向下兼容性差（Android 4.4 以上可用）</td><td>Android 4.4 以上用这个方法</td></tr></tbody></table>
<h2 data-id="heading-5">3. JS 调用 Android 代码</h2>
<h3 data-id="heading-6">3.1 通过 WebView 的 addJavascriptInterface() 进行对象映射</h3>
<p>步骤 1 ：定义一个要注入到 JS 中的类：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.webviewtest;

<span class="hljs-keyword">import</span> android.webkit.JavascriptInterface;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JsObject</span> {

    <span class="hljs-comment">// 对于 Build.VERSION_CODES.JELLY_BEAN_MR1 及以上的版本，</span>
    <span class="hljs-comment">// 只有添加了 @JavascriptInterface 注解的 public 方法才能从 JavaScript 中访问</span>
    <span class="hljs-meta">@JavascriptInterface</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hello</span><span class="hljs-params">(String msg)</span> {
        System.out.println(<span class="hljs-string">" JS 调用了 Android 的 hello 方法"</span>);
    }
}
</code></pre>
<p>步骤 2 ：在 assets 目录下添加需要加载的 JS 代码：javascript.html</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>JS Interaction<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">callAndroid</span>(<span class="hljs-params"/>){
            <span class="hljs-comment">// 由于对象映射，所以调用 test 对象等于调用 Android 中的对象</span>
            test.<span class="hljs-title function_">hello</span>(<span class="hljs-string">"js调用了android中的hello方法"</span>);
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button1"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"callAndroid()"</span>&gt;</span>点击调用 Android 代码<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>步骤 3 ：在 Android 中通过 WebView 的 addJavascriptInterface() 方法将 Java 对象注入 WebView 中的 JavaScript。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.webviewtest;

<span class="hljs-keyword">import</span> android.os.Bundle;
<span class="hljs-keyword">import</span> android.webkit.WebSettings;
<span class="hljs-keyword">import</span> android.webkit.WebView;

<span class="hljs-keyword">import</span> androidx.appcompat.app.AppCompatActivity;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {

    WebView mWebView;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        mWebView = findViewById(R.id.webview);
        <span class="hljs-type">WebSettings</span> <span class="hljs-variable">webSettings</span> <span class="hljs-operator">=</span> mWebView.getSettings();

        webSettings.setJavaScriptEnabled(<span class="hljs-literal">true</span>);

        <span class="hljs-comment">// 通过 addJavascriptInterface() 方法将 Java 对象注入 WebView 中的 JavaScript</span>
        <span class="hljs-comment">// 参数1：注入的 Java 对象</span>
        <span class="hljs-comment">// 参数2：暴露在 JS 中对应的实例的名字</span>
        mWebView.addJavascriptInterface(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JsObject</span>(), <span class="hljs-string">"test"</span>);

        mWebView.loadUrl(<span class="hljs-string">"file:///android_asset/javascript.html"</span>);
    }
}
</code></pre>
<p>activity_main.xml:</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">RelativeLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">WebView</span>
        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/webview"</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>/&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">RelativeLayout</span>&gt;</span>
</code></pre>
<p>这样点击 html 中的 button 会调用 callAndroid() 方法，然后会调用 test 实例的 hello() 方法，相应会调用 JsObject 实例的 hello() 方法。</p>
<p>这个方法的优点是简单，缺点是存在安全漏洞。Google 在 Android 4.2 及以上的版本中规定对被调用的函数要以 @JavascriptInterface 进行注解从而避免漏洞攻击，在 Android 4.2 以下 @JavascriptInterface 是无效的，存在安全漏洞。在 Android 4.2 以下需要采用拦截 prompt() 的方式进行漏洞修复。</p>
<h3 data-id="heading-7">3.2 通过 WebViewClient 的 shouldOverrideUrlLoading() 方法拦截 url</h3>
<p>javascript.html:</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>JS Interaction<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">callAndroid</span>(<span class="hljs-params"/>){
            <span class="hljs-variable language_">document</span>.<span class="hljs-property">location</span> = <span class="hljs-string">"js://webview?arg1=111&amp;arg2=222"</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button1"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"callAndroid()"</span>&gt;</span>点击调用 Android 代码<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>MainActivity.java:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.webviewtest;

<span class="hljs-keyword">import</span> android.net.Uri;
<span class="hljs-keyword">import</span> android.os.Build;
<span class="hljs-keyword">import</span> android.os.Bundle;
<span class="hljs-keyword">import</span> android.util.Log;
<span class="hljs-keyword">import</span> android.webkit.WebResourceRequest;
<span class="hljs-keyword">import</span> android.webkit.WebSettings;
<span class="hljs-keyword">import</span> android.webkit.WebView;
<span class="hljs-keyword">import</span> android.webkit.WebViewClient;

<span class="hljs-keyword">import</span> androidx.appcompat.app.AppCompatActivity;

<span class="hljs-keyword">import</span> java.util.Set;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> MainActivity.class.getSimpleName();

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        <span class="hljs-type">WebView</span> <span class="hljs-variable">mWebView</span> <span class="hljs-operator">=</span> findViewById(R.id.webview);

        <span class="hljs-type">WebSettings</span> <span class="hljs-variable">webSettings</span> <span class="hljs-operator">=</span> mWebView.getSettings();

        webSettings.setJavaScriptEnabled(<span class="hljs-literal">true</span>);

        mWebView.loadUrl(<span class="hljs-string">"file:///android_asset/javascript.html"</span>);

        mWebView.setWebViewClient(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebViewClient</span>() {

            <span class="hljs-comment">//该重载方法不建议使用了，Android 7.0 以上已经摒弃了</span>
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">shouldOverrideUrlLoading</span><span class="hljs-params">(WebView view, String url)</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.shouldOverrideUrlLoading(view, url);
            }

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">shouldOverrideUrlLoading</span><span class="hljs-params">(WebView view, WebResourceRequest request)</span> {
                <span class="hljs-comment">// 传入进来的 url = "js://webview?arg1=111&amp;arg2=222"</span>
                Uri uri;
                <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {
                    uri = request.getUrl();
                } <span class="hljs-keyword">else</span> {
                    uri = Uri.parse(request.toString());
                }
                <span class="hljs-comment">// 先判断 scheme</span>
                <span class="hljs-keyword">if</span> (<span class="hljs-string">"js"</span>.equals(uri.getScheme())) {
                    <span class="hljs-comment">// 再判断 authority</span>
                    <span class="hljs-keyword">if</span> (<span class="hljs-string">"webview"</span>.equals(uri.getAuthority())) {

                        <span class="hljs-comment">// 执行对应的代码</span>
                        Log.d(TAG, <span class="hljs-string">"JS 调用了 Android 的方法"</span>);
                        Set&lt;String&gt; sets = uri.getQueryParameterNames();
                        <span class="hljs-keyword">for</span> (String key : sets) {
                            Log.d(TAG, <span class="hljs-string">"param:"</span> + uri.getQueryParameter(key));
                        }
                        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                    }
                }
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.shouldOverrideUrlLoading(view, request);
            }
        });
    }
}
</code></pre>
<p>原理就是通过解析 url 的协议调用相应的代码。</p>
<p>该方式的优点是不存在方式一的漏洞，缺点是如果 JS 想获取 Android 方法的返回值会比较麻烦。</p>
<p>如果 JS 想要拿到 Android 方法的返回值，只能通过 WebView 的 loadUrl() 去执行 JS 代码中的方法把返回值传递给 JS，代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Android：MainActivity.java</span>
mWebView.loadUrl(<span class="hljs-string">"javascript:returnResult("</span> + result + <span class="hljs-string">")"</span>);

<span class="hljs-comment">// JS：javascript.html</span>
function <span class="hljs-title function_">returnResult</span><span class="hljs-params">(result)</span>{
    alert(<span class="hljs-string">"result is"</span> + result);
}
</code></pre>
<h3 data-id="heading-8">3.3 通过 WebChromeClient 的 onJsAlert()、onJsConfirm()、onJsPrompt() 方法回调拦截</h3>
<p>在 JS 中，有三个常用的弹出对话框的方法：</p>
<ul>
<li>alert()，用于弹出警告框，没有返回值，在文本中加入 \n 可以换行；</li>
<li>confirm()，用于弹出确认框，有两个返回值，返回 true 表示点击了确认按钮，false 表示点击了取消按钮；</li>
<li>prompt()，用于弹出输入框，可以任意设置返回值，点击确认会返回输入框中的字符串，点击取消会返回 null；</li>
</ul>
<p>这 3 个方法分别会触发 WebChromeClient 的 onJsAlert()、onJsConfirm()、onJsPrompt() 方法。</p>
<p>最常用的是使用 JS 的 prompt() 方法，因为只有 prompt() 可以返回任意类型的值，看下面的示例：</p>
<p>javascript.html:</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>JS Interactiion<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">callPrompt</span>(<span class="hljs-params"/>){
            <span class="hljs-keyword">var</span> result = <span class="hljs-title function_">prompt</span>(<span class="hljs-string">"js://webview?arg1=8&amp;arg2=9"</span>);
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"result is:"</span> + result);
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button1"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"callPrompt()"</span>&gt;</span>点击调用 Android 代码<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>MainActivity.java:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.webviewtest;

<span class="hljs-keyword">import</span> android.net.Uri;
<span class="hljs-keyword">import</span> android.os.Bundle;
<span class="hljs-keyword">import</span> android.util.Log;
<span class="hljs-keyword">import</span> android.webkit.JsPromptResult;
<span class="hljs-keyword">import</span> android.webkit.WebChromeClient;
<span class="hljs-keyword">import</span> android.webkit.WebSettings;
<span class="hljs-keyword">import</span> android.webkit.WebView;

<span class="hljs-keyword">import</span> androidx.appcompat.app.AppCompatActivity;

<span class="hljs-keyword">import</span> java.util.Set;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> MainActivity.class.getSimpleName();

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        <span class="hljs-type">WebView</span> <span class="hljs-variable">mWebView</span> <span class="hljs-operator">=</span> findViewById(R.id.webview);

        <span class="hljs-type">WebSettings</span> <span class="hljs-variable">webSettings</span> <span class="hljs-operator">=</span> mWebView.getSettings();

        webSettings.setJavaScriptEnabled(<span class="hljs-literal">true</span>);

        mWebView.loadUrl(<span class="hljs-string">"file:///android_asset/javascript.html"</span>);

        mWebView.setWebChromeClient(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebChromeClient</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onJsPrompt</span><span class="hljs-params">(WebView view, String url, String message, String defaultValue, JsPromptResult result)</span> {
                <span class="hljs-comment">// 传入进来的 url = "js://webview?arg1=8&amp;arg2=9"</span>

                <span class="hljs-type">Uri</span> <span class="hljs-variable">uri</span> <span class="hljs-operator">=</span> Uri.parse(message);
                <span class="hljs-keyword">if</span> (uri.getScheme().equals(<span class="hljs-string">"js"</span>)) {

                    <span class="hljs-keyword">if</span> (uri.getAuthority().equals(<span class="hljs-string">"webview"</span>)) {

                        <span class="hljs-comment">// 执行对应的代码</span>
                        Log.d(TAG, <span class="hljs-string">"JS 调用了 Android 的方法"</span>);
                        Set&lt;String&gt; sets = uri.getQueryParameterNames();
                        <span class="hljs-keyword">for</span> (String key : sets) {
                            Log.d(TAG, <span class="hljs-string">"param:"</span> + uri.getQueryParameter(key));
                        }

                        <span class="hljs-comment">// JsPromptResult 用于把结果返回给 JS</span>
                        result.confirm(<span class="hljs-string">"JS 调用 Android 的方法成功啦！"</span>);
                    }
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                }
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.onJsPrompt(view, url, message, defaultValue, result);
            }
        });
    }
}
</code></pre>
<h3 data-id="heading-9">3.4 三种方法的对比</h3>





























<table><thead><tr><th>调用方式</th><th>优点</th><th>缺点</th><th>使用场景</th></tr></thead><tbody><tr><td>通过 WebView 的 addJavascriptInterface() 进行对象映射</td><td>简单</td><td>Android 4.2 以下存在漏洞</td><td>Android 4.2 以上用这个方法</td></tr><tr><td>通过 WebViewClient 的 shouldOverrideUrlLoading() 方法拦截 url</td><td>没有漏洞问题</td><td>相对复杂，需要解析 url</td><td>不需要 Android 端的方法的返回值的场景</td></tr><tr><td>通过 WebChromeClient 的 onJsAlert()、onJsConfirm()、onJsPrompt() 方法回调拦截</td><td>没有漏洞问题</td><td>相对复杂，需要解析 url</td><td>能满足大多数场景</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java学习第33天 - 微服务架构与云原生]]></title>    <link>https://juejin.cn/post/7590597231708241955</link>    <guid>https://juejin.cn/post/7590597231708241955</guid>    <pubDate>2026-01-04T01:53:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590597231708241955" data-draft-id="7590403249561550863" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java学习第33天 - 微服务架构与云原生"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-04T01:53:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="浮游本尊"/> <meta itemprop="url" content="https://juejin.cn/user/2533726710668696"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java学习第33天 - 微服务架构与云原生
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2533726710668696/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    浮游本尊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T01:53:44.000Z" title="Sun Jan 04 2026 01:53:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">学习目标</h2>
<p>深入理解微服务架构设计，掌握云原生技术栈，学习系统设计方法，准备技术面试，了解新技术趋势，完成项目实战。</p>
<hr/>
<h2 data-id="heading-1">1. 微服务架构深入</h2>
<h3 data-id="heading-2">1.1 服务注册与发现</h3>
<p><strong>Eureka服务注册中心：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Eureka Server配置</span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableEurekaServer</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EurekaServerApplication</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(EurekaServerApplication.class, args);
    }
}

<span class="hljs-comment">// Eureka Server配置类</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EurekaServerConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> EurekaInstanceConfigBean <span class="hljs-title function_">eurekaInstanceConfig</span><span class="hljs-params">()</span> {
        <span class="hljs-type">EurekaInstanceConfigBean</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EurekaInstanceConfigBean</span>();
        config.setHostname(<span class="hljs-string">"localhost"</span>);
        config.setInstanceId(<span class="hljs-string">"eureka-server"</span>);
        config.setLeaseRenewalIntervalInSeconds(<span class="hljs-number">30</span>);
        config.setLeaseExpirationDurationInSeconds(<span class="hljs-number">90</span>);
        <span class="hljs-keyword">return</span> config;
    }
}

<span class="hljs-comment">// Eureka Client配置</span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableEurekaClient</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderServiceApplication</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(OrderServiceApplication.class, args);
    }
}

<span class="hljs-comment">// Eureka Client配置类</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EurekaClientConfig</span> {
    
    <span class="hljs-meta">@Value("${eureka.instance.hostname}")</span>
    <span class="hljs-keyword">private</span> String hostname;
    
    <span class="hljs-meta">@Value("${server.port}")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> port;
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> EurekaInstanceConfigBean <span class="hljs-title function_">eurekaInstanceConfig</span><span class="hljs-params">()</span> {
        <span class="hljs-type">EurekaInstanceConfigBean</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EurekaInstanceConfigBean</span>();
        config.setHostname(hostname);
        config.setInstanceId(hostname + <span class="hljs-string">":"</span> + port);
        config.setLeaseRenewalIntervalInSeconds(<span class="hljs-number">30</span>);
        config.setLeaseExpirationDurationInSeconds(<span class="hljs-number">90</span>);
        
        <span class="hljs-comment">// 健康检查配置</span>
        Map&lt;String, String&gt; metadataMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        metadataMap.put(<span class="hljs-string">"management.port"</span>, String.valueOf(port));
        config.setMetadataMap(metadataMap);
        
        <span class="hljs-keyword">return</span> config;
    }
}

<span class="hljs-comment">// 服务发现客户端</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceDiscoveryClient</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> DiscoveryClient discoveryClient;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RestTemplate restTemplate;
    
    <span class="hljs-comment">// 获取服务实例</span>
    <span class="hljs-keyword">public</span> List&lt;ServiceInstance&gt; <span class="hljs-title function_">getServiceInstances</span><span class="hljs-params">(String serviceName)</span> {
        <span class="hljs-keyword">return</span> discoveryClient.getInstances(serviceName);
    }
    
    <span class="hljs-comment">// 负载均衡调用服务</span>
    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">callService</span><span class="hljs-params">(String serviceName, String path, Class&lt;T&gt; responseType)</span> {
        List&lt;ServiceInstance&gt; instances = getServiceInstances(serviceName);
        
        <span class="hljs-keyword">if</span> (instances.isEmpty()) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"服务不可用: "</span> + serviceName);
        }
        
        <span class="hljs-comment">// 简单轮询负载均衡</span>
        <span class="hljs-type">ServiceInstance</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> instances.get(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt(instances.size())
        );
        
        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">"http://"</span> + instance.getHost() + <span class="hljs-string">":"</span> + instance.getPort() + path;
        <span class="hljs-keyword">return</span> restTemplate.getForObject(url, responseType);
    }
    
    <span class="hljs-comment">// 使用Ribbon负载均衡</span>
    <span class="hljs-meta">@LoadBalanced</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title function_">restTemplate</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestTemplate</span>();
    }
    
    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">callServiceWithRibbon</span><span class="hljs-params">(String serviceName, String path, Class&lt;T&gt; responseType)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">"http://"</span> + serviceName + path;
        <span class="hljs-keyword">return</span> restTemplate.getForObject(url, responseType);
    }
}
</code></pre>
<h3 data-id="heading-3">1.2 配置中心</h3>
<p><strong>Spring Cloud Config配置中心：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Config Server配置</span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableConfigServer</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigServerApplication</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(ConfigServerApplication.class, args);
    }
}

<span class="hljs-comment">// Config Server配置类</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigServerConfig</span> {
    
    <span class="hljs-comment">// Git仓库配置</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> GitRepository <span class="hljs-title function_">gitRepository</span><span class="hljs-params">()</span> {
        <span class="hljs-type">GitRepository</span> <span class="hljs-variable">repository</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GitRepository</span>();
        repository.setUri(<span class="hljs-string">"https://github.com/example/config-repo.git"</span>);
        repository.setSearchPaths(<span class="hljs-string">"config"</span>);
        <span class="hljs-keyword">return</span> repository;
    }
}

<span class="hljs-comment">// Config Client配置</span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableConfigClient</span>
<span class="hljs-meta">@RefreshScope</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderServiceApplication</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(OrderServiceApplication.class, args);
    }
}

<span class="hljs-comment">// 动态配置服务</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicConfigService</span> {
    
    <span class="hljs-meta">@Value("${app.order.timeout:5000}")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> orderTimeout;
    
    <span class="hljs-meta">@Value("${app.order.retry-count:3}")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> retryCount;
    
    <span class="hljs-meta">@Value("${app.feature.enable-new-payment:false}")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> enableNewPayment;
    
    <span class="hljs-comment">// 获取配置值</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getOrderTimeout</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> orderTimeout;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getRetryCount</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> retryCount;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEnableNewPayment</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> enableNewPayment;
    }
    
    <span class="hljs-comment">// 配置变更监听</span>
    <span class="hljs-meta">@EventListener</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleConfigChange</span><span class="hljs-params">(EnvironmentChangeEvent event)</span> {
        log.info(<span class="hljs-string">"配置变更: {}"</span>, event.getKeys());
        <span class="hljs-comment">// 处理配置变更逻辑</span>
    }
}

<span class="hljs-comment">// Nacos配置中心（替代方案）</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NacosConfig</span> {
    
    <span class="hljs-meta">@NacosValue(value = "${app.order.timeout:5000}", autoRefreshed = true)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> orderTimeout;
    
    <span class="hljs-meta">@NacosValue(value = "${app.order.retry-count:3}", autoRefreshed = true)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> retryCount;
    
    <span class="hljs-comment">// 监听配置变更</span>
    <span class="hljs-meta">@NacosConfigListener(dataId = "order-service", groupId = "DEFAULT_GROUP")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onConfigChange</span><span class="hljs-params">(String newConfig)</span> {
        log.info(<span class="hljs-string">"配置变更: {}"</span>, newConfig);
        <span class="hljs-comment">// 解析并应用新配置</span>
    }
}
</code></pre>
<h3 data-id="heading-4">1.3 API网关</h3>
<p><strong>Spring Cloud Gateway：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Gateway配置</span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GatewayApplication</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(GatewayApplication.class, args);
    }
}

<span class="hljs-comment">// Gateway路由配置</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GatewayConfig</span> {
    
    <span class="hljs-comment">// 路由配置</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> RouteLocator <span class="hljs-title function_">customRouteLocator</span><span class="hljs-params">(RouteLocatorBuilder builder)</span> {
        <span class="hljs-keyword">return</span> builder.routes()
            <span class="hljs-comment">// 订单服务路由</span>
            .route(<span class="hljs-string">"order-service"</span>, r -&gt; r
                .path(<span class="hljs-string">"/api/orders/**"</span>)
                .filters(f -&gt; f
                    .stripPrefix(<span class="hljs-number">1</span>)
                    .addRequestHeader(<span class="hljs-string">"X-Gateway"</span>, <span class="hljs-string">"Spring-Cloud-Gateway"</span>)
                    .retry(config -&gt; config
                        .setRetries(<span class="hljs-number">3</span>)
                        .setStatuses(HttpStatus.INTERNAL_SERVER_ERROR)
                        .setMethods(HttpMethod.GET)
                    )
                )
                .uri(<span class="hljs-string">"lb://order-service"</span>)
            )
            <span class="hljs-comment">// 用户服务路由</span>
            .route(<span class="hljs-string">"user-service"</span>, r -&gt; r
                .path(<span class="hljs-string">"/api/users/**"</span>)
                .filters(f -&gt; f
                    .stripPrefix(<span class="hljs-number">1</span>)
                    .circuitBreaker(config -&gt; config
                        .setName(<span class="hljs-string">"user-service-circuit"</span>)
                        .setFallbackUri(<span class="hljs-string">"forward:/fallback/user"</span>)
                    )
                )
                .uri(<span class="hljs-string">"lb://user-service"</span>)
            )
            <span class="hljs-comment">// 限流路由</span>
            .route(<span class="hljs-string">"rate-limit-route"</span>, r -&gt; r
                .path(<span class="hljs-string">"/api/public/**"</span>)
                .filters(f -&gt; f
                    .requestRateLimiter(config -&gt; config
                        .setRateLimiter(redisRateLimiter())
                        .setKeyResolver(ipKeyResolver())
                    )
                )
                .uri(<span class="hljs-string">"lb://public-service"</span>)
            )
            .build();
    }
    
    <span class="hljs-comment">// Redis限流器</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> RedisRateLimiter <span class="hljs-title function_">redisRateLimiter</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisRateLimiter</span>(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>); <span class="hljs-comment">// 每秒10个请求，突发20个</span>
    }
    
    <span class="hljs-comment">// 限流Key解析器（按IP限流）</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> KeyResolver <span class="hljs-title function_">ipKeyResolver</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> exchange -&gt; Mono.just(
            exchange.getRequest().getRemoteAddress().getAddress().getHostAddress()
        );
    }
    
    <span class="hljs-comment">// 全局过滤器</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> GlobalFilter <span class="hljs-title function_">customGlobalFilter</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> (exchange, chain) -&gt; {
            <span class="hljs-type">ServerHttpRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> exchange.getRequest();
            log.info(<span class="hljs-string">"请求路径: {}"</span>, request.getURI().getPath());
            
            <span class="hljs-comment">// 添加请求头</span>
            <span class="hljs-type">ServerHttpRequest</span> <span class="hljs-variable">modifiedRequest</span> <span class="hljs-operator">=</span> request.mutate()
                .header(<span class="hljs-string">"X-Request-Time"</span>, String.valueOf(System.currentTimeMillis()))
                .build();
            
            <span class="hljs-keyword">return</span> chain.filter(exchange.mutate().request(modifiedRequest).build());
        };
    }
    
    <span class="hljs-comment">// 自定义过滤器</span>
    <span class="hljs-meta">@Component</span>
    <span class="hljs-meta">@Slf4j</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GatewayFilter</span>, Ordered {
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">filter</span><span class="hljs-params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> {
            <span class="hljs-type">ServerHttpRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> exchange.getRequest();
            <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeaders().getFirst(<span class="hljs-string">"Authorization"</span>);
            
            <span class="hljs-keyword">if</span> (token == <span class="hljs-literal">null</span> || !isValidToken(token)) {
                <span class="hljs-type">ServerHttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> exchange.getResponse();
                response.setStatusCode(HttpStatus.UNAUTHORIZED);
                <span class="hljs-keyword">return</span> response.setComplete();
            }
            
            <span class="hljs-keyword">return</span> chain.filter(exchange);
        }
        
        <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValidToken</span><span class="hljs-params">(String token)</span> {
            <span class="hljs-comment">// Token验证逻辑</span>
            <span class="hljs-keyword">return</span> token.startsWith(<span class="hljs-string">"Bearer "</span>);
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getOrder</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> -<span class="hljs-number">100</span>;
        }
    }
}

<span class="hljs-comment">// 降级处理</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FallbackController</span> {
    
    <span class="hljs-meta">@RequestMapping("/fallback/user")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-title function_">userFallback</span><span class="hljs-params">()</span> {
        Map&lt;String, Object&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        result.put(<span class="hljs-string">"code"</span>, <span class="hljs-number">500</span>);
        result.put(<span class="hljs-string">"message"</span>, <span class="hljs-string">"用户服务暂时不可用，请稍后重试"</span>);
        <span class="hljs-keyword">return</span> ResponseEntity.status(HttpStatus.SERVICE_UNAVAILABLE).body(result);
    }
}
</code></pre>
<h3 data-id="heading-5">1.4 服务调用</h3>
<p><strong>OpenFeign服务调用：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Feign客户端接口</span>
<span class="hljs-meta">@FeignClient(name = "user-service", fallback = UserServiceFallback.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserServiceClient</span> {
    
    <span class="hljs-meta">@GetMapping("/api/users/{id}")</span>
    UserDTO <span class="hljs-title function_">getUserById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable("id")</span> Long id)</span>;
    
    <span class="hljs-meta">@PostMapping("/api/users")</span>
    UserDTO <span class="hljs-title function_">createUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> CreateUserRequest request)</span>;
    
    <span class="hljs-meta">@GetMapping("/api/users")</span>
    List&lt;UserDTO&gt; <span class="hljs-title function_">getUsers</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam("ids")</span> List&lt;Long&gt; ids)</span>;
}

<span class="hljs-comment">// Feign降级处理</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceFallback</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserServiceClient</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> UserDTO <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Long id)</span> {
        log.warn(<span class="hljs-string">"用户服务降级，返回默认用户: {}"</span>, id);
        <span class="hljs-type">UserDTO</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserDTO</span>();
        user.setId(id);
        user.setName(<span class="hljs-string">"默认用户"</span>);
        <span class="hljs-keyword">return</span> user;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> UserDTO <span class="hljs-title function_">createUser</span><span class="hljs-params">(CreateUserRequest request)</span> {
        log.warn(<span class="hljs-string">"用户服务降级，创建用户失败"</span>);
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"用户服务不可用"</span>);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;UserDTO&gt; <span class="hljs-title function_">getUsers</span><span class="hljs-params">(List&lt;Long&gt; ids)</span> {
        log.warn(<span class="hljs-string">"用户服务降级，返回空列表"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    }
}

<span class="hljs-comment">// Feign配置</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FeignConfig</span> {
    
    <span class="hljs-comment">// 请求拦截器</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> RequestInterceptor <span class="hljs-title function_">requestInterceptor</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> requestTemplate -&gt; {
            <span class="hljs-comment">// 添加请求头</span>
            requestTemplate.header(<span class="hljs-string">"X-Request-Id"</span>, UUID.randomUUID().toString());
            requestTemplate.header(<span class="hljs-string">"X-Service-Name"</span>, <span class="hljs-string">"order-service"</span>);
        };
    }
    
    <span class="hljs-comment">// 日志配置</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Logger.Level <span class="hljs-title function_">feignLoggerLevel</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Logger.Level.FULL;
    }
    
    <span class="hljs-comment">// 错误解码器</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> ErrorDecoder <span class="hljs-title function_">errorDecoder</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorDecoder</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> Exception <span class="hljs-title function_">decode</span><span class="hljs-params">(String methodKey, Response response)</span> {
                <span class="hljs-keyword">if</span> (response.status() == <span class="hljs-number">404</span>) {
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResourceNotFoundException</span>(<span class="hljs-string">"资源未找到"</span>);
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (response.status() &gt;= <span class="hljs-number">500</span>) {
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceException</span>(<span class="hljs-string">"服务异常"</span>);
                }
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"未知错误"</span>);
            }
        };
    }
    
    <span class="hljs-comment">// 重试配置</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Retryer <span class="hljs-title function_">retryer</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Retryer</span>.Default(<span class="hljs-number">100</span>, <span class="hljs-number">1000</span>, <span class="hljs-number">3</span>);
    }
}

<span class="hljs-comment">// 使用Feign客户端</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserServiceClient userServiceClient;
    
    <span class="hljs-keyword">public</span> OrderDTO <span class="hljs-title function_">createOrder</span><span class="hljs-params">(CreateOrderRequest request)</span> {
        <span class="hljs-comment">// 调用用户服务</span>
        <span class="hljs-type">UserDTO</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userServiceClient.getUserById(request.getUserId());
        
        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"用户不存在"</span>);
        }
        
        <span class="hljs-comment">// 创建订单逻辑</span>
        <span class="hljs-type">OrderDTO</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderDTO</span>();
        order.setUserId(user.getId());
        order.setUserName(user.getName());
        <span class="hljs-comment">// ...</span>
        
        <span class="hljs-keyword">return</span> order;
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-6">2. 云原生技术</h2>
<h3 data-id="heading-7">2.1 Docker容器化</h3>
<p><strong>Dockerfile编写：</strong></p>
<pre><code class="hljs language-dockerfile" lang="dockerfile"># 多阶段构建
# 第一阶段：构建应用
FROM maven:3.8.4-openjdk-17 AS builder
WORKDIR /app
COPY pom.xml .
RUN mvn dependency:go-offline
COPY src ./src
RUN mvn clean package -DskipTests

# 第二阶段：运行应用
FROM openjdk:17-jre-slim
WORKDIR /app

# 创建非root用户
RUN groupadd -r appuser &amp;&amp; useradd -r -g appuser appuser

# 复制构建产物
COPY --from=builder /app/target/*.jar app.jar

# 设置文件权限
RUN chown -R appuser:appuser /app

# 切换到非root用户
USER appuser

# 暴露端口
EXPOSE 8080

# 健康检查
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
  CMD curl -f http://localhost:8080/actuator/health || exit 1

# 启动应用
ENTRYPOINT ["java", "-jar", "app.jar"]
</code></pre>
<p><strong>Docker Compose配置：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">'3.8'</span>

<span class="hljs-attr">services:</span>
  <span class="hljs-comment"># 订单服务</span>
  <span class="hljs-attr">order-service:</span>
    <span class="hljs-attr">build:</span>
      <span class="hljs-attr">context:</span> <span class="hljs-string">./order-service</span>
      <span class="hljs-attr">dockerfile:</span> <span class="hljs-string">Dockerfile</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">order-service</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"8080:8080"</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">SPRING_PROFILES_ACTIVE=docker</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://eureka:8761/eureka/</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">mysql</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">redis</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">microservices-network</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">unless-stopped</span>

  <span class="hljs-comment"># 用户服务</span>
  <span class="hljs-attr">user-service:</span>
    <span class="hljs-attr">build:</span>
      <span class="hljs-attr">context:</span> <span class="hljs-string">./user-service</span>
      <span class="hljs-attr">dockerfile:</span> <span class="hljs-string">Dockerfile</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">user-service</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"8081:8080"</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">SPRING_PROFILES_ACTIVE=docker</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://eureka:8761/eureka/</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">mysql</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">microservices-network</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">unless-stopped</span>

  <span class="hljs-comment"># Eureka服务注册中心</span>
  <span class="hljs-attr">eureka:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">springcloud/eureka</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">eureka-server</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"8761:8761"</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">microservices-network</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">unless-stopped</span>

  <span class="hljs-comment"># MySQL数据库</span>
  <span class="hljs-attr">mysql:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">mysql:8.0</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">mysql</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">MYSQL_ROOT_PASSWORD=root123</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">MYSQL_DATABASE=order_db</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"3306:3306"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">mysql-data:/var/lib/mysql</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">microservices-network</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">unless-stopped</span>

  <span class="hljs-comment"># Redis缓存</span>
  <span class="hljs-attr">redis:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">redis:7-alpine</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">redis</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"6379:6379"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">redis-data:/data</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">microservices-network</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">unless-stopped</span>

<span class="hljs-attr">volumes:</span>
  <span class="hljs-attr">mysql-data:</span>
  <span class="hljs-attr">redis-data:</span>

<span class="hljs-attr">networks:</span>
  <span class="hljs-attr">microservices-network:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">bridge</span>
</code></pre>
<p><strong>Docker操作服务：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Docker操作服务</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DockerService</span> {
    
    <span class="hljs-comment">// 构建Docker镜像</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildImage</span><span class="hljs-params">(String dockerfilePath, String imageName, String tag)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">ProcessBuilder</span> <span class="hljs-variable">processBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(
                <span class="hljs-string">"docker"</span>, <span class="hljs-string">"build"</span>,
                <span class="hljs-string">"-f"</span>, dockerfilePath,
                <span class="hljs-string">"-t"</span>, imageName + <span class="hljs-string">":"</span> + tag,
                <span class="hljs-string">"."</span>
            );
            
            <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> processBuilder.start();
            <span class="hljs-type">int</span> <span class="hljs-variable">exitCode</span> <span class="hljs-operator">=</span> process.waitFor();
            
            <span class="hljs-keyword">if</span> (exitCode == <span class="hljs-number">0</span>) {
                log.info(<span class="hljs-string">"Docker镜像构建成功: {}:{}"</span>, imageName, tag);
            } <span class="hljs-keyword">else</span> {
                log.error(<span class="hljs-string">"Docker镜像构建失败，退出码: {}"</span>, exitCode);
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"构建Docker镜像异常"</span>, e);
        }
    }
    
    <span class="hljs-comment">// 运行Docker容器</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">runContainer</span><span class="hljs-params">(String imageName, String containerName, 
                           Map&lt;String, String&gt; envVars, <span class="hljs-type">int</span> port)</span> {
        <span class="hljs-keyword">try</span> {
            List&lt;String&gt; command = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
            command.add(<span class="hljs-string">"docker"</span>);
            command.add(<span class="hljs-string">"run"</span>);
            command.add(<span class="hljs-string">"-d"</span>);
            command.add(<span class="hljs-string">"--name"</span>);
            command.add(containerName);
            command.add(<span class="hljs-string">"-p"</span>);
            command.add(port + <span class="hljs-string">":8080"</span>);
            
            <span class="hljs-comment">// 添加环境变量</span>
            <span class="hljs-keyword">for</span> (Map.Entry&lt;String, String&gt; entry : envVars.entrySet()) {
                command.add(<span class="hljs-string">"-e"</span>);
                command.add(entry.getKey() + <span class="hljs-string">"="</span> + entry.getValue());
            }
            
            command.add(imageName);
            
            <span class="hljs-type">ProcessBuilder</span> <span class="hljs-variable">processBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(command);
            <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> processBuilder.start();
            <span class="hljs-type">int</span> <span class="hljs-variable">exitCode</span> <span class="hljs-operator">=</span> process.waitFor();
            
            <span class="hljs-keyword">if</span> (exitCode == <span class="hljs-number">0</span>) {
                log.info(<span class="hljs-string">"Docker容器启动成功: {}"</span>, containerName);
            } <span class="hljs-keyword">else</span> {
                log.error(<span class="hljs-string">"Docker容器启动失败，退出码: {}"</span>, exitCode);
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"启动Docker容器异常"</span>, e);
        }
    }
}
</code></pre>
<h3 data-id="heading-8">2.2 Kubernetes部署</h3>
<p><strong>Kubernetes部署配置：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># Deployment配置</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">order-service</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">order-service</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">order-service</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">order-service</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">order-service</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">order-service:latest</span>
        <span class="hljs-attr">ports:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8080</span>
        <span class="hljs-attr">env:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">SPRING_PROFILES_ACTIVE</span>
          <span class="hljs-attr">value:</span> <span class="hljs-string">"k8s"</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE</span>
          <span class="hljs-attr">value:</span> <span class="hljs-string">"http://eureka-service:8761/eureka/"</span>
        <span class="hljs-attr">resources:</span>
          <span class="hljs-attr">requests:</span>
            <span class="hljs-attr">memory:</span> <span class="hljs-string">"512Mi"</span>
            <span class="hljs-attr">cpu:</span> <span class="hljs-string">"500m"</span>
          <span class="hljs-attr">limits:</span>
            <span class="hljs-attr">memory:</span> <span class="hljs-string">"1Gi"</span>
            <span class="hljs-attr">cpu:</span> <span class="hljs-string">"1000m"</span>
        <span class="hljs-attr">livenessProbe:</span>
          <span class="hljs-attr">httpGet:</span>
            <span class="hljs-attr">path:</span> <span class="hljs-string">/actuator/health/liveness</span>
            <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">60</span>
          <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span>
        <span class="hljs-attr">readinessProbe:</span>
          <span class="hljs-attr">httpGet:</span>
            <span class="hljs-attr">path:</span> <span class="hljs-string">/actuator/health/readiness</span>
            <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">30</span>
          <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">5</span>

<span class="hljs-meta">---</span>
<span class="hljs-comment"># Service配置</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">order-service</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">order-service</span>
  <span class="hljs-attr">ports:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">80</span>
    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8080</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span>

<span class="hljs-meta">---</span>
<span class="hljs-comment"># Ingress配置</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.k8s.io/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">order-service-ingress</span>
  <span class="hljs-attr">annotations:</span>
    <span class="hljs-attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="hljs-string">/</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">rules:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">api.example.com</span>
    <span class="hljs-attr">http:</span>
      <span class="hljs-attr">paths:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/api/orders</span>
        <span class="hljs-attr">pathType:</span> <span class="hljs-string">Prefix</span>
        <span class="hljs-attr">backend:</span>
          <span class="hljs-attr">service:</span>
            <span class="hljs-attr">name:</span> <span class="hljs-string">order-service</span>
            <span class="hljs-attr">port:</span>
              <span class="hljs-attr">number:</span> <span class="hljs-number">80</span>

<span class="hljs-meta">---</span>
<span class="hljs-comment"># ConfigMap配置</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">order-service-config</span>
<span class="hljs-attr">data:</span>
  <span class="hljs-attr">application.yml:</span> <span class="hljs-string">|
    spring:
      datasource:
        url: jdbc:mysql://mysql-service:3306/order_db
      redis:
        host: redis-service
        port: 6379
</span>
<span class="hljs-meta">---</span>
<span class="hljs-comment"># Secret配置</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Secret</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">order-service-secret</span>
<span class="hljs-attr">type:</span> <span class="hljs-string">Opaque</span>
<span class="hljs-attr">data:</span>
  <span class="hljs-attr">db-password:</span> <span class="hljs-string">cm9vdDEyMw==</span>  <span class="hljs-comment"># base64编码的密码</span>
</code></pre>
<p><strong>Kubernetes操作服务：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Kubernetes操作服务</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KubernetesService</span> {
    
    <span class="hljs-comment">// 创建Deployment</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createDeployment</span><span class="hljs-params">(String name, String image, <span class="hljs-type">int</span> replicas)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">ProcessBuilder</span> <span class="hljs-variable">processBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(
                <span class="hljs-string">"kubectl"</span>, <span class="hljs-string">"create"</span>, <span class="hljs-string">"deployment"</span>,
                name,
                <span class="hljs-string">"--image="</span> + image,
                <span class="hljs-string">"--replicas="</span> + replicas
            );
            
            <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> processBuilder.start();
            <span class="hljs-type">int</span> <span class="hljs-variable">exitCode</span> <span class="hljs-operator">=</span> process.waitFor();
            
            <span class="hljs-keyword">if</span> (exitCode == <span class="hljs-number">0</span>) {
                log.info(<span class="hljs-string">"Kubernetes Deployment创建成功: {}"</span>, name);
            } <span class="hljs-keyword">else</span> {
                log.error(<span class="hljs-string">"Kubernetes Deployment创建失败，退出码: {}"</span>, exitCode);
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"创建Kubernetes Deployment异常"</span>, e);
        }
    }
    
    <span class="hljs-comment">// 扩缩容</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">scaleDeployment</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> replicas)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">ProcessBuilder</span> <span class="hljs-variable">processBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(
                <span class="hljs-string">"kubectl"</span>, <span class="hljs-string">"scale"</span>, <span class="hljs-string">"deployment"</span>,
                name,
                <span class="hljs-string">"--replicas="</span> + replicas
            );
            
            <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> processBuilder.start();
            <span class="hljs-type">int</span> <span class="hljs-variable">exitCode</span> <span class="hljs-operator">=</span> process.waitFor();
            
            <span class="hljs-keyword">if</span> (exitCode == <span class="hljs-number">0</span>) {
                log.info(<span class="hljs-string">"Kubernetes Deployment扩缩容成功: {} -&gt; {}"</span>, name, replicas);
            } <span class="hljs-keyword">else</span> {
                log.error(<span class="hljs-string">"Kubernetes Deployment扩缩容失败，退出码: {}"</span>, exitCode);
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"Kubernetes Deployment扩缩容异常"</span>, e);
        }
    }
    
    <span class="hljs-comment">// 滚动更新</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rollingUpdate</span><span class="hljs-params">(String name, String newImage)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">ProcessBuilder</span> <span class="hljs-variable">processBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(
                <span class="hljs-string">"kubectl"</span>, <span class="hljs-string">"set"</span>, <span class="hljs-string">"image"</span>,
                <span class="hljs-string">"deployment/"</span> + name,
                name + <span class="hljs-string">"="</span> + newImage
            );
            
            <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> processBuilder.start();
            <span class="hljs-type">int</span> <span class="hljs-variable">exitCode</span> <span class="hljs-operator">=</span> process.waitFor();
            
            <span class="hljs-keyword">if</span> (exitCode == <span class="hljs-number">0</span>) {
                log.info(<span class="hljs-string">"Kubernetes滚动更新成功: {} -&gt; {}"</span>, name, newImage);
            } <span class="hljs-keyword">else</span> {
                log.error(<span class="hljs-string">"Kubernetes滚动更新失败，退出码: {}"</span>, exitCode);
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"Kubernetes滚动更新异常"</span>, e);
        }
    }
}
</code></pre>
<h3 data-id="heading-9">2.3 Service Mesh</h3>
<p><strong>Istio Service Mesh配置：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># VirtualService配置</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.istio.io/v1alpha3</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">VirtualService</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">order-service</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">hosts:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">order-service</span>
  <span class="hljs-attr">http:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">match:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">headers:</span>
        <span class="hljs-attr">version:</span>
          <span class="hljs-attr">exact:</span> <span class="hljs-string">v2</span>
    <span class="hljs-attr">route:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">destination:</span>
        <span class="hljs-attr">host:</span> <span class="hljs-string">order-service</span>
        <span class="hljs-attr">subset:</span> <span class="hljs-string">v2</span>
      <span class="hljs-attr">weight:</span> <span class="hljs-number">100</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">route:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">destination:</span>
        <span class="hljs-attr">host:</span> <span class="hljs-string">order-service</span>
        <span class="hljs-attr">subset:</span> <span class="hljs-string">v1</span>
      <span class="hljs-attr">weight:</span> <span class="hljs-number">90</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">destination:</span>
        <span class="hljs-attr">host:</span> <span class="hljs-string">order-service</span>
        <span class="hljs-attr">subset:</span> <span class="hljs-string">v2</span>
      <span class="hljs-attr">weight:</span> <span class="hljs-number">10</span>

<span class="hljs-meta">---</span>
<span class="hljs-comment"># DestinationRule配置</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.istio.io/v1alpha3</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">DestinationRule</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">order-service</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">host:</span> <span class="hljs-string">order-service</span>
  <span class="hljs-attr">subsets:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">v1</span>
    <span class="hljs-attr">labels:</span>
      <span class="hljs-attr">version:</span> <span class="hljs-string">v1</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">v2</span>
    <span class="hljs-attr">labels:</span>
      <span class="hljs-attr">version:</span> <span class="hljs-string">v2</span>
  <span class="hljs-attr">trafficPolicy:</span>
    <span class="hljs-attr">loadBalancer:</span>
      <span class="hljs-attr">simple:</span> <span class="hljs-string">ROUND_ROBIN</span>
    <span class="hljs-attr">connectionPool:</span>
      <span class="hljs-attr">tcp:</span>
        <span class="hljs-attr">maxConnections:</span> <span class="hljs-number">100</span>
      <span class="hljs-attr">http:</span>
        <span class="hljs-attr">http1MaxPendingRequests:</span> <span class="hljs-number">10</span>
        <span class="hljs-attr">http2MaxRequests:</span> <span class="hljs-number">100</span>
        <span class="hljs-attr">maxRequestsPerConnection:</span> <span class="hljs-number">2</span>
    <span class="hljs-attr">circuitBreaker:</span>
      <span class="hljs-attr">consecutiveErrors:</span> <span class="hljs-number">5</span>
      <span class="hljs-attr">interval:</span> <span class="hljs-string">30s</span>
      <span class="hljs-attr">baseEjectionTime:</span> <span class="hljs-string">30s</span>
      <span class="hljs-attr">maxEjectionPercent:</span> <span class="hljs-number">50</span>
      <span class="hljs-attr">minHealthPercent:</span> <span class="hljs-number">50</span>

<span class="hljs-meta">---</span>
<span class="hljs-comment"># Gateway配置</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.istio.io/v1alpha3</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Gateway</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">order-gateway</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">istio:</span> <span class="hljs-string">ingressgateway</span>
  <span class="hljs-attr">servers:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span>
      <span class="hljs-attr">number:</span> <span class="hljs-number">80</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">http</span>
      <span class="hljs-attr">protocol:</span> <span class="hljs-string">HTTP</span>
    <span class="hljs-attr">hosts:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">api.example.com</span>
</code></pre>
<hr/>
<h2 data-id="heading-10">3. 系统设计实战</h2>
<h3 data-id="heading-11">3.1 高并发系统设计</h3>
<p><strong>高并发系统架构：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 限流服务</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RateLimitService</span> {
    
    <span class="hljs-comment">// 令牌桶限流</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">RateLimiter</span> <span class="hljs-variable">rateLimiter</span> <span class="hljs-operator">=</span> RateLimiter.create(<span class="hljs-number">100.0</span>); <span class="hljs-comment">// 每秒100个请求</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> rateLimiter.tryAcquire();
    }
    
    <span class="hljs-comment">// 滑动窗口限流</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, List&lt;Long&gt;&gt; requestWindows = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">WINDOW_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">60</span>; <span class="hljs-comment">// 60秒窗口</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_REQUESTS</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>; <span class="hljs-comment">// 最大100个请求</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAllowed</span><span class="hljs-params">(String key)</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">currentTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis() / <span class="hljs-number">1000</span>;
        List&lt;Long&gt; window = requestWindows.computeIfAbsent(key, k -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;());
        
        <span class="hljs-comment">// 移除过期请求</span>
        window.removeIf(time -&gt; time &lt; currentTime - WINDOW_SIZE);
        
        <span class="hljs-keyword">if</span> (window.size() &gt;= MAX_REQUESTS) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        
        window.add(currentTime);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}

<span class="hljs-comment">// 缓存服务</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;
    
    <span class="hljs-comment">// 多级缓存</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Cache&lt;String, Object&gt; localCache = Caffeine.newBuilder()
        .maximumSize(<span class="hljs-number">10000</span>)
        .expireAfterWrite(<span class="hljs-number">5</span>, TimeUnit.MINUTES)
        .build();
    
    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">get</span><span class="hljs-params">(String key, Class&lt;T&gt; type, Supplier&lt;T&gt; dataLoader)</span> {
        <span class="hljs-comment">// 一级缓存：本地缓存</span>
        <span class="hljs-type">T</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (T) localCache.getIfPresent(key);
        <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> value;
        }
        
        <span class="hljs-comment">// 二级缓存：Redis</span>
        value = (T) redisTemplate.opsForValue().get(key);
        <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) {
            localCache.put(key, value);
            <span class="hljs-keyword">return</span> value;
        }
        
        <span class="hljs-comment">// 三级缓存：数据库</span>
        value = dataLoader.get();
        <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) {
            redisTemplate.opsForValue().set(key, value, <span class="hljs-number">1</span>, TimeUnit.HOURS);
            localCache.put(key, value);
        }
        
        <span class="hljs-keyword">return</span> value;
    }
}

<span class="hljs-comment">// 异步处理服务</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncProcessService</span> {
    
    <span class="hljs-meta">@Async("taskExecutor")</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;Void&gt; <span class="hljs-title function_">processAsync</span><span class="hljs-params">(String data)</span> {
        <span class="hljs-comment">// 异步处理逻辑</span>
        log.info(<span class="hljs-string">"异步处理: {}"</span>, data);
        <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(<span class="hljs-literal">null</span>);
    }
    
    <span class="hljs-comment">// 线程池配置</span>
    <span class="hljs-meta">@Bean(name = "taskExecutor")</span>
    <span class="hljs-keyword">public</span> ThreadPoolTaskExecutor <span class="hljs-title function_">taskExecutor</span><span class="hljs-params">()</span> {
        <span class="hljs-type">ThreadPoolTaskExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolTaskExecutor</span>();
        executor.setCorePoolSize(<span class="hljs-number">10</span>);
        executor.setMaxPoolSize(<span class="hljs-number">50</span>);
        executor.setQueueCapacity(<span class="hljs-number">200</span>);
        executor.setThreadNamePrefix(<span class="hljs-string">"async-task-"</span>);
        executor.setRejectedExecutionHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy());
        executor.initialize();
        <span class="hljs-keyword">return</span> executor;
    }
}
</code></pre>
<h3 data-id="heading-12">3.2 分布式系统设计</h3>
<p><strong>分布式系统架构：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 分布式任务调度</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistributedTaskScheduler</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;
    
    <span class="hljs-comment">// 分布式锁实现任务调度</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">scheduleTask</span><span class="hljs-params">(String taskId, Runnable task)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"task:lock:"</span> + taskId;
        <span class="hljs-type">String</span> <span class="hljs-variable">lockValue</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString();
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (tryLock(lockKey, lockValue, <span class="hljs-number">30</span>)) {
                <span class="hljs-comment">// 检查任务是否已执行</span>
                <span class="hljs-type">String</span> <span class="hljs-variable">executedKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"task:executed:"</span> + taskId;
                <span class="hljs-keyword">if</span> (redisTemplate.hasKey(executedKey)) {
                    log.info(<span class="hljs-string">"任务已执行: {}"</span>, taskId);
                    <span class="hljs-keyword">return</span>;
                }
                
                <span class="hljs-comment">// 执行任务</span>
                task.run();
                
                <span class="hljs-comment">// 标记任务已执行</span>
                redisTemplate.opsForValue().set(executedKey, <span class="hljs-string">"1"</span>, <span class="hljs-number">1</span>, TimeUnit.HOURS);
            }
        } <span class="hljs-keyword">finally</span> {
            releaseLock(lockKey, lockValue);
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(String lockKey, String lockValue, <span class="hljs-type">long</span> expireTime)</span> {
        <span class="hljs-type">Boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue()
            .setIfAbsent(lockKey, lockValue, expireTime, TimeUnit.SECONDS);
        <span class="hljs-keyword">return</span> Boolean.TRUE.equals(result);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">releaseLock</span><span class="hljs-params">(String lockKey, String lockValue)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">luaScript</span> <span class="hljs-operator">=</span> 
            <span class="hljs-string">"if redis.call('get', KEYS[1]) == ARGV[1] then "</span> +
            <span class="hljs-string">"  return redis.call('del', KEYS[1]) "</span> +
            <span class="hljs-string">"else return 0 end"</span>;
        
        DefaultRedisScript&lt;Long&gt; script = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;();
        script.setScriptText(luaScript);
        script.setResultType(Long.class);
        
        redisTemplate.execute(script, Collections.singletonList(lockKey), lockValue);
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-13">4. 面试准备</h2>
<h3 data-id="heading-14">4.1 常见面试题</h3>
<p><strong>Java基础面试题：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 单例模式实现</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> {
    <span class="hljs-comment">// 双重检查锁定</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">static</span> Singleton instance;
    
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton</span><span class="hljs-params">()</span> {}
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">synchronized</span> (Singleton.class) {
                <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) {
                    instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();
                }
            }
        }
        <span class="hljs-keyword">return</span> instance;
    }
    
    <span class="hljs-comment">// 静态内部类实现</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SingletonHolder</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Singleton</span> <span class="hljs-variable">INSTANCE</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getInstance2</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> SingletonHolder.INSTANCE;
    }
}

<span class="hljs-comment">// 2. 线程安全的单例</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">SingletonEnum</span> {
    INSTANCE;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doSomething</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 业务逻辑</span>
    }
}

<span class="hljs-comment">// 3. 生产者消费者模式</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProducerConsumer</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BlockingQueue&lt;Integer&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">10</span>);
    
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Producer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {
                    queue.put(i);
                    System.out.println(<span class="hljs-string">"生产: "</span> + i);
                }
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }
    }
    
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Consumer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
                    <span class="hljs-type">Integer</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> queue.take();
                    System.out.println(<span class="hljs-string">"消费: "</span> + value);
                }
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-15">4.2 算法题</h3>
<p><strong>常见算法实现：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 快速排序</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">QuickSort</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sort</span><span class="hljs-params">(<span class="hljs-type">int</span>[] arr, <span class="hljs-type">int</span> low, <span class="hljs-type">int</span> high)</span> {
        <span class="hljs-keyword">if</span> (low &lt; high) {
            <span class="hljs-type">int</span> <span class="hljs-variable">pivot</span> <span class="hljs-operator">=</span> partition(arr, low, high);
            sort(arr, low, pivot - <span class="hljs-number">1</span>);
            sort(arr, pivot + <span class="hljs-number">1</span>, high);
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">partition</span><span class="hljs-params">(<span class="hljs-type">int</span>[] arr, <span class="hljs-type">int</span> low, <span class="hljs-type">int</span> high)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">pivot</span> <span class="hljs-operator">=</span> arr[high];
        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> low - <span class="hljs-number">1</span>;
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> low; j &lt; high; j++) {
            <span class="hljs-keyword">if</span> (arr[j] &lt; pivot) {
                i++;
                swap(arr, i, j);
            }
        }
        
        swap(arr, i + <span class="hljs-number">1</span>, high);
        <span class="hljs-keyword">return</span> i + <span class="hljs-number">1</span>;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">swap</span><span class="hljs-params">(<span class="hljs-type">int</span>[] arr, <span class="hljs-type">int</span> i, <span class="hljs-type">int</span> j)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> arr[i];
        arr[i] = arr[j];
        arr[j] = temp;
    }
}

<span class="hljs-comment">// 二分查找</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BinarySearch</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">search</span><span class="hljs-params">(<span class="hljs-type">int</span>[] arr, <span class="hljs-type">int</span> target)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">left</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, right = arr.length - <span class="hljs-number">1</span>;
        
        <span class="hljs-keyword">while</span> (left &lt;= right) {
            <span class="hljs-type">int</span> <span class="hljs-variable">mid</span> <span class="hljs-operator">=</span> left + (right - left) / <span class="hljs-number">2</span>;
            
            <span class="hljs-keyword">if</span> (arr[mid] == target) {
                <span class="hljs-keyword">return</span> mid;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (arr[mid] &lt; target) {
                left = mid + <span class="hljs-number">1</span>;
            } <span class="hljs-keyword">else</span> {
                right = mid - <span class="hljs-number">1</span>;
            }
        }
        
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    }
}

<span class="hljs-comment">// LRU缓存实现</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LRUCache</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> capacity;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Integer, Node&gt; cache;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Node head;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Node tail;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">LRUCache</span><span class="hljs-params">(<span class="hljs-type">int</span> capacity)</span> {
        <span class="hljs-built_in">this</span>.capacity = capacity;
        <span class="hljs-built_in">this</span>.cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        <span class="hljs-built_in">this</span>.head = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        <span class="hljs-built_in">this</span>.tail = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        head.next = tail;
        tail.prev = head;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-type">int</span> key)</span> {
        <span class="hljs-type">Node</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> cache.get(key);
        <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
        }
        moveToHead(node);
        <span class="hljs-keyword">return</span> node.value;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(<span class="hljs-type">int</span> key, <span class="hljs-type">int</span> value)</span> {
        <span class="hljs-type">Node</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> cache.get(key);
        <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">null</span>) {
            <span class="hljs-type">Node</span> <span class="hljs-variable">newNode</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>(key, value);
            cache.put(key, newNode);
            addToHead(newNode);
            
            <span class="hljs-keyword">if</span> (cache.size() &gt; capacity) {
                <span class="hljs-type">Node</span> <span class="hljs-variable">tail</span> <span class="hljs-operator">=</span> removeTail();
                cache.remove(tail.key);
            }
        } <span class="hljs-keyword">else</span> {
            node.value = value;
            moveToHead(node);
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addToHead</span><span class="hljs-params">(Node node)</span> {
        node.prev = head;
        node.next = head.next;
        head.next.prev = node;
        head.next = node;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeNode</span><span class="hljs-params">(Node node)</span> {
        node.prev.next = node.next;
        node.next.prev = node.prev;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">moveToHead</span><span class="hljs-params">(Node node)</span> {
        removeNode(node);
        addToHead(node);
    }
    
    <span class="hljs-keyword">private</span> Node <span class="hljs-title function_">removeTail</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Node</span> <span class="hljs-variable">lastNode</span> <span class="hljs-operator">=</span> tail.prev;
        removeNode(lastNode);
        <span class="hljs-keyword">return</span> lastNode;
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span> {
        <span class="hljs-type">int</span> key;
        <span class="hljs-type">int</span> value;
        Node prev;
        Node next;
        
        Node(<span class="hljs-type">int</span> key, <span class="hljs-type">int</span> value) {
            <span class="hljs-built_in">this</span>.key = key;
            <span class="hljs-built_in">this</span>.value = value;
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-16">5. 新技术趋势</h2>
<h3 data-id="heading-17">5.1 响应式编程</h3>
<p><strong>Reactor响应式编程：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 响应式服务</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactiveService</span> {
    
    <span class="hljs-comment">// 创建Flux</span>
    <span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">getDataStream</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>)
            .map(i -&gt; <span class="hljs-string">"数据"</span> + i)
            .delayElements(Duration.ofMillis(<span class="hljs-number">100</span>))
            .doOnNext(data -&gt; log.info(<span class="hljs-string">"处理数据: {}"</span>, data));
    }
    
    <span class="hljs-comment">// 创建Mono</span>
    <span class="hljs-keyword">public</span> Mono&lt;String&gt; <span class="hljs-title function_">getSingleData</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Mono.just(<span class="hljs-string">"单个数据"</span>)
            .delayElement(Duration.ofMillis(<span class="hljs-number">100</span>))
            .doOnNext(data -&gt; log.info(<span class="hljs-string">"处理数据: {}"</span>, data));
    }
    
    <span class="hljs-comment">// 组合多个流</span>
    <span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">combineStreams</span><span class="hljs-params">()</span> {
        Flux&lt;String&gt; stream1 = Flux.just(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>);
        Flux&lt;String&gt; stream2 = Flux.just(<span class="hljs-string">"1"</span>, <span class="hljs-string">"2"</span>, <span class="hljs-string">"3"</span>);
        
        <span class="hljs-keyword">return</span> Flux.zip(stream1, stream2, (s1, s2) -&gt; s1 + s2);
    }
    
    <span class="hljs-comment">// 错误处理</span>
    <span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">handleError</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>)
            .map(i -&gt; {
                <span class="hljs-keyword">if</span> (i == <span class="hljs-number">5</span>) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"错误"</span>);
                }
                <span class="hljs-keyword">return</span> <span class="hljs-string">"数据"</span> + i;
            })
            .onErrorResume(error -&gt; {
                log.error(<span class="hljs-string">"处理错误"</span>, error);
                <span class="hljs-keyword">return</span> Flux.just(<span class="hljs-string">"错误恢复数据"</span>);
            });
    }
}

<span class="hljs-comment">// WebFlux控制器</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactiveController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ReactiveService reactiveService;
    
    <span class="hljs-meta">@GetMapping("/api/data/stream")</span>
    <span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">getDataStream</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> reactiveService.getDataStream();
    }
    
    <span class="hljs-meta">@GetMapping("/api/data/single")</span>
    <span class="hljs-keyword">public</span> Mono&lt;String&gt; <span class="hljs-title function_">getSingleData</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> reactiveService.getSingleData();
    }
}
</code></pre>
<h3 data-id="heading-18">5.2 虚拟线程（Java 19+）</h3>
<p><strong>虚拟线程使用：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 虚拟线程服务</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VirtualThreadService</span> {
    
    <span class="hljs-comment">// 使用虚拟线程</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processWithVirtualThread</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newVirtualThreadPerTaskExecutor()) {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {
                <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">taskId</span> <span class="hljs-operator">=</span> i;
                executor.submit(() -&gt; {
                    log.info(<span class="hljs-string">"虚拟线程执行任务: {}"</span>, taskId);
                    <span class="hljs-comment">// 执行任务</span>
                });
            }
        }
    }
    
    <span class="hljs-comment">// 虚拟线程与CompletableFuture结合</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">processAsync</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-comment">// 业务逻辑</span>
            <span class="hljs-keyword">return</span> <span class="hljs-string">"处理结果"</span>;
        }, Executors.newVirtualThreadPerTaskExecutor());
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[工厂模式]]></title>    <link>https://juejin.cn/post/7590213554798985251</link>    <guid>https://juejin.cn/post/7590213554798985251</guid>    <pubDate>2026-01-03T14:00:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590213554798985251" data-draft-id="7590213554798952483" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="工厂模式"/> <meta itemprop="keywords" content="设计模式"/> <meta itemprop="datePublished" content="2026-01-03T14:00:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="XRay"/> <meta itemprop="url" content="https://juejin.cn/user/3966693685869288"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            工厂模式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3966693685869288/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    XRay
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T14:00:14.000Z" title="Sat Jan 03 2026 14:00:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">简单工厂模式</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span>{
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductA</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Product</span>{
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductB</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Product</span>{
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Factory</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Product <span class="hljs-title function_">produce</span><span class="hljs-params">(<span class="hljs-type">int</span> type)</span>{
        <span class="hljs-keyword">if</span>(type == <span class="hljs-number">1</span>){
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductA</span>();
        }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(type == <span class="hljs-number">2</span>){
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductB</span>();
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<p>这种设计模式有什么优点？</p>
<p>它将调用 produce() 方法的调用方与生产 Product 的具体细节分离开了。</p>
<p>比如小王想生产产品 A，他直接调用 produce() 方法，传入 type，就可以拿到 ProductA，不需要关心 ProductA 是如何生产出来的，也不需要关心 ProductA 里面的具体细节。</p>
<p>这种设计模式又有什么缺点呢？</p>
<p>如果你想添加另外一种产品 ProductC ，就不得不修改 produce() 方法，这样就违背了 <code>开闭原则</code> 。</p>
<p>什么是开闭原则？</p>
<blockquote>
<p>开闭原则简单来说就是：<strong>对修改关闭，对拓展开放</strong>。即当我们想要拓展功能的时候最好不要修改已有的代码，以免产生 Bug，应该提前做好类的抽象，在抽象的基础上进行拓展。</p>
</blockquote>
<h4 data-id="heading-1">工厂方法模式</h4>
<p>使用工厂方法模式就可以解决上面这个问题，我们来看代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbsFactory</span> {
    <span class="hljs-keyword">abstract</span> Product <span class="hljs-title function_">produce</span><span class="hljs-params">()</span>;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FactoryA</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbsFactory</span>{
    <span class="hljs-meta">@Override</span>
    Product <span class="hljs-title function_">produce</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductA</span>();
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FactoryB</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbsFactory</span> {
    <span class="hljs-meta">@Override</span>
    Product <span class="hljs-title function_">produce</span><span class="hljs-params">()</span> {
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductB</span>();
    }
}
</code></pre>
<p>调用方直接调用对应工厂类的 produce() 方法即可：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">AbsFactory</span> <span class="hljs-variable">factoryA</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FactoryA</span>();
        factoryA.produce();
    }
}
</code></pre>
<p>如果后续你想添加产品 ProductC，直接添加 ProductC 及 FactoryC 即可，不需要对已有的代码进行修改，符合开闭原则；同时符合单一职责原则，每个具体工厂类只负责创建对应的产品，不需要像简单工厂那样存在复杂的 if 逻辑判断。</p>
<p>Android 中<code>RecyclerView.Adapter</code>就运用了工厂方法模式：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Adapter</span>&lt;VH <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ViewHolder</span>&gt; {
    <span class="hljs-comment">//延迟实现构建细节到子类中</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> VH <span class="hljs-title function_">onCreateViewHolder</span><span class="hljs-params">(ViewGroup parent, <span class="hljs-type">int</span> viewType)</span>;
}
</code></pre>
<p>Adapter 不知道具体 ViewHolder 类型，由子类决定如何根据 viewType 创建对应的 ViewHolder，这正是工厂方法的精髓：<strong>把实例化推迟到子类</strong>。</p>
<h4 data-id="heading-2">抽象工厂模式</h4>
<p>如果产品A包含2个零件：PartOne 和 PartTwo，就可以使用抽象工厂模式来实现：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//零件1</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PartOne</span> {
}

<span class="hljs-comment">//零件2</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PartTwo</span> {
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Factory</span> {
    PartOne <span class="hljs-title function_">produceOne</span><span class="hljs-params">()</span>;
    PartTwo <span class="hljs-title function_">produceTwo</span><span class="hljs-params">()</span>; 
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FactoryA</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Factory</span>{

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> PartOne <span class="hljs-title function_">produceOne</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PartOne</span>();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> PartTwo <span class="hljs-title function_">produceTwo</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PartTwo</span>();
    }
}

<span class="hljs-comment">//产品A</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductA</span> {
    <span class="hljs-keyword">private</span> PartOne partOne;
    <span class="hljs-keyword">private</span> PartTwo partTwo;

    <span class="hljs-keyword">private</span> Factory factory;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ProductA</span><span class="hljs-params">(Factory factory)</span>{
        <span class="hljs-built_in">this</span>.factory = factory;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">prepare</span><span class="hljs-params">()</span>{
        partOne = factory.produceOne();
        partTwo = factory.produceTwo();
    }

}
</code></pre>
<p>使用方法如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Factory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FactoryA</span>();
        <span class="hljs-type">ProductA</span> <span class="hljs-variable">productA</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductA</span>(factory);
        productA.prepare();
    }
}
</code></pre>
<p>抽象工厂模式与工厂方法模式的区别在于抽象工厂模式适用于构建一组关联对象的场景，例如上例中 ProductA 中包含的两个对象：PartOne 和 PartTwo。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot LiquibasePlus 数据库版本管理工具加强使用指南]]></title>    <link>https://juejin.cn/post/7590403249561583631</link>    <guid>https://juejin.cn/post/7590403249561583631</guid>    <pubDate>2026-01-04T01:59:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590403249561583631" data-draft-id="7540566577622614079" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot LiquibasePlus 数据库版本管理工具加强使用指南"/> <meta itemprop="keywords" content="Spring Boot"/> <meta itemprop="datePublished" content="2026-01-04T01:59:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="昵称为空C"/> <meta itemprop="url" content="https://juejin.cn/user/1267096172897005"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot LiquibasePlus 数据库版本管理工具加强使用指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1267096172897005/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    昵称为空C
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T01:59:52.000Z" title="Sun Jan 04 2026 01:59:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>摘要：本文主要介绍了基于<code>springboot</code>+<code>liquibase</code>的数据库版本管理工具的使用说明；案例封装了<code>liquibase</code>的功能进行了业务增强，让实际生成环境使用更省心。</p>
<h2 data-id="heading-0">直接使用会遇到的问题</h2>
<ul>
<li>异常退出导致<code>databasechangeloglock</code>锁表，需要手动清理数据。</li>
<li>无法满足多租户使用。</li>
<li>无法满足多数据库适配。</li>
</ul>
<h2 data-id="heading-1"><code>LiquibasePlus</code>封装案例</h2>
<blockquote>
<p>只是在<code>Liquibase</code>上做了功能增强。</p>
</blockquote>
<h3 data-id="heading-2"><code>pom.xml</code></h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.liquibase<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>liquibase-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-3"><code>LiquibaseApplication</code></h3>
<blockquote>
<p>启动类</p>
</blockquote>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LiquibaseApplication</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">SpringApplication</span>.<span class="hljs-title function_">run</span>(<span class="hljs-title class_">LiquibaseApplication</span>.<span class="hljs-property">class</span>, args);
    }
}
</code></pre>
<h3 data-id="heading-4"><code>application.yml</code></h3>
<blockquote>
<p>配置文件</p>
</blockquote>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">super_admin</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">super_admin</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://192.168.8.134:30635/test_1?useSSL=false&amp;serverTimezone=UTC</span>
  <span class="hljs-attr">liquibase:</span>
    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span>
  <span class="hljs-attr">liquibase-plus:</span>
    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">super_admin</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">super_admin</span>
    <span class="hljs-attr">jdbc-url:</span> <span class="hljs-string">jdbc:mysql://192.168.8.134:30635/test_1?useSSL=false&amp;serverTimezone=UTC</span>
    <span class="hljs-attr">change-log:</span> <span class="hljs-string">classpath*:sql/mysql/changelog.xml</span>
</code></pre>
<h3 data-id="heading-5"><code>SpringLiquibasePlusProperties</code></h3>
<blockquote>
<p>属性配置类</p>
</blockquote>
<pre><code class="hljs language-arduino" lang="arduino">@Data
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringLiquibasePlusProperties</span> {

    <span class="hljs-comment">/** 是否开启 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> enabled;
    <span class="hljs-comment">/** 驱动名称 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> driverClassName;
    <span class="hljs-comment">/** 链接地址 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> jdbcUrl;
    <span class="hljs-comment">/** 用户名 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> username;
    <span class="hljs-comment">/** 密码 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> password;
    <span class="hljs-comment">/** 数据库schema */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> schema;
    <span class="hljs-comment">/** 变更日志 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> changeLog;

}
</code></pre>
<h3 data-id="heading-6"><code>SpringLiquibasePlusExecutor</code></h3>
<blockquote>
<p><code>liquibase</code>执行器</p>
</blockquote>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Slf</span>4j
public class SpringLiquibasePlusExecutor {

    private final ResourceLoader resourceLoader;

    public <span class="hljs-built_in">SpringLiquibasePlusExecutor</span>(ResourceLoader resourceLoader) {
        this<span class="hljs-selector-class">.resourceLoader</span> = resourceLoader;
    }

    <span class="hljs-comment">/**
     * 初始化数据库
     * @param properties
     */</span>
    public void <span class="hljs-built_in">execute</span>(SpringLiquibasePlusProperties properties) throws Exception{
        <span class="hljs-built_in">try</span>(HikariDataSource hikariDataSource = this.buildDataSource(properties)) {
            SpringLiquibase liquibase = new <span class="hljs-built_in">SpringLiquibase</span>();
            liquibase<span class="hljs-selector-class">.setDataSource</span>(hikariDataSource);
            liquibase<span class="hljs-selector-class">.setResourceLoader</span>(resourceLoader);
            liquibase<span class="hljs-selector-class">.setDatabaseChangeLogTable</span>("databasechangelog");
            liquibase<span class="hljs-selector-class">.setDatabaseChangeLogLockTable</span>("databasechangeloglock");
            <span class="hljs-comment">//指定changelog的位置，这里使用的一个master文件引用其他文件的方式</span>
            liquibase<span class="hljs-selector-class">.setChangeLog</span>(properties.getChangeLog());
            liquibase<span class="hljs-selector-class">.setShouldRun</span>(true);
            <span class="hljs-comment">// 检查锁表的情况</span>
            <span class="hljs-built_in">removeTimeoutLock</span>(hikariDataSource, liquibase.getDatabaseChangeLogLockTable());
            liquibase<span class="hljs-selector-class">.afterPropertiesSet</span>();
        }
    }

    <span class="hljs-comment">/**
     * 构建数据源
     * @param properties
     * @return
     */</span>
    private HikariDataSource <span class="hljs-built_in">buildDataSource</span>(SpringLiquibasePlusProperties properties){
        HikariDataSource hikariDataSource = new <span class="hljs-built_in">HikariDataSource</span>();
        hikariDataSource<span class="hljs-selector-class">.setDriverClassName</span>(properties.getDriverClassName());
        hikariDataSource<span class="hljs-selector-class">.setJdbcUrl</span>(properties.getJdbcUrl());
        hikariDataSource<span class="hljs-selector-class">.setUsername</span>(properties.getUsername());
        hikariDataSource<span class="hljs-selector-class">.setPassword</span>(properties.getPassword());
        hikariDataSource<span class="hljs-selector-class">.setSchema</span>(properties.getSchema());
        hikariDataSource<span class="hljs-selector-class">.setMinimumIdle</span>(<span class="hljs-number">1</span>);
        hikariDataSource<span class="hljs-selector-class">.setMaximumPoolSize</span>(<span class="hljs-number">1</span>);
        return hikariDataSource;
    }

    <span class="hljs-comment">/**
     * 移除超时的锁
     * 如果要写得更好，先判断表存在没有，存在了再执行SQL语句，我这里捕获异常处理的
     * @param dataSource
     * @param tableName
     */</span>
    public void <span class="hljs-built_in">removeTimeoutLock</span>(DataSource dataSource, String tableName){
        <span class="hljs-comment">// 超时5分钟就认为超时，这里可以自己自定义</span>
        Timestamp lastDBLockTime = new <span class="hljs-built_in">Timestamp</span>(new java.util.Date()<span class="hljs-selector-class">.getTime</span>() - (<span class="hljs-number">5</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>));
        <span class="hljs-comment">// 这里的SQL语句需要按照自己的数据库方式来，现阶段我就遇到`oracle`写法不一样</span>
        String sql = String<span class="hljs-selector-class">.format</span>("UPDATE %s SET LOCKED = <span class="hljs-number">0</span>, LOCKGRANTED = NULL, LOCKEDBY = NULL WHERE LOCKED = <span class="hljs-number">1</span> AND LOCKGRANTED &lt; '%s'", tableName, lastDBLockTime);

        try (Connection connection = dataSource.getConnection(); Statement stmt = connection<span class="hljs-selector-class">.createStatement</span>()) {
            int updateCount = stmt<span class="hljs-selector-class">.executeUpdate</span>(sql);
            <span class="hljs-built_in">if</span>(updateCount &gt; <span class="hljs-number">0</span>){
                log<span class="hljs-selector-class">.info</span>("liquibase异常锁解除成功");
            }else {
                log<span class="hljs-selector-class">.info</span>("liquibase无异常锁");
            }
        } catch (Exception ex) {
            <span class="hljs-built_in">if</span>(!(ex instanceof SQLException)){
                <span class="hljs-comment">// 直接跳过不用处理异常了</span>
                log<span class="hljs-selector-class">.error</span>("liquibase解锁异常", ex);
            }else {
                log<span class="hljs-selector-class">.warn</span>("liquibase初次加载");
            }
        }
    }

}
</code></pre>
<h3 data-id="heading-7"><code>SpringLiquibasePlusConfig</code>启动配置</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Slf4j</span>
<span class="hljs-variable">@Configuration</span>
<span class="hljs-variable">@ConditionalOnProperty</span>(
        prefix = <span class="hljs-string">"spring.liquibase-plus"</span>,
        name = {<span class="hljs-string">"enabled"</span>}
)
public class SpringLiquibasePlusConfig {

    <span class="hljs-variable">@Autowired</span>
    private ResourceLoader resourceLoader;
    <span class="hljs-variable">@Autowired</span>
    private List&lt;CustomTaskChange&gt; customTaskChanges;

    <span class="hljs-variable">@Bean</span>
    <span class="hljs-variable">@ConfigurationProperties</span>(prefix = <span class="hljs-string">"spring.liquibase-plus"</span>,ignoreUnknownFields = false)
    public SpringLiquibasePlusProperties <span class="hljs-built_in">springLiquibasePlusProperties</span>() {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">SpringLiquibasePlusProperties</span>();
    }

    @<span class="hljs-selector-tag">Bean</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">SpringLiquibasePlusExecutor</span> <span class="hljs-selector-tag">springLiquibasePlusExecuter</span>(SpringLiquibasePlusProperties springLiquibasePlusProperties) <span class="hljs-selector-tag">throws</span> <span class="hljs-selector-tag">Exception</span> {
        <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"Liquibase CustomTaskChange size: {}, names: {}"</span>, customTaskChanges.<span class="hljs-built_in">size</span>(), customTaskChanges.<span class="hljs-built_in">stream</span>().<span class="hljs-built_in">map</span>(<span class="hljs-attribute">CustomTaskChange</span>::getClass).<span class="hljs-built_in">collect</span>(Collectors.<span class="hljs-built_in">toSet</span>()));
        <span class="hljs-selector-tag">customTaskChanges</span><span class="hljs-selector-class">.forEach</span>(<span class="hljs-attribute">CustomChange</span>::getConfirmationMessage);
        <span class="hljs-selector-tag">SpringLiquibasePlusExecutor</span> <span class="hljs-selector-tag">springLiquibasePlusExecutor</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">SpringLiquibasePlusExecutor</span>(resourceLoader);
        <span class="hljs-selector-tag">springLiquibasePlusExecutor</span><span class="hljs-selector-class">.execute</span>(springLiquibasePlusProperties);
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">springLiquibasePlusExecutor</span>;
    }

}
</code></pre>
<h3 data-id="heading-8"><code>V1_00_00_ClearCustomTaskChange</code></h3>
<blockquote>
<p><code>sql</code>中解决不了的，需要用<code>java</code>代码来进行版本管理的业务。</p>
</blockquote>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">V1_00_00_ClearCustomTaskChange</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CustomTaskChange</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">JdbcTemplate</span> jdbcTemplate;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setJdbcTemplate</span>(<span class="hljs-params">JdbcTemplate jdbcTemplate</span>) {
        V1_00_00_ClearCustomTaskChange.<span class="hljs-property">jdbcTemplate</span> = jdbcTemplate;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">execute</span>(<span class="hljs-title class_">Database</span> database) throws <span class="hljs-title class_">CustomChangeException</span> {
        <span class="hljs-comment">// 这里写liquibase简单的sql语句做不了的复杂写法，我这里只做简单演示，这里强烈建议用jdbcTemplate查询其他的表，并且只查询自己需要的字段</span>
        <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt;&gt; mapList = jdbcTemplate.<span class="hljs-title function_">queryForList</span>(<span class="hljs-string">"select * from school_01 where name = 'A'"</span>);
        <span class="hljs-keyword">if</span>(<span class="hljs-title class_">CollectionUtils</span>.<span class="hljs-title function_">isEmpty</span>(mapList)) {
            <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
                jdbcTemplate.<span class="hljs-title function_">update</span>(<span class="hljs-string">"insert into school_01(id, name) values (?, ?)"</span>, i, <span class="hljs-string">"A"</span> + i);
            }
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getConfirmationMessage</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"SUCCESS"</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setUp</span>() throws <span class="hljs-title class_">SetupException</span> {

    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setFileOpener</span>(<span class="hljs-params">ResourceAccessor resourceAccessor</span>) {

    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">ValidationErrors</span> <span class="hljs-title function_">validate</span>(<span class="hljs-params">Database database</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<h3 data-id="heading-9"><code>changelog.xml</code></h3>
<blockquote>
<p>主要的数据库版本管理文件</p>
</blockquote>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">databaseChangeLog</span>
        <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.liquibase.org/xml/ns/dbchangelog"</span>
        <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
        <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd"</span>&gt;</span>

    <span class="hljs-comment">&lt;!--  初始化表结构  --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">file</span>=<span class="hljs-string">"/sql/mysql/V1.00.00.sql"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">changeSet</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"V1.00.00-003-1"</span> <span class="hljs-attr">author</span>=<span class="hljs-string">"huzhihui"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">customChange</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.github.sp3.liquibase.config.custom.V1_00_00_ClearCustomTaskChange"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">changeSet</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">file</span>=<span class="hljs-string">"/sql/mysql/V1.00.01.sql"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">databaseChangeLog</span>&gt;</span>
</code></pre>
<h3 data-id="heading-10"><code>V1.00.00.sql</code></h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">--liquibase formatted sql</span>

<span class="hljs-comment">--changeset huzhihui:V1.00.00-001-1</span>
<span class="hljs-comment">--preconditions onFail:MARK_RAN onError:MARK_RAN</span>
<span class="hljs-comment">--precondition-sql-check expectedResult:0 select count(1) from information_schema.tables where table_schema = (select database()) and table_name = 'school_01';</span>
<span class="hljs-comment">--comment 测试表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `school_01` (
  `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `create_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `time_zone` <span class="hljs-type">timestamp</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `time_no_zone` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB;

<span class="hljs-comment">--changeset huzhihui:V1.00.00-002-1</span>
<span class="hljs-comment">--preconditions onFail:MARK_RAN onError:MARK_RAN</span>
<span class="hljs-comment">--precondition-sql-check expectedResult:0 select count(1) from information_schema.tables where table_schema = (select database()) and table_name = 'school_02';</span>
<span class="hljs-comment">--comment 测试表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `school_02` (
 `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
 `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
 `create_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
 `time_zone` <span class="hljs-type">timestamp</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
 `time_no_zone` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
 <span class="hljs-keyword">PRIMARY</span> KEY (`id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB;
</code></pre>
<h3 data-id="heading-11"><code>V1.00.01.sql</code></h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">--liquibase formatted sql</span>

<span class="hljs-comment">--changeset huzhihui:V1.00.01-001-1</span>
<span class="hljs-comment">--preconditions onFail:MARK_RAN onError:MARK_RAN</span>
<span class="hljs-comment">--precondition-sql-check expectedResult:0 select count(1) from information_schema.tables where table_schema = (select database()) and table_name = 'school_03';</span>
<span class="hljs-comment">--comment 测试表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `school_03` (
  `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `create_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `time_zone` <span class="hljs-type">timestamp</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `time_no_zone` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB;
</code></pre>
<h2 data-id="heading-12">最终执行结果</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71a3c708cc564645a333c548df64f9c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pi156ew5Li656m6Qw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768096792&amp;x-signature=%2FpDEi12m%2FVVZqTA0Y2RruqahNkQ%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3990f674ad474230ae6f8dc51bf5e86d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pi156ew5Li656m6Qw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768096792&amp;x-signature=60J%2FmmJaMwC%2FWXwv%2BsoX2zrDP6w%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed1cb86741334a758c66d34fde76e30f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pi156ew5Li656m6Qw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768096792&amp;x-signature=vEsepQ2L%2FEe7G0lkUZSCBE1W%2Bns%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5dff566ad5a4cfebd8e63bb9c540d84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pi156ew5Li656m6Qw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768096792&amp;x-signature=Os8ZEHQ4dF7QUm7Q5IR%2Fq5yam4w%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[7 个从入门到资深 PHP 开发者都在用的核心调试技能]]></title>    <link>https://juejin.cn/post/7590330924001493055</link>    <guid>https://juejin.cn/post/7590330924001493055</guid>    <pubDate>2026-01-04T00:02:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590330924001493055" data-draft-id="7590309337861767209" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="7 个从入门到资深 PHP 开发者都在用的核心调试技能"/> <meta itemprop="keywords" content="后端,PHP"/> <meta itemprop="datePublished" content="2026-01-04T00:02:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            7 个从入门到资深 PHP 开发者都在用的核心调试技能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T00:02:20.000Z" title="Sun Jan 04 2026 00:02:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">7 个从入门到资深 PHP 开发者都在用的核心调试技能</h2>
<h3 data-id="heading-1">调试的残酷真相</h3>
<p>大多数 PHP bug 难搞，不是因为它们"复杂"，而是因为它们<strong>看不见</strong>。</p>
<p>变量在比你预期早两层的地方就变成了 null。一个"不可能发生"的条件偏偏只在生产环境发生。请求在本地正常，放到代理后面就挂了。队列 worker 的行为和 HTTP 运行时不一样。还有经典场景：你修好了……下周它又回来了。</p>
<p>想快速成长为 PHP 开发者，别急着学更多框架特性。先学会<strong>观察系统实际在做什么</strong>。</p>
<p>下面是我认为每个 PHP 开发者从第一天就该掌握的 7 个调试技能。它们不是花招，而是会持续产生复利的习惯。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2026-01%2Fdebugging-php-like-a-pro" target="_blank" title="https://catchadmin.com/post/2026-01/debugging-php-like-a-pro" ref="nofollow noopener noreferrer">原文 7 个从入门到资深 PHP 开发者都在用的核心调试技能</a></p>
<h3 data-id="heading-2">错误要看得见，但别暴露给用户</h3>
<p>看不到错误，你就不是在调试——你是在猜。</p>
<p>PHP 提供了可靠的错误可见性原语：<code>error_reporting</code>、<code>display_errors</code> 和日志设置。关键是把开发环境和生产环境当作不同的可观测模式来对待。</p>
<p>PHP 官方手册强烈建议在生产网站上记录错误而非显示错误。</p>
<h4 data-id="heading-3">开发环境：全开</h4>
<p>在开发环境，你需要最大化的信号：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment">; php.ini (development)</span>
<span class="hljs-attr">error_reporting</span> = -<span class="hljs-number">1</span>
<span class="hljs-attr">display_errors</span> = <span class="hljs-literal">On</span>
<span class="hljs-attr">display_startup_errors</span> = <span class="hljs-literal">On</span>
<span class="hljs-attr">log_errors</span> = <span class="hljs-literal">On</span>
</code></pre>
<p>如果你用 Docker 或开发容器，确认容器内部的设置：</p>
<pre><code class="hljs language-bash" lang="bash">php -i | grep -E <span class="hljs-string">"error_reporting|display_errors|log_errors"</span>
</code></pre>
<h4 data-id="heading-4">生产环境：只记录，不显示</h4>
<p>在生产环境，<code>display_errors=On</code> 不是"有帮助"，而是漏洞。你要的是日志，不是泄露的堆栈跟踪。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment">; php.ini (production)</span>
<span class="hljs-attr">error_reporting</span> = -<span class="hljs-number">1</span>
<span class="hljs-attr">display_errors</span> = <span class="hljs-literal">Off</span>
<span class="hljs-attr">display_startup_errors</span> = <span class="hljs-literal">Off</span>
<span class="hljs-attr">log_errors</span> = <span class="hljs-literal">On</span>
<span class="hljs-attr">error_log</span> = /var/log/php/app-error.log
</code></pre>
<p>然后在故障期间 tail 日志：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">tail</span> -f /var/log/php/app-error.log
</code></pre>
<h4 data-id="heading-5">异常日志要带上下文</h4>
<p>别完全依赖 PHP 默认的错误日志格式。在应用启动时添加一个顶层异常处理器（框架无关）：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);

<span class="hljs-title function_ invoke__">set_exception_handler</span>(function (<span class="hljs-built_in">Throwable</span> <span class="hljs-variable">$e</span>) {
    <span class="hljs-title function_ invoke__">error_log</span>(<span class="hljs-title function_ invoke__">json_encode</span>([
        <span class="hljs-string">'level'</span> =&gt; <span class="hljs-string">'error'</span>,
        <span class="hljs-string">'event'</span> =&gt; <span class="hljs-string">'uncaught_exception'</span>,
        <span class="hljs-string">'message'</span> =&gt; <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>(),
        <span class="hljs-string">'type'</span> =&gt; <span class="hljs-variable">$e</span>::<span class="hljs-variable language_">class</span>,
        <span class="hljs-string">'file'</span> =&gt; <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getFile</span>(),
        <span class="hljs-string">'line'</span> =&gt; <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getLine</span>(),
        <span class="hljs-string">'trace'</span> =&gt; <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">"\n"</span>, <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getTraceAsString</span>()),
    ], JSON_UNESCAPED_SLASHES));
});
</code></pre>
<p>这是"穷人版结构化日志"，但已经比经典的"崩了，不知道为啥"强多了。</p>
<p><strong>技能检验</strong>：如果有人给你一张生产环境的错误截图，你应该能说："关掉那个。放到日志里。加上关联 ID。然后复现。"</p>
<h3 data-id="heading-6">Xdebug 步进调试：别再瞎猜了</h3>
<p><code>var_dump()</code> 在探索时还行。步进调试才是你认真排查时用的工具。</p>
<p>Xdebug 的步进调试器让你可以逐步执行代码并交互式地检查状态。</p>
<h4 data-id="heading-7">理解它能干什么</h4>
<p>步进调试回答的问题：</p>
<ul>
<li>代码实际走了哪条路径？</li>
<li>这里的值是什么，不是你脑子里想的那个？</li>
<li>为什么这个分支被执行了？</li>
<li>是什么修改了这个变量？</li>
</ul>
<h4 data-id="heading-8">Xdebug 3 最小配置</h4>
<p>Xdebug 有多种模式和现代化的配置方式。官方文档覆盖了步进调试和所有设置。</p>
<p>在大多数环境中，可以这样配置：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment">; xdebug.ini</span>
<span class="hljs-attr">xdebug.mode</span> = debug
<span class="hljs-attr">xdebug.start_with_request</span> = <span class="hljs-literal">yes</span>
<span class="hljs-attr">xdebug.client_port</span> = <span class="hljs-number">9003</span>
</code></pre>
<p>为什么是 9003？Xdebug 3 改了默认端口（这是"连不上"问题的常见原因）。IDE 文档和社区答案通常把 9003 作为 Xdebug 3 的默认端口。</p>
<h4 data-id="heading-9">共享环境别常开调试</h4>
<p>更好的习惯是"需要时才调试"。这样能保持性能稳定，避免意外暴露调试行为。</p>
<p>尽量用环境变量：</p>
<pre><code class="hljs language-bash" lang="bash">XDEBUG_MODE=debug php -S localhost:8000 -t public
</code></pre>
<p>或者对于 PHP-FPM/容器，只在开发环境设置 <code>XDEBUG_MODE=debug</code>。</p>
<h4 data-id="heading-10">高效的调试流程</h4>
<ol>
<li>在可疑函数的第一行打断点</li>
<li>触发请求</li>
<li>步进进入函数</li>
<li>观察：
<ul>
<li>输入参数</li>
<li>分支条件</li>
<li>意外的 null / 空字符串</li>
<li>"神秘"变化的值</li>
</ul>
</li>
<li>找到错误假设后，停下来。用一句话写下来。</li>
</ol>
<p>最后一步很重要：目标不是"无限探索"，而是快速找到错误的假设。</p>
<h3 data-id="heading-11">告别 var_dump()，用更好的方式 dump</h3>
<p>dump 仍然有用。错误在于盲目 dump。</p>
<p>Symfony 的 VarDumper 组件提供了比 <code>var_dump()</code> 更易读的 <code>dump()</code> 函数。很多流行生态（包括 Laravel）的 <code>dd()</code> 便捷函数都基于 VarDumper 风格的 dump 构建。</p>
<h4 data-id="heading-12">dump 关键字段，别 dump 整个对象</h4>
<p>与其 dump 整个对象图然后滚动 5 分钟，不如 dump 你关心的形状。</p>
<p><strong>差</strong>：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title function_ invoke__">dump</span>(<span class="hljs-variable">$request</span>);
</code></pre>
<p><strong>好</strong>：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title function_ invoke__">dump</span>([
  <span class="hljs-string">'method'</span> =&gt; <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">getMethod</span>(),
  <span class="hljs-string">'path'</span>   =&gt; <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">getPathInfo</span>(),
  <span class="hljs-string">'userId'</span> =&gt; <span class="hljs-variable">$user</span>?-&gt;id,
]);
</code></pre>
<h4 data-id="heading-13">写个临时的调试辅助函数</h4>
<p>在纯 PHP 应用中，定义一个小辅助函数：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dd</span>(<span class="hljs-params"><span class="hljs-keyword">mixed</span> <span class="hljs-variable">$value</span></span>): <span class="hljs-title">never</span> </span>{
    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">'Content-Type: text/plain; charset=utf-8'</span>);
    <span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$value</span>);
    <span class="hljs-keyword">exit</span>(<span class="hljs-number">1</span>);
}
</code></pre>
<p>然后谨慎使用。重点是速度。</p>
<p><strong>规则</strong>：如果一个流程里有超过 3 个 dump，你可能需要步进调试或带关联 ID 的日志。</p>
<h3 data-id="heading-14">日志要像证据，不是流水账</h3>
<p>日志不应该是散落在代码里的随机句子。日志应该是<strong>证据</strong>。</p>
<p>如果你用 Laravel，它的日志系统是基于 channel 的，默认使用"stack" channel。Laravel 还有"context"能力，可以在请求/任务/命令中捕获共享元数据并包含在日志里。</p>
<p>即使你不用 Laravel，这个模式到处适用：一次性附加上下文，每行日志都变得更有用。</p>
<h4 data-id="heading-15">给每个请求加关联 ID</h4>
<p>这是投入产出比最高的调试手段之一。</p>
<p>框架无关的示例：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getCorrelationId</span>(<span class="hljs-params"/>): <span class="hljs-title">string</span> </span>{
    <span class="hljs-variable">$hdr</span> = <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'HTTP_X_REQUEST_ID'</span>] ?? <span class="hljs-string">''</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_string</span>(<span class="hljs-variable">$hdr</span>) &amp;&amp; <span class="hljs-variable">$hdr</span> !== <span class="hljs-string">''</span>) <span class="hljs-keyword">return</span> <span class="hljs-variable">$hdr</span>;
    <span class="hljs-comment">// 如果没有就生成一个</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">bin2hex</span>(<span class="hljs-title function_ invoke__">random_bytes</span>(<span class="hljs-number">16</span>));
}
<span class="hljs-variable">$reqId</span> = <span class="hljs-title function_ invoke__">getCorrelationId</span>();
<span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">'X-Request-Id: '</span> . <span class="hljs-variable">$reqId</span>);
</code></pre>
<p>然后加到日志里：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title function_ invoke__">error_log</span>(<span class="hljs-title function_ invoke__">json_encode</span>([
  <span class="hljs-string">'level'</span> =&gt; <span class="hljs-string">'info'</span>,
  <span class="hljs-string">'event'</span> =&gt; <span class="hljs-string">'checkout.start'</span>,
  <span class="hljs-string">'request_id'</span> =&gt; <span class="hljs-variable">$reqId</span>,
  <span class="hljs-string">'user_id'</span> =&gt; <span class="hljs-variable">$userId</span> ?? <span class="hljs-literal">null</span>,
  <span class="hljs-string">'cart_items'</span> =&gt; <span class="hljs-title function_ invoke__">count</span>(<span class="hljs-variable">$items</span>),
]));
</code></pre>
<h4 data-id="heading-16">记录分支决策，而非流水事件</h4>
<p>决策点是行为分叉的地方：</p>
<ul>
<li>授权检查</li>
<li>选择支付提供商</li>
<li>回退逻辑</li>
<li>重试</li>
<li>功能开关</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$logger</span>-&gt;<span class="hljs-title function_ invoke__">info</span>(<span class="hljs-string">'payment.route'</span>, [
  <span class="hljs-string">'request_id'</span> =&gt; <span class="hljs-variable">$reqId</span>,
  <span class="hljs-string">'order_id'</span> =&gt; <span class="hljs-variable">$orderId</span>,
  <span class="hljs-string">'provider'</span> =&gt; <span class="hljs-variable">$providerName</span>,
  <span class="hljs-string">'reason'</span> =&gt; <span class="hljs-string">'currency_supported'</span>,
]);
</code></pre>
<h4 data-id="heading-17">敏感信息绝对不能进日志</h4>
<p>脱敏 token、密码、Authorization header、session ID。调试不值得让凭证永远泄露在日志里。</p>
<h3 data-id="heading-18">不能复现的 bug 等于没修</h3>
<p>不能复现的 bug 没有被修复，它只是在睡觉。</p>
<p>成为"调试高手"最快的方法是学会创建最小复现。</p>
<h4 data-id="heading-19">最小复现清单</h4>
<p>bug 报告来了，立刻捕获这些：</p>
<ul>
<li>精确的输入 payload（或脱敏版本）</li>
<li>环境差异（PHP 版本、扩展、配置）</li>
<li>时间相关条件（时区、当前日期、夏令时）</li>
<li>并发条件（1 个请求 vs 10 个并发）</li>
<li>数据前置条件（特定的数据库行）</li>
</ul>
<p>然后精简。</p>
<p>如果你的应用需要 20 步才能复现，目标是 3 步。如果需要 3 步，目标是 1 步。</p>
<h4 data-id="heading-20">把 bug 变成测试用例</h4>
<p>这是真正的团队阻止回归的方式。</p>
<p>示例：一个微妙的折扣舍入 bug，只在特定价格时出现。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);

<span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Discount</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">apply</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> <span class="hljs-variable">$priceCents</span>, <span class="hljs-keyword">int</span> <span class="hljs-variable">$percent</span></span>): <span class="hljs-title">int</span>
    </span>{
        <span class="hljs-variable">$cut</span> = (<span class="hljs-keyword">int</span>) <span class="hljs-title function_ invoke__">round</span>(<span class="hljs-variable">$priceCents</span> * (<span class="hljs-variable">$percent</span> / <span class="hljs-number">100</span>));
        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">max</span>(<span class="hljs-number">0</span>, <span class="hljs-variable">$priceCents</span> - <span class="hljs-variable">$cut</span>);
    }
}
</code></pre>
<p>写回归测试：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);

<span class="hljs-keyword">use</span> <span class="hljs-title">PHPUnit</span>\<span class="hljs-title">Framework</span>\<span class="hljs-title">TestCase</span>;
<span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DiscountTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TestCase</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testRoundingEdgeCase</span>(<span class="hljs-params"/>): <span class="hljs-title">void</span>
    </span>{
        <span class="hljs-variable">$d</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Discount</span>();
        <span class="hljs-comment">// Bug 报告：999 分钱打 10% 折扣产生了 900 而非 899</span>
        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">assertSame</span>(<span class="hljs-number">899</span>, <span class="hljs-variable">$d</span>-&gt;<span class="hljs-title function_ invoke__">apply</span>(<span class="hljs-number">999</span>, <span class="hljs-number">10</span>));
    }
}
</code></pre>
<p>现在你有了：</p>
<ul>
<li>几秒钟就能跑完的复现</li>
<li>防止以后重新引入 bug 的安全网</li>
</ul>
<h4 data-id="heading-21">时间相关的 bug：冻结时间</h4>
<p>如果你的代码依赖时间，你会追鬼。</p>
<p>在应用代码中，包装"现在"：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Clock</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">now</span>(<span class="hljs-params"/>): <span class="hljs-title">DateTimeImmutable</span></span>;
}

<span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SystemClock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Clock</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">now</span>(<span class="hljs-params"/>): <span class="hljs-title">DateTimeImmutable</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTimeImmutable</span>(<span class="hljs-string">'now'</span>);
    }
}
</code></pre>
<p>在测试中，注入固定的 clock。你的调试就变得确定性了。</p>
<h3 data-id="heading-22">边界调试：数据库和外部 API</h3>
<p>在现代 PHP 应用中，bug 往往不在你的业务逻辑里。它在：</p>
<ul>
<li>返回意外结构的查询</li>
<li>N+1 查询模式</li>
<li>导致超时的慢事务</li>
<li>返回微妙不同 payload 的外部 API</li>
</ul>
<h4 data-id="heading-23">数据库：先看查询数量</h4>
<p>如果你的接口突然变慢，第一个问题往往是："这个请求执行了多少查询？"</p>
<p>框架无关的方式（PDO 包装器）可以计数查询。Laravel/Symfony 可以接入它们的数据库 profiler 功能。不管什么技术栈，习惯是一样的：</p>
<ul>
<li>捕获查询数量</li>
<li>捕获慢查询</li>
<li>小心捕获参数（避免泄露敏感信息）</li>
</ul>
<p>示例（概念性伪包装器）：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Db</span>
</span>{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> <span class="hljs-variable">$count</span> = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> PDO <span class="hljs-variable">$pdo</span></span>) </span>{}
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">query</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$sql</span>, <span class="hljs-keyword">array</span> <span class="hljs-variable">$params</span> = []</span>): <span class="hljs-title">array</span>
    </span>{
        <span class="hljs-variable language_">$this</span>-&gt;count++;
        <span class="hljs-variable">$stmt</span> = <span class="hljs-variable language_">$this</span>-&gt;pdo-&gt;<span class="hljs-title function_ invoke__">prepare</span>(<span class="hljs-variable">$sql</span>);
        <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">execute</span>(<span class="hljs-variable">$params</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">fetchAll</span>(PDO::<span class="hljs-variable constant_">FETCH_ASSOC</span>);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">queryCount</span>(<span class="hljs-params"/>): <span class="hljs-title">int</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;count; }
}
</code></pre>
<p>请求结束时：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$logger</span>-&gt;<span class="hljs-title function_ invoke__">info</span>(<span class="hljs-string">'request.db'</span>, [
  <span class="hljs-string">'request_id'</span> =&gt; <span class="hljs-variable">$reqId</span>,
  <span class="hljs-string">'query_count'</span> =&gt; <span class="hljs-variable">$db</span>-&gt;<span class="hljs-title function_ invoke__">queryCount</span>(),
]);
</code></pre>
<h4 data-id="heading-24">外部 HTTP：记录元数据，别记 body</h4>
<p>你需要的是：</p>
<ul>
<li>method</li>
<li>host/path</li>
<li>status</li>
<li>duration</li>
<li>retries</li>
<li>关联 ID</li>
</ul>
<p>示例包装器：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">callPartnerApi</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$url</span>, <span class="hljs-keyword">array</span> <span class="hljs-variable">$headers</span></span>): <span class="hljs-title">array</span>
</span>{
    <span class="hljs-variable">$start</span> = <span class="hljs-title function_ invoke__">microtime</span>(<span class="hljs-literal">true</span>);
    <span class="hljs-variable">$ch</span> = <span class="hljs-title function_ invoke__">curl_init</span>(<span class="hljs-variable">$url</span>);
    <span class="hljs-title function_ invoke__">curl_setopt_array</span>(<span class="hljs-variable">$ch</span>, [
        CURLOPT_RETURNTRANSFER =&gt; <span class="hljs-literal">true</span>,
        CURLOPT_HTTPHEADER =&gt; <span class="hljs-title function_ invoke__">array_map</span>(
            fn(<span class="hljs-variable">$k</span>, <span class="hljs-variable">$v</span>) =&gt; <span class="hljs-string">"<span class="hljs-subst">$k</span>: <span class="hljs-subst">$v</span>"</span>,
            <span class="hljs-title function_ invoke__">array_keys</span>(<span class="hljs-variable">$headers</span>),
            <span class="hljs-variable">$headers</span>
        ),
        CURLOPT_TIMEOUT =&gt; <span class="hljs-number">10</span>,
        CURLOPT_CONNECTTIMEOUT =&gt; <span class="hljs-number">3</span>,
    ]);
    <span class="hljs-variable">$body</span> = <span class="hljs-title function_ invoke__">curl_exec</span>(<span class="hljs-variable">$ch</span>);
    <span class="hljs-variable">$status</span> = <span class="hljs-title function_ invoke__">curl_getinfo</span>(<span class="hljs-variable">$ch</span>, CURLINFO_HTTP_CODE);
    <span class="hljs-variable">$durationMs</span> = (<span class="hljs-keyword">int</span>) ((<span class="hljs-title function_ invoke__">microtime</span>(<span class="hljs-literal">true</span>) - <span class="hljs-variable">$start</span>) * <span class="hljs-number">1000</span>);
    <span class="hljs-title function_ invoke__">curl_close</span>(<span class="hljs-variable">$ch</span>);
    <span class="hljs-title function_ invoke__">error_log</span>(<span class="hljs-title function_ invoke__">json_encode</span>([
        <span class="hljs-string">'event'</span> =&gt; <span class="hljs-string">'http.out'</span>,
        <span class="hljs-string">'url'</span> =&gt; <span class="hljs-variable">$url</span>,
        <span class="hljs-string">'status'</span> =&gt; <span class="hljs-variable">$status</span>,
        <span class="hljs-string">'duration_ms'</span> =&gt; <span class="hljs-variable">$durationMs</span>,
    ]));
    <span class="hljs-keyword">return</span> [<span class="hljs-string">'status'</span> =&gt; <span class="hljs-variable">$status</span>, <span class="hljs-string">'body'</span> =&gt; <span class="hljs-variable">$body</span>];
}
</code></pre>
<p><strong>调试收益</strong>：一旦你有了带请求 ID 的 duration 和 status 日志，你就不用再猜 bug 是"我们的问题"还是"合作方 API 负载过高"了。</p>
<h3 data-id="heading-25">硬核手段：二分法、git bisect、断言守卫</h3>
<p>卡住的时候，暴力往往比聪明更有效。</p>
<h4 data-id="heading-26">二分法定位代码路径</h4>
<p>如果你有一个复杂流程（结账、预订、审批流水线），别读整个代码库。缩小范围。</p>
<ol>
<li>在可疑区域的开头加一条日志</li>
<li>在结尾加一条日志</li>
<li>如果开头的日志出现了但结尾的没出现，bug 就在里面</li>
<li>把区域一分为二，重复</li>
</ol>
<p>这就是"代码的二分查找"。效果惊人。</p>
<h4 data-id="heading-27">回归 bug 用 git bisect</h4>
<p>如果一个 bug"最近才开始出现"，别争论了，直接 bisect。</p>
<pre><code class="hljs language-bash" lang="bash">git bisect start
git bisect bad HEAD
git bisect good &lt;已知正常的-commit-或-tag&gt;
</code></pre>
<p>然后运行一个能复现问题的脚本/测试，每一步标记 good/bad，直到 Git 找到引入 bug 的 commit。</p>
<p>如果你没有复现脚本，那就是你的第一个任务（见技能 5）。</p>
<h4 data-id="heading-28">在边界加断言守卫</h4>
<p>大量调试时间花在处理"不可能的状态变成了可能"上。</p>
<p>添加快速失败并带清晰消息的守卫：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">requireNonEmptyString</span>(<span class="hljs-params"><span class="hljs-keyword">mixed</span> <span class="hljs-variable">$v</span>, <span class="hljs-keyword">string</span> <span class="hljs-variable">$name</span></span>): <span class="hljs-title">string</span> </span>{
    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">is_string</span>(<span class="hljs-variable">$v</span>) || <span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-variable">$v</span>) === <span class="hljs-string">''</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">"<span class="hljs-subst">$name</span> must be a non-empty string"</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$v</span>;
}
</code></pre>
<p>在 bug 聚集的地方使用它：解析输入、读取环境变量、处理外部 payload。</p>
<p>示例：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$apiKey</span> = <span class="hljs-title function_ invoke__">requireNonEmptyString</span>(<span class="hljs-title function_ invoke__">getenv</span>(<span class="hljs-string">'PARTNER_API_KEY'</span>), <span class="hljs-string">'PARTNER_API_KEY'</span>);
</code></pre>
<p>这不是"额外代码"。这是调试预防。</p>
<h3 data-id="heading-29">完整的调试工作流</h3>
<p>遇到 bug 时，跑这个循环：</p>
<h4 data-id="heading-30">第一步：让错误可见</h4>
<p>确认错误设置和日志（技能 1）。拿到真正的堆栈跟踪。</p>
<h4 data-id="heading-31">第二步：复现</h4>
<p>精简步骤。捕获输入。让它确定性（技能 5）。</p>
<h4 data-id="heading-32">第三步：选工具</h4>
<ul>
<li>一个变量错了？<code>dump()</code> 一个小形状（技能 3）</li>
<li>控制流不清楚？Xdebug 步进调试（技能 2）</li>
<li>分布式/系统问题？关联 ID + 结构化日志（技能 4）</li>
<li>回归？git bisect（技能 7）</li>
</ul>
<h4 data-id="heading-33">第四步：修复并锁定</h4>
<p>添加测试或守卫，让它不再回来（技能 5 / 技能 7）。</p>
<p>这就是整个游戏。</p>
<h3 data-id="heading-34">结语</h3>
<p>最好的 PHP 调试者没有神奇的直觉。他们有更好的反馈循环。</p>
<ul>
<li>错误可见但不泄露（PHP 官方也建议在生产环境记录而非显示）</li>
<li>猜不出来时有步进调试可用（Xdebug 就是为此而生）</li>
<li>dump 可读且有意识（VarDumper 的 <code>dump()</code> 存在是因为 <code>var_dump()</code> 太痛苦）</li>
<li>日志在执行过程中携带上下文（Laravel 明确支持在日志中包含 context）</li>
<li>bug 变成可复现的测试，而非反复出现的故事</li>
</ul>
<p>尽早掌握这七个技能，你的"调试时间"会大幅缩短——不是因为 bug 消失了，而是因为你的系统不再对你隐藏真相。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java并发编程避坑指南：5个常见的CompletableFuture性能陷阱及解决方案]]></title>    <link>https://juejin.cn/post/7590433626560643107</link>    <guid>https://juejin.cn/post/7590433626560643107</guid>    <pubDate>2026-01-04T00:17:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590433626560643107" data-draft-id="7590597231707799587" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java并发编程避坑指南：5个常见的CompletableFuture性能陷阱及解决方案"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-04T00:17:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java并发编程避坑指南：5个常见的CompletableFuture性能陷阱及解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T00:17:30.000Z" title="Sun Jan 04 2026 00:17:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Java并发编程避坑指南：5个常见的CompletableFuture性能陷阱及解决方案</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>在Java 8引入的<code>CompletableFuture</code>为异步编程提供了强大的工具，它结合了<code>Future</code>的异步特性和函数式编程的灵活性。然而，在实际使用中，开发者往往会陷入一些性能陷阱，导致系统吞吐量下降、资源耗尽甚至死锁。本文深入剖析5个最常见的<code>CompletableFuture</code>性能陷阱，并提供经过生产验证的解决方案，帮助开发者编写高效可靠的并发代码。</p>
<h2 data-id="heading-2">1. 线程池滥用导致的资源耗尽</h2>
<h3 data-id="heading-3">问题现象</h3>
<p>默认情况下，<code>CompletableFuture</code>使用<code>ForkJoinPool.commonPool()</code>作为执行线程池。在高并发场景下：</p>
<ul>
<li>所有异步任务共享同一个公共线程池</li>
<li>I/O密集型任务长时间占用线程</li>
<li>最终导致公共池饱和，影响整个应用的响应能力</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 危险示例：大量I/O任务阻塞公共池</span>
CompletableFuture.supplyAsync(() -&gt; blockingIOOperation());
</code></pre>
<h3 data-id="heading-4">解决方案</h3>
<p><strong>专用线程池隔离</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ExecutorService</span> <span class="hljs-variable">ioExecutor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">50</span>);
CompletableFuture.supplyAsync(() -&gt; blockingIOOperation(), ioExecutor);
</code></pre>
<p><strong>最佳实践</strong>：</p>
<ul>
<li>CPU密集型任务：使用与CPU核心数相当的线程池</li>
<li>I/O密集型任务：使用更大的线程池（建议50-200）</li>
<li>不同业务域使用独立线程池隔离</li>
</ul>
<h2 data-id="heading-5">2. 回调地狱引发的栈溢出</h2>
<h3 data-id="heading-6">问题现象</h3>
<p>深层嵌套的<code>thenApply/thenAccept</code>调用链会导致：</p>
<pre><code class="hljs language-java" lang="java">future.thenApply(f1)
      .thenApply(f2)
      <span class="hljs-comment">// ...多层嵌套...</span>
      .thenApply(f20);
</code></pre>
<ul>
<li>StackOverflowError异常（JDK8存在此问题）</li>
<li>调试困难的可维护性问题</li>
</ul>
<h3 data-id="heading-7">解决方案</h3>
<p><strong>扁平化处理链</strong>：</p>
<pre><code class="hljs language-java" lang="java">CompletableFuture&lt;V&gt; result = future.thenApply(f1)
                                   .thenCompose(v -&gt; processStage2(v))
                                   .thenCompose(v -&gt; processStage3(v));
</code></pre>
<p><strong>组合式编程</strong>：</p>
<pre><code class="hljs language-java" lang="java">CompletableFuture.allOf(
    future.thenApplyAsync(f1),
    future.thenApplyAsync(f2)
).thenAccept(results -&gt; ...);
</code></pre>
<h2 data-id="heading-8">3. 阻塞获取破坏异步优势</h2>
<h3 data-id="heading-9">问题现象</h3>
<p>错误地混合同步阻塞调用：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">CompletableFuture</span> <span class="hljs-variable">future</span> <span class="hljs-operator">=</span> asyncOperation();
future.get(); <span class="hljs-comment">// 主线程被阻塞！</span>
</code></pre>
<p>导致：</p>
<ul>
<li>完全丧失异步优势</li>
<li>可能引发死锁（如果get()在回调线程中被调用）</li>
</ul>
<h3 data-id="heading-10">解决方案</h3>
<p><strong>纯异步编程范式</strong>：</p>
<pre><code class="hljs language-java" lang="java">asyncOperation()
    .thenAccept(result -&gt; handleResult(result))
    .exceptionally(ex -&gt; handleError(ex));
</code></pre>
<p><strong>强制超时保护（必须阻塞时）</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">try</span> {
    future.get(<span class="hljs-number">500</span>, TimeUnit.MILLISECONDS); 
} <span class="hljs-keyword">catch</span> (TimeoutException e) {
    future.cancel(<span class="hljs-literal">true</span>);
}
</code></pre>
<h2 data-id="heading-11">4. 异常处理缺失导致静默失败</h2>
<h3 data-id="heading-12">问题现象</h3>
<p>未处理的异常会导致：</p>
<pre><code class="hljs language-java" lang="java">future.thenApply(v -&gt; <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>())
     .thenAccept(v -&gt; System.out.println(<span class="hljs-string">"永远不会执行"</span>));
</code></pre>
<ul>
<li>任务链静默中断</li>
<li>错误无法追踪（除非主动调用join()）</li>
</ul>
<h3 data-id="heading-13">解决方案</h3>
<p><strong>全面异常处理策略</strong>：</p>
<p>方案1：全局异常处理器</p>
<pre><code class="hljs language-java" lang="java">future.exceptionally(ex -&gt; {
    metrics.recordFailure(ex);
    <span class="hljs-keyword">return</span> fallbackValue;
});
</code></pre>
<p>方案2：组合处理模式</p>
<pre><code class="hljs language-java" lang="java">future.handle((result, ex) -&gt; {
    <span class="hljs-keyword">if</span> (ex != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> recoveryOperation();
    }
    <span class="hljs-keyword">return</span> result;
});
</code></pre>
<h2 data-id="heading-14">5. 不合理的依赖编排引发死锁</h2>
<h3 data-id="heading-15">问题现象</h3>
<p>复杂的依赖关系可能导致：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">CompletableFuture</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> futureA.thenCombine(futureB, (x,y) -&gt; x+y); 
<span class="hljs-type">CompletableFuture</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> futureB.thenCombine(futureA, (x,y) -&gt; x*y);
</code></pre>
<ul>
<li>A等待B完成，B同时等待A完成</li>
<li>ForkJoinPool工作窃取机制失效</li>
</ul>
<h3 data-id="heading-16">解决方案</h3>
<p><strong>依赖图分析技术</strong>：</p>
<ol>
<li>
<p><strong>可视化工具辅助设计</strong>：使用JProfiler等工具分析任务依赖图</p>
</li>
<li>
<p><strong>原子性编排原则</strong>：</p>
</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Good:明确的串行关系 </span>
futureA.thenAcceptBoth(futureB, (a,b) -&gt; {
    <span class="hljs-comment">// a和b都已就绪才执行 </span>
});
</code></pre>
<ol start="3">
<li><strong>超时熔断机制</strong>：</li>
</ol>
<pre><code class="hljs language-java" lang="java">futureA.completeOnTimeout(defaultVal,<span class="hljs-number">100</span>,TimeUnit.MILLISECONDS);
</code></pre>
<h2 data-id="heading-17">JVM层面的深度优化</h2>
<h3 data-id="heading-18">JDK9+改进须知：</h3>
<ol>
<li><strong>延迟初始化优化</strong>：JDK9后<code>defaultExecutor()</code>改为按需初始化公共池</li>
<li><strong>内存屏障改进</strong>：JDK12优化了内部VarHandle的内存语义（JEP334）</li>
<li><strong>取消性能提升</strong>：JDK11后cancel()操作减少内存占用（8231914）</li>
</ol>
<h2 data-id="heading-19">Spring集成最佳实践</h2>
<p>对于Spring应用：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Bean</span> 
<span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">asyncExecutor</span><span class="hljs-params">()</span> { <span class="hljs-comment">// Spring管理的线程池 </span>
    <span class="hljs-type">ThreadPoolTaskExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolTaskExecutor</span>();
    executor.setCorePoolSize(<span class="hljs-number">20</span>);
    executor.setQueueCapacity(<span class="hljs-number">100</span>); 
    executor.setThreadNamePrefix(<span class="hljs-string">"Async-"</span>);
    <span class="hljs-keyword">return</span> executor;
}

<span class="hljs-meta">@Service</span> 
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    
    <span class="hljs-meta">@Async("asyncExecutor")</span> <span class="hljs-comment">// Spring与CF的完美结合 </span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;Order&gt; <span class="hljs-title function_">queryOrderAsync</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.completedStage(repository.findById(id));
    }
}
</code></pre>
<h2 data-id="heading-20">总结</h2>
<p>掌握这些避坑技巧后，开发者可以充分发挥<code>CompletableFuture</code>的强大威力。关键要点包括：合理配置线程池、保持纯异步编程风格、完善的异常处理机制、避免循环依赖以及及时跟进JDK版本的改进特性。正确使用的<code>CompletableFuture</code>可以实现数万TPS的高并发处理能力，同时保持代码的可读性和可维护性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PPO：那个让你在强化学习路上少摔几跤的“调酒师”]]></title>    <link>https://juejin.cn/post/7590705425135239177</link>    <guid>https://juejin.cn/post/7590705425135239177</guid>    <pubDate>2026-01-04T00:26:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590705425135239177" data-draft-id="7590915294446714907" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PPO：那个让你在强化学习路上少摔几跤的“调酒师”"/> <meta itemprop="keywords" content="强化学习,人工智能,算法"/> <meta itemprop="datePublished" content="2026-01-04T00:26:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="都叫我大帅哥"/> <meta itemprop="url" content="https://juejin.cn/user/3956505282886506"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PPO：那个让你在强化学习路上少摔几跤的“调酒师”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3956505282886506/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    都叫我大帅哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T00:26:04.000Z" title="Sun Jan 04 2026 00:26:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">PPO：那个让你在强化学习路上少摔几跤的“调酒师”</h2>
<blockquote>
<p>本文适合以下人群阅读：</p>
<ol>
<li>想入门强化学习但被TRPO数学劝退的朋友</li>
<li>在PPO参数调试中怀疑人生的实践者</li>
<li>准备面试却被“为什么PPO要clip？”问懵的求职者</li>
<li>单纯想看看AI如何学习“走平衡木”的好奇宝宝</li>
</ol>
</blockquote>
<h3 data-id="heading-1">第一章：当强化学习遇到“中年危机”——PPO为何而生？</h3>
<h4 data-id="heading-2">1.1 强化学习的“过山车”之旅</h4>
<p>想象一下，你正在教一只AI仓鼠玩跑轮。传统强化学习的方法是：</p>
<ul>
<li><strong>REINFORCE算法</strong>（蒙特卡洛版）：“仓鼠兄弟，你随便跑，跑完一圈我告诉你这圈打得多少分”</li>
<li><strong>DQN</strong>（深度Q网络）：“我先预测一下每个动作能得多少分...等等，仓鼠怎么卡在轮子里了？”</li>
<li><strong>TRPO</strong>（信任域策略优化）：“我们做个复杂的数学体操，保证每次更新都不掉下悬崖...哦，这计算量够我训练一个GPT了”</li>
</ul>
<p>就在这个时候，OpenAI的研究员们端着酒杯说：“干嘛这么复杂？我们加个‘裁剪’不就好了？”</p>
<p>于是，<strong>PPO（Proximal Policy Optimization，近端策略优化）</strong> 在2017年诞生了！</p>
<h4 data-id="heading-3">1.2 PPO的“人设”：稳如老狗，快如闪电</h4>
<p>PPO的核心哲学很接地气：</p>
<blockquote>
<p>“我想让AI进步，但又怕它‘步子迈太大扯着蛋’，所以每次更新我都拉着它的衣角说：兄嘚，别跑太远，差不多得了”</p>
</blockquote>
<p>这种“既要...又要...”的精神，让PPO一举成为强化学习的“国民算法”：</p>
<ul>
<li>MuJoCo物理模拟？用PPO！</li>
<li>Dota 2游戏AI？用PPO！</li>
<li>股票交易策略？试试PPO！</li>
<li>连ChatGPT的强化学习微调也用PPO！</li>
</ul>
<h3 data-id="heading-4">第二章：PPO用法大全——从“Hello World”到“称霸健身房”</h3>
<h4 data-id="heading-5">2.1 安装与环境搭建</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 首先，让我们准备好工具箱</span>
!pip install gymnasium torch numpy matplotlib seaborn tqdm

<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn
<span class="hljs-keyword">import</span> torch.optim <span class="hljs-keyword">as</span> optim
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> gymnasium <span class="hljs-keyword">as</span> gym
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> deque
<span class="hljs-keyword">import</span> random
<span class="hljs-keyword">from</span> tqdm <span class="hljs-keyword">import</span> tqdm
<span class="hljs-keyword">import</span> seaborn <span class="hljs-keyword">as</span> sns

<span class="hljs-comment"># 设置随机种子，保证结果可复现（玄学的一部分）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">set_seed</span>(<span class="hljs-params">seed=<span class="hljs-number">42</span></span>):
    torch.manual_seed(seed)
    np.random.seed(seed)
    random.seed(seed)
    torch.backends.cudnn.deterministic = <span class="hljs-literal">True</span>
    
set_seed()
</code></pre>
<h4 data-id="heading-6">2.2 完整PPO实现案例：教AI玩“平衡木”</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ActorCriticNetwork</span>(nn.Module):
    <span class="hljs-string">"""演员-评论家网络：既决定动作，又评价状态"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, state_dim, action_dim, hidden_dim=<span class="hljs-number">64</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        
        <span class="hljs-comment"># 共享的特征提取层</span>
        self.shared = nn.Sequential(
            nn.Linear(state_dim, hidden_dim),
            nn.Tanh(),
            nn.Linear(hidden_dim, hidden_dim),
            nn.Tanh(),
        )
        
        <span class="hljs-comment"># 演员头：输出动作概率分布</span>
        self.actor = nn.Sequential(
            nn.Linear(hidden_dim, action_dim),
            nn.Softmax(dim=-<span class="hljs-number">1</span>)  <span class="hljs-comment"># 输出概率，和为1</span>
        )
        
        <span class="hljs-comment"># 评论家头：评估状态价值</span>
        self.critic = nn.Linear(hidden_dim, <span class="hljs-number">1</span>)
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        features = self.shared(x)
        action_probs = self.actor(features)
        state_value = self.critic(features)
        <span class="hljs-keyword">return</span> action_probs, state_value
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">act</span>(<span class="hljs-params">self, state, deterministic=<span class="hljs-literal">False</span></span>):
        <span class="hljs-string">"""根据状态选择动作"""</span>
        <span class="hljs-keyword">with</span> torch.no_grad():
            action_probs, _ = self.forward(state)
            
            <span class="hljs-keyword">if</span> deterministic:
                <span class="hljs-comment"># 测试时：选择概率最大的动作</span>
                action = torch.argmax(action_probs, dim=-<span class="hljs-number">1</span>)
            <span class="hljs-keyword">else</span>:
                <span class="hljs-comment"># 训练时：按概率采样（探索的关键！）</span>
                dist = torch.distributions.Categorical(action_probs)
                action = dist.sample()
                
            <span class="hljs-keyword">return</span> action.item()
            
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate</span>(<span class="hljs-params">self, state, action</span>):
        <span class="hljs-string">"""评估给定状态-动作对"""</span>
        action_probs, state_value = self.forward(state)
        dist = torch.distributions.Categorical(action_probs)
        
        <span class="hljs-comment"># 动作的对数概率</span>
        action_logprob = dist.log_prob(action)
        
        <span class="hljs-comment"># 动作的熵（用于鼓励探索）</span>
        dist_entropy = dist.entropy()
        
        <span class="hljs-keyword">return</span> action_logprob, state_value, dist_entropy


<span class="hljs-keyword">class</span> <span class="hljs-title class_">PPOBuffer</span>:
    <span class="hljs-string">"""PPO专用经验回放缓冲区"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, state_dim, buffer_size=<span class="hljs-number">2048</span>, gamma=<span class="hljs-number">0.99</span>, gae_lambda=<span class="hljs-number">0.95</span></span>):
        self.states = np.zeros((buffer_size, state_dim), dtype=np.float32)
        self.actions = np.zeros(buffer_size, dtype=np.int32)
        self.rewards = np.zeros(buffer_size, dtype=np.float32)
        self.dones = np.zeros(buffer_size, dtype=np.float32)
        self.values = np.zeros(buffer_size, dtype=np.float32)
        self.logprobs = np.zeros(buffer_size, dtype=np.float32)
        
        self.gamma = gamma
        self.gae_lambda = gae_lambda
        self.buffer_size = buffer_size
        self.ptr = <span class="hljs-number">0</span>
        self.path_start_idx = <span class="hljs-number">0</span>
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">store</span>(<span class="hljs-params">self, state, action, reward, done, value, logprob</span>):
        <span class="hljs-string">"""存储一条经验"""</span>
        idx = self.ptr
        
        self.states[idx] = state
        self.actions[idx] = action
        self.rewards[idx] = reward
        self.dones[idx] = done
        self.values[idx] = value
        self.logprobs[idx] = logprob
        
        self.ptr += <span class="hljs-number">1</span>
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">finish_path</span>(<span class="hljs-params">self, last_value=<span class="hljs-number">0</span></span>):
        <span class="hljs-string">"""当一个回合结束时，计算GAE和回报"""</span>
        path_slice = <span class="hljs-built_in">slice</span>(self.path_start_idx, self.ptr)
        
        rewards = np.append(self.rewards[path_slice], last_value)
        values = np.append(self.values[path_slice], last_value)
        dones = np.append(self.dones[path_slice], <span class="hljs-number">0</span>)
        
        <span class="hljs-comment"># 计算GAE（广义优势估计）</span>
        gae = <span class="hljs-number">0</span>
        advantages = np.zeros(<span class="hljs-built_in">len</span>(rewards) - <span class="hljs-number">1</span>, dtype=np.float32)
        
        <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> <span class="hljs-built_in">reversed</span>(<span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(rewards) - <span class="hljs-number">1</span>)):
            delta = rewards[t] + self.gamma * values[t+<span class="hljs-number">1</span>] * (<span class="hljs-number">1</span> - dones[t]) - values[t]
            gae = delta + self.gamma * self.gae_lambda * (<span class="hljs-number">1</span> - dones[t]) * gae
            advantages[t] = gae
            
        <span class="hljs-comment"># 计算回报</span>
        returns = advantages + self.values[path_slice]
        
        self.advantages = advantages <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(self, <span class="hljs-string">'advantages'</span>) <span class="hljs-keyword">else</span> np.concatenate([self.advantages, advantages])
        self.returns = returns <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(self, <span class="hljs-string">'returns'</span>) <span class="hljs-keyword">else</span> np.concatenate([self.returns, returns])
        
        self.path_start_idx = self.ptr
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""获取所有数据并归一化优势值"""</span>
        <span class="hljs-comment"># 归一化优势（重要技巧！）</span>
        advantages = (self.advantages - np.mean(self.advantages)) / (np.std(self.advantages) + <span class="hljs-number">1e-8</span>)
        
        <span class="hljs-keyword">return</span> (
            torch.FloatTensor(self.states[:self.ptr]),
            torch.LongTensor(self.actions[:self.ptr]),
            torch.FloatTensor(self.logprobs[:self.ptr]),
            torch.FloatTensor(self.returns[:self.ptr]),
            torch.FloatTensor(advantages),
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">clear</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""清空缓冲区"""</span>
        self.ptr = <span class="hljs-number">0</span>
        self.path_start_idx = <span class="hljs-number">0</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(self, <span class="hljs-string">'advantages'</span>):
            <span class="hljs-keyword">del</span> self.advantages
            <span class="hljs-keyword">del</span> self.returns


<span class="hljs-keyword">class</span> <span class="hljs-title class_">PPOAgent</span>:
    <span class="hljs-string">"""PPO智能体：真正的调酒师"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, env_name=<span class="hljs-string">"CartPole-v1"</span>, 
                 hidden_dim=<span class="hljs-number">64</span>, 
                 lr=<span class="hljs-number">3e-4</span>,
                 gamma=<span class="hljs-number">0.99</span>,
                 gae_lambda=<span class="hljs-number">0.95</span>,
                 clip_epsilon=<span class="hljs-number">0.2</span>,
                 ppo_epochs=<span class="hljs-number">10</span>,
                 batch_size=<span class="hljs-number">64</span></span>):
        
        <span class="hljs-comment"># 创建环境</span>
        self.env = gym.make(env_name)
        self.state_dim = self.env.observation_space.shape[<span class="hljs-number">0</span>]
        self.action_dim = self.env.action_space.n
        
        <span class="hljs-comment"># 初始化网络</span>
        self.policy = ActorCriticNetwork(self.state_dim, self.action_dim, hidden_dim)
        self.optimizer = optim.Adam(self.policy.parameters(), lr=lr)
        
        <span class="hljs-comment"># PPO超参数</span>
        self.gamma = gamma
        self.gae_lambda = gae_lambda
        self.clip_epsilon = clip_epsilon
        self.ppo_epochs = ppo_epochs
        self.batch_size = batch_size
        
        <span class="hljs-comment"># 经验缓冲区</span>
        self.buffer = PPOBuffer(self.state_dim, buffer_size=<span class="hljs-number">2048</span>, 
                                gamma=gamma, gae_lambda=gae_lambda)
        
        <span class="hljs-comment"># 记录器</span>
        self.episode_rewards = []
        self.episode_lengths = []
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">collect_experience</span>(<span class="hljs-params">self, max_steps=<span class="hljs-number">1000</span></span>):
        <span class="hljs-string">"""收集经验数据：让AI在环境中玩耍"""</span>
        state, _ = self.env.reset()
        episode_reward = <span class="hljs-number">0</span>
        episode_length = <span class="hljs-number">0</span>
        
        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(max_steps):
            state_tensor = torch.FloatTensor(state).unsqueeze(<span class="hljs-number">0</span>)
            
            <span class="hljs-comment"># 选择动作</span>
            action = self.policy.act(state_tensor)
            
            <span class="hljs-comment"># 与环境交互</span>
            next_state, reward, terminated, truncated, _ = self.env.step(action)
            done = terminated <span class="hljs-keyword">or</span> truncated
            
            <span class="hljs-comment"># 评估当前状态-动作对</span>
            <span class="hljs-keyword">with</span> torch.no_grad():
                action_tensor = torch.LongTensor([action])
                logprob, value, _ = self.policy.evaluate(state_tensor, action_tensor)
            
            <span class="hljs-comment"># 存储经验</span>
            self.buffer.store(state, action, reward, done, 
                             value.item(), logprob.item())
            
            state = next_state
            episode_reward += reward
            episode_length += <span class="hljs-number">1</span>
            
            <span class="hljs-keyword">if</span> done:
                <span class="hljs-comment"># 处理回合结束</span>
                <span class="hljs-keyword">with</span> torch.no_grad():
                    next_state_tensor = torch.FloatTensor(next_state).unsqueeze(<span class="hljs-number">0</span>)
                    _, next_value, _ = self.policy.evaluate(next_state_tensor, 
                                                           torch.LongTensor([<span class="hljs-number">0</span>]))
                self.buffer.finish_path(next_value.item())
                
                <span class="hljs-comment"># 记录回合信息</span>
                self.episode_rewards.append(episode_reward)
                self.episode_lengths.append(episode_length)
                
                <span class="hljs-comment"># 重置环境</span>
                state, _ = self.env.reset()
                episode_reward = <span class="hljs-number">0</span>
                episode_length = <span class="hljs-number">0</span>
                
                <span class="hljs-keyword">if</span> self.buffer.ptr &gt;= self.buffer.buffer_size:
                    <span class="hljs-keyword">break</span>
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">update_policy</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""PPO的核心：用收集的经验更新策略"""</span>
        <span class="hljs-comment"># 获取所有数据</span>
        states, actions, old_logprobs, returns, advantages = self.buffer.get()
        
        <span class="hljs-comment"># 多次更新（PPO的关键：重复利用数据）</span>
        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(self.ppo_epochs):
            <span class="hljs-comment"># 打乱数据顺序</span>
            indices = np.arange(<span class="hljs-built_in">len</span>(states))
            np.random.shuffle(indices)
            
            <span class="hljs-comment"># 小批量更新</span>
            <span class="hljs-keyword">for</span> start <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(states), self.batch_size):
                end = start + self.batch_size
                batch_indices = indices[start:end]
                
                <span class="hljs-comment"># 获取批次数据</span>
                batch_states = states[batch_indices]
                batch_actions = actions[batch_indices]
                batch_old_logprobs = old_logprobs[batch_indices]
                batch_returns = returns[batch_indices]
                batch_advantages = advantages[batch_indices]
                
                <span class="hljs-comment"># 评估当前策略</span>
                new_logprobs, state_values, dist_entropy = self.policy.evaluate(
                    batch_states, batch_actions
                )
                
                <span class="hljs-comment"># 计算比率（新旧策略概率比）</span>
                ratios = torch.exp(new_logprobs - batch_old_logprobs)
                
                <span class="hljs-comment"># PPO的Clip目标函数</span>
                surr1 = ratios * batch_advantages
                surr2 = torch.clamp(ratios, <span class="hljs-number">1</span> - self.clip_epsilon, 
                                   <span class="hljs-number">1</span> + self.clip_epsilon) * batch_advantages
                
                <span class="hljs-comment"># 演员损失（策略损失）</span>
                actor_loss = -torch.<span class="hljs-built_in">min</span>(surr1, surr2).mean()
                
                <span class="hljs-comment"># 评论家损失（价值损失）</span>
                critic_loss = nn.MSELoss()(state_values.squeeze(), batch_returns)
                
                <span class="hljs-comment"># 总损失（加上熵正则项鼓励探索）</span>
                entropy_coeff = <span class="hljs-number">0.01</span>
                total_loss = actor_loss + <span class="hljs-number">0.5</span> * critic_loss - entropy_coeff * dist_entropy.mean()
                
                <span class="hljs-comment"># 反向传播</span>
                self.optimizer.zero_grad()
                total_loss.backward()
                
                <span class="hljs-comment"># 梯度裁剪（防止梯度爆炸）</span>
                torch.nn.utils.clip_grad_norm_(self.policy.parameters(), <span class="hljs-number">0.5</span>)
                
                self.optimizer.step()
        
        <span class="hljs-comment"># 清空缓冲区</span>
        self.buffer.clear()
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">train</span>(<span class="hljs-params">self, total_timesteps=<span class="hljs-number">100000</span></span>):
        <span class="hljs-string">"""训练主循环"""</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"开始PPO训练！"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"状态维度: <span class="hljs-subst">{self.state_dim}</span>, 动作维度: <span class="hljs-subst">{self.action_dim}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
        
        timestep = <span class="hljs-number">0</span>
        episode = <span class="hljs-number">0</span>
        
        <span class="hljs-keyword">with</span> tqdm(total=total_timesteps, desc=<span class="hljs-string">"训练进度"</span>) <span class="hljs-keyword">as</span> pbar:
            <span class="hljs-keyword">while</span> timestep &lt; total_timesteps:
                <span class="hljs-comment"># 收集经验</span>
                self.collect_experience()
                timestep += self.buffer.ptr
                
                <span class="hljs-comment"># 更新策略</span>
                self.update_policy()
                
                <span class="hljs-comment"># 更新进度条</span>
                <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.episode_rewards) &gt; <span class="hljs-number">0</span>:
                    avg_reward = np.mean(self.episode_rewards[-<span class="hljs-number">10</span>:])  <span class="hljs-comment"># 最近10回合平均奖励</span>
                    pbar.set_postfix({
                        <span class="hljs-string">'平均奖励'</span>: <span class="hljs-string">f'<span class="hljs-subst">{avg_reward:<span class="hljs-number">.2</span>f}</span>'</span>,
                        <span class="hljs-string">'回合数'</span>: <span class="hljs-built_in">len</span>(self.episode_rewards)
                    })
                
                pbar.update(self.buffer.ptr)
                
                <span class="hljs-comment"># 每100回合评估一次</span>
                <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.episode_rewards) % <span class="hljs-number">100</span> == <span class="hljs-number">0</span>:
                    eval_reward = self.evaluate()
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n评估回合奖励: <span class="hljs-subst">{eval_reward:<span class="hljs-number">.2</span>f}</span>"</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate</span>(<span class="hljs-params">self, n_episodes=<span class="hljs-number">5</span>, render=<span class="hljs-literal">False</span></span>):
        <span class="hljs-string">"""评估训练好的策略"""</span>
        total_rewards = []
        
        <span class="hljs-keyword">for</span> episode <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n_episodes):
            state, _ = self.env.reset()
            episode_reward = <span class="hljs-number">0</span>
            done = <span class="hljs-literal">False</span>
            
            <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> done:
                <span class="hljs-keyword">if</span> render <span class="hljs-keyword">and</span> episode == <span class="hljs-number">0</span>:
                    self.env.render()
                    
                state_tensor = torch.FloatTensor(state).unsqueeze(<span class="hljs-number">0</span>)
                action = self.policy.act(state_tensor, deterministic=<span class="hljs-literal">True</span>)
                
                next_state, reward, terminated, truncated, _ = self.env.step(action)
                done = terminated <span class="hljs-keyword">or</span> truncated
                
                state = next_state
                episode_reward += reward
                
            total_rewards.append(episode_reward)
        
        <span class="hljs-keyword">return</span> np.mean(total_rewards)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">plot_training_progress</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""可视化训练过程"""</span>
        fig, axes = plt.subplots(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">12</span>, <span class="hljs-number">4</span>))
        
        <span class="hljs-comment"># 奖励曲线</span>
        axes[<span class="hljs-number">0</span>].plot(self.episode_rewards, alpha=<span class="hljs-number">0.6</span>)
        axes[<span class="hljs-number">0</span>].set_xlabel(<span class="hljs-string">'回合数'</span>)
        axes[<span class="hljs-number">0</span>].set_ylabel(<span class="hljs-string">'回合奖励'</span>)
        axes[<span class="hljs-number">0</span>].set_title(<span class="hljs-string">'训练奖励曲线'</span>)
        axes[<span class="hljs-number">0</span>].grid(<span class="hljs-literal">True</span>, alpha=<span class="hljs-number">0.3</span>)
        
        <span class="hljs-comment"># 滑动平均奖励</span>
        window_size = <span class="hljs-number">50</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.episode_rewards) &gt;= window_size:
            moving_avg = np.convolve(self.episode_rewards, 
                                    np.ones(window_size)/window_size, 
                                    mode=<span class="hljs-string">'valid'</span>)
            axes[<span class="hljs-number">0</span>].plot(<span class="hljs-built_in">range</span>(window_size-<span class="hljs-number">1</span>, <span class="hljs-built_in">len</span>(self.episode_rewards)), 
                        moving_avg, <span class="hljs-string">'r-'</span>, linewidth=<span class="hljs-number">2</span>, label=<span class="hljs-string">f'<span class="hljs-subst">{window_size}</span>回合平均'</span>)
            axes[<span class="hljs-number">0</span>].legend()
        
        <span class="hljs-comment"># 回合长度分布</span>
        axes[<span class="hljs-number">1</span>].hist(self.episode_lengths, bins=<span class="hljs-number">30</span>, alpha=<span class="hljs-number">0.7</span>, color=<span class="hljs-string">'skyblue'</span>)
        axes[<span class="hljs-number">1</span>].set_xlabel(<span class="hljs-string">'回合长度'</span>)
        axes[<span class="hljs-number">1</span>].set_ylabel(<span class="hljs-string">'频次'</span>)
        axes[<span class="hljs-number">1</span>].set_title(<span class="hljs-string">'回合长度分布'</span>)
        axes[<span class="hljs-number">1</span>].grid(<span class="hljs-literal">True</span>, alpha=<span class="hljs-number">0.3</span>)
        
        plt.tight_layout()
        plt.show()


<span class="hljs-comment"># 让我们开始训练吧！</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-comment"># 初始化PPO智能体</span>
    agent = PPOAgent(
        env_name=<span class="hljs-string">"CartPole-v1"</span>,
        hidden_dim=<span class="hljs-number">64</span>,
        lr=<span class="hljs-number">3e-4</span>,
        clip_epsilon=<span class="hljs-number">0.2</span>,
        ppo_epochs=<span class="hljs-number">10</span>,
        batch_size=<span class="hljs-number">64</span>
    )
    
    <span class="hljs-comment"># 训练</span>
    agent.train(total_timesteps=<span class="hljs-number">50000</span>)
    
    <span class="hljs-comment"># 可视化训练结果</span>
    agent.plot_training_progress()
    
    <span class="hljs-comment"># 最终评估</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"最终评估结果："</span>)
    eval_reward = agent.evaluate(n_episodes=<span class="hljs-number">10</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"平均评估奖励: <span class="hljs-subst">{eval_reward:<span class="hljs-number">.2</span>f}</span>"</span>)
    
    <span class="hljs-comment"># 展示AI的表演</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n观看AI的表演（按任意键退出）..."</span>)
    agent.evaluate(n_episodes=<span class="hljs-number">3</span>, render=<span class="hljs-literal">True</span>)
    
    <span class="hljs-keyword">return</span> agent

<span class="hljs-comment"># 运行主函数</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    trained_agent = main()
</code></pre>
<h3 data-id="heading-7">第三章：PPO原理深度剖析——数学不复杂，就是有点“绕”</h3>
<h4 data-id="heading-8">3.1 核心思想：策略更新的“安全带”</h4>
<p>PPO的核心公式其实很简单：</p>
<pre><code class="hljs language-python" lang="python">L(θ) = E[<span class="hljs-built_in">min</span>(
    r(θ) * A,          <span class="hljs-comment"># 原始目标</span>
    clip(r(θ), <span class="hljs-number">1</span>-ε, <span class="hljs-number">1</span>+ε) * A  <span class="hljs-comment"># 裁剪后目标</span>
)]
</code></pre>
<p>其中：</p>
<ul>
<li><code>r(θ) = π_θ(a|s) / π_θ_old(a|s)</code> 是新旧策略的概率比</li>
<li><code>A</code> 是优势函数（这个动作比平均水平好多少）</li>
<li><code>ε</code> 是裁剪参数（通常0.1~0.3）</li>
</ul>
<p><strong>通俗理解</strong>：</p>
<blockquote>
<p>想象你在教AI打篮球：</p>
<ol>
<li>如果某个动作让投篮命中率从30%提到60%（r=2.0，A为正），我们想多用它</li>
<li>但如果变化太大（比如r&gt;1.2），我们怕AI"动作变形"，就按住它："别太夸张，最多比原来多用20%"</li>
<li>如果某个动作让命中率下降（A为负），我们想少用它</li>
<li>但如果变化太大（比如r&lt;0.8），我们也按住："别完全不用啊，至少保留80%"</li>
</ol>
</blockquote>
<h4 data-id="heading-9">3.2 PPO的两个变体：CLIP vs KL散度</h4>
<p>PPO有两种实现方式，就像两种不同的"安全带"：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 变体1：PPO-CLIP（最常用的）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">ppo_clip_loss</span>(<span class="hljs-params">new_logprob, old_logprob, advantage, epsilon=<span class="hljs-number">0.2</span></span>):
    ratio = torch.exp(new_logprob - old_logprob)  <span class="hljs-comment"># r(θ)</span>
    
    <span class="hljs-comment"># 裁剪目标</span>
    surr1 = ratio * advantage
    surr2 = torch.clamp(ratio, <span class="hljs-number">1</span>-epsilon, <span class="hljs-number">1</span>+epsilon) * advantage
    
    <span class="hljs-keyword">return</span> -torch.<span class="hljs-built_in">min</span>(surr1, surr2).mean()  <span class="hljs-comment"># 取负号因为我们要最大化</span>

<span class="hljs-comment"># 变体2：PPO-Penalty（自适应KL散度）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">ppo_kl_loss</span>(<span class="hljs-params">new_logprob, old_logprob, advantage, kl_div, beta=<span class="hljs-number">0.5</span>, target_kl=<span class="hljs-number">0.01</span></span>):
    ratio = torch.exp(new_logprob - old_logprob)
    surr = ratio * advantage
    
    <span class="hljs-comment"># 自适应调整β</span>
    <span class="hljs-keyword">if</span> kl_div &gt; <span class="hljs-number">1.5</span> * target_kl:
        beta *= <span class="hljs-number">2</span>
    <span class="hljs-keyword">elif</span> kl_div &lt; target_kl / <span class="hljs-number">1.5</span>:
        beta /= <span class="hljs-number">2</span>
    
    <span class="hljs-keyword">return</span> -surr.mean() + beta * kl_div
</code></pre>
<h4 data-id="heading-10">3.3 GAE（广义优势估计）：PPO的"时光机"</h4>
<p>GAE的巧妙之处在于它平衡了"偏差"和"方差"：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">compute_gae</span>(<span class="hljs-params">rewards, values, dones, gamma=<span class="hljs-number">0.99</span>, gae_lambda=<span class="hljs-number">0.95</span></span>):
    <span class="hljs-string">"""计算广义优势估计"""</span>
    advantages = np.zeros_like(rewards)
    last_advantage = <span class="hljs-number">0</span>
    
    <span class="hljs-comment"># 从后往前计算</span>
    <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> <span class="hljs-built_in">reversed</span>(<span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(rewards))):
        <span class="hljs-keyword">if</span> t == <span class="hljs-built_in">len</span>(rewards) - <span class="hljs-number">1</span>:
            next_value = <span class="hljs-number">0</span>  <span class="hljs-comment"># 终止状态的价值为0</span>
        <span class="hljs-keyword">else</span>:
            next_value = values[t+<span class="hljs-number">1</span>] * (<span class="hljs-number">1</span> - dones[t])
        
        <span class="hljs-comment"># TD误差</span>
        delta = rewards[t] + gamma * next_value - values[t]
        
        <span class="hljs-comment"># GAE公式</span>
        advantages[t] = delta + gamma * gae_lambda * (<span class="hljs-number">1</span> - dones[t]) * last_advantage
        last_advantage = advantages[t]
    
    <span class="hljs-keyword">return</span> advantages
</code></pre>
<p><strong>通俗理解</strong>：</p>
<blockquote>
<p>GAE就像看电影时：</p>
<ul>
<li>λ=0：只看下一帧的预告（高偏差，低方差）</li>
<li>λ=1：直接看大结局（低偏差，高方差）</li>
<li>λ=0.95：看10分钟预告片再猜结局（平衡的艺术）</li>
</ul>
</blockquote>
<h3 data-id="heading-11">第四章：PPO vs 其他算法——强化学习"华山论剑"</h3>
<h4 data-id="heading-12">4.1 算法对比表</h4>















































<table><thead><tr><th>算法</th><th>优点</th><th>缺点</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>PPO</strong></td><td>稳定、简单、样本效率高</td><td>超参数敏感、收敛可能慢</td><td>连续/离散动作、复杂环境</td></tr><tr><td><strong>DQN</strong></td><td>价值估计准确、理论成熟</td><td>只能处理离散动作、过估计问题</td><td>雅达利游戏、离散决策</td></tr><tr><td><strong>A2C/A3C</strong></td><td>并行效率高、实现简单</td><td>稳定性较差、需要精细调参</td><td>并行环境、简单任务</td></tr><tr><td><strong>TRPO</strong></td><td>理论保证、非常稳定</td><td>计算复杂、实现困难</td><td>学术研究、高安全性需求</td></tr><tr><td><strong>SAC</strong></td><td>自动调温度参数、探索性强</td><td>实现复杂、超参数多</td><td>连续控制、需要大量探索</td></tr><tr><td><strong>DDPG</strong></td><td>适用于连续动作</td><td>对超参数敏感、训练不稳定</td><td>机器人控制、连续动作空间</td></tr></tbody></table>
<h4 data-id="heading-13">4.2 PPO的"杀手锏"：Clipping机制的妙处</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 让我们可视化一下Clipping机制</span>
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np

<span class="hljs-keyword">def</span> <span class="hljs-title function_">visualize_clipping</span>():
    advantages = np.linspace(-<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">100</span>)
    ratios = np.linspace(<span class="hljs-number">0.5</span>, <span class="hljs-number">1.5</span>, <span class="hljs-number">100</span>)
    R, A = np.meshgrid(ratios, advantages)
    
    <span class="hljs-comment"># PPO-CLIP目标</span>
    epsilon = <span class="hljs-number">0.2</span>
    surr1 = R * A
    surr2 = np.clip(R, <span class="hljs-number">1</span>-epsilon, <span class="hljs-number">1</span>+epsilon) * A
    L = np.minimum(surr1, surr2)
    
    <span class="hljs-comment"># 绘图</span>
    fig = plt.figure(figsize=(<span class="hljs-number">12</span>, <span class="hljs-number">4</span>))
    
    <span class="hljs-comment"># 原始目标</span>
    ax1 = fig.add_subplot(<span class="hljs-number">131</span>, projection=<span class="hljs-string">'3d'</span>)
    ax1.plot_surface(R, A, surr1, cmap=<span class="hljs-string">'viridis'</span>, alpha=<span class="hljs-number">0.8</span>)
    ax1.set_title(<span class="hljs-string">'原始目标: r(θ)·A'</span>)
    ax1.set_xlabel(<span class="hljs-string">'概率比 r(θ)'</span>)
    ax1.set_ylabel(<span class="hljs-string">'优势 A'</span>)
    
    <span class="hljs-comment"># 裁剪目标</span>
    ax2 = fig.add_subplot(<span class="hljs-number">132</span>, projection=<span class="hljs-string">'3d'</span>)
    ax2.plot_surface(R, A, surr2, cmap=<span class="hljs-string">'plasma'</span>, alpha=<span class="hljs-number">0.8</span>)
    ax2.set_title(<span class="hljs-string">'裁剪目标: clip(r(θ))·A'</span>)
    ax2.set_xlabel(<span class="hljs-string">'概率比 r(θ)'</span>)
    
    <span class="hljs-comment"># PPO最终目标</span>
    ax3 = fig.add_subplot(<span class="hljs-number">133</span>, projection=<span class="hljs-string">'3d'</span>)
    ax3.plot_surface(R, A, L, cmap=<span class="hljs-string">'coolwarm'</span>, alpha=<span class="hljs-number">0.8</span>)
    ax3.set_title(<span class="hljs-string">'PPO目标: min(原始, 裁剪)'</span>)
    ax3.set_xlabel(<span class="hljs-string">'概率比 r(θ)'</span>)
    
    plt.suptitle(<span class="hljs-string">'PPO Clipping机制可视化'</span>, fontsize=<span class="hljs-number">14</span>, fontweight=<span class="hljs-string">'bold'</span>)
    plt.tight_layout()
    plt.show()

<span class="hljs-comment"># visualize_clipping()  # 运行可以看到漂亮的可视化</span>
</code></pre>
<h3 data-id="heading-14">第五章：PPO避坑指南——那些年我踩过的坑</h3>
<h4 data-id="heading-15">5.1 超参数调试的"玄学"</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PPOHyperparameterTuner</span>:
    <span class="hljs-string">"""PPO超参数调试指南"""</span>
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">common_pitfalls</span>():
        pitfalls = {
            <span class="hljs-string">'学习率太高'</span>: {
                <span class="hljs-string">'症状'</span>: <span class="hljs-string">'奖励剧烈震荡，策略崩溃'</span>,
                <span class="hljs-string">'解决方案'</span>: <span class="hljs-string">'从3e-4开始，逐渐减小'</span>,
                <span class="hljs-string">'代码'</span>: <span class="hljs-string">'lr=3e-4 → 1e-4 → 3e-5'</span>
            },
            <span class="hljs-string">'裁剪系数太大'</span>: {
                <span class="hljs-string">'症状'</span>: <span class="hljs-string">'学习缓慢，策略更新保守'</span>,
                <span class="hljs-string">'解决方案'</span>: <span class="hljs-string">'ε通常设为0.1~0.3'</span>,
                <span class="hljs-string">'代码'</span>: <span class="hljs-string">'clip_epsilon=0.2'</span>
            },
            <span class="hljs-string">'GAE λ不合适'</span>: {
                <span class="hljs-string">'症状'</span>: <span class="hljs-string">'优势估计偏差大或方差大'</span>,
                <span class="hljs-string">'解决方案'</span>: <span class="hljs-string">'通常设为0.9~0.99'</span>,
                <span class="hljs-string">'代码'</span>: <span class="hljs-string">'gae_lambda=0.95'</span>
            },
            <span class="hljs-string">'批次太小'</span>: {
                <span class="hljs-string">'症状'</span>: <span class="hljs-string">'训练不稳定，方差大'</span>,
                <span class="hljs-string">'解决方案'</span>: <span class="hljs-string">'增加批次大小到64~256'</span>,
                <span class="hljs-string">'代码'</span>: <span class="hljs-string">'batch_size=64'</span>
            },
            <span class="hljs-string">'熵系数太大'</span>: {
                <span class="hljs-string">'症状'</span>: <span class="hljs-string">'过度探索，策略不收敛'</span>,
                <span class="hljs-string">'解决方案'</span>: <span class="hljs-string">'逐渐减小熵系数'</span>,
                <span class="hljs-string">'代码'</span>: <span class="hljs-string">'entropy_coeff=0.01 → 0.001'</span>
            }
        }
        <span class="hljs-keyword">return</span> pitfalls
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">recommended_configs</span>(<span class="hljs-params">env_type</span>):
        <span class="hljs-string">"""不同环境类型的推荐配置"""</span>
        configs = {
            <span class="hljs-string">'离散动作简单环境'</span>: {  <span class="hljs-comment"># 如CartPole, LunarLander</span>
                <span class="hljs-string">'lr'</span>: <span class="hljs-number">3e-4</span>,
                <span class="hljs-string">'clip_epsilon'</span>: <span class="hljs-number">0.2</span>,
                <span class="hljs-string">'gamma'</span>: <span class="hljs-number">0.99</span>,
                <span class="hljs-string">'gae_lambda'</span>: <span class="hljs-number">0.95</span>,
                <span class="hljs-string">'ppo_epochs'</span>: <span class="hljs-number">10</span>,
                <span class="hljs-string">'batch_size'</span>: <span class="hljs-number">64</span>,
                <span class="hljs-string">'hidden_dim'</span>: <span class="hljs-number">64</span>
            },
            <span class="hljs-string">'连续动作物理控制'</span>: {  <span class="hljs-comment"># 如MuJoCo, PyBullet</span>
                <span class="hljs-string">'lr'</span>: <span class="hljs-number">3e-4</span>,
                <span class="hljs-string">'clip_epsilon'</span>: <span class="hljs-number">0.2</span>,
                <span class="hljs-string">'gamma'</span>: <span class="hljs-number">0.99</span>,
                <span class="hljs-string">'gae_lambda'</span>: <span class="hljs-number">0.95</span>,
                <span class="hljs-string">'ppo_epochs'</span>: <span class="hljs-number">10</span>,
                <span class="hljs-string">'batch_size'</span>: <span class="hljs-number">256</span>,
                <span class="hljs-string">'hidden_dim'</span>: <span class="hljs-number">256</span>
            },
            <span class="hljs-string">'视觉输入环境'</span>: {  <span class="hljs-comment"># 如Atari</span>
                <span class="hljs-string">'lr'</span>: <span class="hljs-number">2.5e-4</span>,
                <span class="hljs-string">'clip_epsilon'</span>: <span class="hljs-number">0.1</span>,
                <span class="hljs-string">'gamma'</span>: <span class="hljs-number">0.99</span>,
                <span class="hljs-string">'gae_lambda'</span>: <span class="hljs-number">0.95</span>,
                <span class="hljs-string">'ppo_epochs'</span>: <span class="hljs-number">4</span>,
                <span class="hljs-string">'batch_size'</span>: <span class="hljs-number">256</span>,
                <span class="hljs-string">'hidden_dim'</span>: <span class="hljs-number">512</span>,
                <span class="hljs-string">'备注'</span>: <span class="hljs-string">'需要CNN处理图像'</span>
            }
        }
        <span class="hljs-keyword">return</span> configs.get(env_type, configs[<span class="hljs-string">'离散动作简单环境'</span>])
</code></pre>
<h4 data-id="heading-16">5.2 调试技巧：当PPO不工作时</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">ppo_debug_checklist</span>(<span class="hljs-params">agent, env</span>):
    <span class="hljs-string">"""PPO调试清单"""</span>
    checklist = []
    
    <span class="hljs-comment"># 1. 检查奖励缩放</span>
    rewards = []
    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):
        state, _ = env.reset()
        done = <span class="hljs-literal">False</span>
        <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> done:
            action = agent.policy.act(torch.FloatTensor(state).unsqueeze(<span class="hljs-number">0</span>))
            state, reward, terminated, truncated, _ = env.step(action)
            done = terminated <span class="hljs-keyword">or</span> truncated
            rewards.append(reward)
    
    avg_reward = np.mean(rewards)
    <span class="hljs-keyword">if</span> avg_reward &lt; -<span class="hljs-number">10</span> <span class="hljs-keyword">or</span> avg_reward &gt; <span class="hljs-number">10</span>:
        checklist.append(<span class="hljs-string">f"⚠️ 奖励范围过大(<span class="hljs-subst">{avg_reward:<span class="hljs-number">.2</span>f}</span>)，建议缩放奖励"</span>)
    
    <span class="hljs-comment"># 2. 检查梯度</span>
    <span class="hljs-keyword">for</span> name, param <span class="hljs-keyword">in</span> agent.policy.named_parameters():
        <span class="hljs-keyword">if</span> param.grad <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            grad_norm = param.grad.norm().item()
            <span class="hljs-keyword">if</span> grad_norm &gt; <span class="hljs-number">100</span>:
                checklist.append(<span class="hljs-string">f"⚠️ 梯度爆炸: <span class="hljs-subst">{name}</span>的梯度范数为<span class="hljs-subst">{grad_norm:<span class="hljs-number">.2</span>f}</span>"</span>)
            <span class="hljs-keyword">elif</span> grad_norm &lt; <span class="hljs-number">1e-6</span>:
                checklist.append(<span class="hljs-string">f"⚠️ 梯度消失: <span class="hljs-subst">{name}</span>的梯度范数为<span class="hljs-subst">{grad_norm:<span class="hljs-number">.2</span>e}</span>"</span>)
    
    <span class="hljs-comment"># 3. 检查探索率</span>
    entropies = []
    states = torch.randn(<span class="hljs-number">100</span>, agent.state_dim)
    <span class="hljs-keyword">with</span> torch.no_grad():
        <span class="hljs-keyword">for</span> state <span class="hljs-keyword">in</span> states:
            probs, _ = agent.policy(state.unsqueeze(<span class="hljs-number">0</span>))
            dist = torch.distributions.Categorical(probs)
            entropies.append(dist.entropy().item())
    
    avg_entropy = np.mean(entropies)
    max_entropy = np.log(agent.action_dim)  <span class="hljs-comment"># 最大熵</span>
    
    <span class="hljs-keyword">if</span> avg_entropy &lt; <span class="hljs-number">0.1</span> * max_entropy:
        checklist.append(<span class="hljs-string">f"⚠️ 探索不足: 熵(<span class="hljs-subst">{avg_entropy:<span class="hljs-number">.3</span>f}</span>) &lt; 10%最大熵(<span class="hljs-subst">{max_entropy:<span class="hljs-number">.3</span>f}</span>)"</span>)
    
    <span class="hljs-keyword">return</span> checklist
</code></pre>
<h3 data-id="heading-17">第六章：PPO最佳实践——从"能用"到"好用"</h3>
<h4 data-id="heading-18">6.1 高级技巧：让PPO飞得更高</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AdvancedPPO</span>(<span class="hljs-title class_ inherited__">PPOAgent</span>):
    <span class="hljs-string">"""增强版PPO，包含多种高级技巧"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, *args, **kwargs</span>):
        <span class="hljs-built_in">super</span>().__init__(*args, **kwargs)
        
        <span class="hljs-comment"># 添加学习率调度器</span>
        self.scheduler = optim.lr_scheduler.LambdaLR(
            self.optimizer,
            lr_lambda=<span class="hljs-keyword">lambda</span> epoch: <span class="hljs-number">0.999</span> ** epoch  <span class="hljs-comment"># 逐渐衰减</span>
        )
        
        <span class="hljs-comment"># 奖励归一化</span>
        self.reward_normalizer = RunningMeanStd(shape=())
        
        <span class="hljs-comment"># 状态归一化</span>
        self.state_normalizer = RunningMeanStd(shape=self.state_dim)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">normalize_state</span>(<span class="hljs-params">self, state</span>):
        <span class="hljs-string">"""状态归一化"""</span>
        self.state_normalizer.update(state)
        normalized = (state - self.state_normalizer.mean) / np.sqrt(self.state_normalizer.var + <span class="hljs-number">1e-8</span>)
        <span class="hljs-keyword">return</span> normalized
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">normalize_reward</span>(<span class="hljs-params">self, reward</span>):
        <span class="hljs-string">"""奖励归一化"""</span>
        self.reward_normalizer.update(np.array([reward]))
        normalized = reward / np.sqrt(self.reward_normalizer.var + <span class="hljs-number">1e-8</span>)
        <span class="hljs-keyword">return</span> normalized
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">collect_experience</span>(<span class="hljs-params">self, max_steps=<span class="hljs-number">1000</span></span>):
        <span class="hljs-string">"""增强的经验收集，包含归一化"""</span>
        state, _ = self.env.reset()
        state = self.normalize_state(state)
        
        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(max_steps):
            <span class="hljs-comment"># ... 与基类类似，但添加归一化 ...</span>
            reward = self.normalize_reward(reward)
            <span class="hljs-comment"># ... 其余代码 ...</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">update_policy</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""增强的策略更新，包含学习率调度"""</span>
        <span class="hljs-built_in">super</span>().update_policy()
        self.scheduler.step()  <span class="hljs-comment"># 更新学习率</span>


<span class="hljs-keyword">class</span> <span class="hljs-title class_">RunningMeanStd</span>:
    <span class="hljs-string">"""在线计算均值和标准差"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, shape, epsilon=<span class="hljs-number">1e-4</span></span>):
        self.mean = np.zeros(shape, dtype=np.float32)
        self.var = np.ones(shape, dtype=np.float32)
        self.count = epsilon
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">update</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-string">"""更新统计量"""</span>
        batch_mean = np.mean(x, axis=<span class="hljs-number">0</span>)
        batch_var = np.var(x, axis=<span class="hljs-number">0</span>)
        batch_count = x.shape[<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(x.shape) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>
        
        <span class="hljs-comment"># 合并统计量</span>
        delta = batch_mean - self.mean
        total_count = self.count + batch_count
        
        self.mean += delta * batch_count / total_count
        self.var = (
            self.count * self.var + 
            batch_count * batch_var + 
            delta**<span class="hljs-number">2</span> * self.count * batch_count / total_count
        ) / total_count
        self.count = total_count
</code></pre>
<h4 data-id="heading-19">6.2 并行PPO：让多个CPU核心为你打工</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> multiprocessing <span class="hljs-keyword">as</span> mp
<span class="hljs-keyword">from</span> multiprocessing <span class="hljs-keyword">import</span> Process, Queue

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ParallelPPO</span>:
    <span class="hljs-string">"""并行PPO实现"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, env_name, num_workers=<span class="hljs-number">4</span></span>):
        self.num_workers = num_workers
        self.env_name = env_name
        
        <span class="hljs-comment"># 创建共享网络</span>
        self.global_policy = ActorCriticNetwork(
            gym.make(env_name).observation_space.shape[<span class="hljs-number">0</span>],
            gym.make(env_name).action_space.n
        )
        
        <span class="hljs-comment"># 创建工作进程</span>
        self.workers = []
        self.result_queue = Queue()
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">worker_process</span>(<span class="hljs-params">self, worker_id, global_params, queue</span>):
        <span class="hljs-string">"""工作进程函数"""</span>
        <span class="hljs-comment"># 创建本地网络</span>
        local_policy = ActorCriticNetwork(...)
        local_policy.load_state_dict(global_params)
        
        <span class="hljs-comment"># 收集经验</span>
        buffer = self.collect_experience(local_policy)
        
        <span class="hljs-comment"># 计算梯度</span>
        gradients = self.compute_gradients(local_policy, buffer)
        
        <span class="hljs-comment"># 发送回主进程</span>
        queue.put((worker_id, gradients))
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">train_parallel</span>(<span class="hljs-params">self, total_updates=<span class="hljs-number">1000</span></span>):
        <span class="hljs-string">"""并行训练"""</span>
        <span class="hljs-keyword">for</span> update <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(total_updates):
            <span class="hljs-comment"># 启动工作进程</span>
            processes = []
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(self.num_workers):
                p = Process(target=self.worker_process,
                          args=(i, self.global_policy.state_dict(), self.result_queue))
                p.start()
                processes.append(p)
            
            <span class="hljs-comment"># 收集梯度</span>
            all_gradients = []
            <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(self.num_workers):
                worker_id, gradients = self.result_queue.get()
                all_gradients.append(gradients)
            
            <span class="hljs-comment"># 等待所有进程结束</span>
            <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> processes:
                p.join()
            
            <span class="hljs-comment"># 平均梯度并更新全局网络</span>
            self.apply_gradients(all_gradients)
</code></pre>
<h3 data-id="heading-20">第七章：PPO面试考点大全——准备好了吗？</h3>
<h4 data-id="heading-21">7.1 理论面试题</h4>
<p><strong>Q1：为什么PPO要使用Clipping机制？直接比率最大化不行吗？</strong></p>
<p><strong>参考答案</strong>：</p>
<blockquote>
<p>直接最大化比率r(θ)会导致策略更新过大，容易"一步踏空"。想象你在走钢丝：</p>
<ul>
<li>直接最大化：听到"左边风大"，你猛向左倾——掉下去了！</li>
<li>PPO-CLIP：听到"左边风大"，你想向左倾，但系统拉住你："最多倾20%！"——安全通过！</li>
</ul>
<p>数学上，TRPO用复杂的二阶优化保证信任域，PPO用简单的clip近似实现同样效果。</p>
</blockquote>
<p><strong>Q2：GAE中λ参数的作用是什么？λ=0和λ=1分别对应什么？</strong></p>
<p><strong>参考答案</strong>：</p>
<blockquote>
<p>λ是偏差-方差权衡的超参数：</p>
<ul>
<li>λ=0：使用TD(0)，即单步优势估计。高偏差（短视），低方差</li>
<li>λ=1：使用蒙特卡洛回报，无偏差但高方差（看完全局才判断）</li>
<li>λ=0.95：折中方案，通常效果最好</li>
</ul>
<p>就像天气预报：只看今天（λ=0）不准，看全年平均（λ=1）没意义，看未来一周（λ=0.95）最实用。</p>
</blockquote>
<p><strong>Q3：PPO中的熵正则项有什么作用？</strong></p>
<p><strong>参考答案</strong>：</p>
<blockquote>
<p>熵正则项鼓励探索，防止策略过早收敛到局部最优。可以理解为：</p>
<ol>
<li><strong>探索激励</strong>：让AI保持好奇心，尝试新动作</li>
<li><strong>避免确定性</strong>：防止输出变成one-hot，保持一定随机性</li>
<li><strong>训练稳定性</strong>：在训练初期特别重要</li>
</ol>
<p>但要注意：熵系数需要衰减，否则后期还在"瞎探索"。</p>
</blockquote>
<h4 data-id="heading-22">7.2 代码面试题</h4>
<p><strong>Q1：实现PPO中的clip损失函数</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">ppo_clip_loss</span>(<span class="hljs-params">new_logprobs, old_logprobs, advantages, epsilon=<span class="hljs-number">0.2</span></span>):
    <span class="hljs-string">"""
    实现PPO-CLIP损失函数
    
    参数:
        new_logprobs: 新策略的对数概率 [batch_size]
        old_logprobs: 旧策略的对数概率 [batch_size]
        advantages: 优势估计 [batch_size]
        epsilon: 裁剪参数
    
    返回:
        policy_loss: 策略损失（标量）
    """</span>
    <span class="hljs-comment"># 计算概率比</span>
    ratio = torch.exp(new_logprobs - old_logprobs)
    
    <span class="hljs-comment"># 两种目标</span>
    surr1 = ratio * advantages
    surr2 = torch.clamp(ratio, <span class="hljs-number">1</span> - epsilon, <span class="hljs-number">1</span> + epsilon) * advantages
    
    <span class="hljs-comment"># 取最小值并求平均</span>
    policy_loss = -torch.<span class="hljs-built_in">min</span>(surr1, surr2).mean()
    
    <span class="hljs-keyword">return</span> policy_loss
</code></pre>
<p><strong>Q2：解释下面PPO训练代码的问题</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 有问题的代码</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">train_ppo</span>():
    <span class="hljs-keyword">for</span> episode <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1000</span>):
        <span class="hljs-comment"># 收集数据</span>
        states, actions, rewards = collect_one_episode()
        
        <span class="hljs-comment"># 每个episode都更新</span>
        update_policy(states, actions, rewards)
        
    <span class="hljs-comment"># 问题：没有重要性采样，没有clip，没有GAE...</span>
</code></pre>
<p><strong>参考答案</strong>：</p>
<blockquote>
<p>这段代码有多个问题：</p>
<ol>
<li><strong>样本效率低</strong>：每个episode只更新一次</li>
<li><strong>没有重要性采样</strong>：直接用新策略梯度更新，破坏理论保证</li>
<li><strong>没有Clipping</strong>：可能导致大幅度的策略更新</li>
<li><strong>没有优势归一化</strong>：梯度可能不稳定</li>
<li><strong>没有价值函数训练</strong>：缺少评论家网络</li>
</ol>
</blockquote>
<h3 data-id="heading-23">第八章：总结——PPO的过去、现在与未来</h3>
<h4 data-id="heading-24">8.1 PPO的成功秘诀</h4>
<p>PPO之所以成为RL领域的"瑞士军刀"，是因为它：</p>
<ol>
<li><strong>简单有效</strong>：几行代码就能实现，效果却不错</li>
<li><strong>稳定可靠</strong>：相比DQN、A3C等更不容易崩溃</li>
<li><strong>通用性强</strong>：连续/离散动作、各种环境都能用</li>
<li><strong>有理论依据</strong>：虽然不是严格保证，但有TRPO的理论基础</li>
</ol>
<h4 data-id="heading-25">8.2 PPO的局限性</h4>
<p>当然，PPO也不是万能的：</p>
<ol>
<li><strong>超参数敏感</strong>：ε、λ等参数需要仔细调整</li>
<li><strong>样本效率</strong>：相比SAC等off-policy算法，样本效率较低</li>
<li><strong>探索能力</strong>：依赖熵正则，探索可能不足</li>
<li><strong>收敛速度</strong>：有时候比TRPO慢</li>
</ol>
<h4 data-id="heading-26">8.3 PPO的未来发展</h4>
<p>PPO家族还在不断进化：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># PPO的未来变体可能包括：</span>
future_ppo_variants = {
    <span class="hljs-string">'PPO-λ'</span>: <span class="hljs-string">'自动调整λ参数的自适应PPO'</span>,
    <span class="hljs-string">'PPO-M'</span>: <span class="hljs-string">'结合模型预测的PPO'</span>,
    <span class="hljs-string">'PPO-H'</span>: <span class="hljs-string">'分层PPO，解决长期信用分配'</span>,
    <span class="hljs-string">'PPO-D'</span>: <span class="hljs-string">'分布式PPO，更好处理多模态奖励'</span>,
    <span class="hljs-string">'PPO-T'</span>: <span class="hljs-string">'结合Transformer的PPO，处理长序列'</span>
}
</code></pre>
<h4 data-id="heading-27">8.4 最后的话：给RL学习者的建议</h4>
<p>学习PPO（和强化学习）就像学骑自行车：</p>
<ol>
<li><strong>先跑起来</strong>：用默认参数让代码能运行</li>
<li><strong>别怕摔跤</strong>：调试是学习的一部分</li>
<li><strong>理解原理</strong>：知道为什么clip，为什么用GAE</li>
<li><strong>动手实践</strong>：在多种环境中尝试</li>
<li><strong>持续学习</strong>：RL领域日新月异，保持好奇心</li>
</ol>
<p>记住，每个RL大牛都曾经：</p>
<ul>
<li>调参调到怀疑人生</li>
<li>看着NaN损失发呆</li>
<li>以为训练好了，结果测试时崩了</li>
<li>读论文时"我懂了"，写代码时"我是谁？"</li>
</ul>
<p>但最终，当你的AI第一次学会平衡、学会行走、学会玩游戏时，那种成就感是无与伦比的！</p>
<hr/>
<p><strong>致谢</strong>：感谢OpenAI的研究员们提出了PPO，让强化学习不再那么"劝退"。也感谢坚持读到这里的你，未来的RL专家！</p>
<p><strong>下一步行动</strong>：</p>
<ol>
<li>运行上面的代码，看看AI怎么学会平衡木</li>
<li>尝试修改参数，观察效果变化</li>
<li>应用到你自己感兴趣的环境</li>
<li>读一读PPO原论文（其实不难懂！）</li>
</ol>
<p>祝你在强化学习的道路上越走越远！🚀</p>
<blockquote>
<p>"PPO最大的优点，就是它没有明显的缺点。" —— RL社区共识</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 从入门到出门第二章 生命周期函数与内置 Hooks 整体认知]]></title>    <link>https://juejin.cn/post/7590309337861832745</link>    <guid>https://juejin.cn/post/7590309337861832745</guid>    <pubDate>2026-01-04T00:43:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590309337861832745" data-draft-id="7589838742552789011" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 从入门到出门第二章  生命周期函数与内置 Hooks 整体认知"/> <meta itemprop="keywords" content="前端,JavaScript,React.js"/> <meta itemprop="datePublished" content="2026-01-04T00:43:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="怕浪猫"/> <meta itemprop="url" content="https://juejin.cn/user/2832784963939438"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 从入门到出门第二章  生命周期函数与内置 Hooks 整体认知
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2832784963939438/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    怕浪猫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T00:43:54.000Z" title="Sun Jan 04 2026 00:43:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98bd667ad2354695944a091cfccc3383~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oCV5rWq54yr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768092399&amp;x-signature=i88iIR3QvgrJ3XdKdiu%2BHmFGM2Y%3D" alt="BLAb3hgs.jpeg" loading="lazy"/>
大家好～ 上一篇我们聊了 React 19 的 JSX 增强特性和函数组件基础，今天咱们聚焦另一个核心知识点——生命周期函数与内置 Hooks。</p>
<p>很多刚接触 React 的同学会有个误区：“只有 class 组件才有生命周期”。其实在 React 19 中，函数组件通过 Hooks 完全可以实现甚至优化生命周期的逻辑，而且 Hooks 是函数组件的核心能力，所有 React 19 新特性都围绕 Hooks 展开。</p>
<p>今天这篇文章，我们就从“生命周期的本质是什么”入手，先搞懂 React 组件的核心运行流程，再逐一认识 React 19 中 8 个常用内置 Hooks（useState、useEffect、useContext、useCallback、useRef、useMemo、useDeferredValue、useTransition），结合代码示例讲清“核心作用+应用场景+使用注意”，最后用精准的图例梳理清楚 Hooks 与生命周期的对应关系，帮大家建立完整的知识框架。</p>
<h2 data-id="heading-0">一、先搞懂：生命周期的本质是“组件的运行阶段”</h2>
<p>不管是 class 组件还是函数组件，React 组件的核心运行流程都可以分为三个阶段：<strong>挂载阶段（组件第一次渲染到页面）、更新阶段（组件数据变化重新渲染）、卸载阶段（组件从页面中移除）</strong> 。</p>
<p>生命周期函数，就是 React 提供的、允许我们在组件不同运行阶段插入自定义逻辑的“钩子”。比如：</p>
<ul>
<li>挂载阶段：我们可能需要请求初始化数据、绑定事件监听；</li>
<li>更新阶段：我们可能需要根据数据变化更新 DOM 、做性能优化；</li>
<li>卸载阶段：我们可能需要清除定时器、取消事件监听，避免内存泄漏。</li>
</ul>
<h3 data-id="heading-1">React 19 中生命周期的实现方式</h3>
<p>在 React 早期，class 组件通过 <code>componentDidMount</code>、<code>componentDidUpdate</code>、<code>componentWillUnmount</code> 等生命周期方法实现上述逻辑。但在 React 19 中，函数组件+ Hooks 已经成为主流，官方也更推荐这种方式——因为 Hooks 能让逻辑复用更简单，代码更简洁。</p>
<p>下面先通过一个精准的图例，直观看看 React 19 组件的完整生命周期流程，以及函数组件中对应的 Hooks
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a90c83f90d84fefbafa7cbbc209f723~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oCV5rWq54yr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768092399&amp;x-signature=d3%2BzP070II4mRUmTMwuXj2BnhYk%3D" alt="ogimage.png" loading="lazy"/>
从图中可以看出：useEffect 是最核心的“生命周期 Hooks”，能覆盖挂载、更新、卸载三个阶段的逻辑；而 useState、useContext 等 Hooks 则聚焦于状态管理或性能优化，为生命周期中的逻辑提供支撑。</p>
<h2 data-id="heading-2">二、React 19 8 个核心内置 Hooks 详解（核心作用+应用场景+代码示例）</h2>
<p>React 19 提供了一系列内置 Hooks，每个 Hooks 都有明确的使用场景，遵循“命名以 use 开头、只能在函数组件顶层调用”的规则。下面我们逐一讲解 8 个常用核心 Hooks，重点突出应用场景，结合实战代码说明用法。</p>
<h3 data-id="heading-3">1. useState：组件状态管理的“基石”</h3>
<p><strong>核心作用</strong>：为函数组件添加“可变化的状态”（组件内部可修改、修改后触发重新渲染的数据），是实现组件更新生命周期的基础。</p>
<p><strong>应用场景</strong>：</p>
<ul>
<li>管理组件内部的简单状态（如计数器数值、表单输入值、弹窗显示/隐藏状态）；</li>
<li>存储组件渲染所需的动态数据（如列表数据、用户信息等，可配合 useEffect 请求后更新）；</li>
<li>实现组件内部的状态联动（如根据一个状态变化同步更新另一个状态）。</li>
</ul>
<p><strong>语法</strong>：<code>const [状态变量, 状态更新函数] = useState(初始值);</code></p>
<p><strong>使用注意</strong>：状态更新是异步的，若需基于前一个状态更新，需使用函数式更新（<code>setCount(prev =&gt; prev + 1)</code>）；更新对象/数组时需遵循“不可变原则”，不能直接修改原数据。</p>
<h4 data-id="heading-4">实战案例：表单输入与弹窗控制</h4>
<pre><code class="hljs language-ini" lang="ini">import { useState } from 'react'<span class="hljs-comment">;</span>

function FormWithModal() {
  // 场景1：管理表单输入状态（用户名、密码）
  const <span class="hljs-section">[formData, setFormData]</span> = useState({ username: '', password: '' })<span class="hljs-comment">;</span>
  // 场景2：管理弹窗显示/隐藏状态
  const <span class="hljs-section">[isModalOpen, setIsModalOpen]</span> = useState(false)<span class="hljs-comment">;</span>

  const <span class="hljs-attr">handleInputChange</span> = (e) =&gt; {
    const { name, value } = e.target<span class="hljs-comment">;</span>
    // 不可变更新对象状态
    setFormData(<span class="hljs-attr">prev</span> =&gt; ({ ...prev, [name]: value }))<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>

  const <span class="hljs-attr">handleSubmit</span> = (e) =&gt; {
    e.preventDefault()<span class="hljs-comment">;</span>
    // 表单验证通过后打开弹窗
    if (formData.username &amp;&amp; formData.password) {
      setIsModalOpen(true)<span class="hljs-comment">;</span>
    }
  }<span class="hljs-comment">;</span>

  return (
    &lt;div&gt;
      &lt;form <span class="hljs-attr">onSubmit</span>={handleSubmit}&gt;
        &lt;input
          <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>
          <span class="hljs-attr">name</span>=<span class="hljs-string">"username"</span>
          <span class="hljs-attr">value</span>={formData.username}
          <span class="hljs-attr">onChange</span>={handleInputChange}
          <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入用户名"</span>
        /&gt;
        &lt;input
          <span class="hljs-attr">type</span>=<span class="hljs-string">"password"</span>
          <span class="hljs-attr">name</span>=<span class="hljs-string">"password"</span>
          <span class="hljs-attr">value</span>={formData.password}
          <span class="hljs-attr">onChange</span>={handleInputChange}
          <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入密码"</span>
        /&gt;
        &lt;button <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;提交&lt;/button&gt;
      &lt;/form&gt;

      {/* 弹窗组件，根据 isModalOpen 状态显示/隐藏 */}
      {isModalOpen &amp;&amp; (
        &lt;div <span class="hljs-attr">style</span>={{ position: <span class="hljs-string">'fixed'</span>, top: <span class="hljs-string">'50%'</span>, left: <span class="hljs-string">'50%'</span>, transform: <span class="hljs-string">'translate(-50%, -50%)'</span>, border: <span class="hljs-string">'1px solid #ccc'</span>, padding: <span class="hljs-string">'20px'</span> }}&gt;
          &lt;h3&gt;提交成功！&lt;/h3&gt;
          &lt;p&gt;用户名：{formData.username}&lt;/p&gt;
          &lt;button <span class="hljs-attr">onClick</span>={() =&gt; setIsModalOpen(<span class="hljs-literal">false</span>)}&gt;关闭&lt;/button&gt;
        &lt;/div&gt;
      )}
    &lt;/div&gt;
  )<span class="hljs-comment">;</span>
}
</code></pre>
<h3 data-id="heading-5">2. useEffect：处理副作用的“万能 Hooks”</h3>
<p><strong>核心作用</strong>：处理组件的“副作用”（即不直接参与 UI 渲染的逻辑，如数据请求、事件绑定、定时器、清理资源等），覆盖 class 组件 <code>componentDidMount</code>、<code>componentDidUpdate</code>、<code>componentWillUnmount</code> 三个生命周期方法的功能。</p>
<p><strong>应用场景</strong>：</p>
<ul>
<li>挂载阶段：初始化数据请求（如页面加载时请求列表数据）、绑定全局事件（如窗口大小监听、滚动监听）；</li>
<li>更新阶段：依赖数据变化后重新请求数据（如根据用户 ID 变化请求对应用户详情）、根据状态变化更新 DOM 样式；</li>
<li>卸载阶段：清理资源（如清除定时器、取消事件监听、取消未完成的请求），避免内存泄漏。</li>
</ul>
<p><strong>语法</strong>：<code>useEffect(() =&gt; { 副作用逻辑; return () =&gt; { 清理逻辑; }; }, [依赖数组]);</code></p>
<p><strong>使用注意</strong>：依赖数组需包含副作用逻辑中使用的所有状态/变量，避免遗漏导致使用旧值；空依赖数组（<code>[]</code>）仅在挂载时执行一次，无数组则每次渲染都执行。</p>
<h4 data-id="heading-6">实战案例：数据请求+事件监听+定时器清理</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">DataFetchWithCleanup</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [data, setData] = <span class="hljs-title function_">useState</span>([]);
  <span class="hljs-keyword">const</span> [loading, setLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 场景1：挂载时请求数据</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.example.com/list'</span>);
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>();
        <span class="hljs-title function_">setData</span>(result);
      } <span class="hljs-keyword">catch</span> (err) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请求失败：'</span>, err);
      } <span class="hljs-keyword">finally</span> {
        <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>);
      }
    };
    <span class="hljs-title function_">fetchData</span>();

    <span class="hljs-comment">// 场景2：绑定窗口滚动监听事件</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleScroll</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'滚动位置：'</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollY</span>);
    };
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, handleScroll);

    <span class="hljs-comment">// 场景3：开启定时器</span>
    <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'定时器执行中...'</span>);
    }, <span class="hljs-number">1000</span>);

    <span class="hljs-comment">// 清理逻辑：卸载时执行</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'scroll'</span>, handleScroll); <span class="hljs-comment">// 移除事件监听</span>
      <span class="hljs-built_in">clearInterval</span>(timer); <span class="hljs-comment">// 清除定时器</span>
      <span class="hljs-comment">// 若有未完成的请求，可在此处取消（如使用 AbortController）</span>
    };
  }, []); <span class="hljs-comment">// 空依赖，仅挂载时执行</span>

  <span class="hljs-keyword">if</span> (loading) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
      {data.map(item =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span>&gt;</span>{item.name}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-7">3. useContext：跨组件状态共享的“快捷方式”</h3>
<p><strong>核心作用</strong>：解决“组件层级过深时的 props 透传问题”（即“props drilling”），允许子组件直接获取父组件提供的共享状态，无需通过中间组件层层传递。</p>
<p><strong>应用场景</strong>：</p>
<ul>
<li>共享全局基础状态（如主题色、语言设置、用户登录状态）；</li>
<li>共享组件树内的公共状态（如表单步骤组件间的步骤状态、列表页与详情页的共享筛选条件）；</li>
<li>简化跨层级组件的通信（如爷爷组件向孙子组件传递数据，无需父组件中转）。</li>
</ul>
<p><strong>使用步骤</strong>：</p>
<ol>
<li>创建 Context：<code>const MyContext = createContext(默认值);</code>（默认值仅在无 Provider 时生效）；</li>
<li>提供 Context：用 <code>&lt;MyContext.Provider value={共享数据/方法}&gt;</code> 包裹需要共享数据的组件树；</li>
<li>消费 Context：在子组件中用 <code>useContext(MyContext)</code> 获取共享数据。</li>
</ol>
<p><strong>使用注意</strong>：useContext 适合共享“变化不频繁”的状态，若需频繁更新且涉及复杂逻辑，建议结合 useReducer 或专门的状态管理库（如 Redux Toolkit）。</p>
<h4 data-id="heading-8">实战案例：全局主题切换（多组件共享主题状态）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createContext, useContext, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 1. 创建主题 Context</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">ThemeContext</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-string">'light'</span>);

<span class="hljs-comment">// 2. 提供 Context 的顶层组件（如 App 或专门的 Provider 组件）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ThemeProvider</span>(<span class="hljs-params">{ children }</span>) {
  <span class="hljs-keyword">const</span> [theme, setTheme] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'light'</span>);

  <span class="hljs-comment">// 共享的方法：切换主题</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleTheme</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setTheme</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev === <span class="hljs-string">'light'</span> ? <span class="hljs-string">'dark'</span> : <span class="hljs-string">'light'</span>);
  };

  <span class="hljs-comment">// 向子组件提供的共享数据（状态+方法）</span>
  <span class="hljs-keyword">const</span> contextValue = { theme, toggleTheme };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ThemeContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{contextValue}</span>&gt;</span>
      {children} {/* 包裹需要共享主题的所有组件 */}
    <span class="hljs-tag">&lt;/<span class="hljs-name">ThemeContext.Provider</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 3. 消费 Context 的子组件1：主题按钮（任意层级）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ThemeToggleButton</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { theme, toggleTheme } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ThemeContext</span>);
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span>
      <span class="hljs-attr">onClick</span>=<span class="hljs-string">{toggleTheme}</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">background:</span> <span class="hljs-attr">theme</span> === <span class="hljs-string">'light'</span> ? '#<span class="hljs-attr">fff</span>' <span class="hljs-attr">:</span> '#<span class="hljs-attr">333</span>',
        <span class="hljs-attr">color:</span> <span class="hljs-attr">theme</span> === <span class="hljs-string">'light'</span> ? '#<span class="hljs-attr">333</span>' <span class="hljs-attr">:</span> '#<span class="hljs-attr">fff</span>',
        <span class="hljs-attr">padding:</span> '<span class="hljs-attr">8px</span> <span class="hljs-attr">16px</span>',
        <span class="hljs-attr">border:</span> '<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">ccc</span>'
      }}
    &gt;</span>
      切换到 {theme === 'light' ? '深色' : '浅色'} 主题
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 4. 消费 Context 的子组件2：主题内容区（任意层级）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ThemeContent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { theme } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ThemeContext</span>);
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">width:</span> '<span class="hljs-attr">300px</span>',
        <span class="hljs-attr">height:</span> '<span class="hljs-attr">200px</span>',
        <span class="hljs-attr">margin:</span> '<span class="hljs-attr">20px</span> <span class="hljs-attr">0</span>',
        <span class="hljs-attr">background:</span> <span class="hljs-attr">theme</span> === <span class="hljs-string">'light'</span> ? '#<span class="hljs-attr">fff</span>' <span class="hljs-attr">:</span> '#<span class="hljs-attr">333</span>',
        <span class="hljs-attr">color:</span> <span class="hljs-attr">theme</span> === <span class="hljs-string">'light'</span> ? '#<span class="hljs-attr">333</span>' <span class="hljs-attr">:</span> '#<span class="hljs-attr">fff</span>',
        <span class="hljs-attr">padding:</span> '<span class="hljs-attr">20px</span>'
      }}
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>当前主题：{theme}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>跨组件共享主题状态示例<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 根组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ThemeProvider</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ThemeToggleButton</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ThemeContent</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ThemeProvider</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-9">4. useCallback：缓存函数的“性能优化工具”</h3>
<p><strong>核心作用</strong>：缓存函数引用，避免函数在组件每次渲染时重新创建，减少因函数引用变化导致的子组件不必要重渲染。</p>
<p><strong>应用场景</strong>：</p>
<ul>
<li>向子组件传递回调函数时（尤其是子组件使用 React.memo 包裹进行性能优化时）；</li>
<li>函数作为 useEffect 的依赖时（避免因函数重新创建导致 useEffect 不必要执行）；</li>
<li>高频渲染的组件中（如列表项组件，每个列表项需传递点击事件函数）。</li>
</ul>
<p><strong>语法</strong>：<code>const 缓存的函数 = useCallback(原函数, [依赖数组]);</code></p>
<p><strong>使用注意</strong>：依赖数组需包含原函数中使用的所有外部变量/状态；若函数无依赖，依赖数组可为空（<code>[]</code>）；仅在函数引用变化会导致性能问题时使用，无需过度使用。</p>
<h4 data-id="heading-10">实战案例：优化子组件重渲染</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState, useCallback, memo } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 子组件：用 React.memo 包裹，仅在 props 变化时重渲染</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Child</span> = <span class="hljs-title function_">memo</span>(<span class="hljs-function">(<span class="hljs-params">{ onClick, name }</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${name}</span> 子组件渲染了`</span>);
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onClick}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">margin:</span> '<span class="hljs-attr">5px</span>' }}&gt;</span>
      {name} 按钮
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
});

<span class="hljs-keyword">function</span> <span class="hljs-title function_">UseCallbackDemo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-comment">// 未使用 useCallback：每次渲染都会重新创建函数，导致 Child 重渲染</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleNormalClick</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'普通按钮点击'</span>);
  };

  <span class="hljs-comment">// 使用 useCallback：缓存函数引用，仅依赖变化时才重新创建</span>
  <span class="hljs-keyword">const</span> handleCachedClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'缓存按钮点击'</span>);
  }, []); <span class="hljs-comment">// 无依赖，永久缓存</span>

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>计数：{count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(prev =&gt; prev + 1)}&gt;+1（触发父组件渲染）<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleNormalClick}</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"普通"</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleCachedClick}</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"缓存"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>运行结果：点击“+1”按钮触发父组件渲染时，“普通按钮”子组件会重新渲染（因 handleNormalClick 函数重新创建），而“缓存按钮”子组件不会重新渲染（因 handleCachedClick 引用未变）。</p>
<h3 data-id="heading-11">5. useRef：获取 DOM/保存持久值的“工具 Hooks”</h3>
<p><strong>核心作用</strong>：有两个核心用途——一是获取 DOM 元素或组件实例；二是保存“持久化值”（组件重新渲染时值不重置，且修改值不会触发组件重新渲染）。</p>
<p><strong>应用场景</strong>：</p>
<ul>
<li>获取 DOM 元素：实现输入框自动聚焦、获取 DOM 尺寸/位置、操作 DOM 元素（如设置样式、触发事件）；</li>
<li>保存持久值：记录组件渲染次数、保存定时器 ID、保存前一次的状态/Props 值、存储不希望触发重新渲染的数据。</li>
</ul>
<p><strong>语法</strong>：<code>const ref 对象 = useRef(初始值);</code>（通过 <code>ref.current</code> 访问/修改值）</p>
<p><strong>使用注意</strong>：修改 <code>ref.current</code> 是同步的，但不会触发组件重新渲染；若需基于 ref 值更新 UI，需配合 useState 或 useEffect。</p>
<h4 data-id="heading-12">实战案例：输入框自动聚焦+记录渲染次数</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useRef, useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">UseRefDemo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-comment">// 场景1：获取 DOM 元素（输入框）</span>
  <span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-comment">// 场景2：保存持久值（渲染次数）</span>
  <span class="hljs-keyword">const</span> renderCountRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-number">0</span>);

  <span class="hljs-comment">// 每次渲染后更新渲染次数（useEffect 无依赖，每次渲染都执行）</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    renderCountRef.<span class="hljs-property">current</span> += <span class="hljs-number">1</span>;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'组件渲染次数：'</span>, renderCountRef.<span class="hljs-property">current</span>);
  });

  <span class="hljs-comment">// 挂载时让输入框自动聚焦</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    inputRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">focus</span>();
  }, []);

  <span class="hljs-comment">// 点击按钮滚动到输入框位置</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">scrollToInput</span> = (<span class="hljs-params"/>) =&gt; {
    inputRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">scrollIntoView</span>({ <span class="hljs-attr">behavior</span>: <span class="hljs-string">'smooth'</span> });
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">marginTop:</span> '<span class="hljs-attr">50px</span>' }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>计数：{count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>组件渲染次数：{renderCountRef.current}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(prev =&gt; prev + 1)}&gt;+1（触发渲染）<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{scrollToInput}</span>&gt;</span>滚动到输入框<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

      {/* 输入框：通过 ref 关联 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">marginTop:</span> '<span class="hljs-attr">200px</span>' }}&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
          <span class="hljs-attr">ref</span>=<span class="hljs-string">{inputRef}</span>
          <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>
          <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"我会自动聚焦..."</span>
          <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">width:</span> '<span class="hljs-attr">300px</span>', <span class="hljs-attr">height:</span> '<span class="hljs-attr">30px</span>' }}
        /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-13">6. useMemo：缓存计算结果的“性能优化工具”</h3>
<p><strong>核心作用</strong>：缓存“昂贵计算”的结果，避免组件每次渲染时重复执行相同的复杂计算，提升组件渲染性能。</p>
<p><strong>应用场景</strong>：</p>
<ul>
<li>执行复杂计算时（如大数据量列表排序、过滤、复杂数学计算）；</li>
<li>计算结果作为 props 传递给子组件时（避免因计算结果重新创建导致子组件不必要重渲染）；</li>
<li>基于多个状态/Props 推导衍生数据时（如根据筛选条件和排序规则推导过滤后的列表）。</li>
</ul>
<p><strong>语法</strong>：<code>const 缓存的计算结果 = useMemo(() =&gt; 计算逻辑, [依赖数组]);</code></p>
<p><strong>使用注意</strong>：依赖数组需包含计算逻辑中使用的所有外部变量/状态；仅用于“昂贵计算”，简单计算无需使用（缓存本身有轻微开销）；useMemo 是“备忘录”，仅在依赖变化时重新计算。</p>
<h4 data-id="heading-14">实战案例：优化大数据量排序</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState, useMemo } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">UseMemoDemo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [list, setList] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 模拟大数据量（10000 条数据）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">10000</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> ({ <span class="hljs-attr">id</span>: i, <span class="hljs-attr">value</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">1000</span> }));
  });
  <span class="hljs-keyword">const</span> [sortType, setSortType] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'asc'</span>); <span class="hljs-comment">// asc：升序，desc：降序</span>

  <span class="hljs-comment">// 场景：复杂计算（大数据量排序），用 useMemo 缓存结果</span>
  <span class="hljs-keyword">const</span> sortedList = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'执行排序计算...'</span>);
    <span class="hljs-comment">// 模拟昂贵计算（排序 10000 条数据）</span>
    <span class="hljs-keyword">return</span> [...list].<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> sortType === <span class="hljs-string">'asc'</span> ? a.<span class="hljs-property">value</span> - b.<span class="hljs-property">value</span> : b.<span class="hljs-property">value</span> - a.<span class="hljs-property">value</span>;
    });
  }, [list, sortType]); <span class="hljs-comment">// 仅 list 或 sortType 变化时重新排序</span>

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setSortType(prev =&gt; prev === 'asc' ? 'desc' : 'asc')}&gt;
        切换排序（当前：{sortType === 'asc' ? '升序' : '降序'}）
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">marginTop:</span> '<span class="hljs-attr">20px</span>' }}&gt;</span>
        {/* 仅渲染前 10 条数据，避免页面卡顿 */}
        {sortedList.slice(0, 10).map(item =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span>&gt;</span>ID：{item.id}，值：{item.value.toFixed(2)}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        ))}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>运行结果：首次渲染和切换排序时会执行排序计算（控制台打印“执行排序计算...”），若仅触发其他不相关状态更新（如添加一个无关计数器），sortedList 会直接使用缓存结果，不会重新排序。</p>
<h3 data-id="heading-15">7. useDeferredValue：延迟更新非紧急状态的“体验优化工具”</h3>
<p><strong>核心作用</strong>：创建一个“延迟版本”的状态，当组件有紧急更新（如输入框输入）时，优先执行紧急更新，非紧急更新延迟到紧急更新完成后再执行，避免页面卡顿，提升用户体验。</p>
<p><strong>应用场景</strong>：</p>
<ul>
<li>输入框实时搜索（输入是紧急更新，搜索结果渲染是非紧急更新，避免输入卡顿）；</li>
<li>大数据量列表实时筛选（输入筛选条件是紧急更新，筛选结果渲染是非紧急更新）；</li>
<li>任何需要“优先响应用户操作”的场景（如拖拽时的非紧急状态更新）。</li>
</ul>
<p><strong>语法</strong>：<code>const 延迟状态 = useDeferredValue(原始状态);</code></p>
<p><strong>使用注意</strong>：useDeferredValue 是“被动延迟”，依赖原始状态变化；延迟状态会“追平”原始状态，最终与原始状态一致；无需手动清理，React 会自动处理。</p>
<h4 data-id="heading-16">实战案例：输入框实时搜索（优化输入体验）</h4>
<pre><code class="hljs language-ini" lang="ini">import { useState, useDeferredValue } from 'react'<span class="hljs-comment">;</span>

// 模拟大数据量列表（10000 条数据）
const <span class="hljs-attr">mockList</span> = Array.from({ length: <span class="hljs-number">10000</span> }, (_, i) =&gt; ({
  id: i,
  name: `商品 ${i + 1} - ${Math.random().toString(36).substring(2, 6)}`
}))<span class="hljs-comment">;</span>

function DeferredValueSearch() {
  // 紧急状态：输入框输入值（优先响应）
  const <span class="hljs-section">[searchValue, setSearchValue]</span> = useState('')<span class="hljs-comment">;</span>
  // 延迟状态：搜索值的延迟版本（非紧急，等输入完成后再更新）
  const <span class="hljs-attr">deferredSearchValue</span> = useDeferredValue(searchValue)<span class="hljs-comment">;</span>

  // 根据延迟搜索值筛选列表（非紧急操作）
  const <span class="hljs-attr">filteredList</span> = mockList.filter(item =&gt; {
    return item.name.includes(deferredSearchValue)<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>

  return (
    &lt;div&gt;
      &lt;input
        <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>
        <span class="hljs-attr">value</span>={searchValue}
        <span class="hljs-attr">onChange</span>={(e) =&gt; setSearchValue(e.target.value)}
        <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"输入关键词搜索商品..."</span>
        <span class="hljs-attr">style</span>={{ width: <span class="hljs-string">'300px'</span>, height: <span class="hljs-string">'30px'</span>, padding: <span class="hljs-string">'0 8px'</span> }}
      /&gt;
      &lt;div <span class="hljs-attr">style</span>={{ marginTop: <span class="hljs-string">'20px'</span> }}&gt;
        {filteredList.slice(0, 10).map(<span class="hljs-attr">item</span> =&gt; (
          &lt;p <span class="hljs-attr">key</span>={item.id}&gt;{item.name}&lt;/p&gt;
        ))}
        {<span class="hljs-attr">filteredList.length</span> === <span class="hljs-number">0</span> &amp;&amp; &lt;p&gt;无匹配商品&lt;/p&gt;}
      &lt;/div&gt;
    &lt;/div&gt;
  )<span class="hljs-comment">;</span>
}
</code></pre>
<p>效果说明：若不使用 useDeferredValue，输入时会实时执行筛选逻辑（10000 条数据过滤），导致输入框卡顿；使用后，输入操作优先执行，筛选逻辑延迟到输入间隙执行，输入框流畅无卡顿。</p>
<h3 data-id="heading-17">8. useTransition：标记非紧急更新的“体验优化工具”</h3>
<p><strong>核心作用</strong>：将“非紧急的状态更新”标记为过渡更新，React 会优先处理紧急更新（如输入、点击等用户交互），非紧急更新在后台异步执行，避免阻塞用户操作，提升体验。</p>
<p><strong>应用场景</strong>：</p>
<ul>
<li>点击按钮触发的大数据量筛选/排序（点击是紧急操作，筛选/排序是非紧急更新）；</li>
<li>表单提交后的数据处理（提交操作是紧急的，后续数据加工是非紧急的）；</li>
<li>页面切换时的非紧急数据预加载（页面切换是紧急的，预加载数据是非紧急的）。</li>
</ul>
<p><strong>语法</strong>：<code>const [isPending, startTransition] = useTransition();</code></p>
<p>关键说明：</p>
<ul>
<li>startTransition：包裹非紧急的状态更新逻辑；</li>
<li>isPending：布尔值，标记过渡更新是否正在进行（可用于显示加载状态）。</li>
</ul>
<p><strong>使用注意</strong>：useTransition 是“主动标记”非紧急更新，需手动将更新逻辑放入 startTransition 中；过渡更新可被中断（如用户触发新的紧急更新），避免无效计算。</p>
<h4 data-id="heading-18">实战案例：按钮触发的大数据量排序（优化点击体验）</h4>
<pre><code class="hljs language-ini" lang="ini">import { useState, useTransition } from 'react'<span class="hljs-comment">;</span>

// 模拟大数据量（10000 条数据）
const <span class="hljs-attr">mockList</span> = Array.from({ length: <span class="hljs-number">10000</span> }, (_, i) =&gt; ({
  id: i,
  value: Math.random() * 1000
}))<span class="hljs-comment">;</span>

function TransitionSort() {
  const <span class="hljs-section">[list, setList]</span> = useState(mockList)<span class="hljs-comment">;</span>
  const <span class="hljs-section">[sortType, setSortType]</span> = useState('asc')<span class="hljs-comment">;</span>
  // 获取过渡更新状态（是否正在排序）和标记函数
  const <span class="hljs-section">[isPending, startTransition]</span> = useTransition()<span class="hljs-comment">;</span>

  const <span class="hljs-attr">handleSort</span> = () =&gt; {
    const <span class="hljs-attr">newSortType</span> = sortType === <span class="hljs-string">'asc'</span> ? <span class="hljs-string">'desc'</span> : <span class="hljs-string">'asc'</span><span class="hljs-comment">;</span>
    setSortType(newSortType)<span class="hljs-comment">; // 紧急更新：切换排序类型文字</span>

    // 非紧急更新：大数据量排序，标记为过渡更新
    startTransition(() =&gt; {
      const <span class="hljs-attr">sortedList</span> = [...mockList].sort((a, b) =&gt; {
        return <span class="hljs-attr">newSortType</span> === <span class="hljs-string">'asc'</span> ? a.value - b.value : b.value - a.value<span class="hljs-comment">;</span>
      })<span class="hljs-comment">;</span>
      setList(sortedList)<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>

  return (
    &lt;div&gt;
      &lt;button <span class="hljs-attr">onClick</span>={handleSort} disabled={isPending}&gt;
        {isPending ? '排序中...' : `切换排序（当前：${<span class="hljs-attr">sortType</span> === <span class="hljs-string">'asc'</span> ? <span class="hljs-string">'升序'</span> : <span class="hljs-string">'降序'</span>}）`}
      &lt;/button&gt;
      &lt;div <span class="hljs-attr">style</span>={{ marginTop: <span class="hljs-string">'20px'</span> }}&gt;
        {list.slice(0, 10).map(<span class="hljs-attr">item</span> =&gt; (
          &lt;p <span class="hljs-attr">key</span>={item.id}&gt;ID：{item.id}，值：{item.value.toFixed(<span class="hljs-number">2</span>)}&lt;/p&gt;
        ))}
      &lt;/div&gt;
    &lt;/div&gt;
  )<span class="hljs-comment">;</span>
}
</code></pre>
<p>效果说明：点击按钮后，排序类型文字（sortType）立即更新（紧急更新），排序逻辑在后台异步执行；排序过程中按钮显示“排序中...”并禁用，避免重复点击；若排序未完成时触发新的紧急操作，排序可被中断，提升整体体验。</p>
<h2 data-id="heading-19">三、React 19 生命周期与 Hooks 对应关系梳理（精准图例+核心总结）</h2>
<p>为了让大家更清晰地对应“生命周期阶段”与“ Hooks 用法”，我们用以下精准图例总结，覆盖所有核心场景：</p>
<h3 data-id="heading-20">核心总结</h3>
<ol>
<li><strong>生命周期是“阶段”，Hooks 是“实现工具”</strong> ：函数组件通过不同 Hooks 覆盖挂载、更新、卸载全阶段逻辑，其中 useEffect 是核心生命周期 Hooks，其他 Hooks 按需补充功能；</li>
<li><strong>8 个核心 Hooks 各司其职</strong>：状态管理（useState）、副作用处理（useEffect）、跨组件共享（useContext）、性能优化（useCallback、useMemo）、DOM/持久值（useRef）、体验优化（useDeferredValue、useTransition）；</li>
<li><strong>使用 Hooks 需遵循核心规则</strong>：仅在函数组件/自定义 Hooks 顶层调用，不能在条件/循环/嵌套函数中使用；命名以 use 开头；依赖数组需完整包含外部依赖；</li>
<li><strong>优化类 Hooks 避免过度使用</strong>：useCallback、useMemo、useDeferredValue、useTransition 均为优化手段，需结合实际场景使用，简单场景无需额外优化（优化本身有开销）。</li>
</ol>
<h2 data-id="heading-21">四、常见误区与避坑指南</h2>
<ul>
<li><strong>误区 1：过度依赖 useEffect</strong>：简单的状态计算、DOM 操作若可同步执行，无需放入 useEffect，避免不必要的渲染延迟；</li>
<li><strong>误区 2：useCallback/useMemo 滥用</strong>：简单函数、简单计算无需缓存，仅在确有性能问题时使用；</li>
<li><strong>误区 3：useDeferredValue 与 useTransition 混淆</strong>：useDeferredValue 是“被动延迟状态”，依赖原始状态；useTransition 是“主动标记更新”，需手动包裹更新逻辑；</li>
<li><strong>误区 4：useContext 替代状态管理库</strong>：useContext 适合共享少量固定状态，复杂状态更新（如多组件修改同一状态）建议结合 useReducer 或 Redux Toolkit；</li>
<li><strong>误区 5：修改 ref.current 期望触发渲染</strong>：ref.current 变化不会触发组件重新渲染，若需更新 UI，需配合 useState 或 useEffect。</li>
</ul>
<h2 data-id="heading-22">五、下一步学习方向</h2>
<p>今天我们建立了 React 19 生命周期与 8 个核心 Hooks 的完整认知，这是函数组件开发的核心基础。下一步可以重点学习：</p>
<ul>
<li>自定义 Hooks：将复用逻辑封装为自定义 Hooks（如 useFetch、useTimer），提升代码复用性；</li>
<li>useReducer：处理复杂状态逻辑，替代 useState 实现多状态联动；</li>
<li>React 19 新增 Hooks：如 use()、useOptimistic 等，简化异步数据处理和乐观更新；</li>
<li>Hooks 性能优化实战：结合 React DevTools 分析组件渲染，精准使用优化类 Hooks。</li>
</ul>
<p>如果这篇文章对你有帮助，欢迎点赞、收藏、转发～ 有任何问题也可以在评论区留言交流～ 我们下期再见！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[剑指offer-58、对称二叉树]]></title>    <link>https://juejin.cn/post/7590915294446878747</link>    <guid>https://juejin.cn/post/7590915294446878747</guid>    <pubDate>2026-01-04T00:57:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590915294446878747" data-draft-id="7589838742552461331" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="剑指offer-58、对称二叉树"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-04T00:57:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            剑指offer-58、对称二叉树
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T00:57:54.000Z" title="Sun Jan 04 2026 00:57:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">题⽬描述</h2>
<p>请实现⼀个函数，⽤来判断⼀棵⼆叉树是不是对称的。注意，如果⼀个⼆叉树同此⼆叉树的镜像是同样
的，定义其为对称的。</p>
<p>例如：下⾯这棵⼆叉树是对称的</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d6e9fee68764db7bd76b229093845c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768093073&amp;x-signature=SebiB2H49DFLjKM3wz8YdBAwIb8%3D" alt="" loading="lazy"/></p>
<p>下⾯这个就不是对称的：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ab1d63fdfbe40caa91872d3d9f926a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768093073&amp;x-signature=im3RM6%2FiG%2BCNAGTQ9wAnNC5PYbQ%3D" alt="" loading="lazy"/></p>
<p>示例1</p>
<p>输⼊：{8,6,6,5,7,7,5}
返回值：true</p>
<p>示例2：</p>
<p>输⼊：{8,6,9,5,7,7,5}
返回值：false</p>
<h2 data-id="heading-1">思路及解答</h2>
<h3 data-id="heading-2">递归</h3>
<p>递归，先判断根节点是否为空，不为空则判断左右⼦树是不是对称。</p>
<p>如果左右⼦树都为空，则返回 true ，如果有⼀个为空，则返回 false ，如果两个都不为空的时候，除了对⽐左右两个节点的值，还需要递归，对⽐左⼦树的左⼦树和右⼦树的右⼦树是否相等，左⼦树的右⼦树和右⼦树的左⼦树是否相等。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">jude</span><span class="hljs-params">(TreeNode left, TreeNode right)</span> {
        <span class="hljs-comment">// 如果左右两个都为空，则对称</span>
        <span class="hljs-keyword">if</span> (left == <span class="hljs-literal">null</span> &amp;&amp; right == <span class="hljs-literal">null</span>) {
        	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (left == <span class="hljs-literal">null</span> || right == <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 如果左右两个有⼀个为空，那么就不对称</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        
        <span class="hljs-comment">// 都不为空的情况，需要判断两个的值，是不是相等</span>
        <span class="hljs-keyword">if</span> (left.val != right.val) {
        	<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 递归判断，左⼦树的左⼦树和右⼦树的右⼦树，左⼦树的右⼦树和右⼦树的左⼦树</span>
            <span class="hljs-keyword">return</span> jude(left.left, right.right) &amp;&amp; jude(left.right, right.left);
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isSymmetrical</span><span class="hljs-params">(TreeNode pRoot)</span> {
        <span class="hljs-comment">// 判断根节点是否为空，如果不为空则判断左右⼦树</span>
        <span class="hljs-keyword">return</span> pRoot==<span class="hljs-literal">null</span> || jude(pRoot.left, pRoot.right);
    }
}
</code></pre>
<ul>
<li>时间复杂度：O(n)</li>
<li>空间复杂度：O(n),最坏情况下，⼆叉树退化为链表</li>
</ul>
<h3 data-id="heading-3">迭代</h3>
<p>是借助两个队列，按照层次，⼀个是按照从左到右添加元素，另外⼀个队列
是按照从右到左添加元素，挨个取出来，进⾏对⽐，不等则说明不对称，如果相等，则再把其左右⼦树
分别按照不同的顺序添加到队列中。代码如下</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-comment">/**
    * 迭代法
     * 使用双端队列，相当于两个栈
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isSymmetric2</span><span class="hljs-params">(TreeNode root)</span> {
        Deque&lt;TreeNode&gt; deque = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();
        deque.offerFirst(root.left);
        deque.offerLast(root.right);
        <span class="hljs-keyword">while</span> (!deque.isEmpty()) {
            <span class="hljs-type">TreeNode</span> <span class="hljs-variable">leftNode</span> <span class="hljs-operator">=</span> deque.pollFirst();
            <span class="hljs-type">TreeNode</span> <span class="hljs-variable">rightNode</span> <span class="hljs-operator">=</span> deque.pollLast();
            <span class="hljs-keyword">if</span> (leftNode == <span class="hljs-literal">null</span> &amp;&amp; rightNode == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">continue</span>;
            }

            <span class="hljs-keyword">if</span> (leftNode == <span class="hljs-literal">null</span> || rightNode == <span class="hljs-literal">null</span> || leftNode.val != rightNode.val) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
            deque.offerFirst(leftNode.left);
            deque.offerFirst(leftNode.right);
            deque.offerLast(rightNode.right);
            deque.offerLast(rightNode.left);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-comment">/**
     * 迭代法
     * 使用普通队列
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isSymmetric3</span><span class="hljs-params">(TreeNode root)</span> {
        Queue&lt;TreeNode&gt; deque = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();
        deque.offer(root.left);
        deque.offer(root.right);
        <span class="hljs-keyword">while</span> (!deque.isEmpty()) {
            <span class="hljs-type">TreeNode</span> <span class="hljs-variable">leftNode</span> <span class="hljs-operator">=</span> deque.poll();
            <span class="hljs-type">TreeNode</span> <span class="hljs-variable">rightNode</span> <span class="hljs-operator">=</span> deque.poll();
            <span class="hljs-keyword">if</span> (leftNode == <span class="hljs-literal">null</span> &amp;&amp; rightNode == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">continue</span>;
            }

            <span class="hljs-keyword">if</span> (leftNode == <span class="hljs-literal">null</span> || rightNode == <span class="hljs-literal">null</span> || leftNode.val != rightNode.val) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
            <span class="hljs-comment">// 这里顺序与使用Deque不同</span>
            deque.offer(leftNode.left);
            deque.offer(rightNode.right);
            deque.offer(leftNode.right);
            deque.offer(rightNode.left);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<ul>
<li>空间复杂度为 O(n)</li>
<li>时间复杂度为 O(n) ,每个节点只会⼊队出队⼀次。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MyBatis会话模块详解]]></title>    <link>https://juejin.cn/post/7590929624743231538</link>    <guid>https://juejin.cn/post/7590929624743231538</guid>    <pubDate>2026-01-04T01:02:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590929624743231538" data-draft-id="7590457413347295259" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MyBatis会话模块详解"/> <meta itemprop="keywords" content="MyBatis"/> <meta itemprop="datePublished" content="2026-01-04T01:02:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MyBatis会话模块详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T01:02:17.000Z" title="Sun Jan 04 2026 01:02:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>深入剖析MyBatis核心——SqlSession的前世今生</p>
</blockquote>
<h2 data-id="heading-0">一、MyBatis整体架构与会话模块</h2>
<p>MyBatis是一个优秀的持久层框架，它支持定制化SQL、存储过程以及高级映射。MyBatis避免了几乎所有的JDBC代码和手动设置参数以及获取结果集的工作。</p>
<h2 data-id="heading-1">1.1 MyBatis整体架构</h2>
<p>MyBatis采用分层架构设计，从上到下分为：</p>
<pre><code class="hljs language-sql" lang="sql">• 应用层 — 与用户应用程序直接交互
• 接口层 — 提供SqlSession和Mapper接口
• 核心处理层 — 包括<span class="hljs-keyword">SQL</span>解析、执行、结果映射
• 基础支撑层 — 包括反射、类型处理、日志、缓存、事务
• 数据层 — 数据源管理、连接池、JDBC驱动
</code></pre>
<p>会话模块位于接口层，是MyBatis与应用程序交互的主要入口。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f3a231f2f3b486584e28511c97d91e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768093336&amp;x-signature=aKbE%2BshF1J9oHLOWoOoJ8wApvrM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">1.2 会话模块的核心职责</h2>
<p>会话模块在MyBatis中承担以下核心职责：</p>
<pre><code class="hljs language-sql" lang="sql">✅ 数据库操作接口 — 提供<span class="hljs-keyword">insert</span>、<span class="hljs-keyword">update</span>、<span class="hljs-keyword">delete</span>、<span class="hljs-keyword">select</span>等方法
✅ SqlSession生命周期管理 — 创建、使用、关闭SqlSession
✅ 事务控制 — 管理事务的开启、提交、回滚
✅ Mapper管理 — 获取Mapper接口的代理对象
✅ 批量操作支持 — 提供批量执行<span class="hljs-keyword">SQL</span>的能力
</code></pre>
<h2 data-id="heading-3">二、SqlSession接口详解</h2>
<p>SqlSession是MyBatis的核心接口之一，它定义了所有数据库操作的方法。</p>
<h2 data-id="heading-4">2.1 SqlSession核心方法分类</h2>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 查询单个对象</span>
&lt;T&gt; T <span class="hljs-built_in">selectOne</span>(String statement);
&lt;T&gt; T <span class="hljs-built_in">selectOne</span>(String statement, Object parameter);

<span class="hljs-comment">// 查询列表</span>
&lt;E&gt; List&lt;E&gt; <span class="hljs-built_in">selectList</span>(String statement);
&lt;E&gt; List&lt;E&gt; <span class="hljs-built_in">selectList</span>(String statement, Object parameter);

<span class="hljs-comment">// 查询Map</span>
&lt;K, V&gt; Map&lt;K, V&gt; <span class="hljs-built_in">selectMap</span>(String statement, String mapKey);

<span class="hljs-comment">// 游标查询</span>
&lt;T&gt; <span class="hljs-attribute">Cursor</span>&lt;T&gt; <span class="hljs-built_in">selectCursor</span>(String statement);
<span class="hljs-comment">// 插入</span>
int <span class="hljs-built_in">insert</span>(String statement);
int <span class="hljs-built_in">insert</span>(String statement, Object parameter);

<span class="hljs-comment">// 更新</span>
int <span class="hljs-built_in">update</span>(String statement);
int <span class="hljs-built_in">update</span>(String statement, Object parameter);

<span class="hljs-comment">// 删除</span>
int <span class="hljs-built_in">delete</span>(String statement);
int <span class="hljs-built_in">delete</span>(String statement, Object parameter);
<span class="hljs-comment">// 提交事务</span>
void <span class="hljs-built_in">commit</span>();
void <span class="hljs-built_in">commit</span>(boolean force);

<span class="hljs-comment">// 回滚事务</span>
void <span class="hljs-built_in">rollback</span>();
void <span class="hljs-built_in">rollback</span>(boolean force);
<span class="hljs-comment">// 获取Mapper代理对象</span>
&lt;T&gt; T <span class="hljs-built_in">getMapper</span>(Class&lt;T&gt; type);
<span class="hljs-comment">// 1. 获取SqlSessionFactory</span>
SqlSessionFactory factory = new <span class="hljs-built_in">SqlSessionFactoryBuilder</span>()
    <span class="hljs-selector-class">.build</span>(Resources.getResourceAsStream("mybatis-config.xml"));

<span class="hljs-comment">// 2. 打开SqlSession</span>
try (SqlSession session = factory.openSession()) {
    <span class="hljs-comment">// 3. 执行SQL</span>
    User user = session<span class="hljs-selector-class">.selectOne</span>(
        "com.example.mapper.UserMapper.selectById", <span class="hljs-number">1</span>);
    System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(user);
}
try (SqlSession session = factory.openSession()) {
    <span class="hljs-comment">// 获取Mapper代理对象</span>
    UserMapper mapper = session<span class="hljs-selector-class">.getMapper</span>(UserMapper.class);

    <span class="hljs-comment">// 调用Mapper方法</span>
    User user = mapper<span class="hljs-selector-class">.selectById</span>(<span class="hljs-number">1</span>);
    System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(user);

    session<span class="hljs-selector-class">.commit</span>();
}
</code></pre>
<h2 data-id="heading-5">三、SqlSession的实现类</h2>
<p>MyBatis提供了两个主要的SqlSession实现类。</p>
<h2 data-id="heading-6">3.1 DefaultSqlSession</h2>
<p>DefaultSqlSession是SqlSession的默认实现类，最常用的实现。</p>
<p>核心代码片段：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultSqlSession</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SqlSession</span> {

    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">Configuration</span> configuration;
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">Executor</span> executor;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">selectOne</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> statement, <span class="hljs-built_in">Object</span> parameter</span>) {
        <span class="hljs-title class_">List</span>&lt;T&gt; list = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">selectList</span>(statement, parameter);
        <span class="hljs-keyword">if</span> (list.<span class="hljs-title function_">size</span>() == <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">return</span> list.<span class="hljs-title function_">get</span>(<span class="hljs-number">0</span>);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (list.<span class="hljs-title function_">size</span>() &gt; <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TooManyResultsException</span>(
                <span class="hljs-string">"Expected one result but found: "</span> + list.<span class="hljs-title function_">size</span>());
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">commit</span>(<span class="hljs-params"><span class="hljs-built_in">boolean</span> force</span>) {
        <span class="hljs-keyword">try</span> {
            executor.<span class="hljs-title function_">commit</span>(<span class="hljs-title function_">isCommitOrRollbackRequired</span>(force));
            dirty = <span class="hljs-literal">false</span>;
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-title class_">ExceptionFactory</span>.<span class="hljs-title function_">wrapException</span>(
                <span class="hljs-string">"Error committing transaction."</span>, e);
        }
    }
}
</code></pre>
<h2 data-id="heading-7">3.2 SqlSessionManager</h2>
<p>SqlSessionManager同时实现了SqlSession和SqlSessionFactory接口，既可以作为SqlSession使用，也可以作为工厂使用。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SqlSessionManager</span> 
    <span class="hljs-title">implements</span> <span class="hljs-title">SqlSessionFactory</span>, <span class="hljs-title">SqlSession</span> {

    <span class="hljs-keyword">private</span> final SqlSessionFactory sqlSessionFactory;
    <span class="hljs-keyword">private</span> final SqlSession sqlSessionProxy;
    <span class="hljs-keyword">private</span> ThreadLocal&lt;SqlSession&gt; localSqlSession 
        = <span class="hljs-keyword">new</span> ThreadLocal&lt;&gt;();

    <span class="hljs-comment">// 开启本地Session</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">startManagedSession</span>()</span> {
        <span class="hljs-keyword">this</span>.localSqlSession.<span class="hljs-keyword">set</span>(openSession());
    }

    <span class="hljs-comment">// 关闭本地Session</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">closeManagedSession</span>()</span> {
        SqlSession sqlSession = localSqlSession.<span class="hljs-keyword">get</span>();
        <span class="hljs-keyword">if</span> (sqlSession != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">try</span> {
                sqlSession.close();
            } <span class="hljs-keyword">finally</span> {
                localSqlSession.<span class="hljs-keyword">remove</span>();
            }
        }
    }
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a34283f2afa842d6a55efec67dac3c31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768093336&amp;x-signature=%2BcHKb4WuXUn2EMHB69EthQbuf2Y%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">四、SqlSessionFactory工厂</h2>
<p>SqlSessionFactory是创建SqlSession的工厂接口。</p>
<h2 data-id="heading-9">4.1 SqlSessionFactory接口方法</h2>
<pre><code class="hljs language-scss" lang="scss">public interface SqlSessionFactory {

    <span class="hljs-comment">// 常用方法：打开Session</span>
    SqlSession <span class="hljs-built_in">openSession</span>();

    <span class="hljs-comment">// 指定ExecutorType</span>
    SqlSession <span class="hljs-built_in">openSession</span>(ExecutorType execType);

    <span class="hljs-comment">// 指定是否自动提交</span>
    SqlSession <span class="hljs-built_in">openSession</span>(boolean autoCommit);

    <span class="hljs-comment">// 指定事务隔离级别</span>
    SqlSession <span class="hljs-built_in">openSession</span>(TransactionIsolationLevel level);

    <span class="hljs-comment">// 使用指定连接</span>
    SqlSession <span class="hljs-built_in">openSession</span>(Connection connection);
}
</code></pre>
<h2 data-id="heading-10">4.2 DefaultSqlSessionFactory核心流程</h2>
<p>创建SqlSession的完整流程：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> SqlSession <span class="hljs-title function_">openSessionFromDataSource</span><span class="hljs-params">(
    ExecutorType execType,
    TransactionIsolationLevel level,
    <span class="hljs-type">boolean</span> autoCommit)</span> {

    <span class="hljs-type">Transaction</span> <span class="hljs-variable">tx</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">//获取环境配置</span>
        <span class="hljs-type">Environment</span> <span class="hljs-variable">environment</span> <span class="hljs-operator">=</span> configuration.getEnvironment();

        <span class="hljs-comment">//创建事务工厂</span>
        <span class="hljs-type">TransactionFactory</span> <span class="hljs-variable">transactionFactory</span> <span class="hljs-operator">=</span> 
            getTransactionFactoryFromEnvironment(environment);

        <span class="hljs-comment">//创建事务</span>
        tx = transactionFactory.newTransaction(
            environment.getDataSource(), level, autoCommit);

        <span class="hljs-comment">//创建执行器</span>
        <span class="hljs-type">Executor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> configuration.newExecutor(tx, execType);

        <span class="hljs-comment">//创建DefaultSqlSession</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultSqlSession</span>(configuration, executor, autoCommit);
    } <span class="hljs-keyword">catch</span> (Exception e) {
        closeTransaction(tx);
        <span class="hljs-keyword">throw</span> ExceptionFactory.wrapException(
            <span class="hljs-string">"Error opening session."</span>, e);
    }
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b093cdd644e7426c83e82fcd94eb1d88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768093336&amp;x-signature=7mdc3OuJ3zLozfnpCmErBegekV4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11">五、SqlSession生命周期管理</h2>
<p>SqlSession的生命周期管理非常重要，不当使用会导致资源泄漏。</p>
<h2 data-id="heading-12">5.1 SqlSession的三个阶段</h2>
<pre><code class="hljs language-ini" lang="ini">// 方式1：默认创建
SqlSession <span class="hljs-attr">session</span> = sqlSessionFactory.openSession()<span class="hljs-comment">;</span>

// 方式2：自动提交
SqlSession <span class="hljs-attr">session</span> = sqlSessionFactory.openSession(<span class="hljs-literal">true</span>)<span class="hljs-comment">;</span>

// 方式3：指定Executor类型
SqlSession <span class="hljs-attr">session</span> = sqlSessionFactory.openSession(
    ExecutorType.BATCH)<span class="hljs-comment">;</span>

// 方式4：事务隔离级别
SqlSession <span class="hljs-attr">session</span> = sqlSessionFactory.openSession(
    TransactionIsolationLevel.READ_COMMITTED)<span class="hljs-comment">;</span>
try (SqlSession <span class="hljs-attr">session</span> = factory.openSession()) {
    // 执行查询
    User <span class="hljs-attr">user</span> = session.selectOne(
        "com.example.mapper.UserMapper.selectById", 1)<span class="hljs-comment">;</span>

    // 执行更新
    User <span class="hljs-attr">updateUser</span> = new User()<span class="hljs-comment">;</span>
    updateUser.setId(1)<span class="hljs-comment">;</span>
    updateUser.setName("张三")<span class="hljs-comment">;</span>
    session.update(
        "com.example.mapper.UserMapper.update", updateUser)<span class="hljs-comment">;</span>

    // 提交事务
    session.commit()<span class="hljs-comment">;</span>
}
// 推荐方式：try-with-resources
try (SqlSession <span class="hljs-attr">session</span> = factory.openSession()) {
    // 使用session
} // 自动关闭

// 传统方式
SqlSession <span class="hljs-attr">session</span> = null<span class="hljs-comment">;</span>
try {
    <span class="hljs-attr">session</span> = factory.openSession()<span class="hljs-comment">;</span>
    // 使用session
} finally {
    if (session != null) {
        session.close()<span class="hljs-comment">;</span>
    }
}
</code></pre>
<blockquote>
<p>重要原则：SqlSession的作用域应该是方法级别的！</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误：SqlSession作为成员变量</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">private</span> SqlSession session; <span class="hljs-comment">// ❌ 不要这样做！</span>

    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> {
        <span class="hljs-keyword">return</span> session.selectOne(
            <span class="hljs-string">"com.example.mapper.UserMapper.selectById"</span>, id);
    }
}
<span class="hljs-comment">// 正确：SqlSession在方法中创建和关闭</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">private</span> SqlSessionFactory factory;

    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">SqlSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> factory.openSession()) {
            <span class="hljs-keyword">return</span> session.selectOne(
                <span class="hljs-string">"com.example.mapper.UserMapper.selectById"</span>, id);
        }
    }
}
</code></pre>
<h2 data-id="heading-13">5.3 线程安全问题</h2>
<blockquote>
<p>SqlSession不是线程安全的，每个线程都应该有自己的SqlSession实例！</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-comment">// ❌ 多个线程共享同一个SqlSession</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">SqlSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> factory.openSession();
}
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">private</span> SqlSessionFactory factory;

    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> {
        <span class="hljs-comment">// ✅ 每次调用都创建新的SqlSession</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">SqlSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> factory.openSession()) {
            <span class="hljs-keyword">return</span> session.selectOne(<span class="hljs-string">"..."</span>, id);
        }
    }
}
</code></pre>
<h2 data-id="heading-14">5.4 ThreadLocal管理模式</h2>
<p>在某些场景下，可以使用ThreadLocal管理SqlSession：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SqlSessionManager</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final ThreadLocal&lt;SqlSession&gt; LOCAL_SESSION 
        = <span class="hljs-keyword">new</span> ThreadLocal&lt;&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SqlSessionFactory factory;

    <span class="hljs-comment">// 获取当前线程的SqlSession</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SqlSession <span class="hljs-title">getSession</span>()</span> {
        SqlSession session = LOCAL_SESSION.<span class="hljs-keyword">get</span>();
        <span class="hljs-keyword">if</span> (session == <span class="hljs-literal">null</span>) {
            session = factory.openSession();
            LOCAL_SESSION.<span class="hljs-keyword">set</span>(session);
        }
        <span class="hljs-keyword">return</span> session;
    }

    <span class="hljs-comment">// 关闭当前线程的SqlSession</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">closeSession</span>()</span> {
        SqlSession session = LOCAL_SESSION.<span class="hljs-keyword">get</span>();
        <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
            session.close();
            LOCAL_SESSION.<span class="hljs-keyword">remove</span>();
        }
    }
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52459c703a78445e9d0c501ccf0860e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768093336&amp;x-signature=v1Dd2yltusTF%2BG4eYJUuu6zNZAk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-15">六、事务控制机制</h2>
<p>SqlSession提供了完善的事务控制机制。</p>
<h2 data-id="heading-16">6.1 自动提交 vs 手动提交</h2>
<pre><code class="hljs language-ini" lang="ini">// 不自动提交（默认）
SqlSession <span class="hljs-attr">session</span> = factory.openSession()<span class="hljs-comment">;</span>
session.insert("...")<span class="hljs-comment">;</span>
session.commit()<span class="hljs-comment">; // 需要手动提交</span>

//自动提交
SqlSession <span class="hljs-attr">session</span> = factory.openSession(<span class="hljs-literal">true</span>)<span class="hljs-comment">;</span>
session.insert("...")<span class="hljs-comment">; // 自动提交</span>
</code></pre>
<h2 data-id="heading-17">6.2 手动事务控制实战</h2>
<pre><code class="hljs language-scss" lang="scss">try (SqlSession session = factory.openSession()) {
    try {
        <span class="hljs-comment">// 1.插入用户</span>
        User user = new <span class="hljs-built_in">User</span>();
        user<span class="hljs-selector-class">.setName</span>("张三");
        user<span class="hljs-selector-class">.setEmail</span>("zhangsan@example.com");
        session<span class="hljs-selector-class">.insert</span>(
            "com.example.mapper.UserMapper.insert", user);

        <span class="hljs-comment">//2.插入订单</span>
        <span class="hljs-attribute">Order</span> <span class="hljs-attribute">order</span> = new <span class="hljs-attribute">Order</span>();
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setUserId</span>(user.getId());
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setAmount</span>(<span class="hljs-number">100.0</span>);
        session<span class="hljs-selector-class">.insert</span>(
            "com.example.mapper.OrderMapper.insert", order);

        <span class="hljs-comment">//3.提交事务</span>
        session<span class="hljs-selector-class">.commit</span>();
    } catch (Exception e) {
        <span class="hljs-comment">//4.回滚事务</span>
        session<span class="hljs-selector-class">.rollback</span>();
        throw e;
    }
}
</code></pre>
<h2 data-id="heading-18">6.3 事务隔离级别</h2>
<p>MyBatis支持设置事务隔离级别：</p>
<pre><code class="hljs language-ini" lang="ini">SqlSession <span class="hljs-attr">session</span> = factory.openSession(
    TransactionIsolationLevel.READ_COMMITTED)<span class="hljs-comment">;</span>
</code></pre>
<p>支持的隔离级别：</p>



































<table><thead><tr><th>隔离级别</th><th>说明</th><th>适用场景</th></tr></thead><tbody><tr><td>NONE</td><td>无事务隔离</td><td>不推荐</td></tr><tr><td>READ_UNCOMMITTED</td><td>读未提交</td><td>极少使用</td></tr><tr><td>READ_COMMITTED</td><td>读已提交</td><td>大多数数据库默认</td></tr><tr><td>REPEATABLE_READ</td><td>可重复读</td><td>MySQL默认</td></tr><tr><td>SERIALIZABLE</td><td>串行化</td><td>最高隔离级别</td></tr></tbody></table>
<h2 data-id="heading-19">6.4 批量操作的事务控制</h2>
<pre><code class="hljs language-ini" lang="ini">try (SqlSession <span class="hljs-attr">session</span> = factory.openSession(
    ExecutorType.BATCH, false)) {
    try {
        UserMapper <span class="hljs-attr">mapper</span> = session.getMapper(UserMapper.class)<span class="hljs-comment">;</span>

        // 批量插入
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 1000; i++) {</span>
            User <span class="hljs-attr">user</span> = new User()<span class="hljs-comment">;</span>
            user.setName("User" + i)<span class="hljs-comment">;</span>
            user.setEmail("user" + i + "@example.com")<span class="hljs-comment">;</span>
            mapper.insert(user)<span class="hljs-comment">;</span>
        }

        // 统一提交
        session.commit()<span class="hljs-comment">;</span>
    } catch (Exception e) {
        session.rollback()<span class="hljs-comment">;</span>
        throw e<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83142af20c054c7c9992c49494a5442a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768093336&amp;x-signature=GzEuvaRRjuwr2tCIP77r3%2Bn4OGE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-20">七、SqlSession与Mapper集成</h2>
<p>SqlSession与Mapper接口的集成是MyBatis最常用的方式。</p>
<h2 data-id="heading-21">7.1 定义Mapper接口</h2>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">interface</span> <span class="hljs-selector-tag">UserMapper</span> {
    <span class="hljs-selector-tag">User</span> <span class="hljs-selector-tag">selectById</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">"id"</span>) Integer id);
    <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">User</span>&gt; <span class="hljs-selector-tag">selectAll</span>();
    <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">insert</span>(User user);
    <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">update</span>(User user);
    <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">deleteById</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">"id"</span>) Integer id);
}
</code></pre>
<h2 data-id="heading-22">7.2 Mapper XML映射文件</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span> ?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span>
    <span class="hljs-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"com.example.mapper.UserMapper"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"BaseResultMap"</span> 
               <span class="hljs-attr">type</span>=<span class="hljs-string">"com.example.entity.User"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"INTEGER"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"name"</span> 
                <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"VARCHAR"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"email"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"email"</span> 
                <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"VARCHAR"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectById"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"BaseResultMap"</span>&gt;</span>
        SELECT id, name, email, age
        FROM t_user
        WHERE id = #{id}
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"insert"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.example.entity.User"</span> 
            <span class="hljs-attr">useGeneratedKeys</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">keyProperty</span>=<span class="hljs-string">"id"</span>&gt;</span>
        INSERT INTO t_user (name, email, age)
        VALUES (#{name}, #{email}, #{age})
    <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span>
</code></pre>
<h2 data-id="heading-23">7.3 通过SqlSession获取Mapper</h2>
<pre><code class="hljs language-ini" lang="ini">try (SqlSession <span class="hljs-attr">session</span> = factory.openSession()) {
    // 获取Mapper代理对象
    UserMapper <span class="hljs-attr">mapper</span> = session.getMapper(UserMapper.class)<span class="hljs-comment">;</span>

    //调用Mapper方法
    User <span class="hljs-attr">user</span> = mapper.selectById(<span class="hljs-number">1</span>)<span class="hljs-comment">;</span>

    //插入数据
    User <span class="hljs-attr">newUser</span> = new User()<span class="hljs-comment">;</span>
    newUser.setName("李四")<span class="hljs-comment">;</span>
    newUser.setEmail("lisi@example.com")<span class="hljs-comment">;</span>
    mapper.insert(newUser)<span class="hljs-comment">;</span>

    //提交事务
    session.commit()<span class="hljs-comment">;</span>
}
</code></pre>
<h2 data-id="heading-24">7.4 MapperProxy工作原理</h2>
<p>MyBatis通过JDK动态代理为Mapper接口生成代理对象：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperProxy</span>&lt;<span class="hljs-type">T</span>&gt; <span class="hljs-title">implements</span> <span class="hljs-title">InvocationHandler</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SqlSession sqlSession;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;T&gt; mapperInterface;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object invoke(Object proxy, Method method, 
                        Object[] args) throws Throwable {
        <span class="hljs-comment">// 如果是Object类的方法，直接执行</span>
        <span class="hljs-keyword">if</span> (Object.<span class="hljs-keyword">class</span>.equals(method.getDeclaringClass())) {
            <span class="hljs-keyword">return</span> method.invoke(<span class="hljs-keyword">this</span>, args);
        }

        <span class="hljs-comment">// 获取Mapper方法</span>
        <span class="hljs-keyword">final</span> MapperMethod mapperMethod = 
            cachedMapperMethod(method);

        <span class="hljs-comment">// 执行Mapper方法</span>
        <span class="hljs-keyword">return</span> mapperMethod.execute(sqlSession, args);
    }
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c60ad67099e4dbf93410da0d9e2aa2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768093336&amp;x-signature=Ns4x0Ve3d9wBJm6zjN2cOtlzp84%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-25">八、Executor执行器详解</h2>
<p>Executor是SqlSession的核心组件，负责实际执行SQL语句。</p>
<h2 data-id="heading-26">8.1 三种Executor类型</h2>
<pre><code class="hljs language-ini" lang="ini">// 默认的Executor，每次执行都会创建新的Statement
SqlSession <span class="hljs-attr">session</span> = factory.openSession(ExecutorType.SIMPLE)<span class="hljs-comment">;</span>
</code></pre>
<p>特点：简单直接，每次创建新Statement</p>
<p>适用场景：一般查询、单条操作</p>
<pre><code class="hljs language-ini" lang="ini">// 重用Statement，减少创建开销
SqlSession <span class="hljs-attr">session</span> = factory.openSession(ExecutorType.REUSE)<span class="hljs-comment">;</span>
</code></pre>
<p>特点：重用Statement，减少创建开销</p>
<p>适用场景：执行相同SQL多次</p>
<pre><code class="hljs language-ini" lang="ini">// 批量执行SQL，性能最高
SqlSession <span class="hljs-attr">session</span> = factory.openSession(ExecutorType.BATCH)<span class="hljs-comment">;</span>
</code></pre>
<p>特点：批量执行，性能最优</p>
<p>适用场景：批量插入、更新</p>
<h2 data-id="heading-27">8.2 Executor对比表</h2>





























<table><thead><tr><th>Executor类型</th><th>性能</th><th>Statement复用</th><th>适用场景</th></tr></thead><tbody><tr><td>SIMPLE</td><td>⭐⭐⭐</td><td>❌</td><td>一般查询</td></tr><tr><td>REUSE</td><td>⭐⭐⭐⭐</td><td>✅</td><td>相同SQL多次执行</td></tr><tr><td>BATCH</td><td>⭐⭐⭐⭐⭐</td><td>✅</td><td>批量操作</td></tr></tbody></table>
<h2 data-id="heading-28">8.3 实战示例</h2>
<pre><code class="hljs language-ini" lang="ini">//BATCH执行器批量插入示例
try (SqlSession <span class="hljs-attr">session</span> = factory.openSession(
    ExecutorType.BATCH)) {

    UserMapper <span class="hljs-attr">mapper</span> = session.getMapper(UserMapper.class)<span class="hljs-comment">;</span>

    for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 1000; i++) {</span>
        User <span class="hljs-attr">user</span> = new User()<span class="hljs-comment">;</span>
        user.setName("User" + i)<span class="hljs-comment">;</span>
        mapper.insert(user)<span class="hljs-comment">;</span>
    }

    // 批量提交
    session.commit()<span class="hljs-comment">;</span>
}
</code></pre>
<h2 data-id="heading-29">九、最佳实践</h2>
<h2 data-id="heading-30">9.1 SqlSession使用黄金法则</h2>
<pre><code class="hljs language-csharp" lang="csharp">✅ 及时关闭 — 使用<span class="hljs-keyword">try</span>-<span class="hljs-keyword">with</span>-resources确保资源释放
✅ 方法作用域 — SqlSession应该在方法级别创建和关闭
✅ 线程独立 — 每个线程使用独立的SqlSession
✅ 事务控制 — 明确提交或回滚事务
✅ 异常处理 — 捕获异常并回滚事务
</code></pre>
<h2 data-id="heading-31">9.2 Spring集成最佳实践</h2>
<p>在Spring中使用MyBatis时，SqlSession由容器管理：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">UserMapper</span> userMapper;

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">User user</span>) {
        <span class="hljs-comment">// SqlSession由Spring管理，无需手动关闭</span>
        userMapper.<span class="hljs-title function_">insert</span>(user);
    }
}
</code></pre>
<h2 data-id="heading-32">9.3 常见问题排查</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误示例</span>
<span class="hljs-type">SqlSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> factory.openSession();
<span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> session.selectOne(<span class="hljs-string">"..."</span>);
<span class="hljs-comment">//忘记关闭 → 资源泄漏</span>

<span class="hljs-comment">//正确示例</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">SqlSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> factory.openSession()) {
    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> session.selectOne(<span class="hljs-string">"..."</span>);
} <span class="hljs-comment">// 自动关闭</span>
<span class="hljs-comment">// 错误示例</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">SqlSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> factory.openSession()) {
    session.insert(<span class="hljs-string">"..."</span>);
    <span class="hljs-comment">// 忘记提交 → 数据未保存</span>
}

<span class="hljs-comment">//正确示例</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">SqlSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> factory.openSession()) {
    session.insert(<span class="hljs-string">"..."</span>);
    session.commit(); <span class="hljs-comment">// 记得提交</span>
}
<span class="hljs-comment">//错误示例</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">SqlSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> factory.openSession();

<span class="hljs-comment">//正确示例</span>
<span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Integer id)</span> {
    <span class="hljs-keyword">try</span> (<span class="hljs-type">SqlSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> factory.openSession()) {
        <span class="hljs-keyword">return</span> session.selectOne(<span class="hljs-string">"..."</span>, id);
    }
}
</code></pre>
<h2 data-id="heading-33">十、总结</h2>
<p>通过本文的学习，我们深入了解了MyBatis会话模块的核心内容：</p>
<pre><code class="hljs">SqlSession接口 — 定义了所有数据库操作方法
SqlSessionFactory — 负责创建和管理SqlSession实例
生命周期管理 — 方法级别创建，线程独立使用
事务控制 — 支持手动提交和自动提交两种模式
Mapper集成 — 通过动态代理实现类型安全操作
Executor类型 — SIMPLE、REUSE、BATCH各有千秋
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android Studio 的 AI Agent 有什么特别？未来会有惊艳什么功能？]]></title>    <link>https://juejin.cn/post/7590421489998610451</link>    <guid>https://juejin.cn/post/7590421489998610451</guid>    <pubDate>2026-01-03T23:04:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590421489998610451" data-draft-id="7590283328176717867" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android Studio 的 AI Agent 有什么特别？未来会有惊艳什么功能？"/> <meta itemprop="keywords" content="前端,Flutter,Android"/> <meta itemprop="datePublished" content="2026-01-03T23:04:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="恋猫de小郭"/> <meta itemprop="url" content="https://juejin.cn/user/817692379985752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android Studio 的 AI Agent 有什么特别？未来会有惊艳什么功能？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/817692379985752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    恋猫de小郭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T23:04:56.000Z" title="Sat Jan 03 2026 23:04:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>相信大家都在之前的 <a href="https://juejin.cn/post/7579999793320247302" target="_blank" title="https://juejin.cn/post/7579999793320247302">《Android Studio Otter 2 Feature 发布》</a>已经了解过，为什么这是一个比较值得更新的 Android Studio 版本，与此同时，谷歌也和我们展示了未来（Canary）全新的 AI Agent 有什么特别之处。</p>
<p>对于一个 AI Agent 来说，最重要的有三个基础概念：<strong>工具 (Tools)</strong> 、<strong>上下文 (Context)</strong> 和 <strong>MCP (模型上下文协议)</strong> ，而大多数人对于它们的理解，可能还比较片面。</p>
<p>比如工具 ，<strong>实际上 AI Agent 不只是一个聊天场景，更多是 Agent 通过“工具”来执行任务</strong>，而不是单纯用来做文本回复，最重要的是，Agent 不会将整个代码库发送给模型，毕竟这太浪费 token ，而且还慢，事实上它只是根据用户的 Prompt（提示词），自行决定调用哪些工具 。</p>
<p>比如一般内置的有包括 <code>Find Files</code>（查找文件）、<code>read_file</code>（读取文件）、<code>version_lookup</code>（版本查询）、<code>gradle_sync</code> 等等，例如：</p>
<blockquote>
<p>开发者询问：“主题在哪里定义？”，Agent 会推断并使用 <code>Find Files</code> 搜索 <code>theme.kt</code>，而不是扫描所有文件 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7fa4f17027044aaa74e62c8329ffc89~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=%2B4EzlVkaQLXDLUYp5oIe14hWmLo%3D" alt="" loading="lazy"/></p>
</blockquote>
<p>你也可以通过收入 <code>/tools</code> 让 AI 展示现在存在的工具：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72be84b624904230abc0c2581ee11b17~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=K067KI%2F5XP2IopB4fzZ7lT8XTvc%3D" alt="" loading="lazy"/></p>
<p>另外的工具就是 <strong>Android 知识库 (Knowledge Base)</strong> ：为了解决大模型数据滞后的问题，例如不知道最新的 Navigation 3 API 等场景，Android Studio 集成了 <code>search_android_docs</code> 工具，它允许 Agent 搜索 Android 文档、Firebase 和 Kotlin 的最新资料等。</p>
<blockquote>
<p>所以官方建议，<strong>需要是可以在 Prompt 中加上“check the docs”（检查文档），增加触发工具执行的概率</strong> 。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02b7167e21974b0a887c68d13b62e57f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=bbMGdHsFsv2jSjVEs3POkZ0E%2FbY%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>有了知识库之后，以后就算不更新 Android Studio ，AI 也可以通过最新知识库获取到最新的 API 和文档。</p>
</blockquote>
<p>而对于 (MCP - Model Context Protocol)，作为模型上下文协议 ，<strong>它属于扩展能力，可以让开发者连接外部服务</strong>，比如和 Figma 集成，连接本地运行的 Figma MCP 服务器，开发者可以直接在 IDE 中要求 Agent “截取我在 Figma 中选中的内容并转换当前屏幕”，从而打通设计与开发的流程 ：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5388b889e11458a953cb94d7b63a22c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=IlNrDb%2B2xBy0RuVI3J88SHn5RZE%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92c6b04a05a34c2795cc06726910652d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=IUPH%2B4I9h0iBFp0LS1hMTuzl2hE%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2867b1c458114fb5bd581ffb98c570d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=AWJllQiZxBlnZ1Xxc9WC5Ah9k7s%3D" alt="" loading="lazy"/></p>
<p>而 Context 则是用于智能感知， Agent 能够自动获取项目名称、当前打开的文件等信息作为上下文 ，而一般开发过程中，推荐用户添加自己的规则或者偏好，避免 AI 过渡自我发挥，例如：</p>
<ul>
<li><strong>agents.md</strong> ：团队共享的标准文件，可以在其中定义项目架构（如 Hilt）、代码风格或业务描述，Agent 会在执行任务时读取文件保持一致性</li>
<li><strong>层级结构</strong>：Agent 会从当前目录向上递归查找所有 <code>agents.md</code> 文件，允许在不同模块（如 data 模块）定义不同层级的上下文</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c12fba35da1f43c2b381385f47dfa138~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=Zud%2FHlzJ4vm7kYRNYfLq8V40ftU%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7863a512bbd5442aa6f5dca3052bb971~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=JJxT9mj9m5VKJ%2Bvij2NZVZAKzH8%3D" alt="" loading="lazy"/></p>
<p>而官方也演示了覆盖从“从零创建”到“微调完善”的 UI 开发全流程，注意这里用的也是 Canary 版本：</p>
<ul>
<li>
<p>通过自然语言 Prompt 生成完整的应用原型，Agent 会先生成一个计划（包含库和工具），用户确认后，它会生成 ViewModels、Compose UI 代码甚至单元测试</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7bec3c97c9ff45aea4d07e8e80de740d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=TfSwsePIspgcqKQkMkmDBdXylr0%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b2fa7a6b0284352b3c91f934926819a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=vO5CSv1HtLEZv3fVq%2Fs7k%2FkjnvQ%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p>之后用户可以将 UI 截图拖入会话，Agent 会分析并生成对应的 Jetpack Compose 代码 ，这个过程它会尝试重用现有组件，如果缺少资源（如特定图标），它甚至会尝试生成新的 Vector Drawable <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc0f4ecaf59f45a2b0a06775387c1e82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=auiIgMHwlT5nDDiqIpVnD6kMj08%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0998d7f28d1489697781550150a873c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=BOOm1PZukGIhS%2BDI54oNnKFCXGA%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/196dcfe04ed94639bbd7de3a79c4632c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=5xZFgDB6qbx9sSvpT6T0ZTysqgQ%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p>接着就是代码分析与修复，利用 IDE 现有的 Lint 和静态分析能力，通过 AI 自动修复问题（如未使用的导入、弃用的 API），避免运行耗时的 Gradle 构建 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a30541bdd7347c4bc7cf3cd36e04870~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=mOtROz0DgIMTLqlaQx6y2iC1XL0%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p>然后是 UI 匹配，当现有组件需要根据新设计图进行迭代时使用，用户上传新设计图，Agent 会分析差异并自动调整现有代码从而匹配新设计 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/964242ecf91b47c78a1acc4c2fa54de2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=v43B1LrXxVV8YsAFZNCxLzJ6KC0%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p>然后是预览，Agent 会调用 <code>Render Compose Preview</code> 工具在聊天窗口中直接渲染预览，从而验证修改是否正确且可编译 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/759993ee3e2544949f41a21336bba6a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=TwNzdQ6y9%2FLgWVqfV0xxU2eNcoc%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p>接着就是通过自然语言指令修改 UI，比如输入“左对齐设置、增大字体、添加柔和的渐变背景”，Agent 会将这些指令转化为代码修改</p>
</li>
<li>
<p>最后结合 UI Check 模式（用于检测可访问性、屏幕适配等问题），当 UI Check 检测到“颜色对比度不足”时，用户可以点击“Fix with AI”，Agent 会自动寻找合适的颜色代码并修复该可访问性问题，最后重新运行检查以确保问题已解决 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7f3ce3224e345d8a99dc199a8ea5d1a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=qz3%2B0BXzHyPZimaB4y801j%2BoKmo%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c573450d5b0452e8198665e48529e4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=Xi%2F2IokxuZPhLZpB5gQPH62kcis%3D" alt="image-20251223112251073" loading="lazy"/></p>
</li>
</ul>
<p>可以看到，未来的 Android Studio Agent 会有更加丰富的多模态处理能力，比如更好的设计稿理解，图片理解，可以做到设计图和现有 UI 的差异识别并进行改动，甚至直接生成预览效果，同时还支持 UI 检测等，对于 Android 开发者来说，以后也许真的就是动动嘴皮子而已。</p>
<blockquote>
<p>对于 android 开发者来说， AI Agent 的 Android Studio 体验实际会比 antigravity 更好？</p>
</blockquote>
<h2 data-id="heading-0">参考链接</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DjTlW8JeCClA" target="_blank" title="https://www.youtube.com/watch?v=jTlW8JeCClA" ref="nofollow noopener noreferrer">www.youtube.com/watch?v=jTl…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解 Interlocked.CompareExchange：C#.NET 原子操作核心原理]]></title>    <link>https://juejin.cn/post/7590597231707783203</link>    <guid>https://juejin.cn/post/7590597231707783203</guid>    <pubDate>2026-01-03T22:59:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590597231707783203" data-draft-id="7590292192989495336" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解 Interlocked.CompareExchange：C#.NET 原子操作核心原理"/> <meta itemprop="keywords" content="C#,.NET"/> <meta itemprop="datePublished" content="2026-01-03T22:59:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="唐青枫"/> <meta itemprop="url" content="https://juejin.cn/user/3737995266234280"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解 Interlocked.CompareExchange：C#.NET 原子操作核心原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3737995266234280/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    唐青枫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T22:59:38.000Z" title="Sat Jan 03 2026 22:59:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">什么是 Interlocked.CompareExchange？</h3>
<p><code>Interlocked.CompareExchange</code> 是 <code>.NET</code> 中 <code>System.Threading.Interlocked</code> 类的最核心原子操作方法。它执行比较并交换（<code>Compare-And-Swap</code>，简称 <code>CAS</code>） 操作：在多线程环境下，安全地将变量的值与预期值比较，如果相等则替换为新值，整个过程原子不可中断。</p>
<p>关键特性</p>
<ul>
<li>
<p>原子性：整个操作在CPU级别是原子的，不会被线程调度打断</p>
</li>
<li>
<p>无锁操作：无需使用锁即可实现线程安全</p>
</li>
<li>
<p>内存屏障：隐含完整内存屏障（<code>full fence</code>），确保操作前后内存访问顺序</p>
</li>
</ul>
<p>返回值重要性：返回值是判断操作是否成功的关键</p>
<ul>
<li>核心签名（常见重载）：</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> <span class="hljs-title">CompareExchange</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> <span class="hljs-built_in">int</span> location, <span class="hljs-built_in">int</span> <span class="hljs-keyword">value</span>, <span class="hljs-built_in">int</span> comparand</span>)</span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">long</span> <span class="hljs-title">CompareExchange</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> <span class="hljs-built_in">long</span> location, <span class="hljs-built_in">long</span> <span class="hljs-keyword">value</span>, <span class="hljs-built_in">long</span> comparand</span>)</span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> T <span class="hljs-title">CompareExchange</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params"><span class="hljs-keyword">ref</span> T location, T <span class="hljs-keyword">value</span>, T comparand</span>) <span class="hljs-keyword">where</span> T : <span class="hljs-keyword">class</span></span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">float</span> <span class="hljs-title">CompareExchange</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> <span class="hljs-built_in">float</span> location, <span class="hljs-built_in">float</span> <span class="hljs-keyword">value</span>, <span class="hljs-built_in">float</span> comparand</span>)</span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">double</span> <span class="hljs-title">CompareExchange</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> <span class="hljs-built_in">double</span> location, <span class="hljs-built_in">double</span> <span class="hljs-keyword">value</span>, <span class="hljs-built_in">double</span> comparand</span>)</span>;
</code></pre>
<ul>
<li>
<p>参数解释：</p>
<ul>
<li>
<p><code>location</code>：要操作的共享变量（必须用 <code>ref</code> 传递）。</p>
</li>
<li>
<p><code>value</code>：如果比较成功，要写入的新值。</p>
</li>
<li>
<p><code>comparand</code>：预期旧值（用于比较）。</p>
</li>
<li>
<p>返回值：操作前 <code>location</code> 的实际值（无论成功与否都返回旧值）。</p>
</li>
</ul>
</li>
</ul>
<p><code>CAS</code> 是现代无锁（<code>lock-free</code>）并发编程的基础，许多高级结构（如 <code>ConcurrentDictionary</code>、<code>SpinLock</code>）内部都依赖它。</p>
<h3 data-id="heading-1">为什么使用 Interlocked.CompareExchange？</h3>
<p>在多线程中，直接读取-修改-写入（如 <code>if (count == 0) count = 1;</code>）会产生竞争条件：多个线程可能同时读取相同值，导致覆盖更新。</p>
<ul>
<li>
<p>传统锁的问题：<code>lock</code> 开销大（互斥锁、上下文切换），不适合高频轻量操作。</p>
</li>
<li>
<p><code>CAS</code> 的优势：</p>
<ul>
<li>
<p>无锁（<code>Lock-Free</code>）：不阻塞线程，高并发下性能极高。</p>
</li>
<li>
<p>乐观并发：假设冲突少，先尝试操作，失败则重试（自旋）。</p>
</li>
<li>
<p>原子性：硬件级保证（<code>x86 的 cmpxchg</code> 指令）。</p>
</li>
</ul>
</li>
<li>
<p>典型应用场景：</p>
<ul>
<li>
<p>实现线程安全的单例模式（双检查锁）。</p>
</li>
<li>
<p>自定义无锁队列/栈。</p>
</li>
<li>
<p>原子更新复杂状态（标志位 + 计数器）。</p>
</li>
<li>
<p>实现自定义同步原语（如 <code>SpinLock</code>、<code>SemaphoreSlim</code> 内部）。</p>
</li>
</ul>
</li>
</ul>
<p>传统的 “比较 + 赋值” 是两步非原子操作，多线程下会因竞态条件导致逻辑错误。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 非原子操作：多线程下可能同时通过if判断，导致赋值错误</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> _value = <span class="hljs-number">0</span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UnsafeUpdate</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> oldVal, <span class="hljs-built_in">int</span> newVal</span>)</span>
{
    <span class="hljs-keyword">if</span> (_value == oldVal) <span class="hljs-comment">// 步骤1：读取并比较</span>
    {
        _value = newVal;  <span class="hljs-comment">// 步骤2：赋值</span>
    }
}
</code></pre>
<p>两个线程可能同时通过if判断（都读到 <code>_value=oldVal</code> ），最终都执行赋值，导致逻辑错误。</p>
<p><code>Interlocked.CompareExchange</code> 将 “比较” 和 “赋值” 合并为不可中断的原子操作，从底层杜绝竞态条件，且无需阻塞线程（无锁）。</p>
<p>与 <code>lock</code> 的根本区别</p>



































<table><thead><tr><th>维度</th><th>lock</th><th>CompareExchange</th></tr></thead><tbody><tr><td>是否阻塞</td><td>是</td><td>否</td></tr><tr><td>是否上下文切换</td><td>是</td><td>否</td></tr><tr><td>粒度</td><td>任意代码块</td><td>单变量</td></tr><tr><td>性能</td><td>较低</td><td>极高</td></tr><tr><td>适合</td><td>复杂逻辑</td><td>状态切换</td></tr></tbody></table>
<h3 data-id="heading-2">什么时候该用 CompareExchange？</h3>





























<table><thead><tr><th>场景</th><th>推荐</th></tr></thead><tbody><tr><td>简单状态切换</td><td>✔</td></tr><tr><td>计数、标志位</td><td>✔</td></tr><tr><td>高并发热点</td><td>✔</td></tr><tr><td>复杂业务流程</td><td>❌</td></tr><tr><td>多变量一致性</td><td>❌</td></tr></tbody></table>
<h3 data-id="heading-3">如何使用 Interlocked.CompareExchange？</h3>
<h4 data-id="heading-4">最简单的 CAS 操作（判断是否交换成功）</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> _counter = <span class="hljs-number">0</span>;

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">TestCas</span>()</span>
{
    <span class="hljs-comment">// 目标：如果_counter是0，就改为100</span>
    <span class="hljs-built_in">int</span> expected = <span class="hljs-number">0</span>;    <span class="hljs-comment">// 预期值</span>
    <span class="hljs-built_in">int</span> newValue = <span class="hljs-number">100</span>;  <span class="hljs-comment">// 新值</span>
    
    <span class="hljs-comment">// 执行CAS操作</span>
    <span class="hljs-built_in">int</span> original = Interlocked.CompareExchange(<span class="hljs-keyword">ref</span> _counter, newValue, expected);
    
    <span class="hljs-comment">// 判断是否交换成功（原始值 == 预期值 → 成功）</span>
    <span class="hljs-keyword">if</span> (original == expected)
    {
        Console.WriteLine(<span class="hljs-string">$"交换成功！原始值：<span class="hljs-subst">{original}</span>，新值：<span class="hljs-subst">{_counter}</span>"</span>);
    }
    <span class="hljs-keyword">else</span>
    {
        Console.WriteLine(<span class="hljs-string">$"交换失败！原始值：<span class="hljs-subst">{original}</span>，当前值：<span class="hljs-subst">{_counter}</span>"</span>);
    }
}
</code></pre>
<p>输出：交换成功！原始值：0，新值：100（若再次执行，会输出失败，因为<code>_counter</code> 已不是 0）。</p>
<h4 data-id="heading-5">原子条件更新</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> _status = <span class="hljs-number">0</span>;  <span class="hljs-comment">// 0: 未初始化, 1: 初始化中, 2: 已完成</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Initialize</span>()</span>
{
    <span class="hljs-keyword">if</span> (Interlocked.CompareExchange(<span class="hljs-keyword">ref</span> _status, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>) == <span class="hljs-number">0</span>)
    {
        <span class="hljs-comment">// 只有第一个线程进入这里</span>
        <span class="hljs-keyword">try</span>
        {
            <span class="hljs-comment">// 执行初始化逻辑</span>
            DoInitialize();
        }
        <span class="hljs-keyword">finally</span>
        {
            <span class="hljs-comment">// 标记完成（原子操作，无需 CAS）</span>
            Interlocked.Exchange(<span class="hljs-keyword">ref</span> _status, <span class="hljs-number">2</span>);
        }
    }
    <span class="hljs-keyword">else</span>
    {
        <span class="hljs-comment">// 其他线程等待完成</span>
        <span class="hljs-keyword">while</span> (_status != <span class="hljs-number">2</span>) Thread.SpinWait(<span class="hljs-number">10</span>);
    }
}
</code></pre>
<ul>
<li>解释：只有当 <code>_status</code> 为 0 时才设置为 1 并执行初始化。</li>
</ul>
<h4 data-id="heading-6">实现自旋锁</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SpinLock</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> _lock = <span class="hljs-number">0</span>; <span class="hljs-comment">// 0=未锁定, 1=已锁定</span>
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Enter</span>()</span>
    {
        <span class="hljs-keyword">while</span> (Interlocked.CompareExchange(<span class="hljs-keyword">ref</span> _lock, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>) != <span class="hljs-number">0</span>)
        {
            <span class="hljs-comment">// 等待 - 可以使用Thread.SpinWait优化</span>
            Thread.SpinWait(<span class="hljs-number">100</span>);
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Exit</span>()</span>
    {
        Interlocked.Exchange(<span class="hljs-keyword">ref</span> _lock, <span class="hljs-number">0</span>);
    }
}
</code></pre>
<h4 data-id="heading-7">经典场景：无锁计数器（循环 CAS）</h4>
<p>单次 <code>CAS</code> 可能因其他线程修改变量失败，需循环重试（自旋 <code>CAS</code>），实现线程安全的计数器：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> _casCounter = <span class="hljs-number">0</span>;

<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> 无锁原子递增（替代Interlocked.Increment）</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> <span class="hljs-title">IncrementCounter</span>()</span>
{
    <span class="hljs-built_in">int</span> current;   <span class="hljs-comment">// 当前值</span>
    <span class="hljs-built_in">int</span> newValue;  <span class="hljs-comment">// 新值</span>
    <span class="hljs-keyword">do</span>
    {
        <span class="hljs-comment">// 1. 原子读取当前值（Interlocked保证可见性）</span>
        current = _casCounter;
        <span class="hljs-comment">// 2. 计算新值（仅本地计算，无竞态）</span>
        newValue = current + <span class="hljs-number">1</span>;
        <span class="hljs-comment">// 3. CAS操作：若当前值未被修改，就更新为新值</span>
        <span class="hljs-comment">// 返回值≠current → 被其他线程修改，重试</span>
    } <span class="hljs-keyword">while</span> (Interlocked.CompareExchange(<span class="hljs-keyword">ref</span> _casCounter, newValue, current) != current);
    
    <span class="hljs-keyword">return</span> newValue; <span class="hljs-comment">// 返回递增后的值</span>
}

<span class="hljs-comment">// 测试：1000个线程各调用1次，最终结果必为1000</span>
<span class="hljs-keyword">var</span> tasks = Enumerable.Range(<span class="hljs-number">0</span>, <span class="hljs-number">1000</span>)
    .Select(_ =&gt; Task.Run(IncrementCounter))
    .ToList();
Task.WaitAll(tasks.ToArray());
Console.WriteLine(<span class="hljs-string">$"最终计数器值：<span class="hljs-subst">{_casCounter}</span>"</span>); <span class="hljs-comment">// 输出：1000</span>
</code></pre>
<h3 data-id="heading-8">高级应用场景</h3>
<h4 data-id="heading-9">泛型版本：懒加载单例（双检查锁模式）</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Singleton</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Singleton _instance = <span class="hljs-literal">null</span>;

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">Singleton</span>()</span> { }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton Instance
    {
        <span class="hljs-keyword">get</span>
        {
            <span class="hljs-keyword">if</span> (_instance == <span class="hljs-literal">null</span>)
            {
                <span class="hljs-keyword">var</span> temp = <span class="hljs-keyword">new</span> Singleton();
                Interlocked.CompareExchange(<span class="hljs-keyword">ref</span> _instance, temp, <span class="hljs-literal">null</span>);
            }
            <span class="hljs-keyword">return</span> _instance;
        }
    }
}
</code></pre>
<p>在 <code>.NET</code> 中需加 <code>Lazy&lt;T&gt;</code> 更安全：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Lazy&lt;Singleton&gt; _instance = <span class="hljs-keyword">new</span> Lazy&lt;Singleton&gt;(() =&gt; <span class="hljs-keyword">new</span> Singleton());
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton Instance =&gt; _instance.Value;
</code></pre>
<h4 data-id="heading-10">无锁状态机（原子状态转换）</h4>
<p>控制对象状态的原子转换（如从 <code>Idle→Running</code> ，避免状态混乱）：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 定义状态枚举</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">enum</span> TaskState { Idle, Running, Completed, Failed }

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TaskStateMachine</span>
{
    <span class="hljs-keyword">private</span> TaskState _state = TaskState.Idle;

    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> 原子转换：Idle → Running（仅当状态为Idle时成功）</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">TryStart</span>()</span>
    {
        TaskState original = Interlocked.CompareExchange(
            <span class="hljs-keyword">ref</span> _state, 
            TaskState.Running,  <span class="hljs-comment">// 新值</span>
            TaskState.Idle      <span class="hljs-comment">// 预期值</span>
        );
        <span class="hljs-keyword">return</span> original == TaskState.Idle; <span class="hljs-comment">// 原始值=预期值 → 转换成功</span>
    }

    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> 原子转换：Running → Completed</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">TryComplete</span>()</span>
    {
        TaskState original = Interlocked.CompareExchange(
            <span class="hljs-keyword">ref</span> _state, 
            TaskState.Completed, 
            TaskState.Running
        );
        <span class="hljs-keyword">return</span> original == TaskState.Running;
    }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">var</span> stateMachine = <span class="hljs-keyword">new</span> TaskStateMachine();
Console.WriteLine(stateMachine.TryStart());    <span class="hljs-comment">// true（状态变为Running）</span>
Console.WriteLine(stateMachine.TryStart());    <span class="hljs-comment">// false（已不是Idle）</span>
Console.WriteLine(stateMachine.TryComplete()); <span class="hljs-comment">// true（状态变为Completed）</span>
</code></pre>
<h4 data-id="heading-11">自旋实现原子加法（模拟 Interlocked.Add）</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> _counter = <span class="hljs-number">0</span>;

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">Increment</span>()</span>
{
    <span class="hljs-built_in">int</span> oldValue, newValue;
    <span class="hljs-keyword">do</span>
    {
        oldValue = _counter;
        newValue = oldValue + <span class="hljs-number">1</span>;
    } <span class="hljs-keyword">while</span> (Interlocked.CompareExchange(<span class="hljs-keyword">ref</span> _counter, newValue, oldValue) != oldValue);
    <span class="hljs-keyword">return</span> newValue;
}
</code></pre>
<ul>
<li>解释：循环直到 <code>CAS</code> 成功（自旋），实现无锁递增</li>
</ul>
<h4 data-id="heading-12">对象引用替换（线程安全赋值）</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">private</span> List&lt;<span class="hljs-built_in">int</span>&gt; _cache = <span class="hljs-literal">null</span>;

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UpdateCache</span>(<span class="hljs-params">List&lt;<span class="hljs-built_in">int</span>&gt; newCache</span>)</span>
{
    Interlocked.CompareExchange(<span class="hljs-keyword">ref</span> _cache, newCache, _cache);  <span class="hljs-comment">// 仅当未被其他线程修改时更新</span>
}
</code></pre>
<h3 data-id="heading-13">Interlocked.CompareExchange 的内部实现</h3>
<ul>
<li>
<p>硬件支持：</p>
<ul>
<li>
<p><code>x86/x64</code>：<code>LOCK CMPXCHG</code> 指令，总线锁保证原子性。</p>
</li>
<li>
<p><code>ARM</code>：LDREX/STREX 指令对（<code>Load-Exclusive/Store-Exclusive</code>），失败重试。</p>
</li>
</ul>
</li>
</ul>
<p>同时，该操作会触发全内存屏障（<code>Full Memory Barrier</code>）：</p>
<ul>
<li>
<p>保证操作前后的内存读写不会被 <code>CPU</code> 重排序；</p>
</li>
<li>
<p>确保所有线程能立即看到变量的最新值（避免 <code>CPU</code> 缓存导致的 “脏读”）。</p>
</li>
<li>
<p><code>.NET</code> 实现（<code>CoreCLR</code> 简化伪码）：</p>
</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> <span class="hljs-title">CompareExchange</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> <span class="hljs-built_in">int</span> location, <span class="hljs-built_in">int</span> <span class="hljs-keyword">value</span>, <span class="hljs-built_in">int</span> comparand</span>)</span>
{
    <span class="hljs-comment">// 内联为平台特定原子指令</span>
    <span class="hljs-keyword">fixed</span> (<span class="hljs-built_in">int</span>* ptr = &amp;location)
    {
        <span class="hljs-keyword">return</span> InterlockedCompareExchange(ptr, <span class="hljs-keyword">value</span>, comparand);
    }
}
</code></pre>
<ul>
<li>
<p>性能：</p>
<ul>
<li>
<p>无竞争：<code>O(1)</code>，极快。</p>
</li>
<li>
<p>高竞争：自旋消耗 <code>CPU</code>，但仍远优于锁（无上下文切换）。</p>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-14">注意事项与最佳实践</h3>
<ul>
<li>
<p>自旋循环：总是用 <code>do-while</code> 包装 <code>CAS</code>，形成“乐观循环”。</p>
</li>
<li>
<p><code>ABA</code> 问题：</p>
<ul>
<li>
<p>线程 1 读取值为A，准备 <code>CAS</code> 为C；线程 2 将A改为B，又改回A；线程 1 的 <code>CAS</code> 会成功，但中间状态已变化，可能导致逻辑错误</p>
</li>
<li>
<p>解决方法：版本号 + 引用 <code>CAS</code>。</p>
</li>
</ul>
</li>
<li>
<p>内存可见性：<code>Interlocked</code> 操作自带全内存屏障（<code>full fence</code>），无需额外 <code>volatile</code>。</p>
</li>
<li>
<p>避免过度使用：简单计数用 <code>Interlocked.Increment</code>；集合用 <code>Concurrent</code> 类。</p>
</li>
<li>
<p>替代方案：</p>
<ul>
<li>
<p>高层：<code>ConcurrentDictionary、BlockingCollection</code>。</p>
</li>
<li>
<p>现代：<code>System.Threading.Channels</code>（生产者-消费者）。</p>
</li>
<li>
<p><code>.NET 8+</code>：考虑 <code>System.Threading.Lock</code>（<code>C# 12</code> 新特性，更简洁）。</p>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-15">ABA 问题</h3>
<h4 data-id="heading-16">什么是 ABA 问题？</h4>
<p><code>ABA</code> 问题 是无锁（<code>lock-free</code>）编程中使用 <code>Compare-And-Swap</code> (<code>CAS</code>) 操作时的一种经典隐患。</p>
<p>场景描述：</p>
<ul>
<li>
<p>线程 A 读取共享变量值：A</p>
</li>
<li>
<p>线程 B 先将值改为 B，然后又改回 A</p>
</li>
<li>
<p>线程 A 执行 <code>CAS</code>：期望值是 A，当前值也是 A → <code>CAS</code> 成功！</p>
</li>
<li>
<p>但实际上值已经被其他线程修改过，语义已经改变，线程 A 却误以为“一切未变”。</p>
</li>
</ul>
<p>这会导致逻辑错误，尤其在无锁栈、队列等数据结构中，可能造成节点丢失、循环引用或内存泄漏。</p>
<h4 data-id="heading-17">解决方案：版本号 + 引用 CAS</h4>
<ol>
<li>定义「版本化状态对象」</li>
</ol>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">VersionedValue</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> Value;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> Version;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">VersionedValue</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> <span class="hljs-keyword">value</span>, <span class="hljs-built_in">int</span> version</span>)</span>
    {
        Value = <span class="hljs-keyword">value</span>;
        Version = version;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ToString</span>()</span>
        =&gt; <span class="hljs-string">$"Value=<span class="hljs-subst">{Value}</span>, Version=<span class="hljs-subst">{Version}</span>"</span>;
}
</code></pre>
<p>关键点：</p>
<ul>
<li>
<p>不可变（<code>readonly</code>）</p>
</li>
<li>
<p>每次修改 → 新对象</p>
</li>
<li>
<p><code>CAS</code> 比较的是 对象引用</p>
</li>
</ul>
<ol start="2">
<li>运行示例</li>
</ol>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Threading;
<span class="hljs-keyword">using</span> System.Threading.Tasks;

<span class="hljs-keyword">class</span> <span class="hljs-title">Program</span>
{
    <span class="hljs-keyword">static</span> VersionedValue state = <span class="hljs-keyword">new</span> VersionedValue(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>);

    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>()</span>
    {
        <span class="hljs-keyword">var</span> t1 = Task.Run(Thread1);
        <span class="hljs-keyword">var</span> t2 = Task.Run(Thread2);

        Task.WaitAll(t1, t2);

        Console.WriteLine(<span class="hljs-string">$"Final state: <span class="hljs-subst">{state}</span>"</span>);
    }

    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Thread1</span>()</span>
    {
        <span class="hljs-keyword">var</span> old = state; <span class="hljs-comment">// 读 A(v0)</span>
        Console.WriteLine(<span class="hljs-string">$"T1 read: <span class="hljs-subst">{old}</span>"</span>);

        Thread.Sleep(<span class="hljs-number">200</span>);

        <span class="hljs-keyword">var</span> newState = <span class="hljs-keyword">new</span> VersionedValue(<span class="hljs-number">3</span>, old.Version + <span class="hljs-number">1</span>);

        <span class="hljs-keyword">var</span> result = Interlocked.CompareExchange(
            <span class="hljs-keyword">ref</span> state,
            newState,
            old
        );

        <span class="hljs-keyword">if</span> (result == old)
        {
            Console.WriteLine(<span class="hljs-string">"T1 CAS succeeded"</span>);
        }
        <span class="hljs-keyword">else</span>
        {
            Console.WriteLine(<span class="hljs-string">$"T1 CAS failed, current = <span class="hljs-subst">{result}</span>"</span>);
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Thread2</span>()</span>
    {
        Thread.Sleep(<span class="hljs-number">50</span>);

        <span class="hljs-comment">// A → B</span>
        state = <span class="hljs-keyword">new</span> VersionedValue(<span class="hljs-number">2</span>, state.Version + <span class="hljs-number">1</span>);
        <span class="hljs-comment">// B → A</span>
        state = <span class="hljs-keyword">new</span> VersionedValue(<span class="hljs-number">1</span>, state.Version + <span class="hljs-number">1</span>);

        Console.WriteLine(<span class="hljs-string">$"T2 changed state twice: <span class="hljs-subst">{state}</span>"</span>);
    }
}
</code></pre>
<ol start="3">
<li>典型输出</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">T1 read: <span class="hljs-attr">Value</span>=<span class="hljs-number">1</span>, Version=<span class="hljs-number">0</span>
T2 changed state twice: <span class="hljs-attr">Value</span>=<span class="hljs-number">1</span>, Version=<span class="hljs-number">2</span>
T1 CAS failed, <span class="hljs-attr">current</span> = Value=<span class="hljs-number">1</span>, Version=<span class="hljs-number">2</span>
Final state: <span class="hljs-attr">Value</span>=<span class="hljs-number">1</span>, Version=<span class="hljs-number">2</span>
</code></pre>
<p>核心结果：</p>
<ul>
<li>
<p>值还是 1</p>
</li>
<li>
<p>版本已经变了</p>
</li>
<li>
<p><code>CAS</code> 失败</p>
</li>
<li>
<p><code>ABA</code> 被成功识别</p>
</li>
</ul>
<h4 data-id="heading-18">为什么这个方案一定能防 ABA？</h4>
<blockquote>
<p>CAS 比较的是“对象引用”，而不是值</p>
</blockquote>
<p>即使：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">Value: 1 → 2 → 1</span>
</code></pre>
<p>但：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">Reference: A → B → C</span>
</code></pre>
<p>A ≠ C</p>
<p><code>CAS</code> 不可能误判成功</p>
<h4 data-id="heading-19">黄金组合</h4>

























<table><thead><tr><th>技术</th><th>作用</th></tr></thead><tbody><tr><td>Interlocked.CompareExchange</td><td>原子性</td></tr><tr><td>不可变对象</td><td>消除中间态</td></tr><tr><td>版本号</td><td>明确变化历史</td></tr><tr><td>GC</td><td>避免悬垂指针</td></tr></tbody></table>
<blockquote>
<p>.NET 官方并发集合、Immutable 系列，都是这个思想</p>
</blockquote>
<h4 data-id="heading-20">什么时候该用这一套？</h4>
<p>适合：</p>
<ul>
<li>
<p>自定义状态机</p>
</li>
<li>
<p><code>CAS</code> + 状态切换</p>
</li>
<li>
<p>无锁缓存</p>
</li>
<li>
<p>高频并发更新</p>
</li>
</ul>
<p>不适合：</p>
<ul>
<li>
<p>普通计数</p>
</li>
<li>
<p>简单标志位</p>
</li>
<li>
<p>低并发业务</p>
</li>
</ul>
<h3 data-id="heading-21">总结</h3>
<blockquote>
<p>Interlocked.CompareExchange 是 .NET 无锁并发的“原子开关”
用它可以：</p>
<ul>
<li>不加锁</li>
<li>不阻塞</li>
<li>在竞争中安全修改状态</li>
</ul>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025年终总结，智启]]></title>    <link>https://juejin.cn/post/7590421489998479379</link>    <guid>https://juejin.cn/post/7590421489998479379</guid>    <pubDate>2026-01-03T15:30:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590421489998479379" data-draft-id="7590309337861521449" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025年终总结，智启"/> <meta itemprop="keywords" content="AIGC,人工智能"/> <meta itemprop="datePublished" content="2026-01-03T15:30:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="袁庭新"/> <meta itemprop="url" content="https://juejin.cn/user/1207714136735408"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025年终总结，智启
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1207714136735408/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    袁庭新
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T15:30:13.000Z" title="Sat Jan 03 2026 15:30:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是袁庭新。2025年就这么溜走了，对我而言，是极为不寻常的一年，总是想着用文字把它记录下来。</p>
<h2 data-id="heading-0">文章输出</h2>
<p>写是为了更好的思考，坚持写作，力争更好的思考。</p>
<p>2025年累计发表54篇原创文章，平均1周更1篇，大多数是技术相关。2025年我有个转变——每个月写一篇月总结，对这个月主要做了什么事做一个系统的梳理，尽量以可量化的形式呈现，比如，这个月写了多少篇文章，拍了几条短视频，录了几节课，办了几场讲座等诸如此类。</p>
<p>为什么采用这种方式呢？前些年我也不是没写过年终总结，年底一回顾，感觉又稀里糊涂过了一年，好像什么事儿也没干。这种感觉让我很难受，同时我也觉得很可怕，因此在2025年我调整了自己的工作方式，每个月必须要有可量化的产出内容，不然那可真的就白活了一个月，如果每个月没有产出，那可就又白活了一年。</p>
<p>一句话总结为什么要坚持写文章，目的就是“以生产为导向”来倒逼自己不断输入。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/957d4f50d7584a4ca9e29e7a0048fd0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=1A5CeDLXLszvlrsFqpAYxGsy8YM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">短视频创作</h2>
<p>2025年共计录制52条短视频，一年刚好52个周，平均一周刚好更一条。说实话，2025年在短视频创作上偷懒了，最后一个季度基本上就没咋更新过，2026年还需要继续努力。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d454435f50694140b0f9016d72c063b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=SBBOJIMjXjljaepTeBz8Wg7zIew%3D" alt="" loading="lazy"/></p>
<p>我为什么要坚持拍短视频？拍摄一条短视频内容，有很多个环节——编剧、导演、演出、拍摄、剪辑、配音/配乐、发行、宣传。随便一数就至少有8个环节，一条短视频从头到位都是由你一个人制作完成，你说对一个人锻炼大不大？</p>
<h2 data-id="heading-2">讲义研发</h2>
<p>2025年共计研发了14套讲义，分别是：《Lua教程-V1.1》、《Redis 7.x企业级开发实战教程》、《DeepSeek快速入门》、《LLM提示词工程》、《使用大模型高效学习》、《AI高效办公解决方案》、《用DeepSeek高效生成图文音频与视频》、《大模型本地部署》、《个人知识库搭建》、《搭建批量处理工作流》、《搭建AI Agent智能体》、《零代码搞定项目开发部署》、《微信商业生态平民创业》、《职业发展与求职类AI智能体》。</p>
<p>这些讲义都是图文并茂，可以边学边练，快速提升专业知识能力，部分讲义见下图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5788ebae4ee4f0e9a504e6811f7de35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=wjOEwqrwgsj93WqBSeIZAX%2Fs1q0%3D" alt="" loading="lazy"/></p>
<p>我一直认为自己的研发能力很强，但今年7月、9月和10月却把大量时间投入在市场支持上，几乎没什么研发产出。如果当时不去开拓市场，至少还能多完成5套讲义的研发。</p>
<h2 data-id="heading-3">课程研发</h2>
<p>2025年，共计完成11门精品课程的录制，并在小鹅通、B站课堂和淘宝平台上架。其中，与人工智能技术应用相关的就有310节课程，软件开发的有404节课程。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d02c3c529f2244efa72a67a840078732~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=rf2037rBOyCa%2Fgx0ctot%2FOH1DOs%3D" alt="" loading="lazy"/></p>
<p>这里我要重点强调的是《职业技术认证培训课程》，2025年主要的时间精力都围绕在这门课程上，也是我花心思最多的一门课程，且在2026年是我重点去迭代维护的一门课程。</p>
<p>这套《职业技术认证培训课程》课程涵盖文案写作、PPT制作、数据分析、思维导图、会议纪要、视频生成、生活、教育、创业、政务、法律、投研、科研、自媒体、智能体、软件开发、等50余高频工作场景。课程内容还在陆续开发中。</p>
<h2 data-id="heading-4">上线专栏</h2>
<p>2025年1月，我上线了《Redis 7.x企业级开发实战教程》专栏，共计82篇文章，这也是我人生中上线的第一个付费专栏。本专栏全面覆盖Redis技术精髓，从基础概念到高级应用一网打尽。涵盖Redis基本操作、数据类型、分布式缓存、Lua脚本、性能优化及面试技巧。无论你是初学者还是进阶者，都能在此找到提升Redis技能的宝贵资源。实战导向，助力你在项目中高效运用Redis，成为缓存技术高手！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00a110ccb3ab40b784b6bd10e8ed63be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=yZ172yJr8vBFmVYkcbM6GxiDLzo%3D" alt="" loading="lazy"/></p>
<p>专栏《Redis 7.x企业级开发实战教程》的核心大纲内容见下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fdf498d3dbf1423e8f41a357eeaca9ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=lne1bGtwJ%2BIPpMH1mpzvsRU6als%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">讲座授课</h2>
<p>2025年，共计开展了20场讲座或授课活动，覆盖1890人。与在校大学生或企业进行了面对面的深度交流，都是与AI相关的报告。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d1ec8a8df0f48bf89754ba6c54fdb1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=QQdBn%2BYubbSYSw201pNF1173iXw%3D" alt="" loading="lazy"/></p>
<p>这是同学们在现场学习的照片，看得出来大家对AI的学习热情非常高！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cb4beb002cb418e99021d462e67dbc2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=BKmqYQp1TRvmNdmu7dFxAhrBXA0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">知识库搭建</h2>
<p>1.人人都要学AI知识库</p>
<p>未来是一个“人人都能学AI，人人都要学AI”的时代。我把我研发的提供保姆级教程、AI工具实操、案例解析及开源项目等教程都整理放在这个知识库里了，目的就是为大家构建一个系统化AI知识体系。截至今日，该知识库中共有98篇文档，271118字。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54096b5cf421414db4e23aa5a618e392~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=%2FHNFzrNiGcwaDiPmWP%2ByufmrzeU%3D" alt="" loading="lazy"/></p>
<p>2.圆心学堂星球知识库</p>
<p>这个知识库我是从2024年开始维护的，这里有着循序渐进的Java学习体系，涵盖主流框架、中间件、分布式和微服务等领域技术，助你开启Java进阶之旅。截至今日，该知识库中共有189篇文档，1582791字。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89d18348187c4b2cab279a0c4554495b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=Yf635Ux7CRSknIHJYHedZUWt5QM%3D" alt="" loading="lazy"/></p>
<p>3.圆心启点市场知识库</p>
<p>为便于各合作伙伴快速了解《人工智能应用认证培训课程》产品，我特别整理了本产品知识库。内容包含公司简介、证书介绍、课程简章、课程海报、报名表格、招生讲座、咨询话术、考试流程、练习题库等核心资料。目的就是希望我们的合作伙伴更加快速的了解我们的产品，用最快最短的时间实现合作共赢。截至今日，该知识库中共有21篇文档，48068字。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c0e3aff5c8f4251bd734490594aafd6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=wBpIHqKQ0tm5FKLdLWWdv%2FMK0cI%3D" alt="" loading="lazy"/></p>
<p>我做了一个统计，以上三个知识库共计有308篇文档，1901977字。没想到差不多两年的时间，竟写了190万字，我还真的被自己惊艳到了，这就是长期积累的结果吧。</p>
<h2 data-id="heading-7">店铺运营</h2>
<p>在这个互联网时代，人人都可以做点小生意。要做生意就得开店，2025年我相继开通了小鹅通店铺、B站课堂小店、淘宝店铺、微信小店。</p>
<p>店铺的运营是需要花费巨大时间的，其实，时间主要花费在了商品封面和商品长图海报设计上。我是不懂设计的，那咋办？不懂就学呀，还能咋办，我又没钱请别人帮我设计。当然了，我对自己设计的海报还是挺满意的，大家觉得咋样呢？</p>
<p>下图是小鹅通店铺H5展示样式：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c028c30dd864051944d6d748196fa60~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=TRpbxBOXxg6LdO05ZKLAEPnSwLM%3D" alt="" loading="lazy"/></p>
<p>下图是B站课堂小店展示样式：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dcafc566e75a47d28b426ab2ac6607b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=J8asfDTXQCFmWFIjeugsAMb3Y4k%3D" alt="" loading="lazy"/></p>
<p>下图是淘宝店铺展示样式：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c501c1acf7b9401489d5ac9cef277cea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=9Phu67MPSdwCGokB70dSqxlu1Ls%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">知识星球运营</h2>
<p>知识星球「圆心学堂」是我2024年7月22日创建的一个专注于后端软件开发知识分享的社群。涵盖Java主流技术栈，有着一套循序渐进的学习体系，帮助星友快速获取所需技能，助力职业生涯发展。该星球配套有1个知识库，现有42个专栏，830+内容数量。</p>
<p>今年5月份我又创建了一个星球——「人人都要学AI」，该星球是由袁庭新我本人发起的一站式AI学习社群。涵盖文案写作、PPT制作、数据分析、思维导图、会议纪要、视频生成、生活、教育、创业、政务、法律、投研、科研、自媒体、智能体、软件开发、等50余高频工作场景，100+提示词开箱即用。社群内每月设大咖直播答疑，支持全天候互动交流，致力于为大学生、职场人、创业者等不同群体，搭建从理论认知到实践落地的全链路成长平台，助你系统掌握AI知识与技能，拥抱数字化时代的核心竞争力。该星球配套有1个知识库，640+内容数量。</p>
<p>未来，我本人依旧会重点维护这两个社群，一方面专注于软件开发，另一方面核心聚焦于AIGC领域的前沿技术。</p>
<h2 data-id="heading-9">媒体平台账号运营</h2>
<p>“再小的个体，也有自己的品牌”。</p>
<p>我猜，在此之前，很多人（包括我）从未认真体会过这个简短句子的深意——可现在，我可谓感受颇深，感慨万千。非常后悔前些年一直没有重视自媒体平台运营，当然现在还不晚。</p>
<p>我现在运营有43个账号，是的你没听错。主体上这43个账号分为三类，第一类是以「袁庭新」为昵称的账号，这个账号主要分享软件开发的相关知识；第二类是以「袁庭新AI」为昵称的账号，该账号未来将聚焦人工智能前沿动态与发展，为了更好地分享AI相关知识；第三类是以「圆心星球」为昵称的账号，这个账号未来规划的是与公司相关的资讯、动态、产品等内容，都会发布到这个账号上。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db55ffd9b59540c5bb77664a79c81021~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=1HYGGrfBmscyPUc79TpFT2qsKPc%3D" alt="" loading="lazy"/></p>
<p>无论是哪一类账号，都将持续输出优质内容，欢迎感兴趣的朋友们关注！</p>
<h2 data-id="heading-10">职业技术证书</h2>
<p>为推动实施人才强国战略，创新驱动发展战略，紧密围绕工业和信息化高质量发展步伐，立足新技术、新业态、新职业，进一步聚焦工业和信息化领域重点产业和关键技术，我司联合工业和信息化部教育与考试中心开发了《人工智能技术应用》和《生成式人工智能技术应用》两个方向的职业技术证书认证培训课程标准，这两个方向证书共设三个等级，分别为：初级、中级、高级。</p>
<p>我是工信部教考中心《人工智能技术应用》和《生成式人工智能技术应用》人才培养工程标准的编写人，其实就是教考中心请几位不同行业的专家，针对我所写的这份人才培养标准进行评审，主要就是给一些建议，然后我再进行修改调整内容。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/feaae69095fd4bb6ac23b6849f63d291~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=MnjrMgxfmJirDJ8phW9kuzGkdX0%3D" alt="" loading="lazy"/></p>
<p>在项目申报过程中，我写了大量的材料。其中，《人才培养工程培训站点申请表》就有35页。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f096bdadde904f9384bd795099703be3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=LchybIGNY0nxHUhhKx7ZqMK4HS4%3D" alt="" loading="lazy"/></p>
<p>在撰写人才培养标准时，需要结合一线企业用人需求和当下AI技术发展现状完成《工业和信息化人才培养工程培训课程标准》研发，光这个文件就写了27页。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef2fa2d4ab3f4ca896b72f18e30bc130~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=qUAwDMpCRLm3HUsjCd439svQUtQ%3D" alt="" loading="lazy"/></p>
<p>针对《人工智能技术应用》和《生成式人工智能技术应用》两个方向的认证，出了8套试卷。每套试卷10余页试题，8套试卷合计超80页试题。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df7dae072cac444cb2335b99470ee270~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=RWovVVtJ3ZixvnpU6uk7UDEZRXE%3D" alt="" loading="lazy"/></p>
<p>此外，还包括考试系统维护、学员信息整理、组织考试以及批阅试卷等工作，内容极为繁杂，我在2025年为这个项目投入了大量精力。所以，朋友们如果有《人工智能技术应用》和《生成式人工智能技术应用》证书需求可以找我，该证书具备高含金量与公信力，助力学员职业进阶与能力认证。</p>
<h2 data-id="heading-11">公司运营</h2>
<p>在AI时代，“一人公司”正从概念走向现实。我也在积极拥抱AI，尝试着利用人工智能技术来独立完成产品开发、运营、营销、客服等商业活动。</p>
<p>2025年，我也在尝试着运营公司，这方面完全就是一个小白。这一年纯粹是在“干中学”，了解了公司股权设置、银行对接、公户管理、报税扣税、公积金管理等等，学到了以前从未想过和看到的东西。</p>
<p>路老师在奋力的开拓市场，寻找合作伙伴，突然觉得我们的业务发展的还挺快，北京、河南、湖南、山西、陕西现在又到了甘肃，都有我们的业务合作伙伴。照这个势头下去，2026年要覆盖全国了呀！</p>
<p>一个好消息是，2025年年底，我们团队新加入了一位成员。新的一年里，我们将并肩同行、携手探索，在彼此支持中不断成长，一起奔赴更加美好的明天！</p>
<h2 data-id="heading-12">物料研发</h2>
<p>我现在已经是一个“全能型”的打工仔，不光负责课程的开发和录制，包括与之相关的产品物料都是我亲自设计的，如课程简章设计、学员手册设计、课程海报设计以及线下活动宣传物料等。</p>
<p>起初我对设计排版几乎一无所知，但在AI工具和在线设计平台的帮助下，即使毫无设计基础的我也能制作出可用的海报，只是需要多花些时间打磨。</p>
<p>课程简章是非常重要的市场支持物料文件，课程内容有新的迭代了，第一时间要同步到课程简章中，同时还要考虑排版设计，总不能太丑吧，那样看上去就很low。下图是百分百由我操刀设计的简章，大家觉得咋样呢？</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e72ff40f35d944f89bf0be1ce132a751~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=tQ48MynVCHiYxIDGuOc%2BAWKIuig%3D" alt="" loading="lazy"/></p>
<p>为了让学员高效学习，设计了《学员学习流程手册》，大家觉得，设计的如何？</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbd0510dbbdd42619139cddf0d2f88c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=THtoylQ4gIf2959%2FwUYAMbtau4Q%3D" alt="" loading="lazy"/></p>
<p>为了更好的支持市场小伙伴，我根据市场的特点，给制作了3种类型的PPT，分别是：技术类讲座PPT、实操类讲座PPT、营销类讲座PPT。在PPT制作上花费了巨大的时间。</p>
<p>技术类讲座：纯讲主流的前沿技术，技术框架，解决方案等，适合计算机类专业，共计93页。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c27911c6f294491b1d170087380fce1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=HgmvgSb6dFgEikTqNz3uQ%2FpBqp0%3D" alt="" loading="lazy"/></p>
<p>实操类讲座：讲解AIGC工具的实操应用，通过快速案例演示吸引学员，适合所有专业，共计88页。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f91e876557e04ef3a0f4c403c3100ff2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=CON9%2Bo1I3X%2FaJVij5TBbRROaGPY%3D" alt="" loading="lazy"/></p>
<p>营销类讲座：讲AI发展趋势以及典型的应用案例，和证书的价值等，适合所有专业，共计70页。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb4c47617c65447a973843ad45bc6724~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=dbMe3m0GmZjYuD9z7t1FjysiWR4%3D" alt="" loading="lazy"/></p>
<p>课程海报是我花了很多心思设计出来的，大家来看看我做的这张长图海报，觉得怎么样？欢迎提提意见！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df149a0a17b74a228e2cc55b94a2e873~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=ehdMX3ICXvKDups%2BGzcPe%2B6OdvM%3D" alt="" loading="lazy"/></p>
<p>这套课程还配套了职业技术证书，学完并通过考试后，可获得《人工智能技术应用》和《生成式人工智能技术应用》证书。</p>
<p>以上我只是挑了几个有代表性的物料研发做了介绍，其实还有非常多的其他物料研发，比如项目合伙人海报的创意与制作、线下集训营活动海报、证书相关海报、讲师介绍海报等等，就不一一赘述了。</p>
<h2 data-id="heading-13">强健体魄</h2>
<p>“身体是革命的本钱”这句话一点儿都不假，这一生想做点事，想多做一点事，拥有一个强健的体魄是前提，你看重要的道理总是这么简单。道理都知道，知道有什么用呢？关键是要做到呀！</p>
<p>2025年我也有意识的开始多运动。爬了三座山：渭南少华山、长安库峪太兴山、秦岭翠华山。年纪是真的大了，开始喜欢山山水水了，厌倦了城市的繁华，就想一个人静静地待着——看山看水！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5b6908517fd40b5b8f971e145eb1145~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=2OLB9JbaHhI4%2FeNsSNkD426%2BSdg%3D" alt="" loading="lazy"/></p>
<p>同时，还滑了4次雪，刚开始穿上雪橇连站都站不稳，现在基本上能滑了，摔倒了也能不依靠别人自己站起来，就是还没学会刹车减速，2026年必须得学会。</p>
<p>从2025年7月份开始，我有计划的开始健身，比如做俯卧撑、仰卧起坐、跑步等。运动确实可以改变一个人的状态，如果工作焦虑长期心烦意燥或者失眠，更应该多运动。今年我有一个观念转变就是：锻炼比学习甚至更重要。</p>
<h2 data-id="heading-14">个人荣誉</h2>
<p>2025年取得了两项个人荣誉。第一个是加入计算机教育学会，我本人也非常荣幸，在大会上经表决，被增补为陕西省计算机教育学会第九届理事会理事。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbba6375e2cc474183ec9f934d37cdb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=wgXj1sqzGOUDJjpgERiPUfU4ykA%3D" alt="" loading="lazy"/></p>
<p>同时在2025年7月22日，还赴汉中参加陕西省计算机教育学会第九届理事会2025年会员代表大会。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f2343d8f9234c0c966fe6850f673f46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=65dFsA3MtTa%2BxwTa3TAzoHQJJAM%3D" alt="" loading="lazy"/></p>
<p>第二个是，我很荣幸作为工信部教考中心《人工智能技术应用》和《生成式人工智能技术应用》人才培养工程标准主要参编人。学AI、考AI证书，说实话咱是真专业！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e14880a5ba174dbe910b36b5e62b8154~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=MNgwjwcopgI6gErIkuS5%2FzNTSxk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-15">其他事项</h2>
<p>读了几本书</p>
<p>见了几位多年未见的老友</p>
<p>回了三趟旬阳，可惜的是没有回老家</p>
<p>拍了一组长发写真，要像斗士一样活着</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7bf37968808341c19b0cb34358333ed6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=GAAjoBtaGa4WSTh6jp1I4khqMjw%3D" alt="" loading="lazy"/></p>
<p>2025，已成过往！2026，又会有怎样的故事呢？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 0 到 1 构建领先 DBaaS 平台：移动云架构师丁顺的 KubeBlocks 实践之路]]></title>    <link>https://juejin.cn/post/7590421489998299155</link>    <guid>https://juejin.cn/post/7590421489998299155</guid>    <pubDate>2026-01-03T14:10:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590421489998299155" data-draft-id="7590283328176537643" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 从 0 到 1 构建领先 DBaaS 平台：移动云架构师丁顺的 KubeBlocks 实践之路"/> <meta itemprop="keywords" content="Kubernetes,DBA,云原生"/> <meta itemprop="datePublished" content="2026-01-03T14:10:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小猿姐"/> <meta itemprop="url" content="https://juejin.cn/user/1286882438155148"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             从 0 到 1 构建领先 DBaaS 平台：移动云架构师丁顺的 KubeBlocks 实践之路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1286882438155148/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小猿姐
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T14:10:37.000Z" title="Sat Jan 03 2026 14:10:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0"><strong>引言：</strong></h3>
<p>在云原生浪潮席卷全球的今天，各行各业都在加速数字化转型。对于构建云数据库服务（DBaaS）的团队而言，如何在保证高性能、高可用性的同时，快速迭代、降低运维复杂度，成为了核心挑战。今天，我们有幸邀请到移动云大云海山数据库管控系统的架构师丁顺，他将与我们分享移动云团队如何利用 KubeBlocks，在资源与时间有限的情况下，高效构建起其核心 DBaaS 服务的故事。他的经历不仅展现了 KubeBlocks 在实际生产环境中的强大价值，也为我们带来了对云原生数据库管理未来发展的深刻洞察。</p>
<hr/>
<h2 data-id="heading-1"><strong>第一部分：与移动云 DBaaS 架构师丁顺对话</strong></h2>
<p><strong>Q1：丁顺您好，请您简单介绍一下自己和您的工作？</strong></p>
<p><strong>丁顺：</strong> 大家好，我是丁顺，目前在移动云担任大云海山数据库管控系统的架构师。我的主要职责是规划和实现移动云自研数据库大云海山数据库的云产品化，为用户提供高效、稳定的 DBaaS 服务。</p>
<p><strong>Q2：移动云在数据库领域扮演怎样的角色？</strong></p>
<p><strong>丁顺：</strong> 移动云是中国移动旗下的云计算品牌，致力于提供全面的云服务。我们是云服务提供商，主要深耕于云原生数据库领域，在 Kubernetes 之上构建大云海山数据库的 DBaaS 服务，以满足不同企业级客户对高性能、高可靠数据库的需求。</p>
<p><strong>Q3：刚刚您提到了移动云自研的大云海山数据库。能否展开讲讲这是一款怎样的数据库产品？</strong></p>
<p><strong>丁顺：</strong> 大云海山数据库是移动云自研的数据库，是中国移动重点打造的自有品牌。它具备高扩展、高性能、高可用、高安全及低成本等特性，并全面适配主流国产芯片和操作系统，旨在为业界提供即开即用、安全可靠的数据库服务。值得一提的是，今年 8 月，大云海山数据库顺利通过了<strong>国家安全可靠测评</strong>，这是国家对其产品能力、企业资质、运维能力、未来发展的认可。</p>
<p><strong>Q4：能否分享一下当前支撑移动云 DBaaS 平台的基础技术栈？</strong></p>
<p><strong>丁顺：</strong> 我们的核心技术栈完全基于 Kubernetes 构建。作为云提供商，我们利用 Kubernetes 的强大编排和管理能力，为大云海山数据库提供稳定、弹性的运行环境。我们目前专注于构建和维护大云海山数据库的 DBaaS 服务，确保其在云环境中能够提供业界领先的数据库管理能力。</p>
<hr/>
<h2 data-id="heading-2"><strong>第二部分：困境与破局：为什么是 KubeBlocks？</strong></h2>
<p><strong>Q1：您是如何发现 KubeBlocks 的？</strong></p>
<p><strong>丁顺：</strong> 当时我们正面临从零开始构建大云海山数据库的 DBaaS 管控系统的巨大挑战，时间紧、人力缺。在技术选型调研阶段，有同事推荐了 KubeBlocks，这为我们打开了一扇新的大门。</p>
<p><strong>Q2：在接触 KubeBlocks 之前，移动云在 Kubernetes 上构建数据库服务时，主要面临哪些核心痛点和挑战？</strong></p>
<p><strong>丁顺：</strong> 痛点非常明显，可以总结为内忧和外患。</p>
<p>首先是技术上的“<strong>烟囱式开发</strong>”和“<strong>伪云原生</strong>”问题。以往每引入一种新数据库，就得从头写 Operator 和 CRD，不仅重复造轮子，而且质量参差不齐。很多自研 Operator 只是把数据库简单的“搬”上 K8s，却没解决共享内存、ulimit 等深层问题，导致性能不如人意。</p>
<p>其次是项目背景带来的<strong>资源挑战</strong>。当时我们需要在极短的时间内、用极其有限的人力，从零构建出大云海山数据库的 DBaaS 服务。同时，我们还希望它不仅是为了解决眼下的问题，更要是一个能适配多种引擎的<strong>通用管控底座</strong>。这对我们当时的团队来说，几乎是一个“不可能三角”。</p>
<p><strong>Q3：这听起来确实极具挑战。那么，KubeBlocks 是凭借什么特性打动了您，让您觉得它可以解决这些难题？</strong></p>
<p><strong>丁顺：</strong> 主要是它的“<strong>低代码模式</strong>”、“<strong>通用架构</strong>”和“<strong>强大的抽象模型</strong>”完美契合了我们的需求。</p>
<p>第一，它把数据库复杂的生命周期管理抽象成了统一的 Operator，我们<strong>只需要编写配置文件的形式开发 Addon（插件）</strong>，就能快速接入新引擎。这直接将 Operator 开发的复杂度降维了，极大地缓解了我们人力不足的压力。</p>
<p>第二，我们在做通用性 DBaaS 管控系统设计的架构选型时其实对比过三种架构方案，KubeBlocks 的设计理念（即在 Operator 层展现通用能力）与我们构想的终极方案<strong>不谋而合</strong>。它不仅能救火（解决上线时间问题），又符合我们将来的长期战略（构建通用底座）。这种高度的契合，促使我们最终决定将其作为核心底座。</p>
<p>第三，大云海山数据库作为一个持续演进的自研数据库产品，它的内核架构需要不断迭代以适应新的业务场景。这对底层的 DBaaS 管控系统提出了极高的要求：Operator 必须具备极强的灵活性，以应对未来架构的升级变化。这也是我们选择 KubeBlocks 的关键原因——其强大的<strong>抽象模型</strong>能够灵活适配大云海山数据库未来的架构演进，为我们持续迭代、提供稳定的云上服务提供了坚实的底座保障。</p>
<hr/>
<h2 data-id="heading-3"><strong>第三部分：从 0 到 1 的落地实践与价值</strong></h2>
<p><strong>Q4：目前 KubeBlocks 在移动云的落地情况如何？主要应用在哪些场景？</strong></p>
<p><strong>丁顺：</strong> 我们已经在<strong>生产环境</strong>全量上线。目前，移动云的每个大云海山数据库部署区域（Region）都部署了一套 KubeBlocks，作为大云海山数据库管控系统的核心 <strong>Operator 层</strong>。</p>
<p>它不仅支撑了大云海山数据库实例的<strong>创建、备份/恢复、扩缩容、高可用管理</strong>等核心功能，我们也正在利用它的通用性适配更多开源数据库，以验证其作为通用底座的能力。</p>
<p><strong>Q5：在将 KubeBlocks 集成到移动云现有的庞大云管体系中时，你们团队做了哪些架构层面的设计？</strong></p>
<p><strong>丁顺：</strong> 我们把 KubeBlocks 作为<strong>原子能力的提供者</strong>，集成在我们的“大云海山数据库管控平台”内部。</p>
<p>我们构建了一套<strong>三层管控平台架构</strong>：最上层是<strong>统一的业务服务层</strong>，负责处理移动云特有的计费、鉴权及容量管理等业务逻辑；中间层是<strong>管控服务层</strong>，提供独立于特定业务底座的通用数据库管控能力；底层则是<strong>Operator 层</strong>，我们基于 KubeBlocks 框架，利用其 Addon 机制来实现不同数据库引擎的组件编排、高可用切换及备份等核心运维能力。</p>
<p>这种分层的架构设计，既保留了移动云业务的灵活性，又充分利用了开源社区的技术红利。这也是我们团队在 DBaaS 架构演进中的一次重要实践。</p>
<p><strong>Q6：将核心管控层交给 KubeBlocks 后，为移动云带来了哪些实质性的改变？</strong></p>
<p><strong>丁顺：</strong> 最直观的改变就是<strong>研发效率的质变</strong>。</p>
<p>以前我们对于每个产品都需要组建一支团队去开发和维护 Operator，现在我们投入比以前更少的人力开发 KubeBlocks Addon，就能获得成熟的数据库编排能力。这让我们能把宝贵的研发资源集中在<strong>数据库自研内核的优化</strong>上，而不是消耗在重复的 K8s 运维逻辑中。</p>
<p>此外，它帮我们实现了<strong>运维经验的复用</strong>。因为 API 模型是统一的，我们为大云海山数据库积累的运维能力，可以无缝迁移到其他数据库产品上，大大降低了长期的运维成本。</p>
<p><strong>Q7：在使用过程中，遇到过什么挑战或痛点吗？</strong></p>
<p><strong>丁顺：</strong> 虽然 KubeBlocks 带来了巨大价值，但在使用过程中我们也遇到了一些挑战，希望能与社区共同探讨：</p>
<ol>
<li>
<p><strong>Addon 开发调试：</strong> 目前 Addon 开发过程中的问题调试还是个难点，有时报错信息不够明确，排查难度较大。</p>
</li>
<li>
<p><strong>API 命名相似：</strong> 我们生产环境上线较早（从 0.8 版本开始），后续的 KubeBlocks 版本中由于前向兼容或其他原因, 某些 API 字段得以保留，但是导致了新版本的一些字段和这些历史遗留的字段名称过于相似，在使用新版本 KubeBlocks 接口开发 AddOn 时容易混淆，例如 <code>cluster.spec.componentSpecs.componentDef</code> (新版本) 和 <code>cluster.spec.componentSpecs.componentDefRef</code> (老版本) 。我觉得社区有一些其它开发者可能会有同样的困扰。</p>
</li>
</ol>
<p><strong>Q8：作为一个深耕云原生技术的团队，移动云在享用开源红利的同时，是否也参与了 KubeBlocks 社区的共建？</strong></p>
<p><strong>丁顺：</strong> 当然。我们团队始终秉持“源于开源，回馈开源”的理念。在适配大云海山数据库的实战过程中，我们将在 Addon 开发及大规模生产运维中遇到的深层问题，积极整理并反馈给社区。同时，我们也贡献了大量 PR，涵盖了<strong>对 KubeBlocks 框架本身的优化</strong>以及<strong>对现有开源 Addon 的功能增强</strong>。通过与社区的紧密协作，我们不仅提升了自身产品的稳定性，也共同推动了整个开源生态的成熟。这种技术与生态的“双向奔赴”，是我们非常看重的合作模式。</p>
<hr/>
<h2 data-id="heading-4"><strong>第四部分：对未来的展望</strong></h2>
<p><strong>Q1：您是否有其他反馈或建议想和社区分享？</strong></p>
<p><strong>丁顺：</strong> 我有一个大胆的想法，有没有可能把 KubeBlocks Addon 的开发相关的流程和最佳实践，打包为一个对应的 Claude Skill？这样让 Claude Code 这样的 AI agent 具有自动开发、修改和调试 KubeBlocks Addon 的能力，那将极大地提升开发效率！</p>
<p><strong>Q2：对于刚开始评估 KubeBlocks 的同行，您会给出什么建议？</strong></p>
<p><strong>丁顺：</strong> 结合我们的经验，KubeBlocks 对于希望在 Kubernetes 上构建通用、高性能 DBaaS 平台的团队来说，是一个极其有价值的解决方案。</p>
<p>它能帮助你<strong>大幅缩短开发周期，降低运维成本，并避免重复造轮子</strong>。虽然在刚开始学习 Addon 开发时会有些挑战，但其带来的长期收益，尤其是对于希望标准化数据库运营的团队来说，是巨大的。建议深入研究其设计理念，并多参考社区现有的 Addon 案例。</p>
<hr/>
<h3 data-id="heading-5"><strong>结语：</strong></h3>
<p>感谢丁顺的精彩分享！移动云利用 KubeBlocks 成功构建大云海山数据库 DBaaS 平台的经验，充分证明了 KubeBlocks 在云原生数据库管理领域的强大能力和巨大潜力。同时，丁顺提出的挑战和建议，也为 KubeBlocks 社区指明了未来的优化方向。KubeBlocks 社区将持续听取用户反馈，不断打磨产品，致力于为开发者提供更易用、更强大、更成熟的云原生数据库管理解决方案。我们期待与更多像丁顺一样的先行者，共同推动云原生数据库生态的发展！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GDAL 实现自定义数据坐标系]]></title>    <link>https://juejin.cn/post/7590403249561092111</link>    <guid>https://juejin.cn/post/7590403249561092111</guid>    <pubDate>2026-01-03T14:58:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590403249561092111" data-draft-id="7590403249561075727" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GDAL 实现自定义数据坐标系"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-03T14:58:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GIS之路"/> <meta itemprop="url" content="https://juejin.cn/user/4346787284915481"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GDAL 实现自定义数据坐标系
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4346787284915481/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GIS之路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T14:58:24.000Z" title="Sat Jan 03 2026 14:58:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">^ 关注我，带你一起学GIS ^</h2>
<h2 data-id="heading-1">前言</h2>
<blockquote>
<p>❝</p>
<p>在GIS开发中，经常需要进行数据的转换处理，特别是Shapefile数据的投影转换更是重中之重，如何高效、准确的将源数据坐标系转换到目标坐标系是我们需要研究解决的问题。</p>
</blockquote>
<p>在之前的文章中讲了如何使用<code>GDAL</code>或者<code>ogr2ogr</code>工具将<code>txt</code>以及<code>csv</code>文本数据转换为<code>Shp</code>格式，本篇教程在之前一系列文章的基础上讲解如何使用<code>GDAL</code>实现自定义数据坐标系。</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FQtb_BJw91nKrFMeoa7WcxA" target="_blank" title="https://mp.weixin.qq.com/s/Qtb_BJw91nKrFMeoa7WcxA" ref="nofollow noopener noreferrer">GDAL 简介</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FFLWfZItLj24JYicQEX-PbQ" target="_blank" title="https://mp.weixin.qq.com/s/FLWfZItLj24JYicQEX-PbQ" ref="nofollow noopener noreferrer">GDAL 下载安装</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fu0539e3CM2q4Y3MbMxxZKQ" target="_blank" title="https://mp.weixin.qq.com/s/u0539e3CM2q4Y3MbMxxZKQ" ref="nofollow noopener noreferrer">GDAL 开发起步</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F0DGoC0oFHizJbweBnEvI-g" target="_blank" title="https://mp.weixin.qq.com/s/0DGoC0oFHizJbweBnEvI-g" ref="nofollow noopener noreferrer">GDAL 实现 GIS 数据读取转换（全）</a></li>
</ul>
<p>如果你还没有看过，建议从以上内容开始。</p>
<h2 data-id="heading-2">1. 开发环境</h2>
<p>本文使用如下开发环境，以供参考。</p>
<p>时间：<code>2025年</code></p>
<p>系统：<code>Windows 11</code></p>
<p>Python：<code>3.11.7</code></p>
<p>GDAL：<code>3.11.1</code></p>
<h2 data-id="heading-3">2. 数据重投影</h2>
<p>定义一个方法<code>ShpProjection</code>用于实现Shp数据的投影转换，其中参数<code>sourcePath</code>为源数据路径，<code>targetPath</code>为目标文件路径。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
说明：Shapfile 文件重投影
参数：
    -sourcePath：Shp 源文件路径
    -targetPath：投影文件目标路径
"""</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">ShpProjection</span>(<span class="hljs-params">sourcePath,targetPath</span>):
</code></pre>
<p>先检查源数据文件是否存在，若不存在则退出程序</p>
<pre><code class="hljs language-lua" lang="lua"># 检查Shp源文件是否存在
<span class="hljs-keyword">if</span> <span class="hljs-built_in">os</span>.<span class="hljs-built_in">path</span>.exists(sourcePath):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"源文件存在！"</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(f<span class="hljs-string">"源文件不存在：{sourcePath}"</span>)
    <span class="hljs-keyword">return</span>
</code></pre>
<p>添加<code>Shp</code>数据驱动用于创建<code>Shp</code>数据源和图层，<code>GetDriverByName</code>方法需要一个驱动器名称。还需要检查一下目标数据路径是否正常，只有在目标路径正常时才创建数据源。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 获取Shp数据驱动</span>
shpDriver = gdal.GetDriverByName(<span class="hljs-string">"ESRI Shapefile"</span>)

<span class="hljs-comment"># 检查Shp文件是否存在</span>
<span class="hljs-keyword">if</span> os.path.exists(targetPath):
    <span class="hljs-keyword">try</span>:
        shpDriver.DeleteDataSource(targetPath)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"文件已删除！"</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"文件路径不存在！：<span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
<span class="hljs-comment"># 创建数据源</span>
targetDataSource = shpDriver.CreateDataSource(targetPath)
</code></pre>
<p>获取源数据图层信息并创建坐标系统。<code>osr</code>模块下的<code>SpatialReference</code>方法用于定义空间参考信息。其中空间参考信息具有三种形式，可以传递字符串名称，<code>EPSG</code>代码或者<code>wkt</code>形式的坐标定义内容。<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1639376ec055431b9fa77b590fa03f98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768057104&amp;x-signature=n4DYVGxxLkyeDdBARLUS8CRw45c%3D" alt="" loading="lazy"/>如下采用<code>name</code>参数形式。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 获取Shp数据图层</span>
<span class="hljs-attr">sourceDataSource</span> = ogr.Open(sourcePath)
<span class="hljs-attr">sourceLayer</span> = sourceDataSource.GetLayer()

<span class="hljs-comment"># 获取坐标系</span>
<span class="hljs-attr">srs</span> = osr.SpatialReference(epsg=<span class="hljs-number">5646</span>)
print(f"坐标系统名称：{srs.GetName()}")
</code></pre>
<p>打印坐标系统名称如下：<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7277df6c8ff24ab1b9c0e6f11ede6d38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768057104&amp;x-signature=d4jnjq9uhuxcUa3XCd6urVLnj2g%3D" alt="" loading="lazy"/></p>
<p>使用<code>CreateLayer</code>方法创建目标图层，本例中数据类型为<code>LineString</code>，所以<code>geom_type</code>参数为<code>ogr.wkbLineString</code>。之后遍历源图层数据，将属性字段和要素值写入投影图层之中。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 创建Shp投影数据图层</span>
<span class="hljs-attr">geomType</span> = sourceLayer.GetGeomType()
<span class="hljs-attr">shpProjectLayer</span> = targetDataSource.CreateLayer(
    "layer",
    <span class="hljs-attr">srs</span>=srs,
    <span class="hljs-attr">geom_type</span>=ogr.wkbLineString
)

<span class="hljs-comment"># 获取源图层属性结构</span>
<span class="hljs-attr">layerDefn</span> = sourceLayer.GetLayerDefn()
print(layerDefn.GetFieldCount())

<span class="hljs-attr">fieldCount</span> = layerDefn.GetFieldCount()

<span class="hljs-comment"># 添加属性字段</span>
for i in range(fieldCount):
    <span class="hljs-attr">fieldDefn</span> = layerDefn.GetFieldDefn(i)
    shpProjectLayer.CreateField(fieldDefn)

for feature in sourceLayer:
    shpProjectLayer.CreateFeature(feature)

if <span class="hljs-attr">__name__</span>  == <span class="hljs-string">"__main__"</span>:

    <span class="hljs-attr">sourcePath</span> = <span class="hljs-string">"E:\data\test_data\geojson\river.shp"</span>
    <span class="hljs-attr">targetPath</span> = <span class="hljs-string">"E:\data\test_data\geojson\river_project.shp"</span>

    ShpProjection(sourcePath,targetPath)
</code></pre>
<p>运行成功之后在<code>ArcGIS</code>中打开图层属性显示如下：<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58e526113b684b6ab3c1af7cba6721c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768057104&amp;x-signature=kJCNyeaK0ESY2WN1chJlvzZCLk8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1a4dc4a644747c482828b899e928d66~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768057104&amp;x-signature=TA%2Bdz3eLQy7BEMr9kaxycOyFzRo%3D" alt="" loading="lazy"/></p>
<p><strong><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41ddc3c0830445109943f91df517fef6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768057104&amp;x-signature=5MeapY95NCsPpzrpD0U5vpjCbkk%3D" alt="" loading="lazy"/></strong></p>
<blockquote>
<p>❝</p>
<p>OpenLayers示例数据下载，请在公众号后台回复：<strong>ol数据</strong></p>
<p>全国信息化工程师－GIS 应用水平考试资料，请在公众号后台回复：<strong>GIS考试</strong></p>
</blockquote>
<blockquote>
<p>❝</p>
<p><em><strong>GIS之路</strong></em> 公众号已经接入了<strong>智能</strong> <strong>助手</strong>，可以在对话框进行提问，也可以直接搜索历史文章进行查看。</p>
</blockquote>
<p>都看到这了，不要忘记<em><strong>点赞、收藏</strong></em> <strong>+</strong> <em><strong>关注</strong></em> 哦 <strong>！</strong></p>
<p>本号不定时更新有关 <em><strong>GIS开发</strong></em> 相关内容，<em><strong>欢迎关注 <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8788d47b19ab46e187f596a9b5b99b44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768057104&amp;x-signature=MnbBwt0VVHVdoNfD9Adx1JhZTsY%3D" alt="" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/669f936658fb476f860e9a0184728e8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768057104&amp;x-signature=3tyqHSDgdtfMfXDZ7XrK4P4DNws%3D" alt="" loading="lazy"/></strong></em></p>
<hr/>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/394d4909e484434da58150e19f584944~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768057104&amp;x-signature=i%2FccFaDaXIXAe4ImwxN0xSFgzCI%3D" alt="" loading="lazy"/></p>
<p>   <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/deb58e5f63a843d79505c4cfafe2d5f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768057104&amp;x-signature=bL4umKNXBbiCXQGIpIdrlZQJ2qA%3D" alt="" loading="lazy"/> </p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwOTEzNjI5NQ%3D%3D%26mid%3D2247487953%26idx%3D1%26sn%3D0b2d5aeefdb290583cf8cdd82f3c2077%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwOTEzNjI5NQ==&amp;mid=2247487953&amp;idx=1&amp;sn=0b2d5aeefdb290583cf8cdd82f3c2077&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">GeoTools 开发合集（全）</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwOTEzNjI5NQ%3D%3D%26mid%3D2247487119%26idx%3D1%26sn%3Dc313efa84c27bf933ef2f2a47991ef2d%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwOTEzNjI5NQ==&amp;mid=2247487119&amp;idx=1&amp;sn=c313efa84c27bf933ef2f2a47991ef2d&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">OpenLayers 开发合集</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FPGxwhRbuiRUKIpT2D2cVGQ" target="_blank" title="https://mp.weixin.qq.com/s/PGxwhRbuiRUKIpT2D2cVGQ" ref="nofollow noopener noreferrer">GDAL 实现矢量数据读写</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fi77nCatd4V2nuybZFIs-xA" target="_blank" title="https://mp.weixin.qq.com/s/i77nCatd4V2nuybZFIs-xA" ref="nofollow noopener noreferrer">GDAL 数据类型大全</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FAVXeDrd13EexedVqOdLuxA" target="_blank" title="https://mp.weixin.qq.com/s/AVXeDrd13EexedVqOdLuxA" ref="nofollow noopener noreferrer">百度宣布，良心画图工具停服！</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F0DGoC0oFHizJbweBnEvI-g" target="_blank" title="https://mp.weixin.qq.com/s/0DGoC0oFHizJbweBnEvI-g" ref="nofollow noopener noreferrer">GDAL 实现 GIS 数据读取转换（全）</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Frk-Jxqnn5E9aXDxQiomIIg" target="_blank" title="https://mp.weixin.qq.com/s/rk-Jxqnn5E9aXDxQiomIIg" ref="nofollow noopener noreferrer">GIS 数据转换：使用 GDAL 将 Shp 转换为 GeoJSON 数据</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FJg0-96t5C2CIlAB5K38kbw" target="_blank" title="https://mp.weixin.qq.com/s/Jg0-96t5C2CIlAB5K38kbw" ref="nofollow noopener noreferrer">GIS 数据转换：使用 GDAL 将 GeoJSON 转换为 Shp 数据</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F5lRetXg_dHYO-ZXKQnbi5Q" target="_blank" title="https://mp.weixin.qq.com/s/5lRetXg_dHYO-ZXKQnbi5Q" ref="nofollow noopener noreferrer">GIS 数据转换：使用 GDAL 将 TXT 转换为 Shp 数据</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[这可能是最懂人话的AI：阿里MAI-UI让手机自动驾驶成真]]></title>    <link>https://juejin.cn/post/7590654280900263979</link>    <guid>https://juejin.cn/post/7590654280900263979</guid>    <pubDate>2026-01-03T13:02:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590654280900263979" data-draft-id="7590421489998151699" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="这可能是最懂人话的AI：阿里MAI-UI让手机自动驾驶成真"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2026-01-03T13:02:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            这可能是最懂人话的AI：阿里MAI-UI让手机自动驾驶成真
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T13:02:56.000Z" title="Sat Jan 03 2026 13:02:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>说实话，我们已经听腻了“AI智能体”这个词。但在大多数时候，所谓的智能体还是像个只会答题的书呆子——你让它写首诗行，但让它帮你用手机订张从北京到上海的高铁票，再顺手发给秘书？它大概率会卡在第一步，或者胡乱点击一通。</p>
<p>为什么？因为它们不懂手机屏幕，也不懂人。</p>
<p>不过，阿里巴巴通义实验室最近扔出的这张王炸——<strong>MAI-UI</strong>，可能真的要改变这个局面了。这不仅仅是一个新的多模态模型，更像是一个给手机装上的“自动驾驶系统”。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2F6390276979052866838949967.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/6390276979052866838949967.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f53fef54055248eabef1f09b98a04cf7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050176&amp;x-signature=Lxwv%2Bfdp2N14XnPoG1zi9ENPaZw%3D" alt="6390276979052866838949967" loading="lazy"/></a></p>
<h2 data-id="heading-0">终于学会了“张嘴问人”</h2>
<p>现在的GUI Agent（图形界面智能体）有个通病：死脑筋。</p>
<p>举个例子，你跟它说：“把我的简历发给HR。” 传统的AI会直接愣住，或者开始在他的训练数据里瞎猜，甚至可能把你的购物清单发出去。</p>
<p>MAI-UI最大的不同在于，它拥有了<strong>原生的人机交互能力</strong>。面对模糊指令，它不会盲目操作，而是会暂停下来问你：“老板，你要发哪一份简历？HR的邮箱是哪个？”</p>
<p>这听起来很简单，但在技术上却是巨大的飞跃。阿里团队在训练中引入了“拒绝采样”和专门的交互动作，治好了AI喜欢“不懂装懂”的毛病。这让它不仅仅是一个执行脚本，更像是一个懂得和你确认需求的真实助理。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2F6390276977443088257701246.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/6390276977443088257701246.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/464943b979be4fb79253c26df536882d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050176&amp;x-signature=%2FOyog8Kd%2BmTmOwg0uZXAwPlTrSY%3D" alt="6390276977443088257701246" loading="lazy"/></a></p>
<h2 data-id="heading-1">抄近道：不只是傻傻点屏幕</h2>
<p>以前的屏幕智能体完全依赖视觉识别——找图标、模拟点击、滑动。这在复杂APP里很容易出错，效率也低。</p>
<p>MAI-UI引入了一个很极客的功能：<strong>MCP工具调用</strong>。</p>
<p>简单说，它是个“双面手”。对于简单的界面，它像人一样去点击；但对于复杂的任务，比如“查询GitHub某仓库的最近提交”或者“计算两地驾车距离”，它会直接跳过繁琐的UI操作，在后台调用API接口（MCP）直接拿数据。</p>
<p>这一招“抄近道”，把原本需要几十次点击、容易出错的流程，压缩成了几次精准的代码调用。在MobileWorld的测试中，这让它的成功率直接甩开了最好的竞争对手30多个百分点。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2Fasfsdgdfg-1024x448.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/asfsdgdfg-1024x448.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26086cf21b9740c98f0fff5fe5a47d3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050176&amp;x-signature=91zeQx0Y1IDMabXwbjI582TDJEU%3D" alt="asfsdgdfg" loading="lazy"/></a></p>
<h2 data-id="heading-2">大小脑配合，隐私也没落下</h2>
<p>把所有操作都交给云端大模型，不仅慢，还让人担心隐私——谁愿意把银行卡密码传到云端去识别？</p>
<p>MAI-UI搞了一套<strong>端云协同</strong>的架构。</p>
<ul>
<li><strong>端侧小模型（2B版本）：</strong> 住在你的手机里，反应快，负责处理日常琐事，盯着屏幕状态，绝不泄露隐私。</li>
<li><strong>云端大模型（235B版本）：</strong> 遇到复杂的逻辑推理难题时，端侧搞不定了，才会请云端的大脑介入。</li>
</ul>
<p>这种动态调度，让端侧任务成功率提升了33%，同时还可以减少40%的云端调用。既省了流量和算力，又保住了你的隐私。</p>
<h2 data-id="heading-3">战绩如何？数据说话</h2>
<p>别光听概念，看看硬指标。在目前的GUI智能体竞技场上，MAI-UI的表现可以用“霸榜”来形容。</p>
<p>在著名的<strong>AndroidWorld</strong>基准测试中，MAI-UI拿下了<strong>76.7%<strong>的成功率。 这个成绩意味着什么？它直接超越了Google的</strong>Gemini-2.5-Pro</strong>，也击败了之前的开源强者<strong>UI-Tars-2</strong>。即便是只有2B参数的端侧小模型，其表现也比同级别的Ferret-UI Lite高出了整整21个百分点。</p>
<p>这背后，是阿里在一个拥有500多个并行环境的“虚拟手机农场”里，通过大规模在线强化学习（Online RL）反复操练的结果。它见识过各种弹窗广告、UI漂移和突发状况，所以比温室里长大的模型更抗造。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2Fasdasddfgsfg.jpg" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/asdasddfgsfg.jpg" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4652c3f24374a2dade0c75619dab6ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050176&amp;x-signature=wcQj1xDs6Rw93IkeXrUd1lKAmxU%3D" alt="asdasddfgsfg" loading="lazy"/></a></p>
<h2 data-id="heading-4">写在最后</h2>
<p>好消息是，通义实验室并没有把这个好东西藏着掖着。目前，<strong>MAI-UI的2B和8B模型权重、代码已经在GitHub开源</strong>，连同那个高难度的评测基准MobileWorld也一并放了出来。</p>
<p>对于开发者来说，这意味着我们离“动动嘴，手机自动帮我搞定一切”的科幻场景，又近了一大步。或许不久的将来，你的手机操作系统里，就住着这样一个不仅看得懂屏幕，还懂得这什么时候该问你、什么时候该自己动手的“真·智能助理”。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用另一种方式让《留白》继续存在下去]]></title>    <link>https://juejin.cn/post/7590592594675449866</link>    <guid>https://juejin.cn/post/7590592594675449866</guid>    <pubDate>2026-01-03T13:16:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590592594675449866" data-draft-id="7590608345923321882" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 用另一种方式让《留白》继续存在下去"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-03T13:16:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="codelang"/> <meta itemprop="url" content="https://juejin.cn/user/184373682638727"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             用另一种方式让《留白》继续存在下去
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/184373682638727/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    codelang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T13:16:00.000Z" title="Sat Jan 03 2026 13:16:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近翻阅相册，旧旧的照片有一张独特的排版，思绪一下就把我拉回了从前，这张照片是《留白》App 编辑生成的，一款非常具有艺术感的 App。《留白》是我前司创始人开发的 App，当时用户量还挺多的，首页还会推荐一些摄影师拍摄的作品。</p>
<p>最近想从 App Store 重新下载把玩下发现，该应用下架很多年了，并且从一些三方渠道拿到的 Apk 都是 32 位的，现在主流的手机已经无法安装了，通过知乎发现，已经很久没有维护了：</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74e38667791f4f02953aaabf7afa0121~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZWxhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050959&amp;x-signature=Z41Ogiw49Fu8sN4sqHgbU%2BqutQ8%3D" alt="" width="50%" loading="lazy"/></p>
<p>这款独特又小众的 App 无法使用着实有点可惜，留白的 preview 页：</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb00349a20b94d2594b4a2308891c7ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZWxhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050959&amp;x-signature=mck2h5tJ621XSN2xKz%2FWJUKX2%2B0%3D" alt="" width="30%" loading="lazy"/></p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b5756d58718459789f3f06c268c0d45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZWxhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050959&amp;x-signature=UDcVQcUKYZXHWj5iGGDUHPEbw0U%3D" alt="" width="30%" loading="lazy"/></p>
<p>所以，我萌生了一个想法，基于强大的 AI 能力，让这款产品重新再现一下，说干就干。</p>
<p>开发步骤：</p>
<ul>
<li>技术选型：最主要是实现快，能快速验证思路与想法，最终敲定下来用 react</li>
<li>AI 编码：最终敲定下来是 claude clode(后文简称 cc) + 智谱 GLM-4.7</li>
<li>部署体验：将 react 部署到线上体验</li>
<li>终极体验：将 react 实现的能力，让 AI 翻译成微信小程序，部署到微信小程序中</li>
</ul>
<p>在技术选型中，我最先思考的是如何快速实现自己想要的效果，相比较知识库与社区的成熟度，对于 AI 来说，生成前端的正确率会比移动端会高点，并且能快速的调试。我将留白 preview 图片丢给了 cc，让 cc 按照该图生成前端应用，并为该图增加了滤镜、字体、主题等一类设置，如下是实现效果，你也可以访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fliubai-white.vercel.app%2F" target="_blank" title="https://liubai-white.vercel.app/" ref="nofollow noopener noreferrer">liubai-white.vercel.app/</a> 进行试玩：</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31964fc0a39548f5ac52c0ae5421a470~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZWxhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050959&amp;x-signature=ioLPMdUyc6mQLDFMPHf5UHbQj8Q%3D" alt="" width="30%" loading="lazy"/></p>
<p>cc + 智谱 GLM-4.7 的生成效果与正确率还是蛮惊艳的，并没有因为一个错误的解决而无限陷入另一种错误。</p>
<p>在经过各种细节与优化中，我发现这种方案可行，但提供网页让用户使用的话，一个是体验不佳，另一个是没有人会记住一个网址，所以，我决定将这个方案的实现迁移到微信小程序。</p>
<p>起初，我了解到 Taro + react 是可以生成微信小程序代码的，我尝试让 cc 将 react 转成 Taro 模式，然后让 Taro 编译 react 代码生成微信小程序项目，但经过我各种调试，都无法达成满意的效果，最主要的原因是 react 很多库的实现，在微信小程序上没有，Taro 无法进行转译，所以，这种方案我立马放弃了。</p>
<p>最终还是直接让 cc 翻译了 react 的项目结构，并生成了项目的功能指南，接着我让 cc 重新创建了个 miniapp 的目录，让他读取 react 代码与功能指南，重新生成微信小程序项目。</p>
<blockquote>
<p><em>未来，AI 也可能是跨端的另一种实现</em></p>
</blockquote>
<p>转义的效果依然非常惊艳，第一把就成功了，预览效果与 react 差不多，但细节还需要再做下处理，本以为没啥大问题，当我将图片下载下来时发现，各种排版错乱。检查了下项目代码实现，在微信小程序中，页面布局的展示是通过 wxml 渲染的，但生成图片是通过 canvas 画的，也就是说，canvas 要对着 wxml 的 css 进行转义，而且 AI 的转义能力特别弱，即使我用 cursor+opus 尝试过，也是一塌糊涂，如果界面渲染排版发生了变动，AI 又会忘了 canvas 也要变动， 在这块的调试上吃了太多力气。那怎么办呢，只能给 cc 添加更多的 rules 规则，去定制规则并且限制他的随意发挥。</p>
<p>经过各种调试对垒，第一版的 留白 微信小程序实现啦，效果图如下：</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed6829a1d65b4f3fbda8401d15784330~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZWxhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050959&amp;x-signature=yq4URonmqcw2Pq%2FfYAvMtyIc5fI%3D" alt="" width="30%" loading="lazy"/></p>
<p>如果你想体验的话，可以扫如下的小程序码：</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b519caccf89c4499bf0250eb2b20b89c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZWxhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050959&amp;x-signature=C6Yr8XXlm93u7GVXEvWr15zSUSI%3D" alt="" width="30%" loading="lazy"/></p>
<p>有任何体验的问题，或是对 AI Coding 有想法的，都可以在公众号中找到我的联系方式。</p>
<p>元旦这三天智谱的 tokens 消耗：</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a30c892a91c24216be5ade417fd9d903~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZWxhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050959&amp;x-signature=NSQhzkjXeKSD6%2F3Ze6RP2GtdNfE%3D" alt="image.png" width="50%" loading="lazy"/></p>
<p>对于 AI Coding ，我有一点想说：</p>
<blockquote>
<p>随着大模型越来越强，我觉得用谁家的模型会变得没那么重要，比如我用的智谱GLM 就能帮我实现非常惊艳的能力，我觉得当前最重要的还是工具，我非常推荐 claude code，Anthropic 这家公司一直走在 AI Coding 的最前沿，无论是 mcp、cli，还是最近非常火热的 skills 、subAgent，他总能从工程化思维去解决你的问题，让 AI 代码生成的更可靠。比如 prompt 的拆解与注入、token 如何减少消耗、上下文污染如何规避等等。</p>
<p>2026 年，AI Coding 一定是往更可靠的大方向走，但要想更可靠，交给开发者肯定是不足够的，一定是有很多工具去辅助开发者更可靠才行。</p>
<p>正如 Anthropic 首席产品官 Mike Krieger 所说的：</p>
<p><strong/> 能可靠地接过你手里的活儿。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025我常用的 AI 产品]]></title>    <link>https://juejin.cn/post/7590309337861373993</link>    <guid>https://juejin.cn/post/7590309337861373993</guid>    <pubDate>2026-01-03T13:40:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590309337861373993" data-draft-id="7590283328176504875" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025我常用的 AI 产品"/> <meta itemprop="keywords" content="程序员,全栈,招聘"/> <meta itemprop="datePublished" content="2026-01-03T13:40:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="KaneLogger"/> <meta itemprop="url" content="https://juejin.cn/user/3650034333917031"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025我常用的 AI 产品
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3650034333917031/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    KaneLogger
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T13:40:34.000Z" title="Sat Jan 03 2026 13:40:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>宗旨：用"好 AI"，用好 AI。</p>
</blockquote>
<p>之前专门写过一篇文章，里面有很多产品，但是品类太多了，其实平时用的也就那么几个，写这篇文章的目的也是总结自己平时使用的产品，以及自己是如何使用的。</p>
<p>在用好 AI 之前，应该多用用业界最好的 AI 产品。</p>
<p>如何知道现在哪类模型好呢？除了用户评价，还可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Flmarena.ai%2Fzh%2Fleaderboard" target="_blank" title="https://lmarena.ai/zh/leaderboard" ref="nofollow noopener noreferrer">lmarena</a> 大模型竞技场上找找，当然最重要的还是多用多体验。</p>
<h3 data-id="heading-0">对话</h3>









































<table><thead><tr><th>平台</th><th>响应速度</th><th>应用场景</th><th>费用</th></tr></thead><tbody><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgemini.google.com%2F" target="_blank" title="https://gemini.google.com/" ref="nofollow noopener noreferrer">Gemini</a></td><td>⭐⭐⭐⭐⭐</td><td>长文本、图片（nano banana）</td><td>Pro 版：140 元/月</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.doubao.com" target="_blank" title="https://www.doubao.com" ref="nofollow noopener noreferrer">豆包</a></td><td>⭐⭐⭐⭐⭐</td><td>日常对话、图片 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fjimeng.jianying.com%2Fai-tool%2Fhome" target="_blank" title="https://jimeng.jianying.com/ai-tool/home" ref="nofollow noopener noreferrer">即梦</a>)</td><td>免费</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.kimi.com" target="_blank" title="https://www.kimi.com" ref="nofollow noopener noreferrer">Kimi</a></td><td>⭐⭐⭐⭐</td><td>长文本</td><td>Andante 49 元/月</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fchat.qwen.ai%2F" target="_blank" title="https://chat.qwen.ai/" ref="nofollow noopener noreferrer">通义千问</a></td><td>⭐⭐⭐⭐⭐</td><td>日常对话、图片</td><td>免费</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fi%2Fgrok" target="_blank" title="https://x.com/i/grok" ref="nofollow noopener noreferrer">Grok</a></td><td>⭐⭐⭐⭐</td><td>特攻：推特爬虫</td><td>免费就够用了</td></tr></tbody></table>
<h3 data-id="heading-1">图像</h3>
<p>这个赛道比较窄，z-image\mj\flux 能用，艺术感强，光影细节处理也很成熟，但是上手成本也比较高，适合专业人士做商业插图。我常用的只有：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgemini.google.com%2Fapp" target="_blank" title="https://gemini.google.com/app" ref="nofollow noopener noreferrer">nano banana</a> 可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Faistudio.google.com%2F" target="_blank" title="https://aistudio.google.com/" ref="nofollow noopener noreferrer">ai studio</a> 中使用，缺点是没有系统给的提示词，也可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fyoumind.com%2Fboards" target="_blank" title="https://youmind.com/boards" ref="nofollow noopener noreferrer">youmind</a> 这些产品中使用。官网每天三张，API 调用，平均一张 2k 图 1 元。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fjimeng.jianying.com%2F" target="_blank" title="https://jimeng.jianying.com/" ref="nofollow noopener noreferrer">即梦</a> 基础会员 69 元/月，每日 60 免费积分，可生成 20-50 张图。</li>
</ul>
<h3 data-id="heading-2">编程</h3>
<ul>
<li>【terminal】Claude code + 国产模型 minmax/kimi k2/GLM-4.6 Pro</li>
<li>【IDE】trae 首月 21rmb/月 后续 70rmb/月</li>
<li>【IDE】cursor 付费 pro 140rmb/月 pro+ 420rmb/月 ultra400rmb/月</li>
<li>【terminal】gemini cli</li>
<li>【IDE】其他偶尔可薅羊毛 qcoder、CodeBuddy、antigravity、kiro、vs code</li>
</ul>
<h3 data-id="heading-3">全家桶</h3>
<ul>
<li>Gemini 全家桶
<ul>
<li>Gemini + nano banana + notebookLM 办公套件</li>
<li>Veo 文生视频</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fstitch.withgoogle.com%2F" target="_blank" title="https://stitch.withgoogle.com/" ref="nofollow noopener noreferrer">stitch</a> Google 推出的 AI 辅助 UI 原型设计工具</li>
<li>antigravity 编辑器</li>
<li>gemini cli 终端工具</li>
</ul>
</li>
<li>豆包 全家桶
<ul>
<li>豆包</li>
<li>seedream 文生图</li>
<li>seedance 文生视频</li>
<li>trae 编辑器</li>
</ul>
</li>
<li>gpt 全家桶
<ul>
<li>chatGPT 对话、图片</li>
<li>sora 视频</li>
<li>codex</li>
</ul>
</li>
</ul>
<h3 data-id="heading-4">我的订阅</h3>
<ul>
<li>对话(画图)部分：Gemini + 豆包 + kimi + 偶尔 qwen + 爬虫 Grok</li>
<li>编程：claude code(minmax) + cursor</li>
<li>知识库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnotebooklm.google.com%2F" target="_blank" title="https://notebooklm.google.com/" ref="nofollow noopener noreferrer">notebookLM(ppt 思维导图)</a> + <a href="https://link.juejin.cn?target=https%3A%2F%2Fima.qq.com%2F" target="_blank" title="https://ima.qq.com/" ref="nofollow noopener noreferrer">ima（知识库管理）</a> + <a href="https://link.juejin.cn?target=https%3A%2F%2Fyoumind.com%2Fzh-CN%2F" target="_blank" title="https://youmind.com/zh-CN/" ref="nofollow noopener noreferrer">youmind（整理碎片想法信息）</a></li>
<li>工作流：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.coze.cn%2F" target="_blank" title="https://www.coze.cn/" ref="nofollow noopener noreferrer">coze(配合飞书)</a> + <a href="https://link.juejin.cn?target=https%3A%2F%2Fn8n.io%2F" target="_blank" title="https://n8n.io/" ref="nofollow noopener noreferrer">n8n（本地工作流）</a></li>
</ul>
<h4 data-id="heading-5">智能体</h4>
<p>还没花过钱，基本上用在研报上。</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fspace.coze.cn%2Fspace-intro" target="_blank" title="https://space.coze.cn/space-intro" ref="nofollow noopener noreferrer">扣子空间</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.manus.ai%2F" target="_blank" title="https://www.manus.ai/" ref="nofollow noopener noreferrer">manus</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fautoglm.zhipuai.cn%2F" target="_blank" title="https://autoglm.zhipuai.cn/" ref="nofollow noopener noreferrer">AutoGLM</a></li>
<li>【DeepResearch】<a href="https://link.juejin.cn?target=https%3A%2F%2Fithy.com%2F" target="_blank" title="https://ithy.com/" ref="nofollow noopener noreferrer">ithy</a></li>
<li>【DeepResearch】<a href="https://link.juejin.cn?target=https%3A%2F%2Fmetaso.cn%2F" target="_blank" title="https://metaso.cn/" ref="nofollow noopener noreferrer">秘塔</a></li>
<li>【DeepResearch】<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.perplexity.ai%2F" target="_blank" title="https://www.perplexity.ai/" ref="nofollow noopener noreferrer">Perplexity（国外网站）</a></li>
<li>【DeepResearch】<a href="https://link.juejin.cn?target=https%3A%2F%2Fmetaso.cn%2F" target="_blank" title="https://metaso.cn/" ref="nofollow noopener noreferrer">秘塔 AI 搜索</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于 YOLOv8 的共享单车乱停放智能识别系统— 从数据集构建到可视化部署的完整项目]]></title>    <link>https://juejin.cn/post/7590330924001148991</link>    <guid>https://juejin.cn/post/7590330924001148991</guid>    <pubDate>2026-01-03T12:05:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590330924001148991" data-draft-id="7590283328176422955" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于 YOLOv8 的共享单车乱停放智能识别系统— 从数据集构建到可视化部署的完整项目"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-03T12:05:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我是杰尼"/> <meta itemprop="url" content="https://juejin.cn/user/4200579899599495"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于 YOLOv8 的共享单车乱停放智能识别系统— 从数据集构建到可视化部署的完整项目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4200579899599495/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我是杰尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T12:05:46.000Z" title="Sat Jan 03 2026 12:05:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">基于 YOLOv8 的共享单车乱停放智能识别系统— 从数据集构建到可视化部署的完整项目</h2>
<h3 data-id="heading-1">一、项目背景：为什么要做“乱停放识别”？</h3>
<p>随着共享单车在城市中的高密度投放，“最后一公里”出行问题得到了极大缓解，但随之而来的<strong>随意停放、占道堆积、盲道阻塞</strong>等问题，也成为城市治理中的一大痛点。</p>
<p>在实际城市管理中，传统处理方式主要依赖以下手段：</p>
<ul>
<li>人工巡查（成本高、效率低）</li>
<li>群众举报（滞后、不可控）</li>
<li>简单规则检测（误报率高）</li>
</ul>
<p>这些方式很难应对<strong>大规模、全天候、动态变化</strong>的街景环境。因此，<strong>基于计算机视觉的自动化识别方案</strong>成为一种必然选择。</p>
<p>本项目的目标是：</p>
<blockquote>
<p>🎯 <strong>构建一套完整、可落地的共享单车/自行车乱停放智能识别系统</strong>
覆盖：<strong>数据 → 训练 → 推理 → UI → 部署</strong>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3a011a718814ebebcfa89fa2a0d3276~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768046746&amp;x-signature=EMuSVG2QJHBt%2BMjPU6xwCqk0938%3D" alt="在这里插入图片描述" loading="lazy"/></p>
</blockquote>
<h4 data-id="heading-2">源码下载与效果演示</h4>
<p>哔哩哔哩视频下方观看：</p>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1HxKbzSEco%2F" target="_blank" title="https://www.bilibili.com/video/BV1HxKbzSEco/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1Hx…</a></p>
</blockquote>
<p>包含：</p>
<p>📦完整项目源码</p>
<p>📦 预训练模型权重</p>
<p>🗂️ 数据集地址（含标注脚本</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ae2a78a2ee443b49eead838e20fbf1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768046746&amp;x-signature=YnLoovTWrUtxjAbHV5GXDljxZWU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-3">二、系统总体设计思路</h3>
<p>从工程角度出发，本项目并非“单一模型测试”，而是完整的软件系统，整体架构如下：</p>
<pre><code class="hljs language-markdown" lang="markdown">数据采集 → 数据标注 → YOLOv8模型训练
<span class="hljs-code">        ↓
   模型评估与调优
        ↓
PyQt5 可视化检测系统
        ↓
图片 / 视频 / 摄像头 / 批量检测
</span></code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02eadcd68dd64b5ab658d627540a6c80~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768046746&amp;x-signature=bCht76tGG1NlMQ96bRbU4kutmjU%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/124b8b176c804f628f43cb20330e1206~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768046746&amp;x-signature=YWdzfvfft27MtoRLQnhi7hc2DLk%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-4">系统核心组成模块</h4>

































<table><thead><tr><th>模块</th><th>说明</th></tr></thead><tbody><tr><td>目标检测模型</td><td>YOLOv8 Detection</td></tr><tr><td>深度学习框架</td><td>PyTorch</td></tr><tr><td>图形界面</td><td>PyQt5</td></tr><tr><td>推理方式</td><td>图片 / 文件夹 / 视频 / 摄像头</td></tr><tr><td>输出形式</td><td>标注图像 / 视频文件</td></tr><tr><td>使用方式</td><td>开箱即用 / 可二次开发</td></tr></tbody></table>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90dbc7fbcbf448e29f1210bcd805b078~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768046746&amp;x-signature=8BfBVWK6S4uGZRVSOaHbnEgsl2o%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-5">三、YOLOv8 模型选型与原理分析</h3>
<h4 data-id="heading-6">3.1 为什么选择 YOLOv8？</h4>
<p>在众多目标检测模型中（Faster R-CNN、SSD、YOLOv5/7 等），YOLOv8 具备以下明显优势：</p>
<ul>
<li><strong>Anchor-Free 架构</strong>：减少人为超参依赖</li>
<li><strong>更高的推理速度</strong>：适合实时摄像头场景</li>
<li><strong>Ultralytics 官方生态完善</strong>：训练、推理、导出一步到位</li>
<li><strong>对小目标更友好</strong>：适合街景中密集单车检测</li>
</ul>
<h4 data-id="heading-7">3.2 YOLOv8 Detection 架构概览</h4>
<p>YOLOv8 仍然遵循经典的三段式结构：</p>
<ul>
<li><strong>Backbone</strong>：特征提取（C2f + CSP 思想）</li>
<li><strong>Neck</strong>：多尺度特征融合（FPN + PAN）</li>
<li><strong>Head</strong>：Anchor-Free 检测头</li>
</ul>
<p>其核心改进点在于：</p>
<ul>
<li>Task-Aligned Assigner</li>
<li>解耦式检测头</li>
<li>DFL（Distribution Focal Loss）</li>
</ul>
<p>这些设计显著提升了模型在复杂场景下的稳定性。</p>
<hr/>
<h3 data-id="heading-8">四、数据集构建与标注规范</h3>
<h4 data-id="heading-9">4.1 数据来源与采集</h4>
<p>数据主要来自：</p>
<ul>
<li>城市街景实拍</li>
<li>公共道路监控截图</li>
<li>不同天气 / 光照 / 角度场景</li>
</ul>
<p>重点覆盖以下情况：</p>
<ul>
<li>随意堆叠停放</li>
<li>占用盲道、人行道</li>
<li>路口密集区域</li>
<li>单车与背景高度相似场景</li>
</ul>
<h4 data-id="heading-10">4.2 YOLO 数据集结构</h4>
<p>采用标准 YOLOv8 数据集格式：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">dataset/
├── images/
│   ├── train/
│   └── <span class="hljs-keyword">val</span>/
├── labels/
│   ├── train/
│   └── <span class="hljs-keyword">val</span>/
</code></pre>
<h4 data-id="heading-11">4.3 标注格式说明</h4>
<p>每一行标签格式如下：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">class_id</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">x_center</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">y_center</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">width</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">height</span>&gt;</span>
</code></pre>
<p>坐标全部采用 <strong>归一化比例值</strong>，便于模型泛化。</p>
<hr/>
<h3 data-id="heading-12">五、模型训练流程与参数配置</h3>
<h4 data-id="heading-13">5.1 训练命令示例</h4>
<pre><code class="hljs language-bash" lang="bash">yolo detect train \
  data=dataset/bike.yaml \
  model=yolov8n.pt \
  epochs=100 \
  batch=16 \
  imgsz=640 \
  lr0=0.001
</code></pre>
<h4 data-id="heading-14">5.2 训练过程关注指标</h4>
<ul>
<li>box_loss（定位误差）</li>
<li>cls_loss（分类误差）</li>
<li>dfl_loss（边界框分布）</li>
<li>mAP@0.5 / mAP@0.5:0.95</li>
</ul>
<blockquote>
<p>在实验中，当 mAP@0.5 稳定在 <strong>90% 以上</strong>，模型已具备实际部署价值。</p>
</blockquote>
<hr/>
<h3 data-id="heading-15">六、模型推理与检测结果分析</h3>
<h4 data-id="heading-16">6.1 Python 推理示例</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> ultralytics <span class="hljs-keyword">import</span> YOLO

model = YOLO(<span class="hljs-string">"best.pt"</span>)
results = model(<span class="hljs-string">"test.jpg"</span>, conf=<span class="hljs-number">0.25</span>, save=<span class="hljs-literal">True</span>)
</code></pre>
<h4 data-id="heading-17">6.2 输出结果内容</h4>
<ul>
<li>检测框位置</li>
<li>类别名称</li>
<li>置信度评分</li>
<li>自动保存标注图像</li>
</ul>
<p>模型在复杂街景、遮挡场景下仍能保持较好鲁棒性。</p>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ab73f230ad842a8ad2bbe8bce614cc4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768046746&amp;x-signature=hJZBS6Qioq1WdLE72RqO69jOOYU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-18">七、PyQt5 可视化检测系统设计</h3>
<h4 data-id="heading-19">7.1 为什么要做 GUI？</h4>
<p>对于实际使用者（城管、运营人员、学生演示）来说：</p>
<blockquote>
<p>❌ 命令行 ≠ 易用
✅ 可视化界面 = 真正可用系统</p>
</blockquote>
<h4 data-id="heading-20">7.2 支持功能一览</h4>
<ul>
<li>📷 单张图片检测</li>
<li>📁 文件夹批量检测</li>
<li>🎞️ 视频文件检测</li>
<li>🎥 实时摄像头检测</li>
<li>💾 结果保存开关</li>
</ul>
<h4 data-id="heading-21">7.3 系统运行方式</h4>
<pre><code class="hljs language-bash" lang="bash">python main.py
</code></pre>
<p>无需任何深度学习基础，即可完成检测。</p>
<hr/>
<h3 data-id="heading-22">八、工程落地与应用场景</h3>
<p>本系统可直接应用于：</p>
<ul>
<li>🚦 城市智慧城管</li>
<li>🏙️ 智慧园区管理</li>
<li>🚴‍♂️ 共享单车运维监管</li>
<li>🎓 计算机视觉教学/毕设</li>
</ul>
<p>同时，该项目也可作为 <strong>YOLOv8 + GUI 工程模板</strong>，快速迁移到其他检测任务。</p>
<hr/>
<h3 data-id="heading-23">九、完整源码与资源说明</h3>
<p>项目已打包提供：</p>
<ul>
<li>✔️ 完整训练代码</li>
<li>✔️ 数据集与标注</li>
<li>✔️ 训练权重文件</li>
<li>✔️ PyQt5 可视化系统</li>
<li>✔️ 一键运行脚本</li>
</ul>
<p>适合：</p>
<blockquote>
<p>毕业设计 / 科研实验 / 技术复现 / 二次开发</p>
</blockquote>
<hr/>
<h3 data-id="heading-24">十、总结</h3>
<p>本项目不仅是一次 YOLOv8 模型实践，更是一套<strong>从算法到系统、从实验到落地</strong>的完整工程方案。</p>
<p>如果你希望：</p>
<ul>
<li>系统性掌握目标检测工程</li>
<li>做一个“真正能跑”的 AI 项目</li>
<li>拥有可展示、可部署、可扩展的成果</li>
</ul>
<p>那么，这个项目会是一个非常理想的起点。</p>
<p>本文围绕共享单车/自行车乱停放这一典型的城市治理痛点，完整介绍了一套基于 YOLOv8 目标检测模型 + PyQt5 可视化界面 的智能识别系统。从问题背景出发，系统性地阐述了模型选型理由、数据集构建方式、训练与评估流程，以及多输入源（图片、视频、摄像头、批量文件）的工程化落地实现。该项目不仅在算法层面验证了 YOLOv8 在复杂街景下的高精度与实时性优势，更通过图形化界面降低了使用门槛，使模型真正具备可部署、可使用、可扩展的工程价值。整体方案兼顾技术深度与实用性，既可直接应用于智慧城管与共享单车监管场景，也可作为目标检测教学、毕业设计和二次开发的完整实践范例。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于大模型的智能读报助手]]></title>    <link>https://juejin.cn/post/7590330924001165375</link>    <guid>https://juejin.cn/post/7590330924001165375</guid>    <pubDate>2026-01-03T12:10:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590330924001165375" data-draft-id="7590309337861226537" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于大模型的智能读报助手"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-03T12:10:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Livingbody"/> <meta itemprop="url" content="https://juejin.cn/user/4213771487417944"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于大模型的智能读报助手
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4213771487417944/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Livingbody
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T12:10:10.000Z" title="Sat Jan 03 2026 12:10:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、《人民日报》工具箱简介</h2>
<p>这是一个用于人民日报PDF完整工作流程的Python工具集，支持从网站下载、文本提取到AI智能分析的全流程处理。</p>
<h3 data-id="heading-1">1.🎯 功能特性</h3>
<h4 data-id="heading-2">1.1📥 <strong>PDF下载功能</strong></h4>
<ul>
<li>🌐 自动从人民日报官网下载指定日期的PDF版报纸</li>
<li>📄 自动检测报纸版面数量（通常8-16版）</li>
<li>🔄 智能合并多个版面为一个完整的PDF文件</li>
<li>⏰ 支持指定日期下载和批量下载</li>
</ul>
<h4 data-id="heading-3">1.2📖 <strong>PDF文本提取</strong></h4>
<ul>
<li>🔍 使用PyPDF2库精确提取PDF文件中的文本内容</li>
<li>📝 处理各种PDF格式和编码</li>
<li>🛡️ 容错处理，防止提取失败影响整体流程</li>
</ul>
<h4 data-id="heading-4">1.3🤖 <strong>AI智能分析</strong></h4>
<ul>
<li>🧠 基于大语言模型对人民日报内容进行深度分析</li>
<li>📊 自动分类识别：重大事件、评论文章、金句典故、优秀词组</li>
<li>📋 生成结构化的Markdown格式分析报告</li>
<li>💡 支持流式输出，实时显示分析过程</li>
</ul>
<h3 data-id="heading-5">2.🎯 扩展用例</h3>
<ul>
<li>🧠 手机端定时爬取《人民日报》，如每天早晨7:00爬取当日《人民日报》</li>
<li>📊 自动分析当日报纸精华，并存入obsidian笔记</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29815171f81744d0b647e45d3e516d89~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGl2aW5nYm9keQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768047203&amp;x-signature=qspHGVvg7x4C9cnYPre%2BWPtg4FY%3D" alt="" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d31ca22469dd4c02bfe394be5545c8df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGl2aW5nYm9keQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768047203&amp;x-signature=JxK8BTyq3T44tAzyaeiPhENcMFk%3D" alt="" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c6db3ba59ad45b7bc93b83fe7875aed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGl2aW5nYm9keQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768047203&amp;x-signature=LpiBytdhBlmAathg%2Byif5NALMW0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">3.🏗️ 项目结构</h3>
<pre><code class="hljs language-bash" lang="bash">xx/
├── rmrb_down.py              <span class="hljs-comment"># 人民日报PDF下载工具</span>
├── readpdf.py                <span class="hljs-comment"># PDF文本提取工具  </span>
├── note_for_rmrb.py          <span class="hljs-comment"># 人民日报AI智能分析工具</span>
├── requirements.txt          <span class="hljs-comment"># 项目依赖列表</span>
├── README.md                <span class="hljs-comment"># 项目说明文档</span>
└── storage/
    └── downloads/
        └── rmrb/            <span class="hljs-comment"># 下载的PDF文件存储目录</span>
            └── rmrb_YYYY-MM-DD.pdf
└── 人民日报_YYYY-MM-DD.md    <span class="hljs-comment"># AI分析结果输出文件</span>
</code></pre>
<h2 data-id="heading-7">二、安装说明</h2>
<h3 data-id="heading-8">1. 环境准备</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 确保Python版本 &gt;= 3.7</span>
python --version
</code></pre>
<h3 data-id="heading-9">2. 克隆项目</h3>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/livingbody/People_Daily_Toolkit
<span class="hljs-built_in">cd</span> People_Daily_Toolkit
</code></pre>
<h3 data-id="heading-10">3. 安装依赖</h3>
<pre><code class="hljs language-bash" lang="bash">pip install -r requirements.txt
</code></pre>
<p><strong>依赖库列表</strong>：</p>
<ul>
<li><code>requests==2.31.0</code> - HTTP请求库，用于网页抓取</li>
<li><code>beautifulsoup4==4.12.2</code> - HTML解析库，用于网页内容解析</li>
<li><code>PyPDF2==3.0.1</code> - PDF处理库，用于文件读取和合并</li>
<li><code>openai==1.58.1</code> - OpenAI API库，用于大模型调用</li>
</ul>
<pre><code class="hljs language-python" lang="python">!git clone https://github.com/livingbody/People_Daily_Toolkit
!pip install -r People_Daily_Toolkit/requirements.txt
</code></pre>
<h2 data-id="heading-11">三、使用方法</h2>
<h3 data-id="heading-12">1.报纸PDF下载</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 本项目用于从人民日报网站下载指定日期的PDF版报纸，并将多个版面合并为一个完整的PDF文件</span>
<span class="hljs-comment"># 作者: livingbody</span>
<span class="hljs-comment"># pip install requests beautifulsoup4 PyPDF2</span>

<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">from</span> bs4 <span class="hljs-keyword">import</span> BeautifulSoup
<span class="hljs-keyword">import</span> PyPDF2
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> date, datetime, timedelta
<span class="hljs-keyword">import</span> re


<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_page_count</span>(<span class="hljs-params">url</span>):
    <span class="hljs-string">"""
    获取报纸的总版面数
    
    参数:
        url: 报纸版面目录页的URL
    
    返回值:
        int: 总版面数
    """</span>
    <span class="hljs-keyword">try</span>:
        response = requests.get(url, timeout=<span class="hljs-number">10</span>)
        response.encoding = <span class="hljs-string">'utf-8'</span>
        soup = BeautifulSoup(response.text, <span class="hljs-string">'html.parser'</span>)
        
        <span class="hljs-comment"># 查找所有版面链接</span>
        page_links = soup.find_all(<span class="hljs-string">'a'</span>, href=<span class="hljs-keyword">lambda</span> x: x <span class="hljs-keyword">and</span> <span class="hljs-string">'node_'</span> <span class="hljs-keyword">in</span> x <span class="hljs-keyword">and</span> <span class="hljs-string">'.html'</span> <span class="hljs-keyword">in</span> x)
        
        <span class="hljs-comment"># 提取版面编号并找到最大的编号</span>
        max_page = <span class="hljs-number">0</span>
        <span class="hljs-keyword">for</span> link <span class="hljs-keyword">in</span> page_links:
            <span class="hljs-keyword">match</span> = re.search(<span class="hljs-string">r'node_(\d+)\.html'</span>, link.get(<span class="hljs-string">'href'</span>))
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>:
                page_num = <span class="hljs-built_in">int</span>(<span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>))
                max_page = <span class="hljs-built_in">max</span>(max_page, page_num)
                
        <span class="hljs-keyword">return</span> max_page
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"获取版面数量失败: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-number">8</span>  <span class="hljs-comment"># 默认返回8版</span>


<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_pdf_urls</span>(<span class="hljs-params">base_url, date_str</span>):
    <span class="hljs-string">"""
    获取所有版面的PDF文件URL
    
    参数:
        base_url: 人民日报网站的基础URL
        date_str: 日期字符串，格式为'YYYY-MM-DD'
    
    返回值:
        list: PDF文件URL列表
    """</span>
    year, month, day = date_str.split(<span class="hljs-string">'-'</span>)
    
    <span class="hljs-comment"># 构建版面目录页URL</span>
    catalog_url = <span class="hljs-string">f"<span class="hljs-subst">{base_url}</span>/rmrb/pc/layout/<span class="hljs-subst">{year}</span><span class="hljs-subst">{month}</span>/<span class="hljs-subst">{day}</span>/node_01.html"</span>
    
    <span class="hljs-comment"># 获取版面数量</span>
    page_count = get_page_count(catalog_url)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"发现 <span class="hljs-subst">{page_count}</span> 个版面"</span>)
    
    pdf_urls = []
    
    <span class="hljs-comment"># 遍历所有版面</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, page_count + <span class="hljs-number">1</span>):
        <span class="hljs-comment"># 构建当前版面的URL</span>
        page_url = <span class="hljs-string">f"<span class="hljs-subst">{base_url}</span>/rmrb/pc/layout/<span class="hljs-subst">{year}</span><span class="hljs-subst">{month}</span>/<span class="hljs-subst">{day}</span>/node_<span class="hljs-subst">{i:02d}</span>.html"</span>
        
        <span class="hljs-keyword">try</span>:
            response = requests.get(page_url, timeout=<span class="hljs-number">10</span>)
            response.encoding = <span class="hljs-string">'utf-8'</span>
            soup = BeautifulSoup(response.text, <span class="hljs-string">'html.parser'</span>)
            
            <span class="hljs-comment"># 查找PDF链接</span>
            pdf_link = soup.find(<span class="hljs-string">'a'</span>, href=<span class="hljs-keyword">lambda</span> x: x <span class="hljs-keyword">and</span> x.endswith(<span class="hljs-string">'.pdf'</span>))
            
            <span class="hljs-keyword">if</span> pdf_link:
                pdf_href = pdf_link.get(<span class="hljs-string">'href'</span>)
                <span class="hljs-comment"># 如果是相对URL，则构建绝对URL</span>
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> pdf_href.startswith(<span class="hljs-string">'http'</span>):
                    <span class="hljs-keyword">if</span> pdf_href.startswith(<span class="hljs-string">'/'</span>):
                        pdf_href = base_url + pdf_href
                    <span class="hljs-keyword">else</span>:
                        pdf_href = <span class="hljs-string">f"<span class="hljs-subst">{base_url}</span>/rmrb/pc/layout/<span class="hljs-subst">{year}</span><span class="hljs-subst">{month}</span>/<span class="hljs-subst">{day}</span>/<span class="hljs-subst">{pdf_href}</span>"</span>
                
                pdf_urls.append(pdf_href)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"找到版面 <span class="hljs-subst">{i}</span> 的PDF链接: <span class="hljs-subst">{pdf_href}</span>"</span>)
            <span class="hljs-keyword">else</span>:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"未找到版面 <span class="hljs-subst">{i}</span> 的PDF链接"</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"获取版面 <span class="hljs-subst">{i}</span> 的PDF链接失败: <span class="hljs-subst">{e}</span>"</span>)
            
    <span class="hljs-keyword">return</span> pdf_urls


<span class="hljs-keyword">def</span> <span class="hljs-title function_">download_pdfs</span>(<span class="hljs-params">pdf_urls, date_str</span>):
    <span class="hljs-string">"""
    下载所有PDF文件
    
    参数:
        pdf_urls: PDF文件URL列表
        date_str: 日期字符串，用于命名下载的文件
    
    返回值:
        list: 下载的PDF文件路径列表
    """</span>
    downloaded_files = []
    
    <span class="hljs-comment"># 创建临时目录存储下载的文件</span>
    temp_dir = <span class="hljs-string">f"temp_pdfs_<span class="hljs-subst">{date_str}</span>"</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(temp_dir):
        os.makedirs(temp_dir)
    
    <span class="hljs-comment"># 下载每个PDF文件</span>
    <span class="hljs-keyword">for</span> i, pdf_url <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(pdf_urls):
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 构建保存的文件名</span>
            file_name = <span class="hljs-string">f"<span class="hljs-subst">{temp_dir}</span>/rmrb_<span class="hljs-subst">{date_str}</span>_<span class="hljs-subst">{i+<span class="hljs-number">1</span>:02d}</span>.pdf"</span>
            
            <span class="hljs-comment"># 下载文件</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"开始下载版面 <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span> 的PDF文件..."</span>)
            response = requests.get(pdf_url, timeout=<span class="hljs-number">30</span>)
            
            <span class="hljs-comment"># 保存文件</span>
            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_name, <span class="hljs-string">'wb'</span>) <span class="hljs-keyword">as</span> f:
                f.write(response.content)
            
            downloaded_files.append(file_name)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"版面 <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span> 的PDF文件下载完成: <span class="hljs-subst">{file_name}</span>"</span>)
            
            <span class="hljs-comment"># 添加下载间隔，避免请求过于频繁</span>
            time.sleep(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"下载版面 <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span> 的PDF文件失败: <span class="hljs-subst">{e}</span>"</span>)
    
    <span class="hljs-keyword">return</span> downloaded_files


<span class="hljs-keyword">def</span> <span class="hljs-title function_">merge_pdfs</span>(<span class="hljs-params">pdf_files, output_file</span>):
    <span class="hljs-string">"""
    合并多个PDF文件为一个
    
    参数:
        pdf_files: 要合并的PDF文件路径列表
        output_file: 合并后的输出文件路径
    
    返回值:
        bool: 合并是否成功
    """</span>
    <span class="hljs-keyword">try</span>:
        pdf_writer = PyPDF2.PdfWriter()
        
        <span class="hljs-comment"># 遍历每个PDF文件</span>
        <span class="hljs-keyword">for</span> pdf_file <span class="hljs-keyword">in</span> pdf_files:
            <span class="hljs-keyword">try</span>:
                pdf_reader = PyPDF2.PdfReader(pdf_file, strict=<span class="hljs-literal">False</span>)
                
                <span class="hljs-comment"># 添加每一页到写入器</span>
                <span class="hljs-keyword">for</span> page_num <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(pdf_reader.pages)):
                    pdf_writer.add_page(pdf_reader.pages[page_num])
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"读取文件 <span class="hljs-subst">{pdf_file}</span> 失败: <span class="hljs-subst">{e}</span>"</span>)
        
        <span class="hljs-comment"># 写入合并后的文件</span>
        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(output_file, <span class="hljs-string">'wb'</span>) <span class="hljs-keyword">as</span> out:
            pdf_writer.write(out)
        
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"PDF文件合并完成: <span class="hljs-subst">{output_file}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"PDF文件合并失败: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>


<span class="hljs-keyword">def</span> <span class="hljs-title function_">clean_temp_files</span>(<span class="hljs-params">temp_files</span>):
    <span class="hljs-string">"""
    清理临时文件
    
    参数:
        temp_files: 临时文件路径列表
    """</span>
    <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> temp_files:
        <span class="hljs-keyword">try</span>:
            os.remove(file)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"删除临时文件 <span class="hljs-subst">{file}</span> 失败: <span class="hljs-subst">{e}</span>"</span>)
    
    <span class="hljs-comment"># 尝试删除临时目录</span>
    <span class="hljs-keyword">if</span> temp_files:
        temp_dir = os.path.dirname(temp_files[<span class="hljs-number">0</span>])
        <span class="hljs-keyword">try</span>:
            os.rmdir(temp_dir)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"删除临时目录 <span class="hljs-subst">{temp_dir}</span> 失败: <span class="hljs-subst">{e}</span>"</span>)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">download_rmrb_pdf</span>(<span class="hljs-params">date_str=<span class="hljs-literal">None</span>, base_url=<span class="hljs-string">"https://paper.people.com.cn"</span></span>):
    <span class="hljs-string">"""
    下载指定日期的人民日报PDF并合并
    
    参数:
        date_str: 日期字符串，格式为'YYYY-MM-DD'，默认为当天
        base_url: 人民日报网站的基础URL
    
    返回值:
        str: 合并后的PDF文件路径，如果失败则返回None
    """</span>
    <span class="hljs-comment"># 如果未指定日期，则使用当天日期</span>
    <span class="hljs-keyword">if</span> date_str <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
        date_str = datetime.now().strftime(<span class="hljs-string">'%Y-%m-%d'</span>)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"开始下载 <span class="hljs-subst">{date_str}</span> 的人民日报PDF..."</span>)
    
    <span class="hljs-comment"># 获取所有版面的PDF链接</span>
    pdf_urls = get_pdf_urls(base_url, date_str)
    
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> pdf_urls:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"未找到任何PDF链接，下载失败"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
    
    <span class="hljs-comment"># 下载PDF文件</span>
    downloaded_files = download_pdfs(pdf_urls, date_str)
    
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> downloaded_files:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"所有PDF文件下载失败"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
    
    <span class="hljs-comment"># 构建输出文件名</span>
    output_file = <span class="hljs-string">f"rmrb_<span class="hljs-subst">{date_str}</span>.pdf"</span>
    
    <span class="hljs-comment"># 合并PDF文件</span>
    <span class="hljs-keyword">if</span> merge_pdfs(downloaded_files, output_file):
        <span class="hljs-comment"># 清理临时文件</span>
        clean_temp_files(downloaded_files)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"人民日报 <span class="hljs-subst">{date_str}</span> PDF下载和合并完成！"</span>)
        <span class="hljs-keyword">return</span> output_file
    <span class="hljs-keyword">else</span>:
        <span class="hljs-comment"># 即使合并失败，也清理临时文件</span>
        clean_temp_files(downloaded_files)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 示例用法：下载当天的人民日报PDF</span>
    <span class="hljs-comment"># 如果需要下载特定日期的报纸，可以传入日期参数，例如：download_rmrb_pdf('2025-09-29')</span>
    <span class="hljs-comment"># 如果未指定日期，则使用当天日期</span>
    today=datetime.now()
    download_rmrb_pdf()
 
</code></pre>
<pre><code class="hljs language-bash" lang="bash">开始下载 2026-01-03 的人民日报PDF...
发现 8 个版面
找到版面 1 的PDF链接: https://paper.people.com.cn/rmrb/pc/layout/202601/03/../../../attachement/202601/03/a34b8d91-e465-4b84-9c08-c07900f5d536.pdf
找到版面 2 的PDF链接: https://paper.people.com.cn/rmrb/pc/layout/202601/03/../../../attachement/202601/03/dee045f0-a680-450a-933d-03b6b038ee3d.pdf
找到版面 3 的PDF链接: https://paper.people.com.cn/rmrb/pc/layout/202601/03/../../../attachement/202601/03/0c5046c0-6919-4194-931b-145f8e7fa90f.pdf
找到版面 4 的PDF链接: https://paper.people.com.cn/rmrb/pc/layout/202601/03/../../../attachement/202601/03/1c61519d-506a-4c83-925d-b9c79e7609f7.pdf
找到版面 5 的PDF链接: https://paper.people.com.cn/rmrb/pc/layout/202601/03/../../../attachement/202601/03/7a2392d1-d4fb-4b9d-93e3-28ed039d1de3.pdf
找到版面 6 的PDF链接: https://paper.people.com.cn/rmrb/pc/layout/202601/03/../../../attachement/202601/03/32f4a6e9-3959-411a-bcaf-ebf638a7239c.pdf
找到版面 7 的PDF链接: https://paper.people.com.cn/rmrb/pc/layout/202601/03/../../../attachement/202601/03/a864bc77-c935-4d50-b3ce-5e9eb8ba2fc2.pdf
找到版面 8 的PDF链接: https://paper.people.com.cn/rmrb/pc/layout/202601/03/../../../attachement/202601/03/1c86d66b-66c3-4633-9b78-0c85e34d23a8.pdf
开始下载版面 1 的PDF文件...
版面 1 的PDF文件下载完成: temp_pdfs_2026-01-03/rmrb_2026-01-03_01.pdf
开始下载版面 2 的PDF文件...
版面 2 的PDF文件下载完成: temp_pdfs_2026-01-03/rmrb_2026-01-03_02.pdf
开始下载版面 3 的PDF文件...
版面 3 的PDF文件下载完成: temp_pdfs_2026-01-03/rmrb_2026-01-03_03.pdf
开始下载版面 4 的PDF文件...
版面 4 的PDF文件下载完成: temp_pdfs_2026-01-03/rmrb_2026-01-03_04.pdf
开始下载版面 5 的PDF文件...
版面 5 的PDF文件下载完成: temp_pdfs_2026-01-03/rmrb_2026-01-03_05.pdf
开始下载版面 6 的PDF文件...
版面 6 的PDF文件下载完成: temp_pdfs_2026-01-03/rmrb_2026-01-03_06.pdf
开始下载版面 7 的PDF文件...
版面 7 的PDF文件下载完成: temp_pdfs_2026-01-03/rmrb_2026-01-03_07.pdf
开始下载版面 8 的PDF文件...
版面 8 的PDF文件下载完成: temp_pdfs_2026-01-03/rmrb_2026-01-03_08.pdf

PDF文件合并完成: rmrb_2026-01-03.pdf
人民日报 2026-01-03 PDF下载和合并完成！
</code></pre>
<p>根据日志可见：</p>
<ul>
<li>按照版面依次下载pdf文件</li>
<li>合并所有版面成报纸
另外保存目录等自己可以调整。</li>
</ul>
<h3 data-id="heading-13">2.使用ERNIE大模型对《人民日报》进行智能分析</h3>
<h4 data-id="heading-14">2.1 读取PDF</h4>
<pre><code class="hljs">从PDF文件中提取文本内容， 使用PyPDF2库读取PDF文件，提取所有页面的文本内容，各页面文本用单换行符连接。
</code></pre>
<h4 data-id="heading-15">2.2 使用ERNIE大语言模型对文本内容进行智能分析</h4>
<p>主要完成下列任务：</p>
<ul>
<li>1.报纸中出现的重大事件；</li>
<li>2.评论员文章；</li>
<li>3.金句、典故、古语；</li>
<li>4.优秀词组、新词。</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># -*- coding: utf-8 -*-</span>
<span class="hljs-string">"""
人民日报PDF智能分析工具
=========================

这个模块提供了对人民日报PDF文件的智能分析功能，能够：
1. 自动提取PDF文本内容
2. 使用大语言模型进行智能分析
3. 生成结构化的分析报告

主要功能：
- 提取人民日报PDF文本
- AI智能分析识别重大事件、评论文章、金句典故、优秀词组
- 生成Markdown格式的分析报告
- 自动按日期命名输出文件

依赖库：
- PyPDF2: PDF文件读取
- OpenAI: 大模型API调用
- datetime: 日期时间处理

"""</span>

<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime
<span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI
<span class="hljs-keyword">from</span> PyPDF2 <span class="hljs-keyword">import</span> PdfReader

<span class="hljs-comment"># 获取当前日期字符串，用于文件名命名</span>
date_str = datetime.now().strftime(<span class="hljs-string">'%Y-%m-%d'</span>)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">read_pdf</span>(<span class="hljs-params">pdf_path</span>):
    <span class="hljs-string">"""
    从PDF文件中提取文本内容
    
    使用PyPDF2库读取PDF文件，提取所有页面的文本内容，
    各页面文本用单换行符连接。
    
    Args:
        pdf_path (str): PDF文件的完整路径
        
    Returns:
        str: 从PDF中提取的文本内容，各页面之间用换行符分隔
        
    Note:
        这个函数与readpdf.py中的read_pdf函数类似，但连接符不同
        这里使用单换行符，适合后续的AI分析处理
    """</span>
    <span class="hljs-comment"># 创建PDF阅读器对象并读取文件</span>
    reader = PdfReader(pdf_path)
    
    <span class="hljs-comment"># 提取所有页面的文本内容</span>
    <span class="hljs-comment"># page.extract_text() 可能返回None，使用or ""处理空页面</span>
    <span class="hljs-comment"># 各页面文本用换行符连接，保持一定分隔但比双换行符更紧凑</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"\n"</span>.join(page.extract_text() <span class="hljs-keyword">or</span> <span class="hljs-string">""</span> <span class="hljs-keyword">for</span> page <span class="hljs-keyword">in</span> reader.pages)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_info</span>(<span class="hljs-params">content</span>):
    <span class="hljs-string">"""
    使用大语言模型对文本内容进行智能分析
    
    该函数调用百度AI Studio的ernie-4.5-turbo-vl模型，
    对输入的文本内容进行结构化分析，识别和分类各种信息。
    
    Args:
        content (str): 待分析的文本内容（通常是从PDF提取的报纸内容）
        
    Returns:
        str: AI分析生成的结构化文本内容
        
    Note:
        - 使用流式输出，实时显示AI思考过程和分析结果
        - 分析结果包含重大事件、评论文章、金句典故、优秀词组四个维度
        - 模型配置为低温度(0.2)以确保输出稳定性
    """</span>
    <span class="hljs-comment"># 初始化OpenAI客户端</span>
    <span class="hljs-comment"># 注意：API密钥应从环境变量或配置文件获取，避免硬编码</span>
    client = OpenAI(
        <span class="hljs-comment"># API密钥配置 - 生产环境中应使用环境变量xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span>
        api_key=<span class="hljs-string">"生产环境中应使用环境变量xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span>,
        <span class="hljs-comment"># 百度AI Studio大模型API服务地址</span>
        base_url=<span class="hljs-string">"https://aistudio.baidu.com/llm/lmapi/v3"</span>,
    )

    <span class="hljs-comment"># 创建聊天完成请求</span>
    chat_completion = client.chat.completions.create(
        <span class="hljs-comment"># 使用ernie-4.5-turbo-vl模型进行多模态分析</span>
        model=<span class="hljs-string">"ernie-4.5-turbo-vl"</span>,
        
        <span class="hljs-comment"># 构建对话消息</span>
        messages=[
            {
                <span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>,
                <span class="hljs-string">"content"</span>: (
                    <span class="hljs-string">"该内容是报纸pdf识别的，内容连续性可能有问题，请你理顺后，"</span>
                    <span class="hljs-string">"然后详尽完成下列任务，要详细，尽可能多："</span>
                    <span class="hljs-string">"1.报纸中出现的重大事件；"</span>
                    <span class="hljs-string">"2.评论员文章；"</span>
                    <span class="hljs-string">"3.金句、典故、古语；"</span>
                    <span class="hljs-string">"4.优秀词组、新词。"</span>
                ),
            },
            {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: content},
        ],
        
        <span class="hljs-comment"># 启用流式输出，实时显示结果</span>
        stream=<span class="hljs-literal">True</span>,
        
        <span class="hljs-comment"># 额外的模型参数配置</span>
        extra_body={
            <span class="hljs-string">"penalty_score"</span>: <span class="hljs-number">1</span>,      <span class="hljs-comment"># 重复惩罚分数，控制内容重复度</span>
            <span class="hljs-string">"enable_thinking"</span>: <span class="hljs-literal">True</span>  <span class="hljs-comment"># 启用思考模式，提高分析质量</span>
        },
        
        <span class="hljs-comment"># 模型生成参数</span>
        max_completion_tokens=<span class="hljs-number">12000</span>,  <span class="hljs-comment"># 最大输出token数，确保详细分析</span>
        temperature=<span class="hljs-number">0.2</span>,              <span class="hljs-comment"># 温度参数，低温度保证输出稳定性</span>
        top_p=<span class="hljs-number">0.8</span>,                    <span class="hljs-comment"># 核采样参数</span>
        frequency_penalty=<span class="hljs-number">0</span>,          <span class="hljs-comment"># 频率惩罚，避免重复内容</span>
        presence_penalty=<span class="hljs-number">0</span>            <span class="hljs-comment"># 存在惩罚，鼓励新话题</span>
    )

    <span class="hljs-comment"># 处理流式输出</span>
    mycontent = <span class="hljs-string">""</span>
    <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> chat_completion:
        <span class="hljs-comment"># 检查是否有有效的选择结果</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> chunk.choices <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(chunk.choices) == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">continue</span>
            
        choice = chunk.choices[<span class="hljs-number">0</span>]
        
        <span class="hljs-comment"># 处理AI思考过程内容（如果启用思考模式）</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(choice.delta, <span class="hljs-string">"reasoning_content"</span>) <span class="hljs-keyword">and</span> choice.delta.reasoning_content:
            <span class="hljs-comment"># 实时显示AI的思考过程</span>
            <span class="hljs-built_in">print</span>(choice.delta.reasoning_content, end=<span class="hljs-string">""</span>, flush=<span class="hljs-literal">True</span>)
            
        <span class="hljs-comment"># 处理实际的分析内容</span>
        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">hasattr</span>(choice.delta, <span class="hljs-string">"content"</span>) <span class="hljs-keyword">and</span> choice.delta.content:
            <span class="hljs-comment"># 实时显示分析结果</span>
            <span class="hljs-built_in">print</span>(choice.delta.content, end=<span class="hljs-string">""</span>, flush=<span class="hljs-literal">True</span>)
            <span class="hljs-comment"># 累积完整内容用于返回</span>
            mycontent = mycontent + choice.delta.content
            
    <span class="hljs-comment"># 返回完整的分析结果</span>
    <span class="hljs-keyword">return</span> mycontent


<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-string">"""
    主函数 - 程序执行入口
    
    执行完整的PDF分析流程：
    1. 构建当日人民日报PDF文件名
    2. 读取PDF文本内容
    3. 使用AI进行智能分析
    4. 保存分析结果到Markdown文件
    """</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 构建当日人民日报PDF文件名 (格式: rmrb_YYYY-MM-DD.pdf)</span>
        rmrb_pdf_file = <span class="hljs-string">f"rmrb_<span class="hljs-subst">{date_str}</span>.pdf"</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"正在读取PDF文件: <span class="hljs-subst">{rmrb_pdf_file}</span>"</span>)
        
        <span class="hljs-comment"># 提取PDF文本内容</span>
        content = read_pdf(rmrb_pdf_file)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"PDF文本提取完成，内容长度: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(content)}</span> 字符"</span>)
        
        <span class="hljs-comment"># 使用AI进行智能分析</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n开始AI分析..."</span>)
        markdown_note = extract_info(content)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\nAI分析完成"</span>)
        
        <span class="hljs-comment"># 重新获取日期字符串（确保文件名日期准确）</span>
        current_date = datetime.now().strftime(<span class="hljs-string">"%Y-%m-%d"</span>)
        output_filename = <span class="hljs-string">f"人民日报_<span class="hljs-subst">{current_date}</span>.md"</span>
        
        <span class="hljs-comment"># 保存分析结果到Markdown文件</span>
        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(output_filename, <span class="hljs-string">"w"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> file:
            <span class="hljs-built_in">print</span>(markdown_note, file=file)
            
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n分析结果已保存到: <span class="hljs-subst">{output_filename}</span>"</span>)
        
    <span class="hljs-keyword">except</span> FileNotFoundError:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"错误: 找不到文件 '<span class="hljs-subst">{rmrb_pdf_file}</span>'"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"请确保当日的人民日报PDF文件存在且命名格式正确"</span>)
        
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"处理过程中发生错误: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"请检查网络连接和API配置"</span>)
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">#开始对报纸内容分析</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()
</code></pre>
<h2 data-id="heading-16">四、报纸摘要示例</h2>
<h4 data-id="heading-17">一、报纸中出现的重大事件</h4>
<ol>
<li>
<p><strong>经济数据发布</strong></p>
<ul>
<li>2025年我国全年电影票房达518.32亿元，同比增长21.95%，国产影片占比79.67%。</li>
<li>元旦假期首日（2026年1月1日）全国跨区域人员流动量超2亿人次，同比增长20.3%。</li>
</ul>
</li>
<li>
<p><strong>科技与能源成就</strong></p>
<ul>
<li>“华龙一号”漳州核电2号机组投入商业运行，标志漳州核电一期工程全面投产，单台机组年发电量约100亿千瓦时。</li>
<li>“深海一号”气田2025年油气总产量突破450万吨，与陆地中型油田规模相当。</li>
</ul>
</li>
<li>
<p><strong>政策调整与经济措施</strong></p>
<ul>
<li>国家发展改革委优化“两新”政策（设备更新与消费品以旧换新），扩大资金支持范围，降低企业申报门槛。</li>
<li>2026年提前批“两重”建设项目清单下达，约2950亿元投资聚焦城市地下管网、高标准农田等领域。</li>
</ul>
</li>
<li>
<p><strong>国际合作与外交</strong></p>
<ul>
<li>多国重申坚持一个中国原则，反对干涉中国内政，包括巴基斯坦、孟加拉国、吉布提等。</li>
<li>中国助力非洲数字化转型，如承建博茨瓦纳国家数据中心、助力肯尼亚电商发展（Kilimall平台）等。</li>
</ul>
</li>
<li>
<p><strong>社会民生与乡村振兴</strong></p>
<ul>
<li>吉林省镇赉县创业村通过盐碱地改良实现水稻丰收，打造“镇赉大米”品牌，村集体收入突破50万元。</li>
<li>浙江舟山实施“小岛迁、大岛建”工程，改善海岛老人养老条件，同时盘活小岛资源发展特色产业。</li>
</ul>
</li>
<li>
<p><strong>文化与法治建设</strong></p>
<ul>
<li>中国法治论坛聚焦“十五五”法治保障，强调构建法学自主知识体系，推动法治赋能高质量发展。</li>
<li>《哪吒之魔童闹海》票房破154亿元，推动中国电影工业水平提升。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-18">二、评论员文章</h4>
<ol>
<li>
<p><strong>《继续回答好延安“窑洞之问”》</strong></p>
<ul>
<li>核心观点：坚持自我革命，保持党同人民血肉联系，通过从严治党净化政治生态，确保“十五五”良好开局。</li>
<li>关键论据：从“让人民监督政府”到“自我革命”，历史周期率的两个答案彰显党与人民风雨同舟。</li>
</ul>
</li>
<li>
<p><strong>《优化实施“两新”政策，推动高质量发展》</strong></p>
<ul>
<li>核心观点：通过资金分配优化、监管强化和范围拓展，提升政策惠及面，支持企业设备更新与消费升级。</li>
<li>关键论据：2025年消费品以旧换新暴露问题，2026年针对性优化，如增加老旧小区电梯改造、商业综合体设备更新等。</li>
</ul>
</li>
<li>
<p><strong>《中国助力非洲数字化转型》</strong></p>
<ul>
<li>核心观点：通过数字基建、电商培育、人才培训，中国助力非洲弥合数字鸿沟，推动可持续发展。</li>
<li>关键论据：博茨瓦纳数据中心、肯尼亚Kilimall平台、卢旺达鲁班工坊等案例体现中非合作成果。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-19">三、金句、典故、古语</h4>
<ol>
<li>
<p><strong>领导人金句</strong></p>
<ul>
<li>“党兴方能国强。”（新年贺词）</li>
<li>“我国成为创新力上升最快的经济体之一。”（2026年新年贺词）</li>
<li>“信心，来自经济实力的拾级而上。”（新年贺词解读）</li>
</ul>
</li>
<li>
<p><strong>典故与古语</strong></p>
<ul>
<li>“民惟邦本”（《尚书》），用于阐释“以人民为中心”的治理理念。</li>
<li>“四水归堂”（传统建筑智慧），象征民居文化中“聚财聚气”的生态设计。</li>
<li>“逐梦星辰大海”，形容科技发展的远大志向。</li>
</ul>
</li>
<li>
<p><strong>文化引用</strong></p>
<ul>
<li>侗族款约“不会唱歌难娶亲”，体现非遗文化传承与社区治理结合。</li>
<li>“风物长宜放眼量”，用于鼓励长期主义发展观。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-20">四、优秀词组、新词</h4>
<ol>
<li>
<p><strong>政策术语</strong></p>
<ul>
<li><strong>“两新”政策</strong>：设备更新与消费品以旧换新。</li>
<li><strong>“两重”建设</strong>：重大战略、重点领域安全能力建设。</li>
<li><strong>“新质生产力”</strong>：以创新驱动的高质量发展动能。</li>
</ul>
</li>
<li>
<p><strong>经济与科技新词</strong></p>
<ul>
<li><strong>“地理信息产业”</strong>：自动驾驶地图标准体系、实景三维中国建设。</li>
<li><strong>“同一起跑线”</strong>：形容未来产业布局的公平竞争环境。</li>
</ul>
</li>
<li>
<p><strong>社会民生词汇</strong></p>
<ul>
<li><strong>“小岛迁、大岛建”</strong>：海岛乡村振兴模式。</li>
<li><strong>“盐碱地上创业”</strong>：通过科技改良实现农业突破。</li>
</ul>
</li>
<li>
<p><strong>文化与国际传播</strong></p>
<ul>
<li><strong>“文化出海‘新三样’”</strong>：网文、网剧、网游成为文化输出新渠道。</li>
<li><strong>“最佳旅游乡村”</strong>：黄岗村等通过文旅融合实现乡村振兴。</li>
</ul>
</li>
<li>
<p><strong>法治与治理概念</strong></p>
<ul>
<li><strong>“全国统一大市场”</strong>：破除地方壁垒，促进要素自由流动。</li>
<li><strong>“法治赋能高质量发展”</strong>：通过立法保障经济转型。</li>
</ul>
</li>
</ol>
<hr/>
<p>以上内容基于报纸PDF识别材料整理，涵盖时政、经济、科技、文化等多领域，体现中国在政策、创新、民生及国际合作中的动态。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[还在手搓流程图？DeepSeek+Draw.io王炸组合，一句话秒出可编辑源文件！]]></title>    <link>https://juejin.cn/post/7590309337861161001</link>    <guid>https://juejin.cn/post/7590309337861161001</guid>    <pubDate>2026-01-03T11:24:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590309337861161001" data-draft-id="7590654280900100139" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="还在手搓流程图？DeepSeek+Draw.io王炸组合，一句话秒出可编辑源文件！"/> <meta itemprop="keywords" content="开源,AIGC,DeepSeek"/> <meta itemprop="datePublished" content="2026-01-03T11:24:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="后端小肥肠"/> <meta itemprop="url" content="https://juejin.cn/user/2966945320667536"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            还在手搓流程图？DeepSeek+Draw.io王炸组合，一句话秒出可编辑源文件！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2966945320667536/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    后端小肥肠
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T11:24:34.000Z" title="Sat Jan 03 2026 11:24:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是小肥肠！今天给大家分享一个一句话生成流程图的AI工具，支持在线编辑，使用方法也很简单，5分钟即可完成部署轻松上手，感兴趣就速速码住哦~</p>
<h2 data-id="heading-0">1. 效果展示</h2>
<p>昨天剪辑AI漫剧的空隙刷了一下AI资讯（超绝不经意展示我在做的AI漫剧，嘻嘻）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6335589a7fd14ae089d1ead42f1d9018~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768044273&amp;x-signature=gUwA1YzYm6UiM4H1%2BTdI6WYPmOc%3D" alt="" loading="lazy"/></p>
<p>偶然发现了一个让我眼前一亮的项目—<code>next-ai-draw-io</code>。咱们的老粉应该记得，之前我分享过一篇<a href="https://link.juejin.cn?target=https%3A%2F%2Fpa23ntdf1gf.feishu.cn%2Fwiki%2FVZjZwnhLcimViBkJTVQcAipQnFR%3Ffrom%3Dfrom_copylink" target="_blank" title="https://pa23ntdf1gf.feishu.cn/wiki/VZjZwnhLcimViBkJTVQcAipQnFR?from=from_copylink" ref="nofollow noopener noreferrer">让Mermaid听懂人话：用Coze空间+MCP一句话搞定所有业务图</a>。那个方案虽然好用，但是有个缺点就是不能在线修改，而今天这个工具，<strong>直接把AI嵌入到了我们最熟悉的 draw.io 里！</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92a4f502842b4c7bb58724a5d17cd7bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768044273&amp;x-signature=73rXssncvw2GSjH%2F2Z5z1vpqXXA%3D" alt="" loading="lazy"/></p>
<p>以前上班画架构图、流程图，draw.io 是绝对的T0级别工具，现在加上了 AI 的加持，简直是如虎添翼。我花了5分钟在本地部署了一套，接入了 DeepSeek 模型，效果直接炸裂：<strong>一句话生成规范流程图，不满意还能直接在右侧 UI 界面手动微调。</strong></p>
<p>首先是流程图：</p>
<pre><code class="hljs">帮我画一个电商用户的购物流程图。从用户浏览商品开始，包括加入购物车、结账、支付成功/失败的判断，一直到发货和确认收货
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d96d33f4650458a89f840308da40f36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768044273&amp;x-signature=L%2FD%2FtfLa02JHDY75m7aahVIHmRw%3D" alt="" loading="lazy"/></p>
<p>又试了一下带动态效果的架构图：</p>
<pre><code class="hljs">我画一个简单的网络架构图，包含一个‘客户端’图标和一个‘服务器’图标。请使用带有明显动画效果的连接线（animated connector）将它们连接起来，方向从客户端指向服务器，生动地展示数据正在传输的过程。
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9a445ffd5d44f0487218c0a873b50d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768044273&amp;x-signature=JGweJWC9wAM7e1URAQtCWjCw8ww%3D" alt="" loading="lazy"/></p>
<p><strong>生成的流程图经过修改后，可以直接将源文件下载到本地使用。</strong> 话不多说直接教大家来部署使用，<strong>结尾还送小肥肠配置好的next-ai-draw-io压缩包，大家可以直接拿过去部署使用~</strong></p>
<h2 data-id="heading-1">2. 部署使用</h2>
<h3 data-id="heading-2">2.1. docker安装</h3>
<p><strong>1.</strong> <strong>安装 WSL 2（适用于 Windows 10 版本 2004 及以上）：</strong></p>
<p>Windows 子系统 Linux 2（WSL 2）提供了一个完整的 Linux 内核，Docker Desktop 依赖于此。win+R打开命令窗口，输入winver查看系统版本，确保内部版本高于19041：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd2858af300e42c6b3e0f518f7cceba8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768044273&amp;x-signature=SwBkN9DIskESUhsbg2nXKEs89iI%3D" alt="" loading="lazy"/></p>
<p>以管理员身份打开 PowerShell，运行以下命令：</p>
<pre><code class="hljs language-css" lang="css">wsl <span class="hljs-attr">--install</span>
</code></pre>
<p>安装完成后需要重启一下计算机。</p>
<p><strong>2.</strong> <strong>安装DockerDesktop</strong></p>
<p>安装 Docker Desktop 之前，确保你已经安装并启用了 WSL 2。可以通过在 <strong>PowerShell</strong> 运行以下命令来检查：</p>
<pre><code class="hljs language-css" lang="css">wsl <span class="hljs-attr">--list</span> <span class="hljs-attr">--verbose</span>
</code></pre>
<p><strong>下载 Docker Desktop</strong>：访问 Docker 官方网站，下载适用于 Windows 的 Docker Desktop 安装包。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd851de54ec942038f8dafd3cd70c5bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768044273&amp;x-signature=V%2Foy2yruAccrUDywZctVGJItARA%3D" alt="" loading="lazy"/></p>
<p><strong>安装 Docker Desktop</strong>：</p>
<ul>
<li>双击下载的安装文件 <code>Docker Desktop Installer.exe</code>。</li>
<li>按照提示完成安装过程。</li>
<li>安装完成后，系统可能提示重启计算机，建议重启以确保所有组件正常工作。</li>
</ul>
<p><strong>启动 Docker Desktop</strong>：电脑重启后，启动<strong>Docker Desktop，</strong> 初次启动可能需要一些时间。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0861cd7ab92946d781353158bb2651aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768044273&amp;x-signature=%2Bd5G6JdqV0YaAPl3SWskH4Vg3LU%3D" alt="" loading="lazy"/></p>
<p>配置一下docker镜像源地址：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a258e9e948994b19bd85eff78e3084ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768044273&amp;x-signature=9SR7wY035L4%2BYCwN6WRl4%2BjdNDg%3D" alt="" loading="lazy"/></p>
<p>以下镜像源地址为国内地址，你不想用我的也可以自己找：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"builder"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"gc"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"defaultKeepStorage"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"20GB"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"enabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"experimental"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"registry-mirrors"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"https://docker.1panel.live"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"https://hub.rat.dev"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"https://docker.chenby.cn"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"https://docker.m.daocloud.io"</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-3">2.2. next-ai-draw-io安装</h3>
<p>来到next-ai-draw-io仓库页面<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FDayuanJiang%2Fnext-ai-draw-io" target="_blank" title="https://github.com/DayuanJiang/next-ai-draw-io" ref="nofollow noopener noreferrer">github.com/DayuanJiang…</a> 点击下载压缩包按钮。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4541c8504a44a4194042006610b33a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768044273&amp;x-signature=o7DtHPegnav28wPQ%2FAZm2Cga2XY%3D" alt="" loading="lazy"/></p>
<p>将下载好的压缩包解压到任意目录，如有git可以用git clone命令直接下载项目到文件夹中：</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/DayuanJiang/next-ai-draw-io
</code></pre>
<p>复制一份env.example文件并改名为.env。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb9eb7a619764bee95a79cee1752c22e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768044273&amp;x-signature=PBX8kTSQ2XEZkqfSU1xaDxblWs4%3D" alt="" loading="lazy"/></p>
<p>在.env文件中进行大模型配置用来驱动drawio绘图操作，下图中我配置的是deepseek，你也可以配置其他模型：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48c50b785a2d4be2ad2e4e9f7fe8e547~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768044273&amp;x-signature=WaV5t3hFWerk0bBkyW2i24d2wOI%3D" alt="" loading="lazy"/></p>
<p>打开docker-compose.ym文件在进行如下配置：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04a509e96bb94405a272be038f13d225~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768044273&amp;x-signature=DJ9EsXRmHuToAh%2Bxhb2fiN3gaMo%3D" alt="" loading="lazy"/></p>
<p><strong>注意：为了防止和本地其他服务冲突，我将 drawio 的端口修改为了 8818。如果你本地 8080 没被占用，保持默认即可；如果占用了，记得像我截图里一样，同时修改</strong> <code>ports</code> <strong>和</strong> <code>env</code> <strong>文件里的端口号。</strong></p>
<p>回到next-ai-draw-io文件目录，在文件路径处输入cmd打开命令提示符，输入命令docker-compose up -d --build</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/769e50497f7d4c59a4c04695601c3446~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768044273&amp;x-signature=G6d090tiqD%2FZp7OBVYSdyT8k1RY%3D" alt="" loading="lazy"/></p>
<p>等待next-ai-draw-io安装，成功后打开网址<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A3000%2Fzh%25E5%258D%25B3%25E5%258F%25AF%25E8%25BF%259B%25E5%2585%25A5next-ai-draw-io%25E6%2593%258D%25E4%25BD%259C%25E7%2595%258C%25E9%259D%25A2%25EF%25BC%258C%25E6%2588%2591%25E4%25BB%25AC%25E5%258F%25AF%25E4%25BB%25A5%25E5%25BC%2580%25E5%25A7%258B%25E8%25BF%259B%25E8%25A1%258C%25E4%25B8%2580%25E5%258F%25A5%25E8%25AF%259D%25E7%2594%259F%25E6%2588%2590%25E6%25B5%2581%25E7%25A8%258B%25E5%259B%25BE%25E7%259A%2584%25E6%2593%258D%25E4%25BD%259C%25E4%25BA%2586%25EF%25BC%259A" target="_blank" title="http://localhost:3000/zh%E5%8D%B3%E5%8F%AF%E8%BF%9B%E5%85%A5next-ai-draw-io%E6%93%8D%E4%BD%9C%E7%95%8C%E9%9D%A2%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E5%BC%80%E5%A7%8B%E8%BF%9B%E8%A1%8C%E4%B8%80%E5%8F%A5%E8%AF%9D%E7%94%9F%E6%88%90%E6%B5%81%E7%A8%8B%E5%9B%BE%E7%9A%84%E6%93%8D%E4%BD%9C%E4%BA%86%EF%BC%9A" ref="nofollow noopener noreferrer">http://localhost:3000/zh即可进入next-ai-draw-io操作界面，我们可以开始进行一句话生成流程图的操作了：</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d5ac4fa217f4cdb85477953d96f87da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768044273&amp;x-signature=DcEIzm2SQaGhOFUc%2FSdGQFjXZgo%3D" alt="" loading="lazy"/></p>
<p>以上就是本期教程的完整内容，想获取小肥肠已经配置好的next-ai-draw-io压缩包可以评论区说流程图哦~</p>
<h2 data-id="heading-4">3. 结语</h2>
<p>无论你是产品经理、开发人员还是架构师，这套 <code>DeepSeek + next-ai-draw-io</code> 的组合，绝对能成为提高工作效率的一把利器。</p>
<p><strong>如本次分享对你有帮助，麻烦一键三连支持一下小肥肠，我们下期再见~</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/190eaed60f004d77b7c9d04831a96ae2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768044273&amp;x-signature=QqxprKbvQnRLGJi6Han3FANhcDM%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[阿里人的 2025 年终总结：买房、晋升、订婚、投资，遇见更清晰的自己]]></title>    <link>https://juejin.cn/post/7590699877630378022</link>    <guid>https://juejin.cn/post/7590699877630378022</guid>    <pubDate>2026-01-03T11:55:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590699877630378022" data-draft-id="7590699877630328870" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="阿里人的 2025 年终总结：买房、晋升、订婚、投资，遇见更清晰的自己"/> <meta itemprop="keywords" content="后端,面试,架构"/> <meta itemprop="datePublished" content="2026-01-03T11:55:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱敲代码的小黄"/> <meta itemprop="url" content="https://juejin.cn/user/598584558627246"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            阿里人的 2025 年终总结：买房、晋升、订婚、投资，遇见更清晰的自己
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/598584558627246/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱敲代码的小黄
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T11:55:59.000Z" title="Sat Jan 03 2026 11:55:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bdb9b40d45524053bfdc3e50beb9a6c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5pWy5Luj56CB55qE5bCP6buE:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768046158&amp;x-signature=SCWvo1D6E14W%2BrPgI7QETYVJSlI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">一、引言</h2>
<p>又到了一年一度的年终复盘时刻。</p>
<p>复盘，从来不只是回看已经发生的事情，更重要的是——为尚未发生的未来，提前铺路、校准方向。</p>
<p>回望 2025 年，其实很长一段时间里，我始终没有真正找到自己的方向。工作之外，谈不上热爱，也谈不上笃定，只是在惯性中前行。</p>
<p>直到 2025 年的尾声，才终于看清了一些东西：哪些是必须坚持的，哪些是可以放下的，也逐渐摸索出几条更属于自己的路径。这一年，并非突然开悟，而是反复碰壁后的沉淀与取舍。</p>
<p>依旧按照惯例，沿着时间的轨迹，回到 2025 年的起点，梳理这一整年里的得与失、进与退，也为下一阶段的自己，留下些什么。</p>
<h2 data-id="heading-1">二、技术（AI驱动）</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9dd262c4e24e496fabdd11b579b4e447~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5pWy5Luj56CB55qE5bCP6buE:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768046158&amp;x-signature=bXK%2FP%2Bsa1ph7wID8PtEk0SNAOu0%3D" alt="" loading="lazy"/></p>
<p>2025 年，是 AI 加速演进的一年。</p>
<p>这一年里，我写博客明显少了，最直接的原因，正是 AI 带来的冲击。曾经需要熬夜查资料、翻文档、啃源码的事情，在今天的 AI 面前显得异常高效——只需要给出合适的关键词，答案往往已经被系统性地整理好。</p>
<p>从宏观来看，2025 年的主旋律，几乎全部围绕着<strong>大模型基础设施</strong>展开。各大厂商持续投入巨额资金，用于模型规模、算力和训练能力的迭代升级。但与之形成鲜明对比的是：​<strong>大模型的应用落地，依然是一个尚未被彻底解决的问题</strong>​。</p>
<p>这就像高速公路已经修好，但真正决定胜负的，是谁家的车最先跑起来、跑得最稳。</p>
<p>基于这一判断，我越来越坚定地认为：<strong>2026 年的主旋律，一定是 AI 的落地与应用。</strong></p>
<p>对技术人而言，未来不再只是把业务“做深做熟”，而是在既有业务基础上，思考如何与大模型更好地结合、适配、放大价值——这或许才是更长远的终局。</p>
<p>纯业务型技术路线，势必会遭遇一定冲击。原因并不复杂：当业务格局趋于稳定，公司往往不会再在传统方向上投入重资产。努力当然重要，但在技术浪潮面前，​<strong>方向的优先级，永远高于努力本身</strong>​。风口之上，选择往往比埋头苦干更关键。</p>
<p>坦白说，我曾长期对 AI 保持距离。并非否定它的价值，而是因为它太新——标准未定、路径未明、变量太多。这种不确定性，本能地让人抗拒。</p>
<p>真正的转折，来自一次和老板的绩效沟通。在 AI 飞速演进的节点，如果只是站在一旁观望，等别人把位置站稳、红利吃完，再回头跟进，我们注定只能咀嚼别人剩下的成果，且永远慢一步。</p>
<p>从那次谈话之后，我逐渐接受了一个事实：<strong>AI 不是选修，而是必须正视的方向。</strong></p>
<p>客观来说，2025 年我并没有系统性地学习太多 AI 知识。但我也越来越确信，学习本身并不是最难的事，真正重要的，是先选对方向。</p>
<p>立下 2026 年的第一个 Flag：<strong>持续系统性地学习 AI，构建完整的技术体系，至少让自己始终站在行业前列。</strong></p>
<h2 data-id="heading-2">三、工作（Agent/晋升）</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81797c49750b482bb9b4ff32fbe321ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5pWy5Luj56CB55qE5bCP6buE:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768046158&amp;x-signature=hTx7eH3BNbIJDpzCjHm79Rq6TRM%3D" alt="" loading="lazy"/></p>
<p>2025 年，几乎可以被视为 ​<strong>Agent 的元年</strong>​。</p>
<p>对风控工程师而言，这是一个难得的历史窗口期。大模型天然擅长图文理解，而内容风控的核心风险，恰恰集中在图文与多模态层面，二者之间的契合度，几乎是为内容风控量身定做。</p>
<p>在过去一年里，我们更多是在​<strong>夯实底层能力</strong>​：包括大模型与小模型的协同、向量检索体系、敏感词与规则匹配等基础设施建设。而今年，则顺应技术演进的方向，在此之上，开始系统性地推进​<strong>内容风控 Agent 的建设</strong>​。</p>
<p>从系统设计角度看，传统架构往往以同步模式为主。但在大模型时代，推理延迟不可避免地成为整体架构的瓶颈，在高 QPS 场景下，单纯依赖同步调用已难以支撑规模化落地。因此，架构形态也不得不随之演进，从同步模式逐步向<strong>异步化、任务化</strong>转变。</p>
<p>不过，相比架构调整，Agent 本身长期存在的两个核心问题更加关键：<strong>幻觉问题</strong>与​<strong>成本问题</strong>​。</p>
<p>对于幻觉问题，业界较为成熟的做法，是通过 Workflow 对大模型的行为路径进行约束，让其在预设的流程和边界内完成推理，从而降低不确定性。</p>
<p>而成本问题则更具挑战性。目前主流思路可以拆解为两个方向：一是<strong>降低大模型</strong>​​<strong>的调用频次</strong>​，二是​<strong>降低单次调用成本</strong>​。前者往往引入搜广推体系中的粗排 / 精排架构，由小模型或规则先行过滤，仅将必要样本交由大模型处理；后者则更多依赖自建推理服务，通过部署开源模型（如千问、DeepSeek 等）来降低整体成本。</p>
<p>更进一步来看，自建模型还有一个明显优势：当前开源模型大多是通用基模，而真实业务更需要的是​<strong>领域大模型</strong>​。这也意味着，必须通过微调、蒸馏等手段，构建并持续演进真正贴合业务的模型体系。</p>
<p>整体来看，这一阶段的工作，相比传统开发，多了更多的不确定性，但也因此更具挑战性和成长空间，是真正与 AI 深度接轨的一段经历。</p>
<p>也幸运地得到了老板的认可，拿到了来之不易的晋升名额，完成了职业生涯中的第二次晋升——上一次是在上一家公司。回头看，确实有运气成分，也更需要珍惜。</p>
<p>立下新年的第二个 Flag：<strong>2026 年，持续精进 Agent 架构能力，从整体设计到细节实现全面吃透，建立真正的体系化掌控力，同时对自己保持足够严格的技术要求，始终心存技术敬畏。</strong></p>
<h2 data-id="heading-3">四、健康（运动/旅游）</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36bf0b698075439cb956a218b2300aa4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5pWy5Luj56CB55qE5bCP6buE:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768046158&amp;x-signature=Dbt23RYbuX%2FWfAMeVns%2BTfpRvJI%3D" alt="" loading="lazy"/></p>
<p>又到了这个多少有些老生常谈的栏目。</p>
<p>坦率地说，2025 年的运动状态可以用全面崩盘来形容。不仅没有瘦下来，反而稳步增重，这一项只能毫不留情地给自己打一个最低分，甚至有点不忍直视。唯一能做的，大概只能把希望寄托在 2026 年，重新做人。</p>
<p>相比之下，生活并非全然失守。这一年，还是走了不少地方。公司团建去了昆明、大理，看到了心心念念的洱海；个人也陆续去了深圳、香港、天津、北戴河、南京等城市，在不同的节奏里切换视角，多少算是给自己留了一些喘息的空间。</p>
<p>也期待明年能继续把“在路上”这件事延续下去——更重要的是，明年对象终于有年假了。</p>
<p>立下新年的第三个 Flag：<strong>坚持运动，至少别再继续发胖；同时走进几个尚未抵达过的城市，让生活保持一点新的变量。</strong></p>
<h2 data-id="heading-4">五、家庭（买房/订婚）</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb4d32b143f04958a3e3fe5ead1bf0c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5pWy5Luj56CB55qE5bCP6buE:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768046158&amp;x-signature=CII2ImBQTkDqAkJ%2FrEUBkAYTSeo%3D" alt="" loading="lazy"/></p>
<p>去年看过的房子，最终还是和对象商量后定了下来。位置在县城里算是比较成熟的小区，四面都有学校，整体价格也在可承受范围内。房贷已经还了一年，对日常生活的影响并不大。</p>
<p>唯一的遗憾是交付时间要到 2027 年，目前仍在建设中。不过好在并不着急，慢一点也无妨。地理位置也和去年设想的一样——我和亲姐选择了同一个小区、同一个单元、上下楼，只需要一分钟，就能“传送”到她家蹭饭。考虑到我和对象都不太擅长做饭，这个选择现在看起来，格外明智。</p>
<p>另一件重要的事情，是订婚。和对象谈了七年恋爱，最终还是给了彼此一个相对笃定、也让双方家庭都满意的答案。整个过程比预想中顺利得多，几乎没有在流程或观念上产生大的分歧。订婚前和订婚后，心态确实发生了一些变化——一种更明确的“我们已经是一家人了”的心理确认。</p>
<p>当然，现实层面仍然存在异地的问题。对象在老家县医院工作，我则在北京从事互联网相关工作。所幸的是，老家县城今年将开通直达北京的高铁，往返的成本和难度都会降低，这也算是一个不小的利好。</p>
<p>整体来看，家庭这一块在 2025 年算是比较稳定的一年，没有突发的波折，一切都在预期内向前推进。</p>
<p>立下新年的第三个 Flag：<strong>家庭层面继续顺其自然、稳步发展；如果房子能提前交付，也不排除提前去拍个婚纱照——不强制，慢慢来。</strong></p>
<h2 data-id="heading-5">六、投资（美股/港股/A股）</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c0c4aa816b54c2887c67f46ad0491a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5pWy5Luj56CB55qE5bCP6buE:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768046158&amp;x-signature=oUVrfCJ4rBH%2FYQjo1wDFpCqZNuk%3D" alt="" loading="lazy"/></p>
<p>2025 年，也算是我个人投资生涯的起点。</p>
<p>在长桥关门前开通了账户，在汇丰调整政策前办好了银行卡，时间点刚好卡在一个“来得及”的窗口期。12 月份正式进入美股市场后，才真正意识到：投资这件事，本身就像一门需要长期修炼的技术。</p>
<p>这一阶段，最大的收获并不在于盈亏，而是对投资这件事的​<strong>认知重构</strong>​。至少有几件事，是必须补上的基础能力。</p>
<p>第一，是​<strong>仓位控制</strong>​。如何在不踏空的前提下，避免一次性打光子弹，是非常难的一件事。仓位过低，行情来了只能旁观；仓位过高，下跌时却失去补仓空间。合理的仓位，本质上是为了​<strong>尽可能长时间地留在牌桌上</strong>​。</p>
<p>第二，是​<strong>买卖策略</strong>​。不同股票对应不同策略：有的适合长期持有，有的更偏交易属性。对陌生标的，更需要分批建仓，区分观察仓、交易仓与核心仓，而不是一次性下注。</p>
<p>第三，是​<strong>情绪管理</strong>​。这一点的冲击远超预期。下跌时容易冲动补仓，情绪持续低落；上涨时又容易过度乐观，放松纪律。回头看，绝大多数错误操作，都不是判断失误，而是典型的“情绪杀”。</p>
<p>第四，是​<strong>交易复盘</strong>​。 每一笔交易都值得被复盘：究竟是基于清晰逻辑做出的决策，还是随市场情绪跟风的结果。如果连自己为什么买、为什么卖都说不清楚，那么这笔交易本身就是不合格的。</p>
<p>事实上，这些问题最终都可以归结为一个核心：<strong>是否拥有一套成熟、可执行、可复盘的交易系统。</strong></p>
<p>只有在系统的约束下交易，才能尽可能屏蔽情绪干扰，让结果更多由概率而非情绪决定。</p>
<p>某种程度上，这和前面提到的技术路径并无本质区别——就像 2026 年是 Agent 的关键一年一样，投资领域同样需要系统化思维。在美股市场中，也有不少值得长期观察的优质标的，新的一年，我会重点关注：​<strong>谷歌、英伟达、台积电、特斯拉</strong>​。</p>
<p>立下新年的第四个 Flag：<strong>建立并持续迭代属于自己的交易系统，在控制风险的前提下，争取 2026 年实现 10% 的年度收益目标。</strong></p>
<h2 data-id="heading-6">七、总结</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a693e4a41f7b4ef88b8e289db317bdb1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5pWy5Luj56CB55qE5bCP6buE:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768046158&amp;x-signature=yZS3xbyt6I%2BWBFnTO7XW4j5SvAc%3D" alt="" loading="lazy"/></p>
<p>2025 年过得很快，一转眼就到了年末。回头算了一下，自己已经毕业四年半了。</p>
<p>还记得刚毕业的时候，对周围的一切都充满好奇，对技术保持着最纯粹的热情。那时知道的不多，需要承担的事情也不多，反而简单、专注，也更容易感到快乐。</p>
<p>随着年龄和阅历的增长，不得不考虑的事情越来越多，责任与压力也随之而来，这是成长过程中无法回避的一部分。</p>
<p>回看从毕业到现在的这几年，多少还是带着一些运气。整体来看，很少在关键节点上做出错误选择，生活与事业也在持续向更好的方向推进。正因如此，也愈发珍惜当下所拥有的一切。</p>
<p>但运气从来不是全部。对我而言，更重要的是始终保持一种行动上的自觉—<strong>想到就去做，决定了方向，就尽力把事情做成。</strong></p>
<p>接下来，也对 2025 年年初立下的 Flag 做一次完整复盘，给自己这一年的选择与投入，留下一份相对坦诚的答案。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cd26e1988c3445589b73ee542e6c38c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5pWy5Luj56CB55qE5bCP6buE:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768046158&amp;x-signature=cPAs%2B64LwTL6WHzi1qqdjTKQ0jU%3D" alt="" loading="lazy"/></p>
<p>回到终点，再看起点，会发现很多事情并非一蹴而就，而是在一次次选择中逐渐变得清晰。</p>
<p>这一年，没有奇迹，也没有偏航。有的，只是在关键问题上站对方向，在重要事情上持续投入。</p>
<p>花有重开日，人无再少年。<strong>2026，让我们顶峰相见。</strong></p>
<p>如果你也对 <strong>后端架构</strong> 和 <strong>中间件源码</strong> 感兴趣，欢迎添加博主微信：​<strong>hls1793929520</strong>​，一起学习，一起成长。</p>
<p>我是 <strong>​爱敲代码的小黄，​</strong>阿里巴巴 Java 开发工程师，CSDN 博客专家，专注后端架构与中间件源码。</p>
<blockquote>
<p>我从清晨走过，也拥抱夜晚的星辰。人生没有捷径，你我皆平凡。<strong>你好，陌生人，一起共勉。</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从随叫随到到规范配送：现代物流系统与 REST API 的登场]]></title>    <link>https://juejin.cn/post/7590421489997889555</link>    <guid>https://juejin.cn/post/7590421489997889555</guid>    <pubDate>2026-01-03T10:07:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590421489997889555" data-draft-id="7590421489997856787" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从随叫随到到规范配送：现代物流系统与 REST API 的登场"/> <meta itemprop="keywords" content="后端,Python,全栈"/> <meta itemprop="datePublished" content="2026-01-03T10:07:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="韩师傅"/> <meta itemprop="url" content="https://juejin.cn/user/286348958252526"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从随叫随到到规范配送：现代物流系统与 REST API 的登场
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/286348958252526/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    韩师傅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T10:07:30.000Z" title="Sat Jan 03 2026 10:07:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>摘要</strong>：第三代物流系统（Flask、Django、Express）带来了路由系统和持续运行，给进程减负了。前后端分离让灵狐法师登场，REST API 作为"物流法典"为不同系统建立了统一的配送标准。</p>
<h2 data-id="heading-0">📜 第三代：现代物流系统（Flask、Django、Express）</h2>
<h3 data-id="heading-1">时代背景</h3>
<p>🐍 大蟒蛇法师："现代物流系统出现了，比如我的 Flask、Django，还有夜狐法师的 Express。从这一代开始，有了本质的改变：进程持续运行，有固定的路由系统，可以只取用仓库中的部分内容，不依赖之前订单的运输团队。"</p>
<p><strong>关键分割点</strong>：</p>
<ul>
<li><strong>从第三代开始</strong>：核心是给进程减负了</li>
<li><strong>进程 = 整个送货的任务</strong>：不是车马，而是整个送货的任务</li>
<li><strong>之前的运送任务</strong>（第一、二代）：需要做过这一单子的运输团队，运输团队需要记录路径</li>
<li><strong>到了第三代</strong>：
<ul>
<li>有固定的路线（路由系统）</li>
<li>能够知道需要去哪些仓库取哪些东西</li>
<li>这些成了文档，记录在了内存里面</li>
<li>任务就变得简单了</li>
</ul>
</li>
</ul>
<p><strong>特点</strong>：</p>
<ul>
<li><strong>Flask（Python）</strong>：大蟒蛇法师的轻量级物流系统，灵活</li>
<li><strong>Django（Python）</strong>：大蟒蛇法师的全功能物流系统，功能丰富</li>
<li><strong>Express（Node.js）</strong>：夜狐法师的物流系统，JavaScript 世界的物流系统</li>
<li><strong>持续运行</strong>：不需要每次请求都重新启动</li>
<li><strong>路由系统</strong>：可以定义不同的配送路线</li>
<li><strong>中间件支持</strong>：可以添加物流中心点</li>
</ul>
<p><strong>比喻</strong>：</p>
<pre><code class="hljs language-plain" lang="plain">进程 = 整个送货的任务

之前的运送任务（第一、二代）：
  需要做过这一单子的运输团队
  运输团队需要记录路径
  任务复杂，需要运输团队记住路径

到了第三代：
  有固定的路线（路由系统）
  能够知道需要去哪些仓库取哪些东西
  这些成了文档，记录在了内存里面
  任务就变得简单了
  ↓
收到订单：
  🐍 大蟒蛇法师："物流系统一直在运行，直接处理订单..."
  ↓
通过路由系统（固定的路线文档）知道需要打开哪些仓库
  ↓
只取用仓库中的部分内容（函数、类等）
  ↓
处理订单（任务变简单了）
  ↓
返回结果
  ↓
进程继续运行，等待下一个订单
</code></pre>
<p><strong>与 CGI/PHP 的本质区别</strong>：</p>
<p><strong>CGI/PHP（第一、二代）</strong>：</p>
<pre><code class="hljs language-plain" lang="plain">进程 = 整个送货的任务
每次请求：
  启动/复用进程 → 加载整个文件 → 处理订单 → 进程结束/保留
  运输团队每次都要重新装货，一个个仓库去开
  需要做过这一单子的运输团队，运输团队需要记录路径
  任务复杂
</code></pre>
<p><strong>现代物流系统（第三代开始）</strong>：</p>
<pre><code class="hljs language-plain" lang="plain">进程 = 整个送货的任务
核心是给进程减负了

有固定的路线（路由系统）
能够知道需要去哪些仓库取哪些东西
这些成了文档，记录在了内存里面
任务就变得简单了
  ↓
收到订单：
  通过路由系统（固定的路线文档）知道需要打开哪些仓库
  ↓
只取用仓库中的部分内容（函数、类等）
  ↓
处理订单（任务变简单了）
  ↓
进程继续运行，等待下一个订单
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6564002c7a984037a8eb73c8f66b029a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z-p5biI5YKF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768040796&amp;x-signature=8m2KkHRKloN9YVszWSmaj9NG3XQ%3D" alt="image.png" loading="lazy"/></p>
<p><strong>优势</strong>：</p>
<ul>
<li>✅ 核心是给进程减负了：任务变简单了</li>
<li>✅ 持续运行，不需要每次重新启动</li>
<li>✅ 路由系统（固定的路线文档），可以定义不同的配送路线</li>
<li>✅ 能够知道需要去哪些仓库取哪些东西，记录在了内存里面</li>
<li>✅ 可以只取用仓库中的部分内容，不需要加载整个文件</li>
<li>✅ 不需要做过这一单子的运输团队，任务就变得简单了</li>
<li>✅ 中间件支持，可以添加物流中心点</li>
<li>✅ 效率高，可以处理大量订单</li>
</ul>
<p><strong>权衡：持续运行的资源消耗</strong></p>
<p>🐍 大蟒蛇法师："确实，到了第三代，运输任务（进程）一直存在，一直有人待命，这确实有资源消耗。但这是一个权衡："</p>
<p><strong>持续运行的消耗</strong>：</p>
<ul>
<li>⚠️ <strong>内存消耗</strong>：进程一直占用内存，即使没有订单</li>
<li>⚠️ <strong>CPU 消耗</strong>：需要一直监听订单请求（虽然很少，但确实在消耗）</li>
<li>⚠️ <strong>资源占用</strong>：运输团队一直待命，占用资源</li>
</ul>
<p><strong>但避免了什么</strong>：</p>
<ul>
<li>✅ <strong>避免每次启动进程的开销</strong>：第一代每次都要重新启动进程，启动成本很高</li>
<li>✅ <strong>避免每次加载代码的开销</strong>：不需要每次重新加载整个文件</li>
<li>✅ <strong>避免每次初始化的开销</strong>：不需要每次重新初始化环境</li>
<li>✅ <strong>响应速度更快</strong>：收到订单立即处理，不需要等待启动</li>
</ul>
<p><strong>权衡结果</strong>：</p>
<pre><code class="hljs language-plain" lang="plain">第一代（CGI）：
  没有订单时：0 消耗（进程不存在）
  有订单时：高消耗（启动进程 + 加载代码 + 初始化 + 处理）
  = 按需消耗，但每次启动成本高

第三代（Flask/Django）：
  没有订单时：低消耗（进程在监听，占用内存）
  有订单时：低消耗（直接处理，不需要启动）
  = 持续低消耗，但响应速度快
</code></pre>
<p><strong>什么时候用哪种方式</strong>：</p>
<ul>
<li><strong>第一代（按需启动）</strong>：适合订单很少的场景，没有订单时完全不消耗资源</li>
<li><strong>第三代（持续运行）</strong>：适合订单频繁的场景，用持续的资源消耗换取更快的响应速度</li>
</ul>
<p><strong>问题</strong>：</p>
<ul>
<li>⚠️ 但还没有统一的"配送标准"（REST API 概念）</li>
</ul>
<p><strong>前后端分离带来的革命性改变</strong>：</p>
<p>🐍 大蟒蛇法师："从第三代开始，灵狐法师出现了，前后端分离带来了革命性的改变。这不仅仅是技术上的改变，更是整个物流系统的升级。"</p>
<p><strong>前后端分离的价值</strong>：</p>
<ol>
<li><strong>货物集中到灵狐法师处打包和售卖</strong>：
<ul>
<li>之前：每个法师都要自己打包、自己卖货，各自为政</li>
<li>现在：所有法师的货物都送到灵狐法师那里，统一打包和售卖</li>
<li>好处：专业化分工，每个法师专注自己的核心能力</li>
</ul>
</li>
<li><strong>将备货和送货固定下来</strong>：
<ul>
<li>之前：每次订单都要重新准备，备货流程不固定</li>
<li>现在：备货和送货流程固定下来，有标准化的路线</li>
<li>好处：效率提升，错误减少</li>
</ul>
</li>
<li><strong>能够售卖的货物种类变多了</strong>：
<ul>
<li>之前：每个法师只能卖自己擅长的货物，种类有限</li>
<li>现在：灵狐法师可以整合多个法师的货物，提供更多种类的商品</li>
<li>好处：客户选择更多，满足更多需求</li>
</ul>
</li>
<li><strong>路线可以固定了下来</strong>：
<ul>
<li>之前：每次都要重新规划路线，运输团队需要记录路径</li>
<li>现在：路线固定下来，记录在路由系统中，不需要每次都重新规划</li>
<li>好处：任务变简单了，效率更高</li>
</ul>
</li>
<li><strong>能够得到灵狐法师更好的包装了</strong>：
<ul>
<li>之前：每个法师自己包装，包装质量参差不齐</li>
<li>现在：灵狐法师专业包装，包装精美，用户体验更好</li>
<li>好处：统一的用户体验，更好的交互</li>
</ul>
</li>
<li><strong>给很多法师带来了便利</strong>：
<ul>
<li>🐍 大蟒蛇法师："我不需要关心前端展示，只需要专注配制魔药，返回 JSON 数据就行。"</li>
<li>🌙 夜狐法师："我可以隐藏于黑暗中，专注后端逻辑，前端交给兄弟灵狐法师。"</li>
<li>☕ 黑水甲瓦法师："现代模式下，我也可以与灵狐法师合作，提供 REST API，不需要自己处理前端。"</li>
<li>🛡️ 蓝盾法师："现代模式下，我的 ASP.NET Core Web API 也可以与灵狐法师合作，前后端分离。"</li>
</ul>
</li>
</ol>
<p><strong>前后端分离的比喻</strong>：</p>
<pre><code class="hljs language-plain" lang="plain">之前（传统模式）：
  法师 → 自己打包 → 自己卖货 → 客户
  每个法师都要做所有事情，效率低，种类少

现在（前后端分离）：
  法师 → 返回 JSON 数据 → 灵狐法师统一打包和售卖 → 客户
  法师专注核心能力，灵狐法师专业包装和展示
  货物种类更多，包装更好，路线固定
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d8f77aba8c04f739f94165fa40019a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z-p5biI5YKF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768040796&amp;x-signature=qgIXuJuXGBk76gzK9wpftDPFVnc%3D" alt="image.png" loading="lazy"/></p>
<p>🧠 小结：从这一代开始，物流系统终于有了“路线图”和“打包团队”。虽然还不是统一标准，但各地法师之间，开始用同一种语言交流送货方式了。</p>
<p><strong>世界观解释</strong>：</p>
<ul>
<li>🐍 大蟒蛇法师："从第三代开始，我的 Flask 和 Django 物流系统有了本质的改变。核心是给进程减负了。进程是整个送货的任务，不是车马。之前的运送任务需要做过这一单子的运输团队，运输团队需要记录路径，任务复杂。到了第三代，有固定的路线（路由系统），能够知道需要去哪些仓库取哪些东西，这些成了文档，记录在了内存里面，任务就变得简单了。虽然运输任务一直存在，一直有人待命，这确实有资源消耗（内存、CPU），但这是一个权衡：用持续的资源消耗，换取更快的响应速度。因为避免了每次启动进程、加载代码、初始化的开销，所以整体效率更高。更重要的是，灵狐法师的出现带来了前后端分离，这给整个物流系统带来了革命性的改变：货物可以集中到灵狐法师处打包和售卖，备货和送货固定下来，能够售卖的货物种类变多了，路线可以固定下来，并且能够得到灵狐法师更好的包装。这其实是给很多法师带来了便利，我们只需要专注核心能力，返回 JSON 数据，灵狐法师负责专业包装和展示。"</li>
<li>🌙 夜狐法师："我的 Express 物流系统也是这样的。虽然我隐藏于黑暗中，不露面，但我的物流系统一直在运行，与兄弟灵狐法师合作。我负责后端配置，灵狐法师负责卖货给客户。虽然一直待命有资源消耗，但响应速度快，适合订单频繁的场景。前后端分离让我可以专注后端逻辑，不需要关心前端展示，这给我带来了很大的便利。"</li>
<li>🦊 灵狐法师："前后端分离让我可以整合多个法师的货物，提供更多种类的商品给客户。我可以专业包装，提供更好的用户体验。路线固定下来后，我的工作也变得更简单了，不需要每次都重新规划。这其实是一个双赢的局面，法师们专注核心能力，我负责专业包装和展示。"</li>
</ul>
<hr/>
<h2 data-id="heading-2">📦 第四代：标准化物流系统（REST API 概念登场）</h2>
<h3 data-id="heading-3">REST API 是什么？</h3>
<p>🐍 大蟒蛇法师："REST API 不是某个具体的物流系统，它更像是整个魔法世界的《物流法典》。它定义了‘怎么发货、怎么收货、用什么格式沟通’，让所有系统都能彼此听懂、协同送达。"</p>
<p><strong>REST API = 标准化配送流程（概念）</strong>：</p>
<ul>
<li><strong>REST</strong>：Representational State Transfer（表现层状态转移）</li>
<li><strong>不是具体的物流系统</strong>：而是一个设计概念</li>
<li><strong>定义了配送标准</strong>：如何设计 API 接口</li>
<li><strong>让不同系统可以互相理解</strong>：遵循相同的标准</li>
</ul>
<p><strong>REST API 的核心原则</strong>：</p>
<ol>
<li><strong>资源（Resource）</strong>：
<ul>
<li>每个魔药都是一个资源</li>
<li>用 URL 表示资源（如 <code>/api/potions/123</code>）</li>
</ul>
</li>
<li><strong>HTTP 方法（Method）</strong>：
<ul>
<li>GET：查询魔药</li>
<li>POST：创建魔药</li>
<li>PUT：更新魔药</li>
<li>DELETE：删除魔药</li>
</ul>
</li>
<li><strong>无状态（Stateless）</strong>：
<ul>
<li>每次订单都是独立的</li>
<li>不依赖之前的订单</li>
</ul>
</li>
<li><strong>统一接口（Uniform Interface）</strong>：
<ul>
<li>所有接口都遵循相同的格式</li>
<li>使用标准的 HTTP 方法</li>
</ul>
</li>
<li><strong>分层系统（Layered System）</strong>：
<ul>
<li>可以有多个物流中心点（中间件）</li>
<li>每个层次负责不同的功能</li>
</ul>
</li>
</ol>
<p><strong>比喻</strong>：</p>
<pre><code class="hljs language-plain" lang="plain">REST API = 标准化配送流程

就像所有物流公司都遵循相同的配送标准：
- 订单格式统一（JSON）
- 配送路线统一（URL 路径）
- 配送方法统一（HTTP 方法）
- 配送结果统一（HTTP 状态码）

这样，不同的物流系统（Flask、Django、FastAPI）都可以互相理解
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76ae4a4bc53c4d92964ecb059ed8b393~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z-p5biI5YKF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768040796&amp;x-signature=MkuEAY2vrDDmH%2FoQowzY1jfGDJU%3D" alt="image.png" loading="lazy"/></p>
<p><strong>重要理解</strong>：</p>
<ul>
<li>✅ REST API 是一个<strong>概念</strong>，不是某个具体的物流系统</li>
<li>✅ 不同的物流系统（Flask、Django、FastAPI）都可以遵循 REST API 概念</li>
<li>✅ 遵循 REST API 概念，可以让不同的系统互相理解</li>
</ul>
<hr/>
<hr/>
<h2 data-id="heading-4">📚 系列导航</h2>
<p><strong>系列名称</strong>：Web API 演进史：从 CGI 到 FastAPI<br/>
<em>（用物流系统比喻讲解 Web API 演进）</em></p>
<ul>
<li><a href="https://juejin.cn/post/7589932422655344676" target="_blank" title="https://juejin.cn/post/7589932422655344676">片段1：从重启马车到常驻运输队</a></li>
<li><a href="https://juejin.cn/post/7590421489997889555" target="_blank" title="https://juejin.cn/post/7590421489997889555">片段2：从随叫随到到规范配送</a> ← 当前文章</li>
<li><a href="https://juejin.cn/post/7590421489997922323" target="_blank" title="https://juejin.cn/post/7590421489997922323">片段3：从物流法典到智能调度</a></li>
</ul>
<hr/>
<blockquote>
<p>📝 片段2 结束<br/>
🔄 下一片段预告：<br/>
有了《物流法典》之后，各大法师开始制定自己的送货规章——REST API 的细节约定、FastAPI 的登场与智能化的调度中心也即将现身。最后的进化阶段，要开始了……</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[zustand源码解析]]></title>    <link>https://juejin.cn/post/7590592594674417674</link>    <guid>https://juejin.cn/post/7590592594674417674</guid>    <pubDate>2026-01-03T08:19:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590592594674417674" data-draft-id="7590592594674401290" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="zustand源码解析"/> <meta itemprop="keywords" content="源码阅读,前端"/> <meta itemprop="datePublished" content="2026-01-03T08:19:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="lzh_hz"/> <meta itemprop="url" content="https://juejin.cn/user/2348212566891831"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            zustand源码解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2348212566891831/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    lzh_hz
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T08:19:16.000Z" title="Sat Jan 03 2026 08:19:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">zustand是什么，如何使用</h2>
<p>Zustand 是一个轻量级的 React 状态管理库，比 Redux 简单，比 Context 高效。</p>
<ul>
<li>核心代码约 100 行，API 简单直观。</li>
<li>无Provider</li>
<li>符合 React Hooks 使用习惯</li>
<li>只更新订阅了变化状态的组件。</li>
<li>完整的类型推断和支持。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { create } <span class="hljs-keyword">from</span> <span class="hljs-string">'zustand'</span>

<span class="hljs-comment">// 1️⃣ 定义类型（TypeScript）</span>
interface <span class="hljs-title class_">BearStore</span> {
  <span class="hljs-attr">bears</span>: number
  <span class="hljs-attr">fish</span>: number
  <span class="hljs-attr">addBear</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">void</span>
  <span class="hljs-attr">eatFish</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">void</span>
  <span class="hljs-attr">reset</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">void</span>
}

<span class="hljs-comment">// 2️⃣ 创建 Store</span>
<span class="hljs-keyword">const</span> useBearStore = create&lt;<span class="hljs-title class_">BearStore</span>&gt;(<span class="hljs-function">(<span class="hljs-params">set</span>) =&gt;</span> ({
  <span class="hljs-attr">bears</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">fish</span>: <span class="hljs-number">10</span>,
  <span class="hljs-attr">addBear</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">set</span>(<span class="hljs-function">(<span class="hljs-params">s</span>) =&gt;</span> ({ <span class="hljs-attr">bears</span>: s.<span class="hljs-property">bears</span> + <span class="hljs-number">1</span> })),
  <span class="hljs-attr">eatFish</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">set</span>(<span class="hljs-function">(<span class="hljs-params">s</span>) =&gt;</span> ({ <span class="hljs-attr">fish</span>: s.<span class="hljs-property">fish</span> - <span class="hljs-number">1</span> })),
  <span class="hljs-attr">reset</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">set</span>({ <span class="hljs-attr">bears</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">fish</span>: <span class="hljs-number">10</span> })
}))

<span class="hljs-comment">// 3️⃣ 组件 A：只订阅 bears</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">BearCounter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> bears = <span class="hljs-title function_">useBearStore</span>(<span class="hljs-function">(<span class="hljs-params">s</span>) =&gt;</span> s.<span class="hljs-property">bears</span>)
  <span class="hljs-keyword">const</span> addBear = <span class="hljs-title function_">useBearStore</span>(<span class="hljs-function">(<span class="hljs-params">s</span>) =&gt;</span> s.<span class="hljs-property">addBear</span>)
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>🐻 Bears: {bears}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{addBear}</span>&gt;</span>Add Bear<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}

<span class="hljs-comment">// 4️⃣ 组件 B：只订阅 fish</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">FishCounter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> fish = <span class="hljs-title function_">useBearStore</span>(<span class="hljs-function">(<span class="hljs-params">s</span>) =&gt;</span> s.<span class="hljs-property">fish</span>)
  <span class="hljs-keyword">const</span> eatFish = <span class="hljs-title function_">useBearStore</span>(<span class="hljs-function">(<span class="hljs-params">s</span>) =&gt;</span> s.<span class="hljs-property">eatFish</span>)
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>🐟 Fish: {fish}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{eatFish}</span>&gt;</span>Eat Fish<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}

<span class="hljs-comment">// 5️⃣ 主应用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">BearCounter</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">FishCounter</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<h2 data-id="heading-1">当调用zustand的create时会发生什么</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> create <span class="hljs-keyword">from</span> <span class="hljs-string">'zustand'</span>;
<span class="hljs-keyword">const</span> useStore = <span class="hljs-title function_">create</span>(<span class="hljs-function">(<span class="hljs-params">set</span>) =&gt;</span> ({
  <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">increment</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">set</span>(<span class="hljs-function">(<span class="hljs-params">s</span>) =&gt;</span> ({ <span class="hljs-attr">count</span>: s.<span class="hljs-property">count</span> + <span class="hljs-number">1</span> }))
}))
</code></pre>
<p>create 方法最终会调用vanvailla.ts中的createStoreImp 函数</p>
<p>createStoreImp主要完成的功能:</p>
<ul>
<li>创建zustand的api(setSate,getState,getInitialState, subscribe)</li>
<li>在调用时会执行传入的函数，将最终结果赋值给 initialState</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 这里的createState是下面这个函数</span>
<span class="hljs-comment">// (set) =&gt; ({</span>
<span class="hljs-comment">//   count: 0,</span>
<span class="hljs-comment">//   increment: () =&gt; set((s) =&gt; ({ count: s.count + 1 }))</span>
<span class="hljs-comment">// })</span>
<span class="hljs-comment">// 最终initialState的值是</span>
<span class="hljs-comment">// { </span>
<span class="hljs-comment">//   count:0,</span>
<span class="hljs-comment">//   increment:() =&gt; set((s) =&gt; ({ count: s.count + 1 }))</span>
<span class="hljs-comment">// }</span>

<span class="hljs-keyword">const</span> initialState = (state = <span class="hljs-title function_">createState</span>(setState, getState, api))
<span class="hljs-keyword">return</span> api <span class="hljs-keyword">as</span> any
</code></pre>
<p>createStoreImp返回的api会在react.ts中的createImp中使用</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'./vanilla.ts'</span>
<span class="hljs-keyword">const</span> createImpl = &lt;T&gt;<span class="hljs-function">(<span class="hljs-params">createState: StateCreator&lt;T, [], []&gt;</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> api = <span class="hljs-title function_">createStore</span>(createState)

  <span class="hljs-keyword">const</span> <span class="hljs-attr">useBoundStore</span>: any = <span class="hljs-function">(<span class="hljs-params">selector?: any</span>) =&gt;</span> <span class="hljs-title function_">useStore</span>(api, selector)

  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(useBoundStore, api)

  <span class="hljs-keyword">return</span> useBoundStore
}
</code></pre>
<p>useStore会创建一个hook, 将获取到的api 传入React.useSyncExternalStore()方法，从而实现当setSate时，订阅了这个state的组件都会触发重新渲染.</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> useStore&lt;<span class="hljs-title class_">TState</span>, <span class="hljs-title class_">StateSlice</span>&gt;(
  <span class="hljs-attr">api</span>: <span class="hljs-title class_">ReadonlyStoreApi</span>&lt;<span class="hljs-title class_">TState</span>&gt;,
  <span class="hljs-attr">selector</span>: <span class="hljs-function">(<span class="hljs-params">state: TState</span>) =&gt;</span> <span class="hljs-title class_">StateSlice</span> = identity <span class="hljs-keyword">as</span> any,
) {
  <span class="hljs-keyword">const</span> slice = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useSyncExternalStore</span>(
    api.<span class="hljs-property">subscribe</span>,
    <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">selector</span>(api.<span class="hljs-title function_">getState</span>()), [api, selector]),
    <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">selector</span>(api.<span class="hljs-title function_">getInitialState</span>()), [api, selector]),
  )
  <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useDebugValue</span>(slice)
  <span class="hljs-keyword">return</span> slice
}
</code></pre>
<p>当在一个组件调用useStore时，都会执行React.useSyncExternalStore()，useSyncExternalStore() 会执行api.subscribe.  api.subscibe定义在vanilla.ts的createStoreImp函数中</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 这里的listener是由react的useSyncExtenalStore传入的callback function, 会注册到listeners里</span>
<span class="hljs-comment">// 调用callback function会触发组件重新渲染</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">subscribe</span>: <span class="hljs-title class_">StoreApi</span>&lt;<span class="hljs-title class_">TState</span>&gt;[<span class="hljs-string">'subscribe'</span>] = <span class="hljs-function">(<span class="hljs-params">listener</span>) =&gt;</span> {
    listeners.<span class="hljs-title function_">add</span>(listener)
    <span class="hljs-comment">// Unsubscribe</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> listeners.<span class="hljs-title function_">delete</span>(listener)
  }
<span class="hljs-comment">// 当 setSate里，会执行listeners里的callback function, 从而实现组件更新</span>
 <span class="hljs-keyword">const</span> <span class="hljs-attr">setState</span>: <span class="hljs-title class_">StoreApi</span>&lt;<span class="hljs-title class_">TState</span>&gt;[<span class="hljs-string">'setState'</span>] = <span class="hljs-function">(<span class="hljs-params">partial, replace</span>) =&gt;</span> {
    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Remove type assertion once https://github.com/microsoft/TypeScript/issues/37663 is resolved</span>
    <span class="hljs-comment">// https://github.com/microsoft/TypeScript/issues/37663#issuecomment-759728342</span>
    <span class="hljs-keyword">const</span> nextState =
      <span class="hljs-keyword">typeof</span> partial === <span class="hljs-string">'function'</span>
        ? (partial <span class="hljs-keyword">as</span> (<span class="hljs-attr">state</span>: <span class="hljs-title class_">TState</span>) =&gt; <span class="hljs-title class_">TState</span>)(state)
        : partial
    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">is</span>(nextState, state)) {
      <span class="hljs-keyword">const</span> previousState = state
      state =
        (replace ?? (<span class="hljs-keyword">typeof</span> nextState !== <span class="hljs-string">'object'</span> || nextState === <span class="hljs-literal">null</span>))
          ? (nextState <span class="hljs-keyword">as</span> <span class="hljs-title class_">TState</span>)
          : <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, state, nextState)
      <span class="hljs-comment">// 关键实现</span>
      listeners.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">listener</span>) =&gt;</span> <span class="hljs-title function_">listener</span>(state, previousState))
    }
  }

</code></pre>
<p>再回到react.ts中的createImpl函数，会返回一个hook给业务组件去调用</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> api = <span class="hljs-title function_">createStore</span>(...)  <span class="hljs-comment">// api 已创建                         │</span>
│                                                                      │
│  <span class="hljs-comment">// 创建 Hook 函数                                                    │</span>
│  <span class="hljs-keyword">const</span> <span class="hljs-title function_">useBoundStore</span> = (<span class="hljs-params">selector</span>) =&gt; <span class="hljs-title function_">useStore</span>(api, selector)         │
│  <span class="hljs-comment">//                                     │                            │</span>
│  <span class="hljs-comment">//  闭包捕获 api ◄─────────────────────┘                            │</span>
│                                                                      │
│  <span class="hljs-comment">// 将 api 方法挂载到 Hook 上                                         │</span>
│  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(useBoundStore, api)                                   │
│  <span class="hljs-comment">//                                                                  │</span>
│  <span class="hljs-comment">//  useBoundStore.getState = api.getState                           │</span>
│  <span class="hljs-comment">//  useBoundStore.setState = api.setState                           │</span>
│  <span class="hljs-comment">//  useBoundStore.subscribe = api.subscribe                         │</span>
│                                                                      │
│  <span class="hljs-keyword">return</span> useBoundStore                                                │
│                           
</code></pre>
<p>create函数主要作了以下三件事:</p>
<ul>
<li>创建 vanilla store (包含zustand的api)</li>
<li>调用用户函数</li>
<li>包装成hook</li>
</ul>
<h2 data-id="heading-2">当getState时会发生什么</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> useStore = <span class="hljs-title function_">create</span>(<span class="hljs-function">(<span class="hljs-params">set</span>) =&gt;</span> ({
  <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">name</span>: <span class="hljs-string">'zustand'</span>
}))

<span class="hljs-comment">// 获取当前状态</span>
<span class="hljs-keyword">const</span> state = useStore.<span class="hljs-title function_">getState</span>()
<span class="hljs-comment">// { count: 0, name: 'zustand' }</span>

<span class="hljs-comment">// 获取特定字段</span>
<span class="hljs-keyword">const</span> count = useStore.<span class="hljs-title function_">getState</span>().<span class="hljs-property">count</span>
<span class="hljs-comment">// 0</span>
</code></pre>
<p>根据上面的create实现解析，useStore的getState()最终会调用定义在vanilla.ts中的createStoreImpl中的getState</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-attr">getState</span>: <span class="hljs-title class_">StoreApi</span>&lt;<span class="hljs-title class_">TState</span>&gt;[<span class="hljs-string">'getState'</span>] = <span class="hljs-function">() =&gt;</span> state
<span class="hljs-comment">// 如果调用时未触发setState， 获取到的是用户在ceate时传入的state, 调用create时会执行以下代码</span>
<span class="hljs-keyword">const</span> initialState = (state = <span class="hljs-title function_">createState</span>(setState, getState, api))

</code></pre>
<h2 data-id="heading-3">当setState时会发生什么</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> useStore = <span class="hljs-title function_">create</span>(<span class="hljs-function">(<span class="hljs-params">set</span>) =&gt;</span> ({
  <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>
}))

<span class="hljs-comment">// 在任何地方</span>
useStore.<span class="hljs-title function_">setState</span>({ <span class="hljs-attr">count</span>: <span class="hljs-number">10</span> })
</code></pre>
<p>据上面的create实现解析，useStore的getState()最终会调用定义在vanilla.ts中的createStoreImpl中的setSate</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">setState</span> = (<span class="hljs-params">partial, replace</span>) =&gt; {
  <span class="hljs-comment">// 1️⃣ 计算新状态</span>
  <span class="hljs-keyword">const</span> nextState =
    <span class="hljs-keyword">typeof</span> partial === <span class="hljs-string">'function'</span>
      ? <span class="hljs-title function_">partial</span>(state)    <span class="hljs-comment">// 函数式：调用函数得到新状态</span>
      : partial           <span class="hljs-comment">// 对象式：直接使用</span>

  <span class="hljs-comment">// 2️⃣ 检查是否真的变化</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">is</span>(nextState, state)) {
    <span class="hljs-keyword">const</span> previousState = state
    
    <span class="hljs-comment">// 3️⃣ 决定合并还是替换</span>
    state =
      (replace ?? (<span class="hljs-keyword">typeof</span> nextState !== <span class="hljs-string">'object'</span> || nextState === <span class="hljs-literal">null</span>))
        ? nextState                         <span class="hljs-comment">// 替换</span>
        : <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, state, nextState)  <span class="hljs-comment">// 浅合并</span>

    <span class="hljs-comment">// 4️⃣ 通知所有订阅者</span>
    listeners.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">listener</span>) =&gt;</span> <span class="hljs-title function_">listener</span>(state, previousState))
  }
}
</code></pre>
<p>setSate时不会触发所有组件的更新，只会触发订阅了相关state的组件更新</p>
<pre><code class="hljs language-javascript" lang="javascript">onst useStore = <span class="hljs-title function_">create</span>(<span class="hljs-function">(<span class="hljs-params">set</span>) =&gt;</span> ({
  <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">name</span>: <span class="hljs-string">'zustand'</span>,
  <span class="hljs-attr">updateCount</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">set</span>({ <span class="hljs-attr">count</span>: <span class="hljs-number">1</span> }),
  <span class="hljs-attr">updateName</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">set</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'bear'</span> })
}))

<span class="hljs-comment">// 组件 A：只订阅 count</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">CounterA</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'CounterA 渲染'</span>)
  <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">useStore</span>(<span class="hljs-function">(<span class="hljs-params">s</span>) =&gt;</span> s.<span class="hljs-property">count</span>)  <span class="hljs-comment">// ← 只关心 count</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{count}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}

<span class="hljs-comment">// 组件 B：只订阅 name</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">CounterB</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'CounterB 渲染'</span>)
  <span class="hljs-keyword">const</span> name = <span class="hljs-title function_">useStore</span>(<span class="hljs-function">(<span class="hljs-params">s</span>) =&gt;</span> s.<span class="hljs-property">name</span>)  <span class="hljs-comment">// ← 只关心 name</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}

<span class="hljs-comment">// 组件 C：订阅全部</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">CounterC</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'CounterC 渲染'</span>)
  <span class="hljs-keyword">const</span> state = <span class="hljs-title function_">useStore</span>()  <span class="hljs-comment">// ← 关心所有</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{state.count} - {state.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}
</code></pre>
<p>当组件A调用userStore时，最终会执行react.ts中的useStore</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 这里的select就是组件A传入的(s) =&gt; s.name</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> useStore&lt;<span class="hljs-title class_">TState</span>, <span class="hljs-title class_">StateSlice</span>&gt;(
  <span class="hljs-attr">api</span>: <span class="hljs-title class_">ReadonlyStoreApi</span>&lt;<span class="hljs-title class_">TState</span>&gt;,
  <span class="hljs-attr">selector</span>: <span class="hljs-function">(<span class="hljs-params">state: TState</span>) =&gt;</span> <span class="hljs-title class_">StateSlice</span> = identity <span class="hljs-keyword">as</span> any,
) {
  <span class="hljs-comment">// getSnapshot 通过 selector 只取需要的部分, 只有需要的部分的值发送变化时，才会触发更新</span>
  <span class="hljs-keyword">const</span> slice = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useSyncExternalStore</span>(
    api.<span class="hljs-property">subscribe</span>,
    <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">selector</span>(api.<span class="hljs-title function_">getState</span>()), [api, selector]),
    <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">selector</span>(api.<span class="hljs-title function_">getInitialState</span>()), [api, selector]),
  )
  <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useDebugValue</span>(slice)
  <span class="hljs-keyword">return</span> slice
}
</code></pre>
<p>具体流程</p>
<ol>
<li>
<p>setState 改变状态</p>
</li>
<li>
<p>通知所有订阅的组件（所有使用 useStore 的组件）</p>
</li>
<li>
<p>每个组件执行自己的 selector(newState)</p>
</li>
<li>
<p>比较 selector 返回的新旧值</p>
<pre><code class="hljs">│

├── 相等 → 不重渲染

│

└── 不等 → 重渲染
</code></pre>
</li>
</ol>
<h2 data-id="heading-4">Rect.useSyncExternalStore解析</h2>
<p>react 18 新增的 Hook，用于安全地订阅外部数据源。</p>
<p>简化实现</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useSyncExternalStore</span>(<span class="hljs-params">subscribe, getSnapshot, getServerSnapshot</span>) {
  <span class="hljs-comment">// 存储当前快照</span>
  <span class="hljs-keyword">const</span> [snapshot, setSnapshot] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// SSR 时用 getServerSnapshot</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> === <span class="hljs-string">'undefined'</span> 
      ? getServerSnapshot?.() 
      : <span class="hljs-title function_">getSnapshot</span>()
  })

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// React 创建的 callback</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">callback</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">const</span> newSnapshot = <span class="hljs-title function_">getSnapshot</span>()
      <span class="hljs-comment">// 只有真正变化才更新</span>
      <span class="hljs-title function_">setSnapshot</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">is</span>(prev, newSnapshot)) {
          <span class="hljs-keyword">return</span> prev  <span class="hljs-comment">// 返回旧值，不触发更新</span>
        }
        <span class="hljs-keyword">return</span> newSnapshot
      })
    }

    <span class="hljs-comment">// 订阅</span>
    <span class="hljs-keyword">const</span> unsubscribe = <span class="hljs-title function_">subscribe</span>(callback)

    <span class="hljs-comment">// 清理</span>
    <span class="hljs-keyword">return</span> unsubscribe
  }, [subscribe, getSnapshot])

  <span class="hljs-keyword">return</span> snapshot
}
</code></pre>
<p>具体流程：</p>
<ol>
<li>Mount<br/>
├── 1.1 getSnapshot() → 初始值<br/>
├── 1.2 subscribe(callback) → 注册<br/>
└── 1.3 return 初始值</li>
<li>状态变化<br/>
├── 2.1 你调用 callback()<br/>
├── 2.2 React 调用 getSnapshot() → 新值<br/>
├── 2.3 Object.is(旧值, 新值)<br/>
└── 2.4 相等？<br/>
├── 2.4.1 是 → 跳过<br/>
└── 2.4.2 否 → 重渲染</li>
<li>Unmount<br/>
└── 3.1 调用 unsubscribe()</li>
</ol>
<h2 data-id="heading-5">总结</h2>
<p>核心实现是使用React.useSyncExternalStore hook， 创建一个store， 当state里的值发生改变时，触发订阅了state的值的组件重新渲染。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[图文+示例，带你彻底搞清楚那些加密手段...！]]></title>    <link>https://juejin.cn/post/7590213554798542883</link>    <guid>https://juejin.cn/post/7590213554798542883</guid>    <pubDate>2026-01-03T09:02:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590213554798542883" data-draft-id="7590128405351792640" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="图文+示例，带你彻底搞清楚那些加密手段...！"/> <meta itemprop="keywords" content="安全,程序员"/> <meta itemprop="datePublished" content="2026-01-03T09:02:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="momo06117"/> <meta itemprop="url" content="https://juejin.cn/user/3103246594353275"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            图文+示例，带你彻底搞清楚那些加密手段...！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3103246594353275/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    momo06117
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T09:02:39.000Z" title="Sat Jan 03 2026 09:02:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>最近，小编在学习的过程中有了解到加密的手段，因此想来分享一下自己学到的一些新知识。如有讲得不好或遗漏 欢迎各位大佬在评论区指出。</p>
<h2 data-id="heading-1">关于加密</h2>
<p>加密是<strong>指通过特定手段将明文存储的内容加密成密文</strong>。那么为什么要进行加密呢？</p>
<p>互联网中各种攻击防不胜防，如果敏感内容不加密存储，例如用户密码之类的（一想到自己的密码明晃晃的暴露在传输过程中，是不是有点后背一凉的感觉~），那攻击者就能够轻易获取用户隐私信息并实施攻击。</p>
<p>因此加密是必不可少的。那么<strong>加密的手段有哪些？或者我们在针对什么场景应该做什么加密？</strong></p>
<p>下面小编一一介绍并通过node手段简单实现。</p>
<h3 data-id="heading-2">hash加密</h3>
<p>加密手段中，最常见的就是hash加密，指通过一定的算法将明文转化为密文。</p>
<blockquote>
<p>比如将密码abc随机后退3格加密成为dfg，这是一种最简单的加密手段。</p>
</blockquote>
<p>现代常见最常见的加密手段有<code>MD5</code>，<code>SHA</code>加密等，由于其复杂性hash加密是不可逆的。但是由于hash算法固定，<strong>因此同一个密码加密后是相同的密文</strong>，因此攻击者想到可以通过<code>彩虹表</code>攻击。</p>
<p>故实际生产中，我们往往会往明文先<strong>加盐</strong>（一段随机的字符串插入），然后再进行hash加密。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b918c32c6e5948ae95d5726730937fd0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9tbzA2MTE3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768035759&amp;x-signature=tKXDFYKI31YbGog63yv84hp9l%2FM%3D" alt="image.png" loading="lazy"/></p>
<p><strong>使用场景</strong>： 数据库中的<strong>密码存储</strong>（由于hash不可逆，实则程序员也不知道你的密码）</p>
<p><strong>实现示例</strong>： 使用bcrypt进行加密</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//自动加盐并且内嵌</span>
<span class="hljs-keyword">const</span> hashPassword = bcrypt.<span class="hljs-title function_">hashSync</span>(password,<span class="hljs-number">10</span>) 
<span class="hljs-comment">//解密</span>
<span class="hljs-keyword">const</span> compareResult = bcrypt.<span class="hljs-title function_">compareSync</span>(userinfo.<span class="hljs-property">password</span>,result[<span class="hljs-number">0</span>].<span class="hljs-property">password</span>)
</code></pre>
<h3 data-id="heading-3">对称加密</h3>
<p><em>上面说到了hash算法，但由于hash算法是不可逆的，故常用于存储加密，而实际开发中我们会经常用到传输加密，故对称加密应运而生。</em></p>
<p>对称加密是指将<strong>密码通过密钥加密后生成密文</strong>，对方再<strong>通过同一密钥破解生成的密文。</strong></p>
<p><strong>常见手段</strong>：<code>AES加密</code></p>
<p><strong>优缺点</strong>：加密简单，解密<strong>速度快</strong>。但密钥的管理和传输困难。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/192a49f73a87464d8ff1b625fee4f428~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9tbzA2MTE3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768035759&amp;x-signature=yahfUQEuuQj%2Bi05fLJdFlPaqz5k%3D" alt="image.png" loading="lazy"/></p>
<p><strong>实际场景</strong>：大量需要被加密的内容</p>
<p><strong>实现示例</strong>：使用<code>CryptoJS</code>进行AES加密</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> cryptoJs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto-js'</span>)

<span class="hljs-keyword">const</span> message = <span class="hljs-string">'hello word'</span>
<span class="hljs-keyword">const</span> key = <span class="hljs-string">'this is key'</span> <span class="hljs-comment">//实际过程中 对称密钥通常是随机生成的</span>

<span class="hljs-comment">//加密</span>
<span class="hljs-keyword">const</span> encrypted = cryptoJs.<span class="hljs-property">AES</span>.<span class="hljs-title function_">encrypt</span>(message, key)

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'对称加密密文：'</span>,encrypted.<span class="hljs-title function_">toString</span>())

<span class="hljs-comment">//将密文解密</span>
<span class="hljs-keyword">const</span> decryptedMessage  = cryptoJs.<span class="hljs-property">AES</span>.<span class="hljs-title function_">decrypt</span>(encrypted,key)

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'解密：'</span>,decryptedMessage.<span class="hljs-title function_">toString</span>(cryptoJs.<span class="hljs-property">enc</span>.<span class="hljs-property">Utf8</span>))
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a00ad039ab7b42898bf6f5de2f307e04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9tbzA2MTE3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768035759&amp;x-signature=UkhfZ2z3D2m2NjxIsKkyoF7f9ko%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">非对称加密</h3>
<p><em>目的是为了解决上面提到的密钥安全问题，对称加密密钥被截获，密文也就轻易可知了。</em></p>
<p>非对称加密是指发送端用<strong>公钥</strong>进行加密，然后采用<strong>私钥</strong>进行解密，公钥是公开的，私钥是只有接受方才有的。就像一个箱子，发送方把用锁把箱子锁上，接收方用钥匙解锁。</p>
<p><strong>常见手段</strong>:<code> RSA非对称加密</code></p>
<p><strong>优缺点</strong>： 由于私钥只有接收方可知，<strong>保密性好</strong>。但加密和解密比较耗时。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02606218f9b5453897aa65a0e75d0c88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9tbzA2MTE3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768035759&amp;x-signature=AQGSXsc4exWRSckuaEzxKQNImwo%3D" alt="image.png" loading="lazy"/></p>
<p><strong>实际场景</strong>： 密钥交换，数字签名</p>
<p><strong>实现示例</strong>： 使用node原生crypto进行RSA非对称加密</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto'</span>)

<span class="hljs-comment">// 生成RSA密钥对</span>
<span class="hljs-keyword">const</span> { publicKey, privateKey } = crypto.<span class="hljs-title function_">generateKeyPairSync</span>(<span class="hljs-string">'rsa'</span>, {
  <span class="hljs-attr">modulusLength</span>: <span class="hljs-number">2048</span>, <span class="hljs-comment">// 密钥长度</span>
  <span class="hljs-attr">publicKeyEncoding</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-string">'spki'</span>,
    <span class="hljs-attr">format</span>: <span class="hljs-string">'pem'</span>
  },
  <span class="hljs-attr">privateKeyEncoding</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-string">'pkcs8'</span>,
    <span class="hljs-attr">format</span>: <span class="hljs-string">'pem'</span>
  }
})

<span class="hljs-keyword">const</span> data = <span class="hljs-string">'hello word'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'原始数据:'</span>, data);

<span class="hljs-comment">// 使用公钥加密</span>
<span class="hljs-keyword">const</span> encryptedData = crypto.<span class="hljs-title function_">publicEncrypt</span>(
  {
    <span class="hljs-attr">key</span>: publicKey,
    <span class="hljs-attr">padding</span>: crypto.<span class="hljs-property">constants</span>.<span class="hljs-property">RSA_PKCS1_OAEP_PADDING</span>
  },
  <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(data)
)

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'加密后 (base64):'</span>, encryptedData.<span class="hljs-title function_">toString</span>(<span class="hljs-string">'base64'</span>))

<span class="hljs-comment">// 使用私钥解密</span>
<span class="hljs-keyword">const</span> decryptedData = crypto.<span class="hljs-title function_">privateDecrypt</span>(
  {
    <span class="hljs-attr">key</span>: privateKey,
    <span class="hljs-attr">padding</span>: crypto.<span class="hljs-property">constants</span>.<span class="hljs-property">RSA_PKCS1_OAEP_PADDING</span>
  },
  encryptedData
)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'解密后:'</span>, decryptedData.<span class="hljs-title function_">toString</span>())
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/107deb59b637439c97f0e2c6d48ac996~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9tbzA2MTE3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768035759&amp;x-signature=HiSrp0WC1E5VMgoREVlpENEe2mc%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-5">混合加密</h3>
<p>上面有说到对称加密和非对称加密的优缺点，那么有没有集两者大成，既适合传输大量内容又密钥管理安全的方案呢？
答案是有的，那就是混合加密。</p>
<p>混合加密是指用<code>非对称加密</code> 加密 <code>对称加密的密钥</code>，可能有点绕，下面详细介绍一下。</p>
<p><strong>加密过程</strong>：</p>
<ol>
<li>服务器生成一对公钥和私钥，<strong>将公钥发送给客户端</strong></li>
<li>客户端收到私钥后，<strong>随机生成一对会话密钥（对称密钥）用服务器的公钥加密后发送</strong></li>
<li>服务器收到密文后，<strong>用私钥解密，会话密钥</strong></li>
<li>此时，服务器和客户端都有会话密钥，此后都使用<strong>会话密钥加密对话</strong></li>
</ol>
<p><strong>优缺点</strong>：只需要前期少量资源用于非对称加密，后期可用对称加密传输大量内容，但实现比较复杂</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69da4ac4205b40c0872c21fb559f953b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9tbzA2MTE3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768035759&amp;x-signature=lN9rmh9ZcQknNrzvO7ocq0VrGaM%3D" alt="image.png" loading="lazy"/></p>
<p><strong>实际场景</strong>： http加密的重要手段，现代大量加密场景等。</p>
<h2 data-id="heading-6">总结</h2>
<p>总的来说，加密是我们开发过程中必不可少的一环，针对不同的环境，做出不同的加密手段是我们作为开发者必不可少的综合技能~</p>















































<table><thead><tr><th>特性</th><th>Hash加密</th><th>对称加密</th><th>非对称加密</th><th>混合加密</th></tr></thead><tbody><tr><td><strong>加密类型</strong></td><td>加密存储</td><td>加密传输</td><td>加密传输</td><td>加密传输</td></tr><tr><td><strong>核心原理</strong></td><td>单向散列函数</td><td>相同密钥加解密</td><td>公钥加密，私钥解密</td><td>非对称加密保护对称密钥</td></tr><tr><td><strong>密钥数量</strong></td><td>无密钥（有盐值）</td><td>1个共享密钥</td><td>2个密钥（公钥+私钥）</td><td>3个密钥（非对称对+对称密钥）</td></tr><tr><td><strong>安全性</strong></td><td>防篡改，不可逆</td><td>依赖密钥安全</td><td>依赖数学难题安全</td><td>综合安全等级最高</td></tr><tr><td><strong>推荐场景</strong></td><td>需要验证但不需要解密的场景</td><td>内部系统、大量加密</td><td>密钥分发、身份认证</td><td>公网通信、高安全要求</td></tr></tbody></table>
<p><em>制作不易 礼貌集赞</em></p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f971a67e95f456aa4c8a14f1fdce448~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9tbzA2MTE3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768035759&amp;x-signature=PYkD7YOu1mrO7DWRHOIq6Rfu8eQ%3D" alt="image.png" width="30%" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 之 自定义 Hooks 🚀]]></title>    <link>https://juejin.cn/post/7590292192988971048</link>    <guid>https://juejin.cn/post/7590292192988971048</guid>    <pubDate>2026-01-03T09:15:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590292192988971048" data-draft-id="7590403249560633359" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React  之  自定义 Hooks 🚀"/> <meta itemprop="keywords" content="React.js,前端,面试"/> <meta itemprop="datePublished" content="2026-01-03T09:15:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xiaoxue_"/> <meta itemprop="url" content="https://juejin.cn/user/4065372122398027"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React  之  自定义 Hooks 🚀
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4065372122398027/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xiaoxue_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T09:15:48.000Z" title="Sat Jan 03 2026 09:15:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    15
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">自定义 Hooks 🚀</h2>
<p>在 React 的世界里，Hooks 就像一把神奇的钥匙，为函数组件打开了状态管理和生命周期的大门。今天我们就来深入探索自定义 Hooks 的奥秘，看看它如何让我们的代码更优雅、更可复用！</p>
<h3 data-id="heading-1">一、hooks 详解 🧐</h3>
<h4 data-id="heading-2">1. 什么是 hooks ？</h4>
<p>Hooks 是 React 16.8 引入的新特性，它是一种<strong>函数编程思想的实践</strong>，允许我们在不编写类组件的情况下，在函数组件中使用状态（State）和其他 React 特性（如生命周期）。简单来说，Hooks 就是 “钩子”，能让我们轻松 “钩入” React 的内部特性，让函数组件拥有更强大的能力。</p>
<h4 data-id="heading-3">2. hooks 分类</h4>
<p>Hooks 主要分为两类：</p>
<ul>
<li><strong>React 内置 Hooks</strong>：如<code>useState</code>（管理状态）、<code>useEffect</code>（处理副作用）、<code>useContext</code>（共享上下文）等，这些是 React 官方提供的基础工具。</li>
<li><strong>自定义 Hooks</strong>：由开发者根据业务需求封装的 Hooks，命名以<code>use</code>开头，本质是对内置 Hooks 和业务逻辑的组合封装，方便复用。</li>
</ul>
<p>（前面我们讲解过 React 内置的 hooks 函数，感兴趣的小伙伴可以去翻翻我前面的文章看看）</p>
<h4 data-id="heading-4">3. hooks 有什么作用？</h4>
<ul>
<li>让函数组件具备状态管理能力，摆脱类组件的繁琐语法（如<code>this</code>绑定、生命周期函数嵌套）。</li>
<li>将组件中的相关逻辑聚合在一起，而非分散在不同的生命周期函数中（比如类组件中<code>componentDidMount</code>和<code>componentDidUpdate</code>可能写重复逻辑）。</li>
<li>实现逻辑复用，通过自定义 Hooks 将相同的状态逻辑抽离，供多个组件使用。</li>
</ul>
<h4 data-id="heading-5">4. 为什么需要自定义 hooks ？</h4>
<p>在开发中，我们经常会遇到多个组件需要共享相同状态逻辑的场景。比如：多个组件都需要监听鼠标位置、都需要处理本地存储数据、都需要发起相同的 API 请求等。</p>
<p>如果没有自定义 Hooks，我们可能会通过 “复制粘贴代码” 或 “高阶组件”“render props” 等方式复用逻辑，但这些方式要么导致代码冗余，要么增加组件层级复杂度。</p>
<p>而自定义 Hooks 就像一个 “逻辑容器”，能将这些重复逻辑抽离成独立函数，让组件只关注 UI 渲染，极大提升代码的复用性和可维护性！</p>
<h3 data-id="heading-6">二、先来看一个简单案例：响应式显示鼠标的位置 🖱️</h3>
<h4 data-id="heading-7">1. 需求分析</h4>
<p>我们要实现一个包含两个核心功能的小应用：</p>
<p>（1）<strong>计数功能</strong>：一个计数器，点击按钮可以增加数字。</p>
<p>（2）<strong>条件显示鼠标位置</strong>：当计数器的值为偶数时，显示鼠标在页面上的实时坐标；为奇数时，不显示。</p>
<h4 data-id="heading-8">2. 核心实现（两个文件）</h4>
<p>（1）<code>App2.jsx</code>：主组件，负责管理计数器状态和根据计数奇偶性条件渲染鼠标位置组件。</p>
<p>（2）<code>useMouse.js</code>：自定义 Hooks，封装鼠标位置监听的逻辑，提供<code>x</code>、<code>y</code>坐标供组件使用（向外暴露的状态和方法放在 return 中返回）。</p>
<h4 data-id="heading-9">3. 代码展示</h4>
<h5 data-id="heading-10">（1）App2.jsx</h5>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { useMouse } <span class="hljs-keyword">from</span> <span class="hljs-string">'./hooks/useMouse.js'</span>;

<span class="hljs-comment">// 鼠标位置展示组件（纯UI组件）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">MouseMove</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 调用自定义Hook获取鼠标坐标</span>
    <span class="hljs-keyword">const</span> { x, y } = <span class="hljs-title function_">useMouse</span>();
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
                鼠标位置：{x}, {y}
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/&gt;</span></span>
    );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 定义计数器状态，初始值为0</span>
    <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
            {/* 显示当前计数 */}
            {count}
            {/* 点击按钮增加计数（使用函数式更新确保获取最新count） */}
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount((count) =&gt; count + 1)}&gt;
                点击增加
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            {/* 当count为偶数时，渲染MouseMove组件显示鼠标位置 */}
            {count % 2 === 0 &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">MouseMove</span> /&gt;</span>}
        <span class="hljs-tag">&lt;/&gt;</span></span>
    )
}
</code></pre>
<p><strong>代码逻辑详解</strong>：</p>
<ul>
<li><code>App</code>组件通过<code>useState</code>管理计数器<code>count</code>的状态，点击按钮时通过<code>setCount</code>更新值。</li>
<li>定义了<code>MouseMove</code>组件，它不包含任何业务逻辑，仅通过调用<code>useMouse()</code>获取鼠标坐标并渲染，是一个纯 UI 组件。</li>
<li>通过条件渲染<code>{count % 2 === 0 &amp;&amp; &lt;MouseMove /&gt;}</code>实现 “偶数显示鼠标位置，奇数不显示” 的需求。</li>
</ul>
<h5 data-id="heading-11">（2）useMouse.js</h5>
<p>js</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 自定义Hook：封装鼠标位置监听逻辑（命名以use开头）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useMouse</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 定义状态存储鼠标x、y坐标，初始值为0</span>
    <span class="hljs-keyword">const</span> [x, setX] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">const</span> [y, setY] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

    <span class="hljs-comment">// 副作用：监听鼠标移动事件</span>
    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 事件处理函数：更新x、y坐标</span>
        <span class="hljs-keyword">const</span> <span class="hljs-title function_">update</span> = (<span class="hljs-params">event</span>) =&gt; {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'/////'</span>);
            <span class="hljs-title function_">setX</span>(event.<span class="hljs-property">pageX</span>); <span class="hljs-comment">// 更新x坐标为鼠标相对于文档的水平位置</span>
            <span class="hljs-title function_">setY</span>(event.<span class="hljs-property">pageY</span>); <span class="hljs-comment">// 更新y坐标为鼠标相对于文档的垂直位置</span>
        }
        <span class="hljs-comment">// 绑定mousemove事件，触发时调用update更新坐标</span>
        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousemove'</span>, update);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'||||| 挂载'</span>); <span class="hljs-comment">// 组件挂载时打印</span>

        <span class="hljs-comment">// 清理函数：组件卸载时移除事件监听，避免内存泄漏</span>
        <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'mousemove'</span>, update); <span class="hljs-comment">// 移除相同的事件处理函数</span>
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'===== 清除'</span>); <span class="hljs-comment">// 清理时打印</span>
        }
    }, []); <span class="hljs-comment">// 空依赖数组：仅在组件挂载时执行一次，卸载时执行清理</span>

    <span class="hljs-comment">// 返回鼠标坐标，供组件使用</span>
    <span class="hljs-keyword">return</span> {
        x,
        y,
    }
}
</code></pre>
<p><strong>代码逻辑详解</strong>：</p>
<ul>
<li>
<p><code>useMouse</code>遵循命名规范（以<code>use</code>开头），内部可以调用内置 Hooks（<code>useState</code>、<code>useEffect</code>）。</p>
</li>
<li>
<p>用<code>useState</code>定义<code>x</code>和<code>y</code>状态，分别存储鼠标的水平和垂直坐标。</p>
</li>
<li>
<p>用<code>useEffect</code>处理鼠标监听的副作用：</p>
<ul>
<li>挂载时：绑定<code>mousemove</code>事件，鼠标移动时触发<code>update</code>函数更新<code>x</code>、<code>y</code>。</li>
<li>卸载时：通过<code>useEffect</code>的返回函数移除<code>mousemove</code>事件监听，避免组件已卸载但事件仍触发的内存泄漏（比如当<code>count</code>为奇数时，<code>MouseMove</code>组件卸载，此时会执行清理函数）。</li>
</ul>
</li>
<li>
<p>最后返回包含<code>x</code>和<code>y</code>的对象，让组件可以获取鼠标坐标。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b705405c85ef47a5b17e097ff41195ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGlhb3h1ZV8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768041866&amp;x-signature=ouEpwutZVO56nhLVP1NUDhXOMrI%3D" alt="QQ20260103-184336.png" loading="lazy"/></p>
<h4 data-id="heading-12">4. 效果展示：</h4>
<ul>
<li>当点击按钮使<code>count</code>为 0、2、4 等偶数时，页面会显示 “鼠标位置：x, y”，移动鼠标时坐标会实时更新，控制台打印 “||||| 挂载”。</li>
<li>当点击按钮使<code>count</code>为 0、2、4 等偶数时，移动鼠标，控制台打印“/////”</li>
<li>当<code>count</code>为 1、3、5 等奇数时，鼠标位置不显示，控制台打印 “===== 清除”且不打印“/////”（表示事件监听已移除）。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e85e9f21c8cb4672bcec43e966698393~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGlhb3h1ZV8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768041866&amp;x-signature=N8wjjJQcE2e5MpwEBStosoiuzZg%3D" alt="QQ202613-165111.gif" loading="lazy"/></p>
<h3 data-id="heading-13">三、详解自定义 hooks 📚</h3>
<p>通过上面的简单案例，我们可以总结出关于自定义 Hooks 的必备知识：</p>
<h4 data-id="heading-14">1. 什么时候需要自定义 hooks ？</h4>
<p>（1）<strong>逻辑复用场景</strong>当多个组件需要共享相同的状态逻辑时，通过自定义 Hook 封装可避免代码重复。上面案例中，<code>useMouse</code>封装了鼠标位置监听的完整逻辑（状态管理、事件绑定 / 解绑），使得<code>MouseMove</code>组件无需重复编写该逻辑。若其他组件（如 “鼠标轨迹绘制组件”）也需要获取鼠标位置，可直接复用<code>useMouse</code>。</p>
<p>（2）<strong>分离 UI 与业务逻辑</strong>当组件中同时包含 UI 渲染和复杂业务逻辑（如事件监听、数据处理）时，自定义 Hooks 可将业务逻辑抽离，让组件只专注于 UI 展示。上面案例中，<code>MouseMove</code>组件仅负责渲染鼠标坐标（纯 UI 逻辑），而鼠标监听的业务逻辑被封装在<code>useMouse</code>中，使组件代码更简洁易维护。</p>
<p>（3）<strong>抽象复杂副作用逻辑</strong>当逻辑涉及<code>useState</code>、<code>useEffect</code>等 Hook 的组合使用（如状态管理 + 副作用处理）时，自定义 Hook 可将其抽象为独立单元，提高可读性。上面案例中<code>useMouse</code>整合了<code>useState</code>（管理 x、y 坐标）和<code>useEffect</code>（鼠标事件监听 / 清理），将分散的逻辑聚合为可复用的单元。</p>
<h4 data-id="heading-15">2. 如何自定义 hooks？</h4>
<p>（1）<strong>遵循命名规范</strong>函数名必须以<code>use</code>开头（如<code>useMouse</code>、<code>useTodos</code>），这是 React 的强制约定，确保 React 能识别 Hook 的调用规则（如只能在组件或其他 Hook 中使用）。</p>
<p>（2）<strong>封装核心逻辑</strong>在函数内部可调用其他 Hook（如<code>useState</code>、<code>useEffect</code>），并通过<code>return</code>暴露需要的状态或方法。案例中<code>useMouse</code>的实现步骤：</p>
<ul>
<li>用<code>useState</code>定义<code>x</code>和<code>y</code>状态，存储鼠标坐标；</li>
<li>用<code>useEffect</code>绑定<code>mousemove</code>事件，实时更新坐标；</li>
<li>通过<code>return { x, y }</code>将坐标暴露给组件使用。</li>
</ul>
<p>（3）<strong>设计返回值</strong>根据需求返回状态、方法或对象，方便组件灵活使用。案例中返回包含<code>x</code>和<code>y</code>的对象，组件通过<code>const { x, y } = useMouse()</code>直接获取坐标；若逻辑复杂（如待办事项管理），可返回状态和操作方法的集合（如<code>{ todos, addTodo, deleteTodo }</code>）。</p>
<h4 data-id="heading-16">3. 自定义 hooks 有什么注意事项？</h4>
<p>（1）<strong>严格遵循 Hook 调用规则</strong></p>
<ul>
<li>只能在组件函数或其他自定义 Hook 中调用（上面案例中<code>useMouse</code>在<code>MouseMove</code>组件中调用，符合规则）；</li>
<li>不能在循环、条件判断或普通函数中调用（避免 React 无法保证 Hook 调用顺序的一致性）。</li>
</ul>
<p>（2）<strong>清理副作用，避免内存泄漏</strong>若 Hook 包含副作用（如事件监听、定时器、API 请求），必须在<code>useEffect</code>的清理函数中移除副作用。上面案例中，<code>useMouse</code>在<code>useEffect</code>的返回函数中调用<code>removeEventListener</code>，确保<code>MouseMove</code>组件卸载时（<code>count</code>为奇数时）移除鼠标监听，避免组件已卸载但事件仍触发的内存泄漏（控制台会打印 “===== 清除” 验证）。</p>
<p>（3）<strong>保持单一职责</strong>一个自定义 Hook 应专注于解决一个特定问题。上面案例中<code>useMouse</code>仅负责鼠标位置监听，职责单一；若强行加入其他逻辑（如键盘监听）会导致 Hook 臃肿，降低复用性。</p>
<h3 data-id="heading-17">四、复杂案例实战：待办事项（Todo List）应用 📝</h3>
<h4 data-id="heading-18">1. 需求分析：</h4>
<p>本案例是一个基于 React 的待办事项应用，核心需求围绕待办事项的全生命周期管理，具体包括：</p>
<ul>
<li>输入框输入待办内容，点击添加按钮创建新待办；</li>
<li>勾选复选框标记待办事项为 “已完成” 或 “未完成”；</li>
<li>点击删除按钮移除特定待办事项；</li>
<li>页面刷新后，已添加的待办数据不丢失（本地持久化）；</li>
<li>无待办事项时显示空状态提示。</li>
</ul>
<p>核心痛点：如何将数据管理逻辑与 UI 渲染逻辑分离，实现代码复用和维护性提升 —— 这正是自定义 Hook 的核心应用场景。</p>
<h4 data-id="heading-19">2. 实现架构设计：</h4>
<p>（1）<strong>整体架构</strong>采用 “UI 组件 + 自定义 Hook” 的分离模式：</p>
<ul>
<li>UI 组件：负责渲染界面和处理用户交互（输入、点击等）；</li>
<li>自定义 Hooks（<code>useTodos</code>）：封装数据状态、业务逻辑和持久化操作。</li>
</ul>
<p>（2）<strong>核心设计：自定义 hooks 的职责</strong><code>useTodos</code>作为数据和逻辑的 “中央处理器”，承担以下职责：</p>
<ul>
<li>管理待办事项的响应式状态（<code>todos</code>数组）；</li>
<li>提供操作待办的方法（添加、切换状态、删除）；</li>
<li>实现数据本地持久化（<code>localStorage</code>读写）。</li>
</ul>
<h4 data-id="heading-20">3. 代码展示（核心代码）</h4>
<h5 data-id="heading-21">（1）自定义 Hook：useTodos.js</h5>
<p>js</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 封装响应式的todos业务逻辑</span>
<span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 定义localStorage的键名，用于存储待办数据</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">STORAGE_KEY</span> = <span class="hljs-string">'todos'</span>;

<span class="hljs-comment">// 从localStorage加载待办数据</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">loadFromStorge</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> <span class="hljs-title class_">StoredTodos</span> = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-variable constant_">STORAGE_KEY</span>);
    <span class="hljs-comment">// 若有数据则解析为JSON，否则返回空数组</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">StoredTodos</span> ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">StoredTodos</span>) : [];
}

<span class="hljs-comment">// 将待办数据保存到localStorage</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">saveToStorage</span>(<span class="hljs-params">todos</span>) {
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-variable constant_">STORAGE_KEY</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(todos));
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useTodos</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 初始化todos状态：从localStorage加载（useState接收函数，确保只执行一次）</span>
    <span class="hljs-keyword">const</span> [todos, setTodos] = <span class="hljs-title function_">useState</span>(loadFromStorge);

    <span class="hljs-comment">// 监听todos变化，实时保存到localStorage（持久化）</span>
    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">saveToStorage</span>(todos);
    }, [todos]); <span class="hljs-comment">// 依赖todos：只有todos变化时才执行</span>

    <span class="hljs-comment">// 添加待办事项</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">addTodo</span> = (<span class="hljs-params">text</span>) =&gt; {
        <span class="hljs-title function_">setTodos</span>([
            ...todos, <span class="hljs-comment">// 复制现有待办</span>
            { 
                <span class="hljs-attr">id</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(), <span class="hljs-comment">// 用时间戳作为唯一ID</span>
                text, <span class="hljs-comment">// 待办内容</span>
                <span class="hljs-attr">completed</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// 初始状态为未完成</span>
            }
        ]);
    }

    <span class="hljs-comment">// 切换待办事项的完成状态</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleTodo</span> = (<span class="hljs-params">id</span>) =&gt; {
        <span class="hljs-title function_">setTodos</span>(
            todos.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">todo</span>) =&gt;</span> {
                <span class="hljs-comment">// 找到目标待办，反转completed状态</span>
                <span class="hljs-keyword">if</span> (todo.<span class="hljs-property">id</span> === id) {
                    <span class="hljs-keyword">return</span> { ...todo, <span class="hljs-attr">completed</span>: !todo.<span class="hljs-property">completed</span> };
                }
                <span class="hljs-keyword">return</span> todo; <span class="hljs-comment">// 非目标待办不变</span>
            })
        );
    }

    <span class="hljs-comment">// 删除待办事项</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">deleteTodo</span> = (<span class="hljs-params">id</span>) =&gt; {
        <span class="hljs-title function_">setTodos</span>(
            todos.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">todo</span>) =&gt;</span> todo.<span class="hljs-property">id</span> !== id) <span class="hljs-comment">// 过滤掉要删除的待办</span>
        );
    }

    <span class="hljs-comment">// 暴露状态和方法给组件使用</span>
    <span class="hljs-keyword">return</span> {
        todos,
        addTodo,
        toggleTodo,
        deleteTodo,
    }
}
</code></pre>
<p><strong>逻辑详解</strong>：</p>
<ul>
<li><code>loadFromStorge</code>和<code>saveToStorage</code>：封装<code>localStorage</code>的读写逻辑，实现数据持久化（页面刷新后数据不丢失）。</li>
<li><code>useTodos</code>内部用<code>useState</code>管理<code>todos</code>状态，初始化时从本地存储加载数据。</li>
<li>用<code>useEffect</code>监听<code>todos</code>变化，每次变化都调用<code>saveToStorage</code>保存到本地，确保数据实时同步。</li>
<li>提供<code>addTodo</code>（添加）、<code>toggleTodo</code>（切换状态）、<code>deleteTodo</code>（删除）三个方法，通过<code>setTodos</code>更新状态，遵循 “不可变数据” 原则（用扩展运算符、<code>map</code>、<code>filter</code>创建新数组）。</li>
<li>最后返回<code>todos</code>状态和操作方法，供 UI 组件使用。</li>
</ul>
<h5 data-id="heading-22">（2）UI 组件：App.jsx（主组件）</h5>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { useTodos } <span class="hljs-keyword">from</span> <span class="hljs-string">'./hooks/useTodos.js'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">TodoList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/TodoList.jsx'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">TodoInput</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/TodoInput.jsx'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 调用自定义Hook获取待办数据和操作方法</span>
    <span class="hljs-keyword">const</span> { todos, addTodo, deleteTodo, toggleTodo } = <span class="hljs-title function_">useTodos</span>();

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
            {/* 输入组件：传递addTodo方法用于添加待办 */}
            <span class="hljs-tag">&lt;<span class="hljs-name">TodoInput</span> <span class="hljs-attr">addTodo</span>=<span class="hljs-string">{addTodo}</span> /&gt;</span>
            {/* 条件渲染：有待办时显示列表，否则显示空状态 */}
            {
                todos.length &gt; 0 ?
                    <span class="hljs-tag">&lt;<span class="hljs-name">TodoList</span>
                        <span class="hljs-attr">todos</span>=<span class="hljs-string">{todos}</span>
                        <span class="hljs-attr">deleteTodo</span>=<span class="hljs-string">{deleteTodo}</span>
                        <span class="hljs-attr">toggleTodo</span>=<span class="hljs-string">{toggleTodo}</span>
                    /&gt;</span> : 
                    (<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>暂无待办事项<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>)
            }
        <span class="hljs-tag">&lt;/&gt;</span></span>
    )
}
</code></pre>
<p><strong>逻辑详解</strong>：</p>
<ul>
<li><code>App</code>组件作为入口，通过<code>useTodos()</code>获取待办数据（<code>todos</code>）和操作方法（<code>addTodo</code>等）。</li>
<li>渲染<code>TodoInput</code>组件（负责输入待办）并传递<code>addTodo</code>方法，让输入组件能触发添加操作。</li>
<li>渲染<code>TodoList</code>组件（负责展示待办列表）并传递<code>todos</code>、<code>deleteTodo</code>、<code>toggleTodo</code>，让列表组件能展示数据和处理删除 / 切换操作。</li>
<li>通过条件渲染实现 “无待办时显示空提示” 的需求。</li>
</ul>
<h5 data-id="heading-23">（3）UI 组件：TodoInput.jsx（输入组件）</h5>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TodoInput</span>(<span class="hljs-params">{ addTodo }</span>) {
    <span class="hljs-comment">// 管理输入框文本状态（受控组件）</span>
    <span class="hljs-keyword">const</span> [text, setText] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);

    <span class="hljs-comment">// 输入框变化时更新text状态</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChange</span> = (<span class="hljs-params">e</span>) =&gt; {
        <span class="hljs-title function_">setText</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>);
    }

    <span class="hljs-comment">// 表单提交时添加待办</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = (<span class="hljs-params">e</span>) =&gt; {
        e.<span class="hljs-title function_">preventDefault</span>(); <span class="hljs-comment">// 阻止表单默认提交行为</span>
        <span class="hljs-keyword">if</span> (text.<span class="hljs-title function_">trim</span>() === <span class="hljs-string">''</span>) { <span class="hljs-comment">// 过滤空输入</span>
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-title function_">addTodo</span>(text); <span class="hljs-comment">// 调用父组件传递的addTodo方法添加待办</span>
        <span class="hljs-title function_">setText</span>(<span class="hljs-string">''</span>); <span class="hljs-comment">// 清空输入框</span>
    }

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'todo-input'</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">{handleSubmit}</span>&gt;</span>
            {/* 受控组件：value绑定text，变化触发handleChange */}
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">'text'</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{text}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleChange}</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">'submit'</span>&gt;</span>添加<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span>
    )
}
</code></pre>
<p><strong>逻辑详解</strong>：</p>
<ul>
<li>纯 UI 组件，仅负责输入框的状态管理和提交逻辑，不关心数据如何存储或处理。</li>
<li>通过<code>useState</code>管理输入框的<code>text</code>状态，实现 “受控组件”（输入框值由 React 状态控制）。</li>
<li>表单提交时调用<code>addTodo</code>（从<code>App</code>组件传递的方法）添加待办，并清空输入框。</li>
</ul>
<h5 data-id="heading-24">（4）UI 组件：TodoList.jsx（列表组件）</h5>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">TodoItem</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./TodoItem.jsx'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TodoList</span>(<span class="hljs-params">{ todos, deleteTodo, toggleTodo }</span>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"todo-list"</span>&gt;</span>
            {/* 遍历todos数组，为每个待办渲染TodoItem组件 */}
            {todos.map((todo) =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">TodoItem</span> 
                 <span class="hljs-attr">key</span>=<span class="hljs-string">{todo.id}</span> // <span class="hljs-attr">唯一key</span>
                 <span class="hljs-attr">todo</span>=<span class="hljs-string">{todo}</span> // <span class="hljs-attr">传递单个待办数据</span>
                 <span class="hljs-attr">deleteTodo</span>=<span class="hljs-string">{deleteTodo}</span> // <span class="hljs-attr">传递删除方法</span>
                 <span class="hljs-attr">toggleTodo</span>=<span class="hljs-string">{toggleTodo}</span> // <span class="hljs-attr">传递切换状态方法</span>
                /&gt;</span>
            ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>
    )
}
</code></pre>
<p><strong>逻辑详解</strong>：</p>
<ul>
<li>接收<code>todos</code>数组，通过<code>map</code>遍历渲染每个待办项（<code>TodoItem</code>）。</li>
<li>仅负责列表渲染，将单个待办的数据和操作方法传递给<code>TodoItem</code>，自身不处理业务逻辑。</li>
</ul>
<h5 data-id="heading-25">（5）UI 组件：TodoItem.jsx（单个待办项）</h5>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TodoItem</span>(<span class="hljs-params">{ todo, deleteTodo, toggleTodo }</span>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"todo-item"</span>&gt;</span>
            {/* 复选框：状态绑定todo.completed，点击触发toggleTodo */}
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
                <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span>
                <span class="hljs-attr">checked</span>=<span class="hljs-string">{todo.completed}</span>
                <span class="hljs-attr">onChange</span>=<span class="hljs-string">{()</span> =&gt;</span> toggleTodo(todo.id)}
            /&gt;
            {/* 待办文本：已完成时添加completed类（可用于样式区分） */}
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{todo.completed</span> ? '<span class="hljs-attr">completed</span>' <span class="hljs-attr">:</span> ''}&gt;</span>
                {todo.text}
            <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            {/* 删除按钮：点击触发deleteTodo */}
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> deleteTodo(todo.id)}&gt;删除<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>
    )
}
</code></pre>
<p><strong>逻辑详解</strong>：</p>
<ul>
<li>接收单个待办数据（<code>todo</code>）和操作方法，渲染复选框、文本和删除按钮。</li>
<li>复选框状态与<code>todo.completed</code>绑定，点击时调用<code>toggleTodo</code>切换状态。</li>
<li>文本根据<code>completed</code>状态添加样式类（如划线效果），删除按钮点击时调用<code>deleteTodo</code>删除当前待办。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10ecafc5f10844369f5f6d214b0f4dbf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGlhb3h1ZV8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768041866&amp;x-signature=zB6qg6oQzohfCNDDp5pyupcUres%3D" alt="QQ20260103-170824.png" loading="lazy"/></p>
<h4 data-id="heading-26">4. 效果展示：</h4>
<ul>
<li>输入框输入内容，点击 “添加” 按钮，待办列表会新增一项。</li>
<li>勾选复选框，待办文本会显示为 “已完成” 样式。</li>
<li>点击 “删除” 按钮，对应待办项会从列表中移除。</li>
<li>刷新页面后，所有待办数据依然存在（本地存储生效）。</li>
<li>当列表为空时，页面显示 “暂无待办事项”。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93a8817cc396405f9b478e994a276f3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGlhb3h1ZV8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768041866&amp;x-signature=T3RIj4Slvx24PmkVxphO2UIB2Pc%3D" alt="QQ202613-1709.gif" loading="lazy"/></p>
<h4 data-id="heading-27">5. 案例总结：</h4>
<ul>
<li><strong>逻辑复用最大化</strong>：<code>useTodos</code>封装了待办事项的所有核心逻辑（状态管理、CRUD 操作、本地持久化），若其他组件（如 “待办统计组件”）需要使用待办数据，可直接调用<code>useTodos</code>，无需重复编写逻辑。</li>
<li><strong>UI 与业务彻底分离</strong>：所有 UI 组件（<code>TodoInput</code>、<code>TodoList</code>等）仅负责渲染和传递交互，不包含任何数据处理逻辑，代码结构清晰，维护成本低。</li>
<li><strong>副作用集中管理</strong>：本地存储的读写逻辑被封装在<code>useTodos</code>的<code>useEffect</code>中，避免副作用分散在多个组件中，便于统一维护。</li>
</ul>
<h3 data-id="heading-28">五、面试官会问 🤔</h3>
<ol>
<li><strong>自定义 Hook 和普通函数有什么区别？</strong> 自定义 Hook 以<code>use</code>开头，内部可以调用其他 Hook（如<code>useState</code>、<code>useEffect</code>），且必须遵循 Hook 调用规则（只能在组件或其他 Hook 中调用）；普通函数不能调用 Hook，也没有命名限制。</li>
<li><strong>为什么自定义 Hook 必须以 use 开头？</strong> 这是 React 的约定，确保 React 能通过命名识别 Hook，从而验证 Hook 的调用规则（如避免在条件语句中调用），防止出现逻辑错误。</li>
<li><strong>如何避免自定义 Hook 中的内存泄漏？</strong> 若 Hook 包含副作用（如事件监听、定时器），必须在<code>useEffect</code>的清理函数中移除副作用（如<code>removeEventListener</code>、<code>clearTimeout</code>），确保组件卸载时副作用被清除。</li>
<li><strong>自定义 Hook 如何实现状态隔离？</strong> 每个组件调用自定义 Hook 时，React 都会为其创建独立的状态实例，不同组件之间的状态互不干扰（如两个组件调用<code>useMouse</code>，会分别维护自己的<code>x</code>、<code>y</code>状态）。</li>
<li><strong>什么时候应该抽离自定义 Hook？</strong> 当多个组件需要共享相同的状态逻辑，或组件中业务逻辑过于复杂（导致 UI 与逻辑混杂）时，就应该抽离为自定义 Hook。</li>
</ol>
<h3 data-id="heading-29">六、结语 🌟</h3>
<p>自定义 Hooks 是 React 中 “逻辑复用” 的最佳实践，它让我们的代码从 “重复冗余” 走向 “简洁高效”，从 “UI 与逻辑混杂” 走向 “职责清晰分离”。</p>
<p>通过本文的两个案例（鼠标位置监听和待办事项应用），我们可以看到：一个设计良好的自定义 Hook，就像一个 “功能模块”，能让组件专注于 UI 渲染，让逻辑专注于业务处理。</p>
<p>希望大家在实际开发中多思考、多实践，将自定义 Hooks 运用到项目中，让代码更优雅、更可维护！🎉</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[程序员应该熟悉的概念(6)Fine-tuning和RAG]]></title>    <link>https://juejin.cn/post/7590452143016656934</link>    <guid>https://juejin.cn/post/7590452143016656934</guid>    <pubDate>2026-01-03T07:49:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590452143016656934" data-draft-id="7590469811409010715" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="程序员应该熟悉的概念(6)Fine-tuning和RAG"/> <meta itemprop="keywords" content="人工智能,架构,算法"/> <meta itemprop="datePublished" content="2026-01-03T07:49:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刘立军"/> <meta itemprop="url" content="https://juejin.cn/user/2830599308981642"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            程序员应该熟悉的概念(6)Fine-tuning和RAG
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2830599308981642/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刘立军
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T07:49:42.000Z" title="Sat Jan 03 2026 07:49:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>大语言模型/LLM</strong> 通常是由海量通用知识（如语法、常识、逻辑）训练的，在面对具体场景（如医疗问诊、法律文书生成）时，能力往往不足。<br/>
<strong>Fine-tuning/微调</strong> 正是为解决这一问题而生的核心技术，其本质是在预训练模型的基础上，用特定领域 / 任务的小数据集进一步训练，让模型 <strong>适配具体需求</strong>，最终输出更精准、更贴合场景的结果。</p>

<h2 data-id="heading-0">微调（Fine-tuning）的核心定义</h2>
<p>微调的技术逻辑可拆解为两步：</p>
<ol>
<li>基础：预训练模型<br/>
模型已通过万亿级通用数据（如全网文本、书籍、论文）学习了通用语言规律（如 “猫是哺乳动物”“合同需包含当事人信息”），但对 “儿科常见病症用药”、“知识产权合同纠纷条款” 等细分领域知识掌握薄弱。</li>
<li>关键：针对性训练<br/>
用该领域的小数据集（通常几千～几万条，远少于预训练数据），以 “少量迭代更新模型参数” 的方式，让模型重点学习细分领域的知识、话术和规则。<br/>
例如用 1 万条 “医生与儿科患者对话” 数据微调模型，使其能像儿科医生一样回答家长的问诊问题。</li>
</ol>
<p>简单类比：<strong>预训练模型</strong>是 <strong>高中毕业的通用人才</strong>，<strong>微调</strong>（Fine-tuning） 是 <strong>针对医生 / 律师 / 程序员岗位的岗前培训</strong>，最终让模型成为 <strong>领域专才</strong>。</p>
<h2 data-id="heading-1">微调的优点与缺点</h2>
<p>微调的核心价值在于 <strong>让模型深度适配场景</strong>，但也受限于数据、成本和灵活性，具体优劣势如下：</p>






























<table><thead><tr><th>维度</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td><strong>输出精准度</strong></td><td>能深度融合领域知识，输出结果的专业性、准确性更高（如法律微调模型能精准引用法条）。</td><td>对训练数据质量要求极高：若数据存在错误 / 偏见，微调后模型会 “固化错误”（如数据含误诊案例，模型会重复误诊）。</td></tr><tr><td><strong>响应效率</strong></td><td>微调后的模型可 “本地化部署”，无需实时调用外部数据，响应速度快（毫秒级）。</td><td>训练成本高：需专业算法工程师操作，且 GPU 算力消耗大（一次医疗模型微调可能需数万元算力成本）。</td></tr><tr><td><strong>场景适配性</strong></td><td>能适配 “无公开数据参考” 的私有场景（如企业内部客户服务话术、专属产品知识库）。</td><td>灵活性差：若场景需求变化（如医疗指南更新、法律条文修订），需重新准备数据并再次微调，周期长（通常 1~2 周）。</td></tr><tr><td><strong>数据依赖度</strong></td><td>相比预训练，仅需 “小数据集” 即可生效（适合数据稀缺的细分领域）。</td><td>存在 “灾难性遗忘” 风险：过度微调可能导致模型忘记预训练的通用知识（如仅学法律后，无法回答基础常识问题）。</td></tr></tbody></table>
<blockquote>
<p>这个世界不存在完美，尤其是工程技术：）</p>
</blockquote>
<h2 data-id="heading-2">微调与 RAG 的对比：优势与劣势</h2>
<blockquote>
<p>如果您想了解 RAG，可参见：<a href="https://link.juejin.cn?target=http%3A%2F%2Fwfcoding.com%2Farticles%2Fpractice%2F0318%2F" target="_blank" title="http://wfcoding.com/articles/practice/0318/" ref="nofollow noopener noreferrer">用langgraph实现RAG(Retrieval Augmented Generation,检索增强生成)</a></p>
</blockquote>
<p>在实际应用中，微调常与<strong>RAG（检索增强生成，Retrieval-Augmented Generation）</strong> 相比，两者都是 “让模型适配具体场景” 的技术，但底层逻辑完全不同：</p>
<ul>
<li><strong>微调</strong>：把领域知识 “灌进模型参数里”（让模型 “记住” 知识）；</li>
<li><strong>RAG</strong>：让模型在生成答案前，先 “检索外部数据库”（让模型 “参考” 实时 / 私有知识）。</li>
</ul>
<p>两者的优劣势对比可通过下表清晰呈现：</p>








































<table><thead><tr><th>对比维度</th><th>微调（Fine-tuning）</th><th>RAG（检索增强生成）</th></tr></thead><tbody><tr><td><strong>知识更新成本</strong></td><td>高：知识变化（如法规修订、产品迭代）需重新准备数据、重新训练，周期长（1~2 周）。</td><td>低：只需更新外部数据库（如替换 Excel 表格、同步文档），无需修改模型，即时生效。</td></tr><tr><td><strong>数据要求</strong></td><td>高：需高质量、结构化的标注数据（如 “问题 + 标准答案” 对），无数据则无法启动。</td><td>低：支持非结构化数据（如 PDF、Word、聊天记录），无需标注，“扔进去就能用”，数据门槛低。</td></tr><tr><td><strong>响应速度</strong></td><td>快：知识存在模型内部，生成答案时无需外部调用，响应时间短（毫秒级）。</td><td>慢：需先检索外部数据库（依赖数据库性能），响应时间长（百毫秒～秒级）。</td></tr><tr><td><strong>私有性与安全</strong></td><td>高：可本地化部署，数据不对外传输，适合涉密场景（如军工、金融核心数据）。</td><td>中：若用第三方数据库（如云端向量库），存在数据传输风险；本地化部署可提升安全性。</td></tr><tr><td><strong>适用场景</strong></td><td>1. 知识稳定、长期不变的领域（如数学公式、经典医学理论）；2. 需极致响应速度的场景（如实时客服、工业控制）；3. 涉密 / 私有性要求高的场景。</td><td>1. 知识高频更新的领域（如新闻、电商商品、政策法规）；2. 数据非结构化、标注困难的场景（如企业历史文档、用户聊天记录）；3. 需 “溯源引用” 的场景（如学术写作、法律论证，需标注答案来源）。</td></tr><tr><td><strong>成本（长期）</strong></td><td>高：除首次训练成本，后续知识更新需持续投入算力和人力。</td><td>低：主要成本是数据库存储与维护，无重复训练成本，长期更经济。</td></tr></tbody></table>
<blockquote>
<p>在<code>RAG</code>场景中，一般的分为两步：</p>
<ol>
<li>将用户的问题矢量化并通过知识库进行语义检索，找出最贴近的答案；</li>
<li>使用大模型结合知识库的答案，推理出流畅的自然语言给出答案。</li>
</ol>
<p>如果数据量不太大，语义检索在性能好一点的CPU下运行速度也会很快，所以性能的瓶颈通常在于大模型的推理。</p>
</blockquote>
<h2 data-id="heading-3">总结：如何选择微调与 RAG？</h2>
<p>两者并非 “非此即彼”，实际应用中常结合使用（如 “微调 + RAG” 混合方案），核心选择逻辑如下：</p>
<ul>
<li>若你的场景<strong>知识稳定、数据质量高、需极致速度或强隐私</strong>（如医疗设备实时诊断、军工文档分析），优先选<strong>微调（Fine-tuning）</strong>；</li>
<li>若你的场景<strong>知识高频更新、数据零散无标注、需低成本快速落地</strong>（如电商商品问答、企业周报生成），优先选 <strong>RAG(Retrieval Augmented Generation,检索增强生成)</strong>；</li>
<li>若需 “兼顾专业度与灵活性”（如法律智能助手：既需精准法条引用，又需实时更新新规），可采用 “先用微调让模型掌握法律通用逻辑，再用 RAG 检索最新法条” 的混合方案。</li>
</ul>
<blockquote>
<p>如果对成本比较敏感，通过选择 <strong>参数小的大模型 + 知识库</strong> 的 <strong>RAG</strong> 是最优方案。</p>
</blockquote>
<hr/>
<p>🪐感谢观看，祝好运🪐</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RocketMQ 为什么读得这么快？揭秘 ConsumeQueue 的异步索引设计]]></title>    <link>https://juejin.cn/post/7590403249560797199</link>    <guid>https://juejin.cn/post/7590403249560797199</guid>    <pubDate>2026-01-03T10:15:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590403249560797199" data-draft-id="7590213554798723107" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RocketMQ 为什么读得这么快？揭秘 ConsumeQueue 的异步索引设计"/> <meta itemprop="keywords" content="后端,RocketMQ,面试"/> <meta itemprop="datePublished" content="2026-01-03T10:15:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RocketMQ 为什么读得这么快？揭秘 ConsumeQueue 的异步索引设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T10:15:04.000Z" title="Sat Jan 03 2026 10:15:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言：写得快不够，还要读得快</h2>
<p><a href="https://juejin.cn/post/7589962224795713574" target="_blank" title="https://juejin.cn/post/7589962224795713574">上一篇</a>我们解决了写入问题：CommitLog顺序写，让RocketMQ写入TPS达到十万级别。</p>
<p>但写得快只是第一步。<strong>消费者怎么快速读取消息？</strong></p>
<p>设想一个场景：</p>
<ul>
<li>CommitLog有100GB数据，包含1000个Topic</li>
<li>Consumer只关心其中一个Topic（1GB数据）</li>
<li>从头扫描？读取100GB，丢弃99GB？</li>
</ul>
<p>实测数据：扫描100MB的CommitLog找2万条消息，耗时102ms。如果是100GB？那就是10万ms，即100秒。</p>
<p>完全不可行。</p>
<p><strong>RocketMQ的答案：ConsumeQueue异步索引。</strong></p>
<ul>
<li>20字节定长结构</li>
<li>查询速度提升34倍（102ms → 3ms）</li>
<li>数据量减少272倍（100MB → 0.37MB）</li>
</ul>
<p>今天拆解三个核心问题：</p>
<ol>
<li><strong>ConsumeQueue是什么？</strong> - 20字节索引如何设计</li>
<li><strong>为什么异步构建？</strong> - 写入性能如何保持</li>
<li><strong>怎么配合工作？</strong> - 读写如何分离</li>
</ol>
<h2 data-id="heading-1">一、ConsumeQueue是什么？</h2>
<h3 data-id="heading-2">1.1 核心设计</h3>
<p>ConsumeQueue是CommitLog的索引，采用<strong>定长、异步构建</strong>的设计。</p>
<p>每个Topic的每个Queue都有一个独立的ConsumeQueue文件：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-variable">$ROCKETMQ_HOME</span>/store/consumequeue/
├── TopicA/
│   ├── 0/                    ← Queue-0的索引
│   │   └── 00000000000000000000
│   ├── 1/                    ← Queue-1的索引
│   │   └── 00000000000000000000
└── TopicB/
    ├── 0/
    │   └── 00000000000000000000
</code></pre>
<h3 data-id="heading-3">1.2 索引条目结构</h3>
<p>每个索引条目固定20字节，包含3个字段：</p>
<pre><code class="hljs language-scss" lang="scss">+-------------------+-------------------+-------------------+
|   CommitLog偏移量  |     消息大小       |      TagsCode     |
|      (<span class="hljs-number">8</span>字节)       |     (<span class="hljs-number">4</span>字节)       |      (<span class="hljs-number">8</span>字节)      |
+-------------------+-------------------+-------------------+
</code></pre>
<p><strong>为什么是20字节？</strong></p>
<p>定长设计的好处：</p>
<ol>
<li><strong>快速定位</strong> - 第N条索引位置 = N × 20，O(1)复杂度</li>
<li><strong>空间高效</strong> - 1KB消息 → 20字节索引，压缩比51:1</li>
<li><strong>批量读取</strong> - 连续存储，PageCache友好</li>
</ol>
<h3 data-id="heading-4">1.3 读写分离的设计</h3>
<p>ConsumeQueue和CommitLog分工明确：</p>
<p><strong>CommitLog：物理存储层</strong></p>
<ul>
<li>所有消息顺序写入</li>
<li>不关心Topic和Queue</li>
<li>只管追加，写入极快</li>
</ul>
<p><strong>ConsumeQueue：逻辑索引层</strong></p>
<ul>
<li>按Topic/Queue组织</li>
<li>只存20字节索引</li>
<li>快速定位消息</li>
</ul>
<p><strong>协作方式：写入快速，读取精准</strong></p>
<h2 data-id="heading-5">二、为什么不直接扫描CommitLog？</h2>
<h3 data-id="heading-6">2.1 性能对比测试</h3>
<p>我写了一个简化版的实现，对比两种查询方式：</p>
<p><strong>测试场景：</strong></p>
<ul>
<li>消息总数：10万条，每条1KB</li>
<li>Topic数量：5个（消息随机分布）</li>
<li>查询目标：找出Topic-2的所有消息（约2万条）</li>
</ul>
<p><strong>方式A：直接扫描CommitLog</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 从头到尾扫描，逐条解析</span>
<span class="hljs-keyword">for</span> (Message msg : commitLog.scanAll()) {
    <span class="hljs-keyword">if</span> (msg.getTopic().equals(<span class="hljs-string">"Topic-2"</span>)) {
        results.add(msg);
    }
}
</code></pre>
<p><strong>方式B：通过ConsumeQueue索引</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 读取索引，直接定位</span>
<span class="hljs-type">ConsumeQueue</span> <span class="hljs-variable">queue</span> <span class="hljs-operator">=</span> getQueue(<span class="hljs-string">"Topic-2"</span>, <span class="hljs-number">0</span>);
<span class="hljs-keyword">for</span> (IndexEntry entry : queue.getAll()) {
    <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> commitLog.read(entry.offset, entry.size);
    results.add(msg);
}
</code></pre>
<h3 data-id="heading-7">2.2 测试结果</h3>





























<table><thead><tr><th>指标</th><th>直接扫描</th><th>索引查询</th><th>差距</th></tr></thead><tbody><tr><td>查询耗时</td><td>102 ms</td><td>3 ms</td><td><strong>34倍</strong></td></tr><tr><td>扫描数据量</td><td>100.00 MB</td><td>0.37 MB</td><td><strong>272倍</strong></td></tr><tr><td>找到消息数</td><td>19,384条</td><td>19,384条</td><td>相同</td></tr></tbody></table>
<p><strong>为什么差距这么大？</strong></p>
<ul>
<li><strong>数据量差异</strong>：100MB vs 0.37MB，减少272倍IO</li>
<li><strong>解析开销</strong>：全部9.6万条 vs 目标1.9万条，减少5倍解析</li>
<li><strong>缓存命中</strong>：索引小全在内存，CommitLog太大命中率低</li>
</ul>
<h3 data-id="heading-8">2.3 不同消息数量下的性能</h3>



































<table><thead><tr><th>消息总数</th><th>直接扫描</th><th>索引查询</th><th>性能提升</th></tr></thead><tbody><tr><td>1万</td><td>14 ms</td><td>1 ms</td><td>14倍</td></tr><tr><td>5万</td><td>55 ms</td><td>2 ms</td><td>27.5倍</td></tr><tr><td>10万</td><td>76 ms</td><td>1 ms</td><td>76倍</td></tr><tr><td>20万</td><td>59 ms</td><td>1 ms</td><td>59倍</td></tr></tbody></table>
<p><strong>趋势分析：</strong></p>
<ul>
<li>直接扫描：耗时随消息数量线性增长</li>
<li>索引查询：耗时基本恒定（1-2ms）</li>
<li>消息越多，索引优势越明显</li>
</ul>
<p><strong>关于20万条数据的说明：</strong>
细心的读者会发现，20万条消息的扫描耗时（59ms）反而比10万条（76ms）少。这不符合线性增长的预期。</p>
<p>原因是<strong>PageCache效应</strong>：</p>
<ul>
<li>测试按1万→5万→10万→20万顺序执行</li>
<li>前面的测试让大量数据进入PageCache</li>
<li>20万测试时，很多数据已在内存中</li>
<li>磁盘IO大幅减少，耗时反而降低</li>
</ul>
<p>这个现象恰好说明：</p>
<ol>
<li>PageCache对顺序读取的优化很强</li>
<li>真实生产环境中，冷启动时性能会更差</li>
<li>索引查询因为数据量小，不受PageCache波动影响</li>
</ol>
<p><strong>结论：直接扫描CommitLog是不可行的。生产环境百万、千万级消息，扫描耗时会达到秒级甚至分钟级，完全无法接受。</strong></p>
<p><strong>两种查询方式对比：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[Consumer查询Topic-2消息] --&gt; B{选择方式}
    B --&gt;|方式A| C[扫描100MB CommitLog]
    B --&gt;|方式B| D[读取0.37MB索引]
    C --&gt; E[解析96,465条消息]
    D --&gt; F[解析19,384条消息]
    E --&gt; G[耗时102ms]
    F --&gt; H[耗时3ms]
    
    style C fill:#ffe1e1
    style D fill:#e8f5e9
    style G fill:#ffe1e1
    style H fill:#e8f5e9
</code></pre>
<h2 data-id="heading-9">三、异步构建机制</h2>
<h3 data-id="heading-10">3.1 为什么要异步？</h3>
<p>同步构建会拖累写入性能：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 同步构建（性能差）</span>
commitLog.append(msg);
consumeQueue.buildIndex(msg);  <span class="hljs-comment">// ← 阻塞等待</span>
<span class="hljs-keyword">return</span> success;

<span class="hljs-comment">// 异步构建（高性能）</span>
commitLog.append(msg);
<span class="hljs-keyword">return</span> success;  <span class="hljs-comment">// ← 立即返回，后台线程异步构建</span>
</code></pre>
<p><strong>问题：</strong></p>
<ul>
<li>同步构建需要等待索引完成</li>
<li>索引文件分散，写入变随机IO</li>
<li>1000个Topic = 1000个索引文件同时写，性能崩溃</li>
</ul>
<p><strong>异步优势：</strong></p>
<ul>
<li>写入立即返回，不等索引</li>
<li>后台线程统一处理，批量高效</li>
<li>写入性能100%保留</li>
</ul>
<h3 data-id="heading-11">3.2 ReputMessageService实现</h3>
<p>RocketMQ使用ReputMessageService线程异步分发消息到ConsumeQueue。</p>
<p><strong>异步构建流程：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[Producer写入] --&gt; B[CommitLog]
    B -.-&gt;|立即返回| A
    C[ReputService后台线程] -.-&gt;|轮询| B
    C --&gt; D[读取新消息]
    D --&gt; E[解析消息]
    E --&gt; F[写入ConsumeQueue]
    
    style B fill:#e1f5ff
    style C fill:#fff4e1
    style F fill:#ffe1e1
</code></pre>
<p><strong>核心逻辑：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ReputMessageService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> <span class="hljs-variable">reputFromOffset</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;  <span class="hljs-comment">// 已处理位置</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">while</span> (running) {
            <span class="hljs-type">long</span> <span class="hljs-variable">maxOffset</span> <span class="hljs-operator">=</span> commitLog.getMaxOffset();
            
            <span class="hljs-keyword">if</span> (reputFromOffset &lt; maxOffset) {
                <span class="hljs-comment">// 解析消息并分发到ConsumeQueue</span>
                <span class="hljs-type">DispatchRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> parseMessage(reputFromOffset);
                doDispatch(request);
                reputFromOffset += request.getMsgSize();
            } <span class="hljs-keyword">else</span> {
                Thread.sleep(<span class="hljs-number">1</span>);  <span class="hljs-comment">// 无新消息，休眠1ms</span>
            }
        }
    }
}
</code></pre>
<p><strong>关键参数：</strong></p>
<ul>
<li>轮询间隔：1ms</li>
<li>每次处理：1条消息</li>
<li>延迟窗口：&lt;10ms</li>
</ul>
<h3 data-id="heading-12">3.3 延迟窗口验证</h3>
<p>写入1000条消息的过程中：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">写入期间（保持20-50条延迟）：</span>
  <span class="hljs-attr">CommitLog:</span>    <span class="hljs-number">200</span><span class="hljs-string">条</span> <span class="hljs-string">████████████████████</span>
  <span class="hljs-attr">ConsumeQueue:</span> <span class="hljs-number">180</span><span class="hljs-string">条</span> <span class="hljs-string">██████████████████</span>
  <span class="hljs-string">延迟:</span> <span class="hljs-number">20</span><span class="hljs-string">条</span> <span class="hljs-string">(~20ms)</span>

<span class="hljs-string">写入停止后10ms（完全追上）：</span>
  <span class="hljs-attr">CommitLog:</span>    <span class="hljs-number">1000</span><span class="hljs-string">条</span> <span class="hljs-string">████████████████████████████████████████</span>
  <span class="hljs-attr">ConsumeQueue:</span> <span class="hljs-number">1000</span><span class="hljs-string">条</span> <span class="hljs-string">████████████████████████████████████████</span>
  <span class="hljs-string">延迟:</span> <span class="hljs-number">0</span><span class="hljs-string">条</span>
</code></pre>
<p><strong>延迟特点：</strong></p>
<ul>
<li>写入期间保持小幅延迟（20-50条消息）</li>
<li>停止写入后10ms内完全追上</li>
<li>对消费者影响可忽略（消费者本身异步）</li>
</ul>
<h2 data-id="heading-13">四、设计权衡</h2>
<h3 data-id="heading-14">4.1 三种方案对比</h3>





































<table><thead><tr><th>方案</th><th>写入性能</th><th>读取性能</th><th>复杂度</th><th>一致性</th><th>适用场景</th></tr></thead><tbody><tr><td>直接扫描CommitLog</td><td>高</td><td>极低</td><td>简单</td><td>强一致</td><td>不适用</td></tr><tr><td>同步构建ConsumeQueue</td><td>低</td><td>高</td><td>中等</td><td>强一致</td><td>小规模</td></tr><tr><td>异步构建ConsumeQueue</td><td>高</td><td>高</td><td>较高</td><td>最终一致</td><td>大规模生产</td></tr></tbody></table>
<p><strong>为什么选择异步构建？</strong></p>
<p>核心权衡：</p>
<ul>
<li>写入性能100%保留（不等索引）</li>
<li>查询性能34倍提升（通过索引）</li>
<li>延迟&lt;10ms可接受（消费者本身异步）</li>
</ul>
<p><strong>一致性问题：</strong></p>
<p>Consumer不会读到不一致数据，因为：</p>
<ol>
<li>Consumer定期拉取（默认每秒1次），感知不到10ms延迟</li>
<li>Offset管理保证不漏消息，只是新消息晚几毫秒可见</li>
<li>Broker重启后ReputService从断点继续构建</li>
</ol>
<p>最坏情况：宕机瞬间丢失&lt;1ms的索引，重启后重建，对消费者透明。</p>
<h2 data-id="heading-15">五、CommitLog与ConsumeQueue的协作</h2>
<h3 data-id="heading-16">5.1 完整的消息流转</h3>
<p><strong>写入路径（Producer → Broker）：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[Producer] --&gt;|1.发送消息| B[CommitLog]
    B --&gt;|2.立即返回| A
    B -.-&gt;|3.异步通知| C[ReputService]
    C --&gt;|4.构建索引| D[ConsumeQueue]
    
    style B fill:#e1f5ff
    style C fill:#fff4e1
    style D fill:#ffe1e1
</code></pre>
<ol>
<li>Producer发送消息到Broker</li>
<li>Broker写入CommitLog（顺序追加）</li>
<li>返回成功给Producer</li>
<li>ReputService异步读取CommitLog</li>
<li>构建ConsumeQueue索引</li>
</ol>
<p><strong>读取路径（Consumer → Broker）：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[Consumer] --&gt;|1.请求消息| B[ConsumeQueue]
    B --&gt;|2.返回offset| A
    A --&gt;|3.读取消息| C[CommitLog]
    C --&gt;|4.返回数据| A
    
    style B fill:#ffe1e1
    style C fill:#e1f5ff
</code></pre>
<ol>
<li>Consumer向Broker请求消息</li>
<li>Broker查询ConsumeQueue索引</li>
<li>获得消息在CommitLog的offset和size</li>
<li>从CommitLog读取完整消息</li>
<li>返回给Consumer</li>
</ol>
<h3 data-id="heading-17">5.2 设计思想</h3>
<p><strong>CommitLog（写入侧）：</strong></p>
<ul>
<li>顺序写，充分利用磁盘性能</li>
<li>不关心Topic和Queue</li>
<li>只管追加，简单高效</li>
</ul>
<p><strong>ConsumeQueue（读取侧）：</strong></p>
<ul>
<li>按Topic/Queue组织</li>
<li>定长索引，快速定位</li>
<li>只读关心的消息</li>
</ul>
<p>核心：<strong>读写分离，各自优化到极致。</strong></p>
<h3 data-id="heading-18">5.3 文件布局</h3>
<pre><code class="hljs language-perl" lang="perl">store/
├── commitlog/
│   ├── <span class="hljs-number">00000000000000000000</span>           <span class="hljs-comment"># 1GB</span>
│   └── <span class="hljs-number">00000001073741</span>824              <span class="hljs-comment"># 1GB</span>
│
├── consumequeue/
│   ├── TopicA/
│   │   ├── <span class="hljs-number">0</span>/<span class="hljs-number">00000000000000000000</span>    <span class="hljs-comment"># 5.7MB (30万条)</span>
│   │   └── <span class="hljs-number">1</span>/<span class="hljs-number">00000000000000000000</span>
│   └── TopicB/
│       ├── <span class="hljs-number">0</span>/<span class="hljs-number">00000000000000000000</span>
│       └── <span class="hljs-number">1</span>/<span class="hljs-number">00000000000000000000</span>
│
└── <span class="hljs-keyword">index</span>/                             <span class="hljs-comment"># 按Key查询（可选）</span>
    └── <span class="hljs-number">20250103120000000</span>
</code></pre>
<p><strong>空间占用（10万条消息）：</strong></p>
<ul>
<li>CommitLog：100 MB（完整消息）</li>
<li>ConsumeQueue：1.9 MB（索引）</li>
<li>索引开销：仅1.9%</li>
</ul>
<h2 data-id="heading-19">六、升华：主数据 + 异步索引模式</h2>
<p>ConsumeQueue的设计，本质是<strong>主数据 + 异步索引</strong>模式。</p>
<h3 data-id="heading-20">6.1 核心模式</h3>
<pre><code class="hljs">主数据层（写优化） → 异步构建 → 索引层（读优化）
</code></pre>
<p><strong>设计原则：</strong></p>
<ol>
<li>主数据优先写入 - 保证不丢</li>
<li>索引异步构建 - 不阻塞</li>
<li>读取走索引 - 快速定位</li>
<li>最终一致 - 可接受延迟</li>
</ol>
<h3 data-id="heading-21">6.2 典型应用</h3>
<p><strong>MySQL的二级索引：</strong></p>
<ul>
<li>主键索引 = CommitLog（数据存储）</li>
<li>二级索引 = ConsumeQueue（查询加速）</li>
<li>Change Buffer异步合并索引</li>
</ul>
<p><strong>Elasticsearch的倒排索引：</strong></p>
<ul>
<li>_source字段 = 原始文档（CommitLog）</li>
<li>倒排索引 = 查询索引（ConsumeQueue）</li>
<li>refresh间隔控制延迟（默认1秒）</li>
</ul>
<p><strong>数据仓库的物化视图：</strong></p>
<ul>
<li>明细表 = 原始数据</li>
<li>聚合表 = 查询视图</li>
<li>定时任务计算更新</li>
</ul>
<h3 data-id="heading-22">6.3 适用条件</h3>
<p><strong>适合：</strong></p>
<ul>
<li>写多读少，查询必须快</li>
<li>可容忍秒级延迟</li>
<li>索引构建代价高</li>
</ul>
<p><strong>不适合：</strong></p>
<ul>
<li>强一致性要求</li>
<li>查询简单（全表扫描也能接受）</li>
</ul>
<h2 data-id="heading-23">总结</h2>
<p>ConsumeQueue用20字节定长索引 + 异步构建，解决了CommitLog的读取问题。</p>
<p><strong>核心数据：</strong></p>
<ul>
<li>查询速度：提升34倍（102ms → 3ms）</li>
<li>数据量：减少272倍（100MB → 0.37MB）</li>
<li>异步延迟：&lt;10ms，对消费者透明</li>
</ul>
<p><strong>设计精髓：</strong></p>
<ul>
<li>定长索引：offset(8) + size(4) + tagsCode(8) = 20字节</li>
<li>异步构建：写入不等待，后台ReputService轮询处理</li>
<li>读写分离：CommitLog写入极致，ConsumeQueue查询极致</li>
</ul>
<p><strong>通用模式：</strong></p>
<p>主数据 + 异步索引 = 写快 + 读快 + 最终一致</p>
<p>这个模式在MySQL二级索引、ES倒排索引、数据仓库物化视图中都能看到。</p>
<p>核心是：<strong>用可接受的延迟，换取读写性能的极致。</strong></p>
<p>下一篇：刷盘策略 —— SYNC_FLUSH和ASYNC_FLUSH到底差多少性能？</p>
<hr/>
<p><strong>参考资料：</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Frocketmq.apache.org%2F" target="_blank" title="https://rocketmq.apache.org/" ref="nofollow noopener noreferrer">RocketMQ官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fapache%2Frocketmq%2Fblob%2Fmaster%2Fdocs%2Fcn%2Fdesign.md" target="_blank" title="https://github.com/apache/rocketmq/blob/master/docs/cn/design.md" ref="nofollow noopener noreferrer">RocketMQ Design</a></li>
<li>《RocketMQ技术内幕》第三章 - 消息存储</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Turborepo 的 Docker 化实战]]></title>    <link>https://juejin.cn/post/7590292192989151272</link>    <guid>https://juejin.cn/post/7590292192989151272</guid>    <pubDate>2026-01-03T10:14:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590292192989151272" data-draft-id="7590403249560780815" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Turborepo 的 Docker 化实战"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2026-01-03T10:14:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无声2017"/> <meta itemprop="url" content="https://juejin.cn/user/1618116899507735"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Turborepo 的 Docker 化实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1618116899507735/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无声2017
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T10:14:35.000Z" title="Sat Jan 03 2026 10:14:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>从 2025-07 开始，我开始在 Vue 项目中使用 Docker + Workflow 的方式进行打包部署，在此简单列举几个好处，例如：</p>
<ul>
<li>开发、测试、生产环境完全一致，Docker 镜像封装了 OS、Node.js 版本、依赖、构建工具等，避免因环境差异导致的构建失败或运行时错误。</li>
<li>节省人力，无需手动登录服务器执行命令。</li>
<li>每次部署对应一个带 tag 的 Docker 镜像，出现问题时，一键回滚到上一个镜像版本，无需重新构建。</li>
</ul>
<p>本文将先简单回顾传统 Vue 项目 Docker 打包部署的方式与 Turborepo 的项目结构。说明如何在 Turborepo 架构的项目中通过 Docker 打包部署 Vue 项目。</p>
<h2 data-id="heading-1">Vue 项目 Docker 打包部署</h2>
<p>分为 Node 镜像构建以及 Nginx 部署两个阶段，Dockerfile 内容如下：</p>
<pre><code class="hljs language-dockerfile" lang="dockerfile"># 第一阶段：node镜像打包
FROM node:latest AS frontend-builder
WORKDIR /build-app
COPY . .
RUN npm install
RUN npm run build

# 第二阶段：nginx打包
FROM nginx:latest
EXPOSE 80
WORKDIR /app
# 替换nginx配置
COPY nginx.conf /etc/nginx/conf.d/default.conf
# 将第一阶段的静态文件复制到nginx中
RUN rm -rf /usr/share/nginx/html
RUN mkdir /usr/share/nginx/html
COPY --from=frontend-builder /build-app/dist /usr/share/nginx/html

# 运行
CMD ["nginx", "-g", "daemon off;"]
</code></pre>
<p><code>nginx.conf</code> 是在项目根目录下的自定义 Nginx 配置文件，详情可见<code>个人相关配置</code>。</p>
<h2 data-id="heading-2">Turborepo 项目结构回顾</h2>
<p>Turborepo 本身不是构建工具，而是一个高性能的 Monorepo 任务编排器。它依赖底层包管理器（如 pnpm、yarn）来管理依赖，通过智能缓存和并行执行加速构建、测试等任务。</p>
<p>一个典型的 Turborepo + pnpm 项目结构如下：</p>
<pre><code class="hljs language-tex" lang="tex">my-turborepo/
├── apps/
│   ├── app1/               # 前端应用（如 Vue/React）
│   │   ├── src/
│   │   ├── public/
│   │   ├── package.json   ← name: "app1"
│   │   └── vite.config.ts
│   └── app2/
│       ├── ...
│       └── package.json   ← name: "app2"
├── packages/              # ← 缺失则 workspace 依赖安装失败
│   ├── ui/                # 共享 UI 组件库
│   │   └── package.json   ← name: "@my/ui"
│   └── utils/             # 工具函数
│       └── package.json   ← name: "@my/utils"
├── package.json           # 根工作区配置 + turbo 脚本
├── pnpm-workspace.yaml    # ← 缺失则 turbo 找不到 app1
├── turbo.json             # Turborepo 任务流水线配置
└── .npmrc                 # pnpm 配置（含 hoist 等）
</code></pre>
<p>Turborepo 的核心特点与 Docker 相关性如下：</p>






























<table><thead><tr><th>特性</th><th>说明</th><th>对 Docker 的影响 ❗</th></tr></thead><tbody><tr><td><strong>Workspace 结构</strong></td><td>所有子项目（apps/packages）通过 <code>pnpm-workspace.yaml</code> 被识别为 workspace 包</td><td>Docker 构建时必须复制该文件，否则 pnpm 无法识别子包</td></tr><tr><td><strong>依赖链接（Linking）</strong></td><td>子项目间通过 <code>workspace:*</code> 协议引用（如 <code>"@my/ui": "workspace:*"</code>），实际是符号链接</td><td>不能只复制单个 app 目录，必须复制整个 <code>apps/</code> 和 <code>packages/</code></td></tr><tr><td><strong>根目录统一安装</strong></td><td>所有依赖在根目录通过 <code>pnpm install</code> 安装，<code>node_modules</code> 位于根目录</td><td>构建命令必须在根目录执行，不能进入 <code>apps/web</code> 后再 <code>pnpm install</code></td></tr><tr><td><strong>Turbo 任务驱动</strong></td><td>通过 <code>turbo run build</code> 并指定 <code>--filter=app1</code> 来构建特定应用</td><td>需确保 <code>turbo.json</code> 和子项目的 <code>name</code> 正确，否则 filter 失败</td></tr></tbody></table>
<h2 data-id="heading-3">编写 Turborepo 中的 Dockerfile</h2>
<p>首先展示我最终的 <code>Dockerfile.dev</code>（prod、test 中会使用到公司的镜像源），代码如下：</p>
<pre><code class="hljs language-dockerfile" lang="dockerfile"># 第一阶段：构建
FROM node:22-alpine AS frontend-builder

WORKDIR /build-app

# 启用 pnpm（通过 Corepack）
ENV COREPACK_NPM_REGISTRY=https://registry.npmmirror.com
RUN corepack enable
RUN echo "Corepack registry: $COREPACK_NPM_REGISTRY" &amp;&amp; \
    corepack prepare pnpm@10.24.0 --activate

# 复制所有配置文件
COPY .npmrc ./
COPY pnpm-workspace.yaml ./
COPY turbo.json ./
COPY package.json pnpm-lock.yaml ./
COPY apps/ apps/
COPY packages/ packages/

# 安装所有依赖（含 devDependencies）
RUN pnpm install

# 构建 icic（在原始位置）
RUN pnpm turbo build --filter icic -- --mode production

# 第二阶段：Nginx
FROM nginx:alpine
EXPOSE 80
COPY apps/icic/nginx.conf /etc/nginx/conf.d/default.conf
COPY --from=frontend-builder /build-app/apps/icic/dist /usr/share/nginx/html
CMD ["nginx", "-g", "daemon off;"]
</code></pre>
<p>两者的核心差异对比如下：</p>








































<table><thead><tr><th>维度</th><th>普通 Vue 项目</th><th>Turborepo（Monorepo）</th></tr></thead><tbody><tr><td><strong>项目结构</strong></td><td>单一目录，<code>package.json</code> 在根目录</td><td>多包结构，Vue 项目在 <code>apps/xxx/</code>，根目录是 workspace</td></tr><tr><td><strong>依赖安装位置</strong></td><td>直接在项目根目录 <code>npm install</code> / <code>pnpm install</code></td><td>必须在 <strong>workspace 根目录</strong> 安装所有依赖</td></tr><tr><td><strong>构建命令</strong></td><td><code>npm run build</code> 或 <code>vite build</code></td><td>必须用 <code>turbo run build --filter=xxx</code>（或进入子目录构建）</td></tr><tr><td><strong>关键配置文件</strong></td><td>只需 <code>package.json</code>、<code>vite.config.js</code> 等</td><td>还需： • <code>pnpm-workspace.yaml</code> • <code>turbo.json</code> • 根目录 <code>.npmrc</code></td></tr><tr><td><strong>Dockerfile COPY 范围</strong></td><td>只需复制当前项目文件</td><td>必须复制： • 整个 <code>apps/</code> • 整个 <code>packages/</code> • 所有根配置文件</td></tr><tr><td><strong>node_modules 位置</strong></td><td>在项目根目录</td><td>在 workspace 根目录，子项目通过链接使用</td></tr></tbody></table>
<h2 data-id="heading-4">总结</h2>
<p><strong>普通 Vue 项目只关注自身；Turborepo 项目需要关注整个 workspace。</strong> Docker 构建时，必须还原完整的 workspace 上下文，否则依赖解析会断裂。</p>
<h2 data-id="heading-5">其他</h2>
<h3 data-id="heading-6">常见错误排查</h3>






























<table><thead><tr><th>错误现象</th><th>可能原因</th><th>解决方案</th></tr></thead><tbody><tr><td><code>pnpm: not found</code></td><td>未运行 <code>corepack enable</code></td><td>添加 <code>RUN corepack enable</code></td></tr><tr><td><code>No package found 'app1'</code></td><td>缺少 <code>pnpm-workspace.yaml</code></td><td>确保 <code>COPY pnpm-workspace.yaml ./</code></td></tr><tr><td><code>Cannot resolve @my/utils</code></td><td>未复制 <code>packages/</code></td><td>添加 <code>COPY packages/ packages/</code></td></tr><tr><td>构建成功但页面空白</td><td>Nginx 未配置 <code>try_files</code></td><td>检查 <code>nginx.conf</code> 是否包含 <code>try_files $uri $uri/ /index.html;</code></td></tr></tbody></table>
<h3 data-id="heading-7">个人相关配置</h3>
<p><code>nginx.conf</code></p>
<pre><code class="hljs language-nginx" lang="nginx">server {
    listen       80;
    listen  [::]:80;
    server_name  localhost;

    access_log  /var/log/nginx/host.access.log  main;

    location / {
        root   /usr/share/nginx/html;
        index  index.html index.htm;

        # 新增下面这句，其他是默认nginx配置
        # 解决部分前端框架的路由问题，在浏览器刷新报错404
        try_files $uri $uri/ /index.html;
    }

    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }
}

</code></pre>
<p><code>pnpm-workspace</code></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">packages:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">"apps/*"</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">"packages/*"</span>
</code></pre>
<p><code>.npmrc</code></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># China mirror of npm</span>
<span class="hljs-attr">registry</span> = https://registry.npmmirror.com

<span class="hljs-comment"># 安装依赖时锁定版本号</span>
<span class="hljs-attr">save-exact</span> = <span class="hljs-literal">true</span>

<span class="hljs-comment"># 启用 hoist，让 bin 文件提升到根目录</span>
<span class="hljs-attr">shamefully-hoist</span> = <span class="hljs-literal">true</span>
<span class="hljs-attr">hoist</span>=<span class="hljs-literal">true</span>
<span class="hljs-attr">public-hoist-pattern</span>=*
</code></pre>
<h2 data-id="heading-8">参考</h2>
<ul>
<li><a href="https://juejin.cn/post/7302268383316213787" target="_blank" title="https://juejin.cn/post/7302268383316213787">前端项目容器化(Docker)打包部署 - 掘金</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fturbo.build%2Frepo%2Fdocs%2Fcrafting-your-repository%2Fmanaging-dependencies%23best-practices-for-dependency-installation" target="_blank" title="https://turbo.build/repo/docs/crafting-your-repository/managing-dependencies#best-practices-for-dependency-installation" ref="nofollow noopener noreferrer">Best practices for dependency installation - Turborepo</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025年终总结：再次选择、沪漂、第一次演讲、相亲无果]]></title>    <link>https://juejin.cn/post/7590309337861046313</link>    <guid>https://juejin.cn/post/7590309337861046313</guid>    <pubDate>2026-01-03T10:24:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590309337861046313" data-draft-id="7590421489997905939" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025年终总结：再次选择、沪漂、第一次演讲、相亲无果"/> <meta itemprop="keywords" content="后端,GitHub,程序员"/> <meta itemprop="datePublished" content="2026-01-03T10:24:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="卷福同学"/> <meta itemprop="url" content="https://juejin.cn/user/3456520291098686"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025年终总结：再次选择、沪漂、第一次演讲、相亲无果
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3456520291098686/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    卷福同学
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T10:24:34.000Z" title="Sat Jan 03 2026 10:24:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>选择大于努力</p>
</blockquote>
<p>友友们，我是卷福同学，上次写2024年终总结的时候还在武汉，谁能想到一年之后会在上海写2025的年终总结。今年下半年经历的事情比较多，总结来说就是，人生经历又丰富了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d4b9f9591204760a981657d4ec02993~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768040674&amp;x-signature=1Ku9jUlS5bTfj9kFxMm%2BOmMxnXA%3D" alt="1.png" loading="lazy"/></p>
<h2 data-id="heading-0">1.再次选择</h2>
<blockquote>
<p>去一线大城市闯荡人生还是留在武汉岁月静好呢？</p>
</blockquote>
<h3 data-id="heading-1">1月</h3>
<p>1月时候还在武汉国企里呢，彼时因为项目变少了，武汉人员要重新分配，没分到项目组的人要进资源池等候下一步安排。而我这个小组之前武汉是有2个人的，北京1个项目经理，给我分配了半个人的工时，另一个人直接让去资源池。关于这个项目经理，去年也写过吐槽的帖子。这个人在武汉的名声非常不好，就完全是对待牛马一样对待底下干活的人。</p>
<p>我想着以后的日子可能过得更难受，还不如直接进资源池算了。于是就和他说了，他倒也爽快，想着再从武汉随便捞个人进来呗，反正还有很多人没安排项目组的。没想到的是，他接连找了两个人，但是因为武汉的人都听说过他的名号，都表示不想去他的项目组。最后，他把项目给外包人员做了。武汉的人，宁愿待池子里，也不想跟着他干。。。</p>
<p>这让我想起以前上小学的时候，以前农村小学的老师，打学生都很厉害的。而打的原因不仅仅是因为调皮捣蛋，我那个班教数学的老师，就是其中打人最厉害的。上课的讲台两边会有两个座位嘛，每次她讲课的时候，都会从这两个座位的学生手里拿课后作业讲，要是讲的时候发现写错了，直接冲过去打头，提耳朵等等。有一次因为班上写错作业的人太多了，直接一节课没上，轮流上去扎马步。而我呢，又恰巧有一学期是坐在讲台旁边的座位，于是这学期每逢她的课必挨打，打到后面，居然在课上说，卷福坐在这，已经被我打肿了，你们再敢做错题试试。到第二学期开学的时候，大家选座位直接把前面两个位置空着了，有两个人宁愿在后面站着也不坐那位置。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7b5f332d13c4859972db360a8ca3b87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768040674&amp;x-signature=r6ZLKEctA2tjKGPgp1e%2FHQfXnS0%3D" alt="插图.png" loading="lazy"/></p>
<p>我感觉是不是历史又一次重演了呢？</p>
<p>现在回头看，当时没继续跟着他的选择是对的。在武汉，也没有岁月静好啊。</p>
<h3 data-id="heading-2">再次选择</h3>
<p>虽然5月份的时候拿了上海的offer，但是等真的要走的时候，还是会纠结的。就和刚毕业的时候去北京一样，一切都要重头开始了。走的那天，出租屋里只有个保洁阿姨在打扫卫生，就和我刚回武汉的时候一样。不同的是，上次阿姨说的是房子很快就打扫好了，这次说的是，祝老板以后去上海了发大财啊</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2be2b17b617a4bb7a3faf3d2c9074c04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768040674&amp;x-signature=AOdkmQYk4RxmTMzV6cRsZNc40Q8%3D" alt="2.jpg" loading="lazy"/></p>
<h2 data-id="heading-3">2.沪漂</h2>
<h3 data-id="heading-4">探索新事物</h3>
<p>上海就是机会多啊，休息日都会出去逛逛，探索些新事物。想想来上海之后，去周边城市参加徒步、参加ChinaJoy漫展、看了开心麻花的话剧《疯狂理发店》、还有市区内的一些公园、大学、图书馆、动物园、演唱活动等等，生活非常丰富多彩。</p>
<ul>
<li>徒步活动在小红书上找个团报就行，很多都是一天游，一半时间都在路上</li>
<li>漫展里的coser都美如画，非常适合集邮</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3860a27a7254d9d9109944c11b9a04f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768040674&amp;x-signature=X1639NmL2uou67k%2FLBD2Ebgqt9A%3D" alt="3_1.jpg" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/860e0dd37239494197cbc0ccc91efd8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768040674&amp;x-signature=EI4%2BiQXCxngICiO4iwGvDPbpVa4%3D" alt="3.jpg" loading="lazy"/></p>
<h2 data-id="heading-5">3.第一次演讲</h2>
<h3 data-id="heading-6">3月</h3>
<p>今年参加的线下活动还比较多呢，3月份的时候受腾讯云社区的邀请去杭州参加线下的技术训练营活动，主要也是想趁机会多认识些大佬，说不定大佬招人，有内推机会。倒也认识了不少人，喵喵、小智，还有社区的泽敏姐。晚上一起吃饭交流的时候，泽敏姐说下次有机会让我上去演讲。当时只以为是说说而已，毕竟社区里大佬太多了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6f3329c59cd4e3f90242d1e4a327bed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768040674&amp;x-signature=tYs1ISPbWqnPjBzxrY7nWPLpjYs%3D" alt="4.jpg" loading="lazy"/></p>
<h3 data-id="heading-7">9月</h3>
<p>9月份的时候收到社区的邀请，去深圳参加腾讯全球数字生态大会，作为讲师上去做分享。我是非常想去的，这样就能达成从学生到老师角色转变的目标，输入变输出。比较纠结的是分享什么内容比较好呢，想了一晚上，最后觉得分享自己用AI两年的经历、沉淀的一些使用心得体、还有变现方式会比较好。</p>
<p>现场的分享也是比较顺利，讲完下来的时候和小智老师沟通上台演讲体验，小智说我讲的非常干货，讲的很稳，刚才他自己讲的时候非常紧张，腿都在抖。我说，我也是啊，腿都在打颤，反而看你讲一点也不慌的样子。。。</p>
<p>第二天又和喵喵一起去腾讯数码大厦找泽敏姐，非常感谢泽敏姐的邀请，第一次到腾讯的大楼参观。期间见识到了超豪华的二次元工位，满墙的手办，非常震惊。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aea58b73cdb64e668e524f847b7e1eec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768040674&amp;x-signature=DTnnUTPaDcRhBSOhLgpWMCJPdKc%3D" alt="5.jpg" loading="lazy"/></p>
<h2 data-id="heading-8">4.AI探索</h2>
<p>选择适合自己的方向比较重要，2024年投入了很多时间在AI视频、绘画上，虽然也有涨粉嘛，但是变现不行，一年下来也就三位数的收益。今年主要在写作还有AI编程方向投入，因为换工作的原因，其实投入精力没去年那么多。反而收益还更多了，有四位数的收益。也产出了百万阅读的文章和10w+播放量的视频</p>
<p>出爆款的诀窍就是追热点，这是普通人出爆款最容易的方式了。比如年初的Deepseek，国庆期间的sora2，趁着刚出来热度最高的时候，随便写点东西或者做个视频，流量都非常好的。那像现在再去写Deepseek，流量肯定不如之前了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b85c581680094c2ca0e1ca5089a4c222~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768040674&amp;x-signature=fIRfY%2B6x9CKUlm5hMv6rTnUrC5g%3D" alt="6.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bb43c628f8c453595d6e1f307ae8e6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768040674&amp;x-signature=lqSh8rJGUVgPnpdaTBi5sBUB5a4%3D" alt="7.png" loading="lazy"/></p>
<h3 data-id="heading-9">11月</h3>
<p>11月看到小智老师发的华为鸿蒙线下编程活动的信息，拉着在上海的一个前同事一起去参加玩玩，前同事是我在北京阿里工作时同组的，后来来了上海后，我居然在一个公交站碰到他了，也是十分震惊，居然在上海遇到曾在北京的前同事。鸿蒙的编程活动都是基础的操作，正好也买了Codebuddy的会员，用AI编程轻松解决了，拿到个小礼品</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b13a9495b7542348ccb215b9aff7507~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768040674&amp;x-signature=jb9UrnNikT2CW8y7DmuocBmDi%2FQ%3D" alt="8.jpg" loading="lazy"/></p>
<h3 data-id="heading-10">12月</h3>
<p>年底了，AI破局俱乐部在深圳举办行动家大会，我看分享嘉宾和内容挺干货的，也报名跑去深圳参加了，到现场才发现，高手云集，天下英雄如过江之鲫。我把这次参会了解的东西整理了下：</p>
<ul>
<li>
<p>AIPPT.com ：赵充老师以肯德基为例分享做产品不要做全家桶，用户只想要个甜筒（不要做大而全的产品，而是在垂直领域找到需求，在单点，堵上一切）</p>
</li>
<li>
<p>AI编程出海：老外付费意愿更强，大公司不愿意做的垂直小市场，才是个人最大的机会。remove.bg网站仅有去除背景这一项功能，流量却非常高</p>
</li>
<li>
<p>搜索流量比推荐流量更值钱：用户主动搜的，说明有明确需求。而平台推的，用户只是随便看看。获取搜索流量的方法：研究用户搜索的关键词，围绕关键词输出内容，时间久了，用户搜索这个关键词，自然就找到你了</p>
</li>
</ul>
<p>活动分享的内容挺多的啊，这里就不继续写了。</p>
<p>同样的听课，结果可能完全不同，会场的1000人，参加完会回去后，可能大部分人就是感慨一下，然后继续原来的生活</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7fe6186ae197474ea445c4f433376e6f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768040674&amp;x-signature=aop67PVesi1FzhUKctc1rJhi60s%3D" alt="9.jpg" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd7d0e18fa7648e892747043f3cb538c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768040674&amp;x-signature=l8KeqHH2idwkR7HW%2BcEAkvkpD4U%3D" alt="10.jpg" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8cff48febf7483cb76fae6ecc532660~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768040674&amp;x-signature=sI5JR9WEmGfYodGKCwwfQQ964%2BY%3D" alt="11.jpg" loading="lazy"/></p>
<h2 data-id="heading-11">5.相亲</h2>
<p>离开武汉前，和大学同学聚餐，聊了下发现同学要准备去女方家提亲了，问对象是从哪里找的，说了个相亲软件。不过也很难，同学相亲了十几个女生，才和现在这个走到谈结婚这一步。知道了相亲软件（青藤）后，我来上海也开始了相亲之旅，到目前为止，还没有一个相上的，简单说下相亲的几个女生吧：</p>
<ul>
<li>91年，初中老师。其实是在武汉相亲的，家里给介绍的。感觉年龄差的太大了，差不多5岁了，不过因为是家里介绍的，还是得见上一面。3月的时候，武大樱花还开着，便想去武大里逛逛聊聊。让她把身份证号发我，用校友通道预约。然后犹犹豫豫半天没有发我，说是个人隐私等等之类的，要自己预约。结果没约上，想再用校友通道时已经约满了，无奈只好约着去学校旁边一家冷锅鱼店吃饭好了，计划约的12点见面，我预估12点半应该能吃上饭（不知道为什么，武汉相亲的女生都迟到），没想到她直到1点多才到，迟到1个多小时，期间也就各种尬聊，回去后两人都没再发消息了，凉凉</li>
<li>93年，上海公务员。家里的亲戚介绍的，是我相亲过的最优秀的女生了。以前的高考文科状元，武大校友，长得像袁咏仪，聊天说话情商也很高。接触了一个月吧，期间也一起吃过饭，看过话剧。最后一次见面聊天说起她前男友，海归，年入百万，金融行业。长相没说啊，应该也不差，妥妥高富帅。我一听这条件，心里顿时凉凉，差距太大了。问起为什么分了呢，说是男的虽然有钱，但是不给女的花，什么事都要AA。就是网上那种观念：钱是给女人看的，不是给女人花的。这次聊完之后就结束了，又凉凉。</li>
<li>95年，幼师。在上海相亲的，青藤上找的，见面后感觉非常漂亮啊。不过性格比较强势，刚开始聊的还是开心的话题，突然画风一转，她就开始吐槽模式，吐槽支教的山里小学的领导等等，后半段全是听她吐槽，没再聊相亲的话题了。回去后又聊了几周，但是幼师可能时间太紧，也可能她同时聊的人太多，后面想再约见面就没时间了，于是凉凉</li>
<li>97年，互联网数据分析师。来上海后相亲的第一个女生，也是非常漂亮，加上好友，看了我动态后，说非常崇拜技术大佬（多写博客还是有好处的嘛），想请我吃饭。于是爽快赴约，期间聊分布式、高并发等等，最后吃完饭结束的时候，说感觉身高不够</li>
<li>00年，主业机械设计，副业自媒体。遇到同行了，聊天话题特别多，情绪价值拉满。约线下去CJ漫展玩，让她把身份证号发我来买票，本来还想着怎么解释说明的，下一秒就把身份证号和手机号发来了，没有任何犹豫。约好了早上9点半去会展中心，没想到她早早到我这边来等我一起过去，连零食和水都买好了。遂开心前往，妹子是第一次逛漫展，逛的非常开心。只不过回去后还是说了性格不合，只好当朋友了。后续还是保持联系，偶尔见面</li>
</ul>
<p>这里列出不同年龄段的相亲女生，其他还有一些都是软件上匹配了没说话，或者说两句话就不继续聊了的。给兄弟们做个负面教材的参考啊，今年的相亲就到此为止，明年再说吧。。。</p>
<h2 data-id="heading-12">6.2026目标</h2>
<p>最后不都得展望下未来吗，2026年你们又给自己制定了哪些目标和规划呢，我给自己定下的目标，希望明年都能做到</p>
<ul>
<li>神山转山</li>
<li>樱花巡礼</li>
<li>新手上路</li>
<li>恰老外米</li>
</ul>
<p>最后，感兴趣的朋友可以关注我的公众号:<strong>卷福同学</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MyBatis日志模块详解]]></title>    <link>https://juejin.cn/post/7590452143016771622</link>    <guid>https://juejin.cn/post/7590452143016771622</guid>    <pubDate>2026-01-03T09:08:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590452143016771622" data-draft-id="7590503651115958322" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MyBatis日志模块详解"/> <meta itemprop="keywords" content="MyBatis"/> <meta itemprop="datePublished" content="2026-01-03T09:08:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MyBatis日志模块详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T09:08:19.000Z" title="Sat Jan 03 2026 09:08:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>作为持久层框架的佼佼者，MyBatis的日志模块为SQL调试、性能优化提供了强大支持。本文将带你深入理解其设计精髓与实战技巧。</p>
</blockquote>
<h2 data-id="heading-0">一、整体架构：日志模块的战略位置</h2>
<p>在深入探讨之前，让我们先从宏观视角理解MyBatis的分层架构。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6e674c197024d6f9435d89e6f9c2228~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768036099&amp;x-signature=9V53VHuzn71eO1CV%2BkAYk9Oe8bY%3D" alt="" loading="lazy"/></p>
<p>从架构图可以看出，日志模块位于<strong>基础支撑层</strong>，它就像一个忠实的记录员，默默记录着系统运行的每一个关键时刻。</p>
<h2 data-id="heading-1">日志模块的六大核心职责</h2>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 记录SQL执行日志 - 完整捕获执行的SQL语句
<span class="hljs-bullet">2.</span> 记录参数日志 - 追踪SQL参数的传递过程
<span class="hljs-bullet">3.</span> 记录结果日志 - 可选的查询结果记录
<span class="hljs-bullet">4.</span> 记录性能日志 - 精准统计SQL执行耗时
<span class="hljs-bullet">5.</span> 记录异常日志 - 详尽的错误信息捕获
<span class="hljs-bullet">6.</span> 集成日志框架 - 无缝适配主流日志组件
</code></pre>
<h2 data-id="heading-2">为什么日志如此重要？</h2>
<p>在实际开发中，日志扮演着三个关键角色：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-number">1</span>、开发调试阶段
  <span class="hljs-number">1</span>、查看实际执行的<span class="hljs-keyword">SQL</span>语句
  <span class="hljs-number">2</span>、检查参数绑定是否正确
  <span class="hljs-number">3</span>、快速排查<span class="hljs-keyword">SQL</span>语法错误
<span class="hljs-number">2</span>、性能优化阶段
  <span class="hljs-number">1</span>、识别执行缓慢的<span class="hljs-keyword">SQL</span>查询
  <span class="hljs-number">2</span>、分析<span class="hljs-keyword">SQL</span>执行频率分布
  <span class="hljs-number">3</span>、指导索引优化方向
<span class="hljs-number">3</span>、生产运维阶段
  <span class="hljs-number">1</span>、问题快速定位与追踪
  <span class="hljs-number">2</span>、数据操作行为审计
  <span class="hljs-number">3</span>、业务数据深度分析
</code></pre>
<h2 data-id="heading-3">MyBatis日志的五大特点</h2>





























<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td>自动集成</td><td>智能检测并使用项目中的日志框架</td></tr><tr><td>多框架支持</td><td>支持SLF4J、Log4j、Log4j2、JDK Logging等</td></tr><tr><td>分级记录</td><td>支持DEBUG、INFO、WARN、ERROR等级别</td></tr><tr><td>性能考虑</td><td>使用延迟加载，避免不必要的字符串拼接</td></tr><tr><td>JDBC日志</td><td>专门记录JDBC操作的详细日志</td></tr></tbody></table>
<h2 data-id="heading-4">二、接口架构：统一而灵活的设计</h2>
<p>MyBatis采用接口+适配器的经典设计模式，实现了与日志框架的解耦。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ec980824a08499f841a162244c593b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768036099&amp;x-signature=9mmX%2B6Xy8AZ2UxdtLFbOhURyiCw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">核心接口：Log</h2>
<p>MyBatis定义了简洁而强大的日志接口：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> interface Log {
    <span class="hljs-comment">// 是否启用DEBUG级别</span>
    <span class="hljs-function"><span class="hljs-type">boolean</span> <span class="hljs-title">isDebugEnabled</span><span class="hljs-params">()</span></span>;

    <span class="hljs-comment">// 是否启用ERROR级别</span>
    <span class="hljs-function"><span class="hljs-type">boolean</span> <span class="hljs-title">isErrorEnabled</span><span class="hljs-params">()</span></span>;

    <span class="hljs-comment">// DEBUG级别日志</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">debug</span><span class="hljs-params">(<span class="hljs-type">String</span> s)</span></span>;

    <span class="hljs-comment">// ERROR级别日志</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">error</span><span class="hljs-params">(<span class="hljs-type">String</span> s)</span></span>;

    <span class="hljs-comment">// ERROR级别日志（带异常）</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">error</span><span class="hljs-params">(<span class="hljs-type">String</span> s, Throwable e)</span></span>;

    <span class="hljs-comment">// WARN级别日志（带异常）</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">warn</span><span class="hljs-params">(<span class="hljs-type">String</span> s, Throwable e)</span></span>;
}
</code></pre>
<p><strong>日志框架适配器家族</strong>MyBatis通过适配器模式支持多种主流日志框架：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e78b04ff596642149f66c9b6fea98c45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768036099&amp;x-signature=yvum4mm5MytERF0YrBWN9zoEivY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">Slf4jImpl实现示例</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Slf4jImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Log</span> {
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">Logger</span> log;

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Slf4</span>jImpl(<span class="hljs-title class_">String</span> clazz) {
        <span class="hljs-comment">// 通过SLF4J工厂创建Logger</span>
        log = <span class="hljs-title class_">LoggerFactory</span>.<span class="hljs-title function_">getLogger</span>(clazz);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isDebugEnabled</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> log.<span class="hljs-title function_">isDebugEnabled</span>();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> s</span>) {
        log.<span class="hljs-title function_">debug</span>(s);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">error</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> s, Throwable e</span>) {
        log.<span class="hljs-title function_">error</span>(s, e);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">warn</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> s, Throwable e</span>) {
        log.<span class="hljs-title function_">warn</span>(s, e);
    }
}
</code></pre>
<h2 data-id="heading-7">LogFactory工厂类：智能选择最佳日志框架</h2>
<p>LogFactory负责按照优先级自动检测并创建合适的Log实现：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LogFactory</span> </span>{
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">static</span> Constructor<span class="hljs-meta">&lt;?</span> <span class="hljs-keyword">extends</span> Log&gt; logConstructor;

    <span class="hljs-built_in">static</span> {
        <span class="hljs-comment">// 按优先级依次尝试加载日志框架</span>
        <span class="hljs-comment">// 1. 优先尝试SLF4J</span>
        <span class="hljs-title function_ invoke__">tryImplementation</span>(Slf4jImpl.<span class="hljs-keyword">class</span>, <span class="hljs-string">"SLF4J"</span>);
        <span class="hljs-comment">// 2. 然后尝试Log4j2</span>
        <span class="hljs-title function_ invoke__">tryImplementation</span>(Log4j2Impl.<span class="hljs-keyword">class</span>, <span class="hljs-string">"Log4j 2"</span>);
        <span class="hljs-comment">// 3. 继续尝试Log4j</span>
        <span class="hljs-title function_ invoke__">tryImplementation</span>(Log4jImpl.<span class="hljs-keyword">class</span>, <span class="hljs-string">"Log4j"</span>);
        <span class="hljs-comment">// 4. 尝试JDK内置日志</span>
        <span class="hljs-title function_ invoke__">tryImplementation</span>(Jdk14LoggingImpl.<span class="hljs-keyword">class</span>, <span class="hljs-string">"JDK logging"</span>);
        <span class="hljs-comment">// 5. 降级到标准输出</span>
        <span class="hljs-title function_ invoke__">tryImplementation</span>(StdOutImpl.<span class="hljs-keyword">class</span>, <span class="hljs-string">"stdout"</span>);
        <span class="hljs-comment">// 6. 最后使用空实现</span>
        <span class="hljs-title function_ invoke__">tryImplementation</span>(NoOpImpl.<span class="hljs-keyword">class</span>, <span class="hljs-string">"noop"</span>);
    }

    <span class="hljs-comment">// 获取Log实例</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> Log <span class="hljs-title function_ invoke__">getLog</span>(Class&lt;?&gt; clazz) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">getLog</span>(clazz.<span class="hljs-title function_ invoke__">getName</span>());
    }

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> Log <span class="hljs-title function_ invoke__">getLog</span>(String logger) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> logConstructor.<span class="hljs-title function_ invoke__">newInstance</span>(logger);
        } <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Throwable</span> t) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(
                <span class="hljs-string">"Error creating logger for "</span> + logger, t);
        }
    }

    <span class="hljs-comment">// 支持自定义日志实现</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> synchronized <span class="hljs-keyword">void</span> <span class="hljs-title function_ invoke__">useCustomLogging</span>(
        Class&lt;? <span class="hljs-keyword">extends</span> Log&gt; clazz) {
        <span class="hljs-title function_ invoke__">setImplementation</span>(clazz);
    }
}
</code></pre>
<h2 data-id="heading-8">三、日志配置：灵活多样的配置方式</h2>
<p>MyBatis提供了多种配置方式，满足不同场景需求。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ddd4bb5b7234b269aa823981fe198d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768036099&amp;x-signature=VSgedxv7z3scvAIPAVQ1I%2FuzxOY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">方式1：mybatis-config.xml配置</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">settings</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 可选：显式指定日志实现 --&gt;</span>
        <span class="hljs-comment">&lt;!-- &lt;setting name="logImpl" value="SLF4J"/&gt; --&gt;</span>
        <span class="hljs-comment">&lt;!-- &lt;setting name="logImpl" value="LOG4J2"/&gt; --&gt;</span>
        <span class="hljs-comment">&lt;!-- &lt;setting name="logImpl" value="STDOUT_LOGGING"/&gt; --&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">settings</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
</code></pre>
<h2 data-id="heading-10">方式2：Log4j2详细配置</h2>
<p><strong>log4j2.xml：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">Configuration</span> <span class="hljs-attr">status</span>=<span class="hljs-string">"WARN"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Appenders</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 控制台输出 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Console</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"Console"</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"SYSTEM_OUT"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">PatternLayout</span> 
                <span class="hljs-attr">pattern</span>=<span class="hljs-string">"%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Console</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 文件输出（滚动策略） --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">RollingFile</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"RollingFile"</span> 
                     <span class="hljs-attr">fileName</span>=<span class="hljs-string">"logs/mybatis.log"</span>
                     <span class="hljs-attr">filePattern</span>=<span class="hljs-string">"logs/mybatis-%d{yyyy-MM-dd}-%i.log.gz"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">PatternLayout</span> 
                <span class="hljs-attr">pattern</span>=<span class="hljs-string">"%d{yyyy-MM-dd HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n"</span>/&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Policies</span>&gt;</span>
                <span class="hljs-comment">&lt;!-- 每天滚动 --&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">TimeBasedTriggeringPolicy</span> <span class="hljs-attr">interval</span>=<span class="hljs-string">"1"</span>/&gt;</span>
                <span class="hljs-comment">&lt;!-- 单文件最大100MB --&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">SizeBasedTriggeringPolicy</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"100 MB"</span>/&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Policies</span>&gt;</span>
            <span class="hljs-comment">&lt;!-- 最多保留30天 --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">DefaultRolloverStrategy</span> <span class="hljs-attr">max</span>=<span class="hljs-string">"30"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">RollingFile</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Appenders</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">Loggers</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- MyBatis核心日志 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"org.apache.ibatis"</span> <span class="hljs-attr">level</span>=<span class="hljs-string">"DEBUG"</span> <span class="hljs-attr">additivity</span>=<span class="hljs-string">"false"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">AppenderRef</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"Console"</span>/&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">AppenderRef</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"RollingFile"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Logger</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- SQL语句日志 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"org.apache.ibatis.jdbc.SQL"</span> 
                <span class="hljs-attr">level</span>=<span class="hljs-string">"DEBUG"</span> <span class="hljs-attr">additivity</span>=<span class="hljs-string">"false"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">AppenderRef</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"Console"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Logger</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- Root Logger --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Root</span> <span class="hljs-attr">level</span>=<span class="hljs-string">"INFO"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">AppenderRef</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"Console"</span>/&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">AppenderRef</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"RollingFile"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Root</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Loggers</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Configuration</span>&gt;</span>
</code></pre>
<h2 data-id="heading-11">方式3：Logback配置</h2>
<p><strong>logback.xml：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 控制台输出 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"CONSOLE"</span> 
              <span class="hljs-attr">class</span>=<span class="hljs-string">"ch.qos.logback.core.ConsoleAppender"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">encoder</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">pattern</span>&gt;</span>%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n<span class="hljs-tag">&lt;/<span class="hljs-name">pattern</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">encoder</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 文件输出 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"FILE"</span> 
              <span class="hljs-attr">class</span>=<span class="hljs-string">"ch.qos.logback.core.rolling.RollingFileAppender"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">file</span>&gt;</span>logs/mybatis.log<span class="hljs-tag">&lt;/<span class="hljs-name">file</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">rollingPolicy</span> 
            <span class="hljs-attr">class</span>=<span class="hljs-string">"ch.qos.logback.core.rolling.TimeBasedRollingPolicy"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">fileNamePattern</span>&gt;</span>logs/mybatis-%d{yyyy-MM-dd}.log<span class="hljs-tag">&lt;/<span class="hljs-name">fileNamePattern</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">maxHistory</span>&gt;</span>30<span class="hljs-tag">&lt;/<span class="hljs-name">maxHistory</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">rollingPolicy</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">encoder</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">pattern</span>&gt;</span>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n<span class="hljs-tag">&lt;/<span class="hljs-name">pattern</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">encoder</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- MyBatis日志配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"org.apache.ibatis"</span> <span class="hljs-attr">level</span>=<span class="hljs-string">"DEBUG"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"java.sql.Connection"</span> <span class="hljs-attr">level</span>=<span class="hljs-string">"DEBUG"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"java.sql.Statement"</span> <span class="hljs-attr">level</span>=<span class="hljs-string">"DEBUG"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"java.sql.PreparedStatement"</span> <span class="hljs-attr">level</span>=<span class="hljs-string">"DEBUG"</span>/&gt;</span>

    <span class="hljs-comment">&lt;!-- Root配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">root</span> <span class="hljs-attr">level</span>=<span class="hljs-string">"INFO"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"CONSOLE"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"FILE"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
</code></pre>
<h2 data-id="heading-12">方式4：Spring Boot配置</h2>
<p><strong>application.yml：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 日志配置</span>
<span class="hljs-attr">logging:</span>
  <span class="hljs-attr">level:</span>
    <span class="hljs-comment"># MyBatis SQL日志</span>
    <span class="hljs-attr">org.apache.ibatis:</span> <span class="hljs-string">DEBUG</span>
    <span class="hljs-attr">java.sql.Connection:</span> <span class="hljs-string">DEBUG</span>
    <span class="hljs-attr">java.sql.Statement:</span> <span class="hljs-string">DEBUG</span>
    <span class="hljs-attr">java.sql.PreparedStatement:</span> <span class="hljs-string">DEBUG</span>
    <span class="hljs-attr">java.sql.ResultSet:</span> <span class="hljs-string">WARN</span>
  <span class="hljs-comment"># 日志文件配置</span>
  <span class="hljs-attr">file:</span>
    <span class="hljs-attr">path:</span> <span class="hljs-string">logs</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">myapp.log</span>
    <span class="hljs-attr">max-size:</span> <span class="hljs-string">100MB</span>
    <span class="hljs-attr">max-history:</span> <span class="hljs-number">30</span>
  <span class="hljs-comment"># 日志格式</span>
  <span class="hljs-attr">pattern:</span>
    <span class="hljs-attr">console:</span> <span class="hljs-string">"%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"</span>
    <span class="hljs-attr">file:</span> <span class="hljs-string">"%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"</span>
</code></pre>
<h2 data-id="heading-13">四、JDBC日志：细粒度的操作追踪</h2>
<p><strong>MyBatis提供了专门的JDBC日志记录机制，可以追踪每一个JDBC操作的细节。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5da0ae4cc6eb4e73bbdba0f3458070d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768036099&amp;x-signature=jvuOpcBqFGp8JFVPIcsLjt8Q8Gg%3D" alt="" loading="lazy"/></p>
<p><strong>JDBC日志记录内容</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15bc48f40d6547979a9ebcd35f24d70f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768036099&amp;x-signature=B9h84ioMds2D81cMCIZGZ9UBw2c%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-14">BaseJdbcLogger基础类</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseJdbcLogger</span> {
    <span class="hljs-comment">// 日志对象</span>
    <span class="hljs-keyword">protected</span> Log statementLog;
    <span class="hljs-keyword">protected</span> Log connectionLog;

    <span class="hljs-comment">// 调试开关</span>
    <span class="hljs-keyword">protected</span> boolean isDebugEnabled;

    <span class="hljs-comment">// 慢查询阈值（毫秒）</span>
    <span class="hljs-keyword">protected</span> int slowQueryThreshold;

    <span class="hljs-keyword">public</span> BaseJdbcLogger(Log log, int queryThreshold) {
        <span class="hljs-keyword">this</span>.statementLog = log;
        <span class="hljs-keyword">this</span>.connectionLog = log;
        <span class="hljs-keyword">this</span>.isDebugEnabled = log.isDebugEnabled();
        <span class="hljs-keyword">this</span>.slowQueryThreshold = queryThreshold;
    }

    <span class="hljs-comment">// 记录SQL执行</span>
    <span class="hljs-keyword">protected</span> void debug(String s, boolean isSql) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isDebugEnabled) {
            <span class="hljs-keyword">this</span>.statementLog.debug(s);
        }
    }

    <span class="hljs-comment">// 记录连接创建</span>
    <span class="hljs-keyword">protected</span> void connectionCreated(Connection conn) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.connectionLog.isDebugEnabled()) {
            <span class="hljs-keyword">this</span>.connectionLog.debug(<span class="hljs-string">"==&gt;  Opening JDBC Connection"</span>);
        }
    }

    <span class="hljs-comment">// 记录连接关闭</span>
    <span class="hljs-keyword">protected</span> void connectionClosed(Connection conn) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.connectionLog.isDebugEnabled()) {
            <span class="hljs-keyword">this</span>.connectionLog.debug(<span class="hljs-string">"&lt;==  Closing JDBC Connection"</span>);
        }
    }
}
</code></pre>
<h2 data-id="heading-15">ConnectionLogger连接日志</h2>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConnectionLogger</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseJdbcLogger</span> </span>
    implements <span class="hljs-type">InvocationHandler</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Connection</span> connection;

    public <span class="hljs-type">ConnectionLogger</span>(<span class="hljs-type">Connection</span> conn, <span class="hljs-type">Log</span> log, int queryThreshold) {
        <span class="hljs-keyword">super</span>(log, queryThreshold);
        <span class="hljs-keyword">this</span>.connection = conn;
    }

    <span class="hljs-meta">@Override</span>
    public <span class="hljs-type">Object</span> invoke(<span class="hljs-type">Object</span> proxy, <span class="hljs-type">Method</span> method, <span class="hljs-type">Object</span>[] args) 
        <span class="hljs-keyword">throws</span> <span class="hljs-type">Throwable</span> {
        <span class="hljs-type">String</span> methodName = method.getName();

        <span class="hljs-comment">// 记录PreparedStatement创建</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"prepareStatement"</span>.equals(methodName) || 
            <span class="hljs-string">"prepareCall"</span>.equals(methodName)) {
            <span class="hljs-keyword">if</span> (isDebugEnabled()) {
                debug(<span class="hljs-string">"Preparing: "</span> + 
                    removeBreakingWhitespace((<span class="hljs-type">String</span>) args[<span class="hljs-number">0</span>]), <span class="hljs-literal">true</span>);
            }
        }

        <span class="hljs-comment">// 记录连接关闭</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"close"</span>.equals(methodName)) {
            connectionClosed(connection);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }

        <span class="hljs-comment">// 执行原方法</span>
        <span class="hljs-keyword">return</span> method.invoke(connection, args);
    }
}
</code></pre>
<h2 data-id="heading-16">PreparedStatementLogger语句日志</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PreparedStatementLogger</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseJdbcLogger</span> 
    <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PreparedStatement statement;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String sql;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Object[] parameterValues;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> 
        <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> method.getName();

        <span class="hljs-comment">// 记录参数设置</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"setString"</span>.equals(methodName) || 
            <span class="hljs-string">"setInt"</span>.equals(methodName) ||
            <span class="hljs-string">"setLong"</span>.equals(methodName)) {
            <span class="hljs-keyword">if</span> (args.length == <span class="hljs-number">2</span>) {
                <span class="hljs-type">int</span> <span class="hljs-variable">paramIndex</span> <span class="hljs-operator">=</span> (Integer) args[<span class="hljs-number">0</span>];
                <span class="hljs-type">Object</span> <span class="hljs-variable">paramValue</span> <span class="hljs-operator">=</span> args[<span class="hljs-number">1</span>];
                parameterValues[paramIndex - <span class="hljs-number">1</span>] = paramValue;

                <span class="hljs-keyword">if</span> (isDebugEnabled) {
                    debug(<span class="hljs-string">"Parameters: "</span> + paramIndex + 
                        <span class="hljs-string">" =&gt; "</span> + paramValue, <span class="hljs-literal">true</span>);
                }
            }
        }

        <span class="hljs-comment">// 记录SQL执行</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"execute"</span>.equals(methodName) || 
            <span class="hljs-string">"executeUpdate"</span>.equals(methodName) ||
            <span class="hljs-string">"executeQuery"</span>.equals(methodName)) {

            <span class="hljs-keyword">if</span> (isDebugEnabled) {
                debug(<span class="hljs-string">"==&gt;  Executing: "</span> + sql, <span class="hljs-literal">true</span>);
                debug(<span class="hljs-string">"==&gt; Parameters: "</span> + 
                    getParameterString(), <span class="hljs-literal">true</span>);
            }

            <span class="hljs-comment">// 计时执行</span>
            <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
            <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> method.invoke(statement, args);
            <span class="hljs-type">long</span> <span class="hljs-variable">cost</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - start;

            <span class="hljs-keyword">if</span> (isDebugEnabled) {
                debug(<span class="hljs-string">"&lt;==  Total: "</span> + cost + <span class="hljs-string">" ms"</span>, <span class="hljs-literal">true</span>);
            }

            <span class="hljs-comment">// 慢查询告警</span>
            <span class="hljs-keyword">if</span> (slowQueryThreshold &gt; <span class="hljs-number">0</span> &amp;&amp; cost &gt; slowQueryThreshold) {
                connectionLog.warn(<span class="hljs-string">"Slow query detected: "</span> + 
                    cost + <span class="hljs-string">" ms"</span>);
            }

            <span class="hljs-keyword">return</span> result;
        }

        <span class="hljs-keyword">return</span> method.invoke(statement, args);
    }

    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getParameterString</span><span class="hljs-params">()</span> {
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; parameterValues.length; i++) {
            <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span>) sb.append(<span class="hljs-string">", "</span>);
            sb.append(i + <span class="hljs-number">1</span>).append(<span class="hljs-string">" =&gt; "</span>).append(parameterValues[i]);
        }
        <span class="hljs-keyword">return</span> sb.toString();
    }
}
</code></pre>
<h2 data-id="heading-17">ResultSetLogger结果集日志</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResultSetLogger</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseJdbcLogger</span> 
    <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ResultSet resultSet;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;String&gt; columnNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;String&gt; columnValues = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> 
        <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> method.getName();
        <span class="hljs-comment">// 记录列名</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"next"</span>.equals(methodName)) {
            <span class="hljs-keyword">if</span> (columnNames.isEmpty()) {
                <span class="hljs-type">ResultSetMetaData</span> <span class="hljs-variable">metaData</span> <span class="hljs-operator">=</span> resultSet.getMetaData();
                <span class="hljs-type">int</span> <span class="hljs-variable">columnCount</span> <span class="hljs-operator">=</span> metaData.getColumnCount();
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= columnCount; i++) {
                    columnNames.add(metaData.getColumnName(i));
                }
            }
        }
        <span class="hljs-comment">// 记录结果值</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"getString"</span>.equals(methodName) || 
            <span class="hljs-string">"getInt"</span>.equals(methodName) ||
            <span class="hljs-string">"getObject"</span>.equals(methodName)) {
            <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> method.invoke(resultSet, args);
            <span class="hljs-keyword">if</span> (isDebugEnabled &amp;&amp; result != <span class="hljs-literal">null</span>) {
                <span class="hljs-type">String</span> <span class="hljs-variable">columnName</span> <span class="hljs-operator">=</span> columnNames.isEmpty() ? 
                    <span class="hljs-string">"?"</span> : columnNames.get(columnValues.size());
                columnValues.add(columnName + <span class="hljs-string">" = "</span> + result);
            }
            <span class="hljs-keyword">return</span> result;
        }
        <span class="hljs-comment">// 记录结果集关闭</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"close"</span>.equals(methodName)) {
            <span class="hljs-keyword">if</span> (isDebugEnabled &amp;&amp; !columnValues.isEmpty()) {
                debug(<span class="hljs-string">"&lt;==    Columns: "</span> + columnNames, <span class="hljs-literal">true</span>);
                debug(<span class="hljs-string">"&lt;==        Row: "</span> + columnValues, <span class="hljs-literal">true</span>);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        <span class="hljs-keyword">return</span> method.invoke(resultSet, args);
    }
}
</code></pre>
<h2 data-id="heading-18">五、日志适配器：优雅的框架集成</h2>
<h2 data-id="heading-19">MyBatis通过适配器模式实现了与各种日志框架的无缝集成。</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a4b1e8cfcd842c8b3780da146c9054b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768036099&amp;x-signature=aoe60Wez%2BnP3zk2dpXgpvsuVKU8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-20">日志适配器的工作流程</h2>
<pre><code class="hljs language-markdown" lang="markdown">MyBatis Log接口
<span class="hljs-code">    ↓
日志适配器 (Log4j2Impl)
    ↓
Log4j2 Logger
    ↓
日志输出（控制台/文件）
</span></code></pre>
<h2 data-id="heading-21">日志输出（控制台/文件）</h2>
<p>LogFactory按照优先级自动检测并选择日志框架：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> SLF4J (优先级最高)
<span class="hljs-bullet">2.</span> Log4j2
<span class="hljs-bullet">3.</span> Log4j
<span class="hljs-bullet">4.</span> JDK Logging
<span class="hljs-bullet">5.</span> STDOUT (标准输出)
<span class="hljs-bullet">6.</span> NOOP (无日志
</code></pre>
<p><strong>自定义日志适配器</strong></p>
<p>如果需要使用自定义日志框架，可以轻松扩展：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomLog</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Log</span> {
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">CustomLogger</span> logger;

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">CustomLog</span>(<span class="hljs-title class_">String</span> clazz) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span> = <span class="hljs-title class_">CustomLoggerFactory</span>.<span class="hljs-title function_">getLogger</span>(clazz);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isDebugEnabled</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> logger.<span class="hljs-title function_">isDebugEnabled</span>();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> s</span>) {
        logger.<span class="hljs-title function_">debug</span>(s);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">error</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> s, Throwable e</span>) {
        logger.<span class="hljs-title function_">error</span>(s, e);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">warn</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> s, Throwable e</span>) {
        logger.<span class="hljs-title function_">warn</span>(s, e);
    }
}

<span class="hljs-comment">// 使用自定义日志</span>
<span class="hljs-title class_">LogFactory</span>.<span class="hljs-title function_">useCustomLogging</span>(<span class="hljs-title class_">CustomLog</span>.<span class="hljs-property">class</span>);
</code></pre>
<h2 data-id="heading-22">主流日志框架对比</h2>









































<table><thead><tr><th>日志框架</th><th>优点</th><th>缺点</th><th>适用场景</th></tr></thead><tbody><tr><td>SLF4J</td><td>统一日志门面性能优秀</td><td>需要绑定实现</td><td>大型项目</td></tr><tr><td>Log4j2</td><td>性能最佳功能强大</td><td>配置相对复杂</td><td>高并发系统</td></tr><tr><td>Log4j</td><td>成熟稳定社区活跃</td><td>性能一般</td><td>老项目维护</td></tr><tr><td>JDK Logging</td><td>无需额外依赖简单轻量</td><td>功能有限</td><td>简单项目</td></tr><tr><td>STDOUT</td><td>配置简单即开即用</td><td>无格式化不可配置</td><td>开发测试</td></tr></tbody></table>
<h2 data-id="heading-23">六、实战应用：日志在开发中的运用</h2>
<p>让我们通过实际场景看看日志如何帮助我们解决问题。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26edd45c03754ffab9a62d69e79144ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768036099&amp;x-signature=pZ3bRAdX6da0Dp1Hu98O6pylXYM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-24">场景1：SQL调试日志</h2>
<p>记录完整的SQL语句和参数，快速定位问题：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">/</span><span class="hljs-operator">/</span> 执行查询
<span class="hljs-keyword">User</span> <span class="hljs-keyword">user</span> <span class="hljs-operator">=</span> userMapper.selectById(<span class="hljs-number">1</span>L);

<span class="hljs-operator">/</span><span class="hljs-operator">/</span> 控制台输出：
<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span>  Preparing: <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_user <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> ?
<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> Parameters: <span class="hljs-number">1</span>(<span class="hljs-type">Integer</span>)
<span class="hljs-operator">&lt;=</span><span class="hljs-operator">=</span>    Columns: id, name, email, age, create_time
<span class="hljs-operator">&lt;=</span><span class="hljs-operator">=</span>        <span class="hljs-type">Row</span>: <span class="hljs-number">1</span>, 张三, zhangsan<span class="hljs-variable">@example</span>.com, <span class="hljs-number">25</span>, <span class="hljs-number">2024</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">10</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>
<span class="hljs-operator">&lt;=</span><span class="hljs-operator">=</span>  Total: <span class="hljs-number">15</span> ms
</code></pre>
<h2 data-id="heading-25">场景2：性能监控日志</h2>
<p>识别慢查询，优化系统性能：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> Object <span class="hljs-title function_">query</span><span class="hljs-params">(...)</span> <span class="hljs-keyword">throws</span> SQLException {
    <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();

    <span class="hljs-keyword">try</span> {
        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> method.invoke(target, args);
        <span class="hljs-keyword">return</span> result;
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">cost</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - start;

        <span class="hljs-comment">// 慢查询告警</span>
        <span class="hljs-keyword">if</span> (cost &gt; slowQueryThreshold) {
            logger.warn(<span class="hljs-string">"Slow query: {} ms - SQL: {}"</span>, 
                cost, sql);
        }

        <span class="hljs-keyword">if</span> (isDebugEnabled) {
            logger.debug(<span class="hljs-string">"Query cost: {} ms"</span>, cost);
        }
    }
}
</code></pre>
<h2 data-id="heading-26">场景3：参数日志</h2>
<p>检查参数绑定是否正确：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">/</span><span class="hljs-operator">/</span> 查询用户
List<span class="hljs-operator">&lt;</span><span class="hljs-keyword">User</span><span class="hljs-operator">&gt;</span> users <span class="hljs-operator">=</span> userMapper.selectByCondition("张", <span class="hljs-number">25</span>);

<span class="hljs-operator">/</span><span class="hljs-operator">/</span> 日志输出：
<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span>  Preparing: <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_user 
     <span class="hljs-keyword">WHERE</span> name <span class="hljs-keyword">LIKE</span> CONCAT(<span class="hljs-string">'%'</span>, ?, <span class="hljs-string">'%'</span>) <span class="hljs-keyword">AND</span> age <span class="hljs-operator">=</span> ?
<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> Parameters: 张(String), <span class="hljs-number">25</span>(<span class="hljs-type">Integer</span>)
<span class="hljs-operator">&lt;=</span><span class="hljs-operator">=</span>  Total: <span class="hljs-number">22</span> ms
<span class="hljs-operator">&lt;=</span><span class="hljs-operator">=</span>      <span class="hljs-keyword">Rows</span>: <span class="hljs-number">5</span>
</code></pre>
<h2 data-id="heading-27">场景4：结果日志（开发环境）</h2>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 日志输出：</span>
&lt;==    <span class="hljs-attribute">Columns</span>: id, name, email
&lt;==        <span class="hljs-attribute">Row</span>: <span class="hljs-number">1</span>, 张三, zhangsan<span class="hljs-variable">@example</span>.com
&lt;==        <span class="hljs-attribute">Row</span>: <span class="hljs-number">2</span>, 李四, lisi<span class="hljs-variable">@example</span>.com
&lt;==        <span class="hljs-attribute">Row</span>: <span class="hljs-number">3</span>, 王五, wangwu<span class="hljs-variable">@example</span>.com
&lt;==  <span class="hljs-attribute">Total</span>: <span class="hljs-number">3</span> rows
</code></pre>
<h2 data-id="heading-28">场景5：异常日志</h2>
<p>详细记录SQL执行异常：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">try</span> {
    userMapper.insert(user);
} <span class="hljs-keyword">catch</span> (Exception e) {
    <span class="hljs-comment">// 日志输出：</span>
    ==&gt;  Preparing: <span class="hljs-function">INSERT INTO <span class="hljs-title">t_user</span> (<span class="hljs-params">name, email</span>) <span class="hljs-title">VALUES</span> (<span class="hljs-params">?, ?</span>)</span>
    ==&gt; Parameters: 张三(String), invalid-email(String)
    <span class="hljs-meta">### Error updating database.</span>
    <span class="hljs-meta">### Cause: java.sql.SQLException: Incorrect string value</span>
    <span class="hljs-meta">### The <span class="hljs-keyword">error</span> may exist in UserMapper.xml</span>
    <span class="hljs-meta">### The <span class="hljs-keyword">error</span> may involve UserMapper.insert</span>
    <span class="hljs-meta">### SQL: INSERT INTO t_user (name, email) VALUES (?, ?)</span>
    <span class="hljs-meta">### Cause: java.sql.SQLException: Incorrect string value</span>
}
</code></pre>
<h2 data-id="heading-29">场景6：事务日志</h2>
<p>追踪事务的完整生命周期：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 开启事务</span>
SqlSession session = sqlSessionFactory.openSession();

<span class="hljs-comment">// 日志输出：</span>
==&gt;  Opening JDBC Connection
==&gt;  Setting autocommit to <span class="hljs-keyword">false</span> <span class="hljs-keyword">on</span> JDBC Connection

<span class="hljs-comment">// 提交事务</span>
session.commit();

<span class="hljs-comment">// 日志输出：</span>
==&gt;  Committing JDBC Connection
&lt;==  Closing JDBC Connection
</code></pre>
<h2 data-id="heading-30">七、最佳实践</h2>
<h2 data-id="heading-31">不同环境的日志配置策略</h2>
<h2 data-id="heading-32">开发环境配置</h2>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">logging:</span>
  <span class="hljs-attr">level:</span>
    <span class="hljs-attr">org.apache.ibatis:</span> <span class="hljs-string">DEBUG</span>
  <span class="hljs-comment"># 启用DEBUG级别</span>
  <span class="hljs-comment"># 记录SQL和参数</span>
  <span class="hljs-comment"># 记录结果集</span>
  <span class="hljs-comment"># 记录执行时间</span>
</code></pre>
<h2 data-id="heading-33">测试环境配置</h2>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">logging:</span>
  <span class="hljs-attr">level:</span>
    <span class="hljs-attr">org.apache.ibatis:</span> <span class="hljs-string">INFO</span>
  <span class="hljs-comment"># 启用INFO级别</span>
  <span class="hljs-comment"># 记录SQL和参数</span>
  <span class="hljs-comment"># 记录慢查询（&gt;1秒）</span>
  <span class="hljs-comment"># 记录异常信息</span>
</code></pre>
<h2 data-id="heading-34">生产环境配置</h2>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">logging:</span>
  <span class="hljs-attr">level:</span>
    <span class="hljs-attr">org.apache.ibatis:</span> <span class="hljs-string">WARN</span>
  <span class="hljs-comment"># 启用WARN级别</span>
  <span class="hljs-comment"># 仅记录慢查询（&gt;3秒）</span>
  <span class="hljs-comment"># 记录错误和异常</span>
</code></pre>
<h2 data-id="heading-35">性能优化</h2>
<h2 data-id="heading-36">1️⃣ 合理设置日志级别</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 生产环境使用INFO或WARN级别 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"org.apache.ibatis"</span> <span class="hljs-attr">level</span>=<span class="hljs-string">"WARN"</span>/&gt;</span>
</code></pre>
<h2 data-id="heading-37">2️⃣ 使用异步日志</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Log4j2异步日志配置 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">Async</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"AsyncAppender"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">AppenderRef</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"RollingFile"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Async</span>&gt;</span>
</code></pre>
<h2 data-id="heading-38">3️⃣ SQL日志单独存储</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- SQL日志独立文件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">RollingFile</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"SqlLog"</span> <span class="hljs-attr">fileName</span>=<span class="hljs-string">"logs/sql.log"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">PatternLayout</span> <span class="hljs-attr">pattern</span>=<span class="hljs-string">"%d{yyyy-MM-dd HH:mm:ss} - %msg%n"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">RollingFile</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">Logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"org.apache.ibatis.jdbc"</span> <span class="hljs-attr">level</span>=<span class="hljs-string">"DEBUG"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">AppenderRef</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"SqlLog"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Logger</span>&gt;</span>
</code></pre>
<h2 data-id="heading-39">4️⃣ 日志文件滚动策略</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Policies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 每天滚动 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">TimeBasedTriggeringPolicy</span> <span class="hljs-attr">interval</span>=<span class="hljs-string">"1"</span>/&gt;</span>
    <span class="hljs-comment">&lt;!-- 单文件最大100MB --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">SizeBasedTriggeringPolicy</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"100 MB"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Policies</span>&gt;</span>
<span class="hljs-comment">&lt;!-- 最多保留30天 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">DefaultRolloverStrategy</span> <span class="hljs-attr">max</span>=<span class="hljs-string">"30"</span>/&gt;</span>
</code></pre>
<h2 data-id="heading-40">八、总结</h2>
<p>MyBatis的日志模块为开发调试和性能优化提供了强大的支持。</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> Log接口 - MyBatis定义的统一日志接口，实现与框架解耦
<span class="hljs-bullet">2.</span> 日志适配器 -通过适配器模式支持多种日志框架
<span class="hljs-bullet">3.</span> JDBC日志 - 细粒度的JDBC操作日志记录
<span class="hljs-bullet">4.</span> 灵活配置 - 支持多种配置方式，适应不同场景
<span class="hljs-bullet">5.</span> 性能监控 - 通过日志识别性能瓶颈
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从重启马车到常驻运输队：CGI 与 PHP 的物流系统演进简史]]></title>    <link>https://juejin.cn/post/7589932422655344676</link>    <guid>https://juejin.cn/post/7589932422655344676</guid>    <pubDate>2026-01-03T09:00:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589932422655344676" data-draft-id="7589932422655311908" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从重启马车到常驻运输队：CGI 与 PHP 的物流系统演进简史"/> <meta itemprop="keywords" content="后端,PHP,Java"/> <meta itemprop="datePublished" content="2026-01-03T09:00:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="韩师傅"/> <meta itemprop="url" content="https://juejin.cn/user/286348958252526"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从重启马车到常驻运输队：CGI 与 PHP 的物流系统演进简史
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/286348958252526/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    韩师傅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T09:00:30.000Z" title="Sat Jan 03 2026 09:00:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>摘要</strong>：从 CGI 每次重启进程的"外包临工"模式，到 PHP 进程复用的"自家雇员"模式。第一代和第二代物流系统的关键差异在于进程是否可以复用，这是 Web API 演进史上的第一个重要转折点。</p>
<h2 data-id="heading-0">🚚 物流系统的演进史</h2>
<h3 data-id="heading-1">大蟒蛇法师的困惑</h3>
<p>🐍 大蟒蛇法师："灵狐法师问我，FastAPI 是不是第一代物流系统？其实不是的。在 FastAPI 之前，已经有很多物流系统了。让我给你讲讲物流系统的演进史，以及不同法师们的物流系统。"</p>
<p><strong>核心理解</strong>：</p>
<ul>
<li>FastAPI 不是第一代物流系统</li>
<li>在 FastAPI 之前，已经有很多物流系统（Flask、Django、Express 等）</li>
<li>这些物流系统都在不断演进，适应不同的需求</li>
<li>REST API 是一个<strong>概念</strong>，不是某个具体的物流系统</li>
<li>不同的法师有不同的物流系统</li>
</ul>
<h3 data-id="heading-2">法师角色介绍</h3>
<p>在魔法世界里，不同的法师负责不同的后端技术：</p>
<ul>
<li>🐍 <strong>大蟒蛇法师</strong>：Python 后端，负责 Flask、Django、FastAPI 等 Python 物流系统，<strong>需要与灵狐法师合作</strong>（前后端分离）</li>
<li>🦊 <strong>灵狐法师</strong>：前端开发（JavaScript），负责卖货给客户，与大蟒蛇法师、夜狐法师合作</li>
<li>🌙 <strong>夜狐法师</strong>：Node.js 后端，隐藏于黑暗中，不露面，与兄弟灵狐法师合作，负责后端配置（前后端分离）</li>
<li>🧵 <strong>PHP 织布师</strong>：PHP 后端，负责 PHP 物流系统，<strong>不需要与灵狐法师合作</strong>（传统全栈模式，直接返回 HTML）</li>
<li>☕ <strong>黑水甲瓦法师</strong>：Java 后端，负责 Servlet、Spring 等 Java 物流系统
<ul>
<li><strong>Servlet 时代（1990s）</strong>：主要是传统模式，Servlet + JSP，直接返回 HTML，<strong>不需要与灵狐法师合作</strong>（前后端不分离）</li>
<li><strong>现代模式（Spring MVC，2010s+）</strong>：可以前后端分离，提供 REST API，<strong>需要与灵狐法师合作</strong></li>
</ul>
</li>
<li>🛡️ <strong>蓝盾法师</strong>：ASP.NET 后端，概念法师，从彩色方块世界来的，没人见过他的真身，只有外号
<ul>
<li><strong>传统模式</strong>：类似 PHP 织布师，直接返回 HTML，<strong>不需要与灵狐法师合作</strong></li>
<li><strong>现代模式</strong>：ASP.NET Core Web API，<strong>需要与灵狐法师合作</strong>（前后端分离）</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-3">📜 第一代：原始物流系统（CGI、Servlet）</h2>
<h3 data-id="heading-4">时代背景</h3>
<p>🐍 大蟒蛇法师："最早的物流系统，就像最原始的送货任务。每次订单都要重新启动整个送货任务，效率很低。那时候，CGI 和黑水甲瓦法师（Java）的 Servlet 系统就是这样的。"</p>
<h3 data-id="heading-5">CGI 是什么？</h3>
<p>🐍 大蟒蛇法师："CGI（Common Gateway Interface，通用网关接口）是一个<strong>接口标准</strong>，定义了 Web 服务器如何与外部程序通信。在原始时代，没有完整的备货流程，每次订单都要重新开始。"</p>
<p><strong>CGI = 启动马车和道路的方法（接口标准）</strong>：</p>
<ul>
<li><strong>不是完整的物流系统</strong>：而是"如何启动马车和道路"的方法（接口标准）</li>
<li><strong>定义了接口标准</strong>：定义了 Web 服务器如何调用外部程序的接口标准</li>
<li><strong>不是具体的物流系统</strong>：而是一个接口标准，定义了如何与外部程序通信</li>
<li><strong>通用接口</strong>：所有法师都可以使用这个接口标准</li>
<li><strong>每次请求都要启动新进程</strong>：每次订单都要重新启动程序进程（整个送货的任务）</li>
<li><strong>处理完就结束</strong>：程序处理完订单后，进程（整个送货的任务）就结束了</li>
</ul>
<p><strong>CGI 的定位</strong>：</p>
<ul>
<li><strong>CGI = 接口标准</strong>：定义了"如何启动马车和道路"的方法</li>
<li><strong>不是完整的物流系统</strong>：只是定义了如何调用外部程序的接口</li>
<li><strong>FastAPI 比它完整得多</strong>：FastAPI 是完整的物流系统（框架），包含路由系统、中间件、数据验证等</li>
</ul>
<p><strong>CGI 时代 = 原始时代，没有完整的备货流程</strong></p>
<p>☕ 黑水甲瓦法师："在 CGI 时代，没有完整的备货流程。收到订单之后，我会启动整个送货任务，去到每个仓库，每个仓库的大门都需要大开，从材料的查找开始，一个个去找，然后再制作。每次来新订单，都要重新启动整个送货任务，一个个仓库去开，然后做产品。同样的流程没有被记录和筛检，所以等于每次都是新的。"</p>
<p><strong>CGI 的工作方式（魔法仓库比喻）</strong>：</p>
<pre><code class="hljs language-plain" lang="plain">客户下单
  ↓
🛡️ 阿帕奇守护者（Web 服务器）收到订单
  ↓
☕ 黑水甲瓦法师："启动整个送货任务！"（启动新的 CGI 程序进程）
  ↓
☕ 进程 = 整个送货的任务
  ↓
☕ 需要做过这一单子的运输团队
  ↓
☕ 运输团队需要记录路径（任务复杂）
  ↓
☕ 去到每个仓库（加载整个脚本文件）
  ↓
☕ 每个仓库的大门都需要大开（整个文件都要被加载）
  ↓
☕ 从材料的查找开始，一个个去找（脚本里的所有代码都要执行）
  ↓
☕ 然后再制作（处理订单）
  ↓
☕ 完成，整个送货任务结束，进程结束
  ↓
下次订单又要重新启动整个送货任务，重新开仓库，重新找材料
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d51acdcc50c4d8585fa010b359e4300~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z-p5biI5YKF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768038764&amp;x-signature=zyGkY57GPqc%2F0p0OF69n1vZSAFw%3D" alt="image.png" loading="lazy"/></p>
<p><strong>关键特点</strong>：</p>
<ul>
<li><strong>进程 = 整个送货的任务</strong>：不是车马，而是整个送货的任务</li>
<li><strong>需要做过这一单子的运输团队</strong>：每次都要重新组织运输团队</li>
<li><strong>运输团队需要记录路径</strong>：任务复杂，需要运输团队记住路径</li>
<li><strong>没有固定的备货流程</strong>：没有路由系统，每个脚本都是独立的</li>
<li><strong>每次都要重新开始</strong>：每次请求都要重新启动进程（整个送货的任务），重新加载文件</li>
<li><strong>整个文件都要被加载</strong>：可能一个文件里面只跑一个函数，但还是要请求整个文件</li>
<li><strong>同样的流程没有被记录和筛检</strong>：没有路由系统，没有固定的流程</li>
<li><strong>所以等于每次都是新的</strong>：每次请求都是独立的，没有复用</li>
</ul>
<p><strong>Servlet 是什么？</strong></p>
<p>☕ 黑水甲瓦法师："Servlet 是我的代码仓库，专门用来做 CGI 这样的物流过程。它比 CGI 更完整，有生命周期管理，可以复用，但每次请求还是要重新处理整个送货任务。"</p>
<p><strong>Servlet = 代码仓库，专门用来做 CGI 这样的物流过程</strong>：</p>
<ul>
<li><strong>是 Java 的 Web 处理技术</strong>：黑水甲瓦法师用来处理 Web 请求的技术</li>
<li><strong>类似 CGI，但更完整</strong>：有生命周期管理、可以复用</li>
<li><strong>专门用来做 CGI 这样的物流过程</strong>：实现类似 CGI 的功能，但更高效</li>
<li><strong>每次请求还是要重新处理</strong>：虽然可以复用，但每次请求还是要重新处理整个送货任务</li>
<li><strong>进程 = 整个送货的任务</strong>：需要做过这一单子的运输团队，运输团队需要记录路径，任务复杂</li>
</ul>
<p><strong>Servlet 时代的前后端模式</strong>：</p>
<p>🐍 大蟒蛇法师："Servlet 时代（1990s）主要是传统模式，前后端不分离。那时候还没有灵狐法师（现代前端框架），所以黑水甲瓦法师直接返回 HTML 页面（JSP）。"</p>
<p>☕ 黑水甲瓦法师："是的，在 Servlet 时代，我主要是用 Servlet + JSP 的方式，直接返回 HTML 页面，前后端不分离。那时候还没有灵狐法师，所以我不需要与灵狐法师合作。但 Servlet 技术本身可以支持前后端分离（提供 API），只是那时候前端技术还没成熟，所以主要是传统模式。"</p>
<p><strong>关键理解</strong>：</p>
<ul>
<li><strong>Servlet 时代（1990s）</strong>：主要是传统模式，Servlet + JSP，直接返回 HTML，<strong>前后端不分离</strong></li>
<li><strong>Servlet 技术本身</strong>：可以支持前后端分离（提供 API），但那时候前端技术还没成熟</li>
<li><strong>现代 Servlet（Spring MVC，2010s+）</strong>：可以前后端分离，与灵狐法师合作，提供 REST API</li>
<li><strong>前后端分离的时代</strong>：2010s+，现代前端框架（React/Vue/Angular）兴起，后端提供 API</li>
</ul>
<p><strong>问题</strong>：</p>
<ul>
<li>❌ 每次订单都要重新启动整个送货任务，效率太低</li>
<li>❌ 需要做过这一单子的运输团队，运输团队需要记录路径，任务复杂</li>
<li>❌ 资源消耗大（每次都要启动新进程）</li>
<li>❌ 无法处理大量订单（高并发时性能瓶颈明显）</li>
</ul>
<hr/>
<h2 data-id="heading-6">📜 第二代：改进的物流系统（PHP、ASP.NET）</h2>
<h3 data-id="heading-7">时代背景</h3>
<p>🐍 大蟒蛇法师："后来有了改进的物流系统，比如 PHP 织布师的物流系统。进程（整个送货的任务）可以复用，但还是要重新准备。还有蓝盾法师的 ASP.NET 系统。"</p>
<p><strong>特点</strong>：</p>
<ul>
<li><strong>PHP</strong>：PHP 织布师的物流系统，进程（整个送货的任务）可以复用</li>
<li><strong>ASP.NET</strong>：蓝盾法师的物流系统，从彩色方块世界来的</li>
<li><strong>可以复用资源</strong>：但每次请求还是要重新初始化</li>
<li><strong>效率提升</strong>：比第一代快，但还不够</li>
</ul>
<h3 data-id="heading-8">PHP 的改进：进程（整个送货的任务）可以复用</h3>
<p>🧵 PHP 织布师："我织布师也不是吃素的！我的送货团队早就养在厂里，随时待命。订单一来，运输马车立刻出发，省时又省马草。虽然每次还得亲自装货、一个仓库一个仓库跑，但这可比临时招人强多了。"</p>
<p><strong>PHP 的工作方式（进程可以复用）</strong>：</p>
<pre><code class="hljs language-plain" lang="plain">第一次请求：
  🛡️ 阿帕奇守护者："启动 PHP 进程"
  ↓
  🧵 PHP 织布师："进程（整个送货的任务）准备好了"
  ↓
  🧵 进程 = 整个送货的任务
  ↓
  🧵 需要做过这一单子的运输团队
  ↓
  🧵 运输团队需要记录路径（任务复杂）
  ↓
  🧵 处理订单（一个个仓库去开）
  ↓
  🧵 进程保留（整个送货的任务还在，运输团队没有遣散）

第二次请求：
  🛡️ 阿帕奇守护者："复用 PHP 进程"
  ↓
  🧵 PHP 织布师："进程（整个送货的任务）还在，但我需要重新装货..."
  ↓
  🧵 重新初始化 PHP 环境（重新装货）
  ↓
  🧵 需要做过这一单子的运输团队
  ↓
  🧵 运输团队需要记录路径（任务复杂）
  ↓
  🧵 处理订单（还是要一个个仓库去开）
  ↓
  🧵 进程保留（整个送货的任务还在，运输团队没有遣散）
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dddb27d751cd4b949d9e13b227b5a582~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z-p5biI5YKF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768038764&amp;x-signature=EkyDsfJYDiSa5Iou%2F3fpSZFLBnM%3D" alt="image.png" loading="lazy"/></p>
<p><strong>关键理解</strong>：</p>
<ul>
<li><strong>进程 = 整个送货的任务</strong>：不是车马，而是整个送货的任务</li>
<li><strong>进程（整个送货的任务）一直在</strong>：PHP 进程可以保留，不需要每次都重新启动</li>
<li><strong>同样的运输团队，并没有遣散，随时待命</strong>：进程可以复用，随时待命</li>
<li><strong>需要做过这一单子的运输团队</strong>：每次请求还是要重新组织运输团队</li>
<li><strong>运输团队需要记录路径</strong>：任务复杂，需要运输团队记住路径</li>
<li><strong>执行一样的运输任务，就会识路</strong>：进程可以复用，可能有一些缓存或优化</li>
<li><strong>但还是要一个个仓库去开</strong>：每次请求还是要重新加载和执行 PHP 脚本文件</li>
</ul>
<p><strong>与 CGI 的对比</strong>：</p>
<p><strong>CGI（第一代）</strong>：</p>
<pre><code class="hljs language-plain" lang="plain">每次请求：
  启动新进程（整个送货的任务） → 处理订单 → 进程结束
  需要做过这一单子的运输团队，运输团队需要记录路径，任务复杂
  整个送货任务用完就没了，运输团队遣散了
</code></pre>
<p><strong>PHP（第二代）</strong>：</p>
<pre><code class="hljs language-plain" lang="plain">每次请求：
  复用进程（整个送货的任务） → 处理订单 → 进程保留
  需要做过这一单子的运输团队，运输团队需要记录路径，任务复杂
  整个送货任务一直在，运输团队没有遣散，随时待命
</code></pre>
<p><strong>改进</strong>：</p>
<ul>
<li>✅ 进程（整个送货的任务）可以复用，不需要每次都重新启动</li>
<li>✅ 同样的运输团队，并没有遣散，随时待命</li>
<li>✅ 效率比第一代高</li>
<li>⚠️ 但每次请求还是要重新初始化（重新装货）</li>
<li>⚠️ 但还是要一个个仓库去开（重新加载和执行脚本文件）</li>
<li>⚠️ 但还是要需要做过这一单子的运输团队，运输团队需要记录路径，任务复杂</li>
</ul>
<p>🐍 大蟒蛇法师："所以说，从第一代到第二代，物流团队从‘外包临工’进化成了‘自家雇员’，虽然搬货流程还不够自动化，但起码省去了每次重启团队的烦恼。"</p>
<h3 data-id="heading-9">🔄 第一代 vs 第二代：关键差异对比</h3>
<p>🐍 大蟒蛇法师："虽然第一代和第二代都是传统模式，但它们有一个关键差异：<strong>进程是否可以复用</strong>。让我用一个对照表来说明。"</p>








































<table><thead><tr><th>特性</th><th>第一代（CGI/Servlet）</th><th>第二代（PHP/ASP.NET）</th></tr></thead><tbody><tr><td><strong>进程复用</strong></td><td>❌ 每次请求都重新启动进程</td><td>✅ 进程可以复用，保留在内存中</td></tr><tr><td><strong>运输团队</strong></td><td>每次都要重新组织，用完就遣散</td><td>运输团队不遣散，随时待命</td></tr><tr><td><strong>启动成本</strong></td><td>高（每次都要启动新进程）</td><td>低（复用已有进程）</td></tr><tr><td><strong>资源消耗</strong></td><td>按需消耗，但启动成本高</td><td>持续占用，但响应更快</td></tr><tr><td><strong>效率</strong></td><td>低（每次都要重新开始）</td><td>较高（进程复用带来效率提升）</td></tr><tr><td><strong>适用场景</strong></td><td>订单很少的场景</td><td>订单频繁的场景</td></tr></tbody></table>
<p><strong>核心差异</strong>：</p>
<ul>
<li><strong>第一代</strong>：每次订单都要重新启动整个送货任务，进程用完就结束，运输团队遣散</li>
<li><strong>第二代</strong>：进程（整个送货的任务）可以复用，运输团队不遣散，随时待命，但每次请求还是要重新初始化</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/796571d6e9504739a7705dde5f7c1c3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z-p5biI5YKF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768038764&amp;x-signature=o5cceDLNSun54zjQF0Q4NzUW3m4%3D" alt="image.png" loading="lazy"/></p>
<p><strong>第二代时代的前后端模式</strong>：</p>
<p>🐍 大蟒蛇法师："第二代时代（2000s）主要是传统模式，前后端不分离。那时候还没有灵狐法师（现代前端框架），所以 PHP 织布师和蓝盾法师直接返回 HTML 页面。"</p>
<p>🧵 PHP 织布师："是的，在 PHP 时代（2000s），我主要是直接返回 HTML 页面，前后端不分离。那时候还没有灵狐法师，所以我不需要与灵狐法师合作。PHP 技术本身可以支持前后端分离（提供 API），但那时候前端技术还没成熟，所以主要是传统模式。"</p>
<p>🛡️ 蓝盾法师："虽然没人见过我的真身，但我的 ASP.NET 系统也是这样的。在 ASP.NET 时代（2000s），我主要是传统模式，直接返回 HTML，前后端不分离。那时候还没有灵狐法师，所以我不需要与灵狐法师合作。但 ASP.NET 技术本身可以支持前后端分离（提供 API），只是那时候前端技术还没成熟，所以主要是传统模式。"</p>
<p><strong>关键理解</strong>：</p>
<ul>
<li><strong>第二代时代（2000s）</strong>：主要是传统模式，PHP/ASP.NET 直接返回 HTML，<strong>前后端不分离</strong></li>
<li><strong>PHP/ASP.NET 技术本身</strong>：可以支持前后端分离（提供 API），但那时候前端技术还没成熟</li>
<li><strong>现代 PHP/ASP.NET（2010s+）</strong>：可以前后端分离，与灵狐法师合作，提供 REST API</li>
<li><strong>前后端分离的时代</strong>：2010s+，现代前端框架（React/Vue/Angular）兴起，后端提供 API</li>
</ul>
<hr/>
<h2 data-id="heading-10">📚 系列导航</h2>
<p><strong>系列名称</strong>：Web API 演进史：从 CGI 到 FastAPI<br/>
<em>（用物流系统比喻讲解 Web API 演进）</em></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">片段1：从重启马车到常驻运输队</a> ← 当前文章</li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">片段2：从随叫随到到规范配送</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">片段3：从物流法典到智能调度</a></li>
</ul>
<hr/>
<blockquote>
<p>📝 片段1 结束<br/>
🔄 下一片段预告：<br/>
运输团队终于不用手动写地址了！REST API 标准登场，为物流世界带来了"送货协议"与"资源派发规则"。<br/>
前后端开始真正分工，一场现代物流革命悄然发生……</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Wireshark TS | 超时重传时间不翻倍]]></title>    <link>https://juejin.cn/post/7589962224795762726</link>    <guid>https://juejin.cn/post/7589962224795762726</guid>    <pubDate>2026-01-02T06:38:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589962224795762726" data-draft-id="7589958976226557962" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Wireshark TS | 超时重传时间不翻倍"/> <meta itemprop="keywords" content="Wireshark,TCP/IP,网络协议"/> <meta itemprop="datePublished" content="2026-01-02T06:38:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="7ACE"/> <meta itemprop="url" content="https://juejin.cn/user/4033458369739741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Wireshark TS | 超时重传时间不翻倍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4033458369739741/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    7ACE
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-02T06:38:01.000Z" title="Fri Jan 02 2026 06:38:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>看图猜故障系列，来自于技术群讨论的又一个问题，数据包如下图，No.4900 原始数据包，No.4901 间隔208ms第一次重传，No.4903 间隔208ms第二次重传。</p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aecb2aafa0d84c0faf743008b4fbfaa0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgN0FDRQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767940681&amp;x-signature=2NG%2Fiu4ZxywZHPStU7GDT3bFzZE%3D" alt="" loading="lazy"/></p>
<p><strong>问题就是数据包第二次超时重传，间隔时间为什么没有翻倍。</strong></p>
<h2 data-id="heading-1">问题分析</h2>
<p>说实话，刚看到这个数据包文件截图时，记忆中竟然没有一丝相似的故障现象，略感纳闷。实际解读，也没有特别反常的迹象，只是在间隔 384s 后，客户端所发送的数据段由于得不到 ACK 确认，进行了重传的过程。当然由于第二次重传的超时时间未翻倍的原因，所以首先我并没有把这些重传全部定义为是超时重传。</p>
<p>但既然是一个数据段的重传，没有其他输入的信息，那么可以先简单模拟超时重传，对比看下。</p>
<pre><code class="hljs language-plain" lang="plain"># cat test.pkt 
0  socket(..., SOCK_STREAM, IPPROTO_TCP) = 3
+0 setsockopt(3, SOL_SOCKET, SO_REUSEADDR, [1], 4) = 0
+0 setsockopt(3, SOL_TCP, TCP_NODELAY, [1], 4) = 0
+0 bind(3, ..., ...) = 0
+0 listen(3, 1) = 0

+0 &lt; S 0:0(0) win 10000 &lt;mss 1000&gt;
+0 &gt; S. 0:0(0) ack 1 &lt;...&gt;
+0.01 &lt; . 1:1(0) ack 1 win 10000
+0 accept(3, ..., ...) = 4

+0.1 write(4,...,100) = 100

+0 `sleep 5`
#
</code></pre>
<p>执行脚本，同时通过 tcpdump 抓取数据包，现象如下。</p>
<p>可以看到发出数据段后，第一次重传间隔时间为213ms，而第二次重传间隔时间为436ms，也就是说都符合超时重传的现象，超时时间是正常翻倍了。</p>
<pre><code class="hljs language-plain" lang="plain"># packetdrill test.pkt
#


# tcpdump -i any -nn port 8080
tcpdump: data link type LINUX_SLL2
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on any, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144 bytes
22:25:38.983501 tun0  In  IP 192.0.2.1.34827 &gt; 192.168.209.238.8080: Flags [S], seq 0, win 10000, options [mss 1000], length 0
22:25:38.983536 tun0  Out IP 192.168.209.238.8080 &gt; 192.0.2.1.34827: Flags [S.], seq 3745491915, ack 1, win 64240, options [mss 1460], length 0
22:25:38.993637 tun0  In  IP 192.0.2.1.34827 &gt; 192.168.209.238.8080: Flags [.], ack 1, win 10000, length 0
22:25:39.093744 tun0  Out IP 192.168.209.238.8080 &gt; 192.0.2.1.34827: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
22:25:39.307178 tun0  Out IP 192.168.209.238.8080 &gt; 192.0.2.1.34827: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
22:25:39.743184 tun0  Out IP 192.168.209.238.8080 &gt; 192.0.2.1.34827: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
22:25:40.607187 tun0  Out IP 192.168.209.238.8080 &gt; 192.0.2.1.34827: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
22:25:42.335186 tun0  Out IP 192.168.209.238.8080 &gt; 192.0.2.1.34827: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
#
</code></pre>
<p>当然，由于第一个测试并没有支持 SACK，因此继续可以增加尝试测试。</p>
<pre><code class="hljs language-plain" lang="plain"># cat test.pkt 
0  socket(..., SOCK_STREAM, IPPROTO_TCP) = 3
+0 setsockopt(3, SOL_SOCKET, SO_REUSEADDR, [1], 4) = 0
+0 setsockopt(3, SOL_TCP, TCP_NODELAY, [1], 4) = 0
+0 bind(3, ..., ...) = 0
+0 listen(3, 1) = 0

+0 &lt; S 0:0(0) win 10000 &lt;mss 1000,nop,nop,sackOK&gt;
+0 &gt; S. 0:0(0) ack 1 &lt;...&gt;
+0.01 &lt; . 1:1(0) ack 1 win 10000
+0 accept(3, ..., ...) = 4

+0.1 write(4,...,100) = 100

+0 `sleep 5`
#
</code></pre>
<p>执行脚本，同时通过 tcpdump 抓取数据包，现象如下。</p>
<p>可以看到发出数据段后，第一次重传间隔时间为213ms，而第二次重传间隔时间为216ms，和问题截图一模一样的现象，第二次重传的超时时间并未翻倍。</p>
<pre><code class="hljs language-plain" lang="plain"># packetdrill test.pkt
#


# tcpdump -i any -nn port 8080
tcpdump: data link type LINUX_SLL2
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on any, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144 bytes
22:35:37.983481 tun0  In  IP 192.0.2.1.54829 &gt; 192.168.44.251.8080: Flags [S], seq 0, win 10000, options [mss 1000,nop,nop,sackOK], length 0
22:35:37.983508 tun0  Out IP 192.168.44.251.8080 &gt; 192.0.2.1.54829: Flags [S.], seq 2010255923, ack 1, win 64240, options [mss 1460,nop,nop,sackOK], length 0
22:35:37.993598 tun0  In  IP 192.0.2.1.54829 &gt; 192.168.44.251.8080: Flags [.], ack 1, win 10000, length 0
22:35:38.093722 tun0  Out IP 192.168.44.251.8080 &gt; 192.0.2.1.54829: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
22:35:38.307185 tun0  Out IP 192.168.44.251.8080 &gt; 192.0.2.1.54829: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
22:35:38.523213 tun0  Out IP 192.168.44.251.8080 &gt; 192.0.2.1.54829: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
22:35:38.975187 tun0  Out IP 192.168.44.251.8080 &gt; 192.0.2.1.54829: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
22:35:39.839188 tun0  Out IP 192.168.44.251.8080 &gt; 192.0.2.1.54829: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
22:35:41.567190 tun0  Out IP 192.168.44.251.8080 &gt; 192.0.2.1.54829: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
#
</code></pre>
<p>通过两次实验对比，可知仅仅是增加了 SACK 的支持，就产生了不一样的结果，同时结合数据包的重传时间，可以判断出第一次重传并不是普通的超时重传，而在它发出之后，看到的第二次重传，才是真正的第一次超时重传，之后的也才是 RTO 不断翻倍后的超时重传过程。</p>
<p>那么第一次重传是什么？<strong>在 linux 系统中，它实际是一个 TLP 数据包，在SACK开启下，TLP 会重传强制传输还没有收到 ACK 确认的报文里面的最后一个报文或者未发送的新报文。</strong> 而在上面的测试以及问题截图场景中，也比较特殊，因为只发送了一个报文，所以第一次重传也就是发送了 TLP 定义中的最后一个报文，乍看起来，确实像是在进行超时重传。</p>
<h2 data-id="heading-2">TLP 介绍</h2>
<p>Tail Loss Probe (TLP)是一个发送端算法，主要目的是使用快速重传取代RTO超时重传来处理尾包丢失场景。如果TCP尾包丢失，如果依靠RTO超时进行重传会带来比较大的延迟，进而影响用户体验。</p>
<p>那么如果一个TCP连接没有在一段时间内没有收到ACK报文，TLP会强制传输还没有收到ACK确认的报文里面的最后一个报文或者未发送的新报文(传输的这个报文就叫做loss probe)。</p>
<p><strong>tcp_early_retrans - INTEGER</strong></p>
<p>Enable Early Retransmit (ER), per RFC 5827. ER lowers the threshold for triggering fast retransmit when the amount of outstanding data is small and when no previously unsent data can be transmitted (such that limited transmit could be used). Also controls the use of Tail loss probe (TLP) that converts RTOs occurring due to tail losses into fast recovery (draft-dukkipati-tcpm-tcp-loss-probe-01).</p>
<p>Possible values:</p>
<p>0 disables ER</p>
<p>1 enables ER</p>
<p>2 enables ER but delays fast recovery and fast retransmit by a fourth of RTT. This mitigates connection falsely recovers when network has a small degree of reordering (less than 3 packets).</p>
<p>3 enables delayed ER and TLP.</p>
<p>4 enables TLP only.</p>
<p>Default: 3</p>
<h2 data-id="heading-3">证明实验</h2>
<p>在 linux 中 <strong>tcp_early_retrans</strong> 参数默认值为 3，也就是同时启用了 Delayed ER 和 TLP。</p>
<pre><code class="hljs language-plain" lang="plain"># sysctl -a|grep early_retrans
net.ipv4.tcp_early_retrans = 3
# 
</code></pre>
<p>如果想证明确实和 TLP 相关，可以从三个方面测试下：</p>
<ol>
<li>关闭 SACK；（上述实验已测试）</li>
<li>net.ipv4.tcp_early_retrans 值修改为 4，仅开启 TLP；</li>
<li>net.ipv4.tcp_early_retrans 值修改为 0，关闭 ER 以及 TLP。</li>
</ol>
<p>首先仅开启 TLP 的情况，继续测试在 SACK 开启的脚本。</p>
<pre><code class="hljs language-plain" lang="plain"># sysctl -q net.ipv4.tcp_early_retrans=4
# sysctl -a|grep early_retrans
net.ipv4.tcp_early_retrans = 4
# 
</code></pre>
<p>执行脚本，同时通过 tcpdump 抓取数据包，现象如下，可以看到与默认值 3 的测试结果一致，说明了和 ER 重传无关，与 TLP 可能有关（严谨的说法，因为也有可能是某某重传引起）。</p>
<pre><code class="hljs language-plain" lang="plain"># tcpdump -i any -nn port 8080
tcpdump: data link type LINUX_SLL2
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on any, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144 bytes
10:12:36.563494 tun0  In  IP 192.0.2.1.50647 &gt; 192.168.165.47.8080: Flags [S], seq 0, win 10000, options [mss 1000,nop,nop,sackOK], length 0
10:12:36.563526 tun0  Out IP 192.168.165.47.8080 &gt; 192.0.2.1.50647: Flags [S.], seq 3170095082, ack 1, win 64240, options [mss 1460,nop,nop,sackOK], length 0
10:12:36.573627 tun0  In  IP 192.0.2.1.50647 &gt; 192.168.165.47.8080: Flags [.], ack 1, win 10000, length 0
10:12:36.673761 tun0  Out IP 192.168.165.47.8080 &gt; 192.0.2.1.50647: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
10:12:36.887178 tun0  Out IP 192.168.165.47.8080 &gt; 192.0.2.1.50647: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
10:12:37.103192 tun0  Out IP 192.168.165.47.8080 &gt; 192.0.2.1.50647: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
10:12:37.535174 tun0  Out IP 192.168.165.47.8080 &gt; 192.0.2.1.50647: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
10:12:38.399184 tun0  Out IP 192.168.165.47.8080 &gt; 192.0.2.1.50647: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
10:12:40.127180 tun0  Out IP 192.168.165.47.8080 &gt; 192.0.2.1.50647: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
#
</code></pre>
<p>继续关闭 TLP 的情况，仍然是测试 SACK 开启的脚本。</p>
<pre><code class="hljs language-plain" lang="plain"># sysctl -q net.ipv4.tcp_early_retrans=0
# sysctl -a|grep early_retrans
net.ipv4.tcp_early_retrans = 0
# 
</code></pre>
<p>执行脚本，同时通过 tcpdump 抓取数据包，现象如下，可以看到与关闭 SACK 的首次测试结果一致，标准的超时重传现象。对于关闭 TLP 和开启 TLP 的两次实验结果，可得知第一次重传数据包确实是 TLP 报文。</p>
<pre><code class="hljs language-plain" lang="plain"># tcpdump -i any -nn port 8080
tcpdump: data link type LINUX_SLL2
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on any, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144 bytes
10:17:24.423493 tun0  In  IP 192.0.2.1.35821 &gt; 192.168.117.180.8080: Flags [S], seq 0, win 10000, options [mss 1000,nop,nop,sackOK], length 0
10:17:24.423527 tun0  Out IP 192.168.117.180.8080 &gt; 192.0.2.1.35821: Flags [S.], seq 1548070828, ack 1, win 64240, options [mss 1460,nop,nop,sackOK], length 0
10:17:24.433632 tun0  In  IP 192.0.2.1.35821 &gt; 192.168.117.180.8080: Flags [.], ack 1, win 10000, length 0
10:17:24.533759 tun0  Out IP 192.168.117.180.8080 &gt; 192.0.2.1.35821: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
10:17:24.751193 tun0  Out IP 192.168.117.180.8080 &gt; 192.0.2.1.35821: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
10:17:25.183189 tun0  Out IP 192.168.117.180.8080 &gt; 192.0.2.1.35821: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
10:17:26.047181 tun0  Out IP 192.168.117.180.8080 &gt; 192.0.2.1.35821: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
10:17:27.775172 tun0  Out IP 192.168.117.180.8080 &gt; 192.0.2.1.35821: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
#
</code></pre>
<h2 data-id="heading-4">问题总结</h2>
<p>实际上对于重传触发出来的原因，或者说重传的归类，远远不止众所周知的超时重传、快速重传这两种，后续再慢慢展开分享吧。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>