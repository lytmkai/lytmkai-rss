<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Flink源码阅读：Netty通信]]></title>    <link>https://juejin.cn/post/7593164154631815177</link>    <guid>https://juejin.cn/post/7593164154631815177</guid>    <pubDate>2026-01-09T12:13:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593164154631815177" data-draft-id="7593164154631798793" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flink源码阅读：Netty通信"/> <meta itemprop="keywords" content="Flink,大数据"/> <meta itemprop="datePublished" content="2026-01-09T12:13:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="面向Google编程"/> <meta itemprop="url" content="https://juejin.cn/user/1063982986695374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flink源码阅读：Netty通信
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1063982986695374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    面向Google编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T12:13:27.000Z" title="Fri Jan 09 2026 12:13:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前文中我们了解了 Flink 的数据交互过程，上游的 Task 将数据写入到 ResultSubpartition 的 buffers 队列中。下游的 Task 通过 LocalInputChannel 和 RemoteInputChannel 消费上游的数据。</p>
<p>LocalInputChannel 是上下游的 Task 部署在同一个 TaskManager 时使用的，在本地即可完成数据交换，无需网络通信。当上下游的 Task 部署在不同的 TaskManager 时，就需要用到 RemoteInputChannel，Flink 利用 Netty 来进行数据交互。本文我们来一起梳理一下 Netty 相关的源码。</p>
<h3 data-id="heading-0">初始化</h3>
<p>我们先来看 NettyServer 和 NettyClient 的初始化过程。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ba4706fbb604cc5884638aaad02c95b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2i5ZCRR29vZ2xl57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768565606&amp;x-signature=ro8kY7ZVGC%2BQRjha4Mu06IgMWMI%3D" alt="NettyInit" loading="lazy"/></p>
<p>Netty 的初始化阶段是在 TaskManager 启动的过程中执行的。在 <code>TaskManagerServices.fromConfiguration</code> 方法中，会创建并启动 ShuffleEnvironment。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> TaskManagerServices <span class="hljs-title function_ invoke__">fromConfiguration</span>(
        TaskManagerServicesConfiguration taskManagerServicesConfiguration,
        PermanentBlobService permanentBlobService,
        MetricGroup taskManagerMetricGroup,
        ExecutorService ioExecutor,
        ScheduledExecutor scheduledExecutor,
        FatalErrorHandler fatalErrorHandler,
        WorkingDirectory workingDirectory)
        throws <span class="hljs-built_in">Exception</span> {
    ...

    <span class="hljs-keyword">final</span> ShuffleEnvironment<span class="hljs-meta">&lt;?</span>, <span class="hljs-meta">?&gt;</span> shuffleEnvironment =
            <span class="hljs-title function_ invoke__">createShuffleEnvironment</span>(
                    taskManagerServicesConfiguration,
                    taskEventDispatcher,
                    taskManagerMetricGroup,
                    ioExecutor,
                    scheduledExecutor);
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> listeningDataPort = shuffleEnvironment.<span class="hljs-title function_ invoke__">start</span>();
    ...
}
</code></pre>
<p>我们顺着调用链路可以一直找到 <code>NettyShuffleServiceFactory.createNettyShuffleEnvironment</code> 方法，这个方法中创建了 NettyConnectionManager，在 NettyConnectionManager 中有几个很重要的对象。</p>
<pre><code class="hljs language-ini" lang="ini">public NettyConnectionManager(
        NettyBufferPool bufferPool,
        ResultPartitionProvider partitionProvider,
        TaskEventPublisher taskEventPublisher,
        NettyConfig nettyConfig,
        boolean connectionReuseEnabled) {

    <span class="hljs-attr">this.server</span> = new NettyServer(nettyConfig)<span class="hljs-comment">;</span>
    <span class="hljs-attr">this.client</span> = new NettyClient(nettyConfig)<span class="hljs-comment">;</span>
    <span class="hljs-attr">this.bufferPool</span> = checkNotNull(bufferPool)<span class="hljs-comment">;</span>

    <span class="hljs-attr">this.partitionRequestClientFactory</span> =
            new PartitionRequestClientFactory(
                    client, nettyConfig.getNetworkRetries(), connectionReuseEnabled)<span class="hljs-comment">;</span>

    <span class="hljs-attr">this.nettyProtocol</span> =
            new NettyProtocol(
                    checkNotNull(partitionProvider), checkNotNull(taskEventPublisher))<span class="hljs-comment">;</span>
}
</code></pre>
<p>server 和 client 不需要多介绍，就是 Netty 的服务端和客户端。bufferPool 是缓冲池，用于存储要传输的数据。nettyProtocol 提供了 NettyClient 和 NettyServer 引导启动注册的 Channel Handler。</p>
<p>后面就是创建 NettyShuffleEnvironment 及其需要的对象了。在创建完成后，会调用它的 start 方法启动。这个启动方法就是调用了 <code>connectionManager.start</code>，在 NettyConnectionManager 中，就是初始化客户端和服务端。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">start</span>() throws IOException</span> {
    client.<span class="hljs-keyword">init</span>(nettyProtocol, bufferPool);

    <span class="hljs-keyword">return</span> server.<span class="hljs-keyword">init</span>(nettyProtocol, bufferPool);
}
</code></pre>
<h4 data-id="heading-1">client 初始化</h4>
<p>client 的初始化过程是先创建并初始化 Bootstrap。</p>
<pre><code class="hljs language-scss" lang="scss">private void <span class="hljs-built_in">initEpollBootstrap</span>() {
    <span class="hljs-comment">// Add the server port number to the name in order to distinguish</span>
    <span class="hljs-comment">// multiple clients running on the same host.</span>
    String name =
            NettyConfig<span class="hljs-selector-class">.CLIENT_THREAD_GROUP_NAME</span> + " (" + config.getServerPortRange() + ")";

    EpollEventLoopGroup epollGroup =
            new <span class="hljs-built_in">EpollEventLoopGroup</span>(
                    config.getClientNumThreads(), NettyServer<span class="hljs-selector-class">.getNamedThreadFactory</span>(name));
    bootstrap<span class="hljs-selector-class">.group</span>(epollGroup)<span class="hljs-selector-class">.channel</span>(EpollSocketChannel.class);

    config<span class="hljs-selector-class">.getTcpKeepIdleInSeconds</span>()
            <span class="hljs-selector-class">.ifPresent</span>(idle -&gt; bootstrap.option(EpollChannelOption.TCP_KEEPIDLE, idle));
    config<span class="hljs-selector-class">.getTcpKeepInternalInSeconds</span>()
            <span class="hljs-selector-class">.ifPresent</span>(
                    interval -&gt; bootstrap.option(EpollChannelOption.TCP_KEEPINTVL, interval));
    config<span class="hljs-selector-class">.getTcpKeepCount</span>()
            <span class="hljs-selector-class">.ifPresent</span>(count -&gt; bootstrap.option(EpollChannelOption.TCP_KEEPCNT, count));
}
</code></pre>
<p>初始化过程重要设置 EventLoopGroup 和 channel，可以用 epoll 的话就用 epoll，否则就用 nio。设置好这些后就是设置了一些通道参数（连接超时时间、Bufffer 池等）。</p>
<p>到这里 client 的初始化其实并没有结束，还需要设置 Handler 流水线，这些工作是在 Task 启动时执行了。</p>
<h4 data-id="heading-2">server 初始化</h4>
<p>server 的初始化过程是先创建并初始化了 ServerBootstrap。之后同样也是设置 EventLoopGroup 和 channel，以及通道相关的各种参数。</p>
<p>设置好之后，会添加 ChannelHandler 流水线，这里的 ChannelHandler 流水线就是我们前面创建的 NettyProtocol 提供的。</p>
<pre><code class="hljs language-ini" lang="ini">public ChannelHandler<span class="hljs-section">[]</span> getServerChannelHandlers() {
    PartitionRequestQueue <span class="hljs-attr">queueOfPartitionQueues</span> = new PartitionRequestQueue()<span class="hljs-comment">;</span>
    PartitionRequestServerHandler <span class="hljs-attr">serverHandler</span> =
            new PartitionRequestServerHandler(
                    partitionProvider, taskEventPublisher, queueOfPartitionQueues)<span class="hljs-comment">;</span>

    return new ChannelHandler<span class="hljs-section">[]</span> {
        messageEncoder,
        new NettyMessage.NettyMessageDecoder(),
        serverHandler,
        queueOfPartitionQueues
    }<span class="hljs-comment">;</span>
}
</code></pre>
<p>流水线上包含了消息编码器、解码器、PartitionRequestServerHandler 请求服务端处理器和 PartitionRequestQueue 分区请求队列。</p>
<p>这些都设置好之后，就开始启动 NettyServer 服务了。</p>
<pre><code class="hljs language-scss" lang="scss">Iterator&lt;Integer&gt; portsIterator = config<span class="hljs-selector-class">.getServerPortRange</span>()<span class="hljs-selector-class">.getPortsIterator</span>();
while (portsIterator.hasNext() &amp;&amp; bindFuture == null) {
    Integer port = portsIterator<span class="hljs-selector-class">.next</span>();
    LOG<span class="hljs-selector-class">.debug</span>("Trying to bind Netty server to port: {}", port);

    bootstrap<span class="hljs-selector-class">.localAddress</span>(config.getServerAddress(), port);
    try {
        bindFuture = bootstrap<span class="hljs-selector-class">.bind</span>()<span class="hljs-selector-class">.syncUninterruptibly</span>();
    } catch (Exception e) {
        <span class="hljs-comment">// syncUninterruptibly() throws checked exceptions via Unsafe</span>
        <span class="hljs-comment">// continue if the exception is due to the port being in use, fail early</span>
        <span class="hljs-comment">// otherwise</span>
        if (isBindFailure(e)) {
            LOG<span class="hljs-selector-class">.debug</span>("Failed to bind Netty server", e);
        } else {
            throw e;
        }
    }
}

if (bindFuture == null) {
    throw new <span class="hljs-built_in">BindException</span>(
            "Could not start rest endpoint on any port in port range "
                    + config.getServerPortRange());
}

localAddress = (InetSocketAddress) bindFuture<span class="hljs-selector-class">.channel</span>()<span class="hljs-selector-class">.localAddress</span>();
</code></pre>
<h3 data-id="heading-3">客户端请求远端子分区</h3>
<p>服务端和客户端初始化之后，在 Task 运行时，会先完成 Client 的 ChannelHandler 的配置，然后请求 Netty 远端服务。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b99d38c65200487f8f5f1d7e05cc2b36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2i5ZCRR29vZ2xl57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768565606&amp;x-signature=7ig7BNFyUGozffh2yuryKQkj%2FHo%3D" alt="NettyRequestPartition" loading="lazy"/></p>
<p>我们来看具体过程，在 Task 初始化时，会调用 <code>StreamTask.invoke</code> 方法，其内部会调用 <code>StreamTask.restoreStateAndGate</code> 方法，这里会便利 Task 的所有 InputGate，然后调用 requestPartitions。在 InputGate 的 requestPartitions 逻辑中，又便利所有的 InputChannel，调用 requestSubpartitions。</p>
<pre><code class="hljs language-scss" lang="scss">for (InputGate inputGate : inputGates) {
    recoveredFutures<span class="hljs-selector-class">.add</span>(inputGate.getStateConsumedFuture());

    inputGate
            <span class="hljs-selector-class">.getStateConsumedFuture</span>()
            <span class="hljs-selector-class">.thenRun</span>(
                    () -&gt;
                            mainMailboxExecutor<span class="hljs-selector-class">.execute</span>(
                                    inputGate::requestPartitions,
                                    "Input gate request partitions"));
}


private void <span class="hljs-built_in">internalRequestPartitions</span>() {
    for (InputChannel inputChannel : inputChannels()) {
        try {
            inputChannel<span class="hljs-selector-class">.requestSubpartitions</span>();
        } catch (Throwable t) {
            inputChannel<span class="hljs-selector-class">.setError</span>(t);
            return;
        }
    }
}
</code></pre>
<p>我们来看 <code>RemoteInputChannel.requestSubpartitions</code> 的逻辑。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">requestSubpartitions</span>() throws IOException, InterruptedException</span> {
    <span class="hljs-keyword">if</span> (partitionRequestClient == <span class="hljs-literal">null</span>) {
        LOG.debug(
                <span class="hljs-string">"{}: Requesting REMOTE subpartitions {} of partition {}. {}"</span>,
                <span class="hljs-keyword">this</span>,
                consumedSubpartitionIndexSet,
                partitionId,
                channelStatePersister);
        <span class="hljs-comment">// Create a client and request the partition</span>
        <span class="hljs-keyword">try</span> {
            partitionRequestClient =
                    connectionManager.createPartitionRequestClient(connectionId);
        } <span class="hljs-keyword">catch</span> (IOException e) {
            <span class="hljs-comment">// IOExceptions indicate that we could not open a connection to the remote</span>
            <span class="hljs-comment">// TaskExecutor</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> PartitionConnectionException(partitionId, e);
        }

        partitionRequestClient.requestSubpartition(
                partitionId, consumedSubpartitionIndexSet, <span class="hljs-keyword">this</span>, <span class="hljs-number">0</span>);
    }
}
</code></pre>
<p>这里主要有两个步骤，先是创建 partitionRequestClient，然后调用 requestSubpartition。</p>
<h4 data-id="heading-4">创建请求客户端</h4>
<p>PartitionRequestClient 是在 <code>PartitionRequestClientFactory.connect</code> 中创建的。先调用了 <code>NettyClient.connect</code>，同步等待客户端连接到服务端，这个过程中会进行 ChannelHandler 配置，也就是我们在初始化的过程中介绍的，NettyClient 没有完成的步骤。</p>
<pre><code class="hljs language-scss" lang="scss">public ChannelHandler<span class="hljs-selector-attr">[]</span> <span class="hljs-built_in">getClientChannelHandlers</span>() {
    NetworkClientHandler networkClientHandler = new <span class="hljs-built_in">CreditBasedPartitionRequestClientHandler</span>();

    return new ChannelHandler<span class="hljs-selector-attr">[]</span> {
        messageEncoder,
        new <span class="hljs-built_in">NettyMessageClientDecoderDelegate</span>(networkClientHandler),
        networkClientHandler
    };
}
</code></pre>
<p>Handler 包括了消息编码器、解码器和 CreditBasedPartitionRequestClientHandler 这个基于 Credit 的分区请求客户端处理器。Handler 配置好之后会利用 bootstrap 连接到服务端。</p>
<p>在获取到 Channel 和 NetworkClientHandler 之后，就直接创建了 NettyPartitionRequestClient。</p>
<h4 data-id="heading-5">请求子分区数据</h4>
<p>让我们再回到 RemoteInputChannel 的 requestSubpartitions 方法中，现在我们创建好了 NettyPartitionRequestClient，接下来就是调用它的 requestSubpartition 方法来发起请求。</p>
<p>这里逻辑也比较简单：</p>
<ol>
<li>向 NetworkClientHandler 注册当前 RemoteInputChannel。</li>
<li>构造请求对象 PartitionRequest，这里包含了分区 ID、子分区索引、inputChannel ID 以及初识的 Credit。</li>
<li>调用 <code>tcpChannel.writeAndFlush</code> 发起请求，并添加请求失败的监听。</li>
<li>如果请求失败，移除当前 inputChannel。</li>
</ol>
<h3 data-id="heading-6">服务端响应</h3>
<p>现在数据到了服务端，我们来看服务端处理的具体过程。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/339a67c8d7c64865bc109c665e60c60c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2i5ZCRR29vZ2xl57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768565606&amp;x-signature=xpUm9gskdJn323LGxtvTmcAThSc%3D" alt="NettyServerHandler" loading="lazy"/></p>
<p>在 NettyServer 初始化的过程中，我们添加了两个重要的 Handler，分别是 PartitionRequestServerHandler 和 PartitionRequestQueue。服务端响应数据的过程就是这两个 Handler 在发挥作用。</p>
<p>PartitionRequestServerHandler 负责处理 Client 端通过 PartitionRequestClient 发送的请求，处理过程是先创建 CreditBasedSequenceNumberingViewReader 类型的 reader，然后将它放入 PartitionRequestQueue 维护的 reader 队列中。PartitionRequestQueue 会监听 Netty Channel 的可写入状态，当 Netty Channel 可写入时，会消费数据并写入网络。</p>
<p>下面我们来看具体的源码。</p>
<p>服务端的响应入口在 <code>PartitionRequestServerHandler.channelRead0</code> 方法，这里在处理 PartitionRequest 请求时，先是创建 CreditBasedSequenceNumberingViewReader，然后调用 requestSubpartitionViewOrRegisterListener。</p>
<p>requestSubpartitionViewOrRegisterListener 的逻辑是创建 ResultSubpartitionView，并提醒 PartitionRequestQueue 有数据可用。</p>
<pre><code class="hljs language-ini" lang="ini">Optional&lt;ResultSubpartitionView&gt; <span class="hljs-attr">subpartitionViewOptional</span> =
        partitionProvider.createSubpartitionViewOrRegisterListener(
                resultPartitionId,
                subpartitionIndexSet,
                this,
                partitionRequestListener)<span class="hljs-comment">;</span>
...

notifyDataAvailable(subpartitionView)<span class="hljs-comment">;</span>
</code></pre>
<p>ResultSubpartitionView 就是用来消费 ResultSubpartition 的数据。</p>
<p>notifyDataAvailable 内部调用了 notifyReaderNonEmpty，notifyReaderNonEmpty 又触发了 userEventTriggered，这里调用 enqueueAvailableReader 将 reader 放入到可用队列 availableReaders 中。</p>
<pre><code class="hljs language-scss" lang="scss">private void <span class="hljs-built_in">enqueueAvailableReader</span>(final NetworkSequenceViewReader reader) throws Exception {
    if (reader.isRegisteredAsAvailable()) {
        return;
    }

    ResultSubpartitionView<span class="hljs-selector-class">.AvailabilityWithBacklog</span> availabilityWithBacklog =
            reader<span class="hljs-selector-class">.getAvailabilityAndBacklog</span>();
    if (!availabilityWithBacklog.isAvailable()) {
        int backlog = availabilityWithBacklog<span class="hljs-selector-class">.getBacklog</span>();
        if (backlog &gt; <span class="hljs-number">0</span> &amp;&amp; reader.needAnnounceBacklog()) {
            <span class="hljs-built_in">announceBacklog</span>(reader, backlog);
        }
        return;
    }

    <span class="hljs-comment">// Queue an available reader for consumption. If the queue is empty,</span>
    <span class="hljs-comment">// we try trigger the actual write. Otherwise this will be handled by</span>
    <span class="hljs-comment">// the writeAndFlushNextMessageIfPossible calls.</span>
    boolean triggerWrite = availableReaders<span class="hljs-selector-class">.isEmpty</span>();
    <span class="hljs-built_in">registerAvailableReader</span>(reader);

    if (triggerWrite) {
        <span class="hljs-built_in">writeAndFlushNextMessageIfPossible</span>(ctx.channel());
    }
}
</code></pre>
<p>如果 reader 是队列中的第一个元素，会触发数据写入网络。</p>
<p>writeAndFlushNextMessageIfPossible 的处理步骤如下：</p>
<ol>
<li>取出可用 reader。</li>
<li>调用 <code>reader.getNextBuffer</code> 获取数据。</li>
<li>如果 reader 仍然可用，将其加回队列。</li>
<li>向下游写入数据并添加下次写入的监听。</li>
</ol>

<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> BufferAndAvailability <span class="hljs-title function_">getNextBuffer</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException {
    <span class="hljs-type">BufferAndBacklog</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> subpartitionView.getNextBuffer();
    <span class="hljs-keyword">if</span> (next != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">if</span> (next.buffer().isBuffer() &amp;&amp; --numCreditsAvailable &lt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"no credit available"</span>);
        }

        <span class="hljs-keyword">final</span> Buffer.<span class="hljs-type">DataType</span> <span class="hljs-variable">nextDataType</span> <span class="hljs-operator">=</span> getNextDataType(next);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferAndAvailability</span>(
                next.buffer(), nextDataType, next.buffersInBacklog(), next.getSequenceNumber());
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<p>在 getNextBuffer 方法中，会将 credit 值减 1，并判断是否小于 0。如果小于 0 会抛出异常，reader 是否可用也是根据 numCreditsAvailable 是否大于 0 来判断的。</p>
<h3 data-id="heading-7">客户端接收数据</h3>
<p>NettyClient 在消费数据时，同样也是以 ChannelHandler 作为入口。这里的入口方法是 <code>CreditBasedPartitionRequestClientHandler.channelRead</code> 。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e3e211ea7d445e8a040cfd2e5bac1dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2i5ZCRR29vZ2xl57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768565606&amp;x-signature=QzLjqwFQqFXMQxN4wlfezdFTli4%3D" alt="NettyClientHandler" loading="lazy"/></p>
<p>在 decodeMsg 方法中，先解码 msg，判断 InputChannel 是否可用，如果不可用，则取消当前 InputChannel 的订阅。如果可用，继续调用 decodeBufferOrEvent 进行处理。decodeBufferOrEvent 的核心逻辑是调用 <code>RemoteInputChannel.onBuffer</code> 方法，将数据加入到 receivedBuffers 队列。</p>
<p>如果 receivedBuffers 队列在此之前处于空闲状态，会调用 notifyChannelNonEmpty，将当前 RemoteInputChannel 加入到 inputChannelsWithData 队列中，同时还会唤醒 inputChannelsWithData 上的阻塞线程，让 inputGate 可以消费 RemoteInputChannel 的数据。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">private</span> boolean <span class="hljs-title">queueChannelUnsafe</span>(<span class="hljs-params">InputChannel channel, boolean priority</span>)</span> {
    assert Thread.holdsLock(inputChannelsWithData);
    <span class="hljs-keyword">if</span> (channelsWithEndOfPartitionEvents.<span class="hljs-keyword">get</span>(channel.getChannelIndex())) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    final boolean alreadyEnqueued =
            enqueuedInputChannelsWithData.<span class="hljs-keyword">get</span>(channel.getChannelIndex());
    <span class="hljs-keyword">if</span> (alreadyEnqueued
            &amp;&amp; (!priority || inputChannelsWithData.containsPriorityElement(channel))) {
        <span class="hljs-comment">// already notified / prioritized (double notification), ignore</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">// 当前 inputChannel 加入到 inputChannelsWithData</span>
    inputChannelsWithData.<span class="hljs-keyword">add</span>(channel, priority, alreadyEnqueued);
    <span class="hljs-keyword">if</span> (!alreadyEnqueued) {
        enqueuedInputChannelsWithData.<span class="hljs-keyword">set</span>(channel.getChannelIndex());
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}

<span class="hljs-comment">// 唤醒线程</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">notifyDataAvailable</span>()</span> {
    availabilityMonitor.notifyAll();
    toNotify = inputGate.availabilityHelper.getUnavailableToResetAvailable();
}
</code></pre>
<p>如果客户端有积压，还需要根据积压申请 Buffer 并更新 Credit 值。这里申请的 buffer 数量为积压数量+初识 Credit 值。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSenderBacklog</span><span class="hljs-params">(<span class="hljs-type">int</span> backlog)</span> <span class="hljs-keyword">throws</span> IOException {
    notifyBufferAvailable(bufferManager.requestFloatingBuffers(backlog + initialCredit));
}
</code></pre>
<p>如果 RemoteInputChannel 没有足够的 buffer，则会向 LocalBufferPool 申请新的 buffer，如果申请不到，会加一个监听，等 LocalBufferPool 有空闲时再触发申请 buffer。</p>
<pre><code class="hljs language-ini" lang="ini">private int tryRequestBuffers() {
    assert Thread.holdsLock(bufferQueue)<span class="hljs-comment">;</span>

    int <span class="hljs-attr">numRequestedBuffers</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
    while (bufferQueue.getAvailableBufferSize() &lt; numRequiredBuffers
            &amp;&amp; !isWaitingForFloatingBuffers) {
        BufferPool <span class="hljs-attr">bufferPool</span> = inputChannel.inputGate.getBufferPool()<span class="hljs-comment">;</span>
        Buffer <span class="hljs-attr">buffer</span> = bufferPool.requestBuffer()<span class="hljs-comment">;</span>
        if (buffer != null) {
            bufferQueue.addFloatingBuffer(buffer)<span class="hljs-comment">;</span>
            numRequestedBuffers++<span class="hljs-comment">;</span>
        } else if (bufferPool.addBufferListener(this)) {
            <span class="hljs-attr">isWaitingForFloatingBuffers</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
            break<span class="hljs-comment">;</span>
        }
    }
    return numRequestedBuffers<span class="hljs-comment">;</span>
}
</code></pre>
<p>当 RemoteInputChannel 申请到了需要的 buffer 之后，就会向 NettyServer 发送 AddCredit 消息，请求更新 Credit 值。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">notifyCreditAvailable</span>() throws IOException</span> {
    checkPartitionRequestQueueInitialized();

    partitionRequestClient.notifyCreditAvailable(<span class="hljs-keyword">this</span>);
}


<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">notifyCreditAvailable</span>(<span class="hljs-params">RemoteInputChannel inputChannel</span>)</span> {
    sendToChannel(<span class="hljs-keyword">new</span> AddCreditMessage(inputChannel));
}
</code></pre>
<p>NettyServer 收到请求后，会将对应的 Credit 值进行更新。</p>
<pre><code class="hljs language-ini" lang="ini">else if (<span class="hljs-attr">msgClazz</span> == AddCredit.class) {
    AddCredit <span class="hljs-attr">request</span> = (AddCredit) msg<span class="hljs-comment">;</span>

    outboundQueue.addCreditOrResumeConsumption(
            request.receiverId, reader -&gt; reader.addCredit(request.credit))<span class="hljs-comment">;</span>
}

void addCreditOrResumeConsumption(
        InputChannelID receiverId, Consumer&lt;NetworkSequenceViewReader&gt; operation)
        throws Exception {
    if (fatalError) {
        return<span class="hljs-comment">;</span>
    }

    NetworkSequenceViewReader <span class="hljs-attr">reader</span> = obtainReader(receiverId)<span class="hljs-comment">;</span>

    operation.accept(reader)<span class="hljs-comment">;</span>
    enqueueAvailableReader(reader)<span class="hljs-comment">;</span>
}


public void addCredit(int creditDeltas) {
    numCreditsAvailable += creditDeltas<span class="hljs-comment">;</span>
}
</code></pre>
<p>此外，Flink 还有两种场景会更新 Credit 值。</p>
<p>一种是 LocalBufferPool 回收空闲 buffer 时，会将 buffer 分配给申请者，分配之后会调用对应 InputChannel 的 notifyBufferAvailable 方法通知更新 Credit。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91654d63dada40089adc39ddeaa32f16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2i5ZCRR29vZ2xl57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768565606&amp;x-signature=%2B6Q5%2FPKgLnUQeBSJ7%2BBwQflI7Ik%3D" alt="LocalBufferPool" loading="lazy"/></p>
<p>另一种是 RemoteInputChannel 独占的 buffer 队列释放 buffer 时，会触发 Credit 更新。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c5cb9fddc0d4e18802107951125230b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2i5ZCRR29vZ2xl57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768565606&amp;x-signature=T4scDtDnWrMIvABCUiom8RV0bTQ%3D" alt="BufferManager" loading="lazy"/></p>
<h3 data-id="heading-8">反压</h3>
<p>通过前面的学习，我们其实已经理解了反压的机制了。当前 Flink 的反压就是通过 Credit 来实现反压的，如果下游数据处理速度慢，Credit 会被耗尽，上游也就不会继续处理和下发数据了。直到下游处理完成，有了空闲的 buffer，此时向上游反馈更新 Credit 值，上游就会继续处理数据。</p>
<h3 data-id="heading-9">总结</h3>
<p>最后我们总结一下，本文我们一起梳理了 Flink Netty 相关的源码。包括 NettyClient 和 NettyServer 的初始化，初始化过程中会创建一系列 ChannelHandler，之后利用这些Handler 处理数据，数据处理包括 Client 端的发送和接收消息，Server 端处理消息的过程。中间还穿插着 Credit 的处理。Flink 的反压逻辑就是依赖于 Credit 来实现的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基准测试：Akamai云上的NVIDIA RTX Pro 6000 Blackwell]]></title>    <link>https://juejin.cn/post/7593173569871806516</link>    <guid>https://juejin.cn/post/7593173569871806516</guid>    <pubDate>2026-01-09T12:18:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593173569871806516" data-draft-id="7593224937075474484" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基准测试：Akamai云上的NVIDIA RTX Pro 6000 Blackwell"/> <meta itemprop="keywords" content="人工智能,云计算,测试"/> <meta itemprop="datePublished" content="2026-01-09T12:18:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AKAMAI"/> <meta itemprop="url" content="https://juejin.cn/user/829502942352628"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基准测试：Akamai云上的NVIDIA RTX Pro 6000 Blackwell
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/829502942352628/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AKAMAI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T12:18:22.000Z" title="Fri Jan 09 2026 12:18:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0"><strong><strong>执行摘要</strong></strong></h4>
<p>基准测试显示，在Akamai云上运行的NVIDIA RTX PRO™ 6000 Blackwell推理吞吐量比H100最高提升1.63倍，在100个并发请求下每台服务器达到24,240 TPS。</p>
<hr/>
<p>如您所在的企业也在考虑采购云服务或进行云迁移，</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Flp%2Fakamai-cloud-computing-freetrial%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejin_260109_blogarticles241" target="_blank" title="https://www.akamai.com/zh/lp/akamai-cloud-computing-freetrial?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejin_260109_blogarticles241" ref="nofollow noopener noreferrer">点击链接</a>了解Akamai Linode解决方案，现在申请试用可得高达5000美元专属额度</p>
<hr/>
<h4 data-id="heading-1"><strong><strong>为Akamai推理云进行基准测试</strong></strong></h4>
<p>本周，Akamai宣布推出<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fblog%2Fcloud%2Fai-edge-all-you-need%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260109_external1_blogarticles241" target="_blank" title="https://www.akamai.com/zh/blog/cloud/ai-edge-all-you-need?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260109_external1_blogarticles241" ref="nofollow noopener noreferrer">Akamai推理云</a>。我们将自身在全球分布式架构方面的专业知识与NVIDIA Blackwell AI基础设施相结合，从根本上重新思考并扩展了释放AI真正潜力所需的加速计算能力。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fblog%2Fcloud%2Fenabling-ai-everywhere-with-akamai-inference-cloud%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260109_external2_blogarticles241" target="_blank" title="https://www.akamai.com/zh/blog/cloud/enabling-ai-everywhere-with-akamai-inference-cloud?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260109_external2_blogarticles241" ref="nofollow noopener noreferrer">Akamai推理云</a>平台将NVIDIA RTX PRO™服务器（配备NVIDIA RTX PRO 6000 Blackwell服务器版GPU、NVIDIA BlueField-3® DPU和NVIDIA AI Enterprise软件）与Akamai的分布式云计算基础设施和全球边缘网络（在全球拥有超过4,400个站点）相结合。</p>
<h4 data-id="heading-2"><strong><strong>高效、通用且优化的GPU</strong></strong></h4>
<p>分布式推理和下一代智能体体验需要高效、通用并能针对并发实时工作负载进行优化的GPU。RTX PRO 6000 Blackwell完全满足这三项要求。其FP4精度模式以数据中心级GPU的一小部分功耗和成本提供了卓越的吞吐量，使得将其部署到数百个站点变得切实可行。</p>
<p>该架构支持在单个GPU上并发处理包括文本、视觉和语音在内的多模态工作负载，减少了对专用加速器的需求，并限制了不必要的网络数据传输。</p>
<p>NVIDIA RTX Pro服务器针对代理式AI、工业和物理AI、科学计算、数据分析与模拟、视觉计算和企业应用等工作负载进行了优化。</p>
<p>NVIDIA强调，这些服务器能够实现高达6倍的<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fglossary%2Fwhat-is-a-large-language-model%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260109_external3_blogarticles241" target="_blank" title="https://www.akamai.com/zh/glossary/what-is-a-large-language-model?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260109_external3_blogarticles241" ref="nofollow noopener noreferrer">大语言模型</a>推理吞吐量、4倍更快的合成数据生成速度、7倍更快的基因组序列比对速度、3倍更高的工程模拟吞吐量、4倍更佳的实时渲染性能，以及4倍更多的并发多实例GPU工作负载。</p>
<h4 data-id="heading-3"><strong><strong>性能验证</strong></strong></h4>
<p>为了验证性能，我们测试了在Akamai云上运行的NVIDIA RTX Pro 6000 Blackwell服务器版GPU，并使用NVIDIA LaunchPad环境将其与NVIDIA H100 NVL 96GB进行了基准比较。</p>
<p>我们的目标是了解，与目前行业的黄金标准相比，下一代RTX Pro 6000 GPU在实际推理工作负载中的表现如何。</p>
<h4 data-id="heading-4"><strong><strong>基准测试结果展示</strong></strong></h4>
<p>基准测试结果证实了NVIDIA RTX Pro 6000 Blackwell在Akamai云上的设计优势。</p>
<ul>
<li>相较于H100（FP8），吞吐量提升<strong><strong>1.63倍</strong></strong>，这表明RTX Pro 6000 Blackwell以更小巧、更易于部署的规格提供了数据中心级的性能，非常适合于分布式环境。</li>
<li>从FP8切换到FP4带来的<strong><strong>1.32倍</strong></strong>性能提升，展示了NVIDIA的精度效率如何直接转化为在边缘更快、更具成本效益的推理。</li>
<li>在<strong><strong>100+并发请求</strong></strong>下保持稳定的性能，验证了该GPU处理全球分布式推理中多租户、对延迟敏感的工作负载的能力。</li>
</ul>
<p>综合来看，这些结果表明，Blackwell的效率和并发性优势使其成为Akamai分布式推理架构的理想基础，能够在我们的全球网络中提供高吞吐、低延迟和可扩展的性能。</p>
<h4 data-id="heading-5"><strong><strong>基准测试概述</strong></strong></h4>
<p>我们遵循NVIDIA的基准测试方法来评估一致负载条件下的推理性能。在本文中，我们将介绍设置、方法和关键发现，并讨论这些结果对在Akamai云上运行AI工作负载的意义。</p>
<p><strong><strong>设置</strong></strong></p>
<p>为了评估Akamai云上的NVIDIA RTX Pro 6000 GPU，我们使用了<strong><strong>Llama-3.3-Nemotron-Super-49B-v1.5</strong></strong>模型，这是一个源于Meta Llama-3.3-70B-Instruct（即参考模型）的大语言模型。它是一个针对推理、人类聊天偏好以及智能体任务（如RAG和工具调用）进行后训练的推理模型。</p>
<p>我们为同一模型使用了两个NVIDIA推理微服务配置文件，以比较精度模式并了解其对性能和效率的影响。这两个配置文件——tensorrt_llm-rtx6000_blackwell_sv-fp8-tp1-pp1-throughput-2bb5 和 tensorrt_llm-rtx6000_blackwell_sv-nvfp4-tp1-pp1-throughput-2bb5——除了精度设置外完全相同。</p>
<p>第一个使用<strong><strong>FP8</strong></strong>精度，第二个使用NVIDIA的<strong><strong>FP4</strong></strong>精度。NVIDIA的FP4版本直接在NVIDIA Blackwell GPU中得到支持。</p>
<p>通过运行两者，我们旨在观察降低数值精度如何影响吞吐量和延迟。NVFP4以低于1%的精度损失带来了显著的性能和效率提升，实现了更快、更低功耗的大规模推理，而FP8则提供了更高的数值精度。比较两者有助于为实际工作负载确定速度、效率和推理保真度之间的最佳权衡。</p>
<p>我们在位于Akamai云LAX数据中心的NVIDIA RTX Pro 6000 Blackwell服务器版GPU上运行了测试。为了进行比较，我们使用了NVIDIA LaunchPad环境中的NVIDIA H100 GPU。</p>
<p><strong><strong>方法论</strong></strong></p>
<p>对于此基准测试，我们运行了一个旨在测量现实负载条件下基线推理性能的压力测试。每个请求处理200个输入令牌并生成200个输出令牌，代表了大语言模型典型的短提示-响应交互。</p>
<p>为了测试可扩展性和一致性，我们执行了<strong><strong>100个并发运行</strong></strong>，使我们能够观察系统处理持续同时推理量时的吞吐量和延迟行为。这种方法提供了模型和硬件在生产类工作负载下性能的一个受控但具有代表性的快照。</p>
<p>我们测量了两个关键指标：<strong><strong>首令牌时间（TTFT）<strong><strong>和</strong></strong>每秒令牌数（TPS）</strong></strong>。TTFT以毫秒为单位，衡量模型在收到提示后开始生成响应的速度——这是延迟和用户感知响应性的重要指标。TPS衡量整体吞吐量，显示系统在生成开始后每秒可以生成多少令牌。</p>
<p>两者结合提供了现实世界性能的平衡视图，反映了初始推理的速度以及负载下的持续输出效率。</p>
<p>作为基准测试方法的一部分，我们运行了两组测试来评估NVIDIA RTX 6000 Blackwell服务器版GPU的性能特征。</p>
<ol>
<li><strong><strong>FP4与FP8精度比较</strong></strong><br/>
我们在同一模型上测试了两个NIM配置文件——一个使用<strong><strong>FP8</strong></strong>精度，另一个使用FP4精度——以衡量NVIDIA新型<strong><strong>FP4</strong></strong>量化对推理性能的影响。NVIDIA强调FP4是效率和吞吐量方面的一项重大进步。</li>
<li><strong><strong>RTX 6000与H100 GPU比较</strong></strong><br/>
然后，我们将<strong><strong>RTX 6000 Blackwell</strong></strong>的结果与在<strong><strong>NVIDIA LaunchPad</strong></strong>环境中运行的<strong><strong>H100 GPU</strong></strong>进行了比较，通过查看两个NIM配置文件<strong><strong>FP8</strong></strong>及<strong><strong>FP4</strong></strong>来评估实际推理优势。这使我们能够评估RTX 6000不仅在不同精度模式下的表现，还与NVIDIA当前的数据中心GPU标准进行对比。</li>
</ol>
<p><strong><strong>详细结果</strong></strong></p>
<p>我们确定<strong><strong>最佳并发级别为100</strong></strong>——即在100个同时推理请求下，我们观察到了最稳定和最具代表性的性能结果。在C=100时，RTX 6000从FP8切换到FP4精度带来了<strong><strong>1.32倍</strong></strong>的性能提升，显示了NVIDIA FP4量化的效率增益。</p>
<p>与使用FP8精度的H100相比，RTX Pro 6000 Blackwell服务器在使用NVFP4精度时实现了<strong><strong>1.63倍</strong></strong>的性能提升。即使使用FP8，Blackwell服务器也展示了<strong><strong>1.21倍</strong></strong>的优势，显示了超越旧FP8格式的下一代推理优化。</p>
<p>总体而言，在此并发级别下，RTX Pro 6000 Blackwell服务器实现了<strong><strong>3,030.01 TPS</strong></strong>，这相当于我们基础设施即服务（IaaS）虚拟机产品可提供高达<strong><strong>24,240.08 TPS</strong></strong>，突显了Blackwell架构在Akamai云上强大的推理性能和可扩展性。</p>
<h4 data-id="heading-6"><strong><strong>测试1：FP8与FP4精度比较</strong></strong></h4>
<p>RTX Pro 6000 Blackwell FP8与FP4的性能结果。</p>
<p><strong><strong>LAX：NVIDIA RTX Pro 6000 Blackwell服务器 FP8</strong></strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97dcc1f923be419eb98312be84387ba1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUtBTUFJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768565902&amp;x-signature=8xXj7bfALNZ4H2aLJlBK5fqf8RM%3D" alt="" loading="lazy"/></p>
<p><strong><strong>LAX：NVIDIA RTX PRO 6000 Blackwell服务器 FP4</strong></strong></p>
<p><strong><strong><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef4eafab5ac64fc29eeec53b3e1dcc89~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUtBTUFJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768565902&amp;x-signature=hizz9DHt833P2ruK6rXaQl8GssI%3D" alt="" loading="lazy"/></strong></strong></p>
<p><strong><strong>测试2：RTX Pro 6000 Blackwell服务器与H100 GPU比较</strong></strong></p>
<p>H100 NVL FP8与RTX Pro 6000 Blackwell服务器 FP8和FP4的性能结果比较。</p>
<p><strong><strong>LaunchPad：H100 NVL FP8</strong></strong></p>
<p><strong><strong><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f10c3ab58ea416e8109eb8ba79ee30a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUtBTUFJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768565902&amp;x-signature=PRTVdLCl2%2F4DOGy96V7Xvzki8W0%3D" alt="" loading="lazy"/></strong></strong></p>
<p><strong><strong>LaunchPad：NVIDIA RTX PRO 6000 Blackwell服务器 FP8</strong></strong></p>
<p><strong><strong><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/716ba7039620466da287b23c3b85973b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUtBTUFJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768565902&amp;x-signature=5%2B83fMvTL8vPnHdFE%2BggyCAhjfM%3D" alt="" loading="lazy"/></strong></strong></p>
<p><strong><strong>LaunchPad：NVIDIA RTX PRO 6000 Blackwell服务器 FP4</strong></strong></p>
<p><strong><strong><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66603aaa9e4e4d819e985e549430ad60~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUtBTUFJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768565902&amp;x-signature=125IgRqFZWKwU6SV6uS2wPiq47U%3D" alt="" loading="lazy"/></strong></strong></p>
<h4 data-id="heading-7"><strong><strong>结论</strong></strong></h4>
<p>本次基准测试旨在评估NVIDIA RTX Pro 6000 Blackwell服务器版GPU在Akamai云上执行LLM推理的表现，以及在相似假设下与NVIDIA H100 GPU的比较。使用NVIDIA推荐的基准测试方法，我们测试了FP8和FP4两种精度模式，以了解性能、效率和延迟之间的权衡。</p>
<p>结果清楚地表明，FP4带来了可衡量的增益，在RTX 6000上相比FP8吞吐量提升<strong><strong>1.32倍</strong></strong>。与FP8下的H100相比，RTX 6000（FP4）实现了<strong><strong>1.63倍</strong></strong>的性能提升，突显了Blackwell架构在推理工作负载方面的潜力。</p>
<p>这些发现表明，在Akamai分布式云上运行的RTX 6000 GPU能够以更低的成本和延迟为实际AI推理提供高吞吐量和高效的扩展。对于正在评估GPU方案的团队而言，这种组合能在全球范围内达成速度、效率与可及性的卓越平衡。</p>
<h4 data-id="heading-8"><strong><strong>获取访问权限</strong></strong></h4>
<p>注册以获取在Akamai推理云上使用RTX Pro 6000 Blackwell服务器版的访问权限。</p>
<hr/>
<p>如您所在的企业也在考虑采购云服务或进行云迁移，</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Flp%2Fakamai-cloud-computing-freetrial%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejin_260109_blogarticles241_end" target="_blank" title="https://www.akamai.com/zh/lp/akamai-cloud-computing-freetrial?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejin_260109_blogarticles241_end" ref="nofollow noopener noreferrer">点击链接</a>了解Akamai Linode解决方案，现在申请试用可得高达5000美元专属额度</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我们来说说 Cookie、Session、Token、JWT]]></title>    <link>https://juejin.cn/post/7593187953271881728</link>    <guid>https://juejin.cn/post/7593187953271881728</guid>    <pubDate>2026-01-09T12:57:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593187953271881728" data-draft-id="7593193235251150900" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我们来说说 Cookie、Session、Token、JWT"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2026-01-09T12:57:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员小假"/> <meta itemprop="url" content="https://juejin.cn/user/2285197690931932"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我们来说说 Cookie、Session、Token、JWT
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2285197690931932/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员小假
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T12:57:19.000Z" title="Fri Jan 09 2026 12:57:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">什么是认证（Authentication）</h2>
<ul>
<li>通俗地讲就是验证当前用户的身份，证明“你是你自己”（比如：你每天上下班打卡，都需要通过指纹打卡，当你的指纹和系统里录入的指纹相匹配时，就打卡成功）</li>
<li>互联网中的认证：</li>
</ul>

<ul>
<li>
<ul>
<li>用户名密码登录</li>
<li>邮箱发送登录链接</li>
<li>手机号接收验证码</li>
<li>只要你能收到邮箱/验证码，就默认你是账号的主人</li>
</ul>
</li>
</ul>
<h2 data-id="heading-1">什么是授权（Authorization）</h2>
<ul>
<li>用户授予第三方应用访问该用户某些资源的权限</li>
</ul>

<ul>
<li>
<ul>
<li>在安装手机应用的时候，APP 会询问是否允许授予权限（访问相册、地理位置等权限）</li>
<li>在访问微信小程序时，当登录时，小程序会询问是否允许授予权限（获取昵称、头像、地区、性别等个人信息）</li>
</ul>
</li>
</ul>

<ul>
<li>实现授权的方式有：cookie、session、token、OAuth</li>
</ul>
<h2 data-id="heading-2">什么是凭证（Credentials）</h2>
<ul>
<li>实现认证和授权的前提是需要一种媒介（证书）来标记访问者的身份</li>
</ul>

<ul>
<li>
<ul>
<li>在战国时期，商鞅变法，发明了照身帖。照身帖由官府发放，是一块打磨光滑细密的竹板，上面刻有持有人的头像和籍贯信息。国人必须持有，如若没有就被认为是黑户，或者间谍之类的。</li>
<li>在现实生活中，每个人都会有一张专属的居民身份证，是用于证明持有人身份的一种法定证件。通过身份证，可以办理手机卡/银行卡/个人贷款/交通出行等等，这就是认证的凭证。</li>
<li>在互联网应用中，一般网站（如掘金）会有两种模式，游客模式和登录模式。游客模式下，可以正常浏览网站上面的文章，一旦想要点赞/收藏/分享文章，就需要登录或者注册账号。当用户登录成功后，服务器会给该用户使用的浏览器颁发一个令牌（token），这个令牌用来表明身份，每次浏览器发送请求时会带上这个令牌，就可以使用游客模式下无法使用的功能。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-3">什么是 Cookie</h2>
<ul>
<li>HTTP 是无状态的协议（对于事务处理没有记忆能力，每次客户端和服务端会话完成时，服务端不会保存任何会话信息）：每个请求都是完全独立的，服务端无法确认当前访问者的身份信息，无法分辨上一次的请求发送者和这一次的发送者是不是同一个人。所以服务器与浏览器为了进行会话跟踪（知道是谁在访问），就必须主动的去维护一个状态，这个状态用于告知服务端前后两个请求是否来自同一浏览器。而这个状态需要通过 cookie 或者 session 去实现。</li>
<li>cookie 存储在客户端：cookie 是服务器发送到用户浏览器并保存在本地的一小块数据，它会在浏览器下次向同一服务器再发起请求时被携带并发送到服务器上。</li>
<li>cookie 是不可跨域的：每个 cookie 都会绑定单一的域名，无法在别的域名下获取使用，一级域名和二级域名之间是允许共享使用的（靠的是 domain）。</li>
</ul>
<p>cookie 重要的属性</p>





































<table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td>name=value</td><td>键值对，设置 Cookie 的名称及相对应的值，都必须是字符串类型 - 如果值为 Unicode 字符，需要为字符编码。- 如果值为二进制数据，则需要使用 BASE64 编码。</td></tr><tr><td>domain</td><td>指定 cookie 所属域名，默认是当前域名</td></tr><tr><td>path</td><td>指定 cookie 在哪个路径（路由）下生效，默认是 ‘/‘。如果设置为/abc，则只有/abc下的路由可以访问到该 cookie，如：/abc/read。</td></tr><tr><td>maxAge</td><td>cookie 失效的时间，单位秒。如果为整数，则该 cookie 在 maxAge 秒后失效。如果为负数，该 cookie 为临时 cookie ，关闭浏览器即失效，浏览器也不会以任何形式保存该 cookie 。如果为 0，表示删除该 cookie 。默认为 -1。-比 expires 好用。</td></tr><tr><td>expires</td><td>过期时间，在设置的某个时间点后该 cookie 就会失效。一般浏览器的 cookie 都是默认储存的，当关闭浏览器结束这个会话的时候，这个 cookie 也就会被删除</td></tr><tr><td>secure</td><td>该 cookie 是否仅被使用安全协议传输。安全协议有 HTTPS，SSL等，在网络上传输数据之前先将数据加密。默认为false。当 secure 值为 true 时，cookie 在 HTTP 中是无效，在 HTTPS 中才有效。</td></tr><tr><td>httpOnly</td><td>如果给某个 cookie 设置了 httpOnly 属性，则无法通过 JS 脚本 读取到该 cookie 的信息，但还是能通过 Application 中手动修改 cookie，所以只是在一定程度上可以防止 XSS 攻击，不是绝对的安全</td></tr></tbody></table>
<h2 data-id="heading-4">什么是 Session</h2>
<ul>
<li>session 是另一种记录服务器和客户端会话状态的机制</li>
<li>session 是基于 cookie 实现的，session 存储在服务器端，sessionId 会被存储到客户端的cookie 中</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a859eaee2a24037b837ee0c9a1edfec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP5YGH:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768568239&amp;x-signature=gOS9fkxOKw%2Fep58t63nVbKuRI9w%3D" alt="" loading="lazy"/></p>
<ul>
<li>session 认证流程：</li>
</ul>

<ul>
<li>
<ul>
<li>用户第一次请求服务器的时候，服务器根据用户提交的相关信息，创建对应的 Session</li>
<li>请求返回时将此 Session 的唯一标识信息 SessionID 返回给浏览器</li>
<li>浏览器接收到服务器返回的 SessionID 信息后，会将此信息存入到 Cookie 中，同时 Cookie 记录此 SessionID 属于哪个域名</li>
<li>当用户第二次访问服务器的时候，请求会自动判断此域名下是否存在 Cookie 信息，如果存在自动将 Cookie 信息也发送给服务端，服务端会从 Cookie 中获取 SessionID，再根据 SessionID 查找对应的 Session 信息，如果没有找到说明用户没有登录或者登录失效，如果找到 Session 证明用户已经登录可执行后面操作。</li>
</ul>
</li>
</ul>
<p>根据以上流程可知，SessionID 是连接 Cookie 和 Session 的一道桥梁，大部分系统也是根据此原理来验证用户登录状态。</p>
<h2 data-id="heading-5">Cookie 和 Session 的区别</h2>
<ul>
<li>安全性：Session 比 Cookie 安全，Session 是存储在服务器端的，Cookie 是存储在客户端的。</li>
<li>存取值的类型不同：Cookie 只支持存字符串数据，想要设置其他类型的数据，需要将其转换成字符串，Session 可以存任意数据类型。</li>
<li>有效期不同：Cookie 可设置为长时间保持，比如经常使用的默认登录功能，Session 一般失效时间较短，客户端关闭（默认情况下）或者 Session 超时都会失效。</li>
<li>存储大小不同：单个 Cookie 保存的数据不能超过 4K，Session 可存储数据远高于 Cookie，但是当访问量过多，会占用过多的服务器资源。</li>
</ul>
<h2 data-id="heading-6">什么是 Token（令牌）</h2>
<h3 data-id="heading-7">Acesss Token</h3>
<ul>
<li>访问资源接口（API）时所需要的资源凭证</li>
<li>简单 token 的组成：uid(用户唯一的身份标识)、time(当前时间的时间戳)、sign（签名，token 的前几位以哈希算法压缩成的一定长度的十六进制字符串）</li>
<li>特点：</li>
</ul>

<ul>
<li>
<ul>
<li>服务端无状态化、可扩展性好</li>
<li>支持移动端设备</li>
<li>安全</li>
<li>支持跨程序调用</li>
</ul>
</li>
</ul>

<ul>
<li>token 的身份验证流程：</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d90360d6b254a108b2a34941353a887~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP5YGH:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768568239&amp;x-signature=W2RCfhd9EefIaILH12lDb3FXj80%3D" alt="" loading="lazy"/></p>
<ol>
<li>客户端使用用户名跟密码请求登录</li>
<li>服务端收到请求，去验证用户名与密码</li>
<li>验证成功后，服务端会签发一个 token 并把这个 token 发送给客户端</li>
<li>客户端收到 token 以后，会把它存储起来，比如放在 cookie 里或者 localStorage 里</li>
<li>客户端每次向服务端请求资源的时候需要带着服务端签发的 token</li>
<li>服务端收到请求，然后去验证客户端请求里面带着的 token ，如果验证成功，就向客户端返回请求的数据</li>
</ol>
<ul>
<li>每一次请求都需要携带 token，需要把 token 放到 HTTP 的 Header 里</li>
<li>基于 token 的用户认证是一种服务端无状态的认证方式，服务端不用存放 token 数据。用解析 token 的计算时间换取 session 的存储空间，从而减轻服务器的压力，减少频繁的查询数据库</li>
<li>token 完全由应用管理，所以它可以避开同源策略</li>
</ul>
<h3 data-id="heading-8">Refresh Token</h3>
<ul>
<li>另外一种 token——refresh token</li>
<li>refresh token 是专用于刷新 access token 的 token。如果没有 refresh token，也可以刷新 access token，但每次刷新都要用户输入登录用户名与密码，会很麻烦。有了 refresh token，可以减少这个麻烦，客户端直接用 refresh token 去更新 access token，无需用户进行额外的操作。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc194893c4a14663b71e869f9ca59027~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP5YGH:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768568239&amp;x-signature=8aaZXEP5X0lKf70px%2FdsXzuAIcM%3D" alt="" loading="lazy"/></p>
<ul>
<li>Access Token 的有效期比较短，当 Acesss Token 由于过期而失效时，使用 Refresh Token 就可以获取到新的 Token，如果 Refresh Token 也失效了，用户就只能重新登录了。</li>
<li>Refresh Token 及过期时间是存储在服务器的数据库中，只有在申请新的 Acesss Token 时才会验证，不会对业务接口响应时间造成影响，也不需要向 Session 一样一直保持在内存中以应对大量的请求。</li>
</ul>
<h2 data-id="heading-9">Token 和 Session 的区别</h2>
<ul>
<li>Session 是一种记录服务器和客户端会话状态的机制，使服务端有状态化，可以记录会话信息。而 Token 是令牌，访问资源接口（API）时所需要的资源凭证。Token使服务端无状态化，不会存储会话信息。</li>
<li>Session 和 Token 并不矛盾，作为身份认证 Token 安全性比 Session 好，因为每一个请求都有签名还能防止监听以及重放攻击，而 Session 就必须依赖链路层来保障通讯安全了。如果需要实现有状态的会话，仍然可以增加 Session 来在服务器端保存一些状态。</li>
<li>所谓 Session 认证只是简单的把 User 信息存储到 Session 里，因为 SessionID 的不可预测性，暂且认为是安全的。而 Token ，如果指的是 OAuth Token 或类似的机制的话，提供的是 认证 和 授权 ，认证是针对用户，授权是针对 App 。其目的是让某 App 有权利访问某用户的信息。这里的 Token 是唯一的。不可以转移到其它 App上，也不可以转到其它用户上。Session 只提供一种简单的认证，即只要有此 SessionID ，即认为有此 User 的全部权利。是需要严格保密的，这个数据应该只保存在站方，不应该共享给其它网站或者第三方 App。所以简单来说：如果用户数据可能需要和第三方共享，或者允许第三方调用 API 接口，用 Token 。如果永远只是自己的网站，自己的 App，用什么就无所谓了。</li>
</ul>
<h2 data-id="heading-10">什么是 JWT</h2>
<ul>
<li>JSON Web Token（简称 JWT）是目前最流行的跨域认证解决方案。</li>
<li>是一种认证授权机制。</li>
<li>JWT 是为了在网络应用环境间传递声明而执行的一种基于 JSON 的开放标准（RFC 7519）。JWT 的声明一般被用来在身份提供者和服务提供者间传递被认证的用户身份信息，以便于从资源服务器获取资源。比如用在用户登录上。</li>
<li>可以使用 HMAC 算法或者是 RSA 的公/私秘钥对 JWT 进行签名。因为数字签名的存在，这些传递的信息是可信的。</li>
</ul>
<h3 data-id="heading-11">生成 JWT</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fjwt.io%2Fwww.jsonwebtoken.io%2F" target="_blank" title="https://jwt.io/www.jsonwebtoken.io/" ref="nofollow noopener noreferrer">jwt.io/www.jsonweb…</a></p>
<h3 data-id="heading-12">JWT 的原理</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cdbf2b1cd5284bc0ad158b91e2543dc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP5YGH:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768568239&amp;x-signature=VKvM%2BNv6E%2FtZVs0WGwWFISJbiKk%3D" alt="" loading="lazy"/></p>
<ul>
<li>JWT 认证流程：</li>
</ul>

<ul>
<li>
<ul>
<li>用户输入用户名/密码登录，服务端认证成功后，会返回给客户端一个 JWT</li>
<li>客户端将 token 保存到本地（通常使用 localstorage，也可以使用 cookie）</li>
<li>当用户希望访问一个受保护的路由或者资源的时候，需要请求头的 Authorization 字段中使用Bearer 模式添加 JWT，其内容看起来是下面这样</li>
</ul>
</li>
</ul>

<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">Authorization: Bearer &lt;token&gt;</span>
</code></pre>
<ul>
<li>服务端的保护路由将会检查请求头 Authorization 中的 JWT 信息，如果合法，则允许用户的行为</li>
<li>因为 JWT 是自包含的（内部包含了一些会话信息），因此减少了需要查询数据库的需要</li>
<li>因为 JWT 并不使用 Cookie 的，所以可以使用任何域名提供 API 服务而不需要担心跨域资源共享问题（CORS）</li>
<li>因为用户的状态不再存储在服务端的内存中，所以这是一种无状态的认证机制</li>
</ul>
<h3 data-id="heading-13">JWT 的使用方式</h3>
<ul>
<li>客户端收到服务器返回的 JWT，可以储存在 Cookie 里面，也可以储存在 localStorage。</li>
</ul>
<h4 data-id="heading-14">方式一</h4>
<ul>
<li>当用户希望访问一个受保护的路由或者资源的时候，可以把它放在 Cookie 里面自动发送，但是这样不能跨域，所以更好的做法是放在 HTTP 请求头信息的 Authorization 字段里，使用 Bearer 模式添加 JWT。</li>
</ul>

<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">GET</span> /calendar/v1/events
<span class="hljs-symbol">Host:</span> api.example.com
<span class="hljs-symbol">Authorization:</span> Bearer &lt;token&gt;
</code></pre>
<ul>
<li>
<ul>
<li>用户的状态不会存储在服务端的内存中，这是一种无状态的认证机制</li>
<li>服务端的保护路由将会检查请求头 Authorization 中的 JWT 信息，如果合法，则允许用户的行为。</li>
<li>由于 JWT 是自包含的，因此减少了需要查询数据库的需要</li>
<li>JWT 的这些特性使得可以完全依赖其无状态的特性提供数据 API 服务，甚至是创建一个下载流服务。</li>
<li>因为 JWT 并不使用 Cookie ，所以可以使用任何域名提供 API 服务而不需要担心跨域资源共享问题（CORS）</li>
</ul>
</li>
</ul>
<h4 data-id="heading-15">方式二</h4>
<ul>
<li>跨域的时候，可以把 JWT 放在 POST 请求的数据体里。</li>
</ul>
<h4 data-id="heading-16">方式三</h4>
<ul>
<li>通过 URL 传输</li>
</ul>
<p><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.example.com%2Fuser%3Ftoken%3Dxxx" target="_blank" title="http://www.example.com/user?token=xxx" ref="nofollow noopener noreferrer">www.example.com/user?token=…</a></p>
<h2 data-id="heading-17">Token 和 JWT 的区别</h2>
<p>相同：</p>
<ul>
<li>都是访问资源的令牌</li>
<li>都可以记录用户的信息</li>
<li>都是使服务端无状态化</li>
<li>都是只有验证成功后，客户端才能访问服务端上受保护的资源</li>
</ul>
<p>区别：</p>
<ul>
<li>Token：服务端验证客户端发送过来的 Token 时，还需要查询数据库获取用户信息，然后验证 Token 是否有效。</li>
<li>JWT：将 Token 和 Payload 加密后存储于客户端，服务端只需要使用密钥解密进行校验（校验也是 JWT 自己实现的）即可，不需要查询或者减少查询数据库，因为 JWT 自包含了用户信息和加密的数据。</li>
</ul>
<h2 data-id="heading-18">常见的前后端鉴权方式</h2>
<ol>
<li>Session-Cookie</li>
<li>Token 验证（包括 JWT，SSO）</li>
<li>OAuth2.0（开放授权）</li>
</ol>
<h2 data-id="heading-19">常见的加密算法</h2>
<ul>
<li>哈希算法(Hash Algorithm)又称散列算法、散列函数、哈希函数，是一种从任何一种数据中创建小的数字“指纹”的方法。哈希算法将数据重新打乱混合，重新创建一个哈希值。</li>
<li>哈希算法主要用来保障数据真实性(即完整性)，即发信人将原始消息和哈希值一起发送，收信人通过相同的哈希函数来校验原始数据是否真实。</li>
<li>哈希算法通常有以下几个特点：</li>
</ul>

<ul>
<li>
<ul>
<li>2 的 128 次方为 340282366920938463463374607431768211456，也就是 10 的 39 次方级别</li>
<li>2 的 160 次方为 1.4615016373309029182036848327163e+48，也就是 10 的 48 次方级别</li>
<li>2 的 256 次方为 1.1579208923731619542357098500869 × 10 的 77 次方，也就是 10 的 77 次方</li>
<li>正像快速：原始数据可以快速计算出哈希值</li>
<li>逆向困难：通过哈希值基本不可能推导出原始数据</li>
<li>输入敏感：原始数据只要有一点变动，得到的哈希值差别很大</li>
<li>冲突避免：很难找到不同的原始数据得到相同的哈希值，宇宙中原子数大约在 10 的 60 次方到 80 次方之间，所以 2 的 256 次方有足够的空间容纳所有的可能，算法好的情况下冲突碰撞的概率很低：</li>
</ul>
</li>
</ul>
<p>注意：</p>
<ol>
<li>以上不能保证数据被恶意篡改，原始数据和哈希值都可能被恶意篡改，要保证不被篡改，可以使用RSA 公钥私钥方案，再配合哈希值。</li>
<li>哈希算法主要用来防止计算机传输过程中的错误，早期计算机通过前 7 位数据第 8 位奇偶校验码来保障（12.5% 的浪费效率低），对于一段数据或文件，通过哈希算法生成 128bit 或者 256bit 的哈希值，如果校验有问题就要求重传。</li>
</ol>
<h2 data-id="heading-20">常见问题</h2>
<h3 data-id="heading-21">使用 cookie 时需要考虑的问题</h3>
<ul>
<li>因为存储在客户端，容易被客户端篡改，使用前需要验证合法性</li>
<li>不要存储敏感数据，比如用户密码，账户余额</li>
<li>使用 httpOnly 在一定程度上提高安全性</li>
<li>尽量减少 cookie 的体积，能存储的数据量不能超过 4kb</li>
<li>设置正确的 domain 和 path，减少数据传输</li>
<li>cookie 无法跨域</li>
<li>一个浏览器针对一个网站最多存 20 个Cookie，浏览器一般只允许存放 300 个Cookie</li>
<li>移动端对 cookie 的支持不是很好，而 session 需要基于 cookie 实现，所以移动端常用的是 token</li>
</ul>
<h3 data-id="heading-22">使用 session 时需要考虑的问题</h3>
<ul>
<li>将 session 存储在服务器里面，当用户同时在线量比较多时，这些 session 会占据较多的内存，需要在服务端定期的去清理过期的 session</li>
<li>当网站采用集群部署的时候，会遇到多台 web 服务器之间如何做 session 共享的问题。因为 session 是由单个服务器创建的，但是处理用户请求的服务器不一定是那个创建 session 的服务器，那么该服务器就无法拿到之前已经放入到 session 中的登录凭证之类的信息了。</li>
<li>当多个应用要共享 session 时，除了以上问题，还会遇到跨域问题，因为不同的应用可能部署的主机不一样，需要在各个应用做好 cookie 跨域的处理。</li>
<li>sessionId 是存储在 cookie 中的，假如浏览器禁止 cookie 或不支持 cookie 怎么办？一般会把 sessionId 跟在 url 参数后面即重写 url，所以 session 不一定非得需要靠 cookie 实现</li>
<li>移动端对 cookie 的支持不是很好，而 session 需要基于 cookie 实现，所以移动端常用的是 token</li>
</ul>
<h3 data-id="heading-23">使用 token 时需要考虑的问题</h3>
<ul>
<li>如果认为用数据库来存储 token 会导致查询时间太长，可以选择放在内存当中。比如 redis 很适合对 token 查询的需求。</li>
<li>token 完全由应用管理，所以它可以避开同源策略</li>
<li>token 可以避免 CSRF 攻击(因为不需要 cookie 了)</li>
<li>移动端对 cookie 的支持不是很好，而 session 需要基于 cookie 实现，所以移动端常用的是 token</li>
</ul>
<h3 data-id="heading-24">使用 JWT 时需要考虑的问题</h3>
<ul>
<li>因为 JWT 并不依赖 Cookie 的，所以可以使用任何域名提供 API 服务而不需要担心跨域资源共享问题（CORS）</li>
<li>JWT 默认是不加密，但也是可以加密的。生成原始 Token 以后，可以用密钥再加密一次。</li>
<li>JWT 不加密的情况下，不能将秘密数据写入 JWT。</li>
<li>JWT 不仅可以用于认证，也可以用于交换信息。有效使用 JWT，可以降低服务器查询数据库的次数。</li>
<li>JWT 最大的优势是服务器不再需要存储 Session，使得服务器认证鉴权业务可以方便扩展。但这也是 JWT 最大的缺点：由于服务器不需要存储 Session 状态，因此使用过程中无法废弃某个 Token 或者更改 Token 的权限。也就是说一旦 JWT 签发了，到期之前就会始终有效，除非服务器部署额外的逻辑。</li>
<li>JWT 本身包含了认证信息，一旦泄露，任何人都可以获得该令牌的所有权限。为了减少盗用，JWT的有效期应该设置得比较短。对于一些比较重要的权限，使用时应该再次对用户进行认证。</li>
<li>JWT 适合一次性的命令认证，颁发一个有效期极短的 JWT，即使暴露了危险也很小，由于每次操作都会生成新的 JWT，因此也没必要保存 JWT，真正实现无状态。</li>
<li>为了减少盗用，JWT 不应该使用 HTTP 协议明码传输，要使用 HTTPS 协议传输。</li>
</ul>
<h3 data-id="heading-25">使用加密算法时需要考虑的问题</h3>
<ul>
<li>绝不要以明文存储密码</li>
<li>永远使用 哈希算法 来处理密码，绝不要使用 Base64 或其他编码方式来存储密码，这和以明文存储密码是一样的，使用哈希，而不要使用编码。编码以及加密，都是双向的过程，而密码是保密的，应该只被它的所有者知道， 这个过程必须是单向的。哈希正是用于做这个的，从来没有解哈希这种说法， 但是编码就存在解码，加密就存在解密。</li>
<li>绝不要使用弱哈希或已被破解的哈希算法，像 MD5 或 SHA1 ，只使用强密码哈希算法。</li>
<li>绝不要以明文形式显示或发送密码，即使是对密码的所有者也应该这样。如果需要 “忘记密码” 的功能，可以随机生成一个新的一次性的（这点很重要）密码，然后把这个密码发送给用户。</li>
</ul>
<h3 data-id="heading-26">分布式架构下 session 共享方案</h3>
<h4 data-id="heading-27">1. session 复制</h4>
<p>任何一个服务器上的 session 发生改变（增删改），该节点会把这个 session 的所有内容序列化，然后广播给所有其它节点，不管其他服务器需不需要 session ，以此来保证 session 同步<br/>
优点：可容错，各个服务器间 session 能够实时响应。缺点：会对网络负荷造成一定压力，如果 session 量大的话可能会造成网络堵塞，拖慢服务器性能。</p>
<h4 data-id="heading-28">2. 粘性 session /IP 绑定策略</h4>
<ul>
<li>采用 Ngnix 中的 ip_hash 机制，将某个 ip的所有请求都定向到同一台服务器上，即将用户与服务器绑定。用户第一次请求时，负载均衡器将用户的请求转发到了 A 服务器上，如果负载均衡器设置了粘性 session 的话，那么用户以后的每次请求都会转发到 A 服务器上，相当于把用户和 A 服务器粘到了一块，这就是粘性 session 机制。</li>
</ul>
<p>优点：简单，不需要对 session 做任何处理。缺点：缺乏容错性，如果当前访问的服务器发生故障，用户被转移到第二个服务器上时，他的 session 信息都将失效。适用场景：发生故障对客户产生的影响较小；服务器发生故障是低概率事件 。实现方式：以 Nginx 为例，在 upstream 模块配置 ip_hash 属性即可实现粘性 session。</p>
<h4 data-id="heading-29">3. session 共享（常用）</h4>
<ul>
<li>使用分布式缓存方案比如 Memcached 、Redis 来缓存 session，但是要求 Memcached 或 Redis 必须是集群</li>
<li>把 session 放到 Redis 中存储，虽然架构上变得复杂，并且需要多访问一次 Redis ，但是这种方案带来的好处也是很大的：</li>
</ul>

<ul>
<li>
<ul>
<li>实现了 session 共享；</li>
<li>可以水平扩展（增加 Redis 服务器）；</li>
<li>服务器重启 session 不丢失（不过也要注意 session 在 Redis 中的刷新/失效机制）；</li>
<li>不仅可以跨服务器 session 共享，甚至可以跨平台（例如网页端和 APP 端）</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/029470ed1c75477cb0b51431c0ac6af1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP5YGH:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768568239&amp;x-signature=gSCNJvpZGBSWtDYFcYelugrccxY%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-30">4. session 持久化</h4>
<p>将 session 存储到数据库中，保证 session 的持久化<br/>
优点：服务器出现问题，session 不会丢失缺点：如果网站的访问量很大，把 session 存储到数据库中，会对数据库造成很大压力，还需要增加额外的开销维护数据库。</p>
<h3 data-id="heading-31">只要关闭浏览器 ，session 真的就消失了？</h3>
<p>不对。对 session 来说，除非程序通知服务器删除一个 session，否则服务器会一直保留，程序一般都是在用户做 log off 的时候发个指令去删除 session。然而浏览器从来不会主动在关闭之前通知服务器它将要关闭，因此服务器根本不会有机会知道浏览器已经关闭，之所以会有这种错觉，是大部分 session 机制都使用会话 cookie 来保存 session id，而关闭浏览器后这个 session id 就消失了，再次连接服务器时也就无法找到原来的 session。如果服务器设置的 cookie 被保存在硬盘上，或者使用某种手段改写浏览器发出的 HTTP 请求头，把原来的 session id 发送给服务器，则再次打开浏览器仍然能够打开原来的 session。恰恰是由于关闭浏览器不会导致 session 被删除，迫使服务器为 session 设置了一个失效时间，当距离客户端上一次使用 session 的时间超过这个失效时间时，服务器就认为客户端已经停止了活动，才会把 session 删除以节省存储空间。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[知识蒸馏学习总结]]></title>    <link>https://juejin.cn/post/7593145583347941418</link>    <guid>https://juejin.cn/post/7593145583347941418</guid>    <pubDate>2026-01-09T11:13:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593145583347941418" data-draft-id="7593145583347925034" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="知识蒸馏学习总结"/> <meta itemprop="keywords" content="算法,人工智能"/> <meta itemprop="datePublished" content="2026-01-09T11:13:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="矮人三等"/> <meta itemprop="url" content="https://juejin.cn/user/4350105576808472"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            知识蒸馏学习总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4350105576808472/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    矮人三等
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T11:13:11.000Z" title="Fri Jan 09 2026 11:13:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读23分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<ol>
<li>模型蒸馏是一种将大模型的知识传递给小模型的过程，“大模型”通常是一个性能较好的复杂模型，而“小模型”则是一个更简单、计算量较小的模型。
<ol>
<li>通过模型蒸馏，可以让小模型学到大模型的一些关键知识，从而在保持较高性能的同时，降低计算成本和存储需求。</li>
<li>蒸馏算法的关键问题是如何从老师模型转换的知识传授给学生模型。</li>
<li>一个知识蒸馏系统由三个主要部分组成：知识，蒸馏算法，和师生架构。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25c953a52ad4409bb3f960c7038a6b3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-u5Lq65LiJ562J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768561991&amp;x-signature=ZOgEpZDmnD5%2F0jNX2FlJUwTiBVQ%3D" alt="在这里插入图片描述" loading="lazy"/></li>
</ol>
</li>
</ol>
<h2 data-id="heading-1">标签</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87bc82048efe42169a81ee57b0c0511d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-u5Lq65LiJ562J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768561991&amp;x-signature=co5PBuFQFygAj9bJ4rbDB2IL%2BeQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ol>
<li>软标签和硬标签：在机器学习和深度学习中，硬标签（Hard Labels）和软标签（Soft Labels） 是两种不同的标签表示方式。
<ol>
<li>硬标签（Hard Labels）在模型蒸馏中，硬标签是指 真实数据的标注，通常是 独热编码（One-Hot Encoding） 的形式。硬标签表示每个样本的真实类别，用于 监督学习。
<ol>
<li>特点 是离散性和明确性：
<ol>
<li>离散性：硬标签是离散的，每个样本只有一个类别被标记为1，其余类别为0。</li>
<li>明确性：硬标签直接反映了数据的真实类别，没有概率信息。</li>
</ol>
</li>
</ol>
</li>
<li>软标签（Soft Labels） 在模型蒸馏中，软标签是指教师模型的输出概率分布。教师模型对每个样本进行预测，输出每个类别的概率值，这些概率值构成了软标签。</li>
<li>暗知识：指的是<strong>教师模型学到的、无法通过人工标注的 “硬标签” 直接体现的隐性规律与关联信息</strong>，是教师模型在海量数据上训练后内化的 “经验”。
<ol>
<li>举例如下：判断句子 “苹果发布会即将召开” 的类别是<code>[科技, 美食, 体育]</code>。
<ol>
<li>硬标签：<code>[1,0,0]</code>（科技）</li>
<li>暗知识：教师输出<code>[0.85, 0.1, 0.05]</code>。其中<code>0.1</code>的美食概率，就是暗知识 (因为 “苹果” 也可以指水果，模型捕捉到了这个一词多义的隐性关联。)</li>
</ol>
</li>
</ol>
</li>
<li>暗知识的核心特点
<ol>
<li>隐含性：无法通过人工标注得到，是模型从数据中自主学习到的模式。</li>
<li>泛化性：包含类别间的相似性、关联性，能帮助学生模型更好地处理模糊样本。</li>
<li>温度依赖：暗知识的提取需要通过**温度系数 T **软化教师模型的输出概率。T 越大，概率分布越平滑，暗知识的体现越充分
<ol>
<li>logits：<strong>logits（对数几率）指的是模型最后一层全连接层的原始输出</strong>—— 它是还没经过 Softmax 激活函数、没有被归一化成概率的数值，通俗理解就是比如比赛评委打分：此时刚进行打分，还没有根据分数进行分组的阶段输出</li>
</ol>
</li>
</ol>
</li>
<li>暗知识与知识蒸馏的关系: 知识蒸馏的核心就是<strong>把暗知识从教师模型迁移到学生模型</strong>。
<ul>
<li>如果只让学生学习硬标签，学生只能学会 “分类结果”，但学不会 “分类的逻辑”；</li>
<li>结合软标签学习暗知识，学生不仅能判断 “是什么”，还能理解 “为什么像”，从而在样本分布复杂、数据量少的场景下，达到接近教师模型的泛化性能。</li>
</ul>
</li>
</ol>
</li>
</ol>
<h2 data-id="heading-2">蒸馏过程</h2>
<ol>
<li>变量以及公式详解：
<ol>
<li>Zi(T) ：表示教师模型对第 i 类的 logits；  Zi(S)同理表示学生模型的 logits</li>
<li>yi 表示真实标签，也就是硬标签</li>
<li>Softmax(Zi) = Pi = e^(zi  ) / ∑j e ^ (zj)</li>
<li>软化概率公式(带有温度 T 的 softmax 公式，生成软标签的工具)：Pi_T = e^(zi / T ) / ∑j e ^ (zj / T)</li>
<li>交叉熵损失函数(多分类为例)：L_CE= - ∑i  yi * log(y^)</li>
<li>图像任务：T=2 ～ 4；NLP 任务：T=5～10</li>
</ol>
</li>
<li>蒸馏损失的计算：L_total = α * L_hard + (1-α)  * L_soft             α ∈  [0,1]) 是损失权重，通常取 (0.3)（侧重软损失传递暗知识）。
<ol>
<li>软损失 L_soft 是传递教师的"暗知识"，分别结算教师模型和学生模型的软化概率：
<ol>
<li>1.4 中的软化概率公式分别计算得到 Pi_T 和 Qi_S</li>
<li>注：其实就是模型最后一层全连接成的原始输出 logits，不使用 softmax 而是带有 T 的 softmax 得到每个类别的概率值</li>
</ol>
</li>
<li>计算交叉熵损失：L_soft = - ∑i Pi_T   * log(Qi_S)
<ol>
<li>使用 1.5 中的公式，其实这就是一个计算教师模型输出概率和学生概率分布的差值后，反向传播来训练学生模型的过程</li>
</ol>
</li>
<li>硬损失 L_hard 是保证任务正确性：
<ol>
<li>此时 T=1，也就是说硬化概率公式就是原本的 softmax 函数得到的</li>
<li>Pi_S：硬标签也就是 softmax 得到的结果， L_hard = - ∑i yi   * log(Pi_S)，此时不需要教师模型计算，因为用的是真实标签</li>
</ol>
</li>
<li>softmax 函数此时也可以用 MSE 函数来代替，原因如下：
<ol>
<li>当前计算损失直接使用预测值和真实值的均方和，同样可以进行反向传播训练，而且不经过 softmax 还可以避免 Softmax 的数值压缩，更直接传递教师的原始判断信息。</li>
<li>此时的 MSE 不是为了分类，而是单纯为了让学生分布和教师分布接近的更快</li>
<li>MSE 使用场景：(快速验证、小模型蒸馏)   CE 使用场景: (核心蒸馏场景，优先选择)</li>
</ol>
</li>
<li>总结： logits --&gt; Pi --&gt; L ，教师模型参数冻结，只更新学生模型参数</li>
</ol>
</li>
</ol>
<h2 data-id="heading-3">1 知识</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ebc942849fbb4788b8be7af0e2bcf889~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-u5Lq65LiJ562J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768561991&amp;x-signature=0ve%2BR1YlvreMdEZN6L6EnV4vGGs%3D" alt="在这里插入图片描述" loading="lazy"/></p>





























<table><thead><tr><th>知识类型</th><th>迁移对象</th><th>适用场景</th><th>典型损失函数</th></tr></thead><tbody><tr><td>基于响应的知识</td><td>教师模型全连接层输出 logits</td><td>入门级蒸馏、小模型轻量化</td><td>交叉熵（软标签）、MSE（Logits 匹配）</td></tr><tr><td>基于特征的知识</td><td>教师模型中间层的特征向量</td><td>复杂任务（检测 / 分割）、大模型蒸馏</td><td>MSE、余弦相似度、Gram 矩阵损失</td></tr><tr><td>基于关系的知识</td><td>教师模型样本间的关联关系</td><td>细粒度分类、小样本学习</td><td>关系一致性损失、对比损失</td></tr></tbody></table>
<ol>
<li>
<p>基于响应的知识：最基础、最经典的蒸馏范式
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90d0b06b9d244811b0211c0c879641b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-u5Lq65LiJ562J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768561991&amp;x-signature=j5Gn8y%2FQ6ULRrWWz6n4Pet%2Ba8bQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ol>
<li>核心定义：知识是教师模型在<strong>输出层的响应</strong>，即最后一层的 <strong>Logits</strong> 或经过 Softmax（带温度 T）的 <strong>概率分布</strong>。</li>
<li>通俗理解：相当于教师直接把 “最终答案 + 最终结果的思考” 告诉学生：</li>
<li>迁移方式：学生模型的输出层响应 对齐 教师模型的输出层响应</li>
<li>优势：实现简单，无需修改模型结构，适合入门和快速验证</li>
<li>基于软目标的响应型知识蒸馏通常用于监督学习的场景中。</li>
</ol>
</li>
<li>
<p>基于特征的知识：函数通过最小化教师模型和学生模型之间的特征激活差异来进行优化
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0205f2fc67d1407a99a9a69c5df0f1af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-u5Lq65LiJ562J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768561991&amp;x-signature=C%2FIo09BAggAnPASfJ03PAozST6k%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ol>
<li>核心定义：知识是教师模型<strong>中间层的特征表示</strong>，这些特征是模型对输入数据的 “抽象理解”</li>
<li>通俗理解：教师不仅告诉学生 “答案”，还把 “解题的草稿纸” 给学生看，让学生可以学习分析问题的关键步骤</li>
<li>迁移方式：选择教师与学生的<strong>对应中间层</strong>（需保证维度匹配，不匹配时用投影层转换），让学生的中间特征 对齐 教师的中间特征；</li>
<li>实现步骤拆解：
<ol>
<li>选定中间层：(目的：保证两者特征的语义层级一致)
<ol>
<li>选择方法：分层级(根据模型结构顺序分层级)和找对应(同结构对应比例，不同结构优先选输出维度相近 + 语义层级相近的层)</li>
<li>不用纠结 “选最准的层”，优先选<strong>中层</strong>（底层太简单、高层太接近输出层，中层的知识迁移性价比最高）；</li>
<li>若不确定，直接选模型的<strong>倒数第 3~ 第 5 层</strong>（大部分模型的核心语义都在这个区间）。</li>
</ol>
</li>
<li>提取中间特征：通俗理解就是使用一个钩子函数或者修改模型，让模型在前向传播的时候在你选定的中间层进行"拦截"，把中间层输出保存下来，不影响正常训练，只是从中间复制了一份数据。</li>
<li>特征维度匹配：加投影层
<ol>
<li>投影层的作用只有一个：解决师生特征 “维度不匹配” 的问题，本质是一个 “转换器”。</li>
<li>其实在 NLP 中就是加一个线性变换来改变维度，不破坏特征的语义信息。</li>
<li>此时结果就是教师模型中间层输出和学生模型中间层输出的维度是一致的</li>
</ol>
</li>
<li>计算损失并优化：使用表格中的损失函数，并使用方向传播进行训练即可</li>
<li>Gram 矩阵损失（Gram Matrix Loss）：
<ol>
<li>Gram 矩阵不关心特征的 “具体数值”，只关心 <strong>“特征内部不同部分的关联程度”</strong>。</li>
<li>提取教师和学生的<strong>中层隐藏特征</strong>：形状为<code>[批次大小, 序列长度, 隐藏层维度]</code>；</li>
<li>计算 Gram 矩阵：衡量 “词 A 的隐藏向量” 和 “词 B 的隐藏向量” 的相关性；</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li>
<p>基于关系的知识：突破了 “单样本知识” 的局限，关注教师模型对<strong>多个样本之间关系</strong>的理解
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/babc038ea54147f694c40c882e0b4de7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-u5Lq65LiJ562J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768561991&amp;x-signature=Ik7EpZDJxU%2BrLI2V27DP3He0VbE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ol>
<li>
<p>核心定义：知识不是单个样本的输出或特征，而是<strong>样本之间的相对关系</strong>，比如 “样本 A 和样本 B 的相似性高于样本 A 和样本 C”“样本 X 是样本 Y 的特例”。</p>
</li>
<li>
<p>通俗理解：教师教学生 “举一反三” 的能力，不是教学生 “这是猫”“那是狗”，而是教 “猫和老虎长得像，猫和狗长得不像”“波斯猫是猫的一种”。</p>
</li>
<li>
<p>迁移方式：构建样本组（对），让学生模型学到的样本间关系 与 教师模型一致；</p>
</li>
<li>
<p>优势：能传递 “泛化性知识”，解决小样本、细粒度分类等数据不足的问题。</p>
</li>
<li>
<p>实现步骤拆解：</p>
<ol>
<li>
<p>构建样本组：</p>
<ol>
<li>从批次中选子集构建 “样本对 / 样本组”，比如批次 B=8(批次是样本集)，选其中 4 个样本组成组(抽样)，计算两两之间的关系；</li>
<li>目的：让模型学习 “样本 A 和 B 像，A 和 C 不像” 这类相对关系。</li>
</ol>
</li>
<li>
<p>提取样本特征：方法同上，只是后续处理不太一致，一个是单个样本，一个是样本组，此时会得到教师模型的特征矩阵和学生模型的特征矩阵，计算矩阵距离，并训练让其距离拉近</p>
</li>
<li>
<p>计算关系矩阵：对教师 / 学生的样本特征，计算 “两两相似度矩阵”（比如余弦相似度），得到教师关系矩阵 (R_t)、学生关系矩阵 (R_s)；</p>
<ol>
<li>优先用<strong>余弦相似度</strong>（通用、鲁棒，大部分场景效果最好）；</li>
<li>如果特征已经做了归一化（比如用<code>F.normalize</code>），用<strong>点积相似度</strong>（计算更快，结果和余弦相似度一致）。</li>
</ol>





























<table><thead><tr><th>相似度方法</th><th>计算逻辑（通俗版）</th><th>适用场景</th><th>优点</th></tr></thead><tbody><tr><td>余弦相似度</td><td>衡量两个特征<strong>方向是否一致</strong>，不关心长度（比如特征 A=[1,2], 特征 B=[2,4]，方向相同，余弦相似度 = 1）</td><td>特征长度差异大的场景（如 NLP 的不同长度句子特征）</td><td>对特征缩放不敏感，通用型强</td></tr><tr><td>欧式距离（倒数）</td><td>衡量两个特征<strong>在空间中的直线距离</strong>，距离越小越相似（比如 A 和 B 坐标离得越近，越相似）</td><td>特征维度低、数值分布均匀的场景</td><td>计算简单，易于理解</td></tr><tr><td>点积相似度</td><td>衡量两个特征<strong>数值的乘积和</strong>，数值越大、对应维度越一致，相似度越高</td><td>特征已经归一化（长度为 1）的场景</td><td>计算速度最快，适合大规模样本</td></tr></tbody></table>
</li>
<li>
<p>计算损失并优化：用关系一致性损失 / 对比损失，让 (R_s) 逼近 (R_t)，仅更新学生参数。</p>
<ol>
<li>关系一致性损失（Relation Consistency Loss）：直接衡量教师和学生的<strong>样本关系矩阵</strong>的差异，让学生学到的 “样本间相似性” 和教师完全一致。
<ol>
<li>余弦相似度：<strong>只做 “关系描述”</strong>（比如 “学生 A 和 B 像，相似度 0.9”），是一个 “静态数值”，把 “特征矩阵” 转化为 “关系矩阵”，只做 “数值转换”，无优化能力</li>
<li>关系一致性损失：<strong>做 “关系优化”</strong>（衡量学生的描述和教师的描述差多少，再通过反向传播让学生修正），是一个 “动态优化过程”，通俗讲就是这一步开始对 1 中得到的关系矩阵进行处理，其实就是进行归一化后的 MSE</li>
<li>优化目标：让学生的<strong>关系矩阵数值</strong> 逐元素逼近教师，依赖教师的 “标准答案”（关系矩阵）</li>
<li>使用场景：有高性能教师模型的场景，追求 “学生完全复刻教师的关系判断”</li>
</ol>
</li>
<li>对比损失（Contrastive Loss ； 经典 InfoNCE 损失）：不直接匹配相似度数值，而是通过 “拉近同类样本、推远异类样本” 的方式(物理意义：让正样本对的相似度尽可能大，负样本对的相似度尽可能小。)，让学生学到教师的 “样本关系逻辑”，是更鲁棒的关系蒸馏方式。
<ol>
<li>优化目标：让学生学会 <strong>“同类样本更像，异类样本更不像”</strong> 的相对关系，不追求数值完全一致；不依赖教师，只依赖样本的类别标签（正样本 / 负样本）</li>
<li>使用场景：教师模型效果一般，或样本标签充足的场景，追求 “学生自主学习合理的样本关系”</li>
</ol>
</li>
<li>两种损失可以搭配使用
<ol>
<li>关系一致性损失保证学生 “复刻教师的经验”；</li>
<li>对比损失保证学生 “学习通用的关系逻辑”，避免过拟合到教师的误差</li>
<li>教师模型能力极强或者资源有限情况下不建议搭配使用</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<h2 data-id="heading-4">2 训练</h2>
<ol>
<li>离线蒸馏：离线蒸馏是最常见的方法，其中使用一个预训练的教师模型来指导学生模型。在这种方式中，教师模型首先在训练数据集上进行预训练，然后将教师模型中的知识蒸馏到学生模型中进行训练。
<ol>
<li>优缺点：
<ol>
<li>优点：教师性能稳定，学生的上限由教师决定；实现简单，工业界落地成熟。</li>
<li>缺点：需要分两步训练，耗时较长；教师一旦固定，无法在学生训练过程中优化。</li>
</ol>
</li>
<li>典型应用：
<ol>
<li>大模型轻量化：如用 GPT-3 蒸馏小尺寸 GPT、用 ResNet-152 蒸馏 ResNet-18；</li>
<li>特定任务优化：如用中文预训练大模型蒸馏小模型，适配移动端文本分类。</li>
</ol>
</li>
</ol>
</li>
<li>在线蒸馏：在离线蒸馏中，预训练的教师模型通常是一个高容量的深度神经网络。然而，在某些情况下，可能无法获得适用于离线蒸馏的预训练模型。为了解决这一局限性，可以使用在线蒸馏，在这种方法中，教师模型和学生模型在一个端到端的训练过程中同时更新。在线蒸馏可以通过并行计算实现，因此是一种高效的方法。
<ol>
<li>实现步骤：
<ol>
<li>初始化多个模型：通常初始化一组结构相同或相似的模型（如 3 个 ResNet-18），互为 “教师” 和 “学生”；</li>
<li>协同训练：每个模型在训练时，既作为 “学生” 学习其他模型的输出，也作为 “教师” 输出软标签指导其他模型；</li>
<li>动态更新：所有模型的参数都在训练中更新，没有固定的教师。</li>
</ol>
</li>
<li>优缺点：
<ol>
<li>优点：无需预训练教师，训练流程一步到位；教师动态更新，避免过拟合；多个模型协同，性能通常优于单模型。</li>
<li>缺点：训练时需要同时运行多个模型，显存占用高；超参数调优复杂。</li>
</ol>
</li>
<li>典型应用：
<ol>
<li>多模型集成系统：如推荐系统的多塔模型；</li>
<li>资源受限场景：如边缘设备的模型训练，无法承担预训练大模型的成本。</li>
</ol>
</li>
</ol>
</li>
<li>自蒸馏：在自蒸馏中，教师模型和学生模型使用相同的模型。例如，可以利用深层神经网络的深层激活值来训练浅层网络。这可以视为在线蒸馏的一种特殊情况，并可以通过多种方式实现。例如，教师模型在早期训练轮次的知识可以转移到其后期训练轮次中，用于训练学生模型。
<ol>
<li>最轻量化的蒸馏范式</li>
<li>两种实现方式：
<ol>
<li>基于时间的自蒸馏：用模型不同训练阶段的输出作为软标签</li>
<li>基于结构的自蒸馏	用模型不同部分的输出作为软标签</li>
</ol>
</li>
<li>优缺点：
<ol>
<li>优点：无额外教师开销，显存占用最低；训练流程简单，适合小模型和隐私保护场景（无需共享教师模型）；</li>
<li>缺点：性能上限受限于模型自身，无法超越单模型的最优性能；对训练超参数敏感。</li>
</ol>
</li>
<li>典型应用：
<ol>
<li>小模型性能提升：如移动端的轻量级 CNN 模型，通过自蒸馏提升分类精度；</li>
<li>隐私计算场景：如医疗数据训练，数据不能离开本地，无法训练独立教师模型。</li>
</ol>
</li>
</ol>
</li>
<li><strong>训练效率</strong>：自蒸馏 &gt; 在线蒸馏 &gt; 离线蒸馏（自蒸馏无需额外训练教师）；</li>
<li><strong>性能上限</strong>：离线蒸馏 &gt; 在线蒸馏 &gt; 自蒸馏（离线蒸馏可使用超大模型作为教师）。</li>
</ol>
<h2 data-id="heading-5">3 知识蒸馏的算法</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24b32417a6b14194b574ab2118ac7ad3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-u5Lq65LiJ562J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768561991&amp;x-signature=OsttwO5%2FGYyXtbTUWGg7%2FUwIkm4%3D" alt="在这里插入图片描述" loading="lazy"/></p>

































































<table><thead><tr><th>蒸馏方法</th><th>核心定位</th><th>关键创新点</th><th>典型应用</th></tr></thead><tbody><tr><td>对抗蒸馏</td><td>鲁棒性优化</td><td>引入 GAN 思想，让学生对抗性学习教师知识</td><td>噪声数据分类、防御对抗攻击(自动驾驶)</td></tr><tr><td>多教师蒸馏</td><td>知识融合</td><td>多个教师模型协同指导，集成互补知识</td><td>医疗影像诊断(高精度要求，小样本场景)</td></tr><tr><td>跨模态蒸馏</td><td>跨领域迁移</td><td>不同模态模型间传递知识（如视觉→文本）</td><td>图文检测，字幕生成，某一模态数据不足</td></tr><tr><td>图蒸馏</td><td>图结构适配</td><td>针对图神经网络（GNN）的拓扑 + 节点知识迁移</td><td>社交网络分析、分子属性预测</td></tr><tr><td>注意力蒸馏</td><td>结构对齐</td><td>迁移教师模型的注意力权重，复刻决策逻辑</td><td>大语言模型轻量化、机器翻译。细颗粒任务</td></tr><tr><td>无数据蒸馏</td><td>隐私保护</td><td>无需原始数据，通过生成数据传递知识</td><td>隐私敏感场景（医疗 / 金融）</td></tr><tr><td>量化蒸馏</td><td>硬件适配</td><td>结合模型量化，在压缩精度的同时保留性能</td><td>边缘设备部署（手机 / IoT）低资源情况</td></tr><tr><td>终身蒸馏</td><td>持续学习</td><td>模型在新任务上学习时，保留旧任务知识</td><td>机器人自主学习、推荐系统迭代</td></tr><tr><td>NAS 蒸馏</td><td>架构搜索</td><td>蒸馏指导神经架构搜索，高效生成最优小模型</td><td>自动化模型设计、低算力场景</td></tr></tbody></table>
<ol>
<li>
<p>对抗蒸馏：将<strong>对抗生成网络（GAN）</strong> 的思想融入蒸馏，通过 “生成器 - 判别器” 的博弈，让学生模型不仅学习教师的软标签，还能<strong>抵抗噪声和对抗样本</strong>，提升鲁棒性。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0191e21c7904bc0a57d5bd93625c055~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-u5Lq65LiJ562J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768561991&amp;x-signature=FGNubxzxY5F%2Blxf6ogSFjiBQzaw%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ol>
<li>实现流程：
<ol>
<li>使用干净数据和对抗数据训练判别器</li>
<li>使用教师模型生成干净数据</li>
<li>让学生模型去使用干净数据进行推理，得到结果后让判别器判断属于哪种数据(干净或者对抗)</li>
<li>学习干净数据的时候，可以使用教师模型的结果来优化，提高学生模型的精度</li>
<li>学习对抗数据的时候，精度提升了那对抗数据的结果也会提升，鲁棒性增强，判别器无法识别学生模型的输出到底是干净数据还是对抗数据</li>
<li>注：判别器只对输出数据进行判别，其实判别的是每个词向量位置，比如一个正常文本的词向量数值大小是不一样的，对抗数据就是不符合正常文本的向量值大小的，学生模型如何可以把这个位置对应的概率大小调整好，判别器就会认为这个文本是正常的。</li>
</ol>
</li>
</ol>
</li>
<li>
<p>多教师蒸馏：用<strong>多个不同的教师模型</strong>协同指导一个学生模型，融合多个教师的互补知识，避免单教师的局限性。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4a792752b5a4363bcc2fc9eb63a3ad6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-u5Lq65LiJ562J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768561991&amp;x-signature=cxxDGNQSJnj6unQxPLeaDuVgGuI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ol>
<li>教师选择策略：
<ol>
<li>同架构多教师：多个相同结构的模型，训练在不同数据子集上（如数据增强的不同版本）；</li>
<li>异架构多教师：不同结构的模型，覆盖不同的特征提取角度。</li>
</ol>
</li>
<li>知识加权策略：
<ol>
<li>加权平均：根据教师的性能权重，融合多个教师的软标签。</li>
<li>投票机制：对每个样本，取多个教师软标签的众数作为学生的学习目标；</li>
<li>分层融合：不同教师负责指导学生的不同中间层（如教师 A 指导低层特征，教师 B 指导高层特征）。</li>
</ol>
</li>
<li>离线蒸馏的模式，随机森林的思想。</li>
</ol>
</li>
<li>
<p>跨模态蒸馏：让不同模态的模型之间传递知识（如视觉模型→文本模型、语音模型→图像模型），实现跨领域的知识迁移。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d62f75d261214e78a76513eb63712490~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-u5Lq65LiJ562J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768561991&amp;x-signature=rnK7NkY2%2Bxpvrx137WPjiChSB3s%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ol>
<li>共享特征空间：通过一个映射层，将源模态（如图像）的特征和目标模态（如文本）的特征投影到同一空间；</li>
<li>对齐损失：让学生模型（目标模态）的特征与教师模型（源模态）的特征在共享空间中对齐。</li>
<li>离线蒸馏的模式，统一不同模态的信息，完成在统一态上的迁移</li>
</ol>
</li>
<li>
<p>图蒸馏：专门针对<strong>图神经网络（GNN）</strong> 设计的蒸馏方法，不仅迁移节点的特征知识，还迁移图的<strong>拓扑结构知识</strong>（如节点间的连接关系、子图的结构模式）。</p>
<ol>
<li>本人内容不涉及，不做详解</li>
</ol>
</li>
<li>
<p>注意力蒸馏：聚焦于迁移教师模型的<strong>注意力权重</strong>，让学生模型复刻教师的 “决策逻辑”—— 比如教师关注图像的哪个区域、文本的哪个词，而非仅学习输出层的软标签。</p>
<ol>
<li>获取注意力权重：类比上面"基于关系的知识"，区别在于这个蒸馏方法是针对样本，上面是针对样本组</li>
<li>蒸馏的损失设计：
<ol>
<li>直接匹配：学生的注意力矩阵与教师的注意力矩阵的 MSE 损失；</li>
<li>特征加权：用教师的注意力权重加权学生的中间特征，再计算与教师特征的</li>
</ol>
</li>
<li>通俗讲就是把教师模型的注意力权重附加到学生模型的特征向量，要一一对应，这样学生就知道了向量的重要程度</li>
</ol>
</li>
<li>
<p>无数据蒸馏：在<strong>没有原始训练数据</strong>的前提下，实现教师模型到学生模型的知识迁移，核心解决<strong>数据隐私和数据缺失</strong>的问题。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0df7c135ca23473aabfb18beb80cc9dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-u5Lq65LiJ562J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768561991&amp;x-signature=h0rfVJ3fFil13NUlNSxVfQt%2FqNs%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ol>
<li>生成伪数据
<ol>
<li>用教师模型指导一个生成器（如 GAN），生成能够激活教师模型关键特征的伪数据（如让教师输出高置信度的图像）；</li>
<li>伪数据的质量直接决定蒸馏效果。</li>
</ol>
</li>
<li>蒸馏流程：
<ol>
<li>生成器生成伪数据→输入教师模型，得到软标签；</li>
<li>学生模型学习伪数据和对应的软标签，无需接触原始数据。</li>
</ol>
</li>
<li>离线蒸馏模式</li>
</ol>
</li>
<li>
<p>量化蒸馏：将<strong>模型量化</strong>与知识蒸馏结合，在把模型权重从高精度（如 FP32）压缩到低精度（如 INT8、INT4）的同时，通过蒸馏弥补量化带来的性能损失。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b4186eb4a324b9daa09b55036577a65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-u5Lq65LiJ562J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768561991&amp;x-signature=6bWPFaKl282xPP1x43i619rx%2B%2FY%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ol>
<li>量化的核心问题：低精度量化会导致权重信息丢失，模型精度下降；</li>
<li>通过蒸馏进行补偿的策略：
<ol>
<li>教师：高精度的原始模型（FP32）；</li>
<li>学生：量化后的低精度模型（INT8）；</li>
<li>蒸馏目标：让量化学生的输出与高精度教师的输出对齐，同时优化量化误差。</li>
</ol>
</li>
<li>QAT：在<strong>训练过程中就模拟量化的误差</strong>，让模型提前适应低精度，最终量化后的精度损失大幅降低。
<ol>
<li>通俗讲并不是学生就一直用低精度来训练，而是在量化 / 反量化节点降低精确度进行训练，这样就可以让模型感受到丢失精确度带来的影响，从而降低这部分影响</li>
</ol>
</li>
</ol>
</li>
<li>
<p>终身蒸馏：也叫<strong>持续学习蒸馏</strong>，解决模型在<strong>连续学习新任务</strong>时的 “灾难性遗忘” 问题 —— 让模型在学习新任务知识的同时，通过蒸馏保留旧任务的知识。</p>
<ol>
<li>特有机制：
<ol>
<li><strong>知识回放</strong>（Replay）：训练新任务时，每隔 epoch 回放缓存的旧任务样本，让学生同时学新旧任务；</li>
<li><strong>弹性权重固化（EWC）</strong>：对旧任务重要的参数 “加权重惩罚”，避免新任务训练时修改这些参数（比如识别猫的参数，学狗时不被篡改）。</li>
</ol>
</li>
<li>知识缓存机制
<ol>
<li>学习新任务时，缓存旧任务的关键样本和教师模型（旧任务的最优模型）；</li>
<li>新任务的学生模型同时学习：① 新任务的硬标签；② 旧任务教师模型的软标签。</li>
</ol>
</li>
<li>增量蒸馏策略
<ol>
<li>每次学习新任务后，更新教师模型为 “新旧任务融合的模型”；</li>
<li>后续任务的学生模型，始终学习最新的教师模型知识。</li>
</ol>
</li>
</ol>
</li>
<li>
<p>NAS蒸馏：将<strong>知识蒸馏与神经架构搜索（NAS）</strong> 结合，用教师模型的知识来指导 NAS 算法，高效搜索出性能接近教师、且计算量极小的学生模型架构</p>
<ol>
<li>一种可以自动选择最优学生模型的算法。</li>
</ol>
</li>
<li>
<p>方法选择：</p>
<ol>
<li><strong>看数据条件</strong>：数据隐私→无数据蒸馏；数据多模态→跨模态蒸馏；</li>
<li><strong>看模型架构</strong>：图结构→图蒸馏；Transformer→注意力蒸馏；</li>
<li><strong>看部署需求</strong>：边缘设备→量化蒸馏；自动化设计→NAS 蒸馏；</li>
<li><strong>看任务特性</strong>：持续学习→终身蒸馏；鲁棒性要求→对抗蒸馏；高精度要求→多教师蒸馏。</li>
<li>常用程度：注意力蒸馏 / 量化蒸馏 / 多教师蒸馏 &gt; 跨模态蒸馏 &gt; 对抗 / 无数据 / 图 / 终身 / NAS 蒸馏；</li>
</ol>
</li>
</ol>
<h3 data-id="heading-6">参考</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fu012347027%2Farticle%2Fdetails%2F111415197" target="_blank" title="https://blog.csdn.net/u012347027/article/details/111415197" ref="nofollow noopener noreferrer">1</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fa131529%2Farticle%2Fdetails%2F144582677" target="_blank" title="https://blog.csdn.net/a131529/article/details/144582677" ref="nofollow noopener noreferrer">2</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 如何准确判断数据类型？5 种方法深度对比]]></title>    <link>https://juejin.cn/post/7593139476840841222</link>    <guid>https://juejin.cn/post/7593139476840841222</guid>    <pubDate>2026-01-09T11:31:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593139476840841222" data-draft-id="7582785032852504639" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 如何准确判断数据类型？5 种方法深度对比"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-09T11:31:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员大华"/> <meta itemprop="url" content="https://juejin.cn/user/3507878440995946"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 如何准确判断数据类型？5 种方法深度对比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3507878440995946/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员大华
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T11:31:57.000Z" title="Fri Jan 09 2026 11:31:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在写js的时候，很容易因为数据类型没判断好而出错，比如这样的代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">calculate</span>(<span class="hljs-params">a, b</span>) {
    <span class="hljs-keyword">return</span> a + b;
}
<span class="hljs-comment">// 我以为是 10 + 20 = 30</span>
<span class="hljs-title function_">calculate</span>(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>); <span class="hljs-comment">// 结果 30 对的 </span>

<span class="hljs-comment">// 实际上用户输入的是字符串和数字</span>
<span class="hljs-title function_">calculate</span>(<span class="hljs-string">"10"</span>, <span class="hljs-number">20</span>); <span class="hljs-comment">// 结果为 "1020" </span>
</code></pre>
<p>所以为了避免这种情况的出现，我们还是要去判断好数据类型。</p>
<p>在<code>JavaScript</code>中，有几种方式来判断数据类型，以下是常用的方法：</p>
<h2 data-id="heading-0">1. typeof 操作符</h2>
<p>最常用的类型判断方法，但有一些局限性：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">typeof</span> <span class="hljs-number">42</span>;           <span class="hljs-comment">// "number"</span>
<span class="hljs-keyword">typeof</span> <span class="hljs-string">"hello"</span>;      <span class="hljs-comment">// "string"</span>
<span class="hljs-keyword">typeof</span> <span class="hljs-literal">true</span>;         <span class="hljs-comment">// "boolean"</span>
<span class="hljs-keyword">typeof</span> <span class="hljs-literal">undefined</span>;    <span class="hljs-comment">// "undefined"</span>
<span class="hljs-keyword">typeof</span> <span class="hljs-literal">null</span>;         <span class="hljs-comment">// "object" (历史遗留问题)</span>
<span class="hljs-keyword">typeof</span> {};           <span class="hljs-comment">// "object"</span>
<span class="hljs-keyword">typeof</span> [];           <span class="hljs-comment">// "object"</span>
<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"/>){}; <span class="hljs-comment">// "function"</span>
<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Symbol</span>();     <span class="hljs-comment">// "symbol"</span>
<span class="hljs-keyword">typeof</span> <span class="hljs-number">42n</span>;          <span class="hljs-comment">// "bigint"</span>
</code></pre>
<p><strong>局限性</strong>：</p>
<ul>
<li>无法区分数组、对象和 <code>null</code></li>
<li>函数返回 <code>function</code></li>
<li><code>typeof</code> 适合判断基本类型，但遇到对象类型就力不从心了</li>
</ul>
<hr/>
<h2 data-id="heading-1">2. instanceof 操作符</h2>
<p>用于检测构造函数的 <code>prototype</code> 属性是否出现在对象的原型链中：</p>
<pre><code class="hljs language-javascript" lang="javascript">[] <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Array</span>;           <span class="hljs-comment">// true</span>
{} <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Object</span>;          <span class="hljs-comment">// true</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>() <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Date</span>;    <span class="hljs-comment">// true</span>
<span class="hljs-keyword">function</span>(<span class="hljs-params"/>){} <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Function</span>; <span class="hljs-comment">// true</span>

<span class="hljs-comment">// 继承关系，数组也是对象</span>
[] <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Object</span>;          <span class="hljs-comment">// true</span>
</code></pre>
<p><code>instanceof</code> 的局限性：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 基本类型用不了</span>
<span class="hljs-number">42</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Number</span>;          <span class="hljs-comment">// false</span>
<span class="hljs-string">"hello"</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">String</span>;     <span class="hljs-comment">// false</span>
</code></pre>
<p>在跨 <code>iframe</code> 或不同 <code>window</code> 环境下可能失效（因为构造函数不同）</p>
<hr/>
<h2 data-id="heading-2">3. Object.prototype .toString.call()</h2>
<p>这是最准确、最可靠的方法,能识别所有内置类型！</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(<span class="hljs-number">42</span>);           <span class="hljs-comment">// "[object Number]"</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(<span class="hljs-string">"hello"</span>);      <span class="hljs-comment">// "[object String]"</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(<span class="hljs-literal">true</span>);         <span class="hljs-comment">// "[object Boolean]"</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(<span class="hljs-literal">null</span>);         <span class="hljs-comment">// "[object Null]"</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(<span class="hljs-literal">undefined</span>);    <span class="hljs-comment">// "[object Undefined]"</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>([]);           <span class="hljs-comment">// "[object Array]"</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>({});           <span class="hljs-comment">// "[object Object]"</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>){}); <span class="hljs-comment">// "[object Function]"</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(<span class="hljs-title class_">Symbol</span>());     <span class="hljs-comment">// "[object Symbol]"</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(<span class="hljs-number">42n</span>);          <span class="hljs-comment">// "[object BigInt]"</span>
</code></pre>
<p>我们封装一个实用的工具函数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getRealType</span>(<span class="hljs-params">value</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(value)
        .<span class="hljs-title function_">slice</span>(<span class="hljs-number">8</span>, -<span class="hljs-number">1</span>)          <span class="hljs-comment">// 截取"[object "和"]"之间的内容</span>
        .<span class="hljs-title function_">toLowerCase</span>();         <span class="hljs-comment">// 转为小写，更友好</span>
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">getRealType</span>([]));        <span class="hljs-comment">// "array"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">getRealType</span>(<span class="hljs-literal">null</span>));      <span class="hljs-comment">// "null"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">getRealType</span>({}));        <span class="hljs-comment">// "object"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">getRealType</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>())); <span class="hljs-comment">// "date"</span>
</code></pre>
<hr/>
<h2 data-id="heading-3">4. 专用方法</h2>
<p>对于一些特殊类型，JavaScript提供了专门的判断方法：</p>
<h3 data-id="heading-4">判断数组：Array.isArray()</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>([]);     <span class="hljs-comment">// true</span>
<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>({});     <span class="hljs-comment">// false</span>
<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(<span class="hljs-string">"123"</span>);  <span class="hljs-comment">// false</span>
</code></pre>
<h3 data-id="heading-5">判断NaN：Number.isNaN()</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 注意区别！</span>
<span class="hljs-built_in">isNaN</span>(<span class="hljs-string">"hello"</span>);        <span class="hljs-comment">// true  ← 字符串不是数字，但这样判断容易误解</span>
<span class="hljs-title class_">Number</span>.<span class="hljs-built_in">isNaN</span>(<span class="hljs-string">"hello"</span>); <span class="hljs-comment">// false ← 更准确：只有真正的NaN才返回true</span>
<span class="hljs-title class_">Number</span>.<span class="hljs-built_in">isNaN</span>(<span class="hljs-title class_">NaN</span>);     <span class="hljs-comment">// true</span>
</code></pre>
<h3 data-id="heading-6">判断有限数字：Number.isFinite()</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Number</span>.<span class="hljs-built_in">isFinite</span>(<span class="hljs-number">42</span>);     <span class="hljs-comment">// true</span>
<span class="hljs-title class_">Number</span>.<span class="hljs-built_in">isFinite</span>(<span class="hljs-title class_">Infinity</span>); <span class="hljs-comment">// false  ← 无穷大不是有限数字</span>
<span class="hljs-title class_">Number</span>.<span class="hljs-built_in">isFinite</span>(<span class="hljs-string">"42"</span>);   <span class="hljs-comment">// false  ← 字符串不是数字</span>
</code></pre>
<h2 data-id="heading-7">编写健壮的函数</h2>
<p>在实际开发中的应用：</p>
<h3 data-id="heading-8">场景1：安全的数字相加</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">safeAdd</span>(<span class="hljs-params">a, b</span>) {
    <span class="hljs-comment">// 确保两个参数都是数字类型</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> a !== <span class="hljs-string">'number'</span> || <span class="hljs-keyword">typeof</span> b !== <span class="hljs-string">'number'</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'参数必须是数字'</span>);
    }
    <span class="hljs-keyword">return</span> a + b;
}

<span class="hljs-title function_">safeAdd</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);     <span class="hljs-comment">// 3</span>
<span class="hljs-title function_">safeAdd</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"2"</span>);   <span class="hljs-comment">// 报错：参数必须是数字</span>
</code></pre>
<h3 data-id="heading-9">场景2：处理多种数据类型</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">processData</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-comment">// getRealType方法在第3点Object.prototype.toString.call()中有写</span>
    <span class="hljs-keyword">const</span> type = <span class="hljs-title function_">getRealType</span>(data); 
    
    <span class="hljs-keyword">switch</span>(type) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">'array'</span>:
            <span class="hljs-keyword">return</span> data.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item * <span class="hljs-number">2</span>);
        <span class="hljs-keyword">case</span> <span class="hljs-string">'object'</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(data).<span class="hljs-property">length</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'string'</span>:
            <span class="hljs-keyword">return</span> data.<span class="hljs-title function_">toUpperCase</span>();
        <span class="hljs-keyword">case</span> <span class="hljs-string">'number'</span>:
            <span class="hljs-keyword">return</span> data * <span class="hljs-number">2</span>;
        <span class="hljs-attr">default</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">'不支持的数据类型'</span>;
    }
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">processData</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]));    <span class="hljs-comment">// [2, 4, 6]</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">processData</span>(<span class="hljs-string">"hello"</span>));      <span class="hljs-comment">// "HELLO"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">processData</span>({<span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">2</span>})); <span class="hljs-comment">// 2</span>
</code></pre>
<h2 data-id="heading-10">总结：选择合适的方法</h2>



































<table><thead><tr><th>场景</th><th>推荐方法</th><th>示例</th></tr></thead><tbody><tr><td>判断基本类型</td><td><code>typeof</code></td><td><code>typeof "hello" === "string"</code></td></tr><tr><td>判断数组</td><td><code>Array.isArray()</code></td><td><code>Array.isArray([])</code></td></tr><tr><td>判断自定义对象</td><td><code>instanceof</code></td><td><code>obj instanceof MyClass</code></td></tr><tr><td>精确类型判断</td><td><code>Object.prototype.toString.call()</code></td><td>见上文工具函数</td></tr><tr><td>特殊值判断</td><td>专用方法</td><td><code>Number.isNaN()</code>, <code>Number.isFinite()</code></td></tr></tbody></table>
<blockquote>
<p>本文首发于公众号：程序员大华，专注分享前后端开发的实战笔记。关注我，少走弯路，一起进步！</p>
</blockquote>
<h4 data-id="heading-11">📌往期精彩</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FUqzEppE_f8gdil6S-toBTg" target="_blank" title="https://mp.weixin.qq.com/s/UqzEppE_f8gdil6S-toBTg" ref="nofollow noopener noreferrer">写前端久了，我用 Node.js 给自己造了几个省力小工具</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FF4JkmYxUs9RAtsti6V1uhg" target="_blank" title="https://mp.weixin.qq.com/s/F4JkmYxUs9RAtsti6V1uhg" ref="nofollow noopener noreferrer">我也是写了很久 TypeScript，才意识到这些写法不对</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F2wHCiqgtRfK_008fLBamPQ" target="_blank" title="https://mp.weixin.qq.com/s/2wHCiqgtRfK_008fLBamPQ" ref="nofollow noopener noreferrer">ThreadLocal 在实际项目中的 6 大用法，原来可以这么简单</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FsMAKhSLNvmU1ddxg0yv9Fg" target="_blank" title="https://mp.weixin.qq.com/s/sMAKhSLNvmU1ddxg0yv9Fg" ref="nofollow noopener noreferrer">重构了20个SpringBoot项目后，总结出这套稳定高效的架构设计</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS 特殊符号 / 英文导致换行问题速查表]]></title>    <link>https://juejin.cn/post/7593077945016221723</link>    <guid>https://juejin.cn/post/7593077945016221723</guid>    <pubDate>2026-01-09T10:02:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593077945016221723" data-draft-id="7593169840199794714" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS 特殊符号 / 英文导致换行问题速查表"/> <meta itemprop="keywords" content="CSS"/> <meta itemprop="datePublished" content="2026-01-09T10:02:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="卡尔特斯"/> <meta itemprop="url" content="https://juejin.cn/user/4450440831840909"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS 特殊符号 / 英文导致换行问题速查表
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4450440831840909/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    卡尔特斯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T10:02:55.000Z" title="Fri Jan 09 2026 10:02:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、最推荐通用写法（90% 场景）</h2>
<pre><code class="hljs language-arduino" lang="arduino">.text {
  <span class="hljs-type">word</span>-<span class="hljs-keyword">break</span>: normal;
  overflow-wrap: <span class="hljs-keyword">break</span>-<span class="hljs-type">word</span>;
  white-space: normal;
}
</code></pre>
<p><strong>适用：</strong></p>
<ul>
<li>中文 + 英文混排</li>
<li>URL / 特殊符号</li>
<li>不希望英文被拆成字母</li>
</ul>
<hr/>
<h2 data-id="heading-1">二、常见需求对应写法</h2>
<blockquote>
<p>以下场景覆盖：<strong>不拆单词 / 允许拆单词 / 特殊符号提前换行</strong> 等真实业务需求</p>
</blockquote>
<h3 data-id="heading-2">1️⃣ 不希望单词被拆开</h3>
<pre><code class="hljs language-arduino" lang="arduino">.text {
  <span class="hljs-type">word</span>-<span class="hljs-keyword">break</span>: normal;
  overflow-wrap: normal;
}
</code></pre>
<hr/>
<h3 data-id="heading-3">2️⃣ 单词太长允许必要时换行（推荐）</h3>
<pre><code class="hljs language-arduino" lang="arduino">.text {
  overflow-wrap: <span class="hljs-keyword">break</span>-<span class="hljs-type">word</span>;
  <span class="hljs-type">word</span>-<span class="hljs-keyword">break</span>: normal;
}
</code></pre>
<hr/>
<h3 data-id="heading-4">3️⃣ 特殊符号（<code>- _ / .</code>）导致断行</h3>
<pre><code class="hljs language-arduino" lang="arduino">.text {
  <span class="hljs-type">word</span>-<span class="hljs-keyword">break</span>: keep-all;
  overflow-wrap: <span class="hljs-keyword">break</span>-<span class="hljs-type">word</span>;
}
</code></pre>
<hr/>
<h3 data-id="heading-5">4️⃣ 完全不换行（一行显示）</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.text</span> {
  <span class="hljs-attribute">white-space</span>: nowrap;
}
</code></pre>
<hr/>
<h3 data-id="heading-6">5️⃣ 一行显示，超出省略号</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.text</span> {
  <span class="hljs-attribute">white-space</span>: nowrap;
  <span class="hljs-attribute">overflow</span>: hidden;
  <span class="hljs-attribute">text-overflow</span>: ellipsis;
}
</code></pre>
<hr/>
<h3 data-id="heading-7">6️⃣ URL / 长链接优雅断行</h3>
<pre><code class="hljs language-arduino" lang="arduino">.text {
  <span class="hljs-type">word</span>-<span class="hljs-keyword">break</span>: normal;
  overflow-wrap: anywhere;
}
</code></pre>
<hr/>
<h3 data-id="heading-8">7️⃣ 代码 / hash / token 强制断行</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.code</span> {
  <span class="hljs-attribute">word-break</span>: break-all;
  <span class="hljs-attribute">font-family</span>: monospace;
}
</code></pre>
<hr/>
<h3 data-id="heading-9">8️⃣ <strong>明确接受单词被拆开（强制任何位置换行）</strong></h3>
<pre><code class="hljs language-arduino" lang="arduino">.text {
  <span class="hljs-type">word</span>-<span class="hljs-keyword">break</span>: <span class="hljs-keyword">break</span>-all;
}
</code></pre>
<p><strong>适用：</strong></p>
<ul>
<li>日志内容</li>
<li>长 hash / token / ID</li>
<li>空间极窄但必须完整展示</li>
</ul>
<p>⚠️ 英文会被拆成字母，属于<strong>主动选择的行为</strong></p>
<hr/>
<h3 data-id="heading-10">9️⃣ <strong>特殊符号导致“提前换行”（如 <code>- / _ .</code>）</strong></h3>
<pre><code class="hljs language-arduino" lang="arduino">.text {
  <span class="hljs-type">word</span>-<span class="hljs-keyword">break</span>: normal;
  overflow-wrap: normal;
}
</code></pre>
<p><strong>说明：</strong></p>
<ul>
<li>禁止在符号处断行</li>
<li>让浏览器只在真正需要时换行</li>
</ul>
<hr/>
<h3 data-id="heading-11">🔟 <strong>允许在特殊符号处优先换行（比拆字母更友好）</strong></h3>
<pre><code class="hljs language-arduino" lang="arduino">.text {
  overflow-wrap: anywhere;
  <span class="hljs-type">word</span>-<span class="hljs-keyword">break</span>: normal;
}
</code></pre>
<p><strong>适用：</strong></p>
<ul>
<li>URL / 路径</li>
<li><code>aaa-bbb-ccc-ddd</code></li>
<li>希望优先在符号处分行，而不是字母中间</li>
</ul>
<pre><code class="hljs language-yaml" lang="yaml">
<span class="hljs-meta">---
</span>
<span class="hljs-comment">## 三、Flex / Table 常见坑</span>

<span class="hljs-comment">### flex 子项内容被异常换行</span>

<span class="hljs-string">```css</span>
<span class="hljs-string">.item</span> {
  <span class="hljs-attr">min-width:</span> <span class="hljs-number">0</span><span class="hljs-string">;</span>
  <span class="hljs-attr">overflow-wrap:</span> <span class="hljs-string">break-word;</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-12">四、不推荐写法（慎用）</h2>
<blockquote>
<p>⚠️ 以下写法不是不能用，而是<strong>必须明确知道后果</strong></p>
</blockquote>
<pre><code class="hljs language-kotlin" lang="kotlin">word-<span class="hljs-keyword">break</span>: <span class="hljs-keyword">break</span>-all;
</code></pre>
<p>❌ 会把英文拆成字母，仅适合日志 / code 场景</p>
<hr/>
<h2 data-id="heading-13">五、属性速记表</h2>





















<table><thead><tr><th>属性</th><th>作用</th></tr></thead><tbody><tr><td><code>word-break</code></td><td>是否允许在单词内部断行</td></tr><tr><td><code>overflow-wrap</code></td><td>单词太长时是否允许换行（⭐推荐）</td></tr><tr><td><code>white-space</code></td><td>是否允许换行</td></tr></tbody></table>
<hr/>
<p>📌 <strong>记住一句话：</strong></p>
<blockquote>
<p><strong>优先用 <code>overflow-wrap: break-word</code>，避免 <code>word-break: break-all</code></strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用changeset来管理你的npm包版本]]></title>    <link>https://juejin.cn/post/7593139476840611846</link>    <guid>https://juejin.cn/post/7593139476840611846</guid>    <pubDate>2026-01-09T10:05:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593139476840611846" data-draft-id="7593098101432238134" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用changeset来管理你的npm包版本"/> <meta itemprop="keywords" content="前端,NPM"/> <meta itemprop="datePublished" content="2026-01-09T10:05:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="稀饭52"/> <meta itemprop="url" content="https://juejin.cn/user/2313028196632446"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用changeset来管理你的npm包版本
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2313028196632446/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    稀饭52
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T10:05:48.000Z" title="Fri Jan 09 2026 10:05:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"/>
<p>简单介绍下，changeset是一个版本管理和生成更新日志的工具，超级适用于多包仓库，比如monorepo，可以在提交发布时，自动更新所有包的版本号，创建Tag，并且生成更新日志。</p>
<h3 data-id="heading-1">一、安装</h3>
<p>进入项目之后执行命令，安装changeset，并且初始化</p>
<pre><code class="hljs language-bash" lang="bash"> pnpm add -D @changesets/cli
 pnpm changeset init
</code></pre>
<p>执行完之后，在项目中会新增一个<code>.changeset</code>目录，用于存放配置文件和<strong>临时的版本变更描述文件</strong>。</p>
<pre><code class="hljs language-txt" lang="txt">.changeset/
 ├─ config.json
 └─ README.md
</code></pre>
<h3 data-id="heading-2">二、使用流程</h3>
<p>在通用的版本管理流程中，通常会区分为：</p>
<ul>
<li><strong>预发布版本</strong>（如alpha和beta）</li>
<li><strong>正式版本</strong></li>
</ul>
<h4 data-id="heading-3">预发布版本</h4>
<p>预发布阶段的两级为alpha和beta，下面是大致区别：</p>



































<table><thead><tr><th align="left">维度</th><th>alpha（内测）</th><th>beta（公测）</th></tr></thead><tbody><tr><td align="left"><strong>代码稳定性</strong></td><td>随时可能大改</td><td>功能基本锁定，不会有大的调整</td></tr><tr><td align="left"><strong>测试人群</strong></td><td>团队内部</td><td>灰度用户</td></tr><tr><td align="left"><strong>发布频率</strong></td><td>每天/每周都能出包</td><td>节奏稍慢，某个阶段的版本</td></tr><tr><td align="left"><strong>版本号示例</strong></td><td>1.0.0-alpha.0 ➜ 1.0.0-alpha.1 …</td><td>1.0.0-beta.0 ➜ 1.0.0-beta.1 …</td></tr><tr><td align="left"><strong>退出条件</strong></td><td>达到功能完备 → 进入beta</td><td>连续几天无阻塞Bug → 发布正式版</td></tr></tbody></table>
<p>相关命令：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm changeset pre enter alpha   <span class="hljs-comment"># 进入alpha模式,</span>
pnpm changeset version          <span class="hljs-comment"># 版本变成0.0.1-alpha.0</span>

pnpm changeset pre enter beta   <span class="hljs-comment"># 进入beta模式</span>
pnpm changeset version          <span class="hljs-comment"># 版本变成0.0.1-beta.0</span>

<span class="hljs-comment"># 结束预发布</span>
pnpm changeset pre <span class="hljs-built_in">exit</span>
pnpm changeset version          <span class="hljs-comment"># 版本变成0.0.1</span>
</code></pre>
<h4 data-id="heading-4">正式版本</h4>
<p>当你完成某个包的开发，准备发版时，执行：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm changeset
</code></pre>
<p>如果是多包仓库，终端会出现一个选择框，让你选择改过的包，</p>
<ol>
<li>
<p>按空格选中你改过的包（有星号就算选中）→ 回车，</p>
</li>
<li>
<p>选包的更新级别，会依次出现major和minor，回车到下一步，如果都没选中，就默认为patch，输入本次更新的描述回车</p>
<ul>
<li>patch：修复小bug（1.0.0→1.0.1）</li>
<li>minor：添加新功能（1.0.0→1.1.0）</li>
<li>major：破坏性的大版本调整，api级别的调整（1.0.0→2.0.0）</li>
</ul>
</li>
</ol>
<p>单包仓库就直接到了选择更新级别这一步，同样是输入描述，然后回车；</p>
<p>生成版本号，执行：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm changeset version
</code></pre>
<p>你会发现<code>.changeset</code>文件夹中刚才生成的md文件都已经不见了，版本号也升好了。</p>
<h4 data-id="heading-5">发布</h4>
<ul>
<li>登录npm</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">npm login
</code></pre>
<ul>
<li>发版</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">pnpm changeset publish
</code></pre>
<p>成功后，会在git创建对应的git tag，终端会给出每个包的版本号和 npm链接。</p>
<h3 data-id="heading-6">三、changeset总结</h3>
<p>最后总结下，对changeset的整体感觉</p>
<h4 data-id="heading-7">优点</h4>
<ol>
<li>版本语义化，显式标注变更级别</li>
<li>每一次变更都会新建个文件，方便review
<ul>
<li>列出受影响的包</li>
<li>变更的级别，patch/minor/major</li>
<li>变更的内容</li>
</ul>
</li>
<li>自动生成tag、版本号changelog</li>
<li>Monorepo依赖的自动推导，比如修改了a包，b包依赖了a包，那么b包也会更新版本</li>
</ol>
<h4 data-id="heading-8">缺点</h4>
<ol>
<li>会有额外心智负担，
<ul>
<li>每次变更都要执行changeset，会增加操作流程（其实我觉得这个不能算）</li>
<li>思考版本类型</li>
<li>流程容易漏</li>
</ul>
</li>
<li>单包项目有点多余，没完全发挥作用</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Switch2Antigravity: 让 IntelliJ IDEA 与 Antigravity 无缝协作]]></title>    <link>https://juejin.cn/post/7593181244708519988</link>    <guid>https://juejin.cn/post/7593181244708519988</guid>    <pubDate>2026-01-09T09:53:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593181244708519988" data-draft-id="7593173569871380532" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Switch2Antigravity: 让 IntelliJ IDEA 与 Antigravity 无缝协作"/> <meta itemprop="keywords" content="VibeCoding,IntelliJ IDEA,程序员"/> <meta itemprop="datePublished" content="2026-01-09T09:53:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="PPPHUANG"/> <meta itemprop="url" content="https://juejin.cn/user/3083464300298525"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Switch2Antigravity: 让 IntelliJ IDEA 与 Antigravity 无缝协作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3083464300298525/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    PPPHUANG
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T09:53:31.000Z" title="Fri Jan 09 2026 09:53:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>Antigravity</strong> 是一款“以智能体为主”的平台。它预设 AI 不仅是编写代码的工具，而且是能够规划、执行、验证和迭代复杂工程任务的自主行动者，几乎无需人工干预。随着 <strong>Gemini 3</strong> 的发布 Antigravity 在 vibe coding 领域火的一塌糊涂。</p>
<p>在日常开发中，经常在 <strong>IntelliJ IDEA</strong> (强大的 Java/Kotlin 静态分析与重构能力) 和 <strong>Antigravity</strong> (流畅的 AI 辅助编码体验) 之间切换。</p>
<p>为了解决两个编辑器之间频繁“手动定位文件”的痛点，我开发了一个 IntelliJ IDEA 插件 —— <strong>Switch2Antigravity</strong>，搭配 vs code 的 <strong>Switch2IDEA</strong> 插件让 IntelliJ IDEA 与 Antigravity 无缝协作。</p>
<h2 data-id="heading-0"><strong>✨ 核心功能</strong></h2>
<p>这个插件的核心目标只有一个：<strong>Context Switching Costs Null (让上下文切换零成本)</strong>。</p>
<ul>
<li>
<p><strong>⚡ 一键跳转</strong>: 在 IDEA 中按下 <code>Shift + Alt + A</code>，当前编辑的文件会立即在 Antigravity 中打开。也可以在文件或者文件夹上点击右键 <code>Open in Antigravity</code>。</p>
</li>
<li>
<p><strong>📍 精准定位</strong>: 不仅仅是打开文件，它会自动带你到<strong>光标所在的具体行和列</strong>。无缝衔接你的思维流。</p>
</li>
<li>
<p><strong>🛠️ 智能配置</strong>:</p>
<ul>
<li>自动检测系统中的 Antigravity 安装路径 (支持 Windows <code>where</code> 和 Mac/Linux <code>which</code> 探测)。</li>
<li>支持在设置页面自定义可执行文件路径。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-1"><strong>🔧 技术实现亮点</strong></h2>
<p>基于 IntelliJ Platform SDK 和 Kotlin 开发，虽然功能简单，但细节满满。</p>
<h3 data-id="heading-2"><strong>1. 跨平台启动命令</strong></h3>
<p>不同系统的启动参数略有不同，为了保证稳定性，我们使用了原生的 CLI 调用方式而不是 URL Scheme。</p>
<h3 data-id="heading-3"><strong>2. 智能路径探测</strong></h3>
<p>很多同学的安装路径各不相同，我们在 <code>OpenInAntigravityAction</code> 中实现了多级探测策略：</p>
<ol>
<li><strong>用户配置优先</strong>: 检查插件设置中是否指定了路径。</li>
<li><strong>PATH 环境变量</strong>: 遍历 PATH 查找 <code>antigravity</code>。</li>
<li><strong>System Command</strong>: 尝试执行 <code>where antigravity</code> (Win) 或 <code>which antigravity</code> (Mac) 获取真实路径。</li>
<li><strong>默认路径兜底</strong>: 检查常见的默认安装位置 (如 <code>AppData</code>, <code>/Applications</code> 等)。</li>
</ol>
<h2 data-id="heading-4"><strong>🤯 Inception：用 Antigravity 开发 Antigravity 插件</strong></h2>
<p>更有趣的是，<strong>这个插件本身就是完全使用 Antigravity 辅助开发的</strong>。</p>
<p>从最初的 Gradle 脚本配置、Kotlin 逻辑实现，到复杂的 SVG 图标生成脚本，甚至是 solving 各种环境兼容性 bug，全过程都是在 Antigravity 的 AGENTIC 模式下完成的。</p>
<ul>
<li><strong>需求理解</strong>: 我只需要输入 "帮我搞个 IDEA 插件，能跳转到 Antigravity"，它就自动规划了 <code>plugin.xml</code> 和 Action 的结构。</li>
<li><strong>代码生成</strong>: 自动补全了复杂的 PSI 和 ActionSystem 相关代码。</li>
<li><strong>Debug</strong>: 遇到 Mac 下 <code>open</code> 命令参数问题，它迅速给出了 <code>ProcessBuilder</code> 的 CLI 替代方案。</li>
<li><strong>文案创作</strong>: 你正在看的这篇博客，也是它写的！</li>
</ul>
<p>这不仅是一个工具的集成，更是一次 <strong>AI Native 开发流程</strong> 的最佳实践。</p>
<h2 data-id="heading-5"><strong>📦 如何安装</strong></h2>
<p>插件上架 JetBrains Marketplace， 编辑器 JetBrains Marketplace 中搜索安装。</p>
<p>手动安装</p>
<ol>
<li>Clone 本项目源码。</li>
<li>运行 <code>./gradlew buildPlugin</code>。</li>
<li>在 IDEA 中选择 "Install Plugin from Disk"，选中 <code>build/distributions/</code> 下生成的 Zip 包即可。</li>
</ol>
<h2 data-id="heading-6"><strong>🔗 开源地址</strong></h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FPPPHUANG%2Fidea-antigravity-plugin" target="_blank" title="https://github.com/PPPHUANG/idea-antigravity-plugin" ref="nofollow noopener noreferrer">github.com/PPPHUANG/id…</a></p>
<hr/>
<p><em>Happy Coding with IDEA &amp; Antigravity!</em></p>
<p>公众号：<strong>DailyHappy</strong> 一位后端写码师，一位黑暗料理制造者。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于 Angular UI 的 C# 桌面应用]]></title>    <link>https://juejin.cn/post/7592960378690945059</link>    <guid>https://juejin.cn/post/7592960378690945059</guid>    <pubDate>2026-01-09T09:15:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592960378690945059" data-draft-id="7593158683411103744" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于 Angular UI 的 C# 桌面应用"/> <meta itemprop="keywords" content="后端,前端,Angular.js"/> <meta itemprop="datePublished" content="2026-01-09T09:15:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="TeamDev"/> <meta itemprop="url" content="https://juejin.cn/user/4158825167847872"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于 Angular UI 的 C# 桌面应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4158825167847872/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    TeamDev
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T09:15:58.000Z" title="Fri Jan 09 2026 09:15:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/195aa778358b47d78318720fb2753233~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVGVhbURldg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768554959&amp;x-signature=FjadOfvXrMRCMXS%2BjhA6wYG%2BPLM%3D" alt="" loading="lazy"/></p>
<p>现代用户体验已成为桌面应用的基础要求，采用 Web 技术能帮助团队更快交付软件。</p>
<p>本文将展示基于 C# 的桌面应用架构，其用户界面采用 Angular 实现。该应用支持离线运行且无需本地服务器。</p>
<h2 data-id="heading-0">为什么在桌面应用中使用 Web UI？</h2>
<p>Web UI 技术栈拥有庞大且经过充分验证的组件生态系统。采用 Angular 构建桌面UI，可借助熟悉的工具处理布局、主题和交互逻辑，避免在原生 UI 框架中重复实现相同控件。</p>
<p>这种方式同时简化了代码复用流程。同一个 Angular 应用既能在浏览器中运行，也能嵌入桌面应用宿主程序，大幅减少代码冗余，实现 UI 变更的集中管理。原生窗口与系统集成的工作由独立模块负责，Web 层保持可移植性，桌面应用则能与各个操作系统实现无缝集成。</p>
<h2 data-id="heading-1">C# 桌面应用中的 Web UI</h2>
<p>本文将构建一个 跨平台的 Avalonia 桌面应用，其 UI 是一个基于 Angular 的简单偏好设置界面。Angular Web 应用被打包进桌面程序中，而 .NET 端负责将设置保存到持久化存储中。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83d0dc08f9a5488c9c1461569da6ce99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVGVhbURldg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768554959&amp;x-signature=QX6ZBmPIWne9kcNjTAx5FMzwZvU%3D" alt="运行在 Avalonia 窗口中的 Angular UI。" loading="lazy"/></p>
<p align="center"><span>运行在 Avalonia 窗口中的 Angular UI</span></p>
<p>UI 使用了 PrimeNG 作为现成的 Angular 组件库，但在该架构下，任何类似的组件库都可以使用。</p>
<p>将网页界面嵌入桌面壳层时,需克服以下障碍：</p>
<ol>
<li>需采用符合现代网页标准的可靠网页视图组件。</li>
<li>需实现无服务器环境下的网页内容加载，确保应用自包含性。</li>
<li>需建立 JavaScript 与 .NET 之间的双向通信机制。</li>
</ol>
<p>后续章节将依次说明：窗口与网页视图的配置方案、无服务器加载 Angular UI 的实现方法，以及通过 OpenAPI 规范定义的接口连接 JavaScript 与 .NET 的具体方案。</p>
<h2 data-id="heading-2">应用窗口与网页视图</h2>
<p>对于桌面壳层，我们使用 Avalonia 创建原生窗口和布局，并通过 DotNetBrowser（基于 Chromium 的跨平台网页视图组件）将其嵌入其中：</p>
<p><strong>MainWindow.axaml</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Window</span> <span class="hljs-attr">Width</span>=<span class="hljs-string">"1200"</span> <span class="hljs-attr">Height</span>=<span class="hljs-string">"800"</span> <span class="hljs-attr">Title</span>=<span class="hljs-string">"Angular Demo"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Grid</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">app:BrowserView</span> <span class="hljs-attr">x:Name</span>=<span class="hljs-string">"BrowserView"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Grid</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Window</span>&gt;</span>
</code></pre>
<p>在后端代码中，窗口会监听生命周期事件，并在打开时初始化浏览器组件：</p>
<p><strong>MainWindow.axaml.cs</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MainWindow</span> : <span class="hljs-title">Window</span>
{
<span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">string</span> Url = ResourceRequestHandler.Domain;

    <span class="hljs-keyword">public</span> IBrowser? Browser { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    <span class="hljs-keyword">public</span> IServiceProvider? ServiceProvider { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MainWindow</span>()</span>
    {
        InitializeComponent();
        Opened += OnOpened;
        Closed += OnClosed;
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnOpened</span>(<span class="hljs-params"><span class="hljs-built_in">object</span>? sender, EventArgs e</span>)</span>
    {
        Browser = ServiceProvider
            .GetRequiredService&lt;IEngineService&gt;()
            .CreateBrowser();
        BrowserView.InitializeFrom(Browser);

        <span class="hljs-keyword">await</span> Browser.Navigation.LoadUrl(Url);
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnClosed</span>(<span class="hljs-params"><span class="hljs-built_in">object</span>? sender, EventArgs e</span>)</span>
    {
        Browser?.Dispose();
    }
}
</code></pre>
<p>Engine 本身由 <code>IEngineService</code> 管理，因此窗口只需在打开时请求新的浏览器实例，并在关闭时释放它。这样可以将 Engine 的生命周期和配置集中管理。</p>
<h2 data-id="heading-3">在桌面应用中加载 Web UI</h2>
<p>将 Angular 应用移入嵌入式浏览器会改变其加载方式。
在生产环境中，编译后的压缩文件会被打包到桌面应用中，而非通过常规浏览器标签页的 <code>http://localhost</code> 地址提供服务。</p>
<p>不过，在在开发阶段，您仍希望获得开发服务器的快速反馈和热重载功能。</p>
<p>在开发模式下，可保持常规 Angular 工作流：启动 <code>ng serve</code> 并加载开发 URL，这样热重载功才能得以保留。</p>
<h3 data-id="heading-4">生产环境中的 Web UI 加载</h3>
<p>在生产环境中，我们不希望依赖开发服务器，甚至不希望使用任何 HTTP 服务器。相反，嵌入式浏览器会加载类似 <code>dnb://internal.host/</code> 这样的自定义协议 URL。</p>
<p>DotNetBrowser 可拦截该协议请求，并通过嵌入资源响应数据而非网络请求。配置此协议处理器后，Angular 应用完全由包内部提供：</p>
<p><strong>EngineService.cs</strong></p>
<pre><code class="hljs language-ini" lang="ini">var <span class="hljs-attr">builder</span> = new EngineOptions.Builder
{
    <span class="hljs-attr">RenderingMode</span> = RenderingMode.HardwareAccelerated
}<span class="hljs-comment">;</span>
builder.Schemes.Add(Scheme.Create("dnb"), handler)<span class="hljs-comment">;</span>
</code></pre>
<p><strong>ResourceRequestHandler.cs</strong></p>
<pre><code class="hljs language-lua" lang="lua">private <span class="hljs-built_in">string</span> ConvertToResourcePath(<span class="hljs-built_in">string</span> url)
{
    <span class="hljs-built_in">string</span> <span class="hljs-built_in">path</span> = url.Replace(Domain, <span class="hljs-built_in">string</span>.Empty, StringComparison.Ordinal);
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">string</span>.IsNullOrWhiteSpace(<span class="hljs-built_in">path</span>) || <span class="hljs-built_in">path</span> == <span class="hljs-string">"/"</span>)
    {
        <span class="hljs-built_in">path</span> = <span class="hljs-string">"browser/index.html"</span>;
    }
    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">path</span>.StartsWith(<span class="hljs-string">"browser/"</span>, StringComparison.OrdinalIgnoreCase))
    {
        <span class="hljs-built_in">path</span> = $<span class="hljs-string">"browser/{path}"</span>;
    }
    <span class="hljs-keyword">return</span> prefix + <span class="hljs-built_in">path</span>.TrimStart(<span class="hljs-string">'/'</span>).Replace(<span class="hljs-string">"/"</span>, <span class="hljs-string">"."</span>);
}
</code></pre>
<p>完成资源加载配置后，剩下的关键步骤是让 Angular 与 .NET 之间进行信息交换。</p>
<h2 data-id="heading-5">Web 应用与 .NET 之间的通信</h2>
<p>与任何 Web UI 一样，Angular 应用也需要与后端进行通信。这便是应用程序的 .NET 部分，负责处理业务逻辑，而 Web UI 则负责用户交互。关键问题在于如何将这两部分连接起来，同时确保在应用程序演进过程中保持可维护性。</p>
<h3 data-id="heading-6">JavaScript 与 .NET 的直接桥接</h3>
<p>最直接的方式是将 .NET 方法直接暴露给 JavaScript。DotNetBrowser 支持这种方式。首先，定义一个 C# 类：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PrefsService</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> PreferencesStore store;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PrefsService</span>(<span class="hljs-params">PreferencesStore store</span>)</span>
    {
        <span class="hljs-keyword">this</span>.store = store;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetAccountEmail</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> email</span>)</span>
    {
        <span class="hljs-keyword">var</span> account = store.GetAccount();
        account.Email = email;
        store.SetAccount(account);
    }
}
</code></pre>
<p>其次，在 TypeScript 中映射其结构：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">declare</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrefsService</span> {
  <span class="hljs-title function_">setAccountEmail</span>(<span class="hljs-attr">email</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span>;
}

<span class="hljs-keyword">declare</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">prefsService</span>: <span class="hljs-title class_">PrefsService</span>;
<span class="hljs-comment">// ...</span>
prefsService.<span class="hljs-title function_">setAccountEmail</span>(<span class="hljs-string">'john.doe@example.com'</span>);
</code></pre>
<p>最后，将 C# 对象注入 JavaScript 环境：</p>
<pre><code class="hljs language-csharp" lang="csharp">browser.InjectJsHandler = <span class="hljs-keyword">new</span> Handler&lt;InjectJsParameters&gt;(p =&gt;
{
    <span class="hljs-built_in">dynamic</span> window = p.Frame.ExecuteJavaScript(<span class="hljs-string">"window"</span>).Result;
    <span class="hljs-keyword">if</span> (window != <span class="hljs-literal">null</span>)
    {
        window.prefsService = <span class="hljs-keyword">new</span> PrefsService(store);
    }
});
</code></pre>
<p>对于小型项目来说，这种方式简单直观，也容易理解。但当 API 增长到不止几个方法时，就会在 C# 和 TypeScript 中重复定义同样的契约，并依赖人工保持同步。</p>
<p>为避免这种问题，该应用将桥接层视为一个 小型 HTTP API，并使用工具自动生成客户端，具体做法将在 OpenAPI 章节中介绍。</p>
<h3 data-id="heading-7">OpenAPI</h3>
<p>在这种架构中，Web 与 .NET 之间的契约通过 OpenAPI 进行一次性描述。基于同一份规范，可以生成 强类型的 C# 和 TypeScript 模型与客户端，从而确保两端在 API 演进过程中始终保持同步。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79f0a8f4a4904b82942f54a94d7f44fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVGVhbURldg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768554959&amp;x-signature=YQsKuZsOD6wWbSArMAhe%2B2QuUtU%3D" alt="Angular UI 与 .NET 处理程序的通信" loading="lazy"/></p>
<p align="center"><span>Angular UI 与 .NET 处理程序的通信</span></p>
<p>处理 API 请求时，我们采用与加载网页相同的 <code>dnb:/</code> 方案拦截器。此设计使应用保持自包含特性，避免暴露用户可在普通浏览器中访问的 <code>localhost</code> 端口或远程端点。</p>
<p>客户端方面，生成的 TypeScript 服务通过常规 <code>fetch()</code> API 进行通信。这确保 TypeScript 代码具备可移植性，并与常规浏览器环境兼容。</p>
<h4 data-id="heading-8">OpenAPI 契约概览</h4>
<p>以下是我们用于演示项目的 OpenAPI 定义精简版：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">paths:</span>
  <span class="hljs-string">/account:</span>
    <span class="hljs-attr">get:</span>
      <span class="hljs-attr">responses:</span>
        <span class="hljs-attr">'200':</span>
          <span class="hljs-attr">content:</span>
            <span class="hljs-attr">application/json:</span>
              <span class="hljs-attr">schema:</span>
                <span class="hljs-string">$ref:</span> <span class="hljs-string">'#/components/schemas/Account'</span>
    <span class="hljs-attr">put:</span>
      <span class="hljs-attr">requestBody:</span>
        <span class="hljs-attr">required:</span> <span class="hljs-literal">true</span>
        <span class="hljs-attr">content:</span>
          <span class="hljs-attr">application/json:</span>
            <span class="hljs-attr">schema:</span>
              <span class="hljs-string">$ref:</span> <span class="hljs-string">'#/components/schemas/Account'</span>
<span class="hljs-attr">components:</span>
  <span class="hljs-attr">schemas:</span>
    <span class="hljs-attr">Account:</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">object</span>
      <span class="hljs-attr">properties:</span>
        <span class="hljs-attr">email:</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
        <span class="hljs-attr">fullName:</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
        <span class="hljs-attr">twoFactorAuthentication:</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
        <span class="hljs-attr">biometricAuthentication:</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">boolean</span>
</code></pre>
<p>以下是 TypeScript 代码如何使用自动生成的 API 客户端：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> account = <span class="hljs-keyword">await</span> <span class="hljs-title class_">DefaultService</span>.<span class="hljs-title function_">getAccount</span>();

<span class="hljs-keyword">const</span> <span class="hljs-attr">next</span>: <span class="hljs-title class_">Account</span> = {
  ...account,
  <span class="hljs-attr">email</span>: <span class="hljs-string">'john.doe@example.com'</span>,
};

<span class="hljs-keyword">await</span> <span class="hljs-title class_">DefaultService</span>.<span class="hljs-title function_">putAccount</span>(next);
</code></pre>
<p>在服务器端，相同的 OpenAPI 定义支持拦截器处理 <code>dnb://internal.host/api/*</code> 请求，并将它们路由到业务逻辑类：</p>
<p><strong>ResourceRequestHandler.cs</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-title class_">InterceptRequestResponse</span> <span class="hljs-title class_">HandleApiRequest</span>(
    <span class="hljs-title class_">InterceptRequestParameters</span> parameters,
    <span class="hljs-built_in">string</span> path)
{
    <span class="hljs-keyword">return</span> (method, trimmedPath) <span class="hljs-keyword">switch</span>
    {
        <span class="hljs-function">(<span class="hljs-params"><span class="hljs-string">"GET"</span>, <span class="hljs-string">"account"</span></span>) =&gt;</span> <span class="hljs-title class_">JsonResponse</span>(parameters, store.<span class="hljs-title class_">GetAccount</span>()),
        <span class="hljs-function">(<span class="hljs-params"><span class="hljs-string">"PUT"</span>, <span class="hljs-string">"account"</span></span>) =&gt;</span>
            <span class="hljs-title class_">HandlePut</span>&lt;<span class="hljs-title class_">Account</span>&gt;(parameters, <span class="hljs-function"><span class="hljs-params">a</span> =&gt;</span> store.<span class="hljs-title class_">SetAccount</span>(a)),
        <span class="hljs-function">(<span class="hljs-params"><span class="hljs-string">"GET"</span>, <span class="hljs-string">"profile-picture"</span></span>) =&gt;</span>
            <span class="hljs-title class_">JsonResponse</span>(parameters, store.<span class="hljs-title class_">GetProfilePicture</span>()),
        <span class="hljs-function">(<span class="hljs-params"><span class="hljs-string">"PUT"</span>, <span class="hljs-string">"profile-picture"</span></span>) =&gt;</span>
            <span class="hljs-title class_">HandlePut</span>&lt;<span class="hljs-title class_">ProfilePicture</span>&gt;(
                parameters,
                <span class="hljs-function"><span class="hljs-params">pic</span> =&gt;</span> store.<span class="hljs-title class_">SetProfilePicture</span>(pic)),
        <span class="hljs-function"><span class="hljs-params">_</span> =&gt;</span> <span class="hljs-title class_">CreateResponse</span>(parameters, <span class="hljs-title class_">HttpStatusCode</span>.<span class="hljs-property">NotFound</span>)
    };
}
</code></pre>
<p>该架构确保协议类型安全、支持离线操作，并保持与常规浏览器环境的兼容性，因为它依赖标准 HTTP 语义。</p>
<h2 data-id="heading-9">总结</h2>
<p>DotNetBrowser 与 Avalonia 提供了原生、跨平台的桌面外壳，而 Angular 与 PrimeNG 则带来了现代化的 Web UI。通过自定义协议加载 UI，可以保持应用完全自包含；而基于 OpenAPI 的契约，则允许 JavaScript 通过 fetch 调用 .NET，而无需额外启动服务器。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PostgreSQL 显式锁定：从原理到实践（趣味版）]]></title>    <link>https://juejin.cn/post/7593158683411431424</link>    <guid>https://juejin.cn/post/7593158683411431424</guid>    <pubDate>2026-01-09T10:11:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593158683411431424" data-draft-id="7593193235250724916" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PostgreSQL 显式锁定：从原理到实践（趣味版）"/> <meta itemprop="keywords" content="PostgreSQL"/> <meta itemprop="datePublished" content="2026-01-09T10:11:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="光蛋"/> <meta itemprop="url" content="https://juejin.cn/user/3537560778573467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PostgreSQL 显式锁定：从原理到实践（趣味版）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3537560778573467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    光蛋
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T10:11:14.000Z" title="Fri Jan 09 2026 10:11:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：数据库里的“抢板凳”游戏</h2>
<p>想象一下，你和朋友围着一张摆满零食的桌子抢吃的：有人只想看一眼零食（读数据），有人想直接拿走（改数据），有人想把整张桌子搬走（删表）。如果没人管，桌子肯定会被掀翻——PostgreSQL的显式锁，就是这场“抢零食游戏”的规则和裁判，确保每个人都能按规矩来，不打架、不抢乱。</p>
<p>PostgreSQL的锁体系就像一套精密的“交通规则”，覆盖了表、行、页三个维度，还有专门解决“互不相让”的死锁机制，以及灵活的“自定义规则”（咨询锁）。接下来，我们用故事+示例的方式，把这些枯燥的锁概念讲明白。</p>
<h2 data-id="heading-1">1 表级锁：给整张零食桌定规矩</h2>
<p>表级锁是给整张表上的“大锁”，就像给零食桌贴标签：“只许看”，“可拿零食但不能搬桌子”，“谁都不许碰”……PostgreSQL定义了8种表级锁模式，核心是“谁和谁不能同时来”。</p>
<h3 data-id="heading-2">趣味场景：零食店的营业规则</h3>
<p>假设你开了一家零食店（数据库），货架（表）上摆着各种零食（数据），不同顾客（事务）有不同需求，你需要用表级锁来管理：</p>
<ul>
<li><strong>ACCESS SHARE（只许看）</strong> ：顾客只想看货架上有什么零食（SELECT），不拿也不碰。只要没人把货架搬走（ACCESS EXCLUSIVE），多少人看都可以。</li>
<li><strong>ROW EXCLUSIVE（可拿零食）</strong> ：顾客要拿走一包薯片（UPDATE/INSERT/DELETE），此时不能有人把货架锁起来盘点（SHARE），但其他人还能看、还能拿其他零食。</li>
<li><strong>ACCESS EXCLUSIVE（谁都不许碰）</strong> ：你要把整个货架搬走重装（ALTER TABLE/TRUNCATE），此时任何人都不能看、不能拿，必须等你搬完。</li>
</ul>
<h3 data-id="heading-3">实操示例：手动加表级锁</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 会话1：给products表加“只许读”的锁（ACCESS SHARE）</span>
<span class="hljs-keyword">BEGIN</span>;
LOCK <span class="hljs-keyword">TABLE</span> products <span class="hljs-keyword">IN</span> ACCESS SHARE MODE;
<span class="hljs-comment">-- 此时可以正常SELECT，但无法执行ALTER TABLE/TRUNCATE</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> category <span class="hljs-operator">=</span> <span class="hljs-string">'零食'</span>;
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- 会话2：尝试给products表加“独占锁”（ACCESS EXCLUSIVE），会被阻塞</span>
<span class="hljs-keyword">BEGIN</span>;
LOCK <span class="hljs-keyword">TABLE</span> products <span class="hljs-keyword">IN</span> ACCESS EXCLUSIVE MODE; <span class="hljs-comment">-- 等待会话1提交后才会执行</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> products <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> stock <span class="hljs-type">int</span>;
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- 冲突示例：ACCESS SHARE和ACCESS EXCLUSIVE互斥</span>
<span class="hljs-comment">-- 会话1先持有ACCESS SHARE，会话2的ACCESS EXCLUSIVE会等待；反之亦然</span>
</code></pre>
<h3 data-id="heading-4">核心冲突规则（简化版）</h3>

























<table><thead><tr><th>锁模式</th><th>能和谁共存？</th><th>不能和谁共存？</th></tr></thead><tbody><tr><td>ACCESS SHARE（只读）</td><td>几乎所有锁</td><td>只有ACCESS EXCLUSIVE</td></tr><tr><td>ROW EXCLUSIVE（改数据）</td><td>读锁、行共享锁</td><td>共享锁、独占锁、ACCESS EXCLUSIVE</td></tr><tr><td>ACCESS EXCLUSIVE（独占）</td><td>无</td><td>所有锁</td></tr></tbody></table>
<h3 data-id="heading-5">实际使用案例：电商商品表的表级锁控制</h3>
<p>【场景】电商平台的商品表（products）日常有大量用户查询商品信息（SELECT），运营人员需定期更新商品分类（ALTER TABLE），数据分析师需夜间生成销售统计报表（CREATE INDEX CONCURRENTLY）。</p>
<p>【锁策略设计】：</p>
<ul>
<li>用户查询商品时，PostgreSQL自动加ACCESS SHARE锁，不影响其他查询，仅阻塞ALTER TABLE等加ACCESS EXCLUSIVE锁的操作；</li>
<li>运营更新商品分类字段（ALTER TABLE products ADD COLUMN category_level int）时，需加ACCESS EXCLUSIVE锁，需避开查询高峰（如凌晨执行），避免阻塞大量用户查询；</li>
<li>数据分析师创建统计索引（CREATE INDEX CONCURRENTLY idx_products_sales ON products(sales_num)）时，加SHARE UPDATE EXCLUSIVE锁，不会阻塞用户查询，但会阻塞运营的ALTER TABLE操作，需与运营操作错峰。</li>
</ul>
<p>【实操验证】：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 高峰时段用户查询（自动加ACCESS SHARE锁）</span>
<span class="hljs-keyword">SELECT</span> name, price, stock <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> category <span class="hljs-operator">=</span> <span class="hljs-string">'electronics'</span>;

<span class="hljs-comment">-- 夜间运营更新字段（加ACCESS EXCLUSIVE锁）</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> products <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> category_level <span class="hljs-type">int</span>;
<span class="hljs-keyword">UPDATE</span> products <span class="hljs-keyword">SET</span> category_level <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> category <span class="hljs-operator">=</span> <span class="hljs-string">'electronics'</span>;
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- 凌晨分析师创建并发索引（加SHARE UPDATE EXCLUSIVE锁）</span>
<span class="hljs-keyword">CREATE</span> INDEX CONCURRENTLY idx_products_sales <span class="hljs-keyword">ON</span> products(sales_num);
</code></pre>
<h2 data-id="heading-6">2 行级锁：只锁你想要的那包零食</h2>
<p>如果说表级锁是“锁整张桌子”，行级锁就是“只锁你手里的那包薯片”——不影响别人拿其他零食，精准又高效。PostgreSQL的行级锁只阻塞“改这行数据的人”，不影响“看这行数据的人”。</p>
<h3 data-id="heading-7">趣味场景：抢最后一包限量薯片</h3>
<p>零食店只剩1包限量薯片（行数据），两个顾客同时想买：</p>
<ul>
<li>顾客A先伸手拿（SELECT ... FOR UPDATE），给这包薯片贴了“我要了”的标签（行级排他锁）；</li>
<li>顾客B再伸手，发现标签后只能等顾客A松手（事务结束），要么买到，要么发现薯片已经被买走（行被删除）。</li>
</ul>
<h3 data-id="heading-8">实操示例：行级锁的4种模式</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 会话1：锁定id=100的薯片行（FOR UPDATE，排他锁）</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">100</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;
<span class="hljs-comment">-- 此时这行被锁定，其他会话改这行都会等</span>
<span class="hljs-keyword">UPDATE</span> products <span class="hljs-keyword">SET</span> stock <span class="hljs-operator">=</span> stock <span class="hljs-operator">-</span> <span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;
<span class="hljs-comment">-- 暂不提交，保持锁</span>

<span class="hljs-comment">-- 会话2：尝试改同一行，会被阻塞</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">UPDATE</span> products <span class="hljs-keyword">SET</span> price <span class="hljs-operator">=</span> <span class="hljs-number">9.9</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">100</span>; <span class="hljs-comment">-- 等待会话1提交/回滚</span>
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- 更温和的锁：FOR NO KEY UPDATE（不阻塞FOR KEY SHARE）</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">100</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">NO</span> KEY <span class="hljs-keyword">UPDATE</span>;
<span class="hljs-comment">-- 只锁“非主键/外键列”，适合普通更新</span>
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- 共享锁：FOR SHARE（多人可看，都不能改）</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">100</span> <span class="hljs-keyword">FOR</span> SHARE;
<span class="hljs-comment">-- 其他会话可以加FOR SHARE，但不能加FOR UPDATE</span>
<span class="hljs-keyword">COMMIT</span>;
</code></pre>
<h3 data-id="heading-9">行级锁冲突规则</h3>
<h3 data-id="heading-10">实际使用案例：秒杀活动中的行级锁防超卖</h3>
<p>【场景】电商秒杀活动，某款限量100件的商品，大量用户同时抢购，需防止超卖（即最终下单数超过库存数）。</p>
<p>【问题分析】：若不使用行级锁，多个事务同时读取库存（如stock=1），都判断有库存并执行扣减，会导致最终stock变为-1（超卖）。</p>
<p>【解决方案】：使用SELECT ... FOR UPDATE行级锁，确保同一时刻只有一个事务能修改该商品的库存记录。</p>
<p>【实操代码】：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 秒杀下单核心逻辑（需在事务中执行）</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-comment">-- 锁定目标商品行，防止其他事务同时修改</span>
<span class="hljs-keyword">SELECT</span> stock <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;
<span class="hljs-comment">-- 检查库存是否充足</span>
IF (<span class="hljs-keyword">SELECT</span> stock <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span>) <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span>
  <span class="hljs-comment">-- 扣减库存</span>
  <span class="hljs-keyword">UPDATE</span> products <span class="hljs-keyword">SET</span> stock <span class="hljs-operator">=</span> stock <span class="hljs-operator">-</span> <span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span>;
  <span class="hljs-comment">-- 创建订单记录</span>
  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders (product_id, user_id, create_time) 
  <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1001</span>, #{userId}, NOW());
  <span class="hljs-keyword">COMMIT</span>;
  <span class="hljs-keyword">RETURN</span> <span class="hljs-string">'下单成功'</span>;
<span class="hljs-keyword">ELSE</span>
  <span class="hljs-keyword">ROLLBACK</span>;
  <span class="hljs-keyword">RETURN</span> <span class="hljs-string">'库存不足'</span>;
<span class="hljs-keyword">END</span> IF;
</code></pre>
<p>【说明】：通过FOR UPDATE锁定商品行后，其他抢购该商品的事务会阻塞在SELECT ... FOR UPDATE步骤，等待当前事务提交或回滚后再执行，从而避免超卖。</p>








































<table><thead><tr><th>请求的锁</th><th>FOR KEY SHARE</th><th>FOR SHARE</th><th>FOR NO KEY UPDATE</th><th>FOR UPDATE</th></tr></thead><tbody><tr><td>FOR KEY SHARE</td><td>✅</td><td>✅</td><td>✅</td><td>❌</td></tr><tr><td>FOR SHARE</td><td>✅</td><td>✅</td><td>❌</td><td>❌</td></tr><tr><td>FOR NO KEY UPDATE</td><td>❌</td><td>❌</td><td>❌</td><td>❌</td></tr><tr><td>FOR UPDATE</td><td>❌</td><td>❌</td><td>❌</td><td>❌</td></tr></tbody></table>
<h2 data-id="heading-11">3 页级锁：零食盒的“临时锁”</h2>
<p>页级锁是PostgreSQL内部用的“小锁”——把表拆成一个个“零食盒”（数据页），操作盒里的零食时，先锁盒子，用完马上放。对应用开发者来说，<strong>完全不用关心</strong>，PostgreSQL会自动处理，这里只做科普：</p>
<ul>
<li>作用：控制对内存中数据页的读写；</li>
<li>特点：用完就放，不持久，开发者无需手动操作。</li>
</ul>
<h2 data-id="heading-12">4 死锁：谁都不让谁的“僵局”</h2>
<p>死锁就像两个顾客吵架：</p>
<p>顾客A：你先把我的薯片还给我，我再给你可乐！</p>
<p>顾客B：你先把我的可乐还给我，我再给你薯片！</p>
<p>谁都不让步，最后只能店长（PostgreSQL）出面，把其中一个人劝走（中断事务），打破僵局。</p>
<h3 data-id="heading-13">趣味场景：转账引发的死锁</h3>
<p>小明要给小红转100元，小红要给小明转50元，两人同时操作：</p>
<ol>
<li>小明的事务：先锁自己的账户（更新余额-100），再想锁小红的账户（+100）；</li>
<li>小红的事务：先锁自己的账户（更新余额-50），再想锁小明的账户（+50）；</li>
<li>结果：小明等小红松手，小红等小明松手，死锁！</li>
</ol>
<h3 data-id="heading-14">实操示例：复现并解决死锁</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 先建表：账户表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> accounts (
  acctnum <span class="hljs-type">int</span> <span class="hljs-keyword">PRIMARY</span> KEY,
  balance <span class="hljs-type">numeric</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>)
);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> accounts <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">11111</span>, <span class="hljs-number">1000</span>), (<span class="hljs-number">22222</span>, <span class="hljs-number">1000</span>);

<span class="hljs-comment">-- 会话1（小明）：先更自己，再更小红</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">-</span> <span class="hljs-number">100</span> <span class="hljs-keyword">WHERE</span> acctnum <span class="hljs-operator">=</span> <span class="hljs-number">11111</span>;
<span class="hljs-comment">-- 暂不提交，保持锁</span>

<span class="hljs-comment">-- 会话2（小红）：先更自己，再更小明</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">-</span> <span class="hljs-number">50</span> <span class="hljs-keyword">WHERE</span> acctnum <span class="hljs-operator">=</span> <span class="hljs-number">22222</span>;
<span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">+</span> <span class="hljs-number">50</span> <span class="hljs-keyword">WHERE</span> acctnum <span class="hljs-operator">=</span> <span class="hljs-number">11111</span>; <span class="hljs-comment">-- 等待会话1</span>

<span class="hljs-comment">-- 回到会话1：尝试更小红，触发死锁</span>
<span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">+</span> <span class="hljs-number">100</span> <span class="hljs-keyword">WHERE</span> acctnum <span class="hljs-operator">=</span> <span class="hljs-number">22222</span>;
<span class="hljs-comment">-- PostgreSQL会提示：ERROR:  deadlock detected</span>
<span class="hljs-comment">-- 并中断其中一个事务，另一个继续执行</span>
</code></pre>
<h3 data-id="heading-15">死锁预防技巧</h3>
<h3 data-id="heading-16">实际使用案例：多账户转账的死锁避免</h3>
<p>【场景】银行转账系统，支持用户之间互转，如用户A转用户B、用户B转用户A，若不控制锁顺序，易引发死锁。</p>
<p>【死锁复现】：如前文“转账引发的死锁”示例，因两个事务锁账户的顺序相反（A先锁A再锁B，B先锁B再锁A），导致死锁。</p>
<p>【解决方案】：统一锁顺序，即所有转账事务都按“账户号从小到大”的顺序锁定账户。</p>
<p>【优化后实操代码】：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 通用转账函数（统一按账户号升序锁）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">FUNCTION</span> transfer(from_acct <span class="hljs-type">int</span>, to_acct <span class="hljs-type">int</span>, amount <span class="hljs-type">numeric</span>)
<span class="hljs-keyword">RETURNS</span> <span class="hljs-type">VARCHAR</span> <span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
  min_acct <span class="hljs-type">int</span>;
  max_acct <span class="hljs-type">int</span>;
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-comment">-- 确定账户号大小，统一先锁小号账户</span>
  IF from_acct <span class="hljs-operator">&lt;</span> to_acct <span class="hljs-keyword">THEN</span>
    min_acct :<span class="hljs-operator">=</span> from_acct;
    max_acct :<span class="hljs-operator">=</span> to_acct;
  <span class="hljs-keyword">ELSE</span>
    min_acct :<span class="hljs-operator">=</span> to_acct;
    max_acct :<span class="hljs-operator">=</span> from_acct;
  <span class="hljs-keyword">END</span> IF;
  
  <span class="hljs-keyword">BEGIN</span>;
  <span class="hljs-comment">-- 按统一顺序锁定账户</span>
  <span class="hljs-keyword">SELECT</span> balance <span class="hljs-keyword">FROM</span> accounts <span class="hljs-keyword">WHERE</span> acctnum <span class="hljs-operator">=</span> min_acct <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;
  <span class="hljs-keyword">SELECT</span> balance <span class="hljs-keyword">FROM</span> accounts <span class="hljs-keyword">WHERE</span> acctnum <span class="hljs-operator">=</span> max_acct <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;
  
  <span class="hljs-comment">-- 检查转出账户余额</span>
  IF (<span class="hljs-keyword">SELECT</span> balance <span class="hljs-keyword">FROM</span> accounts <span class="hljs-keyword">WHERE</span> acctnum <span class="hljs-operator">=</span> from_acct) <span class="hljs-operator">&lt;</span> amount <span class="hljs-keyword">THEN</span>
    <span class="hljs-keyword">ROLLBACK</span>;
    <span class="hljs-keyword">RETURN</span> <span class="hljs-string">'余额不足'</span>;
  <span class="hljs-keyword">END</span> IF;
  
  <span class="hljs-comment">-- 执行转账</span>
  <span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">-</span> amount <span class="hljs-keyword">WHERE</span> acctnum <span class="hljs-operator">=</span> from_acct;
  <span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">+</span> amount <span class="hljs-keyword">WHERE</span> acctnum <span class="hljs-operator">=</span> to_acct;
  
  <span class="hljs-keyword">COMMIT</span>;
  <span class="hljs-keyword">RETURN</span> <span class="hljs-string">'转账成功'</span>;
<span class="hljs-keyword">END</span>;
$$ <span class="hljs-keyword">LANGUAGE</span> plpgsql;

<span class="hljs-comment">-- 调用示例（无论谁转谁，都按账户号升序锁）</span>
<span class="hljs-keyword">SELECT</span> transfer(<span class="hljs-number">11111</span>, <span class="hljs-number">22222</span>, <span class="hljs-number">100</span>); <span class="hljs-comment">-- 先锁11111，再锁22222</span>
<span class="hljs-keyword">SELECT</span> transfer(<span class="hljs-number">22222</span>, <span class="hljs-number">11111</span>, <span class="hljs-number">50</span>);  <span class="hljs-comment">-- 同样先锁11111，再锁22222</span>
</code></pre>
<p>【说明】：通过统一锁顺序，确保所有事务对多个账户的锁定顺序一致，从根本上避免了死锁的发生。</p>
<ol>
<li><strong>统一锁顺序</strong>：所有事务都按“账户号从小到大”更新，比如先更11111，再更22222；</li>
<li><strong>缩短锁持有时间</strong>：事务尽量快，别拿着锁等用户输入；</li>
<li><strong>重试机制</strong>：捕获死锁错误后，自动重试事务。</li>
</ol>
<h2 data-id="heading-17">5 咨询锁：自定义的“零食店规矩”</h2>
<p>咨询锁是PostgreSQL给开发者的“自定义锁”——系统不管你怎么用，全靠你自己守规矩。就像零食店老板和熟客约定：“看到桌上摆着红色杯子，就说明我在盘点，别进来”，杯子（咨询锁）的含义由你们自己定。</p>
<h3 data-id="heading-18">趣味场景：防止多人同时盘点库存</h3>
<p>零食店每天闭店要盘点，你怕多个员工同时盘点出错，就用咨询锁：</p>
<ul>
<li>员工A盘点前，先“占坑”：拿一个编号为100的咨询锁；</li>
<li>员工B再想盘点，发现100号锁被占，就等员工A盘完再开始；</li>
<li>盘点结束，员工A释放锁。</li>
</ul>
<h3 data-id="heading-19">实操示例：会话级vs事务级咨询锁</h3>
<h3 data-id="heading-20">实际使用案例：分布式任务调度的咨询锁控制</h3>
<p>【场景】分布式系统中，多个服务节点需共同执行一批定时任务（如订单超时关闭），需确保同一个任务同一时刻只被一个节点执行，避免重复处理。</p>
<p>【解决方案】：使用事务级咨询锁，每个任务对应一个唯一标识（如任务ID），服务节点执行任务前先获取该标识的咨询锁，获取成功则执行任务，失败则跳过（等待下一轮）。</p>
<p>【实操代码】：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 定时任务执行逻辑（每个节点定时调用）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">FUNCTION</span> execute_timeout_task()
<span class="hljs-keyword">RETURNS</span> VOID <span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
  task RECORD;
  lock_acquired <span class="hljs-type">BOOLEAN</span>;
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-comment">-- 遍历未执行的超时订单任务</span>
  <span class="hljs-keyword">FOR</span> task <span class="hljs-keyword">IN</span> <span class="hljs-keyword">SELECT</span> id <span class="hljs-keyword">FROM</span> order_timeout_tasks <span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'pending'</span> LOOP
    <span class="hljs-comment">-- 尝试获取事务级咨询锁（任务ID作为锁标识）</span>
    <span class="hljs-keyword">SELECT</span> pg_try_advisory_xact_lock(task.id) <span class="hljs-keyword">INTO</span> lock_acquired;
    
    IF lock_acquired <span class="hljs-keyword">THEN</span>
      <span class="hljs-comment">-- 获取锁成功，执行任务（关闭超时订单）</span>
      <span class="hljs-keyword">UPDATE</span> orders <span class="hljs-keyword">SET</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'closed'</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> task.order_id;
      <span class="hljs-comment">-- 更新任务状态为已完成</span>
      <span class="hljs-keyword">UPDATE</span> order_timeout_tasks <span class="hljs-keyword">SET</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'completed'</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> task.id;
      RAISE NOTICE <span class="hljs-string">'任务 % 执行成功'</span>, task.id;
    <span class="hljs-keyword">ELSE</span>
      <span class="hljs-comment">-- 未获取到锁，说明其他节点正在执行</span>
      RAISE NOTICE <span class="hljs-string">'任务 % 已被其他节点执行，跳过'</span>, task.id;
    <span class="hljs-keyword">END</span> IF;
  <span class="hljs-keyword">END</span> LOOP;
<span class="hljs-keyword">END</span>;
$$ <span class="hljs-keyword">LANGUAGE</span> plpgsql;

<span class="hljs-comment">-- 服务节点定时调用（如每分钟一次）</span>
<span class="hljs-keyword">SELECT</span> execute_timeout_task();
</code></pre>
<p>【说明】：使用pg_try_advisory_xact_lock（非阻塞获取事务级咨询锁），避免节点间相互等待。事务结束后锁自动释放，无需手动解锁，确保任务执行的原子性和唯一性。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 1. 会话级咨询锁（会话结束才释放，无视事务回滚）</span>
<span class="hljs-keyword">SELECT</span> pg_advisory_lock(<span class="hljs-number">100</span>); <span class="hljs-comment">-- 占100号锁</span>
<span class="hljs-comment">-- 此时其他会话调用pg_advisory_lock(100)会阻塞</span>
<span class="hljs-keyword">SELECT</span> pg_advisory_unlock(<span class="hljs-number">100</span>); <span class="hljs-comment">-- 释放锁</span>

<span class="hljs-comment">-- 2. 事务级咨询锁（事务结束自动释放）</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">SELECT</span> pg_advisory_xact_lock(<span class="hljs-number">100</span>); <span class="hljs-comment">-- 事务级锁</span>
<span class="hljs-comment">-- 盘点操作：SELECT SUM(stock) FROM products;</span>
<span class="hljs-keyword">COMMIT</span>; <span class="hljs-comment">-- 提交后自动释放锁</span>

<span class="hljs-comment">-- 避坑：LIMIT和咨询锁一起用要小心</span>
<span class="hljs-comment">-- 错误写法：可能锁到非预期的行</span>
<span class="hljs-keyword">SELECT</span> pg_advisory_lock(id) <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">&gt;</span> <span class="hljs-number">10</span> LIMIT <span class="hljs-number">10</span>;

<span class="hljs-comment">-- 正确写法：先筛选行，再锁</span>
<span class="hljs-keyword">SELECT</span> pg_advisory_lock(q.id) <span class="hljs-keyword">FROM</span> (
  <span class="hljs-keyword">SELECT</span> id <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">&gt;</span> <span class="hljs-number">10</span> LIMIT <span class="hljs-number">10</span>
) q;
</code></pre>
<h2 data-id="heading-21">6 总结</h2>
<ol>
<li><strong>表级锁</strong>：按“严格程度”分8种，核心是ACCESS SHARE（只读）和ACCESS EXCLUSIVE（独占）互斥，适合控制整张表的访问；</li>
<li><strong>行级锁</strong>：精准锁定单行，只阻塞修改，不阻塞读取，常用FOR UPDATE实现“悲观锁”；</li>
<li><strong>死锁</strong>：多事务互等锁导致，预防关键是“统一锁顺序+缩短锁持有时间”；</li>
<li><strong>咨询锁</strong>：自定义锁，分会话级（手动释放）和事务级（自动释放），适合MVCC不适用的场景。</li>
</ol>
<p>“读尽量不堵读，改尽量少堵读，独占锁堵一切，死锁靠顺序防，咨询锁自己定”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Ajax 数据请求：从零开始掌握异步通信]]></title>    <link>https://juejin.cn/post/7571695634942165019</link>    <guid>https://juejin.cn/post/7571695634942165019</guid>    <pubDate>2025-11-12T14:19:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571695634942165019" data-draft-id="7571704212850851891" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Ajax 数据请求：从零开始掌握异步通信"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-12T14:19:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="神秘的猪头"/> <meta itemprop="url" content="https://juejin.cn/user/793223472877051"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Ajax 数据请求：从零开始掌握异步通信
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/793223472877051/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    神秘的猪头
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T14:19:18.000Z" title="Wed Nov 12 2025 14:19:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在现代 Web 开发中，<strong>Ajax（Asynchronous JavaScript and XML）</strong> 是实现页面局部刷新、提升用户体验的核心技术之一。虽然名字里包含 “XML”，但如今我们更多使用的是 <strong>JSON 格式</strong>的数据。本文将结合原理讲解与示例代码，带你深入理解并动手实践原生 Ajax 请求。</p>
<hr/>
<h2 data-id="heading-0">一、什么是 Ajax？</h2>
<p>Ajax 全称是 <strong>Asynchronous JavaScript and XML</strong>，即“异步的 JavaScript 和 XML”。它的核心思想是：</p>
<blockquote>
<p><strong>在不重新加载整个页面的情况下，通过 JavaScript 向服务器发送请求并处理响应，从而动态更新网页内容。</strong></p>
</blockquote>
<p>这种机制让 Web 应用更像桌面应用——流畅、快速、无刷新。</p>
<hr/>
<h2 data-id="heading-1">二、Ajax 的基本工作流程</h2>
<p>使用原生 JavaScript 发起 Ajax 请求，通常遵循以下五个步骤：</p>
<ol>
<li><strong>创建 XMLHttpRequest 对象</strong></li>
<li><strong>调用 <code>open()</code> 方法配置请求</strong></li>
<li><strong>设置回调函数监听状态变化（<code>onreadystatechange</code>）</strong></li>
<li><strong>调用 <code>send()</code> 发送请求</strong></li>
<li><strong>在回调中处理响应数据</strong></li>
</ol>
<h3 data-id="heading-2">关键概念解析</h3>
<h4 data-id="heading-3">1. <code>XMLHttpRequest</code> 对象</h4>
<p>这是浏览器内置的对象，用于发起 HTTP 请求。</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">xhr</span> = new XMLHttpRequest()<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-4">2. <code>open(method, url, async)</code></h4>
<ul>
<li><code>method</code>：HTTP 方法，如 <code>'GET'</code>、<code>'POST'</code></li>
<li><code>url</code>：请求的目标地址（API 接口）</li>
<li><code>async</code>：是否异步（<strong>强烈建议设为 <code>true</code></strong>）</li>
</ul>
<blockquote>
<p>⚠️ 注意：示例中使用了 <code>false</code>（同步），这会阻塞浏览器，<strong>实际开发中应避免</strong>！</p>
</blockquote>
<h4 data-id="heading-5">3. <code>send()</code></h4>
<p>真正发出请求。对于 GET 请求，通常传入 <code>null</code> 或空值。</p>
<h4 data-id="heading-6">4. <code>onreadystatechange</code> 事件</h4>
<p>每当请求状态发生变化时触发。我们需要在这个回调中判断请求是否成功完成。</p>
<h4 data-id="heading-7">5. 状态码与就绪状态</h4>

















<table><thead><tr><th>属性</th><th>含义</th></tr></thead><tbody><tr><td><code>xhr.status</code></td><td>HTTP 状态码，如 <code>200</code> 表示成功</td></tr><tr><td><code>xhr.readyState</code></td><td>请求的当前阶段（0~4）</td></tr></tbody></table>
<h5 data-id="heading-8"><code>readyState</code> 的五个阶段：</h5>



































<table><thead><tr><th>值</th><th>状态</th><th>说明</th></tr></thead><tbody><tr><td>0</td><td>UNSENT</td><td>已创建，未调用 <code>open()</code></td></tr><tr><td>1</td><td>OPENED</td><td>已调用 <code>open()</code></td></tr><tr><td>2</td><td>HEADERS_RECEIVED</td><td>已调用 <code>send()</code>，收到响应头</td></tr><tr><td>3</td><td>LOADING</td><td>正在接收响应体</td></tr><tr><td>4</td><td>DONE</td><td>请求完成，响应数据全部接收</td></tr></tbody></table>
<p>✅ <strong>只有当 <code>readyState === 4</code> 且 <code>status === 200</code> 时，才表示请求成功！</strong></p>
<hr/>
<h2 data-id="heading-9">三、实战示例：获取 GitHub 组织成员列表</h2>
<p>我们将通过一个真实 API（GitHub 的公开接口）来演示如何用 Ajax 获取数据并渲染到页面。</p>
<h3 data-id="heading-10">✅ 改进后的推荐写法（<strong>异步模式</strong>）</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Ajax 数据请求 - 异步版<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>Lemoncode 组织成员<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"members"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();

        <span class="hljs-comment">// 配置请求：异步 GET</span>
        xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'https://api.github.com/orgs/lemoncode/members'</span>, <span class="hljs-literal">true</span>);

        <span class="hljs-comment">// 监听状态变化</span>
        xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
            <span class="hljs-comment">// 只有 readyState 为 4 且状态码为 200 才处理</span>
            <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">readyState</span> === <span class="hljs-number">4</span>) {
                <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">status</span> === <span class="hljs-number">200</span>) {
                    <span class="hljs-comment">// 成功：解析 JSON 并渲染</span>
                    <span class="hljs-keyword">const</span> members = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(xhr.<span class="hljs-property">responseText</span>);
                    <span class="hljs-keyword">const</span> listItems = members.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> <span class="hljs-string">`&lt;li&gt;<span class="hljs-subst">${user.login}</span>&lt;/li&gt;`</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>);
                    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'members'</span>).<span class="hljs-property">innerHTML</span> = listItems;
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-comment">// 失败：显示错误信息</span>
                    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'members'</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-string">'&lt;li&gt;加载失败，请稍后重试。&lt;/li&gt;'</span>;
                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请求失败:'</span>, xhr.<span class="hljs-property">status</span>);
                }
            }
        };

        <span class="hljs-comment">// 发送请求</span>
        xhr.<span class="hljs-title function_">send</span>();
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 data-id="heading-11">🌟 关键改进点：</h3>
<ol>
<li><strong>使用 <code>async: true</code></strong> —— 不阻塞主线程，用户体验更好。</li>
<li><strong>错误处理</strong> —— 检查非 200 状态码，避免程序崩溃。</li>
<li><strong>结构清晰</strong> —— 先监听，再发送，逻辑更安全。</li>
</ol>
<hr/>
<h2 data-id="heading-12">四、为什么不要用同步请求（<code>async: false</code>）？</h2>
<p>在你提供的原始代码中：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">xhr.<span class="hljs-keyword">open</span>(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'...'</span>, <span class="hljs-literal">false</span>); <span class="hljs-comment">// 同步！</span>
</code></pre>
<p>这会导致：</p>
<ul>
<li>浏览器界面<strong>完全冻结</strong>，直到请求完成；</li>
<li>用户无法滚动、点击或交互；</li>
<li>现代浏览器已<strong>不推荐甚至警告</strong>使用同步 XHR。</li>
</ul>
<p>✅ <strong>永远使用异步请求！</strong></p>
<hr/>
<h2 data-id="heading-13">五、现代替代方案：<code>fetch</code> API</h2>
<p>虽然原生 Ajax 是基础，但现代开发更常用 <code>fetch</code>，它基于 Promise，语法更简洁：</p>
<pre><code class="hljs language-ini" lang="ini">fetch('https://api.github.com/orgs/lemoncode/members')
  .then(<span class="hljs-attr">response</span> =&gt; response.json())
  .then(<span class="hljs-attr">members</span> =&gt; {
    document.getElementById('members').<span class="hljs-attr">innerHTML</span> = 
      members.map(<span class="hljs-attr">user</span> =&gt; `&lt;li&gt;<span class="hljs-variable">${user.login}</span>&lt;/li&gt;`).join(<span class="hljs-string">''</span>)<span class="hljs-comment">;</span>
  })
  .catch(<span class="hljs-attr">error</span> =&gt; {
    console.error('请求出错:', error)<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>
</code></pre>
<p>不过，理解 <code>XMLHttpRequest</code> 仍是掌握网络请求本质的关键！</p>
<hr/>
<h2 data-id="heading-14">六、总结</h2>

































<table><thead><tr><th>要点</th><th>说明</th></tr></thead><tbody><tr><td>✅ 核心对象</td><td><code>XMLHttpRequest</code></td></tr><tr><td>✅ 必须监听</td><td><code>onreadystatechange</code></td></tr><tr><td>✅ 判断条件</td><td><code>readyState === 4 &amp;&amp; status === 200</code></td></tr><tr><td>✅ 数据格式</td><td>通常为 JSON，需 <code>JSON.parse()</code></td></tr><tr><td>❌ 避免使用</td><td>同步请求（<code>async: false</code>）</td></tr><tr><td>🔮 进阶方向</td><td>学习 <code>fetch</code>、<code>axios</code> 等现代工具</td></tr></tbody></table>
<hr/>
<p>通过本文的学习，你应该已经掌握了 Ajax 的基本原理和实现方式。下一步可以尝试：</p>
<ul>
<li>发送 POST 请求提交表单；</li>
<li>添加加载动画（<code>readyState === 3</code> 时显示“加载中”）；</li>
<li>封装一个通用的 Ajax 函数。</li>
</ul>
<p>记住：<strong>异步是 Web 的灵魂，而 Ajax 是通往动态交互的第一步！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[华为 DevKit 25.2.rc1 源码迁移分析使用教程（openEuler + ARM64）]]></title>    <link>https://juejin.cn/post/7593098101431910454</link>    <guid>https://juejin.cn/post/7593098101431910454</guid>    <pubDate>2026-01-09T09:11:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593098101431910454" data-draft-id="7592990758476152851" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="华为 DevKit 25.2.rc1 源码迁移分析使用教程（openEuler + ARM64）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-09T09:11:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="秋说"/> <meta itemprop="url" content="https://juejin.cn/user/442448008454568"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            华为 DevKit 25.2.rc1 源码迁移分析使用教程（openEuler + ARM64）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/442448008454568/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    秋说
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T09:11:52.000Z" title="Fri Jan 09 2026 09:11:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、前言</h2>
<p>华为 DevKit 是一款用于 x86 → 鲲鹏（ARM64）平台代码迁移分析  的工具。从 v25.0 起，DevKit 采用   模块化 RPM 包设计 ，需安装多个组件才能使用源码迁移功能。本次实验我带大家实操一下码迁移分析使用，实验有以下几点需要注意。</p>
<p>⚠️   注意 ：</p>
<ul>
<li>25.2.rc1 为 Release Candidate 版本 ，存在权限和参数接口变更问题。</li>
<li>正式版（如 25.1.0）体验更佳，建议实验完成后升级。</li>
<li>本次实验是在华为云开发者空间上进行的，点击进入<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huaweicloud.com%2Fspace%2Fdevportal%2Fplatform%2FdevEnvironment%3Ftab%3Dcloud_desktop%26ticket%3DST-8160487-KjIyCRlHrKoolUkIbqrfPb59-sso%26locale%3Dzh-cn" target="_blank" title="https://developer.huaweicloud.com/space/devportal/platform/devEnvironment?tab=cloud_desktop&amp;ticket=ST-8160487-KjIyCRlHrKoolUkIbqrfPb59-sso&amp;locale=zh-cn" ref="nofollow noopener noreferrer">developer.huaweicloud.com/space/devpo…</a></li>
</ul>
<hr/>
<h2 data-id="heading-1">二、准备工作</h2>
<h3 data-id="heading-2">1. 下载所需 RPM 包</h3>
<p>确保已下载以下三个包（架构：<code>aarch64</code>）：</p>
<pre><code class="hljs language-bash" lang="bash">devkit-25.2.rcll-1.aarch64.rpm
devkit-porting-25.2.rc1-1.aarch64.rpm     <span class="hljs-comment"># 必须！提供迁移分析能力</span>
devkit-sys-mig-25.2.rc1-1.aarch64.rpm     <span class="hljs-comment"># 可选（本次实验不需要）</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e54f10977114e1fa1ffff23f4c8309c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56eL6K-0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768554712&amp;x-signature=muxyIhN5zvFzfiloi%2B%2FBRHqnajc%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>💡 若未下载，请从 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.hikunpeng.com%2Fzh%2Fdeveloper%2Fdevkit%2Fdownload%3Ftab%3DcommandLine" target="_blank" title="https://www.hikunpeng.com/zh/developer/devkit/download?tab=commandLine" ref="nofollow noopener noreferrer">华为鲲鹏社区</a> 获取。</p>
</blockquote>
<h3 data-id="heading-3">2. 准备待分析项目</h3>
<p>以开源项目 <code>simdjson</code> 为例：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> ~
git <span class="hljs-built_in">clone</span> https://github.com/simdjson/simdjson.git
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/029dba0f48de4266a0c1719706557931~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56eL6K-0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768554712&amp;x-signature=F8tmF4b5lT068WFkZXnn6JSYH2c%3D" alt="image.png" loading="lazy"/></p>
<p>项目路径：<code>/home/developer/simdjson</code></p>
<hr/>
<h2 data-id="heading-4">三、安装 DevKit</h2>
<h3 data-id="heading-5">1. 卸载旧版本（如有）</h3>
<pre><code class="hljs language-javascript" lang="javascript">sudo rpm -e devkit devkit-porting devkit-sys-mig <span class="hljs-number">2</span>&gt;<span class="hljs-regexp">/dev/</span><span class="hljs-literal">null</span> || <span class="hljs-literal">true</span>
</code></pre>
<h3 data-id="heading-6">2. 按依赖顺序安装 RPM 包</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 进入 RPM 所在目录（假设在 ~/Downloads）</span>
<span class="hljs-built_in">cd</span> ~/Downloads

<span class="hljs-comment"># 安装主框架</span>
sudo rpm -ivh devkit-25.2.rc1-1.aarch64.rpm

<span class="hljs-comment"># 安装源码迁移模块（关键！）</span>
sudo rpm -ivh devkit-porting-25.2.rc1-1.aarch64.rpm

<span class="hljs-comment"># （可选）安装系统迁移模块</span>
<span class="hljs-comment"># sudo rpm -ivh devkit-sys-mig-25.2.rc1-1.aarch64.rpm</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/676c849d890e49ebb7a4177c1f450755~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56eL6K-0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768554712&amp;x-signature=Yeym1n6fi7Xoq6A4FSfBwjBfzVE%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>✅ 验证安装：
<code>/usr/local/devkit/devkit --version</code></p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d961c76991b64b51978231ed9b79365d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56eL6K-0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768554712&amp;x-signature=q4Seuw2A79Rsg6HYnyVUsjf%2Fk84%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-7">四、运行源码迁移分析</h2>
<h3 data-id="heading-8">1. 创建输出目录</h3>
<pre><code class="hljs language-arduino" lang="arduino">mkdir -p /home/developer/migration_report
</code></pre>
<h3 data-id="heading-9">2. 执行分析命令（关键：使用新参数格式）</h3>
<blockquote>
<p>⚠️   DevKit 25.2.rc1 参数变更 ：
<code>--project-path</code> → <code>--input</code> 或 <code>-i</code>
<code>--output-path</code> → <code>--output</code> 或 <code>-o</code>
<code>--language</code> → <code>--source-type</code></p>
</blockquote>
<pre><code class="hljs language-css" lang="css">sudo devkit porting <span class="hljs-attribute">src</span>-mig \
  <span class="hljs-attr">--input</span> /home/developer/simdjson \
  <span class="hljs-attr">--output</span> /home/developer/migration_report \
  <span class="hljs-attr">--source-type</span> c,c++
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a1e7208d3b94f96a60bba6cac095ca8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56eL6K-0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768554712&amp;x-signature=I52Pm%2BXjZqYTGC%2BdUMYMuoBY97Y%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>🔍   为什么用  <code> sudo</code>  ？
RC 版本硬编码日志路径为 <code>/usr/local/devkit/...</code>，普通用户无写权限。
正式版默认使用 <code>$HOME/.kunpeng-devkit</code>，无需 <code>sudo</code>。</p>
</blockquote>
<h3 data-id="heading-10">3. 等待分析完成</h3>
<p>典型输出：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">Using the local system as target os:</span> <span class="hljs-string">openeuler22.03</span>
<span class="hljs-attr">Current progress:</span> [<span class="hljs-number">100</span><span class="hljs-string">%</span>] [<span class="hljs-string">Phase</span> <span class="hljs-number">3</span><span class="hljs-string">/3</span>] <span class="hljs-string">Scan</span> <span class="hljs-string">completed.</span> <span class="hljs-string">Generating</span> <span class="hljs-string">reports.</span>
<span class="hljs-string">...</span>
<span class="hljs-attr">Files to be modified:</span> <span class="hljs-number">30</span>
<span class="hljs-attr">Lines to be modified:</span> <span class="hljs-number">204</span>
<span class="hljs-attr">Estimated transplant workload:</span> <span class="hljs-number">0.5</span> <span class="hljs-string">person/months.</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17f1344bb887493299a552cbd177619a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56eL6K-0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768554712&amp;x-signature=%2FCC%2FfAVmJQ8BMQ5UwZoYWO9ZR7I%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-11">五、查看分析报告</h2>
<h3 data-id="heading-12">1. 报告文件列表</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">ls</span> ~/migration_report/
</code></pre>
<p>生成三个文件：</p>
<ul>
<li><code>Code_Porting_ .html</code> ←   主报告（推荐）</li>
<li><code>Code_Porting_ .csv</code>  ← 表格数据</li>
<li><code>Code_Porting_ .json</code> ← 原始数据</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/028d22157ab84539a0d5778240ed8ea5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56eL6K-0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768554712&amp;x-signature=WyiXT7cfcgz0x1yKzD9pl9qeAkQ%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-13">3. 报告内容解读</h3>

























<table><thead><tr><th>类别</th><th>说明</th></tr></thead><tbody><tr><td>架构相关指令</td><td>x86 汇编（如 <code>_mm_load_si128</code>）、SSE/AVX 内建函数</td></tr><tr><td>编译器差异</td><td>GCC/Clang 特有扩展在 ARM64 上的兼容性</td></tr><tr><td>字节序与对齐</td><td>大端/小端、内存对齐问题</td></tr><tr><td>依赖库兼容性</td><td>第三方库是否支持 ARM64</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-14">六、常见问题与解决方案</h2>



































<table><thead><tr><th>问题</th><th>原因</th><th>解决方案</th></tr></thead><tbody><tr><td><code>error: init execute pwd failed</code></td><td>未安装 <code>devkit-porting</code></td><td>安装 <code>devkit-porting- .rpm</code></td></tr><tr><td><code>Permission denied: common.log.lock</code></td><td>RC 版硬编码系统路径</td><td>使用  <code> sudo</code>   运行</td></tr><tr><td><code>The task name is incorrect</code></td><td>未指定子任务</td><td>使用 <code>devkit porting src-mig ...</code></td></tr><tr><td><code>required: -i/--input</code></td><td>参数格式变更</td><td>将 <code>--project-path</code> 改为 <code>--input</code></td></tr><tr><td>SELinux 阻止写入</td><td>安全策略限制</td><td>临时执行 <code>sudo setenforce 0</code></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-15">七、后续建议</h2>
<h3 data-id="heading-16">1. 升级到正式版</h3>
<p>卸载 RC 版：</p>
<pre><code class="hljs">sudo rpm -e devkit devkit-porting devkit-sys-mig
</code></pre>
<p>下载并安装   DevKit 25.1.0 正式版 ，享受：</p>
<ul>
<li>无需 <code>sudo</code></li>
<li>自动使用 <code>$HOME/.kunpeng-devkit</code></li>
<li>更稳定的 CLI 接口</li>
</ul>
<h3 data-id="heading-17">2. 修改代码并验证</h3>
<p>根据报告提示：</p>
<ul>
<li>替换 x86 内建函数为 ARM NEON 等价实现</li>
<li>添加跨平台宏（如 <code>#ifdef __aarch64__</code>）</li>
<li>在鲲鹏服务器上编译测试</li>
</ul>
<hr/>
<h2 data-id="heading-18">八、附录：完整命令速查</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装</span>
sudo rpm -ivh devkit- .rpm devkit-porting- .rpm

<span class="hljs-comment"># 分析（RC 版必须用 sudo + 新参数）</span>
sudo devkit porting src-mig \
  --input /path/to/source \
  --output /path/to/report \
  --source-type c,c++

<span class="hljs-comment"># 归还权限</span>
sudo <span class="hljs-built_in">chown</span> -R <span class="hljs-variable">$USER</span>:<span class="hljs-variable">$USER</span> /path/to/report

<span class="hljs-comment"># 查看帮助</span>
devkit porting src-mig --<span class="hljs-built_in">help</span>
</code></pre>
<hr/>
<h2 data-id="heading-19">总结</h2>
<p>作为一个开发者，在 openEuler ARM64 环境下使用 DevKit 25.2.rc1 进行源码迁移分析时，需特别注意其 RC 版本的限制：必须安装 <code>devkit-porting</code> 模块，且因日志路径硬编码于系统目录，普通用户无写权限，  需用  <code> sudo</code>   执行 。同时，CLI 参数已变更——<code>--project-path</code> 改为 <code>--input</code>，<code>--language</code> 改为 <code>--source-type</code>。虽然流程略显繁琐，但工具能精准识别 x86 专属指令（如 SSE/AVX）、内存对齐等问题，并生成 HTML 报告，极大提升 ARM64 移植效率。建议实验后升级至正式版以获得更友好的开发体验。</p>
<p>鲲鹏社区直达<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.hikunpeng.com%2Fdeveloper%3Futm_campaign%3Dcom%26utm_source%3Dcsdnkol" target="_blank" title="https://www.hikunpeng.com/developer?utm_campaign=com&amp;utm_source=csdnkol" ref="nofollow noopener noreferrer">www.hikunpeng.com/developer?u…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C# 成为 2025 年的编程语言，7个C#技巧助力开发效率]]></title>    <link>https://juejin.cn/post/7593165280488030249</link>    <guid>https://juejin.cn/post/7593165280488030249</guid>    <pubDate>2026-01-09T09:02:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593165280488030249" data-draft-id="7592990758476120083" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C# 成为 2025 年的编程语言，7个C#技巧助力开发效率"/> <meta itemprop="keywords" content="后端,.NET,C#"/> <meta itemprop="datePublished" content="2026-01-09T09:02:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ServBay"/> <meta itemprop="url" content="https://juejin.cn/user/3828929445244761"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C# 成为 2025 年的编程语言，7个C#技巧助力开发效率
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3828929445244761/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ServBay
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T09:02:45.000Z" title="Fri Jan 09 2026 09:02:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>TIOBE 公布的数据显示，C# 以 2.94% 的年度最大涨幅再度获评2025 年度编程语言，这是 C# 在三年内第二次获此殊荣，凭借的是其在榜单上最大的年度增长幅度。</p>
<p>其实，C# 早就不是当年那个贴着“Windows 独占”和“闭源”标签的语言了。从早期的模仿者到如今现代语言特性的引领者，C# 成功完成了向跨平台和开源的巨大转型。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ef1361c669747aeb3a12d40b53095bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VydkJheQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768554966&amp;x-signature=NirDk39sroy1mRZ%2BV7aU6xqCYCE%3D" alt="" loading="lazy"/></p>
<p>在企业级开发领域，C# 与 Java 的竞争持续了二十多年。相比于 Java 略显冗长和样板化的代码风格，C# 在语法设计的灵活性和演进速度上一直保持着敏锐的嗅觉。对于开发者而言，C# 版本的快速迭代意味着手里有了更多高效的工具。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5bc78edb15a1407392fe3093eeeda6f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VydkJheQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768554966&amp;x-signature=O7rh2mx5NGeg1dPGitT67tnGdPc%3D" alt="" loading="lazy"/></p>
<p>以下盘点7个在实际开发中非常实用的C#代码技巧，涵盖并发处理、内存优化及新语法特性。</p>
<h3 data-id="heading-0">多线程场景下的字典安全策略</h3>
<p>在多线程环境操作字典时，手动加锁（lock）往往容易出错且效率不高。不要重复造轮子，<code>ConcurrentDictionary&lt;TKey, TValue&gt;</code> 是专为并发读写设计的结构，内部实现了细粒度的锁机制和原子操作。</p>
<p><strong>低效：</strong></p>
<pre><code class="hljs language-c#" lang="c#"><span class="hljs-keyword">var</span> cache = <span class="hljs-keyword">new</span> Dictionary&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">int</span>&gt;();
<span class="hljs-comment">// 多线程并发写入时，普通字典非线程安全，可能导致异常或数据覆盖</span>
<span class="hljs-keyword">await</span> Task.WhenAll(dataItems.Select(<span class="hljs-keyword">async</span> item =&gt;
{
    <span class="hljs-comment">// 即使加锁，性能也会受影响</span>
    cache[item.Key] = <span class="hljs-keyword">await</span> ProcessItemAsync(item);
}));
</code></pre>
<p><strong>推荐：</strong></p>
<pre><code class="hljs language-c#" lang="c#"><span class="hljs-keyword">var</span> cache = <span class="hljs-keyword">new</span> ConcurrentDictionary&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">int</span>&gt;();
<span class="hljs-comment">// 内部已处理并发控制，读写更高效</span>
<span class="hljs-keyword">await</span> Task.WhenAll(dataItems.Select(<span class="hljs-keyword">async</span> item =&gt;
{
    cache[item.Key] = <span class="hljs-keyword">await</span> ProcessItemAsync(item);
}));
</code></pre>
<h3 data-id="heading-1">避免频繁分配空集合</h3>
<p>在返回空数组或列表时，习惯性地 <code>new</code> 一个对象会造成不必要的内存分配。特别是在高频调用的循环或 LINQ 查询中，这会显著增加垃圾回收（GC）的压力。<code>.NET</code> 为此提供了缓存的单例空对象。</p>
<p><strong>低效：</strong></p>
<pre><code class="hljs language-c#" lang="c#"><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">string</span>[<span class="hljs-number">0</span>]; <span class="hljs-comment">// 每次都在堆上分配新对象</span>
</code></pre>
<p><strong>推荐：</strong></p>
<pre><code class="hljs language-c#" lang="c#"><span class="hljs-keyword">return</span> Array.Empty&lt;<span class="hljs-built_in">string</span>&gt;(); <span class="hljs-comment">// 使用全局缓存的空实例</span>
</code></pre>
<p>同理，在 LINQ 场景下应使用 <code>Enumerable.Empty&lt;T&gt;()</code>。</p>
<h3 data-id="heading-2">善用空合并赋值运算符 (??=)</h3>
<p><code>??=</code> 运算符能让空检查和初始化逻辑变得极其简洁。它不仅减少了样板代码，还消除了不必要的嵌套，非常适合用于属性的延迟加载（Lazy Initialization）。</p>
<p><strong>低效：</strong></p>
<pre><code class="hljs language-c#" lang="c#"><span class="hljs-keyword">if</span> (userSettings == <span class="hljs-literal">null</span>)
{
    userSettings = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">string</span>&gt;();
}
</code></pre>
<p><strong>推荐：</strong></p>
<pre><code class="hljs language-c#" lang="c#"><span class="hljs-comment">// 仅当 userSettings 为 null 时才进行赋值</span>
userSettings ??= <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">string</span>&gt;();
</code></pre>
<h3 data-id="heading-3">优化日志记录中的字符串开销</h3>
<p>C# 10 引入了针对插值字符串的底层优化。在记录日志时，如果直接使用 <code>$</code> 进行拼接，即便日志级别未开启，字符串拼接的开销依然存在。使用结构化日志参数写法，可以在日志级别关闭时完全跳过插值计算。</p>
<p><strong>有隐形开销：</strong></p>
<pre><code class="hljs language-c#" lang="c#"><span class="hljs-comment">// 即使 LogLevel 关闭，字符串插值依然会执行，消耗 CPU</span>
_logger.LogInformation(<span class="hljs-string">$"Order <span class="hljs-subst">{orderId}</span> processed at <span class="hljs-subst">{DateTime.Now}</span>"</span>);
</code></pre>
<p><strong>推荐：</strong></p>
<pre><code class="hljs language-c#" lang="c#"><span class="hljs-comment">// 模板化参数，只有日志确实需要记录时，才会处理参数</span>
_logger.LogInformation(<span class="hljs-string">"Order {OrderId} processed at {ProcessTime}"</span>, orderId, DateTime.Now);
</code></pre>
<h3 data-id="heading-4">并行任务优先使用 Task.WhenAll</h3>
<p>在异步方法中，如果多个任务之间没有依赖关系，顺次 <code>await</code> 会导致它们串行执行，浪费了并发优势。应当同时启动所有任务，并等待它们全部完成。</p>
<p><strong>低效：</strong></p>
<pre><code class="hljs language-c#" lang="c#"><span class="hljs-keyword">await</span> UploadLogsAsync();
<span class="hljs-keyword">await</span> UpdateDatabaseAsync();
<span class="hljs-keyword">await</span> NotifyUserAsync();
</code></pre>
<p><strong>高效：</strong></p>
<pre><code class="hljs language-c#" lang="c#"><span class="hljs-keyword">await</span> Task.WhenAll(
    UploadLogsAsync(),
    UpdateDatabaseAsync(),
    NotifyUserAsync()
);
</code></pre>
<p><em>注：使用</em> <em><code>Task.WhenAll</code></em> 时，若发生异常，抛出的是 <code>AggregateException</code> <em>，需注意捕获处理。</em></p>
<h3 data-id="heading-5">预设字典容量以避免重哈希</h3>
<p><code>Dictionary</code> 在元素数量超出当前容量时，会触发扩容（Resize）和重哈希（Rehash），这是非常昂贵的操作。如果能预估数据量级，在构造时指定容量可以大幅减少内存分配开销。</p>
<p><strong>低效：</strong></p>
<pre><code class="hljs language-c#" lang="c#"><span class="hljs-keyword">var</span> map = <span class="hljs-keyword">new</span> Dictionary&lt;<span class="hljs-built_in">int</span>, <span class="hljs-built_in">string</span>&gt;(); <span class="hljs-comment">// 默认容量小，数据多时会多次扩容</span>
</code></pre>
<p><strong>高效：</strong></p>
<pre><code class="hljs language-c#" lang="c#"><span class="hljs-keyword">var</span> map = <span class="hljs-keyword">new</span> Dictionary&lt;<span class="hljs-built_in">int</span>, <span class="hljs-built_in">string</span>&gt;(expectedCount); <span class="hljs-comment">// 一次分配到位</span>
</code></pre>
<h3 data-id="heading-6">原始字符串字面量与插值</h3>
<p>C# 11 引入了三重引号 <code>"""</code>，完美解决了 JSON、SQL 或 HTML 字符串中引号转义的痛点。结合 <code>$$</code> 语法，还可以自定义插值符号，避免与内容中的 <code>{}</code> 冲突。</p>
<pre><code class="hljs language-c#" lang="c#"><span class="hljs-keyword">var</span> userName = <span class="hljs-string">"Alice"</span>;
<span class="hljs-keyword">var</span> userAge = <span class="hljs-number">28</span>;

<span class="hljs-comment">// 使用 $$ 前缀，表示 {{}} 才是插值，单个 {} 被视为普通字符</span>
<span class="hljs-keyword">var</span> jsonContent = $<span class="hljs-string">$""</span><span class="hljs-string">"
{
    "</span>user<span class="hljs-string">": "</span>{{userName}}<span class="hljs-string">",
    "</span>age<span class="hljs-string">": {{userAge}},
    "</span>role<span class="hljs-string">": "</span>admin<span class="hljs-string">"
}
"</span><span class="hljs-string">""</span>;
</code></pre>
<p>这种写法让代码清晰度大幅提升，再也不用数反斜杠了。</p>
<h3 data-id="heading-7">快速搞定.NET环境</h3>
<p>上述技巧跨越了多个 C# 版本，从基础的 .NET Framework 到最新的 .NET Core 及 .NET 5+。在实际工作中，维护旧项目（如 .NET 2.0）和探索新特性（如 .NET 10.0）往往需要同时进行。</p>
<p>在本地配置.NET环境时，多个运行版本还是挺麻烦的，涉及大量的环境变量切换。使用 ServBay 就能<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.servbay.com%2Ffeatures%2Fnet" target="_blank" title="https://www.servbay.com/features/net" ref="nofollow noopener noreferrer">一键安装 .NET 环境</a>，支持范围极广，从 .NET 2.0 一直到 .NET 10.0，甚至包含了 Mono 6。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54cb1c5922604fe18b4202bf6f7182c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VydkJheQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768554966&amp;x-signature=fXQIzGvaxdC6l39Q%2BuzjuIAmMHY%3D" alt="" loading="lazy"/></p>
<p>ServBay 支持多个.NET版本同时并存，完全不需要开发者手动处理环境变量冲突。无论你是需要维护十年前的老系统，还是测试最新的 C# 语法特性，都能在同一台机器上无缝切换，将精力真正集中在代码编写上。</p>
<h3 data-id="heading-8">结语</h3>
<p>代码的整洁与高效往往体现在细节之中。掌握这些 C# 技巧，不仅能减少运行时的资源消耗，更能让代码逻辑清晰易读。随着 .NET 生态的不断发展，保持对新特性的关注，并结合得力的工具来管理开发环境，是每一位开发者持续进阶的关键。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ABP9.3.0+React 19.2.0基础创建]]></title>    <link>https://juejin.cn/post/7593158683411152896</link>    <guid>https://juejin.cn/post/7593158683411152896</guid>    <pubDate>2026-01-09T09:15:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593158683411152896" data-draft-id="7592960378690879523" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ABP9.3.0+React 19.2.0基础创建"/> <meta itemprop="keywords" content="React.js"/> <meta itemprop="datePublished" content="2026-01-09T09:15:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="七八星天"/> <meta itemprop="url" content="https://juejin.cn/user/3848733848768205"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ABP9.3.0+React 19.2.0基础创建
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3848733848768205/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    七八星天
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T09:15:03.000Z" title="Fri Jan 09 2026 09:15:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前/后端技术栈</h2>
<p>服务端:</p>
<pre><code class="hljs language-makefile" lang="makefile">ABP Framework v9.3.0
	
<span class="hljs-section">ORM:</span>
	EFCore   v9.3.0
        -SqlServer V2022
      

<span class="hljs-section">环境:</span>
	.NET SDK 9.0
	
<span class="hljs-section">工具:</span>
	.ABP CLI 9.3.0
</code></pre>
<p>客户端:</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">Web:</span>
	React + Vite + TypeScript
	-UI:
		Antd
	

<span class="hljs-section">环境:</span>
	Node v20.19.6
	pnpm v10.23.0
	Android SDK
        Vite 和 React 对环境要求较宽松：支持 Node.js 较新版本（&gt;=14/16/18），通常无需严格固定版本即可运行。
<span class="hljs-section">工具:	</span>
	vite 	v7.2.4
	nvm 	v1.2.2
	vite-cli:通过npm命令,不需要全局安装
</code></pre>
<h2 data-id="heading-1">1.创建</h2>
<p>创建相应的框架项目文件</p>
<h3 data-id="heading-2">后端ABP</h3>
<pre><code class="hljs language-ruby" lang="ruby">/<span class="hljs-regexp">/ABP官网
https:/</span><span class="hljs-regexp">/abp.io/docs</span><span class="hljs-regexp">/latest/get</span>-started/layered-web-application  
</code></pre>
<h4 data-id="heading-3">🌈使用ABP_CLI创建</h4>
<pre><code class="hljs language-c#" lang="c#"><span class="hljs-comment">//手脚架说明</span>
https:<span class="hljs-comment">//abp.io/docs/latest/cli </span>
<span class="hljs-comment">//手脚架快速命令构建页面</span>
https:<span class="hljs-comment">//abp.io/get-started</span>
确认当前 CLI 安装的版本:abp --version

<span class="hljs-comment">//模板选择指南</span>
https:<span class="hljs-comment">//abp.io/docs/9.3/solution-templates/guide</span>


<span class="hljs-comment">//指定文件夹，CMD</span>
输入命令：   
abp <span class="hljs-keyword">new</span> AppCoreServer -t app  -u none -d ef -v <span class="hljs-number">9.3</span><span class="hljs-number">.0</span>
<span class="hljs-comment">//生成完后即可看到/AppCoreServer/aspnet-core文件夹</span>
</code></pre>
<h4 data-id="heading-4">项目结构</h4>
<pre><code class="hljs language-bash" lang="bash">aspnet-core/                	 		<span class="hljs-comment"># 解决方案。</span>
   ├── src/                   		 	<span class="hljs-comment"># 后端主服务代码目录。</span>
   │   ├── Application/        		 	<span class="hljs-comment"># 应用服务层，处理业务逻辑。</span>
   │   ├── Application.Contracts/       <span class="hljs-comment"># 应用服务层接口定义层。</span>
   │   ├── DbMigrator/             		<span class="hljs-comment"># 迁移层，用于配置，定义迁移数据库。</span>
   │   ├── Domain/             			<span class="hljs-comment"># 领域层，包含领域模型和业务规则。</span>
   │   ├── Domain.Shared/             	<span class="hljs-comment"># 存放通用类和定义。</span>
   │   ├── EntityFrameworkCore/ 		<span class="hljs-comment"># 数据访问层，使用 EF Core 实现数据库操作。</span>
   │   ├── HttpApi/            			<span class="hljs-comment"># HTTP API 层，定义 API 接口,暴露 REST API。</span>
   │   ├── HttpApi.Client/     			<span class="hljs-comment"># 生成 C# SDK，用于其它程序直接消费API-(可以让另一个c#项目引用该层</span>
   │   │									,然后调用Application一样调用,而不是写httlclient调用,适用于微服务,分布式)
   │   └── HttpApi.Host/       			<span class="hljs-comment"># 项目根模块，配置和运行后端服务,Program就在这里。</span>
   │
   └── <span class="hljs-built_in">test</span>/                   			<span class="hljs-comment"># 测试单元。</span>
   │   ├── Application.Tests/  			<span class="hljs-comment"># 应用服务层的测试。</span>
   │   ├── Domain.Tests/       			<span class="hljs-comment"># 领域层的测试。</span>
   │   └── IntegrationTests/   			<span class="hljs-comment"># 集成测试。</span>
   │
   └──AppCoreServer.sln					<span class="hljs-comment">#解决方案文件,包含项目路径、依赖顺序,.net10开始变成slnx</span>
   |
   └──.gitignore						<span class="hljs-comment">#定义 Git 不需要追踪的文件和目录。</span>
</code></pre>
<h4 data-id="heading-5">附录</h4>
<h5 data-id="heading-6">🧱 ABP 项目类型总览对比表</h5>























































<table><thead><tr><th>类型</th><th>名称</th><th>特点</th><th>适用场景</th><th>是否分层</th><th>是否前后端分离</th><th>是否支持模块化</th><th>是否为微服务</th></tr></thead><tbody><tr><td>1️⃣</td><td><strong>单层 Web 应用</strong> (Single Layer Web App)</td><td>所有代码在一个项目中</td><td>快速开发、小项目、原型</td><td>❌</td><td>❌（默认集成 UI）</td><td>❌</td><td>❌</td></tr><tr><td>2️⃣</td><td><strong>分层 Web 应用</strong> (Layered Web App)</td><td>领域、应用、接口、EFCore 层分离</td><td>中大型项目，清晰架构</td><td>✅</td><td>❌（默认集成 UI）</td><td>✅</td><td>❌</td></tr><tr><td>3️⃣</td><td><strong>模块项目</strong> (Module Project)</td><td>可复用、可移植、可发布为 NuGet 模块</td><td>公共服务模块、组件库</td><td>✅</td><td>❌</td><td>✅（专为模块开发）</td><td>❌</td></tr><tr><td>4️⃣</td><td><strong>微服务解决方案</strong> (Microservice Solution)</td><td>多服务、多数据库、前后端分离</td><td>大型系统、分布式部署</td><td>✅</td><td>✅（UI 独立）</td><td>✅</td><td>✅</td></tr></tbody></table>
<h3 data-id="heading-7">前端React</h3>
<pre><code class="hljs language-ruby" lang="ruby">前端<span class="hljs-title class_">React</span>+<span class="hljs-title class_">Vite</span>手脚架

/<span class="hljs-regexp">/React官网
https:/</span><span class="hljs-regexp">/zh-hans.react.dev/learn</span><span class="hljs-regexp">/creating-a-react-app

/</span><span class="hljs-regexp">/Vite官网
https:/</span><span class="hljs-regexp">/vitejs.cn/vite</span>5-cn/
</code></pre>
<h4 data-id="heading-8">🌈使用Vite创建</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//使用Vite手脚架创建React+TypeScript项目</span>


<span class="hljs-attr">cmd</span>:

<span class="hljs-attr">D</span>:\<span class="hljs-title class_">AppWmcsServer</span>&gt;npm create vite@latest
&gt; npx
&gt; create-vite

|
o  <span class="hljs-title class_">Project</span> <span class="hljs-attr">name</span>:						<span class="hljs-comment">//项目名</span>
|  react-web
|
o  <span class="hljs-title class_">Select</span> a <span class="hljs-attr">framework</span>:   				<span class="hljs-comment">//框架</span>
|  <span class="hljs-title class_">React</span>
|
o  <span class="hljs-title class_">Select</span> a <span class="hljs-attr">variant</span>:   					<span class="hljs-comment">//选择一种版本</span>
|  <span class="hljs-title class_">TypeScript</span> + <span class="hljs-variable constant_">SWC</span>
|
o  <span class="hljs-title class_">Use</span> rolldown-vite (<span class="hljs-title class_">Experimental</span>)?:  	<span class="hljs-comment">//是否使用实验性功能,否</span>
|  <span class="hljs-title class_">No</span>
|
o  <span class="hljs-title class_">Install</span> <span class="hljs-keyword">with</span> npm and start now?   	<span class="hljs-comment">//是否安装依赖,否</span>
|  <span class="hljs-title class_">No</span>
|
o  <span class="hljs-title class_">Scaffolding</span> project <span class="hljs-keyword">in</span> <span class="hljs-attr">D</span>:\<span class="hljs-title class_">AppWmcsServer</span>\react-web...
|
—  <span class="hljs-title class_">Done</span>. <span class="hljs-title class_">Now</span> <span class="hljs-attr">run</span>:

  cd react-web
  npm install
  npm run dev
<span class="hljs-attr">D</span>:\0App\<span class="hljs-title class_">ResourceCenter</span>\2App\<span class="hljs-title class_">AppWmcsServer</span>&gt;


<span class="hljs-comment">//TypeScript + SWC:</span>
<span class="hljs-comment">//使用 TypeScript 语言编写项目代码</span>
<span class="hljs-comment">//使用 SWC 作为构建时的编译器（替代 Babel 或 TSC）将.ts、.tsx 文件会被 SWC 编译为 JavaScript，速度比用 Babel 快很多</span>
</code></pre>
<h4 data-id="heading-9">项目结构</h4>
<pre><code class="hljs language-csharp" lang="csharp">react-web/
├── node_modules/       <span class="hljs-meta"># 存放项目的依赖包，由 npm 或 yarn 自动生成，不需要手动修改。</span>
├── <span class="hljs-keyword">public</span>/             <span class="hljs-meta"># 存放公共资源文件，直接复制到最终构建的输出中。</span>
│   └── favicon.ico     <span class="hljs-meta"># 项目的图标文件，通常显示在浏览器标签页中。</span>
├── index.html      	<span class="hljs-meta"># 项目的入口 HTML 文件。Vite 以此文件为基础生成最终的页面。</span>
├── src/                <span class="hljs-meta"># 源代码目录，存放主要的开发文件。</span>
│   ├── assets/         <span class="hljs-meta"># 存放静态资源文件，如图片、字体等。</span>
│   ├── components/     <span class="hljs-meta"># 存放可复用的 React 组件，每个组件可以独立开发和测试。</span>
│   ├── pages/          <span class="hljs-meta"># 存放页面级组件，每个页面代表一个路由或完整功能模块。</span>
│   ├── App.tsx         <span class="hljs-meta"># 主应用组件，通常包含路由和全局状态管理的内容。</span>
│   ├── main.tsx        <span class="hljs-meta"># 项目的入口文件，用于渲染根组件并挂载到 DOM 上。</span>
│   └── vite-env.d.ts   <span class="hljs-meta"># 为 Vite 特定的 TypeScript 类型声明文件，方便开发时的类型检查。</span>
├── tsconfig.json       <span class="hljs-meta"># 这是 TypeScript 项目的根配置文件，定义了全局的 TypeScript 编译选项</span>
├── tsconfig.app.json   <span class="hljs-meta">#这个文件是特定于应用的 TypeScript 配置文件    </span>
├── tsconfig.node.json  <span class="hljs-meta">#这个文件专门为 Node.js 环境配置 TypeScript。     </span>
├── vite.config.ts      <span class="hljs-meta"># Vite 的配置文件，用于自定义开发服务器、插件和构建流程。</span>
├── package.json        <span class="hljs-meta"># 项目的元数据文件，包含项目依赖、脚本和基本信息。</span>
├── .eslintrc.cjs       <span class="hljs-meta"># ESLint 的配置文件，用于规范代码风格和查找潜在问题。</span>
├── .gitignore          <span class="hljs-meta"># 定义 Git 不需要追踪的文件和目录。</span>
└── README.md           <span class="hljs-meta"># 自述文件项目的说明文档，包含项目简介、使用说明和贡献指南。</span>
</code></pre>
<h2 data-id="heading-10">2.项目初始化</h2>
<pre><code class="hljs">将项目模板结构不需要的文件修改删除调整
</code></pre>
<h3 data-id="heading-11">2.1 ABP</h3>
<h4 data-id="heading-12">初始化Serilog日志</h4>
<pre><code class="hljs language-c#" lang="c#"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-built_in">int</span>&gt; <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-built_in">string</span>[] args</span>)</span>
    {
        Log.Logger = <span class="hljs-keyword">new</span> LoggerConfiguration()
<span class="hljs-meta">#<span class="hljs-keyword">if</span> DEBUG</span>
            .MinimumLevel.Debug()
<span class="hljs-meta">#<span class="hljs-keyword">else</span></span>
            .MinimumLevel.Information()
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
            .MinimumLevel.Override(<span class="hljs-string">"Microsoft"</span>, LogEventLevel.Information)
            .MinimumLevel.Override(<span class="hljs-string">"Microsoft.EntityFrameworkCore"</span>, LogEventLevel.Warning)
            .Enrich.FromLogContext()
            .WriteTo.Async(c =&gt; c.File(
                <span class="hljs-string">"Logs/log-.log"</span>,
                rollingInterval: RollingInterval.Day,
                rollOnFileSizeLimit: <span class="hljs-literal">true</span>,
                fileSizeLimitBytes: <span class="hljs-number">1L</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> / <span class="hljs-number">2</span>, <span class="hljs-comment">// 500MB</span>
                retainedFileCountLimit: <span class="hljs-number">10</span>,
                shared: <span class="hljs-literal">true</span>
            ))
<span class="hljs-meta">#<span class="hljs-keyword">if</span> DEBUG  //debug时日志输出到控制台</span>
            .WriteTo.Async(c =&gt; c.Console())
<span class="hljs-meta">#<span class="hljs-keyword">endif</span>    //日志输出文件中</span>
            .CreateLogger();       

        <span class="hljs-keyword">try</span>
        {
           <span class="hljs-comment">//#省略...</span>
        }
    }
</code></pre>
<blockquote>
<p><strong>解析</strong></p>
</blockquote>
<pre><code class="hljs language-vbnet" lang="vbnet">Serilog 是一个高性能、简单的日志库，用于记录应用程序的日志。它支持丰富的输出方式（控制台、文件、数据库等），并且允许动态配置日志级别。

.MinimumLevel.Debug() 和 .MinimumLevel.Information()：这两行代码设置日志的最小级别。在 Debug 模式下，日志级别设置为 Debug，这意味着所有级别的日志都会被记录（包括 Debug、Information、Warning 等）。在 Release 模式下，日志级别设置为 Information，表示只记录 Information 级别及更高严重级别的日志。

.MinimumLevel.Override(<span class="hljs-string">"Microsoft"</span>, LogEventLevel.Information)：这行代码覆盖了 Microsoft 命名空间的日志级别，设置为 Information。这样就不会记录 Microsoft 相关的调试信息，减少日志冗余。

.WriteTo.<span class="hljs-keyword">Async</span>(...)：这里的 WriteTo 配置定义了日志的输出方式。<span class="hljs-keyword">Async</span> 是指日志会异步写入，避免影响主线程的性能。它配置了：

File：日志会写入文件。日志文件会以 Logs/log-.log 命名，并且日志会按天分割。

<span class="hljs-symbol">rollingInterval:</span> RollingInterval.Day：每一天都会生成一个新的日志文件。

<span class="hljs-symbol">rollOnFileSizeLimit:</span> <span class="hljs-literal">true</span>：当文件大小超过限制时，日志会自动滚动（即生成新的文件）。

<span class="hljs-symbol">fileSizeLimitBytes:</span> <span class="hljs-number">1L</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> / <span class="hljs-number">2</span>：日志文件的最大大小为 <span class="hljs-number">500</span>MB。

<span class="hljs-symbol">retainedFileCountLimit:</span> <span class="hljs-number">10</span>：保留最近的 <span class="hljs-number">10</span> 个日志文件，删除更早的文件。

<span class="hljs-symbol">shared:</span> <span class="hljs-literal">true</span>：文件可被多个进程共享。

Console 输出（仅在 Debug 模式下）：如果是 Debug 模式，还会输出日志到控制台。这样在调试时可以快速看到日志。
</code></pre>
<h4 data-id="heading-13">初始化配置文件</h4>
<blockquote>
<p>src/AppCoreServer.HttpApi.Host/appsettings.json 项目根配置文件</p>
</blockquote>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"App"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
       <span class="hljs-comment">//当前服务自身的根 URL，常用于服务注册或跳转（OpenIddict、身份认证等场景）</span>
    <span class="hljs-attr">"SelfUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://localhost:44239"</span><span class="hljs-punctuation">,</span>
      
       <span class="hljs-comment">//允许哪些前端域名进行跨域访问（用逗号或分号分隔）支持通配符如 https://*.xxx.com</span>
    <span class="hljs-attr">"CorsOrigins"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://*.AppCoreServer.com"</span><span class="hljs-punctuation">,</span>
      
      <span class="hljs-comment">//【Openiddict提供,授权码模式备案名单】登录完成后允许跳转的 URL 白名单（防止重定向攻击）可设置为 https://yourfrontend.com</span>
    <span class="hljs-attr">"RedirectAllowedUrls"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    
    <span class="hljs-comment">//初始配置链接字符串,EFcore默认使用Default字符串</span>
  <span class="hljs-attr">"ConnectionStrings"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"Default"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Server=.;Database=AppCoreServer;uid=sa;pwd=sa;TrustServerCertificate=True"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-comment">//认证配置，见下文OpenIdDict认证授权</span>
  <span class="hljs-attr">"AuthServer"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"Authority"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://localhost:44239"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"RequireHttpsMetadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"SwaggerClientId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AppCoreServer_Swagger"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    
  <span class="hljs-attr">"StringEncryption"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"DefaultPassPhrase"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"WVtuUXdarYDdaFZp"</span><span class="hljs-comment">//编码密钥，用于一些编码服务</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<blockquote>
<p>src/AppCoreServer.DbMigrator/appsettings.json 项目迁移配置</p>
</blockquote>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-comment">//迁移地址</span>
  <span class="hljs-attr">"ConnectionStrings"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
     <span class="hljs-attr">"Default"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Server=.;Database=AppCoreServer;uid=sa;pwd=sa;TrustServerCertificate=True"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    
  <span class="hljs-attr">"Redis"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"Configuration"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"127.0.0.1"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-comment">//OpenIddict认证模式配置</span>
  <span class="hljs-attr">"OpenIddict"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"Applications"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"AppCoreServer_Web"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"ClientId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AppCoreServer_Web"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"ClientSecret"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1q2w3e*"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"RootUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://localhost:44320"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"AppCoreServer_App"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"ClientId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AppCoreServer_App"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"RootUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://localhost:4200"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"AppCoreServer_BlazorServerTiered"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"ClientId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AppCoreServer_BlazorServerTiered"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"ClientSecret"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1q2w3e*"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"RootUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://localhost:44345"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"AppCoreServer_BlazorWebAppTiered"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"ClientId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AppCoreServer_BlazorWebAppTiered"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"ClientSecret"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1q2w3e*"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"RootUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://localhost:44345"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"AppCoreServer_Swagger"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"ClientId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AppCoreServer_Swagger"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"RootUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://localhost:44355"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<blockquote>
<p>launchSettings.json</p>
</blockquote>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">//aspnet-core\src\AppCoreServer.HttpApi.Host\Properties\launchSettings.json</span>
运行配置文件<span class="hljs-punctuation">,</span>用于开发时的端口监听配置<span class="hljs-punctuation">,</span>常用于编辑器配置启动编译<span class="hljs-punctuation">,</span>部署时忽略.

 <span class="hljs-attr">"applicationUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://localhost:44239"</span><span class="hljs-comment">//地址跟App:SelfUrl保持一致</span>
</code></pre>























<table><thead><tr><th>启动方式</th><th>使用配置</th><th>底层宿主</th><th>启动行为</th></tr></thead><tbody><tr><td><code>IIS Express</code></td><td><code>iisExpress.applicationUrl</code></td><td><strong>IIS Express 进程 (<code>iisexpress.exe</code>)</strong></td><td>通过 VS 或命令调用 <code>iisexpress.exe</code> 启动项目，不是用 <code>dotnet run</code></td></tr><tr><td><code>Kestrel</code>（dotnet run）</td><td><code>applicationUrl</code></td><td><strong>Kestrel 服务器 (<code>dotnet</code>)</strong></td><td>使用 <code>dotnet run</code> 启动程序，即调用 <code>.dll</code> 文件运行</td></tr></tbody></table>
<h3 data-id="heading-14">2.2 React</h3>
<h4 data-id="heading-15">🌈调整：</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">//新建src/view/App目录</span>
	
view/App
├──App.tsx
└──App.css



<span class="hljs-comment">//修改App.tsx:</span>
const App<span class="hljs-punctuation">:</span> React.FC = () =&gt; <span class="hljs-punctuation">{</span>
    return(
        &lt;StrictMode&gt;
      
        &lt;/StrictMode&gt;
    )
<span class="hljs-punctuation">}</span>


<span class="hljs-comment">//修改main.tsx:</span>
createRoot(document.getElementById('root')!).render(
    &lt;App/&gt;
)


<span class="hljs-comment">//如上，main.tsx作为根目录入口文件，App.tsx作为全局配置来整理项目</span>
</code></pre>
<blockquote>
<p>StrictMode:</p>
</blockquote>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-operator">&lt;</span><span class="hljs-type">StrictMode</span><span class="hljs-operator">&gt;</span> 是 <span class="hljs-type">React</span> 提供的一种工具，用来检测应用中的潜在问题<span class="hljs-operator">。</span>它不会渲染任何可见的 <span class="hljs-type">UI，只是对其子组件执行额外的检查和警告，帮助开发者编写更健壮的代码</span><span class="hljs-operator">。</span>

主要功能
检测废弃的生命周期方法：例如 componentWillMount<span class="hljs-operator">、</span>componentWillReceiveProps<span class="hljs-operator">。</span>
识别不安全的操作：比如 findDOMNode 的使用<span class="hljs-operator">。</span>
检查意外的副作用：<span class="hljs-type">React</span> 会在开发环境下对组件的 render 和 useEffect 等进行两次调用，以帮助识别潜在的副作用<span class="hljs-operator">。</span>
强制更严格的模式：提醒开发者采用 <span class="hljs-type">React</span> 推荐的最佳实践<span class="hljs-operator">。</span>
</code></pre>
<h2 data-id="heading-16">3.基础构建</h2>
<h3 data-id="heading-17">3.1 后端跨域</h3>
<h4 data-id="heading-18">🌈操作</h4>
<pre><code class="hljs language-c#" lang="c#">   <span class="hljs-string">"App"</span>: {
    <span class="hljs-string">"SelfUrl"</span>: <span class="hljs-string">"https://localhost:55555"</span>,
    <span class="hljs-string">"CorsOrigins"</span>: <span class="hljs-string">"https://*.ServerApp.com"</span>
        
 	<span class="hljs-comment">//添加了允许全部</span>
	<span class="hljs-string">"AllowAnyOrigin"</span>: <span class="hljs-string">"true"</span>
  },
 
 context.Services.AddCors(options =&gt;
        {
            options.AddDefaultPolicy(builder =&gt;
            {
                builder
                    .WithAbpExposedHeaders()
                    .SetIsOriginAllowedToAllowWildcardSubdomains()
                    .AllowAnyHeader()
                    .AllowAnyMethod().AllowCredentials().WithExposedHeaders(<span class="hljs-string">"x-elsa-workflow-instance-id"</span>);

                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">bool</span>.Parse(configuration[<span class="hljs-string">"App:AllowAnyOrigin"</span>] ?? <span class="hljs-string">"false"</span>))
                {
                    <span class="hljs-comment">//允许全部</span>
                    builder.SetIsOriginAllowed(_ =&gt; <span class="hljs-literal">true</span>);
                }
                <span class="hljs-keyword">else</span>
                {
                    <span class="hljs-comment">//否则按照CorsOrigins允许的来</span>
                    builder
                        .WithOrigins(
                            (configuration[<span class="hljs-string">"App:CorsOrigins"</span>] ?? <span class="hljs-string">""</span>)
                            .Split(<span class="hljs-string">","</span>, StringSplitOptions.RemoveEmptyEntries)
                            .Select(o =&gt; o.RemovePostFix(<span class="hljs-string">"/"</span>))
                            .ToArray()
                        );
                }
            });
        });
</code></pre>
<h3 data-id="heading-19">3.2 OpenIddict授权认证</h3>
<h4 data-id="heading-20">配置客户端</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">//aspnet-core\src\AppCoreServer.DbMigrator\appsettings.json 迁移文件配置</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"ConnectionStrings"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"Default"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Server=.;Database=AppCoreServer;uid=sa;pwd=sa;TrustServerCertificate=True"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"OpenIddict"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"Applications"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"AppCoreServer_Swagger"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"ClientId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AppCoreServer_Swagger"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"RootUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://localhost:55319"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-comment">//新增APP内部客户端,使用密码模式</span>
        <span class="hljs-attr">"AppCoreServer_App"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"ClientId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AppCoreServer_App"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"ClientSecret"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1q2w3E*"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-comment">//新增第三方访问客户端,使用授权码模式</span>
      <span class="hljs-attr">"AppCoreServer_ExternalSystems"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"ClientId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AppCoreServer_ExternalSystems"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"ClientSecret"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ExternalSystems_API"</span>
      <span class="hljs-punctuation">}</span>
      
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-21">创建客户端</h4>
<pre><code class="hljs language-c#" lang="c#"><span class="hljs-keyword">namespace</span> <span class="hljs-title">AppCoreServer.OpenIddict</span>;

<span class="hljs-comment">/* Creates initial data that is needed to property run the application
 * and make client-to-server communication possible.
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">OpenIddictDataSeedContributor</span> : <span class="hljs-title">IDataSeedContributor</span>, <span class="hljs-title">ITransientDependency</span>
{
   <span class="hljs-comment">//...省略</span>

    [<span class="hljs-meta">UnitOfWork</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">SeedAsync</span>(<span class="hljs-params">DataSeedContext context</span>)</span>
    {
        <span class="hljs-keyword">await</span> CreateScopesAsync();
        <span class="hljs-keyword">await</span> CreateApplicationsAsync();
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">CreateScopesAsync</span>()</span>
    {
        <span class="hljs-comment">//框架默认创建</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">await</span> _openIddictScopeRepository.FindByNameAsync(<span class="hljs-string">"AppCoreServer"</span>) == <span class="hljs-literal">null</span>)
        {
            <span class="hljs-keyword">await</span> _scopeManager.CreateAsync(<span class="hljs-keyword">new</span> OpenIddictScopeDescriptor {
                Name = <span class="hljs-string">"AppCoreServer"</span>, DisplayName = <span class="hljs-string">"AppCoreServer API"</span>, Resources = { <span class="hljs-string">"AppCoreServer"</span> }
            });
        }
        
        <span class="hljs-comment">//创建第三方访问客户端</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">await</span> _openIddictScopeRepository.FindByNameAsync(<span class="hljs-string">"ExternalSystems"</span>) == <span class="hljs-literal">null</span>)
        {
            <span class="hljs-keyword">await</span> _scopeManager.CreateAsync(<span class="hljs-keyword">new</span> OpenIddictScopeDescriptor {
                Name = <span class="hljs-string">"ExternalSystems"</span>, DisplayName = <span class="hljs-string">"ExternalSystems API"</span>, Resources = { <span class="hljs-string">"ExternalSystems"</span> }
            });
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">CreateApplicationsAsync</span>()</span>
    {
        
     <span class="hljs-comment">// ✅ 通用 Scope（所有客户端都能用的）</span>
    <span class="hljs-keyword">var</span> commonScopes = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">string</span>&gt;
    {
        OpenIddictConstants.Permissions.Scopes.Address,
        OpenIddictConstants.Permissions. Scopes.Email,
        OpenIddictConstants.Permissions. Scopes.Phone,
        OpenIddictConstants.Permissions.Scopes.Profile,
        OpenIddictConstants. Permissions.Scopes.Roles,
        <span class="hljs-string">"AppCoreServer"</span>,  <span class="hljs-comment">// 主 API 的 Scope</span>
        <span class="hljs-string">"ExternalSystems"</span>
    };

    <span class="hljs-keyword">var</span> configurationSection = _configuration.GetSection(<span class="hljs-string">"OpenIddict:Applications"</span>);

    <span class="hljs-comment">// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span>
    <span class="hljs-comment">// 1️⃣ Swagger 客户端（公共客户端 + 授权码模式）</span>
    <span class="hljs-comment">// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span>
    <span class="hljs-keyword">var</span> swaggerClientId = configurationSection[<span class="hljs-string">"AppCoreServer_Swagger: ClientId"</span>];
    <span class="hljs-keyword">if</span> (!swaggerClientId.IsNullOrWhiteSpace())
    {
        <span class="hljs-keyword">var</span> swaggerRootUrl = configurationSection[<span class="hljs-string">"AppCoreServer_Swagger:RootUrl"</span>]?.TrimEnd(<span class="hljs-string">'/'</span>);

        <span class="hljs-keyword">await</span> CreateApplicationAsync(
            name: swaggerClientId!,
            type: OpenIddictConstants.ClientTypes.Public,  <span class="hljs-comment">// ✅ 公共客户端</span>
            consentType: OpenIddictConstants.ConsentTypes.Implicit,  <span class="hljs-comment">// ✅ 自动同意</span>
            displayName: <span class="hljs-string">"Swagger Application"</span>,
            secret: <span class="hljs-literal">null</span>,  <span class="hljs-comment">// ✅ 公共客户端不需要 Secret</span>
            grantTypes: <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">string</span>&gt;
            {
                OpenIddictConstants.GrantTypes.AuthorizationCode  <span class="hljs-comment">// ✅ 授权码模式</span>
            },
            scopes: commonScopes,
            redirectUri: <span class="hljs-string">$"<span class="hljs-subst">{swaggerRootUrl}</span>/swagger/oauth2-redirect.html"</span>,
            clientUri: swaggerRootUrl
        );
    }

    <span class="hljs-comment">// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span>
    <span class="hljs-comment">// 2️⃣ App 客户端（内部网页/移动端 + 密码模式）</span>
    <span class="hljs-comment">// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span>
    <span class="hljs-keyword">var</span> appClientId = configurationSection[<span class="hljs-string">"AppCoreServer_App:ClientId"</span>];
    <span class="hljs-keyword">if</span> (!appClientId. IsNullOrWhiteSpace())
    {
        <span class="hljs-keyword">var</span> appClientSecret = configurationSection[<span class="hljs-string">"AppCoreServer_App:ClientSecret"</span>];  <span class="hljs-comment">// ✅ 从配置读取 Secret</span>

        <span class="hljs-keyword">await</span> CreateApplicationAsync(
            name: appClientId!,
            type: OpenIddictConstants.ClientTypes. Public,
            consentType:  OpenIddictConstants.ConsentTypes.Implicit,  <span class="hljs-comment">// ✅ 自动同意（内部系统）</span>
            displayName: <span class="hljs-string">"App Application"</span>,
            secret: <span class="hljs-literal">null</span>,
            grantTypes: <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">string</span>&gt;
            {
                OpenIddictConstants.GrantTypes.Password,  <span class="hljs-comment">// ✅ 密码模式</span>
                OpenIddictConstants.GrantTypes.RefreshToken  <span class="hljs-comment">// ✅ 支持刷新令牌</span>
            },
            scopes: commonScopes,
            redirectUri: <span class="hljs-literal">null</span>, 
            clientUri: <span class="hljs-literal">null</span>
        );
    }

    <span class="hljs-comment">// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span>
    <span class="hljs-comment">// 3️⃣ 第三方系统客户端（机密客户端 + 客户端凭证模式）</span>
    <span class="hljs-comment">// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span>
    <span class="hljs-keyword">var</span> externalSystemsClientId = configurationSection[<span class="hljs-string">"AppCoreServer_ExternalSystems:ClientId"</span>];
    <span class="hljs-keyword">if</span> (!externalSystemsClientId.IsNullOrWhiteSpace())
    {
        <span class="hljs-keyword">var</span> externalSystemsSecret = configurationSection[<span class="hljs-string">"AppCoreServer_ExternalSystems:ClientSecret"</span>];  <span class="hljs-comment">// ✅ 读取 Secret</span>

        <span class="hljs-comment">// ✅ 第三方系统专用 Scope</span>
        <span class="hljs-keyword">var</span> externalScopes = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">string</span>&gt;
        {
            <span class="hljs-string">"ExternalSystems"</span>  <span class="hljs-comment">// ✅ 只能访问外部系统 API</span>
        };
        <span class="hljs-keyword">await</span> CreateApplicationAsync(
            name: externalSystemsClientId!,
            type: OpenIddictConstants.ClientTypes.Confidential,  <span class="hljs-comment">// ✅ 机密客户端</span>
            consentType: OpenIddictConstants. ConsentTypes.Implicit,  <span class="hljs-comment">// ✅ 不需要用户确认</span>
            displayName: <span class="hljs-string">"External Systems Application"</span>, 
            secret:  externalSystemsSecret,  <span class="hljs-comment">// ✅ 必须配置 Secret</span>
            grantTypes: <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">string</span>&gt;
            {
                OpenIddictConstants.GrantTypes.ClientCredentials  <span class="hljs-comment">// ✅ 客户端凭证模式（推荐）</span>
            },
            scopes: externalScopes, 
            redirectUri: <span class="hljs-literal">null</span>, 
            clientUri: <span class="hljs-literal">null</span>
        );
    }
        
    }
}

</code></pre>
<pre><code class="hljs language-c#" lang="c#"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">SeedAsync</span>(<span class="hljs-params">DataSeedContext context</span>)</span>
{
    <span class="hljs-keyword">await</span> CreateScopesAsync();
    <span class="hljs-keyword">await</span> CreateApplicationsAsync();

    <span class="hljs-comment">//主动给admin角色添加全部权限</span>
    <span class="hljs-keyword">var</span> allPermissions =(<span class="hljs-keyword">await</span> _permissionDefinitionManager.GetPermissionsAsync()).Select(p =&gt; p.Name);
    <span class="hljs-keyword">await</span> _permissionDataSeeder.SeedAsync(<span class="hljs-string">"R"</span>,<span class="hljs-string">"admin"</span>,allPermissions);
}
</code></pre>
<h4 data-id="heading-22">执行迁移</h4>
<p>OpenIddict 使用 4 张核心表：</p>






























<table><thead><tr><th>表名</th><th>作用</th><th>主要字段</th></tr></thead><tbody><tr><td><strong>OpenIddictApplications</strong></td><td>存储客户端应用配置</td><td>ClientId, ClientSecret, Type, Permissions</td></tr><tr><td><strong>OpenIddictScopes</strong></td><td>定义权限范围</td><td>Name, DisplayName, Resources</td></tr><tr><td><strong>OpenIddictAuthorizations</strong></td><td>记录用户授权</td><td>Subject（用户ID）, ApplicationId, Scopes</td></tr><tr><td><strong>OpenIddictTokens</strong></td><td>存储 Token</td><td>Type, Payload, ExpirationDate</td></tr></tbody></table>
<p><strong>表关系</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">OpenIddictApplications（客户端）
<span class="hljs-code">    ↓ 1: N
OpenIddictAuthorizations（授权记录）
    ↓ 1:N
OpenIddictTokens（Token）
</span>
OpenIddictScopes（独立，定义可用的 Scope）
</code></pre>
<h4 data-id="heading-23">修改Token生效时间</h4>
<pre><code class="hljs language-c#" lang="c#">  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ConfigureAuthentication</span>(<span class="hljs-params">ServiceConfigurationContext context</span>)</span>
    {
        context.Services.ForwardIdentityAuthenticationForBearer(OpenIddictValidationAspNetCoreDefaults.AuthenticationScheme);
        context.Services.Configure&lt;AbpClaimsPrincipalFactoryOptions&gt;(options =&gt;
        {
            options.IsDynamicClaimsEnabled = <span class="hljs-literal">true</span>;
        });

      	<span class="hljs-comment">//AddOpenIddict的配置</span>
        context.Services.AddOpenIddict().AddServer(options =&gt;
        {
            <span class="hljs-comment">// ⏱️ Token 生命周期配置,12个小时</span>
            options.SetAccessTokenLifetime(TimeSpan.FromHours(<span class="hljs-number">12</span>));
        });
    }
</code></pre>
<h4 data-id="heading-24">创建权限</h4>
<pre><code class="hljs language-c#" lang="c#"><span class="hljs-comment">//aspnet-core\src\AppCoreServer.Application.Contracts\Permissions</span>
<span class="hljs-comment">// 权限定义提供者，用于定义模块的权限结构</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AppCoreServerPermissionDefinitionProvider</span> : <span class="hljs-title">PermissionDefinitionProvider</span>
{
    <span class="hljs-comment">// 重写 Define 方法，在其中定义你的权限结构</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Define</span>(<span class="hljs-params">IPermissionDefinitionContext context</span>)</span>
    {
        <span class="hljs-comment">// 添加权限组（用于归类权限），组名为 "frame"</span>
        <span class="hljs-keyword">var</span> myGroup = context.AddGroup(AppCoreServerPermissions.GroupName);

        <span class="hljs-comment">// 在权限组中添加一个权限，权限名为 "AppCoreServer.MyPermission1"，显示名称为“测试权限”</span>
        myGroup.AddPermission(AppCoreServerPermissions.MyPermission1, L(<span class="hljs-string">"测试权限"</span>));
    }

    <span class="hljs-comment">// 本地化方法，将字符串包装成 LocalizableString，用于多语言支持</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> LocalizableString <span class="hljs-title">L</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> name</span>)</span>
    {
        <span class="hljs-keyword">return</span> LocalizableString.Create&lt;frameResource&gt;(name);
        <span class="hljs-comment">// frameResource 是你模块的资源类，用于多语言本地化</span>
    }
}
</code></pre>
<h4 data-id="heading-25">添加权限</h4>
<pre><code class="hljs language-c#" lang="c#">[<span class="hljs-meta">Authorize(framePermissions.MyPermission1)</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">GetInventory</span>()</span>
{
    <span class="hljs-keyword">await</span> _InventoryRepository.getby();
}


此时可以测试一下swagger Ui，运行后报错<span class="hljs-number">401</span>，没有登录，然后此时可以在右上角Authoriz是解锁状态，以frame_Swagger客户端登录，
client_secret:不用输入，如果输入匹配不了，即使输入了登录账户admin密码<span class="hljs-number">1</span>q2w3E*也是错误。登录成功后,Authoriz是锁状态,即可访问权限接口。
</code></pre>
<h4 data-id="heading-26">用户密码登录</h4>
<p>postman中参数要使用x-www-form-urlencoded填写</p>
<pre><code class="hljs language-shell" lang="shell">curl --location --request POST 'https://localhost:55319/connect/token' \
--header 'User-Agent: Apifox/1.0.0 (https://apifox.com)' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--header 'Accept: */*' \
--header 'Host: localhost:55319' \
--header 'Connection: keep-alive' \
--data-urlencode 'grant_type=password' \
--data-urlencode 'client_id=AppCoreServer_App' \
--data-urlencode 'scope=AppCoreServer' \
--data-urlencode 'username=admin' \
--data-urlencode 'password=1q2w3E*'
</code></pre>
<p>响应</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"access_token"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eyJhbGciOiJSUzI1N...."</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"token_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bearer"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"expires_in"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">43199</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-27">服务端凭证登录</h4>
<pre><code class="hljs language-ini" lang="ini">POST /connect/token
Content-Type:  application/x-www-form-urlencoded

<span class="hljs-attr">grant_type</span>=client_credentials
&amp;<span class="hljs-attr">client_id</span>=AppCoreServer_ExternalSystems
&amp;<span class="hljs-attr">client_secret</span>=ExternalSystems_API
&amp;<span class="hljs-attr">scope</span>=ExternalSystems
</code></pre>
<h4 data-id="heading-28">防伪令牌</h4>
<pre><code class="hljs language-css" lang="css">问题 <span class="hljs-number">1</span>：ABP <span class="hljs-number">9.0</span> 开始强验证了吗？
答：是的！ ABP <span class="hljs-number">9.0</span> 默认强制验证防伪令牌，这是安全性增强的重大变更。

问题 <span class="hljs-number">2</span>：是否只接受 RequestVerificationToken 字段？
答：是的！ ABP 默认只接受 RequestVerificationToken 作为 <span class="hljs-selector-tag">Header</span> 名称，x-xsrf-token 是不被识别的。

解决方案
把前端的 x-xsrf-token 改成 RequestVerificationToken 即可！
</code></pre>
<p>后端禁用防伪令牌验证</p>
<pre><code class="hljs language-c#" lang="c#">注册到服务运行时中
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ConfigureAntiForgery</span>(<span class="hljs-params">ServiceConfigurationContext context</span>)</span>
{
    context.Services.Configure&lt;AbpAntiForgeryOptions&gt;(options =&gt; { options.AutoValidate = <span class="hljs-literal">false</span>; });
}
</code></pre>
<h3 data-id="heading-29">3.3 前端Vite代理+Axios封装</h3>
<h4 data-id="heading-30">🌈配置Vite</h4>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">react</span>()],
  <span class="hljs-attr">server</span>: {
  	<span class="hljs-attr">port</span>: <span class="hljs-number">5173</span>, <span class="hljs-comment">// 设置开发服务器的端口为 5173</span>
    <span class="hljs-attr">cors</span>:<span class="hljs-literal">true</span>,
    <span class="hljs-attr">proxy</span>: {
      <span class="hljs-comment">//url关键字</span>
      <span class="hljs-string">'/api'</span>: {
  		<span class="hljs-attr">target</span>: <span class="hljs-string">"https://localhost:55555/"</span>,  
        <span class="hljs-comment">//是否跨域</span>
        <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-comment">//【注意：当指定的目标地址是https的时候一定要添加上该配置，如果是http则不需要，</span>
        <span class="hljs-comment">//不然请求会一直报错500且调试前端会提示 http proxy error: Error: self signed certificate in certificate chain vite 代理报错】</span>
        <span class="hljs-attr">secure</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 如果是https接口，需要配置这个参数,禁用 SSL 校验，适用于 HTTPS 的本地开发环境</span>
        <span class="hljs-attr">ws</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 允许websocket代理</span>
        <span class="hljs-comment">// 重写配置：可以将请求url重写  ，以下意思是将'/api/app/station'进行重写，留着api加上网址=》</span>
        <span class="hljs-attr">rewrite</span>: <span class="hljs-function">(<span class="hljs-params">path</span>) =&gt;</span> path.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^\/api/</span>, <span class="hljs-string">'/api'</span>),
      }
    },
  },
})


<span class="hljs-attr">target</span>: <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_BASE_URL</span> 
这样的写法目前在config中读取环境变量是失败的
详情可见<span class="hljs-attr">https</span>:<span class="hljs-comment">//cn.vite.dev</span>
</code></pre>
<h4 data-id="heading-31">🌈Axios封装</h4>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> axios, {<span class="hljs-title class_">AxiosRequestConfig</span>, <span class="hljs-title class_">AxiosResponse</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">"axios"</span>;
<span class="hljs-keyword">import</span> {stringify} <span class="hljs-keyword">from</span> <span class="hljs-string">"qs"</span>;  
<span class="hljs-comment">//npm install qs</span>
<span class="hljs-comment">//npm install --save-dev @types/qs</span>

<span class="hljs-comment">// 定义 API 响应数据结构的接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ResponseData</span> {
    errorMessage?: <span class="hljs-built_in">string</span>;
    [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">unknown</span>;  <span class="hljs-comment">// 可以根据实际需要进行扩展</span>
}

<span class="hljs-comment">// 定义请求配置接口</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RequestConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AxiosRequestConfig</span> {
    requestType?: <span class="hljs-string">"form"</span> | <span class="hljs-string">"json"</span>;  <span class="hljs-comment">// 定义请求类型</span>
}

<span class="hljs-keyword">const</span> instance = axios.<span class="hljs-title function_">create</span>({
    <span class="hljs-attr">baseURL</span>: <span class="hljs-title function_">getBaseURL</span>(),
    <span class="hljs-comment">// timeout: 3000,</span>
    <span class="hljs-attr">headers</span>: {
        <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span>
    }
});


<span class="hljs-comment">// 请求拦截</span>
instance.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(
    <span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> {
        <span class="hljs-comment">// 根据 requestType 设置请求头或对数据进行转换</span>
        <span class="hljs-keyword">if</span> ((config <span class="hljs-keyword">as</span> <span class="hljs-title class_">RequestConfig</span>).<span class="hljs-property">requestType</span> === <span class="hljs-string">"form"</span>) {
            config.<span class="hljs-property">headers</span>[<span class="hljs-string">"Content-Type"</span>] = <span class="hljs-string">"application/x-www-form-urlencoded;charset=UTF-8"</span>;
            config.<span class="hljs-property">data</span> = <span class="hljs-title function_">stringify</span>(config.<span class="hljs-property">data</span>); <span class="hljs-comment">// 序列化为表单数据</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((config <span class="hljs-keyword">as</span> <span class="hljs-title class_">RequestConfig</span>).<span class="hljs-property">requestType</span> === <span class="hljs-string">"json"</span>) {
            config.<span class="hljs-property">headers</span>[<span class="hljs-string">"Content-Type"</span>] = <span class="hljs-string">"application/json"</span>;
        }
        <span class="hljs-keyword">return</span> config;
    },
    <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">alert</span>(err.<span class="hljs-property">message</span> || <span class="hljs-string">"请求错误"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(err);
    }
);

<span class="hljs-comment">// 响应拦截</span>
instance.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(
    <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> response,
    <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> errorMessage = <span class="hljs-title function_">getErrorMessage</span>(err.<span class="hljs-property">response</span>);
        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">alert</span>(errorMessage || err.<span class="hljs-property">message</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(err); <span class="hljs-comment">// 保证错误被业务捕获</span>
    }
);



<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> request&lt;T = <span class="hljs-title class_">ResponseData</span>&gt;(
    <span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>,
    <span class="hljs-attr">param</span>: <span class="hljs-title class_">RequestConfig</span> = {}
): <span class="hljs-title class_">Promise</span>&lt;T&gt; {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> instance&lt;T&gt;(url, {...param});
    <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>;
}



<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getErrorMessage</span> = (<span class="hljs-params">response: AxiosResponse | <span class="hljs-literal">undefined</span></span>) =&gt; {
    <span class="hljs-comment">//注意,当使用Vite代理时,response不是null,因为vite代理会抛错500出来</span>
    <span class="hljs-comment">//代理机制：Vite 使用 Node.js 的 http-proxy 或类似库转发请求。如果目标服务器（https://localhost:55319/）不可达，代理会捕获错误并返回 HTTP 响应（e.g., 500），而不是抛出原始的 ECONNREFUSED 或超时错误。</span>
    <span class="hljs-keyword">if</span> (!response) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"服务器未响应,请检查网络"</span>;
    }
    <span class="hljs-keyword">const</span> data = response.<span class="hljs-property">data</span>;
    <span class="hljs-keyword">if</span> (!data) {
        <span class="hljs-keyword">switch</span> (response.<span class="hljs-property">status</span>) {
            <span class="hljs-keyword">case</span> <span class="hljs-number">401</span>:
                <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">alert</span>(<span class="hljs-string">"登录已过期，请重新登录"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-title function_">reload</span>();
            <span class="hljs-keyword">case</span> <span class="hljs-number">403</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-string">"无此操作权限"</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-number">404</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-string">"服务端无此资源"</span>;
            <span class="hljs-attr">default</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-string">"未知异常,请联系开发人员"</span>;
        }
    }
    <span class="hljs-comment">// 如果后端返回了详细错误信息，可在这里优先返回</span>
    <span class="hljs-keyword">if</span> (data.<span class="hljs-property">error</span>.<span class="hljs-property">message</span>) {
        <span class="hljs-keyword">return</span> data.<span class="hljs-property">error</span>.<span class="hljs-property">message</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-string">"未知错误"</span>;
};

<span class="hljs-comment">// ✅ 核心修改：开发环境返回空字符串，让请求走相对路径</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getBaseURL</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> env = <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>;
    
    <span class="hljs-comment">// 开发环境：返回空字符串，走 Vite proxy</span>
    <span class="hljs-keyword">if</span> (env.<span class="hljs-property">DEV</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;  <span class="hljs-comment">// ✅ 关键改动</span>
    }
    

    <span class="hljs-keyword">if</span> (env.<span class="hljs-property">PROD</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${env.VITE_API_BASE_URL}</span>:<span class="hljs-subst">${env.VITE_API_PORT}</span>`</span>;
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
}

</code></pre>
<h4 data-id="heading-32">Vite.env 环境变量配置</h4>
<p>操作</p>
<pre><code class="hljs language-ini" lang="ini">手动创建以下文件
.env   		开发环境
.env.production   生产环境

文件手动新增变量
{
    <span class="hljs-attr">VITE_API_BASE_URL</span>=https://localhost
    <span class="hljs-attr">VITE_API_PORT</span> =<span class="hljs-number">44319</span>
}
</code></pre>
<p>解释</p>
<pre><code class="hljs language-typescript" lang="typescript">环境加载优先级
一份用于指定模式的文件（例如 .<span class="hljs-property">env</span>.<span class="hljs-property">production</span>）会比通用形式的优先级更高（例如 .<span class="hljs-property">env</span>）。
为了防止意外地将一些环境变量泄漏到客户端，只有以 <span class="hljs-variable constant_">VITE_</span> 为前缀的变量才会暴露给经过 vite 处理的代码



<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>) <span class="hljs-comment">//此时根据不同的环境，使用不同的环境变量</span>
==》{
    <span class="hljs-string">"BASE_URL"</span>: <span class="hljs-string">"/"</span>,
    <span class="hljs-string">"DEV"</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">//开发环境</span>
    <span class="hljs-string">"MODE"</span>: <span class="hljs-string">"development"</span>,
    <span class="hljs-string">"PROD"</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-string">"SSR"</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-string">"VITE_API_BASE_URL"</span>: <span class="hljs-string">"https://localhost"</span>,
    <span class="hljs-string">"VITE_API_PORT"</span>: <span class="hljs-string">"44319"</span>,
}

<span class="hljs-title class_">Vite</span> 在一个特殊的 <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span> 对象上暴露环境变量，这些变量在构建时会被静态地替换掉。这里有一些在所有情况下都可以使用的内建变量：
<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">MODE</span>: {<span class="hljs-built_in">string</span>} 应用运行的模式。

<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">BASE_URL</span>: {<span class="hljs-built_in">string</span>} 部署应用时的基本 <span class="hljs-variable constant_">URL</span>。他由base 配置项决定。

<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">PROD</span>: {<span class="hljs-built_in">boolean</span>} 应用是否运行在生产环境（使用 <span class="hljs-variable constant_">NODE_ENV</span>=<span class="hljs-string">'production'</span> 运行开发服务器或构建应用时使用 <span class="hljs-variable constant_">NODE_ENV</span>=<span class="hljs-string">'production'</span> ）。

<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">DEV</span>: {<span class="hljs-built_in">boolean</span>} 应用是否运行在开发环境 (永远与 <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">PROD</span>相反)。

<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">SSR</span>: {<span class="hljs-built_in">boolean</span>} 应用是否运行在 server 上。
</code></pre>
<h3 data-id="heading-33">3.4 Openapi与Swagger</h3>
<h4 data-id="heading-34">配置Swagger/json</h4>
<pre><code class="hljs language-c#" lang="c#"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ConfigureSwaggerServices</span>(<span class="hljs-params">ServiceConfigurationContext context, IConfiguration configuration</span>)</span>
    {
        context.Services.AddAbpSwaggerGenWithOAuth(
            configuration[<span class="hljs-string">"AuthServer:Authority"</span>]!,
            <span class="hljs-keyword">new</span> Dictionary&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;
            {
                    {<span class="hljs-string">"AppCoreServer"</span>, <span class="hljs-string">"AppCoreServer API"</span>}
            },
            options =&gt;
            {
                options.SwaggerDoc(<span class="hljs-string">"v1"</span>, <span class="hljs-keyword">new</span> OpenApiInfo { Title = <span class="hljs-string">"AppCoreServer API"</span>, Version = <span class="hljs-string">"v1"</span> });
                options.DocInclusionPredicate((docName, description) =&gt; <span class="hljs-literal">true</span>);
                options.CustomSchemaIds(type =&gt; type.FullName);
                
                <span class="hljs-comment">//给Swagger的json中添加  operationId字段</span>
                <span class="hljs-comment">//可见Swashbuckle  Abp.Swashbuckle.Extensions</span>
                options.CustomOperationIds(apiDesc =&gt;
                    apiDesc.TryGetMethodInfo(<span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> methodInfo) ? methodInfo.Name : <span class="hljs-literal">null</span>);
            });
    }


<span class="hljs-comment">//得到的API_json==&gt;</span>

<span class="hljs-string">"/api/abp/application-configuration"</span>: {
      <span class="hljs-string">"get"</span>: {
        <span class="hljs-string">"tags"</span>: [
          <span class="hljs-string">"AbpApplicationConfiguration"</span>
        ],
        <span class="hljs-string">"operationId"</span>: <span class="hljs-string">"GetAsync"</span>, <span class="hljs-comment">//方便前端生成方法名称</span>
        <span class="hljs-string">"parameters"</span>: [
          {
            <span class="hljs-string">"name"</span>: <span class="hljs-string">"IncludeLocalizationResources"</span>,
            <span class="hljs-string">"in"</span>: <span class="hljs-string">"query"</span>,
            <span class="hljs-string">"schema"</span>: {
              <span class="hljs-string">"type"</span>: <span class="hljs-string">"boolean"</span>
            }
          }
        ]
</code></pre>
<h4 data-id="heading-35">配置Umijs/Openapi</h4>
<blockquote>
<p>1.14.1版</p>
</blockquote>
<p>创建\reactWeb\openapi2ts.config.ts文件</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { generateService } <span class="hljs-keyword">from</span> <span class="hljs-string">'@umijs/openapi'</span>;
<span class="hljs-title function_">generateService</span>({
    <span class="hljs-comment">/**
     * 指定请求库导入语句，生成的接口文件会用到这个导入。
     * 例如你项目中封装了请求函数 request，可以写成：
     * "import { request } from '@/utils/request'"
     */</span>
    <span class="hljs-attr">requestLibPath</span>: <span class="hljs-string">"../../utils/request"</span>,

    <span class="hljs-comment">/**
     * OpenAPI / Swagger 的接口文档地址或本地文件路径。
     * 这里是本地接口文档的 HTTP 地址，生成代码会基于这个定义。
     */</span>
    <span class="hljs-attr">schemaPath</span>: <span class="hljs-string">'https://localhost:2001/swagger/v1/swagger.json'</span>,

    <span class="hljs-comment">/**
     * 项目名称，生成的文件夹名或命名空间参考名，
     * 主要用于区分不同项目的生成代码。
     */</span>
    <span class="hljs-attr">serversPath</span>: <span class="hljs-string">"./src/services"</span>,
    <span class="hljs-attr">projectName</span>: <span class="hljs-string">'api'</span>,

    <span class="hljs-comment">/**
     * TypeScript 代码中使用的命名空间名称，
     * 生成的类型、接口等都会放在这个命名空间下。
     */</span>
    <span class="hljs-attr">namespace</span>: <span class="hljs-string">'API'</span>,

    <span class="hljs-comment">/**
     * 自定义模板文件夹路径，指向你的 Nunjucks 模板目录。
     * 生成器会使用此目录下的模板文件生成代码，
     * 方便你自定义生成格式。
     */</span>  
	<span class="hljs-attr">templatesFolder</span>: <span class="hljs-string">'./openapi-template'</span>, 

    <span class="hljs-comment">/**
     * 是否使用驼峰命名法生成接口方法名称，默认 true。
     * 设为 false，接口方法名保持 PascalCase，
     * 比如 GetAsync 而不是 getAsync。
     */</span>
    <span class="hljs-attr">isCamelCase</span>: <span class="hljs-literal">false</span>,

    <span class="hljs-comment">/**
     * 钩子函数集，可以自定义生成过程的各种逻辑，
     * 这里自定义了接口函数名称生成逻辑，
     * 使用 OpenAPI 中定义的 operationId 作为函数名，
     * 如果没有则默认 'AutoGenerated'。
     */</span>
    <span class="hljs-attr">hook</span>: {
        <span class="hljs-title function_">customFunctionName</span>(<span class="hljs-params">api</span>) {
            <span class="hljs-keyword">return</span> api.<span class="hljs-property">operationId</span> || <span class="hljs-string">'AutoGenerated'</span>;
        },
    },
});

</code></pre>
<p>templatesFolder: './openapi-template',</p>
<pre><code class="hljs">需要使用自定义模板,解决默认模板生成的入参参数类型集合,重复不兼容的问题
</code></pre>
<p>配置运行命令</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsc -b &amp;&amp; vite build"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"lint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eslint ."</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"preview"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite preview"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"openapi2ts"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsx openapi2ts.config.ts"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>

<span class="hljs-comment">//有需要安装以下两个依赖包</span>
<span class="hljs-comment">//pnpm i tsx@3.14.0</span>
<span class="hljs-comment">//pnpm add tslib</span>
</code></pre>
<p>执行</p>
<pre><code class="hljs language-json" lang="json">此时可以看到 serversPath<span class="hljs-punctuation">:</span> <span class="hljs-string">"./src/services"</span>
生成了后端对应的请求文件<span class="hljs-punctuation">,</span>API的格式是按照requestLibPath<span class="hljs-punctuation">:</span> <span class="hljs-string">"../../utils/request"</span>设计
    
 <span class="hljs-comment">/** 此处后端没有提供注释 GET /api/abp/application-configuration */</span>
export async function GetAsync(
  <span class="hljs-comment">// 叠加生成的Param类型 (非body参数swagger默认没有生成对象)</span>
  params<span class="hljs-punctuation">:</span> API.GetAsyncParams<span class="hljs-punctuation">,</span>
  options?<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-punctuation">[</span>key<span class="hljs-punctuation">:</span> string<span class="hljs-punctuation">]</span><span class="hljs-punctuation">:</span> any <span class="hljs-punctuation">}</span>
) <span class="hljs-punctuation">{</span>
  return request&lt;API.ApplicationConfigurationDto&gt;(
    <span class="hljs-string">"/api/abp/application-configuration"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      method<span class="hljs-punctuation">:</span> <span class="hljs-string">"GET"</span><span class="hljs-punctuation">,</span>
      params<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        ...params<span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      ...(options || <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>)<span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">}</span>
  );
<span class="hljs-punctuation">}</span>   
</code></pre>
<h3 data-id="heading-36">3.5全局配置与路由与布局</h3>
<h4 data-id="heading-37">修改html主结构</h4>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-title class_">AppServer</span>\react-web\index.<span class="hljs-property">html</span>

修改项目主入口html，标题等为自己项目log等

<span class="hljs-attr">svg</span>:<span class="hljs-attr">https</span>:<span class="hljs-comment">//www.iconfont.cn/</span>
</code></pre>
<h4 data-id="heading-38">UI库</h4>
<pre><code class="hljs language-bash" lang="bash">以下使用了
<span class="hljs-string">"antd
"</span>antd-style<span class="hljs-string">"
"</span>@ant-design/icons<span class="hljs-string">"
"</span>@ant-design/pro-components<span class="hljs-string">"
</span></code></pre>
<h4 data-id="heading-39">构建路由</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Freactrouter.remix.org.cn%2Fhome" target="_blank" title="https://reactrouter.remix.org.cn/home" ref="nofollow noopener noreferrer">React Router 主页 | React Router - React Router 路由库</a></p>
<pre><code class="hljs language-css" lang="css">npm <span class="hljs-selector-tag">i</span> react-router-dom   ^<span class="hljs-number">7.11</span>.<span class="hljs-number">0</span>
使用数据模式
</code></pre>

































<table><thead><tr><th>包名</th><th>适用场景</th><th>优点</th><th>缺点</th><th>推荐度（Vite 项目）</th></tr></thead><tbody><tr><td><code>react-router</code></td><td>底层逻辑，非 Web 项目</td><td>灵活、可扩展</td><td>缺少 DOM 功能</td><td>低（通常不单独用）</td></tr><tr><td><code>react-router-dom</code></td><td>标准 Web SPA 路由</td><td>简单、稳定、功能齐全</td><td>缺少 SSR/SSG 等高级功能</td><td>高（基础搭建）</td></tr><tr><td><code>@react-router/dev</code></td><td>现代框架模式（v7）</td><td>SSR、SSG、数据加载、Vite 集成</td><td>配置复杂，生态较新</td><td>中高（需要高级功能）</td></tr></tbody></table>
<h5 data-id="heading-40">构建主路由链</h5>
<p>创建react-web\src\router</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">//react-web\src\router\index.ts</span>

<span class="hljs-keyword">const</span> <span class="hljs-attr">index</span>:<span class="hljs-title class_">ReturnType</span>&lt;<span class="hljs-keyword">typeof</span> createBrowserRouter&gt; = <span class="hljs-title function_">createBrowserRouter</span>([
    {
        <span class="hljs-attr">path</span>: <span class="hljs-string">"/"</span>,
        <span class="hljs-attr">element</span>: <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">"../view/ServerApp/Dashboard"</span>))),
    },
]);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> index;
                                  
                                                                    
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Dashboard</span>:<span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>= <span class="hljs-function">()=&gt;</span>{
    <span class="hljs-keyword">return</span>(
        <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>我是仪表盘<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/&gt;</span></span>
    )
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Dashboard</span>;
</code></pre>
<h5 data-id="heading-41">注册路由</h5>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> <span class="hljs-title class_">App</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span> = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">return</span>(
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">StrictMode</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">RouterProvider</span> <span class="hljs-attr">router</span>=<span class="hljs-string">{router}/</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">StrictMode</span>&gt;</span></span>
    )
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>


<span class="hljs-comment">//此时按照上述路由链，则优先展示仪表盘页面</span>
</code></pre>
<h5 data-id="heading-42">路由加载页面</h5>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> <span class="hljs-title class_">App</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span> = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">StrictMode</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">PageLoading</span>/&gt;</span>}&gt;
                <span class="hljs-tag">&lt;<span class="hljs-name">RouterProvider</span> <span class="hljs-attr">router</span>=<span class="hljs-string">{MainRouter}/</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">StrictMode</span>&gt;</span></span>
    )
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>
</code></pre>
<h5 data-id="heading-43">基础页面</h5>
<h6 data-id="heading-44">创建404页面</h6>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//npm antd-style  创建样式</span>

<span class="hljs-comment">//react-web\src\view\System\NotFound\index.tsx</span>
<span class="hljs-keyword">import</span> {useNavigate} <span class="hljs-keyword">from</span> <span class="hljs-string">"react-router-dom"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> {<span class="hljs-title class_">Button</span>, <span class="hljs-title class_">Result</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">"antd"</span>;
<span class="hljs-keyword">import</span> useStyles <span class="hljs-keyword">from</span> <span class="hljs-string">"./style.ts"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">NotFound</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span> = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> {styles} = <span class="hljs-title function_">useStyles</span>();
    <span class="hljs-keyword">const</span>  navigate=<span class="hljs-title function_">useNavigate</span>();
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Result</span>
            <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.result}</span>
            <span class="hljs-attr">icon</span>=<span class="hljs-string">{null}</span>
            <span class="hljs-attr">title</span>=<span class="hljs-string">"当前页面不存在..."</span>
            <span class="hljs-attr">subTitle</span>=<span class="hljs-string">"请检查您输入的网址是否正确，或点击下面的按钮返回上一级"</span>
            <span class="hljs-attr">extra</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span>=&gt;</span>navigate(-1)}&gt;返回上一级<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>}
        /&gt;</span>

    );
};
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">NotFound</span>;
</code></pre>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">//react-web\src\view\System\NotFound\style.ts</span>

<span class="hljs-keyword">import</span> {createStyles} <span class="hljs-keyword">from</span> <span class="hljs-string">"antd-style"</span>;
<span class="hljs-keyword">import</span> notFoundImg <span class="hljs-keyword">from</span> <span class="hljs-string">"../../../assets/404.png"</span>

<span class="hljs-keyword">const</span> useStyles = <span class="hljs-title function_">createStyles</span>({
    <span class="hljs-attr">result</span>:{
        <span class="hljs-attr">position</span>: <span class="hljs-string">'relative'</span>,
        <span class="hljs-attr">backgroundImage</span>: <span class="hljs-string">`url(<span class="hljs-subst">${notFoundImg}</span>)`</span>,  <span class="hljs-comment">// 动态引入图片路径</span>
        <span class="hljs-attr">backgroundSize</span>: <span class="hljs-string">'cover'</span>,         <span class="hljs-comment">// 确保图片覆盖整个区域</span>
        <span class="hljs-attr">backgroundPosition</span>: <span class="hljs-string">'center'</span>,    <span class="hljs-comment">// 居中显示背景图片</span>
        <span class="hljs-attr">backgroundRepeat</span>: <span class="hljs-string">'no-repeat'</span>,   <span class="hljs-comment">// 防止图片重复</span>
        <span class="hljs-attr">textAlign</span>: <span class="hljs-string">"center"</span>,             <span class="hljs-comment">// 文本居中</span>
        <span class="hljs-attr">display</span>: <span class="hljs-string">'flex'</span>,
        <span class="hljs-attr">flexDirection</span>: <span class="hljs-string">'column'</span>,
        <span class="hljs-attr">justifyContent</span>: <span class="hljs-string">'center'</span>,        <span class="hljs-comment">// 垂直居中</span>
        <span class="hljs-attr">alignItems</span>: <span class="hljs-string">'center'</span>,            <span class="hljs-comment">// 水平居中</span>
        <span class="hljs-attr">height</span>: <span class="hljs-string">'100vh'</span>,
    },
})
<span class="hljs-keyword">export</span>  <span class="hljs-keyword">default</span>  useStyles;
</code></pre>
<h6 data-id="heading-45">加载页面</h6>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> {<span class="hljs-title class_">Spin</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">"antd"</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title class_">PageLoading</span>:<span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>=<span class="hljs-function">()=&gt;</span>{
    <span class="hljs-keyword">const</span> <span class="hljs-attr">contentStyle</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">CSSProperties</span> = {
        <span class="hljs-attr">padding</span>: <span class="hljs-number">50</span>,
        <span class="hljs-attr">background</span>: <span class="hljs-string">'rgba(0, 0, 0, 0.05)'</span>,
        <span class="hljs-attr">borderRadius</span>: <span class="hljs-number">4</span>,
    };

    <span class="hljs-keyword">return</span> (

        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
            <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
                <span class="hljs-attr">height:</span> "<span class="hljs-attr">100vh</span>", // <span class="hljs-attr">占满视口高度</span>
                <span class="hljs-attr">display:</span> "<span class="hljs-attr">flex</span>", // <span class="hljs-attr">启用</span> <span class="hljs-attr">flex</span> <span class="hljs-attr">布局</span>
                <span class="hljs-attr">justifyContent:</span> "<span class="hljs-attr">center</span>", // <span class="hljs-attr">水平居中</span>
                <span class="hljs-attr">alignItems:</span> "<span class="hljs-attr">center</span>", // <span class="hljs-attr">垂直居中</span>
                <span class="hljs-attr">flexDirection:</span> "<span class="hljs-attr">column</span>", // <span class="hljs-attr">子元素纵向排列</span>
                <span class="hljs-attr">backgroundColor:</span> "#<span class="hljs-attr">f0f2f5</span>", // <span class="hljs-attr">设置背景色</span>，<span class="hljs-attr">与</span> <span class="hljs-attr">antd</span> <span class="hljs-attr">默认一致</span>（<span class="hljs-attr">可选</span>）
            }}
        &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Spin</span> <span class="hljs-attr">tip</span>=<span class="hljs-string">"Loading"</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"large"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{contentStyle}/</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Spin</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">PageLoading</span>;
</code></pre>
<h4 data-id="heading-46">全局样式</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">//删除index.css,App.css文件</span>
<span class="hljs-comment">//AppServer\react-web\src\styles</span>
<span class="hljs-comment">//AppServer\react-web\src\styles\GlobalStyle.ts</span>


<span class="hljs-keyword">import</span> { createGlobalStyle } <span class="hljs-keyword">from</span> <span class="hljs-string">"antd-style"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">GlobalStyle</span> = <span class="hljs-title function_">createGlobalStyle</span>(
    <span class="hljs-function">(<span class="hljs-params">{ theme }</span>) =&gt;</span> <span class="hljs-string">`
html,body{
    height:100%;
    width:100%;
    background-color:<span class="hljs-subst">${theme.colorBgLayout}</span>;
}
body{
margin:0;
}
`</span>,
);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">GlobalStyle</span>;
</code></pre>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> <span class="hljs-title class_">App</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span> = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">StrictMode</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">PageLoading</span>/&gt;</span>}&gt;
                <span class="hljs-tag">&lt;<span class="hljs-name">RouterProvider</span> <span class="hljs-attr">router</span>=<span class="hljs-string">{MainRouter}/</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">GlobalStyle</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">StrictMode</span>&gt;</span></span>
    )
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>
</code></pre>
<h4 data-id="heading-47">页面布局</h4>
<h5 data-id="heading-48">添加业务路由</h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, {lazy} <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> {<span class="hljs-title class_">WindowsFilled</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">"@ant-design/icons"</span>;
<span class="hljs-keyword">import</span> {<span class="hljs-title class_">MenuDataItem</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">"@ant-design/pro-components"</span>;
<span class="hljs-keyword">import</span> {<span class="hljs-title class_">Navigate</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">"react-router-dom"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">ServiceRouters</span>: <span class="hljs-title class_">MenuDataItem</span>[] = [
    {
        <span class="hljs-attr">path</span>: <span class="hljs-string">"dashboard"</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">"主页"</span>,
        <span class="hljs-attr">element</span>: <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">"../view/ServerAppPages/Dashboard"</span>))),
    },
    {
        <span class="hljs-attr">path</span>: <span class="hljs-string">"systemManager"</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">"系统管理"</span>,
        <span class="hljs-attr">icon</span>: <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-title class_">WindowsFilled</span>),
        <span class="hljs-attr">children</span>: [
            {
                <span class="hljs-attr">path</span>: <span class="hljs-string">"ChangeLogs"</span>,
                <span class="hljs-attr">name</span>: <span class="hljs-string">"更新日志"</span>,
                <span class="hljs-attr">element</span>: (
                    <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">"../view/ServerAppPages/ChangeLogs"</span>)))
                ),
            }
        ]
    },
    { <span class="hljs-comment">//页面重定向</span>
        <span class="hljs-attr">index</span>:<span class="hljs-literal">true</span>,
        <span class="hljs-title class_">Component</span>: <span class="hljs-function">() =&gt;</span>
            <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-title class_">Navigate</span>, {
                <span class="hljs-attr">to</span>: <span class="hljs-string">"/dashboard"</span>,
            }),
    },
];

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">ServiceRouters</span>;

</code></pre>
<h5 data-id="heading-49">ProLayout</h5>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//https://procomponents.ant.design/components/layout</span>

<span class="hljs-keyword">import</span> {
    <span class="hljs-title class_">LogoutOutlined</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@ant-design/icons'</span>;
<span class="hljs-keyword">import</span> {<span class="hljs-title class_">PageContainer</span>, <span class="hljs-title class_">ProSettings</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@ant-design/pro-components'</span>;
<span class="hljs-keyword">import</span> {
    <span class="hljs-title class_">ProLayout</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@ant-design/pro-components'</span>;
<span class="hljs-keyword">import</span> {
    <span class="hljs-title class_">Button</span>,
    <span class="hljs-title class_">Dropdown</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">HeartSvg</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"../../../../public/log.svg"</span>;
<span class="hljs-keyword">import</span> {<span class="hljs-title class_">Link</span>, <span class="hljs-title class_">Outlet</span>, useLocation, useNavigate} <span class="hljs-keyword">from</span> <span class="hljs-string">"react-router-dom"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, {<span class="hljs-title class_">Suspense</span>, useState} <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">PageLoading</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"../../System/PageLoading"</span>;
<span class="hljs-keyword">import</span> serviceRouters <span class="hljs-keyword">from</span> <span class="hljs-string">"@/router/ServiceRouters.ts"</span>;


<span class="hljs-keyword">const</span> <span class="hljs-title class_">Layout</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span> = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> [settings] = useState&lt;<span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">ProSettings</span>&gt;&gt;({
        <span class="hljs-attr">fixSiderbar</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">layout</span>: <span class="hljs-string">"mix"</span>,
        <span class="hljs-attr">splitMenus</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">navTheme</span>: <span class="hljs-string">"light"</span>,
        <span class="hljs-attr">contentWidth</span>: <span class="hljs-string">"Fluid"</span>,
        <span class="hljs-attr">colorPrimary</span>: <span class="hljs-string">"#FAAD14"</span>,
        <span class="hljs-attr">siderMenuType</span>: <span class="hljs-string">"sub"</span>,
        <span class="hljs-attr">fixedHeader</span>: <span class="hljs-literal">true</span>,
    });
    <span class="hljs-keyword">const</span> username =<span class="hljs-string">"admin"</span>;
    <span class="hljs-keyword">const</span> navigate = <span class="hljs-title function_">useNavigate</span>();
    <span class="hljs-keyword">const</span> location = <span class="hljs-title function_">useLocation</span>();
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ProLayout</span>
            {<span class="hljs-attr">...settings</span>} //<span class="hljs-attr">设置属性样式配置</span>
            <span class="hljs-attr">logo</span>=<span class="hljs-string">{</span>
                &lt;<span class="hljs-attr">img</span>
                    <span class="hljs-attr">src</span>=<span class="hljs-string">{HeartSvg}</span>
                    <span class="hljs-attr">alt</span>=<span class="hljs-string">"logo"</span>
                    <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
                        <span class="hljs-attr">height:</span> <span class="hljs-attr">24</span>,
                        <span class="hljs-attr">width:</span> "<span class="hljs-attr">auto</span>",
                        <span class="hljs-attr">objectFit:</span> "<span class="hljs-attr">contain</span>",
                        <span class="hljs-attr">verticalAlign:</span> "<span class="hljs-attr">middle</span>",
                    }}
                /&gt;</span>
            }
            title={"博客"}
            menuDataRender={() =&gt; serviceRouters} //传入路由生成侧边菜单栏
            //头部标题，默认antd图标
            //面包屑，根据传递的路由名
            breadcrumbRender={(routes = []) =&gt; {
                return routes.map((route) =&gt; {
                    return {
                        path: route.path,
                        breadcrumbName: route.breadcrumbName,
                    };
                });
            }}
            //左侧边栏样式设置
            siderMenuType={"sub"}
            //左侧边栏底部样式
            menuFooterRender={(props) =&gt; {
                if (props?.collapsed) return undefined;
                return (
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">textAlign:</span> '<span class="hljs-attr">center</span>', <span class="hljs-attr">paddingBlockStart:</span> <span class="hljs-attr">12</span> }}&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>© 驰名商标<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                );
            }}
            //目前不明确
            location={location}
            //路由点击事件
            menuItemRender={(item, dom) =&gt; {
                if (item.path) {
                    return <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">{</span>`${<span class="hljs-attr">item.path</span>}`}&gt;</span>{dom}<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>;
                }
                return dom;
            }}
        &gt;
            {/* 渲染选中的页面内容 */}
            <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">PageLoading</span> /&gt;</span>}&gt;
                <span class="hljs-tag">&lt;<span class="hljs-name">PageContainer</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">Outlet</span> /&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">PageContainer</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">ProLayout</span>&gt;</span></span>
    );
};
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Layout</span>;
</code></pre>
<h5 data-id="heading-50">配置主路由</h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-title class_">MainRouter</span>: <span class="hljs-title class_">ReturnType</span>&lt;<span class="hljs-keyword">typeof</span> createBrowserRouter&gt; = <span class="hljs-title function_">createBrowserRouter</span>([
    {
        <span class="hljs-attr">path</span>:<span class="hljs-string">"/"</span>,
        <span class="hljs-attr">element</span>: <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">"../view/System/Layout"</span>))),
        <span class="hljs-attr">children</span>: serviceRouters
    },
    {
        <span class="hljs-attr">path</span>: <span class="hljs-string">"*"</span>,    <span class="hljs-comment">// 使用path: "*",匹配配置全局404</span>
        <span class="hljs-attr">element</span>: (
            <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">"../view/System/NotFound"</span>)))
        ),
    }

]);
                             
                            
</code></pre>
<h5 data-id="heading-51">理解</h5>
<pre><code class="hljs language-tex" lang="tex">应用启动时，通过路由配置以 `path: "/"` 优先加载 `Layout` 组件，作为整体框架的容器。

`Layout` 组件内部预先配置了业务路由（`serviceRouters`），将其转换为侧边栏菜单，侧边栏中的链接如 `&lt;a href="/dashboard"&gt;主页&lt;/a&gt;` 。

用户首次访问 `/` 时，通过路由重定向跳转到 `/dashboard`，确保进入系统后默认显示主页内容。

整体流程是：`Layout` 负责框架结构（侧边栏、头部、页脚），业务路由负责具体页面内容渲染，实现了框架与业务的分离与解耦。

应用挂载点只挂载全局路由配置，维护简洁，易于扩展和维护，以此分开主路由和业务路由
</code></pre>
<h4 data-id="heading-52">拓展</h4>
<h5 data-id="heading-53">路径优化</h5>
<blockquote>
<p><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fvite-tsconfig-paths" target="_blank" title="https://www.npmjs.com/package/vite-tsconfig-paths" ref="nofollow noopener noreferrer"><code>vite-tsconfig-paths</code></a></strong></p>
</blockquote>
<p>它的作用就是：
<strong>自动读取你的 <code>tsconfig.json</code> 或 <code>jsconfig.json</code> 里的路径别名配置</strong>，并在 Vite 中生效，无需手动在 <code>vite.config.ts</code> 中写 <code>alias</code>！</p>
<pre><code class="hljs language-javascript" lang="javascript">效果：
<span class="hljs-keyword">import</span> <span class="hljs-title class_">MainRouter</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"../../router/MainRouter.ts"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">MainRouter</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"@/router/MainRouter.ts"</span>;
</code></pre>
<ol>
<li>安装依赖</li>
</ol>
<pre><code class="hljs language-css" lang="css">npm install vite-tsconfig-paths <span class="hljs-attr">--save-dev</span>
</code></pre>
<ol start="2">
<li>配置 vite.config.ts</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.ts</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>;
<span class="hljs-keyword">import</span> react <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-react'</span>;
<span class="hljs-keyword">import</span> tsconfigPaths <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-tsconfig-paths'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">react</span>(),
    <span class="hljs-title function_">tsconfigPaths</span>(), <span class="hljs-comment">// 👈 自动读取 tsconfig.json 中的 paths</span>
  ],
});
</code></pre>
<ol start="3">
<li>设置 tsconfig.json 中的路径别名</li>
</ol>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// tsconfig.app.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
   
    <span class="hljs-comment">//引用路径替代</span>
    <span class="hljs-attr">"baseUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"."</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 设置基准路径为项目根目录</span>
    <span class="hljs-attr">"paths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"@/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/*"</span><span class="hljs-punctuation">]</span>  <span class="hljs-comment">// 现在可以工作</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>优点</p>
<ul>
<li>不需要手动写 <code>resolve.alias</code>。</li>
<li>支持多个别名，如 <code>"@components/*": ["src/components/*"]</code>。</li>
<li>和 <code>tsc</code> / IDE / ESLint / Jest 保持一致性。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GitHub Fork 协作完整流程]]></title>    <link>https://juejin.cn/post/7592887786967466020</link>    <guid>https://juejin.cn/post/7592887786967466020</guid>    <pubDate>2026-01-09T08:17:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592887786967466020" data-draft-id="7592887786967416868" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GitHub Fork 协作完整流程"/> <meta itemprop="keywords" content="前端,Git,前端工程化"/> <meta itemprop="datePublished" content="2026-01-09T08:17:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="眯眼因为很困啦"/> <meta itemprop="url" content="https://juejin.cn/user/2718423318278718"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GitHub Fork 协作完整流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2718423318278718/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    眯眼因为很困啦
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T08:17:17.000Z" title="Fri Jan 09 2026 08:17:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">GitHub Fork 协作完整流程</h2>
<blockquote>
<p>适用于：开源项目二次开发、插件扩展、给上游项目提交 PR（Pull Request）</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">一、Fork 是什么？</h3>
<p>Fork 是把别人的 GitHub 仓库复制一份到你自己的账号下：</p>
<pre><code class="hljs">原仓库（upstream） → 你的仓库（origin）
</code></pre>
<p>你在自己的仓库里可以随意修改代码，而不会影响原项目。</p>
<hr/>
<h3 data-id="heading-2">二、整体协作流程</h3>
<pre><code class="hljs language-css" lang="css">flowchart <span class="hljs-selector-tag">TD</span>
    <span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[原项目 GitHub 仓库]</span> --&gt;|Fork| <span class="hljs-selector-tag">B</span><span class="hljs-selector-attr">[你自己的 GitHub 仓库]</span>
    <span class="hljs-selector-tag">B</span> --&gt;|git clone| C<span class="hljs-selector-attr">[你的本地仓库]</span>
    <span class="hljs-selector-tag">A</span> --&gt;|git fetch upstream| C
    C --&gt;|git merge upstream/<span class="hljs-selector-tag">main</span>| C
    C --&gt;|git push origin| <span class="hljs-selector-tag">B</span>
    <span class="hljs-selector-tag">B</span> --&gt;|Pull Request| <span class="hljs-selector-tag">A</span>
</code></pre>
<hr/>
<h3 data-id="heading-3">三、Fork 项目（网页操作）</h3>
<ol>
<li>
<p>打开你要 Fork 的仓库，例如：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">https:</span>//github.com/vercel/<span class="hljs-keyword">next</span>.js
</code></pre>
</li>
<li>
<p>点击右上角 <strong>Fork</strong></p>
</li>
<li>
<p>选择你的 GitHub 账号</p>
</li>
<li>
<p>得到你的仓库：</p>
<pre><code class="hljs language-bash" lang="bash">https://github.com/你的用户名/next.js
</code></pre>
</li>
</ol>
<hr/>
<h3 data-id="heading-4">四、Clone 到本地</h3>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/你的用户名/next.js.git
<span class="hljs-built_in">cd</span> next.js
</code></pre>
<hr/>
<h3 data-id="heading-5">五、配置 upstream（非常重要）</h3>
<p>查看当前远程仓库：</p>
<pre><code class="hljs">git remote -v
</code></pre>
<p>你会看到：</p>
<pre><code class="hljs language-bash" lang="bash">origin https://github.com/你的用户名/next.js.git
</code></pre>
<p>添加原仓库：</p>
<pre><code class="hljs language-csharp" lang="csharp">git remote <span class="hljs-keyword">add</span> upstream https:<span class="hljs-comment">//github.com/vercel/next.js.git</span>
</code></pre>
<p>再确认：</p>
<pre><code class="hljs">git remote -v
</code></pre>
<p>应该是：</p>
<pre><code class="hljs">origin   你自己的仓库
upstream 原项目仓库
</code></pre>
<hr/>
<h3 data-id="heading-6">六、同步原项目最新代码（标准流程）</h3>
<pre><code class="hljs language-css" lang="css">git checkout <span class="hljs-selector-tag">main</span>
git fetch upstream
git merge upstream/<span class="hljs-selector-tag">main</span>
git push origin <span class="hljs-selector-tag">main</span>
</code></pre>
<p>含义：</p>
<blockquote>
<p>用原作者的 main 更新你的 main，并推送到你自己的 GitHub</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">七、开发你的功能</h3>
<pre><code class="hljs language-perl" lang="perl">git checkout -b <span class="hljs-keyword">my</span>-feature
<span class="hljs-comment"># 修改代码</span>
git add .
git commit -m <span class="hljs-string">"Add my feature"</span>
git <span class="hljs-keyword">push</span> origin <span class="hljs-keyword">my</span>-feature
</code></pre>
<hr/>
<h3 data-id="heading-8">八、提交 Pull Request</h3>
<ol>
<li>
<p>打开你的 GitHub 仓库</p>
</li>
<li>
<p>GitHub 会提示：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">Compare</span> &amp; Pull Request
</code></pre>
</li>
<li>
<p>点击并填写说明</p>
</li>
<li>
<p>提交 → 原项目维护者审核</p>
</li>
</ol>
<hr/>
<h3 data-id="heading-9">九、为什么必须使用 upstream？</h3>

















<table><thead><tr><th>远程名</th><th>作用</th></tr></thead><tbody><tr><td>origin</td><td>你自己的 GitHub 仓库</td></tr><tr><td>upstream</td><td>原作者的 GitHub 仓库</td></tr></tbody></table>
<p>你只向 origin push，但要从 upstream 获取最新版本。</p>
<hr/>
<h3 data-id="heading-10">十、fetch vs merge 的正确用法</h3>
<pre><code class="hljs language-rust" lang="rust">sequenceDiagram
    participant U <span class="hljs-keyword">as</span> GitHub upstream
    participant L <span class="hljs-keyword">as</span> Local Repo
    participant O <span class="hljs-keyword">as</span> GitHub origin

    U<span class="hljs-punctuation">-&gt;</span>&gt;L: git fetch upstream
    L<span class="hljs-punctuation">-&gt;</span>&gt;L: upstream/main 更新
    L<span class="hljs-punctuation">-&gt;</span>&gt;L: git merge upstream/main
    L<span class="hljs-punctuation">-&gt;</span>&gt;O: git push origin main
</code></pre>
<ul>
<li><code>fetch</code> = 下载真实世界</li>
<li><code>merge</code> = 使用真实世界</li>
</ul>
<p>永远不要跳过 fetch。</p>
<hr/>
<h3 data-id="heading-11">十一、错误示例（不要这样）</h3>
<pre><code class="hljs language-bash" lang="bash">git merge upstream/main   <span class="hljs-comment"># ❌ 如果你没先 fetch</span>
</code></pre>
<p>你合并的可能是 <strong>几个月前缓存的 upstream</strong>，非常危险。</p>
<hr/>
<h3 data-id="heading-12">十二、最佳实践总结</h3>
<blockquote>
<p>Fork 项目的生存法则</p>
</blockquote>
<pre><code class="hljs language-sql" lang="sql">只向 origin 写代码  
只从 upstream 读更新  
<span class="hljs-keyword">fetch</span> 在前，<span class="hljs-keyword">merge</span> 在后
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀 React Router 7 + Vercel 部署全指南]]></title>    <link>https://juejin.cn/post/7593077945015779355</link>    <guid>https://juejin.cn/post/7593077945015779355</guid>    <pubDate>2026-01-09T08:20:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593077945015779355" data-draft-id="7592992745574465574" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀 React Router 7 + Vercel 部署全指南"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-09T08:20:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="whisper"/> <meta itemprop="url" content="https://juejin.cn/user/2814366169706040"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀 React Router 7 + Vercel 部署全指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2814366169706040/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    whisper
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T08:20:16.000Z" title="Fri Jan 09 2026 08:20:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、 开发环境准备 (本地)</h3>
<ol>
<li><strong>推荐包管理器</strong>：使用 <code>pnpm</code> 替代 <code>npm</code> 以获得更快的构建速度和更清晰的依赖管理。</li>
</ol>
<p>如果已经使用npm构建，那么先删掉node_modules文件夹，安装pnpm</p>
<pre><code class="hljs">pnpm install
</code></pre>
<ol start="2">
<li><strong>Node.js 版本限制</strong>：</li>
</ol>
<p>在 <code>package.json</code> 中显式指定：</p>
<ul>
<li>
<ul>
<li>JSON</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"engines"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"20.x"</span> <span class="hljs-punctuation">}</span>
</code></pre>
<ol start="3">
<li><strong>静态模式配置 (SPA)</strong> ：</li>
</ol>
<p>若不需要 SSR（服务端渲染），在 <code>react-router.config.ts</code> 中设置：</p>
<ul>
<li>
<ul>
<li>TypeScript</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> { ssr: <span class="hljs-literal">false</span> } satisfies Config;
</code></pre>
<ol start="4">
<li><strong>关联github及vercel</strong></li>
</ol>
<p>本地代码提交到github，同时登录vercel平台，将vercel与github关联上，后续你在本地改动了代码并提交到github后，访问vercel平台的项目域名就能看到改动的内容了</p>
<hr/>
<h3 data-id="heading-1">二、 静态资源与图标 (Icon)</h3>
<ol>
<li><strong>文件存放</strong>：所有的图片、SVG 图标必须放在根目录的 <code>public/</code> 文件夹下。</li>
<li><strong>页面引入</strong>：</li>
</ol>
<p>在 <code>app/root.tsx</code> 的 <code>links</code> 函数中配置：</p>
<ul>
<li>
<ul>
<li>TypeScript</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">export const links: <span class="hljs-attr">LinksFunction</span> = () =&gt; [
  { rel: <span class="hljs-string">"icon"</span>, type: <span class="hljs-string">"image/svg+xml"</span>, href: <span class="hljs-string">"/logo.svg"</span> },
]<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h3 data-id="heading-2">三、 Vercel 部署关键点 (最重要)</h3>
<p>如果你遇到 <code>now-php</code> 或 <code>Function Runtimes</code> 报错，请检查以下配置：</p>
<p><code>vercel.json</code> <strong>配置</strong>（强制静态重写，防止 404）：</p>
<ol>
<li>JSON</li>
</ol>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"framework"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"rewrites"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span> <span class="hljs-attr">"source"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/(.*)"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"destination"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ol start="2">
<li><strong>Vercel 后台设置</strong>：</li>
</ol>
<ul>
<li>
<ul>
<li><strong>Framework Preset</strong>: 优先选择 <code>Vite</code>；如果被锁定为 <code>React Router</code>，请确保手动开启 <strong>Build and Output Settings</strong>。</li>
<li><strong>Build Command</strong>: <code>pnpm build</code></li>
<li><strong>Output Directory</strong>: <code>dist</code>（如果在脚本中手动移动了产物）或 <code>build/client</code>。</li>
<li><strong>Install Command</strong>: <code>pnpm install</code></li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-3">四、 自定义域名</h3>
<ol>
<li><strong>修改 Vercel 默认域名</strong>：</li>
</ol>
<ul>
<li>
<ul>
<li><code>Settings</code> -&gt; <code>Domains</code> -&gt; <code>Edit</code>，可以直接修改 <code>xxx.vercel.app</code> 的前缀。</li>
</ul>
</li>
</ul>
<ol start="2">
<li><strong>绑定独立域名</strong>：</li>
</ol>
<ul>
<li>
<ul>
<li>在 <code>Domains</code> 页面输入你购买的域名。</li>
<li><strong>DNS 配置</strong>：</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>
<ul>
<li><strong>A 记录</strong>：指向 <code>76.76.21.21</code>。</li>
<li><strong>CNAME 记录</strong>：指向 <code>cname.vercel-dns.com</code>。</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-4">💡 核心避坑心得</h3>
<ul>
<li><strong>清理缓存</strong>：部署报错时，尝试删除 Vercel 项目重新导入，并确保 <code>pnpm-lock.yaml</code> 是最新的。</li>
<li><strong>路径大小写</strong>：Vercel 的 Linux 环境对文件名大小写敏感，确保 <code>import</code> 路径与文件名完全一致。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从vue3 watch开始理解Vue的响应式原理]]></title>    <link>https://juejin.cn/post/7592922036093222927</link>    <guid>https://juejin.cn/post/7592922036093222927</guid>    <pubDate>2026-01-09T08:23:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592922036093222927" data-draft-id="7592939457043529780" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从vue3 watch开始理解Vue的响应式原理"/> <meta itemprop="keywords" content="Vue.js,前端"/> <meta itemprop="datePublished" content="2026-01-09T08:23:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="徐徐子"/> <meta itemprop="url" content="https://juejin.cn/user/1724455245584872"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从vue3 watch开始理解Vue的响应式原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1724455245584872/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    徐徐子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T08:23:32.000Z" title="Fri Jan 09 2026 08:23:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从vue3 watch开始理解Vue的响应式原理</h2>
<h3 data-id="heading-1">前言</h3>
<p>vue源代码的内容非常之多，包括模板解析（把vue文件的写法解析成一个函数用来插入dom或者调整dom），依赖收集，响应式，事件处理，插槽，组件，指令，等等等。刚开始看时不知道从何看起，这里分享一个个人的学习思路，我们可以从一些关键的api开始逐步学习，这里推荐 reactive，watch。明白了这两个api时如何工作的，那vue的响应式系统就基本理解了。</p>
<h3 data-id="heading-2">let`s start</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// demo.js</span>
<span class="hljs-keyword">import</span> { reactive, watch } <span class="hljs-keyword">from</span> <span class="hljs-string">'./vue-core.js'</span>
<span class="hljs-keyword">const</span> user = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">25</span>
})
<span class="hljs-title function_">watch</span>(user, <span class="hljs-function">(<span class="hljs-params">newValue, oldValue</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(
    <span class="hljs-string">`User changed from <span class="hljs-subst">${oldValue.name}</span>,<span class="hljs-subst">${oldValue.age}</span> to <span class="hljs-subst">${newValue.name}</span>,<span class="hljs-subst">${newValue.age}</span>`</span>
  )
})
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  user.<span class="hljs-property">name</span> = <span class="hljs-string">'Bob'</span>
  user.<span class="hljs-property">age</span> = <span class="hljs-number">30</span>
}, <span class="hljs-number">1000</span>)

</code></pre>
<p>朴素的示例，如果user发生了变化。那么就会触发watch的回调。脱离vue框架，我们需要如何设计呢，首先想到的简单逻辑就是拦截user的set和get。无论是通过Proxy还是Object的set，原理是一样的。</p>
<pre><code class="hljs language-vue-core.js" lang="vue-core.js">let activeSub = null // 当前活跃的订阅者
const targetMap = new WeakMap()

export function reactive(obj) {
  return new Proxy(obj, {
    get(target, key, receiver) {
      track(target, key)
      return Reflect.get(target, key, receiver)
    },
    set(target, key, value, receiver) {
      const res = Reflect.set(target, key, value, receiver)
      trigger(target, key)
      return res
    }
  })
}
// 简化版watch实现,只考虑监听一个reactive对象（类似上面的user例子）的变化
export function watch(source, cb) {
  const getter = () =&gt; {
    for (const key in source) {
      source[key]
    }
    return source
  }
  let oldValue
  const effect = new ReactiveEffect(getter)
  const job = () =&gt; {
    const newValue = effect.run()
    //todo 对比newValue和oldValue是否有变化
    cb(newValue, oldValue)
    oldValue = newValue
  }
  effect.schedule = job
  oldValue = effect.run()
  console.log('old', oldValue)
}

// 示例解释：搜集user中每个key的下游依赖，当user的name或age变化时，触发对应的依赖更新，从而调用watch的回调函数。
function track(target, key) {
  let depsMap = targetMap.get(target)
  if (!depsMap) {
    targetMap.set(target, (depsMap = new Map()))
  }
  let dep = depsMap.get(key)
  if (!dep) {
    depsMap.set(key, (dep = new Dep()))
  }
  dep.track()
}
function trigger(target, key) {
  const depsMap = targetMap.get(target)
  if (!depsMap) return
  const dep = depsMap.get(key)
  if (dep) {
    dep.trigger()
  }
}

function Dep() {
  this.subs = new Set()
  this.track = () =&gt; {
    // 借助全局变量activeSub记录当前活跃的订阅者
    if (activeSub) {
      this.subs.add(activeSub)
    }
  }
  this.trigger = () =&gt; {
    this.subs.forEach((sub) =&gt; {
      sub.notify()
    })
  }
}

function ReactiveEffect(fn) {
  this.fn = fn
  this.notify = null // 回调函数, 可类比于watch的cb用来辅助理解
  this.schedule = null
  this.run = () =&gt; {
    // 标记当前活跃的订阅者为this 通过fn触发每个ref或者reactive对象的getter
    // 从而触发track函数，将当前活跃的订阅者this添加到dep的subs中
    const preActiveSub = activeSub
    activeSub = this
    const value = this.fn()
    activeSub = preActiveSub
    return value
  }
  // 上游的ref或者reactive对象触发setter时，会通过收集者调用trigger函数，从而触发schedule函数，在watch中就是cb函数
  this.trigger = () =&gt; {
    this.schedule?.()
  }
  this.notify = () =&gt; {
    this.trigger()
  }
}


</code></pre>
<p>从上面的demo中我们初步实现了user变动时调用一个回调，deps表示“依赖”，通俗的理解就是有多少个下游正在依赖user，例如computed，watch，render函数等等这些的最终结果都是根据上游来变动的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ea5b4ca808c4f92ad4f667b53d72641~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5b6Q5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768551812&amp;x-signature=zZe3IG9xoTjpn77lYac00AbsKMQ%3D" alt="3a7131ea44dd9bfb4726e7f3af8f988ce8045f8de77b904d636c9d9b0ff74207.png" loading="lazy"/></p>
<p>这里面其实就两个概念需要理解，一个是依赖收集者 Dep，一个是响应副作用管理器 ReactiveEffect。借助例子，Dep 理解为用来管理user中每个key都有哪些watch正在监听。而 ReactiveEffect 理解为当user的某个key发生变化时，需要调用哪些watch的回调函数。</p>
<p>调用watch的过程其实关注的就是  oldValue = effect.run() 这一段代码。在创建watch时，会立即调用effect.run()，从而触发user的getter，从而触发track函数，将当前活跃的订阅者effect添加到user.name和user.age的dep中。这样，当user.name或user.age发生变化时，就会触发trigger函数，从而调用effect的notify函数，从而调用watch的回调函数。</p>
<p>组件渲染其实就是一个特殊的watch，watch的回调函数就是渲染函数。当user的name或age发生变化时，就会触发渲染函数，从而更新dom。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 Electron 写了一个 macOS 版本的 wallpaper（附源码、下载地址）]]></title>    <link>https://juejin.cn/post/7592939457043726388</link>    <guid>https://juejin.cn/post/7592939457043726388</guid>    <pubDate>2026-01-09T08:46:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592939457043726388" data-draft-id="7592939457043349556" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 Electron 写了一个 macOS 版本的 wallpaper（附源码、下载地址）"/> <meta itemprop="keywords" content="前端,Electron,Vue.js"/> <meta itemprop="datePublished" content="2026-01-09T08:46:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="musashi"/> <meta itemprop="url" content="https://juejin.cn/user/4072246799240072"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 Electron 写了一个 macOS 版本的 wallpaper（附源码、下载地址）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4072246799240072/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    musashi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T08:46:46.000Z" title="Fri Jan 09 2026 08:46:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Mac 上一直未能找到免费且好用的类似 Wallpaper Engine 的动态壁纸软件。所以直接想着自己搞一个。</p>
<p>本文主要记录核心技术点的实现，包括“将窗口置于桌面图标下层”、“多显示器支持”、“系统托盘常驻”。</p>
<p>效果展示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/287c98bf651a4a06934c604bc032785b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbXVzYXNoaQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768553772&amp;x-signature=MvFAzM5UTh1rTEbjQIDdOnbjp84%3D" alt="output.gif" loading="lazy"/></p>
<h2 data-id="heading-0">功能支持</h2>
<ul>
<li><strong>控制中心 (Dashboard)</strong>：提供独立的控制面板，可为每个显示器单独管理壁纸。</li>
<li><strong>丰富的媒体支持</strong>：
<ul>
<li><strong>图片</strong>：支持 JPG, PNG, GIF, WebP 等常见格式。</li>
<li><strong>视频</strong>：支持 MP4, WebM, MKV, MOV (自动静音循环播放)。</li>
<li><strong>HTML</strong>：支持将任意本地 HTML 文件设置为交互式壁纸。</li>
</ul>
</li>
<li><strong>自动保存状态</strong>：应用重启后，自动恢复上次设置的壁纸配置。</li>
<li><strong>历史记录</strong>：自动记录最近使用的壁纸，方便快速切换回之前的喜爱内容。</li>
<li><strong>多显示器支持</strong>：自动检测接入的显示器，并支持多屏独立设置。</li>
<li><strong>在线画廊</strong>：内置在线资源库，可一键下载包括《绝区零》、《原神》、《鸣潮》等热门游戏的高清静态与动态壁纸。</li>
</ul>
<h2 data-id="heading-1">核心技术实现</h2>
<h3 data-id="heading-2">1. 将窗口置于桌面图标下层</h3>
<p>这是最核心的功能。Electron 的 <code>BrowserWindow</code> 提供了一个 <code>type: 'desktop'</code> 属性，在 macOS 上会将窗口置于最底层。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> win = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BrowserWindow</span>({
  <span class="hljs-attr">type</span>: <span class="hljs-string">'desktop'</span>, <span class="hljs-comment">// 关键配置：设置为桌面类型</span>
  <span class="hljs-attr">enableLargerThanScreen</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">frame</span>: <span class="hljs-literal">false</span>,    <span class="hljs-comment">// 无边框</span>
  <span class="hljs-attr">show</span>: <span class="hljs-literal">false</span>,     <span class="hljs-comment">// 先隐藏，加载完再显示</span>
  <span class="hljs-attr">webPreferences</span>: {
    <span class="hljs-attr">nodeIntegration</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">contextIsolation</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">webSecurity</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// 允许加载本地资源</span>
  }
});
</code></pre>
<p>仅仅这样还不够，为了保证交互体验，我们需要让这个窗口无法被聚焦和移动，像真正的壁纸一样。</p>
<h3 data-id="heading-3">2. 多显示器支持</h3>
<p>现在的开发环境通常都有多个屏幕。通过 Electron 的 <code>screen</code> 模块获取所有显示器，并为每个显示器创建一个独立的 BrowserWindow 实例。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { screen } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'electron'</span>);

<span class="hljs-keyword">const</span> displays = screen.<span class="hljs-title function_">getAllDisplays</span>();

displays.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">display</span>) =&gt;</span> {
  <span class="hljs-title function_">createWallpaperWindow</span>(display);
});

<span class="hljs-keyword">function</span> <span class="hljs-title function_">createWallpaperWindow</span>(<span class="hljs-params">display</span>) {
  <span class="hljs-keyword">const</span> { x, y, width, height } = display.<span class="hljs-property">bounds</span>;
  <span class="hljs-keyword">const</span> win = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BrowserWindow</span>({
    x, y, width, height, <span class="hljs-comment">// 填满当前屏幕</span>
    <span class="hljs-comment">// ... 其他配置</span>
  });
  
  <span class="hljs-comment">// 加载资源</span>
  win.<span class="hljs-title function_">loadFile</span>(<span class="hljs-string">'path/to/wallpaper.html'</span>);
}
</code></pre>
<h3 data-id="heading-4">3. 资源获取 (爬虫)</h3>
<p>为了解决壁纸来源问题，内置了一个简单的爬虫（基于 Node.js <code>fetch</code>），抓取米游社等平台的同人图和官方壁纸。</p>
<p>主要难点在于处理接口的 Referer 校验和数据分页。</p>
<h3 data-id="heading-5">4. 甚至支持关闭主窗口后常驻后台</h3>
<p>为了不让应用在关闭设置面板（主窗口）时直接退出，需要利用 <code>Tray</code> 模块和拦截 <code>window-all-closed</code> 事件。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 拦截主窗口关闭事件，改为隐藏</span>
mainWindow.<span class="hljs-title function_">on</span>(<span class="hljs-string">'close'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (!app.<span class="hljs-property">isQuitting</span>) {
    event.<span class="hljs-title function_">preventDefault</span>();
    mainWindow.<span class="hljs-title function_">hide</span>();
  }
});

<span class="hljs-comment">// 实现托盘菜单</span>
<span class="hljs-keyword">const</span> tray = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Tray</span>(iconPath);
<span class="hljs-keyword">const</span> contextMenu = <span class="hljs-title class_">Menu</span>.<span class="hljs-title function_">buildFromTemplate</span>([
  { <span class="hljs-attr">label</span>: <span class="hljs-string">'打开面板'</span>, <span class="hljs-attr">click</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">showMainWindow</span>() },
  { <span class="hljs-attr">label</span>: <span class="hljs-string">'退出'</span>, <span class="hljs-attr">click</span>: <span class="hljs-function">() =&gt;</span> {
      app.<span class="hljs-property">isQuitting</span> = <span class="hljs-literal">true</span>;
      app.<span class="hljs-title function_">quit</span>();
    } 
  }
]);
tray.<span class="hljs-title function_">setContextMenu</span>(contextMenu);
</code></pre>
<h2 data-id="heading-6">构建与分发</h2>
<h3 data-id="heading-7">1. 双架构打包</h3>
<p>为了同时支持 M1/M2/M3 (Apple Silicon) 和旧款 Intel Mac，配置了 <code>electron-builder</code> 的 universal 构建或分别构建。</p>
<p><code>package.json</code> 配置：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"mac"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"target"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"target"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"default"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"arch"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"x64"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"arm64"</span><span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-8">2. "应用已损坏，无法打开" 的解决</h3>
<p>因为没有购买 Apple 昂贵的开发者证书进行签名，编译出的 <code>.app</code> 在别人的电脑上运行时会被 macOS Gatekeeper 拦截，提示“应用已损坏”。</p>
<p>这是一个常见问题，解决方法是移除苹果的隔离属性。用户需要执行一次终端命令：</p>
<pre><code class="hljs language-bash" lang="bash">sudo xattr -rd com.apple.quarantine /Applications/Wallpaper-Mac.app
</code></pre>
<h2 data-id="heading-9">源码与下载</h2>
<p>项目已开源，虽然功能简单，但足以满足日常动态壁纸需求（支持视频、图片）。</p>
<ul>
<li><strong>GitHub 地址</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzhulinghao%2Fwallpaper-mac" target="_blank" title="https://github.com/zhulinghao/wallpaper-mac" ref="nofollow noopener noreferrer">github.com/zhulinghao/…</a></li>
<li><strong>Release 下载</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzhulinghao%2Fwallpaper-mac%2Freleases%2Ftag%2Fv1.0.0" target="_blank" title="https://github.com/zhulinghao/wallpaper-mac/releases/tag/v1.0.0" ref="nofollow noopener noreferrer">github.com/zhulinghao/…</a></li>
</ul>
<p>欢迎 Star 和 PR。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Web 仔用 Node 像 Java 一样写后端服务]]></title>    <link>https://juejin.cn/post/7593173569871183924</link>    <guid>https://juejin.cn/post/7593173569871183924</guid>    <pubDate>2026-01-09T09:10:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593173569871183924" data-draft-id="7592960378690682915" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Web 仔用 Node 像 Java 一样写后端服务"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-09T09:10:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JFChen"/> <meta itemprop="url" content="https://juejin.cn/user/4336129593055966"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Web 仔用 Node 像 Java 一样写后端服务
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4336129593055966/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JFChen
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T09:10:27.000Z" title="Fri Jan 09 2026 09:10:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>当Node.js遇上Java的优雅架构，会碰撞出怎样的火花？</p>
</blockquote>
<p>作为一名前端开发者，我们常常被Java开发者"鄙视"："Node.js就是个玩具，写写前端还行，做后端？算了吧！" 但事实真的如此吗？通过一个完整的manage-system-server项目实践，我将向大家展示如何用Node.js构建出媲美Java Spring的企业级后端服务，Node.js也可以写得这么"Java范儿"！今天就来跟大家分享这个基于 <strong>Koa + TypeScript + TypeORM</strong> 的现代化后端架构。</p>
<h2 data-id="heading-0">🏗️ 架构设计：Spring Boot的Node.js版</h2>
<p>这个项目采用了典型的分层架构，让我想起了Java Spring Boot的优雅设计：</p>
<pre><code class="hljs language-ruby" lang="ruby">src/
├── app/
│   ├── controllers/    <span class="hljs-comment"># 控制器层 - 类似Spring的<span class="hljs-doctag">@Controller</span></span>
│   ├── entity/         <span class="hljs-comment"># 数据实体 - 类似JPA Entity</span>
│   ├── service/        <span class="hljs-comment"># 业务服务层 - 类似<span class="hljs-doctag">@Service</span></span>
│   └── req-validate/   <span class="hljs-comment"># 请求验证 - 类似DTO验证</span>
├── config/             <span class="hljs-comment"># 配置管理</span>
├── decorator/          <span class="hljs-comment"># 装饰器 - 类似Spring注解</span>
├── middles/            <span class="hljs-comment"># 中间件 - 类似Spring拦截器</span>
└── tools/              <span class="hljs-comment"># 工具类</span>
</code></pre>
<h2 data-id="heading-1">🎯 核心特性：Java范儿的Node.js实现</h2>
<h3 data-id="heading-2">1. 依赖注入：告别require的混乱</h3>
<p>项目使用 <code>typedi</code> 实现依赖注入，让代码组织更加清晰：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>()
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> roleService: RoleService</span>) {}
  
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">userList</span>(<span class="hljs-params">req: IListReq</span>) {
    <span class="hljs-comment">// 业务逻辑</span>
  }
}
</code></pre>
<h3 data-id="heading-3">2. 声明式控制器：注解驱动的API设计</h3>
<p>基于 <code>routing-controllers</code> 的控制器设计，让API定义变得优雅：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@JsonController</span>()
<span class="hljs-meta">@Service</span>()
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> userService: UserService</span>) {}

  <span class="hljs-meta">@Post</span>(<span class="hljs-title class_">Api</span>.<span class="hljs-property">USER_LIST</span>)
  <span class="hljs-meta">@ApiAuth</span>(<span class="hljs-title class_">ModuleEnum</span>.<span class="hljs-property">USER</span>, <span class="hljs-title class_">OperationEnum</span>.<span class="hljs-property">QUERY</span>)
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">userList</span>(<span class="hljs-params"><span class="hljs-meta">@Body</span>({ validate: <span class="hljs-literal">true</span> }) body: IListReq</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userService</span>.<span class="hljs-title function_">userList</span>(body);
  }
}
</code></pre>
<h3 data-id="heading-4">3. 数据实体：TypeORM的ORM魔法</h3>
<p>实体类设计借鉴了JPA的思想，支持数据库字段映射和生命周期钩子：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Entity</span>(<span class="hljs-string">'user'</span>)
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserEntity</span> {
  <span class="hljs-meta">@PrimaryGeneratedColumn</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'id'</span> })
  id?: <span class="hljs-built_in">number</span>;

  <span class="hljs-meta">@Column</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'login_name'</span> })
  <span class="hljs-attr">loginName</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@Column</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'password'</span>, <span class="hljs-attr">select</span>: <span class="hljs-literal">false</span> })
  password?: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@BeforeInsert</span>()
  <span class="hljs-meta">@BeforeUpdate</span>()
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">encryptFields</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 插入/更新前自动加密密码</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">password</span> = <span class="hljs-title class_">AesTools</span>.<span class="hljs-title function_">encryptData</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">password</span>);
  }
}
</code></pre>
<h3 data-id="heading-5">4. 数据验证：类级别的参数校验</h3>
<p>使用 <code>class-validator</code> 实现请求参数验证，类似Spring的@Valid：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">IUserAddReq</span> {
  <span class="hljs-meta">@IsString</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'loginName接收类型为string'</span> })
  <span class="hljs-meta">@IsNotEmpty</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'loginName不能为空'</span> })
  <span class="hljs-attr">loginName</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@IsString</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'password接收类型为string'</span> })
  <span class="hljs-meta">@IsNotEmpty</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'password不能为空'</span> })
  <span class="hljs-meta">@IsDecryptPwd</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'password密码错误，请确认加密方式'</span> })
  <span class="hljs-attr">password</span>: <span class="hljs-built_in">string</span>;
}
</code></pre>
<h3 data-id="heading-6">5. 权限控制：基于装饰器的细粒度权限</h3>
<p>自定义权限装饰器实现方法级别的权限控制：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ApiAuth</span>(<span class="hljs-params"><span class="hljs-variable language_">module</span>: ModuleEnum, operation: OperationEnum</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">target: <span class="hljs-built_in">any</span>, propertyKey: <span class="hljs-built_in">string</span>, descriptor: PropertyDescriptor</span>) {
    <span class="hljs-title class_">Authorized</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">module</span>}</span>_<span class="hljs-subst">${operation}</span>`</span>)(target, propertyKey, descriptor);
  };
}
</code></pre>
<h2 data-id="heading-7">🔧 技术栈深度解析</h2>
<h3 data-id="heading-8">核心依赖分析</h3>
<p>从 <code>package.json</code> 可以看出项目的技术选型思路：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"koa"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.15.0"</span><span class="hljs-punctuation">,</span>           <span class="hljs-comment">// 轻量级Web框架</span>
    <span class="hljs-attr">"typeorm"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0.3.20"</span><span class="hljs-punctuation">,</span>         <span class="hljs-comment">// 强大ORM框架</span>
    <span class="hljs-attr">"routing-controllers"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^0.10.4"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 注解式路由</span>
    <span class="hljs-attr">"class-validator"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^0.14.1"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 数据验证</span>
    <span class="hljs-attr">"typedi"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^0.10.0"</span><span class="hljs-punctuation">,</span>         <span class="hljs-comment">// 依赖注入容器</span>
    <span class="hljs-attr">"reflect-metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^0.1.13"</span> <span class="hljs-comment">// 反射元数据支持</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-9">开发工具链</h3>
<p>项目配备了完整的开发工具链：</p>
<ul>
<li><strong>TypeScript 5.7.2</strong>: 类型安全的JavaScript超集</li>
<li><strong>ESLint + Prettier</strong>: 代码规范和格式化</li>
<li><strong>TypeORM迁移</strong>: 数据库版本管理</li>
<li><strong>热重载开发</strong>: nodemon实时监控文件变化</li>
</ul>
<h2 data-id="heading-10">🚀 实际应用示例</h2>
<h3 data-id="heading-11">完整的用户管理流程</h3>
<p>让我们看一个完整的用户添加流程：</p>
<p><strong>1. 控制器层接收请求</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Post</span>(<span class="hljs-title class_">Api</span>.<span class="hljs-property">USER_ADD</span>)
<span class="hljs-meta">@ApiAuth</span>(<span class="hljs-title class_">ModuleEnum</span>.<span class="hljs-property">USER</span>, <span class="hljs-title class_">OperationEnum</span>.<span class="hljs-property">ADD</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">userAdd</span>(<span class="hljs-params">
  <span class="hljs-meta">@CurrentLoginName</span>() loginName: <span class="hljs-built_in">string</span>,
  <span class="hljs-meta">@Body</span>({ validate: <span class="hljs-literal">true</span> }) body: IUserAddReq,
</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userService</span>.<span class="hljs-title function_">addUser</span>(loginName, body);
}
</code></pre>
<p><strong>2. 服务层业务逻辑</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">addUser</span>(<span class="hljs-params">creatorName: <span class="hljs-built_in">string</span>, userInfo: IUserAddReq</span>) {
  <span class="hljs-comment">// 密码解密</span>
  <span class="hljs-keyword">const</span> decryptPwd = <span class="hljs-title class_">AesTools</span>.<span class="hljs-title function_">decryptData</span>(userInfo.<span class="hljs-property">password</span>);
  
  <span class="hljs-comment">// 检查登录名重复</span>
  <span class="hljs-keyword">const</span> hasUser = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">checkDuplicateLoginName</span>(userInfo.<span class="hljs-property">loginName</span>);
  <span class="hljs-keyword">if</span> (hasUser) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">CommonTools</span>.<span class="hljs-title function_">returnError</span>(<span class="hljs-title class_">CodeEnum</span>.<span class="hljs-property">USER_LOGIN_NAME_SAME</span>);
  }
  
  <span class="hljs-comment">// 创建用户实体</span>
  <span class="hljs-keyword">const</span> insertUser = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserEntity</span>({
    <span class="hljs-attr">password</span>: decryptPwd,
    <span class="hljs-attr">username</span>: userInfo.<span class="hljs-property">username</span>,
    <span class="hljs-attr">loginName</span>: userInfo.<span class="hljs-property">loginName</span>,
    <span class="hljs-attr">creator</span>: creatorName,
  });
  
  <span class="hljs-comment">// 保存到数据库</span>
  <span class="hljs-keyword">const</span> resp = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getRepository</span>(<span class="hljs-title class_">UserEntity</span>).<span class="hljs-title function_">insert</span>(insertUser);
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">CommonTools</span>.<span class="hljs-title function_">returnData</span>({ <span class="hljs-attr">id</span>: resp.<span class="hljs-property">generatedMaps</span>[<span class="hljs-number">0</span>].<span class="hljs-property">id</span> });
}
</code></pre>
<p><strong>3. 统一的错误处理</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorMiddleware</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">KoaMiddlewareInterface</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">use</span>(<span class="hljs-attr">ctx</span>: <span class="hljs-title class_">ICtxRouterContent</span>, <span class="hljs-attr">next</span>: <span class="hljs-title class_">Next</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-comment">// 统一处理各种错误类型</span>
      <span class="hljs-keyword">if</span> (ctx.<span class="hljs-property">status</span> === <span class="hljs-title class_">HttpCode</span>.<span class="hljs-property">BAD_REQUEST</span>) {
        <span class="hljs-comment">// 参数校验错误处理</span>
        ctx.<span class="hljs-property">body</span> = <span class="hljs-title class_">CommonTools</span>.<span class="hljs-title function_">returnData</span>(errors, <span class="hljs-title class_">CodeEnum</span>.<span class="hljs-property">COMMON_PARAMS_ERROR</span>);
      }
    }
  }
}
</code></pre>
<h2 data-id="heading-12">💡 架构优势总结</h2>
<h3 data-id="heading-13">1. 代码可维护性</h3>
<ul>
<li><strong>分层清晰</strong>: Controller-Service-Entity明确分工</li>
<li><strong>类型安全</strong>: TypeScript全程保驾护航</li>
<li><strong>依赖注入</strong>: 松耦合的组件关系</li>
<li><strong>共享类型定义</strong>：前后端共享DTO和接口定义</li>
</ul>
<h3 data-id="heading-14">2. 开发效率</h3>
<ul>
<li><strong>注解驱动</strong>: 减少样板代码</li>
<li><strong>热重载</strong>: 快速开发调试</li>
<li><strong>迁移工具</strong>: 数据库版本化管理</li>
<li><strong>统一技术栈</strong>：前后端都使用TypeScript，减少学习成本</li>
<li><strong>快速迭代</strong>：前端开发者可以直接参与后端开发</li>
<li><strong>问题定位</strong>：前后端问题定位更加高效</li>
</ul>
<h3 data-id="heading-15">3. 企业级特性</h3>
<ul>
<li><strong>权限控制</strong>: 细粒度的API权限管理</li>
<li><strong>数据加密</strong>: 自动的敏感数据加密</li>
<li><strong>错误处理</strong>: 统一的异常处理机制</li>
</ul>
<h3 data-id="heading-16">4. 扩展性</h3>
<ul>
<li><strong>微服务就绪</strong>: 模块化架构支持微服务拆分</li>
<li><strong>多租户支持</strong>: 内置数据隔离机制</li>
<li><strong>缓存集成</strong>: Redis缓存提升性能</li>
</ul>
<h2 data-id="heading-17">🎉 结语</h2>
<p>写完这个项目后让我深刻体会到，Node.js生态已经足够成熟，完全可以胜任复杂的企业级应用开发。通过借鉴Java生态的优秀设计模式，我们可以在保持JavaScript灵活性的同时，获得Java级别的工程化能力。</p>
<p>作为"Web仔"，我们不再需要羡慕Java程序员的那套"重型装备"。在Node.js的世界里，我们同样可以写出优雅、健壮、可维护的后端代码！</p>
<p><strong>技术不分贵贱，优雅的代码才是王道！</strong></p>
<hr/>
<p><em>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fchencjfeng%2Fmanage-system-server" target="_blank" title="https://github.com/chencjfeng/manage-system-server" ref="nofollow noopener noreferrer">github.com/chencjfeng/…</a></em><br/>
<em>作者：ChenJF</em><br/>
<em>邮箱：<a href="https://link.juejin.cn?target=mailto%3Achencjfeng%40163.com" target="_blank" title="mailto:chencjfeng@163.com" ref="nofollow noopener noreferrer">chencjfeng@163.com</a></em></p>
<blockquote>
<p>本文基于实际项目代码分析，所有示例代码均可运行。欢迎Star和贡献！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Typescript之类型总结大全]]></title>    <link>https://juejin.cn/post/7593169840199630874</link>    <guid>https://juejin.cn/post/7593169840199630874</guid>    <pubDate>2026-01-09T09:25:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593169840199630874" data-draft-id="7593164154631405577" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Typescript之类型总结大全"/> <meta itemprop="keywords" content="前端,TypeScript"/> <meta itemprop="datePublished" content="2026-01-09T09:25:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="满天星辰"/> <meta itemprop="url" content="https://juejin.cn/user/2771198801097485"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Typescript之类型总结大全
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2771198801097485/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    满天星辰
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T09:25:20.000Z" title="Fri Jan 09 2026 09:25:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TypeScript 中的基本类型</h2>
<p>TypeScript 的基本类型涵盖了 JavaScript 的原始类型，并添加了一些 TypeScript 特有的类型。</p>
<hr/>
<h3 data-id="heading-1">1. <strong>JavaScript 原始类型（Primitive Types）</strong></h3>
<p>这些是 JavaScript 原有的基本数据类型，TypeScript 为它们提供了类型注解。</p>
<h4 data-id="heading-2"><strong><code>boolean</code> - 布尔值</strong></h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> <span class="hljs-attr">isDone</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">true</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">isLoading</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;
</code></pre>
<h4 data-id="heading-3"><strong><code>number</code> - 数字</strong></h4>
<p>TypeScript 中的所有数字都是浮点数，支持十进制、十六进制、二进制和八进制。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> <span class="hljs-attr">decimal</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">6</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">hex</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0xf00d</span>;      <span class="hljs-comment">// 十六进制</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">binary</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0b1010</span>;   <span class="hljs-comment">// 二进制</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">octal</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0o744</span>;     <span class="hljs-comment">// 八进制</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">float</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">3.14</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">infinity</span>: <span class="hljs-built_in">number</span> = <span class="hljs-title class_">Infinity</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">notANumber</span>: <span class="hljs-built_in">number</span> = <span class="hljs-title class_">NaN</span>;
</code></pre>
<h4 data-id="heading-4"><strong><code>string</code> - 字符串</strong></h4>
<pre><code class="hljs language-typescri" lang="typescri">let name: string = "张三";
let sentence: string = `你好，${name}！`;  // 模板字符串
</code></pre>
<h4 data-id="heading-5"><strong><code>bigint</code> - 大整数</strong>（ES2020+）</h4>
<p>表示大于 2^53 - 1 的整数。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> <span class="hljs-attr">big</span>: <span class="hljs-built_in">bigint</span> = <span class="hljs-number">9007199254740991n</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">big2</span>: <span class="hljs-built_in">bigint</span> = <span class="hljs-title class_">BigInt</span>(<span class="hljs-number">9007199254740991</span>);
</code></pre>
<h4 data-id="heading-6"><strong><code>symbol</code> - 符号</strong>（ES2015+）</h4>
<p>创建唯一的标识符。</p>
<p>typescript</p>
<pre><code class="hljs language-ini" lang="ini">let sym1: <span class="hljs-attr">symbol</span> = Symbol()<span class="hljs-comment">;</span>
let sym2: <span class="hljs-attr">symbol</span> = Symbol(<span class="hljs-string">"description"</span>)<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h3 data-id="heading-7">2. <strong>特殊原始类型</strong></h3>
<h4 data-id="heading-8"><strong><code>null</code> - 空值</strong></h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> <span class="hljs-attr">n</span>: <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
</code></pre>
<h4 data-id="heading-9"><strong><code>undefined</code> - 未定义</strong></h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> <span class="hljs-attr">u</span>: <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;
</code></pre>
<p><strong>注意</strong>：在 <code>strictNullChecks</code> 模式下，<code>null</code> 和 <code>undefined</code> 只能赋值给它们自己或 <code>any</code> 类型。</p>
<hr/>
<h3 data-id="heading-10">3. <strong>TypeScript 特有类型</strong></h3>
<h4 data-id="heading-11"><strong><code>any</code> - 任意类型</strong></h4>
<p>关闭类型检查，兼容所有类型。</p>
<pre><code class="hljs language-typescri" lang="typescri">let notSure: any = 4;
notSure = "可能是字符串";
notSure = false;  // 没问题
</code></pre>
<h4 data-id="heading-12"><strong><code>unknown</code> - 未知类型</strong></h4>
<p>比 <code>any</code> 更安全的类型，使用时需要类型检查或断言。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> <span class="hljs-attr">value</span>: <span class="hljs-built_in">unknown</span>;

<span class="hljs-comment">// 需要类型检查后才能使用</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">"string"</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value.<span class="hljs-property">length</span>);
}

<span class="hljs-comment">// 或使用类型断言</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">str</span>: <span class="hljs-built_in">string</span> = (value <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>);
</code></pre>
<h4 data-id="heading-13"><strong><code>void</code> - 空类型</strong></h4>
<p>表示函数没有返回值。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">warnUser</span>(<span class="hljs-params"/>): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"警告信息"</span>);
    <span class="hljs-comment">// 没有 return 语句</span>
}
</code></pre>
<h4 data-id="heading-14"><strong><code>never</code> - 永不存在的值</strong></h4>
<p>表示永远不会发生的类型，用于总是抛出异常或无限循环的函数。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 抛出错误</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">error</span>(<span class="hljs-params">message: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">never</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(message);
}

<span class="hljs-comment">// 无限循环</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">infiniteLoop</span>(<span class="hljs-params"/>): <span class="hljs-built_in">never</span> {
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {}
}
</code></pre>
<h4 data-id="heading-15"><strong><code>object</code> - 非原始类型</strong></h4>
<p>表示非原始类型的值（不是 number, string, boolean, symbol, null, undefined）。</p>
<pre><code class="hljs language-typescri" lang="typescri">let obj: object = {};
let arr: object = [];
let func: object = function() {};
</code></pre>
<hr/>
<h3 data-id="heading-16">4. <strong>数组类型</strong></h3>
<p>有两种表示方式：</p>
<h4 data-id="heading-17"><strong>类型 + 方括号</strong></h4>
<pre><code class="hljs language-typescr" lang="typescr">let list: number[] = [1, 2, 3];
let strings: string[] = ["a", "b", "c"];
</code></pre>
<h4 data-id="heading-18"><strong>泛型 Array&lt;类型&gt;</strong></h4>
<pre><code class="hljs language-typescri" lang="typescri">let list: Array&lt;number&gt; = [1, 2, 3];
let strings: Array&lt;string&gt; = ["a", "b", "c"];
</code></pre>
<h4 data-id="heading-19"><strong>只读数组</strong></h4>
<pre><code class="hljs language-typescri" lang="typescri">let readonlyArr: ReadonlyArray&lt;number&gt; = [1, 2, 3];
// readonlyArr.push(4);  // ❌ 错误：只读数组不能修改
</code></pre>
<hr/>
<h3 data-id="heading-20">5. <strong>元组（Tuple）</strong></h3>
<p>表示已知元素数量和类型的数组。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 定义元组类型</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">tuple</span>: [<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>];
tuple = [<span class="hljs-string">"hello"</span>, <span class="hljs-number">10</span>];  <span class="hljs-comment">// ✅ 正确</span>
<span class="hljs-comment">// tuple = [10, "hello"];  // ❌ 错误：类型不匹配</span>

<span class="hljs-comment">// 访问元组元素</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(tuple[<span class="hljs-number">0</span>].<span class="hljs-title function_">substring</span>(<span class="hljs-number">1</span>));  <span class="hljs-comment">// "ello"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(tuple[<span class="hljs-number">1</span>].<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>));    <span class="hljs-comment">// "10.00"</span>

<span class="hljs-comment">// 可选元素（3.0+）</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">optionalTuple</span>: [<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>?];
optionalTuple = [<span class="hljs-string">"hello"</span>];           <span class="hljs-comment">// ✅ 正确</span>
optionalTuple = [<span class="hljs-string">"hello"</span>, <span class="hljs-number">42</span>];       <span class="hljs-comment">// ✅ 正确</span>

<span class="hljs-comment">// 剩余元素</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">restTuple</span>: [<span class="hljs-built_in">string</span>, ...<span class="hljs-built_in">number</span>[]];
restTuple = [<span class="hljs-string">"hello"</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];      <span class="hljs-comment">// ✅ 正确</span>
</code></pre>
<hr/>
<h3 data-id="heading-21">6. <strong>枚举（Enum）</strong></h3>
<h4 data-id="heading-22"><strong>数字枚举</strong></h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Direction</span> {
    <span class="hljs-title class_">Up</span> = <span class="hljs-number">1</span>,      <span class="hljs-comment">// 从 1 开始</span>
    <span class="hljs-title class_">Down</span>,        <span class="hljs-comment">// 自动递增为 2</span>
    <span class="hljs-title class_">Left</span>,        <span class="hljs-comment">// 3</span>
    <span class="hljs-title class_">Right</span>        <span class="hljs-comment">// 4</span>
}

<span class="hljs-keyword">let</span> <span class="hljs-attr">dir</span>: <span class="hljs-title class_">Direction</span> = <span class="hljs-title class_">Direction</span>.<span class="hljs-property">Up</span>;
</code></pre>
<h4 data-id="heading-23"><strong>字符串枚举</strong></h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Direction</span> {
    <span class="hljs-title class_">Up</span> = <span class="hljs-string">"UP"</span>,
    <span class="hljs-title class_">Down</span> = <span class="hljs-string">"DOWN"</span>,
    <span class="hljs-title class_">Left</span> = <span class="hljs-string">"LEFT"</span>,
    <span class="hljs-title class_">Right</span> = <span class="hljs-string">"RIGHT"</span>
}
</code></pre>
<h4 data-id="heading-24"><strong>常量枚举</strong>（编译时完全删除）</h4>
<pre><code class="hljs language-typescri" lang="typescri">const enum Colors {
    Red,
    Green,
    Blue
}

let color = Colors.Red;  // 编译后：let color = 0;
</code></pre>
<hr/>
<h3 data-id="heading-25">7. <strong>字面量类型</strong></h3>
<h4 data-id="heading-26"><strong>字符串字面量</strong></h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">EventType</span> = <span class="hljs-string">"click"</span> | <span class="hljs-string">"scroll"</span> | <span class="hljs-string">"mousemove"</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">event</span>: <span class="hljs-title class_">EventType</span> = <span class="hljs-string">"click"</span>;  <span class="hljs-comment">// ✅</span>
<span class="hljs-comment">// event = "hover";  // ❌ 错误</span>
</code></pre>
<h4 data-id="heading-27"><strong>数字字面量</strong></h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">DiceRoll</span> = <span class="hljs-number">1</span> | <span class="hljs-number">2</span> | <span class="hljs-number">3</span> | <span class="hljs-number">4</span> | <span class="hljs-number">5</span> | <span class="hljs-number">6</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">roll</span>: <span class="hljs-title class_">DiceRoll</span> = <span class="hljs-number">3</span>;  <span class="hljs-comment">// ✅</span>
<span class="hljs-comment">// roll = 7;  // ❌ 错误</span>
</code></pre>
<h4 data-id="heading-28"><strong>布尔字面量</strong></h4>
<pre><code class="hljs language-typescr" lang="typescr">type Truthy = true;
let isTrue: Truthy = true;
// isTrue = false;  // ❌ 错误
</code></pre>
<hr/>
<h3 data-id="heading-29">8. <strong>类型推断与联合类型</strong></h3>
<h4 data-id="heading-30"><strong>类型推断</strong></h4>
<pre><code class="hljs language-typescri" lang="typescri">let x = 3;            // x 被推断为 number
let y = "hello";      // y 被推断为 string
</code></pre>
<h4 data-id="heading-31"><strong>联合类型</strong></h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span>;
id = <span class="hljs-string">"abc123"</span>;  <span class="hljs-comment">// ✅</span>
id = <span class="hljs-number">123</span>;       <span class="hljs-comment">// ✅</span>
<span class="hljs-comment">// id = true;   // ❌ 错误</span>

<span class="hljs-comment">// 类型守卫</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> id === <span class="hljs-string">"string"</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(id.<span class="hljs-title function_">toUpperCase</span>());
} <span class="hljs-keyword">else</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(id.<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>));
}
</code></pre>
<hr/>
<h3 data-id="heading-32">9. <strong>类型别名</strong></h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 基本类型别名</span>
<span class="hljs-keyword">type</span> <span class="hljs-variable constant_">ID</span> = <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Point</span> = {
    <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-keyword">let</span> <span class="hljs-attr">userId</span>: <span class="hljs-variable constant_">ID</span> = <span class="hljs-string">"user-123"</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">position</span>: <span class="hljs-title class_">Point</span> = { <span class="hljs-attr">x</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">20</span> };
</code></pre>
<hr/>
<h3 data-id="heading-33">类型总结表</h3>





















































































<table><thead><tr><th>类型</th><th>示例</th><th>描述</th></tr></thead><tbody><tr><td><code>boolean</code></td><td><code>let isDone: boolean = true;</code></td><td>布尔值</td></tr><tr><td><code>number</code></td><td><code>let count: number = 10;</code></td><td>所有数字类型</td></tr><tr><td><code>string</code></td><td><code>let name: string = "John";</code></td><td>字符串</td></tr><tr><td><code>bigint</code></td><td><code>let big: bigint = 100n;</code></td><td>大整数</td></tr><tr><td><code>symbol</code></td><td><code>let sym: symbol = Symbol();</code></td><td>唯一标识符</td></tr><tr><td><code>null</code></td><td><code>let n: null = null;</code></td><td>空值</td></tr><tr><td><code>undefined</code></td><td><code>let u: undefined = undefined;</code></td><td>未定义</td></tr><tr><td><code>any</code></td><td><code>let anything: any = 4;</code></td><td>任意类型</td></tr><tr><td><code>unknown</code></td><td><code>let unsure: unknown = 30;</code></td><td>未知类型</td></tr><tr><td><code>void</code></td><td><code>function(): void {}</code></td><td>无返回值</td></tr><tr><td><code>never</code></td><td><code>function error(): never {}</code></td><td>永不存在的值</td></tr><tr><td><code>object</code></td><td><code>let obj: object = {};</code></td><td>非原始类型</td></tr><tr><td><code>Array&lt;T&gt;</code></td><td><code>let list: number[] = [1, 2, 3];</code></td><td>数组</td></tr><tr><td><code>[T1, T2]</code></td><td><code>let tuple: [string, number];</code></td><td>元组</td></tr><tr><td><code>enum</code></td><td><code>enum Color { Red, Green }</code></td><td>枚举</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-34">实用示例</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 完整示例</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">processInput</span>(<span class="hljs-params">input: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span> | <span class="hljs-built_in">boolean</span></span>): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> input === <span class="hljs-string">"string"</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">`字符串: <span class="hljs-subst">${input.toUpperCase()}</span>`</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> input === <span class="hljs-string">"number"</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">`数字: <span class="hljs-subst">${input.toFixed(<span class="hljs-number">2</span>)}</span>`</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">`布尔值: <span class="hljs-subst">${input}</span>`</span>;
    }
}

<span class="hljs-comment">// 严格空值检查</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span></span>): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">if</span> (name === <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"你好，访客！"</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-string">`你好，<span class="hljs-subst">${name}</span>！`</span>;
}

<span class="hljs-comment">// 使用 never 进行穷尽检查</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Shape</span> = <span class="hljs-string">"circle"</span> | <span class="hljs-string">"square"</span> | <span class="hljs-string">"triangle"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">getArea</span>(<span class="hljs-params">shape: Shape</span>): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">switch</span> (shape) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">"circle"</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">"square"</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">"triangle"</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-number">0.5</span>;
        <span class="hljs-attr">default</span>:
            <span class="hljs-comment">// 确保处理了所有情况</span>
            <span class="hljs-keyword">const</span> <span class="hljs-attr">_exhaustiveCheck</span>: <span class="hljs-built_in">never</span> = shape;
            <span class="hljs-keyword">return</span> _exhaustiveCheck;
    }
}
</code></pre>
<p>TypeScript 的基本类型系统提供了强大的类型安全保证，帮助开发者在编译时捕获错误，提高代码质量。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React useState 原理和异步更新]]></title>    <link>https://juejin.cn/post/7593139476840120326</link>    <guid>https://juejin.cn/post/7593139476840120326</guid>    <pubDate>2026-01-09T08:52:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593139476840120326" data-draft-id="7592921639465435178" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React useState 原理和异步更新"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2026-01-09T08:52:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="松潘"/> <meta itemprop="url" content="https://juejin.cn/user/893218038484600"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React useState 原理和异步更新
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/893218038484600/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    松潘
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T08:52:27.000Z" title="Fri Jan 09 2026 08:52:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">useState 的基本原理</h2>
<p>useState 是 React 的一个 Hook，它的核心原理基于以下几点：</p>
<h3 data-id="heading-1">1. 闭包和链表结构</h3>
<p>React 内部使用链表来存储组件的所有 Hook 状态。每次组件渲染时，React 会按照 Hook 调用的顺序遍历这个链表：</p>
<pre><code class="hljs language-ini" lang="ini">// 简化的内部实现概念
let <span class="hljs-attr">hooks</span> = []<span class="hljs-comment">;</span>
let <span class="hljs-attr">currentHook</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>

function useState(initialValue) {
  const <span class="hljs-attr">hookIndex</span> = currentHook<span class="hljs-comment">;</span>
  
  // 初始化或获取已有状态
  if (hooks<span class="hljs-section">[hookIndex]</span> === undefined) {
    hooks<span class="hljs-section">[hookIndex]</span> = initialValue<span class="hljs-comment">;</span>
  }
  
  const <span class="hljs-attr">setState</span> = (newValue) =&gt; {
    hooks<span class="hljs-section">[hookIndex]</span> = newValue<span class="hljs-comment">;</span>
    render()<span class="hljs-comment">; // 触发重新渲染</span>
  }<span class="hljs-comment">;</span>
  
  currentHook++<span class="hljs-comment">;</span>
  return <span class="hljs-section">[hooks[hookIndex]</span>, setState]<span class="hljs-comment">;</span>
}
</code></pre>
<p>这就是为什么 Hook 必须在组件顶层调用，不能在条件语句或循环中使用 - 因为 React 依赖调用顺序来匹配状态。</p>
<h2 data-id="heading-2">异步更新机制</h2>
<h3 data-id="heading-3">2. 批量更新（Batching）</h3>
<p>React 不会立即更新状态，而是将多个 setState 调用合并成一次更新：</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">Counter</span>() {
  const <span class="hljs-selector-attr">[count, setCount]</span> = <span class="hljs-built_in">useState</span>(<span class="hljs-number">0</span>);
  
  const handleClick = () =&gt; {
    <span class="hljs-built_in">setCount</span>(count + <span class="hljs-number">1</span>); <span class="hljs-comment">// count = 0 + 1</span>
    <span class="hljs-built_in">setCount</span>(count + <span class="hljs-number">1</span>); <span class="hljs-comment">// count = 0 + 1 (还是读取的旧值)</span>
    <span class="hljs-built_in">setCount</span>(count + <span class="hljs-number">1</span>); <span class="hljs-comment">// count = 0 + 1</span>
    <span class="hljs-comment">// 最终 count = 1，而不是 3</span>
  };
  
  return &lt;<span class="hljs-selector-tag">button</span> onClick={handleClick}&gt;{count}&lt;/<span class="hljs-selector-tag">button</span>&gt;;
}
</code></pre>
<p><strong>为什么这样设计？</strong></p>
<ul>
<li>性能优化：避免不必要的重复渲染</li>
<li>保持一致性：确保在一次事件处理中看到的状态是一致的</li>
</ul>
<h3 data-id="heading-4">3. 函数式更新</h3>
<p>如果需要基于前一个状态更新，使用函数形式：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">handleClick</span> = () =&gt; {
  setCount(<span class="hljs-attr">prev</span> =&gt; prev + <span class="hljs-number">1</span>)<span class="hljs-comment">; // 1</span>
  setCount(<span class="hljs-attr">prev</span> =&gt; prev + <span class="hljs-number">1</span>)<span class="hljs-comment">; // 2</span>
  setCount(<span class="hljs-attr">prev</span> =&gt; prev + <span class="hljs-number">1</span>)<span class="hljs-comment">; // 3</span>
  // 最终 <span class="hljs-attr">count</span> = <span class="hljs-number">3</span>
}<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-5">4. React 18 的自动批处理</h3>
<p>在 React 18 之前，只有在事件处理器中才会批处理。React 18 扩展到了所有场景：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// React 18 中，这些也会被批处理</span>
<span class="hljs-built_in">setTimeout</span>(() =&gt; {
  <span class="hljs-built_in">setCount</span>(c =&gt; c + <span class="hljs-number">1</span>);
  <span class="hljs-built_in">setFlag</span>(f =&gt; !f);
  <span class="hljs-comment">// 只触发一次重新渲染</span>
}, <span class="hljs-number">1000</span>);

<span class="hljs-built_in">fetch</span>('/api')<span class="hljs-selector-class">.then</span>(() =&gt; {
  <span class="hljs-built_in">setData</span>(newData);
  <span class="hljs-built_in">setLoading</span>(false);
  <span class="hljs-comment">// 只触发一次重新渲染</span>
});
</code></pre>
<h2 data-id="heading-6">实际应用场景</h2>
<h3 data-id="heading-7">场景 1: 需要立即读取更新后的值</h3>
<pre><code class="hljs language-scss" lang="scss">const <span class="hljs-selector-attr">[count, setCount]</span> = <span class="hljs-built_in">useState</span>(<span class="hljs-number">0</span>);

const handleClick = () =&gt; {
  <span class="hljs-built_in">setCount</span>(count + <span class="hljs-number">1</span>);
  console<span class="hljs-selector-class">.log</span>(count); <span class="hljs-comment">// 还是旧值 0</span>
  
  <span class="hljs-comment">// 解决方案：使用 useEffect</span>
  <span class="hljs-built_in">useEffect</span>(() =&gt; {
    console<span class="hljs-selector-class">.log</span>(count); <span class="hljs-comment">// 新值 1</span>
  }, <span class="hljs-selector-attr">[count]</span>);
};
</code></pre>
<h3 data-id="heading-8">场景 2: 依赖多个状态更新</h3>
<pre><code class="hljs language-scss" lang="scss">const <span class="hljs-selector-attr">[user, setUser]</span> = <span class="hljs-built_in">useState</span>(null);
const <span class="hljs-selector-attr">[loading, setLoading]</span> = <span class="hljs-built_in">useState</span>(false);

const fetchUser = async () =&gt; {
  <span class="hljs-built_in">setLoading</span>(true);
  const data = await api<span class="hljs-selector-class">.getUser</span>();
  <span class="hljs-built_in">setUser</span>(data);
  <span class="hljs-built_in">setLoading</span>(false);
  <span class="hljs-comment">// React 会批量处理这些更新，只渲染一次</span>
};
</code></pre>
<h3 data-id="heading-9">场景 3: 复杂状态管理</h3>
<p>对于复杂的状态逻辑，考虑使用 useReducer：</p>
<pre><code class="hljs language-scss" lang="scss">const <span class="hljs-selector-attr">[state, dispatch]</span> = <span class="hljs-built_in">useReducer</span>(reducer, initialState);

<span class="hljs-comment">// 一次 dispatch 可以更新多个相关状态</span>
<span class="hljs-built_in">dispatch</span>({ type: 'FETCH_SUCCESS', payload: data });
</code></pre>
<h2 data-id="heading-10">关键要点</h2>
<ol>
<li><strong>状态更新是异步的</strong> - 不要期望 setState 后立即读取新值</li>
<li><strong>使用函数式更新</strong> - 当新状态依赖旧状态时</li>
<li><strong>批量更新提升性能</strong> - React 会自动优化多次 setState</li>
<li><strong>保持 Hook 调用顺序</strong> - 不要在条件语句中使用 Hook</li>
<li><strong>状态是不可变的</strong> - 更新对象或数组时要创建新的引用</li>
</ol>
<p>这些机制让 React 能够高效地管理组件状态，同时保持 UI 的一致性和可预测性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PowerShell 启动卡顿？内存飙升？原来是 800MB 的历史记录在作祟！]]></title>    <link>https://juejin.cn/post/7593164154631454729</link>    <guid>https://juejin.cn/post/7593164154631454729</guid>    <pubDate>2026-01-09T09:30:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593164154631454729" data-draft-id="7593077945016107035" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PowerShell 启动卡顿？内存飙升？原来是 800MB 的历史记录在作祟！"/> <meta itemprop="keywords" content="Windows"/> <meta itemprop="datePublished" content="2026-01-09T09:30:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="林瞅瞅"/> <meta itemprop="url" content="https://juejin.cn/user/588993964277933"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PowerShell 启动卡顿？内存飙升？原来是 800MB 的历史记录在作祟！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993964277933/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    林瞅瞅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T09:30:27.000Z" title="Fri Jan 09 2026 09:30:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">PowerShell 启动卡顿？内存飙升？原来是 800MB 的历史记录在作祟！</h2>
<p>最近在开发过程中遇到一个非常诡异的问题：<strong>PowerShell 一启动，电脑就像被施了定身法一样卡顿。</strong> 打开任务管理器一看，好家伙，PowerShell 进程的内存占用像坐火箭一样蹭蹭往上涨，甚至在没有任何手动操作的情况下也是如此。</p>
<p>经过一番侦探式的排查，终于揪出了幕后真凶。今天就把这个排查过程和解决方案分享给大家，如果你的终端也经常卡顿，不妨检查一下这个问题。</p>
<h3 data-id="heading-1">🧐 问题现场</h3>
<p>现象非常简单粗暴：</p>
<ul>
<li>双击启动 PowerShell（或者在 VS Code 中打开终端）。</li>
<li>系统明显卡顿，鼠标移动都变得迟缓。</li>
<li>查看任务管理器，PowerShell 进程占用内存极高（甚至达到 GB 级别）。</li>
<li>等待许久后，终端才勉强可以输入命令。</li>
</ul>
<h3 data-id="heading-2">🕵️‍♂️ 抽丝剥茧：排查过程</h3>
<p>为了找到原因，我并没有急着重装系统（虽然这是万能大法），而是决定深入系统内部看一看。</p>
<h4 data-id="heading-3">1. 进程分析</h4>
<p>首先，我使用 <code>Get-Process</code> 命令查看了 PowerShell 进程的状态。果不其然，<code>WorkingSet</code>（工作集内存）数值异常的高。</p>
<h4 data-id="heading-4">2. 环境检查</h4>
<p>我怀疑是不是某个 Profile 配置文件或者加载的模块有问题。检查了 <code>$PROFILE</code>，发现并没有什么特殊的启动脚本。接着检查已加载的模块，一切似乎都很正常。</p>
<h4 data-id="heading-5">3. 关键发现</h4>
<p>在排查 PowerShell 的常用模块 <strong>PSReadLine</strong> 时，我注意到了一个细节。这个模块负责管理我们的命令行历史记录、语法高亮等功能。它会把我们敲过的所有命令都保存在一个文本文件里。</p>
<p>我顺藤摸瓜找到了这个文件，结果让我大吃一惊：</p>
<blockquote>
<p><strong>文件路径：</strong> <code>%APPDATA%\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt</code>
<strong>文件大小：</strong> <strong>832 MB</strong></p>
</blockquote>
<p>没错，你没看错，一个纯文本的历史记录文件，竟然有 <strong>800多兆</strong>！这意味着里面可能保存了数百万行的命令历史。</p>
<p><strong>真相大白：</strong> PowerShell 在启动时，PSReadLine 模块会尝试加载这个巨大的历史记录文件，以便提供“向上箭头”查找历史命令的功能。这就好比让你一口气背诵一本字典，不卡才怪！</p>
<h3 data-id="heading-6">🛠️ 一键解决</h3>
<p>既然找到了病灶，治疗方案就非常简单了：<strong>让 PowerShell 放弃加载这个文件。</strong></p>
<p>为了保险起见（万一里面有重要的历史命令呢），我没有直接删除它，而是选择了重命名。</p>
<h4 data-id="heading-7">操作步骤：</h4>
<p>打开你的文件资源管理器，或者直接在命令行执行以下操作：</p>
<pre><code class="hljs language-powershell" lang="powershell"># 进入 PSReadLine 目录
cd "$env:APPDATA\Microsoft\Windows\PowerShell\PSReadLine"

# 将巨大的历史文件重命名备份
Rename-Item .\ConsoleHost_history.txt -NewName ConsoleHost_history.txt.bak
</code></pre>
<p><strong>效果立竿见影：</strong>
再次启动 PowerShell，秒开！内存占用恢复到了几十 MB 的正常水平。系统瞬间恢复了丝般顺滑。</p>
<h3 data-id="heading-8">💡 避坑指南</h3>
<p>问题解决了，但为什么会有这么大的历史文件呢？通常有以下几个原因：</p>
<ol>
<li><strong>日积月累：</strong> 从来没有清理过，数年的操作记录都在里面。</li>
<li><strong>自动化脚本：</strong> 某些自动化脚本如果在 PowerShell 环境下疯狂循环执行命令，这些命令也会被记录下来。</li>
</ol>
<h4 data-id="heading-9">建议：</h4>
<ul>
<li>定期检查一下 <code>%APPDATA%\Microsoft\Windows\PowerShell\PSReadLine\</code> 目录下的文件大小。</li>
<li>如果你发现自己不需要保留那么久远的历史记录，可以考虑定期清理。</li>
<li>如果那个 800MB 的备份文件里没有你需要的“传家宝”代码，果断删掉它释放空间吧！</li>
</ul>
<hr/>
<p>希望这篇文章能帮到遇到同样问题的你。Happy Coding! 🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 事件分发机制 - 事件流向详解]]></title>    <link>https://juejin.cn/post/7593139476840169478</link>    <guid>https://juejin.cn/post/7593139476840169478</guid>    <pubDate>2026-01-09T09:07:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593139476840169478" data-draft-id="7592921639465304106" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 事件分发机制 - 事件流向详解"/> <meta itemprop="keywords" content="前端,面试,Android"/> <meta itemprop="datePublished" content="2026-01-09T09:07:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="青莲843"/> <meta itemprop="url" content="https://juejin.cn/user/541408646929991"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 事件分发机制 - 事件流向详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/541408646929991/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    青莲843
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T09:07:28.000Z" title="Fri Jan 09 2026 09:07:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读23分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Android 事件分发机制 - 事件流向详解</h2>
<h3 data-id="heading-1">事件来源</h3>
<h4 data-id="heading-2">事件产生流程</h4>
<pre><code class="hljs language-markdown" lang="markdown">用户触摸屏幕
<span class="hljs-code">    ↓
InputManager（系统服务）
    ↓
通过Binder传递到应用进程
    ↓
主线程的MessageQueue
    ↓
Looper取出事件
    ↓
Activity.dispatchTouchEvent()
    ↓
开始事件分发
</span></code></pre>
<hr/>
<h3 data-id="heading-3">ViewGroup事件流向详解</h3>
<h4 data-id="heading-4">ViewGroup的三个方法</h4>

























<table><thead><tr><th>方法</th><th>作用</th><th>返回值</th></tr></thead><tbody><tr><td><code>dispatchTouchEvent()</code></td><td>分发事件</td><td>boolean</td></tr><tr><td><code>onInterceptTouchEvent()</code></td><td>拦截事件</td><td>boolean</td></tr><tr><td><code>onTouchEvent()</code></td><td>处理事件</td><td>boolean</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-5">dispatchTouchEvent()返回值详解</h4>
<h5 data-id="heading-6">返回 true</h5>
<p><strong>详细事件流向：</strong></p>
<pre><code class="hljs language-scss" lang="scss">Activity → Window → DecorView → ViewGroup <span class="hljs-selector-tag">A</span>
    ↓
ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.dispatchTouchEvent</span>()被调用
    ↓
ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.dispatchTouchEvent</span>()返回true ✅
    ↓
【关键点】返回true表示事件被消费，方法立即返回
    ↓
不会调用<span class="hljs-built_in">onInterceptTouchEvent</span>()（后续逻辑不执行）
    ↓
不会遍历子View（不会进入子View遍历逻辑）
    ↓
不会调用<span class="hljs-built_in">onTouchEvent</span>()（不会调用<span class="hljs-built_in">onTouchEvent</span>()）
    ↓
事件分发结束，ViewGroup <span class="hljs-selector-tag">A</span>成为目标View
    ↓
后续ACTION_MOVE、ACTION_UP会继续传递给ViewGroup <span class="hljs-selector-tag">A</span>
    【原因】系统记录ViewGroup <span class="hljs-selector-tag">A</span>为目标View（mFirstTouchTarget）
</code></pre>
<p><strong>最终去向：</strong> ✅ <strong>事件被ViewGroup A消费，不再传递</strong></p>
<p><strong>详细说明：</strong></p>
<ol>
<li>
<p><strong>为什么不会调用onInterceptTouchEvent()？</strong></p>
<ul>
<li>dispatchTouchEvent()返回true后，方法立即返回</li>
<li>不会执行后续的拦截判断逻辑</li>
<li>这是性能优化，避免不必要的判断</li>
</ul>
</li>
<li>
<p><strong>为什么不会传递给子View？</strong></p>
<ul>
<li>dispatchTouchEvent()返回true表示事件被消费</li>
<li>系统认为事件已经处理完成，不需要继续传递</li>
<li>这是事件分发的核心机制：一旦消费，停止传递</li>
</ul>
</li>
<li>
<p><strong>为什么后续事件会继续传递？</strong></p>
<ul>
<li>系统会记录处理ACTION_DOWN的View（mFirstTouchTarget）</li>
<li>后续的MOVE、UP会直接传递给这个View</li>
<li>这是为了保持事件序列的一致性</li>
</ul>
</li>
</ol>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomViewGroup</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ViewGroup</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">dispatchTouchEvent</span><span class="hljs-params">(MotionEvent event)</span> {
        <span class="hljs-comment">// 完全控制事件处理</span>
        <span class="hljs-keyword">switch</span> (event.getAction()) {
            <span class="hljs-keyword">case</span> MotionEvent.ACTION_DOWN:
                <span class="hljs-comment">// 处理按下事件</span>
                handleDown(event);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// ✅ 返回true，事件在此停止</span>
            <span class="hljs-keyword">case</span> MotionEvent.ACTION_MOVE:
                <span class="hljs-comment">// 处理移动事件</span>
                handleMove(event);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">case</span> MotionEvent.ACTION_UP:
                <span class="hljs-comment">// 处理抬起事件</span>
                handleUp(event);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 所有事件都消费</span>
    }
    
    <span class="hljs-comment">// 注意：onInterceptTouchEvent()和onTouchEvent()不会被调用</span>
}
</code></pre>
<p><strong>实际应用场景：</strong></p>
<ul>
<li>自定义ViewGroup需要完全控制所有触摸事件</li>
<li>需要阻止事件传递给子View</li>
<li>实现特殊的触摸交互逻辑</li>
</ul>
<hr/>
<h5 data-id="heading-7">返回 false</h5>
<p><strong>详细事件流向：</strong></p>
<pre><code class="hljs language-scss" lang="scss">Activity → Window → DecorView → ViewGroup <span class="hljs-selector-tag">A</span>
    ↓
ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.dispatchTouchEvent</span>()被调用
    ↓
ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.dispatchTouchEvent</span>()返回false ❌
    ↓
【关键点】返回false表示不处理事件，方法立即返回
    ↓
不会调用<span class="hljs-built_in">onInterceptTouchEvent</span>()（后续逻辑不执行）
    ↓
不会遍历子View（不会进入子View遍历逻辑）
    ↓
不会调用<span class="hljs-built_in">onTouchEvent</span>()（不会调用<span class="hljs-built_in">onTouchEvent</span>()）
    ↓
事件返回到父ViewGroup（DecorView）
    ↓
DecorView会尝试其他子View，或调用自己的<span class="hljs-built_in">onTouchEvent</span>()
    ↓
如果都不处理，最终调用Activity<span class="hljs-selector-class">.onTouchEvent</span>()
    ↓
后续ACTION_MOVE、ACTION_UP不会传递给ViewGroup <span class="hljs-selector-tag">A</span>
    【原因】系统不会记录ViewGroup <span class="hljs-selector-tag">A</span>为目标View
</code></pre>
<p><strong>最终去向：</strong> ⬆️ <strong>事件向上传递给父ViewGroup/Activity</strong></p>
<p><strong>详细说明：</strong></p>
<ol>
<li>
<p><strong>为什么不会调用onInterceptTouchEvent()？</strong></p>
<ul>
<li>dispatchTouchEvent()返回false后，方法立即返回</li>
<li>不会执行后续的拦截判断逻辑</li>
<li>表示ViewGroup完全不参与事件处理</li>
</ul>
</li>
<li>
<p><strong>为什么不会传递给子View？</strong></p>
<ul>
<li>dispatchTouchEvent()返回false表示不处理事件</li>
<li>系统认为这个ViewGroup不参与事件分发</li>
<li>不会进入子View遍历逻辑</li>
</ul>
</li>
<li>
<p><strong>为什么后续事件不会传递？</strong></p>
<ul>
<li>系统只记录处理ACTION_DOWN的View</li>
<li>如果ACTION_DOWN不被处理，不会记录目标View</li>
<li>后续MOVE、UP不会传递给该ViewGroup</li>
</ul>
</li>
</ol>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DisabledViewGroup</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ViewGroup</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">mEnabled</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">dispatchTouchEvent</span><span class="hljs-params">(MotionEvent event)</span> {
        <span class="hljs-keyword">if</span> (!mEnabled) {
            <span class="hljs-comment">// ViewGroup被禁用，不处理事件</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// ❌ 返回false，事件向上传递</span>
        }
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.dispatchTouchEvent(event);
    }
    
    <span class="hljs-comment">// 注意：onInterceptTouchEvent()和onTouchEvent()不会被调用</span>
}
</code></pre>
<p><strong>实际应用场景：</strong></p>
<ul>
<li>ViewGroup被禁用时</li>
<li>ViewGroup不可见时（GONE）</li>
<li>ViewGroup需要将事件完全交给父View处理时</li>
</ul>
<hr/>
<h5 data-id="heading-8">返回 super</h5>
<p><strong>详细事件流向：</strong></p>
<pre><code class="hljs language-scss" lang="scss">Activity → Window → DecorView → ViewGroup <span class="hljs-selector-tag">A</span>
    ↓
ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.dispatchTouchEvent</span>()被调用
    ↓
ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.dispatchTouchEvent</span>()返回super
    ↓
【关键点】返回super表示使用系统默认处理逻辑
    ↓
进入ViewGroup<span class="hljs-selector-class">.dispatchTouchEvent</span>()的默认实现
    ↓
首先调用<span class="hljs-built_in">onInterceptTouchEvent</span>()判断是否拦截
    ↓
根据<span class="hljs-built_in">onInterceptTouchEvent</span>()的返回值决定：
    ├─ 如果返回true → 拦截，不传递给子View
    │   └─ 调用ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.onTouchEvent</span>()
    │       ├─ 返回true → ViewGroup <span class="hljs-selector-tag">A</span>消费 ✅
    │       └─ 返回false → 向上传递 ⬆️
    └─ 如果返回false → 不拦截，传递给子View
        └─ 遍历子View，调用子View<span class="hljs-selector-class">.dispatchTouchEvent</span>()
            ├─ 子View处理 → 子View消费 ✅
            └─ 子View不处理 → 调用ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.onTouchEvent</span>()
</code></pre>
<p><strong>最终去向：</strong> 🔄 <strong>根据onInterceptTouchEvent()和onTouchEvent()的返回值决定</strong></p>
<p><strong>详细说明：</strong></p>
<ol>
<li>
<p><strong>为什么需要调用onInterceptTouchEvent()？</strong></p>
<ul>
<li>ViewGroup需要判断是否拦截事件</li>
<li>这是ViewGroup的核心功能：控制子View的事件</li>
<li>只有ViewGroup有这个方法</li>
</ul>
</li>
<li>
<p><strong>拦截和不拦截的区别：</strong></p>
<ul>
<li><strong>拦截（true）</strong>：事件不传递给子View，由ViewGroup自己处理</li>
<li><strong>不拦截（false）</strong>：事件传递给子View，让子View处理</li>
</ul>
</li>
<li>
<p><strong>子View处理和不处理的区别：</strong></p>
<ul>
<li><strong>子View处理</strong>：事件被子View消费，ViewGroup的onTouchEvent()不会被调用</li>
<li><strong>子View不处理</strong>：事件返回ViewGroup，调用ViewGroup的onTouchEvent()</li>
</ul>
</li>
</ol>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomViewGroup</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ViewGroup</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">dispatchTouchEvent</span><span class="hljs-params">(MotionEvent event)</span> {
        <span class="hljs-comment">// 使用系统默认处理逻辑</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.dispatchTouchEvent(event);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onInterceptTouchEvent</span><span class="hljs-params">(MotionEvent event)</span> {
        <span class="hljs-comment">// 系统会调用这个方法判断是否拦截</span>
        <span class="hljs-comment">// 返回true拦截，返回false不拦截</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.onInterceptTouchEvent(event);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onTouchEvent</span><span class="hljs-params">(MotionEvent event)</span> {
        <span class="hljs-comment">// 如果拦截或子View不处理，会调用这个方法</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.onTouchEvent(event);
    }
}
</code></pre>
<p><strong>实际应用场景：</strong></p>
<ul>
<li>大多数情况下使用</li>
<li>需要系统默认的事件分发逻辑</li>
<li>不需要完全自定义事件处理</li>
</ul>
<hr/>
<h4 data-id="heading-9">onInterceptTouchEvent()返回值详解</h4>
<blockquote>
<p>⚠️ <strong>注意</strong>：只有ViewGroup有，View没有此方法</p>
</blockquote>
<h5 data-id="heading-10">返回 true</h5>
<p><strong>详细事件流向：</strong></p>
<pre><code class="hljs language-scss" lang="scss">ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.dispatchTouchEvent</span>() → super
    ↓
调用ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.onInterceptTouchEvent</span>()
    ↓
ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.onInterceptTouchEvent</span>()返回true ✅
    ↓
【关键点】返回true表示拦截事件，不传递给子View
    ↓
不会遍历子View（拦截了，不需要传递）
    ↓
不会调用子View的<span class="hljs-built_in">dispatchTouchEvent</span>()（子View不会收到事件）
    ↓
如果子View之前收到了ACTION_DOWN，会收到ACTION_CANCEL
    【说明】DOWN时不拦截，MOVE时拦截的情况
    ↓
调用ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.onTouchEvent</span>()（拦截后，由ViewGroup自己处理）
    ↓
根据<span class="hljs-built_in">onTouchEvent</span>()的返回值决定：
    ├─ 返回true → ViewGroup <span class="hljs-selector-tag">A</span>消费事件 ✅
    └─ 返回false → 事件向上传递给父ViewGroup ⬆️
</code></pre>
<p><strong>最终去向：</strong> 🛑 <strong>拦截，不传递给子View，调用自己的onTouchEvent()</strong></p>
<p><strong>详细说明：</strong></p>
<ol>
<li>
<p><strong>为什么不会传递给子View？</strong></p>
<ul>
<li>onInterceptTouchEvent()返回true表示拦截</li>
<li>拦截意味着ViewGroup要自己处理事件</li>
<li>系统不会将事件传递给子View</li>
</ul>
</li>
<li>
<p><strong>ACTION_CANCEL什么时候发送？</strong></p>
<ul>
<li>当ViewGroup在MOVE时拦截，而子View之前收到了DOWN</li>
<li>系统会发送ACTION_CANCEL给子View</li>
<li>子View应该清理状态，恢复到初始状态</li>
</ul>
</li>
<li>
<p><strong>拦截的时机：</strong></p>
<ul>
<li>可以在DOWN时拦截</li>
<li>可以在MOVE时拦截（更常见）</li>
<li>可以在UP时拦截（少见）</li>
</ul>
</li>
</ol>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomScrollView</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ScrollView</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">float</span> mLastX, mLastY;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onInterceptTouchEvent</span><span class="hljs-params">(MotionEvent event)</span> {
        <span class="hljs-type">float</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> event.getX();
        <span class="hljs-type">float</span> <span class="hljs-variable">y</span> <span class="hljs-operator">=</span> event.getY();
        
        <span class="hljs-keyword">switch</span> (event.getAction()) {
            <span class="hljs-keyword">case</span> MotionEvent.ACTION_DOWN:
                mLastX = x;
                mLastY = y;
                <span class="hljs-comment">// DOWN时不拦截，让子View可以点击</span>
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// ❌ 不拦截</span>
                
            <span class="hljs-keyword">case</span> MotionEvent.ACTION_MOVE:
                <span class="hljs-type">float</span> <span class="hljs-variable">deltaX</span> <span class="hljs-operator">=</span> Math.abs(x - mLastX);
                <span class="hljs-type">float</span> <span class="hljs-variable">deltaY</span> <span class="hljs-operator">=</span> Math.abs(y - mLastY);
                <span class="hljs-comment">// 如果是垂直滑动，拦截事件</span>
                <span class="hljs-keyword">if</span> (deltaY &gt; deltaX &amp;&amp; deltaY &gt; <span class="hljs-number">10</span>) {
                    <span class="hljs-comment">// 此时子View会收到ACTION_CANCEL</span>
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// ✅ 拦截</span>
                }
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// ❌ 不拦截</span>
                
            <span class="hljs-keyword">case</span> MotionEvent.ACTION_UP:
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// ❌ 不拦截</span>
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onTouchEvent</span><span class="hljs-params">(MotionEvent event)</span> {
        <span class="hljs-comment">// 拦截后，自己处理滑动</span>
        handleScroll(event);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// ✅ 消费事件</span>
    }
}
</code></pre>
<p><strong>实际应用场景：</strong></p>
<ul>
<li>ScrollView需要拦截子View的滑动事件</li>
<li>ViewPager需要拦截子View的左右滑动</li>
<li>自定义ViewGroup需要控制子View的事件</li>
</ul>
<hr/>
<h5 data-id="heading-11">返回 false</h5>
<p><strong>详细事件流向：</strong></p>
<pre><code class="hljs language-sql" lang="sql">ViewGroup A.dispatchTouchEvent() → super
    ↓
调用ViewGroup A.onInterceptTouchEvent()
    ↓
ViewGroup A.onInterceptTouchEvent()返回<span class="hljs-literal">false</span> ❌
    ↓
【关键点】返回<span class="hljs-literal">false</span>表示不拦截，事件继续传递给子<span class="hljs-keyword">View</span>
    ↓
开始遍历子<span class="hljs-keyword">View</span>（从后往前，上层<span class="hljs-keyword">View</span>优先）
    ↓
检查子<span class="hljs-keyword">View</span>是否可接收事件（可见、坐标范围内、可用）
    ↓
对于符合条件的子<span class="hljs-keyword">View</span>，调用子View.dispatchTouchEvent()
    ↓
根据子<span class="hljs-keyword">View</span>的返回值决定：
    ├─ 子<span class="hljs-keyword">View</span>返回<span class="hljs-literal">true</span> → 子<span class="hljs-keyword">View</span>消费事件 ✅
    │   └─ 记录目标<span class="hljs-keyword">View</span>（mFirstTouchTarget <span class="hljs-operator">=</span> 子<span class="hljs-keyword">View</span>）
    │   └─ ViewGroup A的onTouchEvent()不会被调用
    │   └─ 后续MOVE、UP会直接传递给该子<span class="hljs-keyword">View</span>
    └─ 子<span class="hljs-keyword">View</span>返回<span class="hljs-literal">false</span> → 继续遍历下一个子<span class="hljs-keyword">View</span>
        └─ 如果所有子<span class="hljs-keyword">View</span>都不处理
            └─ 调用ViewGroup A.onTouchEvent()
                ├─ 返回<span class="hljs-literal">true</span> → ViewGroup A消费 ✅
                └─ 返回<span class="hljs-literal">false</span> → 向上传递 ⬆️
</code></pre>
<p><strong>最终去向：</strong> ⬇️ <strong>不拦截，传递给子View</strong></p>
<p><strong>详细说明：</strong></p>
<ol>
<li>
<p><strong>为什么从后往前遍历？</strong></p>
<ul>
<li>后添加的View在Z轴上层</li>
<li>上层View应该优先响应触摸事件</li>
<li>符合用户的视觉预期</li>
</ul>
</li>
<li>
<p><strong>子View的检查条件：</strong></p>
<ul>
<li><strong>可见性</strong>：必须是VISIBLE（GONE和INVISIBLE不接收事件）</li>
<li><strong>坐标</strong>：触摸点必须在子View的区域内</li>
<li><strong>可用性</strong>：子View必须是enabled状态</li>
</ul>
</li>
<li>
<p><strong>mFirstTouchTarget的作用：</strong></p>
<ul>
<li>记录处理ACTION_DOWN的子View</li>
<li>后续MOVE、UP会直接传递给这个View</li>
<li>避免重复遍历，提高性能</li>
</ul>
</li>
</ol>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomViewGroup</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ViewGroup</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onInterceptTouchEvent</span><span class="hljs-params">(MotionEvent event)</span> {
        <span class="hljs-comment">// 不拦截，让子View正常处理事件</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// ❌ 不拦截</span>
    }
    
    <span class="hljs-comment">// 系统会自动遍历子View，调用子View.dispatchTouchEvent()</span>
    <span class="hljs-comment">// 如果子View处理，事件被子View消费</span>
    <span class="hljs-comment">// 如果子View不处理，会调用onTouchEvent()</span>
}
</code></pre>
<p><strong>实际应用场景：</strong></p>
<ul>
<li>大多数情况下使用</li>
<li>需要子View正常处理事件</li>
<li>不需要拦截子View的事件</li>
<li>普通的布局容器（LinearLayout、RelativeLayout等）</li>
</ul>
<hr/>
<h5 data-id="heading-12">返回 super</h5>
<p><strong>详细事件流向：</strong></p>
<pre><code class="hljs language-scss" lang="scss">ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.dispatchTouchEvent</span>() → super
    ↓
调用ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.onInterceptTouchEvent</span>()
    ↓
ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.onInterceptTouchEvent</span>()返回super
    ↓
【关键点】返回super表示使用系统默认实现
    ↓
系统默认实现返回false（ViewGroup默认不拦截）
    ↓
等同于返回false，事件继续传递给子View
</code></pre>
<p><strong>最终去向：</strong> ⬇️ <strong>等同于返回false，传递给子View</strong></p>
<p><strong>详细说明：</strong></p>
<ol>
<li>
<p><strong>为什么默认返回false？</strong></p>
<ul>
<li>ViewGroup的设计理念是：默认不拦截，让子View处理</li>
<li>只有在需要时才拦截（如ScrollView需要滑动）</li>
<li>这样可以保证子View的正常交互</li>
</ul>
</li>
<li>
<p><strong>super和false的区别：</strong></p>
<ul>
<li><strong>功能上</strong>：完全相同，都表示不拦截</li>
<li><strong>语义上</strong>：super表示使用系统默认，false表示明确不拦截</li>
<li><strong>推荐</strong>：大多数情况下使用super，更符合面向对象设计</li>
</ul>
</li>
<li>
<p><strong>什么时候需要返回false？</strong></p>
<ul>
<li>当需要明确表示不拦截时</li>
<li>当需要覆盖父类的拦截逻辑时</li>
</ul>
</li>
</ol>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomViewGroup</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ViewGroup</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onInterceptTouchEvent</span><span class="hljs-params">(MotionEvent event)</span> {
        <span class="hljs-comment">// 使用系统默认实现（返回false）</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.onInterceptTouchEvent(event);
    }
    
    <span class="hljs-comment">// 等同于：</span>
    <span class="hljs-comment">// @Override</span>
    <span class="hljs-comment">// public boolean onInterceptTouchEvent(MotionEvent event) {</span>
    <span class="hljs-comment">//     return false;</span>
    <span class="hljs-comment">// }</span>
}
</code></pre>
<p><strong>实际应用场景：</strong></p>
<ul>
<li>大多数情况下使用</li>
<li>不需要自定义拦截逻辑</li>
<li>普通的布局容器</li>
</ul>
<hr/>
<h4 data-id="heading-13">onTouchEvent()返回值详解</h4>
<h5 data-id="heading-14">返回 true</h5>
<p><strong>详细事件流向：</strong></p>
<pre><code class="hljs language-css" lang="css">ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.onTouchEvent</span>()被调用
    【调用时机】拦截了事件 或 子View不处理事件
    ↓
ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.onTouchEvent</span>()返回true ✅
    ↓
【关键点】返回true表示消费事件，不再向上传递
    ↓
事件分发结束，系统记录ViewGroup <span class="hljs-selector-tag">A</span>为目标View（mFirstTouchTarget）
    ↓
父ViewGroup/Activity<span class="hljs-selector-class">.onTouchEvent</span>()不会被调用
    ↓
后续ACTION_MOVE、ACTION_UP会继续传递给ViewGroup <span class="hljs-selector-tag">A</span>
    【说明】后续事件会直接调用ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.dispatchTouchEvent</span>()
</code></pre>
<p><strong>最终去向：</strong> ✅ <strong>事件被ViewGroup A消费，不再向上传递</strong></p>
<p><strong>详细说明：</strong></p>
<ol>
<li>
<p><strong>什么时候会调用onTouchEvent()？</strong></p>
<ul>
<li><strong>情况1</strong>：ViewGroup拦截了事件（onInterceptTouchEvent返回true）</li>
<li><strong>情况2</strong>：子View不处理事件（子View的onTouchEvent返回false）</li>
<li><strong>情况3</strong>：没有子View或子View不可见</li>
</ul>
</li>
<li>
<p><strong>为什么后续事件会继续传递？</strong></p>
<ul>
<li>系统会记录处理ACTION_DOWN的View</li>
<li>后续MOVE、UP会直接传递给这个View</li>
<li>这是为了保持事件序列的一致性</li>
</ul>
</li>
<li>
<p><strong>后续事件的拦截判断：</strong></p>
<ul>
<li>后续MOVE、UP仍然会调用onInterceptTouchEvent()</li>
<li>如果拦截，子View会收到ACTION_CANCEL</li>
<li>这是动态拦截机制</li>
</ul>
</li>
</ol>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomViewGroup</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ViewGroup</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onInterceptTouchEvent</span><span class="hljs-params">(MotionEvent event)</span> {
        <span class="hljs-comment">// 拦截事件</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// ✅ 拦截</span>
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onTouchEvent</span><span class="hljs-params">(MotionEvent event)</span> {
        <span class="hljs-keyword">switch</span> (event.getAction()) {
            <span class="hljs-keyword">case</span> MotionEvent.ACTION_DOWN:
                <span class="hljs-comment">// 处理按下</span>
                handleDown(event);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// ✅ 消费事件</span>
                
            <span class="hljs-keyword">case</span> MotionEvent.ACTION_MOVE:
                <span class="hljs-comment">// 处理移动</span>
                handleMove(event);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// ✅ 消费事件</span>
                
            <span class="hljs-keyword">case</span> MotionEvent.ACTION_UP:
                <span class="hljs-comment">// 处理抬起</span>
                handleUp(event);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// ✅ 消费事件</span>
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<p><strong>实际应用场景：</strong></p>
<ul>
<li>ScrollView处理滑动事件</li>
<li>ViewPager处理左右滑动</li>
<li>自定义ViewGroup需要处理触摸事件</li>
<li>点击空白区域时处理事件</li>
</ul>
<hr/>
<h5 data-id="heading-15">返回 false</h5>
<p><strong>详细事件流向：</strong></p>
<pre><code class="hljs language-scss" lang="scss">ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.onTouchEvent</span>()被调用
    【调用时机】拦截了事件 或 子View不处理事件
    ↓
ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.onTouchEvent</span>()返回false ❌
    ↓
【关键点】返回false表示不消费事件，向上传递
    ↓
事件返回到父ViewGroup（DecorView）
    ↓
DecorView会尝试其他子View，或调用自己的<span class="hljs-built_in">onTouchEvent</span>()
    ↓
如果都不处理，最终调用Activity<span class="hljs-selector-class">.onTouchEvent</span>()
    ↓
系统不会记录ViewGroup <span class="hljs-selector-tag">A</span>为目标View
    ↓
后续ACTION_MOVE、ACTION_UP不会传递给ViewGroup <span class="hljs-selector-tag">A</span>
    【说明】后续事件会重新经过完整的分发流程
</code></pre>
<p><strong>最终去向：</strong> ⬆️ <strong>事件向上传递给父ViewGroup/Activity</strong></p>
<p><strong>详细说明：</strong></p>
<ol>
<li>
<p><strong>为什么后续事件不会传递？</strong></p>
<ul>
<li>系统只记录处理ACTION_DOWN的View</li>
<li>如果ACTION_DOWN不被处理，不会记录目标View</li>
<li>后续MOVE、UP不会传递给该ViewGroup</li>
</ul>
</li>
<li>
<p><strong>向上传递的路径：</strong></p>
<ul>
<li>ViewGroup A → 父ViewGroup（DecorView）→ Activity</li>
<li>每一层都会尝试处理事件</li>
<li>如果都不处理，事件会被丢弃</li>
</ul>
</li>
<li>
<p><strong>什么时候返回false？</strong></p>
<ul>
<li>ViewGroup不需要处理事件时</li>
<li>需要将事件交给父View处理时</li>
<li>ViewGroup被禁用时</li>
</ul>
</li>
</ol>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomViewGroup</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ViewGroup</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">mEnabled</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onInterceptTouchEvent</span><span class="hljs-params">(MotionEvent event)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 拦截</span>
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onTouchEvent</span><span class="hljs-params">(MotionEvent event)</span> {
        <span class="hljs-keyword">if</span> (!mEnabled) {
            <span class="hljs-comment">// ViewGroup被禁用，不处理事件</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// ❌ 不消费，向上传递</span>
        }
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.onTouchEvent(event);
    }
}
</code></pre>
<p><strong>实际应用场景：</strong></p>
<ul>
<li>ViewGroup被禁用时</li>
<li>ViewGroup不需要处理事件时</li>
<li>需要将事件交给父View处理时</li>
</ul>
<hr/>
<h5 data-id="heading-16">返回 super</h5>
<p><strong>详细事件流向：</strong></p>
<pre><code class="hljs language-ini" lang="ini">ViewGroup A.onTouchEvent()被调用
    ↓
ViewGroup A.onTouchEvent()返回super
    ↓
【关键点】返回super表示使用系统默认实现
    ↓
系统检查ViewGroup的clickable属性（ViewGroup默认<span class="hljs-attr">clickable</span>=<span class="hljs-literal">false</span>）
    ↓
根据clickable属性决定返回值：
    ├─ <span class="hljs-attr">clickable</span>=<span class="hljs-literal">true</span> → 返回<span class="hljs-literal">true</span>（消费事件）✅
    │   └─ 事件被ViewGroup A消费，后续MOVE、UP会继续传递
    │   └─ 可以触发点击事件（如果设置了OnClickListener）
    └─ <span class="hljs-attr">clickable</span>=<span class="hljs-literal">false</span> → 返回<span class="hljs-literal">false</span>（不消费事件）❌
        └─ 事件向上传递，后续MOVE、UP不会传递
        └─ 不会触发点击事件
</code></pre>
<p><strong>最终去向：</strong> 🔄 <strong>根据clickable属性决定（ViewGroup默认返回false）</strong></p>
<p><strong>详细说明：</strong></p>
<ol>
<li>
<p><strong>ViewGroup的clickable默认值：</strong></p>
<ul>
<li>ViewGroup默认clickable=false</li>
<li>所以super.onTouchEvent()通常返回false</li>
<li>这与View不同（View的Button等默认clickable=true）</li>
</ul>
</li>
<li>
<p><strong>如何让ViewGroup可点击？</strong></p>
<pre><code class="hljs language-java" lang="java">viewGroup.setClickable(<span class="hljs-literal">true</span>);
<span class="hljs-comment">// 或者</span>
viewGroup.setOnClickListener(listener);  <span class="hljs-comment">// 会自动设置clickable=true</span>
</code></pre>
</li>
<li>
<p><strong>clickable=true时的行为：</strong></p>
<ul>
<li>onTouchEvent()返回true</li>
<li>事件被消费</li>
<li>可以触发点击事件</li>
</ul>
</li>
</ol>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomViewGroup</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ViewGroup</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CustomViewGroup</span><span class="hljs-params">(Context context)</span> {
        <span class="hljs-built_in">super</span>(context);
        <span class="hljs-comment">// 默认clickable=false</span>
        <span class="hljs-comment">// super.onTouchEvent()会返回false</span>
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onTouchEvent</span><span class="hljs-params">(MotionEvent event)</span> {
        <span class="hljs-comment">// 使用系统默认实现</span>
        <span class="hljs-comment">// ViewGroup默认返回false</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.onTouchEvent(event);
    }
    
    <span class="hljs-comment">// 如果需要处理点击，可以：</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">enableClick</span><span class="hljs-params">()</span> {
        setClickable(<span class="hljs-literal">true</span>);  <span class="hljs-comment">// 设置为可点击</span>
        setOnClickListener(v -&gt; {
            <span class="hljs-comment">// 处理点击</span>
        });
    }
}
</code></pre>
<p><strong>实际应用场景：</strong></p>
<ul>
<li>大多数情况下使用</li>
<li>不需要自定义触摸处理</li>
<li>普通的布局容器</li>
</ul>
<hr/>
<h3 data-id="heading-17">View事件流向详解</h3>
<h4 data-id="heading-18">View的两个方法</h4>




















<table><thead><tr><th>方法</th><th>作用</th><th>返回值</th></tr></thead><tbody><tr><td><code>dispatchTouchEvent()</code></td><td>分发事件</td><td>boolean</td></tr><tr><td><code>onTouchEvent()</code></td><td>处理事件</td><td>boolean</td></tr></tbody></table>
<blockquote>
<p>⚠️ <strong>注意</strong>：View没有onInterceptTouchEvent()方法</p>
</blockquote>
<hr/>
<h4 data-id="heading-19">dispatchTouchEvent()返回值详解</h4>
<h5 data-id="heading-20">返回 true</h5>
<p><strong>详细事件流向：</strong></p>
<pre><code class="hljs language-css" lang="css">Activity → Window → DecorView → ViewGroup <span class="hljs-selector-tag">A</span>
    ↓
ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.dispatchTouchEvent</span>() → super
    ↓
ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.onInterceptTouchEvent</span>() → false（不拦截）
    ↓
ViewGroup <span class="hljs-selector-tag">A</span>遍历子View，找到View <span class="hljs-selector-tag">B</span>
    ↓
调用View <span class="hljs-selector-tag">B</span><span class="hljs-selector-class">.dispatchTouchEvent</span>()
    ↓
View <span class="hljs-selector-tag">B</span><span class="hljs-selector-class">.dispatchTouchEvent</span>()返回true ✅
    ↓
【关键点】返回true表示事件被消费，方法立即返回
    ↓
不会调用onTouchEvent()（后续逻辑不执行）
    ↓
ViewGroup <span class="hljs-selector-tag">A</span>记录View <span class="hljs-selector-tag">B</span>为目标View（mFirstTouchTarget = View <span class="hljs-selector-tag">B</span>）
    ↓
后续ACTION_MOVE、ACTION_UP会继续传递给View <span class="hljs-selector-tag">B</span>
    【说明】后续事件会直接调用View <span class="hljs-selector-tag">B</span><span class="hljs-selector-class">.dispatchTouchEvent</span>()
</code></pre>
<p><strong>最终去向：</strong> ✅ <strong>事件被View B消费，不再传递</strong></p>
<p><strong>详细说明：</strong></p>
<ol>
<li>
<p><strong>为什么不会调用onTouchEvent()？</strong></p>
<ul>
<li>dispatchTouchEvent()返回true后，方法立即返回</li>
<li>不会执行后续的onTouchEvent()调用</li>
<li>这是性能优化，避免不必要的方法调用</li>
</ul>
</li>
<li>
<p><strong>为什么后续事件会继续传递？</strong></p>
<ul>
<li>系统会记录处理ACTION_DOWN的View</li>
<li>后续MOVE、UP会直接传递给这个View</li>
<li>不会再次经过完整的分发流程</li>
</ul>
</li>
<li>
<p><strong>ViewGroup的拦截对后续事件的影响：</strong></p>
<ul>
<li>如果DOWN时没拦截，后续MOVE、UP也不会拦截（除非动态拦截）</li>
<li>如果DOWN时拦截了，后续MOVE、UP会继续拦截</li>
</ul>
</li>
</ol>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomView</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">dispatchTouchEvent</span><span class="hljs-params">(MotionEvent event)</span> {
        <span class="hljs-comment">// 完全控制事件处理</span>
        <span class="hljs-keyword">switch</span> (event.getAction()) {
            <span class="hljs-keyword">case</span> MotionEvent.ACTION_DOWN:
                handleDown(event);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// ✅ 返回true，事件在此停止</span>
            <span class="hljs-keyword">case</span> MotionEvent.ACTION_MOVE:
                handleMove(event);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">case</span> MotionEvent.ACTION_UP:
                handleUp(event);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 所有事件都消费</span>
    }
    
    <span class="hljs-comment">// 注意：onTouchEvent()不会被调用</span>
}
</code></pre>
<p><strong>实际应用场景：</strong></p>
<ul>
<li>自定义View需要完全控制所有触摸事件</li>
<li>需要实现特殊的触摸交互逻辑</li>
<li>需要阻止系统默认的点击处理</li>
</ul>
<hr/>
<h5 data-id="heading-21">返回 false</h5>
<p><strong>详细事件流向：</strong></p>
<pre><code class="hljs language-css" lang="css">Activity → Window → DecorView → ViewGroup <span class="hljs-selector-tag">A</span>
    ↓
ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.dispatchTouchEvent</span>() → super
    ↓
ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.onInterceptTouchEvent</span>() → false（不拦截）
    ↓
ViewGroup <span class="hljs-selector-tag">A</span>遍历子View，找到View <span class="hljs-selector-tag">B</span>
    ↓
调用View <span class="hljs-selector-tag">B</span><span class="hljs-selector-class">.dispatchTouchEvent</span>()
    ↓
View <span class="hljs-selector-tag">B</span><span class="hljs-selector-class">.dispatchTouchEvent</span>()返回false ❌
    ↓
【关键点】返回false表示不处理事件，方法立即返回
    ↓
不会调用onTouchEvent()（后续逻辑不执行）
    ↓
事件返回到ViewGroup <span class="hljs-selector-tag">A</span>
    ↓
ViewGroup <span class="hljs-selector-tag">A</span>继续遍历其他子View，或调用自己的onTouchEvent()
    ↓
系统不会记录View <span class="hljs-selector-tag">B</span>为目标View
    ↓
后续ACTION_MOVE、ACTION_UP不会传递给View <span class="hljs-selector-tag">B</span>
</code></pre>
<p><strong>最终去向：</strong> ⬆️ <strong>事件向上传递给父ViewGroup</strong></p>
<p><strong>详细说明：</strong></p>
<ol>
<li>
<p><strong>为什么不会调用onTouchEvent()？</strong></p>
<ul>
<li>dispatchTouchEvent()返回false后，方法立即返回</li>
<li>不会执行后续的onTouchEvent()调用</li>
<li>表示View完全不参与事件处理</li>
</ul>
</li>
<li>
<p><strong>ViewGroup会如何处理？</strong></p>
<ul>
<li>ViewGroup会继续遍历其他子View</li>
<li>如果所有子View都不处理，调用ViewGroup自己的onTouchEvent()</li>
<li>这是ViewGroup的默认行为</li>
</ul>
</li>
<li>
<p><strong>为什么后续事件不会传递？</strong></p>
<ul>
<li>系统只记录处理ACTION_DOWN的View</li>
<li>如果ACTION_DOWN不被处理，不会记录目标View</li>
<li>后续MOVE、UP不会传递给该View</li>
</ul>
</li>
</ol>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DisabledView</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">View</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">mEnabled</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">dispatchTouchEvent</span><span class="hljs-params">(MotionEvent event)</span> {
        <span class="hljs-keyword">if</span> (!mEnabled) {
            <span class="hljs-comment">// View被禁用，不处理事件</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// ❌ 返回false，事件向上传递</span>
        }
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.dispatchTouchEvent(event);
    }
    
    <span class="hljs-comment">// 注意：onTouchEvent()不会被调用</span>
}
</code></pre>
<p><strong>实际应用场景：</strong></p>
<ul>
<li>View被禁用时（enabled=false）</li>
<li>View不可见时（visibility=GONE）</li>
<li>View需要将事件完全交给父View处理时</li>
</ul>
<hr/>
<h5 data-id="heading-22">返回 super</h5>
<p><strong>详细事件流向：</strong></p>
<pre><code class="hljs language-scss" lang="scss">Activity → Window → DecorView → ViewGroup <span class="hljs-selector-tag">A</span>
    ↓
ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.dispatchTouchEvent</span>() → super
    ↓
ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.onInterceptTouchEvent</span>() → false（不拦截）
    ↓
ViewGroup <span class="hljs-selector-tag">A</span>遍历子View，找到View <span class="hljs-selector-tag">B</span>
    ↓
调用View <span class="hljs-selector-tag">B</span><span class="hljs-selector-class">.dispatchTouchEvent</span>()
    ↓
View <span class="hljs-selector-tag">B</span><span class="hljs-selector-class">.dispatchTouchEvent</span>()返回super
    ↓
【关键点】返回super表示使用系统默认处理逻辑
    ↓
进入View<span class="hljs-selector-class">.dispatchTouchEvent</span>()的默认实现
    ↓
检查安全性和View是否可用
    ↓
如果有OnTouchListener，先调用OnTouchListener
    【说明】OnTouchListener的优先级高于<span class="hljs-built_in">onTouchEvent</span>()
    ↓
根据OnTouchListener的返回值决定：
    ├─ 返回true → 不调用<span class="hljs-built_in">onTouchEvent</span>()，事件被OnTouchListener消费 ✅
    └─ 返回false或null → 调用<span class="hljs-built_in">onTouchEvent</span>()
        └─ 根据<span class="hljs-built_in">onTouchEvent</span>()的返回值决定：
            ├─ 返回true → View消费 ✅
            └─ 返回false → 向上传递 ⬆️
</code></pre>
<p><strong>最终去向：</strong> 🔄 <strong>根据OnTouchListener和onTouchEvent()的返回值决定</strong></p>
<p><strong>详细说明：</strong></p>
<ol>
<li>
<p><strong>OnTouchListener的优先级：</strong></p>
<ul>
<li>OnTouchListener在onTouchEvent()之前调用</li>
<li>如果OnTouchListener返回true，onTouchEvent()不会被调用</li>
<li>这是为了给外部监听器更高的优先级</li>
</ul>
</li>
<li>
<p><strong>安全检查：</strong></p>
<ul>
<li>onFilterTouchEventForSecurity()：检查事件是否安全</li>
<li>防止某些安全漏洞</li>
</ul>
</li>
<li>
<p><strong>View的可用性检查：</strong></p>
<ul>
<li>如果View不可用（enabled=false），某些逻辑不会执行</li>
<li>但事件仍然会传递</li>
</ul>
</li>
</ol>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomView</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">dispatchTouchEvent</span><span class="hljs-params">(MotionEvent event)</span> {
        <span class="hljs-comment">// 使用系统默认处理逻辑</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.dispatchTouchEvent(event);
    }
    
    <span class="hljs-comment">// 系统会：</span>
    <span class="hljs-comment">// 1. 检查安全性</span>
    <span class="hljs-comment">// 2. 调用OnTouchListener（如果有）</span>
    <span class="hljs-comment">// 3. 调用onTouchEvent()（如果OnTouchListener不处理）</span>
}
</code></pre>
<p><strong>实际应用场景：</strong></p>
<ul>
<li>大多数情况下使用</li>
<li>需要系统默认的事件处理逻辑</li>
<li>不需要完全自定义事件处理</li>
</ul>
<hr/>
<h4 data-id="heading-23">onTouchEvent()返回值详解</h4>
<h5 data-id="heading-24">返回 true</h5>
<p><strong>详细事件流向：</strong></p>
<pre><code class="hljs language-scss" lang="scss">View <span class="hljs-selector-tag">B</span><span class="hljs-selector-class">.onTouchEvent</span>()被调用
    【调用时机】<span class="hljs-built_in">dispatchTouchEvent</span>()返回super 且 OnTouchListener不处理
    ↓
View <span class="hljs-selector-tag">B</span><span class="hljs-selector-class">.onTouchEvent</span>()返回true ✅
    ↓
【关键点】返回true表示消费事件，不再向上传递
    ↓
事件分发结束，系统记录View <span class="hljs-selector-tag">B</span>为目标View（mFirstTouchTarget = View <span class="hljs-selector-tag">B</span>）
    ↓
父ViewGroup<span class="hljs-selector-class">.onTouchEvent</span>()不会被调用
    ↓
后续ACTION_MOVE、ACTION_UP会继续传递给View <span class="hljs-selector-tag">B</span>
    ↓
如果设置了OnClickListener，在ACTION_UP时会触发点击事件（<span class="hljs-built_in">performClick</span>()）
</code></pre>
<p><strong>最终去向：</strong> ✅ <strong>事件被View B消费，不再向上传递</strong></p>
<p><strong>详细说明：</strong></p>
<ol>
<li>
<p><strong>什么时候会调用onTouchEvent()？</strong></p>
<ul>
<li>dispatchTouchEvent()返回super</li>
<li>OnTouchListener返回false或null</li>
<li>或者OnTouchListener不存在</li>
</ul>
</li>
<li>
<p><strong>点击事件的触发：</strong></p>
<ul>
<li>在ACTION_UP时，如果View可点击（clickable=true）</li>
<li>系统会调用performClick()</li>
<li>performClick()会触发OnClickListener</li>
</ul>
</li>
<li>
<p><strong>后续事件的传递：</strong></p>
<ul>
<li>后续MOVE、UP会直接传递给View B</li>
<li>不会再次经过完整的分发流程</li>
<li>但仍然会调用dispatchTouchEvent()和onTouchEvent()</li>
</ul>
</li>
</ol>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomButton</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">View</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CustomButton</span><span class="hljs-params">(Context context)</span> {
        <span class="hljs-built_in">super</span>(context);
        setClickable(<span class="hljs-literal">true</span>);  <span class="hljs-comment">// 设置为可点击</span>
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onTouchEvent</span><span class="hljs-params">(MotionEvent event)</span> {
        <span class="hljs-keyword">switch</span> (event.getAction()) {
            <span class="hljs-keyword">case</span> MotionEvent.ACTION_DOWN:
                <span class="hljs-comment">// 按下反馈</span>
                setBackgroundColor(Color.RED);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// ✅ 消费事件</span>
                
            <span class="hljs-keyword">case</span> MotionEvent.ACTION_MOVE:
                <span class="hljs-comment">// 移动处理</span>
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// ✅ 消费事件</span>
                
            <span class="hljs-keyword">case</span> MotionEvent.ACTION_UP:
                <span class="hljs-comment">// 抬起反馈</span>
                setBackgroundColor(Color.BLUE);
                <span class="hljs-comment">// 触发点击事件（如果设置了OnClickListener）</span>
                performClick();
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// ✅ 消费事件</span>
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<p><strong>实际应用场景：</strong></p>
<ul>
<li>自定义View需要处理触摸事件</li>
<li>需要实现自定义的触摸反馈</li>
<li>需要触发点击事件</li>
<li>Button、ImageView等可点击的View</li>
</ul>
<hr/>
<h5 data-id="heading-25">返回 false</h5>
<p><strong>详细事件流向：</strong></p>
<pre><code class="hljs language-scss" lang="scss">View <span class="hljs-selector-tag">B</span><span class="hljs-selector-class">.onTouchEvent</span>()被调用
    【调用时机】<span class="hljs-built_in">dispatchTouchEvent</span>()返回super 且 OnTouchListener不处理
    ↓
View <span class="hljs-selector-tag">B</span><span class="hljs-selector-class">.onTouchEvent</span>()返回false ❌
    ↓
【关键点】返回false表示不消费事件，向上传递
    ↓
事件返回到ViewGroup <span class="hljs-selector-tag">A</span>
    ↓
ViewGroup <span class="hljs-selector-tag">A</span>会尝试其他子View，或调用自己的<span class="hljs-built_in">onTouchEvent</span>()
    ↓
系统不会记录View <span class="hljs-selector-tag">B</span>为目标View
    ↓
后续ACTION_MOVE、ACTION_UP不会传递给View <span class="hljs-selector-tag">B</span>
    ↓
不会触发点击事件（不会调用<span class="hljs-built_in">performClick</span>()）
</code></pre>
<p><strong>最终去向：</strong> ⬆️ <strong>事件向上传递给父ViewGroup</strong></p>
<p><strong>详细说明：</strong></p>
<ol>
<li>
<p><strong>为什么不会触发点击事件？</strong></p>
<ul>
<li>performClick()是在onTouchEvent()中调用的</li>
<li>如果onTouchEvent()返回false，表示不处理事件</li>
<li>不处理事件就不会触发点击</li>
</ul>
</li>
<li>
<p><strong>ViewGroup会如何处理？</strong></p>
<ul>
<li>ViewGroup会继续尝试其他子View</li>
<li>如果所有子View都不处理，调用ViewGroup自己的onTouchEvent()</li>
<li>这是ViewGroup的默认行为</li>
</ul>
</li>
<li>
<p><strong>什么时候返回false？</strong></p>
<ul>
<li>View不需要处理事件时</li>
<li>View被禁用时</li>
<li>View需要将事件交给父View处理时</li>
</ul>
</li>
</ol>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DisabledView</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">View</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">mEnabled</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onTouchEvent</span><span class="hljs-params">(MotionEvent event)</span> {
        <span class="hljs-keyword">if</span> (!mEnabled) {
            <span class="hljs-comment">// View被禁用，不处理事件</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// ❌ 不消费，向上传递</span>
        }
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.onTouchEvent(event);
    }
}
</code></pre>
<p><strong>实际应用场景：</strong></p>
<ul>
<li>View被禁用时（enabled=false）</li>
<li>View不需要处理事件时</li>
<li>View需要将事件交给父View处理时</li>
</ul>
<hr/>
<h5 data-id="heading-26">返回 super</h5>
<p><strong>详细事件流向：</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">View</span> B.onTouchEvent()被调用
    ↓
<span class="hljs-keyword">View</span> B.onTouchEvent()返回super
    ↓
【关键点】返回super表示使用系统默认实现
    ↓
系统检查<span class="hljs-keyword">View</span>的clickable属性（不同<span class="hljs-keyword">View</span>的默认值不同）
    ↓
根据clickable属性决定返回值：
    ├─ clickable<span class="hljs-operator">=</span><span class="hljs-literal">true</span> → 返回<span class="hljs-literal">true</span>（消费事件）✅
    │   └─ 事件被<span class="hljs-keyword">View</span> B消费，后续MOVE、UP会继续传递
    │   └─ 在ACTION_UP时调用performClick()，触发OnClickListener
    └─ clickable<span class="hljs-operator">=</span><span class="hljs-literal">false</span> → 返回<span class="hljs-literal">false</span>（不消费事件）❌
        └─ 事件向上传递，后续MOVE、UP不会传递
        └─ 不会触发点击事件
</code></pre>
<p><strong>最终去向：</strong> 🔄 <strong>根据clickable属性决定</strong></p>
<p><strong>详细说明：</strong></p>
<ol>
<li>
<p><strong>不同View的clickable默认值：</strong></p>
<ul>
<li><strong>Button</strong>：clickable=true（默认可点击）</li>
<li><strong>TextView</strong>：clickable=false（默认不可点击）</li>
<li><strong>ImageView</strong>：clickable=false（默认不可点击）</li>
<li><strong>自定义View</strong>：clickable=false（默认不可点击）</li>
</ul>
</li>
<li>
<p><strong>如何让View可点击：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 方法1：直接设置</span>
view.setClickable(<span class="hljs-literal">true</span>);

<span class="hljs-comment">// 方法2：设置监听器（会自动设置clickable=true）</span>
view.setOnClickListener(listener);
</code></pre>
</li>
<li>
<p><strong>clickable=true时的完整流程：</strong></p>
<ul>
<li>ACTION_DOWN：返回true，消费事件</li>
<li>ACTION_MOVE：返回true，消费事件</li>
<li>ACTION_UP：返回true，消费事件，调用performClick()</li>
</ul>
</li>
</ol>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Button（默认clickable=true）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Button</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TextView</span> {
    <span class="hljs-comment">// Button的默认实现</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onTouchEvent</span><span class="hljs-params">(MotionEvent event)</span> {
        <span class="hljs-comment">// 系统默认实现</span>
        <span class="hljs-comment">// clickable=true，所以返回true</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.onTouchEvent(event);
    }
}

<span class="hljs-comment">// TextView（默认clickable=false）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TextView</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">View</span> {
    <span class="hljs-comment">// TextView的默认实现</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onTouchEvent</span><span class="hljs-params">(MotionEvent event)</span> {
        <span class="hljs-comment">// 系统默认实现</span>
        <span class="hljs-comment">// clickable=false，所以返回false</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.onTouchEvent(event);
    }
}
</code></pre>
<p><strong>实际应用场景：</strong></p>
<ul>
<li>大多数情况下使用</li>
<li>需要系统默认的点击处理</li>
<li>Button、ImageView等系统控件</li>
</ul>
<hr/>
<h3 data-id="heading-27">完整场景示例</h3>
<h4 data-id="heading-28">场景：Activity → ViewGroup A → ViewGroup B → View C</h4>
<p><strong>视图层次：</strong></p>
<pre><code class="hljs language-css" lang="css">Activity
  └─ ViewGroup <span class="hljs-selector-tag">A</span> (LinearLayout)
      └─ ViewGroup <span class="hljs-selector-tag">B</span> (RelativeLayout)
          └─ View C (<span class="hljs-selector-tag">Button</span>)
</code></pre>
<hr/>
<h4 data-id="heading-29">场景1：ViewGroup A.dispatchTouchEvent() = true</h4>
<p><strong>返回值设置：</strong></p>
<ul>
<li>ViewGroup A.dispatchTouchEvent() = <strong>true</strong> ✅</li>
</ul>
<p><strong>事件流向：</strong></p>
<pre><code class="hljs language-scss" lang="scss">用户触摸
    ↓
Activity<span class="hljs-selector-class">.dispatchTouchEvent</span>()
    ↓
ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.dispatchTouchEvent</span>() → true ✅
    ↓
【事件在ViewGroup <span class="hljs-selector-tag">A</span>停止】
    ↓
不会调用<span class="hljs-built_in">onInterceptTouchEvent</span>()
    ↓
不会传递给ViewGroup <span class="hljs-selector-tag">B</span>
    ↓
不会调用<span class="hljs-built_in">onTouchEvent</span>()
    ↓
后续MOVE、UP继续传递给ViewGroup <span class="hljs-selector-tag">A</span>
</code></pre>
<p><strong>事件最终到哪里：</strong> ✅ <strong>ViewGroup A消费，ViewGroup B和View C不会收到事件</strong></p>
<hr/>
<h4 data-id="heading-30">场景2：ViewGroup A.dispatchTouchEvent() = false</h4>
<p><strong>返回值设置：</strong></p>
<ul>
<li>ViewGroup A.dispatchTouchEvent() = <strong>false</strong> ❌</li>
</ul>
<p><strong>事件流向：</strong></p>
<pre><code class="hljs language-scss" lang="scss">用户触摸
    ↓
Activity<span class="hljs-selector-class">.dispatchTouchEvent</span>()
    ↓
ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.dispatchTouchEvent</span>() → false ❌
    ↓
【事件向上传递给Activity】
    ↓
不会调用<span class="hljs-built_in">onInterceptTouchEvent</span>()
    ↓
不会传递给ViewGroup <span class="hljs-selector-tag">B</span>
    ↓
不会调用<span class="hljs-built_in">onTouchEvent</span>()
    ↓
后续MOVE、UP不会传递给ViewGroup <span class="hljs-selector-tag">A</span>
    ↓
Activity<span class="hljs-selector-class">.onTouchEvent</span>()会被调用
</code></pre>
<p><strong>事件最终到哪里：</strong> ⬆️ <strong>Activity处理，ViewGroup A、B、C都不会收到事件</strong></p>
<hr/>
<h4 data-id="heading-31">场景3：ViewGroup A拦截并处理</h4>
<p><strong>返回值设置：</strong></p>
<ul>
<li>ViewGroup A.dispatchTouchEvent() = <strong>super</strong></li>
<li>ViewGroup A.onInterceptTouchEvent() = <strong>true</strong> ✅</li>
<li>ViewGroup A.onTouchEvent() = <strong>true</strong> ✅</li>
</ul>
<p><strong>事件流向：</strong></p>
<pre><code class="hljs language-css" lang="css">用户触摸
    ↓
Activity<span class="hljs-selector-class">.dispatchTouchEvent</span>()
    ↓
ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.dispatchTouchEvent</span>() → super
    ↓
ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.onInterceptTouchEvent</span>() → true ✅ 【拦截】
    ↓
【事件被拦截，不传递给ViewGroup <span class="hljs-selector-tag">B</span>】
    ↓
ViewGroup <span class="hljs-selector-tag">B</span>不会收到任何事件
    ↓
View C不会收到任何事件
    ↓
ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.onTouchEvent</span>() → true ✅ 【处理】
    ↓
【事件被ViewGroup <span class="hljs-selector-tag">A</span>消费】
    ↓
后续MOVE、UP继续传递给ViewGroup <span class="hljs-selector-tag">A</span>
</code></pre>
<p><strong>事件最终到哪里：</strong> ✅ <strong>ViewGroup A消费，ViewGroup B和View C不会收到事件</strong></p>
<hr/>
<h4 data-id="heading-32">场景4：ViewGroup A拦截但不处理</h4>
<p><strong>返回值设置：</strong></p>
<ul>
<li>ViewGroup A.dispatchTouchEvent() = <strong>super</strong></li>
<li>ViewGroup A.onInterceptTouchEvent() = <strong>true</strong> ✅</li>
<li>ViewGroup A.onTouchEvent() = <strong>false</strong> ❌</li>
</ul>
<p><strong>事件流向：</strong></p>
<pre><code class="hljs language-scss" lang="scss">用户触摸
    ↓
Activity<span class="hljs-selector-class">.dispatchTouchEvent</span>()
    ↓
ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.dispatchTouchEvent</span>() → super
    ↓
ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.onInterceptTouchEvent</span>() → true ✅ 【拦截】
    ↓
【事件被拦截，不传递给ViewGroup <span class="hljs-selector-tag">B</span>】
    ↓
ViewGroup <span class="hljs-selector-tag">B</span>不会收到任何事件
    ↓
View C不会收到任何事件
    ↓
ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.onTouchEvent</span>() → false ❌ 【不处理】
    ↓
【事件向上传递给Activity】
    ↓
后续MOVE、UP不会传递给ViewGroup <span class="hljs-selector-tag">A</span>
    ↓
Activity<span class="hljs-selector-class">.onTouchEvent</span>()会被调用
</code></pre>
<p><strong>事件最终到哪里：</strong> ⬆️ <strong>Activity处理，ViewGroup A、B、C都不会收到后续事件</strong></p>
<hr/>
<h4 data-id="heading-33">场景5：ViewGroup A不拦截，ViewGroup B不拦截，View C处理</h4>
<p><strong>返回值设置：</strong></p>
<ul>
<li>ViewGroup A.dispatchTouchEvent() = <strong>super</strong></li>
<li>ViewGroup A.onInterceptTouchEvent() = <strong>false</strong> ❌</li>
<li>ViewGroup B.dispatchTouchEvent() = <strong>super</strong></li>
<li>ViewGroup B.onInterceptTouchEvent() = <strong>false</strong> ❌</li>
<li>View C.dispatchTouchEvent() = <strong>super</strong></li>
<li>View C.onTouchEvent() = <strong>true</strong> ✅</li>
</ul>
<p><strong>事件流向：</strong></p>
<pre><code class="hljs language-scss" lang="scss">用户触摸
    ↓
Activity<span class="hljs-selector-class">.dispatchTouchEvent</span>()
    ↓
ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.dispatchTouchEvent</span>() → super
    ↓
ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.onInterceptTouchEvent</span>() → false ❌ 【不拦截】
    ↓
【事件传递给ViewGroup <span class="hljs-selector-tag">B</span>】
    ↓
ViewGroup <span class="hljs-selector-tag">B</span><span class="hljs-selector-class">.dispatchTouchEvent</span>() → super
    ↓
ViewGroup <span class="hljs-selector-tag">B</span><span class="hljs-selector-class">.onInterceptTouchEvent</span>() → false ❌ 【不拦截】
    ↓
【事件传递给View C】
    ↓
View C<span class="hljs-selector-class">.dispatchTouchEvent</span>() → super
    ↓
View C<span class="hljs-selector-class">.onTouchEvent</span>() → true ✅ 【处理】
    ↓
【事件被View C消费】
    ↓
后续MOVE、UP继续传递给View C
</code></pre>
<p><strong>事件最终到哪里：</strong> ✅ <strong>View C消费，ViewGroup A和B不会调用onTouchEvent()</strong></p>
<hr/>
<h4 data-id="heading-34">场景6：ViewGroup A不拦截，ViewGroup B不拦截，View C不处理，ViewGroup B处理</h4>
<p><strong>返回值设置：</strong></p>
<ul>
<li>ViewGroup A.dispatchTouchEvent() = <strong>super</strong></li>
<li>ViewGroup A.onInterceptTouchEvent() = <strong>false</strong> ❌</li>
<li>ViewGroup B.dispatchTouchEvent() = <strong>super</strong></li>
<li>ViewGroup B.onInterceptTouchEvent() = <strong>false</strong> ❌</li>
<li>View C.dispatchTouchEvent() = <strong>super</strong></li>
<li>View C.onTouchEvent() = <strong>false</strong> ❌</li>
<li>ViewGroup B.onTouchEvent() = <strong>true</strong> ✅</li>
</ul>
<p><strong>事件流向：</strong></p>
<pre><code class="hljs language-scss" lang="scss">用户触摸
    ↓
Activity<span class="hljs-selector-class">.dispatchTouchEvent</span>()
    ↓
ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.dispatchTouchEvent</span>() → super
    ↓
ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.onInterceptTouchEvent</span>() → false ❌ 【不拦截】
    ↓
【事件传递给ViewGroup <span class="hljs-selector-tag">B</span>】
    ↓
ViewGroup <span class="hljs-selector-tag">B</span><span class="hljs-selector-class">.dispatchTouchEvent</span>() → super
    ↓
ViewGroup <span class="hljs-selector-tag">B</span><span class="hljs-selector-class">.onInterceptTouchEvent</span>() → false ❌ 【不拦截】
    ↓
【事件传递给View C】
    ↓
View C<span class="hljs-selector-class">.dispatchTouchEvent</span>() → super
    ↓
View C<span class="hljs-selector-class">.onTouchEvent</span>() → false ❌ 【不处理】
    ↓
【事件返回ViewGroup <span class="hljs-selector-tag">B</span>】
    ↓
ViewGroup <span class="hljs-selector-tag">B</span><span class="hljs-selector-class">.onTouchEvent</span>() → true ✅ 【处理】
    ↓
【事件被ViewGroup <span class="hljs-selector-tag">B</span>消费】
    ↓
后续MOVE、UP继续传递给ViewGroup <span class="hljs-selector-tag">B</span>
</code></pre>
<p><strong>事件最终到哪里：</strong> ✅ <strong>ViewGroup B消费，View C不处理，ViewGroup A不会调用onTouchEvent()</strong></p>
<hr/>
<h4 data-id="heading-35">场景7：ViewGroup A不拦截，ViewGroup B不拦截，都不处理</h4>
<p><strong>返回值设置：</strong></p>
<ul>
<li>ViewGroup A.dispatchTouchEvent() = <strong>super</strong></li>
<li>ViewGroup A.onInterceptTouchEvent() = <strong>false</strong> ❌</li>
<li>ViewGroup B.dispatchTouchEvent() = <strong>super</strong></li>
<li>ViewGroup B.onInterceptTouchEvent() = <strong>false</strong> ❌</li>
<li>View C.dispatchTouchEvent() = <strong>super</strong></li>
<li>View C.onTouchEvent() = <strong>false</strong> ❌</li>
<li>ViewGroup B.onTouchEvent() = <strong>false</strong> ❌</li>
<li>ViewGroup A.onTouchEvent() = <strong>false</strong> ❌</li>
</ul>
<p><strong>事件流向：</strong></p>
<pre><code class="hljs language-scss" lang="scss">用户触摸
    ↓
Activity<span class="hljs-selector-class">.dispatchTouchEvent</span>()
    ↓
ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.dispatchTouchEvent</span>() → super
    ↓
ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.onInterceptTouchEvent</span>() → false ❌ 【不拦截】
    ↓
【事件传递给ViewGroup <span class="hljs-selector-tag">B</span>】
    ↓
ViewGroup <span class="hljs-selector-tag">B</span><span class="hljs-selector-class">.dispatchTouchEvent</span>() → super
    ↓
ViewGroup <span class="hljs-selector-tag">B</span><span class="hljs-selector-class">.onInterceptTouchEvent</span>() → false ❌ 【不拦截】
    ↓
【事件传递给View C】
    ↓
View C<span class="hljs-selector-class">.dispatchTouchEvent</span>() → super
    ↓
View C<span class="hljs-selector-class">.onTouchEvent</span>() → false ❌ 【不处理】
    ↓
【事件返回ViewGroup <span class="hljs-selector-tag">B</span>】
    ↓
ViewGroup <span class="hljs-selector-tag">B</span><span class="hljs-selector-class">.onTouchEvent</span>() → false ❌ 【不处理】
    ↓
【事件返回ViewGroup <span class="hljs-selector-tag">A</span>】
    ↓
ViewGroup <span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.onTouchEvent</span>() → false ❌ 【不处理】
    ↓
【事件向上传递给Activity】
    ↓
后续MOVE、UP不会传递给任何View
    ↓
Activity<span class="hljs-selector-class">.onTouchEvent</span>()会被调用
</code></pre>
<p><strong>事件最终到哪里：</strong> ⬆️ <strong>Activity处理，所有View都不处理</strong></p>
<hr/>
<h3 data-id="heading-36">快速查询表</h3>
<h4 data-id="heading-37">ViewGroup事件流向快速查询</h4>





























































<table><thead><tr><th>dispatchTouchEvent</th><th>onInterceptTouchEvent</th><th>onTouchEvent</th><th>事件最终到哪里</th><th>后续事件</th></tr></thead><tbody><tr><td><strong>true</strong></td><td>-</td><td>-</td><td>✅ <strong>ViewGroup停止</strong></td><td>继续传递给ViewGroup</td></tr><tr><td><strong>false</strong></td><td>-</td><td>-</td><td>⬆️ <strong>向上传递给父View/Activity</strong></td><td>不传递给ViewGroup</td></tr><tr><td><strong>super</strong></td><td><strong>true</strong></td><td><strong>true</strong></td><td>✅ <strong>ViewGroup消费</strong></td><td>继续传递给ViewGroup</td></tr><tr><td><strong>super</strong></td><td><strong>true</strong></td><td><strong>false</strong></td><td>⬆️ <strong>向上传递给父View/Activity</strong></td><td>不传递给ViewGroup</td></tr><tr><td><strong>super</strong></td><td><strong>false</strong></td><td>-</td><td>⬇️ <strong>传递给子View</strong></td><td>由子View决定</td></tr><tr><td><strong>super</strong></td><td><strong>false</strong></td><td><strong>true</strong></td><td>✅ <strong>ViewGroup消费</strong>（子View不处理时）</td><td>继续传递给ViewGroup</td></tr><tr><td><strong>super</strong></td><td><strong>false</strong></td><td><strong>false</strong></td><td>⬆️ <strong>向上传递</strong>（都不处理）</td><td>不传递给ViewGroup</td></tr></tbody></table>
<h4 data-id="heading-38">View事件流向快速查询</h4>



































<table><thead><tr><th>dispatchTouchEvent</th><th>onTouchEvent</th><th>事件最终到哪里</th><th>后续事件</th></tr></thead><tbody><tr><td><strong>true</strong></td><td>-</td><td>✅ <strong>View停止</strong></td><td>继续传递给View</td></tr><tr><td><strong>false</strong></td><td>-</td><td>⬆️ <strong>向上传递给父ViewGroup</strong></td><td>不传递给View</td></tr><tr><td><strong>super</strong></td><td><strong>true</strong></td><td>✅ <strong>View消费</strong></td><td>继续传递给View</td></tr><tr><td><strong>super</strong></td><td><strong>false</strong></td><td>⬆️ <strong>向上传递给父ViewGroup</strong></td><td>不传递给View</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-39">事件流向符号说明</h3>
<ul>
<li>✅ <strong>消费/停止</strong>：事件被消费，不再传递</li>
<li>⬆️ <strong>向上传递</strong>：事件向上传递给父View/Activity</li>
<li>⬇️ <strong>向下传递</strong>：事件向下传递给子View</li>
<li>🛑 <strong>拦截</strong>：拦截事件，不传递给子View</li>
<li>🔄 <strong>默认处理</strong>：按照系统默认逻辑处理</li>
</ul>
<hr/>
<h3 data-id="heading-40">核心记忆要点</h3>
<h4 data-id="heading-41">1. dispatchTouchEvent()返回值</h4>
<ul>
<li><strong>true</strong> → ✅ 事件在此停止，不再传递</li>
<li><strong>false</strong> → ⬆️ 事件向上传递，不处理</li>
<li><strong>super</strong> → 🔄 进入默认处理流程</li>
</ul>
<h4 data-id="heading-42">2. onInterceptTouchEvent()返回值（只有ViewGroup有）</h4>
<ul>
<li><strong>true</strong> → 🛑 拦截，不传递给子View</li>
<li><strong>false</strong> → ⬇️ 不拦截，传递给子View</li>
<li><strong>super</strong> → ⬇️ 等同于false，传递给子View</li>
</ul>
<h4 data-id="heading-43">3. onTouchEvent()返回值</h4>
<ul>
<li><strong>true</strong> → ✅ 消费事件，不再向上传递</li>
<li><strong>false</strong> → ⬆️ 不消费，向上传递</li>
<li><strong>super</strong> → 🔄 根据clickable属性决定</li>
</ul>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一套底座支撑多场景：高德地图基于 Paimon + StarRocks 轨迹服务实践]]></title>    <link>https://juejin.cn/post/7593187953271209984</link>    <guid>https://juejin.cn/post/7593187953271209984</guid>    <pubDate>2026-01-09T09:31:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593187953271209984" data-draft-id="7593173569870872628" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一套底座支撑多场景：高德地图基于 Paimon + StarRocks 轨迹服务实践"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-09T09:31:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云大数据AI技术"/> <meta itemprop="url" content="https://juejin.cn/user/2414974667341287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一套底座支撑多场景：高德地图基于 Paimon + StarRocks 轨迹服务实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2414974667341287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云大数据AI技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T09:31:25.000Z" title="Fri Jan 09 2026 09:31:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：赵宇(司忱)/数据开发工程师</p>
<blockquote>
<p>导读：</p>
<p>本文整理自高德数据开发工程师、赵宇在 Streaming Lakehouse Meetup上的分享。聚焦高德地图轨迹服务在实时湖仓方向的落地实践。</p>
<p>面对轨迹数据“高实时、高并发、长周期存储”的典型特征，高德团队以访问跨度为依据完成热/温/冷分层，并以 Apache Paimon + StarRocks 构建统一的数据底座，支撑轨迹数据的近实时写入与高性能查询。</p>
<p>该方案通过性能验证覆盖<strong>千亿级轨迹数据查询</strong>等关键场景，在满足实时与查询性能的前提下，实现了分层存储下的“性能—成本”最优平衡，并为后续将流批一体能力扩展到更多业务域、打通 BI 与算法链路提供了可复制的路径。</p>
</blockquote>
<h2 data-id="heading-0">高德地图轨迹相关的背景及面临的挑战</h2>
<p>在进入背景介绍之前，先对轨迹项目在端侧的一些典型应用做一个简要说明。</p>
<p>以“足迹地图”功能为例：用户完成授权后，每一次导航结束，其行程轨迹会被记录并展示在轨迹列表中。用户打开某一段轨迹后，页面会展示该次行程的基础信息，例如驾驶时长、驾驶里程、平均速度等；同时还会在端上渲染出轨迹形状及关键点特征信息，例如会车位置、最大速度点等。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d7879af18394b109be6646823506f2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768555885&amp;x-signature=fJoUt8QXxC8zKF5Xv0gtwgBc4i0%3D" alt="image (17).png" loading="lazy"/></p>
<p>同时，高德地图会将用户的轨迹点与道路进行实时轨迹匹配，从而渲染出“足迹地图”的背景图。以下图为例，该图展示了一位用户在北京范围内行走过道路的渲染效果。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3a028708d2645faba75a28c60db7210~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768555885&amp;x-signature=p2rPnO%2FhYM3LsGy8PXwolqpyqYQ%3D" alt="image (18).png" loading="lazy"/></p>
<p>下图展示的是端侧“工作地图”的一个应用场景。通过该功能，用户可以查看一段轨迹在<strong>何时、何地开始</strong>，在<strong>哪些地点停留以及停留时长</strong>，并在结束后记录其<strong>最终结束位置</strong>。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc6c5d0e62af498dbf56bbc941d9a9d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768555885&amp;x-signature=pLolAYh6N74noUE%2F7gltXpiHZKk%3D" alt="image (19).png" loading="lazy"/></p>
<p>另一个需要补充的应用场景是此前较为热门的“猫鼠游戏”。在该玩法中，同一群组内的用户可以共享各自的实时位置；在一局游戏结束后，系统也会生成并展示用户在该局中的<strong>行程轨迹</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/615aa7fbede848c39d520e599b115a98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768555885&amp;x-signature=T6mfyTXPz%2BiTCyde9ZzsvJE0YNY%3D" alt="image (20).png" loading="lazy"/></p>
<h3 data-id="heading-1">面临的核心挑战</h3>
<p>由于高德地图轨迹数据具有较强的业务特殊性与实时性要求，因此无论在轨迹的<strong>采集、处理</strong>，还是在<strong>存储与查询</strong>环节，都面临一系列挑战。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a4c3fa114224888badd0047f6ff65e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768555885&amp;x-signature=B%2BUP0bg239eG%2BtzvPCn9AdJ2xuo%3D" alt="5eecdaf48460cde5863c6321f93ae74c5aa4fad04a0ed84275b8339e1c4c2483a563e2d00e1f23a98d68742cd653602afc228fb22ff2c4af60a88a48637e1a71be1f310448109ab40fd3fd7eff04315bae6224a2307c97f612302aab73979c04.png" loading="lazy"/></p>
<p><strong>第一，实时可见性要求高。</strong></p>
<p>轨迹数据是判断用户行为的重要依据，数据鲜度至关重要。因此，端侧业务对轨迹数据的实时可见性提出了较高要求。并且日常的轨迹数据的写入流量达到了<strong>每秒百万级</strong>，在节假日等高峰时段还会出现翻倍增长。对数据链路而言，无论是实时计算能力还是整体稳定性，都面临较大压力与挑战。</p>
<p><strong>第二，多场景查询需求复杂，对性能要求高。</strong></p>
<p>轨迹数据不仅服务于离线挖掘以及问题排查，同样需要服务各种线上场景，对查询性能要求也非常高。</p>
<p><strong>第三，历史数据规模大，存储成本高。</strong></p>
<p>高德地图存储了全量历史轨迹数据。在缺乏有效分层、压缩与治理策略的情况下，数据规模持续增长将带来显著的存储成本压力。</p>
<p><strong>第四，历史演进形成数据烟囱，业务依赖复杂。</strong></p>
<p>受多年历史演进影响，轨迹相关链路形成了一定程度的数据烟囱；同时，存在 <strong>20+</strong> 业务依赖，链路与接口关系较为复杂，进一步提升了在架构设计与存储整合上的技术难度。</p>
<h3 data-id="heading-2">统一链路优化方案</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29ad34fdf7144e01a0ea6ee831b3a0c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768555885&amp;x-signature=2JBYp3R1qH31KzqIcEykCRjl3rM%3D" alt="5eecdaf48460cde5863c6321f93ae74c5aa4fad04a0ed84275b8339e1c4c2483a563e2d00e1f23a98d68742cd653602a0d50ecb3f30f832efdb830d1e46df9a0b5ec8b267349bece55a4f6e5feb334fe4d7c21895cde9a85654e83d76c474bef.png" loading="lazy"/></p>
<p>基于上述挑战，我们计划对不同业务的计算场景与存储体系进行整合，核心方向包括：</p>
<ol>
<li>
<p><strong>统一数据处理。</strong> 整合多业务场景下分散的计算链路，建立标准化的数据处理流程与规范。</p>
</li>
<li>
<p><strong>建设通用存储与查询服务。</strong> 提供标准化的轨迹存储能力与统一查询接口，减少重复建设。</p>
</li>
<li>
<p><strong>降低整体成本。</strong> 在控制资源成本的同时，降低后续人工运维成本与系统复杂度。</p>
</li>
<li>
<p><strong>保障性能不妥协。</strong> 在统一架构下保障实时性与查询性能。</p>
</li>
</ol>
<h2 data-id="heading-3">轨迹的能力建设与方案调研</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d692f774468a4bcfb82ceb08706c5c18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768555885&amp;x-signature=VqafAzm2cqoABqytSp1mtUfFBEY%3D" alt="image (21).png" loading="lazy"/></p>
<p>首先介绍轨迹在全场景下的服务能力体系。</p>
<p>作为数据中台，我们承担离线与实时流量的统一入口角色。以轨迹业务为例，整体可按自下而上的链路理解：</p>
<p>从最底层的轨迹原始点数据出发，经由 ETL 加工与清洗，沉淀形成轨迹领域的基础数据资产，包括轨迹点、轨迹段、轨迹匹配结果，以及离线数据等。</p>
<p>依托数据中台与交通业务在轨迹领域的长期建设，我们进一步整合并沉淀出一组核心能力：例如公共层的轨迹实时流任务、通用的轨迹查询能力，以及特征平台等基础能力服务平台。</p>
<p>在核心能力之上，平台对全链路能力进行模块化封装，主要包括两类服务：</p>
<ul>
<li>
<p><strong>查询服务模块</strong>；</p>
</li>
<li>
<p><strong>推送订阅模块</strong>。</p>
</li>
</ul>
<p>基于上述两类模块，轨迹服务能够支撑多类业务场景的接入与调用，包括内部调查平台，以及面向 C 端的相关功能与应用。</p>
<h3 data-id="heading-4">业务访问跨度调研</h3>
<p>明确要将轨迹能力建设为上述统一体系后，下一步需要回答“如何落地”的问题。因此，我们首先开展了对业务访问跨度的调研：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5566339b0ad6477eba32133c071a3fa5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768555885&amp;x-signature=kSLyJJMj%2BG8bwektUiHuXogpLoM%3D" alt="5eecdaf48460cde5863c6321f93ae74c5aa4fad04a0ed84275b8339e1c4c2483a563e2d00e1f23a98d68742cd653602afc228fb22ff2c4af77546376af21a1ff1fb1e70af6b3f61f9dd8d866ed8c82419f1980b601d6c8e4b5e689a894c34d25.png" loading="lazy"/></p>
<p>访问跨度用于衡量“用户访问的轨迹数据距离当前时间有多远”。例如，用户查看 <strong>n 天前</strong>的轨迹数据，则该次访问的跨度定义为 <strong>n</strong>。</p>
<p>基于这一口径，我们对<strong>日均访问跨度</strong>进行了统计（见左侧图）。结果显示：</p>
<ul>
<li>
<p><strong>0–1 天（当天与昨天）的访问占比约为 67%。这部分数据访问最为集中，可定义为热数据。</strong></p>
</li>
<li>
<p><strong>1–3 天直至 30–60 天</strong>区间内的访问占比整体较为均匀，可定义为<strong>温数据</strong>。</p>
</li>
<li>
<p><strong>60 天以上</strong>覆盖更长周期的历史数据，整体访问占比约为 <strong>16%</strong>。尽管访问频次相对较低，但由于其代表全量历史沉淀，体量非常大，可定义为<strong>冷数据</strong>。</p>
</li>
</ul>
<p>在此基础上，我们进一步调研了“访问跨度在 60 天以上的用户”在查看历史轨迹时的行为特征：即这些用户所访问的历史轨迹，在其个人全部轨迹中的位置分布（可理解为是否仍会查看更久远的记录）。调研结果表明，仍有相当比例的用户会回看较早期的历史轨迹。</p>
<p>综合来看，一方面，近期数据访问频繁，对查询性能与实时响应提出更高要求；另一方面，60 天以上历史数据虽然访问相对较少，但仍存在明确的用户需求（例如具备纪念意义的行程回看等），且该部分数据体量更大，对存储成本高度敏感。</p>
<p>因此，整体上需要一套能够支持分层存储并同时满足高效查询的数据方案。</p>
<h3 data-id="heading-5">性能+存储需求调研</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56e5f61dd93e444e8daab6d0a2a4a500~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768555885&amp;x-signature=OFuWcYAQxQyImFUUAUb7DSHX43Q%3D" alt="5eecdaf48460cde5863c6321f93ae74c5aa4fad04a0ed84275b8339e1c4c2483a563e2d00e1f23a98d68742cd653602a0d50ecb3f30f832ef9034c23b6a83e34a2cead40dabf924c6473c031bc9917c4297144b9350559ec9c718bfc0275b3f8.png" loading="lazy"/></p>
<p>在推进该方案的过程中，我们也关注并调研了阿里巴巴集团的数据湖项目，这为后续的湖仓一体化提供了可行路径。</p>
<p>从能力构成来看，集团数据湖项目的核心优势主要体现在三点：</p>
<ol>
<li>
<p>基于 Apache Flink + Apache Paimon，能够提供高性能的近实时数据写入能力，满足处理轨迹数据对时效性的要求。</p>
</li>
<li>
<p>数据写入 Paimon 后，可通过 StarRocks 外部表方式进行挂载，从而对 Paimon 表上的数据提供高性能查询能力。</p>
</li>
<li>
<p>采用 Paimon + 盘古的存储组合，相比其他存储介质具备显著的成本优势。</p>
</li>
</ol>
<p>基于上述优势，其整体数据链路如左图所示：首先通过 Flink Job 消费消息队列中的源端轨迹消息，完成 ETL 处理及必要的聚合计算；随后将结果写入数据存储层，采用 Paimon + 盘古进行持久化存储；最后通过 StarRocks 挂载外部表的方式对湖表数据提供统一、低延迟的查询服务。</p>
<p>在验证 StarRocks + Paimon 是否能够覆盖轨迹项目的性能诉求与关键挑战时，我们开展了一系列性能评估与参数调优工作。</p>
<ul>
<li>
<p>基于 Flink + Paimon 对写入吞吐进行了测试，结果表明该链路能够满足轨迹数据近实时处理的需求。</p>
</li>
<li>
<p>在千亿量级下轨迹的点查场景下，我们使用 StarRocks 进行了查询性能测试，结果达到既定的性能指标要求。</p>
</li>
</ul>
<p>在此基础上，我们对 Paimon 的相关参数进行了调整，以在写入效率与查询性能之间实现更好的平衡。综合测试结果显示，整体链路验证通过：可以采用 StarRocks 作为 OLAP 引擎直连数据湖存储，实现轨迹数据的及时查询与分析。</p>
<p>在存储侧，借助 Paimon + 盘古的组合方案，轨迹存储成本实现了显著优化，年度节省达到百万级规模。</p>
<p><strong>总体而言，StarRocks + Paimon 方案在满足性能指标的前提下，实现了明确的成本优化效果。</strong></p>
<h2 data-id="heading-6">Paimon + StarRocks在轨迹应用中的落地及探索</h2>
<h3 data-id="heading-7">数据分层架构设计（热数据）</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f90c8863366547788ac9ec807fa78dc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768555885&amp;x-signature=HxePZs%2BBaTp%2BH1D971nY5B6lgfk%3D" alt="5eecdaf48460cde5863c6321f93ae74c5aa4fad04a0ed84275b8339e1c4c2483a563e2d00e1f23a98d68742cd653602afa4cc552274ccc031ff4b1cdeac34f7a4439c41d43c13797ad73afe89fed7a493e2545657bb74f57ec25ae8d09d7f073.png" loading="lazy"/></p>
<p>接下来我将进一步说明 Paimon + StarRocks 在轨迹应用中的落地方式与实践探索。</p>
<p>前文提到，我们基于“访问跨度”将轨迹数据划分为三层：热数据、温数据、冷数据。在具体实现上，热数据又进一步细分为 A/B 两层。</p>
<p><strong>热数据 A 层：</strong> 面向对性能要求极高、对响应时延（RT）极为敏感的业务场景。该层采用 Redis 存储，保留近 1 天的数据。</p>
<ul>
<li>
<p>数据组织方式：以用户信息 + 轨迹点信息为主。</p>
</li>
<li>
<p>典型场景：实时位置类查询与高频互动场景，例如“猫鼠游戏”、家人地图、最新位置查询，以及 WIA（工作地图）等。</p>
</li>
</ul>
<p><strong>热数据 B 层：</strong> 主要承载近几天内的轨迹查询需求。该层采用 Lindorm 存储，保留近 3 天的数据。</p>
<ul>
<li>
<p>数据组织方式：以“用户 + 时间片 + 轨迹段” 的结构化设计，以满足多种业务不同的查询方式。</p>
</li>
<li>
<p>典型场景：足迹/运动等近三天轨迹查询；同时也支撑部分内部调查平台使用，以及实时轨迹匹配等能力的在线调用。</p>
</li>
</ul>
<h3 data-id="heading-8">数据分层架构设计（温、冷数据）</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6425a1cd384e43aab127d47a0485e00b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768555885&amp;x-signature=nVu5WZ2NMgfDtgxY%2FwtP6dbPcoY%3D" alt="5eecdaf48460cde5863c6321f93ae74c5aa4fad04a0ed84275b8339e1c4c2483a563e2d00e1f23a98d68742cd653602afa4cc552274ccc03598cddcd0a50830508ff061a335c5dd57ccf6c61713dfbf287c85a61e2648109c44b7ab0651907ea.png" loading="lazy"/></p>
<p>温数据与冷数据部分采用前文提到的 <strong>Apache Paimon + StarRocks</strong> 方案。我们将三天以外的历史轨迹数据统一写入 Paimon，在显著降低湖存储成本的同时，构建起流批一体的统一数据架构。</p>
<p><strong>温数据层（3 天–60 天）</strong></p>
<p>温数据层使用 Paimon + StarRocks 存储并查询 3 天至 60 天范围内的轨迹数据，整体可实现<strong>百毫秒级</strong>响应。</p>
<ul>
<li>
<p>数据组织方式：以“用户 + 时间片 + 轨迹段” 的结构化设计，以覆盖多种查询形态。</p>
</li>
<li>
<p>数据特征：整体 QPS 较低、访问频率相对有限，对 RT 的容忍度相对更高。</p>
</li>
</ul>
<p><strong>冷数据层（60 天以上全量历史）</strong></p>
<p>冷数据层同样采用 Paimon + StarRocks，承载 60 天以上的全量历史轨迹数据。相较温数据层，该层在存储结构上做了进一步优化，将多段轨迹按照轨迹的唯一 ID 聚合为一条完整轨迹，并且引入压缩策略以显著降低历史数据的存储开销。</p>
<p>温/冷数据层主要支撑足迹地图等产品能力对历史轨迹的查询与展示。同时，在离线分析场景中（如 AI 训练、规律挖掘等）以及内部调查平台等工具型场景，也会使用该部分数据资产。</p>
<h3 data-id="heading-9">整体链路架构图</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a7c3f20bc1841d8959c3cf11e20c5a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768555885&amp;x-signature=up7SfoNuYsVLGWnfB%2Bo5kSGdtsk%3D" alt="5eecdaf48460cde5863c6321f93ae74c5aa4fad04a0ed84275b8339e1c4c2483a563e2d00e1f23a98d68742cd653602a0524375348f90ffd024b62de75a06ba27915c57f0c427fd6c327b4ea19d5151fa61ba2f300c01db66d107157f8bbaaaa.png" loading="lazy"/></p>
<p>整体链路的架构示意图可按三层理解：<strong>数据处理层、存储层与接口层</strong>。</p>
<p>从轨迹流处理链路来看，<strong>Flink</strong> 消费原始轨迹数据后，会根据访问跨度与数据分层策略，将数据分别写入<strong>热/温/冷</strong>三类存储介质。与此同时，在轨迹流加工过程中，链路还会引入规划数据及行后（规划导航）相关数据，并借助 <strong>Paimon 的</strong>Partial Update引擎完成宽表化关联，从而生成完整的行程信息并进行持久化存储。</p>
<p>在行程信息沉淀后，平台进一步基于行程信息与行程特征，并结合三急一超数据、天气数据等外部维度，构建里程碑、跨城识别、Link通行量等实时特征能力。</p>
<p>在接口层，平台对外统一提供查询服务能力。综合来看，基于 <strong>Flink + Paimon + StarRocks</strong> 的数据湖方案，并以 Lindorm、Redis 等存储介质作为补充，轨迹链路被整合为一套通用的轨迹基础能力，并在建设目标上体现为“三个一”：</p>
<ul>
<li>
<p><strong>一套存储架构：</strong> 将高德轨迹数据与行程信息在同一架构下进行统一存储与计算整合，同时对轨迹查询服务进行统一化治理。</p>
</li>
<li>
<p><strong>一套特征体系。</strong> 在推进该体系建设过程中，我们对既有特征进行了梳理与收敛，去除历史沉淀下的冗余特征，统一维护一套 Link 级实时特征。在关键业务周期内，该特征体系也支撑并保障了高德“十一出行节”等高峰场景下的稳定性。</p>
</li>
<li>
<p><strong>一套数据湖架构。</strong> 基于数据湖能力，平台形成了一套统一的数据开发与数据服务架构，并将其作为数据开发层的主要技术路径。一方面提升了研发交付效率，另一方面也降低了后续人工运维成本。</p>
</li>
</ul>
<h3 data-id="heading-10">数据分层架构设计总结</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbe5c3250e624efc8299bad53ef9b168~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768555885&amp;x-signature=D0GDEjpozISGaOjl1UIUc7gkXAg%3D" alt="5eecdaf48460cde5863c6321f93ae74c5aa4fad04a0ed84275b8339e1c4c2483a563e2d00e1f23a98d68742cd653602aaac77b6f1abe50df13f0408df7726cc68bfa44526e493719f2098432e8d1f7f705d44c8d5e36c9f6d14d7240e718d0e1.png" loading="lazy"/></p>
<p>关于数据分层架构设计，整体可以从两个方面进行总结：</p>
<p><strong>第一：访问频次分层</strong> 我们以访问跨度为核心指标完成数据热度分析，并基于“时间衰减”的策略，将数据随生命周期在不同存储介质之间动态迁移。</p>
<p><strong>第二：智能数据迁移</strong></p>
<p>在数据访问过程中，系统可根据访问模式在不同层级间自动路由查询，确保数据的就近访问。该机制带来阶梯式的存储成本收益。</p>
<p>基于上述设计，分层架构主要体现两项核心价值：</p>
<ol>
<li>
<p>能够同时覆盖从<strong>实时决策</strong>到<strong>历史分析</strong>的多样化业务需求；</p>
</li>
<li>
<p>通过分层存储实现<strong>性能与成本</strong>之间的最佳平衡。</p>
</li>
</ol>
<h3 data-id="heading-11">查询场景下的一些优化实践</h3>
<p><strong>1、存储优化：轨迹压缩-降低存储成本</strong>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6828edafe6547e3891fd4e458b8fefd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768555885&amp;x-signature=nZejgMABU%2FhnGWtEoFOZDKa1K1Y%3D" alt="5eecdaf48460cde5863c6321f93ae74c5aa4fad04a0ed84275b8339e1c4c2483a563e2d00e1f23a98d68742cd653602afc228fb22ff2c4af6510f6bc16b48b6e0d902b92423a719bf8e9d473deed2c513f3fc6470c97e850047d960e9a4570b2.png" loading="lazy"/></p>
<p>前文提到，我们对轨迹数据进行了压缩，以显著降低历史存储成本。具体实现上采用了 Google 的 <strong>Polyline 编码</strong>。其基本思路是：将经纬度浮点数按固定倍率进行量化（缩放）后转换为整数，再对相邻点的坐标增量进行差分编码，并通过可变长度编码将结果映射为 ASCII 字符串，从而实现对经纬度序列的高效压缩。本质上，该算法是对经纬度整数序列（及其差分结果）进行紧凑编码。</p>
<p>我们在上述算法思路的基础上，结合高德常见的通用轨迹格式进行了适配与改造，从而实现对轨迹数据的统一压缩。以压缩前的数据样例为例，一段轨迹由多个点构成；每个点通常包含 <strong>时间、经度、纬度、速度、方向、高程</strong>等字段信息。</p>
<p>经过压缩后，轨迹数据会被编码为一段紧凑的字符串（形态上类似“乱码”）。从效果来看，单条轨迹的压缩率可达到 <strong>43%–50%</strong>；轨迹越长，压缩效果越明显。整体而言，高德轨迹数据全面应用该压缩方案后，综合收益约为 <strong>47%</strong>。在性能方面，该压缩算法具备较好的资源效率：即便在<strong>亿级轨迹</strong>的压缩规模下，CPU 资源消耗仍保持在较低水平。</p>
<p><strong>2、存储优化：集团 Alake 门户的存储优化功能</strong>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/133f95d16356476b81e630813c09d982~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768555885&amp;x-signature=Om6kaeAyQUA4fcewBpd4YB5nHs0%3D" alt="5eecdaf48460cde5863c6321f93ae74c5aa4fad04a0ed84275b8339e1c4c2483a563e2d00e1f23a98d68742cd653602a15464a86392b1bf594ec014988a9b25e4e48f330f0aa8836c3fa939067edf91ef5b6949115c8defe9f893503a351ce55 (1).png" loading="lazy"/></p>
<p>由于本项目使用集团数据湖能力，集团门户提供了存储治理相关的优化功能。在 Flink 写入 Paimon 的过程中，可能会因检查点（Checkpoint）提交失败等原因产生小文件，并在异常场景下形成孤儿文件。</p>
<p>为此，集团数据湖门户支持按“项目空间 + 表”粒度进行配置。我们将目标表纳入治理范围后，可通过定期执行或手动触发的方式开展：</p>
<ul>
<li>
<p>小文件合并/整理（文件压实、合并小文件）；</p>
</li>
<li>
<p>孤儿文件清理。</p>
</li>
</ul>
<p>上述治理动作能够进一步释放存储空间，同时通过周期性合并/整理作业减少 Paimon 表中的小文件数量，从而保障湖表的高效查询能力。</p>
<p><strong>3、查询优化：数据分区存储，分区裁剪</strong>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42a42155cdcb4df983a8c5750f3e8717~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768555885&amp;x-signature=QRwJkzUtvlSk23zzyltdQCBz7KY%3D" alt="5eecdaf48460cde5863c6321f93ae74c5aa4fad04a0ed84275b8339e1c4c2483a563e2d00e1f23a98d68742cd653602a8169d9d9ddf3b83f16aa4c685ccfbc71df04090c53a45f623be580359e3c0d25d70d64a9ebd6175696b3029a3d8d1d95.png" loading="lazy"/></p>
<p>在读取性能方面，我们从业务访问特征出发对数据进行了分区存储。以千亿级轨迹点查询场景为例，若缺少合理分区，从海量历史数据中定位一条轨迹可能需要触发全表扫描，导致 I/O 与 CPU 开销显著上升。</p>
<p>在轨迹业务中，分区设计会天然遇到“跨天”问题。例如，用户在当日 22:00 开始导航、次日 01:00 结束行程，则该行程对应的轨迹点/轨迹段会跨越多个日期分区。若仍按自然日期分区存储与写入，完整轨迹的查询与写入都会涉及多个分区。</p>
<p>为解决这一问题，我们在历史数据层做了一个关键设计：轨迹点聚合。具体而言，通过轨迹的唯一 ID，将同一条轨迹的多个点聚合为一条完整轨迹，并配合前文介绍的压缩算法，进一步降低存储成本。在分区策略上，我们以轨迹开始日期作为分区键，从而保证单条轨迹只落入一个分区，同时规避跨天写入与跨分区查询的问题。</p>
<p>在表模型设计上，Paimon 表以轨迹 ID作为主键。由于 Paimon 主键表支持 Upsert，我们可以利用其主键合并能力支持轨迹补全与数据修复等场景；同时，主键过滤条件也能够显著加速查询。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5515151d5ecd493491384995199d41fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768555885&amp;x-signature=D07Bb6HbR9iUtNEV3%2BqfZfYmwLQ%3D" alt="5eecdaf48460cde5863c6321f93ae74c5aa4fad04a0ed84275b8339e1c4c2483a563e2d00e1f23a98d68742cd653602a822951806323f8962d2cb5184a5287b612fc2d3a187a7e82ec946d2ed9b63d0762f4e7a3a510fce277db19ed0ef6801a.png" loading="lazy"/></p>
<p>此外，该表开启了 DV（Deletion Vector）相关能力：当 Reader 读取开启 DV 的表时，可自动跳过已标记删除的行，仅返回最新有效数据；同时，Manifest 的更新频次也会降低，综合带来 I/O 的进一步减少。配合 StarRocks 的 DV Native 实现（C++），整体执行效率相较 JNI 路径可获得显著提升（可达到 5 倍以上）。</p>
<p><strong>4、性能优化：调整参数</strong>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e2e0d8e663d4f38bfe4fab66fc960a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768555885&amp;x-signature=OgNHnzN6Rz0KAT3Ul2oMj0a9B2w%3D" alt="5eecdaf48460cde5863c6321f93ae74c5aa4fad04a0ed84275b8339e1c4c2483a563e2d00e1f23a98d68742cd653602a822951806323f896630a2d0c157f619aa6f1656cf8818d35aefc7676df1aca65924952ca63fb3b67ddfef48dcb089ed0.png" loading="lazy"/></p>
<p>我们也针对 Paimon 表做过一系列参数调优，以进一步优化点查场景下的读取效率与稳定性。</p>
<p>例如：将 file-block-size 从默认的 <strong>128MB</strong> 下调至 <strong>32MB</strong>。在轨迹历史数据体量大、以点查为主的场景下，更小的 block/row group 粒度有利于更精细的数据裁剪与下推：</p>
<ul>
<li>
<p>粒度更小意味着可以更准确地定位命中范围，从而在读取时跳过更多不相关的 row group；</p>
</li>
<li>
<p>有助于降低 I/O 放大（只读取命中的 group，而非扩大到整文件级别）；</p>
</li>
<li>
<p>更小的 group 也更利于多线程/多任务并行读取。</p>
</li>
</ul>
<p>我们也尝试过开启“使用线程池处理序列化”的相关参数。但由于该线程池默认大小通常为 CPU 核心数的 2 倍，在高 QPS 场景下反而容易形成排队与瓶颈。为此，我们将该参数设置为 <strong>false</strong>，使序列化由每条 SQL 在执行过程中自行完成。 此外，我们将 manifest 缓存大小从默认的 <strong>1GB</strong> 调整至 <strong>4GB</strong>，用于提升 manifest 命中率。高德轨迹查询存在一定比例的“访问更早历史数据”的特征，若 manifest 频繁过期并被淘汰。扩大缓存后，可覆盖更长时间范围的 manifest 元数据。</p>
<p><strong>5、稳定性调优：多实例隔离</strong>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1cfa7e46edad42d6899e958a03fe6624~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768555885&amp;x-signature=fkGvSo%2B3ggKiaafuxwECRsLAtqU%3D" alt="5eecdaf48460cde5863c6321f93ae74c5aa4fad04a0ed84275b8339e1c4c2483a563e2d00e1f23a98d68742cd653602a7a5c135778ee098c08ae8fbc26d88bc1199f49c74c0281f255a02aca63162d1e589b12df32ca37985a20d1c4d7c1fd9a.png" loading="lazy"/></p>
<p>最后一类需要重点解决的是稳定性与资源隔离问题。前文提到，轨迹数据既服务于 C 端在线业务，也支撑内部调查平台等内部工具，两类业务在 SLA 与查询特征上存在明显差异，若缺乏隔离机制，容易产生资源干扰。</p>
<p>以 C 端足迹类查询为例，其典型特征是点查或小范围扫描，对响应时延（RT）高度敏感；一旦出现超时或明显抖动，用户体验会直接受影响。</p>
<p>相比之下，内部调查平台的查询更多由内部同学按需触发，常见形态包括复杂 Join、更大范围扫描甚至全表扫描，单次查询可能带来 GB 级 I/O 开销。由于其主要用于分析与排查，该类场景对延迟具备更高容忍度。</p>
<p>为解决不同业务 SLA 带来的稳定性问题，我们将SR集群采用物理隔离的方式进行资源治理：将 C 端业务拆分为两个集群，同时将内部调查平台独立部署在一个规模相对较小的集群中。通过这种方式，不同场景之间在查询时候的资源竞争得到有效缓解，既避免了相互干扰，也更好地保障了 C 端业务的 SLA。</p>
<h2 data-id="heading-12">高德地图实时湖仓未来规划</h2>
<p>前文提到，我们所在部门是数据中台，承担高德实时与离线流量的统一入口职责。除轨迹数据外，平台还覆盖多种类型的业务数据。</p>
<p>本次在轨迹场景中实现了流批一体的落地验证，后续将进一步扩大业务范围：</p>
<ul>
<li>
<p>逐步将流批一体能力扩展到高德其他基础服务的日志类数据。</p>
</li>
<li>
<p>与下游 BI 团队及算法团队打通从数据生产、治理到消费的全链路协作。</p>
</li>
</ul>
<p>在此基础上，我们也计划围绕上述多源业务数据，对用户行为与偏好进行特征挖掘，并将相关能力进一步与 AI Agent 结合，形成面向业务的智能化赋能路径。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain 实战 | 快速搭建 Python 开发环境]]></title>    <link>https://juejin.cn/post/7593165280488194089</link>    <guid>https://juejin.cn/post/7593165280488194089</guid>    <pubDate>2026-01-09T09:33:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593165280488194089" data-draft-id="7580723992498110500" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain 实战 | 快速搭建 Python 开发环境"/> <meta itemprop="keywords" content="LangChain,LLM,Python"/> <meta itemprop="datePublished" content="2026-01-09T09:33:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="进击的松鼠"/> <meta itemprop="url" content="https://juejin.cn/user/2749193011073976"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain 实战 | 快速搭建 Python 开发环境
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2749193011073976/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    进击的松鼠
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T09:33:35.000Z" title="Fri Jan 09 2026 09:33:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">介绍 uv</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.astral.sh%2Fuv" target="_blank" title="https://docs.astral.sh/uv" ref="nofollow noopener noreferrer">uv</a> 是一个用 Rust 编写的 <strong>极快的 Python 包管理器和项目管理器。</strong></p>
<p>它整合了 Python 开发者常用的多种工具到一个 CLI 中，非常像 Node.js 生态里的 npm/pnpm。</p>
<ul>
<li>Rust 写的，<strong>速度比 pip 快 10～80 倍</strong></li>
<li>一个工具替代多个工具（pip、virtualenv、pip-tools、pyenv、poetry…）</li>
<li>和 Ruff 同一个团队，专业度高</li>
<li>配置统一在 <code>pyproject.toml</code></li>
<li>兼容 pip，不需要迁移成本</li>
</ul>
<p><strong>uv 命令速查表：</strong></p>





































<table><thead><tr><th>功能</th><th>命令</th></tr></thead><tbody><tr><td>创建虚拟环境</td><td><code>uv venv</code></td></tr><tr><td>使用虚拟环境运行脚本</td><td><code>uv run main.py</code></td></tr><tr><td>安装依赖</td><td><code>uv pip install fastapi</code></td></tr><tr><td>安装到项目（写入 pyproject）</td><td><code>uv add fastapi</code></td></tr><tr><td>安装 Python 版本</td><td><code>uv python install 3.12</code></td></tr><tr><td>运行工具</td><td><code>uv run uvicorn app:app</code></td></tr><tr><td>解析依赖锁定</td><td><code>uv pip compile</code></td></tr></tbody></table>
<h2 data-id="heading-1">安装 uv</h2>
<p>我们需要依据 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.astral.sh%2Fuv" target="_blank" title="https://docs.astral.sh/uv" ref="nofollow noopener noreferrer">uv 官网</a>给我们提供的安装方法将 uv 安装到计算机中。</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e67e9d3fc2d47e5ac00bc781b20644d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-b5Ye755qE5p2-6byg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768557817&amp;x-signature=NmESSR4T2Uorm2GLLfsDQx2tvY0%3D" alt="01-001.png" width="100%" loading="lazy"/>
<p><code>powershell -ExecutionPolicy ByPass -c "irm https://astral.sh/uv/install.ps1 | iex"</code></p>
<p>以 Windows 为例，将上述命令输入到终端后等待几秒就会安装完成。</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcc768d845334b3b97baca0712c47b4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-b5Ye755qE5p2-6byg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768557817&amp;x-signature=jVNA%2BfiFMZzXUSM1Rp43WmyM8aA%3D" alt="01-002.png" width="100%" loading="lazy"/>
<h4 data-id="heading-2">初始化环境</h4>
<p>学习 <code>langchain</code> 我们要创建一个 <code>Python</code> 项目环境。</p>
<p>首先，创建 <code>langchain</code> 项目目录 <code>learn-langchain</code>，在目录下的终端命令行输入 <code>uv init</code>。</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfb9d4344c6b4d109afe0a8e2ceed1d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-b5Ye755qE5p2-6byg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768557817&amp;x-signature=lh8JR1ZVlo0Eaj%2Btwag9wt48N3s%3D" alt="01-1.png" width="100%" loading="lazy"/>
<p>此时，<code>uv</code> 就会帮我们初始化开发环境，会生成如下初始文件：</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2dfc5164e144ee58d4af506f02432ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-b5Ye755qE5p2-6byg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768557817&amp;x-signature=JYU%2FeW8qP6t7BbRygrU3MBctW44%3D" alt="01-2.png" width="100%" loading="lazy"/>
<p>其中，<code>pyproject.toml</code> 是 Python 项目的“<strong>总配置中心 + 依赖声明入口</strong>”。</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-section">[project]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"learn-langchain"</span>
<span class="hljs-attr">version</span> = <span class="hljs-string">"0.1.0"</span>
<span class="hljs-attr">description</span> = <span class="hljs-string">"Add your description here"</span>
<span class="hljs-attr">readme</span> = <span class="hljs-string">"README.md"</span>
<span class="hljs-attr">requires-python</span> = <span class="hljs-string">"&gt;=3.13"</span>
<span class="hljs-attr">dependencies</span> = []
</code></pre>
<p>可以把它类比成前端项目中的 <code>package.json</code> 文件，下面我们详细解释这个文件中各个字段的含义。</p>
<ul>
<li><strong>[project]</strong> ：这是一个 Python 项目的元数据声明，uv 会从这里读取项目信息。</li>
<li><strong>name</strong>：项目的官方名称。</li>
<li><strong>version</strong>：项目版本号。</li>
<li><strong>description</strong>：项目的一句话描述。</li>
<li><strong>readme</strong>：指定项目的 README 文件。</li>
<li><strong>requires-python</strong>：声明项目能运行的 Python 版本范围。</li>
<li><strong>dependencies</strong>：项目的运行时依赖，后续安装的依赖都会存到这里。</li>
</ul>
<h2 data-id="heading-3">安装项目依赖</h2>
<p>首先，安装 langchain 核心依赖，在项目跟目录终端输入：</p>
<p><code>uv add langchain langchain-core langchain-classic langchain-community</code></p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8037e3bbab2465e8aa43b9ebe6c7452~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-b5Ye755qE5p2-6byg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768557817&amp;x-signature=MXsDQ9g0ZYbolQJv1OKAI2eb%2Bh4%3D" alt="01-3.png" width="100%" loading="lazy"/>
<p>此时，新的依赖会声明在 <code>pyproject.toml</code> 文件的 <code>dependencies</code> 中。</p>
<p>同时，在项目中会生成 <code>uv.lovk</code> 文件和 <code>.venv</code> 文件：</p>
<ul>
<li><strong>uv.lovk</strong>： uv 自动生成的<strong>依赖锁文件</strong>， 记录每个依赖的<strong>最终版本。</strong></li>
<li><strong>.venv</strong>： uv 为当前项目创建的 Python 虚拟环境目录，避免全局 Python 环境污染。</li>
</ul>
<h2 data-id="heading-4">激活虚拟环境</h2>
<p>如果是 Windows 系统，在项目终端命令行输入：</p>
<p><code>.venv\Scripts\activate</code></p>
<p>如果是 macOS / Linux 系统，在项目终端命令行输入：</p>
<p><code>source .venv/bin/activate</code></p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5203a55b9934d238fe64c700f5cfc1f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-b5Ye755qE5p2-6byg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768557817&amp;x-signature=EJc6mUuM%2FAxNLoIkPFY%2FFNrPGhc%3D" alt="01-4.png" width="100%" loading="lazy"/>
<p>虚拟环境激活后，会在终端命令行前端显示 <code>(learn-langchain)</code> 表示当前激活的 Python 虚拟环境名称。</p>
<h2 data-id="heading-5">创建项目示例</h2>
<h3 data-id="heading-6">安装依赖</h3>
<p>首先，安装必要的依赖，在项目跟目录终端输入：</p>
<p><code>uv add python-dotenv langchain-openai langchain-deepseek</code></p>
<ul>
<li><code>python-dotenv</code>是一个用于读取 <code>.env</code> 文件并将环境变量加载到 Python 运行时的工具。</li>
<li><code>langchain-openai</code> 提供对 <strong>OpenAI 官方模型</strong> 的接口封装。</li>
<li><code>langchain-deepseek</code> 提供对 <strong>DeepSeek 平台（OpenAI-compatible）的接口</strong> 封装。</li>
</ul>
<h3 data-id="heading-7">配置环境变量</h3>
<p>在项目根目录创建 <code>.env</code> 文件，输入如下内容：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">OPENAI_API_KEY</span>=sk-c97afa925b1745f79225c904dff53cba
<span class="hljs-attr">OPENAI_API_BASE</span>=https://api.deepseek.com/v1
</code></pre>
<p>在学习 <code>LangChain</code> 的前期阶段，我们暂时使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.deepseek.com" target="_blank" title="https://platform.deepseek.com" ref="nofollow noopener noreferrer">DeepSeek</a> 作为我们的大语言模型。</p>
<p>因为 DeepSeek <strong>兼容 OpenAI API 协议，</strong> 所以我们可以使用其 <code>API key</code> 赋值给 <code>OPENAI_API_KEY</code>。</p>
<p>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.deepseek.com%2Fapi_keys" target="_blank" title="https://platform.deepseek.com/api_keys" ref="nofollow noopener noreferrer">DeepSeek 开放平台</a>，创建 <code>API key</code> 保存起来，然后赋值给 <code>.env</code> 中的 <code>OPENAI_API_KEY</code>。</p>
<p>使用官网提供的兼容 OpenAI 的<code>base_url</code> 赋值给 <code>OPENAI_API_BASE</code>。</p>
<h3 data-id="heading-8">创建示例</h3>
<p>创建第一个示例，在项目根目录创建 <code>01-hello-world</code> 文件夹，在其文件夹内创建 <code>01-chat.py</code> 文件。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv

<span class="hljs-comment"># 加载环境变量</span>
load_dotenv()

<span class="hljs-comment"># 初始化聊天模型</span>
llm = ChatOpenAI(
    model=<span class="hljs-string">"deepseek-chat"</span>,
    temperature=<span class="hljs-number">0</span>,
)

<span class="hljs-comment"># 调用模型</span>
response = llm.invoke(<span class="hljs-string">"你是谁"</span>)

<span class="hljs-built_in">print</span>(response.content)
</code></pre>
<p><strong>上述代码的含义是：</strong></p>
<ol>
<li><strong>导入依赖</strong></li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv
</code></pre>
<ul>
<li><code>from langchain_openai import ChatOpenAI</code>
<ul>
<li>从 <strong>LangChain 的 OpenAI 适配器包</strong>里导入 <strong>ChatOpenAI</strong> 类</li>
<li>这个类封装了对 OpenAI 或兼容 API（DeepSeek）的对话模型调用</li>
<li>本质上是一个 <strong>LLM（Large Language Model）客户端</strong></li>
</ul>
</li>
<li><code>from dotenv import load_dotenv</code>
<ul>
<li>从 <code>python-dotenv </code>导入 <code>load_dotenv</code></li>
<li>用来加载 <code>.env</code> 文件中的环境变量到 Python 的 <code>os.environ</code></li>
</ul>
</li>
</ul>
<ol start="2">
<li><strong>加载环境变量</strong></li>
</ol>
<ul>
<li><code>load_dotenv()</code>
<ul>
<li>读取项目根目录下的 <code>.env</code> 文件</li>
<li>将其中的内容（例如 <code>OPENAI_API_KEY</code>、<code>OPENAI_API_BASE</code>）导入环境变量</li>
<li>这样 <code>ChatOpenAI</code> 就可以自动读取 Key 和 API Base，无需在代码中硬编码</li>
</ul>
</li>
</ul>
<ol start="3">
<li><strong>初始化 LLM</strong></li>
</ol>
<pre><code class="hljs language-python" lang="python">llm = ChatOpenAI(
    model=<span class="hljs-string">"deepseek-chat"</span>,
    temperature=<span class="hljs-number">0</span>,
)
</code></pre>
<ul>
<li>创建一个 <strong>ChatOpenAI 对象</strong>，用于发送消息给 LLM</li>
<li><code>model="deepseek-chat" </code>：
<ul>
<li>因为 DeepSeek 兼容 OpenAI API，这里可以直接指定 DeepSeek 提供的模型</li>
</ul>
</li>
<li><code>temperature=0</code>：
<ul>
<li>控制生成文本的随机性， 0 → <strong>最确定、最稳妥， 越大 → 输出越多样化</strong></li>
</ul>
</li>
</ul>
<ol start="4">
<li><strong>调用 LLM</strong></li>
</ol>
<ul>
<li><code>response = llm.invoke("你是谁")</code>
<ul>
<li><code>invoke()</code> 是 ChatOpenAI 的核心方法</li>
<li>输入参数 <code>"你是谁"</code> 是 <strong>prompt</strong>，告诉 LLM 你希望它做什么</li>
<li>返回值 <code>response</code> 是一个对象，通常包含：<code>response.content</code> → LLM 的文本输出</li>
</ul>
</li>
</ul>
<h2 data-id="heading-9">结语</h2>
<p><strong>最终</strong>，在终端命令行输入：<code>python .\01-hello-world\01-chat.py</code> 等待几秒就会在控制台打印内容。</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aef3c786bb9b49ecaf3f8c9edb074432~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-b5Ye755qE5p2-6byg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768557817&amp;x-signature=UQbmHSOHRpzCyMw16vyF0AI7n90%3D" alt="01-5.png" width="100%" loading="lazy"/>
<p>这说明，我们第一个 LangChain 示例运行成功，后续，我们将开始系统学习 LangChain 提供的强大的能力。</p>
<blockquote>
<p>此文章已同步至 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvaesonshu%2Flearn-langchan%2Fissues%2F1" target="_blank" title="https://github.com/vaesonshu/learn-langchan/issues/1" ref="nofollow noopener noreferrer">Github</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[高并发与分布式系统中的幂等处理]]></title>    <link>https://juejin.cn/post/7593139476840448006</link>    <guid>https://juejin.cn/post/7593139476840448006</guid>    <pubDate>2026-01-09T09:26:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593139476840448006" data-draft-id="7593139476840185862" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="高并发与分布式系统中的幂等处理"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2026-01-09T09:26:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="狼爷"/> <meta itemprop="url" content="https://juejin.cn/user/2418581314208279"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            高并发与分布式系统中的幂等处理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2418581314208279/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    狼爷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T09:26:34.000Z" title="Fri Jan 09 2026 09:26:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读23分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="srcery">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1c1b19;color:#fce8c3}.hljs-emphasis,.hljs-strong{color:#918175}.hljs-bullet,.hljs-link,.hljs-literal,.hljs-number,.hljs-quote,.hljs-regexp{color:#ff5c8f}.hljs-code,.hljs-selector-class{color:#68a8e4}.hljs-emphasis{font-style:italic}.hljs-attribute,.hljs-keyword,.hljs-section,.hljs-selector-tag,.hljs-variable{color:#ef2f27}.hljs-name,.hljs-title{color:#fbb829}.hljs-params,.hljs-type{color:#0aaeb3}.hljs-string{color:#98bc37}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-selector-attr,.hljs-selector-id,.hljs-selector-pseudo,.hljs-subst,.hljs-symbol,.hljs-template-tag,.hljs-template-variable{color:#c07abe}.hljs-comment,.hljs-deletion,.hljs-meta{color:#918175}</style><h2 data-id="heading-0">一、为什么高并发系统一定会“被幂等教育”？</h2>
<p>先说一句可能不太好听的大实话：</p>
<blockquote>
<p><strong>绝大多数高并发事故，不是代码写错，而是请求被执行了不止一次。</strong></p>
</blockquote>
<p>很多新手工程师在本地测试时，接口逻辑跑得顺风顺水，但一上生产环境，就容易栽在“重复请求”这个坑里。不是代码逻辑有问题，而是真实的线上环境，根本不存在“请求只来一次”的理想状态。</p>
<p>你一定会遇到这些无法避免的场景：</p>
<ul>
<li>
<p><strong>网络抖动</strong>：客户端发完请求后，因网络延迟没及时收到响应，误以为请求失败</p>
</li>
<li>
<p><strong>客户端重试</strong>：前端按钮重复点击、APP 离线重连后重试、第三方调用方配置了自动重试</p>
</li>
<li>
<p><strong>网关重发</strong>：API 网关因超时等原因，主动重发请求到后端服务</p>
</li>
<li>
<p><strong>MQ 至少一次投递</strong>：为保证消息不丢失，Kafka、RocketMQ 等消息中间件默认都是“至少一次”投递策略，消息必然可能重复</p>
</li>
</ul>
<p>用一段真实的交互场景，就能明白这种无奈：</p>
<pre><code class="hljs language-text" lang="text">客户端：我刚刚是不是没成功？（因网络延迟没收到响应）
系统：成功了。（其实已经处理完并返回，但响应丢了）
客户端：那我再来一次。（触发重试机制）
系统：？？？（我到底该再处理一次还是直接返回？）
</code></pre>
<p>结论先行，记死这句话：</p>
<blockquote>
<p><strong>在高并发 + 分布式系统中，请求“只来一次”是奢望，“重复请求”才是常态。</strong></p>
</blockquote>
<p>这就是为什么所有成熟的高并发系统，都必须过“幂等”这一关——不是你想做，而是环境逼着你必须做。</p>
<hr/>
<h2 data-id="heading-1">二、什么是幂等？（工程师版本，拒绝废话）</h2>
<p>别去背教科书上的抽象定义，记住这一句人话就够了：</p>
<blockquote>
<p><strong>同一个请求，不管来多少次，系统最终的状态和结果都完全一样。</strong></p>
</blockquote>
<p>举个简单的例子：查询接口（GET /api/order?orderNo=123）天生就是幂等的，不管你调用1次还是100次，返回的都是同一个订单信息；但下单接口（POST /api/order/create）如果不做处理，调用2次就会生成2个订单，这就是非幂等的。</p>
<h3 data-id="heading-2">不做幂等，会发生什么？（真实事故案例）</h3>
<p>很多人觉得“幂等是高级优化”，直到踩了坑才明白这是“基础必备”。非幂等接口在高并发下，必然会出现这些致命问题：</p>
<ul>
<li>
<p><strong>重复下单</strong>：用户点击“提交订单”后因网络卡顿时重复点击，生成多笔订单，导致库存被多扣、用户收到多个发货通知</p>
</li>
<li>
<p><strong>重复扣款</strong>：支付接口重试导致用户账户被多次扣款，直接引发用户投诉，甚至监管介入</p>
</li>
<li>
<p><strong>MQ 重复消费</strong>：消息重复投递后被重复处理，导致库存扣为负数、优惠券被重复核销</p>
</li>
<li>
<p><strong>重复退款</strong>：退款接口被重试，用户收到多笔退款，企业直接产生资金损失</p>
</li>
</ul>
<p>这里有个判断标准，记下来直接用：</p>
<blockquote>
<p><strong>只要“同一个请求多执行一次会出事”，这个接口就必须做幂等处理。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-3">三、哪些场景是幂等“重灾区”？（优先处理这些）</h2>
<p>不是所有接口都需要做幂等，我们要把精力放在高风险场景上。直接列重点，这些场景必须优先保证幂等：</p>
<ul>
<li>
<p><strong>交易相关接口</strong>：下单、支付、退款、转账——核心是涉及资金变动，一旦重复必然出问题</p>
</li>
<li>
<p><strong>创建型接口（POST）</strong>：POST 接口的语义是“创建资源”，重复调用会生成多个资源，而 GET 接口是“查询资源”，天生幂等（这里要注意：RESTful 规范中，POST 是非幂等的，PUT 是幂等的，设计接口时要遵循这个语义）</p>
</li>
<li>
<p><strong>MQ 消费逻辑</strong>：如前所述，MQ 默认“至少一次”投递，消费端必须能处理重复消息</p>
</li>
<li>
<p><strong>分布式事务场景</strong>：Saga 模式的补偿接口、TCC 模式的 Confirm/Cancel 接口，都可能因重试触发重复执行</p>
</li>
<li>
<p><strong>对外提供的接口</strong>：给合作方、第三方调用的接口，无法控制对方的重试策略，必须自己兜底幂等</p>
</li>
<li>
<p><strong>用户高频操作接口</strong>：如优惠券领取、活动报名、秒杀下单——用户可能因操作失误或网络问题重复触发</p>
</li>
</ul>
<p>用一句扎心的话总结：</p>
<blockquote>
<p><strong>你不主动做幂等，流量会帮你做事故。</strong></p>
</blockquote>
<p>很多团队的线上故障复盘，最后结论都是“某个接口未做幂等，导致高并发下重复执行”。与其事后救火，不如事前预防。</p>
<hr/>
<h2 data-id="heading-4">四、幂等的本质是什么？（看透问题核心）</h2>
<p>很多人在设计幂等方案时会陷入“各种技巧的堆砌”，其实只要抓住本质，所有方案都能看懂。</p>
<p>所有幂等方案，本质上都在解决同一个核心问题：</p>
<blockquote>
<p><strong>“我怎么判断这个请求是不是已经处理过了？”</strong></p>
</blockquote>
<p>只要能准确回答这个问题，幂等就解决了一半。从工程实践的角度看，解决这个问题无非三种核心思路：</p>
<ul>
<li>
<p><strong>给请求加“唯一标识”</strong>：通过一个全局唯一的 ID 标记请求，系统处理前先检查这个 ID 是否已经处理过——这是最常用的思路</p>
</li>
<li>
<p><strong>让状态“不可逆”</strong>：通过状态机约束，让业务状态只能从“未处理”向“已处理”流转，无法回退，从而避免重复处理——比如订单状态从“待支付”到“已支付”，再收到支付请求时就无法再次变更</p>
</li>
<li>
<p><strong>记录“去重日志”</strong>：专门维护一个去重表或缓存，记录已经处理过的请求，处理新请求时先查去重记录——本质是“唯一标识”思路的延伸</p>
</li>
</ul>
<p>理解了这三种思路，下面的实战方案就很容易看懂了——所有方案都是这三种思路的具体落地。</p>
<hr/>
<h2 data-id="heading-5">五、4 种主流幂等方案（Java 实战，附代码+注意事项）</h2>
<p>下面介绍的 4 种方案，覆盖了 90% 以上的业务场景。从“稳定性”“实现成本”“适用场景”三个维度对比，大家可以根据自己的业务选择。</p>
<h3 data-id="heading-6">1️⃣ 唯一业务 ID + 唯一索引（最稳、最推荐）⭐</h3>
<p>这是工业界最常用、最可靠的方案，核心是“用业务唯一 ID 标记请求，用数据库唯一索引兜底”，从根源上防止重复数据插入。</p>
<h4 data-id="heading-7">核心思路</h4>
<ol>
<li>
<p>客户端发起请求时，携带一个全局唯一的业务 ID（比如订单号 orderNo、业务流水号 bizId）——这个 ID 可以由客户端生成，也可以由服务端生成后返回给客户端</p>
</li>
<li>
<p>服务端处理请求时，将这个唯一业务 ID 存入业务表（比如订单表）</p>
</li>
<li>
<p>在业务表上给这个唯一业务 ID 加“唯一索引”，利用数据库的约束机制，防止重复插入数据</p>
</li>
<li>
<p>当重复请求到来时，数据库会抛出唯一约束冲突异常，服务端捕获异常后，直接返回“处理成功”（因为第一次请求已经处理完成）</p>
</li>
</ol>
<h4 data-id="heading-8">实战代码（Java + MySQL）</h4>
<p>第一步：给业务表加唯一索引（以订单表为例）</p>
<pre><code class="hljs language-sql" lang="sql">
<span class="hljs-comment">-- 订单表：order_no 是全局唯一的业务 ID</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> orders 
<span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> order_no <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'订单号（全局唯一）'</span>,
<span class="hljs-keyword">ADD</span> <span class="hljs-keyword">UNIQUE</span> KEY uk_order_no(order_no); <span class="hljs-comment">-- 唯一索引兜底</span>
</code></pre>
<p>第二步：Java 代码处理逻辑（结合 MyBatis）</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">/**
 * 下单接口（幂等版）
 * <span class="hljs-doctag">@param</span> createOrderDTO 下单请求DTO，包含唯一订单号 orderNo
 */</span>
<span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
<span class="hljs-keyword">public</span> OrderVO <span class="hljs-title function_">createOrder</span><span class="hljs-params">(CreateOrderDTO createOrderDTO)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">orderNo</span> <span class="hljs-operator">=</span> createOrderDTO.getOrderNo();
    <span class="hljs-keyword">if</span> (StringUtils.isBlank(orderNo)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BizException</span>(<span class="hljs-string">"订单号不能为空"</span>);
    }

    <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();
    order.setOrderNo(orderNo);
    order.setUserId(createOrderDTO.getUserId());
    order.setProductId(createOrderDTO.getProductId());
    order.setStatus(<span class="hljs-string">"CREATED"</span>); <span class="hljs-comment">// 初始状态：待支付</span>

    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 尝试插入订单</span>
        orderMapper.insert(order);
        <span class="hljs-comment">// 后续业务逻辑：扣减库存、锁定优惠券等</span>
        deductStock(createOrderDTO.getProductId(), createOrderDTO.getQuantity());
        lockCoupon(createOrderDTO.getUserId(), createOrderDTO.getCouponId());
        <span class="hljs-comment">// 返回成功结果</span>
        <span class="hljs-type">OrderVO</span> <span class="hljs-variable">orderVO</span> <span class="hljs-operator">=</span> convertToVO(order);
        <span class="hljs-keyword">return</span> orderVO;
    } <span class="hljs-keyword">catch</span> (DuplicateKeyException e) {
        <span class="hljs-comment">// 捕获唯一索引冲突异常，说明是重复请求</span>
        log.info(<span class="hljs-string">"重复下单，订单号：{}"</span>, orderNo, e);
        <span class="hljs-comment">// 直接查询已存在的订单，返回成功结果</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">existOrder</span> <span class="hljs-operator">=</span> orderMapper.selectByOrderNo(orderNo);
        <span class="hljs-keyword">return</span> convertToVO(existOrder);
    }
}
</code></pre>
<h4 data-id="heading-9">优点 &amp; 注意事项</h4>
<p>✅ 优点：</p>
<ul>
<li>
<p>实现简单，开发成本低</p>
</li>
<li>
<p>稳定性高，数据库唯一索引是“物理兜底”，不会出现漏判的情况</p>
</li>
<li>
<p>强一致性，能保证业务数据的准确性</p>
</li>
</ul>
<p>⚠️ 注意事项（关键！）：</p>
<blockquote>
<p><strong>唯一索引是最后一道防线，而不是第一道。</strong></p>
</blockquote>
<p>很多人会犯一个错误：每次请求都直接往数据库插数据，靠唯一索引挡重复请求。这样会导致数据库频繁抛出异常，增加数据库压力。</p>
<p>优化建议：在插入数据库之前，先查缓存（比如 Redis）判断订单号是否已存在——缓存命中则直接返回，未命中再执行插入逻辑。这样能减少数据库的异常抛出次数，提升性能。优化后的代码片段：</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">// 优化：先查缓存，减少数据库压力</span>
<span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"order:idempotent:"</span> + orderNo;
<span class="hljs-type">Boolean</span> <span class="hljs-variable">isExist</span> <span class="hljs-operator">=</span> redisTemplate.hasKey(redisKey);
<span class="hljs-keyword">if</span> (Boolean.TRUE.equals(isExist)) {
    <span class="hljs-type">Order</span> <span class="hljs-variable">existOrder</span> <span class="hljs-operator">=</span> orderMapper.selectByOrderNo(orderNo);
    <span class="hljs-keyword">return</span> convertToVO(existOrder);
}

<span class="hljs-keyword">try</span> {
    orderMapper.insert(order);
    <span class="hljs-comment">// 插入成功后，往缓存放一份，过期时间设置为业务合理时间（比如30分钟）</span>
    redisTemplate.opsForValue().set(redisKey, <span class="hljs-string">"1"</span>, <span class="hljs-number">30</span>, TimeUnit.MINUTES);
    <span class="hljs-comment">// 后续业务逻辑...</span>
} <span class="hljs-keyword">catch</span> (DuplicateKeyException e) {
    <span class="hljs-comment">// 重复请求处理...</span>
}
</code></pre>
<h3 data-id="heading-10">2️⃣ 状态机 + 乐观锁（订单系统标配）</h3>
<p>这个方案主要适用于“有明确状态流转”的业务场景，比如订单、支付、退款。核心是“通过状态机约束业务状态的流转，并用乐观锁保证并发安全”，避免重复处理。</p>
<h4 data-id="heading-11">核心思路</h4>
<ol>
<li>
<p>给业务实体定义清晰的状态机，比如订单状态：待支付（CREATED）→ 已支付（PAID）→ 已发货（SHIPPED）→ 已完成（COMPLETED）</p>
</li>
<li>
<p>状态只能“向前流转”，不能“向后流转”（比如已支付的订单，不能再回到待支付状态）</p>
</li>
<li>
<p>更新状态时，通过“乐观锁”（比如版本号 version 或状态字段本身）做条件判断，只有条件满足时才更新成功</p>
</li>
</ol>
<p>一句话理解：重复请求到来时，因为状态已经流转到下一个阶段，更新条件不满足，所以不会重复处理。</p>
<h4 data-id="heading-12">实战代码（Java + MySQL）</h4>
<p>第一步：订单表增加状态字段和版本号字段（乐观锁）</p>
<pre><code class="hljs language-sql" lang="sql">
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> orders 
<span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> status <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'订单状态：CREATED-待支付，PAID-已支付，SHIPPED-已发货，COMPLETED-已完成'</span>,
<span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> version <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'版本号（乐观锁）'</span>;
</code></pre>
<p>第二步：更新状态的 SQL（以“订单支付”为例）</p>
<pre><code class="hljs language-sql" lang="sql">
<span class="hljs-comment">-- 方式1：用状态作为条件（简单场景）</span>
<span class="hljs-keyword">UPDATE</span> orders 
<span class="hljs-keyword">SET</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span>, pay_time <span class="hljs-operator">=</span> NOW()
<span class="hljs-keyword">WHERE</span> order_no <span class="hljs-operator">=</span> ? <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'CREATED'</span>; <span class="hljs-comment">-- 只有状态是“待支付”时才能更新</span>

<span class="hljs-comment">-- 方式2：用版本号作为条件（并发更高的场景）</span>
<span class="hljs-keyword">UPDATE</span> orders 
<span class="hljs-keyword">SET</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span>, pay_time <span class="hljs-operator">=</span> NOW(), version <span class="hljs-operator">=</span> version <span class="hljs-operator">+</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">WHERE</span> order_no <span class="hljs-operator">=</span> ? <span class="hljs-keyword">AND</span> version <span class="hljs-operator">=</span> ?;
</code></pre>
<p>第三步：Java 代码处理逻辑</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">/**
 * 订单支付接口（幂等版）
 * <span class="hljs-doctag">@param</span> payDTO 支付请求DTO，包含订单号、支付金额等
 */</span>
<span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
<span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">payOrder</span><span class="hljs-params">(PayDTO payDTO)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">orderNo</span> <span class="hljs-operator">=</span> payDTO.getOrderNo();
    <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderMapper.selectByOrderNo(orderNo);
    <span class="hljs-keyword">if</span> (order == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BizException</span>(<span class="hljs-string">"订单不存在"</span>);
    }

    <span class="hljs-comment">// 方式1：用状态作为条件更新</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">updateCount</span> <span class="hljs-operator">=</span> orderMapper.updateOrderStatusToPaid(orderNo, <span class="hljs-string">"CREATED"</span>);
    <span class="hljs-keyword">if</span> (updateCount == <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// 更新失败，说明订单已支付或状态异常（重复请求）</span>
        log.info(<span class="hljs-string">"订单已支付或状态异常，订单号：{}"</span>, orderNo);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 重复请求，返回成功</span>
    }

    <span class="hljs-comment">// 方式2：用版本号作为条件更新（推荐高并发场景）</span>
    <span class="hljs-comment">// int updateCount = orderMapper.updateOrderStatusToPaidWithVersion(orderNo, order.getVersion());</span>
    <span class="hljs-comment">// if (updateCount == 0) {</span>
    <span class="hljs-comment">//     log.info("订单已支付或状态异常，订单号：{}", orderNo);</span>
    <span class="hljs-comment">//     return true;</span>
    <span class="hljs-comment">// }</span>

    <span class="hljs-comment">// 后续业务逻辑：扣减用户余额、记录支付日志等</span>
    deductUserBalance(payDTO.getUserId(), payDTO.getAmount());
    recordPayLog(payDTO);

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<h4 data-id="heading-13">优点 &amp; 适用场景</h4>
<p>✅ 优点：</p>
<ul>
<li>
<p>贴合业务场景，状态机本身就是业务逻辑的一部分，不需要额外引入过多概念</p>
</li>
<li>
<p>并发性能好，乐观锁不会阻塞线程，适合高并发场景</p>
</li>
<li>
<p>能防止“状态乱序”问题（比如同时收到“支付”和“取消”请求，保证只有一个能执行）</p>
</li>
</ul>
<p>📌 适用场景：</p>
<ul>
<li>
<p>订单状态流转（支付、发货、取消）</p>
</li>
<li>
<p>退款流程（申请退款 → 退款中 → 退款成功/失败）</p>
</li>
<li>
<p>任何有明确状态流转的业务实体</p>
</li>
</ul>
<p>核心原则：</p>
<blockquote>
<p><strong>状态只往前走，本身就是幂等。</strong></p>
</blockquote>
<h3 data-id="heading-14">3️⃣ Token / Redis 去重（防重复提交首选）</h3>
<p>这个方案主要用于“用户交互型接口”，比如表单提交、按钮点击、秒杀下单。核心是“在请求执行前，先获取一个唯一 Token，执行时校验 Token 有效性”，从而防止重复提交。</p>
<h4 data-id="heading-15">核心流程</h4>
<ol>
<li>
<p>客户端先向服务端请求“获取 Token”（比如用户进入下单页面时，前端调用接口获取 Token）</p>
</li>
<li>
<p>服务端生成一个全局唯一的 Token（比如用 UUID），存入 Redis（设置过期时间），然后返回给客户端</p>
</li>
<li>
<p>客户端发起业务请求时，将 Token 放在请求头或请求参数中一起提交</p>
</li>
<li>
<p>服务端收到请求后，先校验 Token：如果 Redis 中存在该 Token，则删除 Token 并执行后续业务逻辑；如果不存在，则说明是重复请求，直接返回错误</p>
</li>
</ol>
<p>流程示意图：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">
sequenceDiagram
    Client-&gt;&gt;Server: 进入下单页面，请求获取Token
    Server-&gt;&gt;Server: 生成UUID作为Token，存入Redis（设置过期时间）
    Server-&gt;&gt;Client: 返回Token
    Client-&gt;&gt;Server: 提交订单（携带Token）
    Server-&gt;&gt;Server: 校验Redis中是否存在该Token，存在则删除
    Server-&gt;&gt;Server: 执行下单逻辑
    Server-&gt;&gt;Client: 返回下单结果
    Client-&gt;&gt;Server: 重复提交订单（携带相同Token）
    Server-&gt;&gt;Server: 校验Redis中已无该Token
    Server-&gt;&gt;Client: 返回“重复提交”错误
</code></pre>
<h4 data-id="heading-16">实战代码（Java + Redis）</h4>
<p>第一步：获取 Token 接口</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">/**
 * 获取防重复提交Token
 */</span>
<span class="hljs-meta">@GetMapping("/api/idempotent/token")</span>
<span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">getIdempotentToken</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 生成唯一Token（UUID）</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString().replace(<span class="hljs-string">"-"</span>, <span class="hljs-string">""</span>);
    <span class="hljs-comment">// 存入Redis，设置过期时间5分钟（根据业务调整，比如表单提交设置10分钟）</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"idempotent:token:"</span> + token;
    redisTemplate.opsForValue().set(redisKey, <span class="hljs-string">"1"</span>, <span class="hljs-number">5</span>, TimeUnit.MINUTES);
    <span class="hljs-keyword">return</span> Result.success(token);
}
</code></pre>
<p>第二步：业务接口（结合 Spring AOP 实现更优雅）</p>
<p>先定义一个自定义注解，用于标记需要防重复提交的接口：</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">/**
 * 防重复提交注解
 */</span>
<span class="hljs-meta">@Target(ElementType.METHOD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Idempotent {
    <span class="hljs-comment">// Token参数的名称（默认从请求头获取）</span>
    String <span class="hljs-title function_">tokenName</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">"Idempotent-Token"</span>;
}

<span class="hljs-comment">// AOP切面实现</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IdempotentAspect</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;

    <span class="hljs-meta">@Around("@annotation(idempotent)")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">around</span><span class="hljs-params">(ProceedingJoinPoint joinPoint, Idempotent idempotent)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-comment">// 1. 获取请求中的Token</span>
        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();
        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeader(idempotent.tokenName());
        <span class="hljs-keyword">if</span> (StringUtils.isBlank(token)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BizException</span>(<span class="hljs-string">"Token不能为空"</span>);
        }

        <span class="hljs-comment">// 2. 校验Token是否存在于Redis</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"idempotent:token:"</span> + token;
        <span class="hljs-type">Boolean</span> <span class="hljs-variable">isExist</span> <span class="hljs-operator">=</span> redisTemplate.hasKey(redisKey);
        <span class="hljs-keyword">if</span> (Boolean.FALSE.equals(isExist)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BizException</span>(<span class="hljs-string">"重复提交，请稍后再试"</span>);
        }

        <span class="hljs-comment">// 3. 原子性删除Token（防止并发问题）</span>
        <span class="hljs-type">Boolean</span> <span class="hljs-variable">deleteSuccess</span> <span class="hljs-operator">=</span> redisTemplate.delete(redisKey);
        <span class="hljs-keyword">if</span> (Boolean.FALSE.equals(deleteSuccess)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BizException</span>(<span class="hljs-string">"重复提交，请稍后再试"</span>);
        }

        <span class="hljs-comment">// 4. 执行原业务逻辑</span>
        <span class="hljs-keyword">return</span> joinPoint.proceed();
    }
}
</code></pre>
<p>第三步：使用注解标记业务接口</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">/**
 * 表单提交接口（防重复提交）
 */</span>
<span class="hljs-meta">@PostMapping("/api/form/submit")</span>
<span class="hljs-meta">@Idempotent(tokenName = "Idempotent-Token")</span>
<span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">submitForm</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> FormDTO formDTO)</span> {
    <span class="hljs-comment">// 执行表单提交逻辑</span>
    formService.submit(formDTO);
    <span class="hljs-keyword">return</span> Result.success(<span class="hljs-string">"提交成功"</span>);
}
</code></pre>
<h4 data-id="heading-17">优点 &amp; 注意事项</h4>
<p>✅ 优点：</p>
<ul>
<li>
<p>实现优雅，通过 AOP 可以全局复用，开发成本低</p>
</li>
<li>
<p>性能好，基于 Redis 操作，响应速度快</p>
</li>
<li>
<p>适合前端交互场景，能有效防止用户重复点击</p>
</li>
</ul>
<p>⚠️ 注意事项：</p>
<ul>
<li>
<p>不适合核心交易链路：Redis 是缓存，存在宕机或数据丢失的风险，无法像数据库那样提供强一致性保证</p>
</li>
<li>
<p>Token 过期时间要合理：太短会导致正常请求失败，太长会占用 Redis 资源</p>
</li>
<li>
<p>必须保证“删除 Token”是原子操作：如果用“先查后删”的方式，会出现并发问题（两个请求同时查到 Token 存在，然后都执行删除，导致重复处理）</p>
</li>
</ul>
<p>核心结论：这个方案适合“非核心链路的防重复提交”，比如表单提交、评论发布、活动报名等；核心交易链路（下单、支付）不推荐单独使用，建议结合方案一（唯一索引）兜底。</p>
<h3 data-id="heading-18">4️⃣ MQ 消费幂等（面试必考，必须掌握）</h3>
<p>MQ 消费的幂等是高并发系统中的高频问题，因为所有 MQ 中间件都无法保证“恰好一次”投递（除非用事务消息，但复杂度高），默认都是“至少一次”投递。所以，消费端必须自己处理重复消息。</p>
<h4 data-id="heading-19">核心思路</h4>
<p>MQ 消息本身会携带一个全局唯一的消息 ID（比如 RocketMQ 的 msgId、Kafka 的 offset + partition），我们可以利用这个消息 ID 做去重；如果消息 ID 不可靠（比如有些 MQ 会重复生成 msgId），则可以用业务唯一 ID（比如订单号）做去重。</p>
<p>核心流程：</p>
<ol>
<li>
<p>消费消息前，先检查该消息的 ID（msgId 或 bizId）是否已经处理过</p>
</li>
<li>
<p>如果已经处理过，则直接返回成功，不执行后续逻辑</p>
</li>
<li>
<p>如果未处理过，则执行消费逻辑，执行完成后，记录该消息 ID 已处理</p>
</li>
</ol>
<p>一句话点破：</p>
<blockquote>
<p><strong>MQ 一定会重复，业务必须能扛住。</strong></p>
</blockquote>
<h4 data-id="heading-20">实战代码（Java + RocketMQ）</h4>
<p>这里提供两种实现方式：基于 Redis 去重（适合非核心消息）和基于数据库去重表（适合核心消息）。</p>
<p>方式一：基于 Redis 去重（简单场景）</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">/**
 * MQ 消费者（基于Redis去重）
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@RocketMQMessageListener(topic = "order_topic", consumerGroup = "order_consumer_group")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderConsumer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RocketMQListener</span>&lt;MessageExt&gt; {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderService orderService;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(MessageExt messageExt)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">msgId</span> <span class="hljs-operator">=</span> messageExt.getMsgId(); <span class="hljs-comment">// MQ自带的唯一消息ID</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(messageExt.getBody(), StandardCharsets.UTF_8);
        <span class="hljs-type">OrderMessage</span> <span class="hljs-variable">orderMessage</span> <span class="hljs-operator">=</span> JSON.parseObject(body, OrderMessage.class);
        <span class="hljs-type">String</span> <span class="hljs-variable">bizId</span> <span class="hljs-operator">=</span> orderMessage.getOrderNo(); <span class="hljs-comment">// 业务唯一ID（订单号）</span>

        <span class="hljs-comment">// 1. 先查Redis，判断是否已处理（用bizId更可靠，msgId可能重复）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"mq:idempotent:order:"</span> + bizId;
        <span class="hljs-type">Boolean</span> <span class="hljs-variable">isProcessed</span> <span class="hljs-operator">=</span> redisTemplate.hasKey(redisKey);
        <span class="hljs-keyword">if</span> (Boolean.TRUE.equals(isProcessed)) {
            log.info(<span class="hljs-string">"消息已处理，msgId：{}，bizId：{}"</span>, msgId, bizId);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 2. 执行消费逻辑（比如更新订单状态）</span>
            orderService.processOrderMessage(orderMessage);

            <span class="hljs-comment">// 3. 标记为已处理（存入Redis，设置过期时间，比如24小时）</span>
            redisTemplate.opsForValue().set(redisKey, <span class="hljs-string">"1"</span>, <span class="hljs-number">24</span>, TimeUnit.HOURS);
            log.info(<span class="hljs-string">"消息处理成功，msgId：{}，bizId：{}"</span>, msgId, bizId);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"消息处理失败，msgId：{}，bizId：{}"</span>, msgId, bizId, e);
            <span class="hljs-comment">// 抛出异常，让MQ重试（根据业务调整重试策略）</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"消息处理失败，触发重试"</span>, e);
        }
    }
}
</code></pre>
<p>方式二：基于数据库去重表（核心消息，强一致）</p>
<p>第一步：创建 MQ 消息去重表</p>
<pre><code class="hljs language-sql" lang="sql">
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> mq_message_idempotent (
    id <span class="hljs-type">BIGINT</span> AUTO_INCREMENT <span class="hljs-keyword">PRIMARY</span> KEY COMMENT <span class="hljs-string">'主键ID'</span>,
    msg_id <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'MQ消息ID'</span>,
    biz_id <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'业务唯一ID'</span>,
    status TINYINT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'处理状态：0-未处理，1-已处理'</span>,
    create_time DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">'创建时间'</span>,
    update_time DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">'更新时间'</span>,
    <span class="hljs-keyword">UNIQUE</span> KEY uk_biz_id (biz_id) COMMENT <span class="hljs-string">'业务ID唯一约束'</span>
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT <span class="hljs-string">'MQ消息幂等表'</span>;
</code></pre>
<p>第二步：消费逻辑代码</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">/**
 * MQ 消费者（基于数据库去重表）
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@RocketMQMessageListener(topic = "payment_topic", consumerGroup = "payment_consumer_group")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentConsumer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RocketMQListener</span>&lt;MessageExt&gt; {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> MqMessageIdempotentMapper idempotentMapper;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> PaymentService paymentService;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(MessageExt messageExt)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">msgId</span> <span class="hljs-operator">=</span> messageExt.getMsgId();
        <span class="hljs-type">String</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(messageExt.getBody(), StandardCharsets.UTF_8);
        <span class="hljs-type">PaymentMessage</span> <span class="hljs-variable">paymentMessage</span> <span class="hljs-operator">=</span> JSON.parseObject(body, PaymentMessage.class);
        <span class="hljs-type">String</span> <span class="hljs-variable">bizId</span> <span class="hljs-operator">=</span> paymentMessage.getPayNo(); <span class="hljs-comment">// 支付流水号（业务唯一ID）</span>

        <span class="hljs-comment">// 1. 尝试插入去重表（唯一约束兜底）</span>
        <span class="hljs-type">MqMessageIdempotent</span> <span class="hljs-variable">idempotent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MqMessageIdempotent</span>();
        idempotent.setMsgId(msgId);
        idempotent.setBizId(bizId);
        idempotent.setStatus(<span class="hljs-number">0</span>); <span class="hljs-comment">// 未处理</span>

        <span class="hljs-keyword">try</span> {
            idempotentMapper.insert(idempotent);
        } <span class="hljs-keyword">catch</span> (DuplicateKeyException e) {
            <span class="hljs-comment">// 重复消息，查询处理状态</span>
            <span class="hljs-type">MqMessageIdempotent</span> <span class="hljs-variable">exist</span> <span class="hljs-operator">=</span> idempotentMapper.selectByBizId(bizId);
            <span class="hljs-keyword">if</span> (exist.getStatus() == <span class="hljs-number">1</span>) {
                log.info(<span class="hljs-string">"消息已处理，msgId：{}，bizId：{}"</span>, msgId, bizId);
                <span class="hljs-keyword">return</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 消息正在处理中，抛出异常让MQ重试（或根据业务处理）</span>
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"消息处理中，请稍后重试"</span>);
            }
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 2. 执行消费逻辑（比如处理支付结果）</span>
            paymentService.processPaymentResult(paymentMessage);

            <span class="hljs-comment">// 3. 更新去重表状态为“已处理”</span>
            idempotentMapper.updateStatusByBizId(bizId, <span class="hljs-number">1</span>);
            log.info(<span class="hljs-string">"消息处理成功，msgId：{}，bizId：{}"</span>, msgId, bizId);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"消息处理失败，msgId：{}，bizId：{}"</span>, msgId, bizId, e);
            <span class="hljs-comment">// 可以更新状态为“处理失败”，后续人工介入</span>
            idempotentMapper.updateStatusByBizId(bizId, <span class="hljs-number">2</span>);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"消息处理失败，触发重试"</span>, e);
        }
    }
}
</code></pre>
<h4 data-id="heading-21">优点 &amp; 适用场景</h4>
<p>✅ 优点：</p>
<ul>
<li>
<p>可靠性高，尤其是基于数据库去重表的方式，能保证强一致性</p>
</li>
<li>
<p>适配所有 MQ 场景，通用性强</p>
</li>
</ul>
<p>📌 适用场景：</p>
<ul>
<li>
<p>基于 Redis ：非核心消息，比如日志同步、通知推送、数据统计</p>
</li>
<li>
<p>基于数据库：核心消息，比如订单支付结果通知、库存变更消息、退款消息</p>
</li>
</ul>
<p>面试小贴士：被问到“MQ 消费如何保证幂等”时，要先说明“MQ 无法避免重复投递”，然后分场景给出方案，最后强调“核心消息必须用数据库去重表兜底”，这样回答才够全面。</p>
<hr/>
<h2 data-id="heading-22">六、3 个最容易踩的幂等大坑（避坑指南）</h2>
<p>很多人做了幂等处理，但还是出了问题，原因是踩了一些“隐性坑”。下面这 3 个坑，一定要避开：</p>
<h3 data-id="heading-23">❌ 1. 先查再插/先查再更（高并发下必炸）</h3>
<p>这是最常见的错误做法：处理请求时，先查询数据库“这个请求是否已处理”，如果没处理再执行插入/更新操作。代码示例：</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">// 错误代码：先查再插</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(CreateOrderDTO dto)</span> {
    <span class="hljs-comment">// 先查询订单是否存在</span>
    <span class="hljs-type">Order</span> <span class="hljs-variable">existOrder</span> <span class="hljs-operator">=</span> orderMapper.selectByOrderNo(dto.getOrderNo());
    <span class="hljs-keyword">if</span> (existOrder != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-comment">// 插入订单</span>
    <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();
    order.setOrderNo(dto.getOrderNo());
    orderMapper.insert(order);
}
</code></pre>
<p>问题出在“查询”和“插入”之间存在“时间窗口”：高并发下，两个相同的请求可能同时查询到“订单不存在”，然后同时插入订单，导致唯一索引冲突，或者直接生成两个订单（如果没加唯一索引）。</p>
<p>正确做法：</p>
<blockquote>
<p><strong>直接插/直接更，交给唯一约束或乐观锁兜底。</strong></p>
</blockquote>
<p>比如方案一中的“直接插入，捕获唯一索引冲突”，方案二中的“直接更新，判断影响行数”——用数据库的原子操作代替“先查后写”，避免并发问题。</p>
<h3 data-id="heading-24">❌ 2. 幂等逻辑不在事务里（数据灵异）</h3>
<p>这个坑的场景：标记“请求已处理”的操作，和核心业务逻辑不在同一个事务里。比如：</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">// 错误代码：幂等标记不在事务中</span>
<span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processOrder</span><span class="hljs-params">(OrderMessage message)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">bizId</span> <span class="hljs-operator">=</span> message.getOrderNo();
    <span class="hljs-comment">// 1. 执行核心业务逻辑（更新订单状态）</span>
    orderMapper.updateStatus(bizId, <span class="hljs-string">"PAID"</span>);
    <span class="hljs-comment">// 2. 标记为已处理（存入Redis，不在事务中）</span>
    redisTemplate.opsForValue().set(<span class="hljs-string">"order:processed:"</span> + bizId, <span class="hljs-string">"1"</span>, <span class="hljs-number">24</span>, TimeUnit.HOURS);
}
</code></pre>
<p>问题：如果步骤 1 执行成功，但步骤 2 执行失败（比如 Redis 宕机），此时事务会回滚吗？不会！因为步骤 2 是 Redis 操作，不在数据库事务的管辖范围内。最终结果是：订单状态已经更新为“已支付”，但 Redis 中没有标记“已处理”——当下次重复消息到来时，会再次执行步骤 1，导致订单状态被重复更新（虽然状态机可能阻止，但如果是其他业务可能出问题）。</p>
<p>更严重的情况：如果步骤 2 先执行（标记已处理），步骤 1 执行失败（事务回滚），会导致“标记已处理，但业务没执行”——后续请求都会被当成重复请求，直接返回，导致业务丢失。</p>
<p>正确做法：</p>
<ul>
<li>
<p>如果用数据库去重（比如方案一、方案四的数据库去重表），一定要把“标记已处理”和核心业务逻辑放在同一个事务里——用数据库事务保证两者的原子性</p>
</li>
<li>
<p>如果用 Redis 去重，要采用“先执行业务，再标记已处理”的顺序，并且接受“极端情况下可能重复处理”的风险（因为 Redis 不支持事务回滚）；如果是核心业务，建议用数据库去重表兜底</p>
</li>
</ul>
<h3 data-id="heading-25">❌ 3. 幂等 = 吞异常（掩盖问题）</h3>
<p>这个坑的错误认知：“只要是重复请求，不管什么情况都返回成功”——把幂等当成了“吞异常”的遮羞布。比如：</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">// 错误代码：幂等 = 吞异常</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(CreateOrderDTO dto)</span> {
    <span class="hljs-keyword">try</span> {
        orderMapper.insert(dto);
    } <span class="hljs-keyword">catch</span> (Exception e) {
        <span class="hljs-comment">// 不管什么异常，都当成重复请求返回成功</span>
        log.error(<span class="hljs-string">"创建订单失败"</span>, e);
        <span class="hljs-keyword">return</span>;
    }
}
</code></pre>
<p>问题：如果是真正的业务异常（比如库存不足、参数错误），也会被当成重复请求，直接返回成功——用户以为订单创建成功，但实际上并没有，导致用户投诉；同时，开发人员无法及时发现业务问题，因为异常被吞掉了。</p>
<p>正确做法：</p>
<blockquote>
<p><strong>幂等只处理“重复请求”的异常，不处理“业务逻辑”的异常。</strong></p>
</blockquote>
<p>比如方案一中，只捕获“DuplicateKeyException”（唯一索引冲突，代表重复请求），其他异常（比如库存不足的 BizException）要正常抛出，让上层处理（比如返回错误信息给用户）。</p>
<p>核心原则：幂等是“保证重复请求的结果一致”，而不是“掩盖所有异常”。</p>
<hr/>
<h2 data-id="heading-26">七、幂等与分布式事务（相辅相成）</h2>
<p>很多人会把“幂等”和“分布式事务”分开看，但实际上，两者是相辅相成的——没有幂等，分布式事务就跑不起来。</p>
<p>为什么？因为分布式事务的核心是“跨服务的协调”，而协调过程中必然会出现重试（比如 Saga 模式的补偿重试、TCC 模式的 Confirm/Cancel 重试）。如果这些重试的接口没有做幂等，就会导致重复处理，引发数据不一致。</p>
<p>下面是常见分布式事务场景中，幂等的作用：</p>





















<table><thead><tr><th>分布式事务场景</th><th>幂等的作用</th></tr></thead><tbody><tr><td>Saga 模式</td><td>Saga 分为“正向流程”和“补偿流程”，当正向流程某一步失败时，会重试补偿流程；如果补偿接口没有做幂等，多次补偿会导致数据错误（比如重复退款）</td></tr><tr><td>TCC 模式</td><td>TCC 的 Confirm（确认）和 Cancel（取消）接口可能因网络问题被重试；如果这些接口没有做幂等，会导致重复扣减/释放资源（比如重复扣库存）</td></tr><tr><td>MQ 事务消息</td><td>事务消息的“提交”或“回滚”可能被重试，消费端也会收到重复消息；幂等能保证重试和重复消息不会导致数据不一致</td></tr></tbody></table>
<p>一句话总结：</p>
<blockquote>
<p><strong>没有幂等，分布式事务跑不起来；有了幂等，分布式事务才能更稳定。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-27">八、推荐的 Java 技术组合（落地参考）</h2>
<p>结合前面的方案，这里给出一套工业界常用的 Java 技术组合，覆盖大部分业务场景：</p>
<ul>
<li>
<p><strong>核心框架</strong>：Spring Boot / Spring Cloud（成熟稳定，生态完善）</p>
</li>
<li>
<p><strong>数据存储</strong>：MySQL（唯一索引 + 状态机 + 去重表，保证强一致性）</p>
</li>
<li>
<p><strong>缓存</strong>：Redis（Token 防重复提交 + 非核心消息去重，提升性能）</p>
</li>
<li>
<p><strong>消息中间件</strong>：RocketMQ / Kafka（支持事务消息，适配高并发场景）</p>
</li>
<li>
<p><strong>ORM 框架</strong>：MyBatis-Plus（简化数据库操作，支持乐观锁插件）</p>
</li>
</ul>
<p>经验总结，记下来直接用：</p>
<blockquote>
<p><strong>核心链路靠 DB，外围防抖用 Redis。</strong></p>
</blockquote>
<ul>
<li>
<p>核心链路（下单、支付、退款）：用“唯一业务 ID + 唯一索引”兜底，结合“状态机 + 乐观锁”优化并发性能</p>
</li>
<li>
<p>外围链路（表单提交、通知推送、活动报名）：用“Token + Redis”防重复提交，简单高效</p>
</li>
<li>
<p>MQ 消费：核心消息用“数据库去重表”，非核心消息用“Redis 去重”</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-28">九、总结（核心观点再强调）</h2>
<p>最后用几句话总结全文，帮大家梳理核心知识点：</p>
<ol>
<li>
<p>幂等不是高级技巧，而是分布式高并发系统的“入场券”——你可以暂时没遇到幂等问题，但高并发一定会帮你遇到</p>
</li>
<li>
<p>幂等的本质是“判断请求是否已处理”，核心思路是“唯一标识、状态不可逆、去重记录”</p>
</li>
<li>
<p>4 种主流方案各有适用场景：唯一索引最稳，状态机适合订单，Token 适合表单，MQ 去重分核心/非核心</p>
</li>
<li>
<p>避坑重点：别用“先查后写”，幂等逻辑要在事务里，别把幂等当成吞异常的遮羞布</p>
</li>
<li>
<p>技术组合原则：核心链路靠 DB 保证强一致，外围链路用 Redis 提升性能</p>
</li>
</ol>
<p>最后再送大家一句实战感悟：</p>
<blockquote>
<p><strong>做幂等不是为了“解决问题”，而是为了“避免问题”——在高并发的世界里，预防永远比救火更重要。</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【LangChain学习笔记】Message]]></title>    <link>https://juejin.cn/post/7593158683411398656</link>    <guid>https://juejin.cn/post/7593158683411398656</guid>    <pubDate>2026-01-09T09:44:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593158683411398656" data-draft-id="7593187953271226368" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【LangChain学习笔记】Message"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-09T09:44:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用泥种荷花"/> <meta itemprop="url" content="https://juejin.cn/user/4212984289442030"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【LangChain学习笔记】Message
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984289442030/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用泥种荷花
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T09:44:35.000Z" title="Fri Jan 09 2026 09:44:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">核心定义：Message 是什么？</h2>
<p><code>Message</code>（消息）是 <code>LangChain</code> 中封装用户输入、大模型输出、系统指令等交互信息的标准化数据结构，是大模型与外部组件（提示模板、记忆组件、智能体等）间数据传递的核心载体。</p>
<p>通俗理解：<code>Message</code> 就像“交互对话的标准化信封”，用户问题、系统规则、模型回答均需封装为该格式，才能在 LangChain 生态组件间顺畅流转。</p>
<p>核心作用：统一交互数据格式，保障不同组件（如记忆组件存储对话、提示模板拼接上下文）能正确识别处理对话信息。</p>
<h2 data-id="heading-1">核心 Message 类型及用途</h2>
<p>LangChain 定义了多种 Message 类型适配不同交互场景，均继承自 <code>BaseMessage</code> 类，具备 <code>content</code>（消息内容）、<code>role</code>（角色标识）等统一基础属性，各类型详情如下：</p>
<h3 data-id="heading-2">HumanMessage：用户消息</h3>
<p>• 用途：封装用户问题、指令、需求等输入内容；</p>
<p>• 核心属性：</p>
<ul>
<li><code>content: str</code>：核心输入内容（必填）；</li>
<li><code>role: str</code>：固定为 <code>"user"</code>，标识用户角色；</li>
<li><code>additional_kwargs: dict</code>（可选）：存储用户ID、时间戳等元数据。</li>
</ul>
<p>• 示例代码：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> HumanMessage

<span class="hljs-comment"># 初始化用户消息</span>
human_msg = HumanMessage(content=<span class="hljs-string">"请解释什么是 LangChain Message？"</span>)
<span class="hljs-built_in">print</span>(human_msg)
<span class="hljs-comment"># 输出：HumanMessage(content='请解释什么是 LangChain Message？', role='user')</span>
</code></pre>
<h3 data-id="heading-3">AIMessage：大模型消息</h3>
<p>• 用途：封装大模型的回答、推理过程或工具调用指令；</p>
<p>• 核心属性：</p>
<ul>
<li><code>content: str</code>：模型输出内容（必填，工具调用场景可空）；</li>
<li><code>role: str</code>：固定为 <code>"assistant"</code>，标识模型角色；</li>
<li><code>additional_kwargs: dict</code>（可选）：工具调用场景含<code>tool_calls</code> 字段，存储工具参数与调用ID；</li>
<li><code>tool_calls: List[Dict]</code>（可选）：工具调用信息列表，与 <code>additional_kwargs["tool_calls"]</code> 等效。</li>
</ul>
<p>• 示例代码：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> AIMessage

<span class="hljs-comment"># 初始化大模型消息</span>
ai_msg = AIMessage(content=<span class="hljs-string">"LangChain Message 是标准化的交互数据结构，用于封装对话信息..."</span>)
<span class="hljs-built_in">print</span>(ai_msg)
<span class="hljs-comment"># 输出：AIMessage(content='LangChain Message 是标准化的交互数据结构，用于封装对话信息...', role='assistant')</span>
</code></pre>
<h3 data-id="heading-4">SystemMessage：系统消息</h3>
<p>• 用途：封装系统级指令（定义模型角色、行为规则等），仅对模型生效，用户不可见；</p>
<p>• 核心作用：引导模型按规则响应（如“专业Python开发助手”“回答不超过3句话”）；</p>
<p>• 核心属性：</p>
<ul>
<li><code>content: str</code>：系统指令内容（必填）；</li>
<li><code>role: str</code>：固定为<code>"system"</code>，标识系统角色；</li>
<li><code>additional_kwargs: dict</code>（可选）：存储指令优先级、生效范围等元数据。</li>
</ul>
<p>• 示例代码：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> SystemMessage

<span class="hljs-comment"># 初始化系统消息</span>
system_msg = SystemMessage(content=<span class="hljs-string">"你是专业的LangChain技术助手，回答需准确、简洁，基于官方文档内容。"</span>)
<span class="hljs-built_in">print</span>(system_msg)
<span class="hljs-comment"># 输出：SystemMessage(content='你是专业的LangChain技术助手，回答需准确、简洁，基于官方文档内容。', role='system')</span>
</code></pre>
<h3 data-id="heading-5">ToolMessage：工具消息</h3>
<p>• 用途：封装数据库查询、API返回、文件读取等工具调用结果；</p>
<p>• 适用场景：智能体调用工具后，结果需封装为该类型回传模型，供后续推理；</p>
<p>• 核心属性：</p>
<ul>
<li><code>content: str</code>：工具执行结果（必填），建议用JSON等结构化格式；</li>
<li><code>role: str</code>：固定为 <code>"tool"</code>，标识工具角色；</li>
<li><code>tool_call_id: str</code>（必填）：关联对应AIMessage的工具调用ID，匹配“请求-结果”；</li>
<li><code>additional_kwargs: dict</code>（可选）：存储工具名称、执行时间、错误信息等。</li>
</ul>
<p>• 示例代码：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> ToolMessage

<span class="hljs-comment"># 初始化工具消息（模拟文件读取结果）</span>
tool_msg = ToolMessage(
    content=<span class="hljs-string">'{"filename": "langchain_intro.txt", "content": "LangChain 是大模型应用开发框架..."}'</span>,
    tool_call_id=<span class="hljs-string">"call_123"</span>  <span class="hljs-comment"># 关联工具调用ID</span>
)
<span class="hljs-built_in">print</span>(tool_msg)
</code></pre>
<h3 data-id="heading-6">FunctionMessage：函数调用消息</h3>
<p>• 用途：封装函数调用的请求或结果（与ToolMessage类似，侧重通用函数场景）；</p>
<p>• 核心属性：含 <code>content</code>（请求/结果，必填）、<code>role="function"</code>（固定角色）、<code>name</code>（函数名，必填）等；</p>
<p>• 注意：部分版本与ToolMessage合并，优先使用ToolMessage处理工具/函数场景。</p>
<h3 data-id="heading-7">ChatMessage：通用聊天消息</h3>
<p>• 用途：通用型消息，支持自定义角色，适配非标准交互场景；</p>
<p>• 核心属性：</p>
<ul>
<li><code>content: str</code>：核心消息内容（必填）；</li>
<li><code>role: str</code>（必填）：自定义角色标识，如“admin”“user_1”；</li>
<li><code>additional_kwargs: dict</code>（可选）：存储角色权限、所属分组等元数据。</li>
</ul>
<p>• 示例代码：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> ChatMessage

<span class="hljs-comment"># 初始化自定义角色消息</span>
chat_msg = ChatMessage(content=<span class="hljs-string">"请同步最新的开发文档"</span>, role=<span class="hljs-string">"admin"</span>)
<span class="hljs-built_in">print</span>(chat_msg)
<span class="hljs-comment"># 输出：ChatMessage(content='请同步最新的开发文档', role='admin')</span>
</code></pre>
<h2 data-id="heading-8">Message 的关键用法场景</h2>
<p><code>Message</code> 是 <code>LangChain</code> 交互核心，核心应用场景包括对话上下文构建、智能体工具交互等，具体如下：</p>
<h3 data-id="heading-9">构建对话上下文</h3>
<p>将<code>SystemMessage</code>、<code>HumanMessage</code>、<code>AIMessage</code>按顺序组成列表作为上下文传递给模型，即可实现多轮对话。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> SystemMessage, HumanMessage
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain_core.callbacks <span class="hljs-keyword">import</span> StdOutCallbackHandler

<span class="hljs-comment"># 构建对话上下文</span>
messages = [
    SystemMessage(content=<span class="hljs-string">"你是简洁的技术助手，回答不超过2句话。"</span>),
    HumanMessage(content=<span class="hljs-string">"什么是 LangChain？"</span>),
]

<span class="hljs-comment"># 初始化模型</span>
llm = ChatOpenAI(
    model_name=<span class="hljs-string">"qwen-plus"</span>,
    base_url=<span class="hljs-string">"https://dashscope.aliyuncs.com/compatible-mode/v1"</span>,
    api_key=<span class="hljs-string">"你的API Key"</span>
)

<span class="hljs-comment"># 创建智能体并调用</span>
agent = create_agent(model=llm, debug=<span class="hljs-literal">True</span>)
response = agent.invoke(
    {<span class="hljs-string">"messages"</span>: messages},
    config={<span class="hljs-string">"callbacks"</span>: [StdOutCallbackHandler()]}
)

<span class="hljs-built_in">print</span>(response)
</code></pre>
<pre><code class="hljs language-python" lang="python">{
    <span class="hljs-string">"messages"</span>: [
        SystemMessage(content=<span class="hljs-string">"你是简洁的技术助手，回答不超过2句话。"</span>),
        HumanMessage(content=<span class="hljs-string">"什么是 LangChain？"</span>),
        AIMessage(content=<span class="hljs-string">"LangChain 是构建语言模型应用的框架，支持链式调用、记忆管理和外部工具集成，助力高效开发大模型应用。"</span>)
    ]
}
</code></pre>
<h3 data-id="heading-10">智能体工具交互</h3>
<p>智能体调用工具时，工具请求封装为含调用参数的<code>AIMessage</code>，执行结果封装为<code>ToolMessage</code>回传，模型基于结果继续推理。完整示例如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> mcp.server.fastmcp <span class="hljs-keyword">import</span> FastMCP

<span class="hljs-comment"># 定义数学运算工具服务</span>
mcp = FastMCP(<span class="hljs-string">"数学运算Tools"</span>)

<span class="hljs-meta">@mcp.tool()</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">sum</span>(<span class="hljs-params">num1: <span class="hljs-built_in">int</span>, num2: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:
    <span class="hljs-keyword">return</span> num1 + num2

<span class="hljs-meta">@mcp.tool()</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">sub</span>(<span class="hljs-params">num1: <span class="hljs-built_in">int</span>, num2: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:
    <span class="hljs-keyword">return</span> num1 - num2

<span class="hljs-meta">@mcp.tool()</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">mul</span>(<span class="hljs-params">num1: <span class="hljs-built_in">int</span>, num2: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:
    <span class="hljs-keyword">return</span> num1 * num2

<span class="hljs-meta">@mcp.tool()</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">div</span>(<span class="hljs-params">num1: <span class="hljs-built_in">int</span>, num2: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">float</span>:
    <span class="hljs-keyword">return</span> num1 / num2

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    mcp.run(<span class="hljs-string">"stdio"</span>)
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> mcp <span class="hljs-keyword">import</span> StdioServerParameters
<span class="hljs-keyword">from</span> mcp.client.session <span class="hljs-keyword">import</span> ClientSession
<span class="hljs-keyword">from</span> mcp.client.stdio <span class="hljs-keyword">import</span> stdio_client
<span class="hljs-keyword">from</span> langchain_mcp_adapters.client <span class="hljs-keyword">import</span> load_mcp_tools
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate
<span class="hljs-keyword">from</span> langchain_core.callbacks <span class="hljs-keyword">import</span> StdOutCallbackHandler
<span class="hljs-keyword">import</span> asyncio

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_mcp_client</span>():
    <span class="hljs-comment"># 连接工具服务</span>
    server_params = StdioServerParameters(
        command=<span class="hljs-string">"python"</span>,
        args=[os.path.join(os.path.dirname(__file__), <span class="hljs-string">"mcp_stdio_server.py"</span>)],
    )
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> stdio_client(server_params) <span class="hljs-keyword">as</span> (read, write):
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> ClientSession(read, write) <span class="hljs-keyword">as</span> session:
            <span class="hljs-keyword">await</span> session.initialize()
            tools = <span class="hljs-keyword">await</span> load_mcp_tools(session)

            <span class="hljs-comment"># 初始化模型与智能体</span>
            model = ChatOpenAI(
                model_name=<span class="hljs-string">"qwen-plus"</span>,
                base_url=<span class="hljs-string">"https://dashscope.aliyuncs.com/compatible-mode/v1"</span>,
                api_key=<span class="hljs-string">"你的API Key"</span>
            )
            agent = create_agent(model=model, tools=tools, debug=<span class="hljs-literal">True</span>)

            <span class="hljs-comment"># 构建提示与请求</span>
            prompt = ChatPromptTemplate.from_messages([
                (<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是数学工具智能体，用sum/sub/mul/div计算，遵循先乘后加，仅输出最终数值。"</span>),
                (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{expr}"</span>)
            ])
            response = <span class="hljs-keyword">await</span> agent.ainvoke(
                {<span class="hljs-string">"messages"</span>: prompt.format_messages(expr=<span class="hljs-string">"100+200*300"</span>)},
                config={<span class="hljs-string">"callbacks"</span>: [StdOutCallbackHandler()]}
            )

            <span class="hljs-built_in">print</span>(response[<span class="hljs-string">"messages"</span>])

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    asyncio.run(create_mcp_client())
</code></pre>
<pre><code class="hljs language-python" lang="python">{
    <span class="hljs-string">"messages"</span>: [
        SystemMessage(content=<span class="hljs-string">"你是数学工具智能体。请严格使用提供的工具(sum/sub/mul/div) 计算表达式，遵循先乘后加的规则，只输出最终数值。"</span>),
        HumanMessage(content=<span class="hljs-string">"100+200*300"</span>),
        AIMessage(
            content=<span class="hljs-string">""</span>,
            tool_calls=[
                {<span class="hljs-string">"name"</span>: <span class="hljs-string">"mul"</span>, <span class="hljs-string">"args"</span>: {<span class="hljs-string">"num1"</span>: <span class="hljs-number">200</span>, <span class="hljs-string">"num2"</span>: <span class="hljs-number">300</span>}, <span class="hljs-string">"type"</span>: <span class="hljs-string">"tool_call"</span>},
                {<span class="hljs-string">"name"</span>: <span class="hljs-string">"sum"</span>, <span class="hljs-string">"args"</span>: {<span class="hljs-string">"num1"</span>: <span class="hljs-number">100</span>, <span class="hljs-string">"num2"</span>: <span class="hljs-number">60000</span>}, <span class="hljs-string">"type"</span>: <span class="hljs-string">"tool_call"</span>}
            ]
        ),
        ToolMessage(content=[{<span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>, <span class="hljs-string">"text"</span>: <span class="hljs-string">"60000"</span>}], name=<span class="hljs-string">"mul"</span>, artifact={<span class="hljs-string">"structured_content"</span>: {<span class="hljs-string">"result"</span>: <span class="hljs-number">60000</span>}}),
        ToolMessage(content=[{<span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>, <span class="hljs-string">"text"</span>: <span class="hljs-string">"60100"</span>}], name=<span class="hljs-string">"sum"</span>, artifact={<span class="hljs-string">"structured_content"</span>: {<span class="hljs-string">"result"</span>: <span class="hljs-number">60100</span>}}),
        AIMessage(content=<span class="hljs-string">"60100"</span>)
    ]
}
</code></pre>
<h2 data-id="heading-11">关键注意事项</h2>
<ul>
<li><strong>角色匹配</strong>：模型对角色敏感，需确保各<code>Message</code>角色标识正确，否则可能响应异常；</li>
<li><strong>顺序影响</strong>：对话上下文需按时间顺序排列（系统消息在前，后续为用户-模型交互历史），顺序错误影响上下文理解；</li>
<li><strong>关联ID必填</strong>：<code>ToolMessage</code>必须通过<code>tool_call_id</code>关联对应<code>AIMessage</code>，确保“请求-结果”匹配；</li>
<li><strong>序列化存储</strong>：持久化对话历史可通过<code>to_dict()</code>转字典存储，读取时用<code>from_dict()</code>反序列化；</li>
<li><strong>版本兼容</strong>：旧版本<code>Message</code>类型名称可能不同（如<code>ChatMessageType</code>），建议使用最新<code>langchain_core.messages</code>模块。</li>
</ul>
<h2 data-id="heading-12">总结</h2>
<p><code>Message</code>是<code>LangChain</code>交互的“数据核心”，通过标准化角色与格式，实现用户、系统、模型、工具间的顺畅流转。核心需掌握各类Message的用途、属性，以及在对话上下文构建、智能体工具交互中的流转逻辑。</p>
<p>掌握其核心逻辑，可深入理解<code>LangChain</code>组件交互原理，为构建复杂对话系统、智能体应用奠定基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用Python轻松管理Word页脚：批量处理与多节文档技巧]]></title>    <link>https://juejin.cn/post/7593098101432074294</link>    <guid>https://juejin.cn/post/7593098101432074294</guid>    <pubDate>2026-01-09T09:46:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593098101432074294" data-draft-id="7593098101432057910" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用Python轻松管理Word页脚：批量处理与多节文档技巧"/> <meta itemprop="keywords" content="后端,Python"/> <meta itemprop="datePublished" content="2026-01-09T09:46:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户835629078051"/> <meta itemprop="url" content="https://juejin.cn/user/3150554985403516"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用Python轻松管理Word页脚：批量处理与多节文档技巧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3150554985403516/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户835629078051
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T09:46:00.000Z" title="Fri Jan 09 2026 09:46:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e72978089f294ca1a3eb4baa8459d215~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODM1NjI5MDc4MDUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768556760&amp;x-signature=wZ5BYPoBBHGbD3LLJ%2FT7XlbaXpY%3D" alt="Python插入页脚到Word文档" loading="lazy"/></p>
<p>在日常的办公自动化中，处理Word文档是许多人绕不开的环节。无论是生成报告、合同，还是制作项目文档，Word都是一个不可或缺的工具。然而，当文档数量庞大，或者需要频繁更新时，那些看似简单的重复性任务，如插入页码、版权声明或公司Logo到页脚，就会变得异常耗时且容易出错。手动操作不仅效率低下，还可能导致格式不统一。</p>
<p>幸运的是，Python以其强大的自动化能力，为我们提供了优雅的解决方案。通过结合特定的文档处理库，我们可以编写程序来批量、精确地控制Word文档的每一个细节，包括复杂的页脚设置。本文将深入探讨如何利用Python，以编程方式为Word文档添加、定制和管理页脚，从而将你从繁琐的手动工作中解放出来。</p>
<hr/>
<h2 data-id="heading-0">Python环境配置与文档处理库简介</h2>
<p>在开始之前，我们需要确保Python环境已准备就绪，并安装我们将要使用的文档处理库。这个库提供了一系列强大的API，让Python能够与Word文档进行深度交互。</p>
<p>首先，请打开你的终端或命令提示符，执行以下命令来安装所需库：</p>
<pre><code class="hljs language-bash" lang="bash">pip install Spire.Doc
</code></pre>
<p>安装完成后，你就可以在Python脚本中导入必要的模块进行操作了。</p>
<p>了解Word文档的结构对于有效处理页脚至关重要。一个Word文档可以包含多个“节”（Section），每个节都可以拥有独立的页眉和页脚。这意味着你可以为文档的不同部分设置不同的页脚样式，例如，正文部分显示页码，而附录部分显示版本信息。</p>
<hr/>
<h2 data-id="heading-1">为Word文档添加简单文本页脚</h2>
<p>让我们从最基础的开始：为Word文档插入简单的文本页脚。这通常用于添加版权信息、文档名称或简单的日期。</p>
<p>以下是一个创建新文档并添加纯文本页脚的示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> spire.doc <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">from</span> spire.doc.common <span class="hljs-keyword">import</span> *

<span class="hljs-comment"># 创建一个新的Word文档</span>
document = Document()
section = document.AddSection()

<span class="hljs-comment"># 添加一个段落到文档，确保文档有内容</span>
paragraph = section.AddParagraph()
paragraph.AppendText(<span class="hljs-string">"这是文档的正文内容。"</span>)

<span class="hljs-comment"># 获取第一个节的页脚</span>
<span class="hljs-comment"># FooterType.FirstPage表示首页页脚，FooterType.EvenPages表示偶数页页脚，</span>
<span class="hljs-comment"># FooterType.OddPages表示奇数页页脚。如果文档没有设置首页不同或奇偶页不同，</span>
<span class="hljs-comment"># 则修改任何一个都会影响所有页。这里我们直接获取默认页脚。</span>
footer = section.HeadersFooters.Footer

<span class="hljs-comment"># 添加文本到页脚</span>
footer.AddParagraph().AppendText(<span class="hljs-string">"Copyright © 2023 My Company. All Rights Reserved."</span>)

<span class="hljs-comment"># 设置页脚文本的对齐方式</span>
<span class="hljs-comment"># 获取页脚中的第一个段落，并设置其对齐方式</span>
footer.Paragraphs[<span class="hljs-number">0</span>].Format.HorizontalAlignment = HorizontalAlignment.Right <span class="hljs-comment"># 右对齐</span>

<span class="hljs-comment"># 保存文档</span>
document.SaveToFile(<span class="hljs-string">"SimpleTextFooter.docx"</span>, FileFormat.Docx2013)
document.Close()

<span class="hljs-built_in">print</span>(<span class="hljs-string">"文档 'SimpleTextFooter.docx' 已生成，并包含文本页脚。"</span>)
</code></pre>
<p><strong>代码解释：</strong></p>
<ul>
<li><code>document = Document()</code> 创建了一个新的Word文档实例。</li>
<li><code>section = document.AddSection()</code> 添加了一个新的节。</li>
<li><code>footer = section.HeadersFooters.Footer</code> 获取当前节的页脚对象。</li>
<li><code>footer.AddParagraph().AppendText(...)</code> 在页脚中添加一个新的段落并插入文本。</li>
<li><code>footer.Paragraphs[0].Format.HorizontalAlignment = HorizontalAlignment.Right</code> 设置了页脚中第一个段落的水平对齐方式为右对齐。你也可以设置为 <code>HorizontalAlignment.Left</code> 或 <code>HorizontalAlignment.Center</code>。</li>
<li><code>document.SaveToFile(...)</code> 将修改后的文档保存到指定路径。</li>
</ul>
<p>通过这个简单的例子，我们已经能够自动化地为Word文档添加固定文本页脚，大大提升了效率。</p>
<hr/>
<h2 data-id="heading-2">定制化页脚：页码、格式与高级排版</h2>
<p>仅仅是纯文本页脚可能不足以满足所有需求。在实际应用中，我们更常需要插入动态页码，甚至在页脚中混合文本、页码和图片。</p>
<h3 data-id="heading-3">插入动态页码</h3>
<p>页码是页脚最常见的元素之一。这个库提供了灵活的方式来插入和格式化页码。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> spire.doc <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">from</span> spire.doc.common <span class="hljs-keyword">import</span> *

document = Document()
section = document.AddSection()

<span class="hljs-comment"># 添加足够的内容以生成多页，方便查看页码效果</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):
    paragraph = section.AddParagraph()
    paragraph.AppendText(<span class="hljs-string">f"这是文档的第 <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span> 页内容。"</span>)
    <span class="hljs-keyword">if</span> i &lt; <span class="hljs-number">9</span>: <span class="hljs-comment"># 除了最后一页，每页都添加一个分页符</span>
        section.AddPageBreak()

footer = section.HeadersFooters.Footer

<span class="hljs-comment"># 添加一个段落用于页码</span>
page_number_paragraph = footer.AddParagraph()

<span class="hljs-comment"># 插入“第 X 页 共 Y 页”格式的页码</span>
page_number_paragraph.AppendText(<span class="hljs-string">"第 "</span>)
page_number_paragraph.AppendField(<span class="hljs-string">"page number"</span>, FieldType.FieldPage) <span class="hljs-comment"># 当前页码</span>
page_number_paragraph.AppendText(<span class="hljs-string">" 页 共 "</span>)
page_number_paragraph.AppendField(<span class="hljs-string">"number of pages"</span>, FieldType.FieldNumPages) <span class="hljs-comment"># 总页数</span>
page_number_paragraph.AppendText(<span class="hljs-string">" 页"</span>)

<span class="hljs-comment"># 设置页码文本的字体和大小</span>
<span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> page_number_paragraph.ChildObjects:
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(item, TextRange):
        item.CharacterFormat.FontName = <span class="hljs-string">"Arial"</span>
        item.CharacterFormat.FontSize = <span class="hljs-number">10</span>
    <span class="hljs-keyword">elif</span> <span class="hljs-built_in">isinstance</span>(item, Field):
        item.CharacterFormat.FontName = <span class="hljs-string">"Arial"</span>
        item.CharacterFormat.FontSize = <span class="hljs-number">10</span>

<span class="hljs-comment"># 设置页码段落右对齐</span>
page_number_paragraph.Format.HorizontalAlignment = HorizontalAlignment.Right

document.SaveToFile(<span class="hljs-string">"PageNumberFooter.docx"</span>, FileFormat.Docx2013)
document.Close()

<span class="hljs-built_in">print</span>(<span class="hljs-string">"文档 'PageNumberFooter.docx' 已生成，并包含动态页码。"</span>)
</code></pre>
<p><strong>关键点：</strong></p>
<ul>
<li><code>AppendField("page number", FieldType.FieldPage)</code> 插入当前页码。</li>
<li><code>AppendField("number of pages", FieldType.FieldNumPages)</code> 插入文档总页数。</li>
<li>通过遍历段落的 <code>ChildObjects</code> 可以对页码中的文本和字段进行单独的格式设置。</li>
</ul>
<h3 data-id="heading-4">多元素页脚：文本与页码结合</h3>
<p>在同一个页脚中同时显示版权信息和页码也是常见需求。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> spire.doc <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">from</span> spire.doc.common <span class="hljs-keyword">import</span> *

document = Document()
section = document.AddSection()

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):
    section.AddParagraph().AppendText(<span class="hljs-string">f"这是多元素页脚测试内容 <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>。"</span>)
    <span class="hljs-keyword">if</span> i &lt; <span class="hljs-number">4</span>:
        section.AddPageBreak()

footer = section.HeadersFooters.Footer

<span class="hljs-comment"># 左侧添加版权信息</span>
left_paragraph = footer.AddParagraph()
left_paragraph.AppendText(<span class="hljs-string">"Copyright © 2023 My Company"</span>)
left_paragraph.Format.HorizontalAlignment = HorizontalAlignment.Left
left_paragraph.CharacterFormat.FontName = <span class="hljs-string">"Times New Roman"</span>
left_paragraph.CharacterFormat.FontSize = <span class="hljs-number">9</span>

<span class="hljs-comment"># 右侧添加页码</span>
right_paragraph = footer.AddParagraph()
right_paragraph.AppendText(<span class="hljs-string">"Page "</span>)
right_paragraph.AppendField(<span class="hljs-string">"page number"</span>, FieldType.FieldPage)
right_paragraph.AppendText(<span class="hljs-string">" of "</span>)
right_paragraph.AppendField(<span class="hljs-string">"number of pages"</span>, FieldType.FieldNumPages)
right_paragraph.Format.HorizontalAlignment = HorizontalAlignment.Right
right_paragraph.CharacterFormat.FontName = <span class="hljs-string">"Arial"</span>
right_paragraph.CharacterFormat.FontSize = <span class="hljs-number">9</span>

<span class="hljs-comment"># 为了实现左右对齐，通常需要通过表格或定位来精确控制，</span>
<span class="hljs-comment"># 但对于简单的左右布局，可以分别添加段落并设置对齐方式。</span>
<span class="hljs-comment"># 更复杂的布局可能需要借助Table或Shape等高级对象，这里只展示基本方法。</span>

document.SaveToFile(<span class="hljs-string">"MultiElementFooter.docx"</span>, FileFormat.Docx2013)
document.Close()

<span class="hljs-built_in">print</span>(<span class="hljs-string">"文档 'MultiElementFooter.docx' 已生成，并包含多元素页脚。"</span>)
</code></pre>
<p><strong>注意：</strong> 在Word文档中，页脚通常只有一个“故事板”区域。如果需要精确地将内容放置在页脚的左侧和右侧，最健壮的方法是使用页脚中的表格（Table）或文本框（Shape）。上述示例通过添加两个独立的段落并设置对齐方式，在某些情况下可以达到视觉上的左右布局效果，但可能无法完美对齐。</p>
<h3 data-id="heading-5">图片页脚</h3>
<p>在页脚中插入公司Logo或装饰性图片可以提升文档的专业性。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> spire.doc <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">from</span> spire.doc.common <span class="hljs-keyword">import</span> *

document = Document()
section = document.AddSection()
section.AddParagraph().AppendText(<span class="hljs-string">"这是一个带有图片页脚的文档。"</span>)

footer = section.HeadersFooters.Footer

<span class="hljs-comment"># 添加一个段落用于图片</span>
image_paragraph = footer.AddParagraph()

<span class="hljs-comment"># 假设你有一个名为 'logo.png' 的图片文件</span>
<span class="hljs-comment"># 请确保该图片文件存在于脚本运行的同级目录或指定完整路径</span>
<span class="hljs-keyword">try</span>:
    picture = image_paragraph.AppendPicture(<span class="hljs-string">"logo.png"</span>)
    <span class="hljs-comment"># 设置图片大小</span>
    picture.Width = <span class="hljs-number">50</span>
    picture.Height = <span class="hljs-number">50</span>
    <span class="hljs-comment"># 设置图片在页脚中的位置和文字环绕方式</span>
    picture.TextWrappingStyle = TextWrappingStyle.Behind
    picture.HorizontalOrigin = HorizontalOrigin.Column
    picture.HorizontalAlignment = ShapeHorizontalAlignment.Left
    picture.VerticalOrigin = VerticalOrigin.BottomMargin
    picture.VerticalAlignment = ShapeVerticalAlignment.Bottom
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"插入图片失败，请检查图片路径和文件是否存在：<span class="hljs-subst">{e}</span>"</span>)

<span class="hljs-comment"># 可选：在图片旁边添加文本</span>
image_paragraph.AppendText(<span class="hljs-string">"  Confidential Document"</span>)
image_paragraph.CharacterFormat.FontSize = <span class="hljs-number">8</span>

document.SaveToFile(<span class="hljs-string">"ImageFooter.docx"</span>, FileFormat.Docx2013)
document.Close()

<span class="hljs-built_in">print</span>(<span class="hljs-string">"文档 'ImageFooter.docx' 已生成，并包含图片页脚。"</span>)
</code></pre>
<p><strong>提示：</strong> 在插入图片时，<code>TextWrappingStyle</code>、<code>HorizontalOrigin</code>、<code>HorizontalAlignment</code>、<code>VerticalOrigin</code> 和 <code>VerticalAlignment</code> 等属性对于精确控制图片在页脚中的位置至关重要。</p>
<h3 data-id="heading-6">不同节的页脚与清除页脚</h3>
<p>如果你需要为文档的不同部分设置不同的页脚，可以使用多节功能。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> spire.doc <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">from</span> spire.doc.common <span class="hljs-keyword">import</span> *

document = Document()

<span class="hljs-comment"># 第一个节：常规内容，带页码页脚</span>
section1 = document.AddSection()
section1.AddParagraph().AppendText(<span class="hljs-string">"这是文档的第一部分。"</span>)
section1.AddParagraph().AppendText(<span class="hljs-string">"内容较少，但有页码。"</span>)
footer1 = section1.HeadersFooters.Footer
p1 = footer1.AddParagraph()
p1.AppendText(<span class="hljs-string">"Page "</span>)
p1.AppendField(<span class="hljs-string">"page number"</span>, FieldType.FieldPage)
p1.AppendText(<span class="hljs-string">" of "</span>)
p1.AppendField(<span class="hljs-string">"number of pages"</span>, FieldType.FieldNumPages)
p1.Format.HorizontalAlignment = HorizontalAlignment.Right

<span class="hljs-comment"># 添加一个分页符，开始新的节</span>
section2 = document.AddSection()
<span class="hljs-comment"># 设置新节与前一节不同，使其拥有独立的页眉页脚</span>
section2.PageSetup.DifferentFirstPage = <span class="hljs-literal">False</span> <span class="hljs-comment"># 确保不是首页不同</span>
section2.PageSetup.OddAndEvenPagesHeaderFooter = <span class="hljs-literal">False</span> <span class="hljs-comment"># 确保不是奇偶页不同</span>
section2.PageSetup.RestartPageNumbering = <span class="hljs-literal">True</span> <span class="hljs-comment"># 新节重新开始页码编号 (可选)</span>
section2.PageSetup.PageStartingNumber = <span class="hljs-number">1</span> <span class="hljs-comment"># 新节从第1页开始 (配合 RestartPageNumbering)</span>

section2.AddParagraph().AppendText(<span class="hljs-string">"这是文档的第二部分（附录），有不同的页脚。"</span>)
footer2 = section2.HeadersFooters.Footer
footer2.AddParagraph().AppendText(<span class="hljs-string">"Appendix - Version 1.0"</span>)
footer2.Paragraphs[<span class="hljs-number">0</span>].Format.HorizontalAlignment = HorizontalAlignment.Center

<span class="hljs-comment"># 清除现有页脚（如果需要）</span>
<span class="hljs-comment"># footer2.Clear() # 如果想完全清空页脚内容，可以使用此方法</span>

document.SaveToFile(<span class="hljs-string">"MultiSectionFooter.docx"</span>, FileFormat.Docx2013)
document.Close()

<span class="hljs-built_in">print</span>(<span class="hljs-string">"文档 'MultiSectionFooter.docx' 已生成，包含不同节的页脚。"</span>)
</code></pre>
<p><strong>重点：</strong></p>
<ul>
<li><code>section.AddSection()</code> 创建新节。</li>
<li><code>section.PageSetup.DifferentFirstPage = False</code> 和 <code>section.PageSetup.OddAndEvenPagesHeaderFooter = False</code> 是确保新节可以独立设置页脚的关键（默认情况下，新节会继承前一节的页眉页脚设置）。</li>
<li><code>footer.Clear()</code> 方法可以用于删除页脚中的所有内容。</li>
</ul>
<hr/>
<h2 data-id="heading-7">页脚处理的进阶技巧与注意事项</h2>
<p>在实际项目中，除了上述基本操作，我们还需要考虑一些进阶技巧和潜在问题。</p>
<ul>
<li><strong>处理大型文档时的性能：</strong> 对于包含成百上千页的超大型Word文档，频繁地进行保存或复杂的操作可能会影响性能。在这种情况下，可以考虑分批处理、优化代码逻辑，或者在操作完成后一次性保存。</li>
<li><strong>页脚可见性（例如，首页不显示页脚）：</strong> Word文档允许首页不显示页眉页脚。可以通过设置 <code>section.PageSetup.DifferentFirstPage = True</code> 来实现。然后，你可以通过 <code>section.HeadersFooters.FirstPageFooter</code> 来访问和设置首页页脚（或选择不设置任何内容）。</li>
<li><strong>错误处理机制：</strong> 在自动化脚本中，加入健壮的错误处理机制至关重要。例如，使用 <code>try-except</code> 块来捕获文件不存在、权限不足或库操作失败等异常，从而提高脚本的稳定性。</li>
<li><strong>与现有页脚的交互：</strong> 如果文档中已经存在页脚，你是想覆盖它，还是在现有内容基础上追加？通常，直接 <code>AddParagraph()</code> 会在现有内容后追加，而 <code>footer.Clear()</code> 会清空所有内容。</li>
<li><strong>其他相关功能：</strong> 除了页脚，该库还支持页眉、水印、文本框、表格等Word文档的各种元素操作。一旦掌握了页脚的自动化，你可以轻松扩展到其他文档自动化任务。</li>
<li><strong>代码的可维护性和复用性：</strong> 建议将常用的页脚设置逻辑封装成函数，提高代码的模块化和复用性。例如，创建一个 <code>add_page_number_footer(section, alignment)</code> 函数。</li>
</ul>
<hr/>
<h2 data-id="heading-8">总结</h2>
<p>通过本文的详细讲解和代码示例，我们已经深入了解了如何利用Python结合文档处理库，自动化地在Word文档中插入、定制和管理页脚。从简单的文本页脚到复杂的页码、图片和多节文档处理，Python都提供了强大而灵活的解决方案。</p>
<p>告别过去手动调整页脚的繁琐，现在你可以用几行Python代码，轻松实现文档页脚的自动化生成和批量处理，极大地提升你的工作效率和文档处理的准确性。我鼓励你将这些技术应用到你的实际工作中，探索Python在文档自动化领域的更多可能性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[📚 Android Settings系统：图书馆管理员的故事]]></title>    <link>https://juejin.cn/post/7593145583347859498</link>    <guid>https://juejin.cn/post/7593145583347859498</guid>    <pubDate>2026-01-09T09:54:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593145583347859498" data-draft-id="7593098101432156214" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="📚 Android Settings系统：图书馆管理员的故事"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-09T09:54:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Android童话镇"/> <meta itemprop="url" content="https://juejin.cn/user/2716247406161241"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            📚 Android Settings系统：图书馆管理员的故事
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2716247406161241/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Android童话镇
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T09:54:15.000Z" title="Fri Jan 09 2026 09:54:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🧸 故事开始：Android系统的"图书馆管理员"</h2>
<p>想象一下，Android系统是一个巨大的图书馆，里面收藏了成千上万本书籍（系统设置）。这些书籍被分类存放，分为三个区域：</p>
<ol>
<li><strong>Global区域</strong>：所有读者都能看到的通用书籍（如飞行模式、开发选项）</li>
<li><strong>Secure区域</strong>：只有管理员才能接触的敏感书籍（如位置服务、生物识别）</li>
<li><strong>System区域</strong>：普通读者可以借阅的日常书籍（如屏幕亮度、超时设置）</li>
</ol>
<p>在这个图书馆里，<strong>SettingsProvider</strong>就是那个负责管理所有书籍的<strong>管理员</strong>。当应用想要查看或修改某本书的内容时，<strong>不能直接去书架上翻阅</strong>，必须<strong>通过管理员</strong>来操作。</p>
<h2 data-id="heading-1">🧑‍💻 为什么不能直接操作数据库？</h2>
<p>在Android系统中，系统设置数据存储在<code>/data/system/users/0/</code>目录下的XML文件中（如<code>settings_system.xml</code>、<code>settings_global.xml</code>、<code>settings_secure.xml</code>）。但<strong>直接操作这些文件是危险的</strong>，就像你不能直接去图书馆的后台修改书架上的标签一样。</p>
<p>系统设计者聪明地将这些设置封装在<strong>ContentProvider</strong>中，通过<strong>ContentResolver</strong>接口提供安全的访问方式。这就像图书馆管理员，只允许读者通过借阅单（ContentResolver）来借阅书籍（Settings），而不能直接接触书架。</p>
<h2 data-id="heading-2">📌 核心原理：ContentProvider与ContentResolver</h2>
<p><strong>SettingsProvider</strong>是Android框架中的一个ContentProvider，它负责管理Settings数据库。当应用想要读取或修改设置时，需要通过<strong>ContentResolver</strong>向SettingsProvider发出请求。</p>
<p>这就像你去图书馆借书：</p>
<ol>
<li>你向管理员（ContentResolver）提出请求："我想借《屏幕亮度调整指南》"</li>
<li>管理员检查你的权限</li>
<li>如果权限允许，管理员从书架（数据库）中取出书（设置值）</li>
<li>你拿到书（设置值），并按要求阅读/修改</li>
</ol>
<h2 data-id="heading-3">🧪 代码示例：如何"借阅"和"归还"书籍</h2>
<h3 data-id="heading-4">1. 读取设置（获取书籍）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 想要获取屏幕超时设置（书名：screen_off_timeout）</span>
<span class="hljs-type">int</span> <span class="hljs-variable">screenTimeout</span> <span class="hljs-operator">=</span> Settings.System.getInt(
    getContentResolver(), 
    Settings.System.SCREEN_OFF_TIMEOUT, 
    <span class="hljs-number">30000</span> <span class="hljs-comment">// 默认值，如果找不到设置则返回30秒</span>
);
</code></pre>
<h3 data-id="heading-5">2. 写入设置（修改书籍内容）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 修改屏幕超时设置为120秒（书名：screen_off_timeout）</span>
<span class="hljs-comment">// 注意：需要WRITE_SETTINGS权限</span>
<span class="hljs-keyword">if</span> (Settings.System.canWrite(<span class="hljs-built_in">this</span>)) {
    Settings.System.putInt(
        getContentResolver(),
        Settings.System.SCREEN_OFF_TIMEOUT,
        <span class="hljs-number">120000</span> <span class="hljs-comment">// 120秒</span>
    );
} <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 请求权限</span>
    <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(Settings.ACTION_MANAGE_WRITE_SETTINGS);
    intent.setData(Uri.parse(<span class="hljs-string">"package:"</span> + getPackageName()));
    startActivityForResult(intent, REQUEST_WRITE_SETTINGS);
}
</code></pre>
<h2 data-id="heading-6">🔐 权限系统：图书馆的保安</h2>
<p>在图书馆中，不同区域的书籍有不同的访问权限：</p>
<p>表格</p>

























<table><thead><tr><th>区域</th><th>访问权限</th><th>举例</th></tr></thead><tbody><tr><td>Global</td><td>任何应用</td><td>飞行模式</td></tr><tr><td>System</td><td>需要WRITE_SETTINGS权限</td><td>屏幕亮度、超时</td></tr><tr><td>Secure</td><td>需要系统签名/系统应用权限</td><td>位置服务、生物识别</td></tr></tbody></table>
<p>就像图书馆保安一样，Android系统会检查你的"读者证"（权限）是否允许你进入特定区域。</p>
<h2 data-id="heading-7">📅 时序图：整个调用过程</h2>
<p>下面是一个时序图，描述了从应用调用<code>Settings.System.putInt</code>到系统设置被修改的全过程：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc57735953e34cb1ad342f5978a814a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW5kcm9pZOerpeivnemVhw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768557255&amp;x-signature=fqbIP18vG0nBJxhUGMVcWzifgb0%3D" alt="tongyi-mermaid-2026-01-09-175254.png" loading="lazy"/></p>
<h2 data-id="heading-8">🌐 详细过程解析</h2>
<ol>
<li>
<p><strong>应用发起请求</strong>：应用调用<code>Settings.System.putInt()</code>方法，传递需要设置的键（如<code>SCREEN_OFF_TIMEOUT</code>）和值（120000）。</p>
</li>
<li>
<p><strong>权限检查</strong>：<code>Settings.System.putInt()</code>内部会检查应用是否拥有<code>WRITE_SETTINGS</code>权限（Android 6.0+需要动态申请）。</p>
</li>
<li>
<p><strong>ContentResolver转发</strong>：如果权限检查通过，ContentResolver会将请求转发给SettingsProvider。</p>
</li>
<li>
<p><strong>SettingsProvider处理</strong>：</p>
<ul>
<li>通过<code>ContentResolver</code>的<code>insert()</code>或<code>update()</code>方法</li>
<li>检查权限（对于Secure域，需要系统签名）</li>
<li>在内存中更新设置</li>
<li>将更新写入XML文件（如<code>settings_system.xml</code>）</li>
</ul>
</li>
<li>
<p><strong>数据持久化</strong>：SettingsProvider将更新保存到对应的XML文件中，系统重启后会自动加载这些设置。</p>
</li>
</ol>
<h2 data-id="heading-9">💡 为什么不能直接操作XML文件？</h2>
<p>想象一下，如果你直接去图书馆的后台修改书架标签：</p>
<ul>
<li>你可能会不小心修改错误的标签</li>
<li>你可能会在图书馆繁忙时进行修改，导致数据不一致</li>
<li>没有权限检查，任何人都可以随意修改</li>
</ul>
<p>通过SettingsProvider，系统确保了：</p>
<ol>
<li>所有修改都经过权限检查</li>
<li>所有修改都通过一致的API进行</li>
<li>系统可以监控和记录所有设置变更</li>
</ol>
<h2 data-id="heading-10">🧪 实际案例：开机自动设置</h2>
<p>假设我们需要在设备开机后自动关闭飞行模式，可以在<code>init.rc</code>中添加脚本：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在init.rc中添加</span>
on property:dev.bootcomplete=1
    <span class="hljs-built_in">exec</span> /system/bin/set_flight_mode.sh
</code></pre>
<p><code>/system/bin/set_flight_mode.sh</code>脚本内容：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/system/bin/sh</span>
<span class="hljs-built_in">sleep</span> 10  <span class="hljs-comment"># 等待系统服务启动</span>
settings put global airplane_mode_on 0
</code></pre>
<p>这个脚本在系统启动完成后执行，通过<code>settings put</code>命令修改飞行模式设置。</p>
<h2 data-id="heading-11">📌 重要总结</h2>
<ol>
<li><strong>SettingsProvider是ContentProvider</strong>：它通过ContentResolver提供安全的访问接口</li>
<li><strong>权限至关重要</strong>：不同设置域需要不同权限</li>
<li><strong>不能直接操作文件</strong>：必须通过ContentProvider</li>
<li><strong>系统重启后自动加载</strong>：设置值会持久化到XML文件</li>
<li><strong>Android 6.0+需要动态权限</strong>：WRITE_SETTINGS权限需要用户手动授权</li>
</ol>
<h2 data-id="heading-12">💬 系统架构师的建议</h2>
<p>作为Android系统架构师，我经常对新来的开发者说："<strong>不要试图绕过SettingsProvider直接修改设置，这就像试图绕过图书馆管理员直接修改书架标签——看似简单，实则危险。</strong> "</p>
<p>记住：Android的系统设计有其深意，遵循官方API不仅能保证应用的稳定性，还能确保应用在不同Android版本上的兼容性。</p>
<p>现在，你已经掌握了Settings系统的核心原理，可以像图书馆管理员一样，安全、高效地管理Android系统的各种设置啦！📚✨</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[npm pack 一键构建npm离线包]]></title>    <link>https://juejin.cn/post/7593171168258506761</link>    <guid>https://juejin.cn/post/7593171168258506761</guid>    <pubDate>2026-01-09T08:42:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593171168258506761" data-draft-id="7592996072706228274" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="npm pack 一键构建npm离线包"/> <meta itemprop="keywords" content="NPM"/> <meta itemprop="datePublished" content="2026-01-09T08:42:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="就知道你是成心的"/> <meta itemprop="url" content="https://juejin.cn/user/1480370650090200"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            npm pack 一键构建npm离线包
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1480370650090200/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    就知道你是成心的
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T08:42:42.000Z" title="Fri Jan 09 2026 08:42:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>npm pack 命令</strong></p>
<p>npm pack 命令是 npm 包管理器的核心功能之一，专门用于生成离线 npm 模块或依赖包。它的工作原理十分简单：它会遍历 node_modules 目录，查找所有 package.json 文件，并执行 npm pack 命令生成压缩文件。这些压缩文件包含了模块及其所有依赖项，可以独立于 npm 仓库进行安装和使用。</p>
<p><code>my-app/scripts</code></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eac6666c4bac4d6e892c62ce990e3aa4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCx55-l6YGT5L2g5piv5oiQ5b-D55qE:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768552962&amp;x-signature=FCqXZBdsyBwX0McIItdaUhLLcKM%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0"><code>build.sh</code>文件</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4284d5df76fd450abc92ba4eae184a0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCx55-l6YGT5L2g5piv5oiQ5b-D55qE:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768552962&amp;x-signature=j5hh1O4SYhQiYG%2FacqXyOIxr6UA%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-shell" lang="shell">set -e  # 遇到错误立即退出

curDir=$(readlink -f "$(dirname "$0")")

cd $curDir/../

echo "📦 安装依赖..."

yarn

echo "🔨 开始构建..."

yarn build

echo "✅ 构建完成！"
</code></pre>
<p>这几行代码是一个<strong>项目构建自动化脚本</strong>，它的核心作用是：</p>
<ol>
<li><strong>智能定位</strong>：自动找到脚本所在的准确位置</li>
<li><strong>目录切换</strong>：确保在正确的项目根目录下执行</li>
<li><strong>依赖管理</strong>：自动安装项目所需的所有依赖</li>
<li><strong>构建执行</strong>：运行项目的构建流程</li>
</ol>
<h2 data-id="heading-1"><code>pack.sh</code> 文件</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e45948f3f504b658c46649a0f108a18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCx55-l6YGT5L2g5piv5oiQ5b-D55qE:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768552962&amp;x-signature=Lbl6LAs0JDUc9VbV%2BoO898YEXP0%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash">!/bin/bash</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">错误时立即退出</span>
set -e
<span class="hljs-meta prompt_">
# </span><span class="bash">获取脚本所在目录的绝对路径</span>
curDir=$(readlink -f "$(dirname "$0")")

echo "🚀 开始打包流程..."
echo "当前脚本目录: $curDir"
<span class="hljs-meta prompt_">
# </span><span class="bash">1. 重新编译项目</span>
echo "🔄 重新编译项目..."
sh $curDir/build.sh
<span class="hljs-meta prompt_">
# </span><span class="bash">2. 更新版本号为预发布版本</span>
echo "📦 更新版本号..."
npm version prerelease --preid=alpha --no-git-tag-version
current_version=$(node -p "require('$curDir/../package.json').version")
echo "新版本号: $current_version"
<span class="hljs-meta prompt_">
# </span><span class="bash">3. 复制 package.json 到 dist 目录</span>
echo "📁 复制 package.json..."
cp $curDir/../package.json $curDir/../dist/
<span class="hljs-meta prompt_">
# </span><span class="bash">4. 进入 dist 目录</span>
cd $curDir/../dist
echo "切换到目录: $(pwd)"
<span class="hljs-meta prompt_">
# </span><span class="bash">5. 修改版本号，添加本地时间戳</span>
echo "⏰ 添加本地时间戳..."
timestamp=$(date +%Y%m%d%H%M%S)
echo "时间戳: $timestamp"
<span class="hljs-meta prompt_">
# </span><span class="bash">修正 sed 命令，正确的正则表达式</span>
sed -i "s/\"version\": \".*-alpha\.[0-9]*\"/&amp;.local.$timestamp/" package.json
<span class="hljs-meta prompt_">
# </span><span class="bash">验证修改结果</span>
final_version=$(node -p "require('./package.json').version")
echo "最终版本号: $final_version"
<span class="hljs-meta prompt_">
# </span><span class="bash">6. 打包</span>
echo "📦 开始打包..."
npm pack
<span class="hljs-meta prompt_">
# </span><span class="bash">显示生成的文件</span>
echo "✅ 打包完成！生成文件:"
ls -la *.tgz
</code></pre>
<p><code>pubilsh.sh</code>文件</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8cded9bcb2db4806903bc264eb08d1d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCx55-l6YGT5L2g5piv5oiQ5b-D55qE:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768552962&amp;x-signature=CE5Fi7EWJQGTRVfIR8RGJPrbSp0%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一次 CompletableFuture 误用，如何耗尽 IO 线程池并拖垮整个系统]]></title>    <link>https://juejin.cn/post/7593181244708569140</link>    <guid>https://juejin.cn/post/7593181244708569140</guid>    <pubDate>2026-01-09T09:56:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593181244708569140" data-draft-id="7593193235250642996" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一次 CompletableFuture 误用，如何耗尽 IO 线程池并拖垮整个系统"/> <meta itemprop="keywords" content="后端,Java,代码规范"/> <meta itemprop="datePublished" content="2026-01-09T09:56:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="PPPHUANG"/> <meta itemprop="url" content="https://juejin.cn/user/3083464300298525"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一次 CompletableFuture 误用，如何耗尽 IO 线程池并拖垮整个系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3083464300298525/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    PPPHUANG
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T09:56:54.000Z" title="Fri Jan 09 2026 09:56:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>一次看似无害的 <code>CompletableFuture.thenApply</code> 使用，因为在回调中执行了同步 RPC，导致 RPC 框架线程被阻塞， 最终引发 CompletableFuture 无法完成、HTTP 线程池耗尽的级联雪崩。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0"><strong>一、故障现象：不是慢，而是“系统不动了”</strong></h2>
<p>线上服务突然出现大面积超时，QPS 急剧下降，但 CPU 使用率并不高。</p>
<p>第一反应是慢接口，但很快发现事情不对：</p>
<ul>
<li>Tomcat 线程池大量线程处于 <strong>WAITING</strong></li>
<li>请求并没有明显的慢点</li>
<li>重启后短时间恢复，流量上升再次雪崩</li>
</ul>
<p>Thread Dump 中，几乎所有业务线程都卡在同一个地方：</p>
<pre><code class="hljs language-bash" lang="bash">java.lang.Thread.State: WAITING (parking)
    at sun.misc.Unsafe.park(Native Method)
    at java.util.concurrent.locks.LockSupport.park
    at java.util.concurrent.CompletableFuture.waitingGet
    at java.util.concurrent.CompletableFuture.<span class="hljs-built_in">join</span>
    at UserListFetcher.getInfos
</code></pre>
<hr/>
<h2 data-id="heading-1"><strong>二、初步排查：谁在等？在等什么？</strong></h2>
<p>UserListFetcher.getInfos 使用了典型的并行聚合模式：</p>
<pre><code class="hljs language-scss" lang="scss">CompletableFuture<span class="hljs-selector-class">.allOf</span>(cfA, cfB, cfC)<span class="hljs-selector-class">.join</span>();
</code></pre>
<p>乍一看逻辑完全合理：</p>
<p>并行请求多个下游，全部完成后聚合结果。</p>
<p>但问题在于：</p>
<p><strong>其中有一部分 CompletableFuture 很久没有完成。</strong></p>
<hr/>
<h2 data-id="heading-2"><strong>三、致命代码：回调里写了“看起来很正常”的逻辑</strong></h2>
<p>问题出在某个子调用的实现中：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-title class_">CompletableFuture</span>&lt;<span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">Long</span>, <span class="hljs-title class_">UserReturnDto</span>&gt;&gt; <span class="hljs-title function_">getUserReturnMapCf</span>(<span class="hljs-params">...</span>) {
    <span class="hljs-keyword">return</span> asyncExecutor.<span class="hljs-title function_">async</span>(...)
        .<span class="hljs-title function_">thenApply</span>(result -&gt; {
            <span class="hljs-keyword">return</span> <span class="hljs-title function_">dealAfter</span>(result);
        });
}

<span class="hljs-keyword">private</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">Long</span>, <span class="hljs-title class_">UserReturnDto</span>&gt; <span class="hljs-title function_">dealAfter</span>(<span class="hljs-params">...</span>) {
    <span class="hljs-comment">// 同步 RPC 调用</span>
    <span class="hljs-keyword">return</span> extServer.<span class="hljs-title function_">getInfos</span>(...);
}
</code></pre>
<p>代码本身<strong>没有明显错误</strong>，</p>
<ul>
<li>使用了异步 RPC</li>
<li>使用了 CompletableFuture</li>
<li>逻辑清晰、可读性也不错</li>
</ul>
<p>但这里隐藏着一个</p>
<p><strong>对 CompletableFuture 线程模型的致命误解</strong>。</p>
<hr/>
<h2 data-id="heading-3"><strong>四、thenApply 到底在哪个线程执行？</strong></h2>
<blockquote>
<p>CompletableFuture.thenApply / thenAccept</p>
</blockquote>
<blockquote>
<p>并不保证运行在“业务线程池”中。</p>
</blockquote>
<p>它的执行线程取决于 <strong>上一个阶段是在哪个线程完成的</strong>。</p>
<p>在本例中，真实执行流程是：</p>
<ol>
<li>发起异步 RPC</li>
<li>Future 未完成，注册回调</li>
<li>RPC 响应返回</li>
<li><strong>RPC / Netty IO 线程</strong> 标记 Future 完成</li>
<li><strong>同一个 IO 线程立即执行 thenApply</strong></li>
<li>thenApply 回调中执行同步 RPC</li>
<li>RPC 线程进入 WAITING 状态 ❌</li>
</ol>
<hr/>
<h2 data-id="heading-4"><strong>五、雪崩是如何发生的？</strong></h2>
<p>从系统视角看，这是一条非常典型的线程耗尽链路：</p>
<pre><code class="hljs language-bash" lang="bash">HTTP Thread
    |
    v
CompletableFuture.<span class="hljs-built_in">join</span>()
    |
    v
等待子 Future 完成
    |
    v
子 Future 回调运行在 IO 线程
    |
    v
IO 线程被同步 RPC 阻塞
    |
    v
更多 RPC 回调无法执行
    |
    v
更多 Future 无法完成
    |
    v
HTTP 线程池耗尽
</code></pre>
<p>当RPC IO 线程池被业务逻辑占满时：</p>
<ul>
<li>新的 RPC 响应无法被处理</li>
<li>Future 永远不会完成</li>
<li>上游 join() 永远不会返回</li>
</ul>
<blockquote>
<p>这不是“慢”，而是“吞吐量归零”。</p>
</blockquote>
<hr/>
<h2 data-id="heading-5"><strong>六、紧急修复：IO 线程隔离（立刻止血）</strong></h2>
<p>最直接、也是最安全的修复方式：</p>
<blockquote>
<p>明确指定回调执行线程池</p>
</blockquote>
<h3 data-id="heading-6"><strong>❌ 修复前（危险）</strong></h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">asyncExecutor</span><span class="hljs-selector-class">.async</span>(...)
    <span class="hljs-selector-class">.thenApply</span>(res -&gt; otherRpcService.<span class="hljs-built_in">getData</span>(res.<span class="hljs-built_in">getId</span>()));
</code></pre>
<h3 data-id="heading-7"><strong>✅ 修复后（安全）</strong></h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">asyncExecutor</span><span class="hljs-selector-class">.async</span>(...)
    <span class="hljs-selector-class">.thenApplyAsync</span>(
        res -&gt; otherRpcService.<span class="hljs-built_in">getData</span>(res.<span class="hljs-built_in">getId</span>()),
        userBizExecutor
    );
</code></pre>
<hr/>
<h2 data-id="heading-8"><strong>七、长期治理：用 API 设计“防呆”</strong></h2>
<p>这次事故暴露了一个现实问题：</p>
<blockquote>
<p>“不要在回调里写阻塞代码”</p>
</blockquote>
<p>但是这种规范，迟早会被违反。</p>
<p>真正可靠的治理方式是：</p>
<ol>
<li>IDE / 编译期即时反馈</li>
<li>不依赖人的自觉</li>
</ol>
<h3 data-id="heading-9"><strong>7.1 安全版 CompletableFuture 封装</strong></h3>
<p>我们对 RPC 框架使用的 CompletableFuture 做了一层封装：</p>
<ul>
<li>
<p><strong>禁用</strong> thenApply / thenAccept</p>
</li>
<li>
<p>强制区分：</p>
<ul>
<li>阻塞逻辑（Async + Executor）</li>
<li>非阻塞逻辑（明确声明）</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RPCCompletableFuture</span>&lt;T&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CompletableFuture</span>&lt;T&gt; {

<span class="hljs-comment">/**
     * 将标准的 CompletableFuture 包装为 RPCCompletableFuture。
     * 这样可以确保链式调用的每一步都受到 RPCCompletableFuture 的安全检查。
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;U&gt; <span class="hljs-title class_">RPCCompletableFuture</span>&lt;U&gt; <span class="hljs-title function_">wrap</span>(<span class="hljs-params">CompletableFuture&lt;U&gt; original</span>) {
        <span class="hljs-title class_">RPCCompletableFuture</span>&lt;U&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RPCCompletableFuture</span>&lt;&gt;();
        original.<span class="hljs-title function_">whenComplete</span>((res, ex) -&gt; {
            <span class="hljs-keyword">if</span> (ex != <span class="hljs-literal">null</span>) {
                wrapper.<span class="hljs-title function_">completeExceptionally</span>(ex);
            } <span class="hljs-keyword">else</span> {
                wrapper.<span class="hljs-title function_">complete</span>(res);
            }
        });
        <span class="hljs-keyword">return</span> wrapper;
    }
    
     <span class="hljs-comment">/**
     * ⛔️ &lt;b&gt;已禁用提示&lt;/b&gt;
     * &lt;p&gt;
     * 请确认回调逻辑是否包含 IO 操作：
     * - 有 IO 操作：请改用 {<span class="hljs-doctag">@link</span> #thenApplyAsync(Function, Executor)}。
     * - 无 IO 操作（仅对象组装）：请改用 {<span class="hljs-doctag">@link</span> #thenApplyNonBlocking(Function)}。
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Deprecated</span>
    <span class="hljs-keyword">public</span> &lt;U&gt; <span class="hljs-title class_">RPCCompletableFuture</span>&lt;U&gt; <span class="hljs-title function_">thenApply</span>(<span class="hljs-params">
            <span class="hljs-built_in">Function</span>&lt;? <span class="hljs-variable language_">super</span> T, ? <span class="hljs-keyword">extends</span> U&gt; fn</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">wrap</span>(<span class="hljs-variable language_">super</span>.<span class="hljs-title function_">thenApply</span>(fn));
    }
 <span class="hljs-comment">/**
     * ✅ &lt;b&gt;无阻塞安全调用&lt;/b&gt;
     * &lt;p&gt;
     * 仅当确信回调逻辑为&lt;b&gt;纯内存操作&lt;/b&gt;（如对象组装、数据转换）且&lt;b&gt;执行极快&lt;/b&gt;时使用。
     */</span>
      <span class="hljs-keyword">public</span> &lt;U&gt; <span class="hljs-title class_">RPCCompletableFuture</span>&lt;U&gt; <span class="hljs-title function_">thenApplyNonBlocking</span>(<span class="hljs-params"><span class="hljs-built_in">Function</span>&lt;? <span class="hljs-variable language_">super</span> T, ? <span class="hljs-keyword">extends</span> U&gt; fn</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">wrap</span>(<span class="hljs-variable language_">super</span>.<span class="hljs-title function_">thenApply</span>(fn));
    }
}
</code></pre>
<p>IDE 中，错误用法会被明确标红，强制开发者思考线程模型，选择正确用法。</p>
<hr/>
<h2 data-id="heading-10"><strong>八、配套治理：监控与 Code Review</strong></h2>
<h3 data-id="heading-11"><strong>8.1 必须监控的指标</strong></h3>
<ul>
<li>RPC IO 线程池：ActiveCount、QueueSize</li>
<li>业务线程池：队列长度</li>
<li>HTTP 线程池：WAITING 比例</li>
</ul>
<h3 data-id="heading-12"><strong>8.2 Code Review Checklist</strong></h3>
<ul>
<li>回调中是否包含 RPC / DB / Redis？</li>
<li>是否显式指定 Executor？</li>
<li>是否存在隐式阻塞？</li>
<li>是否有上下文丢失风险？</li>
</ul>
<hr/>
<h2 data-id="heading-13"><strong>九、总结</strong></h2>
<p>这次事故的本质不是 CompletableFuture 的 bug，</p>
<p>而是<strong>线程模型被错误理解，或者使用时有疏忽</strong>。</p>
<p>可以归结为三条经验：</p>
<ol>
<li>异步不等于安全，线程模型比 API 更重要</li>
<li>任何系统线程，都不应该承载不确定耗时的非该线程职责内的业务逻辑</li>
<li>最好的开发规范，不是文档，是代码和工具链</li>
</ol>
<p>如果你在系统中大量使用异步编排，这类问题迟早会出现。</p>
<p>区别只在于：<strong>你是提前设计防线，还是等事故帮你复习一遍。</strong></p>
<p>公众号：<strong>DailyHappy</strong> 一位后端写码师，一位黑暗料理制造者。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[浅学文件系统4(页面缓存)]]></title>    <link>https://juejin.cn/post/7592921639463993386</link>    <guid>https://juejin.cn/post/7592921639463993386</guid>    <pubDate>2026-01-09T03:42:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592921639463993386" data-draft-id="7592884480731070510" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="浅学文件系统4(页面缓存)"/> <meta itemprop="keywords" content="Linux"/> <meta itemprop="datePublished" content="2026-01-09T03:42:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="煤球王子"/> <meta itemprop="url" content="https://juejin.cn/user/4088439235949739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            浅学文件系统4(页面缓存)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4088439235949739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    煤球王子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T03:42:06.000Z" title="Fri Jan 09 2026 03:42:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">页面缓存简述</h2>
<p>页面缓存(<strong><code>Page Cache</code></strong>)： Linux内核管理的<code>一块物理内存</code>， 页面缓存——就是缓存 文件磁盘”数据块“ 对应的物理页。</p>
<p><strong>为什么叫“页面缓存” ， 不叫“文件缓存” 呢？</strong></p>
<p>答：一个文件包含多个数据块(4KB), 每个数据块加载到物理内存时，需要一个物理页(page)， 来存储数据，也就是说，页面缓存的单位就是：物理页(4KB page)</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/476085bfd6bf45418cdf237504d1bbe5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Wk55CD546L5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534926&amp;x-signature=hcAv9kluF9o62HcKVaEgHF%2Bw82k%3D" alt="image.png" loading="lazy"/></p>
<p><strong>页面缓存的目的： 减少硬盘或磁盘的 I/O 次数</strong>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da0b1e0a2ea3426ab6c2f6b618c634bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Wk55CD546L5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534926&amp;x-signature=Tl2kG8bCd8%2FHBfx6AAgQ8eQ14cE%3D" alt="image.png" loading="lazy"/></p>
<ol>
<li><code>inode散列表</code>:  缓存__元数据信息</li>
<li><code>dcache散列表</code>: 缓存__目录的目录项数据信息</li>
<li><code>页面缓存</code>:     缓存__文件的数据块信息</li>
</ol>
<blockquote>
<p>从图中我们可以知道，Linux内核为了优化 I/O 做了很多，搞了 inode散列表、dcache散列表、页面缓存</p>
</blockquote>
<h2 data-id="heading-1">页面缓存中的数据结构</h2>
<h3 data-id="heading-2">address_space(地址空间)</h3>
<p><strong><code>address_space</code></strong> 数据结构 用来建立 缓存数据__与__它自己来源之间的关联
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c0aacb2c7f44b7e92af5194103d2487~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Wk55CD546L5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534926&amp;x-signature=6W42a7BcNwwvhkS%2FmK1lL3HM1%2BM%3D" alt="image.png" loading="lazy"/>
上图举例：文件a的_第四个数据块在页面缓存中的位置, <code>文件a的</code>: <strong>inode + 数据块偏移量</strong></p>
<p>（inode , offset） —— （address_sapce, offset）</p>
<blockquote>
<p>当然，Linux为了让页面缓存更通用，把 inode 用 address_space 来代替。 当然它们是有关联的。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c22d8a29139d4078b1dd0f564ad157b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Wk55CD546L5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534926&amp;x-signature=DrviWesxYeKY6WwRIVptHIVedWw%3D" alt="image.png" loading="lazy"/>
inode(索引节点)、file(文件)  这些结构体里面都有 <code>address_space</code> 变量定义</p>
<pre><code class="hljs language-ini" lang="ini">struct  address_space {
    inode  *host<span class="hljs-comment">;  所属问题</span>
    radix_tree_root  page_tree<span class="hljs-comment">;  维护所有缓存页(基数树)</span>
    long  nrpages<span class="hljs-comment">; 总共缓存page个数</span>
    
    rb_root  i_mmap<span class="hljs-comment">; 和内存映射相关</span>
    void  *private_data<span class="hljs-comment">; 私有数据</span>
    
    address_space_operations   *a_ops<span class="hljs-comment">;  方法操作</span>
    .......
}
</code></pre>
<h3 data-id="heading-3">address_space_operations(操作方法)</h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">address_space_operations</span> {</span> 
<span class="hljs-comment">/* ① 读：磁盘 → 页面缓存 */</span> 
    <span class="hljs-comment">/* 单页同步读：磁盘内容填到 page，返回 0/-EIO 等 */</span> 
    <span class="hljs-type">int</span> (*readpage)(<span class="hljs-keyword">struct</span> file *filp, <span class="hljs-keyword">struct</span> page *page); 
    <span class="hljs-comment">/* 批量读：一次性把 pages 链表里的 nr_pages 页全部读入 */</span>
    <span class="hljs-type">int</span> (*readpages)(<span class="hljs-keyword">struct</span> file *filp, <span class="hljs-keyword">struct</span> address_space *mapping, <span class="hljs-keyword">struct</span> list_head *pages, <span class="hljs-type">unsigned</span> nr_pages); 

<span class="hljs-comment">/* ② 写：页面缓存 → 磁盘（回写） */</span> 
    <span class="hljs-comment">/* 单页回写：由 flusher 线程调用，把脏页写回磁盘 */</span>
    <span class="hljs-type">int</span> (*writepage)(<span class="hljs-keyword">struct</span> page *page, <span class="hljs-keyword">struct</span> writeback_control *wbc);  
    <span class="hljs-comment">/* 批量回写：扫描 mapping 的整棵 radix/xarray 树，把脏页写回 */</span> 
    <span class="hljs-type">int</span> (*writepages)(<span class="hljs-keyword">struct</span> address_space *mapping, <span class="hljs-keyword">struct</span> writeback_control *wbc); 

<span class="hljs-comment">/* ③ 标记脏页 */</span> 
    <span class="hljs-comment">/* 把页设为脏，通常由 __set_page_dirty_buffers 调用 */</span> 
    <span class="hljs-type">int</span> (*set_page_dirty)(<span class="hljs-keyword">struct</span> page *page); 

<span class="hljs-comment">/* ④ 直接 I/O：绕过页面缓存 */</span> 
    <span class="hljs-comment">/* 用户态 Direct-IO 读写入口，数据直接落盘/从盘读 */</span> 
    <span class="hljs-type">ssize_t</span> (*direct_IO)(<span class="hljs-keyword">struct</span> kiocb *iocb, <span class="hljs-keyword">struct</span> iov_iter *iter); 

<span class="hljs-comment">/* ⑤ 准备 &amp; 提交写（mmap/缓冲写通用） */</span> 
    <span class="hljs-comment">/* 写前准备：为 [pos, pos+len) 分配/获取缓存页，返回 locked 页 */</span> 
    <span class="hljs-type">int</span> (*write_begin)(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-keyword">struct</span> address_space *mapping, <span class="hljs-type">loff_t</span> pos, <span class="hljs-type">unsigned</span> len, <span class="hljs-type">unsigned</span> flags, <span class="hljs-keyword">struct</span> page **pagep, <span class="hljs-type">void</span> **fsdata); 
    <span class="hljs-comment">/* 写后提交：把 page 标记脏、解锁、更新 i_size；返回实际写入字节 */</span> 
    <span class="hljs-type">int</span> (*write_end)(<span class="hljs-keyword">struct</span> file *file,<span class="hljs-keyword">struct</span> address_space *mapping, <span class="hljs-type">loff_t</span> pos, <span class="hljs-type">unsigned</span> len, <span class="hljs-type">unsigned</span> copied, <span class="hljs-keyword">struct</span> page *page, <span class="hljs-type">void</span> *fsdata);

    ........ 
};
</code></pre>
<h3 data-id="heading-4">Page(页)</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">page</span> { 
<span class="hljs-comment">/* ===== 1. 页面缓存相关 ===== */</span> 
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">address_space</span> *mapping; 指向所属缓存容器（文件 inode 或 swap 地址空间）。 最低位为 <span class="hljs-number">1</span> 时表示该页在 swap 缓存而非文件缓存
    <span class="hljs-type">pgoff_t</span> index;  页在 mapping 内的逻辑下标（以页为单位，非字节）
    
<span class="hljs-comment">/* ===== 2. 物理页框管理 ===== */</span> 
    页标志位集合：PG_locked、PG_dirty、PG_writeback、PG_uptodate、PG_referenced、PG_swapbacked … 
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags; 
    <span class="hljs-keyword">union</span> { 
        <span class="hljs-type">atomic_t</span> _refcount;  页引用计数， <span class="hljs-number">0</span> 表示空闲，  &lt;<span class="hljs-number">0</span>为BUG 
        <span class="hljs-keyword">struct</span> {  SLUB 等子系统复用空闲页的字段
            <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> inuse; 
            <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> objects; 
        }; 
    }; 
    
<span class="hljs-comment">/* ===== 3. LRU 链表 / 回收 ===== */</span> 
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">list_head</span> lru; <span class="hljs-comment">/* 把页挂到 LRU、swap、inode 回收等各种链表 */</span> 
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-keyword">private</span>; <span class="hljs-comment">/* 与页状态联动的私有数据： 1. 缓冲区头指针（块设备页） 2. swap entry 值（swap 缓存页） 3. 其他文件系统私有指针 */</span> 
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">mem_cgroup</span> *mem_cgroup; <span class="hljs-comment">/* 该页归属的 memory cgroup，用于资源统计与回收 */</span>
    
<span class="hljs-comment">/* ===== 4. 反向映射 ===== */</span> 
    <span class="hljs-type">atomic_t</span> _mapcount; <span class="hljs-comment">/* 页表项（PTE）映射计数： -1 表示无映射，  0 表示只有 1 个映射(匿名页或单进程文件映射),  &gt;0 表示多进程共享 */</span> 
    
<span class="hljs-comment">/* ===== 5. 复合页 / 巨型页 ===== */</span> 
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> _compound_tail; 复合页（HugeTLB）时，标记本页在巨型页中的序号 
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">page</span> *first_page; 指向巨型页的首页  

<span class="hljs-comment">/* ===== 6. 调试 / 热区 ===== */</span> 
    <span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> WANT_PAGE_VIRTUAL</span>
        <span class="hljs-type">void</span> *<span class="hljs-keyword">virtual</span>;  高端内存页的永久内核映射地址（kmap） 
    <span class="hljs-meta">#<span class="hljs-keyword">endif</span> </span>
};
</code></pre>
<h2 data-id="heading-5">页面缓存对外提供的接口方法</h2>
<p>Linux内核中针对 <code>页面缓存</code> 封装了很多接口方法，下面简单介绍一些</p>
<p><strong>1. 查找一个页(page)</strong></p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">/**
 * find_get_page - 在页面缓存里查找并引用一个页
 * @mapping: 要搜索的 address_space（即“这个文件”的缓存容器）
 * @offset:  页在文件内的逻辑下标（以页为单位，非字节偏移）
 *
 * 在 radix/xarray 树中查找 &lt;mapping, offset&gt; 对应的 slot。
 * 如果命中，则把 page-&gt;_refcount 加 1 后返回该页；
 * 如果未命中，返回 NULL。
 *
 * 调用者必须在持有 RCU 读锁或 mapping-&gt;tree_lock 的前提下使用，
 * 但本函数内部已自行加锁，因此外部无需额外同步。
 */</span>
<span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">struct</span> page *<span class="hljs-title function_">find_get_page</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> address_space *mapping, <span class="hljs-type">pgoff_t</span> offset)</span>{
        直接调用内部实现，后两个 <span class="hljs-number">0</span> 表示不强制分配（FGP_CREAT=<span class="hljs-number">0</span>）、不标记为正在回写（FGP_WRITEBACK=<span class="hljs-number">0</span>）
        <span class="hljs-keyword">return</span> pagecache_get_page(mapping, offset, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
}
</code></pre>
<p><strong>2.增加一个页(page)</strong></p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">/**
 * add_to_page_cache - 把“刚分配好”的一页塞进页面缓存
 * @page:       新页，此时未上锁、未在缓存树中
 * @mapping:    目标 address_space（即“这个文件”的缓存容器）
 * @offset:     页在文件内的逻辑下标（以页为单位）
 * @gfp_mask:   分配 radix/xarray 节点时使用的内存标志
 *
 * 与 add_to_page_cache_locked() 的区别：
 * 本函数假定页是“全新”的，因此可以安全地直接加锁。
 * 如果插入失败（如 offset 处已存在页），则自动清除锁并返回错误码。
 *
 * 成功返回 0，失败返回 -EEXIST 等负错误码。
 */</span>
<span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add_to_page_cache</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> page *page, <span class="hljs-keyword">struct</span> address_space *mapping,  <span class="hljs-type">pgoff_t</span> offset, <span class="hljs-type">gfp_t</span> gfp_mask)</span>{
        <span class="hljs-type">int</span> error;

        __SetPageLocked(page);    <span class="hljs-comment">/* 新页，直接加锁，避免并发 */</span>

        <span class="hljs-comment">/* 真正插入 radix/xarray 树，失败时返回负错误码 */</span>
        error = add_to_page_cache_locked(page, mapping, offset, gfp_mask);
        <span class="hljs-keyword">if</span> (unlikely(error))
                __ClearPageLocked(page); <span class="hljs-comment">/* 插入失败，回滚锁状态 */</span>

        <span class="hljs-keyword">return</span> error;
}
</code></pre>
<p><strong>3.删除一个页(page)</strong>
下面给出符合 Linux 内核编码风格、宽度 80 列的格式化结果，可直接贴回源码树使用。<br/>
（仅调整空白与折行，零逻辑变更）</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">/**
 * delete_from_page_cache - 把页从页面缓存里摘除
 * @page: 要删除的页，调用前必须保证：
 *        1) 页已在缓存中 (page-&gt;mapping != NULL)
 *        2) 页处于 Locked 状态
 *
 * 函数只做两步：
 *  ① 从 radix/xarray 树中移除该索引槽位；
 *  ② 把 page-&gt;mapping 置为 NULL，表示页已脱离缓存。
 *
 * 注意：函数不会释放页本身，也不会把页放进空闲链表——
 * 调用者必须已经持有页引用 (refcount)，并在后续自行 put_page()。
 */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">delete_from_page_cache</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> page *page)</span>{
	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">address_space</span> *<span class="hljs-title">mapping</span> =</span> page-&gt;mapping; <span class="hljs-comment">/* 所属缓存容器 */</span>
	<span class="hljs-type">void</span> *shadow = <span class="hljs-literal">NULL</span>;
	<span class="hljs-type">int</span> nr = <span class="hljs-number">1</span>;                                    <span class="hljs-comment">/* 默认只删 1 个条目 */</span>

	<span class="hljs-comment">/* 1. 从 xarray 中删除该索引，同时拿到 shadow 条目（若存在）*/</span>
	xa_lock_irq(&amp;mapping-&gt;i_pages);
	shadow = xa_erase(&amp;mapping-&gt;i_pages, page-&gt;index);
	xa_unlock_irq(&amp;mapping-&gt;i_pages);

	<span class="hljs-comment">/* 2. 更新缓存计数 */</span>
	<span class="hljs-keyword">if</span> (xa_is_shadow(shadow))
		nr = <span class="hljs-number">0</span>;                                  <span class="hljs-comment">/* shadow 不算真实页 */</span>
	__dec_zone_page_state(page, NR_FILE_PAGES);
	<span class="hljs-keyword">if</span> (PageSwapBacked(page))
		__dec_zone_page_state(page, NR_SHMEM);
	mapping-&gt;nrpages -= nr;

	<span class="hljs-comment">/* 3. 彻底断开页与缓存容器的关联 */</span>
	page-&gt;mapping = <span class="hljs-literal">NULL</span>;
	<span class="hljs-comment">/* 清除页标志，避免后续误用 */</span>
	page_remove_rmap(page, <span class="hljs-literal">false</span>);
	<span class="hljs-comment">/* 如果页还在 LRU 链表上，这里会把它摘下来 */</span>
	<span class="hljs-keyword">if</span> (PageLRU(page))
		lru_cache_del(page);
}
</code></pre>
<h2 data-id="heading-6">再看文件读写(简略)流程</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76428b386b114411b7376193a5d1b208~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Wk55CD546L5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534926&amp;x-signature=o3apIBPBheDiBzUChvzVBcSR2vQ%3D" alt="image.png" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51dea4896e3d439093978a7f7ada516f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Wk55CD546L5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534926&amp;x-signature=47KIYsYnfvp2h1bp%2FVqjk1dNJkU%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-7">什么是脏页？</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3d085cd47d34c74a5ab71059cc37b4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Wk55CD546L5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534926&amp;x-signature=%2BkFUxiQC7p%2FBVbbvpfGuj2J3OXQ%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-8">脏页数据写回到磁盘的方式</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/272e861b32264285817dd657b10689f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Wk55CD546L5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534926&amp;x-signature=%2BMLdlG7IiAL4CFKTdfAE8VUEzCg%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-9">再看内存映射</h2>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span>

<span class="hljs-comment">/*
 * mmap —— 把文件或匿名页映射进当前进程地址空间
 * 返回：成功 → 映射区首地址；失败 → MAP_FAILED((void *)-1)，errno 被设置
 */</span>
<span class="hljs-type">void</span> *<span class="hljs-title function_">mmap</span><span class="hljs-params">(<span class="hljs-type">void</span> *start,     <span class="hljs-comment">/* 期望映射的起始虚拟地址，通常传 NULL 让内核自动挑选 */</span>
           <span class="hljs-type">size_t</span> length,   <span class="hljs-comment">/* 待映射字节数，必须是页大小(4K)整数倍 */</span>
           <span class="hljs-type">int</span> prot,        <span class="hljs-comment">/* 映射区权限位组合：PROT_READ、PROT_WRITE、PROT_EXEC、PROT_NONE */</span>
           <span class="hljs-type">int</span> flags,       <span class="hljs-comment">/* 映射属性 + 行为标志，常用组合：
                             *   MAP_SHARED  – 对映射区的写入会回写文件（共享内存/文件落盘）
                             *   MAP_PRIVATE – 写时复制，不影响原文件（仅本进程可见）
                             *   MAP_ANONYMOUS – 不关联 fd，直接得一块全 0 匿名内存
                             *   MAP_FIXED     – 强制使用 start 地址（危险，需对齐）
                             */</span>
           <span class="hljs-type">int</span> fd,          <span class="hljs-comment">/* 要映射的文件描述符；若 MAP_ANONYMOUS 通常给 -1 */</span>
           <span class="hljs-type">off_t</span> offset)</span>;   <span class="hljs-comment">/* 文件内起始偏移，也必须按页对齐 */</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/efb82201676d4515ac74e72b423d457d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Wk55CD546L5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534926&amp;x-signature=Uvo1DotwF5580OK3hDdXCxDygoA%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-10">内存映射涉及的数据结构</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da39d457d1dd40528a5099e3d4622130~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Wk55CD546L5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534926&amp;x-signature=uZ6OeWfuESU1TOrgbS3hAhaydUU%3D" alt="vma数据结构.png" loading="lazy"/></p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> {</span>
	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> vm_start;		<span class="hljs-comment">/* 内存映射区域起始地址 */</span>
	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> vm_end;		<span class="hljs-comment">/* 内存映射区域结束地址 */</span>
	<span class="hljs-type">pgprot_t</span> vm_page_prot;		<span class="hljs-comment">/* 访问权限 */</span>
	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vm_next</span>, *<span class="hljs-title">vm_prev</span>;</span> <span class="hljs-comment">/* 挂入 mm-&gt;mmap 双向链表 */</span>
	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> <span class="hljs-title">vm_rb</span>;</span>		<span class="hljs-comment">/* 挂入 mm-&gt;mm_rb 红黑树 */</span>
	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> vm_pgoff;		<span class="hljs-comment">/* 以页为单位的文件内偏移 */</span>
	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">vm_file</span>;</span>		<span class="hljs-comment">/* 被映射的文件（MAP_ANONYMOUS 时 NULL） */</span>
	<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_operations_struct</span> *<span class="hljs-title">vm_ops</span>;</span> <span class="hljs-comment">/* vma 操作钩子 */</span>
	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">anon_vma</span> *<span class="hljs-title">anon_vma</span>;</span>	<span class="hljs-comment">/* 匿名页反向映射 */</span>
        
	<span class="hljs-comment">/* --- 以下来自 anon_vma 内部，图中混贴，已拆出 --- */</span>
	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> <span class="hljs-title">rb</span>;</span>		<span class="hljs-comment">/* anon_vma-&gt;rb_root 上的节点 */</span>
        
	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rb_subtree_last;	<span class="hljs-comment">/* 子树中最大地址 */</span>
    <span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_ANON_VMA</span>
	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> shared;		<span class="hljs-comment">/* 引用计数或共享标志 */</span>
    <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
};
</code></pre>
<p>如需完整内核定义，请直接参考 <code>linux/mm_types.h</code>。</p>
<h3 data-id="heading-11">内存映射涉及的大体流程</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e69c7d6ceb3649399fc755e439726230~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Wk55CD546L5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534926&amp;x-signature=oyeHcyd%2B%2BsYOG%2F12mAcstSn911Y%3D" alt="内存映射1.png" loading="lazy"/></p>
<h2 data-id="heading-12">再看缺页异常大体流程</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84428559c3ce40398cbb636bdd46b03a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Wk55CD546L5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534926&amp;x-signature=z%2B5wDcS1U8%2B7YmUl2pCLjA6ELoo%3D" alt="缺页异常.png" loading="lazy"/></p>
<h2 data-id="heading-13">按需调页</h2>
<p>我们的软件程序一般都被打包到 <code>ELF</code> 文件中
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9ac4248a9b04eeb80de8bdf3f7f7036~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Wk55CD546L5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534926&amp;x-signature=h4aTS667wFBnSxekYX3qt7uEuHA%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3eda04e0ac654e989fe395464dc0b2d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Wk55CD546L5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534926&amp;x-signature=jCYjue4kIQH1sMisOdKtZOoQNLw%3D" alt="按需分页1.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed57afc6f69744ef92d336b737044c67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Wk55CD546L5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534926&amp;x-signature=gE%2BzqJLduInMB4LCbCcdSIG4jVg%3D" alt="按需分页2.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vite+Antd+Micro-app中iframe模式下样式闪烁的问题]]></title>    <link>https://juejin.cn/post/7592997693070180362</link>    <guid>https://juejin.cn/post/7592997693070180362</guid>    <pubDate>2026-01-09T08:08:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592997693070180362" data-draft-id="7592996072706064434" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vite+Antd+Micro-app中iframe模式下样式闪烁的问题"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-09T08:08:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="bieao"/> <meta itemprop="url" content="https://juejin.cn/user/1011206430917710"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vite+Antd+Micro-app中iframe模式下样式闪烁的问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1011206430917710/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    bieao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T08:08:21.000Z" title="Fri Jan 09 2026 08:08:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>在<code>Vite</code>中使用<code>Micro-app</code>进行微前端开发，做的过程中发现在<code>iframe</code>模式下，无论是首屏加载还是中间的路由切换都会出现<code>antd</code>样式闪烁</strong>；具体如下：</p>
<ol>
<li>按钮的样式从最初始状态变为<code>Antd</code>的<code>Button</code>样式，有颜色改变时，最为明显</li>
<li>输入框由<code>input</code>初始样式变为<code>Antd</code>的样式</li>
<li>所有的<code>Antd</code>组件都是从浏览器的默认样式加载为<code>Antd</code>的样式</li>
</ol>
<p>解决历程</p>
<ol>
<li><strong>既然是样式后加载，那么是否可以进行样式预设，当<code>Antd</code>样式加载时，就不会出现明显的闪烁</strong></li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// index.html</span>
&lt;!-- iframe 模式：预设关键样式，避免 <span class="hljs-variable constant_">FOUC</span> --&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
      <span class="hljs-comment">/* 预设主题色，避免按钮颜色闪烁 */</span>
      <span class="hljs-selector-class">.ant-btn-primary</span> {
        <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#7470e9</span>;
        <span class="hljs-attribute">border-color</span>: <span class="hljs-number">#7470e9</span>;
        <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
      }

      <span class="hljs-selector-class">.ant-input</span> {
        <span class="hljs-attribute">height</span>: <span class="hljs-number">40px</span>;
        <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>;
        <span class="hljs-attribute">padding</span>: <span class="hljs-number">6.5px</span> <span class="hljs-number">11px</span>;
        <span class="hljs-attribute">border-width</span>: <span class="hljs-number">1px</span>;
        <span class="hljs-attribute">border-style</span>: solid;
        <span class="hljs-attribute">border-color</span>: <span class="hljs-number">#d9d9d9</span>;
        <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">6px</span>;
      }

      <span class="hljs-selector-class">.ant-btn</span> {
        <span class="hljs-attribute">border-width</span>: <span class="hljs-number">1px</span>;
      }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
</code></pre>
<p><strong>解决效果：肉眼可见的闪烁没有了，但是缺点也很明显，就是需要把用到的所有的<code>Antd</code>组件的基础样式或者叫引起明显抖动的样式预设，避免明显抖动</strong></p>
<ol start="2">
<li><strong>仿照<code>Antd</code>给<code>Next.js</code>做的<code>@ant-design/nextjs-registry</code>库，来解决提前加载样式的问题</strong></li>
</ol>
<p><code>@ant-design/nextjs-registry</code>是如何解决在<code>Next.js</code>中首屏加载时闪烁的问题，是在<code>Next.js</code>渲染组件时，使用<code>@ant-design/cssinjs</code>提供的<code>const styles = extractStyle(cache, true)</code>能力</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-string">'use client'</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">AntdRegistry</span> = (<span class="hljs-params">{ children }</span>) =&gt; {
  <span class="hljs-title function_">useServerInsertedHTML</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 在服务端渲染时执行</span>
    <span class="hljs-keyword">const</span> styleText = <span class="hljs-title function_">extractStyle</span>(cache, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">dangerouslySetInnerHTML</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">__html:</span> <span class="hljs-attr">styleText</span> }} /&gt;</span></span>;
  });

  <span class="hljs-keyword">return</span> <span class="xml"><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">StyleProvider</span> <span class="hljs-attr">cache</span>=<span class="hljs-string">{cache}</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">StyleProvider</span>&gt;</span></span></span>;
};
</code></pre>
<p>将含<code>Antd</code>的<code>HTML</code>代码全部发给浏览器，这样渲染的时候就不会出现样式闪烁，<strong>但是</strong>这个是<code>Next.js</code>的<strong>专属能力</strong>，<code>CSR</code>(客户端渲染)的做不到，因为<code>Antd</code>的组件样式是在加载组件时才会放到<code>cache</code>中，也就是说在<code>App.tsx</code>中使用下面的代码包括，是没有用的</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 在客户端挂载时执行</span>
    <span class="hljs-keyword">const</span> styleText = <span class="hljs-title function_">extractStyle</span>(cache, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">const</span> styleElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'style'</span>);
    styleElement.<span class="hljs-property">textContent</span> = styleText;
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-title function_">insertBefore</span>(styleElement, <span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-property">firstChild</span>);
  }, []);
</code></pre>
<p>这个代码在执行时<code>styleText</code>啥也没有，加载组件在<code>useEffect</code>之后，<strong>此时我们已经很接近真相了</strong></p>
<ol start="3">
<li><strong>我发现一个现象，在<code>SPA</code>页面中，样式只会在首屏时闪烁，进入其他页面后，并没有闪烁，已加载的样式被缓存了，查询之后，发现是<code>Antd</code>的<code>cache</code>在做缓存判断，然后我查看了子应用的样式发现<code>Micro-app</code>给每个样式否加了前缀<code>micro-app[name=hospital-gateway]</code></strong></li>
</ol>
<pre><code class="hljs language-css" lang="css">micro-app<span class="hljs-selector-attr">[name=hospital-gateway]</span> ._hospital-search-wrapper_v077x_1 ._search-operate_v077x_5 <span class="hljs-selector-tag">button</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
    <span class="hljs-attribute">margin-left</span>: <span class="hljs-number">8px</span>;
}
</code></pre>
<p>这个前缀导致了<code>Antd</code>的<code>cache</code>失效，而且每次路由切换时，<code>Micro-app</code>都会将<code>Antd</code>原来的样式重写为有<code>micro-app[name=hospital-gateway]</code>前缀的样式，这就是导致每次样式抖动的根本原因。</p>
<ol start="4">
<li><strong>找到根源后，就看如何去掉这个前缀，<code>iframe</code>模式下，样式是天然隔离的，是不需要类似<code>with</code>模式下的样式前缀的，而且去掉前缀，也可以启用<code>Antd</code>的样式缓存，避免切换路由时的样式抖动，最后发现在添加<code>disable-scopecss属性</code>就可以去掉自动添加的前缀</strong></li>
</ol>
<pre><code class="hljs language-js" lang="js">&lt;micro-app name={name} url={url} baseroute keep-alive disable-scopecss /&gt;
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[保姆级教程：让 Cursor 编辑器突破地区限制，正常调用大模型（附配置 + 截图）]]></title>    <link>https://juejin.cn/post/7592882393252315179</link>    <guid>https://juejin.cn/post/7592882393252315179</guid>    <pubDate>2026-01-09T08:07:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592882393252315179" data-draft-id="7592882393252134955" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="保姆级教程：让 Cursor 编辑器突破地区限制，正常调用大模型（附配置 + 截图）"/> <meta itemprop="keywords" content="Cursor,前端,后端"/> <meta itemprop="datePublished" content="2026-01-09T08:07:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="袋鱼不重"/> <meta itemprop="url" content="https://juejin.cn/user/3611263333042152"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            保姆级教程：让 Cursor 编辑器突破地区限制，正常调用大模型（附配置 + 截图）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3611263333042152/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    袋鱼不重
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T08:07:35.000Z" title="Fri Jan 09 2026 08:07:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Cursor 的大模型功能目前暂不支持中国地区直接访问，导致很多开发者打开后显示 “模型加载失败”。今天分享亲测有效的配置方法，帮你突破地区限制，丝滑使用 Opus、GPT 等模型～</p>
<h2 data-id="heading-0">一、准备工作</h2>
<p>先确保你的代理工具（如 Clash、V2ray 等）已正常运行，且本地代理端口为 <code>7897</code>（若你的代理端口不同，后续配置需对应修改）。</p>
<h2 data-id="heading-1">二、配置 Cursor 代理（带步骤图）</h2>
<h3 data-id="heading-2">步骤 1：打开 Cursor 设置界面</h3>
<ul>
<li>点击 Cursor 左上角「文件 (F)」菜单</li>
<li>鼠标移到「选项」，在子菜单中选择「设置」（快捷键：<code>Ctrl+,</code>）（对应步骤图 1 的「文件」→「选项」→「设置」）</li>
</ul>
<p>也可以直接点右上角「...」按钮，选「打开设置 (json)」（对应步骤图 2）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/467cb09f8fc24cbd8b8856102b89a2ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKL6bG85LiN6YeN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768550855&amp;x-signature=EKjUNknzFGhb%2B9yteKBg%2F0c9rO0%3D" alt="image.png" loading="lazy"/></p>
<p align="center">步骤图1</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6f334c5501c4f559495b6354a69ee58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKL6bG85LiN6YeN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768550855&amp;x-signature=GFTc5I8T8NaLCyD2Q5HNEQOM55g%3D" alt="img_v3_02tp_919fb41f-2117-4098-b521-a64df7ce741g.jpg" loading="lazy"/></p>
<p align="center">步骤图2</p>
<h3 data-id="heading-3">步骤 2：添加地区解锁配置</h3>
<p>在<code>settings.json</code>中粘贴以下代码（直接复制即可，对应步骤图 3 红框区域，注意 JSON 格式的逗号分隔）</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"http.proxy"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://127.0.0.1:7897"</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">"http.proxySupport"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"override"</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">"http.noProxy"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">"cursor.general.disableHttp2"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">"http.proxyStrictSSL"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4470c68543f64b13873bc4807b61d845~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKL6bG85LiN6YeN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768550855&amp;x-signature=CBWL9mLy1fsb5xM0wDD81FmvfiU%3D" alt="image.png" loading="lazy"/></p>
<p align="center">步骤图3</p>
<p>保存配置，此时点击模型选择菜单（步骤图 4），就能正常加载 Opus、GPT-4 等模型了～</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4dcaff26cb5148b6844b0368f9a7be0a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKL6bG85LiN6YeN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768550855&amp;x-signature=Q2YDWd55Xe%2FmvGOg8sNxMhjmWxs%3D" alt="img_v3_02tp_2e44b001-fe13-41cb-8ca6-b4321679ac5g.jpg" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[生产环境的log，上传到开发者的本地服务器]]></title>    <link>https://juejin.cn/post/7593164154630963209</link>    <guid>https://juejin.cn/post/7593164154630963209</guid>    <pubDate>2026-01-09T08:11:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593164154630963209" data-draft-id="7593015632082780187" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="生产环境的log，上传到开发者的本地服务器"/> <meta itemprop="keywords" content="JavaScript,Python"/> <meta itemprop="datePublished" content="2026-01-09T08:11:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="江湖yi山人"/> <meta itemprop="url" content="https://juejin.cn/user/325111174934647"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            生产环境的log，上传到开发者的本地服务器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/325111174934647/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    江湖yi山人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T08:11:14.000Z" title="Fri Jan 09 2026 08:11:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前景</h2>
<p>开发者想掌握生产环境的一些日志，但是又不需要添加实际的埋点进行上报，这个时候就需要将日志上传到开发者的本地</p>
<h2 data-id="heading-1">思路</h2>
<p>启动本地服务的某一个端口用作数据的接收，然后在代码中调用这个服务上传日志</p>
<h2 data-id="heading-2">实现</h2>
<h3 data-id="heading-3">1 启动本地服务</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">#!/usr/bin/env python3</span>
<span class="hljs-string">"""
HTTP 日志接收服务器
将发送到 http://IP:PORT/h5/log 的 POST 请求数据，保存到 ./h5/log 目录下的文件中。
"""</span>
<span class="hljs-keyword">from</span> http.server <span class="hljs-keyword">import</span> HTTPServer, BaseHTTPRequestHandler
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> json

<span class="hljs-comment"># 配置</span>
IP = <span class="hljs-string">'xxx.xxx'</span> <span class="hljs-comment"># 本地服务ip</span>
PORT = xxxx <span class="hljs-comment"># 服务端口</span>
SAVE_DIR = <span class="hljs-string">'./h5/log'</span>  <span class="hljs-comment"># 日志保存目录，相对于脚本所在路径</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">LogHandler</span>(<span class="hljs-title class_ inherited__">BaseHTTPRequestHandler</span>):
    <span class="hljs-comment"># 通用方法用于设置CORS头部</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_set_cors_headers</span>(<span class="hljs-params">self</span>):
        self.send_header(<span class="hljs-string">'Access-Control-Allow-Origin'</span>, <span class="hljs-string">'*'</span>)  <span class="hljs-comment"># 允许所有来源，可按需替换</span>
        self.send_header(<span class="hljs-string">'Access-Control-Allow-Methods'</span>, <span class="hljs-string">'GET, POST, OPTIONS'</span>)
        self.send_header(<span class="hljs-string">'Access-Control-Allow-Headers'</span>, <span class="hljs-string">'Content-Type, Authorization'</span>)
    
    <span class="hljs-comment"># 处理浏览器发送的OPTIONS预检请求</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">do_OPTIONS</span>(<span class="hljs-params">self</span>):
        self.send_response(<span class="hljs-number">200</span>)
        self._set_cors_headers()
        self.end_headers()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">do_POST</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 只处理 /h5/log 路径的请求</span>
        <span class="hljs-keyword">if</span> self.path == <span class="hljs-string">'/h5/log'</span>:
            <span class="hljs-comment"># 1. 读取请求数据</span>
            content_length = <span class="hljs-built_in">int</span>(self.headers.get(<span class="hljs-string">'Content-Length'</span>, <span class="hljs-number">0</span>))
            post_data = self.rfile.read(content_length)

            <span class="hljs-comment"># 2. 确保保存目录存在</span>
            os.makedirs(SAVE_DIR, exist_ok=<span class="hljs-literal">True</span>)

            <span class="hljs-comment"># 3. 生成带时间戳的日志文件名</span>
            filename = datetime.now().strftime(<span class="hljs-string">'log_%Y-%m-%d.txt'</span>)
            filepath = os.path.join(SAVE_DIR, filename)

            <span class="hljs-comment"># 4. 将数据写入文件（追加模式）</span>
            <span class="hljs-keyword">try</span>:
                <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(filepath, <span class="hljs-string">'a'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:
                    <span class="hljs-comment"># 写入当前时间</span>
                    f.write(<span class="hljs-string">f"[<span class="hljs-subst">{datetime.now().strftime(<span class="hljs-string">'%Y-%m-%d %H:%M:%S'</span>)}</span>]\n"</span>)
                    <span class="hljs-comment"># 尝试解析并美化JSON，如果是普通文本则直接写入</span>
                    <span class="hljs-keyword">try</span>:
                        data_obj = json.loads(post_data.decode(<span class="hljs-string">'utf-8'</span>))
                        f.write(json.dumps(data_obj, ensure_ascii=<span class="hljs-literal">False</span>, indent=<span class="hljs-number">2</span>))
                    <span class="hljs-keyword">except</span> json.JSONDecodeError:
                        f.write(post_data.decode(<span class="hljs-string">'utf-8'</span>))
                    f.write(<span class="hljs-string">'\n'</span> + <span class="hljs-string">'-'</span>*<span class="hljs-number">50</span> + <span class="hljs-string">'\n'</span>)  <span class="hljs-comment"># 分隔线</span>

                <span class="hljs-comment"># 5. 返回成功响应</span>
                self.send_response(<span class="hljs-number">200</span>)
                self._set_cors_headers()
                self.send_header(<span class="hljs-string">'Content-type'</span>, <span class="hljs-string">'application/json'</span>)
                self.end_headers()
                response = {<span class="hljs-string">'status'</span>: <span class="hljs-string">'success'</span>, <span class="hljs-string">'message'</span>: <span class="hljs-string">f'Log saved to <span class="hljs-subst">{filepath}</span>'</span>}
                self.wfile.write(json.dumps(response).encode(<span class="hljs-string">'utf-8'</span>))

            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                self.send_error(<span class="hljs-number">500</span>, <span class="hljs-string">f'Failed to save log: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>'</span>)
        <span class="hljs-keyword">else</span>:
            self.send_error(<span class="hljs-number">404</span>, <span class="hljs-string">'Not Found'</span>)

    <span class="hljs-comment"># 可选：处理GET请求，方便测试</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">do_GET</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">if</span> self.path == <span class="hljs-string">'/h5/log'</span>:
            self.send_response(<span class="hljs-number">200</span>)
            self._set_cors_headers()
            self.send_header(<span class="hljs-string">'Content-type'</span>, <span class="hljs-string">'text/html; charset=utf-8'</span>)
            self.end_headers()
            message = <span class="hljs-string">f"""
            &lt;html&gt;&lt;body&gt;
            &lt;h2&gt;日志接收服务器运行中&lt;/h2&gt;
            &lt;p&gt;服务端时间：<span class="hljs-subst">{datetime.now()}</span>&lt;/p&gt;
            &lt;p&gt;日志保存目录：<span class="hljs-subst">{os.path.abspath(SAVE_DIR)}</span>&lt;/p&gt;
            &lt;p&gt;请使用 POST 方法向此地址发送数据以保存日志。&lt;/p&gt;
            &lt;/body&gt;&lt;/html&gt;
            """</span>
            self.write(message.encode(<span class="hljs-string">'utf-8'</span>))
        <span class="hljs-keyword">else</span>:
            self.send_error(<span class="hljs-number">404</span>, <span class="hljs-string">'Not Found'</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">log_message</span>(<span class="hljs-params">self, <span class="hljs-built_in">format</span>, *args</span>):
        <span class="hljs-comment"># 可选：自定义请求日志，此处简单打印到控制台</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[<span class="hljs-subst">{datetime.now().strftime(<span class="hljs-string">'%Y-%m-%d %H:%M:%S'</span>)}</span>] <span class="hljs-subst">{self.address_string()}</span> -&gt; <span class="hljs-subst">{self.command}</span> <span class="hljs-subst">{self.path}</span>"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    server = HTTPServer((IP, PORT), LogHandler)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[*] 日志服务器已启动，正在监听 http://<span class="hljs-subst">{IP}</span>:<span class="hljs-subst">{PORT}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[*] 请将 POST 请求发送至 http://<span class="hljs-subst">{IP}</span>:<span class="hljs-subst">{PORT}</span>/h5/log"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[*] 日志文件将保存至：<span class="hljs-subst">{os.path.abspath(SAVE_DIR)}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"[*] 按 Ctrl+C 停止服务器\n"</span>)
    <span class="hljs-keyword">try</span>:
        server.serve_forever()
    <span class="hljs-keyword">except</span> KeyboardInterrupt:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n[*] 服务器正在关闭..."</span>)
        server.server_close()
</code></pre>
<p>将代码copy下来保存为log_server.py，然后在同级目录下运行，即可启动本地端口</p>
<pre><code class="hljs language-powershell" lang="powershell">python3 log_server.py
</code></pre>
<p>结果如图表示启动成功
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6f83108f5ad47e38a214a84ef38b211~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5rmWeWnlsbHkuro=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768551073&amp;x-signature=O%2B3eUKU2U5Vpuo6kqBq0QiVRYrM%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">2 封装上传方法</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">logLocal</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-keyword">const</span> href = <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>
  <span class="hljs-keyword">if</span> (!href.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'https://test'</span>)) <span class="hljs-keyword">return</span> <span class="hljs-comment">// 仅测试环境使用</span>
  <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'http://IP:PORT/h5/log'</span>, { <span class="hljs-comment">// IP-本地IP，PORT-进行监听的接口</span>
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>
    },
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
      <span class="hljs-attr">url</span>: href,
      ...data
    })
  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> {})
}
</code></pre>
<h3 data-id="heading-5">3 上传数据</h3>
<p>在js代码中的需要位置调用logLocal</p>
<pre><code class="hljs language-javascript" lang="javascript">...
<span class="hljs-title function_">logLocal</span>({ <span class="hljs-attr">msg</span>: <span class="hljs-string">'这是个测试log'</span> })
...
</code></pre>
<h3 data-id="heading-6">4 查看日志</h3>
<p>在log_server.py脚本的同级目录下，打开h5/log的文件夹，找到log_{date}.txt，打开后如下图，url和需要上报的信息上传成功</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d501268cbcfb48758d584ac914ae1ad7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5rmWeWnlsbHkuro=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768551073&amp;x-signature=Q2nO%2F%2BMpVHqUpXCpp2T1sSa2hqI%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[码上星辰，人间烟火：我的2025]]></title>    <link>https://juejin.cn/post/7592887786967072804</link>    <guid>https://juejin.cn/post/7592887786967072804</guid>    <pubDate>2026-01-09T07:23:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592887786967072804" data-draft-id="7592921639464501290" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="码上星辰，人间烟火：我的2025"/> <meta itemprop="keywords" content="前端,代码规范,程序员"/> <meta itemprop="datePublished" content="2026-01-09T07:23:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="zhouzhouya"/> <meta itemprop="url" content="https://juejin.cn/user/3931509312987511"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            码上星辰，人间烟火：我的2025
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3931509312987511/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    zhouzhouya
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T07:23:27.000Z" title="Fri Jan 09 2026 07:23:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">开篇</h2>
<p>2025年就这么过去了。说实话，站在12月的尾巴上往回看，感觉时间就像被按了1.5倍速，上一秒还在为某个的需求发愁，下一秒已经在写年终总结了。</p>
<p>这一年挺有意思的。工作上，我从一个埋头写代码的前端，开始学着抬头看路；生活里，我也在和那些“程序员职业病”斗智斗勇，试着在键盘之外，找回生活的实感。</p>
<h3 data-id="heading-1">租房记：漂泊中的顿悟</h3>
<p>作为一个老北漂，也是没想到这种事情发生在自己的身上。年初决定换房时，我曾天真地以为这不过是和以前一样是一次轻松的"房屋大冒险"。春日的阳光透过玻璃窗洒在脸上，我哼着歌在租房平台滑动屏幕，幻想着新家的落地窗和飘窗上的绿植。那时的我尚未意识到，这次租房会以两次被放鸽子开场，在愤怒与失望中揭开生活最真实的租房市场。</p>
<p>第一次被鸽是在周三一个晚睡的深夜。约好看房签约的女孩发微信告诉我不转租了，望理解，没原因，没解释，直接拉黑删除我。此时我还没有很大的情绪波动，毕竟房子那么多，租房而已，再找就是了。</p>
<p>连着几个周末看房找房，别说中介烦不烦，我是蛮劳累。</p>
<p>终于在同小区找到了合适的房子，约好周六下午签约，然而随之而来的就是被二次被鸽。周六上午我和老公早早起来打包好所有的物品，就等着签约后立即搬家，然后房东迟迟不来签约，我就意识到了不妙，果然女人的第六感就是准，打了房东电话告知我不租了，亲戚家的孩子要来住。这对于收拾了一上午的我来说顿感晴天霹雳，愤怒怨恨充斥整个房间。</p>
<p>不过最终原房东听过我的经历之后，给我们降租金让我们继续续租，这也算是一点点安慰吧。</p>
<p>其实那会儿，我心里头渐渐萌生出想在北京买房的念头。想象着要是能有一套属于自己的房子，那该多踏实。可现实很快就给我泼了冷水——北京的房子，哪是那么好买的呀。</p>
<p>首当其冲的就是总价高得吓人。随便一套小户型，动辄几百万。再就是户口问题，没有北京户口，未来有宝宝后孩子的上学也是个大问题。</p>
<p>更让我犹豫的是，房价跟坐滑梯似的，几十万甚至上百万地往下降。身边朋友都在说，现在绝不是入手的好时机，万一买了又跌，几年白干。每次听到这些，我心里就直打鼓，买房的念头也跟着动摇起来。</p>
<p>但转念一想，虽然现在还不能买，可存钱总是没错的。每个月发了工资，第一件事就是存一部分起来，看着银行卡里的数字慢慢往上涨，心里也是开心的。说不定哪天，时机成熟了，我就能在这座城市里，有一个真正属于自己的小窝呢。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3149a487f0fa4b11afe2138b919ba334~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgemhvdXpob3V5YQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768551461&amp;x-signature=5DpIhec%2BKAQAbAE9JZ4m6vHbabY%3D" alt="image.png" loading="lazy"/></p>
<br/>
<h3 data-id="heading-2">工作成长：从简单执行到主动深耕，借AI东风重构代码新篇</h3>
<p>在工作中，AI的出现让我经历了显著的蜕变，最为突出的便是主动性的大幅增强。这种转变并非一蹴而就，而是体现在日常工作的每一个细微之处。过去，我完成任务的标准仅仅是“做完这个需求”，满足于交付基本功能，对代码的质量和项目的长远发展缺乏深入思考。然而，随着工作经验的积累和自我要求的提升，我逐渐将目标转变为“做好这个需求”，力求在功能实现的基础上，追求代码的简洁性、可维护性和高性能。</p>
<p>这种转变带来的影响是深远的。它让我以更严谨的态度对待每一行代码，不再满足于简单的“能用”，而是追求“好用且耐用”。我开始主动研究代码架构的优化，思考如何让代码逻辑更加清晰，减少冗余，提高代码的复用性。这种对代码质量的执着追求，不仅提升了项目的整体性能，也为我后续的工作奠定了坚实的基础。</p>
<p>今年，我承担了一项极具挑战性的任务——对整个项目的代码进行重构。这一决策的背后，既有我内心渴望承担更多责任、挑战自我的驱动力，也离不开外部技术环境的启发。近年来，AI 技术如雨后春笋般蓬勃发展，其强大的能力和广泛的应用让我深刻认识到代码规范及性能的重要性。说实话，这次重构，有50%的功劳属于AI的。</p>
<ul>
<li>这里要给TRAE打个小广告了，由于自己想用但不想花太多钱，最终选择了性价比较高的TRAE，目前用起来是完全能满足我日常开发需求的。</li>
</ul>
<p>除去这些，我也会主动承担一些工作外的事情，帮助别人解决一些问题等。以后也要继续保持这份热情和动力，不断提升自己的能力，贡献更多的力量。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b918902ba113467ba05c62bc92c8580f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgemhvdXpob3V5YQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768551461&amp;x-signature=R1yTjPtpuW%2BbuJuPN0CP4VZGMA4%3D" alt="image.png" loading="lazy"/></p>
<br/>
<h3 data-id="heading-3">2026年目标</h3>
<p>2026年，把想做的事，一步步变成正在做的事、已经做完的事。</p>
<h4 data-id="heading-4">1️⃣ <strong>财务计划</strong></h4>
<p>存钱：</p>
<ul>
<li>每月固定存入，直到达到目标金额。</li>
<li>目标：通过掘金AIDP兼职攒一笔“韩国旅行”的专项资金。</li>
</ul>
<h4 data-id="heading-5">2️⃣ <strong>体验清单：把“想去”变成“去过”</strong></h4>
<p>用行动兑现对自己的承诺：</p>
<ul>
<li><strong>韩国之旅</strong>：25年办的护照不能只躺在抽屉里，计划在淡季安排一次四天三晚的首尔/济州岛自由行。</li>
<li><strong>滑雪初体验</strong>：看完《骄阳似我》，感觉滑雪好帅，我也要去学滑雪</li>
</ul>
<h4 data-id="heading-6">3️⃣ <strong>专业认证：补上去年落下的flag</strong></h4>
<p><strong>软考中级</strong>不能再拖了：</p>
<ul>
<li>一季度前确定报考方向（系统架构/软件设计）</li>
<li>加入学习小组，按计划推进，每周投入6小时</li>
<li>最晚Q3完成考试，这次不再“下次一定”</li>
</ul>
<h4 data-id="heading-7">4️⃣ <strong>语言持续：让英语成为习惯，而非任务</strong></h4>
<ul>
<li>工作日每天20分钟听力/阅读（通勤时间利用）</li>
<li>年底前能无字幕看完一部喜欢的英文剧集</li>
</ul>
<h3 data-id="heading-8">2026年的核心词是：<strong>兑现</strong>。</h3>
<p>不再让目标只停留在“想”的层面，而是要把那些对生活的向往、对职业的规划、对自己的承诺，一步步转化为具体可执行的计划，并<strong>让时间看得见结果</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java 中的 AI 与机器学习：TensorFlow、DJL 与企业级 AI]]></title>    <link>https://juejin.cn/post/7593015632082894875</link>    <guid>https://juejin.cn/post/7593015632082894875</guid>    <pubDate>2026-01-09T08:17:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593015632082894875" data-draft-id="7593015632082862107" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java 中的 AI 与机器学习：TensorFlow、DJL 与企业级 AI"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-09T08:17:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="信码由缰"/> <meta itemprop="url" content="https://juejin.cn/user/2110664941509214"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java 中的 AI 与机器学习：TensorFlow、DJL 与企业级 AI
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2110664941509214/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    信码由缰
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T08:17:23.000Z" title="Fri Jan 09 2026 08:17:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 引言：Java 意外的机器学习复兴</h2>
<p>尽管 Python 主导了机器学习的研究与实验，但生产部署讲述着不同的故事。截至 2025 年，68% 的应用程序运行在 Java 或 JVM 上，那些已在 Java 生态系统投入巨资的企业面临一个关键问题：是重新培训团队并重写系统，还是将机器学习能力引入 Java？答案正日益倾向于后者。</p>
<p><img src="https://cf-blog.icodebuddy.com/image/102/102-0.png" alt="" loading="lazy"/></p>
<p>Netflix 使用 Deep Java Library 进行分布式深度学习实时推理，通过字符级 CNN 和通用句子编码器模型处理日志数据，每个事件的延迟为 7 毫秒。这代表了一个更广泛的趋势——尽管 Python 在训练方面占主导地位，但 Java 在生产系统、多线程、稳定性和企业集成方面的优势，使其在机器学习部署上极具吸引力。</p>
<p>本文探讨 Java 在机器学习生命周期中的角色，比较各种框架，探索与 Python 生态系统的集成模式，并识别 Java 提供明显优势的场景。</p>
<p><img src="https://cf-blog.icodebuddy.com/image/102/102-1_cn.png" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">2. Java ML 框架对比</h2>
<h3 data-id="heading-2">2.1 Deep Java Library：引擎无关的方案</h3>
<p>Deep Java Library 是一个开源的、高层次的、引擎无关的 Java 深度学习框架，它提供原生 Java 开发体验，功能如同任何其他常规 Java 库。由 AWS 创建的 DJL，其架构理念以抽象为核心——开发者编写一次代码，即可在 PyTorch、TensorFlow、MXNet 或 ONNX Runtime 之间切换而无需修改。</p>
<p>该框架由五层架构组成。高层 API 层提供符合 Java 习惯的接口，供开发者直接交互。引擎抽象层与底层框架通信，隐藏实现差异。NDManager 管理表示张量的 NDArray 的生命周期，在处理后自动释放张量内存以防止泄漏或崩溃。数据处理层提供为模型准备数据的实用工具。最后，原生引擎层通过对 C++ 实现的 JNA 调用执行实际计算。</p>
<p>DJL 与 TensorFlow、PyTorch、MXNet 等各种深度学习框架无缝集成，提供一个高层次 API 以便于在 Java 环境中轻松构建、训练和部署模型，并且与 AWS 服务紧密集成。其 Model Zoo 提供了来自 GluonCV、HuggingFace、TorchHub 和 Keras 的 70 多个预训练模型，支持单行命令加载模型。</p>
<p><strong>优势：</strong></p>
<ul>
<li>
<p><strong>引擎灵活性</strong>：允许根据部署需求切换后端（研究模型用 PyTorch，生产用 MXNet，跨平台用 ONNX）。</p>
</li>
<li>
<p><strong>原生多线程支持</strong>：与 Akka、Akka Streams 及并发 Java 应用程序自然集成。</p>
</li>
<li>
<p><strong>自动 CPU/GPU 检测</strong>：无需配置即可确保最佳硬件利用率。</p>
</li>
<li>
<p><strong>通过 DJL Spring starters 集成 Spring Boot</strong>：简化企业采用。</p>
</li>
</ul>
<p><strong>局限：</strong></p>
<ul>
<li>
<p><strong>训练功能存在，但不如推理功能成熟</strong>。</p>
</li>
<li>
<p><strong>文档侧重于推理而非训练工作流</strong>。</p>
</li>
<li>
<p><strong>社区规模小于 Python 优先的框架</strong>。</p>
</li>
</ul>
<h3 data-id="heading-3">2.2 Deeplearning4j：JVM 原生解决方案</h3>
<p>Eclipse Deeplearning4j 是为 Java 虚拟机编写的编程库，是一个广泛支持深度学习算法的框架，包括受限玻尔兹曼机、深度信念网络、深度自动编码器、堆叠降噪自动编码器、递归神经张量网络、word2vec、doc2vec 和 GloVe 的实现。</p>
<p>DL4J 于 2014 年问世，目标客户是已投入 Java 基础设施的企业。Eclipse Deeplearning4j 项目包括 Samediff（一个类似 TensorFlow/PyTorch 的框架，用于执行复杂计算图）、Python4j（一个 Python 脚本执行框架，用于将 Python 脚本部署到生产环境）、Apache Spark 集成以及 Datavec（一个将原始输入数据转换为张量的数据转换库）。</p>
<p>该框架的分布式计算能力使其区别于其他方案。Deeplearning4j 包含与 Apache Hadoop 和 Spark 集成的分布式并行版本。对于处理大规模数据的组织，DL4J 提供了无需 Python 依赖的原生 JVM 解决方案。</p>
<p><strong>优势：</strong></p>
<ul>
<li>
<p><strong>完整的 ML 生命周期支持</strong>——训练、推理和部署完全在 Java 中完成。</p>
</li>
<li>
<p><strong>分布式训练</strong>：使用 Spark 或 Hadoop 在集群中扩展。</p>
</li>
<li>
<p><strong>ND4J</strong> 提供支持 GPU 加速的、类似 NumPy 的 n 维数组。</p>
</li>
<li>
<p><strong>SameDiff</strong> 提供类似 TensorFlow 的“先定义后运行”图执行方式。</p>
</li>
<li>
<p><strong>Keras 模型导入</strong>：支持 h5 文件，包括 tf.keras 模型。</p>
</li>
</ul>
<p><strong>局限：</strong></p>
<ul>
<li>
<p>文档和社区资源落后于 TensorFlow 和 PyTorch。</p>
</li>
<li>
<p>与高层次框架相比学习曲线更陡峭。</p>
</li>
<li>
<p>采用范围较窄，主要集中在重度使用 Java 的企业。</p>
</li>
</ul>
<h3 data-id="heading-4">2.3 TensorFlow Java：官方但功能有限</h3>
<p>TensorFlow Java 可在任何 JVM 上运行以构建、训练和部署机器学习模型，支持 CPU 和 GPU 在图模式或即时执行模式下的运行，并提供了在 JVM 环境中使用 TensorFlow 的丰富 API。作为 TensorFlow 的官方 Java 绑定，它提供了对 TensorFlow 计算图执行的直接访问。</p>
<p>TensorFlow 的 Java 语言绑定已移至其独立的代码库，以便独立于官方 TensorFlow 版本进行演进和发布，大多数构建任务已从 Bazel 迁移到 Maven。这种分离允许在不等待 TensorFlow 核心发布的情况下进行 Java 特定的改进。</p>
<p><strong>优势：</strong></p>
<ul>
<li>
<p>与 TensorFlow 生态系统和工具直接集成。</p>
</li>
<li>
<p>SavedModel 格式兼容性支持从 Python 到 Java 的无缝模型移交。</p>
</li>
<li>
<p>TensorFlow Lite 支持面向移动和边缘部署。</p>
</li>
<li>
<p>通过原生 TensorFlow 运行时支持 GPU 和 TPU 加速。</p>
</li>
</ul>
<p><strong>局限：</strong></p>
<ul>
<li>
<p>TensorFlow Java API 不在 TensorFlow API 稳定性保证范围内。</p>
</li>
<li>
<p>对 Keras on Java 几乎无官方支持，迫使开发者必须在 Python 中定义和训练复杂模型以供后续导入 Java。</p>
</li>
<li>
<p>与 DJL 甚至 DL4J 相比，较低级别的 API 需要编写更多代码。</p>
</li>
</ul>
<p><img src="https://cf-blog.icodebuddy.com/image/102/102-2_cn.png" alt="" loading="lazy"/></p>
<p><img src="https://cf-blog.icodebuddy.com/image/102/102-3_cn.png" alt="" loading="lazy"/></p>
<p><img src="https://cf-blog.icodebuddy.com/image/102/102-4_cn.png" alt="" loading="lazy"/></p>
<p><img src="https://cf-blog.icodebuddy.com/image/102/102-5_cn.png" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">3. 框架对比表</h2>
<p>| 标准 | Deep Java Library | Deeplearning4j | TensorFlow Java |</p>
<p>| :--- | :--- | :--- | :--- |</p>
<p>| <strong>主要用例</strong> | 推理与模型服务 | 完整 ML 生命周期 | 模型服务 |</p>
<p>| <strong>引擎支持</strong> | PyTorch, TensorFlow, MXNet, ONNX | 原生 JVM | 仅 TensorFlow |</p>
<p>| <strong>训练能力</strong> | 有限 | 完全支持 | 有限 |</p>
<p>| <strong>分布式计算</strong> | 通过引擎（如 MXNet 上的 Spark） | 原生 Spark/Hadoop | 通过 TensorFlow |</p>
<p>| <strong>模型导入</strong> | PyTorch, TensorFlow, Keras, ONNX | Keras, TensorFlow, ONNX | 仅 TensorFlow |</p>
<p>| <strong>预训练模型</strong> | Model Zoo 中 70+ | 社区模型 | TensorFlow Hub |</p>
<p>| <strong>Spring Boot 集成</strong> | 原生 starters | 手动 | 手动 |</p>
<p>| <strong>学习曲线</strong> | 低 | 中-高 | 中 |</p>
<p>| <strong>内存管理</strong> | NDManager（自动） | ND4J（堆外） | 手动会话 |</p>
<p>| <strong>企业就绪度</strong> | 高 | 非常高 | 中 |</p>
<p>| <strong>社区规模</strong> | 增长中 | 小众 | 大（Python） |</p>
<p>| <strong>最适合</strong> | 云原生推理 | 大数据 ML 流水线 | TensorFlow 生态系统 |</p>
<p><strong>决策矩阵：</strong></p>
<ul>
<li>
<p><strong>选择 DJL 用于</strong>：微服务、无服务器函数、Spring Boot 应用、引擎灵活性、AWS 生态系统。</p>
</li>
<li>
<p><strong>选择 DL4J 用于</strong>：分布式训练、Spark/Hadoop 集成、完整的纯 Java 技术栈、企业数据流水线。</p>
</li>
<li>
<p><strong>选择 TensorFlow Java 用于</strong>：现有的 TensorFlow 投资、TPU 部署、直接的 Python 模型兼容性。</p>
</li>
</ul>
<h2 data-id="heading-6">4. 与 Python ML 生态系统的集成</h2>
<h3 data-id="heading-7">4.1 多语言生产模式</h3>
<p>最优的企业 ML 工作流通常结合 Python 的研究能力和 Java 的生产优势。数据科学家在熟悉的 Python 环境中使用 TensorFlow、PyTorch 或 scikit-learn 训练模型。工程师随后将这些模型部署在每天处理数百万请求的 Java 应用程序中。</p>
<p><strong>模型导出格式：</strong></p>
<ul>
<li>
<p><strong>ONNX</strong>：这个通用的交换格式支持大多数框架。在 PyTorch 中训练，导出到 ONNX，通过 DJL 或 DL4J 导入。这种方法支持与框架无关的部署流水线。</p>
</li>
<li>
<p><strong>TensorFlow SavedModel</strong>：对于长期生产服务，导出到中立格式（如 ONNX）或针对服务优化的框架特定生产格式（SavedModel、TorchScript）。SavedModel 将计算图、变量值和元数据打包到单个目录结构中。</p>
</li>
<li>
<p><strong>TorchScript</strong>：PyTorch 模型通过脚本或追踪序列化为 TorchScript。DJL 的 PyTorch 引擎直接加载这些模型，保持完整的计算图。</p>
</li>
<li>
<p><strong>Keras H5</strong>：DL4J 导入 Keras 模型（包括 tf.keras 变体），保留层配置和训练好的权重。</p>
</li>
</ul>
<h3 data-id="heading-8">4.2 Python4j：在 Java 中嵌入 Python</h3>
<p>DL4J 的 Python4j 模块解决了需要 Java 中不可用的 Python 库的场景。Python4j 是一个 Python 脚本执行框架，简化了将 Python 脚本部署到生产环境的过程。该方法将 CPython 解释器嵌入到 JVM 进程中，实现双向调用。</p>
<p><strong>用例包括：</strong></p>
<ul>
<li>
<p>在 Java 推理前使用 scikit-learn 流水线进行预处理。</p>
</li>
<li>
<p>从 Java 数据流水线调用专门的 Python 库（NumPy, SciPy）。</p>
</li>
<li>
<p>在 Java 模型服务旁边运行基于 Python 的特征工程。</p>
</li>
</ul>
<p><strong>权衡之处</strong>在于需要管理 Python 运行时依赖项和潜在的 GIL 限制。对于高吞吐量场景，模型导出仍然优于运行时 Python 执行。</p>
<h2 data-id="heading-9">5. 模型服务与部署模式</h2>
<h3 data-id="heading-10">5.1 实时推理架构</h3>
<p>面向用户的应用，其生产 ML 系统需要低于 100 毫秒的延迟。Java 的线程模型和 JVM 优化在此背景下表现出色。在生产中无需 Python 即可提供 TensorFlow 模型服务，每次预测延迟低于 10 毫秒，并像任何 Spring Boot 服务一样水平扩展。</p>
<p><strong>同步 REST API：</strong></p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-meta">@RestController</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PredictionController</span> {

<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Predictor&lt;Image, Classifications&gt; predictor;

<span class="hljs-meta">@PostMapping("/predict")</span>

<span class="hljs-keyword">public</span> Classifications <span class="hljs-title function_">predict</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Image image)</span> {

<span class="hljs-keyword">return</span> predictor.predict(image); <span class="hljs-comment">// &lt;10ms 典型延迟</span>

}

}

</code></pre>
<p>Spring Boot 的自动配置、健康检查和指标与 DJL 或 DL4J 的预测器实例无缝集成。水平扩展遵循标准的微服务模式——在负载均衡器后部署多个实例。</p>
<p><strong>异步处理：</strong></p>
<p>对于非关键预测，异步处理可提高吞吐量。Java 的 <code>CompletableFuture</code>、<code>Reactor</code> 或 Kotlin 协程支持并发预测批处理：</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">// 异步批量预测</span>

List&lt;CompletableFuture&lt;Result&gt;&gt; futures = images.stream()

.map(img -&gt; CompletableFuture.supplyAsync(

() -&gt; predictor.predict(img), executor))

.collect(Collectors.toList());

</code></pre>
<h3 data-id="heading-11">5.2 批量推理模式</h3>
<p>批量作业可以容器化并部署到作业调度器或流水线（如 Airflow/Prefect、Kubeflow Pipelines、云数据管道服务），而在线模型则部署到服务基础设施（Web 服务器、Kubernetes）。</p>
<p>DL4J 的 Spark 集成处理海量数据集：</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">// Spark 上的分布式批量评分</span>

JavaRDD&lt;DataSet&gt; testData = loadTestData();

JavaRDD&lt;INDArray&gt; predictions = SparkDl4jMultiLayer

.predict(model, testData);

</code></pre>
<p>该模式将推理分布在集群节点上，高效处理数百万条记录。对于拥有 Hadoop 或 Spark 基础设施的组织，这种原生集成消除了 Python 桥接开销。</p>
<h3 data-id="heading-12">5.3 边缘与移动端部署</h3>
<p>DJL 支持部署到边缘设备和移动平台。对于 Android，DJL 提供了针对 ARM 处理器优化的 TensorFlow Lite 和 ONNX Runtime 引擎。自动 CPU/GPU 检测可适应可用硬件。</p>
<p><strong>用例包括：</strong></p>
<ul>
<li>
<p>移动应用中的设备端图像分类。</p>
</li>
<li>
<p>无需云连接的 IoT 传感器异常检测。</p>
</li>
<li>
<p>需要本地推理的边缘计算场景。</p>
</li>
</ul>
<p>该方法降低了延迟，提高了隐私性（数据保留在本地），并消除了网络依赖。</p>
<h2 data-id="heading-13">6. 可扩展性考量</h2>
<h3 data-id="heading-14">6.1 容器化与编排</h3>
<p>使用 Docker 进行容器化，允许将模型及其代码连同所有必需的库和依赖项打包到一个自包含的单元中，该单元可以在任何地方运行（您的笔记本电脑、云虚拟机、Kubernetes 集群中）。</p>
<p>Java ML 服务与传统 Spring Boot 应用的容器化方式相同：</p>
<p><strong>Dockerfile 模式：</strong></p>
<pre><code class="hljs language-dockerfile" lang="dockerfile">
FROM eclipse-temurin:21-jre-alpine

COPY target/ml-service.jar app.jar

ENTRYPOINT ["java", "-jar", "app.jar"]

</code></pre>
<p>Kubernetes 编排处理扩展、健康检查和滚动更新。这种统一性意味着现有的 DevOps 流水线无需特殊处理即可扩展到 ML 服务。</p>
<h3 data-id="heading-15">6.2 性能优化策略</h3>
<ul>
<li>
<p><strong>模型量化</strong>：通过将 float32 权重转换为 int8 来减少模型大小和推理时间。TensorFlow Lite 和 ONNX Runtime 支持量化，且精度损失最小。典型收益：模型缩小 4 倍，推理速度加快 2-3 倍。</p>
</li>
<li>
<p><strong>批处理</strong>：将预测分组以分摊开销。DJL 和 DL4J 支持批处理输入，利用 SIMD 指令，并将每项预测的延迟从 10 毫秒降低到批量 32 条时的每条 2-3 毫秒。</p>
</li>
<li>
<p><strong>模型编译</strong>：ONNX Runtime 和 TensorFlow XLA 将模型编译为优化的执行图。在容器构建期间进行预编译可消除运行时编译开销。</p>
</li>
<li>
<p><strong>内存管理</strong>：DJL 通过其特殊的内存收集器 NDManager 解决了内存泄漏问题，该管理器及时收集 C++ 应用程序内部的陈旧对象，在测试 100 小时连续推理不崩溃后，在生产环境中提供稳定性。</p>
</li>
<li>
<p><strong>连接池</strong>：对于调用外部模型服务器（TensorFlow Serving、Triton）的服务，维护连接池以减少 TCP 握手开销。</p>
</li>
</ul>
<h3 data-id="heading-16">6.3 水平扩展模式</h3>
<p>Java ML 服务的扩展方式与无状态 Web 服务相同：</p>
<ul>
<li>
<p>在负载均衡器后部署多个实例。</p>
</li>
<li>
<p>基于 CPU、内存或自定义指标（推理队列深度）使用 Kubernetes HorizontalPodAutoscaler。</p>
</li>
<li>
<p>实施熔断器以优雅地处理下游故障。</p>
</li>
<li>
<p>使用 Redis 或 Caffeine 缓存频繁的预测结果。</p>
</li>
</ul>
<p>推理的无状态特性（给定模型版本）使得无需协调开销即可实现弹性扩展。</p>
<h2 data-id="heading-17">7. Java 应用的 MLOps</h2>
<h3 data-id="heading-18">7.1 持续训练与部署</h3>
<p>MLOps 团队的目标是自动将 ML 模型部署到核心软件系统中或作为服务组件，自动化整个 ML 工作流步骤，无需任何人工干预。</p>
<ul>
<li>
<p><strong>Level 0（手动）</strong>：许多团队拥有能够构建先进模型的数据科学家和 ML 研究人员，但他们构建和部署 ML 模型的过程完全是手动的，每个步骤都需要手动执行和手动过渡。这代表了 2025 年 35% 的 Java ML 部署。</p>
</li>
<li>
<p><strong>Level 1（ML 流水线自动化）</strong>：自动化训练流水线根据新数据重新训练模型。Jenkins、GitHub Actions 或 GitLab CI 触发训练作业，将模型导出到工件仓库（Nexus、Artifactory），并通知部署系统。版本化的模型自动部署到预发布环境。</p>
</li>
<li>
<p><strong>Level 2（ML 的 CI/CD）</strong>：持续集成通过添加测试和验证数据和模型来扩展对代码和组件的测试和验证；持续交付关注自动部署另一个 ML 模型预测服务的 ML 训练流水线的交付；持续训练自动重新训练 ML 模型以重新部署。</p>
</li>
</ul>
<p>在 Java 上下文中，这意味着：</p>
<ul>
<li>
<p>数据流水线和预处理的自动化单元测试。</p>
</li>
<li>
<p>确保模型预测符合预期输出的集成测试。</p>
</li>
<li>
<p>金丝雀部署（5% 流量导向新模型版本）。</p>
</li>
<li>
<p>性能下降时的自动化回滚。</p>
</li>
</ul>
<h3 data-id="heading-19">7.2 模型版本控制与注册</h3>
<p>将模型视为一等工件：</p>
<pre><code class="hljs language-plainttext" lang="plainttext">
models/

fraud-detection/

v1.0.0/

model.onnx

metadata.json

v1.1.0/

model.onnx

metadata.json

</code></pre>
<p>元数据包括训练日期、数据集版本、性能指标（准确率、F1 分数）和依赖版本。可以使用 Maven 坐标引用模型版本：</p>
<pre><code class="hljs language-xml" lang="xml">
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.company.ml<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fraud-detection-model<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">classifier</span>&gt;</span>onnx<span class="hljs-tag">&lt;/<span class="hljs-name">classifier</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

</code></pre>
<p>这种方法将标准的依赖管理实践应用于 ML 模型，从而实现可重复的构建和可审计的部署。</p>
<h3 data-id="heading-20">7.3 监控与可观察性</h3>
<p>ML 模型部署后，需要进行监控以确保其按预期执行。Java 的可观察性生态系统自然地扩展到 ML 服务：</p>
<p><strong>要跟踪的指标：</strong></p>
<ul>
<li>
<p><strong>推理延迟</strong>：通过 Micrometer 统计 p50、p95、p99 百分位数。</p>
</li>
<li>
<p><strong>吞吐量</strong>：每秒预测数、每秒请求数。</p>
</li>
<li>
<p><strong>错误率</strong>：失败的预测、模型加载失败。</p>
</li>
<li>
<p><strong>数据漂移</strong>：通过统计测试检测到的输入分布变化。</p>
</li>
<li>
<p><strong>模型性能</strong>：生产数据上的准确率、精确率、召回率（当标签可用时）。</p>
</li>
</ul>
<p><strong>与现有工具的集成：</strong></p>
<p>Spring Boot Actuator 暴露 ML 特定指标：</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-meta">@Component</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PredictionMetrics</span> {

<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MeterRegistry registry;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recordPrediction</span><span class="hljs-params">(<span class="hljs-type">long</span> latencyMs, String modelVersion)</span> {

registry.timer(<span class="hljs-string">"prediction.latency"</span>,

<span class="hljs-string">"model"</span>, modelVersion)

.record(Duration.ofMillis(latencyMs));

}

}

</code></pre>
<p>Prometheus 抓取这些指标，Grafana 可视化趋势，并在出现异常（延迟峰值、准确率下降）时触发告警。</p>
<h3 data-id="heading-21">7.4 测试 ML 系统</h3>
<ul>
<li>
<p><strong>单元测试</strong>：验证数据预处理、特征工程和后处理逻辑。标准的 JUnit 测试即可满足。</p>
</li>
<li>
<p><strong>集成测试</strong>：测试 ML 模型是否成功加载到生产服务中，并且对真实数据的预测符合预期；测试训练环境中的模型与服务环境中的模型给出相同的分数。</p>
</li>
<li>
<p><strong>性能测试</strong>：使用 JMeter 或 Gatling 模拟负载，在真实流量模式下测量吞吐量和延迟。建立基线并检测回归。</p>
</li>
<li>
<p><strong>影子部署</strong>：将新模型版本与现有版本并行运行，记录预测而不影响用户。在全面部署前比较结果以识别意外行为。</p>
</li>
</ul>
<h2 data-id="heading-22">8. Java 在机器学习中表现出色的用例</h2>
<h3 data-id="heading-23">8.1 企业集成场景</h3>
<ul>
<li>
<p><strong>金融服务中的欺诈检测</strong>：拥有成熟 Java 生态系统的企业越来越寻求将 ML/AI 模型直接集成到其后端系统的方法，而无需启动单独的基于 Python 的微服务。银行每天通过 Java 系统处理数百万笔交易。将 DJL 预测器直接嵌入交易处理流水线中，无需外部服务调用即可实现低于 10 毫秒的欺诈评分。</p>
</li>
<li>
<p><strong>实时推荐</strong>：基于 Spring Boot 构建的电子商务平台集成 DJL 进行产品推荐。会话数据流经现有的 Java 服务，预测在进程内进行，结果无需网络延迟即可呈现。</p>
</li>
<li>
<p><strong>日志分析与聚类</strong>：Netflix 的可观察性团队使用 DJL 在生产中部署迁移学习模型，以对应用程序日志数据进行实时聚类和分析，通过字符级 CNN 和通用句子编码器模型处理日志行，每条约 7 毫秒。基于 DJL 的流水线分配保留相似性的聚类 ID，从而实现告警量减少和存储效率提高。</p>
</li>
</ul>
<h3 data-id="heading-24">8.2 大数据 ML 工作流</h3>
<p>使用 Spark 或 Hadoop 每天处理 TB 级数据的组织受益于 DL4J 的原生集成。在历史数据上训练模型、对新记录进行评分以及更新模型——所有这些都在 Spark 流水线内完成，无需 Python 桥接。</p>
<p><strong>示例工作流：</strong></p>
<ol>
<li>
<p>从 HDFS 或 S3 将数据读入 Spark DataFrames。</p>
</li>
<li>
<p>使用 Spark SQL 进行特征工程。</p>
</li>
<li>
<p>在集群上分布式训练 DL4J 模型。</p>
</li>
<li>
<p>使用训练好的模型对新数据评分。</p>
</li>
<li>
<p>将结果写回数据仓库。</p>
</li>
</ol>
<p>整个端到端流程保持在 JVM 中，避免了序列化开销和 Python 互操作的复杂性。</p>
<h3 data-id="heading-25">8.3 微服务与云原生应用</h3>
<p>Spring Boot 应用程序主导着企业微服务架构。通过 DJL starters 添加 ML 能力可无缝集成：</p>
<ul>
<li>
<p><strong>熔断器</strong>：Resilience4j 模式保护 ML 服务免受级联故障影响。</p>
</li>
<li>
<p><strong>服务发现</strong>：Eureka 或 Consul 注册 ML 预测服务。</p>
</li>
<li>
<p><strong>配置</strong>：Spring Cloud Config 管理模型端点和参数。</p>
</li>
<li>
<p><strong>追踪</strong>：Zipkin 或 Jaeger 追踪通过 ML 流水线的请求。</p>
</li>
</ul>
<p>这种统一性简化了运维——ML 服务与业务逻辑服务以相同的方式部署、扩展和监控。</p>
<h3 data-id="heading-26">8.4 边缘计算与物联网</h3>
<p>Java 的“一次编写，随处运行”理念扩展到边缘设备。为 ARM 处理器编译的 DJL 模型可以在 Raspberry Pi、NVIDIA Jetson 和工业 IoT 网关上运行。<strong>用例包括：</strong></p>
<ul>
<li>
<p><strong>预测性维护</strong>：本地分析传感器数据，异常时触发警报。</p>
</li>
<li>
<p><strong>视频分析</strong>：在边缘处理安防摄像头视频流，减少带宽。</p>
</li>
<li>
<p><strong>智能家居设备</strong>：设备端语音识别和自然语言理解。</p>
</li>
</ul>
<p>GraalVM 原生镜像编译生成独立的可执行文件，内存占用小（&lt; 50MB），启动速度快（&lt; 100ms），非常适合资源受限的环境。</p>
<h3 data-id="heading-27">8.5 法规与合规要求</h3>
<p>随着欧盟《人工智能法案》等法规的收紧，集成重点转向模型的左移安全性——在流水线中扫描偏见、可解释性和合规性。Java 的强类型、显式异常处理和成熟的日志记录框架便于审计追踪和满足可解释性要求。</p>
<p>金融和医疗保健行业通常要求所有代码（包括 ML 模型）通过经过验证的、带有审批工作流的流水线进行部署。与引入 Python 运行时依赖相比，Java ML 服务能更自然地与现有的治理流程集成。</p>
<h3 data-id="heading-28">9. 结论：我们的收获</h3>
<p>Java 在机器学习中的作用代表了务实的生产工程，而非研究创新。我们分析得出的主要见解：</p>
<ol>
<li>
<p><strong>框架选择取决于上下文</strong>：DJL 在推理和模型服务方面表现出色，具有引擎灵活性，是云原生微服务的理想选择。DL4J 提供了与大数据框架集成的完整 ML 生命周期功能，适用于需要分布式培训的组织。TensorFlow Java 服务于深度投入 TensorFlow 生态系统、需要直接模型兼容性的团队。</p>
</li>
<li>
<p><strong>多语言模式行之有效</strong>：在 Python 中训练并在 Java 中部署，利用了每种语言的优势。ONNX 和 SavedModel 格式支持无缝交接。Python4j 在必要时弥合差距，但出于性能考虑，模型导出仍是首选。</p>
</li>
<li>
<p><strong>生产性能至关重要</strong>：Netflix 7 毫秒的推理延迟证明 Java ML 服务能够满足实时性能要求。适当的内存管理（NDManager、ND4J）、模型优化（量化、编译）和水平扩展提供了生产级系统。</p>
</li>
<li>
<p><strong>MLOps 成熟度参差不齐</strong>：只有 20% 的 Java ML 部署达到了 Level 2 CI/CD 成熟度，具备自动重新训练和监控。机会在于将已建立的 DevOps 实践——容器、编排、可观察性——应用于 ML 工作流。</p>
</li>
<li>
<p><strong>Java 在特定场景中表现出色</strong>：企业集成（欺诈检测、推荐）、大数据 ML 流水线（Spark/Hadoop）、微服务架构、边缘计算和法规合规代表了 Java 的特性——稳定性、线程处理、生态系统成熟度——相比以 Python 为中心的方法提供优势的领域。</p>
</li>
<li>
<p><strong>内存管理区分了框架</strong>：DJL 的 NDManager 解决了管理 JVM 应用程序中本机内存的关键挑战，实现了 100 小时以上的生产运行而无内存泄漏。这种生产就绪性将企业可行的框架与实验性绑定区分开来。</p>
</li>
<li>
<p><strong>差距正在缩小</strong>：虽然 Java 不会取代 Python 在 ML 研究中的地位，但像 DJL 和 DL4J 这样的框架已经足够成熟，可用于生产部署。生态系统现在支持完整的推理生命周期，性能可与 Python 解决方案相媲美。</p>
</li>
</ol>
<p>未来可能涉及更深层次的集成——Spring AI 为 Java 带来 LLM 能力，GraalVM 原生镜像为无服务器 ML 实现即时启动，以及 MLOps 和 DevOps 实践之间持续的融合。对于拥有大量 Java 投资的组织，问题从“我们能用 Java 做 ML 吗？”转变为“我们如何优化 Java ML 部署？”。</p>
<p>随着 ML 在企业系统中变得无处不在，Java 的生产优势——稳定性、性能、工具成熟度和操作熟悉度——使其成为推理层的务实选择，即使 Python 在训练和实验中仍占主导地位。多语言方法——在 Python 中训练，在 Java 中部署——代表的不是妥协，而是对每个平台独特优势的优化。</p>
<hr/>
<p>【注】本文译自：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.javacodegeeks.com%2F2026%2F01%2Fai-and-machine-learning-in-java-tensorflow-djl-and-enterprise-ai.html" target="_blank" title="https://www.javacodegeeks.com/2026/01/ai-and-machine-learning-in-java-tensorflow-djl-and-enterprise-ai.html" ref="nofollow noopener noreferrer">AI and Machine Learning in Java: TensorFlow, DJL, and Enterprise AI</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用第一性原理拆解 Agentic Coding：从理论到实操（上）]]></title>    <link>https://juejin.cn/post/7593169840199237658</link>    <guid>https://juejin.cn/post/7593169840199237658</guid>    <pubDate>2026-01-09T08:29:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593169840199237658" data-draft-id="7592939457043415092" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用第一性原理拆解 Agentic Coding：从理论到实操（上）"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2026-01-09T08:29:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="TRAE_ai"/> <meta itemprop="url" content="https://juejin.cn/user/3048259110571032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用第一性原理拆解 Agentic Coding：从理论到实操（上）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3048259110571032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    TRAE_ai
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T08:29:18.000Z" title="Fri Jan 09 2026 08:29:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读23分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6323f2f57c5f48ae9749ac615fc802bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768552157&amp;x-signature=9U56aq73toNUpDoCxQjrBpszU%2Fk%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>本文作者：小夏，TRAE 技术专家</p>
</blockquote>
<p>当我们使用 AI 编程助手时，很容易把它当作一个「黑盒」：输入我们的需求，就可以获得想要的代码。但如果想真正高效地利用这些工具，我们需要回到第一性原理：理解 LLM 究竟是如何工作的，它的能力边界在哪里，以及 Agent 架构是如何在这些约束下被设计出来的。在本文上篇，我们将从大模型的工作原理和局限性出发，介绍由此引发的 Coding Agent 中的效果问题，进而支撑我们理解各种最佳实践背后的原因，并且你会发现，很多 TRAE 中的 Agent 优化和功能特性本质上都是在解决这些大模型固有的局限性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5155640ba47f49eab0c185569e405a86~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768552157&amp;x-signature=WbVe260zNxSU5ltHUEQcJnkX5Vc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0"><strong>第一性原理｜理解 LLM 的本质</strong></h2>
<h3 data-id="heading-1"><strong>LLM 是如何「思考」的</strong></h3>
<p>大语言模型的工作方式可以用一句话概括：<strong>逐个预测下一个 token。</strong></p>
<p>当你向 LLM 提问时，它并不是先在「脑中」构思好完整答案再输出。相反，它每次只做一件事：基于当前看到的所有文本（你的输入 + 它已经生成的内容），预测最可能的下一个词是什么。然后把这个词加入序列，再预测下一个，如此循环直到生成结束，这种方式被称为 <strong>自回归生成（Autoregressive Generation）</strong> 。</p>
<p>理解这一点至关重要，因为它揭示了 LLM 的几个本质特征：</p>
<p><strong>1. 没有独立于输出的「思考」过程</strong> <strong>：</strong> LLM 的推理就是生成本身。它不能先想好再说，只能边说边想。这就是为什么让模型「一步步思考」（Chain-of-Thought）会提升效果 — 你实际上是在给它更多的「思考空间」，让它通过生成中间步骤来辅助推理。尽管新一代模型很多都带有显式的 reasoning 能力，依然脱离不了这个范式。</p>
<p><strong>2. 上下文就是全部记忆：</strong> LLM 没有独立的记忆存储。它对当前对话的所有「理解」，完全来自于输入给它的上下文窗口。窗口之外的内容，对模型来说就是不存在的。</p>
<p><strong>3. 生成具有概率性：</strong> 每一步预测都是基于概率分布采样，这意味着同样的输入可能产生不同的输出。</p>
<p>自回归（autoregressive）LLM 的核心工作方式是：<strong>一次只预测下一个 token</strong>，然后把自己刚生成的内容再喂回去继续生成。这个机制很强（通用、可扩展、能「写出」复杂结构），但也天然带来一些局限，在 Coding Agent 里这些局限会被放大，因为软件开发是「长链路、强约束、强验证」的任务。</p>
<p><strong>当前 Coding Agent 普遍存在的问题：</strong></p>
<p><strong>1. 局部最优：一步一步「续写」，不等于全局规划</strong></p>
<ul>
<li>
<p>容易先写得很像、很顺，然后在后面发现不对再补丁式修修补补（历史债务快速累积）。</p>
</li>
<li>
<p>多文件重构/架构调整这种「先规划后落地」的任务，会变成边写边想，导致接口不一致、重复实现、遗漏迁移步骤。</p>
</li>
<li>
<p>对「最终能不能通过测试/CI」缺乏感知，除非你把测试结果显式喂回 agent 循环。</p>
</li>
</ul>
<p><strong>2. 一旦走偏，会沿着偏差继续滚雪球</strong></p>
<ul>
<li>
<p>早期误读需求/误判代码库的约束 ，导致后面每一步都在错误世界观里自洽。</p>
</li>
<li>
<p>生成了一个不存在的函数名/类型后，后续会越来越「相信它存在」，直到编译/运行时打脸。</p>
</li>
<li>
<p>在长对话、长任务里尤其明显：越写越像「另一个项目」。</p>
</li>
</ul>
<p><strong>3. 输出是流式的，无法回头修改之前输出的内容</strong></p>
<ul>
<li>
<p>擅长「写新文件/新段落」，相对不擅长在复杂代码中做精确、最小化、局部一致的编辑。</p>
</li>
<li>
<p>容易倾向于「重写一遍」而不是「进行修改」，导致 diff 过大、review 成本高。</p>
</li>
<li>
<p>在需要保持大量不变量（API、格式、风格、兼容性）的仓库里尤其痛苦。</p>
</li>
</ul>
<p><strong>4. 满足约束的能力有限，而代码是强语法/强语义约束的</strong></p>
<ul>
<li>
<p>「看起来合理」的实现，经常在边界条件、并发、错误处理、资源释放上出错。</p>
</li>
<li>
<p>跨文件的符号解析、泛型/模板推导、宏/代码生成等，靠纯文本推断很容易漏。</p>
</li>
<li>
<p>复杂的重构（rename、move、split）没有 AST/语义工具辅助时，错一个引用就全盘崩。</p>
</li>
</ul>
<p><strong>5. 天然单线程思考，难并行探索</strong></p>
<ul>
<li>
<p>在方案选择（架构、依赖、实现路径）上容易早早押注一个方向，缺少系统性对比。</p>
</li>
<li>
<p>排查 bug 时更像「单线推理」，不如人类/工具那样并行假设、并行验证</p>
</li>
</ul>
<h3 data-id="heading-2"><strong>Attention：LLM 如何「阅读」上下文</strong></h3>
<p>在预测下一个 token 时，模型需要从上下文中提取相关信息，这个过程由 <strong>Attention（注意力）机制</strong> 完成。</p>
<p>你可以把 Attention 想象成一个动态的「聚光灯」：当模型生成每个新 token 时，它会扫视整个上下文，对不同位置的内容分配不同的「注意力权重」。权重高的部分会对当前生成产生更大影响，权重低的部分则几乎被忽略。</p>
<p>具体来说，对于当前要生成的 token，模型会：</p>
<ul>
<li>
<p><strong>计算相关性：</strong> 当前位置与上下文中每个位置的相关程度</p>
</li>
<li>
<p><strong>分配权重：</strong> 相关性高的位置获得更高权重，形成一个概率分布</p>
</li>
<li>
<p><strong>加权聚合：</strong> 根据权重汇总上下文信息，用于预测下一个 token</p>
</li>
</ul>
<p>这个机制有几个重要特性：</p>
<ul>
<li>
<p><strong>注意力是稀疏的：</strong> 模型不会均匀地关注所有内容。在实践中，Attention 权重往往集中在少数关键位置，大部分位置的权重接近于零。</p>
</li>
<li>
<p><strong>注意力需要「学习」的：</strong> 模型通过训练学习在什么情况下关注什么内容。这意味着它可能会形成某些偏好模式，比如更关注开头和结尾。</p>
</li>
<li>
<p><strong>计算复杂度是平方级的：</strong> 标准 Attention 需要计算每个位置与所有其他位置的关系，计算量随上下文长度的平方增长。这是上下文长度存在物理上限的根本原因之一。</p>
</li>
</ul>
<p>理解了 Attention 机制，我们就能更好地理解上下文长度为什么会带来多种限制。</p>
<h3 data-id="heading-3"><strong>上下文长度：最关键的约束</strong></h3>
<p>上下文窗口的限制是影响 Coding Agent 设计最核心的约束条件。结合对 Attention 机制的理解，我们可以更清楚地看到这个限制的多个层次。</p>
<h4 data-id="heading-4"><strong>物理上限</strong></h4>
<p>每个模型都有最大 token 限制，目前主流模型通常在 128K 到 200K 之间。这个硬性边界的存在有两个根本原因：</p>
<p><strong>1.</strong> Attention 的计算复杂度通常是 O（n²），上下文长度翻倍，计算量变成四倍</p>
<p><strong>2.</strong> 需要存储完整的注意力矩阵，内存消耗同样是平方级增长</p>
<p><strong>超过这个长度的内容根本无法被处理。</strong></p>
<h4 data-id="heading-5"><strong>有效上下文远小于标称上下文</strong></h4>
<p><strong>虽然模型宣称支持 200K tokens，但这不意味着在 200K 长度下都能保持良好表现。</strong></p>
<p>问题出在 Attention 的「稀疏性」上：当上下文很长时，注意力权重需要分散到更多位置。如果关键信息只是海量内容中的一小部分，它获得的注意力权重可能会被稀释到难以有效利用的程度。实际上，一个支持 200K 的模型，可能在超过 80K 或 100K 之后，就开始出现明显的性能退化。</p>
<h4 data-id="heading-6"><strong>性能退化曲线</strong></h4>
<p>随着上下文变长，不仅是「记忆」变差，模型的整体能力，包括推理准确性、指令遵循能力、代码生成质量都会下降。</p>
<p>这是自回归 + Attention 组合带来的累积效应：</p>
<ul>
<li>
<p>每一步生成都依赖于对上下文的正确理解</p>
</li>
<li>
<p>更长的上下文意味着更稀疏的注意力分布</p>
</li>
<li>
<p>错误理解会传递到后续生成，形成累积误差</p>
</li>
</ul>
<p>理解这些限制，你就能明白为什么 Coding Agent 需要精心设计上下文管理策略，而不是简单地把所有信息塞进窗口。</p>
<h3 data-id="heading-7"><strong>强化学习：让模型学会「做事」</strong></h3>
<p>前面我们讨论的是 LLM 的基础能力，预测下一个 token。但要让模型从**「能说会道」<strong>进化到</strong>「能做事情」**，还需要另一个关键技术：<strong>强化学习（Reinforcement Learning， RL）。</strong></p>
<h4 data-id="heading-8"><strong>预训练的局限</strong></h4>
<p>LLM 的预训练本质上是「模仿」：通过阅读海量文本，学会预测「人类会怎么写下一个词」。这让模型获得了广泛的知识和流畅的表达能力，但也有明显的局限：</p>
<ul>
<li>模型学会的是「文本看起来应该是什么样」，而不是「什么行动能解决问题」</li>
<li>预训练数据中很少有「调用工具 → 观察结果 → 调整策略」这样的交互序列</li>
<li>模型可能会生成看起来合理但实际无效的操作步骤</li>
</ul>
<p><strong>简单来说，预训练教会了模型「说」，但没有教会它「做」。</strong></p>
<h4 data-id="heading-9"><strong>强化学习的核心思想</strong></h4>
<p>强化学习用一个简单的循环来解决这个问题：<strong>尝试 → 反馈 → 调整。</strong></p>
<p>想象教一个小朋友下棋：你不会给他看一百万盘棋谱让他背（这是预训练的方式），而是让他实际下棋，赢了就表扬，输了就复盘。通过无数次的尝试和反馈，他逐渐学会什么是好棋、什么是坏棋。</p>
<p>对 LLM 来说，强化学习的过程类似：</p>
<ul>
<li>
<p><strong>尝试：</strong> 让模型在真实或模拟的环境中执行任务（比如调用工具、编辑文件）</p>
</li>
<li>
<p><strong>反馈：</strong> 根据结果给出奖励信号（任务完成了？代码能运行？测试通过了？)</p>
</li>
<li>
<p><strong>调整：</strong> 更新模型参数，让它更倾向于选择能获得高奖励的行动</p>
</li>
</ul>
<p>这个过程会重复成千上万次，模型逐渐学会：在什么情况下应该调用什么工具、如何解读工具返回的结果、什么时候应该继续尝试、什么时候应该换个方向。</p>
<h4 data-id="heading-10"><strong>为什么 RL 对 Agentic 能力至关重要</strong></h4>
<p>传统的 LLM 微调（比如监督学习）需要人类标注「正确答案」。但 Agent 任务的特点是：</p>
<ul>
<li>
<p><strong>路径多样：</strong> 完成同一个编程任务可能有无数种合理的步骤组合</p>
</li>
<li>
<p><strong>结果导向：</strong> 我们真正关心的是最终结果，而不是中间每一步是否「标准」</p>
</li>
<li>
<p><strong>需要探索：</strong> 有时候必须尝试几种方法才能找到可行的路径</p>
</li>
</ul>
<p>RL 天然适合这种场景。它不要求你定义「正确的步骤序列」，只需要定义「什么算成功」。模型通过自己的探索，学会找到通往成功的路径。</p>
<h4 data-id="heading-11"><strong>实际训练中的应用</strong></h4>
<p>现代 Coding Agent 背后的模型通常会经历这样的 RL 训练：</p>
<ul>
<li>
<p>在模拟的编程环境中执行任务（创建文件、运行代码、修复 bug）</p>
</li>
<li>
<p>用测试通过率、代码质量评分等作为奖励信号</p>
</li>
<li>
<p>学习何时应该读取更多文件来获取上下文，何时应该直接动手修改</p>
</li>
<li>
<p>学习如何从错误信息中提取有用线索，调整下一步策略</p>
</li>
</ul>
<p>值得注意的是，RL 训练的效果高度依赖奖励信号的设计。如果只奖励「任务完成」，模型可能学会走捷径（Reward Hacking）；如果奖励信号太复杂，训练可能不稳定。<strong>这也是为什么不同模型在 Agent 任务上的表现差异很大，背后的 RL 训练策略可能完全不同。</strong></p>
<h4 data-id="heading-12"><strong>对使用者的启示</strong></h4>
<p>理解了 RL 的作用，你会更清楚为什么某些使用方式更有效：</p>
<ul>
<li>
<p><strong>提供清晰的成功标准：</strong> 当你告诉 Agent 「修好这个 bug，运行 npm test 应该全部通过」，你实际上是在给它一个明确的「奖励信号」，这与它训练时的模式一致</p>
</li>
<li>
<p><strong>允许试错：</strong> Agent 在训练中学会了通过尝试来解决问题，给它多次尝试的机会往往比期待一次成功更实际</p>
</li>
<li>
<p><strong>观察它的决策模式：</strong> 当 Agent 做出某个决定（比如先读文件而不是直接修改），这往往反映了它在 RL 训练中学到的策略</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f75cc9980de34df188e688599b2f2d6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768552157&amp;x-signature=vJz2O8POS1r%2BR5XUDQOd64ejDJg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-13"><strong>Coding Agent 的实现原理</strong></h2>
<p>理解了 LLM 的本质和限制后，我们来看 Coding Agent 是如何在这些约束下被设计出来的。</p>
<h3 data-id="heading-14"><strong>LLM API 的核心结构</strong></h3>
<p>现代 LLM API 采用基于消息的对话结构。理解这个结构是构建 Agent 的基础。</p>
<p><strong>Messages 数组</strong></p>
<p>API 的核心是一个消息数组，每条消息包含角色（role）和内容（content）：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"messages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"system"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"你是一个专业的编程助手..."</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"帮我写一个快速排序函数"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"assistant"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"好的，这是一个 Python 实现的快速排序..."</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>三种角色各有用途：</p>
<ul>
<li><strong>system：</strong> 设定 Agent 的行为准则、能力范围和工具定义</li>
<li><strong>user：</strong> 用户的输入</li>
<li><strong>assistant：</strong> 模型的回复</li>
</ul>
<p><strong>Tool Calling 机制</strong></p>
<p>Coding Agent 的核心能力来自工具调用。API 允许你定义工具的 schema，模型会在需要时生成结构化的工具调用请求：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"read_file"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"读取指定路径的文件内容"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"parameters"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"object"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"properties"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"文件路径"</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"path"</span><span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>当模型决定调用工具时，它的响应会包含工具调用信息：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"assistant"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"tool_calls"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"call_abc123"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"read_file"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"{"</span>path<span class="hljs-string">": "</span>src/main.py<span class="hljs-string">"}"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>工具执行结果作为新消息返回给模型：</p>
<pre><code class="hljs language-swift" lang="swift">{
<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool"</span>,
<span class="hljs-string">"tool_call_id"</span>: <span class="hljs-string">"call_abc123"</span>,
<span class="hljs-string">"content"</span>: <span class="hljs-string">"def main():<span class="hljs-subst">\n</span>    print('Hello, World!')<span class="hljs-subst">\n</span>..."</span>
}
</code></pre>
<p><strong>Reasoning Content 的保留</strong></p>
<p>对于具有显式推理能力的模型，API 响应中可能包含 reasoning 或 thinking 字段，记录模型的思考过程：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"assistant"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"reasoning_content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"用户需要读取文件来理解项目结构。我应该先查看 src 目录下的主要文件..."</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"让我先看一下项目的主文件。"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"tool_calls"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>...<span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>在多轮对话中保留这些推理内容，可以帮助模型维持思维的连贯性。模型可以「回顾」自己之前的思考过程，从而做出更一致的决策。</p>
<h3 data-id="heading-15"><strong>Prompt Caching：工程实践的关键</strong></h3>
<p>由于 LLM 的自回归特性，每次请求都需要重新处理整个上下文。对于动辄几万 token 的 Coding Agent 对话来说，这意味着大量的重复计算和延迟。</p>
<p>Prompt Caching 通过缓存上下文前缀的计算结果来解决这个问题。关键在于：<strong>缓存基于前缀匹配</strong>。只有当新请求的开头部分与之前的请求完全一致时，才能命中缓存。</p>
<p>这直接影响了 prompt 的组织方式：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────┐
│  System Prompt              │  ← 稳定不变，可缓存
│  (角色定义、行为准则)         │
├─────────────────────────────┤
│  Tool Definitions           │  ← 稳定不变，可缓存
│  (工具的 schema 定义)        │
├─────────────────────────────┤
│  Project Context            │  ← 相对稳定，尽量少变
│  (项目说明、代码规范)         │
├─────────────────────────────┤
│  Conversation History       │  ← 动态增长
│  (对话历史)                  │
├─────────────────────────────┤
│  Current User Message       │  ← 每次都变
│  (当前用户输入)              │
└─────────────────────────────┘
</code></pre>
<p><strong>最佳实践参考：</strong></p>
<ol>
<li>
<p><strong>把稳定内容放在前面：</strong> system prompt 和工具定义应该保持稳定，避免频繁修改</p>
</li>
<li>
<p><strong>动态内容放在后面：</strong> 对话历史和当前输入放在最后</p>
</li>
<li>
<p><strong>避免在稳定前缀中插入可变内容：</strong> 比如不要在 system prompt 中插入当前时间戳</p>
</li>
</ol>
<h3 data-id="heading-16"><strong>Agent Loop：核心循环</strong></h3>
<p>语言模型可以回答问题，而 Agent 可以<strong>做事情</strong>。Agent Loop 正是实现这一差异的关键。</p>
<p>当模型收到一个无法仅凭训练知识完成的请求时，它需要与外部世界交互：读取文件、查询数据库、执行代码。Agent Loop 就是管理这个「推理-行动」循环的编排层，使模型能够处理需要多个步骤、外部信息或产生实际影响的任务。</p>
<h4 data-id="heading-17"><strong>循环的基本原理</strong></h4>
<p>Agent Loop 的运作遵循一个简单的原则：调用模型 → 检查是否需要使用工具 → 如果需要则执行工具 → 将结果返回给模型再次调用 → 重复直到模型产生最终响应。</p>
<p>这个循环的关键在于<strong>上下文的累积</strong>。每次迭代都会向对话历史中添加新内容。模型不仅能看到原始请求，还能看到它调用过的每个工具以及收到的每个结果。这种累积的上下文使得复杂的多步骤推理成为可能。</p>
<h4 data-id="heading-18"><strong>一个具体的例子</strong></h4>
<p>假设用户请求：「帮我修复项目中的这个 bug：用户登录后会话没有正确保存」。</p>
<p>这不是模型仅凭知识就能完成的任务，它需要通过 Agent Loop 逐步探索：</p>
<ul>
<li>
<p><strong>第一轮：</strong> 模型收到请求，首先需要了解项目结构。它调用 <em><strong>list_directory</strong></em> 工具查看项目根目录。</p>
</li>
<li>
<p><strong>第二轮：</strong> 模型看到了目录结构，识别出 **<em>src/auth/</em> **目录可能与登录相关。它调用 <em><strong>read_file</strong></em> 查看 <em><strong>src/auth/login.js</strong></em>。</p>
</li>
<li>
<p><strong>第三轮：</strong> 模型看到了登录代码，发现它调用了 **<em>sessionManager.save()</em> **。为了追踪问题，它调用 <em><strong>read_file</strong></em> 查看 <em><strong>src/session/manager.j</strong></em>s。</p>
</li>
<li>
<p><strong>第四轮：</strong> 模型发现了问题，**<em>save()</em> **方法中有一个异步操作没有被正确 <em><strong>await</strong></em>。它调用 <em><strong>edit_file</strong></em> 工具修复这个 bug。</p>
</li>
<li>
<p><strong>第五轮：</strong> 修复完成，模型调用 <em><strong>shell</strong></em> 工具运行测试来验证修复是否有效。</p>
</li>
<li>
<p><strong>第六轮：</strong> 测试通过。模型不再请求工具，而是生成最终响应：总结问题原因、修复内容和验证结果。</p>
</li>
</ul>
<p>每一轮都遵循相同的模式：模型接收上下文，决定是继续行动还是给出响应，要么继续循环，要么退出。关键在于，模型基于对任务不断演进的理解<strong>自主做出这些决策。</strong></p>
<h4 data-id="heading-19"><strong>循环的终止条件</strong></h4>
<p>每次模型调用都会返回一个停止原因（stop reason），决定接下来发生什么：</p>
<ul>
<li>
<p><strong>end_turn：</strong> 模型完成了响应，没有进一步的行动需要执行。这是正常的成功终止，循环退出并返回最终消息。</p>
</li>
<li>
<p><strong>tool_use：</strong> 模型想要执行一个或多个工具后再继续。循环执行请求的工具，将结果追加到对话历史，然后再次调用模型。</p>
</li>
<li>
<p><strong>max_tokens：</strong> 模型的响应因达到 token 限制而被截断。这在当前循环中无法恢复，循环以错误终止。</p>
</li>
</ul>
<p>理解这些终止条件有助于预测 Agent 的行为并处理边界情况。</p>
<h3 data-id="heading-20"><strong>Coding Agent 的典型工具</strong></h3>
<p>一个功能完整的 Coding Agent 通常需要以下几类工具：</p>
<p><strong>文件操作</strong></p>
<ul>
<li>
<p><em><strong>read_file</strong></em>：读取文件内容</p>
</li>
<li>
<p><em><strong>write_file</strong></em>：创建或覆盖文件</p>
</li>
<li>
<p><em><strong>edit_file</strong></em>：对文件进行局部编辑（而非完全重写）</p>
</li>
</ul>
<p><strong>代码执行</strong></p>
<ul>
<li><em><strong>shell</strong></em> / <em><strong>terminal</strong></em>：执行命令行命令，用于运行代码、安装依赖、执行测试等</li>
</ul>
<p><strong>代码搜索</strong></p>
<ul>
<li>
<p><em><strong>grep</strong></em> / <em><strong>search</strong></em>：在代码库中搜索文本或模式</p>
</li>
<li>
<p><em><strong>semantic_search</strong></em>：基于语义的代码搜索</p>
</li>
</ul>
<p><strong>项目导航</strong></p>
<ul>
<li>
<p><em><strong>list_directory</strong></em>：列出目录内容</p>
</li>
<li>
<p><em><strong>find_files</strong></em>：根据模式查找文件</p>
</li>
</ul>
<p>这些工具的设计直接影响 Agent 的能力边界，工具的粒度、参数设计、返回格式都需要仔细考量。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c25e5ddae15942cf942ecd1a9ac03d91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768552157&amp;x-signature=q4hKnp1MAC937GMYbxEVvdRDXwI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-21"><strong>常见问题与解决方案</strong></h2>
<p>在了解了 LLM 和 Coding Agent 的基本原理后，我们再来看看一些常见的问题就能更好地理解了。</p>
<h3 data-id="heading-22"><strong>会话间失忆</strong></h3>
<p>Coding Agent 面临的一个根本性问题是：<strong>它们在会话之间没有持久记忆。</strong></p>
<p>每次启动新会话时，Agent 只知道它能在磁盘上找到的内容。就像电影《记忆碎片》或《初恋 50 次》中的主角一样，Agent 每天醒来都不记得昨天发生了什么。而典型的工程工作流往往需要跨越多个会话才能完成一个功能——因为需要测试、代码审查和后续清理。</p>
<p>这导致了一个荒谬的局面：你需要在每个新会话开始时，重新向 Agent 解释项目背景、当前进度和接下来的计划。</p>
<h4 data-id="heading-23"><strong>💡 解决方案：</strong></h4>
<ul>
<li>
<p>使用结构化的任务追踪系统（如 issue tracker）</p>
</li>
<li>
<p>在每个会话结束时，让 Agent 生成一个状态摘要，供下次会话使用</p>
</li>
<li>
<p>将重要决策和发现记录在固定位置，而不是对话历史中</p>
</li>
</ul>
<h3 data-id="heading-24"><strong>上下文窗口耗尽</strong></h3>
<p>每轮循环都会向对话历史添加消息。对于需要多次工具调用的复杂任务，历史记录可能超出模型的上下文窗口。当这种情况发生时，Agent 无法继续。</p>
<p>具体表现包括：模型提供商返回输入长度错误，或随着上下文填满不太相关的早期消息，模型性能明显下降。</p>
<p>目前有两种主流的上下文管理策略：</p>
<h5 data-id="heading-25"><strong>💡 Observation Masking（观察遮蔽）</strong></h5>
<p>这种方法只针对工具返回的观察结果进行处理，而完整保留 Agent 的推理和行动历史。具体做法是：用占位符替换较早轮次的观察内容（比如 「内容已省略」），只保留最近 N 轮的完整输出。</p>
<p>这种方法简单高效，因为典型 Coding Agent 的每轮交互中，工具输出（如文件内容、命令执行结果）往往占据了绝大部分 token。通过遮蔽旧的观察内容，Agent 仍然可以访问自己过去的推理和决策，但不再重复处理早期轮次的冗长文本。</p>
<h4 data-id="heading-26"><strong>💡 LLM Summarization（LLM 摘要）</strong></h4>
<p>这种方法使用另一个 LLM 将较早的交互历史（包括观察、行动和推理）压缩成简短的摘要。摘要会替代原始的详细历史，而最近的几轮对话保持完整。</p>
<p>这种方法理论上可以支持无限长的对话，因为历史会被反复压缩。但它也有代价：每次生成摘要都需要额外的 API 调用，而且摘要可能会丢失某些细节信息。研究发现，摘要有时会掩盖 Agent 应该停止尝试的信号，导致 Agent 运行更多轮次，反而增加了成本。</p>
<p>两种方法各有优劣：Observation Masking 实现简单、成本低，但上下文仍会缓慢增长；LLM Summarization 可以更彻底地压缩历史，但引入了额外开销和信息损失风险。实践中，可以考虑混合使用，以 Observation Masking 作为主要策略，仅在上下文确实过长时触发 LLM Summarization。</p>
<p>其他解决方案：</p>
<ul>
<li>
<p>减少工具输出的冗长程度，返回摘要或相关片段，而非完整数据</p>
</li>
<li>
<p>简化工具 schema，深度嵌套的结构会在工具配置和模型推理中消耗大量 token</p>
</li>
<li>
<p>将大型任务分解为子任务，每个子任务使用新的上下文</p>
</li>
</ul>
<h3 data-id="heading-27"><strong>有效上下文远小于标称值</strong></h3>
<p><strong>即使拥有 1M token 的上下文窗口，Coding Agent 实际上只能有效利用其中的 10-15%。</strong> 超过 20% 后，成本和性能都会急剧恶化。大多数 Agent 会在达到约 20% 时强制中断，而最佳实践是在 15% 之前就重启会话。</p>
<p>这意味着，以全速工作时，你大约只有 5-10 分钟的有效工作时间，然后 Agent 就会「耗尽上下文」，需要重启（相当于死亡）或进行 compaction（相当于记忆清除）。</p>
<p>有一个生动的比喻：上下文窗口就像潜水员的氧气罐。所有人都说「我们给他一个更大的氧气罐：100 万 token！」但他最终还是会耗尽氧气，更大的窗口并不能解决根本问题。</p>
<h3 data-id="heading-28"><strong>「Dumb Zone」：中间区域的性能退化</strong></h3>
<p>研究发现，上下文窗口的中间 40-60% 区域存在一个「Dumb Zone」，在这个区域，模型的召回率下降，推理能力变差。这与前面提到的「Lost in the Middle」现象相呼应。</p>
<p>当 Agent 深入工作时，它会逐渐表现出类似「痴呆」的症状：迷失方向、产生幻觉接口、忘记原始目标。这不是因为模型变笨了，而是因为关键信息被淹没在大量的上下文中，无法被有效利用。</p>
<h3 data-id="heading-29"><strong>新发现的任务被丢弃</strong></h3>
<p>这是 Agentic Coding 中一个容易被忽视但影响巨大的问题：<strong>LLM 在工作过程中会注意到各种问题，但在上下文空间紧张时，会选择忽略这些发现，不采取任何行动。</strong></p>
<p>例如，Agent 在修复一个 bug 时，可能会注意到代码中的另一个潜在问题、一个需要重构的地方、或一个缺失的测试用例。但如果当前上下文已经很满，Agent 可能会「假装没看到」，继续专注于手头的任务。这些被发现但被丢弃的工作，就这样悄悄消失了。</p>
<p><strong>💡 解决方案：</strong></p>
<ul>
<li>
<p>使用外部工具让 Agent 随时记录发现的问题</p>
</li>
<li>
<p>在任务结束时，要求 Agent 列出所有观察到但未处理的问题</p>
</li>
<li>
<p>建立「发现即记录」的工作流程</p>
</li>
</ul>
<h3 data-id="heading-30"><strong>过早宣告完成</strong></h3>
<p>当 Agent 经历多次 compaction 后，可能会出现一个荒谬的情况：它会自信地宣布「恭喜，任务完成了！让我们开始手动测试吧！」而实际上还有大量的阶段没有完成。</p>
<p><strong>解决方案：</strong></p>
<ul>
<li>
<p>将整体计划保存在上下文之外的固定位置</p>
</li>
<li>
<p>定期让 Agent 对照原始计划检查进度</p>
</li>
<li>
<p>使用结构化的任务追踪，而不是依赖 Agent 的记忆</p>
</li>
</ul>
<h3 data-id="heading-31"><strong>工具选择不当</strong></h3>
<p>当模型持续选择错误的工具时，问题通常出在工具描述的模糊性上。从模型的角度审视描述：如果两个工具的描述有重叠，模型就没有选择的依据，我们应该确保每个工具的用途清晰且互不重叠。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ff4689a37e141e6a8c4ba04691b9431~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768552157&amp;x-signature=EYjpo2BhmeZWeyqglELZmlmaw6w%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-32"><strong>结语：从理解到行动的桥梁</strong></h2>
<p>通过上述的探讨，我们已经完成了从 LLM 本质到 Agentic Coding 原理的理论铺垫：从逐个预测 token 的底层逻辑，到注意力机制的上下文约束，再到强化学习如何让模型学会「做事」；从 API 结构的基础框架，到 Agent Loop 的核心循环，最后到解决上下文耗尽、会话失忆等工程问题的实践策略。</p>
<p>这些内容共同构成了 Agentic Coding 的第一性原理基石——理解这些，你就能跳出"黑盒工具"的使用层面，看到各种最佳实践背后的深层逻辑。</p>
<p>在下篇中，我们将从理论走向实操：结合具体案例拆解如何设计高效的 Agent 对话流程、如何选择合适的工具集、如何优化上下文管理策略，以及如何将这些原理应用到实际的编码任务中（如 bug 修复、功能开发、代码重构）。你将看到，当我们用第一性原理的视角重新审视 Agentic Coding 时，那些看似零散的技巧会形成一套系统的方法论，帮助你真正成为 AI 编程助手的「驾驭者」而非「使用者」。</p>
<p>期待在下篇与你继续深入，一起把理论转化为可落地的高效实践。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[鸿蒙开发：那些让我熬秃头的“灵异事件”]]></title>    <link>https://juejin.cn/post/7593139476839890950</link>    <guid>https://juejin.cn/post/7593139476839890950</guid>    <pubDate>2026-01-09T08:34:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593139476839890950" data-draft-id="7592921639465353258" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="鸿蒙开发：那些让我熬秃头的“灵异事件”"/> <meta itemprop="keywords" content="HarmonyOS,ArkTS,ArkUI"/> <meta itemprop="datePublished" content="2026-01-09T08:34:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="威哥爱编程"/> <meta itemprop="url" content="https://juejin.cn/user/2242659450109575"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            鸿蒙开发：那些让我熬秃头的“灵异事件”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2242659450109575/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    威哥爱编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T08:34:40.000Z" title="Fri Jan 09 2026 08:34:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Hello，兄弟们，我是 V 哥！</p>
<p>咱们干鸿蒙开发的，平时是不是觉得自己像个法师？特别是刚从 Android 或者 Vue 转过来的兄弟，面对 ArkTS 这一套声明式 UI，有时候真觉得自己是在做法术。</p>
<p>代码写得行云流水，点个运行——<strong>啪！</strong> 白屏了。
再点一下——<strong>啪！</strong> 崩溃了。
最气人的是，有时候逻辑明明看着没问题，它就是跟你玩“薛定谔的猫”。</p>
<p>今天，V 哥我就把这几个月积攒的**“鸿蒙开发 Bug 悬案卷宗”**给大伙儿抖搂抖搂。这几个 Bug，当初可是折磨了 V 哥整整三天三夜，红喝了半箱，头发掉了好几把。咱们复盘一下，看看你有没有踩过这几个坑！</p>
<hr/>
<h2 data-id="heading-0">悬案一：人间蒸发的 UI 更新（@State 的失忆症）</h2>
<h3 data-id="heading-1">📃 案发现场</h3>
<p>那是一个月黑风高的夜晚，V 哥我在写一个列表页。数据从后端拿回来，是个 JSON 数组。我把它存到了 <code>@State</code> 装饰的变量里。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@State</span> <span class="hljs-attr">dataList</span>: <span class="hljs-title class_">UserModel</span>[] = [];

<span class="hljs-comment">// 网络请求回来后</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">dataList</span> = response.<span class="hljs-property">data</span>;
</code></pre>
<p>逻辑没毛病吧？我看着日志，数据确实赋值进去了，长度也变了。但是！<strong>界面上死活不刷新！</strong> 就像死机了一样，哪怕我把手机屏幕戳个洞，它也不动一下。</p>
<h3 data-id="heading-2">🔍 侦破过程</h3>
<p>V 哥我当时就懵了，难道是 ArkUI 抽风了？我开始疯狂打 Log，发现 <code>dataList</code> 的内存地址确实变了。</p>
<p>这时候，V 哥我突然想起了一句老话：<strong>鸿蒙的观察机制，有时候比前女友还难伺候。</strong></p>
<p>原来啊，我在别的地方，为了图省事，直接操作了数组内部的某个属性，比如：
<code>this.dataList[0].name = 'V哥最帅';</code></p>
<p>或者我在赋值前，对数组做了一些深拷贝的操作，但拷贝得不够“彻底”。在 ArkTS 里，如果你只是修改了对象的<strong>深层属性</strong>，而没有触发对象本身的引用变化，或者嵌套对象没加 <code>@Observed</code>，UI 渲染引擎就会选择性失明：<strong>“哦，还是那个对象，不用动，懒得刷。”</strong></p>
<h3 data-id="heading-3">✅ 终极解决方案</h3>
<p>兄弟们记住了，遇到对象数组刷新，要么老老实实地整体替换引用，要么就用对装饰器！</p>
<ol>
<li><strong>简单粗暴法：</strong> 每次都 <code>new</code> 一个新数组，或者用展开符 <code>[..., newData]</code> 强制换个地址。</li>
<li><strong>专业治本法（推荐）：</strong> 你的 Model 类必须用 <code>@Observed</code> 装饰，然后在组件里用 <code>@ObjectLink</code> 去接！</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Observed</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserModel</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;
  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;
}

<span class="hljs-comment">// 组件里</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">UserItem</span> {
  <span class="hljs-meta">@ObjectLink</span> <span class="hljs-attr">user</span>: <span class="hljs-title class_">UserModel</span>; <span class="hljs-comment">// 注意这里！</span>
  
  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span>.<span class="hljs-property">name</span>)
  }
}
</code></pre>
<p>用了 <code>@ObjectLink</code>，那叫一个丝滑，对象里哪怕改了个标点符号，界面立马跟着变！</p>
<hr/>
<h2 data-id="heading-4">悬案二：真机上的“幽灵点击”（事件冒泡的背刺）</h2>
<h3 data-id="heading-5">📃 案发现场</h3>
<p>为了赶进度，V 哥我写了一个复杂的列表，每个 Item 里面有个“删除”按钮，外面整个 Item 也是可以点击进入详情页的。</p>
<p>在模拟器上跑得好好的，点删除，删除；点 Item，跳转。V 哥我美滋滋地装到真机上测试。</p>
<p>结果，诡异的事情发生了：<strong>我点“删除”按钮，它不仅把数据删了，还特么给我跳到了详情页！</strong></p>
<p>我都想把手机吃了，明明点的是按钮，为什么会触发父容器的点击事件？</p>
<h3 data-id="heading-6">🔍 侦破过程</h3>
<p>刚开始以为是手机屏幕坏了，或者手指太粗。后来发现，这是典型的<strong>事件冒泡</strong>问题。</p>
<p>在鸿蒙的 ArkUI 里，点击事件的传递机制有时候会跟你“捉迷藏”。在模拟器上可能因为响应速度快或者渲染机制不同，不明显。但在真机上，特别是如果你手抖了一下，点击事件就会像坐火箭一样，从子组件（按钮）直接<strong>冒泡</strong>传到了父组件（ListItem），触发两次点击行为。</p>
<h3 data-id="heading-7">✅ 终极解决方案</h3>
<p>给可能触发冲突的子组件事件里，加一句咒语，把它截胡！</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title class_">Button</span>(<span class="hljs-string">'删除'</span>)
  .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">(<span class="hljs-params">event: ClickEvent</span>) =&gt;</span> {
    <span class="hljs-comment">// 你的删除逻辑...</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'执行删除'</span>);
  })
  <span class="hljs-comment">// 重点来了！加上这一句，告诉父组件：到此为止，别往上传了！</span>
  .<span class="hljs-title function_">hitTestBehavior</span>(<span class="hljs-title class_">HitTestMode</span>.<span class="hljs-property">None</span>) 
</code></pre>
<p>或者，在 onClick 的回调里根据业务逻辑判断，但在 UI 声明里，<code>hitTestBehavior</code> 是最物理、最有效的“结界”。加上这一行代码，世界瞬间清净了。</p>
<hr/>
<h2 data-id="heading-8">悬案三：模拟器是亲儿子，真机是捡来的？（资源加载的时差）</h2>
<h3 data-id="heading-9">📃 案发现场</h3>
<p>这个 Bug 简直让我怀疑人生。我在 DevEco Studio 的 Previewer 里预览，图片显示完美，动画流畅。装到华为真机上一跑——<strong>图片全是裂开的默认图！</strong></p>
<p>我检查了路径，<code>common/images/xxx.png</code>，没错啊！权限也给了，网络也通了。为什么真机上就是加载不出来？</p>
<h3 data-id="heading-10">🔍 侦破过程</h3>
<p>V 哥我当时盯着屏幕看了半小时，突然灵光一闪：是不是<strong>加载时机</strong>的问题？</p>
<p>在模拟器里，因为电脑性能强，IO 读写快，图片往往在界面渲染出来之前就已经加载好了。但在真机上，也就是个移动设备，读取本地资源文件是需要时间的。</p>
<p>我的代码逻辑是：
<code>Image(this.imagePath)</code></p>
<p>而 <code>this.imagePath</code> 是在 <code>aboutToAppear()</code> 生命周期里异步去获取并赋值的。真机渲染组件的时候，这个变量还是空的或者是初始值，等它拿到值了，Image 组件已经摆烂不渲染了。</p>
<h3 data-id="heading-11">✅ 终极解决方案</h3>
<p>这叫“异步竞态问题”。解决方法有两个，V 哥推荐第二种。</p>
<ol>
<li><strong>加 Loading 占位：</strong> 用个 if 判断，数据没回来前显示个转圈圈的 Loading。</li>
<li><strong>给 Image 组件加个 Key（绝招）：</strong></li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">imagePath</span>)
  .<span class="hljs-title function_">objectFit</span>(<span class="hljs-title class_">ImageFit</span>.<span class="hljs-property">Cover</span>)
  <span class="hljs-comment">// 加上这个 key！每次 imagePath 变了，强制 Image 组件销毁重绘！</span>
  .<span class="hljs-title function_">key</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">imagePath</span>) 
</code></pre>
<p>一旦你加了 <code>.key(this.imagePath)</code>，这就相当于告诉系统：“兄弟，路径变了，这已经不是刚才那张图了，你赶紧重新加载一下！” 这一招，对解决真机资源加载滞后、不刷新的问题，<strong>百试百灵</strong>！</p>
<hr/>
<h2 data-id="heading-12">悬案四：WebViewController 的“黑屏诅咒”</h2>
<h3 data-id="heading-13">📃 案发现场</h3>
<p>在鸿蒙里嵌入 H5 页面很常见吧？V 哥我当时用 <code>Web</code> 组件加载一个第三方的 URL。</p>
<p>开发阶段一切正常。结果到了测试环境，<strong>页面偶尔一进去就是黑屏，啥也没有，控制台还不报错！</strong> 简直就是见了鬼。</p>
<h3 data-id="heading-14">🔍 侦破过程</h3>
<p>这种不报错的 Bug 最难搞。后来 V 哥我发现，这跟 H5 页面的加载速度和 Web 组件的初始化有关。</p>
<p>当 Web 组件还没完全准备好，或者 H5 页面内部 JS 执行出错卡住了，鸿蒙这边的 Web 内核有时候就会“死机”，呈现一片死寂的黑色。</p>
<h3 data-id="heading-15">✅ 终极解决方案</h3>
<p>咱们得像带孩子一样，盯着它！</p>
<ol>
<li><strong>监听生命周期：</strong> 必须配合 <code>onPageEnd</code> 和 <code>onError</code> 事件。</li>
<li><strong>注入诊断脚本：</strong> 在 H5 加载前，注入一段 JS 去探活。</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title class_">Web</span>({ <span class="hljs-attr">src</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">url</span>, <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span> })
  .<span class="hljs-title function_">onPageEnd</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 页面加载结束了，如果还是黑屏，说明出问题了</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"页面加载结束"</span>);
  })
  .<span class="hljs-title function_">onErrorReceive</span>(<span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
    <span class="hljs-comment">// 捕获错误</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"Web加载失败: "</span> + event.<span class="hljs-title function_">getError</span>().<span class="hljs-title function_">toString</span>());
    <span class="hljs-comment">// 这里可以弹个窗，或者加载一个本地错误的 HTML</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">loadUrl</span>(<span class="hljs-string">'resource:///rawfile/error.html'</span>);
  })
  .<span class="hljs-title function_">domStorageAccess</span>(<span class="hljs-literal">true</span>)
</code></pre>
<p>最关键的一招：<strong>不要在 Controller 没初始化完成的时候就急着 <code>loadUrl</code></strong>。如果你是在 <code>aboutToAppear</code> 里初始化 Web 组件，最好延时个几百毫秒，或者确保 Controller 实例化完毕再操作。给它一点喘息的时间，黑屏就消失了。</p>
<hr/>
<h2 data-id="heading-16">V 哥总结陈词</h2>
<p>兄弟们，这就是 V 哥亲测的鸿蒙开发四大“悬案”。</p>
<p>其实总结下来，鸿蒙开发虽然新，但万变不离其宗：</p>
<ol>
<li><strong>状态管理要搞清引用关系</strong>（Observed/ObjectLink 用起来）。</li>
<li><strong>事件传递要防冒泡</strong>（hitTestBehavior 设起来）。</li>
<li><strong>真机性能要考虑时差</strong>（Key 和 Loading 加起来）。</li>
<li><strong>混合开发要做好容错</strong>（生命周期监听起来）。</li>
</ol>
<p>遇到 Bug 别慌，别砸键盘，更别怀疑人生。把这些坑踩平了，你就是鸿蒙圈里的老司机！</p>
<p>*<em>我是V哥，关注我，一起搞鸿蒙呀！手搓了三本鸿蒙教材，学完即可体系化掌握鸿蒙开发。</em>
*</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51a289da26814dfd808b3c1c0d23dc1f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aiB5ZOl54ix57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768552480&amp;x-signature=qbREfY0w7Ep8R8o5%2BC4aManSrQQ%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[学习一些常用的混合模式之BlendMode. dstIn]]></title>    <link>https://juejin.cn/post/7592990758475972627</link>    <guid>https://juejin.cn/post/7592990758475972627</guid>    <pubDate>2026-01-09T08:35:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592990758475972627" data-draft-id="7592887786967515172" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="学习一些常用的混合模式之BlendMode. dstIn"/> <meta itemprop="keywords" content="Android,Flutter"/> <meta itemprop="datePublished" content="2026-01-09T08:35:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="火柴就是我"/> <meta itemprop="url" content="https://juejin.cn/user/272334614705575"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            学习一些常用的混合模式之BlendMode. dstIn
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/272334614705575/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    火柴就是我
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T08:35:53.000Z" title="Fri Jan 09 2026 08:35:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>Keeps the destination pixels that cover source pixels, discards the remaining source and destination pixels</code></p>
<p>公式：</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3683f4fbfca43778a3ffba676115d75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Gr5p-05bCx5piv5oiR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768552553&amp;x-signature=WBqupaJOZJH65uKYskSGs8dmxdI%3D" alt="image.png" width="30%" loading="lazy"/>
<p>代码:</p>
<pre><code class="hljs language-js" lang="js">    canvas.<span class="hljs-title function_">saveLayer</span>(<span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height), <span class="hljs-title class_">Paint</span>());
    <span class="hljs-title class_">Paint</span> dstPaint = <span class="hljs-title class_">Paint</span>()..<span class="hljs-property">color</span> = <span class="hljs-title class_">Colors</span>.<span class="hljs-property">red</span>;
    dstPaint.<span class="hljs-property">style</span> = ui.<span class="hljs-property">PaintingStyle</span>.<span class="hljs-property">fill</span>;
    canvas.<span class="hljs-title function_">drawImageRect</span>(image1!, <span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, image!.<span class="hljs-property">width</span>.<span class="hljs-title function_">toDouble</span>(), image!.<span class="hljs-property">height</span>.<span class="hljs-title function_">toDouble</span>()), <span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width/<span class="hljs-number">2</span>, height/<span class="hljs-number">2</span>), dstPaint);


    <span class="hljs-keyword">var</span> srcPaint = <span class="hljs-title class_">Paint</span>()
      ..<span class="hljs-property">color</span> = <span class="hljs-title class_">Colors</span>.<span class="hljs-property">red</span>
      ..<span class="hljs-property">blendMode</span> = ui.<span class="hljs-property">BlendMode</span>.<span class="hljs-property">dstIn</span>; <span class="hljs-comment">// 源颜色：蓝色; // 混合模式</span>
    canvas.<span class="hljs-title function_">drawRect</span>(<span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height).<span class="hljs-title function_">deflate</span>(<span class="hljs-number">30</span>), srcPaint);

    canvas.<span class="hljs-title function_">restore</span>();
</code></pre>
<p>效果图:</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0add7846f434f89ae91841d9f65fd46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Gr5p-05bCx5piv5oiR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768552553&amp;x-signature=EUYL%2F6gX7RDi%2F4pG9N9kVM7yORQ%3D" alt="image.png" width="30%" loading="lazy"/>
<p>可以看到重合部分保留了dst，非重合部分dst保留,src全部清空。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2026年的IT圈，看看谁在“裸泳”，谁在“吃肉”]]></title>    <link>https://juejin.cn/post/7593139476839874566</link>    <guid>https://juejin.cn/post/7593139476839874566</guid>    <pubDate>2026-01-09T08:33:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593139476839874566" data-draft-id="7592887786967531556" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2026年的IT圈，看看谁在“裸泳”，谁在“吃肉”"/> <meta itemprop="keywords" content="后端,HarmonyOS,AI编程"/> <meta itemprop="datePublished" content="2026-01-09T08:33:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="威哥爱编程"/> <meta itemprop="url" content="https://juejin.cn/user/2242659450109575"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2026年的IT圈，看看谁在“裸泳”，谁在“吃肉”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2242659450109575/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    威哥爱编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T08:33:33.000Z" title="Fri Jan 09 2026 08:33:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Hello，兄弟们，我是V哥！</p>
<p>最近不少粉丝私信问我：“V哥，现在这行情卷得跟麻花似的，35岁危机就在眼前，你说咱们搞IT的，到了2026年还有出路吗？这技术迭代快得像坐火箭，我到底该往哪边押注？”</p>
<p>V哥我就一句话：<strong>焦虑个屁！机会全是给有准备的人留着的。</strong></p>
<p>你们现在看是“寒冬”，V哥我看是“洗牌”。等到2026年，IT行业的格局早就翻天覆地了。那些只会写重复代码的“代码搬运工”确实该慌，但懂趋势、会借力的兄弟，那会儿绝对是香饽饽。</p>
<p>今天，V哥我就掏心窝子地聊聊，2026年咱们这行的几大“风口”。特别是最后两块大肉，听进去了，你下半年的年终奖就稳了。</p>
<hr/>
<h2 data-id="heading-0">一、 AI智能体开发：2026年的“新物种”</h2>
<p>兄弟们，先把“ChatGPT”这种对话机器人放一边。V哥告诉你，<strong>2026年是AI智能体爆发的一年。</strong></p>
<p>啥叫智能体？现在的AI像个博学的书呆子，你问它答。而智能体，那是<strong>带着“脑子”和“手脚”的打工人</strong>。它不仅能理解你的意图，还能自己拆解任务、自己去调用工具、自己反思纠错，最后把活儿干完了给你交差。</p>
<ul>
<li><strong>现在是：</strong> 你写代码，AI帮你补全一行。</li>
<li><strong>2026年是：</strong> 你说“帮我做个电商后台”，智能体自己写代码、自己测、自己部署、甚至自己写文档。</li>
</ul>
<p><strong>V哥的研判：</strong>
到了2026年，不会开发智能体的程序员，就像2010年不会用智能手机的人一样落伍。你不需要自己去造一个大模型（那是大厂的事儿），你需要做的是<strong>做中间的“Controller”（控制器）</strong>。怎么用LangChain（或者那时候更牛的框架）把大模型串起来？怎么给智能体挂载API接口？怎么设计它的“记忆”和“规划”能力？</p>
<p>这块儿目前还是蓝海，谁能率先把“数字员工”搞定，谁就是那个省下百万人力成本的老板眼里的红人。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcf1d98b4c8f4d2e89f6ef46aeb247f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aiB5ZOl54ix57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768552413&amp;x-signature=USweinompOAVWQ1VxQejXAPBQMs%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-1">二、 鸿蒙开发：国产操作系统的“成年礼”</h2>
<p>这块儿，V哥必须得敲黑板！这可能是未来几年里，中国普通程序员最大的<strong>红利期</strong>。</p>
<p>别总盯着Android和iOS卷了，那是存量市场，杀得头破血流。你看华为现在的动作，<strong>HarmonyOS NEXT（纯血鸿蒙）</strong> 已经切断了对安卓代码的依赖。这意味什么？意味着这不仅仅是换个皮肤，这是一套全新的、独立的生态！</p>
<p><strong>V哥的预言：</strong>
到了2026年，鸿蒙不再是手机的配角，而是<strong>全场景（手机、车机、家电、工控）的霸主</strong>。</p>
<ul>
<li><strong>技术栈：</strong> 赶紧把ArkTS（Ark TypeScript）学熟了，ArkUI这套声明式开发范式非常顺手。</li>
<li><strong>机会在哪？</strong> 现在市面上大量的APP都需要重构鸿蒙原生版。这中间有一个巨大的缺口！前两年进去的那批人，现在都成技术总监了。2026年，随着万物互联真正落地，鸿蒙开发者的薪资会比同级别的安卓开发高出至少30%。</li>
</ul>
<p>V哥我一直说，<strong>技术要跟着国运走</strong>。鸿蒙这条路，不仅是写代码，更是在参与基础设施建设。这碗饭，香！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8158163a6d5145528b9b13ac6d35e2a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aiB5ZOl54ix57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768552413&amp;x-signature=8Y6RB2MA98F2ASU8WO1ZEXRtSfg%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-2">三、 后端开发：告别“CRUD”，拥抱“编排”</h2>
<p>兄弟们，别再笑话写Java/Go的后端枯燥了。虽然简单的增删改查（CRUD）真的会被AI干掉，但<strong>后端的逻辑核心地位永远不会动摇</strong>。</p>
<p>2026年的后端，不再是单纯的写接口，而是<strong>做“AI时代的管家”</strong>。</p>
<p>以前你的服务是给前端APP用的，2026年，你的服务大部分是给上面的“AI智能体”用的。智能体需要调用你的数据库、调用你的业务逻辑。你的接口设计得更规范、更原子化、响应更快。</p>
<p><strong>V哥建议：</strong>
Go语言和Rust会在后端越来越火（因为性能好、并发强）。而且，后端得懂点<strong>云原生</strong>，容器化、Service Mesh（服务网格）这些都是标配。你得学会怎么把一个庞大的系统拆得碎碎的，还能用AI把它们管得服服帖帖。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba591ec95bae4fb68e775efeb0f65fba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aiB5ZOl54ix57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768552413&amp;x-signature=DIaI%2BJ1DU7pGh1NIq2I7UnaM5EY%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-3">四、 前端开发：从“画页面”到“造体验”</h2>
<p>前端死了吗？V哥告诉你，前端才刚刚开始“性感”起来。</p>
<p>写HTML/CSS这种活儿，2026年估计UI设计师直接说一句话，AI就生成了。那前端干嘛？<strong>前端负责“交互的灵魂”</strong>。</p>
<p>随着WebGPU的普及，浏览器里能跑3D大作、能跑复杂的物理引擎。鸿蒙的ArkUI也是跨端的前端技术。未来的前端，更多是<strong>图形学、人机交互和3D可视化</strong>。你打开一个网页，不再是看图文，而是进入一个虚拟空间，这背后全是前端工程师的功力。</p>
<p><strong>V哥一句话：</strong> 放下jQuery，搞深Three.js，搞透React/Vue原理，往图形学和全栈方向发展。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32f20db62bf54ff4b0241059a914fd06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aiB5ZOl54ix57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768552413&amp;x-signature=11ttf6XDgDjV1otbAXBZgnOYI6A%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-4">五、 嵌入式开发：软硬件结合的“硬核浪漫”</h2>
<p>以前搞嵌入式感觉是“修收音机的”，2026年搞嵌入式那是“造智能机器人”的。</p>
<p>因为上面说的<strong>鸿蒙</strong>和<strong>AI</strong>，最后都要落脚到硬件上。智能眼镜、智能家电、自动驾驶，哪个离得开嵌入式？</p>
<p><strong>重点来了：</strong> 嵌入式未来会和AI深度融合，叫<strong>TinyML（微型机器学习）</strong>。在芯片上跑小型的AI模型，让摄像头能识别人脸，让传感器能听懂声音。如果你既懂C语言底层，又懂一点AI算法部署，你是各大硬件厂抢着要的“国宝”。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7547c2a6c8be45c89e4ce5ef087643ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aiB5ZOl54ix57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768552413&amp;x-signature=2pLRkVyQyLI7eckVwDHDdrYiYcU%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-5">六、 大数据开发：从“存数据”到“喂AI”</h2>
<p>大数据没凉，只是换了个活法。</p>
<p>前几年大家搞Hadoop、Spark，是为了存日志、做报表。2026年，搞大数据主要是为了<strong>给AI当“饲养员”</strong>。</p>
<p>AI需要高质量的数据清洗、向量化处理。这就涉及到<strong>向量数据库</strong>、数据湖、实时计算流。怎么把企业的几十亿条数据，变成AI能看懂的“知识”，这是大数据工程师的新活儿。不懂AI的数据工程师，未来路会越走越窄。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a96826a1cb6c418694096d6ce6246af9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aiB5ZOl54ix57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768552413&amp;x-signature=fhfzp8QxJTZT7IGJvmm6u5RtBJA%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-6">七、 AI运维与 AI测试：机器管机器</h2>
<p>最后说说这两个容易被忽视的领域。</p>
<ul>
<li><strong>AI运维：</strong> 以前服务器报警了，运维兄弟半夜爬起来看日志。2026年，AI运维系统会自动定位故障、自动修复、自动扩容。运维工程师不需要敲那么多命令了，而是负责训练这个“运维AI”，制定策略。这叫<strong>SRE（站点可靠性工程）的进化版</strong>。</li>
<li><strong>AI测试：</strong> 测试不仅是找Bug，更是“攻防演练”。用AI去生成几万条变态测试用例去轰炸你的系统，甚至用AI去对抗AI生成的代码。只有AI才能测出AI写的Bug。</li>
</ul>
<hr/>
<h2 data-id="heading-7">V哥总结一下</h2>
<p>兄弟们，2026年其实并不远。</p>
<p>V哥我看了一圈，未来的趋势就两个字：<strong>融合</strong>。</p>
<ul>
<li><strong>鸿蒙</strong>是万物互联的底座，必须要抓；</li>
<li><strong>AI智能体</strong>是提升效率的神器，必须要懂；</li>
<li>其他所有的后端、前端、嵌入式、数据，都要围绕着这两者去进化。</li>
</ul>
<p>别再纠结Java还是Python，Go还是Rust了。语言只是工具，<strong>解决问题的思路才是王道</strong>。从今天起，试着用AI去帮你干活，试着去了解一下鸿蒙的ArkTS，试着把你的工作流程“智能化”。</p>
<p>等到了2026年，当别人还在为裁员瑟瑟发抖时，V哥希望看到你已经站在风口上，笑傲江湖！</p>
<p><strong>我是V哥，带你不仅看懂技术，更看懂未来。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[当多态在构造中“失效”的那一刻]]></title>    <link>https://juejin.cn/post/7593098101431697462</link>    <guid>https://juejin.cn/post/7593098101431697462</guid>    <pubDate>2026-01-09T08:39:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593098101431697462" data-draft-id="7592990758476005395" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="当多态在构造中“失效”的那一刻"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-09T08:39:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            当多态在构造中“失效”的那一刻
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T08:39:01.000Z" title="Fri Jan 09 2026 08:39:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/317ad1da83d244169a4ac9631aaa961c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqL5ryr6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768552741&amp;x-signature=sADZiG4NXiKNkiKUXeVvYquMtAA%3D" alt="image.png" loading="lazy"/></p>
<p>凌晨两点，我的手机突然震动起来。屏幕上显示着同事小张的名字——一位有着五年经验的C++开发者。接起电话，那头传来他困惑而急切的声音：</p>
<p>“我刚刚在调试一个奇怪的崩溃问题。在基类的构造函数中调用了一个虚函数，但它没有按我预期的那样调用派生类的实现，而是调用了基类自己的版本！这怎么可能？虚函数的多态性不是C++的基石吗？”</p>
<p>电话挂断后，我陷入了沉思。小张遇到的问题，正是C++多态机制中最微妙、最容易误解的部分。这个看似简单的现象背后，隐藏着虚函数机制的全部秘密——从内存布局到生命周期，从编译时决定到运行时行为。</p>
<h2 data-id="heading-0">问题的冰山一角</h2>
<p>小张的困惑并非个例。在C++的世界里，虚函数机制就像一座冰山：</p>
<p><strong>水面之上</strong>，是我们熟悉的：通过基类指针调用派生类方法，实现运行时多态。</p>
<p><strong>水面之下</strong>，则是错综复杂的机制：虚函数指针、虚函数表、构造顺序、析构时机……这些概念共同构成了C++多态的基础设施。</p>
<p>让我们跟随小张的调试路径，一步步揭开虚函数的神秘面纱。</p>
<h2 data-id="heading-1">虚函数指针的诞生时刻</h2>
<p>小张首先想知道的是：<strong>虚函数指针和虚函数表是什么时候初始化的？</strong></p>
<p>这是一个关键问题。想象一下，当我们在堆上创建一个派生类对象时：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">Base</span>() { 
        <span class="hljs-comment">// 此时虚函数机制处于什么状态？</span>
    }
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">show</span><span class="hljs-params">()</span> </span>{ cout &lt;&lt; <span class="hljs-string">"Base"</span> &lt;&lt; endl; }
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Derived</span> : <span class="hljs-keyword">public</span> Base {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">Derived</span>() : <span class="hljs-built_in">Base</span>() {}
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">show</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{ cout &lt;&lt; <span class="hljs-string">"Derived"</span> &lt;&lt; endl; }
};

Derived* d = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Derived</span>();  <span class="hljs-comment">// 这里发生了什么？</span>
</code></pre>
<p>在对象构造的舞蹈中，编译器是严谨的编舞者：</p>
<ol>
<li><strong>分配内存</strong>：首先为整个对象分配足够的内存空间</li>
<li><strong>设置vptr</strong>：在进入构造函数体<strong>之前</strong>，编译器插入代码设置当前类的vptr</li>
<li><strong>构造基类</strong>：调用基类构造函数，此时vptr指向基类的虚函数表</li>
<li><strong>更新vptr</strong>：基类构造完成后，vptr被更新为指向派生类的虚函数表</li>
<li><strong>构造成员</strong>：初始化派生类的数据成员</li>
<li><strong>执行构造函数体</strong>：最后执行我们在代码中编写的构造函数逻辑</li>
</ol>
<p>这意味着在基类构造函数执行期间，对象的“类型身份”仍然是基类。这就是为什么小张在基类构造函数中调用虚函数时，看到的是基类版本。</p>
<h2 data-id="heading-2">每个对象都有自己的虚函数指针吗？</h2>
<p>理解初始化时机的答案后，小张自然想到下一个问题：<strong>虚函数指针是每一个对象一份吗？</strong></p>
<p>是的，但有一个重要的区分。每个含有虚函数的类对象在内存布局中都有一个隐藏的成员——虚函数指针（vptr）。这个指针是对象的一部分，随对象创建而创建，随对象销毁而销毁。</p>
<p>然而，所有同类型的对象共享同一个<strong>虚函数表</strong>（vtable）。这个表在编译期生成，存储在程序的只读数据段中，包含了该类所有虚函数的地址。</p>
<pre><code class="hljs language-cpp" lang="cpp">Derived d1, d2, d3;
<span class="hljs-comment">// d1, d2, d3 各自有自己的vptr</span>
<span class="hljs-comment">// 但它们的vptr都指向同一个Derived类的vtable</span>
</code></pre>
<p>这种设计巧妙平衡了空间效率和时间效率：每个对象只需付出一个指针的代价，就能获得完整的动态分派能力。</p>
<h2 data-id="heading-3">派生类会继承虚函数吗？</h2>
<p>小张继续追问：<strong>派生类会继承虚函数吗？</strong></p>
<p>这个问题的答案需要精确表述。派生类继承的是虚函数的<strong>接口</strong>和<strong>调用约定</strong>，但不一定继承具体的<strong>实现</strong>。派生类可以选择：</p>
<ol>
<li><strong>覆盖（override）</strong>：提供自己的实现</li>
<li><strong>不覆盖</strong>：隐式继承基类的实现</li>
<li><strong>隐藏</strong>：通过同名非虚函数隐藏基类虚函数（不推荐）</li>
</ol>
<p>更重要的是，每个派生类都有自己的虚函数表。这个表是从基类的虚函数表“扩展”而来——复制基类的条目，然后用派生类的覆盖实现替换相应的条目。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">speak</span><span class="hljs-params">()</span> </span>= <span class="hljs-number">0</span>;      <span class="hljs-comment">// 纯虚函数，必须被覆盖</span>
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">breathe</span><span class="hljs-params">()</span> </span>{ ... } <span class="hljs-comment">// 有默认实现，可选择覆盖</span>
    <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">Animal</span>() {}           <span class="hljs-comment">// 虚析构函数</span>
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> : <span class="hljs-keyword">public</span> Animal {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">speak</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{ cout &lt;&lt; <span class="hljs-string">"Woof!"</span> &lt;&lt; endl; }  <span class="hljs-comment">// 必须实现</span>
    <span class="hljs-comment">// breathe()使用继承的Animal版本</span>
    <span class="hljs-comment">// 析构函数自动成为虚函数</span>
};
</code></pre>
<h2 data-id="heading-4">派生类会继承基类的虚函数指针吗？</h2>
<p>理解了继承关系后，小张提出了一个精妙的问题：<strong>派生类会继承基类的虚函数指针吗？</strong></p>
<p>答案是否定的，这一点至关重要。派生类<strong>不会</strong>继承基类的vptr。相反：</p>
<ol>
<li>当创建派生类对象时，编译器会确保对象中包含一个vptr</li>
<li>这个vptr在构造过程中会变化：先指向基类的vtable，然后指向派生类的vtable</li>
<li>如果存在多层继承，每个完整的对象仍然只有一个vptr（在单继承情况下）</li>
</ol>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> { <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">f</span><span class="hljs-params">()</span> </span>{} };
<span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> : <span class="hljs-keyword">public</span> A { <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">g</span><span class="hljs-params">()</span> </span>{} };
<span class="hljs-keyword">class</span> <span class="hljs-title class_">C</span> : <span class="hljs-keyword">public</span> B { <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">h</span><span class="hljs-params">()</span> </span>{} };

C obj;
<span class="hljs-comment">// obj内部只有一个vptr，但指向的vtable包含A::f, B::g, C::h的条目</span>
</code></pre>
<p>在多继承的情况下，情况更复杂：对象可能包含多个vptr，每个对应一个含有虚函数的基类。</p>
<h2 data-id="heading-5">虚函数指针属于类还是属于对象？</h2>
<p>小张的问题越来越深入：<strong>虚函数指针属于类还是属于对象？</strong></p>
<p>这是理解整个机制的核心。我们需要明确区分：</p>
<p><strong>虚函数指针（vptr）属于对象</strong>：</p>
<ul>
<li>每个对象实例都有自己的vptr</li>
<li>vptr的值在对象生命周期内可能改变（构造/析构时）</li>
<li>vptr是对象的“身份标识”，决定了运行时类型</li>
</ul>
<p><strong>虚函数表（vtable）属于类</strong>：</p>
<ul>
<li>每个类只有一个vtable，被该类的所有对象共享</li>
<li>vtable在编译期生成，存在于程序的数据段</li>
<li>vtable的内容在运行时不变</li>
</ul>
<p>这种分离设计是C++静态类型系统和动态多态的桥梁。编译器通过vtable在编译期建立函数映射，运行时通过vptr选择正确的函数实现。</p>
<h2 data-id="heading-6">为什么构造/析构期间虚函数行为受限？</h2>
<p>现在我们可以回答小张最初的问题了：<strong>为什么在构造/析构期间虚函数的多态行为受限？</strong></p>
<p>这背后有三个主要原因：</p>
<h3 data-id="heading-7">1. 类型安全的保护屏障</h3>
<p>在对象构造过程中，对象处于“正在构建”的状态。如果允许在基类构造函数中调用派生类的虚函数，可能会访问尚未初始化的派生类成员，导致未定义行为。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">Base</span>() { 
        <span class="hljs-built_in">log</span>();  <span class="hljs-comment">// 安全：调用Base::log()</span>
    }
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">log</span><span class="hljs-params">()</span> </span>{ <span class="hljs-comment">/* 记录基类信息 */</span> }
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Derived</span> : <span class="hljs-keyword">public</span> Base {
    Data* data;  <span class="hljs-comment">// 派生类特有成员</span>
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">Derived</span>() : <span class="hljs-built_in">Base</span>(), <span class="hljs-built_in">data</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Data</span>()) {}
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">log</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{ 
        data-&gt;<span class="hljs-built_in">process</span>();  <span class="hljs-comment">// 危险！此时data可能尚未初始化</span>
    }
};
</code></pre>
<h3 data-id="heading-8">2. 对象状态的演变过程</h3>
<p>构造是从基类到派生类的“自下而上”过程，析构是“自上而下”的逆过程。在这两个过程中，对象的类型身份是动态变化的：</p>
<ul>
<li>构造时：Base → Derived（vptr从Base的vtable变为Derived的vtable）</li>
<li>析构时：Derived → Base（vptr从Derived的vtable变回Base的vtable）</li>
</ul>
<p>这种变化确保了在任何时刻，对象的当前“有效类型”与已构造的部分相匹配。</p>
<h3 data-id="heading-9">3. C++标准的明确规定</h3>
<p>C++标准明确规定了这一行为（ISO/IEC 14882:2020 §15.7）：</p>
<blockquote>
<p>“当从构造函数或析构函数直接或间接调用虚函数时，被调用的函数是构造函数或析构函数所在类的版本，而不是在派生类中覆盖的版本。”</p>
</blockquote>
<p>这不是编译器的bug或限制，而是经过深思熟虑的语言设计选择，旨在提供确定性和类型安全。</p>
<h2 data-id="heading-10">从困惑到理解</h2>
<p>回顾小张的调试之旅，他从一个具体的崩溃现象出发，通过层层追问，最终理解了C++多态机制的完整图景：</p>
<ol>
<li><strong>时机问题</strong> → 理解构造/析构的顺序和vptr的初始化</li>
<li><strong>数量问题</strong> → 区分vptr（每个对象）和vtable（每个类）</li>
<li><strong>继承问题</strong> → 理清接口继承和实现覆盖的关系</li>
<li><strong>关系问题</strong> → 明确派生类不继承基类vptr</li>
<li><strong>所有权问题</strong> → 区分对象级和类级的不同责任</li>
<li><strong>行为问题</strong> → 理解类型安全和对象状态演变的必要性</li>
</ol>
<p>这六个问题恰好构成了理解C++虚函数机制的完整认知链条。每个问题都像拼图的一块，最终拼出了完整的画面。</p>
<h2 data-id="heading-11">安全使用虚函数的准则</h2>
<p>基于这些理解，我们可以总结出一些最佳实践：</p>
<ol>
<li><strong>避免在构造/析构中调用虚函数</strong>：如果必须调用，确保理解其限制</li>
<li><strong>使用非虚接口（NVI）模式</strong>：将虚函数设为private，通过public非虚函数调用</li>
<li><strong>总是声明虚析构函数</strong>：在多态基类中，避免资源泄漏</li>
<li><strong>理解对象切片</strong>：按值传递多态对象时会丢失虚函数特性</li>
<li><strong>谨慎使用dynamic_cast</strong>：理解RTTI的代价和适用场景</li>
</ol>
<h2 data-id="heading-12">最后</h2>
<p>虚函数机制的限制不是C++的缺陷，而是其哲学理念的体现：赋予程序员最大自由的同时，通过编译期检查和运行时保护防止常见错误。它平衡了效率与安全、灵活性与确定性、抽象能力与具体控制。</p>
<p>下次当你在构造函数中意外发现虚函数没有按预期工作时，不要感到困惑或沮丧。这正是C++在默默守护你，防止你踏入未初始化数据的危险领域。理解这些机制，你就能更好地驾驭这门强大而复杂的语言，写出既高效又安全的代码。</p>
<p>虚函数的故事告诉我们：在编程中，有时候限制不是束缚，而是保护；不是bug，而是feature。真正的掌握来自于理解“为什么”而不仅仅是“怎么样”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ooder SkillFlow：破解 AI 编程冲击，重构企业级开发全流程]]></title>    <link>https://juejin.cn/post/7593139476839923718</link>    <guid>https://juejin.cn/post/7593139476839923718</guid>    <pubDate>2026-01-09T08:37:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593139476839923718" data-draft-id="7593139476839907334" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ooder SkillFlow：破解 AI 编程冲击，重构企业级开发全流程"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-09T08:37:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OneCodeCN"/> <meta itemprop="url" content="https://juejin.cn/user/1427583415622366"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ooder SkillFlow：破解 AI 编程冲击，重构企业级开发全流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1427583415622366/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OneCodeCN
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T08:37:02.000Z" title="Fri Jan 09 2026 08:37:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在AI编程工具普及的当下，软件企业正面临双重困境：一方面，AI生成能力碎片化，代码、测试、优化工具各自为战，难以形成协同合力；另一方面，传统开发流程的跨角色协作壁垒、流程节点割裂、能力复用难等问题被放大，导致开发周期冗长、迭代效率低下，AI工具的潜力难以充分释放。</p>
<p>基于AgentSkill模型的SkillFlow，以“智能编排+自动执行+人机协同”为核心解决方案，彻底重构企业级开发流程：它以Skill（最小开发能力单元）为核心，通过MCP统一管控、Agent驱动流转、A2UI精准补位，将“需求定义-代码生成-测试优化-交付发布”串联成无缝衔接的智能流程，既承接AI编程的高效能力，又解决传统流程的协同痛点，实现开发全链路的标准化、高效化与可复用。</p>
<p>以下结合Ooder框架的8步编码流程，重构为SkillFlow为中心的企业级AI开发流程，突出其自动化编排、注解驱动复用、人机协同的核心优势，适配企业级大规模开发需求。</p>
<h2 data-id="heading-0">一、核心定位：SkillFlow——贯穿开发全流程的智能编排中枢</h2>
<p>SkillFlow并非孤立的流程环节，而是深度融入开发全链路的“智能大脑”，核心价值在于“让开发能力按业务逻辑流畅流转”，实现AI能力与人工决策的精准协同：</p>
<ul>
<li>场景化上下文管控：以“软件开发场景（SOFTWARE_DEVELOPMENT）”为核心，MCP构建专属Context（DEV_CONTEXT），统一存储需求文档、代码版本、角色权限、架构规范等全流程数据，确保AI工具与人工操作的数据一致性；</li>
<li>自动化流程驱动：Agent作为“开发流程执行器”，驱动各环节Skill自动化执行（如AI代码生成、自动化测试、智能优化），通过Route规则精准控制流转路径（如“元数据定义→代码编写→自动化测试→人工评审→性能优化”），无需人工手动衔接；</li>
<li>精准人机协同：A2UI作为“人机协同接口”，仅在核心决策环节（如架构确认、质量评审）接入人工，且通过RightEngine精准管控角色权限（如架构师负责架构审核、开发人员负责代码校验），避免冗余干预；</li>
<li>可复用能力原子：Skill作为“开发能力最小单元”，覆盖“元数据生成、代码编写、自动化测试、性能优化”等全流程能力，支持注解驱动定义，可跨项目、跨场景复用。</li>
</ul>
<p>简单来说：传统开发流程是“环节孤立、人工衔接、AI工具碎片化”，SkillFlow流程是“能力串联、自动流转、AI+人工精准协同”，通过标准化编排让开发效率提升50%以上，同时保障代码质量与合规性。</p>
<h2 data-id="heading-1">二、SkillFlow驱动的8步开发流程（AI+人工协同闭环）</h2>
<h3 data-id="heading-2">步骤1：元数据定义SkillFlow——AI自动生成+实时验证</h3>
<p>目标：快速生成标准化元数据，奠定开发基础，通过AI自动化生成+开发人员实时验证，确保元数据符合企业架构规范，替代传统“元数据方案反复沟通”。</p>
<h4 data-id="heading-3">SkillFlow流转逻辑</h4>
<ul>
<li>MCP：初始化“软件开发场景（SOFTWARE_DEVELOPMENT）”和“开发流程上下文（DEV_CONTEXT）”，存储项目架构规范、模块划分、命名规则等基础信息；</li>
<li>Agent：元数据生成Agent（复用ActivityBlock，无状态设计，节省资源），负责调用相关Skill并控制流转；</li>
<li>Skill：MetadataGenerateSkill（注解驱动，绑定软件开发场景），由大模型驱动，根据MCP中的架构规范，自动生成视图元数据、模块关联关系代码；</li>
<li>A2UI：元数据验证A2UI，开发人员通过可视化界面实时校验元数据与模块的映射关系，反馈结果直接写入Context。</li>
</ul>
<h4 data-id="heading-4">执行流程</h4>
<ol>
<li>项目管理人员通过MCP提交需求（如“电商系统订单模块元数据定义”），明确模块边界和架构要求；</li>
<li>MCP触发元数据生成Agent，调用MetadataGenerateSkill（注解定义如下），大模型基于Context中的规范自动生成元数据代码；</li>
<li>开发人员通过A2UI可视化界面查看生成结果，确认元数据与模块匹配无误后，点击“验证通过”，结果同步至MCP；若需修改，直接在界面提交调整需求，Agent触发Skill重新生成，无需反复提交文档。</li>
</ol>
<h4 data-id="heading-5">示例：元数据定义Skill注解（可直接复用）</h4>
<pre><code class="hljs language-ini" lang="ini">@SkillAnnotation(
    <span class="hljs-attr">name</span> = <span class="hljs-string">"MetadataGenerateSkill"</span>,
    <span class="hljs-attr">description</span> = <span class="hljs-string">"软件开发场景元数据生成Skill"</span>,
    <span class="hljs-attr">scenes</span> = {Scene.SOFTWARE_DEVELOPMENT},
    <span class="hljs-attr">contexts</span> = {Context.DEV_CONTEXT},
    <span class="hljs-attr">version</span> = <span class="hljs-string">"1.0"</span>,
    <span class="hljs-attr">isCore</span> = <span class="hljs-literal">true</span>
)
public class MetadataGenerateSkillImpl implements MetadataGenerateSkill {
    @ContextAnnotation(<span class="hljs-attr">value</span> = Context.DEV_CONTEXT, required = <span class="hljs-literal">true</span>)
    private DevContext devContext<span class="hljs-comment">;</span>
    
    @Override
    public MetadataResult generate(MetadataRequest request) {
        // 大模型驱动，根据devContext中的架构规范生成元数据代码
        String <span class="hljs-attr">metadataCode</span> = llmClient.generateMetadata(request, devContext.getArchitectureSpec())<span class="hljs-comment">;</span>
        return new MetadataResult(metadataCode, devContext.getModuleMapping())<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p>复制</p>
<h3 data-id="heading-6">步骤2：钩子API创建SkillFlow——AI标准化生成+自动绑定</h3>
<p>目标：生成符合企业安全规范的钩子API，自动绑定视图与URL，构建项目目录结构，无需人工手动配置，避免API设计不统一、安全漏洞等问题。</p>
<h4 data-id="heading-7">SkillFlow流转逻辑</h4>
<ul>
<li>MCP：在DEV_CONTEXT中补充API设计规范、安全要求（如防注入、权限校验）、项目目录模板等信息；</li>
<li>Agent：API生成Agent，并行调用“钩子API生成Skill”和“项目目录构建Skill”，提升执行效率；</li>
<li>Skill：HookApiGenerateSkill（大模型驱动，生成标准化API代码）、ProjectStructureSkill（联动RAD工具，自动构建项目目录）；</li>
<li>A2UI：API校验A2UI，架构师通过界面审核API的兼容性、安全性，确认后触发RAD图形编译。</li>
</ul>
<h4 data-id="heading-8">执行流程</h4>
<ol>
<li>Agent接收MCP指令，并行调用HookApiGenerateSkill和ProjectStructureSkill，避免串行等待；</li>
<li>HookApiGenerateSkill根据Context中的安全规范，自动生成含防注入、权限校验的钩子API代码，无需人工编写重复逻辑；</li>
<li>ProjectStructureSkill联动RAD工具，按企业标准模板自动构建目录和菜单，确保项目结构统一；</li>
<li>架构师通过A2UI快速审核API代码，确认无误后SkillFlow自动流转至原型设计阶段，无需人工提交流转申请。</li>
</ol>
<h3 data-id="heading-9">步骤3：原型设计SkillFlow——AI可视化生成+需求实时交互</h3>
<p>目标：快速构建高保真原型，同步收集客户、业务人员反馈，确保需求精准落地，减少后续返工。</p>
<h4 data-id="heading-10">SkillFlow流转逻辑</h4>
<ul>
<li>MCP：存储需求文档、客户反馈记录、UI设计规范等数据；</li>
<li>Agent：原型设计Agent，调用“原型生成Skill”，联动A2UI实现需求实时交互；</li>
<li>Skill：PrototypeGenerateSkill（大模型驱动，根据需求生成React/Flutter适配的可视化原型）；</li>
<li>A2UI：原型交互A2UI，业务人员、客户通过界面查看原型、在线标注修改意见，反馈数据实时写入Context。</li>
</ul>
<h4 data-id="heading-11">执行流程</h4>
<ol>
<li>业务人员通过MCP提交需求细节（如“订单支付页面原型要求：简洁、支持多种支付方式”）；</li>
<li>Agent调用PrototypeGenerateSkill，10分钟内生成高保真原型设计稿，支持实时预览；</li>
<li>客户通过A2UI查看原型，在线标注修改意见（如“按钮位置调整”“增加优惠券入口”），反馈自动同步至MCP；</li>
<li>Agent根据反馈触发Skill迭代原型，直至需求确认，自动流转至仓储层开发，无需人工汇总反馈、重新发起设计。</li>
</ol>
<h3 data-id="heading-12">步骤4：仓储层开发SkillFlow——AI自动化编码+单元测试</h3>
<p>目标：生成高质量仓储层代码，通过自动化测试确保数据访问逻辑合规、无Bug，减少人工编码和测试成本。</p>
<h4 data-id="heading-13">SkillFlow流转逻辑</h4>
<ul>
<li>MCP：在DEV_CONTEXT中存储数据源信息、数据访问规范、测试用例模板；</li>
<li>Agent：仓储层开发Agent，调用“仓储层代码生成Skill”和“单元测试Skill”；</li>
<li>Skill：RepositoryCodeSkill（大模型驱动，生成DAO层、服务实现代码）、UnitTestSkill（自动化生成单测用例并执行）；</li>
<li>A2UI：代码评审A2UI，开发人员查看AI生成的代码和测试报告，确认后流转至层间整合。</li>
</ul>
<h4 data-id="heading-14">执行流程</h4>
<ol>
<li>Agent触发RepositoryCodeSkill，基于Context中的数据源信息（如数据库类型、表结构）生成标准化仓储层代码，符合企业编码规范；</li>
<li>自动调用UnitTestSkill，生成单测用例并执行，输出测试覆盖率报告（要求≥80%），自动标记未覆盖场景；</li>
<li>开发人员通过A2UI查看代码和测试报告，聚焦核心业务逻辑评审，确认无问题后SkillFlow自动流转至下一步；若测试不通过，Agent触发Skill自动修复代码，无需人工重新编写。</li>
</ol>
<h3 data-id="heading-15">步骤5：层间整合SkillFlow——AI自动化整合+依赖校验</h3>
<p>目标：自动整合视图层、聚合层、仓储层代码，确保各层依赖关系清晰、无冲突，替代传统“人工整合、反复排错”。</p>
<h4 data-id="heading-16">SkillFlow流转逻辑</h4>
<ul>
<li>MCP：存储各层代码版本、依赖关系清单、整合规范；</li>
<li>Agent：层间整合Agent，调用“层间整合Skill”和“依赖校验Skill”；</li>
<li>Skill：LayerIntegrationSkill（自动整合各层代码，处理依赖注入）、DependencyCheckSkill（校验依赖冲突、版本兼容）；</li>
<li>A2UI：整合验证A2UI，开发人员人工验证层间绑定关系和功能完整性。</li>
</ul>
<h4 data-id="heading-17">执行流程</h4>
<ol>
<li>Agent调用LayerIntegrationSkill，自动整合各层代码，生成统一配置文件，处理依赖注入、接口调用等问题；</li>
<li>DependencyCheckSkill自动校验依赖冲突（如Jar包版本不兼容），输出冲突报告并自动修复常规问题（如版本适配）；</li>
<li>开发人员通过A2UI验证整合后的核心功能点（如数据流转是否正常），确认无误后流转至页面功能单测，无需人工逐行排查依赖问题。</li>
</ol>
<h3 data-id="heading-18">步骤6：页面功能单测SkillFlow——AI批量自动化测试</h3>
<p>目标：批量覆盖所有页面功能，确保交互逻辑完整、无异常，替代传统“人工编写测试脚本、逐页面测试”。</p>
<h4 data-id="heading-19">SkillFlow流转逻辑</h4>
<ul>
<li>MCP：存储页面功能清单、测试规范（如交互逻辑要求、异常场景定义）；</li>
<li>Agent：自动化测试Agent，调用“页面单测Skill”，支持批量执行；</li>
<li>Skill：PageTestSkill（大模型驱动，批量生成测试脚本，执行页面完整性、交互逻辑测试）；</li>
<li>A2UI：测试结果评审A2UI，开发人员查看测试报告，处理异常问题。</li>
</ul>
<h4 data-id="heading-20">执行流程</h4>
<ol>
<li>Agent触发PageTestSkill，批量对所有页面执行自动化测试（如按钮点击、表单提交、数据展示、异常场景模拟）；</li>
<li>测试完成后，自动生成包含“通过用例、失败用例、异常日志”的测试报告，写入Context，清晰标记问题位置；</li>
<li>开发人员通过A2UI查看报告，针对性修复失败用例，修复完成后一键重新触发测试，直至全部通过，无需人工重复执行测试。</li>
</ol>
<h3 data-id="heading-21">步骤7：聚合层优化SkillFlow——AI智能优化+性能测试</h3>
<p>目标：提升聚合层性能，满足企业级高并发、大数据量处理需求，避免上线后出现性能瓶颈。</p>
<h4 data-id="heading-22">SkillFlow流转逻辑</h4>
<ul>
<li>MCP：存储性能指标要求（如响应时间≤2秒、并发支持1000+用户）、高并发场景配置；</li>
<li>Agent：性能优化Agent，调用“聚合层优化Skill”和“性能测试Skill”；</li>
<li>Skill：AggLayerOptimizeSkill（大模型输出优化方案，自动调整代码）、PerformanceTestSkill（模拟高并发场景，测试优化效果）；</li>
<li>A2UI：优化结果确认A2UI，开发人员审核优化方案和性能报告。</li>
</ul>
<h4 data-id="heading-23">执行流程</h4>
<ol>
<li>Agent调用AggLayerOptimizeSkill，大模型基于Context中的性能要求，自动输出优化方案（如缓存策略调整、SQL优化、算法优化）并执行代码修改；</li>
<li>PerformanceTestSkill模拟高并发场景（如1000用户同时访问、大数据量查询），测试优化前后的响应时间、吞吐量、资源占用情况；</li>
<li>开发人员通过A2UI查看优化效果报告，确认满足性能要求后，流转至交付发布；若未达标，Agent触发Skill再次优化，直至符合标准。</li>
</ol>
<h3 data-id="heading-24">步骤8：交付发布SkillFlow——AI自动化归档+资源清理</h3>
<p>目标：完成代码发布、文档归档、冗余资源清理，确保交付合规、环境整洁，降低运维成本。</p>
<h4 data-id="heading-25">SkillFlow流转逻辑</h4>
<ul>
<li>MCP：存储发布环境配置（如服务器地址、部署规则）、文档归档要求；</li>
<li>Agent：交付发布Agent，调用“文档归档Skill”和“资源清理Skill”；</li>
<li>Skill：DocumentArchiveSkill（自动归档需求文档、测试报告、代码版本、优化方案）、ResourceCleanSkill（清理大模型上下文、冗余测试数据、临时文件）；</li>
<li>A2UI：发布确认A2UI，运维人员审核发布配置，触发发布流程。</li>
</ul>
<h4 data-id="heading-26">执行流程</h4>
<ol>
<li>Agent调用DocumentArchiveSkill，按企业规范自动归档所有交付物，生成交付清单，支持后续追溯；</li>
<li>ResourceCleanSkill自动清理项目相关的冗余资源（如测试数据、临时文件、大模型缓存），释放服务器内存；</li>
<li>运维人员通过A2UI确认发布环境配置（如目标服务器、版本号），点击“发布”，系统自动部署代码；</li>
<li>发布完成后，MCP更新流程状态为“已交付”，SkillFlow闭环，全程无需人工手动归档、清理。</li>
</ol>
<h2 data-id="heading-27">三、SkillFlow驱动开发流程的核心优势</h2>
<h3 data-id="heading-28">1. 自动化流转，效率倍增</h3>
<ul>
<li>80%的重复性工作（代码生成、测试、整合、归档）由Skill自动化执行，人工仅聚焦核心决策（如架构审核、异常处理），减少无效劳动；</li>
<li>各环节通过Agent和Route规则实时流转，无需人工提交流转申请、汇总数据，开发周期缩短30%以上，小型项目交付周期从周级压缩至日级。</li>
</ul>
<h3 data-id="heading-29">2. 注解驱动，能力复用</h3>
<ul>
<li>所有Skill通过@SkillAnnotation绑定软件开发场景和上下文，支持跨项目、跨团队复用（如MetadataGenerateSkill可直接用于电商、金融、政务等不同系统）；</li>
<li>代码与配置一体化，新增开发能力只需新增Skill并添加注解，无需修改核心流程，扩展性极强，新业务场景落地效率提升60%。</li>
</ul>
<h3 data-id="heading-30">3. 人机协同，精准高效</h3>
<ul>
<li>A2UI仅在核心决策环节接入人工，避免冗余干预，同时通过RightEngine管控角色权限，确保“谁负责、谁审批”，避免角色越权；</li>
<li>人工反馈实时写入Context，Agent即时触发后续流程（如反馈修改意见→AI自动迭代），无等待延迟，协同效率提升50%。</li>
</ul>
<h3 data-id="heading-31">4. 全流程可追溯，合规性拉满</h3>
<ul>
<li>MCP统一管理Context，存储全流程数据（需求文档、代码版本、测试报告、人工反馈、优化记录）；</li>
<li>SkillHistory、A2UIHistory自动记录各环节执行情况（如谁评审、何时通过、修改内容），支持审计和回溯，完全满足企业级合规要求。</li>
</ul>
<h3 data-id="heading-32">5. 轻量化部署，资源可控</h3>
<ul>
<li>Agent采用无状态设计（复用ActivityBlock），无需独立进程，共享服务器资源，部署成本降低40%；</li>
<li>大文本数据（如测试报告、代码文件）通过VFS存储，仅在数据库保存URL，减轻数据库压力；</li>
<li>按需部署Skill，不同项目可复用核心Skill，无需重复部署，资源利用率提升30%。</li>
</ul>
<h2 data-id="heading-33">四、总结</h2>
<p>面对AI编程的冲击与传统开发流程的痛点，SkillFlow并非简单“替代人工”，而是通过“MCP统一管控+Agent自动流转+Skill能力复用+A2UI精准协同”，构建了“AI做执行、人做决策”的智能开发闭环。</p>
<p>这套流程既充分发挥了AI编程的高效性（自动化生成、测试、优化），又解决了传统流程的协同割裂问题，让开发全链路标准化、可复用、可追溯。无论是大型企业的大规模开发（如多模块系统、高并发平台），还是中小团队的快速迭代（如创业项目、小型工具），SkillFlow都能适配需求，既提升开发效率，又保障代码质量与合规性。</p>
<p>未来，随着大模型能力的演进，SkillFlow可进一步扩展“智能需求拆解、自动Bug修复、多语言跨端编程”等新Skill，持续推动企业级软件开发向更高效、更可控、更具扩展性的方向发展，成为软件企业应对AI时代变革的核心支撑。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一个还没写代码的开源项目，我先来“画个饼”：Spring Insight]]></title>    <link>https://juejin.cn/post/7593169840199368730</link>    <guid>https://juejin.cn/post/7593169840199368730</guid>    <pubDate>2026-01-09T08:43:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593169840199368730" data-draft-id="7593164154631077897" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一个还没写代码的开源项目，我先来“画个饼”：Spring Insight"/> <meta itemprop="keywords" content="后端,开源,GitHub"/> <meta itemprop="datePublished" content="2026-01-09T08:43:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苏渡苇"/> <meta itemprop="url" content="https://juejin.cn/user/729731453429159"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一个还没写代码的开源项目，我先来“画个饼”：Spring Insight
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/729731453429159/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苏渡苇
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T08:43:34.000Z" title="Fri Jan 09 2026 08:43:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>毕竟，每个程序员最擅长的两件事就是：写BUG和画大饼 —— 今天我来展示后者。</p>
</blockquote>
<p>某是个不愿透露姓名的<strong>拖延症晚期</strong>程序员，在经历了无数次“这个项目我要重写”、“那个架构我要优化”的内心戏后，我决定 —— 不如再开一个新坑！🎉</p>
<p>所以，我隆重向大家介绍我的最新大饼：<strong>Spring Insight</strong>。目前它的代码量为：<strong>0行</strong>。是的，它现在是一个纯粹的“PPT开源项目”，但我相信，在画饼这件事上，我是认真的。</p>
<h2 data-id="heading-0">一、为什么我需要一个Spring监控工具？</h2>
<p>说实话，现在的监控生态已经挺丰富了：SkyWalking、Pinpoint、Prometheus + Grafana…… 每个都好用，每个都复杂得像是一架航天飞机。</p>
<p>而我想要的，只是一个<strong>能让我5分钟看懂我的Spring Boot应用在干嘛</strong>的工具。</p>
<ul>
<li><strong>现状</strong>：引入一个监控系统 ≈ 学习一套新概念 + 部署3个中间件 + 写50行配置 + 调试2天。</li>
<li><strong>理想</strong>：加一个依赖，看一个面板，就知道“哦，原来是那个Service又调了那个慢SQL”。</li>
</ul>
<p>于是，<code>Spring Insight</code> 的初心就这么<strong>朴实且枯燥</strong>：做一个Spring开发者真正能“开箱即用”的架构洞察工具，<strong>不求大而全，只求快又准</strong>。</p>
<h2 data-id="heading-1">二、这个“饼”到底想做什么？</h2>
<p>简单说，我想让它成为Spring Boot应用的 <strong>“随身健康医生”</strong> 。不是ICU里那种连着几十根管子的深度监控，而是像健身手环一样，每天给你一些可行的建议：</p>
<ol>
<li>
<p><strong>自动画出你的“服务关系网”</strong>
引入依赖，启动应用，它就能自动发现：你的<code>UserService</code>在调用<code>AuthService</code>，而<code>AuthService</code>又在狂查Redis。<strong>循环依赖？单点故障？</strong> 直接给你标红高亮。</p>
</li>
<li>
<p><strong>给你的HTTP接口做“体检报告”</strong>
不用配任何东西，就能看到一个列表：<code>/api/users</code> 平均响应 120ms，<code>POST /api/orders</code> 最近错误率升高，而且每次发布新版本后它的延迟都会抖一下。</p>
</li>
<li>
<p><strong>智能告诉你“哪里可能有问题”</strong>
这不是简单的数据展示，而是尝试做一些<strong>推断</strong>：</p>
<ul>
<li><em>“您刚刚重启了MySQL，但<code>ProductService</code>的查询耗时反而增加了50%，建议检查连接池配置。”</em></li>
<li><em>“<code>PaymentService</code> 调用 <code>BankGateway</code> 的失败率在每周五下午4点都会飙升，疑似对方限流。”</em></li>
</ul>
</li>
<li>
<p><strong>以上三点只是初始蓝图，能否实现有待观察</strong></p>
</li>
</ol>
<h2 data-id="heading-2">三、技术“蓝图”（其实就是吹牛时间）</h2>
<p>虽然一行代码没写，但架构图我已经画得飞起了（毕竟这是最省成本的部分）：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7f3422a3dfc451aa97db9ae2146124b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5rih6IuH:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768553014&amp;x-signature=anSUqpaE7Xa3YtF07fFHgIZz94I%3D" alt="构想架构图" loading="lazy"/></p>
<p><strong>几个自嗨的亮点设计：</strong></p>
<ol>
<li><strong>绝对无侵入</strong>：梦想是只加一个<code>spring-boot-starter-insight</code>依赖，一切自动发生。现实可能会给我一记重拳。</li>
<li><strong>面向“道歉”编程</strong>：如果收集逻辑影响了你的应用性能，我会第一时间提供“一键关闭”开关，并附上诚挚的道歉文档。</li>
<li><strong>分析结果可操作</strong>：不仅告诉你“有问题”，还尽量告诉你“可能是什么问题”以及“怎么试着解决”。能不能解决另说，但态度要有。</li>
</ol>
<h2 data-id="heading-3">四、为什么我想要整这个“空气项目”？</h2>
<p>我启动它，纯粹是因为我自己作为Spring开发者，长期被以下问题困扰：</p>
<ul>
<li><strong>认知负担重</strong>：现有的APM工具功能强大，但学习和维护成本让我等中小应用开发者望而却步。</li>
<li><strong>反应滞后</strong>：常常是用户先投诉了，我才发现系统某个地方已经默默报错半小时了。</li>
<li><strong>数据孤岛</strong>：日志、指标、链路在不同的系统里，出了问题要到处翻，像个侦探。</li>
</ul>
<p>如果屏幕前的你也有同感，那么这个项目或许——只是或许——也能解决你的一点痛点。</p>
<h2 data-id="heading-4">五、我的“打脸”路线图</h2>
<p>为了表明我不完全是瞎吹，以下是我给自己立的Flag（方便日后打脸用）：</p>
<ul>
<li><strong>Phase 0 (现在 - 2026.Q1)</strong>：把项目仓库建起来，README写得漂漂亮亮（目前唯一已完成99%的事）。</li>
<li><strong>Phase 1 (2026.Q2)</strong>：推出 <strong>0.1.0版</strong>，核心目标：<strong>能跑通一个Demo</strong>。实现最基本的HTTP请求追踪，并在一个简单UI上看到列表。</li>
<li><strong>Phase 2 (2026.Q3)</strong>：推出 <strong>0.5.0版</strong>，核心目标：<strong>真的有点用</strong>。实现服务依赖拓扑的自动绘制和基础的健康检查规则。</li>
<li><strong>Phase 3 (2026.Q4)</strong>：推出 <strong>1.0.0版</strong>，核心目标：<strong>敢给小项目用了</strong>。具备核心的采集、分析、告警能力，文档齐全。</li>
</ul>
<p><strong>再次强调</strong>：以上所有日期都具备极大的弹性，主要取决于我的下班时间、周末心情以及国产单机游戏的发布情况。</p>
<h2 data-id="heading-5">六、来吧</h2>
<p>我一个人画饼，终究容易饿死。如果你：</p>
<ol>
<li>觉得这个想法“哎，有点意思”；</li>
<li>或者觉得“这什么玩意儿，但我有个更好的点子”；</li>
<li>又或者单纯想围观一个项目是如何从零到一（<strong>或从零到零</strong>）的；</li>
</ol>
<p>欢迎你来：</p>
<ul>
<li><strong>GitHub</strong>：搜索 <code>spring-insight</code>（虽然现在仓库里还只有README和我的雄心壮志）</li>
<li><strong>点个Star</strong>：用你的Star给我一点<strong>虚幻的道德压力</strong>，督促我写代码。</li>
<li><strong>提个Issue</strong>：来说说你的痛点和幻想，我的产品经理功能就此激活。</li>
</ul>
<p>项目地址：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fiweidujiang%2Fspring-insight" target="_blank" title="https://github.com/iweidujiang/spring-insight" ref="nofollow noopener noreferrer">github.com/iweidujiang…</a></p>
<p>项目的成败，我现在心里完全没底。但我知道的是，<strong>每一个伟大的项目，都始于一个可能被嘲笑的念头</strong>。</p>
<p>最坏的结果，无非是我自己又摇摇头苦笑了一把（别怀疑，已经锻炼出来了，哈哈）。但万一，我是说万一，它真的能帮到一些像你我一样的普通开发者呢？</p>
<p>那这饼，我就试着把它烙出来吧。</p>
<p><strong>“代码未动，文档先行；功能虽无，愿景在心。”</strong> —— 一位懒散但乐观的程序员，于一个还没写任何代码的夜晚。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[优化NextJs 项目的Docker 镜像 从3.62G 优化到 296.85M]]></title>    <link>https://juejin.cn/post/7592992745574088742</link>    <guid>https://juejin.cn/post/7592992745574088742</guid>    <pubDate>2026-01-09T07:00:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592992745574088742" data-draft-id="7592992745573498918" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="优化NextJs 项目的Docker 镜像 从3.62G 优化到 296.85M "/> <meta itemprop="keywords" content="Docker"/> <meta itemprop="datePublished" content="2026-01-09T07:00:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="菜鸟思维"/> <meta itemprop="url" content="https://juejin.cn/user/2814346130107118"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            优化NextJs 项目的Docker 镜像 从3.62G 优化到 296.85M 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2814346130107118/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    菜鸟思维
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T07:00:56.000Z" title="Fri Jan 09 2026 07:00:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近作为前端看到招聘信息上面出现了需要熟悉docker，说实话在公司内部项目里面确实有Dockerfile 文件</p>
<p>里面的内容就是简单的内容，构建和运行也没有其他东西了。想来我就在本地基于Docker 构建一下生成镜像</p>
<p>一用一个不晓得，WC生成的镜像文件竟然有3.62G，妈卖批的我咋说构建过程生成镜像之后推的时候消耗时间有点长</p>
<p>之后就开始进行优化，最后将镜像结果从3.62GB 优化到 296.85MB</p>
<h2 data-id="heading-0">先科普一下Docker 基础，当然也可以直接跳过</h2>
<h3 data-id="heading-1">1. Docker 简介与安装验证</h3>
<p>Docker 是一个容器化平台，可以将应用程序及其依赖项打包到轻量级、可移植的容器中。</p>
<h4 data-id="heading-2">验证 Docker 安装</h4>
<pre><code class="hljs language-bash" lang="bash">docker run hello-world
</code></pre>
<p>如果输出"Hello from Docker!"，说明安装成功。</p>
<h3 data-id="heading-3">2. Docker 操作流程</h3>
<p>Docker 的层级关系：</p>
<pre><code class="hljs language-arduino" lang="arduino">Image（镜像） → Container（容器） → <span class="hljs-built_in">Process</span>（进程）
</code></pre>
<h4 data-id="heading-4">Docker 桌面版界面功能说明</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c19545e5ab1440ea0140a6d3b6ed105~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I-c6bif5oCd57u0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768546855&amp;x-signature=HM6jrQmL1qyY0TSe4NANBQITL8o%3D" alt="截屏2026-01-09 13.19.14.png" loading="lazy"/></p>
<ul>
<li><strong>Containers</strong>: 正在运行 / 已停止的容器（最常用）</li>
<li><strong>Images</strong>: 镜像列表（相当于"程序安装包"）</li>
<li><strong>Volumes</strong>: 数据存储（数据库数据、文件持久化）</li>
<li><strong>Kubernetes</strong>: K8s（目前可忽略）</li>
<li><strong>Builds</strong>: 构建镜像记录</li>
<li><strong>Docker Hub</strong>: 官方镜像仓库（类似 npm / pip）</li>
</ul>
<h4 data-id="heading-5">Docker 常用命令汇总</h4>


























































































<table><thead><tr><th>类别</th><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>基本操作</td><td><code>docker ps</code></td><td>查看运行中的容器</td></tr><tr><td>基本操作</td><td><code>docker ps -a</code></td><td>查看所有容器（包括停止的）</td></tr><tr><td>基本操作</td><td><code>docker images</code></td><td>查看镜像</td></tr><tr><td>基本操作</td><td><code>docker logs &lt;容器ID或名称&gt;</code></td><td>查看容器日志</td></tr><tr><td>基本操作</td><td><code>docker logs -f &lt;容器ID&gt;</code></td><td>实时查看容器日志</td></tr><tr><td>基本操作</td><td><code>docker exec -it &lt;容器ID&gt; sh</code></td><td>进入容器</td></tr><tr><td>基本操作</td><td><code>docker history &lt;镜像名&gt;</code></td><td>查看镜像历史</td></tr><tr><td>构建镜像</td><td><code>docker build -t &lt;名称&gt; .</code></td><td>构建镜像</td></tr><tr><td>构建镜像</td><td><code>docker build --no-cache -t &lt;名称&gt; .</code></td><td>无缓存构建</td></tr><tr><td>运行容器</td><td><code>docker run -p &lt;host&gt;:&lt;container&gt; &lt;镜像名&gt;</code></td><td>运行镜像并映射端口</td></tr><tr><td>运行容器</td><td><code>docker run -it -v &lt;host_dir&gt;:&lt;container_dir&gt; &lt;镜像名&gt;</code></td><td>运行容器并挂载卷</td></tr><tr><td>容器管理</td><td><code>docker start &lt;容器ID&gt;</code></td><td>启动容器</td></tr><tr><td>容器管理</td><td><code>docker stop &lt;容器ID&gt;</code></td><td>停止容器</td></tr><tr><td>容器管理</td><td><code>docker rm &lt;容器ID&gt;</code></td><td>删除容器</td></tr><tr><td>镜像管理</td><td><code>docker rmi &lt;镜像ID&gt;</code></td><td>删除镜像</td></tr><tr><td>系统管理</td><td><code>docker system prune</code></td><td>清理无用镜像和缓存</td></tr></tbody></table>
<h4 data-id="heading-6">删除镜像流程</h4>
<blockquote>
<p>先找到镜像里面的容器、停止容器、删除容器、删除镜像</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 查找特定镜像的容器</span>
docker ps -a --filter ancestor=next-app

<span class="hljs-comment"># 2. 停止容器</span>
docker stop &lt;container_id&gt;

<span class="hljs-comment"># 3. 删除容器</span>
docker <span class="hljs-built_in">rm</span> &lt;container_id&gt;

<span class="hljs-comment"># 4. 删除镜像</span>
docker rmi next-app
</code></pre>
<h4 data-id="heading-7">构建和运行镜像</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 构建镜像</span>
docker build -t next-web .

<span class="hljs-comment"># 运行镜像</span>
docker run -p 8080:8080 next-web

<span class="hljs-comment"># 无缓存重新构建</span>
docker build --no-cache -t next-app .
</code></pre>
<h3 data-id="heading-8">3. Docker Compose 使用指南</h3>
<p>Docker Compose 是用来定义和运行复杂 Docker 应用的工具，可以通过一个 YAML 文件配置多容器应用。</p>
<h4 data-id="heading-9">安装 Docker Compose</h4>
<p>Docker Desktop 已经内置了 Docker Compose，无需额外安装。</p>
<h4 data-id="heading-10">docker-compose.yml 示例</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">"3.8"</span>

<span class="hljs-attr">services:</span>
  <span class="hljs-attr">web:</span>
    <span class="hljs-attr">build:</span> <span class="hljs-string">.</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"3000:3000"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">.:/app</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">/app/node_modules</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">NODE_ENV=development</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">db</span>

  <span class="hljs-attr">db:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">postgres:13</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">POSTGRES_DB:</span> <span class="hljs-string">myapp</span>
      <span class="hljs-attr">POSTGRES_USER:</span> <span class="hljs-string">user</span>
      <span class="hljs-attr">POSTGRES_PASSWORD:</span> <span class="hljs-string">password</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">postgres_data:/var/lib/postgresql/data</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"5432:5432"</span>

<span class="hljs-attr">volumes:</span>
  <span class="hljs-attr">postgres_data:</span>
</code></pre>
<h4 data-id="heading-11">Docker Compose 常用命令</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动服务（后台运行）</span>
docker-compose up -d

<span class="hljs-comment"># 启动指定服务</span>
docker-compose up service-name

<span class="hljs-comment"># 停止服务</span>
docker-compose down

<span class="hljs-comment"># 查看服务日志</span>
docker-compose logs

<span class="hljs-comment"># 查看服务状态</span>
docker-compose ps

<span class="hljs-comment"># 重新构建并启动</span>
docker-compose up --build

<span class="hljs-comment"># 执行命令到指定容器</span>
docker-compose <span class="hljs-built_in">exec</span> service-name <span class="hljs-built_in">command</span>
</code></pre>
<h3 data-id="heading-12">4. Docker 网络配置</h3>
<p>Docker 提供多种网络模式，用于容器间通信和外部访问。</p>
<h4 data-id="heading-13">网络类型</h4>
<ul>
<li><strong>bridge</strong>（默认）：容器通过虚拟桥接连接，可互相通信</li>
<li><strong>host</strong>：容器直接使用主机网络</li>
<li><strong>none</strong>：容器无网络连接</li>
<li><strong>overlay</strong>：用于多主机环境</li>
</ul>
<h4 data-id="heading-14">网络管理命令</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看网络</span>
docker network <span class="hljs-built_in">ls</span>

<span class="hljs-comment"># 创建网络</span>
docker network create mynetwork

<span class="hljs-comment"># 连接到网络</span>
docker network connect mynetwork container-name

<span class="hljs-comment"># 断开网络连接</span>
docker network disconnect mynetwork container-name

<span class="hljs-comment"># 删除网络</span>
docker network <span class="hljs-built_in">rm</span> mynetwork

<span class="hljs-comment"># 查看网络详情</span>
docker network inspect mynetwork
</code></pre>
<h3 data-id="heading-15">5. 数据持久化与卷管理</h3>
<p>Docker 卷用于数据持久化，即使容器删除数据也不会丢失。</p>
<h4 data-id="heading-16">卷管理命令</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 列出卷</span>
docker volume <span class="hljs-built_in">ls</span>

<span class="hljs-comment"># 创建卷</span>
docker volume create myvolume

<span class="hljs-comment"># 查看卷详情</span>
docker volume inspect myvolume

<span class="hljs-comment"># 删除卷</span>
docker volume <span class="hljs-built_in">rm</span> myvolume

<span class="hljs-comment"># 清理未使用的卷</span>
docker volume prune
</code></pre>
<h4 data-id="heading-17">使用卷运行容器</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用命名卷</span>
docker run -v myvolume:/path/in/container image-name

<span class="hljs-comment"># 使用绑定挂载</span>
docker run -v /host/path:/container/path image-name

<span class="hljs-comment"># 使用临时文件系统（数据不会持久化）</span>
docker run --tmpfs /path/in/container image-name
</code></pre>
<h3 data-id="heading-18">6. Docker 安全最佳实践</h3>
<h4 data-id="heading-19">容器安全</h4>
<ul>
<li>使用官方或可信的基础镜像</li>
<li>定期更新镜像</li>
<li>避免以 root 用户运行容器</li>
<li>限制容器资源使用</li>
<li>禁用不必要的权限和功能</li>
</ul>
<h4 data-id="heading-20">镜像安全</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 扫描镜像漏洞</span>
docker scan image-name

<span class="hljs-comment"># 验证镜像签名</span>
docker trust inspect image-name
</code></pre>
<h3 data-id="heading-21">7. Next.js 在 Docker 中的递进式优化，先以最初的 Nextjs 为例</h3>
<h4 data-id="heading-22">第一步：基础 Next.js 项目 Docker 化</h4>
<ol>
<li>创建基础 Next.js 项目</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">npx create-next-app@latest web
<span class="hljs-built_in">cd</span> web
</code></pre>
<ol start="2">
<li>创建 Dockerfile</li>
</ol>
<pre><code class="hljs language-dockerfile" lang="dockerfile">FROM registry.cn-shanghai.aliyuncs.com/aipgpt/node:20-alpine

WORKDIR /app

# 启用 Corepack 功能
RUN corepack enable
# 安装并激活指定版本的 pnpm
RUN corepack prepare pnpm@latest --activate

COPY package*.json ./
RUN pnpm install

COPY . .

EXPOSE 3000

CMD ["npm", "run", "dev"]
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/027f09600fef45a1a639373609fd1e76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I-c6bif5oCd57u0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768546855&amp;x-signature=TOsa%2B6elTCIf39A2J77%2BzA1PMGg%3D" alt="截屏2026-01-09 14.45.48.png" loading="lazy"/></p>
<ol start="3">
<li>创建 .dockerignore</li>
</ol>

<pre><code class="hljs language-lua" lang="lua">node_modules
.<span class="hljs-built_in">next</span>
.git
</code></pre>
<p>4.  构建和运行</p>
<pre><code class="hljs language-bash" lang="bash">docker build -t next-app .
docker run -p 3000:3000 next-app
</code></pre>
<h4 data-id="heading-23">第二步：使用 Corepack 管理 pnpm（推荐）</h4>
<pre><code class="hljs language-dockerfile" lang="dockerfile">FROM node:18-alpine

WORKDIR /app

# 启用 Corepack 功能
RUN corepack enable
# 安装并激活指定版本的 pnpm
RUN corepack prepare pnpm@latest --activate

COPY package*.json ./
RUN pnpm install

COPY . .

EXPOSE 3000

CMD ["pnpm", "dev"]
</code></pre>
<h4 data-id="heading-24">第三步：配置热更新</h4>
<pre><code class="hljs language-bash" lang="bash">docker run -it \
  -p 3000:3000 \
  -v $(<span class="hljs-built_in">pwd</span>):/app \
  -w /app \
  node:18 \
  npm run dev
</code></pre>
<h4 data-id="heading-25">第四步：指定端口配置</h4>
<ol>
<li>修改 Dockerfile</li>
</ol>
<pre><code class="hljs language-dockerfile" lang="dockerfile">EXPOSE 3008
</code></pre>
<ol start="2">
<li>修改 package.json</li>
</ol>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"next dev -H 0.0.0.0 -p 3008"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>注意</strong>: 必须添加<code>-H 0.0.0.0</code>参数，否则 Docker 外部无法访问。</p>
<h4 data-id="heading-26">第五步：多阶段构建优化</h4>
<pre><code class="hljs language-dockerfile" lang="dockerfile"># =====================
# Build
# =====================
FROM node:20-alpine AS builder
WORKDIR /app

# 启用 Corepack 功能
RUN corepack enable
# 安装并激活指定版本的 pnpm
RUN corepack prepare pnpm@latest --activate

COPY package.json ./
RUN pnpm install --registry=https://registry.npmmirror.com

COPY . .
RUN npm run build


# =====================
# Runtime
# =====================
FROM node:20-alpine
WORKDIR /app
ENV NODE_ENV=production
ENV PORT=3008

COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static
COPY --from=builder /app/public ./public

EXPOSE 3008
CMD ["npm", "run", "dev"]

</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c4de376aeb14c1d8a546103c08fc00c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I-c6bif5oCd57u0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768546855&amp;x-signature=WsNN7mg3vs660pU06KTPpCRT2Yo%3D" alt="截屏2026-01-09 14.48.04.png" loading="lazy"/></p>
<h4 data-id="heading-27">第六步：Next.js Standalone 模式极致优化</h4>
<p>这是 Next.js 12.2.0 版本引入的新特性，旨在优化构建输出和部署。Standalone 模式生成的包更小，启动更快。</p>
<h5 data-id="heading-28">配置 next.config.js</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/** <span class="hljs-doctag">@type</span> {<span class="hljs-type">import('next').NextConfig</span>} */</span>
<span class="hljs-keyword">const</span> nextConfig = {
  <span class="hljs-attr">output</span>: <span class="hljs-string">"standalone"</span>, <span class="hljs-comment">// 启用 standalone 模式</span>
  <span class="hljs-attr">experimental</span>: {
    <span class="hljs-attr">outputFileTracingRoot</span>: path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">"../../"</span>),
  },
};

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = nextConfig;
</code></pre>
<h5 data-id="heading-29">Dockerfile 配置</h5>
<pre><code class="hljs language-dockerfile" lang="dockerfile">FROM node:20-alpine AS builder

WORKDIR /app

# 启用 Corepack 功能
RUN corepack enable
# 安装并激活指定版本的 pnpm
RUN corepack prepare pnpm@latest --activate

COPY package.json ./
RUN pnpm install --registry=https://registry.npmmirror.com

COPY . .

# 构建项目
RUN npm run build

FROM node:20-alpine AS runner

WORKDIR /app

# 仅复制 standalone 输出的文件
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static
COPY --from=builder /app/public ./public

# 暴露端口
EXPOSE 3008
ENV PORT=3008

# 启动项目
CMD ["node", "server.js"]
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae73f89e7b634df3a31e65f65a775339~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I-c6bif5oCd57u0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768546855&amp;x-signature=niDcot3kA3ZQjlfUQz8aCgXzjqU%3D" alt="截屏2026-01-09 14.49.51.png" loading="lazy"/></p>
<blockquote>
<h3 data-id="heading-30">因为初始化Nextjs 基本上没有任何内容显示不出来 使用 Standalone模式之后的对比效果</h3>
<p>如果项目大的时候会有明显的对比</p>
</blockquote>
<h5 data-id="heading-31">关于 Next.js Standalone 模式</h5>
<p>Standalone 模式是 Next.js 团队为了优化部署而推出的新特性，它极大地简化了部署过程并减少了部署包的大小。从我自己的实践经验来看：</p>






























<table><thead><tr><th>Next.js 版本</th><th>是否支持 <code>standalone</code></th><th>说明</th></tr></thead><tbody><tr><td>≤ 12.1</td><td>❌ 不支持</td><td>只能 <code>next start</code></td></tr><tr><td><strong>12.2</strong></td><td>✅ <strong>首次引入</strong></td><td>实验 → 可用</td></tr><tr><td>12.3 / 13.x</td><td>✅ 稳定</td><td>Docker 官方推荐</td></tr><tr><td><strong>14 / 15</strong></td><td>✅ 默认生产方案</td><td>文档全面</td></tr></tbody></table>
<p><strong>优点：</strong></p>
<ul>
<li>部署包更小：只包含必要的文件，大幅减少镜像大小</li>
<li>启动更快：优化了模块加载路径</li>
<li>依赖更少：减少了运行时需要的文件数量</li>
<li>更适合容器化部署：特别适合 Docker 部署</li>
</ul>
<p><strong>需要注意的问题：</strong></p>
<ul>
<li>需要调整 next.config.js 配置</li>
<li>如果使用了外部依赖或复杂的文件操作，需要确认它们在 standalone 模式下是否正常工作</li>
<li>某些动态导入可能需要特殊处理</li>
</ul>
<p><strong>SSR/SSG/ISR/CSR 在两种构建模式下的对比：</strong></p>
<p>在传统模式和 Standalone 模式下，各种渲染方式的行为基本相同，但有以下细微差别：</p>
<ul>
<li><strong>SSR (Server-Side Rendering)</strong>：在两种模式下都正常工作，但在 Standalone 模式下启动更快</li>
<li><strong>SSG (Static Site Generation)</strong>：预生成的静态文件在两种模式下表现一致</li>
<li><strong>ISR (Incremental Static Regeneration)</strong>：在 Standalone 模式下，由于文件结构优化，可能会有轻微的性能提升</li>
<li><strong>CSR (Client-Side Rendering)</strong>：两种模式下完全相同，因为都在客户端执行</li>
</ul>
<p><strong>适用场景：</strong></p>
<ul>
<li>对部署包大小敏感的应用</li>
<li>容器化部署场景</li>
<li>需要快速启动的服务</li>
<li>需要简化部署流程的项目</li>
</ul>
<h3 data-id="heading-32">8. 故障排查技巧</h3>
<h4 data-id="heading-33">查看容器状态</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看容器详细信息</span>
docker inspect container-name

<span class="hljs-comment"># 查看容器资源使用情况</span>
docker stats container-name

<span class="hljs-comment"># 查看容器进程</span>
docker top container-name
</code></pre>
<h4 data-id="heading-34">调试容器</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 进入正在运行的容器</span>
docker <span class="hljs-built_in">exec</span> -it container-name sh

<span class="hljs-comment"># 查看容器挂载的卷</span>
docker inspect -f <span class="hljs-string">'{{.Mounts}}'</span> container-name

<span class="hljs-comment"># 以 root 权限进入容器</span>
docker <span class="hljs-built_in">exec</span> -u root -it container-name sh
</code></pre>
<h4 data-id="heading-35">常见问题排查</h4>
<ul>
<li>容器无法启动：检查日志 <code>docker logs container-name</code></li>
<li>端口无法访问：检查防火墙设置和端口映射</li>
<li>网络连接问题：使用 <code>docker network inspect</code> 检查网络配置</li>
<li>存储问题：使用 <code>docker volume inspect</code> 检查卷配置</li>
</ul>
<h3 data-id="heading-36">9. 常见问题及解决方案</h3>
<h4 data-id="heading-37">问题 1：容器中没有 pnpm</h4>
<p><strong>解决方案</strong>：在 Dockerfile 中安装 pnpm</p>
<pre><code class="hljs language-dockerfile" lang="dockerfile"># 使用 Corepack 方式（推荐）
RUN corepack enable
RUN corepack prepare pnpm@latest --activate
</code></pre>
<h4 data-id="heading-38">问题 2：外部无法访问容器内服务</h4>
<p><strong>解决方案</strong>：在启动命令中添加<code>-H 0.0.0.0</code></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"next dev -H 0.0.0.0 -p 3008"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-39">问题 3：Docker 镜像过大</h4>
<p><strong>解决方案</strong>：</p>
<ol>
<li>使用多阶段构建</li>
<li>使用 Next.js 的 standalone 模式</li>
<li>选择更小的基础镜像（如 alpine 版本）</li>
</ol>
<h4 data-id="heading-40">问题 4：Node 版本问题</h4>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 强制重新构建镜像</span>
docker build --no-cache -t next-app .

<span class="hljs-comment"># 删除指定版本镜像</span>
docker rmi node:18-alpine

<span class="hljs-comment"># 验证运行的版本</span>
docker run --<span class="hljs-built_in">rm</span> next-app node -v
</code></pre>
<h4 data-id="heading-41">问题 5：缓存导致的问题</h4>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 无缓存构建</span>
docker build --no-cache -t aip-web:new .

<span class="hljs-comment"># 清理系统缓存</span>
docker system prune
</code></pre>
<h3 data-id="heading-42">10. Docker 镜像大小优化技巧</h3>
<h4 data-id="heading-43">查看镜像大小</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 进入容器查看</span>
docker <span class="hljs-built_in">exec</span> -it &lt;容器名&gt; sh

<span class="hljs-comment"># 查看镜像体积</span>
docker images next-prod
</code></pre>
<h4 data-id="heading-44">优化策略</h4>
<ol>
<li><strong>多阶段构建</strong>：将构建环境和运行环境分离</li>
<li><strong>使用 .dockerignore</strong>：排除不必要的文件</li>
<li><strong>使用 Alpine 镜像</strong>：更小的基础镜像</li>
<li><strong>清理缓存</strong>：在构建过程中清理不必要的缓存文件</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[⚡IndexedDB：现代Web应用的高性能本地数据库解决方案]]></title>    <link>https://juejin.cn/post/7592939457042939956</link>    <guid>https://juejin.cn/post/7592939457042939956</guid>    <pubDate>2026-01-09T07:04:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592939457042939956" data-draft-id="7592939457042858036" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="⚡IndexedDB：现代Web应用的高性能本地数据库解决方案"/> <meta itemprop="keywords" content="前端,IndexedDB"/> <meta itemprop="datePublished" content="2026-01-09T07:04:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小白菜的编程日记"/> <meta itemprop="url" content="https://juejin.cn/user/1302259794456120"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ⚡IndexedDB：现代Web应用的高性能本地数据库解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1302259794456120/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小白菜的编程日记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T07:04:53.000Z" title="Fri Jan 09 2026 07:04:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="vs2015">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1e1e1e;color:#dcdcdc}.hljs-keyword,.hljs-link,.hljs-literal,.hljs-name,.hljs-symbol{color:#569cd6}.hljs-link{text-decoration:underline}.hljs-built_in,.hljs-type{color:#4ec9b0}.hljs-class,.hljs-number{color:#b8d7a3}.hljs-meta-string,.hljs-string{color:#d69d85}.hljs-regexp,.hljs-template-tag{color:#9a5334}.hljs-formula,.hljs-function,.hljs-params,.hljs-subst,.hljs-title{color:#dcdcdc}.hljs-comment,.hljs-quote{color:#57a64a;font-style:italic}.hljs-doctag{color:#608b4e}.hljs-meta,.hljs-meta-keyword,.hljs-tag{color:#9b9b9b}.hljs-template-variable,.hljs-variable{color:#bd63c5}.hljs-attr,.hljs-attribute,.hljs-builtin-name{color:#9cdcfe}.hljs-section{color:gold}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-bullet,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-selector-tag{color:#d7ba7d}.hljs-addition{background-color:#144212}.hljs-addition,.hljs-deletion{display:inline-block;width:100%}.hljs-deletion{background-color:#600}</style><h4 data-id="heading-0">一、IndexedDB 是什么？</h4>
<p>IndexedDB是一种浏览器内置的NoSQL数据库，允许你在客户端存储大量结构化数据。它不同于简单的键值存储localStorage，可以视为一个轻量级的、基于JavaScript的本地数据库系统。其核心价值在于支持<strong>异步操作</strong>（不阻塞页面渲染）、<strong>事务处理</strong>（保证数据操作的原子性和一致性），并提供<strong>索引</strong>以实现高性能查询。</p>
<p><strong>关键特性速览</strong></p>
<ul>
<li><strong>非关系型结构 (NoSQL)</strong> ：数据以对象形式存储，每个对象存储（Object Store）类似于一张表，但无需固定结构。</li>
<li><strong>异步API</strong>：所有数据库操作都是异步的，避免界面卡顿，提升用户体验。</li>
<li><strong>持久化存储</strong>：数据持久保存在浏览器中，除非用户明确清除网站数据，否则不会丢失。</li>
<li><strong>大容量存储</strong>：通常可存储数百MB甚至更多的数据，远超localStorage约5MB的限制。</li>
</ul>
<h4 data-id="heading-1">二、IndexedDB 的核心优势与局限性</h4>
<p>理解IndexedDB的优劣，能帮助我们在正确的场景下更好地利用它。</p>






























<table><thead><tr><th>特性维度</th><th>优势体现</th><th>局限性或挑战</th></tr></thead><tbody><tr><td><strong>存储能力</strong>​</td><td>支持海量结构化数据存储，适合缓存图片、文档等</td><td>不同浏览器有存储配额限制，通常为磁盘空间的某个百分比</td></tr><tr><td><strong>数据操作</strong>​</td><td>支持事务、索引和复杂查询，功能强大</td><td>API相对底层，较为复杂，学习曲线较陡</td></tr><tr><td><strong>性能表现</strong>​</td><td>异步操作不阻塞UI，索引查询速度快</td><td>需要处理异步编程（回调、Promise）</td></tr><tr><td><strong>兼容性与安全</strong>​</td><td>现代浏览器支持良好，遵循同源策略</td><td>老旧浏览器兼容性需考虑，受同源策略限制</td></tr></tbody></table>
<h4 data-id="heading-2">三、实战应用：基于IndexedDB的公式图片缓存系统</h4>
<p>你的代码是一个完美体现IndexedDB优势的案例。下面我们解析核心实现。</p>
<p><strong>1. 系统架构与工作流程</strong></p>
<p>该系统通过将KaTeX公式文本转换为图片并缓存，解决了表格中重复渲染相同公式时的性能瓶颈。其核心工作流程，即从公式到图片的缓存与读取机制，可以直观地展示为下图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/491ef7f7a0374373a4ca37e6dae2b6b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP55m96I-c55qE57yW56iL5pel6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768547412&amp;x-signature=mCBS9UZAhPS26kR%2FrpWYuPtcwo8%3D" alt="image.png" loading="lazy"/></p>
<p><strong>2. 关键代码解析</strong></p>
<ul>
<li>
<p><strong>初始化数据库与对象存储</strong>：在 <code>onupgradeneeded</code>事件中建立结构，这是版本化架构的核心。</p>
<pre><code class="hljs language-php" lang="php">request.onupgradeneeded = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">db</span> = event.target.result;
    <span class="hljs-comment">// 检查对象存储是否存在，避免重复创建</span>
    <span class="hljs-keyword">if</span> (!db.objectStoreNames.<span class="hljs-title function_ invoke__">contains</span>(STORE_NAME)) {
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">store</span> = db.<span class="hljs-title function_ invoke__">createObjectStore</span>(STORE_NAME, { <span class="hljs-attr">keyPath</span>: <span class="hljs-string">'key'</span> });
        <span class="hljs-comment">// 创建时间戳索引，便于后续实现缓存清理策略</span>
        store.<span class="hljs-title function_ invoke__">createIndex</span>(<span class="hljs-string">'timestamp'</span>, <span class="hljs-string">'timestamp'</span>, { <span class="hljs-attr">unique</span>: <span class="hljs-literal">false</span> });
    }
};
</code></pre>
</li>
<li>
<p><strong>数据操作（以读取为例）</strong> ：使用事务（Transaction）来保证数据操作的可靠性和一致性。</p>
<pre><code class="hljs language-ini" lang="ini">async function getFormulaImageFromIndexedDB(cacheKey) {
    try {
        const <span class="hljs-attr">db</span> = await initDB()<span class="hljs-comment">;</span>
        // 创建一个只读事务
        const <span class="hljs-attr">transaction</span> = db.transaction([STORE_NAME], <span class="hljs-string">'readonly'</span>)<span class="hljs-comment">;</span>
        const <span class="hljs-attr">store</span> = transaction.objectStore(STORE_NAME)<span class="hljs-comment">;</span>
        // 使用Promise封装异步操作，简化调用
        return new Promise((resolve, reject) =&gt; {
            const <span class="hljs-attr">request</span> = store.get(cacheKey)<span class="hljs-comment">;</span>
            <span class="hljs-attr">request.onsuccess</span> = () =&gt; {
                const <span class="hljs-attr">result</span> = request.result<span class="hljs-comment">;</span>
                resolve(result ? result.imageUrl : null)<span class="hljs-comment">;</span>
            }<span class="hljs-comment">;</span>
            <span class="hljs-attr">request.onerror</span> = () =&gt; reject(request.error)<span class="hljs-comment">;</span>
        })<span class="hljs-comment">;</span>
    } catch (error) {
        console.error('从IndexedDB读取失败:', error)<span class="hljs-comment">;</span>
        return null<span class="hljs-comment">;</span>
    }
}
</code></pre>
</li>
</ul>
<h4 data-id="heading-3">四、IndexedDB 最佳实践</h4>
<ol>
<li>
<p><strong>使用Promise进行封装</strong>：IndexedDB API是回调形式的，用Promise封装能极大提升代码可读性和可维护性，避免回调地狱。</p>
</li>
<li>
<p><strong>建立有效的缓存键（Cache Key）</strong> ：如同你的代码所示，通过哈希函数将公式文本和尺寸转换为唯一键，是保证缓存准确性的基础。</p>
</li>
<li>
<p><strong>实现缓存清理策略</strong>：利用时间戳索引，定期清理过期缓存，防止存储空间无限增长。</p>
<pre><code class="hljs language-ini" lang="ini">// 示例：清理7天前的缓存
async function cleanupOldCache(<span class="hljs-attr">maxAge</span> = <span class="hljs-number">7</span> * <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>) {
    const <span class="hljs-attr">db</span> = await initDB()<span class="hljs-comment">;</span>
    const <span class="hljs-attr">transaction</span> = db.transaction([STORE_NAME], <span class="hljs-string">'readwrite'</span>)<span class="hljs-comment">;</span>
    const <span class="hljs-attr">store</span> = transaction.objectStore(STORE_NAME)<span class="hljs-comment">;</span>
    const <span class="hljs-attr">index</span> = store.index(<span class="hljs-string">'timestamp'</span>)<span class="hljs-comment">;</span>
    const <span class="hljs-attr">cutoffTime</span> = Date.now() - maxAge<span class="hljs-comment">;</span>
    // 使用索引和键范围进行高效删除
    const <span class="hljs-attr">range</span> = IDBKeyRange.upperBound(cut<span class="hljs-literal">off</span>Time)<span class="hljs-comment">;</span>
    let <span class="hljs-attr">cursor</span> = await index.openCursor(range)<span class="hljs-comment">;</span>
    while (cursor) {
        cursor.delete()<span class="hljs-comment">;</span>
        <span class="hljs-attr">cursor</span> = await cursor.continue()<span class="hljs-comment">;</span>
    }
}
</code></pre>
</li>
<li>
<p><strong>优雅降级</strong>：在IndexedDB不可用的情况下，应具备回退方案，例如可以降级为仅使用内存缓存，并给出用户提示。</p>
</li>
</ol>
<h4 data-id="heading-4">五、总结</h4>
<p>IndexedDB凭借其<strong>大容量、异步高性能和结构化存储能力</strong>，成为构建复杂离线应用、实现前端大数据缓存（如你的公式图片缓存场景）的理想选择。尽管其API相对复杂，但通过Promise封装、事务的正确使用以及合理的设计模式，可以充分发挥其潜力，显著提升Web应用的性能和用户体验。</p>
<p>希望这篇文章能帮助你更全面地理解IndexedDB，并将其成功应用于更多场景。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解析ElementPlus打包源码（五、copyFiles）]]></title>    <link>https://juejin.cn/post/7593015632082468891</link>    <guid>https://juejin.cn/post/7593015632082468891</guid>    <pubDate>2026-01-09T07:12:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593015632082468891" data-draft-id="7592944032773750835" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 解析ElementPlus打包源码（五、copyFiles）"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2026-01-09T07:12:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="jqq666"/> <meta itemprop="url" content="https://juejin.cn/user/2063132066587822"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             解析ElementPlus打包源码（五、copyFiles）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2063132066587822/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    jqq666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T07:12:18.000Z" title="Fri Jan 09 2026 07:12:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>还有最后一个copyFiles，虽然有点水，还是记录下</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31aec07d9dc5462caf490fc0e8441e73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganFxNjY2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768547601&amp;x-signature=cBWWLlunhI3rxQWu29jQZo7sqJQ%3D" alt="image.png" loading="lazy"/></p>
<p>copyTypesDefinitions 我们之前打包类型已经写过。这里我们只看copyFiles</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">export</span> <span class="hljs-selector-tag">const</span> <span class="hljs-selector-tag">copyFiles</span> = () =&gt;
  <span class="hljs-selector-tag">Promise</span><span class="hljs-selector-class">.all</span>([
    <span class="hljs-built_in">copyFile</span>(epPackage, path.<span class="hljs-built_in">join</span>(epOutput, <span class="hljs-string">'package.json'</span>)),
    <span class="hljs-built_in">copyFile</span>(
      path.<span class="hljs-built_in">resolve</span>(projRoot, <span class="hljs-string">'README.md'</span>),
      path.<span class="hljs-built_in">resolve</span>(epOutput, <span class="hljs-string">'README.md'</span>)
    ),
    <span class="hljs-built_in">copyFile</span>(
      path.<span class="hljs-built_in">resolve</span>(projRoot, <span class="hljs-string">'typings'</span>, <span class="hljs-string">'global.d.ts'</span>),
      path.<span class="hljs-built_in">resolve</span>(epOutput, <span class="hljs-string">'global.d.ts'</span>)
    ),
  ])

</code></pre>
<p>这里复制了三个文件</p>
<h2 data-id="heading-0"><code>packages/element-plus/package.json</code></h2>
<p><code>packages/element-plus/package.json</code>这个文件复制到打包后的项目下当作打包后的package.json</p>
<p>package.json里面涉及了一些package.json的基础信息，例如：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"element-plus"</span><span class="hljs-punctuation">,</span>        <span class="hljs-comment">// 包名，安装时使用 npm install element-plus</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0.0.0-dev.1"</span><span class="hljs-punctuation">,</span>     <span class="hljs-comment">// 版本号</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"A Component Library for Vue 3"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 包的描述</span>
  <span class="hljs-attr">"keywords"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"element-plus"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"vue"</span><span class="hljs-punctuation">,</span> ...<span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 关键词，方便 npm 搜索</span>
  <span class="hljs-attr">"homepage"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://element-plus.org/"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 官网地址</span>
  <span class="hljs-attr">"bugs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"..."</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>      <span class="hljs-comment">// 问题反馈地址</span>
  <span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MIT"</span><span class="hljs-punctuation">,</span>              <span class="hljs-comment">// 开源协议</span>
  <span class="hljs-attr">"repository"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> ... <span class="hljs-punctuation">}</span>         <span class="hljs-comment">// 代码仓库地址</span>
  <span class="hljs-attr">"publishConfig"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> ... <span class="hljs-punctuation">}</span>    <span class="hljs-comment">// 发布配置：`access: public` 表示该包是公开发布的（npm 私有包需付费，此配置确保包公开可访问）</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>还有一些模块导出规则的信息，main/module/types这三个是早期 npm 包的 “基础配置”，只能定义 “根路径” 的单一入口，无法精细化控制子路径，现在的exports优先级更高</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"lib/index.js"</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"es/index.mjs"</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"es/index.d.ts"</span><span class="hljs-punctuation">,</span>
</code></pre>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-string">"exports"</span>: {
  <span class="hljs-regexp">//</span> <span class="hljs-number">1</span>. 根路径引入：import <span class="hljs-string">'element-plus'</span> / <span class="hljs-keyword">require</span>(<span class="hljs-string">'element-plus'</span>)
  <span class="hljs-string">"."</span>: {
    <span class="hljs-string">"types"</span>: <span class="hljs-string">"./es/index.d.ts"</span>,  <span class="hljs-regexp">//</span> TS 类型文件（优先匹配）
    <span class="hljs-string">"import"</span>: <span class="hljs-string">"./es/index.mjs"</span>,  <span class="hljs-regexp">//</span> ESM 引入（import 语法）加载 es 目录的 mjs 文件（ESM 模块）
    <span class="hljs-string">"require"</span>: <span class="hljs-string">"./lib/index.js"</span>  // CommonJS 引入（<span class="hljs-keyword">require</span> 语法）加载 lib 目录的 js 文件（CJS 模块）
  },
  <span class="hljs-regexp">//</span> <span class="hljs-number">2</span>. 全局类型引入：import <span class="hljs-string">'element-plus/global'</span>
  <span class="hljs-string">"./global"</span>: {
    <span class="hljs-string">"types"</span>: <span class="hljs-string">"./global.d.ts"</span>     // 仅导出全局类型（无 js 代码，用于全局类型声明）
  },
  <span class="hljs-regexp">//</span> <span class="hljs-number">3</span>. 直接引入 es 目录：import <span class="hljs-string">'element-plus/es'</span>
  <span class="hljs-string">"./es"</span>: {
    <span class="hljs-string">"types"</span>: <span class="hljs-string">"./es/index.d.ts"</span>,
    <span class="hljs-string">"import"</span>: <span class="hljs-string">"./es/index.mjs"</span>   // 仅支持 ESM 引入（es 目录只存 ESM 模块）
  },
  <span class="hljs-regexp">//</span> <span class="hljs-number">4</span>. 直接引入 lib 目录：<span class="hljs-keyword">require</span>(<span class="hljs-string">'element-plus/lib'</span>)
  <span class="hljs-string">"./lib"</span>: {
    <span class="hljs-string">"types"</span>: <span class="hljs-string">"./lib/index.d.ts"</span>,
    <span class="hljs-string">"require"</span>: <span class="hljs-string">"./lib/index.js"</span>  // 仅支持 CommonJS 引入（lib 目录只存 CJS 模块）
  },
  <span class="hljs-regexp">//</span> <span class="hljs-number">5</span>. 按需引入 es 目录下的 mjs 文件：import <span class="hljs-string">'element-plus/es/button.mjs'</span>
  <span class="hljs-string">"./es/*.mjs"</span>: {
    <span class="hljs-string">"types"</span>: <span class="hljs-string">"./es/*.d.ts"</span>,      <span class="hljs-regexp">//</span> 匹配对应 ts 类型文件（如 button.d.ts）
    <span class="hljs-string">"import"</span>: <span class="hljs-string">"./es/*.mjs"</span>       // 加载对应 mjs 文件（ESM 按需引入）
  },
  <span class="hljs-regexp">//</span> <span class="hljs-number">6</span>. 按需引入 es 目录下的模块：import <span class="hljs-string">'element-plus/es/button'</span>（无后缀）
  <span class="hljs-string">"./es/*"</span>: {
    <span class="hljs-string">"types"</span>: [<span class="hljs-string">"./es/*.d.ts"</span>, <span class="hljs-string">"./es/*/index.d.ts"</span>], <span class="hljs-regexp">//</span> 类型匹配优先级：先找 button.d.ts，再找 button/index.d.ts
    <span class="hljs-string">"import"</span>: <span class="hljs-string">"./es/*.mjs"</span>       // 自动补全 mjs 后缀，适配开发者省略后缀的习惯
  },
  <span class="hljs-regexp">//</span> <span class="hljs-number">7</span>. 按需引入 lib 目录下的 js 文件：<span class="hljs-keyword">require</span>(<span class="hljs-string">'element-plus/lib/button.js'</span>)
  <span class="hljs-string">"./lib/*.js"</span>: {
    <span class="hljs-string">"types"</span>: <span class="hljs-string">"./lib/*.d.ts"</span>,
    <span class="hljs-string">"require"</span>: <span class="hljs-string">"./lib/*.js"</span>      // CJS 按需引入（带后缀）
  },
  <span class="hljs-regexp">//</span> <span class="hljs-number">8</span>. 按需引入 lib 目录下的模块：<span class="hljs-keyword">require</span>(<span class="hljs-string">'element-plus/lib/button'</span>)（无后缀）
  <span class="hljs-string">"./lib/*"</span>: {
    <span class="hljs-string">"types"</span>: [<span class="hljs-string">"./lib/*.d.ts"</span>, <span class="hljs-string">"./lib/*/index.d.ts"</span>], <span class="hljs-regexp">//</span> 类型匹配规则同 es 目录
    <span class="hljs-string">"require"</span>: <span class="hljs-string">"./lib/*.js"</span>      // 自动补全 js 后缀
  },
  <span class="hljs-regexp">//</span> <span class="hljs-number">9</span>. 兜底规则：匹配所有未定义的路径（如 import <span class="hljs-string">'element-plus/package.json'</span>）
  <span class="hljs-string">"./*"</span>: <span class="hljs-string">"./*"</span>
}

</code></pre>
<p>package.json中还有相关的peerDependencies（要求项目中安装符合版本的依赖，否则会进行提醒）、dependencies、devDependencies</p>
<p>还有其他的相关配置可自行查看文档</p>
<h2 data-id="heading-1"><code>README.md</code></h2>
<p>根路径下的README文档，复制到打包后的包中</p>
<h2 data-id="heading-2"><code>global.d.ts</code></h2>
<p>这个文件就是Element Plus 的<strong>全局 TypeScript 类型声明文件</strong></p>
<p>主要就是全局引入组件的时候，方便通过引入这个类型文件，在整个项目中都有提示</p>
<p>可见文档说明 <a href="https://link.juejin.cn?target=https%3A%2F%2Felement-plus.org%2Fzh-CN%2Fguide%2Fquickstart%23volar-%25E6%2594%25AF%25E6%258C%2581" target="_blank" title="https://element-plus.org/zh-CN/guide/quickstart#volar-%E6%94%AF%E6%8C%81" ref="nofollow noopener noreferrer">ElementPlus快速开始</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[揭秘 Nginx 百万并发基石：Reactor 架构与 Epoll 底层原理]]></title>    <link>https://juejin.cn/post/7592992745574187046</link>    <guid>https://juejin.cn/post/7592992745574187046</guid>    <pubDate>2026-01-09T07:14:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592992745574187046" data-draft-id="7592992745574137894" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="揭秘 Nginx 百万并发基石：Reactor 架构与 Epoll 底层原理"/> <meta itemprop="keywords" content="后端,设计模式"/> <meta itemprop="datePublished" content="2026-01-09T07:14:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Aeside1"/> <meta itemprop="url" content="https://juejin.cn/user/2971330788730361"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            揭秘 Nginx 百万并发基石：Reactor 架构与 Epoll 底层原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2971330788730361/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Aeside1
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T07:14:08.000Z" title="Fri Jan 09 2026 07:14:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="" data-highlight-key="idea">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#000;background:#fff}.hljs-subst,.hljs-title{font-weight:400;color:#000}.hljs-comment,.hljs-quote{color:grey;font-style:italic}.hljs-meta{color:olive}.hljs-tag{background:#efefef}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-section,.hljs-selector-class,.hljs-selector-id,.hljs-selector-tag,.hljs-type{font-weight:700;color:navy}.hljs-attribute,.hljs-link,.hljs-number,.hljs-regexp{font-weight:700;color:#00f}.hljs-link,.hljs-number,.hljs-regexp{font-weight:400}.hljs-string{color:green;font-weight:700}.hljs-bullet,.hljs-formula,.hljs-symbol{color:#000;background:#d0eded;font-style:italic}.hljs-doctag{text-decoration:underline}.hljs-template-variable,.hljs-variable{color:#660e7a}.hljs-addition{background:#baeeba}.hljs-deletion{background:#ffc8bd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在现如今的互联网环境下，面对数以亿计的用户，我们常看到各种应用宣称支撑着惊人的流量：从千级 QPS 到万级，再到夸张的十万级。在这些数字背后，往往是庞大的分布式架构在支撑——流量被分摊到成百上千台服务器上，每台机器实际处理的压力依然在有限范围内。</p>
<p>然而，有一个应用始终被视为性能架构的“定海神针”，在开发者圈子里，关于它<strong>单机支撑百万级并发、处理百万级吞吐</strong>的讨论从未停止，它就是我们熟知的 <strong>Nginx</strong>。</p>
<p>为什么在同样的硬件条件下，Nginx 能做到其他 Web 服务器难以企及的并发高度？这并非简单的代码优化，而是其底层架构的降维打击，<strong>也就是 Nginx 的立命之本 —— Reactor 异步事件驱动架构</strong>。</p>
<h2 data-id="heading-0">Nginx 的百万并发，背后的 Reactor 异步事件驱动架构</h2>
<p>在深入复杂的架构细节之前，我们需要先看清 Nginx 的运行形态 —— <strong>Master-Worker 进程模型</strong>。Nginx 并不是一个孤立的单进程程序，而是一个分工有序的“主从兵团”。</p>
<p><strong>Master 进程</strong>坐镇中军，负责读取配置文件、管理 Worker 进程。作为管理层，它不直接处理具体的网络请求，而 <strong>Worker 进程</strong> 才是真正冲锋陷阵的战士。Master 启动后会根据配置 <code>fork</code> 出多个 Worker 进程。由于每个 Worker 都是独立的进程，拥有独立的内存空间，它们之间互不干扰。如果一个 Worker 意外挂掉，Master 会迅速感知并拉起一个新的，实现极高的“高可用性”。同时，这种多进程模型让 Nginx 能将每个进程绑定到特定的 CPU 核心上，完美利用多核优势，避开了传统多线程模型中令人生畏的“锁竞争”和“上下文切换”开销。</p>
<p>然而，仅仅靠多进程还不足以支撑起单机百万并发的传说。如果 Worker 内部采用的是传统的“一请求一阻塞”模式，那么即便有再多的进程，也会在海量连接面前因资源耗尽而瘫痪。真正让每个 Worker 拥有“以一当百”战斗力的，是其内部运行的 <strong>Reactor 异步事件驱动架构</strong>。</p>
<h3 data-id="heading-1">Reactor 异步事件驱动架构</h3>
<p><strong>Reactor（反应器）模式</strong>，本质上是一种<strong>为处理一个或多个并发输入源，而设计的一种同步事件观察者模式</strong>。在设计模式的教科书《Pattern-Oriented Software Architecture》中，Reactor 包含四个核心角色。我们可以通过这四个角色，看清请求是如何在 Nginx 内部流转的。</p>
<ol>
<li>
<p><strong>资源 (Resources)</strong>：在网络编程中，这通常指一个个 <strong>Socket（文件描述符）</strong>。它们是事件的载体，比如“数据到了”或者“连接断了”。</p>
</li>
<li>
<p><strong>同步事件分离器 (Synchronous Event Demultiplexer)</strong>：这是整个架构的“守门员”。它的职责是<strong>阻塞等待</strong>。虽然它本身是阻塞的，但它同时盯着<strong>成千上万</strong>个资源。只要有一个资源“活跃”了（比如有数据进来），它就会立即返回，并告知是哪个资源动了。
<em>注：这正是后面我们要讲的 <code>epoll</code> 扮演的角色。</em></p>
</li>
<li>
<p><strong>反应器 (Reactor)</strong>：这是架构的“调度中心”。它持有一个“分发表”。当分离器发现某个 Socket 有动静时，Reactor 会根据事件类型（Read/Write/Accept），查询分发表，找到预先注册好的“处理器”。</p>
</li>
<li>
<p><strong>事件处理器 (Event Handler)</strong>：这是真正的业务逻辑执行者。它是<strong>非阻塞</strong>的。它被 Reactor 触发后，迅速完成读写操作，然后立即交回控制权。它绝不会在原地等待网络传输，因为那会卡死整个 Reactor 循环。</p>
</li>
</ol>
<h3 data-id="heading-2">Reactor 在 Nginx</h3>
<p>将这四个角色串联起来，我们就得到了 Nginx 处理请求的“流水线”：</p>
<p>当用户发起 HTTP 请求时，Nginx 已经预先由 <strong>Master 进程</strong> 创建好了监听端口。随后，<strong>Worker 进程</strong> 将这些监听连接的 <code>socket</code> 注册到<strong>同步事件分离器（epoll）</strong> 中。此时，Worker 进程并不会死等，而是进入一种“随时待命”的阻塞状态。一旦某个 <code>socket</code> 有数据流入，内核的 <strong>epoll</strong> 会立即感知到。这个“分离器”会精准地挑选出那些活跃的 <code>socket</code>，并返回给<strong>反应器</strong>（Worker 的事件循环）。</p>
<p><strong>Worker 进程</strong> 拿到活跃的 <code>socket</code> 后，并不会漫无目的地处理。它会像查表一样，根据事件类型（是新连接、还是旧连接有新数据）去调用预先注册好的<strong>事件处理器</strong>，也就是Nginx 中的各个模块。<strong>事件处理器（如静态资源模块）</strong> 被触发后立即执行。它从 <code>socket</code> 缓冲区读取数据、进行逻辑处理（如 Gzip 压缩），然后迅速将响应写回。处理完后，它绝不拖泥带水，立即将控制权交还给 <strong>Worker 的事件循环</strong>，以便处理下一个就绪的请求。</p>
<p>相较于传统的 BIO 模式，这种设计模式带来的最大变革是：<strong>解耦了连接与线程。</strong> 在一个 Reactor 线程里，我们可以维护 100 万个处于静止状态的连接，而只在它们活跃的瞬间，才分配 CPU 资源去处理。</p>
<h2 data-id="heading-3">Epoll：撑起百万并发的钢铁之基</h2>
<p>在上文中，我们构建了一套精妙的 Reactor 异步处理架构。然而，在这幅高性能的宏伟蓝图中，我们其实忽略了一个最核心的“齿轮”——<strong>同步事件分离器究竟是如何盯住成千上万个资源的？</strong></p>
<p>想象一下，当 Worker 进程手里握着 100 万个连接（Socket）时，如果其中只有一个连接传来了数据，我们要如何从这百万级的“大海”里，准确、迅速地捞出这根“针”？这就好比我们设计出了一台拥有十万匹马力的超级发动机，但如果没有一个强韧到足以承载这种爆发力的变速器齿，毫无疑问我们的系统会直接崩掉。</p>
<p>在早期的 Linux 时代，<code>select</code> 和 <code>poll</code> 机制就像是木制齿轮：每当有数据进来，它们必须像“查户口”一样把 100 万个连接从头到尾遍历一遍（复杂度为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span>）。随着连接数增加，这种盲目的轮询会瞬间榨干 CPU。</p>
<p><strong>为了打破这个僵局，Linux 祭出了它的终极武器 —— Epoll。它不再是盲目的寻找，而是一场精准的“订阅与通知”。</strong> 不过在我们开始 Epoll 底层原理的探索前，我们得先拜访一下 <code>epoll</code> 的前辈  <code>select</code> 和 <code>poll</code> 。</p>
<h3 data-id="heading-4">步履蹒跚的先行者 Select &amp; Poll</h3>
<p>要理解 Epoll 的伟大，必须先看清它的前辈们——<strong>Select</strong> 和 <strong>Poll</strong> 是如何“挣扎”的。</p>
<p>在 Linux 的进化史上，Select 和 Poll 属于同一代技术。它们解决的是“从 0 到 1”的复用问题，但在“从 1 到 100 万”的并发跨越上，它们遇到了无法逾越的物理屏障。</p>
<p><code>select</code> 技术诞生于1980年代，当时的机器性能有限，且也不会出现如今动不动的千万并发量。所以最大 fd 数限定为 1024 个，并且把 fd 列表放在用户态，采用"用户空间提供列表，内核检查"的简单模式。</p>
<p>这样的设计在当时的场景下确实相当不错，然而当现代程序所需要处理的数据量远远超过设计之初的预想支持场景时，<code>select</code>将会瞬间瘫痪：</p>
<ol>
<li>
<p><strong>搬运之重 (Memory Copy)</strong>：用户态与内核态之间就像隔着一道厚重的门。Select/Poll 每次都要背着沉重的背囊（全量 FD 集合）跨过这道门，回来时还要再背一次。当并发达到十万、百万级，这种内存拷贝的带宽消耗就能把系统拖垮。</p>
</li>
<li>
<p><strong>遍历之苦 (Linear Scan)</strong>：这是一个数学上的悲剧。在百万连接中，通常只有极少数（可能只有几个或几十个）是活跃的。Select/Poll 为了这 0.01% 的活跃度，却要付出 100% 的努力去扫描，白白浪费了 99.99% 的 CPU 周期。</p>
</li>
<li>
<p><strong>触发之乱 (Repeat Set)</strong>：每次调用完 Select/Poll，原来的监听集合会被内核修改。这意味着下一次循环时，你必须重新初始化、重新填充集合。具体来说，<code>select</code> 使用的是位图（bitmap），内核在检测到事件后会<strong>直接修改</strong>这个位图。导致用户态每次循环都要重新初始化 <code>fd_set</code>，这在百万并发下是巨大的无用功。</p>
</li>
</ol>
<p>2002 年，Linux 2.6 内核终于祭出了 <strong>Epoll</strong>。如果说 <code>select</code> 是在每一次任务开始前都要重新排队、重新点名的 <strong>“原始作坊”</strong> ，那么 <code>epoll</code> 则是建立了一套高效的 <strong>“订阅-通知系统”</strong>。它的核心逻辑从<strong>主动轮询</strong>彻底倒转为了<strong>被动回调</strong>。它不再询问：“请问有人准备好了吗？”，而是静静坐着，等待那些准备好的连接自己“跳”出来报到。</p>
<p>接下来，我们将揭开 <code>epoll</code> 内部是如何设计数据结构和方法来解决这些问题的。</p>
<h3 data-id="heading-5">Epoll 底层结构详解</h3>
<p>既然 <code>select</code> 的核心痛点在于“记不住（重复拷贝）”和“找不着（线性遍历）”，那么 <code>epoll</code> 的破局思路就非常直接：<strong>将“存储”与“通知”彻底分离</strong>。</p>
<p>它不再使用单一的位图来混杂地处理所有事情，而是引入了两种更高级的数据结构，分而治之地解决了这两个核心难题。让我们像拆解精密机械表一样，深入内核，看看 <code>epoll</code> 是如何通过 <strong>红黑树</strong> 和 <strong>就绪链表</strong> 这两大物理支柱，实现从 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span> 到 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span> 的跨越的。</p>
<h4 data-id="heading-6">红黑树 &amp; 就绪链表：从“无状态工具”到“有状态服务”</h4>
<p>相对于 <code>select</code>，<code>epoll</code> 中最重要的数据结构就是用于维护 <code>fd</code> 列表的<strong>红黑树</strong>。不过在我们讨论 <code>epoll</code> 如何“Make IO Program Great Again”之前，我们需要再次回顾一遍 <code>select</code> 对于 <code>fd</code> 列表是如何维护的。</p>
<h5 data-id="heading-7">Select：一个没有记忆的“计算器”</h5>
<p><code>select</code> 本质上是一个<strong>无状态的工具函数</strong>。当你调用 <code>select</code> 时，我们可以把 <code>select</code> 的过程想象成是在拿着一张 <strong>“检查单”</strong> （<code>fd</code> 的 <code>bitmap</code>）去办事大厅排队：当你调用 <code>select</code> 时，你必须把这张密密麻麻写满 Socket 编号的检查单，通过窗口（System Call）硬塞进内核。然后返回给你一张宛如瀑布般飞流直下的检查表单，你再用放大镜一条条地遍历下去......</p>
<h5 data-id="heading-8">Epoll：一个专业的“管理员式服务”</h5>
<p>为了解决这个问题，<code>epoll</code> 将 <code>select</code> 从一个简单的打勾窗口变为了 <strong>“图书管理员”</strong>
，将 <code>fd</code> 管理的工作从用户态维护的<code>fd</code>位图迁移到了内核的<strong>红黑树 (RB-Tree)</strong> 中来统一管理，只向外提供已经就绪的 <code>socket</code>。当你通过窗口（System Call）获取就绪 <code>socket</code> 时终于不再给你一纸长文了，而是可以立即使用的<strong>就绪链表 (Ready List)</strong>，排除了那些未响应的 <code>fd</code> 也省去了检查的步骤。</p>
<blockquote>
<h4 data-id="heading-9">为什么用的是红黑树？而不是 B+ 树、平衡树？</h4>
<ul>
<li><strong>为什么不用哈希表？</strong> 虽然哈希表的查找是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span>，但它在扩容时（Rehash）会产生巨大的性能抖动，且内存占用不稳定，无法满足内核对稳定性的极致要求。</li>
<li><strong>为什么不用 B+ 树？</strong> B+ 树是为了磁盘 I/O 优化的，层高低是为了减少磁盘寻道次数。但在内存中，红黑树的二叉结构在处理“频繁的插入和删除”时效率更高，且实现相对 B+ 树更轻量。</li>
<li><strong>红黑树的平衡：</strong> 它保证了在最坏情况下，增删改查的时间复杂度也是稳定的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span>。对于管理 100 万个连接，树的高度也就 20 层左右，CPU 只需要几十次指令就能找到目标，效率极高。</li>
</ul>
</blockquote>
<p>至此，<strong>红黑树</strong>和<strong>就绪链表</strong>解决了 <code>select</code> 的“笨重”问题。然而，这还不足以让 <code>epoll</code> 成为撑起百万并发的钢铁之基，这两大结构只是提供了一个静态的“理论模型”。</p>
<p>如果缺乏一套动态的驱动机制，这台机器依然无法运转。接下来的 <strong>回调机制 (Callback)</strong> 与 <strong>等待队列 (Wait Queue)</strong>，赋予了 <code>epoll</code> 真正的“智能”，完成了从“静态存储”到“动态响应”的关键闭环。</p>
<h4 data-id="heading-10">等待队列 &amp; 回调：闭环的最后一块拼图</h4>
<p>拥有了红黑树（高效存储）和就绪链表（高效访问），我们仅仅是造出了跑车的<strong>引擎</strong>和<strong>轮子</strong>。但要让这辆车真正跑起来，我们还缺少一套能够自动感知路况并传输动力的<strong>传动系统</strong>。</p>
<p>换句话说，静态的数据结构无法自己产生动作。我们需要解决两个动态运行时的终极难题：</p>
<ol>
<li><strong>数据的来源：</strong> 数据到底是怎么从网卡“飞”进就绪链表的？我们绝对不能再去轮询红黑树。</li>
<li><strong>CPU 的去向：</strong> 当没有数据时，Worker 进程该如何优雅地让出 CPU，而不是在那儿傻傻地空转？</li>
</ol>
<p>而这就是 <strong>回调机制</strong> 与 <strong>等待队列</strong> 的由来。</p>
<h5 data-id="heading-11">回调机制 (Callback)：连接红黑树与就绪链表的“桥梁”</h5>
<p>我们在前面设计了美妙的红黑树（存储所有连接）和就绪链表（存储活跃连接）。但是，我们忽略了一个最关键的战术动作：<strong>究竟是谁，在什么时候，把红黑树上那个“有数据”的 Socket 摘下来，放进就绪链表里的？</strong></p>
<p>显然，内核不可能一直盯着红黑树看（那又变成了轮询）。这里的关键就在于<strong>回调机制</strong>。当 <code>epoll_ctl</code> 将一个 Socket 加入红黑树时，内核会同步给这个 Socket 注册一个<strong>回调函数 (<code>ep_poll_callback</code>)：</strong></p>
<ul>
<li><strong>触发时机：</strong> 当网卡接收到数据包，硬件中断触发驱动程序运行。</li>
<li><strong>执行动作：</strong> 驱动程序调用这个回调函数，它会精准地找到红黑树上对应的节点，将其“挂”到<strong>就绪链表</strong>的尾部。</li>
</ul>
<p><strong>这一步是质的飞跃：</strong> 数据的准备不再需要 <code>select</code> 那样的主动探测，而是变成了<strong>硬件驱动的主动投递</strong>。</p>
<h5 data-id="heading-12">等待队列 (Wait Queue)：进程的“挂起”与“唤醒”</h5>
<p>数据准备好的问题解决了，那 Worker 进程这一端呢？ 当就绪链表为空时，Worker 进程如果不休眠，就会陷入死循环空转，榨干 CPU。但如果休眠了，谁来告诉它天亮了？</p>
<p>这就是<strong>等待队列</strong>的职责：</p>
<ul>
<li><strong>安心睡眠（挂起）：</strong> 当 Worker 调用 <code>epoll_wait</code> 发现没有数据时，内核会创建一个等待节点（Wait Entry），把自己挂到 <code>epoll</code> 的等待队列中，然后放心地移出 CPU 运行队列，进入睡眠状态（CPU 占用率为 0）。</li>
<li><strong>主动叫醒（唤醒）：</strong> 还记得上面的那个回调函数吗？它在把 Socket 放入就绪链表后，会顺便看一眼等待队列。如果发现里面有睡着的 Worker，就会立刻将其<strong>唤醒</strong>。</li>
</ul>
<blockquote>
<h4 data-id="heading-13">番外篇：惊群效应 (Thundering Herd) 与 Epoll 的进化</h4>
<p><strong>什么是惊群？</strong> 想象一下，有 4 个 Worker 进程都挂在同一个 <code>epoll</code> 实例的等待队列上“睡觉”。突然，来了一个新连接（数据）。理论上，只需要唤醒 1 个 Worker 去处理就够了。 但在早期的 Linux 内核（2.6.18 之前）中，内核会像敲锣打鼓一样，把这 4 个睡觉的 Worker <strong>全部叫醒</strong>。</p>
<ul>
<li><strong>结果：</strong> 4 个进程都醒了，冲上去抢这 1 个连接。</li>
<li><strong>代价：</strong> 只有 1 个抢到了，剩下 3 个发现没事干，只能灰溜溜地回去继续睡。这就导致了瞬间的 CPU 上下文切换风暴，性能大大折损。</li>
</ul>
<p><strong>Nginx 的应对：</strong> 为了解决这个问题，Nginx 早期采用了一把全局锁（Accept Mutex）。每个 Worker 在调用 <code>epoll_wait</code> 之前，必须先去抢这把锁。抢到的才有资格去监听端口，没抢到的只能在一旁干等。这虽然解决了惊群，但也限制了并行度。</p>
<p><strong>内核的终极解法：</strong> 现在的 Linux 内核已经完美解决了这个问题。</p>
<ol>
<li><strong>Accept 惊群：</strong> 内核引入了 <code>EPOLLEXCLUSIVE</code> 标志。当设置了这个标志，内核在唤醒时会“排他性”地只唤醒 <strong>1 个</strong> 正在等待的进程，彻底根治了惊群效应。</li>
<li><strong>SO_REUSEPORT：</strong> 允许所有 Worker 绑定同一个端口，由内核进行负载均衡，让惊群成为历史。</li>
</ol>
</blockquote>
<h4 data-id="heading-14">三个系统调用：epoll 具体做了什么怎么做？</h4>
<p>至此，我们已经完全参悟了 <code>epoll</code> 的一切。那么现在，再让我们从 Linux 提供的三个系统调用接口出发，通过一个简化的场景代码，将 <strong>红黑树、就绪链表、回调、等待队列</strong> 这一整套复杂的机械装置真正运转起来。</p>
<p>Linux 内核将 <code>epoll</code> 的复杂机制封装成了三个极简的“手术刀”：</p>
<ul>
<li>
<p><code>epoll_create</code></p>
<ul>
<li><strong>动作：</strong> 在内核中创建一个 <code>epoll</code> 实例。</li>
<li><strong>内核映射：</strong> 此时，内核会初始化两个核心结构：一棵空的 <strong>红黑树</strong>（用于存 Socket）和一个空的 <strong>就绪链表</strong>。</li>
<li><strong>返回：</strong> 返回一个句柄 <code>epfd</code>，以后所有的操作都靠它。</li>
</ul>
</li>
<li>
<p><code>epoll_ctl</code></p>
<ul>
<li><strong>动作：</strong> 向 <code>epoll</code> 实例中添加、修改或删除感兴趣的 Socket 事件。</li>
<li><strong>内核映射：</strong> 这是最关键的一步。当你调用 <code>EPOLL_CTL_ADD</code> 时，内核会做两件事：
<ol>
<li>将该 Socket 节点插入到 <strong>红黑树</strong> 中（解决查找问题）。</li>
<li>给该 Socket 注册 <strong>回调函数 (<code>ep_poll_callback</code>)</strong>（解决驱动问题）。</li>
</ol>
</li>
</ul>
</li>
<li>
<p><code>epoll_wait</code></p>
<ul>
<li><strong>动作：</strong> 阻塞等待事件发生。</li>
<li><strong>内核映射：</strong>
<ol>
<li>检查 <strong>就绪链表</strong> 是否有数据。</li>
<li>如果有，直接返回（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span>）。</li>
<li>如果没有，将当前进程放入 <strong>等待队列</strong>，并让出 CPU 进入睡眠（挂起）。</li>
</ol>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-15">实战演练：一个极简的 Epoll Server</h4>
<p>为了把上述流程具象化，我们来看一段伪代码。这段代码展示了 Nginx Worker 进程内部最核心的循环逻辑：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 1. [epoll_create]创建 epoll 实例</span>
<span class="hljs-comment">// 内核动作：初始化红黑树、就绪链表、等待队列</span>
<span class="hljs-type">int</span> epfd = epoll_create(<span class="hljs-number">1</span>);

<span class="hljs-comment">// 2. [epoll_ctl] 注册监听 Socket (listen_fd)</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">epoll_event</span> <span class="hljs-title">ev</span>;</span>
ev.events = EPOLLIN; <span class="hljs-comment">// 监听读事件</span>
ev.data.fd = listen_fd;

<span class="hljs-comment">// 内核动作：将 listen_fd 挂入红黑树，并注册回调函数</span>
epoll_ctl(epfd, EPOLL_CTL_ADD, listen_fd, &amp;ev);

<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">epoll_event</span> <span class="hljs-title">events</span>[<span class="hljs-title">MAX_EVENTS</span>];</span>

<span class="hljs-comment">// 3. 进入 Reactor 事件循环 (Nginx Worker 的日常)</span>
<span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
    <span class="hljs-comment">// [epoll_wait] 等待事件</span>
    <span class="hljs-comment">// 内核动作：</span>
    <span class="hljs-comment">// A. 检查就绪链表。如果不为空，直接返回。</span>
    <span class="hljs-comment">// B. 如果为空，把当前进程放入“等待队列”，进入睡眠。</span>
    <span class="hljs-comment">// C. 当网卡有数据 -&gt; 触发中断 -&gt; 回调函数把 fd 放入就绪链表 -&gt; 唤醒当前进程。</span>
    <span class="hljs-type">int</span> nfds = epoll_wait(epfd, events, MAX_EVENTS, <span class="hljs-number">-1</span>);

    <span class="hljs-comment">// 4. 遍历就绪链表 (只处理活跃的，不遍历无效的)</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; nfds; i++) {
        <span class="hljs-keyword">if</span> (events[i].data.fd == listen_fd) {
            <span class="hljs-comment">// 处理新连接</span>
            <span class="hljs-type">int</span> client_fd = accept(listen_fd, ...);
            
            <span class="hljs-comment">// 将新连接也加入红黑树监管</span>
            epoll_ctl(epfd, EPOLL_CTL_ADD, client_fd, &amp;ev);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 处理已有连接的数据</span>
            <span class="hljs-comment">// 这就是 Reactor 模式中的 "Handler"</span>
            handle_request(events[i].data.fd);
        }
    }
}
</code></pre>
<p>让我们最后一次梳理数据是如何从网卡流向用户程序的：</p>
<ol>
<li><strong>布局 (epoll_ctl)</strong>：进程将 Socket 注册到内核的 <strong>红黑树</strong>，并绑定回调。</li>
<li><strong>入睡 (epoll_wait)</strong>：进程发现没有数据，进入 <strong>等待队列</strong> 睡觉，CPU 利用率降为 0。</li>
<li><strong>触发 (Interrupt)</strong>：网卡收到数据，硬件中断唤醒内核。</li>
<li><strong>搬运 (Callback)</strong>：回调函数将红黑树上对应的 Socket 搬运到 <strong>就绪链表</strong>，并唤醒 <strong>等待队列</strong> 中的进程。</li>
<li><strong>处理 (Wakeup)</strong>：进程醒来，直接从 <strong>就绪链表</strong> 拿走数据，执行业务逻辑。</li>
</ol>
<h2 data-id="heading-16">拨开迷雾，直抵内核</h2>
<p>文章的开头，我们惊叹于 Nginx 单机百万并发的宏大数字；文章的结尾，我们终于在 Linux 内核的深处找到了支撑这一奇迹的答案。</p>
<p>回顾全文，Nginx 其实更像是一个完美的 <strong>“技术展台”</strong> ，它向世人展示了当应用层架构（Reactor）与内核层机制（Epoll）实现完美共振时，软件性能可以达到怎样的高度。我们花大篇幅去剖析红黑树、拆解回调机制、追踪就绪链表，正是为了证明一点：<strong>所谓的高性能“神话”，不过是对底层原理极致利用后的必然结果。</strong></p>
<p>此刻，当我们再次审视 Nginx 那看似复杂的 Master-Worker 进程与配置文件时，眼前的迷雾已然散去。我们看到的不再是神秘的代码黑盒，而是 <strong>Epoll</strong> 那颗强劲跳动的“心脏”，在每一次回调与唤醒中，源源不断地为互联网输送着动力。</p>
<p>Nginx 的百万并发，始于架构，成于 Epoll。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ACM Multimedia | 京东零售广告创意：统一的布局生成和评估模型]]></title>    <link>https://juejin.cn/post/7592922036092977167</link>    <guid>https://juejin.cn/post/7592922036092977167</guid>    <pubDate>2026-01-09T07:29:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592922036092977167" data-draft-id="7593158683410333696" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ACM Multimedia | 京东零售广告创意：统一的布局生成和评估模型"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-09T07:29:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东零售技术"/> <meta itemprop="url" content="https://juejin.cn/user/4233576972293643"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ACM Multimedia | 京东零售广告创意：统一的布局生成和评估模型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4233576972293643/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东零售技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T07:29:15.000Z" title="Fri Jan 09 2026 07:29:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文入选顶会ACM Multimedia</p>
<p>布局生成在电商图片的设计中起到至关重要的作用。当前的布局生成方法在能力上具有任务特定性，并且评估标准与人类感知不一致，导致其应用范围有限且评估效果不佳。为了解决这些问题，Uni-Layout实现了统一生成、模拟人类的评估以及二者之间的对齐。针对通用生成，该框架将各种布局任务整合到一个统一的分类系统中，并开发了一个统一的生成器，通过自然语言提示处理背景或元素内容受限的任务。为了引入人类反馈以有效评估布局，我们构建了Layout-HF100k，这是首个包含10万个人工标注布局的大规模人类反馈数据集。基于Layout-HF100k，我们引入了一种模拟人类的评估器，该评估器结合视觉和几何信息，采用思维链机制进行定性评估，并通过信心估计模块提供定量测量。为了更好地对齐生成器和评估器，我们采用动态边距偏好优化（DMPO）技术，将二者整合为一个协调系统，以更好地符合人类判断。</p>
<p>论文链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2508.02374" target="_blank" title="https://arxiv.org/abs/2508.02374" ref="nofollow noopener noreferrer">arxiv.org/abs/2508.02…</a></p>
<h2 data-id="heading-0">一、背景与现状</h2>
<p>布局生成旨在为给定的元素设计吸引人的视觉排版，涵盖从海报和文档设计到用户界面布局和杂志排版等广泛任务。虽然生成模型取得了显著进展，但现有方法通常专注于狭义任务，导致解决方案缺乏灵活性和普适性。此外，尽管现有的评估指标基于布局设计原则精心设计，但它们常常与人类的感知不一致。如图1所示，高评分的布局可能在视觉质量上较差，这揭示了现有指标与真实人类感知之间的差距。为了解决这些挑战，我们提出了Uni-Layout，一个通过统一生成器、模拟人类的评估器和动态边距对齐机制来整合布局生成、评估和对齐的整体框架。为了详细阐述Uni-Layout，本文围绕三个核心研究问题展开。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2758450960cb45c7a951d65a718765ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768548555&amp;x-signature=BAJsnq4zOPsOXyQjT8C2KlJ8Ais%3D" alt="image.png" loading="lazy"/></p>
<p align="center">图1：布局生成任务的分类体系与动机阐述</p>
<h2 data-id="heading-1">二、如何实现跨任务的统一布局生成</h2>
<p>为了系统地统一当前分散的布局生成任务领域，我们提出了一个基于两个维度的精心组织的分类法：背景和元素内容是自由的还是受限的。如图1所示，我们将现有的布局任务分为四种代表性类型：BFEF、BCEF、BFEC和BCEC。当前的任务特定方法在统一布局生成方面存在困难，但多模态大型语言模型（MLLMs）由于其通用的视觉-语言理解能力，提供了有前景的解决方案。利用MLLMs，我们提出了一个统一的布局生成器，其工作方式类似于一名熟练的设计师。该生成器结合视觉约束和文本指令来生成连贯的布局，能够处理背景和元素内容既可以受限也可以自由的多种场景。通过在各种布局任务上的联合训练，它为布局生成提供了一个灵活且统一的解决方案。</p>
<p>为了统一多种布局任务，一个通用的布局任务指令可写作：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ccc35f012c8b4a819609c909a05a1b0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768548555&amp;x-signature=Ycwcy6SMRqP1HK6fW87hZ%2Bg0Wc8%3D" alt="image.png" loading="lazy"/></p>
<p>其中T为任务描述，b表示背景的内容和属性，e表示元素的内容和属性，O是指定的输出格式。注意背景和元素的属性是必须的，但其内容可为空。为了清楚起见，我们针对BCEC任务提供了一个说明示例，其中下划线部分对应上式中的对应项。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16d88ad7176a4dbc8d7da0db11177440~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768548555&amp;x-signature=0gT6rNwEXW5NuvQvD6Q0McunRsw%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">三、如何模拟人类来评估布局</h2>
<p>尽管人类感知在布局设计中非常重要，但现有数据集中缺乏对布局质量的人类反馈。为弥补这一缺口，我们汇总了统一生成器的输出，并编制了Layout-HF100k，这是首个专为布局生成策划的全面人类反馈数据集，包含10万个精心标注的高质量示例，涵盖代表性布局任务。该数据集的示例如图2所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04438e41c67c48059691166ecda9bbb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768548555&amp;x-signature=aFOC8i%2BjmWrgIvNKmI%2BSXJaO9u0%3D" alt="image.png" loading="lazy"/></p>
<p align="center">图2：Layout-HF100k示例。第一/二行分别为合格/不合格布局。</p>
<p>基于这一全新的数据集，我们开发了一种评估器，结构如图3（b）和（c）所示。其通过视觉和几何信息两个分支处理布局，以有效模拟人类判断模式。此外，该评估器结合了一个输出定量置信度估计的分类头，以及定性“思维链”（CoT）推理，使其能够捕捉微妙的审美偏好，并提供与人类感知模式紧密对齐的可解释评估。通过结合多模态分析和CoT推理，我们的评估器不仅能够做出准确判断，还能阐明其决策背后的理由，类似于人类专家如何评估布局。</p>
<p>具体来说，CoT包含以下四个步骤：</p>
<p>(1) 布局概览：对布局可视化结果快速而全面的扫描，通过简洁的文本描述捕捉布局的第一印象，概述整体构图和上下文元素。</p>
<p>(2) 空间解构：系统地分解布局的基本组成部分，分析几何属性和空间关系。它检查对齐模式、识别潜在重叠，并评估间距一致性，以揭示潜在的结构框架。</p>
<p>(3) 美学评估：对布局的视觉质量进行详细评估，重点关注艺术价值和设计原则。这包括对比例平衡、空间和谐和视觉节奏的评估，同时考虑这些元素如何对整体美学效果产生影响。</p>
<p>(4) 全面评估：最后阶段综合所有先前分析的见解，以提供对布局有效性的全面评估，最后给出“合格”或“不合格”的明确判断。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c444aa38e9564a27940d827d732a3add~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768548555&amp;x-signature=QaEvpiwATZkXJqMWNZMwMxSWNwI%3D" alt="image.png" loading="lazy"/></p>
<p align="center">图3：Uni-Layout框架概览</p>
<h2 data-id="heading-3">四、如何有效对齐人类反馈和布局生成</h2>
<p>现有的对齐方法要么直接最大化人类偏好的输出可能性，要么在其偏好学习目标中使用固定边距。这些传统方法未能反映人类偏好的不同程度，因为它们对强偏好和弱偏好一视同仁。为了解决这一限制，我们提出了一种新的对齐方法，称为动态边距偏好优化（DMPO）。具体而言，当评估者在成对样本之间表现出更强烈的偏好时，DMPO会自动增加边距，以在胜出和失败的响应之间强制产生更大的分数差异，而对于不太明显的偏好则应用较小的边距。这种信心引导的自适应边距策略更好地捕捉了人类判断的范围，从而实现与布局生成和人类偏好的更精确对齐。</p>
<p>如图3（d）所示，给定任务指令和可选的背景或元素内容，生成器产生两个候选布局l1和l2。之后通过双分支处理器将布局结果转化为视觉和几何信息，并通过布局评估器产出候选布局的得分。我们将两种布局的分数差距定义如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f368bada7bc4d5b9cfe5d0269504385~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768548555&amp;x-signature=OZJLbzB%2FCGpRWtQzWf%2BBtYwh8NA%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4eee62d31ec4b339d1c3f410eb26732~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768548555&amp;x-signature=cahdn1a1miCsv%2FXBwer%2BuoWnrqY%3D" alt="image.png" loading="lazy"/></p>
<p>其中I+和l+分别表示高分布局的视觉和几何信息。为了进一步增强对边距的感知，我们应用了非线性变换f()来处理分数差距。最终，DMPO的损失形式可写作：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16faab4ab3f842d48c36231a8eb7ff6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768548555&amp;x-signature=W%2F5kHX8LHBJHyfkglSm2%2BvneayA%3D" alt="image.png" loading="lazy"/></p>
<p>通过将生成和评估整合到反馈循环中，DMPO弥合了布局生成和人类审美偏好之间的差距，产生了更具视觉吸引力的布局。</p>
<h2 data-id="heading-4">五、实验结果</h2>
<p>1、布局评估模型性能</p>
<p>为了验证我们的评估器，我们将其与一些领先的闭源（M）LLM模型进行比较，包括GPT-4o、Claude3.5 Sonnet（Claude3.5）、GLM-4v和DeepSeek-R1。这些模型遵循“LLM-as-Judge”范式。所有模型接收相同的指令和视觉输入，除了DeepSeek-R1，它只处理文本。如表1所示，我们的模型表现出色，达到85.5%的准确率，比现有的MLLMs高出25-35%。一些MLLMs的表现接近随机（约50%），突显了它们在布局评估中的局限性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5d9d2c68fad40e2bb8057544ee952d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768548555&amp;x-signature=xWSLYc4YN8CGLoebEMRpv5sLiEk%3D" alt="image.png" loading="lazy"/></p>
<p align="center">表1 ：布局评估模型对比</p>
<p>2、布局生成模型性能</p>
<p>在本小节中，我们与三类基线方法进行了比较：(1) 针对单个布局任务设计的任务特定SOTA模型（例如，LayoutDM）；(2) 闭源模型，包括GPT-4o、Claude3.5和DeepSeek-R1；(3) 开源的多模态大语言模型（MLLMs），如联合训练四个任务的LLaVA。</p>
<p>在表2展示的任务特定评估中，我们的方法在多个指标上表现出色。值得注意的是，在BFEF任务中，我们实现了最低的Ove（0.001）和Ali（0.00004），与专用模型如LayoutDM和LayoutFlow持平或超越。在BFEC任务中，我们的方法以最小的Ove（0.00045）和最高的Max.（0.439）创下新纪录。在BCEF任务中，我们在𝑅𝑐𝑜𝑚（31.848）和𝑅𝑠𝑢𝑏（0.774）方面取得了最佳结果。同样，在BCEC任务中，我们的方法以最低的𝑅𝑐𝑜𝑚（8.536）显著优于现有方法，同时在其他指标上保持竞争力。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2db6e8ec919b4a84a5e67b7470924ea7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768548555&amp;x-signature=KRadilhp91cUIrSCrmD7bFAU9nc%3D" alt="image.png" loading="lazy"/></p>
<p align="center">表2：任务特定评估指标结果</p>
<p>针对所有任务的人类模拟评估，我们引入了评估模型的LR分数来评估性能。如图4所示，我们的方法实现了最高的LR分数0.702，在不同布局场景中表现出持续的优越性。与其他模型相比，我们显著超越了GPT-4o（0.584）、Claude3.5（0.575）和DeepSeek-R1（0.401），差距明显。与开源基线LLaVA（0.422）相比，性能差距更加显著，提升了近30%。与LayoutFlow（BFEF的SOTA）、P&amp;R（BFEC的SOTA）和Poster-Llama（BCEF和BCEC的SOTA）取得的平均LR分数0.658相比，我们的方法取得了更优的结果，从而验证了Uni-Layout的有效性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7feab9abcc4f4bfe851ec98d80a369b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768548555&amp;x-signature=IXsqqV8U9Z3xv%2Fo3%2BkJ%2FR5Huu0I%3D" alt="image.png" loading="lazy"/></p>
<p align="center">图4： 人类模拟评估指标结果</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>