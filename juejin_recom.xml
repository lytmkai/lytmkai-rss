<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[SPI 只是个接口？揭秘芯片间的高速通道！]]></title>    <link>https://juejin.cn/post/7588092534162128896</link>    <guid>https://juejin.cn/post/7588092534162128896</guid>    <pubDate>2025-12-27T16:28:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588092534162128896" data-draft-id="7588004601393938466" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SPI 只是个接口？揭秘芯片间的高速通道！"/> <meta itemprop="keywords" content="嵌入式,物联网"/> <meta itemprop="datePublished" content="2025-12-27T16:28:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="迷人的星空"/> <meta itemprop="url" content="https://juejin.cn/user/977890073916588"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SPI 只是个接口？揭秘芯片间的高速通道！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/977890073916588/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    迷人的星空
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T16:28:38.000Z" title="Sat Dec 27 2025 16:28:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>一、核心定义</strong></h2>
<p><strong>SPI</strong> 是一种硬件层面的<strong>同步、全双工、主从式</strong>串行通信协议。想象一个高速公路系统：</p>
<ul>
<li><strong>交警中心（Master）</strong> ：系统唯一的指挥者，决定何时发车、道路限速（时钟频率）。</li>
<li><strong>货运仓库（Slaves）</strong> ：多个等待服务的节点，没有交警点名，不能主动发车。</li>
<li><strong>专用车道（总线）</strong> ：这是一条铺设了<strong>双向同步车道</strong>的高速公路。车辆（数据）在精准的绿灯信号（时钟）指挥下，<strong>同时在两个方向上高速对开</strong>，效率极高。</li>
</ul>
<h2 data-id="heading-1"><strong>二、工作机制</strong></h2>
<p>这条“高速公路”最少由4条专用车道（信号线）构成，这是理解其所有特性的基础：</p>
<ul>
<li>
<p><strong>SCLK（时钟线）- 同步红绿灯</strong></p>
<ul>
<li>由<strong>交警中心（主设备）独家控制</strong>，产生固定节奏的方波。每一个脉冲，都命令所有车辆同步前进一位。</li>
</ul>
</li>
<li>
<p><strong>MOSI与MISO（数据线）- 双向车道</strong></p>
<ul>
<li><strong>MOSI</strong>：<strong>主设备输出，从设备输入</strong>。相当于交警中心向仓库发送指令的<strong>下行车道</strong>。</li>
<li><strong>MISO</strong>：<strong>主设备输入，从设备输出</strong>。相当于仓库向交警中心汇报状态的<strong>上行车道</strong>。</li>
<li><strong>关键</strong>：数据在<strong>每个时钟周期内同时、双向传输</strong>，这是“全双工”的核心，也是其高速的原因。</li>
</ul>
</li>
<li>
<p><strong>CS（片选线）- 仓库点名广播</strong></p>
<ul>
<li>这是<strong>选择与谁通信</strong>的关键。每个仓库（从设备）都有自己独立的“点名广播”。</li>
<li>交警中心通过<strong>拉低</strong>（激活）某个仓库的广播，通知它：“接下来和你对话”。同一时间<strong>只能激活一个仓库</strong>。</li>
</ul>
</li>
</ul>
<p><strong>一个完整通信流程：</strong></p>
<ol>
<li><strong>点名</strong>：交警中心拉低仓库A的<code>CS</code>线。</li>
<li><strong>同步发车</strong>：交警中心开启红绿灯(<code>SCLK</code>)，并第一个时钟边沿，通过<code>MOSI</code>线发出一位指令；同时，仓库A也必须立即在<code>MISO</code>线上准备好一位状态数据。</li>
<li><strong>并行交换</strong>：在随后的每个时钟边沿，双方都同步地交换下一位数据，如同双向车道上对向行驶的车流。</li>
<li><strong>结束</strong>：通信完毕，交警中心拉高<code>CS</code>线，仓库A退出对话。</li>
</ol>
<p><strong>技术深化：时钟模式（CPOL与CPHA）</strong></p>
<p>这是协议匹配的<strong>生死线</strong>。它定义了“红绿灯”具体的闪烁规则：</p>
<ul>
<li><strong>CPOL（时钟极性）</strong> ：红绿灯<strong>初始是亮（高电平）还是灭（低电平）</strong> ？</li>
<li><strong>CPHA（时钟相位）</strong> ：在红绿灯<strong>由灭变亮（上升沿）还是由亮变灭（下降沿）</strong> 的时刻采样数据？</li>
<li>这两者的4种组合（模式0-3），主从设备<strong>必须绝对一致</strong>，否则数据会全部错乱。<strong>模式0（CPOL=0， CPHA=0）</strong> 最为常用。</li>
</ul>
<h2 data-id="heading-2"><strong>三、局限性”</strong></h2>
<p>SPI的设计哲学是“用简单换速度”，这带来了一系列固有局限：</p>
<ol>
<li><strong>无应答机制（盲发）</strong> ：交警只管发车，不确认仓库是否收到、是否满仓。必须依靠<strong>软件层面的额外协议</strong>（如读取状态寄存器）来确认。</li>
<li><strong>引脚占用多（成本高）</strong> ：每多连接一个仓库，就需要新增一根<code>CS</code>线。连接大量设备时，会迅速耗尽主设备的引脚资源。</li>
<li><strong>通信距离短（本地网）</strong> ：由于采用单端信号，易受干扰，通常仅适用于<strong>PCB板级或机箱内（&lt;1米）</strong> 的高速通信。</li>
<li><strong>从设备实时性压力大</strong>：主设备时钟一响，从设备必须立刻在<code>MISO</code>上准备好数据，没有任何缓冲余地。当主设备时钟极快时，对从设备的硬件性能是巨大考验。</li>
<li><strong>缺乏多主能力</strong>：高速公路上只能有一个交警中心，无法构建多个指挥中心协同工作的复杂网络。</li>
</ol>
<h2 data-id="heading-3"><strong>四、工程边界与选型决策</strong></h2>
<p>理解了局限性，就划定了它的<strong>工程应用边界</strong>，并知道何时该选择它。</p>
<ul>
<li><strong>核心边界条件</strong>
<ul>
<li><strong>速率与距离成反比</strong>：追求&gt;50Mbps的高速率时，通信距离应控制在厘米级，并需严格考虑<strong>信号完整性</strong>（如阻抗匹配、减少过孔）。</li>
<li><strong>模式必须严格匹配</strong>：主从设备必须在CPOL和CPHA上<strong>完全一致</strong>。</li>
<li><strong>主设备负担全部控制</strong>：所有通信的发起、节奏、终止均由主设备负责。</li>
</ul>
</li>
<li><strong>横向协议选型对比</strong></li>
</ul>
<p>何时用SPI？与I2C、UART对比一目了然：</p>















































<table><thead><tr><th>特性维度</th><th><strong>SPI（高速公路）</strong></th><th><strong>I2C（城市公交）</strong></th><th><strong>UART（直拨电话）</strong></th></tr></thead><tbody><tr><td><strong>核心特点</strong></td><td><strong>同步，全双工，极高速</strong></td><td>同步，半双工，多设备，省引脚</td><td>异步，全双工，简单，远距离</td></tr><tr><td><strong>典型速度</strong></td><td><strong>10 Mbps - 100+ Mbps</strong></td><td>100 kbps - 3.4 Mbps</td><td>9600 bps - 10 Mbps</td></tr><tr><td><strong>引脚需求</strong></td><td>3+<code>N</code> (<code>N</code>=从机数)</td><td><strong>2线（始终）</strong></td><td>2线 (+2流控)</td></tr><tr><td><strong>寻址方式</strong></td><td>硬件片选(<code>CS</code>)线</td><td><strong>7/10位软件地址</strong></td><td>无地址（点对点）</td></tr><tr><td><strong>多主支持</strong></td><td>困难</td><td><strong>支持</strong></td><td>不支持</td></tr><tr><td><strong>最佳场景</strong></td><td>高速Flash、屏幕、ADC</td><td>传感器网络、低速EEPROM</td><td>调试日志、模块透传、长距离通信</td></tr></tbody></table>
<p><strong>选型口诀</strong>：</p>
<ul>
<li><strong>要速度、不差引脚、一对一或少量设备</strong> -&gt; <strong>选SPI</strong>。</li>
<li><strong>设备多、引脚省、速度要求不高</strong> -&gt; <strong>选I2C</strong>。</li>
<li><strong>距离远、简单可靠、点对点调试</strong> -&gt; <strong>选UART</strong>。</li>
</ul>
<h2 data-id="heading-4"><strong>五、应用场景与高级进化</strong></h2>
<ul>
<li>
<p><strong>经典应用场景（传统高速路）</strong></p>
<ul>
<li><strong>存储器</strong>：NOR Flash、EEPROM的快速读写。</li>
<li><strong>传感器</strong>：高采样率的IMU（惯性测量单元）、压力传感器。</li>
<li><strong>显示接口</strong>：OLED、TFT屏幕的初始化与显存刷新。</li>
<li><strong>模数转换</strong>：高速、高精度ADC/DAC的数据读取与配置。</li>
<li><strong>处理器间通信</strong>：MCU与FPGA、DSP之间的数据流通道。</li>
</ul>
</li>
<li>
<p><strong>协议的高级进化（智能立体交通）</strong></p>
</li>
</ul>
<p>为突破局限，SPI已衍生出更强大的版本：</p>
<ol>
<li><strong>QSPI/OSPI</strong>：将数据车道从1条扩宽至<strong>4条(QPI)或8条(OPI)</strong> ，实现“车队并行”，吞吐量飙升。广泛用于<strong>外挂Flash执行代码(XIP)</strong> 。</li>
<li><strong>双倍数据速率(DDR)</strong> ：在红绿灯<strong>亮起和熄灭的瞬间都传输数据</strong>，将理论带宽再翻一倍。</li>
<li><strong>差分SPI</strong>：使用抗干扰的<strong>差分信号对</strong>（如D+/D-）传输，适用于高速长距或恶劣电磁环境。</li>
</ol>
<h2 data-id="heading-5"><strong>六、系统级工程考量</strong></h2>
<p>在实际复杂系统中，使用SPI必须思考以下问题：</p>
<ol>
<li><strong>系统验证</strong>：如何确保SPI控制器在极端时序、数据冲突下依然可靠？需采用<strong>UVM等高级验证方法学</strong>。</li>
<li><strong>功耗管理</strong>：高速时钟常开功耗大，需使用<strong>时钟门控</strong>技术在空闲时关闭时钟。</li>
<li><strong>软件优化</strong>：在Linux等系统中，可通过<strong>预编译SPI消息</strong>、使用DMA（直接内存访问）来解放CPU，减少传输延迟。</li>
</ol>
<h2 data-id="heading-6"><strong>总结</strong></h2>
<p>你可以将SPI视为一个 <strong>“高效但苛刻的短跑健将”</strong> ：</p>
<ul>
<li><strong>它是什么</strong>：一个追求<strong>极速同步并行</strong>的芯片级通信协议。</li>
<li><strong>如何工作</strong>：在<strong>唯一主控</strong>发出的精准时钟下，通过<strong>点名（CS）</strong> 与选定从机进行<strong>双向实时（全双工）</strong> 数据交换。</li>
<li><strong>其局限性</strong>：<strong>无确认、费引脚、距离短、模式需严配</strong>，本质是<strong>用硬件复杂度和控制权换取速度</strong>。</li>
<li><strong>应用边界</strong>：它是<strong>板级高速数据流的王者</strong>，但不适合构建复杂的多节点网络或长距离通信。</li>
<li><strong>工程选择</strong>：在速度至上的场景（如驱动屏幕、读取高速传感器）中它是首选，但必须为其“伺候”好硬件时序和信号完整性。</li>
</ul>
<p>以上是个人的一些浅见，如有不当之处，欢迎批评指正。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python 工具生态深度解析：从 Pyright 到 Astral 家族]]></title>    <link>https://juejin.cn/post/7588092534162161664</link>    <guid>https://juejin.cn/post/7588092534162161664</guid>    <pubDate>2025-12-27T16:35:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588092534162161664" data-draft-id="7588093282530558004" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python 工具生态深度解析：从 Pyright 到 Astral 家族"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-27T16:35:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="moyueheng"/> <meta itemprop="url" content="https://juejin.cn/user/251106837149720"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python 工具生态深度解析：从 Pyright 到 Astral 家族
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/251106837149720/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    moyueheng
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T16:35:52.000Z" title="Sat Dec 27 2025 16:35:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Python 工具生态深度解析：从 Pyright 到 Astral 家族</h2>
<h3 data-id="heading-1">前言</h3>
<p>Python 工具生态正在经历一场前所未有的变革。近年来，我们见证了多个高效工具的涌现：Ruff 以 Rust 之姿席卷 Lint 领域，uv 重写了包管理的游戏规则，ty 则正准备革新类型检查。面对这么多工具，开发者难免会产生困惑：</p>
<blockquote>
<p>这些工具的定位有什么区别？我该选择哪一个？它们不会重复吗？</p>
</blockquote>
<p>本文将深入解析当前主流的 Python 工具，帮助你建立清晰的认知框架，并做出明智的选择。</p>
<hr/>
<h3 data-id="heading-2">一、核心概念：四个容易混淆的基础概念</h3>
<p>在深入各个工具之前，我们需要先厘清四个经常被混淆的概念。理解它们的区别是选择合适工具的基础。</p>
<h4 data-id="heading-3">1.1 概念对比总览</h4>
<pre><code class="hljs language-arduino" lang="arduino">┌─────────────────────────────────────────────────────────────────┐
│                                                                  │
│  类型检查  ──→  这段代码的<span class="hljs-string">"类型"</span>对吗？                             │
│                例如: 字符串能加数字吗？                            │
│                                                                  │
│  Linting    ──→  这段代码的<span class="hljs-string">"写法"</span>好吗？                            │
│                例如: 变量名规范吗？有未使用的代码吗？                 │
│                                                                  │
│  格式化     ──→  这段代码的<span class="hljs-string">"样子"</span>好看吗？                           │
│                例如: 缩进、空格、换行统一吗？                        │
│                                                                  │
│  LSP        ──→  编辑器如何和这些工具<span class="hljs-string">"对话"</span>？                        │
│                它是通信协议，不是工具本身                           │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-4">1.2 类型检查 (Type Checking)</h4>
<p><strong>问题</strong>：这段代码的类型是否正确？</p>
<p>类型检查器通过静态分析代码中的类型注解，在运行前发现类型错误。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 类型检查器会发现的问题</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a: <span class="hljs-built_in">int</span>, b: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:
    <span class="hljs-keyword">return</span> a + b

<span class="hljs-comment"># ✅ 正确</span>
result = add(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)

<span class="hljs-comment"># ❌ 类型错误！字符串不能传给 int 参数</span>
result = add(<span class="hljs-string">"hello"</span>, <span class="hljs-string">"world"</span>)

<span class="hljs-comment"># ❌ 返回类型不匹配</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">int</span>:
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"Hello, <span class="hljs-subst">{name}</span>"</span>  <span class="hljs-comment"># 应该返回 int，但返回了 str</span>
</code></pre>
<p><strong>代表工具</strong>：mypy, pyright, ty, pyre</p>
<h4 data-id="heading-5">1.3 Linting (代码检查)</h4>
<p><strong>问题</strong>：这段代码的写法符合最佳实践吗？</p>
<p>Linter 关注代码质量、潜在bug、代码风格等问题。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Linter 会发现的问题</span>

<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> json  <span class="hljs-comment"># ❌ 未使用的导入</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate</span>(<span class="hljs-params">x, y</span>):
    result = x + y
    <span class="hljs-keyword">return</span> result

<span class="hljs-comment"># ❌ 变量名太短，不具描述性</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">calc</span>(<span class="hljs-params">a, b</span>):
    <span class="hljs-keyword">return</span> a / b  <span class="hljs-comment"># ❌ 没有处理除零风险</span>

<span class="hljs-comment"># ❌ 函数名应该用 snake_case</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">DoSomething</span>():
    <span class="hljs-keyword">pass</span>
</code></pre>
<p><strong>代表工具</strong>：ruff, pylint, flake8, ESLint (JavaScript)</p>
<h4 data-id="heading-6">1.4 格式化 (Formatting)</h4>
<p><strong>问题</strong>：这段代码的样式统一吗？</p>
<p>格式化器只调整代码的视觉呈现，不改变代码逻辑。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 格式化前（混乱）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate</span>(<span class="hljs-params">x,y</span>):
    result=x+y
    <span class="hljs-keyword">return</span> result
<span class="hljs-keyword">if</span> <span class="hljs-literal">True</span>:
<span class="hljs-built_in">print</span>(<span class="hljs-string">"hello"</span>)

<span class="hljs-comment"># 格式化后（统一）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate</span>(<span class="hljs-params">x, y</span>):
    result = x + y
    <span class="hljs-keyword">return</span> result

<span class="hljs-keyword">if</span> <span class="hljs-literal">True</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"hello"</span>)
</code></pre>
<p>格式化器处理的元素：</p>
<ul>
<li>缩进（空格 vs tab）</li>
<li>空格数量</li>
<li>换行位置</li>
<li>引号风格（单引号 vs 双引号）</li>
</ul>
<p><strong>代表工具</strong>：ruff, black, prettier (JavaScript), biome (JavaScript)</p>
<h4 data-id="heading-7">1.5 LSP (Language Server Protocol)</h4>
<p><strong>问题</strong>：编辑器如何和这些工具通信？</p>
<p>LSP 是微软推出的开放协议，用于标准化编辑器与语言服务之间的通信。</p>
<pre><code class="hljs language-arduino" lang="arduino">┌─────────────────────────────────────────────────────────────┐
│                      LSP 架构                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│    ┌─────────┐      LSP 协议      ┌─────────────────────┐  │
│    │ 编辑器   │ ←──────────────→  │  Language <span class="hljs-built_in">Server</span>    │  │
│    │ VSCode  │   JSON-RPC <span class="hljs-number">2.0</span>    │                     │  │
│    │ Neovim  │                    │  ┌─────────────────┤│  │
│    │ Emacs   │                    │  │ Type Checker   ││  │
│    └─────────┘                    │  └─────────────────┤│  │
│                                    │  ┌─────────────────┤│  │
│                                    │  │ Linter         ││  │
│                                    │  └─────────────────┤│  │
│                                    │  ┌─────────────────┤│  │
│                                    │  │ Formatter      ││  │
│                                    │  └─────────────────┘│  │
│                                    └─────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>LSP 提供的功能</strong>：</p>
<ul>
<li>代码补全</li>
<li>跳转到定义</li>
<li>悬停提示</li>
<li>诊断信息（错误/警告）</li>
<li>代码动作</li>
<li>重命名</li>
</ul>
<h4 data-id="heading-8">1.6 对比示例</h4>
<p>看这段代码，不同工具会关注什么：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a:<span class="hljs-built_in">int</span>,b:<span class="hljs-built_in">int</span></span>)-&gt;<span class="hljs-built_in">int</span>:
    <span class="hljs-keyword">return</span> a+b
<span class="hljs-built_in">print</span>(add(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>))
</code></pre>

























<table><thead><tr><th>工具类型</th><th>会说什么</th></tr></thead><tbody><tr><td><strong>类型检查器</strong></td><td>类型正确 ✓</td></tr><tr><td><strong>Linter</strong></td><td><code>import os</code> 未使用，建议删除；参数间应该有空格</td></tr><tr><td><strong>格式化器</strong></td><td>应该改成 <code>a: int, b: int</code>（加空格）</td></tr><tr><td><strong>LSP</strong></td><td>把所有这些信息传给编辑器显示</td></tr></tbody></table>
<h4 data-id="heading-9">1.7 概念总结表</h4>



































<table><thead><tr><th>概念</th><th>关注点</th><th>改变代码逻辑？</th><th>核心问题</th></tr></thead><tbody><tr><td><strong>类型检查</strong></td><td>类型正确性</td><td>❌</td><td>"这段代码能运行吗？"</td></tr><tr><td><strong>Linting</strong></td><td>代码质量</td><td>❌（多数）</td><td>"这段代码写得好吗？"</td></tr><tr><td><strong>格式化</strong></td><td>代码样式</td><td>❌</td><td>"这段代码好看吗？"</td></tr><tr><td><strong>LSP</strong></td><td>通信协议</td><td>-</td><td>"编辑器怎么调用这些工具？"</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-10">二、主流工具深度解析</h3>
<h4 data-id="heading-11">2.1 工具定位总览</h4>















































<table><thead><tr><th>工具</th><th>主要定位</th><th>编程语言</th><th>LSP 支持</th><th>成熟度</th></tr></thead><tbody><tr><td><strong>pyright</strong></td><td>静态类型检查器</td><td>TypeScript</td><td>通过 Pylance</td><td>成熟</td></tr><tr><td><strong>basedpyright</strong></td><td>pyright 的增强 fork</td><td>TypeScript</td><td>内置</td><td>较成熟</td></tr><tr><td><strong>ruff</strong></td><td>Linter + 代码格式化</td><td>Rust</td><td>✅ 原生</td><td>成熟</td></tr><tr><td><strong>ty</strong></td><td>静态类型检查器 + LSP</td><td>Rust</td><td>✅ 内置</td><td>早期开发</td></tr><tr><td><strong>python-lsp-server</strong></td><td>语言服务器协议实现</td><td>Python</td><td>✅</td><td>成熟</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-12">2.2 microsoft/pyright</h4>
<p><strong>定位</strong>：静态类型检查器</p>
<p><strong>语言</strong>：TypeScript 编写</p>
<p><strong>核心特点</strong>：</p>
<ul>
<li>微软官方出品，性能优异（比 mypy 快 5 倍以上）</li>
<li>标准兼容，适用于大型 Python 代码库</li>
<li>严谨的类型推断和类型窄化能力</li>
<li>VSCode 中通过 Pylance 提供 LSP 功能</li>
</ul>
<p><strong>适用场景</strong>：</p>
<ul>
<li>使用 VSCode 进行开发</li>
<li>需要稳定可靠的类型检查</li>
<li>大型项目代码库</li>
</ul>
<hr/>
<h4 data-id="heading-13">2.3 DetachHead/basedpyright</h4>
<p><strong>定位</strong>：pyright 的增强分支</p>
<p><strong>核心特点</strong>：</p>
<ul>
<li>在 pyright 基础上增加了多种类型检查改进</li>
<li><strong>集成了 Pylance 的专有特性</strong>（开源实现）</li>
<li>支持 <strong>inlay hints</strong>（内联提示）和 <strong>semantic tokens</strong></li>
<li>默认使用更严格的检查模式（"all" 模式）</li>
<li>改进了 VSCode 集成支持</li>
</ul>
<p><strong>与 pyright 的关键区别</strong>：</p>



































<table><thead><tr><th>特性</th><th>pyright</th><th>basedpyright</th></tr></thead><tbody><tr><td>Inlay Hints</td><td>❌</td><td>✅</td></tr><tr><td>Semantic Tokens</td><td>❌</td><td>✅</td></tr><tr><td>默认检查模式</td><td>standard</td><td>all（更严格）</td></tr><tr><td>开源程度</td><td>完全开源</td><td>完全开源</td></tr><tr><td>编辑器支持</td><td>VSCode 优先</td><td>多编辑器友好</td></tr></tbody></table>
<p><strong>适用场景</strong>：</p>
<ul>
<li>使用 Neovim、Emacs 等非 VSCode 编辑器</li>
<li>需要更严格的类型检查</li>
<li>需要 Pylance 功能但不想被 VSCode 绑定</li>
</ul>
<hr/>
<h4 data-id="heading-14">2.4 astral-sh/ruff</h4>
<p><strong>定位</strong>：<strong>Linter + 代码格式化工具</strong>（不是类型检查器！）</p>
<p><strong>语言</strong>：Rust 编写</p>
<p><strong>核心特点</strong>：</p>
<ul>
<li><strong>极快的速度</strong>（比传统工具快数十倍）</li>
<li>一个工具替代多个：Flake8, isort, black, pydocstyle, pyupgrade 等</li>
<li>不仅能检测问题，还能进行代码转换</li>
<li>内置原生 LSP 服务器（<code>ruff server</code>）</li>
</ul>
<p><strong>LSP 支持演变</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────┐
│  ruff-lsp (旧版，已弃用)                                 │
│  └── Python 实现的独立 LSP 服务器                        │
│                                                         │
│  ruff server (新版，当前)                                │
│  └── Rust 实现的原生 LSP 服务器，内置在 ruff 中          │
│      命令: ruff server                                  │
└─────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>重要说明</strong>：ruff <strong>不进行类型检查</strong>，但可检测部分类型相关问题。</p>
<p><strong>适用场景</strong>：</p>
<ul>
<li>需要快速的 Lint 和格式化</li>
<li>想统一工具链，减少依赖</li>
<li>任何规模的 Python 项目</li>
</ul>
<hr/>
<h4 data-id="heading-15">2.5 astral-sh/ty</h4>
<p><strong>定位</strong>：静态类型检查器 + LSP</p>
<p><strong>语言</strong>：Rust 编写</p>
<p><strong>状态</strong>：<strong>早期开发阶段（pre-release），不建议用于生产环境</strong></p>
<p><strong>核心特点</strong>：</p>
<ul>
<li><strong>性能极其强悍</strong>：比 mypy/pyright 快 10-60 倍</li>
<li>同时提供类型检查和语言服务器功能</li>
<li>激进的类型推断策略</li>
<li>与 ruff 共享相同的 AST 和 parser</li>
</ul>
<p><strong>历史渊源</strong>：</p>
<p>ty 最初叫 <strong>Red Knot</strong>，是作为 ruff 项目的一部分在开发的，后来独立成单独的工具。</p>
<p><strong>适用场景</strong>：</p>
<ul>
<li>目前仅适合实验性项目</li>
<li>想体验前沿技术的开发者</li>
</ul>
<hr/>
<h4 data-id="heading-16">2.6 python-lsp/python-lsp-server</h4>
<p><strong>定位</strong>：语言服务器协议实现</p>
<p><strong>语言</strong>：Python 编写</p>
<p><strong>核心特点</strong>：</p>
<ul>
<li>提供完整的 LSP 功能（自动补全、悬停提示、跳转定义等）</li>
<li>轻量级、易扩展</li>
<li>可配置多种后端（如 Jedi、rope）</li>
<li><strong>不是类型检查器</strong>，专注于编辑器集成</li>
</ul>
<p><strong>适用场景</strong>：</p>
<ul>
<li>需要纯 Python 实现的 LSP</li>
<li>与其他 Python 工具链集成</li>
<li>轻量级编辑器配置</li>
</ul>
<hr/>
<h3 data-id="heading-17">三、Astral 家族解析</h3>
<p>你可能注意到 ruff、ty、uv 都来自同一个组织 —— <strong>Astral</strong>。这并非重复，而是精心规划的完整工具链。</p>
<h4 data-id="heading-18">3.1 Astral 产品矩阵</h4>
<pre><code class="hljs language-markdown" lang="markdown">┌─────────────────────────────────────────────────────────────┐
│                        Astral 家族                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   uv  ───→  包管理工具                                       │
│            （替代 pip、poetry、pipenv 等）                    │
│                                                             │
│   ruff ───→  Linter + Formatter + LSP                       │
│            （替代 flake8、black、isort 等）                   │
│                                                             │
│   ty   ───→  Type Checker + LSP                             │
│            （替代 mypy、pyright，开发中）                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
<span class="hljs-code">                    │
                    ▼
         共享相同的 AST 和 Parser
         （Rust 实现，极致性能）
</span></code></pre>
<h4 data-id="heading-19">3.2 ruff 和 ty 的关系</h4>






























<table><thead><tr><th>维度</th><th>ruff</th><th>ty</th></tr></thead><tbody><tr><td><strong>主要功能</strong></td><td>Linting + 格式化</td><td>类型检查</td></tr><tr><td><strong>检查内容</strong></td><td>代码风格、潜在bug、最佳实践</td><td>类型正确性</td></tr><tr><td><strong>LSP 侧重点</strong></td><td>代码动作、快速修复、格式化</td><td>类型信息、诊断</td></tr><tr><td><strong>类比</strong></td><td>像 ESLint</td><td>像 TypeScript</td></tr></tbody></table>
<p><strong>它们不重复的原因</strong>：</p>
<p>虽然都有 LSP，但提供的<strong>服务内容不同</strong>：</p>
<ul>
<li><strong>ruff 的 LSP</strong>：提供代码质量相关的功能（诊断、格式化、修复）</li>
<li><strong>ty 的 LSP</strong>：提供类型系统相关的功能（类型推断、类型诊断、类型提示）</li>
</ul>
<p>这就像 VSCode 里同时有 ESLint（Linter）和 TypeScript（Type Checker）一样，两者互补而不是重复。</p>
<hr/>
<h3 data-id="heading-20">四、选择指南</h3>
<h4 data-id="heading-21">4.1 类型检查器选择</h4>
<pre><code class="hljs">┌─────────────────────────────────────────────────────────────┐
│                    类型检查器选择                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  使用 VSCode？                                              │
│       │                                                     │
│       ├─ 是 → pyright + Pylance                            │
│       │        （微软官方集成，体验最佳）                     │
│       │                                                     │
│       └─ 否 → basedpyright                                 │
│                （开源完整，多编辑器友好）                     │
│                                                             │
│  想尝试前沿技术？                                           │
│       └─ ty （实验性项目，注意稳定性）                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-22">4.2 Linter/格式化工具选择</h4>
<pre><code class="hljs language-lua" lang="lua">┌─────────────────────────────────────────────────────────────┐
│                 Linter/格式化工具选择                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  需要什么？                                                 │
│                                                             │
│  Linting + 格式化 + 极致性能                                 │
│       └─ ruff （推荐）                                     │
│                                                             │
│  仅格式化                                                   │
│       └─ black / ruff <span class="hljs-built_in">format</span>                              │
│                                                             │
│  传统工具链                                                 │
│       └─ flake8 + black + isort                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-23">4.3 典型项目配置</h4>
<h5 data-id="heading-24">Python 项目推荐配置</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># .config/python-tools.yaml</span>
<span class="hljs-string">工具链配置:</span>
  <span class="hljs-string">类型检查:</span> <span class="hljs-string">pyright</span> <span class="hljs-string">/</span> <span class="hljs-string">basedpyright</span>
  <span class="hljs-attr">Linting:</span>  <span class="hljs-string">ruff</span>
  <span class="hljs-string">格式化:</span>   <span class="hljs-string">ruff</span> <span class="hljs-string">format</span>
  <span class="hljs-attr">LSP:</span>      <span class="hljs-string">ruff</span> <span class="hljs-string">server</span> <span class="hljs-string">+</span> <span class="hljs-string">pyright/basedpyright</span>
</code></pre>
<h5 data-id="heading-25">Neovim 配置示例</h5>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- 如果你使用 Neovim</span>
{
  <span class="hljs-comment">-- 基于 basedpyright 的类型检查</span>
  <span class="hljs-string">"neovim/nvim-lspconfig"</span>,
  opts = {
    servers = {
      basedpyright = {},
      ruff = {
        <span class="hljs-comment">-- ruff LSP 提供快速 lint 和格式化</span>
      }
    }
  }
}
</code></pre>
<h5 data-id="heading-26">VSCode 配置示例</h5>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// .vscode/settings.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"python.defaultInterpreterPath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./.venv/bin/python"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"[python]"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"editor.formatOnSave"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"editor.defaultFormatter"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"charliemarsh.ruff"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"editor.codeActionsOnSave"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"source.fixAll.ruff"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"explicit"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"source.organizeImports.ruff"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"explicit"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"ruff.lint.enable"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"python.analysis.typeCheckingMode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"strict"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h3 data-id="heading-27">五、性能对比</h3>
<p>根据公开的基准测试数据：</p>
<h4 data-id="heading-28">5.1 Linter 性能</h4>

























<table><thead><tr><th>工具</th><th>相对性能</th><th>说明</th></tr></thead><tbody><tr><td>ruff</td><td><strong>100x</strong></td><td>相比 flake8 等传统工具</td></tr><tr><td>flake8</td><td>1x</td><td>基准</td></tr><tr><td>pylint</td><td>~0.5x</td><td>更慢</td></tr></tbody></table>
<h4 data-id="heading-29">5.2 类型检查器性能</h4>

























<table><thead><tr><th>工具</th><th>相对性能</th><th>说明</th></tr></thead><tbody><tr><td>ty</td><td><strong>10-60x</strong></td><td>早期基准，仍在优化</td></tr><tr><td>pyright</td><td><strong>5x</strong></td><td>相比 mypy</td></tr><tr><td>mypy</td><td>1x</td><td>基准</td></tr></tbody></table>
<p><em>注：实际性能因项目规模和复杂度而异</em></p>
<hr/>
<h3 data-id="heading-30">六、总结</h3>
<h4 data-id="heading-31">6.1 关键要点</h4>
<ol>
<li><strong>理解概念差异</strong>：类型检查、Linting、格式化、LSP 各司其职</li>
<li><strong>工具不重复</strong>：即使都支持 LSP，提供的功能也不同</li>
<li><strong>Astral 的愿景</strong>：打造完整的高性能 Python 工具链</li>
<li><strong>选择基于需求</strong>：考虑编辑器、团队、项目规模</li>
</ol>
<h4 data-id="heading-32">6.2 推荐组合</h4>



































<table><thead><tr><th>开发环境</th><th>类型检查</th><th>Linter/格式化</th><th>LSP</th></tr></thead><tbody><tr><td>VSCode</td><td>pyright</td><td>ruff</td><td>Pylance + ruff</td></tr><tr><td>Neovim</td><td>basedpyright</td><td>ruff</td><td>basedpyright + ruff server</td></tr><tr><td>Emacs</td><td>basedpyright</td><td>ruff</td><td>basedpyright + ruff server</td></tr><tr><td>其他</td><td>basedpyright</td><td>ruff</td><td>python-lsp-server + ruff</td></tr></tbody></table>
<h4 data-id="heading-33">6.3 展望未来</h4>
<p>Python 工具生态正在快速演进：</p>
<ul>
<li><strong>ty</strong> 有望成为主流的类型检查器</li>
<li><strong>ruff</strong> 可能整合更多功能</li>
<li><strong>uv</strong> 已经成为包管理的有力竞争者</li>
</ul>
<p>保持关注，但谨慎采用新工具 —— 尤其是生产环境。</p>
<hr/>
<h3 data-id="heading-34">参考资料</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FDetachHead%2Fbasedpyright" target="_blank" title="https://github.com/DetachHead/basedpyright" ref="nofollow noopener noreferrer">basedpyright GitHub</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.basedpyright.com%2F" target="_blank" title="https://docs.basedpyright.com/" ref="nofollow noopener noreferrer">basedpyright 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fastral-sh%2Fruff" target="_blank" title="https://github.com/astral-sh/ruff" ref="nofollow noopener noreferrer">Ruff GitHub</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.astral.sh%2Fruff%2F" target="_blank" title="https://docs.astral.sh/ruff/" ref="nofollow noopener noreferrer">Ruff 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fastral-sh%2Fty" target="_blank" title="https://github.com/astral-sh/ty" ref="nofollow noopener noreferrer">ty GitHub</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fastral.sh%2Fblog%2Fty" target="_blank" title="https://astral.sh/blog/ty" ref="nofollow noopener noreferrer">ty 官方博客</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2Fpyright" target="_blank" title="https://github.com/microsoft/pyright" ref="nofollow noopener noreferrer">pyright GitHub</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpython-lsp%2Fpython-lsp-server" target="_blank" title="https://github.com/python-lsp/python-lsp-server" ref="nofollow noopener noreferrer">Python LSP Server</a></li>
</ul>
<hr/>
<p><em>本文发布于 2025 年 12 月，工具发展迅速，建议关注官方动态获取最新信息。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C++多态]]></title>    <link>https://juejin.cn/post/7588093282530705460</link>    <guid>https://juejin.cn/post/7588093282530705460</guid>    <pubDate>2025-12-27T17:24:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588093282530705460" data-draft-id="7588098335790596096" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C++多态"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-27T17:24:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="橘子13"/> <meta itemprop="url" content="https://juejin.cn/user/4162084884974491"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C++多态
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4162084884974491/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    橘子13
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T17:24:22.000Z" title="Sat Dec 27 2025 17:24:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">多态的概念</h2>
<p>通俗来说，就是多种形态，就是去完成某个行为，当不同的对象去完成时会产生出不同的状态。</p>
<h2 data-id="heading-1">多态的使用</h2>
<p>要触发 C++ 的<strong>多态调用（运行时动态绑定）</strong>，需同时满足以下 3 个核心条件：</p>
<p><strong>条件1</strong>：<strong>父类声明虚函数</strong>：在父类中，将需要实现多态的成员函数前添加virtual关键字（<strong>析构函数？后文详说</strong>），该函数成为虚函数。</p>
<p><strong>条件2</strong>：<strong>子类完成虚函数的合法重写</strong>（Override）：1.父子类中两个虚函数，三同（函数名，参数，返回）（理解成隐藏的一个子集）2.例外，<strong>协变返回类型，后文详说</strong>。
总结为“<strong>基本三同+协变返回</strong>”。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9376a52eeab5437681968798a20c54bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmY5a2QMTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767461062&amp;x-signature=JeVt7prsSZRTGjmGiwI797AHRr0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>条件3</strong>：<strong>父类的指针或引用去调用虚函数</strong>。
<strong>反例</strong>：若用<strong>子类</strong>指针 / 引用指向<strong>子类对象</strong>（静态类型 = 动态类型），或用父类对象（<strong>非指针 / 非引用</strong>）调用虚函数，均会触发编译期静态绑定（<strong>普通调用</strong>），无法实现多态。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span>
{</span>
public:
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">BuyTicket</span><span class="hljs-params">()</span> { <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"买票-全价"</span> &lt;&lt; <span class="hljs-built_in">endl</span>; }
};

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Student</span> :</span> public Person
{
public:
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">BuyTicket</span><span class="hljs-params">()</span> { <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"买票-半价"</span> &lt;&lt; <span class="hljs-built_in">endl</span>; }
};

<span class="hljs-type">void</span> <span class="hljs-title function_">Func</span><span class="hljs-params">(Person&amp; p)</span>
{
	p.BuyTicket();
}
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>
{
	Person ps;
	Student st;

	Func(ps);
	Func(st);
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b773b26669fd4907a63e9628dd3c40e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmY5a2QMTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767461062&amp;x-signature=wkopeuANBD1FRNpO0VWlqHUWLwI%3D" alt="在这里插入图片描述" loading="lazy"/>
注意：基类加virtual，派生类自动继承虚函数属性，不用显式写virtual。</p>
<h3 data-id="heading-2"><strong>关于普通调用与多态调用</strong></h3>
<p><strong>普通调用（编译时静态绑定）</strong>：普通调用是指编译器在<strong>编译阶段</strong>，<strong>就根据“调用者的类型”（而非实际对象类型）确定要调用的函数地址</strong>，直接将函数调用指令写入编译后的代码中，运行时无需额外判断。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3699748d6c7c4518b50adb0ba54e4829~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmY5a2QMTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767461062&amp;x-signature=YIP8NSMkMKwAdGGCmqyzDsQ7rpY%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>普通调用的核心是“看类型，不看实际对象”</strong>。</p>
<p>普通调用触发条件:
调用非虚函数时（无论通过对象、指针还是引用调用）；
调用虚函数，但通过对象直接调用（非指针 / 引用）时（此时也会退化为普通调用）。</p>
<p><strong>多态调用（运行时动态绑定）</strong>：多态调用是指编译器在编译阶段无法确定函数调用目标，<strong>需在运行阶段，根据 “指针 /引用实际指向的对象类型”</strong>，动态找到对应的函数地址并调用。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6cf0696b6c4140f6a19a4af797af0b91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmY5a2QMTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767461062&amp;x-signature=vGnRvsGsl1B08B93I9l817prB7M%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>多态调用的核心是“看实际对象的类型”</strong>。</p>
<p>满足多态调用的三个必备条件（三者缺一不可）：
1.<strong>基类中声明虚函数</strong>
2.<strong>派生类重写虚函数</strong>
3.<strong>通过基类指针 / 引用调用</strong></p>
<p><strong>总结：普通调用看指针 / 引用类型，多态调用看指向内容（实际对象）的类型。</strong></p>























<table><thead><tr><th>绑定方式</th><th>调用类型</th><th>绑定时机</th><th>核心特征</th></tr></thead><tbody><tr><td>静态绑定</td><td>普通调用</td><td>编译期</td><td>编译时就确定调用哪个函数</td></tr><tr><td>动态绑定</td><td>多态调用</td><td>运行期</td><td>运行时才确定调用哪个函数</td></tr></tbody></table>
<p><strong>补充</strong>：静态多态与动态多态
<strong>动态多态：运行期绑定的多态</strong>，就是上面所说的多态
<strong>静态多态：编译期绑定的多态</strong>，也叫 “编译期多态”—— 编译器在编译阶段就确定要调用的函数。常见例子：函数重载，模版</p>
<h3 data-id="heading-3">虚函数重写的两个例外</h3>
<h4 data-id="heading-4">协变返回值</h4>
<p>1.<strong>协变返回值</strong>，父类与子类的虚函数的返回值可以不同（要求虚函数的返回值必须是父子类关系的指针或引用）</p>
<pre><code class="hljs language-c" lang="c">先写一个父子类AB
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span>
{</span>};
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B</span> :</span> public A 
{};

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Member</span> 
{</span>
public:
    virtual A* <span class="hljs-title function_">f</span><span class="hljs-params">()</span> <span class="hljs-comment">//虚函数的返回值必须是一个父子类的指针或引用</span>
    {
        <span class="hljs-keyword">return</span> new A;
    }
};
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Student</span> :</span> public Member 
{
public:
    virtual B* <span class="hljs-title function_">f</span><span class="hljs-params">()</span> <span class="hljs-comment">//虚函数的返回值必须是一个父子类的指针或引用</span>
    {
        <span class="hljs-keyword">return</span> new B;
    }
};
</code></pre>
<p><strong>总结</strong>：</p>
<ul>
<li>返回值必须是指针或引用（不能是值类型，比如A f()和B f()不构成协变）；</li>
<li><strong>派生类返回</strong>的指针 / 引用类型，必须是<strong>基类返回</strong>类型的直接 / 间接派生类（这里B继承A，满足条件）。</li>
</ul>
<h4 data-id="heading-5">析构函数的重写</h4>
<p><strong>析构函数的名字特殊处理，构成隐藏，建议函数名前加virtual。</strong></p>
<p><strong>这句话是关键</strong>：<strong>基类指针指向派生类对象</strong>时，<strong>非虚析构</strong>会触发<strong>普通调用</strong>，<strong>虚析构</strong>会触发<strong>多态调用</strong>
​​</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Member</span> {</span>
public:
	~Member() 
	{ 
		<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"~Member()"</span> &lt;&lt; <span class="hljs-built_in">endl</span>; 
	}
};
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Student</span> :</span> public Member {
public:
	~Student() 
	{ 
		<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"~Student()"</span> &lt;&lt; <span class="hljs-built_in">endl</span>; 
	}
};
<span class="hljs-comment">//此时析构函数构成隐藏</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>
{
	Member* p1 = new Member;
	Member* p2 = new Student;

	delete p1;
	delete p2;
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>结果为：
​​​​<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a2168532a424b48b7c9920df2507fc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmY5a2QMTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767461062&amp;x-signature=wNtfzrYzpwkDoTUontviFDuM49A%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>​
<strong>​​​​现象</strong>：观察发现在第二个指针析构时只析构了父类，而没有析构子类，可能会导致内存泄漏。</p>
<p><strong>根本原因</strong>：是普通调用，只看指针\引用类型，而不看指向内容的类型。</p>
<p>分析：</p>
<ol>
<li>两个析构函数构成了隐藏（<strong>析构函数虽然名称格式特殊（~类名()），但编译器会将其视为 “同名函数”，因此Student::~Student()会隐藏Member::~Member()。</strong>），实际上也满足了重写条件（由于析构函数的特殊规则，导致不能叫重写，加上virtual后变成虚函数后，自动满足重写）——这样<strong>达成2个条件</strong> 1.父类声明虚函数 2.子类虚函数重写。</li>
</ol>
<blockquote>
<p><strong>析构函数的特殊规则</strong>：析构函数是否构成 “重写” 或 “隐藏”，完全取决于基类析构函数是否被声明为virtual—— <strong>基类析构</strong>是<strong>虚函数</strong>时，<strong>派生类析构</strong>构成 “<strong>重写</strong>”；<strong>基类析构非虚</strong>时，<strong>派生类析构</strong>构成 “<strong>隐藏</strong>”。</p>
</blockquote>
<ol start="2">
<li><strong>基类指针指向派生类对象</strong>时（<strong>达成最后一个条件：3.父类的指针调用虚函数</strong>），<strong>非虚析构</strong>会触发<strong>普通调用</strong>，<strong>虚析构</strong>会触发<strong>多态调用</strong>(“虚”满足父类声明虚函数，“析构”满足子类虚函数重写）</li>
</ol>
<p><strong>总结以上</strong>：也就是说只要加上virtual就可以达成多态调用的3个条件，从而进行多态调用根据指向内容的类型，进行多态析构。</p>
<p><strong>解决方式</strong>：<strong>析构函数特殊处理，在函数名前面加上virtual，变成虚函数</strong>，<strong>从而满足3个多态调用的条件</strong>，从而变成<strong>多态调用</strong>，指向内容是父类类型调父类析构，指向内容是子类类型调子类析构，这个时候p1 delete时就调用Member的析构函数，p2 delete 时就调用Student的析构函数（子类析构完时自动调用父类析构函数）。</p>
<blockquote>
<p><strong>回顾：delete的底层</strong>
分为<code>p-&gt;destructor() + operator delete(p)</code>这两步
<strong>第一步</strong>：析构函数调用<code>p-&gt;~类名()</code>
只有当p指向的是类类型对象（包括自定义类、标准库类等）时，这一步才会执行；若p指向内置类型（int、char等），则无此步骤，直接进入内存释放阶段。
<strong>第二步</strong>：内存释放<code>operator delete(p)</code>
将p指向的内存块归还给堆分配器。 标准库默认的operator delete函数，其底层通常调用 C 语言的free()函数。</p>
</blockquote>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Member</span> {</span>
public:
	virtual ~Member() 
	{ 
		<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"~Member()"</span> &lt;&lt; <span class="hljs-built_in">endl</span>; 
	}
};
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Student</span> :</span> public Member {
public:
	~Student()  <span class="hljs-comment">// 自动成为虚析构（无需显式写virtual）</span>
	{ 
		<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"~Student()"</span> &lt;&lt; <span class="hljs-built_in">endl</span>; 
	}
};
<span class="hljs-comment">// 只有派生类Student的析构函数重写了Person的析构函数，下面的delete对象调用析构函</span>
<span class="hljs-comment">//数，才能构成多态，才能保证p1和p2指向的对象正确的调用析构函数。</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>
{
	Member* p1 = new Member;
	Member* p2 = new Student;

	delete p1;
	delete p2;
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>结果如下：​​
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c64343fe670146278684dcc3c3d08b78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmY5a2QMTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767461062&amp;x-signature=JoZdjjFtSdt%2BvPlWT8a7D9gJiTI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-6">一道难题</h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span>
{</span>
public:
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">func</span><span class="hljs-params">(<span class="hljs-type">int</span> val = <span class="hljs-number">1</span>)</span>
	{
		<span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"A-&gt;"</span> &lt;&lt; val &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
	}
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> { func(); }
};

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B</span> :</span> public A
{
public:
	<span class="hljs-type">void</span> <span class="hljs-title function_">func</span><span class="hljs-params">(<span class="hljs-type">int</span> val = <span class="hljs-number">0</span>)</span>
	{
		<span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"B-&gt;"</span> &lt;&lt; val &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
	}
};

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>
{
	B* p = new B;
	p-&gt;test();
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>​<strong>类 A 的定义</strong>：
<code>virtual void func(int val = 1)</code>：虚函数func，默认参数为 1，输出A-&gt;val。
<code>virtual void test() { func(); }</code>：虚函数test，内部调用func()。
<strong>类 B 的定义</strong>：
<code>void func(int val = 0)</code>：重写基类A的虚函数func，默认参数改为 0，输出B-&gt;val。
<strong>注意</strong>：<strong>B没有重写test函数</strong>，因此test仍使用基类A的实现。
<strong>main 函数执行流程</strong>：
<code>B* p = new B;</code>：创建B类型对象，指针p的静态类型是B*，实际类型也是B。
<code>p-&gt;test();</code>：调用test函数：
<strong>第一步</strong>：test函数未被B重写，因此执行基类A的test函数。
<strong>第二步</strong>：A的test中调用func()，由于func是虚函数，动态绑定到实际对象类型（B）的func，因此执行B::func。
<strong>第三步</strong>：func的默认参数遵循静态绑定（由调用点的静态类型决定）：test属于A类，因此默认参数使用A::func的1，而非B::func的0。
<strong>最终输出</strong>：B-&gt;1。</p>
<h3 data-id="heading-7">C++11 override和final</h3>
<p><strong>final：修饰虚函数，表示该虚函数不能再被重写</strong></p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span>
{</span>
public:
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">func</span><span class="hljs-params">()</span> final
	{
		<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"A"</span> &lt;&lt; <span class="hljs-built_in">endl</span>;
	}
};

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B</span> :</span> public A
{
public:
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">func</span><span class="hljs-params">()</span><span class="hljs-comment">//出错，不允许重写</span>
	{
		<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"B"</span> &lt;&lt; <span class="hljs-built_in">endl</span>;
	}
};
</code></pre>
<p>例子：实现一个类，让这个类不能被继承</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">//法一：将构造函数私有化</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span>
{</span>
public:
	<span class="hljs-type">int</span> _a;
private:<span class="hljs-comment">//将构造函数私有，派生类的构造，必须调用基类的构造，这里继承过去不可见，无法调用</span>
	A(){}
};

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B</span> :</span>public A
{
};

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>
{
	B bb;
}
</code></pre>
<p><strong>final：修饰类，这个类不能被继承</strong></p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">//法二：类后加final成为最终类</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span> <span class="hljs-keyword">final</span>//加<span class="hljs-keyword">final</span>关键字，<span class="hljs-keyword">final</span>修饰的类为最终类，不能被继承
{</span>
public:
	<span class="hljs-type">int</span> _a;
};
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B</span> :</span> public A<span class="hljs-comment">//出错</span>
{

};
</code></pre>
<p>override：检查派生类虚函数是否重写了基类的某个虚函数，如果没有重写编译报错</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span>
{</span>
public:
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">func</span><span class="hljs-params">()</span>
	{
		<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"A"</span> &lt;&lt; <span class="hljs-built_in">endl</span>;
	}
};

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B</span> :</span> public A
{
public:
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">func</span><span class="hljs-params">()</span> override<span class="hljs-comment">//加在派生类的某个虚函数</span>
	{
		<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"B"</span> &lt;&lt; <span class="hljs-built_in">endl</span>;
	}
};
</code></pre>
<h2 data-id="heading-8">抽象类</h2>
<p>概念
在<strong>虚函数后面写上 = 0</strong>，则这个函数为<strong>纯虚函数</strong>。
包含纯虚函数的类叫做<strong>抽象类</strong>（也叫做<strong>接口类</strong>），<strong>抽象类不能实例化出对象</strong>。派生类继承后也不能实例化出对象，只有重写纯虚函数，派生类才能实例化出对象。
例子：抽象类不能实例化</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Car</span>//抽象类
{</span>
public:
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">Drive</span><span class="hljs-params">()</span> = <span class="hljs-number">0</span>;<span class="hljs-comment">//纯虚函数</span>
};

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>
{
	Car c;<span class="hljs-comment">//出错</span>
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>例子：抽象类的一种使用方式</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Car</span>//抽象类
{</span>
public:
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">Drive</span><span class="hljs-params">()</span> = <span class="hljs-number">0</span>;<span class="hljs-comment">//纯虚函数</span>
};
<span class="hljs-comment">//间接强制了子类重写虚函数，因为不重写的话，子类依旧是抽象类，不能实例化出对象</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Benz</span> :</span>public Car
{
public:
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">Drive</span><span class="hljs-params">()</span>
	{
		<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Benz-舒适"</span> &lt;&lt; <span class="hljs-built_in">endl</span>;
	}
};
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BMW</span> :</span>public Car
{
public:
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">Drive</span><span class="hljs-params">()</span>
	{
		<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"BMW-操控"</span> &lt;&lt; <span class="hljs-built_in">endl</span>;
	}
};
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>
{
	<span class="hljs-comment">//Car* a = new Benz;普通调用</span>
	<span class="hljs-comment">//a-&gt;Drive();</span>
	<span class="hljs-comment">//Car* b = new BMW;普通调用</span>
	<span class="hljs-comment">//b-&gt;Drive();</span>
	Car* a = new Benz;<span class="hljs-comment">//多态调用</span>
	a-&gt;Drive();
	Car* b = new BMW;<span class="hljs-comment">//多态调用</span>
	b-&gt;Drive();
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>结果：普通调用与多态调用的结果一样（注）
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/817eac374e1c4cb887095dfdb92b5926~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmY5a2QMTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767461062&amp;x-signature=4Pw5iI8BUf5dL04%2F760uz1Ka%2FPM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-9">关于接口继承和实现继承</h3>
<p><strong>普通函数的继承是一种实现继承</strong>：派生类继承了基类函数，可以使用函数，继承的是函数的实现。
<strong>虚函数的继承是一种接口继承</strong>：派生类继承的是基类函数的接口，目的是重写，达成多态，继承的是接口。</p>
<h2 data-id="heading-10">多态的原理</h2>
<blockquote>
<p><strong>回顾结构体内存对齐规则</strong>
<strong>规则 1：成员的偏移量规则</strong> 结构体中每个成员的「<strong>偏移量</strong>」（相对于结构体起始地址的字节数），必须是该成员「<strong>自身大小</strong>」的整数倍。如果不够，编译器会在该成员前填充「空字节」。
<strong>规则 2：整体大小规则</strong> 结构体的总大小，必须是结构体「<strong>最大对齐数</strong>」的整数倍。
<strong>「最大对齐数」= 结构体中所有成员的自身大小的最大值（比如包含char和int，最大对齐数 = 4）</strong>；
<strong>规则 3：嵌套结构体规则</strong> 如果结构体嵌套了另一个结构体，嵌套的结构体的偏移量，必须是「嵌套结构体的最大对齐数」的整数倍；最终整体大小仍遵循规则 2。</p>
</blockquote>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Base</span>
{</span>
public:
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">Func1</span><span class="hljs-params">()</span>
	{
		<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Func1()"</span> &lt;&lt; <span class="hljs-built_in">endl</span>;
	}
private:
	<span class="hljs-type">int</span> _b = <span class="hljs-number">1</span>;
};

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>
{
	<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-keyword">sizeof</span>(Base) &lt;&lt; <span class="hljs-built_in">endl</span>;
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>通常情况下，我们认为这个类实例化后的大小为4字节（成员函数在公共代码区，不计算大小）。
但是结果为：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/907c1100a42a409d934dc47cc6f37e6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmY5a2QMTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767461062&amp;x-signature=VxfKke0up5eacSGKr2gHFHFXGCw%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>​实际上有了虚函数以后，对象里面会多一个指针。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d311c09f136b42b4b4e5423d340cc085~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmY5a2QMTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767461062&amp;x-signature=aZcC3%2FdHb1qmXYMyi46Mw%2BfOqQQ%3D" alt="在这里插入图片描述" loading="lazy"/>
在看一个稍微复杂例子</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Base</span>
{</span>
public:
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">Func1</span><span class="hljs-params">()</span>
	{
		<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Func1()"</span> &lt;&lt; <span class="hljs-built_in">endl</span>;
	}
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">Func2</span><span class="hljs-params">()</span>
	{
		<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Func2()"</span> &lt;&lt; <span class="hljs-built_in">endl</span>;
	}
	<span class="hljs-type">void</span> <span class="hljs-title function_">Func3</span><span class="hljs-params">()</span>
	{
		<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Func3()"</span> &lt;&lt; <span class="hljs-built_in">endl</span>;
	}
private:
	<span class="hljs-type">int</span> _b = <span class="hljs-number">1</span>;
	<span class="hljs-type">char</span> _ch = <span class="hljs-string">'a'</span>;
};
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Derive</span> :</span> public Base
{
public:
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">Func1</span><span class="hljs-params">()</span>
	{
		<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Derive::Func1()"</span> &lt;&lt; <span class="hljs-built_in">endl</span>;
	}
private:
	<span class="hljs-type">int</span> _d = <span class="hljs-number">2</span>;
};
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>
{
	<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-keyword">sizeof</span>(Base) &lt;&lt; <span class="hljs-built_in">endl</span>;
	Base bb;

	<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-keyword">sizeof</span>(Derive) &lt;&lt; <span class="hljs-built_in">endl</span>;
	Derive dd;
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>结果：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ce56a0c94c6434194ccaac44f077385~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmY5a2QMTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767461062&amp;x-signature=IV6w4GXx49304a7XFJltuDmEjNE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>对于基类:
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1233ae3d6fac41eeb089fdfec2788ac7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmY5a2QMTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767461062&amp;x-signature=OZ%2BYP9HIIf4QovhqOChDDJgF3cs%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>在Base类中，<strong>有三个函数：其中两个函数是虚函数，另一个函数是普通的成员函数</strong>，普通成员函数在公共代码区不用管，另外的两个虚函数的地址实际上被储存在一个虚函数表中，由虚函数表的指针指向，实际上bb这个对象中仅仅包含这个虚函数表的指针。</p>
<p><strong>注意</strong>：他们虚函数表中的虚函数的顺序是类中虚函数声明的顺序。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e8b413aaf0a4b5987ec67c5fbc7a27a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmY5a2QMTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767461062&amp;x-signature=GDZuk9L2SoT9CLBlNOnHiAzLo2Q%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<blockquote>
<p>此外额外实例化对象的虚表指针实际上都指向<strong>同一个虚表的起始地址。</strong></p>
<p><code>Base b1; Base b2; Base b3; </code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0fcf3c6c152448beb3179028c9d73fe6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmY5a2QMTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767461062&amp;x-signature=53m1HVkXrkkkCKs2VU0sEt9x5gQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
</blockquote>
<p>对于派生类：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57920b34353c42e3957e2b20cfdad8a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmY5a2QMTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767461062&amp;x-signature=%2BNoawUJU37cB323isY69bOZK9dA%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>在Derive 类中，将func1进行了重写，func2没有管，实际上在虚函数表中，[0]被重写（被“覆盖”更贴切）为Derive::Func1()，[1]还是原来的Base::Func2()没有动。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90eed6e9c0f2421cadaa04c57bf916be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmY5a2QMTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767461062&amp;x-signature=fue8IlR9Gw%2BmXTu9t%2FNmHNMIJFU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c21273288ff4c1e95290515720f7afa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmY5a2QMTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767461062&amp;x-signature=Ginjn7ewDZCUEzhpo3BmCldshDc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<blockquote>
<p><strong>虚函数的重写也叫做覆盖</strong>：<strong>重写</strong>是<strong>语法层</strong>的概念 <strong>覆盖</strong>是<strong>原理层</strong>的概念</p>
</blockquote>
<p>从内存视角下
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ce35ad322204291b8a8aeb89f94d8b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmY5a2QMTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767461062&amp;x-signature=uhrvl0DNawzoMlOIopD%2B2L9K2dw%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-11">探究多态调用的底层</h3>
<p>例子：一段多态调用的代码</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Base</span>
{</span>
public:
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">Func1</span><span class="hljs-params">()</span>
	{
		<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Base::Func1()"</span> &lt;&lt; <span class="hljs-built_in">endl</span>;
	}
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">Func2</span><span class="hljs-params">()</span>
	{
		<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Base::Func2()"</span> &lt;&lt; <span class="hljs-built_in">endl</span>;
	}
	<span class="hljs-type">void</span> <span class="hljs-title function_">Func3</span><span class="hljs-params">()</span>
	{
		<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Base::Func3()"</span> &lt;&lt; <span class="hljs-built_in">endl</span>;
	}
private:
	<span class="hljs-type">int</span> _b = <span class="hljs-number">1</span>;
	<span class="hljs-type">char</span> _ch = <span class="hljs-string">'a'</span>;
};
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Derive</span> :</span> public Base
{
public:
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">Func1</span><span class="hljs-params">()</span>
	{
		<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Derive::Func1()"</span> &lt;&lt; <span class="hljs-built_in">endl</span>;
	}
private:
	<span class="hljs-type">int</span> _d = <span class="hljs-number">2</span>;
};

<span class="hljs-type">void</span> <span class="hljs-title function_">f</span><span class="hljs-params">(Base* ptr)</span>
{
	ptr-&gt;Func1();<span class="hljs-comment">//多态调用</span>
}
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>
{
	<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-keyword">sizeof</span>(Base) &lt;&lt; <span class="hljs-built_in">endl</span>;
	Base bb;

	<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-keyword">sizeof</span>(Derive) &lt;&lt; <span class="hljs-built_in">endl</span>;
	Derive dd;

	f(&amp;bb);
	f(&amp;dd);
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>结果：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0e40fcae65a4bdbbc9d859e358edb41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmY5a2QMTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767461062&amp;x-signature=E9eBsnAGJrohg7HjtZ767Vr2a28%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>情况 1：</strong><code>Base* ptr = &amp;bb</code><strong>（指针指向父类对象 bb）</strong></p>
<ol>
<li>ptr变量里存的是<strong>bb对象（父类Base）的首地址</strong>；</li>
<li>bb对象的内存布局里，第一个成员就是_vfptr（虚表指针）—— <strong>这个指针是bb专属的，它只指向 Base 类的虚函数表</strong>（Base 虚表的 [0] 是Base::Func1()的地址）；</li>
<li>执行ptr-&gt;Func1()时，按图里的汇编步骤：</li>
</ol>
<ul>
<li>先从ptr里取出bb的首地址（也就是_vfptr的地址）；</li>
<li>再通过_vfptr找到 Base 类的虚表；</li>
<li>从虚表第 0 项取出Base::Func1()的地址；</li>
<li>最后调用这个地址的函数→ 所以最终调用的是父类的虚函数。</li>
</ul>
<p><strong>情况 2：</strong><code>Base* ptr = &amp;dd</code><strong>（指针指向子类对象 dd）</strong></p>
<ol>
<li>ptr变量里存的是<strong>dd对象（派生类Derive）的首地址</strong>（<strong>虽然ptr的类型是 Base*，但它实际指向的是 dd 的内存</strong>）；</li>
<li>dd对象的内存布局里，第一个成员也是_vfptr，但<strong>这个_vfptr是dd专属的 —— 它指向 Derive 类的虚函数表</strong>（Derive 虚表的 [0] 是Derive::Func1()的地址，因为子类重写了 Func1，覆盖了虚表的这一项）；</li>
<li>执行ptr-&gt;Func1()时，汇编步骤和上面完全一样（因为指针类型还是 Base*），但寻址的目标变了：</li>
</ol>
<ul>
<li>从ptr里取出dd的首地址（也就是dd的_vfptr地址）；</li>
<li>通过dd的_vfptr找到 Derive 类的虚表；</li>
<li>从虚表第 0 项取出Derive::Func1()的地址；</li>
<li>最后调用这个地址的函数→ 所以最终调用的是子类的虚函数。</li>
</ul>
<p><strong>多态调用</strong>：运行时区虚函数表中找函数的地址，进行调用，所以指向父类调的是父类虚函数，指向子类调用的是子类的虚函数。</p>
<p>如下就是多态调用的底层原理
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a84d0a1b1ad34a03a07079ccb003c623~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmY5a2QMTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767461062&amp;x-signature=SMz7WmI8jk7oAUtJQN5vZOAsPyQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-12">关于虚函数表与虚函数的一些问题</h3>
<h4 data-id="heading-13"><strong>虚函数表是存在哪个区域？</strong></h4>
<p>如下代码进行验证</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Base</span>
{</span>
public:
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">Func1</span><span class="hljs-params">()</span>
	{
		<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Base::Func1()"</span> &lt;&lt; <span class="hljs-built_in">endl</span>;
	}
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">Func2</span><span class="hljs-params">()</span>
	{
		<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Base::Func2()"</span> &lt;&lt; <span class="hljs-built_in">endl</span>;
	}
	<span class="hljs-type">void</span> <span class="hljs-title function_">Func3</span><span class="hljs-params">()</span>
	{
		<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Base::Func3()"</span> &lt;&lt; <span class="hljs-built_in">endl</span>;
	}
private:
	<span class="hljs-type">int</span> _b = <span class="hljs-number">1</span>;
};
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Derive</span> :</span> public Base
{
public:
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">Func1</span><span class="hljs-params">()</span>
	{
		<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Derive::Func1()"</span> &lt;&lt; <span class="hljs-built_in">endl</span>;
	}
private:
	<span class="hljs-type">int</span> _d = <span class="hljs-number">2</span>;
};

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>
{
	Base bb;
	Derive dd;

	<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;
	<span class="hljs-type">static</span> <span class="hljs-type">int</span> j = <span class="hljs-number">1</span>;
	<span class="hljs-type">int</span>* p1 = new <span class="hljs-type">int</span>;
	<span class="hljs-type">const</span> <span class="hljs-type">char</span>* p2 = <span class="hljs-string">"xxxx"</span>;
	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"栈：%p\n"</span>, &amp;i);
	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"静态区：%p\n"</span>, &amp;j);
	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"堆：%p\n"</span>, p1);
	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"常量区：%p\n"</span>, p2);

	Base* p3 = &amp;bb;
	Derive* p4 = &amp;dd;
	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Base虚表地址：%p\n"</span>, *(<span class="hljs-type">int</span>*)p3);<span class="hljs-comment">//取到虚表指针头四个字节</span>
	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Derive虚表地址：%p\n"</span>, *(<span class="hljs-type">int</span>*)p4);
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/511895a1ae6c46d495127f0e5ba9bfcb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmY5a2QMTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767461062&amp;x-signature=LN1WUSeNL%2FaLPVTc5%2FxpM%2FCul7Y%3D" alt="在这里插入图片描述" loading="lazy"/>
<strong>虚表在常量区存储。</strong></p>
<h4 data-id="heading-14"><strong>虚表在什么阶段生成的</strong>？</h4>
<p>编译的时候</p>
<h4 data-id="heading-15"><strong>虚表指针什么时候初始化的</strong>？</h4>
<p>构造函数构造时，在其他成员变量初始化之前，虚表指针就初始化好了。</p>
<p>注意：虚函数表中只是存储虚函数的指针，而<strong>虚函数的实现在代码段。</strong></p>
<h3 data-id="heading-16">多继承下的类底层结构（含虚函数）</h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Base1</span>
{</span>
public:
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">func1</span><span class="hljs-params">()</span> { <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Base1::func1"</span> &lt;&lt; <span class="hljs-built_in">endl</span>; }
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">func2</span><span class="hljs-params">()</span> { <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Base1::func2"</span> &lt;&lt; <span class="hljs-built_in">endl</span>; }
private:
	<span class="hljs-type">int</span> b1;
};

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Base2</span>
{</span>
public:
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">func1</span><span class="hljs-params">()</span> { <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Base2::func1"</span> &lt;&lt; <span class="hljs-built_in">endl</span>; }
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">func2</span><span class="hljs-params">()</span> { <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Base2::func2"</span> &lt;&lt; <span class="hljs-built_in">endl</span>; }
private:
	<span class="hljs-type">int</span> b2;
};

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Derive</span> :</span> public Base1, public Base2
{
public:
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">func1</span><span class="hljs-params">()</span> { <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Derive::func1"</span> &lt;&lt; <span class="hljs-built_in">endl</span>; }
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">func2</span><span class="hljs-params">()</span> { <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Derive::func2"</span> &lt;&lt; <span class="hljs-built_in">endl</span>; }
private:
	<span class="hljs-type">int</span> d1;
};

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>
{
	<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-keyword">sizeof</span>(Derive) &lt;&lt; <span class="hljs-built_in">endl</span>;
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b9b763ab9f640efa24c6880d737960d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmY5a2QMTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767461062&amp;x-signature=RonVB8zFwpvJBk40K5cRZIybWTM%3D" alt="在这里插入图片描述" loading="lazy"/>
Base1中有一个虚函数指针和int成员变量，共8字节
Base2中有一个虚函数指针和int成员变量，共8字节
所以Derive中有自身的一个int成员变量d1，和继承下来的Base1与Base2对象，共4+8+8=20字节。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/994d6a27db3342cca3eaf6fe557dcb73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmY5a2QMTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767461062&amp;x-signature=z2QYt9txXyxOj1wL8WAIqbKZX7M%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>实际上Derive中有两个不同的虚表指针，指向两个不同的虚表。</strong>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f49b9cc0f4c3451a9e265f3f122df9b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmY5a2QMTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767461062&amp;x-signature=khbBpQaaDzjXXQnrG7si4Kd6QXs%3D" alt="在这里插入图片描述" loading="lazy"/>
在代码中，在Derive类中，我们重写了func1函数，如下可以看出重写的Derive::func1()覆盖了Base1与Base2的虚表中func1()。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89cb58bf76ea4d689f4494f2d555479a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmY5a2QMTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767461062&amp;x-signature=kuoZ7EPRAEtQzDTcYBm1oY%2BEp40%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>那么在类Derive中，不是重写的虚函数func3()放在哪里了？
<strong>放在继承的第一个类Base1的虚表的最后（在菱形继承中也有例子体现）</strong>，验证如下。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">typedef</span> <span class="hljs-title function_">void</span><span class="hljs-params">(*VF_PTR)</span><span class="hljs-params">()</span>;

<span class="hljs-comment">//打印虚表，本质打印指针（虚函数指针）数组</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">PrintVFT</span><span class="hljs-params">(VF_PTR vft[])</span>
{
	<span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; vft[i] != nullptr; i++)
	{
		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"[%d]:%p-&gt;"</span>, i, vft[i]);
		VF_PTR f = vft[i];
		f();
	}
}
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>
{
	Derive d;

	Base1* ptr1 = &amp;d;
	Base2* ptr2 = &amp;d;
	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Base1虚表地址：%p\n"</span>,ptr1);
	PrintVFT((VF_PTR*)(*(<span class="hljs-type">int</span>*)ptr1));
	<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-built_in">endl</span>;
	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Base2虚表地址：%p\n"</span>, ptr2);
	PrintVFT((VF_PTR*)(*(<span class="hljs-type">int</span>*)ptr2));
}
</code></pre>
<blockquote>
<p><strong>普通多重继承中，新增虚函数优先挂到第一个直接基类的虚表（如果它有 vfptr 虚表指针），不管有没有重写其他基类的虚函数。</strong></p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba69322adfb34236820bca927bb90e48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmY5a2QMTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767461062&amp;x-signature=47OAh5IICPuq8vnnbCNNwOIGYkw%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>总结：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a078e8b5774343b3912113556e1c6152~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmY5a2QMTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767461062&amp;x-signature=WsCA26lhF5FOMh1tlQ255DVmRzQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-17">菱形继承下的类底层结构（含虚函数情况）</h4>
<p>例子1</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span>
{</span>
public:
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">funca1</span><span class="hljs-params">()</span> { <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"A::funca1"</span> &lt;&lt; <span class="hljs-built_in">endl</span>; }
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">funca2</span><span class="hljs-params">()</span> { <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"A::funca2"</span> &lt;&lt; <span class="hljs-built_in">endl</span>; }
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">funca3</span><span class="hljs-params">()</span> { <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"A::funca3"</span> &lt;&lt; <span class="hljs-built_in">endl</span>; }
public:
	<span class="hljs-type">int</span> a;
};

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B</span> :</span>virtual public A
{
public:
	<span class="hljs-type">int</span> b;
};

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">C</span> :</span>virtual public A
{
public:
	<span class="hljs-type">int</span> c;
};
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">D</span> :</span>public B, public C
{
public:
	<span class="hljs-type">int</span> d;
};

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>
{
	D dd;
	dd.B::a = <span class="hljs-number">1</span>;
	dd.C::a = <span class="hljs-number">2</span>;
	dd.b = <span class="hljs-number">3</span>;
	dd.c = <span class="hljs-number">4</span>;
	dd.d = <span class="hljs-number">5</span>;
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>分析如下：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b85ac0505084da3a5bf39e1125934d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmY5a2QMTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767461062&amp;x-signature=xkO8iat1CH8pn4tw8f9yuArmEZ4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>例子2</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span>
{</span>
public:
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">func1</span><span class="hljs-params">()</span> { <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"A::func1"</span> &lt;&lt; <span class="hljs-built_in">endl</span>; }
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">func2</span><span class="hljs-params">()</span> { <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"A::func2"</span> &lt;&lt; <span class="hljs-built_in">endl</span>; }
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">func3</span><span class="hljs-params">()</span> { <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"A::func3"</span> &lt;&lt; <span class="hljs-built_in">endl</span>; }
public:
	<span class="hljs-type">int</span> a;
};

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B</span> :</span>virtual public A
{
public:
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">func1</span><span class="hljs-params">()</span> { <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"B::func1"</span> &lt;&lt; <span class="hljs-built_in">endl</span>; }
public:
	<span class="hljs-type">int</span> b;
};

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">C</span> :</span>virtual public A
{
public:
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">func2</span><span class="hljs-params">()</span> { <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"C::func2"</span> &lt;&lt; <span class="hljs-built_in">endl</span>; }
public:
	<span class="hljs-type">int</span> c;
};
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">D</span> :</span>public B, public C
{
public:
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">func1</span><span class="hljs-params">()</span> { <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"D::func1"</span> &lt;&lt; <span class="hljs-built_in">endl</span>; }
public:
	<span class="hljs-type">int</span> d;
};

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>
{
	D dd;
	dd.a = <span class="hljs-number">1</span>;
	dd.b = <span class="hljs-number">2</span>;
	dd.c = <span class="hljs-number">3</span>;
	dd.d = <span class="hljs-number">4</span>;
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>如上类B对类A的func1进行了重写，类C对类A的func2进行了重写，而类D对类B的func1进行了重写。
B、C 只是重写了 A 的虚函数（比如 B 重写 A 的 func1），这些重写的函数可以共享虚基类 A 的虚函数表（因为 A 的虚表会记录最终覆盖后的函数地址）。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fee31c53760a4a0bbc2749ed0913d895~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmY5a2QMTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767461062&amp;x-signature=Ve5jxkUU6qbPKDkC4cM9n1j61Q8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>例子3</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span>
{</span>
public:
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">func1</span><span class="hljs-params">()</span> { <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"A::func1"</span> &lt;&lt; <span class="hljs-built_in">endl</span>; }
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">func2</span><span class="hljs-params">()</span> { <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"A::func2"</span> &lt;&lt; <span class="hljs-built_in">endl</span>; }
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">func3</span><span class="hljs-params">()</span> { <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"A::func3"</span> &lt;&lt; <span class="hljs-built_in">endl</span>; }
public:
	<span class="hljs-type">int</span> a;
};

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B</span> :</span>virtual public A
{
public:
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">func4</span><span class="hljs-params">()</span> { <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"B::func4"</span> &lt;&lt; <span class="hljs-built_in">endl</span>; }
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">func5</span><span class="hljs-params">()</span> { <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"B::func5"</span> &lt;&lt; <span class="hljs-built_in">endl</span>; }
public:
	<span class="hljs-type">int</span> b;
};

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">C</span> :</span>virtual public A
{
public:
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">func6</span><span class="hljs-params">()</span> { <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"C::func6"</span> &lt;&lt; <span class="hljs-built_in">endl</span>; }
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">func7</span><span class="hljs-params">()</span> { <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"C::func7"</span> &lt;&lt; <span class="hljs-built_in">endl</span>; }
public:
	<span class="hljs-type">int</span> c;
};
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">D</span> :</span>public B, public C
{
public:
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">func8</span><span class="hljs-params">()</span> { <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"D::func8"</span> &lt;&lt; <span class="hljs-built_in">endl</span>; }
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">func9</span><span class="hljs-params">()</span> { <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"D::func9"</span> &lt;&lt; <span class="hljs-built_in">endl</span>; }
public:
	<span class="hljs-type">int</span> d;
};

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>
{
	D dd;
	dd.a = <span class="hljs-number">1</span>;
	dd.b = <span class="hljs-number">2</span>;
	dd.c = <span class="hljs-number">3</span>;
	dd.d = <span class="hljs-number">4</span>;
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>现在给 B 加了func4、func5，给 C 加了func6、func7—— 这些是A 没有的独有的虚函数，无法存到 A 的虚函数表里，所以 B、C 必须各自有一个自己的虚函数表指针（vfptr），指向自己的虚函数表（用来存这些独有的虚函数地址）。</p>
<p>如下图，<strong>类中的结构顺序为：虚函数表指针，虚机表指针，类成员变量</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c678549cca44b5f860b36be0dc88390~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmY5a2QMTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767461062&amp;x-signature=ROzOcnkyKP2R3oEErgStqODV57M%3D" alt="在这里插入图片描述" loading="lazy"/>
注意：这里类D（最终类）中有虚函数，但没有像类B，类C那样新增一个虚函数表指针写到成员变量的上面，而是把这些虚函数的地址都放到了，第一个类B的虚函数表中。</p>
<blockquote>
<p><strong>普通多重继承中，新增虚函数优先挂到第一个直接基类的虚表（如果它有 vfptr 虚表指针），不管有没有重写其他基类的虚函数。</strong></p>
</blockquote>
<p>这里举一个例子：C-&gt;B-&gt;A（长一点的继承）
结果预测是B,C中的新的虚函数，都放在了A的虚函数表中，B，C中并没有新增虚函数表。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span>
{</span>
public:
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">func1</span><span class="hljs-params">()</span>{}
public:
	<span class="hljs-type">int</span> a;
};

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B</span>:</span>public A
{
public:
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">func2</span><span class="hljs-params">()</span>{}
public:
	<span class="hljs-type">int</span> b;
};

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">C</span> :</span>public B
{
public:
	virtual <span class="hljs-type">void</span> <span class="hljs-title function_">func3</span><span class="hljs-params">()</span> {}
public:
	<span class="hljs-type">int</span> c;
};

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>
{
	C cc;
	cc.a = <span class="hljs-number">1</span>;
	cc.b = <span class="hljs-number">2</span>;
	cc.c = <span class="hljs-number">3</span>;
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>确实如此
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7597a00dd214b578829651daf02ee54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmY5a2QMTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767461062&amp;x-signature=dw1Hs08eYnZUaqPin8WrtlSFXyY%3D" alt="在这里插入图片描述" loading="lazy"/></p>

















<table><thead><tr><th>场景</th><th>新增虚函数的挂靠规则</th></tr></thead><tbody><tr><td>普通多重继承（如 D 继承 B、C）</td><td><strong>优先挂到第一个直接基类的虚表</strong></td></tr><tr><td>菱形虚拟继承（如 B 虚拟继承 A）</td><td>必须自己建虚表，不能挂 A 的虚表</td></tr></tbody></table>
<p>简单理解：对于“共享类”（例如A），不能挂到他自身，应优先挂到他直接派生类的虚表，对于“普通类”，多重继承中，他的直接派生类优先挂到他的虚表。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🔥 Go Gin 不停机重启指南：让服务在“洗澡搓背”中无缝升级]]></title>    <link>https://juejin.cn/post/7588067055482732553</link>    <guid>https://juejin.cn/post/7588067055482732553</guid>    <pubDate>2025-12-28T00:39:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588067055482732553" data-draft-id="7585948869845205027" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🔥 Go Gin 不停机重启指南：让服务在“洗澡搓背”中无缝升级"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-28T00:39:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="golang学习记"/> <meta itemprop="url" content="https://juejin.cn/user/4371313964100990"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🔥 Go Gin 不停机重启指南：让服务在“洗澡搓背”中无缝升级
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4371313964100990/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    golang学习记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T00:39:41.000Z" title="Sun Dec 28 2025 00:39:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>“用户正在下单，你却要 <code>Ctrl+C</code> 重启服务？”<br/>
“老板问：‘上线怎么又中断了？’ 你弱弱回答：‘就三秒……’”</p>
<p>——这不是运维，是<strong>人质劫持式部署</strong>。</p>
<p>今天，我们教 Gin 服务：<strong>边跑马拉松，边换鞋，还不带喘气的</strong>！👟💨</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">🧠 一、什么是“热重启”？——不是魔法，是科学！</h2>
<p>先抛个灵魂拷问：</p>
<blockquote>
<p>❓ 为什么 Nginx 执行 <code>nginx -s reload</code> 时，你正在下载的视频<strong>不会卡成 PPT</strong>？</p>
</blockquote>
<h3 data-id="heading-1">📌 核心原理三板斧：</h3>





















<table><thead><tr><th>技术点</th><th>人类翻译版</th></tr></thead><tbody><tr><td><strong>1. 监听器继承</strong></td><td>父进程把“门”（socket 监听套接字）传给子进程，新老交替，门口不空岗 👮➡️👮‍♂️</td></tr><tr><td><strong>2. 优雅退出</strong></td><td>旧进程停止接新活，但把手里“半碗面”吃完（处理完在途请求）🍜</td></tr><tr><td><strong>3. 信号驱动</strong></td><td><code>SIGUSR2</code> 不是“杀我”，是“我让位，你上！”</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>底层真相</strong>：<br/>
当 <code>net.Listen("tcp", ":8080")</code> 成功后，内核就绑定了 1 个 socket 文件描述符（FD=3）。<br/>
父进程 <code>fork()</code> + <code>exec()</code> 子进程时，<strong>FD 是默认继承的</strong>（除非设 <code>FD_CLOEXEC</code>）。<br/>
→ 子进程 <code>net.FileListener(os.NewFile(3, ""))</code> 直接接管“大门”，用户连接毫无感知！</p>
</blockquote>
<hr/>
<h2 data-id="heading-2">🎒 二、Go 里怎么玩？5 种姿势大乱斗</h2>
<h3 data-id="heading-3">🥇 <strong>冠军选手：<code>github.com/fvbock/endless</code></strong></h3>
<blockquote>
<p>“稳定如老狗，文档像菜谱”</p>
</blockquote>
<h4 data-id="heading-4">✅ 核心亮点：</h4>
<ul>
<li>单函数替换 <code>http.ListenAndServe</code> → <code>endless.ListenAndServe</code></li>
<li>支持 <code>SIGUSR1</code> / <code>SIGUSR2</code> / <code>SIGTERM</code> 多信号</li>
<li>自动处理 <code>HammerTime</code>（强制关机倒计时）</li>
<li>一行代码拯救世界：</li>
</ul>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 从 ❌ 脆弱模式</span>
log.Fatal(http.ListenAndServe(<span class="hljs-string">":8080"</span>, router))

<span class="hljs-comment">// 一键升级 → ✅ 健壮模式</span>
endless.ListenAndServe(<span class="hljs-string">":8080"</span>, router)
</code></pre>
<h4 data-id="heading-5">🛠 生产级配置（带防坑补丁）：</h4>
<pre><code class="hljs language-go" lang="go">server := endless.NewServer(<span class="hljs-string">":8080"</span>, router)

<span class="hljs-comment">// 防止慢客户端拖垮服务</span>
server.ReadTimeout = <span class="hljs-number">15</span> * time.Second
server.WriteTimeout = <span class="hljs-number">30</span> * time.Second

<span class="hljs-comment">// 关门后等多久“赶客”</span>
endless.DefaultHammerTime = <span class="hljs-number">45</span> * time.Second <span class="hljs-comment">// 超时直接 kill -9</span>

<span class="hljs-comment">// 优雅提示</span>
server.BeforeBegin = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(addr <span class="hljs-type">string</span>)</span></span> {
    log.Printf(<span class="hljs-string">"🚀 Gin Server UP on %s | PID: %d"</span>, addr, os.Getpid())
}
</code></pre>
<blockquote>
<p>🤯 <strong>冷知识</strong>：<code>endless.Kill()</code> 实际发的是 <code>SIGQUIT</code>，触发 <code>fork()</code> + <code>exec()</code> 新进程，并关旧门。</p>
</blockquote>
<hr/>
<h3 data-id="heading-6">🥈 <strong>优雅派：<code>github.com/gin-contrib/graceful</code></strong></h3>
<blockquote>
<p>“Gin 官方亲儿子，可惜最近有点佛”</p>
</blockquote>
<h4 data-id="heading-7">⚠️ 注意：</h4>
<ul>
<li>该库已<strong>多年未更新</strong>（最后 commit 是 2018 年！）</li>
<li>兼容 Go 1.14+，但新特性（如 <code>http.Server.Shutdown</code> context 控制）支持弱</li>
</ul>
<pre><code class="hljs language-go" lang="go">router, _ := graceful.Default()
router.GET(<span class="hljs-string">"/ping"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> {
    c.String(<span class="hljs-number">200</span>, <span class="hljs-string">"pong (pid=%d)"</span>, os.Getpid())
})

srv := &amp;http.Server{Addr: <span class="hljs-string">":8080"</span>, Handler: router}
err := router.RunWithContext(srv)
</code></pre>
<blockquote>
<p>📌 <strong>适合</strong>：老项目维护，不想引入新依赖<br/>
🚫 <strong>不适合</strong>：高可用新项目，建议直接 <code>endless</code></p>
</blockquote>
<hr/>
<h3 data-id="heading-8">🥉 <strong>极简派：标准库 <code>http.Server.Shutdown()</code></strong></h3>
<blockquote>
<p>“不依赖第三方，自带五险一金”</p>
</blockquote>
<pre><code class="hljs language-go" lang="go">srv := &amp;http.Server{Addr: <span class="hljs-string">":8080"</span>, Handler: router}

<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">if</span> err := srv.ListenAndServe(); err != http.ErrServerClosed {
        log.Fatal(err)
    }
}()

<span class="hljs-comment">// 等信号</span>
quit := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> os.Signal, <span class="hljs-number">1</span>)
signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM)
&lt;-quit

<span class="hljs-comment">// 关门清场</span>
ctx, cancel := context.WithTimeout(context.Background(), <span class="hljs-number">10</span>*time.Second)
<span class="hljs-keyword">defer</span> cancel()
srv.Shutdown(ctx) <span class="hljs-comment">// ← 关键！等请求结束再 exit</span>
</code></pre>
<blockquote>
<p>✅ 优点：零依赖、可控性强<br/>
❌ 缺点：<strong>不支持“热”重启</strong>——只能关旧开新，中间有几秒 downtime！</p>
</blockquote>
<hr/>
<h3 data-id="heading-9">🥊 <strong>硬核派：自己撸——Master/Worker 模式（仿 Nginx）</strong></h3>
<blockquote>
<p>“看完这段代码，你就有资格叫‘Go 黑客’”</p>
</blockquote>
<h4 data-id="heading-10">为什么需要自己写？</h4>
<ul>
<li>想控制子进程生命周期（崩溃自动拉起）</li>
<li>需要灰度发布、AB 测试能力</li>
<li>被老板逼着写技术方案 PPT 😭</li>
</ul>
<h4 data-id="heading-11">精简版核心逻辑：</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 主进程：守门人</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">if</span> os.Getenv(<span class="hljs-string">"IS_CHILD"</span>) == <span class="hljs-string">"1"</span> {
        runChild() <span class="hljs-comment">// 子进程走这里</span>
        <span class="hljs-keyword">return</span>
    }

    listener, _ := net.Listen(<span class="hljs-string">"tcp"</span>, <span class="hljs-string">":8080"</span>)
    
    <span class="hljs-comment">// 启动第一个子进程</span>
    startChild(listener)

    <span class="hljs-comment">// 监听信号</span>
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        sig := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> os.Signal, <span class="hljs-number">1</span>)
        signal.Notify(sig, syscall.SIGUSR2)
        <span class="hljs-keyword">for</span> <span class="hljs-keyword">range</span> sig {
            listener2, _ := dupListener(listener) <span class="hljs-comment">// 克隆监听器！</span>
            startChild(listener2) <span class="hljs-comment">// 启动新子进程</span>
            <span class="hljs-comment">// 旧子进程自动退出（靠父子进程心跳 or SIGTERM）</span>
        }
    }()

    <span class="hljs-comment">// 阻塞主进程</span>
    <span class="hljs-keyword">select</span>{}
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">startChild</span><span class="hljs-params">(l net.Listener)</span></span> {
    cmd := exec.Command(os.Args[<span class="hljs-number">0</span>])
    cmd.Env = <span class="hljs-built_in">append</span>(os.Environ(), <span class="hljs-string">"IS_CHILD=1"</span>)
    cmd.ExtraFiles = []*os.File{l.(filer).File()} <span class="hljs-comment">// 传 FD=3</span>
    cmd.Start()
}
</code></pre>
<blockquote>
<p>🔑 关键点：</p>
<ul>
<li><code>l.(filer).File()</code> → 拿到底层 <code>*os.File</code></li>
<li><code>cmd.ExtraFiles = [...]</code> → 传给子进程（成为 FD=3）</li>
<li>子进程中 <code>net.FileListener(os.NewFile(3, ""))</code> 接管</li>
</ul>
</blockquote>
<p>⚠️ 完整实现要考虑：FD 泄露、僵尸进程回收、配置热重载……</p>
<hr/>
<h3 data-id="heading-12">🎮 <strong>开发派：<code>air</code> —— 写代码像打游戏，按 Ctrl+S=重生</strong></h3>
<blockquote>
<p>“改一行代码，服务自动 reload，爽过喝可乐”</p>
</blockquote>
<h4 data-id="heading-13">安装（三秒搞定）：</h4>
<pre><code class="hljs language-bash" lang="bash">go install github.com/cosmtrek/air@latest
<span class="hljs-comment"># 或用脚本（来自官方 install.sh）</span>
curl -sSfL https://raw.githubusercontent.com/cosmtrek/air/master/install.sh | sh -s
</code></pre>
<h4 data-id="heading-14">配置 <code>.air.toml</code>（重点！）：</h4>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-section">[build]</span>
<span class="hljs-attr">cmd</span> = <span class="hljs-string">"go build -o ./tmp/app ."</span>
<span class="hljs-attr">bin</span> = <span class="hljs-string">"tmp/app"</span>
<span class="hljs-attr">delay</span> = <span class="hljs-number">1000</span>      <span class="hljs-comment"># 毫秒，防手抖连点</span>
<span class="hljs-attr">send_interrupt</span> = <span class="hljs-literal">true</span>  <span class="hljs-comment"># 改用 SIGINT 而非 SIGKILL，给优雅退出机会！</span>
</code></pre>
<blockquote>
<p>✅ 为什么 <code>send_interrupt = true</code> 很重要？<br/>
默认 <code>send_interrupt = false</code> → <code>kill -9</code> 粗暴杀死 → <strong>数据库连接泄漏！</strong><br/>
设为 <code>true</code> → 发 <code>SIGINT</code> → 走 <code>Shutdown()</code> 逻辑 → 安全！</p>
</blockquote>
<hr/>
<hr/>
<h2 data-id="heading-15">🚨 四、血泪踩坑实录（避雷指南）</h2>



































<table><thead><tr><th>坑点</th><th>现象</th><th>解决方案</th></tr></thead><tbody><tr><td><strong>FD 泄露</strong></td><td>重启 10 次后 <code>lsof -p</code> 爆出 30+ 个 socket</td><td>子进程启动后，父进程 <code>f.Close()</code> 旧 FD！</td></tr><tr><td><strong>全局变量污染</strong></td><td>重启后配置没更新</td><td>避免 <code>var config = loadConf()</code>，改用 <code>getConfig()</code> 函数式读取</td></tr><tr><td><strong>goroutine 僵尸</strong></td><td>旧请求卡住，新进程起不来</td><td>所有耗时操作必须传 <code>context.WithTimeout</code>！</td></tr><tr><td><strong>Docker 信号失效</strong></td><td><code>kill -USR2</code> 没反应</td><td>ENTRYPOINT 用 <code>tini</code> 或 <code>dumb-init</code> 做 PID 1</td></tr><tr><td><strong>TLS 证书不更新</strong></td><td>重启后还是旧证书</td><td>用 <code>http.Server.TLSConfig.GetCertificate</code> 动态加载</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-16">🌈 结语：优雅，是程序员的终极性感</h2>
<blockquote>
<p>用户不关心你用 Go 还是 Rust，<br/>
他们只关心——<br/>
<strong>“我付款时，页面为什么卡了？”</strong></p>
<p>热重启不是炫技，<br/>
是对用户时间的尊重，<br/>
是对线上服务的敬畏，<br/>
是深夜值班时，你能笑着喝完那杯凉掉的咖啡 ☕。</p>
</blockquote>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Docker 入门实战教程：从零开始掌握容器化技术]]></title>    <link>https://juejin.cn/post/7588042910198644786</link>    <guid>https://juejin.cn/post/7588042910198644786</guid>    <pubDate>2025-12-28T01:19:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588042910198644786" data-draft-id="7588073726207442950" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Docker 入门实战教程：从零开始掌握容器化技术"/> <meta itemprop="keywords" content="Docker"/> <meta itemprop="datePublished" content="2025-12-28T01:19:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Docker 入门实战教程：从零开始掌握容器化技术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T01:19:31.000Z" title="Sun Dec 28 2025 01:19:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Docker 入门实战教程：从零开始掌握容器化技术</h2>
<h3 data-id="heading-1">引言：为什么需要 Docker？</h3>
<p>在软件开发的世界里，我们经常遇到这样的困扰："在我的电脑上明明可以运行，为什么到服务器上就报错了？"这个问题一直困扰着无数开发者。不同的操作系统、不同的依赖库版本、不同的环境配置……这些差异导致了开发和部署环境的不一致。</p>
<p>而 Docker 的出现，彻底改变了这一局面。它让应用程序及其依赖环境打包成一个轻量级的"容器"，在任何支持 Docker 的平台上都能以相同的方式运行。这就是著名的"一次构建，到处运行"（Build Once, Run Anywhere）。</p>
<h3 data-id="heading-2">一、Docker 是什么？</h3>
<h4 data-id="heading-3">1.1 容器技术的革命</h4>
<p>Docker 是一个开源的容器化平台，它可以将应用程序及其依赖环境打包成一个独立的容器。与传统虚拟机相比，Docker 容器更加轻量、快速、高效。</p>
<p><strong>传统虚拟机 vs Docker 容器：</strong></p>



































<table><thead><tr><th>特性</th><th>虚拟机</th><th>Docker 容器</th></tr></thead><tbody><tr><td>启动速度</td><td>分钟级</td><td>秒级</td></tr><tr><td>磁盘占用</td><td>GB 级别</td><td>MB 级别</td></tr><tr><td>性能</td><td>接近原生</td><td>接近原生</td></tr><tr><td>隔离性</td><td>完全隔离</td><td>进程级隔离</td></tr><tr><td>可移植性</td><td>较差</td><td>优秀</td></tr></tbody></table>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd203cf9c7d949b9b8548b6b2e235f41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767489570&amp;x-signature=OOueUzzcnF79MKFqYbuFjmuS24Q%3D" alt="vm_vs_docker.png" loading="lazy"/></p>
<h4 data-id="heading-4">1.2 Docker 的核心优势</h4>
<ul>
<li><strong>快速部署</strong>：容器启动只需几秒钟</li>
<li><strong>环境一致性</strong>：开发、测试、生产环境完全一致</li>
<li><strong>资源高效</strong>：相比虚拟机节省大量系统资源</li>
<li><strong>微服务架构</strong>：完美支持微服务部署</li>
<li><strong>持续集成/部署</strong>：简化 CI/CD 流程</li>
</ul>
<h3 data-id="heading-5">二、Docker 核心概念详解</h3>
<h4 data-id="heading-6">2.1 镜像（Image）</h4>
<p><strong>镜像就像是应用程序的"模板"或"蓝图"</strong>。它是一个只读的文件包，包含了运行应用程序所需的所有内容：代码、运行时、系统工具、系统库和设置。</p>
<p><strong>镜像的特点：</strong></p>
<ul>
<li>分层存储：每一层都是只读的</li>
<li>可复用：多个容器可以共享同一个镜像</li>
<li>版本管理：通过标签（tag）管理不同版本</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c12e6d2edd44ebaac4ceeedf024515e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767489570&amp;x-signature=uN6%2B3TTV71rXNpPPDvGdsoqj82o%3D" alt="docker_image_layers.png" loading="lazy"/></p>
<p><strong>常见镜像示例：</strong></p>
<pre><code class="hljs language-bash" lang="bash">nginx:latest          <span class="hljs-comment"># 最新版本的 Nginx</span>
python:3.9-slim      <span class="hljs-comment"># Python 3.9 精简版</span>
mysql:8.0            <span class="hljs-comment"># MySQL 8.0</span>
ubuntu:20.04         <span class="hljs-comment"># Ubuntu 20.04</span>
</code></pre>
<h4 data-id="heading-7">2.2 容器（Container）</h4>
<p><strong>容器是镜像的运行实例</strong>。如果说镜像是"类"，那么容器就是"对象"。你可以从一个镜像启动多个容器，每个容器都是相互隔离的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e8b7619961f4ba2948c437b12bc711e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767489570&amp;x-signature=v0y3hNCCVYpznj9qqupNH4scIN8%3D" alt="container_lifecycle.png" loading="lazy"/></p>
<p><strong>容器的生命周期：</strong></p>
<ol>
<li><strong>Created</strong>：容器已创建但未启动</li>
<li><strong>Running</strong>：容器正在运行</li>
<li><strong>Paused</strong>：容器已暂停</li>
<li><strong>Stopped</strong>：容器已停止</li>
<li><strong>Deleted</strong>：容器已删除</li>
</ol>
<h4 data-id="heading-8">2.3 仓库（Registry）</h4>
<p><strong>仓库是存放镜像的地方</strong>，就像代码仓库存放代码一样。</p>
<p><strong>常见的 Docker 镜像仓库：</strong></p>
<ul>
<li><strong>Docker Hub</strong>：官方公共仓库（hub.docker.com）</li>
<li><strong>阿里云镜像仓库</strong>：国内访问速度快</li>
<li><strong>私有仓库</strong>：企业内部自建</li>
</ul>
<hr/>
<p><strong>Docker 核心组件架构总览：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3dfc756b0514d8686d65a675f44c4c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767489570&amp;x-signature=RWbJAq4Gu01tckxnQeln0vMJIps%3D" alt="docker_architecture.png" loading="lazy"/></p>
<h3 data-id="heading-9">三、Docker 安装指南</h3>
<h4 data-id="heading-10">3.1 Windows 安装</h4>
<p><strong>系统要求：</strong></p>
<ul>
<li>Windows 10/11 专业版或企业版</li>
<li>启用 Hyper-V 和 WSL 2</li>
</ul>
<p><strong>安装步骤：</strong></p>
<ol>
<li>访问 Docker 官网下载 Docker Desktop for Windows</li>
<li>双击安装程序，按照提示完成安装</li>
<li>重启计算机</li>
<li>启动 Docker Desktop</li>
<li>验证安装：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">docker --version
docker run hello-world
</code></pre>
<h4 data-id="heading-11">3.2 Linux 安装（以 Ubuntu 为例）</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 更新包索引</span>
sudo apt-get update

<span class="hljs-comment"># 2. 安装依赖包</span>
sudo apt-get install \
    ca-certificates \
    curl \
    gnupg \
    lsb-release

<span class="hljs-comment"># 3. 添加 Docker 官方 GPG 密钥</span>
sudo <span class="hljs-built_in">mkdir</span> -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

<span class="hljs-comment"># 4. 设置仓库</span>
<span class="hljs-built_in">echo</span> \
  <span class="hljs-string">"deb [arch=<span class="hljs-subst">$(dpkg --print-architecture)</span> signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  <span class="hljs-subst">$(lsb_release -cs)</span> stable"</span> | sudo <span class="hljs-built_in">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null

<span class="hljs-comment"># 5. 安装 Docker Engine</span>
sudo apt-get update
sudo apt-get install docker-ce docker-ce-cli containerd.io

<span class="hljs-comment"># 6. 验证安装</span>
sudo docker run hello-world
</code></pre>
<p><strong>配置用户组（免 sudo）：</strong></p>
<pre><code class="hljs language-bash" lang="bash">sudo usermod -aG docker <span class="hljs-variable">$USER</span>
newgrp docker
</code></pre>
<h3 data-id="heading-12">四、Docker 实战演练</h3>
<h4 data-id="heading-13">4.1 第一个 Docker 容器</h4>
<p>让我们从最简单的例子开始，运行一个 Nginx Web 服务器：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 拉取 Nginx 镜像</span>
docker pull nginx:latest

<span class="hljs-comment"># 运行 Nginx 容器</span>
docker run -d -p 8080:80 --name my-nginx nginx:latest

<span class="hljs-comment"># 查看运行状态</span>
docker ps

<span class="hljs-comment"># 访问测试</span>
<span class="hljs-comment"># 打开浏览器访问 http://localhost:8080</span>
</code></pre>
<p><strong>参数说明：</strong></p>
<ul>
<li><code>-d</code>：后台运行</li>
<li><code>-p 8080:80</code>：端口映射，宿主机8080端口映射到容器80端口</li>
<li><code>--name my-nginx</code>：指定容器名称</li>
</ul>
<h4 data-id="heading-14">4.2 部署 MySQL 数据库</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 运行 MySQL 容器</span>
docker run -d \
  --name mysql-server \
  -e MYSQL_ROOT_PASSWORD=my-secret-pw \
  -e MYSQL_DATABASE=mydb \
  -p 3306:3306 \
  -v mysql-data:/var/lib/mysql \
  mysql:8.0

<span class="hljs-comment"># 进入 MySQL 容器</span>
docker <span class="hljs-built_in">exec</span> -it mysql-server mysql -uroot -p

<span class="hljs-comment"># 查看 MySQL 日志</span>
docker logs mysql-server
</code></pre>
<p><strong>参数说明：</strong></p>
<ul>
<li><code>-e</code>：设置环境变量</li>
<li><code>-v mysql-data:/var/lib/mysql</code>：数据持久化，数据存储在命名卷中</li>
</ul>
<h4 data-id="heading-15">4.4 Docker Compose 多容器应用</h4>
<p><strong>docker-compose.yml 示例：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">'3.8'</span>

<span class="hljs-attr">services:</span>
  <span class="hljs-comment"># Web 应用</span>
  <span class="hljs-attr">web:</span>
    <span class="hljs-attr">build:</span> <span class="hljs-string">.</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"5000:5000"</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">db</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">DATABASE_URL=mysql://root:my-secret-pw@db:3306/mydb</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">app-network</span>

  <span class="hljs-comment"># 数据库</span>
  <span class="hljs-attr">db:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">mysql:8.0</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">MYSQL_ROOT_PASSWORD:</span> <span class="hljs-string">my-secret-pw</span>
      <span class="hljs-attr">MYSQL_DATABASE:</span> <span class="hljs-string">mydb</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">mysql-data:/var/lib/mysql</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"3306:3306"</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">app-network</span>

  <span class="hljs-comment"># Nginx 反向代理</span>
  <span class="hljs-attr">nginx:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:latest</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"80:80"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./nginx.conf:/etc/nginx/nginx.conf</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">web</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">app-network</span>

<span class="hljs-attr">volumes:</span>
  <span class="hljs-attr">mysql-data:</span>

<span class="hljs-attr">networks:</span>
  <span class="hljs-attr">app-network:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">bridge</span>
</code></pre>
<p><strong>启动服务：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动所有服务</span>
docker-compose up -d

<span class="hljs-comment"># 查看服务状态</span>
docker-compose ps

<span class="hljs-comment"># 查看日志</span>
docker-compose logs -f

<span class="hljs-comment"># 停止服务</span>
docker-compose down
</code></pre>
<h3 data-id="heading-16">五、Docker 常用命令大全</h3>
<h4 data-id="heading-17">5.1 镜像管理命令</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 搜索镜像</span>
docker search nginx

<span class="hljs-comment"># 拉取镜像</span>
docker pull nginx:latest

<span class="hljs-comment"># 查看本地镜像</span>
docker images

<span class="hljs-comment"># 删除镜像</span>
docker rmi nginx:latest

<span class="hljs-comment"># 构建镜像</span>
docker build -t myapp:1.0 .

<span class="hljs-comment"># 导出镜像</span>
docker save -o myapp.tar myapp:1.0

<span class="hljs-comment"># 导入镜像</span>
docker load -i myapp.tar

<span class="hljs-comment"># 标记镜像</span>
docker tag myapp:1.0 myapp:latest
</code></pre>
<h4 data-id="heading-18">5.2 容器管理命令</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 运行容器</span>
docker run [OPTIONS] IMAGE [COMMAND]
docker run -d -p 80:80 --name web nginx

<span class="hljs-comment"># 查看运行中的容器</span>
docker ps

<span class="hljs-comment"># 查看所有容器（包括已停止）</span>
docker ps -a

<span class="hljs-comment"># 停止容器</span>
docker stop web

<span class="hljs-comment"># 启动已停止的容器</span>
docker start web

<span class="hljs-comment"># 重启容器</span>
docker restart web

<span class="hljs-comment"># 删除容器</span>
docker <span class="hljs-built_in">rm</span> web

<span class="hljs-comment"># 强制删除运行中的容器</span>
docker <span class="hljs-built_in">rm</span> -f web

<span class="hljs-comment"># 查看容器详细信息</span>
docker inspect web

<span class="hljs-comment"># 查看容器日志</span>
docker logs web
docker logs -f web  <span class="hljs-comment"># 实时查看</span>

<span class="hljs-comment"># 进入容器</span>
docker <span class="hljs-built_in">exec</span> -it web /bin/bash
</code></pre>
<h4 data-id="heading-19">5.3 数据管理命令</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建数据卷</span>
docker volume create my-volume

<span class="hljs-comment"># 查看数据卷</span>
docker volume <span class="hljs-built_in">ls</span>

<span class="hljs-comment"># 查看数据卷详情</span>
docker volume inspect my-volume

<span class="hljs-comment"># 删除数据卷</span>
docker volume <span class="hljs-built_in">rm</span> my-volume

<span class="hljs-comment"># 创建备份</span>
docker run --<span class="hljs-built_in">rm</span> --volumes-from db-container -v $(<span class="hljs-built_in">pwd</span>):/backup \
  ubuntu tar cvf /backup/backup.tar /var/lib/mysql
</code></pre>
<h4 data-id="heading-20">5.4 网络管理命令</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建网络</span>
docker network create my-network

<span class="hljs-comment"># 查看网络</span>
docker network <span class="hljs-built_in">ls</span>

<span class="hljs-comment"># 连接容器到网络</span>
docker network connect my-network my-container

<span class="hljs-comment"># 断开网络连接</span>
docker network disconnect my-network my-container

<span class="hljs-comment"># 删除网络</span>
docker network <span class="hljs-built_in">rm</span> my-network
</code></pre>
<h3 data-id="heading-21">六、Docker 数据持久化</h3>
<h4 data-id="heading-22">6.1 数据卷（Volume）</h4>
<p><strong>特点：</strong></p>
<ul>
<li>由 Docker 管理</li>
<li>存储在 Docker 特定目录</li>
<li>跨平台兼容性好</li>
<li>适合生产环境</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建命名卷</span>
docker volume create my-data

<span class="hljs-comment"># 使用卷</span>
docker run -d -v my-data:/data nginx

<span class="hljs-comment"># 查看卷信息</span>
docker volume inspect my-data

<span class="hljs-comment"># 清理未使用的卷</span>
docker volume prune
</code></pre>
<h4 data-id="heading-23">6.2 挂载目录（Bind Mount）</h4>
<p><strong>特点：</strong></p>
<ul>
<li>直接映射宿主机目录</li>
<li>适合开发环境</li>
<li>可以直接访问文件</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28ad43036a5646b583e120b08776b66a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767489570&amp;x-signature=55UiLPavgvulyjSBfXL2lSnK3dk%3D" alt="docker_storage_comparison.png" loading="lazy"/></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 挂载当前目录</span>
docker run -d -v $(<span class="hljs-built_in">pwd</span>)/html:/usr/share/nginx/html nginx

<span class="hljs-comment"># 只读挂载</span>
docker run -d -v $(<span class="hljs-built_in">pwd</span>)/html:/usr/share/nginx/html:ro nginx
</code></pre>
<h3 data-id="heading-24">七、Docker 网络模式</h3>
<h4 data-id="heading-25">7.1 网络模式类型</h4>






























<table><thead><tr><th>模式</th><th>说明</th><th>使用场景</th></tr></thead><tbody><tr><td>bridge</td><td>默认模式，容器通过虚拟网桥通信</td><td>单机多容器通信</td></tr><tr><td>host</td><td>共享宿主机网络</td><td>高性能需求</td></tr><tr><td>none</td><td>无网络配置</td><td>离线处理任务</td></tr><tr><td>container</td><td>共享其他容器网络</td><td>容器间协作</td></tr></tbody></table>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9706c9ba65d94e3e959d0c8e44eb2e42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767489570&amp;x-signature=%2B1i0xIx%2Bcdyf30sS6Am5qJ5Zl%2FA%3D" alt="docker_network_modes.png" loading="lazy"/></p>
<h4 data-id="heading-26">7.2 网络配置示例</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建自定义网络</span>
docker network create --driver bridge my-network

<span class="hljs-comment"># 运行容器并连接到网络</span>
docker run -d --name web1 --network my-network nginx
docker run -d --name web2 --network my-network nginx

<span class="hljs-comment"># 容器可以通过容器名互相访问</span>
docker <span class="hljs-built_in">exec</span> web1 ping web2
</code></pre>
<h3 data-id="heading-27">八、Docker 安全最佳实践</h3>
<h4 data-id="heading-28">8.1 镜像安全</h4>
<pre><code class="hljs language-dockerfile" lang="dockerfile"># 使用特定版本标签，不使用 latest
FROM python:3.9-slim

# 使用非 root 用户
RUN useradd -m myuser
USER myuser

# 最小化安装
RUN apt-get update &amp;&amp; apt-get install -y --no-install-recommends \
    curl \
    &amp;&amp; rm -rf /var/lib/apt/lists/*

# 扫描镜像漏洞
# docker scan myapp:1.0
</code></pre>
<h4 data-id="heading-29">8.2 运行时安全</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 限制容器资源</span>
docker run -d \
  --memory=<span class="hljs-string">"512m"</span> \
  --cpus=<span class="hljs-string">"1.0"</span> \
  --read-only \
  --security-opt=no-new-privileges \
  nginx

<span class="hljs-comment"># 使用 rootless 模式</span>
<span class="hljs-comment"># 避免 root 用户运行容器</span>
</code></pre>
<h3 data-id="heading-30">九、实战项目：个人博客系统</h3>
<h4 data-id="heading-31">9.1 项目架构</h4>
<p>我们将部署一个完整的博客系统，包含：</p>
<ul>
<li>WordPress（前端）</li>
<li>MySQL（数据库）</li>
<li>Nginx（反向代理）</li>
</ul>
<h4 data-id="heading-32">9.2 docker-compose.yml 配置</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">'3.8'</span>

<span class="hljs-attr">services:</span>
  <span class="hljs-comment"># 数据库服务</span>
  <span class="hljs-attr">database:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">mysql:8.0</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">blog-mysql</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">MYSQL_ROOT_PASSWORD:</span> <span class="hljs-string">rootpassword</span>
      <span class="hljs-attr">MYSQL_DATABASE:</span> <span class="hljs-string">wordpress</span>
      <span class="hljs-attr">MYSQL_USER:</span> <span class="hljs-string">wpuser</span>
      <span class="hljs-attr">MYSQL_PASSWORD:</span> <span class="hljs-string">wppassword</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">db-data:/var/lib/mysql</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">blog-network</span>

  <span class="hljs-comment"># WordPress 服务</span>
  <span class="hljs-attr">wordpress:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">wordpress:latest</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">blog-wordpress</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">database</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">WORDPRESS_DB_HOST:</span> <span class="hljs-string">database:3306</span>
      <span class="hljs-attr">WORDPRESS_DB_USER:</span> <span class="hljs-string">wpuser</span>
      <span class="hljs-attr">WORDPRESS_DB_PASSWORD:</span> <span class="hljs-string">wppassword</span>
      <span class="hljs-attr">WORDPRESS_DB_NAME:</span> <span class="hljs-string">wordpress</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">wp-data:/var/www/html</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"8080:80"</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">blog-network</span>

  <span class="hljs-comment"># phpMyAdmin（可选）</span>
  <span class="hljs-attr">phpmyadmin:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">phpmyadmin/phpmyadmin</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">blog-phpmyadmin</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">database</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">PMA_HOST:</span> <span class="hljs-string">database</span>
      <span class="hljs-attr">PMA_PORT:</span> <span class="hljs-number">3306</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"8081:80"</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">blog-network</span>

<span class="hljs-attr">volumes:</span>
  <span class="hljs-attr">db-data:</span>
  <span class="hljs-attr">wp-data:</span>

<span class="hljs-attr">networks:</span>
  <span class="hljs-attr">blog-network:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">bridge</span>
</code></pre>
<h4 data-id="heading-33">9.3 部署步骤</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 克隆配置文件</span>
<span class="hljs-built_in">mkdir</span> blog &amp;&amp; <span class="hljs-built_in">cd</span> blog

<span class="hljs-comment"># 2. 创建 docker-compose.yml</span>
<span class="hljs-comment"># （将上面的配置保存为 docker-compose.yml）</span>

<span class="hljs-comment"># 3. 启动服务</span>
docker-compose up -d

<span class="hljs-comment"># 4. 查看服务状态</span>
docker-compose ps

<span class="hljs-comment"># 5. 访问博客</span>
<span class="hljs-comment"># 打开浏览器访问 http://localhost:8080</span>
<span class="hljs-comment"># 首次访问会进入 WordPress 安装向导</span>

<span class="hljs-comment"># 6. 访问 phpMyAdmin</span>
<span class="hljs-comment"># http://localhost:8081</span>
<span class="hljs-comment"># 用户名：root</span>
<span class="hljs-comment"># 密码：rootpassword</span>
</code></pre>
<h3 data-id="heading-34">十、Docker 故障排查</h3>
<h4 data-id="heading-35">10.1 常见问题及解决方案</h4>
<p><strong>问题 1：容器无法启动</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看容器日志</span>
docker logs &lt;container-id&gt;

<span class="hljs-comment"># 查看容器详情</span>
docker inspect &lt;container-id&gt;

<span class="hljs-comment"># 尝试交互式运行</span>
docker run -it &lt;image&gt; /bin/bash
</code></pre>
<p><strong>问题 2：端口冲突</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看端口占用</span>
netstat -tunlp | grep &lt;port&gt;

<span class="hljs-comment"># 更改端口映射</span>
docker run -p 8081:80 nginx  <span class="hljs-comment"># 使用其他端口</span>
</code></pre>
<p><strong>问题 3：磁盘空间不足</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 清理未使用的镜像</span>
docker image prune -a

<span class="hljs-comment"># 清理未使用的容器</span>
docker container prune

<span class="hljs-comment"># 清理未使用的卷</span>
docker volume prune

<span class="hljs-comment"># 一键清理</span>
docker system prune -a --volumes
</code></pre>
<p><strong>问题 4：网络连接问题</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查网络配置</span>
docker network inspect &lt;network-name&gt;

<span class="hljs-comment"># 重建网络</span>
docker network <span class="hljs-built_in">rm</span> &lt;network-name&gt;
docker network create &lt;network-name&gt;
</code></pre>
<h4 data-id="heading-36">10.2 调试技巧</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看容器资源使用情况</span>
docker stats

<span class="hljs-comment"># 查看容器进程</span>
docker top &lt;container-id&gt;

<span class="hljs-comment"># 实时查看日志</span>
docker logs -f --<span class="hljs-built_in">tail</span> 100 &lt;container-id&gt;

<span class="hljs-comment"># 导出容器文件系统</span>
docker <span class="hljs-built_in">export</span> &lt;container-id&gt; &gt; container.tar
</code></pre>
<h3 data-id="heading-37">十一、总结</h3>
<p>Docker 作为容器化技术的代表，已经彻底改变了软件开发和部署的方式。通过本文的学习，你已经掌握了：</p>
<p>✅ Docker 的核心概念（镜像、容器、仓库）
✅ Docker 的安装方法
✅ 常用命令的使用
✅ Dockerfile 的编写技巧
✅ 数据持久化和网络配置
✅ 实战项目部署经验</p>
<p>记住：<strong>Docker 的学习曲线不算陡峭，关键在于多动手实践</strong>。每一个命令、每一个配置，都需要在实战中才能真正理解和掌握。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot 整合 Nacos，让微服务像外卖点单一样简单]]></title>    <link>https://juejin.cn/post/7588095884070338560</link>    <guid>https://juejin.cn/post/7588095884070338560</guid>    <pubDate>2025-12-28T02:31:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588095884070338560" data-draft-id="7588092534162423808" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot 整合 Nacos，让微服务像外卖点单一样简单"/> <meta itemprop="keywords" content="后端,Java,Spring Boot"/> <meta itemprop="datePublished" content="2025-12-28T02:31:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="悟空码字"/> <meta itemprop="url" content="https://juejin.cn/user/3139860942296830"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot 整合 Nacos，让微服务像外卖点单一样简单
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3139860942296830/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    悟空码字
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T02:31:25.000Z" title="Sun Dec 28 2025 02:31:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是小悟。</p>
<h2 data-id="heading-0">🤔 Nacos 是什么？让我们用外卖来理解！</h2>
<p>假如你是个吃货（程序员），在美食广场（微服务架构）里：</p>
<p><strong>没有 Nacos 的情况：</strong></p>
<ul>
<li>"老板，红烧肉在哪家店？" "不知道"</li>
<li>"奶茶店电话多少？" "我找找小纸条..."</li>
<li>"这家店搬走了？怎么不告诉我！"</li>
</ul>
<p><strong>有了 Nacos 的情况：</strong></p>
<ul>
<li>Nacos 就像美食广场的<strong>智能大屏幕 + 广播系统</strong></li>
<li>所有店铺（服务）自动登记："我是卖奶茶的，位置在A区3号"</li>
<li>想喝奶茶？看屏幕（服务发现）直接去</li>
<li>店铺打烊？自动广播（服务下线）通知大家</li>
<li>还能告诉你："今天奶茶半价！"（配置管理）</li>
</ul>
<p>简单说，<strong>Nacos = 服务注册中心 + 配置中心</strong>，微服务的"居委会大妈"——啥都知道，啥都管！</p>
<hr/>
<h2 data-id="heading-1">🚀 整合步骤：让我们开始"组装"吧！</h2>
<h3 data-id="heading-2">第1步：先来点"开胃菜"——环境准备</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 安装Nacos（比泡面还简单）</span>
<span class="hljs-comment"># 下载地址：https://github.com/alibaba/nacos/releases</span>
<span class="hljs-comment"># 解压后，单机模式启动：</span>
sh nacos/bin/startup.sh -m standalone  <span class="hljs-comment"># Linux/Mac</span>
cmd nacos/bin/startup.cmd -m standalone  <span class="hljs-comment"># Windows</span>

<span class="hljs-comment"># 访问 http://localhost:8848/nacos</span>
<span class="hljs-comment"># 账号/密码：nacos/nacos</span>
<span class="hljs-comment"># 看到登录页面？恭喜！Nacos启动成功！</span>
</code></pre>
<h3 data-id="heading-3">第2步：创建SpringBoot项目（我们的"美食摊位"）</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- pom.xml 添加这些依赖（我们的"食材清单"）--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- SpringBoot基础套餐 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- Nacos服务发现（找店铺功能） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2021.0.5.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- Nacos配置中心（看菜单功能） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2021.0.5.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 健康检查（看看摊位还营业吗） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-4">第3步：配置文件（我们的"摊位装修方案"）</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># bootstrap.yml（优先级高，先加载）</span>
<span class="hljs-comment"># 这个文件专门用来和Nacos"打招呼"</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">foodie-service</span>  <span class="hljs-comment"># 给服务起个名，我是"吃货服务"</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">nacos:</span>
      <span class="hljs-attr">discovery:</span>
        <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span>  <span class="hljs-comment"># Nacos居委会地址</span>
        <span class="hljs-attr">group:</span> <span class="hljs-string">DEFAULT_GROUP</span>         <span class="hljs-comment"># 默认分组（就像"中餐区"）</span>
        <span class="hljs-attr">namespace:</span> <span class="hljs-string">public</span>            <span class="hljs-comment"># 命名空间（"美食广场一楼"）</span>
        <span class="hljs-attr">ephemeral:</span> <span class="hljs-literal">true</span>              <span class="hljs-comment"># 临时实例（摆摊的，随时可能收摊）</span>
        
      <span class="hljs-attr">config:</span>
        <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span>  <span class="hljs-comment"># 配置中心也找同一个Nacos</span>
        <span class="hljs-attr">file-extension:</span> <span class="hljs-string">yaml</span>         <span class="hljs-comment"># 配置格式用yaml（菜单用中文写）</span>
        <span class="hljs-attr">group:</span> <span class="hljs-string">DEFAULT_GROUP</span>
        <span class="hljs-attr">namespace:</span> <span class="hljs-string">public</span>
        <span class="hljs-attr">refresh-enabled:</span> <span class="hljs-literal">true</span>        <span class="hljs-comment"># 动态刷新（菜单改了马上知道）</span>
        
  <span class="hljs-attr">config:</span>
    <span class="hljs-attr">import:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">optional:nacos:${spring.application.name}.${spring.cloud.nacos.config.file-extension}</span>
      <span class="hljs-comment"># 这句话意思是："Nacos大妈，我要读取我的配置文件！"</span>

<span class="hljs-comment"># application.yml（常规配置）</span>
<span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>  <span class="hljs-comment"># 我的摊位在8080号位置</span>

<span class="hljs-attr">management:</span>
  <span class="hljs-attr">endpoints:</span>
    <span class="hljs-attr">web:</span>
      <span class="hljs-attr">exposure:</span>
        <span class="hljs-attr">include:</span> <span class="hljs-string">"*"</span>  <span class="hljs-comment"># 暴露健康检查端点（告诉大家我还活着）</span>
</code></pre>
<h3 data-id="heading-5">第4步：主启动类（"摊位开张仪式"）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;
<span class="hljs-keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;

<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableDiscoveryClient  // 开启服务发现（举起牌子：<span class="hljs-string">"我开张啦！"</span>）</span>
public <span class="hljs-keyword">class</span> <span class="hljs-title class_">FoodieApplication</span> {
    public static void main(String[] args) {
        SpringApplication.run(FoodieApplication.<span class="hljs-keyword">class</span>, args);
        System.out.println(<span class="hljs-string">"""
            🎉 吃货服务启动成功！
            📍 摊位号：8080
            📢 已向Nacos居委会登记
            🍔 开始营业！
            """</span>);
    }
}
</code></pre>
<h3 data-id="heading-6">第5步：写个Controller（"制作美食"）</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> org.springframework.beans.factory.<span class="hljs-keyword">annotation</span>.Value;
<span class="hljs-keyword">import</span> org.springframework.cloud.context.config.<span class="hljs-keyword">annotation</span>.RefreshScope;
<span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.GetMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.RestController;

<span class="hljs-keyword">import</span> javax.<span class="hljs-keyword">annotation</span>.PostConstruct;

<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RefreshScope</span>  <span class="hljs-comment">// 这个注解让配置动态刷新（菜单改了立即生效）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FoodController</span> {
    
    <span class="hljs-meta">@Value(<span class="hljs-string">"<span class="hljs-subst">${food.special:红烧肉}</span>"</span>)</span>  <span class="hljs-comment">// 默认值红烧肉</span>
    <span class="hljs-keyword">private</span> String specialFood;
    
    <span class="hljs-meta">@Value(<span class="hljs-string">"<span class="hljs-subst">${food.price:<span class="hljs-number">25</span>}</span>"</span>)</span>
    <span class="hljs-keyword">private</span> Integer price;
    
    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> void <span class="hljs-keyword">init</span>() {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"今日特价："</span> + specialFood + <span class="hljs-string">"，仅售"</span> + price + <span class="hljs-string">"元！"</span>);
    }
    
    <span class="hljs-meta">@GetMapping(<span class="hljs-string">"/order"</span>)</span>
    <span class="hljs-keyword">public</span> String order() {
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"""
            🍽️ 订单详情：
            菜品：%s
            价格：%d元
            制作中...请稍候！
            （本消息来自服务：%s）
            """</span>, specialFood, price, <span class="hljs-string">"吃货服务"</span>);
    }
    
    <span class="hljs-meta">@GetMapping(<span class="hljs-string">"/health"</span>)</span>
    <span class="hljs-keyword">public</span> String health() {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"✅ 本摊位营业中，欢迎光临！"</span>;
    }
}
</code></pre>
<h3 data-id="heading-7">第6步：在Nacos添加配置（"制作菜单"）</h3>
<ol>
<li>访问 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8848%2Fnacos" target="_blank" title="http://localhost:8848/nacos" ref="nofollow noopener noreferrer">http://localhost:8848/nacos</a></li>
<li>进入 <strong>配置管理 → 配置列表</strong></li>
<li>点击 <strong>+</strong> 新建配置：</li>
</ol>

<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">Data ID:</span> <span class="hljs-string">foodie-service.yaml</span>  <span class="hljs-comment"># 必须和bootstrap.yml里的一致</span>
<span class="hljs-attr">Group:</span> <span class="hljs-string">DEFAULT_GROUP</span>
<span class="hljs-string">配置格式:</span> <span class="hljs-string">YAML</span>
<span class="hljs-string">配置内容:</span>
<span class="hljs-attr">food:</span>
  <span class="hljs-attr">special:</span> <span class="hljs-string">"麻辣小龙虾"</span>  <span class="hljs-comment"># 今日特价菜</span>
  <span class="hljs-attr">price:</span> <span class="hljs-number">88</span>             <span class="hljs-comment"># 特价</span>
  <span class="hljs-attr">discount:</span> <span class="hljs-string">"8折"</span>       <span class="hljs-comment"># 折扣信息</span>

<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">profiles:</span>
    <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span>        <span class="hljs-comment"># 环境配置</span>
</code></pre>
<h3 data-id="heading-8">第7步：测试一下（"顾客点单"）</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 启动SpringBoot应用</span>
<span class="hljs-comment"># 2. 查看Nacos控制台 - 服务管理 - 服务列表</span>
<span class="hljs-comment">#    应该能看到 foodie-service，状态为"健康"</span>
<span class="hljs-comment"># 3. 访问测试：</span>
curl http://localhost:8080/order

<span class="hljs-comment"># 输出应该显示"麻辣小龙虾"，价格88元</span>
<span class="hljs-comment"># 而不是默认的红烧肉25元！</span>

<span class="hljs-comment"># 4. 动态刷新测试：</span>
<span class="hljs-comment">#    去Nacos修改配置，把price改成66</span>
<span class="hljs-comment">#    不用重启服务，直接再次访问：</span>
curl http://localhost:8080/order
<span class="hljs-comment">#    价格已经变成66了！神奇吧？</span>
</code></pre>
<h3 data-id="heading-9">第8步：服务发现（"找其他摊位"）</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> org.springframework.beans.factory.<span class="hljs-keyword">annotation</span>.Autowired;
<span class="hljs-keyword">import</span> org.springframework.cloud.client.discovery.DiscoveryClient;
<span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.GetMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.RestController;
<span class="hljs-keyword">import</span> org.springframework.web.client.RestTemplate;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FindRestaurantController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> DiscoveryClient discoveryClient;
    
    <span class="hljs-meta">@GetMapping(<span class="hljs-string">"/find/drinks"</span>)</span>
    <span class="hljs-keyword">public</span> String findDrinkShop() {
        <span class="hljs-comment">// 发现所有服务</span>
        List&lt;String&gt; services = discoveryClient.getServices();
        
        <span class="hljs-comment">// 过滤出饮料相关的服务（实际项目会用更复杂的逻辑）</span>
        List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="hljs-string">"drink-service"</span>);
        
        <span class="hljs-keyword">if</span> (!instances.isEmpty()) {
            String url = instances.<span class="hljs-keyword">get</span>(<span class="hljs-number">0</span>).getUri() + <span class="hljs-string">"/menu"</span>;
            <span class="hljs-keyword">return</span> new RestTemplate().getForObject(url, String.<span class="hljs-keyword">class</span>);
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-string">"没有找到饮料店，Nacos居委会也不知道在哪😢"</span>;
    }
}
</code></pre>
<h2 data-id="heading-10">🎯 高级玩法</h2>
<h3 data-id="heading-11">多环境配置（"分楼层经营"）</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># Nacos中可以创建不同命名空间</span>
<span class="hljs-comment"># 1. 命名空间管理 → 新建命名空间</span>
<span class="hljs-comment">#    dev: 开发环境（一楼试营业）</span>
<span class="hljs-comment">#    test: 测试环境（二楼内测）</span>
<span class="hljs-comment">#    prod: 生产环境（三楼正式营业）</span>

<span class="hljs-comment"># bootstrap.yml 切换环境：</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">nacos:</span>
      <span class="hljs-attr">config:</span>
        <span class="hljs-attr">namespace:</span> <span class="hljs-string">dev-id</span>  <span class="hljs-comment"># 填Nacos生成的命名空间ID</span>
</code></pre>
<h3 data-id="heading-12">配置共享（"通用调料配方"）</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 在Nacos创建 Data ID: common.yaml</span>
<span class="hljs-comment"># 所有服务都可以读取这个公共配置</span>

<span class="hljs-comment"># 服务配置里可以这样用：</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">nacos:</span>
      <span class="hljs-attr">config:</span>
        <span class="hljs-attr">shared-configs:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">data-id:</span> <span class="hljs-string">common.yaml</span>
            <span class="hljs-attr">group:</span> <span class="hljs-string">DEFAULT_GROUP</span>
            <span class="hljs-attr">refresh:</span> <span class="hljs-literal">true</span>
</code></pre>
<h2 data-id="heading-13">📝 总结：Nacos带给我们的"美食体验"</h2>
<h3 data-id="heading-14">优点（"为什么选择这个美食广场"）：</h3>
<ol>
<li><strong>一站式服务</strong>：服务注册、配置管理、服务发现全搞定，不用东奔西跑</li>
<li><strong>动态刷新</strong>：改配置不用重启服务，就像换菜单不用关店</li>
<li><strong>健康检查</strong>：自动剔除"不营业的摊位"，保证你总能吃到新鲜热乎的</li>
<li><strong>多环境支持</strong>：开发、测试、生产环境完美隔离，不会把"试吃品"端给顾客</li>
<li><strong>易于使用</strong>：控制台友好，API丰富，中文文档齐全（阿里出品，必属精品）</li>
</ol>
<h3 data-id="heading-15">注意事项（"经营须知"）：</h3>
<ol>
<li><strong>网络稳定</strong>：Nacos挂了，服务就"失联"了，确保高可用部署</li>
<li><strong>权限管理</strong>：生产环境一定要配置权限，别让路人随便改"菜单"</li>
<li><strong>配置规范</strong>：命名规范要统一，不然找配置像"海底捞针"</li>
<li><strong>版本兼容</strong>：SpringCloud Alibaba版本要和SpringBoot版本匹配，不然会"食物相克"</li>
</ol>
<h3 data-id="heading-16">最后：</h3>
<blockquote>
<p>问：为什么程序员喜欢用Nacos？
答：因为他们再也不用在代码里写死配置了，现在可以理直气壮地说："这个配置Nacos管，我不知道！"</p>
</blockquote>
<blockquote>
<p>问：Nacos和Eureka有什么区别？
答：Eureka像老式电话本，Nacos像智能手机通讯录——还能视频通话（动态刷新）！</p>
</blockquote>
<h2 data-id="heading-17">🏁 建议</h2>
<p>SpringBoot整合Nacos就像给大排档装上智能点餐系统：</p>
<ul>
<li><strong>简单</strong>：几行配置就搞定</li>
<li><strong>强大</strong>：功能丰富，满足各种需求</li>
<li><strong>稳定</strong>：经过阿里大规模生产验证</li>
<li><strong>活跃</strong>：社区活跃，更新及时</li>
</ul>
<p>现在可以试试，让你的微服务像外卖一样：<strong>随时点单，准时送达，还能实时跟踪进度！</strong> 🚚💨</p>
<p>好的架构师就像好的厨师：不仅要会做菜，还要懂得如何高效管理厨房！Nacos就是你的"智能厨房管理系统"！👨‍🍳👩‍🍳</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82cbe0a7770841318211e7caa65ea9eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf56m656CB5a2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767493885&amp;x-signature=pa6mxtBf%2FAEqH0efEmLpcN88dbQ%3D" alt="SpringBoot 整合 Nacos，让微服务像外卖点单一样简单.png" loading="lazy"/></p>
<p><strong>谢谢你看我的文章，既然看到这里了，如果觉得不错，随手点个赞、转发、在看三连吧，感谢感谢。那我们，下次再见。</strong></p>
<p>您的一键三连，是我更新的最大动力，谢谢</p>
<p>山水有相逢，来日皆可期，谢谢阅读，我们再会</p>
<p>我手中的金箍棒，上能通天，下能探海</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vuex 详解：现代 Vue.js 应用的状态管理方案]]></title>    <link>https://juejin.cn/post/7588043318359785507</link>    <guid>https://juejin.cn/post/7588043318359785507</guid>    <pubDate>2025-12-27T16:09:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588043318359785507" data-draft-id="7588043318359769123" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vuex 详解：现代 Vue.js 应用的状态管理方案"/> <meta itemprop="keywords" content="前端,Vue.js,前端框架"/> <meta itemprop="datePublished" content="2025-12-27T16:09:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="进击的野人"/> <meta itemprop="url" content="https://juejin.cn/user/1458425238667008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vuex 详解：现代 Vue.js 应用的状态管理方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1458425238667008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    进击的野人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T16:09:07.000Z" title="Sat Dec 27 2025 16:09:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在现代前端应用开发中，随着应用复杂度的不断提升，组件间的数据共享和状态管理变得越来越重要。Vuex 作为 Vue.js 官方推荐的状态管理库，为 Vue 应用提供了一种集中式、可预测的状态管理模式。本文将结合提供的代码实例，深入探讨 Vuex 的核心概念、工作原理以及实际应用。</p>
<h2 data-id="heading-1">一、Vuex 的基本概念</h2>
<p>Vuex 是一个专门为 Vue.js 应用程序开发的<strong>状态管理模式 + 库</strong>。它采用集中式存储管理应用的所有组件的状态，并以相应的规则保证状态以一种可预测的方式发生变化。</p>
<h3 data-id="heading-2">1.1 为什么需要 Vuex？</h3>
<p>从提供的代码中可以看到，我们有两个组件 <code>MyCount</code> 和 <code>MyPersons</code>，它们都需要访问和修改共享的状态数据：</p>
<ul>
<li><code>MyCount</code> 组件需要访问和修改 <code>sum</code>（求和值）</li>
<li><code>MyPersons</code> 组件需要访问和修改 <code>persons</code>（人员列表）</li>
<li>两个组件都需要相互访问对方的状态数据</li>
</ul>
<p>如果没有 Vuex，这种跨组件的数据共享需要通过复杂的父子组件传值或事件总线来实现，随着应用规模扩大，代码将变得难以维护。Vuex 通过提供一个全局的单例状态树，优雅地解决了这个问题。</p>
<h3 data-id="heading-3">1.2 Vuex 的核心概念</h3>
<p>从 <code>index.js</code> 文件中可以看到，Vuex 包含以下几个核心部分：</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">new</span> Vuex.<span class="hljs-built_in">Store</span>({
  actions,
  mutations,
  state,
  getters
})
</code></pre>
<p><strong>State（状态）</strong> ：应用的单一状态树，包含所有需要共享的数据。</p>
<p><strong>Mutations（变更）</strong> ：唯一更改状态的方法，必须是同步函数。</p>
<p><strong>Actions（动作）</strong> ：提交 mutations，可以包含任意异步操作。</p>
<p><strong>Getters（获取器）</strong> ：从 state 中派生出一些状态，类似于计算属性。</p>
<h2 data-id="heading-4">二、Vuex 的基本使用</h2>
<h3 data-id="heading-5">2.1 初始化与配置</h3>
<p>首先需要在项目中安装和配置 Vuex：</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Vuex</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vuex'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 使用插件</span>
<span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">Vuex</span>)

<span class="hljs-keyword">const</span> store = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vuex</span>.<span class="hljs-title class_">Store</span>({
  <span class="hljs-comment">// 配置项</span>
})
</code></pre>
<h3 data-id="heading-6">2.2 组件中访问状态</h3>
<p>在组件中，可以通过 <code>$store</code> 访问 Vuex 的状态：</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在计算属性中直接访问</span>
<span class="hljs-attr">computed</span>: {
  <span class="hljs-title function_">persons</span>(<span class="hljs-params"/>){
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$store</span>.<span class="hljs-property">state</span>.<span class="hljs-property">persons</span>
  },
  <span class="hljs-title function_">sum</span>(<span class="hljs-params"/>){
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$store</span>.<span class="hljs-property">state</span>.<span class="hljs-property">sum</span>
  }
}
</code></pre>
<h3 data-id="heading-7">2.3 组件中修改状态</h3>
<p>修改状态有两种方式：</p>
<p><strong>方式一：通过 actions（可包含异步操作）</strong></p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">methods</span>: {
  <span class="hljs-title function_">incrementOdd</span>(<span class="hljs-params"/>){
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$store</span>.<span class="hljs-title function_">dispatch</span>(<span class="hljs-string">'jiaOdd'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">n</span>)
  }
}
</code></pre>
<p><strong>方式二：直接提交 mutations（同步操作）</strong></p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">methods</span>: {
  <span class="hljs-title function_">add</span>(<span class="hljs-params"/>){
    <span class="hljs-keyword">const</span> personObj = {<span class="hljs-attr">id</span>:<span class="hljs-title function_">nanoid</span>(), <span class="hljs-attr">name</span>:<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>};
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$store</span>.<span class="hljs-title function_">commit</span>(<span class="hljs-string">'ADD_PERSON'</span>, personObj)
  }
}
</code></pre>
<h2 data-id="heading-8">三、四个 Map 辅助函数的使用</h2>
<p>为了简化代码，Vuex 提供了四个辅助函数：</p>
<h3 data-id="heading-9">3.1 mapState</h3>
<p>将 state 映射为组件的计算属性：</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 数组写法（简写）</span>
...<span class="hljs-title function_ invoke__">mapState</span>([<span class="hljs-string">'sum'</span>, <span class="hljs-string">'persons'</span>])

<span class="hljs-comment">// 对象写法（可重命名）</span>
...<span class="hljs-title function_ invoke__">mapState</span>({<span class="hljs-attr">currentSum</span>: <span class="hljs-string">'sum'</span>, <span class="hljs-attr">personList</span>: <span class="hljs-string">'persons'</span>})
</code></pre>
<h3 data-id="heading-10">3.2 mapGetters</h3>
<p>将 getters 映射为组件的计算属性：</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-css" lang="css">..<span class="hljs-selector-class">.mapGetters</span>(<span class="hljs-selector-attr">[<span class="hljs-string">'bigSum'</span>]</span>)
</code></pre>
<h3 data-id="heading-11">3.3 mapMutations</h3>
<p>将 mutations 映射为组件的方法：</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 对象写法</span>
...<span class="hljs-title function_ invoke__">mapMutations</span>({<span class="hljs-attr">increment</span>: <span class="hljs-string">'JIA'</span>, <span class="hljs-attr">decrement</span>: <span class="hljs-string">'JIAN'</span>}),

<span class="hljs-comment">// 数组写法</span>
...<span class="hljs-title function_ invoke__">mapMutations</span>([<span class="hljs-string">'JIA'</span>, <span class="hljs-string">'JIAN'</span>])
</code></pre>
<h3 data-id="heading-12">3.4 mapActions</h3>
<p>将 actions 映射为组件的方法：</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-php" lang="php">...<span class="hljs-title function_ invoke__">mapActions</span>({<span class="hljs-attr">incrementOdd</span>: <span class="hljs-string">'jiaOdd'</span>, <span class="hljs-attr">incrementWait</span>: <span class="hljs-string">'jiaWait'</span>})
</code></pre>
<h2 data-id="heading-13">四、Vuex 模块化与命名空间</h2>
<p>随着应用规模扩大，将所有状态集中在一个文件中会变得难以维护。Vuex 允许我们将 store 分割成模块，每个模块拥有自己的 state、mutations、actions、getters。</p>
<h3 data-id="heading-14">4.1 模块化配置</h3>
<p>从重构后的代码可以看到，我们将 store 拆分成了两个模块：</p>
<p><strong>count.js</strong> - 处理计数相关的状态<br/>
<strong>person.js</strong> - 处理人员相关的状态</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// index.js</span>
<span class="hljs-keyword">import</span> countAbout <span class="hljs-keyword">from</span> <span class="hljs-string">'./count'</span>
<span class="hljs-keyword">import</span> personAbout <span class="hljs-keyword">from</span> <span class="hljs-string">'./person'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vuex</span>.<span class="hljs-title class_">Store</span>({
  <span class="hljs-attr">modules</span>: {
    countAbout,
    personAbout
  }
})
</code></pre>
<h3 data-id="heading-15">4.2 命名空间</h3>
<p>通过设置 <code>namespaced: true</code> 开启命名空间，可以避免不同模块之间的命名冲突：</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// count.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  namespaced: <span class="hljs-literal">true</span>,
  <span class="hljs-comment">// ... 其他配置</span>
}
</code></pre>
<h3 data-id="heading-16">4.3 模块化后的访问方式</h3>
<p><strong>访问 state：</strong></p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 直接访问</span>
<span class="hljs-title function_">persons</span>(<span class="hljs-params"/>){
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$store</span>.<span class="hljs-property">state</span>.<span class="hljs-property">personAbout</span>.<span class="hljs-property">persons</span>
}

<span class="hljs-comment">// 使用 mapState（需要指定命名空间）</span>
...<span class="hljs-title function_">mapState</span>(<span class="hljs-string">'personAbout'</span>, [<span class="hljs-string">'persons'</span>])
</code></pre>
<p><strong>访问 getters：</strong></p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 直接访问</span>
<span class="hljs-title function_">firstPersonName</span>(<span class="hljs-params"/>){
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$store</span>.<span class="hljs-property">getters</span>[<span class="hljs-string">'personAbout/firstPersonName'</span>];
}

<span class="hljs-comment">// 使用 mapGetters</span>
...<span class="hljs-title function_">mapGetters</span>(<span class="hljs-string">'personAbout'</span>, [<span class="hljs-string">'firstPersonName'</span>])
</code></pre>
<p><strong>提交 mutations：</strong></p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 直接提交</span>
this.<span class="hljs-variable">$store</span>.<span class="hljs-title function_ invoke__">commit</span>(<span class="hljs-string">'personAbout/ADD_PERSON'</span>, personObj);

<span class="hljs-comment">// 使用 mapMutations</span>
...<span class="hljs-title function_ invoke__">mapMutations</span>(<span class="hljs-string">'countAbout'</span>, {<span class="hljs-attr">increment</span>: <span class="hljs-string">'JIA'</span>, <span class="hljs-attr">decrement</span>: <span class="hljs-string">'JIAN'</span>})
</code></pre>
<p><strong>分发 actions：</strong></p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 直接分发</span>
this.<span class="hljs-variable">$store</span>.<span class="hljs-title function_ invoke__">dispatch</span>(<span class="hljs-string">'personAbout/addWangPerson'</span>, personObj);

<span class="hljs-comment">// 使用 mapActions</span>
...<span class="hljs-title function_ invoke__">mapActions</span>(<span class="hljs-string">'countAbout'</span>, {<span class="hljs-attr">incrementOdd</span>: <span class="hljs-string">'jiaOdd'</span>, <span class="hljs-attr">incrementWait</span>: <span class="hljs-string">'jiaWait'</span>})
</code></pre>
<h2 data-id="heading-17">五、实际应用案例分析</h2>
<h3 data-id="heading-18">5.1 计数器模块（count.js）</h3>
<p>这个模块展示了如何处理同步和异步的状态更新：</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 同步操作</span>
<span class="hljs-title function_">JIA</span>(<span class="hljs-params">state, value</span>) {
  state.<span class="hljs-property">sum</span> += value;
},

<span class="hljs-comment">// 异步操作（通过 action）</span>
<span class="hljs-title function_">jiaWait</span>(<span class="hljs-params">context, value</span>) {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    context.<span class="hljs-title function_">commit</span>(<span class="hljs-string">'JIAWAIT'</span>, value);
  }, <span class="hljs-number">500</span>);
}
</code></pre>
<h3 data-id="heading-19">5.2 人员管理模块（person.js）</h3>
<p>这个模块展示了更复杂的业务逻辑：</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 条件性提交 mutation</span>
<span class="hljs-title function_">addWangPerson</span>(<span class="hljs-params">context, value</span>) {
  <span class="hljs-keyword">if</span> (value.<span class="hljs-property">name</span>.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'王'</span>) === <span class="hljs-number">0</span>) {
    context.<span class="hljs-title function_">commit</span>(<span class="hljs-string">'ADD_PERSON'</span>, value);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-title function_">alert</span>(<span class="hljs-string">'添加的人必须姓王！'</span>);
  }
},

<span class="hljs-comment">// 异步 API 调用</span>
<span class="hljs-title function_">addServer</span>(<span class="hljs-params">context</span>) {
  axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">'https://api.uixsj.cn/hitokoto/get?type=social'</span>).<span class="hljs-title function_">then</span>(
    <span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> word = {<span class="hljs-attr">id</span>: <span class="hljs-title function_">nanoid</span>(), <span class="hljs-attr">name</span>: response.<span class="hljs-property">data</span>};
      context.<span class="hljs-title function_">commit</span>(<span class="hljs-string">'ADD_PERSON'</span>, word);
    },
    <span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
      <span class="hljs-title function_">alert</span>(error.<span class="hljs-property">message</span>);
    }
  )
}
</code></pre>
<h2 data-id="heading-20">六、Vuex 的最佳实践</h2>
<h3 data-id="heading-21">6.1 严格遵循数据流</h3>
<p>Vuex 强制实施一种单向数据流：</p>
<ol>
<li>组件派发 Action</li>
<li>Action 提交 Mutation</li>
<li>Mutation 修改 State</li>
<li>State 变化触发组件更新</li>
</ol>
<h3 data-id="heading-22">6.2 合理使用模块化</h3>
<ul>
<li>按功能或业务逻辑划分模块</li>
<li>为所有模块启用命名空间</li>
<li>保持模块的独立性</li>
</ul>
<h3 data-id="heading-23">6.3 异步操作的处理</h3>
<ul>
<li>所有异步逻辑放在 Actions 中</li>
<li>保持 Mutations 的纯粹性（只做状态变更）</li>
<li>合理处理异步错误</li>
</ul>
<h3 data-id="heading-24">6.4 表单处理策略</h3>
<p>在 <code>MyPersons.vue</code> 中，我们看到了典型的表单处理模式：</p>
<p>javascript</p>
<p>复制下载</p>
<pre><code class="hljs language-kotlin" lang="kotlin">add(){
  <span class="hljs-keyword">const</span> personObj = {id: nanoid(), name: <span class="hljs-keyword">this</span>.name};
  <span class="hljs-keyword">this</span>.$store.commit(<span class="hljs-string">'personAbout/ADD_PERSON'</span>, personObj);
  <span class="hljs-keyword">this</span>.name = <span class="hljs-string">''</span>; <span class="hljs-comment">// 清空表单</span>
}
</code></pre>
<h2 data-id="heading-25">七、Vuex 的优缺点分析</h2>
<h3 data-id="heading-26">7.1 优点</h3>
<ol>
<li><strong>集中式状态管理</strong>：所有状态变化都可以追踪和调试</li>
<li><strong>组件通信简化</strong>：跨组件数据共享变得简单</li>
<li><strong>可预测的状态变化</strong>：通过严格的规则保证状态变化的可预测性</li>
<li><strong>插件生态丰富</strong>：支持时间旅行、状态快照等高级功能</li>
<li><strong>TypeScript 支持</strong>：提供完整的类型定义</li>
</ol>
<h3 data-id="heading-27">7.2 缺点</h3>
<ol>
<li><strong>学习曲线</strong>：需要理解 Flux 架构思想</li>
<li><strong>代码冗余</strong>：简单的应用可能不需要 Vuex</li>
<li><strong>样板代码</strong>：需要编写一定量的模板代码</li>
<li><strong>性能考虑</strong>：大型状态树可能影响性能</li>
</ol>
<h2 data-id="heading-28">八、替代方案与未来趋势</h2>
<h3 data-id="heading-29">8.1 Vuex 的替代方案</h3>
<ol>
<li><strong>Pinia</strong>：Vue.js 的下一代状态管理库，更加轻量且对 TypeScript 友好</li>
<li><strong>Composition API</strong>：使用 <code>reactive</code> 和 <code>provide/inject</code> 实现简单的状态共享</li>
<li><strong>事件总线</strong>：适合小型应用的简单通信</li>
</ol>
<h3 data-id="heading-30">8.2 Vuex 4 和 Vuex 5</h3>
<ul>
<li>Vuex 4 支持 Vue 3，API 基本保持不变</li>
<li>Vuex 5（开发中）将提供更好的 TypeScript 支持和更简洁的 API</li>
</ul>
<h2 data-id="heading-31">结论</h2>
<p>Vuex 作为 Vue.js 生态中成熟的状态管理方案，为构建中大型 Vue 应用提供了可靠的架构基础。通过本文的分析，我们可以看到 Vuex 如何：</p>
<ol>
<li>提供集中式的状态管理</li>
<li>通过严格的规则保证状态变化的可预测性</li>
<li>通过模块化支持大型应用的状态管理</li>
<li>提供丰富的辅助函数简化开发</li>
</ol>
<p>在实际项目中，是否使用 Vuex 应该根据应用规模和复杂度来决定。对于小型应用，简单的组件通信可能就足够了；但对于中大型应用，Vuex 提供的结构化状态管理方案将大大提升代码的可维护性和可扩展性。</p>
<p>随着 Vue 3 的普及，开发者也可以考虑使用 Composition API 或 Pinia 等更现代的解决方案，但 Vuex 的核心思想和设计模式仍然是值得学习和借鉴的宝贵经验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Single-SPA 学习总结]]></title>    <link>https://juejin.cn/post/7588084804093935654</link>    <guid>https://juejin.cn/post/7588084804093935654</guid>    <pubDate>2025-12-28T02:22:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588084804093935654" data-draft-id="7588139768275124275" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Single-SPA 学习总结"/> <meta itemprop="keywords" content="前端,JavaScript,微服务"/> <meta itemprop="datePublished" content="2025-12-28T02:22:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹏北海"/> <meta itemprop="url" content="https://juejin.cn/user/1425415102792237"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Single-SPA 学习总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1425415102792237/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹏北海
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T02:22:18.000Z" title="Sun Dec 28 2025 02:22:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><h2 data-id="heading-0">一、什么是 Single-SPA</h2>
<p>Single-SPA 是微前端领域的"鼻祖"框架，它是一个用于前端微服务化的 JavaScript 框架，允许你在同一个页面中使用多个框架（React、Vue、Angular 等），而不需要刷新页面。</p>
<h3 data-id="heading-1">核心定位</h3>
<ul>
<li><strong>JS Entry 方案</strong>：通过加载子应用的 JS 入口文件来集成</li>
<li><strong>路由驱动</strong>：基于 URL 变化自动激活/卸载子应用</li>
<li><strong>框架无关</strong>：支持任意前端框架，只要导出生命周期函数</li>
</ul>
<hr/>
<h2 data-id="heading-2">二、核心概念</h2>
<h3 data-id="heading-3">1. 三种模块类型</h3>





























<table><thead><tr><th>类型</th><th>说明</th><th>生命周期</th><th>使用场景</th></tr></thead><tbody><tr><td><strong>Application</strong></td><td>有 UI 的微前端应用</td><td>bootstrap → mount → unmount</td><td>独立页面/功能模块</td></tr><tr><td><strong>Parcel</strong></td><td>可复用的 UI 组件</td><td>手动挂载/卸载</td><td>跨应用共享组件</td></tr><tr><td><strong>Utility</strong></td><td>无 UI 的共享模块</td><td>无</td><td>工具函数、API 封装、状态管理</td></tr></tbody></table>
<h3 data-id="heading-4">2. 生命周期函数</h3>
<p>每个 Application 必须导出三个生命周期函数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 应用首次加载时调用（只执行一次）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"应用初始化"</span>);
}

<span class="hljs-comment">// 路由匹配时调用（每次激活都执行）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">mount</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-comment">// 渲染 DOM</span>
  <span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">createRoot</span>(props.<span class="hljs-property">container</span>).<span class="hljs-title function_">render</span>(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>);
}

<span class="hljs-comment">// 路由离开时调用</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">unmount</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-comment">// 清理 DOM 和副作用</span>
  root.<span class="hljs-title function_">unmount</span>();
}
</code></pre>
<h3 data-id="heading-5">3. 生命周期流程</h3>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">首次加载:  load → bootstrap → mount</span>
<span class="hljs-section">路由切换:  unmount → mount (另一个应用)</span>
<span class="hljs-section">完全卸载:  unmount → unload (可选)</span>
</code></pre>
<hr/>
<h2 data-id="heading-6">三、核心原理</h2>
<h3 data-id="heading-7">1. 路由劫持</h3>
<p>Single-SPA 通过劫持浏览器的路由事件来实现应用切换：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 劫持 history API</span>
<span class="hljs-keyword">const</span> originalPushState = <span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-property">pushState</span>;
<span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-property">pushState</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {
  originalPushState.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
  <span class="hljs-comment">// 触发应用切换逻辑</span>
  <span class="hljs-title function_">reroute</span>();
};

<span class="hljs-comment">// 监听 popstate 事件</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"popstate"</span>, reroute);
</code></pre>
<h3 data-id="heading-8">2. 应用状态机</h3>
<p>每个应用都有状态流转：</p>
<pre><code class="hljs language-markdown" lang="markdown">NOT<span class="hljs-emphasis">_LOADED → LOADING_</span>SOURCE<span class="hljs-emphasis">_CODE → NOT_</span>BOOTSTRAPPED
<span class="hljs-code">    → BOOTSTRAPPING → NOT_MOUNTED → MOUNTING → MOUNTED
    → UNMOUNTING → NOT_MOUNTED
</span></code></pre>
<h3 data-id="heading-9">3. 应用加载与执行</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 注册应用</span>
<span class="hljs-title function_">registerApplication</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"app1"</span>,
  <span class="hljs-attr">app</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">"./app1/main.js"</span>), <span class="hljs-comment">// 动态导入</span>
  <span class="hljs-attr">activeWhen</span>: <span class="hljs-string">"/app1"</span>, <span class="hljs-comment">// 激活条件</span>
  <span class="hljs-attr">customProps</span>: { <span class="hljs-attr">authToken</span>: <span class="hljs-string">"xxx"</span> }, <span class="hljs-comment">// 传递给子应用的 props</span>
});

<span class="hljs-comment">// 启动</span>
<span class="hljs-title function_">start</span>();
</code></pre>
<h3 data-id="heading-10">4. Import Map 模块解析</h3>
<p>Single-SPA 推荐使用 Import Map 来管理模块 URL：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"importmap"</span>&gt;</span><span class="javascript">
  {
    <span class="hljs-string">"imports"</span>: {
      <span class="hljs-string">"react"</span>: <span class="hljs-string">"https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"</span>,
      <span class="hljs-string">"@myorg/app1"</span>: <span class="hljs-string">"https://mycdn.com/app1/main.js"</span>
    }
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>浏览器会根据 Import Map 解析 <code>import '@myorg/app1'</code> 到实际 URL。</p>
<hr/>
<h2 data-id="heading-11">四、Single-SPA 生态</h2>
<h3 data-id="heading-12">1. 核心包</h3>

















<table><thead><tr><th>包名</th><th>作用</th></tr></thead><tbody><tr><td><code>single-spa</code></td><td>核心库，提供注册、启动、生命周期管理</td></tr><tr><td><code>single-spa-layout</code></td><td>声明式布局引擎，用 HTML 定义路由和布局</td></tr></tbody></table>
<h3 data-id="heading-13">2. 框架适配器</h3>

























<table><thead><tr><th>适配器</th><th>框架</th></tr></thead><tbody><tr><td><code>single-spa-react</code></td><td>React</td></tr><tr><td><code>single-spa-vue</code></td><td>Vue 2/3</td></tr><tr><td><code>single-spa-angular</code></td><td>Angular</td></tr><tr><td><code>single-spa-svelte</code></td><td>Svelte</td></tr></tbody></table>
<h3 data-id="heading-14">3. 开发工具</h3>





















<table><thead><tr><th>工具</th><th>作用</th></tr></thead><tbody><tr><td><code>import-map-overrides</code></td><td>运行时覆盖 Import Map，方便本地调试</td></tr><tr><td><code>import-map-injector</code></td><td>支持从远程 URL 加载 Import Map</td></tr><tr><td><code>create-single-spa</code></td><td>官方脚手架 CLI</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-15">五、项目结构</h2>
<h3 data-id="heading-16">推荐的目录结构</h3>
<pre><code class="hljs language-bash" lang="bash">micro-frontends/
├── root-config/              <span class="hljs-comment"># 基座应用</span>
│   ├── src/
│   │   ├── index.ejs         <span class="hljs-comment"># HTML 模板 + 布局配置</span>
│   │   └── root-config.js    <span class="hljs-comment"># 应用注册和启动</span>
│   └── webpack.config.js
│
├── navbar/                   <span class="hljs-comment"># 导航栏应用（始终显示）</span>
├── app1/                     <span class="hljs-comment"># 业务应用 1</span>
├── app2/                     <span class="hljs-comment"># 业务应用 2</span>
│
├── shared/                   <span class="hljs-comment"># 共享模块</span>
│   ├── api/                  <span class="hljs-comment"># API 封装</span>
│   └── styleguide/           <span class="hljs-comment"># 公共样式/组件</span>
│
└── shared-dependencies/      <span class="hljs-comment"># Import Map 配置</span>
    └── importmap.json
</code></pre>
<hr/>
<h2 data-id="heading-17">六、创建 Single-SPA 项目</h2>
<h3 data-id="heading-18">方式一：使用官方脚手架 create-single-spa（推荐）</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 全局安装</span>
npm install -g create-single-spa

<span class="hljs-comment"># 或使用 npx</span>
npx create-single-spa
</code></pre>
<p>脚手架会引导你选择：</p>
<ol>
<li>
<p><strong>项目类型</strong>：</p>
<ul>
<li><code>single-spa root config</code> - 基座应用</li>
<li><code>single-spa application / parcel</code> - 子应用</li>
<li><code>in-browser utility module</code> - 工具模块</li>
</ul>
</li>
<li>
<p><strong>框架</strong>：React / Vue / Angular / Svelte / None</p>
</li>
<li>
<p><strong>包管理器</strong>：npm / yarn / pnpm</p>
</li>
</ol>
<h4 data-id="heading-19">创建基座应用</h4>
<pre><code class="hljs language-bash" lang="bash">npx create-single-spa --moduleType root-config
<span class="hljs-comment"># 选择组织名称，如 @myorg</span>
</code></pre>
<h4 data-id="heading-20">创建 React 子应用</h4>
<pre><code class="hljs language-bash" lang="bash">npx create-single-spa --moduleType app-parcel --framework react
</code></pre>
<h4 data-id="heading-21">创建 Vue 子应用</h4>
<pre><code class="hljs language-bash" lang="bash">npx create-single-spa --moduleType app-parcel --framework vue
</code></pre>
<h3 data-id="heading-22">方式二：手动配置</h3>
<p>如果需要更多控制，可以手动配置：</p>
<h4 data-id="heading-23">1. 基座应用 (root-config)</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> root-config &amp;&amp; <span class="hljs-built_in">cd</span> root-config
npm init -y
npm install single-spa single-spa-layout
npm install -D webpack webpack-cli webpack-dev-server html-webpack-plugin
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/root-config.js</span>
<span class="hljs-keyword">import</span> { registerApplication, start } <span class="hljs-keyword">from</span> <span class="hljs-string">"single-spa"</span>;
<span class="hljs-keyword">import</span> {
  constructApplications,
  constructRoutes,
  constructLayoutEngine,
} <span class="hljs-keyword">from</span> <span class="hljs-string">"single-spa-layout"</span>;

<span class="hljs-keyword">const</span> routes = <span class="hljs-title function_">constructRoutes</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"#single-spa-layout"</span>));
<span class="hljs-keyword">const</span> applications = <span class="hljs-title function_">constructApplications</span>({
  routes,
  <span class="hljs-attr">loadApp</span>: <span class="hljs-function">(<span class="hljs-params">{ name }</span>) =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-comment">/* webpackIgnore: true */</span> name),
});

applications.<span class="hljs-title function_">forEach</span>(registerApplication);
<span class="hljs-title function_">constructLayoutEngine</span>({ routes, applications }).<span class="hljs-title function_">activate</span>();
<span class="hljs-title function_">start</span>();
</code></pre>
<h4 data-id="heading-24">2. React 子应用</h4>
<pre><code class="hljs language-bash" lang="bash">npm install single-spa-react react react-dom
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/main.js</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ReactDOMClient</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react-dom/client"</span>;
<span class="hljs-keyword">import</span> singleSpaReact <span class="hljs-keyword">from</span> <span class="hljs-string">"single-spa-react"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./App"</span>;

<span class="hljs-keyword">const</span> lifecycles = <span class="hljs-title function_">singleSpaReact</span>({
  <span class="hljs-title class_">React</span>,
  <span class="hljs-title class_">ReactDOMClient</span>,
  <span class="hljs-attr">rootComponent</span>: <span class="hljs-title class_">App</span>,
  <span class="hljs-title function_">errorBoundary</span>(<span class="hljs-params">err, info, props</span>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Error<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  },
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> { bootstrap, mount, unmount } = lifecycles;
</code></pre>
<h4 data-id="heading-25">3. Vue 子应用</h4>
<pre><code class="hljs language-bash" lang="bash">npm install single-spa-vue vue
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/main.js</span>
<span class="hljs-keyword">import</span> { createApp, h } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;
<span class="hljs-keyword">import</span> singleSpaVue <span class="hljs-keyword">from</span> <span class="hljs-string">"single-spa-vue"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./App.vue"</span>;

<span class="hljs-keyword">const</span> vueLifecycles = <span class="hljs-title function_">singleSpaVue</span>({
  createApp,
  <span class="hljs-attr">appOptions</span>: {
    <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">h</span>(<span class="hljs-title class_">App</span>);
    },
  },
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> { bootstrap, mount, unmount } = vueLifecycles;
</code></pre>
<h3 data-id="heading-26">方式三：参考官方示例仓库</h3>

























<table><thead><tr><th>示例</th><th>地址</th><th>说明</th></tr></thead><tbody><tr><td>React 示例</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Freact-microfrontends" target="_blank" title="https://github.com/react-microfrontends" ref="nofollow noopener noreferrer">github.com/react-micro…</a></td><td>完整的 React 微前端示例</td></tr><tr><td>Vue 示例</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvue-microfrontends" target="_blank" title="https://github.com/vue-microfrontends" ref="nofollow noopener noreferrer">github.com/vue-microfr…</a></td><td>完整的 Vue 微前端示例</td></tr><tr><td>混合框架示例</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpolyglot-microfrontends" target="_blank" title="https://github.com/polyglot-microfrontends" ref="nofollow noopener noreferrer">github.com/polyglot-mi…</a></td><td>React + Vue + Angular 混合</td></tr></tbody></table>
<p>在线演示：</p>
<ul>
<li>React: <a href="https://link.juejin.cn?target=https%3A%2F%2Freact.microfrontends.app" target="_blank" title="https://react.microfrontends.app" ref="nofollow noopener noreferrer">react.microfrontends.app</a></li>
<li>Vue: <a href="https://link.juejin.cn?target=https%3A%2F%2Fvue.microfrontends.app" target="_blank" title="https://vue.microfrontends.app" ref="nofollow noopener noreferrer">vue.microfrontends.app</a></li>
</ul>
<hr/>
<h2 data-id="heading-27">七、开发调试技巧</h2>
<h3 data-id="heading-28">1. 使用 import-map-overrides</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在浏览器控制台启用开发工具</span>
<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">"devtools"</span>, <span class="hljs-literal">true</span>);

<span class="hljs-comment">// 刷新页面后，右下角会出现开发工具面板</span>
<span class="hljs-comment">// 可以将任意模块指向本地开发服务器</span>
</code></pre>
<h3 data-id="heading-29">2. 本地开发流程</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 启动本地子应用</span>
<span class="hljs-built_in">cd</span> my-app &amp;&amp; npm start --port 9001

<span class="hljs-comment"># 2. 访问线上/本地基座</span>
<span class="hljs-comment"># 3. 使用 import-map-overrides 将 @myorg/my-app 指向 localhost:9001</span>
</code></pre>
<h3 data-id="heading-30">3. 独立运行子应用</h3>
<p>子应用应该能够独立运行，方便开发调试：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 判断是否在 single-spa 环境中</span>
<span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">window</span>.<span class="hljs-property">singleSpaNavigate</span>) {
  <span class="hljs-comment">// 独立运行</span>
  <span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">createRoot</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"root"</span>)).<span class="hljs-title function_">render</span>(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>);
}
</code></pre>
<hr/>
<h2 data-id="heading-31">八、Single-SPA vs 其他方案</h2>















































<table><thead><tr><th>特性</th><th>single-spa</th><th>qiankun</th><th>micro-app</th></tr></thead><tbody><tr><td>Entry 类型</td><td>JS Entry</td><td>HTML Entry</td><td>HTML Entry</td></tr><tr><td>沙箱隔离</td><td>❌ 无内置</td><td>✅ Proxy 沙箱</td><td>✅ 沙箱隔离</td></tr><tr><td>样式隔离</td><td>❌ 无内置</td><td>✅ Shadow DOM / Scoped</td><td>✅ 样式隔离</td></tr><tr><td>老项目改造</td><td>较高</td><td>极低</td><td>极低</td></tr><tr><td>灵活性</td><td>★★★★★</td><td>★★★★</td><td>★★★</td></tr><tr><td>学习曲线</td><td>较陡</td><td>中等</td><td>较平缓</td></tr></tbody></table>
<h3 data-id="heading-32">选择建议</h3>
<ul>
<li><strong>选 single-spa</strong>：需要最大灵活性、深入理解微前端原理、技术能力强的团队</li>
<li><strong>选 qiankun</strong>：企业级项目、多历史系统接入、需要开箱即用的沙箱和隔离</li>
<li><strong>选 micro-app</strong>：快速上手、组件化思维、Vue 技术栈为主</li>
</ul>
<hr/>
<h2 data-id="heading-33">九、最佳实践</h2>
<h3 data-id="heading-34">1. 共享依赖</h3>
<p>通过 Import Map 共享公共依赖，避免重复加载：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"imports"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://cdn.jsdelivr.net/npm/react@18/..."</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"react-dom"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://cdn.jsdelivr.net/npm/react-dom@18/..."</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-35">2. 样式隔离</h3>
<p>Single-SPA 不提供内置样式隔离，需要自行处理：</p>
<ul>
<li>CSS Modules</li>
<li>CSS-in-JS (styled-components, emotion)</li>
<li>BEM 命名规范</li>
<li>添加应用前缀</li>
</ul>
<h3 data-id="heading-36">3. 全局状态管理</h3>
<ul>
<li>使用 Utility 模块共享状态</li>
<li>发布订阅模式 (EventBus)</li>
<li>通过 customProps 传递</li>
</ul>
<h3 data-id="heading-37">4. 错误边界</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">singleSpaReact</span>({
  <span class="hljs-comment">// ...</span>
  <span class="hljs-title function_">errorBoundary</span>(<span class="hljs-params">err, info, props</span>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ErrorPage</span> <span class="hljs-attr">error</span>=<span class="hljs-string">{err}</span> /&gt;</span></span>;
  },
});
</code></pre>
<hr/>
<h2 data-id="heading-38">十、学习资源</h2>
<h3 data-id="heading-39">官方资源</h3>
<ul>
<li>官方文档: <a href="https://link.juejin.cn?target=https%3A%2F%2Fsingle-spa.js.org%2Fdocs%2Fgetting-started-overview" target="_blank" title="https://single-spa.js.org/docs/getting-started-overview" ref="nofollow noopener noreferrer">single-spa.js.org/docs/gettin…</a></li>
<li>推荐设置: <a href="https://link.juejin.cn?target=https%3A%2F%2Fsingle-spa.js.org%2Fdocs%2Frecommended-setup" target="_blank" title="https://single-spa.js.org/docs/recommended-setup" ref="nofollow noopener noreferrer">single-spa.js.org/docs/recomm…</a></li>
<li>GitHub: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsingle-spa%2Fsingle-spa" target="_blank" title="https://github.com/single-spa/single-spa" ref="nofollow noopener noreferrer">github.com/single-spa/…</a></li>
</ul>
<h3 data-id="heading-40">视频教程</h3>
<ul>
<li>YouTube 官方教程: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fplaylist%3Flist%3DPLLUD8RtHvsAOhtHnyGx57EYXoaNsxGrTU" target="_blank" title="https://www.youtube.com/playlist?list=PLLUD8RtHvsAOhtHnyGx57EYXoaNsxGrTU" ref="nofollow noopener noreferrer">www.youtube.com/playlist?li…</a></li>
<li>B 站教程: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2Fav83498486%2F" target="_blank" title="https://www.bilibili.com/video/av83498486/" ref="nofollow noopener noreferrer">www.bilibili.com/video/av834…</a></li>
</ul>
<h3 data-id="heading-41">相关规范</h3>
<ul>
<li>Import Map 规范: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FWICG%2Fimport-maps" target="_blank" title="https://github.com/WICG/import-maps" ref="nofollow noopener noreferrer">github.com/WICG/import…</a></li>
<li>ES Modules: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FJavaScript%2FGuide%2FModules" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Modules" ref="nofollow noopener noreferrer">developer.mozilla.org/en-US/docs/…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Retrofit 内部工作原理时序图]]></title>    <link>https://juejin.cn/post/7588139768275173427</link>    <guid>https://juejin.cn/post/7588139768275173427</guid>    <pubDate>2025-12-28T02:32:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588139768275173427" data-draft-id="7588084804093820966" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Retrofit 内部工作原理时序图"/> <meta itemprop="keywords" content="架构,开源"/> <meta itemprop="datePublished" content="2025-12-28T02:32:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="乾坤一气杀"/> <meta itemprop="url" content="https://juejin.cn/user/4212984289955431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Retrofit 内部工作原理时序图
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984289955431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    乾坤一气杀
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T02:32:41.000Z" title="Sun Dec 28 2025 02:32:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Retrofit 内部工作原理时序图</h2>
<p>本文档深入剖析Retrofit框架内部的工作机制，展示其核心组件的交互流程。</p>
<h3 data-id="heading-1">1. Retrofit 构建流程</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Client as 开发者代码
    participant Builder as Retrofit.Builder
    participant Platform as Platform
    participant Executor as Executor
    participant Retrofit as Retrofit

    Client-&gt;&gt;Builder: new Retrofit.Builder()
    activate Builder

    Client-&gt;&gt;Builder: baseUrl(url)
    Builder-&gt;&gt;Builder: 验证URL格式
    Builder-&gt;&gt;Builder: 保存baseUrl

    Client-&gt;&gt;Builder: client(okHttpClient)
    Builder-&gt;&gt;Builder: 保存OkHttpClient实例

    Client-&gt;&gt;Builder: addConverterFactory(factory)
    Builder-&gt;&gt;Builder: converterFactories.add(factory)

    Client-&gt;&gt;Builder: addCallAdapterFactory(factory)
    Builder-&gt;&gt;Builder: callAdapterFactories.add(factory)

    Client-&gt;&gt;Builder: build()
    Builder-&gt;&gt;Platform: Platform.get()
    activate Platform
    Platform-&gt;&gt;Platform: 检测运行平台&lt;br/&gt;(Android/Java8/默认)
    Platform--&gt;&gt;Builder: 返回Platform实例
    deactivate Platform

    Builder-&gt;&gt;Executor: platform.defaultCallbackExecutor()
    activate Executor
    Executor--&gt;&gt;Builder: 返回默认Executor&lt;br/&gt;(Android为MainThreadExecutor)
    deactivate Executor

    Builder-&gt;&gt;Builder: 添加平台默认CallAdapterFactory
    Builder-&gt;&gt;Retrofit: new Retrofit(...)
    activate Retrofit
    Retrofit-&gt;&gt;Retrofit: 初始化成员变量
    Retrofit--&gt;&gt;Builder: 返回Retrofit实例
    deactivate Retrofit

    Builder--&gt;&gt;Client: 返回Retrofit实例
    deactivate Builder
</code></pre>
<h3 data-id="heading-2">2. 动态代理创建 API 接口实例</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Client as 开发者代码
    participant Retrofit as Retrofit
    participant Proxy as Proxy.newProxyInstance
    participant Handler as InvocationHandler
    participant ServiceMethod as ServiceMethod
    participant Cache as serviceMethodCache

    Client-&gt;&gt;Retrofit: create(ApiService.class)
    activate Retrofit

    Retrofit-&gt;&gt;Retrofit: validateServiceInterface(service)
    Retrofit-&gt;&gt;Retrofit: 检查是否为接口
    Retrofit-&gt;&gt;Retrofit: 检查接口中的泛型

    Retrofit-&gt;&gt;Proxy: Proxy.newProxyInstance()
    activate Proxy

    Note over Proxy,Handler: 创建动态代理对象
    Proxy-&gt;&gt;Handler: 传入InvocationHandler
    activate Handler

    Handler-&gt;&gt;Handler: 定义invoke方法逻辑&lt;br/&gt;- 处理Object方法&lt;br/&gt;- 处理default方法&lt;br/&gt;- 处理接口方法

    Proxy--&gt;&gt;Retrofit: 返回代理对象
    deactivate Proxy
    deactivate Handler

    Retrofit--&gt;&gt;Client: 返回ApiService代理实例
    deactivate Retrofit

    Note over Client,Cache: 当调用接口方法时触发
    Client-&gt;&gt;Handler: method.invoke(proxy, args)
    activate Handler

    Handler-&gt;&gt;Cache: serviceMethodCache.get(method)
    activate Cache

    alt 缓存存在
        Cache--&gt;&gt;Handler: 返回缓存的ServiceMethod
    else 缓存不存在
        Cache-&gt;&gt;ServiceMethod: ServiceMethod.parseAnnotations()
        activate ServiceMethod
        ServiceMethod-&gt;&gt;ServiceMethod: 解析方法注解和参数
        ServiceMethod--&gt;&gt;Cache: 返回ServiceMethod
        deactivate ServiceMethod
        Cache-&gt;&gt;Cache: cache.put(method, serviceMethod)
        Cache--&gt;&gt;Handler: 返回新建的ServiceMethod
    end
    deactivate Cache

    Handler-&gt;&gt;ServiceMethod: invoke(args)
    Handler--&gt;&gt;Client: 返回Call对象
    deactivate Handler
</code></pre>
<h3 data-id="heading-3">3. ServiceMethod 解析过程</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Handler as InvocationHandler
    participant SMParser as ServiceMethod.parseAnnotations()
    participant RFParser as RequestFactory.parseAnnotations()
    participant HttpMethod as HttpServiceMethod
    participant CallAdapter as CallAdapter.Factory
    participant Converter as Converter.Factory

    Handler-&gt;&gt;SMParser: parseAnnotations(retrofit, method)
    activate SMParser

    SMParser-&gt;&gt;RFParser: RequestFactory.parseAnnotations()
    activate RFParser

    Note over RFParser: 解析方法注解
    RFParser-&gt;&gt;RFParser: 解析HTTP方法注解&lt;br/&gt;@GET/@POST/@PUT/@DELETE等
    RFParser-&gt;&gt;RFParser: 提取HTTP方法和相对URL
    RFParser-&gt;&gt;RFParser: 解析@Headers注解
    RFParser-&gt;&gt;RFParser: 是否包含body(@Body)
    RFParser-&gt;&gt;RFParser: 是否multipart(@Multipart)
    RFParser-&gt;&gt;RFParser: 是否form-encoded(@FormUrlEncoded)

    Note over RFParser: 解析方法参数注解
    loop 遍历每个参数
        RFParser-&gt;&gt;RFParser: 解析参数注解&lt;br/&gt;@Path/@Query/@Header&lt;br/&gt;@Body/@Field等
        RFParser-&gt;&gt;RFParser: 创建ParameterHandler
    end

    RFParser--&gt;&gt;SMParser: 返回RequestFactory
    deactivate RFParser

    SMParser-&gt;&gt;SMParser: 获取方法返回类型
    SMParser-&gt;&gt;CallAdapter: 查找匹配的CallAdapter
    activate CallAdapter

    loop 遍历CallAdapterFactories
        CallAdapter-&gt;&gt;CallAdapter: factory.get(returnType, annotations)
        alt 找到匹配的Factory
            CallAdapter--&gt;&gt;SMParser: 返回CallAdapter
        end
    end
    deactivate CallAdapter

    SMParser-&gt;&gt;Converter: 查找响应体Converter
    activate Converter

    Converter-&gt;&gt;Converter: 提取响应类型
    loop 遍历ConverterFactories
        Converter-&gt;&gt;Converter: factory.responseBodyConverter()
        alt 找到匹配的Converter
            Converter--&gt;&gt;SMParser: 返回Converter
        end
    end
    deactivate Converter

    SMParser-&gt;&gt;HttpMethod: 创建HttpServiceMethod
    activate HttpMethod
    HttpMethod-&gt;&gt;HttpMethod: 保存RequestFactory
    HttpMethod-&gt;&gt;HttpMethod: 保存CallAdapter
    HttpMethod-&gt;&gt;HttpMethod: 保存ResponseConverter
    HttpMethod--&gt;&gt;SMParser: 返回HttpServiceMethod
    deactivate HttpMethod

    SMParser--&gt;&gt;Handler: 返回ServiceMethod
    deactivate SMParser
</code></pre>
<h3 data-id="heading-4">4. OkHttpCall 创建和执行流程</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Client as 开发者代码
    participant ServiceMethod as HttpServiceMethod
    participant OkHttpCall as OkHttpCall
    participant RequestFactory as RequestFactory
    participant RealCall as okhttp3.Call
    participant Callback as Retrofit Callback

    Client-&gt;&gt;ServiceMethod: invoke(args)
    activate ServiceMethod

    ServiceMethod-&gt;&gt;RequestFactory: create(args)
    activate RequestFactory

    Note over RequestFactory: 构建OkHttp Request
    RequestFactory-&gt;&gt;RequestFactory: 应用RequestBuilder
    RequestFactory-&gt;&gt;RequestFactory: 构建完整URL(baseUrl + 相对路径)

    loop 处理每个参数
        RequestFactory-&gt;&gt;RequestFactory: parameterHandler.apply(requestBuilder, value)
        Note over RequestFactory: @Path替换URL路径&lt;br/&gt;@Query添加查询参数&lt;br/&gt;@Header添加请求头&lt;br/&gt;@Body设置请求体
    end

    RequestFactory-&gt;&gt;RequestFactory: requestBuilder.build()
    RequestFactory--&gt;&gt;ServiceMethod: 返回okhttp3.Request
    deactivate RequestFactory

    ServiceMethod-&gt;&gt;OkHttpCall: new OkHttpCall(requestFactory, args, callFactory, responseConverter)
    activate OkHttpCall
    OkHttpCall-&gt;&gt;OkHttpCall: 保存请求参数
    OkHttpCall--&gt;&gt;ServiceMethod: 返回OkHttpCall实例
    deactivate OkHttpCall

    ServiceMethod-&gt;&gt;ServiceMethod: adapt(okHttpCall, args)
    Note over ServiceMethod: 使用CallAdapter包装
    ServiceMethod--&gt;&gt;Client: 返回适配后的Call
    deactivate ServiceMethod

    Note over Client,Callback: 异步执行请求
    Client-&gt;&gt;OkHttpCall: enqueue(callback)
    activate OkHttpCall

    OkHttpCall-&gt;&gt;OkHttpCall: 创建okhttp3.Request
    OkHttpCall-&gt;&gt;RealCall: callFactory.newCall(request)
    activate RealCall
    RealCall--&gt;&gt;OkHttpCall: 返回okhttp3.Call
    deactivate RealCall

    OkHttpCall-&gt;&gt;RealCall: call.enqueue(okhttp3.Callback)
    activate RealCall

    Note over RealCall: OkHttp执行网络请求
    RealCall-&gt;&gt;RealCall: 通过拦截器链执行
    RealCall-&gt;&gt;RealCall: 返回okhttp3.Response

    RealCall--&gt;&gt;OkHttpCall: onResponse(call, response)
    deactivate RealCall

    alt 响应成功(2xx)
        OkHttpCall-&gt;&gt;OkHttpCall: parseResponse(rawResponse)
        OkHttpCall-&gt;&gt;OkHttpCall: converter.convert(responseBody)
        OkHttpCall-&gt;&gt;Callback: callback.onResponse(call, Response.success(body))
    else 响应失败(非2xx)
        OkHttpCall-&gt;&gt;OkHttpCall: 创建错误ResponseBody
        OkHttpCall-&gt;&gt;Callback: callback.onResponse(call, Response.error(errorBody))
    end

    deactivate OkHttpCall

    Callback--&gt;&gt;Client: 处理响应结果
</code></pre>
<h3 data-id="heading-5">5. 同步请求执行流程</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Client as 开发者代码
    participant OkHttpCall as OkHttpCall
    participant RealCall as okhttp3.Call
    participant Converter as ResponseConverter

    Client-&gt;&gt;OkHttpCall: execute()
    activate OkHttpCall

    OkHttpCall-&gt;&gt;OkHttpCall: 检查是否已执行&lt;br/&gt;(executed标志)

    alt 已经执行过
        OkHttpCall--&gt;&gt;Client: throw IllegalStateException
    end

    OkHttpCall-&gt;&gt;OkHttpCall: executed = true
    OkHttpCall-&gt;&gt;OkHttpCall: 创建okhttp3.Request
    OkHttpCall-&gt;&gt;RealCall: callFactory.newCall(request)
    activate RealCall
    RealCall--&gt;&gt;OkHttpCall: 返回Call实例
    deactivate RealCall

    OkHttpCall-&gt;&gt;RealCall: rawCall.execute()
    activate RealCall

    Note over RealCall: 同步阻塞执行
    RealCall-&gt;&gt;RealCall: 经过拦截器链
    RealCall-&gt;&gt;RealCall: 发送网络请求
    RealCall-&gt;&gt;RealCall: 等待响应

    RealCall--&gt;&gt;OkHttpCall: 返回okhttp3.Response
    deactivate RealCall

    OkHttpCall-&gt;&gt;OkHttpCall: parseResponse(rawResponse)
    activate OkHttpCall

    alt HTTP状态码 2xx
        OkHttpCall-&gt;&gt;Converter: convert(response.body())
        activate Converter
        Converter-&gt;&gt;Converter: 解析响应体&lt;br/&gt;(如JSON转对象)
        Converter--&gt;&gt;OkHttpCall: 返回解析后的对象
        deactivate Converter
        OkHttpCall-&gt;&gt;OkHttpCall: Response.success(body, rawResponse)
    else HTTP状态码非2xx
        OkHttpCall-&gt;&gt;Converter: convert(response.errorBody())
        activate Converter
        Converter--&gt;&gt;OkHttpCall: 返回错误体
        deactivate Converter
        OkHttpCall-&gt;&gt;OkHttpCall: Response.error(errorBody, rawResponse)
    end

    OkHttpCall--&gt;&gt;Client: 返回Response
    deactivate OkHttpCall
</code></pre>
<h3 data-id="heading-6">6. 协程支持机制（Suspend Function）</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Client as 客户端协程
    participant Handler as InvocationHandler
    participant ServiceMethod as SuspendForResponse
    participant Call as OkHttpCall
    participant Continuation as Continuation
    participant Dispatcher as 协程调度器
    participant OkHttp as OkHttpClient
    participant Converter as ResponseConverter

    Note over Client,Handler: 调用suspend函数
    Client-&gt;&gt;Handler: invoke(suspendMethod, args)
    activate Handler

    Handler-&gt;&gt;Handler: 检测到suspend函数
    Handler-&gt;&gt;Handler: 提取Continuation参数
    Handler-&gt;&gt;Continuation: 获取协程上下文
    activate Continuation

    Handler-&gt;&gt;ServiceMethod: loadServiceMethod(method)
    activate ServiceMethod

    Note over ServiceMethod: 识别为suspend函数
    ServiceMethod-&gt;&gt;ServiceMethod: 检查返回类型
    ServiceMethod-&gt;&gt;ServiceMethod: 创建SuspendForResponse
    ServiceMethod--&gt;&gt;Handler: 返回ServiceMethod
    deactivate ServiceMethod

    Handler-&gt;&gt;ServiceMethod: invoke(args)
    activate ServiceMethod

    ServiceMethod-&gt;&gt;Call: 创建OkHttpCall
    activate Call
    Call--&gt;&gt;ServiceMethod: 返回Call对象
    deactivate Call

    Note over ServiceMethod: 不使用CallAdapter
    ServiceMethod-&gt;&gt;Call: awaitResponse()
    activate Call

    Note over Call,Dispatcher: 协程挂起点
    Call-&gt;&gt;Call: suspendCancellableCoroutine
    Call-&gt;&gt;Dispatcher: 切换到IO线程
    activate Dispatcher

    Dispatcher-&gt;&gt;OkHttp: call.enqueue()
    activate OkHttp

    Note over OkHttp: 异步执行网络请求
    OkHttp-&gt;&gt;OkHttp: 拦截器链处理
    OkHttp-&gt;&gt;OkHttp: 发送HTTP请求
    OkHttp-&gt;&gt;OkHttp: 接收响应

    OkHttp--&gt;&gt;Dispatcher: onResponse回调
    deactivate OkHttp

    Dispatcher-&gt;&gt;Call: 恢复协程
    deactivate Dispatcher

    Call-&gt;&gt;Call: parseResponse()
    alt HTTP 2xx
        Call-&gt;&gt;Converter: convert(responseBody)
        activate Converter
        Converter-&gt;&gt;Converter: JSON转对象
        Converter--&gt;&gt;Call: 返回解析后的对象
        deactivate Converter
        Call-&gt;&gt;Continuation: resume(result)
    else HTTP非2xx
        Call-&gt;&gt;Call: 创建HttpException
        Call-&gt;&gt;Continuation: resumeWithException(error)
    end

    Call--&gt;&gt;ServiceMethod: 返回结果
    deactivate Call

    ServiceMethod--&gt;&gt;Handler: 返回结果
    deactivate ServiceMethod

    Handler--&gt;&gt;Client: 协程恢复执行
    deactivate Handler
    deactivate Continuation

    Client-&gt;&gt;Client: 继续执行后续代码
</code></pre>
<h3 data-id="heading-7">7. 协程取消机制</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Scope as CoroutineScope
    participant Job as Job
    participant Continuation as CancellableContinuation
    participant Call as OkHttpCall
    participant OkHttp as okhttp3.Call

    Note over Scope,Job: 协程启动
    Scope-&gt;&gt;Job: launch/async
    activate Job
    Job-&gt;&gt;Call: 执行suspend函数
    activate Call

    Call-&gt;&gt;Continuation: suspendCancellableCoroutine
    activate Continuation

    Continuation-&gt;&gt;Continuation: invokeOnCancellation回调
    Note over Continuation: 注册取消监听器

    Call-&gt;&gt;OkHttp: call.enqueue()
    activate OkHttp
    Note over OkHttp: 网络请求进行中

    Note over Scope,Job: 用户取消协程
    Scope-&gt;&gt;Job: job.cancel()
    activate Scope
    Job-&gt;&gt;Job: 标记为已取消

    Job-&gt;&gt;Continuation: cancel()
    Continuation-&gt;&gt;Continuation: 触发invokeOnCancellation

    Continuation-&gt;&gt;Call: 执行取消回调
    Call-&gt;&gt;OkHttp: call.cancel()
    OkHttp-&gt;&gt;OkHttp: 取消网络请求
    OkHttp--&gt;&gt;Call: IOException(Canceled)
    deactivate OkHttp

    Call-&gt;&gt;Continuation: resumeWithException(CancellationException)
    Continuation--&gt;&gt;Job: 抛出CancellationException
    deactivate Continuation
    deactivate Call

    Job--&gt;&gt;Scope: 协程已取消
    deactivate Job
    deactivate Scope
</code></pre>
<h3 data-id="heading-8">8. CallAdapter 工作机制</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Retrofit as Retrofit
    participant Factory as CallAdapter.Factory
    participant Adapter as CallAdapter
    participant TargetType as 目标类型对象

    Note over Retrofit,Factory: 第一阶段：查找CallAdapter
    Retrofit-&gt;&gt;Retrofit: callAdapter(returnType, annotations)
    activate Retrofit

    loop 遍历callAdapterFactories
        Retrofit-&gt;&gt;Factory: factory.get(returnType, annotations, retrofit)
        activate Factory
        Factory-&gt;&gt;Factory: 检查返回类型是否匹配

        alt 类型匹配
            Factory-&gt;&gt;Adapter: 创建CallAdapter实例
            activate Adapter
            Adapter-&gt;&gt;Adapter: 设置responseType
            Adapter--&gt;&gt;Factory: 返回Adapter
            deactivate Adapter
            Factory--&gt;&gt;Retrofit: 返回CallAdapter
            Note over Retrofit: 找到匹配的Adapter停止遍历
        else 类型不匹配
            Factory--&gt;&gt;Retrofit: 返回null
            Note over Retrofit: 继续查找下一个Factory
        end
        deactivate Factory
    end

    Retrofit--&gt;&gt;Retrofit: 返回匹配的CallAdapter
    deactivate Retrofit

    Note over Adapter,TargetType: 第二阶段：适配Call对象
    Retrofit-&gt;&gt;Adapter: adapt(call)
    activate Adapter

    alt DefaultCallAdapter
        Adapter-&gt;&gt;Adapter: 直接返回Call对象
        Adapter--&gt;&gt;Retrofit: 返回Call
    else ExecutorCallbackCall
        Adapter-&gt;&gt;TargetType: new ExecutorCallbackCall
        activate TargetType
        Note over TargetType: 包装Call在指定Executor回调
        TargetType--&gt;&gt;Adapter: 返回包装后的Call
        deactivate TargetType
        Adapter--&gt;&gt;Retrofit: 返回Call
    else CompletableFutureCallAdapter
        Adapter-&gt;&gt;TargetType: new CompletableFutureCallAdapter
        activate TargetType
        Note over TargetType: 将Call转为CompletableFuture
        TargetType--&gt;&gt;Adapter: 返回CompletableFuture
        deactivate TargetType
        Adapter--&gt;&gt;Retrofit: 返回CompletableFuture
    else RxJava3CallAdapter
        Adapter-&gt;&gt;TargetType: 创建Observable/Single
        activate TargetType
        Note over TargetType: 将Call转为RxJava类型
        TargetType--&gt;&gt;Adapter: 返回Observable
        deactivate TargetType
        Adapter--&gt;&gt;Retrofit: 返回Observable
    end

    deactivate Adapter
</code></pre>
<h3 data-id="heading-9">9. Converter 转换机制</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Retrofit as Retrofit
    participant Factory as Converter.Factory
    participant Converter as Converter
    participant ResponseBody as ResponseBody
    participant TargetType as 目标对象

    Note over Retrofit,Factory: 第一阶段：查找ResponseConverter
    Retrofit-&gt;&gt;Retrofit: nextResponseBodyConverter()
    activate Retrofit

    loop 遍历converterFactories
        Retrofit-&gt;&gt;Factory: factory.responseBodyConverter()
        activate Factory
        Factory-&gt;&gt;Factory: 检查是否支持该类型转换

        alt 支持转换
            Factory-&gt;&gt;Converter: 创建Converter实例
            activate Converter
            Converter--&gt;&gt;Factory: 返回Converter
            deactivate Converter
            Factory--&gt;&gt;Retrofit: 返回Converter
            Note over Retrofit: 找到匹配的Converter
        else 不支持
            Factory--&gt;&gt;Retrofit: 返回null
            Note over Retrofit: 继续查找
        end
        deactivate Factory
    end

    Retrofit--&gt;&gt;Retrofit: 返回匹配的Converter
    deactivate Retrofit

    Note over Converter,TargetType: 第二阶段：转换响应体
    Retrofit-&gt;&gt;Converter: convert(responseBody)
    activate Converter

    Converter-&gt;&gt;ResponseBody: value.source()
    activate ResponseBody
    ResponseBody--&gt;&gt;Converter: 返回BufferedSource
    deactivate ResponseBody

    alt GsonConverter
        Converter-&gt;&gt;Converter: gson.getAdapter(type)
        Converter-&gt;&gt;Converter: adapter.read(jsonReader)
        Note over Converter: JSON → Java对象
    else MoshiConverter
        Converter-&gt;&gt;Converter: moshi.adapter(type)
        Converter-&gt;&gt;Converter: adapter.fromJson(source)
        Note over Converter: JSON → Java对象
    else JacksonConverter
        Converter-&gt;&gt;Converter: objectMapper.readValue()
        Note over Converter: JSON → Java对象
    else ProtobufConverter
        Converter-&gt;&gt;Converter: adapter.decode(bytes)
        Note over Converter: Protobuf → Java对象
    else ScalarsConverter
        Converter-&gt;&gt;Converter: responseBody.string()
        Note over Converter: 直接返回字符串
    end

    Converter-&gt;&gt;TargetType: 创建对象实例
    activate TargetType
    TargetType--&gt;&gt;Converter: 返回实例
    deactivate TargetType

    Converter--&gt;&gt;Retrofit: 返回转换后的对象
    deactivate Converter

    Note over Retrofit,Factory: 第三阶段：请求体转换
    Retrofit-&gt;&gt;Factory: requestBodyConverter()
    activate Factory
    Factory-&gt;&gt;Converter: 创建RequestConverter
    activate Converter
    Converter--&gt;&gt;Factory: 返回Converter
    deactivate Converter
    Factory--&gt;&gt;Retrofit: 返回Converter
    deactivate Factory

    Retrofit-&gt;&gt;Converter: convert(value)
    activate Converter

    alt GsonConverter
        Converter-&gt;&gt;Converter: gson.toJson(value)
        Note over Converter: Java对象 → JSON
        Converter-&gt;&gt;Converter: RequestBody.create()
    else MoshiConverter
        Converter-&gt;&gt;Converter: adapter.toJson(value)
        Converter-&gt;&gt;Converter: RequestBody.create()
    end

    Converter--&gt;&gt;Retrofit: 返回RequestBody
    deactivate Converter
</code></pre>
<h3 data-id="heading-10">10. 请求参数处理机制</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant RF as RequestFactory
    participant Builder as RequestBuilder
    participant Handler as ParameterHandler
    participant Request as okhttp3.Request

    RF-&gt;&gt;Builder: new RequestBuilder(httpMethod, baseUrl, relativeUrl)
    activate Builder
    Builder-&gt;&gt;Builder: 初始化HttpUrl.Builder
    Builder-&gt;&gt;Builder: 初始化Headers
    deactivate Builder

    Note over RF,Handler: 应用每个参数
    loop 遍历方法参数
        RF-&gt;&gt;Handler: parameterHandlers[i].apply(builder, args[i])
        activate Handler

        alt @Path参数
            Handler-&gt;&gt;Handler: 验证值不为null
            Handler-&gt;&gt;Handler: 替换URL路径中的占位符
            Handler-&gt;&gt;Builder: relativeUrl.replace(&amp;#34;{name}&amp;#34;, value)
            Builder-&gt;&gt;Builder: 更新URL
        else @Query参数
            Handler-&gt;&gt;Handler: 转换值为字符串
            Handler-&gt;&gt;Builder: addQueryParam(name, value)
            Builder-&gt;&gt;Builder: urlBuilder.addQueryParameter(name, value)
        else @QueryMap参数
            loop 遍历Map条目
                Handler-&gt;&gt;Builder: addQueryParam(key, value)
            end
        else @Header参数
            Handler-&gt;&gt;Handler: 转换值为字符串
            Handler-&gt;&gt;Builder: addHeader(name, value)
            Builder-&gt;&gt;Builder: headersBuilder.add(name, value)
        else @HeaderMap参数
            loop 遍历Map条目
                Handler-&gt;&gt;Builder: addHeader(key, value)
            end
        else @Body参数
            Handler-&gt;&gt;Handler: 使用Converter转换对象
            Handler-&gt;&gt;Handler: converter.convert(value)
            Handler-&gt;&gt;Builder: setBody(requestBody)
            Builder-&gt;&gt;Builder: 保存RequestBody
        else @Field参数 (FormEncoded)
            Handler-&gt;&gt;Handler: 转换值为字符串
            Handler-&gt;&gt;Builder: addFormField(name, value)
            Builder-&gt;&gt;Builder: formBuilder.add(name, value)
        else @FieldMap参数
            loop 遍历Map条目
                Handler-&gt;&gt;Builder: addFormField(key, value)
            end
        else @Part参数 (Multipart)
            Handler-&gt;&gt;Handler: 创建MultipartBody.Part
            Handler-&gt;&gt;Builder: addPart(part)
            Builder-&gt;&gt;Builder: multipartBuilder.addPart(part)
        else @PartMap参数
            loop 遍历Map条目
                Handler-&gt;&gt;Builder: addPart(key, value)
            end
        else @Url参数
            Handler-&gt;&gt;Handler: 解析完整URL
            Handler-&gt;&gt;Builder: setRelativeUrl(url)
            Builder-&gt;&gt;Builder: 覆盖URL
        end

        Handler--&gt;&gt;RF: 参数应用完成
        deactivate Handler
    end

    Note over RF,Request: 构建最终Request
    RF-&gt;&gt;Builder: build()
    activate Builder

    Builder-&gt;&gt;Builder: 构建完整URL&lt;br/&gt;baseUrl + relativeUrl + queryParams
    Builder-&gt;&gt;Builder: 构建Headers

    alt 有RequestBody
        Builder-&gt;&gt;Builder: 设置Content-Type
        Builder-&gt;&gt;Builder: 添加Body
    else FormEncoded
        Builder-&gt;&gt;Builder: formBuilder.build()
        Builder-&gt;&gt;Builder: 设置Content-Type: application/x-www-form-urlencoded
    else Multipart
        Builder-&gt;&gt;Builder: multipartBuilder.build()
        Builder-&gt;&gt;Builder: 设置Content-Type: multipart/form-data
    end

    Builder-&gt;&gt;Request: new Request.Builder().url(url).headers(headers).method(httpMethod, body).build()
    activate Request
    Request--&gt;&gt;Builder: 返回Request实例
    deactivate Request

    Builder--&gt;&gt;RF: 返回okhttp3.Request
    deactivate Builder
</code></pre>
<h3 data-id="heading-11">11. 完整的内部调用链路图</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    Start([调用API接口方法]) --&gt; ProxyInvoke[动态代理拦截调用&lt;br/&gt;InvocationHandler.invoke]

    ProxyInvoke --&gt; CheckCache{ServiceMethod&lt;br/&gt;是否缓存?}

    CheckCache --&gt;|已缓存| GetCached[从缓存获取]
    CheckCache --&gt;|未缓存| ParseMethod[解析方法注解&lt;br/&gt;ServiceMethod.parseAnnotations]

    ParseMethod --&gt; ParseRequest[创建RequestFactory&lt;br/&gt;解析HTTP方法和参数注解]
    ParseRequest --&gt; FindCallAdapter[查找CallAdapter&lt;br/&gt;遍历CallAdapterFactories]
    FindCallAdapter --&gt; FindConverter[查找Converter&lt;br/&gt;遍历ConverterFactories]
    FindConverter --&gt; CreateSM[创建HttpServiceMethod&lt;br/&gt;封装请求信息]
    CreateSM --&gt; CacheIt[缓存ServiceMethod]

    CacheIt --&gt; GetCached
    GetCached --&gt; InvokeSM[调用ServiceMethod.invoke]

    InvokeSM --&gt; CreateRequest[创建okhttp3.Request&lt;br/&gt;应用所有参数处理器]
    CreateRequest --&gt; CreateOkCall[创建OkHttpCall&lt;br/&gt;封装OkHttp调用]
    CreateOkCall --&gt; AdaptCall[使用CallAdapter.adapt&lt;br/&gt;转换为目标类型]

    AdaptCall --&gt; ReturnCall([返回Call对象])

    ReturnCall --&gt; ExecuteChoice{执行方式?}

    ExecuteChoice --&gt;|enqueue| AsyncExec[异步执行&lt;br/&gt;call.enqueue]
    ExecuteChoice --&gt;|execute| SyncExec[同步执行&lt;br/&gt;call.execute]

    AsyncExec --&gt; CreateOkCall2[创建okhttp3.Call]
    SyncExec --&gt; CreateOkCall2

    CreateOkCall2 --&gt; OkHttpChain[OkHttp拦截器链]

    OkHttpChain --&gt; Interceptor1[RetryAndFollowUpInterceptor&lt;br/&gt;重试和重定向]
    Interceptor1 --&gt; Interceptor2[BridgeInterceptor&lt;br/&gt;添加基础Headers]
    Interceptor2 --&gt; Interceptor3[CacheInterceptor&lt;br/&gt;缓存处理]
    Interceptor3 --&gt; Interceptor4[ConnectInterceptor&lt;br/&gt;建立连接]
    Interceptor4 --&gt; Interceptor5[CallServerInterceptor&lt;br/&gt;发送请求]

    Interceptor5 --&gt; Network[网络服务器]
    Network --&gt; RawResponse[返回okhttp3.Response]

    RawResponse --&gt; ParseResponse[解析响应&lt;br/&gt;OkHttpCall.parseResponse]

    ParseResponse --&gt; CheckStatus{HTTP状态码?}

    CheckStatus --&gt;|2xx成功| ConvertSuccess[使用Converter转换响应体&lt;br/&gt;ResponseBodyConverter.convert]
    CheckStatus --&gt;|非2xx| ConvertError[转换错误体&lt;br/&gt;保留原始响应]

    ConvertSuccess --&gt; WrapSuccess[包装为Response.success]
    ConvertError --&gt; WrapError[包装为Response.error]

    WrapSuccess --&gt; Callback[回调结果]
    WrapError --&gt; Callback

    Callback --&gt; End([执行完成])

    style Start fill:#e1f5e1
    style End fill:#ffe1e1
    style Network fill:#e1f0ff
    style ProxyInvoke fill:#fff4e1
    style OkHttpChain fill:#f0e1ff
</code></pre>
<h3 data-id="heading-12">核心类关系说明</h3>
<h4 data-id="heading-13">1. Retrofit</h4>
<ul>
<li><strong>职责</strong>: 框架入口，管理所有配置</li>
<li><strong>核心方法</strong>:
<ul>
<li><code>create(Class&lt;T&gt; service)</code>: 创建API接口代理实例</li>
<li><code>callAdapter(Type returnType, Annotation[] annotations)</code>: 查找匹配的CallAdapter</li>
<li><code>nextResponseBodyConverter(...)</code>: 查找匹配的Converter</li>
</ul>
</li>
</ul>
<h4 data-id="heading-14">2. ServiceMethod</h4>
<ul>
<li><strong>职责</strong>: 封装API方法的所有信息</li>
<li><strong>子类</strong>:
<ul>
<li><code>HttpServiceMethod</code>: 普通HTTP方法的实现</li>
<li><code>SuspendForResponse</code>: suspend函数的特殊实现</li>
<li><code>SuspendForBody</code>: 直接返回响应体的suspend函数</li>
</ul>
</li>
<li><strong>核心信息</strong>:
<ul>
<li>RequestFactory: 请求工厂</li>
<li>CallAdapter: 调用适配器（suspend函数不使用）</li>
<li>Converter: 响应转换器</li>
</ul>
</li>
<li><strong>suspend函数特性</strong>:
<ul>
<li>自动检测方法签名中的<code>Continuation</code>参数</li>
<li>使用<code>suspendCancellableCoroutine</code>实现挂起</li>
<li>支持协程取消传播到OkHttp Call</li>
</ul>
</li>
</ul>
<h4 data-id="heading-15">3. RequestFactory</h4>
<ul>
<li><strong>职责</strong>: 根据方法注解和参数创建OkHttp Request</li>
<li><strong>核心成员</strong>:
<ul>
<li><code>httpMethod</code>: HTTP方法(GET/POST等)</li>
<li><code>relativeUrl</code>: 相对URL</li>
<li><code>headers</code>: 请求头</li>
<li><code>parameterHandlers</code>: 参数处理器数组</li>
</ul>
</li>
</ul>
<h4 data-id="heading-16">4. ParameterHandler</h4>
<ul>
<li><strong>职责</strong>: 处理单个方法参数，应用到RequestBuilder</li>
<li><strong>实现类</strong>:
<ul>
<li><code>Path</code>: 处理@Path注解</li>
<li><code>Query</code>: 处理@Query注解</li>
<li><code>Header</code>: 处理@Header注解</li>
<li><code>Body</code>: 处理@Body注解</li>
<li><code>Field</code>: 处理@Field注解(FormEncoded)</li>
<li><code>Part</code>: 处理@Part注解(Multipart)</li>
</ul>
</li>
</ul>
<h4 data-id="heading-17">5. OkHttpCall</h4>
<ul>
<li><strong>职责</strong>: Retrofit的Call实现，内部委托给OkHttp的Call</li>
<li><strong>核心方法</strong>:
<ul>
<li><code>enqueue(Callback&lt;T&gt; callback)</code>: 异步执行</li>
<li><code>execute()</code>: 同步执行</li>
<li><code>parseResponse(okhttp3.Response rawResponse)</code>: 解析响应</li>
<li><code>await()</code>: 协程扩展，挂起并等待响应</li>
<li><code>awaitResponse()</code>: 协程扩展，返回完整Response对象</li>
</ul>
</li>
<li><strong>协程支持</strong>:
<ul>
<li>使用<code>suspendCancellableCoroutine</code>挂起协程</li>
<li>注册<code>invokeOnCancellation</code>回调处理协程取消</li>
<li>协程取消时自动调用<code>call.cancel()</code>取消网络请求</li>
</ul>
</li>
</ul>
<h4 data-id="heading-18">6. CallAdapter</h4>
<ul>
<li><strong>职责</strong>: 将Call转换为其他类型</li>
<li><strong>内置实现</strong>:
<ul>
<li><code>DefaultCallAdapter</code>: 直接返回Call</li>
<li><code>ExecutorCallbackCall</code>: 在指定Executor回调</li>
<li><code>CompletableFutureCallAdapter</code>: 转换为CompletableFuture (Java 8)</li>
</ul>
</li>
<li><strong>第三方实现</strong>:
<ul>
<li><code>RxJava3CallAdapter</code>: 转换为Observable/Single</li>
<li><code>CoroutineCallAdapter</code>: Kotlin协程支持</li>
</ul>
</li>
</ul>
<h4 data-id="heading-19">7. Converter</h4>
<ul>
<li><strong>职责</strong>: 对象与HTTP请求/响应体之间的转换</li>
<li><strong>实现</strong>:
<ul>
<li><code>GsonConverter</code>: JSON ↔ Java对象 (Gson)</li>
<li><code>MoshiConverter</code>: JSON ↔ Java对象 (Moshi)</li>
<li><code>JacksonConverter</code>: JSON ↔ Java对象 (Jackson)</li>
<li><code>ProtobufConverter</code>: Protobuf ↔ Java对象</li>
<li><code>ScalarsConverter</code>: 原始类型(String/primitives)</li>
</ul>
</li>
</ul>
<h3 data-id="heading-20">工作流程总结</h3>
<h4 data-id="heading-21">标准流程（Call/RxJava）</h4>
<ol>
<li><strong>构建阶段</strong>: 创建Retrofit实例，配置baseUrl、OkHttpClient、Converter、CallAdapter</li>
<li><strong>代理创建</strong>: 使用JDK动态代理为API接口创建实例</li>
<li><strong>方法解析</strong>: 首次调用时解析方法注解，创建ServiceMethod并缓存</li>
<li><strong>请求构建</strong>: 应用参数处理器，将方法参数转换为OkHttp Request</li>
<li><strong>类型适配</strong>: 使用CallAdapter将OkHttpCall转换为目标返回类型</li>
<li><strong>执行请求</strong>: 委托给OkHttp执行网络请求</li>
<li><strong>响应转换</strong>: 使用Converter将响应体转换为Java对象</li>
<li><strong>结果回调</strong>: 通过Callback或其他方式返回结果</li>
</ol>
<h4 data-id="heading-22">协程流程（Suspend Function）</h4>
<ol>
<li><strong>构建阶段</strong>: 同标准流程</li>
<li><strong>代理创建</strong>: 同标准流程</li>
<li><strong>方法解析</strong>: 识别suspend函数，提取Continuation参数，创建SuspendForResponse</li>
<li><strong>请求构建</strong>: 同标准流程</li>
<li><strong>协程挂起</strong>: 使用suspendCancellableCoroutine挂起协程，不经过CallAdapter</li>
<li><strong>异步执行</strong>: 在IO调度器上通过OkHttp异步执行网络请求</li>
<li><strong>响应转换</strong>: 同标准流程，使用Converter转换</li>
<li><strong>协程恢复</strong>: 通过Continuation.resume恢复协程执行</li>
<li><strong>取消支持</strong>: 协程取消时自动取消OkHttp请求</li>
</ol>
<h4 data-id="heading-23">协程 vs 标准调用对比</h4>













































<table><thead><tr><th>特性</th><th>标准Call</th><th>Suspend函数</th></tr></thead><tbody><tr><td><strong>返回类型</strong></td><td><code>Call&lt;T&gt;</code></td><td>直接返回<code>T</code></td></tr><tr><td><strong>调用方式</strong></td><td><code>enqueue(callback)</code></td><td>直接调用，自动挂起</td></tr><tr><td><strong>线程切换</strong></td><td>通过Executor</td><td>通过协程调度器</td></tr><tr><td><strong>取消机制</strong></td><td>手动调用<code>call.cancel()</code></td><td>协程取消自动传播</td></tr><tr><td><strong>错误处理</strong></td><td>Callback回调</td><td>try-catch或协程异常处理</td></tr><tr><td><strong>CallAdapter</strong></td><td>需要</td><td>不需要</td></tr><tr><td><strong>生命周期</strong></td><td>手动管理</td><td>绑定CoroutineScope</td></tr></tbody></table>
<h3 data-id="heading-24">Retrofit vs OkHttp 职责划分</h3>

















<table><thead><tr><th>组件</th><th>职责</th></tr></thead><tbody><tr><td><strong>Retrofit</strong></td><td>注解解析、类型转换、动态代理、CallAdapter适配</td></tr><tr><td><strong>OkHttp</strong></td><td>HTTP连接、请求发送、响应接收、拦截器链、缓存</td></tr></tbody></table>
<p>Retrofit基于OkHttp构建，专注于提供类型安全的HTTP API抽象，而将底层网络通信委托给OkHttp处理。</p>
<hr/>
<blockquote>
<p>本文档深入剖析了Retrofit框架的内部工作机制，涵盖了从API接口创建到请求执行的完整流程。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Dify、n8n 还是 Coze？万字长文解析三大主流 AI Agent 平台]]></title>    <link>https://juejin.cn/post/7588095884070289408</link>    <guid>https://juejin.cn/post/7588095884070289408</guid>    <pubDate>2025-12-28T01:55:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588095884070289408" data-draft-id="7588093282530836532" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Dify、n8n 还是 Coze？万字长文解析三大主流 AI Agent 平台"/> <meta itemprop="keywords" content="Agent,人工智能"/> <meta itemprop="datePublished" content="2025-12-28T01:55:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AlanHou"/> <meta itemprop="url" content="https://juejin.cn/user/62022837364253"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Dify、n8n 还是 Coze？万字长文解析三大主流 AI Agent 平台
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/62022837364253/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AlanHou
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T01:55:27.000Z" title="Sun Dec 28 2025 01:55:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读24分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我们正在见证人工智能应用构建方式的一次根本性转变。过去需要大量机器学习工程师才能完成的工作，如今正越来越多地通过可视化、拖拽式界面来实现。<strong>平台经济已经来到 AI 领域</strong>，并随之带来了一种耐人寻味的能力民主化进程。</p>
<p>曾经，我们需要手写 HTML、手动部署服务器；而现在，我们使用 WordPress 和 AWS乃至Vercel这样的部署平台。同样地，<strong>构建智能代理正从纯代码优先的方式，过渡到平台原生、低代码的范式</strong>。</p>
<p>这种转变并非偶然——它反映了工程成熟度的一条深层规律：<strong>当一项技术发展到足够复杂且稳定的阶段，人类必然会将其抽象为可复用的平台</strong>。低代码 AI 平台，正是自主代理与 LLM 应用走向成熟的标志性时刻。</p>
<h2 data-id="heading-0">为什么低代码平台在当下至关重要</h2>
<p>低代码 AI 平台的商业论证极具说服力，但其价值主张不仅仅在于简单的效率指标。</p>
<ul>
<li><strong>首先是可访问性（普及性）。</strong> 传统的智能体开发（如 ReAct 和 Plan-and-Solve 框架）要求扎实的工程基础。你需要理解 API 编排、状态管理、错误处理和并发执行。低代码平台将这些复杂性抽象为可视化的节点。产品经理、领域专家和业务分析师现在可以参与构建智能体，而无需等待数周的工程周期。这将创新的人才池扩展到了软件团队之外。</li>
<li><strong>其次是生产力倍增器。</strong> 对于专业开发人员来说，这些平台极大地加速了原型设计。编写代码需要三天的工作——连接 API、构建重试逻辑、管理状态——通过可视化设计只需几小时即可完成。这在项目的早期阶段尤为重要，因为我们仍处于验证想法阶段。平台处理“脚手架”工作；而你则可以专注于业务逻辑和提示词工程（Prompt Engineering）。</li>
<li><strong>第三是可观测性。</strong> 基于图（Graph）的平台提供了基于文本的日志无法比拟的端到端可见性。你可以看到数据在节点之间流动，即时识别瓶颈，并在不翻阅终端输出的情况下调试失败的步骤。这不仅是方便——它加速了优化智能体行为所必需的反馈循环。</li>
<li><strong>最后是标准化优势。</strong> 领先的平台将行业最佳实践直接嵌入其设计中。知识检索管道、智能体框架和工具调用模式——这些通常都是内置的，防止团队重复造轮子，并确保跨项目的一致性。</li>
</ul>
<p><strong>核心洞察：</strong> 低代码平台并不会消除编码。它们提升了抽象层级，使我们能够将工程精力集中在最重要的地方——<strong>业务差异化</strong>，而不是基础设施的管道铺设。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a325ba8239840d2a9321f9895afea9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWxhbkhvdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767491727&amp;x-signature=3vLNOw2EpXG%2Bn%2FYBBw%2BD5KmyK74%3D" alt="为什么低代码平台在当下至关重要" loading="lazy"/></p>
<h2 data-id="heading-1">当前格局：三种截然不同的路径</h2>
<p>今天的智能体平台生态系统大致分为三个阵营，每个阵营都针对不同的优先级和用例进行了优化。</p>
<ol>
<li><strong>Dify</strong> 将自己定位为企业级的一站式技术栈。它处理从原型到生产的全生命周期：工作流、RAG（检索增强生成）管道、智能体编排、模型管理和可观测性。它特别适合那些构建需要长期维护和扩展的应用程序的团队。</li>
<li><strong>n8n</strong> 以不同的方式应对这个问题。它从根本上是一个<strong>吸收了 AI 能力的工作流自动化平台</strong>，而不是一个增加了工作流功能的 AI 平台。这个区别很重要。n8n 的优势在于将 AI 集成到复杂的业务流程中——连接 CRM 系统、自动化文档处理、编排多系统工作流，在这些场景中，语言模型虽然强大，但只是众多组件中的一个。</li>
<li><strong>Coze (扣子)</strong> ，字节跳动的平台，针对速度和可访问性进行了优化。如果说 Dify 是为工程师构建的，n8n 是为系统集成商构建的，那么 Coze 的目标就是快速实验和跨平台部署。它的优势在于让非技术用户能够在极短的时间内将可用的智能体发布到多个平台。</li>
</ol>
<p>这些不仅仅是 UI 上的细微差别。它们代表了关于“这些平台应该解决什么问题”以及“谁应该来解决这些问题”的根本不同的设计哲学。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7dc2c9b55bf406c835305f998c3ad11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWxhbkhvdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767491727&amp;x-signature=r5WERKSrPTMlABqRRCwGDN6SHd0%3D" alt="当前格局：三种截然不同的路径" loading="lazy"/></p>
<h2 data-id="heading-2">Dify：企业级基石</h2>
<h3 data-id="heading-3">架构与哲学</h3>
<p>Dify 诞生于这样一种认识：LLM 应用开发需要适当的工具。它是一个开源平台，将工作流编排、检索增强生成 (RAG)、智能体能力和运维基础设施聚合成一个系统。更重要的是，它从第一天起就是为<strong>生产就绪</strong>（Production-Ready）而设计的——团队显然是为那些需要服务真实用户而不仅仅是原型的应用程序设计的。</p>
<p>该平台使用分层架构：数据层处理知识库和上下文，开发层提供可视化工作流和提示词 IDE，编排层管理智能体逻辑和工具调用，以及跨不同 LLM 提供商的基础层抽象。这种关注点分离很重要。这意味着你可以更换向量数据库、更改 LLM 提供商或调整智能体策略，而无需重新来过。</p>
<h3 data-id="heading-4">生态系统的现状</h3>
<p>Dify 市场代表了架构上的重大进步。截至 2025 年 12 月，该市场托管了 600 多个插件，涵盖模型、工具、智能体策略、扩展和数据源。这不仅是数量的问题——这是一种向真正的<strong>插件优先架构</strong>的转变，新功能可以清晰地集成，而无需修改核心代码。</p>
<p>最近的市场新增功能凸显了平台的轨迹。Bright Data 于 2025 年 11 月加入，提供了直接输入知识管道的网页抓取功能。Tavily 添加了用于实时知识集成的 AI 优化网络搜索。这些不是事后的补充或补丁——它们是与内置功能并肩工作的一等公民插件。</p>
<p>2025 年推出的知识管道（Knowledge Pipeline）代表了 Dify 对 RAG 工程挑战的回应。它不再将文档处理成向量的过程视为黑盒，而是让每一步都可见且可调优。你可以看到文档解析、分块、清洗和嵌入作为离散的节点，你可以重新配置它们。文本提取在你的 PDF 上失败了？换一个不同的解析器。需要自定义分块逻辑？编写一个代码节点来处理它。这种透明度的价值远超其表象——RAG 的可靠性完全取决于正确处理这些平凡的细节。</p>
<h3 data-id="heading-5">生产应用的优势</h3>
<p><strong>值得强调的是Dify 支持多 LLM。</strong> 用户没有被锁定在 OpenAI 或任何单一提供商中。Dify 支持 GPT 模型、Anthropic Claude、通过 Ollama 的开源选项、像 AWS Bedrock 这样的专有提供商，以及兼容 OpenAI API 的自定义端点。这种灵活性对于成本优化和避免供应商锁定至关重要。提示词 IDE 允许你在不同模型之间可视化地测试和比较提示词——这一功能显著加速了优化工作。</p>
<p>企业安全功能非常全面。Dify 提供端到端加密、基于角色的访问控制 (RBAC)、审计日志记录，并支持云 SaaS 和本地部署。AWS 提供了 Dify Premium 作为单租户部署选项，供无法使用多租户服务的团队使用。这种灵活性——云端用于开发便利，私有部署用于敏感数据——正日益成为企业采用的标配。</p>
<h3 data-id="heading-6">现实的局限性</h3>
<p>Dify 确实有较陡峭的学习曲线。该平台之所以强大，正是因为它暴露了复杂性。非技术用户通常需要指导才能构建简单的聊天应用程序以外的东西。虽然可视化构建器很直观，但复杂的逻辑——多智能体系统、自定义记忆策略、复杂的工具编排——需要理解底层概念。这本身不是限制，而是一个需要意识到的约束。</p>
<p>高并发场景下的性能值得一提。Dify 的核心服务运行在 Python 上，这在本质上无法匹配 Go 或 Rust 等编译语言的吞吐量。对于处理数百个并发请求的应用程序，你可能需要在缓存、速率限制或自定义部署策略方面进行额外的工程投资。大多数中端市场和企业应用程序不会达到这一限制，但最好针对预期规模下进行测试。</p>
<p>RAG 基础虽然有所改进，仍需细致的工程设计。简单地上传文档并不能保证可靠的检索。分块策略非常重要。嵌入质量因模型而异。检索设置影响相关性和成本。Dify 消除了许多障碍，但并未消除对深思熟虑的数据准备的需求。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb9b8e7616994d27a5b600b601707d3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWxhbkhvdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767491727&amp;x-signature=N%2FJmumZCPPlsqs4MU3nD06f4A80%3D" alt="Dify： 开源LLM应用工程化平台架构" loading="lazy"/></p>
<h2 data-id="heading-7">n8n：AI 邂逅企业工作流自动化</h2>
<h3 data-id="heading-8">独特的定位</h3>
<p>n8n 在平台生态系统中占据着独特的地位。很明确它是一个<strong>包含 AI 功能的工作流自动化工具</strong>，而不是一个<strong>增加了自动化功能的 AI 平台</strong>。这种区别——不是简单的语言游戏——产生了根本不同的特征。</p>
<p>在其核心，n8n 连接各种应用程序。该平台包含数百个预构建节点：从 Gmail 触发事件，使用代码节点转换数据，更新 Salesforce 记录，发布到 Slack，以及查询数据库。在这个自动化框架内，你嵌入了 AI 能力。一个 LLM 节点成为更大流程中的一个组件。这正是 n8n 的亮点——使 AI 成为复杂业务逻辑中被编排的一部分，而不是整个应用程序。</p>
<p>n8n 中的工作流模型非常优雅。每个工作流都有且仅有一个触发节点（何时开始），并可以包含多个常规节点（做什么）。数据作为结构化的 JSON 在节点之间流动，提供了透明度和精确度。你可以使用 If/Else 节点进行分支逻辑，使用 Loop 节点循环数据，并使用 Merge 节点聚合结果。这种抽象对于复杂场景来说足够强大，对于可视化设计来说又足够简单。</p>
<h3 data-id="heading-9">2025 年的 AI 集成</h3>
<p>n8n 的 AI 集成方法已相当成熟。该平台现在包括专用的 AI Agent 节点，处理自主推理和工具选择。与手动在节点之间路由不同，Agent 节点在内部协调多步推理。定义可用的工具，设定目标，然后智能体决定执行策略。</p>
<p>社区贡献依然强劲。截至 2025 年 11 月，经过验证的社区节点开始出现在 n8n Cloud 上，而不仅仅是在自托管实例中。最初的推出包括大约 25 个社区构建和合作伙伴支持的节点。从 OCR 功能（从图像中提取文本）到网页抓取（Firecrawl, Apify）再到专门的 AI 服务。这标志着一个成熟的生态系统，最好的社区贡献获得了“一等公民”的地位。</p>
<h3 data-id="heading-10">实际优势</h3>
<p><strong>n8n 的主要优势是集成广度。</strong> 如果你需要自动化涉及多个系统的流程——从 API 拉取数据，转换它，用 AI 丰富它，将结果存储在数据库中，并通过电子邮件和 Slack 通知利益相关者——n8n 丰富的预构建节点使这变得简单直接。你不是在系统之间搭建桥梁；桥梁已经存在了。</p>
<p>支持自托管的开源架构对许多组织来说很重要。可以保持对数据和执行的完全控制。核心功能无需外部 API 调用。没有供应商依赖的基础设施。随着公司优先考虑数据安全和运营独立性，这一点越来越有价值。</p>
<p>对于熟悉基本自动化概念的用户来说，学习曲线比 Dify 更宽容。如果你使用过 Zapier 或 IFTTT，n8n 的视觉范式会让你感觉很自然。大多数人可以在几小时内构建有用的工作流。</p>
<h3 data-id="heading-11">真正的约束</h3>
<p>最显著的限制是<strong>非持久化记忆问题</strong>。n8n 内置的简单记忆（Simple Memory）和简单向量存储（Simple Vector Store）纯粹在内存中运行。这在开发和测试期间工作正常，但生产部署必须用外部数据库替换这些——Redis 用于对话历史记录，Pinecone 或 Milvus 用于向量存储。这增加了前期并不总是显而易见的运营复杂性和基础设施成本。</p>
<p>随着工作流变得复杂，调试变得具有挑战性。虽然 n8n 提供了执行历史记录和节点级日志，但在具有分支逻辑的二十个节点中跟踪数据流需要系统性的调查。复杂的工作流可能变得难以维护。</p>
<p>版本控制和多用户协作无法与传统代码仓库的成熟度相匹配。虽然你可以将工作流导出为 JSON 文件，但比较版本之间的更改无法提供 <code>git diffs</code> 那样的清晰度。同时编辑同一工作流的团队可能会意外发生冲突。</p>
<p>极端规模（数千个并发请求）下的性能需要仔细的架构设计。n8n 基于节点的执行模型与专用服务相比增加了开销。大多数业务自动化用例永远不会触及这个天花板，但对于高频交易系统、大规模日志处理或类似的极端规模场景来说，这是一个真正的限制。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba2a29fe32764870ad6000570257e07b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWxhbkhvdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767491727&amp;x-signature=t2dXJHuKI2BxKqMt3qwjrCjDzh0%3D" alt="n8n：AI 邂逅企业工作流自动化" loading="lazy"/></p>
<h2 data-id="heading-12">Coze (扣子)：智能体创作的民主化</h2>
<h3 data-id="heading-13">普及优先的方法</h3>
<p>Coze 代表了一种不同的哲学：大幅降低准入门槛，使技术背景成为可选项。字节跳动的平台强调视觉美学和快速迭代。界面感觉不像传统的开发者工具，更像是积木，非程序员也可以直观地操作。</p>
<p>Coze 团队显然从中国的市场动态中吸取了教训。他们观察到，虽然推出了数以千计的聊天机器人式应用，但很少有获得市场牵引力的。他们得出结论，<strong>分发（Distribution）</strong> ——从单一界面发布到多个平台的能力——被低估了。因此，Coze 针对跨平台部署进行了优化。一次构建，只需极少步骤即可发布到微信、飞书、钉钉、Telegram、Discord 和 Web 端。</p>
<h3 data-id="heading-14">能力与集成</h3>
<p>Coze 的插件生态系统包括 400 多个预构建集成。与 Dify 的市场（强调可扩展性）或 n8n 的节点（强调广度）不同，Coze 的插件针对亚洲及全球日益相关的消费者和企业用例进行了优化。搜索 API、翻译服务、文档处理、电子商务 API——这些都能无缝集成。</p>
<p>该平台最近扩展到了字节跳动所谓的“AI Office”领域——能力不仅仅局限于聊天机器人，还延伸到了实际生产力。像 AI Excel（电子表格自动化）、AI Design（视觉生成）和协作工作流等功能表明其定位超越了基于聊天的界面，进入了赋能工作的智能体领域。</p>
<p>知识库的实现简单直接。上传文档、PDF 甚至结构化数据，Coze 处理索引。与工作流的集成意味着你的智能体可以在对话期间检索相关上下文。多模型支持（GPT-4, Gemini, Claude, Doubao）让你能针对成本或能力进行优化。</p>
<h3 data-id="heading-15">Coze 的卓越之处</h3>
<p>对于<strong>快速原型设计和实验</strong>，Coze 是真正的快。从一个空项目到一个发布的智能体，对于简单的用例来说，真的只需要 30 分钟。界面消除了技术摩擦。开发者不会被基础设施问题阻碍；他们专注于定义智能体行为和调整响应。</p>
<p><strong>分发倍增器</strong>是 Coze 的独特优势。从单一界面发布到多个平台解决了一个实际问题。大多数成功的智能体应用程序需要出现在用户已经花费时间的地方。Coze 让这变得简单直接。</p>
<p>成本门槛极低。你可以立即免费构建和发布智能体。如果你选择启用它，变现就会发生。这种“免费开始”的模式减少了决策摩擦，并允许在预算极低的情况下进行实验。</p>
<h3 data-id="heading-16">显著的局限性</h3>
<p><strong>MCP（模型上下文协议）支持明显缺失。</strong> 这一新兴标准使智能体能够以标准化的方式与外部工具和数据源进行交互。Coze 的专有插件系统虽然工作正常，但与更广泛的 MCP 生态系统不兼容，限制了互操作性和未来的灵活性。</p>
<p>插件配置的复杂性与 Coze 的易用性承诺相矛盾。虽然简单的插件很直接，但那些需要 API 密钥、OAuth 配置或多个参数的插件通常需要技术背景。高级工作流编排——条件逻辑、错误处理、复杂数据转换——需要许多目标用户不具备的 JavaScript 或 Python 知识。</p>
<p>导出能力有限。Coze 最近为付费层级添加了导出功能，但格式是专有的（Zip 文件而不是标准 JSON）。这意味着工作流无法轻易迁移到其他平台或与外部版本控制集成。你实际上被锁定在 Coze 的生态系统中。</p>
<p>该平台的演进轨迹与字节跳动的业务优先级紧密相关。虽然目前的投资看起来很稳固，但公司的地缘政治定位和战略调整可能会影响长期的平台承诺。这代表了与开源项目或拥有更多样化投资组合的大型平台公司不同的风险概况。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42a86c2434b042ca96f99c8287f29233~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWxhbkhvdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767491727&amp;x-signature=uMZUMep5ubDJQtr7dyO5SXrCyig%3D" alt="Coze：让代理“人人可做”" loading="lazy"/></p>
<h2 data-id="heading-17">比较分析：选择合适的平台</h2>
<p><strong>用于快速原型设计和实验</strong> Coze 的速度优势很有意义。如果你主要关心的是以最少的设置快速验证想法，Coze 的准入门槛最低。你会立即获得生产力。权衡是针对复杂需求的灵活性降低和供应商锁定问题。 Dify 提供了一个中间地带。设置步骤比 Coze 多，但比 n8n 少。尽管学习曲线较陡，但原型设计速度令人印象深刻。一旦上手，你将保持更好的灵活性和生态系统独立性。 n8n 的设置开销最高，但前提是你还没有将其用于其他自动化需求。如果你的组织已经在使用 n8n 进行业务流程自动化，添加 AI 能力只需极少的额外投资。新组织面临更多的初始复杂性。</p>
<p><strong>用于企业生产部署：</strong> ify 的全面功能集——多 LLM 支持、企业安全、审计日志、私有部署选项——使其成为组织构建计划维护多年的应用程序的自然选择。 如果你要将 AI 集成到现有的业务流程自动化中，n8n 会胜出。它提供了复杂企业工作流所需的集成广度和可扩展性。生态系统足够成熟，可以进行大规模生产部署，尽管基础设施规划很重要。 Coze 通常不是此用例的平台。虽然技术上可行，但其设计理念优先考虑快速实验而非长期可维护性。对于概念验证（PoC）和分发比技术灵活性更重要的面向客户的应用程序来说，它是一个极好的平台。</p>
<p><strong>用于自定义业务逻辑和集成复杂性：</strong> n8n 的集成广度无可匹敌。如果你需要以复杂的模式连接 API、数据库和服务，同时嵌入 AI 智能，n8n 提供了最优雅的解决方案。该平台本质上擅长成为你技术栈中的“结缔组织”。 如果你的复杂性集中在 AI 逻辑上——复杂的智能体编排、复杂的 RAG 需求和多模型编排，Dify 效果很好。它的工作流构建器可以有效地处理这些问题，尽管在非 AI 系统的集成广度上无法与 n8n 匹敌。 如果需要超出其插件生态系统的复杂自定义逻辑，Coze 就会受到限制。它不是为此用例设计的。</p>
<p><strong>用于团队和扩展：</strong> Dify 的基于角色的访问控制、工作区管理和可观测性工具很好地支持团队协作。该平台随组织从单个开发人员发展到企业团队而成长。 n8n 需要更仔细的基础设施规划以进行团队扩展。随着团队的发展，版本控制挑战变得更加明显。然而，已经运行复杂自动化栈的组织可以将 n8n 工作流集成到其现有的部署实践中。 Coze 的协作功能正在不断发展。多用户工作区支持正在开发中，但目前的团队扩展能力比 Dify 更有限。</p>
<h2 data-id="heading-18">“小孩子才做选择，大人全都要”</h2>
<p>通过深入了解这三个平台得出的结论是：它们并非处于竞争关系，而是在解决 AI 应用生态系统中的不同问题。</p>
<p>最成熟的组织正在采用<strong>混合方法</strong>。他们使用 Coze 或 Dify 进行快速实验和面向客户的应用程序。他们利用 n8n 将 AI 能力集成到现有的业务流程自动化中。他们使用代码优先开发来处理平台无法有效处理的特殊需求。</p>
<p>这种“多平台融合”（Polyglot Platform）的方法反映了成熟度。它承认不同的工具擅长解决不同的问题。解决方案空间足够大，没有任何单一平台可以主宰。</p>
<p><strong>考虑一个具体的场景：</strong> 一家金融服务公司想要构建一个 AI 智能体来分析客户数据、检索相关法规并生成初步贷款决策。他们可能会使用 <strong>Dify</strong> 来构建核心智能体——利用其 RAG 功能进行法规检索和多模型支持以优化成本。同时，他们使用 <strong>n8n</strong> 创建工作流，当贷款申请到达时触发 Dify 的智能体，提取决策输出，并将结果输入其传统的贷款管理系统。为了对此智能体进行快速的面向客户的实验，他们在 <strong>Coze</strong> 中构建原型，以便在投资更深度的集成之前验证市场反应。</p>
<p>这不是为了复杂而复杂。这是实用主义。每个平台都将其特定的优势贡献给更大的架构。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58d22f715fa648509e34cf56a58cd310~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWxhbkhvdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767491727&amp;x-signature=hCL2%2BJMenM3ECokbooPrqyZeq0M%3D" alt="选择合适的平台" loading="lazy"/></p>
<h2 data-id="heading-19">值得关注的新兴趋势</h2>
<ul>
<li><strong>插件生态系统正在成熟。</strong> Dify 的 600+ 插件、n8n Cloud 上的验证社区节点以及 Coze 不断扩展的插件库表明，生态系统正变得比核心平台功能更重要。在 2025 年及以后，平台选择应着重权衡生态系统的广度和质量。</li>
<li><strong>智能体能力正在常态化。</strong> 所有三个平台现在都将自主智能体视为一等公民功能，而不是高级用例。这反映了全行业的共识，即多步推理和工具使用是有价值的 AI 应用的基础，而不是边缘情况。</li>
<li><strong>多模型编排正在成为标准。</strong> 单一 LLM 提供商平台的时代正在结束。在同一个应用程序中支持 GPT、Claude、本地模型和专用提供商越来越受到期待。实现真正的<strong>模型中立性</strong>的平台将具有竞争优势。</li>
<li><strong>实时数据集成至关重要。</strong> 连接到实时数据源（如 Dify 的 Bright Data 和 Tavily 集成）的知识管道架构越来越有价值。静态知识库很快就会过时；实时数据连接使智能体能够提供当前、准确的信息。</li>
</ul>
<h2 data-id="heading-20">做出你的平台选择</h2>
<p>在选择低代码智能体平台时，请按顺序考虑这些问题：</p>
<ol>
<li><strong>你的时间节点？</strong> 几天或几周建议使用 Coze。几个月建议使用 Dify 或 n8n，具体取决于复杂性。更长的时间表支持更详细的评估。</li>
<li><strong>你团队的技术背景是什么？</strong> 非技术团队倾向于 Coze。混合团队更喜欢 Dify。自动化专家青睐 n8n。</li>
<li><strong>你将如何衡量成功？</strong> 市场速度和分发范围有利于 Coze。生产可靠性和可扩展性有利于 Dify。与现有系统的集成有利于 n8n。</li>
<li><strong>你对平台依赖的风险承受能力如何？</strong> 开源和自托管选项（Dify 和 n8n）降低了供应商锁定风险。Coze 的专有生态系统具有较高的转换成本。</li>
<li><strong>你的用例有多复杂？</strong> 简单的聊天机器人适合任何平台。复杂的工作流和智能体编排有利于 Dify 或 n8n。跨平台的简单部署有利于 Coze。</li>
</ol>
<h3 data-id="heading-21">我们正处于 AI 平台专业化时代</h3>
<p>我们不再争论低代码 AI 平台是否足以用于生产——这个问题已经解决了。我们现在争论的是<strong>哪种专用平台最能解决你的特定问题</strong>。</p>
<p>应用于 AI 智能体的平台经济并不是要取代专业工程。它是提升工程师用更少的代码和更少的基础设施管道所能完成的事情。一个小团队现在可以构建以前需要更大的工程部门才能完成的应用程序。这不是工程技艺的丧失——这是应用在更高抽象层级上的工程技艺。</p>
<p>这里研究的三个平台——Dify、n8n 和 Coze——各自代表了应对这一挑战的有效方法。它们已经足够成熟，可以支持大规模的生产应用。未来不是关于一个平台的一统天下；而是关于为每个问题选择正确的工具，并将它们作为更广泛技术战略的一部分进行集成。</p>
<p>在 2025 年及以后，<strong>平台素养（Platform Literacy）</strong> 将成为 AI 从业者的核心技能。了解每个平台的优势所在，识别每个平台能够很好解决的问题，并能够评估新兴竞争对手，将比在任何单一平台上的深厚专业知识更重要。快速构建原型、评估选项以及在平台之间进行深思熟虑的集成的能力，将区分成功的团队和那些仍在争论基础问题的团队。</p>
<p>“<strong>以第一性原理自己构建</strong>”的时代正在让位于“<strong>用强大的平台智能组装</strong>”的时代。这不仅是一种妥协——这是一项技术达到成熟的标志。对于 AI 智能体而言，我们显然已经到了这一步。</p>
<p>原文链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmedium.com%2Faimonks%2Fthe-rise-of-low-code-ai-agent-platforms-mastering-dify-n8n-and-coze-in-2025-cbd8aad04ae7" target="_blank" title="https://medium.com/aimonks/the-rise-of-low-code-ai-agent-platforms-mastering-dify-n8n-and-coze-in-2025-cbd8aad04ae7" ref="nofollow noopener noreferrer">The Rise of Low-Code AI Agent Platforms: Mastering Dify, n8n, and Coze in 2025</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Transformer入门：一文读懂《Attention Is All You Need》]]></title>    <link>https://juejin.cn/post/7588093282530852916</link>    <guid>https://juejin.cn/post/7588093282530852916</guid>    <pubDate>2025-12-28T02:18:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588093282530852916" data-draft-id="7588124225701969960" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Transformer入门：一文读懂《Attention Is All You Need》"/> <meta itemprop="keywords" content="算法,架构"/> <meta itemprop="datePublished" content="2025-12-28T02:18:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三斗米"/> <meta itemprop="url" content="https://juejin.cn/user/3157453124416622"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Transformer入门：一文读懂《Attention Is All You Need》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3157453124416622/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三斗米
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T02:18:33.000Z" title="Sun Dec 28 2025 02:18:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">引言：颠覆NLP领域的新架构</h3>
<p>2017年，一篇名为《Attention Is All You Need》的论文横空出世，正如其标题所揭示的，它宣告了一个仅凭“注意力机制”就能独当一面的新时代。这篇论文介绍的Transformer模型，彻底颠覆了当时自然语言处理（NLP）领域的格局。</p>
<p>在Transformer出现之前，序列建模任务（如机器翻译）一直由循环神经网络（RNN）及其变体（如长短期记忆网络LSTM）所主导。然而，这类模型存在一个根本性的瓶颈：它们的计算过程具有“内在的顺序性”（inherently sequential nature）。这意味着模型必须按顺序处理序列中的每一个词，这种机制严重限制了计算的并行性，也使得学习长距离的词语依赖关系变得异常困难。</p>
<p>为了解决这一问题，研究者们提出了Transformer——一个完全摒弃了循环和卷积结构，完全基于注意力机制（based solely on attention mechanisms）的新型网络架构。它不仅在性能上超越了以往所有的模型，更凭借其出色的并行计算能力，极大地缩短了训练时间。论文指出，Transformer模型“可以在八块P100 GPU上仅训练十二个小时”就能达到当时最先进的翻译质量。</p>
<p>本文将遵循原论文的脉络，从整体架构、核心机制到关键组件，为您深入浅出地解析Transformer的精髓。</p>
<hr/>
<h3 data-id="heading-1">1. Transformer的整体架构：宏观视角</h3>
<p>从宏观上看，Transformer遵循了当时主流序列建模任务中非常成熟的编码器-解码器（Encoder-Decoder）结构。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c59954b494214dd9b5d14f7b98ab7d4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ5paX57Gz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767493113&amp;x-signature=B1c5bHjemTZoSMozINwm3RfGhWc%3D" alt="1.png" loading="lazy"/></p>
<p>如上图所示，模型的左半部分是编码器，右半部分是解码器。</p>
<h4 data-id="heading-2">编码器（Encoder）</h4>
<p>编码器的核心任务是将输入的符号序列 <code>(x1, ..., xn)</code> 映射成一个连续的向量表示 <code>z = (z1, ..., zn)</code>。这个 <code>z</code> 包含了输入序列的全部信息。</p>
<p>为了实现这一目标，编码器由<code>N=6</code>个完全相同的层堆叠而成。每一层又包含两个核心的子层：</p>
<ol>
<li><strong>多头自注意力机制（multi-head self-attention）</strong> ：负责捕捉输入序列内部的依赖关系。</li>
<li><strong>简单的、按位置的全连接前馈网络（position-wise fully connected feed-forward network）</strong> ：对注意力层的输出进行非线性变换。</li>
</ol>
<p>值得注意的是，在每个子层的周围，都使用了一个残差连接（residual connection）和层归一化（layer normalization）操作，这有助于稳定训练过程并提升模型性能。</p>
<h4 data-id="heading-3">解码器（Decoder）</h4>
<p>解码器的任务则是在接收编码器输出的 <code>z</code> 之后，生成一个输出符号序列 <code>(y1, ..., ym)</code>。它也同样由<code>N=6</code>个相同的层堆叠而成。</p>
<p>解码器的每一层在编码器两个子层的基础上，额外插入了第三个子层：</p>
<ol>
<li><strong>带掩码的多头自注意力机制（Masked Multi-Head Attention）</strong> ：与编码器类似，但通过掩码（masking）来“防止位置关注到后续位置”（prevent positions from attending to subsequent positions）。这种掩码机制，结合训练时将输出嵌入向右偏移一个位置的做法，共同确保了在预测第 <code>i</code> 个词时，只能依赖于 <code>i</code> 之前的输出，从而保证了模型的自回归（auto-regressive）特性。</li>
<li><strong>编码器-解码器多头注意力（Encoder-Decoder Multi-Head Attention）</strong> ：这一层执行多头注意力机制，但其查询（queries）来自前一个解码器子层，而键（keys）和值（values）则来自编码器的最终输出。这使得解码器在生成每个词时都能关注到输入序列的全部信息。</li>
<li><strong>按位置的全连接前馈网络</strong>：结构和作用与编码器中的相同。</li>
</ol>
<p>同样，解码器中的每个子层也采用了残差连接和层归一化。</p>
<hr/>
<h3 data-id="heading-4">2. 核心机制：深入理解注意力</h3>
<p>既然注意力（Attention）是Transformer的唯一核心，那么它究竟是如何工作的呢？</p>
<h4 data-id="heading-5">2.1 什么是注意力？</h4>
<p>论文中将注意力机制描述为一个映射过程：它将一个查询（Query）和一组键值对（Key-Value pairs）映射到一个输出。</p>
<p>可以这样理解：</p>
<ul>
<li><strong>Query (Q)</strong> ：代表当前需要关注的焦点。</li>
<li><strong>Key (K)</strong> ：代表序列中可供注意的各个元素。</li>
<li><strong>Value (V)</strong> ：代表这些元素实际包含的信息。</li>
</ul>
<p>注意力的输出是所有<strong>值（Values）</strong> <strong>加权和（weighted sum）</strong> 。而每个值对应的权重，则是由查询（Query）<strong>与它对应的</strong>键（Key）<strong>通过一个</strong>兼容性函数（compatibility function）计算得出的。简单来说，就是Q和K越匹配，对应V的权重就越大。</p>
<h4 data-id="heading-6">2.2 缩放点积注意力 (Scaled Dot-Product Attention)</h4>
<p>Transformer中使用的具体注意力实现被称为“缩放点积注意力”。</p>
<p>其计算过程可以分解为以下四步：</p>
<ol>
<li><strong>计算点积</strong>：计算查询（Q）与所有键（K）的点积，得到它们之间的相似度分数。</li>
<li><strong>缩放</strong>：将上一步得到的所有分数除以一个缩放因子 <code>√dk</code>（其中<code>dk</code>是键向量的维度）。论文的脚注解释了为何需要缩放：当<code>dk</code>的值较大时，点积的结果量级会变得很大，这会将Softmax函数推向梯度极小的区域，不利于模型训练。缩放操作可以有效缓解这个问题。</li>
<li><strong>Softmax归一化</strong>：将缩放后的分数输入Softmax函数，得到范围在0到1之间的权重。所有权重之和为1。</li>
<li><strong>加权求和</strong>：用这些权重乘以对应的值（V），然后将它们相加，得到最终的注意力输出。</li>
</ol>
<p>整个过程可以用一个简洁的公式来表示： <code>Attention(Q, K, V) = softmax( (QK^T) / √dk ) V</code></p>
<h4 data-id="heading-7">2.3 多头注意力 (Multi-Head Attention)</h4>
<p>论文作者发现，与其用<code>d_model</code>（模型维度，如512）维度的Q、K、V执行一次注意力计算，不如将它们分别进行<code>h</code>次线性投影，变换到更低的维度（<code>dk</code>, <code>dk</code>, <code>dv</code>），然后并行地执行<code>h</code>次注意力计算。</p>
<p>这个过程如下：</p>
<ol>
<li>将原始的Q、K、V通过不同的线性变换（权重矩阵不同）投影<code>h</code>次。</li>
<li>并行地对这<code>h</code>组投影后的Q、K、V分别执行一次“缩放点积注意力”计算。</li>
<li>将<code>h</code>个注意力计算的输出结果拼接（concatenate）起来。</li>
<li>将拼接后的结果再次进行一次线性投影，得到最终的输出。</li>
</ol>
<p>这种机制的好处在于，正如论文所说：“多头注意力允许模型在不同位置共同关注来自不同表示子空间的信息。”（Multi-head attention allows the model to jointly attend to information from different representation subspaces at different positions.）换句话说，不同的“头”（head）可以学习关注不同方面的信息，比如有的头关注语法结构，有的头关注语义关联，从而增强了模型的表达能力。</p>
<p>在论文中，作者使用了<code>h=8</code>个并行的注意力头。对于维度为512的<code>d_model</code>，每个头处理的维度被缩小为<code>dk = dv = 512/8 = 64</code>。这清晰地体现了将一个大问题分解为多个小问题并行处理的思想。</p>
<hr/>
<h3 data-id="heading-8">3. 注意力在Transformer中的三大应用场景</h3>
<p>多头注意力机制在Transformer模型中有三种不同的应用方式：</p>
<ul>
<li>
<p><strong>编码器-解码器注意力 (Encoder-Decoder Attention)</strong></p>
<ul>
<li>这是连接编码器和解码器的桥梁。它的<strong>查询（queries）</strong> 来自前一个解码器层，而键（keys）<strong>和</strong>值（values）则来自编码器的最终输出。</li>
<li>这使得解码器在生成每一个输出词时，都能够关注到输入序列中的所有位置，这与传统的序列到序列模型中的注意力机制非常相似。</li>
</ul>
</li>
<li>
<p><strong>编码器中的自注意力 (Encoder Self-Attention)</strong></p>
<ul>
<li>在编码器的自注意力层中，所有的键、值和查询（keys, values, and queries）都来自同一个地方——即编码器中前一层的输出。</li>
<li>这使得编码器中的每个位置都能关注到前一层输出的所有位置，从而捕捉输入序列内部的依赖关系。</li>
</ul>
</li>
<li>
<p><strong>解码器中的自注意力 (Decoder Self-Attention)</strong></p>
<ul>
<li>解码器中的自注意力层工作方式与编码器类似，但有一个关键区别：为了保持其自回归特性，必须阻止信息向左流动。</li>
<li>这是通过在缩放点积注意力中引入掩码（masking）实现的。具体而言，在计算softmax之前，它会把所有对应于非法连接（即关注当前位置之后的位置）的值设置为负无穷（-∞）。这样一来，这些位置在经过softmax函数后，其权重会变为0，从而确保预测时只能依赖于已生成的输出序列。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-9">4. 不可或缺的辅助组件</h3>
<p>虽然注意力是核心，但Transformer的成功也离不开一些关键的辅助组件。</p>
<h4 data-id="heading-10">4.1 位置编码 (Positional Encoding)</h4>
<p>由于Transformer模型完全摒弃了循环和卷积，它本身无法感知序列中词语的顺序。例如，对于模型来说，“我爱你”和“你爱我”在没有位置信息的情况下是完全一样的。为了解决这个问题，模型必须引入一些关于序列顺序的信息。</p>
<p>解决方案是在编码器和解码器堆栈底部的输入嵌入（input embeddings）中加入“位置编码”。论文中使用了一种基于不同频率的正弦（sine）和余弦（cosine）函数的固定编码方法。作者选择这种函数的原因是，他们假设这能让模型更容易地学习通过相对位置来进行关注，并且这种方法可能让模型能够推广到比训练时遇到的序列更长的序列。</p>
<h4 data-id="heading-11">4.2 按位置的前馈网络 (Position-wise Feed-Forward Networks)</h4>
<p>在每个编码器和解码器层中，除了注意力子层外，还有一个全连接的前馈网络。这个网络被独立且相同地应用于序列中的每一个位置。</p>
<p>它由两个线性变换和一个ReLU激活函数组成，可以用以下公式表示：</p>
<p><code>FFN(x) = max(0, xW1 + b1)W2 + b2</code></p>
<p>这个组件为模型增加了非线性变换能力，进一步增强了模型的表达能力。在论文的模型中，输入和输出的维度<code>d_model</code>是512，而网络中间层的维度<code>d_ff</code>是2048。这意味着前馈网络首先将表示从512维扩展到2048维，经过ReLU激活后再投影回512维，从而增加了模型的表征容量。</p>
<hr/>
<h3 data-id="heading-12">5. 为什么是自注意力？</h3>
<p>与当时主流的循环层（Recurrent Layer）相比，自注意力机制究竟有何优势？论文从三个方面进行了比较。</p>

























<table><thead><tr><th>特性</th><th>自注意力层 (Self-Attention)</th><th>循环层 (Recurrent)</th></tr></thead><tbody><tr><td><strong>每层计算复杂度</strong></td><td>O(n² · d)</td><td>O(n · d²)</td></tr><tr><td><strong>可并行计算量</strong></td><td>O(1)</td><td>O(n)</td></tr><tr><td><strong>长距离依赖的学习路径长度</strong></td><td>O(1)</td><td>O(n)</td></tr></tbody></table>
<ul>
<li><strong>计算复杂度</strong>：当序列长度<code>n</code>小于表示维度<code>d</code>时，自注意力层的计算速度比循环层更快。这在最先进的机器翻译模型中是非常常见的情况。</li>
<li><strong>并行度</strong>：自注意力机制的计算是常数级别的（O(1)个顺序操作），因为它一次性计算所有位置的注意力，可以大规模并行。而循环层需要<code>O(n)</code>个顺序操作，必须按时间步逐个计算，限制了并行能力。</li>
<li><strong>长距离依赖</strong>：在自注意力网络中，任意两个位置之间的信号传播路径长度都是<code>O(1)</code>，因为它们可以直接交互。而在循环网络中，信号需要从头到尾依次传播，路径长度是<code>O(n)</code>。路径越短，学习长距离依赖关系就越容易，也更能避免RNN中常见的梯度消失或爆炸问题。</li>
</ul>
<hr/>
<h3 data-id="heading-13">6. 成果与结论</h3>
<p>Transformer模型在两个主流的机器翻译任务上取得了卓越的成果。在WMT 2014英德翻译任务上，它取得了28.4的BLEU分数，比之前包括集成模型在内的最佳结果高出整整2.0分。同样地，在WMT 2014英法翻译任务上，该模型也创造了新的单模型SOTA记录，BLEU分数达到了41.8。</p>
<p>更重要的是它的训练效率。论文指出，Transformer的训练速度“明显更快”（significantly faster），其训练成本仅为其他竞争模型的一小部分。</p>
<p>最后，论文的核心贡献可以总结为：提出了Transformer，这是第一个完全基于注意力机制的序列转导模型。它用多头自注意力（multi-headed self-attention）取代了编码器-解码器架构中最常用的循环层，为序列建模领域开辟了一条全新的、更高效的道路。</p>
<hr/>
<p><strong>论文信息</strong></p>
<ul>
<li><strong>论文标题</strong>: Attention Is All You Need</li>
<li><strong>作者</strong>: Ashish Vaswani, Noam Shazeer, Niki Parmar, et al.</li>
<li><strong>发表会议</strong>: NIPS 2017</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[构建AI智能体：六十六、智能的边界：通过偏差-方差理论理解大模型的能力与局限]]></title>    <link>https://juejin.cn/post/7588092534162440192</link>    <guid>https://juejin.cn/post/7588092534162440192</guid>    <pubDate>2025-12-28T02:43:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588092534162440192" data-draft-id="7588043318359654435" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="构建AI智能体：六十六、智能的边界：通过偏差-方差理论理解大模型的能力与局限"/> <meta itemprop="keywords" content="人工智能,Python"/> <meta itemprop="datePublished" content="2025-12-28T02:43:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="彼岸花开了吗"/> <meta itemprop="url" content="https://juejin.cn/user/4153315734334538"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            构建AI智能体：六十六、智能的边界：通过偏差-方差理论理解大模型的能力与局限
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4153315734334538/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    彼岸花开了吗
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T02:43:55.000Z" title="Sun Dec 28 2025 02:43:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、前言</h2>
<p>最近我们分享模型拟合和早停机制时，都涉及到了“偏差-方差权衡”的概念，那么什么是偏差，什么又是方差，隐含了哪些新奇巧妙的知识点，今天我们来一探究竟。首先，我们找一个通俗的例子，初步理解偏差和方差表达的基础概念，想象这样一个场景，我们班级里有三种类型的学生：</p>
<ul>
<li>A类学生：死记硬背课本内容，遇到原题能得高分，但题目稍作变化就不知所措</li>
<li>B类学生：理解知识本质，能够举一反三，在各种题型中都能稳定发挥</li>
<li>C类学生：思维跳跃，有时能给出惊艳的答案，但经常偏离正轨，表现极不稳定</li>
</ul>
<p>这三类学习对应的三种学习模式，恰好对应了机器学习中的高偏差、平衡状态、高方差三种情况。姑且先摸索着有个初步的理解，接下来我们详细的去探讨每类学生对应的偏差-方差原理。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/abf8b1b7530c453a985042e821c96869~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b285bK46Iqx5byA5LqG5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767494753&amp;x-signature=bYN%2Fc7uRZJPCyFXqDMXaZaWafRY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">二、基础概念</h2>
<h3 data-id="heading-2">1. 偏差（Bias）</h3>
<p>偏差衡量的是模型预测值的平均值与真实值之间的差异，它反映了模型对数据基本模式的捕捉能力。</p>
<p>**简单理解：**偏差就像射击时的瞄准误差。如果你总是射向靶心的左边，那么你的瞄准系统就有系统性偏差。</p>
<p>**通俗理解：**好比学生的学习方法，如果学生只会死记硬背，那么无论给他多少学习资料，他都无法真正理解知识本质，总是给出表面化的答案，这样就会导致高偏差，主要体现系统性误差。</p>
<p><strong>高偏差的特征：</strong></p>
<ul>
<li>模型过于简单</li>
<li>无法捕捉数据的复杂模式，表现为欠拟合</li>
<li>训练误差和测试误差都很高</li>
</ul>
<p>**技术定义：**模型预测的平均值与真实值之间的差异，反映了模型对数据基本模式的捕捉能力。</p>
<p><strong>大模型中的表现：</strong></p>
<ul>
<li>高偏差模型：只能生成训练数据中常见的模式化回答</li>
<li>低偏差模型：能够理解问题本质，给出有深度的见解</li>
</ul>
<h3 data-id="heading-3">2. 方差（Variance）</h3>
<p>方差衡量的是模型预测值的波动程度，它反映了模型对训练数据微小变化的敏感性。</p>
<p>**简单理解：**方差就像射击时的手部稳定性，即使你瞄准正确，但每次射击的位置都很分散，说明你的稳定性差（方差大）。</p>
<p>**通俗理解：**好比学生的发挥稳定性，如果学生思维过于发散，可能偶尔给出天才般的答案，但也经常给出完全离谱的回答，这样会导致高方差，主要体现不稳定性。</p>
<p><strong>高方差的特征：</strong></p>
<ul>
<li>模型过于复杂</li>
<li>过度拟合训练数据中的噪声，表现为过拟合</li>
<li>训练误差低但测试误差高</li>
</ul>
<p>**技术定义：**模型预测值的波动程度，反映了模型对训练数据变化的敏感性。</p>
<p><strong>大模型中的表现：</strong></p>
<ul>
<li>高方差模型：相同问题可能得到完全不同的答案，表现不稳定</li>
<li>低方差模型：对相似问题给出一致的回答，表现可靠</li>
</ul>
<h3 data-id="heading-4">3. 噪声（Noise）</h3>
<p>噪声是数据中固有的随机误差，无法通过任何模型减少，它代表了数据的不可约简的不确定性。</p>
<p>**简单理解：**噪声就像射击时突然刮风或者靶子轻微移动，这些是你无法控制的外部因素。</p>
<p>**通俗理解：**就像靶子本身在移动或有风影响，即使你瞄准正确，子弹也可能偏离，这代表数据中的随机误差，无法控制。</p>
<h2 data-id="heading-5">三、偏差-方差分解的数学原理</h2>
<h3 data-id="heading-6">1. 核心公式</h3>
<p>对于回归问题，期望预测误差可以分解为：</p>
<p><strong>总误差 = 偏差² + 方差 + 噪声</strong></p>
<p>数学表达式：</p>
<p><strong>E[(y - ŷ)²] = [Bias(ŷ)]² + Var(ŷ) + σ²</strong></p>
<p>其中：</p>
<ul>
<li>y 是真实值</li>
<li>ŷ 是模型预测值</li>
<li>σ² 是噪声方差</li>
</ul>
<p>公式含义详解：</p>
<ul>
<li>偏差² (Bias²)：<strong>Bias(ŷ) = E[ŷ] - y</strong> 模型预测的平均值与真实值的差异</li>
<li>方差 (Variance)：<strong>Var(ŷ) = E[(ŷ - E[ŷ])²]</strong> 模型预测值的波动程度</li>
<li>噪声 (Noise)：<strong>σ² = E[(y - f(x))²]</strong> 数据中固有的随机误差</li>
</ul>
<h3 data-id="heading-7">2. 实例助解</h3>
<p><strong>2.1 射击类比，想象你在学习射击：</strong></p>
<ul>
<li>低偏差 + 低方差：神枪手
<ul>
<li>瞄准准确（低偏差）</li>
<li>手很稳（低方差）</li>
<li>弹着点集中在靶心</li>
</ul>
</li>
<li>高偏差 + 低方差：系统性误差
<ul>
<li>瞄准偏左（高偏差）</li>
<li>手很稳（低方差）</li>
<li>弹着点集中在靶心左侧</li>
</ul>
</li>
<li>低偏差 + 高方差：不稳定射手
<ul>
<li>瞄准准确（低偏差）</li>
<li>手不稳（高方差）</li>
<li>弹着点分散在靶心周围</li>
</ul>
</li>
<li>高偏差 + 高方差：新手
<ul>
<li>瞄准不准（高偏差）</li>
<li>手不稳（高方差）</li>
<li>弹着点分散且偏离靶心</li>
</ul>
</li>
</ul>
<p><strong>2.2 学习考试类比，想象学生在准备考试：</strong></p>
<ul>
<li>低偏差 + 低方差：学霸
<ul>
<li>真正理解知识（低偏差）</li>
<li>发挥稳定（低方差）</li>
<li>每次考试都高分</li>
</ul>
</li>
<li>高偏差 + 低方差：死记硬背型
<ul>
<li>没有真正理解（高偏差）</li>
<li>发挥稳定（低方差）</li>
<li>成绩稳定但不高</li>
</ul>
</li>
<li>低偏差 + 高方差：聪明但不稳定
<ul>
<li>理解知识（低偏差）</li>
<li>发挥不稳定（高方差）</li>
<li>有时高分有时低分</li>
</ul>
</li>
<li>高偏差 + 高方差：学困生
<ul>
<li>不理解知识（高偏差）</li>
<li>发挥不稳定（高方差）</li>
<li>成绩差且波动大</li>
</ul>
</li>
</ul>
<h2 data-id="heading-8">四、大模型中的理解差异</h2>
<h3 data-id="heading-9">1. 数学解题中的偏差-方差现象</h3>
<p>大模型在数学问题上会出现的表现：</p>
<p><strong>1.1 高偏差表现（死记硬背）：</strong></p>
<blockquote>
<p>用户：一个长方形的长是8cm，宽是5cm，面积是多少？<br/>
模型：长方形的面积是长乘以宽，所以是40平方厘米。</p>
<p>用户：一个平行四边形的底是8cm，高是5cm，面积是多少？<br/>
模型：长方形的面积是长乘以宽，所以是40平方厘米。</p>
</blockquote>
<p>模型机械地套用"长方形面积公式"，没有理解面积计算的本质原理。</p>
<p><strong>1.2 高方差表现（过度发散）：</strong></p>
<blockquote>
<p>用户：一个长方形的长是8cm，宽是5cm，面积是多少？<br/>
模型：可能是40平方厘米，或者需要考虑单位换算？也许是800平方毫米？<br/>
也可能是周长？让我想想，周长是(8+5)×2=26cm...</p>
</blockquote>
<p>模型过度思考，引入了不必要的复杂性，导致答案不稳定。</p>
<p><strong>1.3 平衡状态（真正理解）：</strong></p>
<blockquote>
<p>用户：一个长方形的长是8cm，宽是5cm，面积是多少？<br/>
模型：面积=长×宽=8×5=40平方厘米。</p>
<p>用户：一个平行四边形的底是8cm，高是5cm，面积是多少？<br/>
模型：平行四边形面积=底×高=8×5=40平方厘米。</p>
</blockquote>
<p>模型理解了不同图形面积计算的本质原理，能够正确应用相应公式。</p>
<h3 data-id="heading-10">2. 语言理解中的层次差异</h3>
<p><strong>2.1 高偏差理解（表面理解）：</strong></p>
<blockquote>
<p>文本："他心如刀割"<br/>
模型理解：他心脏被刀子切割（字面意思）</p>
</blockquote>
<p><strong>2.2 高方差理解（过度解读）：</strong></p>
<blockquote>
<p>文本："他心如刀割"<br/>
模型理解：可能表示他经历了心脏手术，或者是某种宗教仪式，或者是...</p>
</blockquote>
<p><strong>2.3 平衡理解（真正理解）：</strong></p>
<blockquote>
<p>文本："他心如刀割"<br/>
模型理解：比喻极度痛苦的心情（正确理解比喻意义）</p>
</blockquote>
<h2 data-id="heading-11">五、偏差-方差分解示例</h2>
<p>我们将通过一个具体的多项式回归例子来逐步分解偏差-方差，并详细说明每一步。我们将使用多个训练集，每个训练集来自同一个真实函数加上噪声，然后训练不同复杂度的模型，并计算偏差、方差和总误差。</p>
<p><strong>示例步骤：</strong></p>
<ul>
<li>1. 定义真实函数（例如正弦函数）并生成多个训练数据集（每个数据集加上随机噪声）。</li>
<li>2. 选择不同复杂度的模型（例如不同次数的多项式）。</li>
<li>3. 对每个模型，在多个数据集上训练，并计算在测试集上的预测。</li>
<li>4. 对每个测试点，计算偏差、方差和总误差。</li>
<li>5. 绘制多个图表来展示偏差-方差分解。</li>
</ul>
<p>我们将使用以下公式（对于回归问题的均方误差）：总误差 = 偏差^2 + 方差 + 噪声</p>
<p>注意：我们假设噪声是已知的（因为我们生成的数据，我们知道噪声的方差）。</p>
<h3 data-id="heading-12">第一步：数据生成和真实函数可视化</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> PolynomialFeatures
<span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LinearRegression, Ridge
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> mean_squared_error
<span class="hljs-keyword">from</span> sklearn.pipeline <span class="hljs-keyword">import</span> Pipeline
<span class="hljs-keyword">import</span> seaborn <span class="hljs-keyword">as</span> sns
sns.set_style(<span class="hljs-string">"whitegrid"</span>)
<span class="hljs-comment"># 设置中文字体和样式</span>
plt.rcParams[<span class="hljs-string">'font.sans-serif'</span>] = [<span class="hljs-string">'SimHei'</span>]
plt.rcParams[<span class="hljs-string">'axes.unicode_minus'</span>] = <span class="hljs-literal">False</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">70</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"步骤1: 数据生成和真实函数可视化"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">70</span>)

<span class="hljs-comment"># 定义真实函数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">true_function</span>(<span class="hljs-params">x</span>):
    <span class="hljs-string">"""真实的目标函数 - 一个复杂的非线性函数"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">2</span> * np.sin(<span class="hljs-number">1.5</span> * np.pi * x) + <span class="hljs-number">0.5</span> * np.cos(<span class="hljs-number">4</span> * np.pi * x)

<span class="hljs-comment"># 生成数据参数</span>
np.random.seed(<span class="hljs-number">42</span>)
n_samples = <span class="hljs-number">50</span>
n_datasets = <span class="hljs-number">100</span>
noise_std = <span class="hljs-number">0.3</span>

<span class="hljs-comment"># 生成测试点</span>
x_test = np.linspace(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">200</span>)
y_test_true = true_function(x_test)

<span class="hljs-comment"># 生成一个示例训练集</span>
x_sample = np.random.uniform(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, n_samples)
y_sample = true_function(x_sample) + np.random.normal(<span class="hljs-number">0</span>, noise_std, n_samples)

<span class="hljs-comment"># 可视化真实函数和示例数据</span>
plt.figure(figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">6</span>))
plt.plot(x_test, y_test_true, <span class="hljs-string">'k-'</span>, linewidth=<span class="hljs-number">3</span>, label=<span class="hljs-string">'真实函数'</span>)
plt.scatter(x_sample, y_sample, s=<span class="hljs-number">50</span>, alpha=<span class="hljs-number">0.7</span>, color=<span class="hljs-string">'red'</span>, label=<span class="hljs-string">'带噪声的训练数据'</span>)
plt.xlabel(<span class="hljs-string">'x'</span>)
plt.ylabel(<span class="hljs-string">'y'</span>)
plt.title(<span class="hljs-string">'步骤1: 真实函数和训练数据示例'</span>, fontsize=<span class="hljs-number">14</span>, fontweight=<span class="hljs-string">'bold'</span>)
plt.legend()
plt.grid(<span class="hljs-literal">True</span>, alpha=<span class="hljs-number">0.3</span>)
plt.tight_layout()
plt.show()

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"真实函数: f(x) = 2*sin(1.5πx) + 0.5*cos(4πx)"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"每个训练集样本数: <span class="hljs-subst">{n_samples}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"噪声标准差: <span class="hljs-subst">{noise_std}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"示例训练集已生成，包含 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(x_sample)}</span> 个数据点"</span>)
</code></pre>
<p><strong>步骤1分析：</strong></p>
<ul>
<li>我们定义了一个复杂的真实函数，包含正弦和余弦成分</li>
<li>生成了带噪声的训练数据，模拟现实世界中的数据收集过程</li>
<li>噪声标准差为0.3，表示数据中存在中等程度的随机误差</li>
<li>这张图展示了我们要学习的目标函数和典型训练数据的分布</li>
</ul>
<p><strong>输出结果：</strong></p>
<blockquote>
<p>步骤1: 数据生成和真实函数可视化<br/>
--------------------------------------------------<br/>
真实函数: f(x) = 2*sin(1.5πx) + 0.5*cos(4πx)<br/>
每个训练集样本数: 50<br/>
噪声标准差: 0.3<br/>
示例训练集已生成，包含 50 个数据点</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2134b2f26cd4351b1aa938c11c24e9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b285bK46Iqx5byA5LqG5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767494753&amp;x-signature=WWH9xelPMy7QTbiJ9NDuICtGBtc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-13">第二步：定义不同复杂度的模型</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">print</span>("\n" + "=" * <span class="hljs-number">70</span>)
<span class="hljs-built_in">print</span>("步骤<span class="hljs-number">2</span>: 定义不同复杂度的模型")
<span class="hljs-built_in">print</span>("=" * <span class="hljs-number">70</span>)

# 定义不同复杂度的模型
models = {
    '线性模型 (高偏差)': <span class="hljs-built_in">Pipeline</span>([
        (<span class="hljs-string">'poly'</span>, <span class="hljs-built_in">PolynomialFeatures</span>(degree=<span class="hljs-number">1</span>)),
        (<span class="hljs-string">'linear'</span>, <span class="hljs-built_in">LinearRegression</span>())
    ]),
    <span class="hljs-string">'4次多项式 (平衡)'</span>: <span class="hljs-built_in">Pipeline</span>([
        (<span class="hljs-string">'poly'</span>, <span class="hljs-built_in">PolynomialFeatures</span>(degree=<span class="hljs-number">4</span>)),
        (<span class="hljs-string">'linear'</span>, <span class="hljs-built_in">LinearRegression</span>())
    ]),
    <span class="hljs-string">'15次多项式 (高方差)'</span>: <span class="hljs-built_in">Pipeline</span>([
        (<span class="hljs-string">'poly'</span>, <span class="hljs-built_in">PolynomialFeatures</span>(degree=<span class="hljs-number">15</span>)),
        (<span class="hljs-string">'linear'</span>, <span class="hljs-built_in">LinearRegression</span>())
    ]),
    <span class="hljs-string">'带正则化的15次多项式'</span>: <span class="hljs-built_in">Pipeline</span>([
        (<span class="hljs-string">'poly'</span>, <span class="hljs-built_in">PolynomialFeatures</span>(degree=<span class="hljs-number">15</span>)),
        (<span class="hljs-string">'linear'</span>, <span class="hljs-built_in">Ridge</span>(alpha=<span class="hljs-number">0.1</span>))  # 正则化减少方差
    ])
}

<span class="hljs-built_in">print</span>("定义的模型:")
for <span class="hljs-selector-tag">i</span>, (name, model) in <span class="hljs-built_in">enumerate</span>(models.items()):
    <span class="hljs-built_in">print</span>(f<span class="hljs-string">"  {i+1}. {name}"</span>)

# 可视化模型复杂度的概念
degrees = [<span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">15</span>, <span class="hljs-number">15</span>]  # 对应每个模型的复杂度
complexity_names = [<span class="hljs-string">'线性\n(简单)'</span>, <span class="hljs-string">'4次多项式\n(中等)'</span>, <span class="hljs-string">'15次多项式\n(复杂)'</span>, <span class="hljs-string">'正则化15次\n(复杂+约束)'</span>]

plt.<span class="hljs-built_in">figure</span>(figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">6</span>))
colors = [<span class="hljs-string">'red'</span>, <span class="hljs-string">'orange'</span>, <span class="hljs-string">'blue'</span>, <span class="hljs-string">'green'</span>]
bars = plt.<span class="hljs-built_in">bar</span>(complexity_names, degrees, color=colors, alpha=<span class="hljs-number">0.7</span>)

plt.<span class="hljs-built_in">ylabel</span>(<span class="hljs-string">'多项式次数'</span>)
plt.<span class="hljs-built_in">title</span>(<span class="hljs-string">'步骤2: 模型复杂度对比'</span>, fontsize=<span class="hljs-number">14</span>, fontweight=<span class="hljs-string">'bold'</span>)
plt.<span class="hljs-built_in">grid</span>(True, alpha=<span class="hljs-number">0.3</span>, axis=<span class="hljs-string">'y'</span>)

# 添加数值标签
for bar, degree in <span class="hljs-built_in">zip</span>(bars, degrees):
    plt.<span class="hljs-built_in">text</span>(bar.<span class="hljs-built_in">get_x</span>() + bar.<span class="hljs-built_in">get_width</span>()/<span class="hljs-number">2</span>, bar.<span class="hljs-built_in">get_height</span>() + <span class="hljs-number">0.1</span>, 
             f<span class="hljs-string">'{degree}次'</span>, ha=<span class="hljs-string">'center'</span>, va=<span class="hljs-string">'bottom'</span>, fontweight=<span class="hljs-string">'bold'</span>)

plt.<span class="hljs-built_in">tight_layout</span>()
plt.<span class="hljs-built_in">show</span>()

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n模型复杂度说明:"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"- 线性模型: 最简单的模型，只能拟合直线关系"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"- 4次多项式: 中等复杂度，可以拟合一些曲线"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"- 15次多项式: 高复杂度，可以拟合非常复杂的曲线"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"- 带正则化的15次多项式: 高复杂度但受约束，减少过拟合"</span>)
</code></pre>
<p><strong>步骤2分析：</strong></p>
<ul>
<li>我们定义了四种不同复杂度的模型来展示偏差-方差权衡</li>
<li>线性模型是最简单的，预期会有高偏差（欠拟合）</li>
<li>15次多项式是最复杂的，预期会有高方差（过拟合）</li>
<li>带正则化的15次多项式展示了如何通过约束来减少方差</li>
<li>模型复杂度从左到右递增，帮助我们观察偏差和方差的变化</li>
</ul>
<p><strong>输出结果：</strong></p>
<blockquote>
<p>步骤2: 定义不同复杂度的模型<br/>
--------------------------------------------------<br/>
定义的模型:<br/>
1. 线性模型 (高偏差)<br/>
2. 4次多项式 (平衡)<br/>
3. 15次多项式 (高方差)<br/>
4. 带正则化的15次多项式</p>
<p>模型复杂度说明:<br/>
- 线性模型: 最简单的模型，只能拟合直线关系<br/>
- 4次多项式: 中等复杂度，可以拟合一些曲线<br/>
- 15次多项式: 高复杂度，可以拟合非常复杂的曲线<br/>
- 带正则化的15次多项式: 高复杂度但受约束，减少过拟合</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a65efd8d03f74d25beb11fc154d591c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b285bK46Iqx5byA5LqG5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767494753&amp;x-signature=g8IpDklpnn%2FtyHAuuDlONXNL39g%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-14">第三步：单个数据集上的模型拟合对比</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">print</span>("\n" + "=" * <span class="hljs-number">70</span>)
<span class="hljs-built_in">print</span>("步骤<span class="hljs-number">3</span>: 单个数据集上的模型拟合对比")
<span class="hljs-built_in">print</span>("=" * <span class="hljs-number">70</span>)

# 训练所有模型并在单个数据集上可视化拟合效果
plt<span class="hljs-selector-class">.figure</span>(figsize=(<span class="hljs-number">12</span>, <span class="hljs-number">8</span>))

# 使用之前生成的示例数据
plt<span class="hljs-selector-class">.scatter</span>(x_sample, y_sample, s=<span class="hljs-number">50</span>, alpha=<span class="hljs-number">0.7</span>, color='green', label='训练数据')
plt<span class="hljs-selector-class">.plot</span>(x_test, y_test_true, 'k-', linewidth=<span class="hljs-number">3</span>, label='真实函数')

colors = <span class="hljs-selector-attr">[<span class="hljs-string">'red'</span>, <span class="hljs-string">'orange'</span>, <span class="hljs-string">'blue'</span>, <span class="hljs-string">'green'</span>]</span>
line_styles = <span class="hljs-selector-attr">[<span class="hljs-string">'-'</span>, <span class="hljs-string">'--'</span>, <span class="hljs-string">'-.'</span>, <span class="hljs-string">':'</span>]</span>

for <span class="hljs-selector-tag">i</span>, (name, model) in <span class="hljs-built_in">enumerate</span>(models.items()):
    model.<span class="hljs-built_in">fit</span>(x_sample.<span class="hljs-built_in">reshape</span>(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>), y_sample)
    y_pred_sample = model.<span class="hljs-built_in">predict</span>(x_test.<span class="hljs-built_in">reshape</span>(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>))
    
    # 计算该模型在此数据集上的误差
    train_error = <span class="hljs-built_in">mean_squared_error</span>(y_sample, model.<span class="hljs-built_in">predict</span>(x_sample.<span class="hljs-built_in">reshape</span>(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>)))
    test_error = <span class="hljs-built_in">mean_squared_error</span>(y_test_true, y_pred_sample)
    
    plt.<span class="hljs-built_in">plot</span>(x_test, y_pred_sample, line_styles[i], linewidth=<span class="hljs-number">2</span>, 
             label=f<span class="hljs-string">'{name}\n训练误差: {train_error:.3f}\n测试误差: {test_error:.3f}'</span>, 
             color=colors[i])

plt.<span class="hljs-built_in">xlabel</span>(<span class="hljs-string">'x'</span>)
plt.<span class="hljs-built_in">ylabel</span>(<span class="hljs-string">'y'</span>)
plt.<span class="hljs-built_in">title</span>(<span class="hljs-string">'步骤3: 单个数据集上的模型拟合对比'</span>, fontsize=<span class="hljs-number">14</span>, fontweight=<span class="hljs-string">'bold'</span>)
plt.<span class="hljs-built_in">legend</span>(bbox_to_anchor=(<span class="hljs-number">1.05</span>, <span class="hljs-number">1</span>), loc=<span class="hljs-string">'upper left'</span>)
plt.<span class="hljs-built_in">grid</span>(True, alpha=<span class="hljs-number">0.3</span>)
plt.<span class="hljs-built_in">tight_layout</span>()
plt.<span class="hljs-built_in">show</span>()

<span class="hljs-built_in">print</span>(<span class="hljs-string">"单个数据集上的拟合分析:"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"- 线性模型: 过于简单，无法捕捉曲线的复杂模式，训练误差和测试误差都较高"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"- 4次多项式: 能够较好地拟合数据，训练误差和测试误差相对平衡"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"- 15次多项式: 过度拟合训练数据，训练误差很低但测试误差较高"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"- 带正则化的15次多项式: 通过正则化减少了过拟合，测试误差有所改善"</span>)
</code></pre>
<p><strong>步骤3分析：</strong></p>
<ul>
<li>在单个数据集上，不同模型的拟合行为有明显差异</li>
<li>线性模型过于简单，无法捕捉真实函数的复杂模式，表现为欠拟合</li>
<li>15次多项式过度拟合训练数据，完美地穿过了所有训练点，但偏离了真实函数</li>
<li>4次多项式在简单和复杂之间取得了较好的平衡</li>
<li>带正则化的15次多项式通过约束参数，减少了过拟合程度</li>
</ul>
<p><strong>输出结果：</strong></p>
<blockquote>
<p>步骤3: 单个数据集上的模型拟合对比<br/>
--------------------------------------------------<br/>
单个数据集上的拟合分析:<br/>
- 线性模型: 过于简单，无法捕捉曲线的复杂模式，训练误差和测试误差都较高<br/>
- 4次多项式: 能够较好地拟合数据，训练误差和测试误差相对平衡<br/>
- 15次多项式: 过度拟合训练数据，训练误差很低但测试误差较高<br/>
- 带正则化的15次多项式: 通过正则化减少了过拟合，测试误差有所改善</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/956a6418923d40f29c52a854678629d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b285bK46Iqx5byA5LqG5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767494753&amp;x-signature=9KVlP7m3c6TpyVBcx982La6DqDQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-15">第四步：多个数据集上的预测分布</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">print</span>("\n" + "=" * <span class="hljs-number">70</span>)
<span class="hljs-built_in">print</span>("步骤<span class="hljs-number">4</span>: 多个数据集上的预测分布")
<span class="hljs-built_in">print</span>("=" * <span class="hljs-number">70</span>)

# 存储预测结果
predictions = {name: [] for name in models.<span class="hljs-built_in">keys</span>()}

<span class="hljs-built_in">print</span>("在多个数据集上训练模型...")
for <span class="hljs-selector-tag">i</span> in <span class="hljs-built_in">range</span>(n_datasets):
    # 生成新的训练数据
    x_train = np.random.<span class="hljs-built_in">uniform</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, n_samples)
    y_train = <span class="hljs-built_in">true_function</span>(x_train) + np.random.<span class="hljs-built_in">normal</span>(<span class="hljs-number">0</span>, noise_std, n_samples)
    
    # 对每个模型进行训练和预测
    for name, model in models.<span class="hljs-built_in">items</span>():
        model.<span class="hljs-built_in">fit</span>(x_train.<span class="hljs-built_in">reshape</span>(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>), y_train)
        y_pred = model.<span class="hljs-built_in">predict</span>(x_test.<span class="hljs-built_in">reshape</span>(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>))
        predictions[name].<span class="hljs-built_in">append</span>(y_pred)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"训练完成!"</span>)

# 选择一个点来展示预测分布
x_point = <span class="hljs-number">0.5</span>
y_true_point = <span class="hljs-built_in">true_function</span>(x_point)

# 可视化在x=<span class="hljs-number">0.5</span>处的预测分布
plt.<span class="hljs-built_in">figure</span>(figsize=(<span class="hljs-number">12</span>, <span class="hljs-number">8</span>))

for i, (name, preds) in <span class="hljs-built_in">enumerate</span>(predictions.<span class="hljs-built_in">items</span>()):
    point_preds = [pred[np.<span class="hljs-built_in">argmin</span>(np.<span class="hljs-built_in">abs</span>(x_test - x_point))] for pred in preds]
    
    # 计算统计量
    mean_pred = np.<span class="hljs-built_in">mean</span>(point_preds)
    std_pred = np.<span class="hljs-built_in">std</span>(point_preds)
    bias = mean_pred - y_true_point
    
    # 绘制预测分布
    plt.<span class="hljs-built_in">hist</span>(point_preds, alpha=<span class="hljs-number">0.6</span>, label=f<span class="hljs-string">'{name}\n均值: {mean_pred:.3f}\n标准差: {std_pred:.3f}\n偏差: {bias:.3f}'</span>, 
             bins=<span class="hljs-number">20</span>, color=colors[i])

# 标记真实值
plt.<span class="hljs-built_in">axvline</span>(x=y_true_point, color=<span class="hljs-string">'black'</span>, linestyle=<span class="hljs-string">'-'</span>, linewidth=<span class="hljs-number">3</span>, 
            label=f<span class="hljs-string">'真实值: {y_true_point:.3f}'</span>)

plt.<span class="hljs-built_in">xlabel</span>(f<span class="hljs-string">'在 x={x_point} 处的预测值'</span>)
plt.<span class="hljs-built_in">ylabel</span>(<span class="hljs-string">'频次'</span>)
plt.<span class="hljs-built_in">title</span>(<span class="hljs-string">'步骤4: 多个数据集上的预测分布 (反映方差)'</span>, fontsize=<span class="hljs-number">14</span>, fontweight=<span class="hljs-string">'bold'</span>)
plt.<span class="hljs-built_in">legend</span>(bbox_to_anchor=(<span class="hljs-number">1.05</span>, <span class="hljs-number">1</span>), loc=<span class="hljs-string">'upper left'</span>)
plt.<span class="hljs-built_in">grid</span>(True, alpha=<span class="hljs-number">0.3</span>)
plt.<span class="hljs-built_in">tight_layout</span>()
plt.<span class="hljs-built_in">show</span>()

<span class="hljs-built_in">print</span>(<span class="hljs-string">"预测分布分析:"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"- 线性模型: 预测分布集中，方差小，但均值偏离真实值（高偏差）"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"- 4次多项式: 预测分布相对集中，均值接近真实值（偏差和方差平衡）"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"- 15次多项式: 预测分布分散，方差大，但均值接近真实值（高方差）"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"- 带正则化的15次多项式: 预测分布比无正则化更集中，方差减小"</span>)
</code></pre>
<p><strong>步骤4分析：</strong></p>
<ul>
<li>通过在多个数据集上训练模型，我们可以看到每个模型的稳定性（方差）</li>
<li>线性模型的预测分布最集中，说明方差最小，但均值偏离真实值，说明偏差大</li>
<li>15次多项式的预测分布最分散，说明方差最大，但均值接近真实值，说明偏差小</li>
<li>4次多项式在偏差和方差之间取得了平衡</li>
<li>带正则化的模型减少了预测的分散程度，降低了方差</li>
</ul>
<p><strong>输出结果：</strong></p>
<blockquote>
<p>步骤4: 多个数据集上的预测分布<br/>
--------------------------------------------------<br/>
在多个数据集上训练模型...<br/>
正在处理第 1/100 个数据集...<br/>
正在处理第 21/100 个数据集...<br/>
正在处理第 41/100 个数据集...<br/>
正在处理第 61/100 个数据集...<br/>
正在处理第 81/100 个数据集...<br/>
训练完成!<br/>
预测分布分析:<br/>
- 线性模型: 预测分布集中，方差小，但均值偏离真实值（高偏差）<br/>
- 4次多项式: 预测分布相对集中，均值接近真实值（偏差和方差平衡）<br/>
- 15次多项式: 预测分布分散，方差大，但均值接近真实值（高方差）<br/>
- 带正则化的15次多项式: 预测分布比无正则化更集中，方差减小</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da7024bd06a841ccaa25d7409a8c6ae8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b285bK46Iqx5byA5LqG5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767494753&amp;x-signature=fMZZ1HEpBQreYF0TPaRc5D1gpKA%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-16">第五步：模型平均预测与真实函数对比</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">print</span>("\n" + "=" * <span class="hljs-number">70</span>)
<span class="hljs-built_in">print</span>("步骤<span class="hljs-number">5</span>: 模型平均预测与真实函数对比")
<span class="hljs-built_in">print</span>("=" * <span class="hljs-number">70</span>)

# 计算每个模型的平均预测
plt<span class="hljs-selector-class">.figure</span>(figsize=(<span class="hljs-number">12</span>, <span class="hljs-number">8</span>))

plt<span class="hljs-selector-class">.plot</span>(x_test, y_test_true, 'k-', linewidth=<span class="hljs-number">3</span>, label='真实函数')

for <span class="hljs-selector-tag">i</span>, (name, preds) in <span class="hljs-built_in">enumerate</span>(predictions.items()):
    preds_array = np.<span class="hljs-built_in">array</span>(preds)
    mean_prediction = np.<span class="hljs-built_in">mean</span>(preds_array, axis=<span class="hljs-number">0</span>)
    
    # 计算平均偏差
    avg_bias = np.<span class="hljs-built_in">mean</span>(mean_prediction - y_test_true)
    bias_squared = np.<span class="hljs-built_in">mean</span>((mean_prediction - y_test_true) ** <span class="hljs-number">2</span>)
    
    plt.<span class="hljs-built_in">plot</span>(x_test, mean_prediction, line_styles[i], linewidth=<span class="hljs-number">2</span>, 
             label=f<span class="hljs-string">'{name}\n平均偏差: {avg_bias:.3f}\n偏差平方: {bias_squared:.3f}'</span>, 
             color=colors[i])

plt.<span class="hljs-built_in">xlabel</span>(<span class="hljs-string">'x'</span>)
plt.<span class="hljs-built_in">ylabel</span>(<span class="hljs-string">'y'</span>)
plt.<span class="hljs-built_in">title</span>(<span class="hljs-string">'步骤5: 模型平均预测与真实函数对比 (反映偏差)'</span>, fontsize=<span class="hljs-number">14</span>, fontweight=<span class="hljs-string">'bold'</span>)
plt.<span class="hljs-built_in">legend</span>(bbox_to_anchor=(<span class="hljs-number">1.05</span>, <span class="hljs-number">1</span>), loc=<span class="hljs-string">'upper left'</span>)
plt.<span class="hljs-built_in">grid</span>(True, alpha=<span class="hljs-number">0.3</span>)
plt.<span class="hljs-built_in">tight_layout</span>()
plt.<span class="hljs-built_in">show</span>()

<span class="hljs-built_in">print</span>(<span class="hljs-string">"平均预测分析:"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"- 线性模型: 平均预测与真实函数差异最大，表现为高偏差"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"- 4次多项式: 平均预测能较好地跟踪真实函数，偏差较小"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"- 15次多项式: 平均预测最接近真实函数，偏差最小"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"- 带正则化的15次多项式: 平均预测接近无正则化版本，偏差很小"</span>)
</code></pre>
<p><strong>步骤5分析：</strong></p>
<ul>
<li>平均预测反映了模型的偏差，即模型预测的系统性误差</li>
<li>线性模型的平均预测是一条直线，与真实曲线差异明显，说明高偏差</li>
<li>15次多项式的平均预测最接近真实函数，说明低偏差</li>
<li>4次多项式的平均预测在大部分区域能较好地跟踪真实函数</li>
<li>这个图表清晰地展示了不同模型的偏差特性</li>
</ul>
<p><strong>输出结果：</strong></p>
<blockquote>
<p>步骤5: 模型平均预测与真实函数对比<br/>
--------------------------------------------------<br/>
平均预测分析:<br/>
- 线性模型: 平均预测与真实函数差异最大，表现为高偏差<br/>
- 4次多项式: 平均预测能较好地跟踪真实函数，偏差较小<br/>
- 15次多项式: 平均预测最接近真实函数，偏差最小<br/>
- 带正则化的15次多项式: 平均预测接近无正则化版本，偏差很小</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d828bf90b3e24f5f81c0f219414de94f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b285bK46Iqx5byA5LqG5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767494753&amp;x-signature=arM5F00n35eKYnm59QHW9D%2FqCtU%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-17">第六步：偏差-方差分解可视化</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">print</span>("\n" + "=" * <span class="hljs-number">70</span>)
<span class="hljs-built_in">print</span>("步骤<span class="hljs-number">6</span>: 偏差-方差分解可视化")
<span class="hljs-built_in">print</span>("=" * <span class="hljs-number">70</span>)

# 计算偏差、方差和总误差
results = {}
noise = noise_std ** <span class="hljs-number">2</span>

for name, preds in predictions<span class="hljs-selector-class">.items</span>():
    preds_array = np.<span class="hljs-built_in">array</span>(preds)
    mean_prediction = np.<span class="hljs-built_in">mean</span>(preds_array, axis=<span class="hljs-number">0</span>)
    
    # 计算偏差平方
    bias_squared = np.<span class="hljs-built_in">mean</span>((mean_prediction - y_test_true) ** <span class="hljs-number">2</span>)
    
    # 计算方差
    variance = np.<span class="hljs-built_in">mean</span>(np.<span class="hljs-built_in">var</span>(preds_array, axis=<span class="hljs-number">0</span>))
    
    # 计算总误差
    total_error = np.<span class="hljs-built_in">mean</span>([<span class="hljs-built_in">mean_squared_error</span>(y_test_true, pred) for pred in preds])
    
    results[name] = {
        'bias_squared': bias_squared,
        <span class="hljs-string">'variance'</span>: variance,
        <span class="hljs-string">'total_error'</span>: total_error,
        <span class="hljs-string">'noise'</span>: noise
    }

# 可视化偏差-方差分解
model_names = <span class="hljs-built_in">list</span>(results.keys())
bias_squared_vals = <span class="hljs-selector-attr">[results[name]</span><span class="hljs-selector-attr">[<span class="hljs-string">'bias_squared'</span>]</span> for name in model_names]
variance_vals = <span class="hljs-selector-attr">[results[name]</span><span class="hljs-selector-attr">[<span class="hljs-string">'variance'</span>]</span> for name in model_names]
noise_vals = <span class="hljs-selector-attr">[results[name]</span><span class="hljs-selector-attr">[<span class="hljs-string">'noise'</span>]</span> for name in model_names]
total_error_vals = <span class="hljs-selector-attr">[results[name]</span><span class="hljs-selector-attr">[<span class="hljs-string">'total_error'</span>]</span> for name in model_names]

plt<span class="hljs-selector-class">.figure</span>(figsize=(<span class="hljs-number">12</span>, <span class="hljs-number">8</span>))
x_pos = np<span class="hljs-selector-class">.arange</span>(len(model_names))
<span class="hljs-attribute">width</span> = <span class="hljs-number">0.2</span>

plt<span class="hljs-selector-class">.bar</span>(x_pos - <span class="hljs-number">1.5</span>*width, bias_squared_vals, width, label='偏差平方', alpha=<span class="hljs-number">0.8</span>, color='red')
plt<span class="hljs-selector-class">.bar</span>(x_pos - <span class="hljs-number">0.5</span>*width, variance_vals, width, label='方差', alpha=<span class="hljs-number">0.8</span>, color='blue')
plt<span class="hljs-selector-class">.bar</span>(x_pos + <span class="hljs-number">0.5</span>*width, noise_vals, width, label='噪声', alpha=<span class="hljs-number">0.8</span>, color='gray')
plt<span class="hljs-selector-class">.bar</span>(x_pos + <span class="hljs-number">1.5</span>*width, total_error_vals, width, label='总误差', alpha=<span class="hljs-number">0.6</span>, 
        color='black', edgecolor='red', linewidth=<span class="hljs-number">2</span>)

plt<span class="hljs-selector-class">.xlabel</span>('模型复杂度')
plt<span class="hljs-selector-class">.ylabel</span>('误差值')
plt<span class="hljs-selector-class">.title</span>('步骤<span class="hljs-number">6</span>: 偏差-方差分解 (总误差 = 偏差² + 方差 + 噪声)', fontsize=<span class="hljs-number">14</span>, fontweight='bold')
plt<span class="hljs-selector-class">.xticks</span>(x_pos, model_names, rotation=<span class="hljs-number">45</span>)
plt<span class="hljs-selector-class">.legend</span>()
plt<span class="hljs-selector-class">.grid</span>(True, alpha=<span class="hljs-number">0.3</span>)

# 添加数值标注
for <span class="hljs-selector-tag">i</span>, v in <span class="hljs-built_in">enumerate</span>(total_error_vals):
    plt.<span class="hljs-built_in">text</span>(i, v + <span class="hljs-number">0.01</span>, f<span class="hljs-string">'{v:.3f}'</span>, ha=<span class="hljs-string">'center'</span>, va=<span class="hljs-string">'bottom'</span>, fontweight=<span class="hljs-string">'bold'</span>)

plt.<span class="hljs-built_in">tight_layout</span>()
plt.<span class="hljs-built_in">show</span>()

<span class="hljs-built_in">print</span>(<span class="hljs-string">"偏差-方差分解结果:"</span>)
for name in model_names:
    bias_sq = results[name][<span class="hljs-string">'bias_squared'</span>]
    var = results[name][<span class="hljs-string">'variance'</span>]
    noise_val = results[name][<span class="hljs-string">'noise'</span>]
    total = results[name][<span class="hljs-string">'total_error'</span>]
    
    <span class="hljs-built_in">print</span>(f<span class="hljs-string">"\n{name}:"</span>)
    <span class="hljs-built_in">print</span>(f<span class="hljs-string">"  偏差平方: {bias_sq:.4f} ({bias_sq/total*100:.1f}%)"</span>)
    <span class="hljs-built_in">print</span>(f<span class="hljs-string">"  方差: {var:.4f} ({var/total*100:.1f}%)"</span>)
    <span class="hljs-built_in">print</span>(f<span class="hljs-string">"  噪声: {noise_val:.4f} ({noise_val/total*100:.1f}%)"</span>)
    <span class="hljs-built_in">print</span>(f<span class="hljs-string">"  总误差: {total:.4f}"</span>)
</code></pre>
<p><strong>步骤6分析：</strong></p>
<ul>
<li>这张图表清晰地展示了每个模型的误差组成</li>
<li>线性模型的主要误差来源是偏差（红色部分）</li>
<li>15次多项式的主要误差来源是方差（蓝色部分）</li>
<li>4次多项式在偏差和方差之间取得了较好的平衡</li>
<li>带正则化的15次多项式通过减少方差，降低了总误差</li>
<li>所有模型都有相同的噪声成分（灰色部分），这是数据固有的不可减少误差</li>
</ul>
<p><strong>输出结果：</strong></p>
<blockquote>
<p>步骤6: 偏差-方差分解可视化<br/>
--------------------------------------------------<br/>
偏差-方差分解结果:</p>
<p>线性模型 (高偏差):<br/>
偏差平方: 0.7832 (96.2%)<br/>
方差: 0.0306 (3.8%)<br/>
噪声: 0.0900 (11.1%)<br/>
总误差: 0.8137</p>
<p>4次多项式 (平衡):<br/>
偏差平方: 0.0461 (67.5%)<br/>
方差: 0.0222 (32.5%)<br/>
噪声: 0.0900 (131.6%)<br/>
总误差: 0.0684</p>
<p>15次多项式 (高方差):<br/>
偏差平方: 7.8403 (0.9%)<br/>
方差: 850.9843 (99.1%)<br/>
噪声: 0.0900 (0.0%)<br/>
总误差: 858.8245</p>
<p>带正则化的15次多项式:<br/>
偏差平方: 0.1624 (87.5%)<br/>
方差: 0.0233 (12.5%)<br/>
噪声: 0.0900 (48.5%)<br/>
总误差: 0.1857</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e983e1baf4f4b1db9ff9e4bdc2b844e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b285bK46Iqx5byA5LqG5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767494753&amp;x-signature=QGeNYntFU68Kbmslv%2BmttrguKlA%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-18">第七步：学习曲线分析</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">print</span>("\n" + "=" * <span class="hljs-number">70</span>)
<span class="hljs-built_in">print</span>("步骤<span class="hljs-number">7</span>: 学习曲线分析")
<span class="hljs-built_in">print</span>("=" * <span class="hljs-number">70</span>)

# 计算训练误差
train_errors = {name: [] for name in models.<span class="hljs-built_in">keys</span>()}

for name, preds in predictions<span class="hljs-selector-class">.items</span>():
    for i in <span class="hljs-built_in">range</span>(n_datasets):
        # 重新生成训练数据以计算训练误差
        x_train = np.random.<span class="hljs-built_in">uniform</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, n_samples)
        y_train = <span class="hljs-built_in">true_function</span>(x_train) + np.random.<span class="hljs-built_in">normal</span>(<span class="hljs-number">0</span>, noise_std, n_samples)
        
        model = models[name]
        model.<span class="hljs-built_in">fit</span>(x_train.<span class="hljs-built_in">reshape</span>(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>), y_train)
        y_pred_train = model.<span class="hljs-built_in">predict</span>(x_train.<span class="hljs-built_in">reshape</span>(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>))
        
        train_errors[name].<span class="hljs-built_in">append</span>(<span class="hljs-built_in">mean_squared_error</span>(y_train, y_pred_train))

# 计算平均训练误差和测试误差
avg_train_errors = [np.<span class="hljs-built_in">mean</span>(train_errors[name]) for name in model_names]
avg_test_errors = [results[name][<span class="hljs-string">'total_error'</span>] for name in model_names]

# 可视化学习曲线
plt.<span class="hljs-built_in">figure</span>(figsize=(<span class="hljs-number">12</span>, <span class="hljs-number">8</span>))
model_complexity = [<span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">15</span>, <span class="hljs-number">15</span>]  # 对应每个模型的复杂度

plt.<span class="hljs-built_in">plot</span>(model_complexity, avg_train_errors, <span class="hljs-string">'o-'</span>, linewidth=<span class="hljs-number">2</span>, markersize=<span class="hljs-number">8</span>, 
         label=<span class="hljs-string">'训练误差'</span>, color=<span class="hljs-string">'blue'</span>)
plt.<span class="hljs-built_in">plot</span>(model_complexity, avg_test_errors, <span class="hljs-string">'o-'</span>, linewidth=<span class="hljs-number">2</span>, markersize=<span class="hljs-number">8</span>, 
         label=<span class="hljs-string">'测试误差'</span>, color=<span class="hljs-string">'red'</span>)

# 标记每个点
for i, name in <span class="hljs-built_in">enumerate</span>(model_names):
    plt.<span class="hljs-built_in">annotate</span>(name, (model_complexity[i], avg_test_errors[i]), 
                textcoords=<span class="hljs-string">"offset points"</span>, xytext=(<span class="hljs-number">0</span>,<span class="hljs-number">10</span>), ha=<span class="hljs-string">'center'</span>, fontweight=<span class="hljs-string">'bold'</span>)

plt.<span class="hljs-built_in">xlabel</span>(<span class="hljs-string">'模型复杂度 (多项式次数)'</span>)
plt.<span class="hljs-built_in">ylabel</span>(<span class="hljs-string">'误差'</span>)
plt.<span class="hljs-built_in">title</span>(<span class="hljs-string">'步骤7: 学习曲线 - 训练误差 vs 测试误差'</span>, fontsize=<span class="hljs-number">14</span>, fontweight=<span class="hljs-string">'bold'</span>)
plt.<span class="hljs-built_in">legend</span>()
plt.<span class="hljs-built_in">grid</span>(True, alpha=<span class="hljs-number">0.3</span>)
plt.<span class="hljs-built_in">tight_layout</span>()
plt.<span class="hljs-built_in">show</span>()

<span class="hljs-built_in">print</span>(<span class="hljs-string">"学习曲线分析:"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"- 训练误差随模型复杂度增加而持续下降"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"- 测试误差先下降后上升，形成典型的U形曲线"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"- 最优模型复杂度在测试误差最低点，这里是4次多项式"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"- 15次多项式表现出明显的过拟合（训练误差低但测试误差高）"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"- 正则化有助于减少过拟合，使测试误差降低"</span>)
</code></pre>
<p><strong>步骤7分析：</strong></p>
<ul>
<li>学习曲线展示了模型复杂度与误差之间的关系</li>
<li>训练误差随复杂度增加而持续下降，复杂模型可以更好地拟合训练数据</li>
<li>测试误差先下降后上升，表明存在最优的模型复杂度</li>
<li>4次多项式位于测试误差的最低点，是偏差-方差权衡的最佳平衡点</li>
<li>15次多项式表现出明显的过拟合现象</li>
<li>这个图表直观地展示了偏差-方差权衡的原理</li>
</ul>
<p><strong>输出结果：</strong></p>
<blockquote>
<p>步骤7: 学习曲线分析<br/>
--------------------------------------------------<br/>
学习曲线分析:<br/>
- 训练误差随模型复杂度增加而持续下降<br/>
- 测试误差先下降后上升，形成典型的U形曲线<br/>
- 最优模型复杂度在测试误差最低点，这里是4次多项式<br/>
- 15次多项式表现出明显的过拟合（训练误差低但测试误差高）<br/>
- 正则化有助于减少过拟合，使测试误差降低</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4be6f7d049f406ba95c99df01bf82c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b285bK46Iqx5byA5LqG5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767494753&amp;x-signature=j98pcRchh7bK4Z0TEl0FwiqIMHU%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-19">第八步：综合总结与模型选择建议</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">print</span>("\n" + "=" * <span class="hljs-number">70</span>)
<span class="hljs-built_in">print</span>("步骤<span class="hljs-number">8</span>: 综合总结与模型选择建议")
<span class="hljs-built_in">print</span>("=" * <span class="hljs-number">70</span>)

# 找出最佳模型
best_model = <span class="hljs-built_in">min</span>(results.items(), key=lambda x: x[<span class="hljs-number">1</span>][<span class="hljs-string">'total_error'</span>])[<span class="hljs-number">0</span>]
<span class="hljs-built_in">print</span>(f<span class="hljs-string">"根据总误差，最佳模型是: {best_model}"</span>)

# 创建总结图表
fig, (ax1, ax2) = plt.<span class="hljs-built_in">subplots</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">15</span>, <span class="hljs-number">6</span>))

# 子图<span class="hljs-number">1</span>: 偏差-方差分解总结
components = [<span class="hljs-string">'偏差²'</span>, <span class="hljs-string">'方差'</span>, <span class="hljs-string">'噪声'</span>]
model_colors = [<span class="hljs-string">'red'</span>, <span class="hljs-string">'orange'</span>, <span class="hljs-string">'blue'</span>, <span class="hljs-string">'green'</span>]

for i, name in <span class="hljs-built_in">enumerate</span>(model_names):
    bias_ratio = results[name][<span class="hljs-string">'bias_squared'</span>] / results[name][<span class="hljs-string">'total_error'</span>]
    variance_ratio = results[name][<span class="hljs-string">'variance'</span>] / results[name][<span class="hljs-string">'total_error'</span>]
    noise_ratio = results[name][<span class="hljs-string">'noise'</span>] / results[name][<span class="hljs-string">'total_error'</span>]
    
    ratios = [bias_ratio, variance_ratio, noise_ratio]
    
    ax1.<span class="hljs-built_in">bar</span>(np.<span class="hljs-built_in">arange</span>(<span class="hljs-built_in">len</span>(components)) + i*<span class="hljs-number">0.2</span>, ratios, width=<span class="hljs-number">0.2</span>, 
            label=name, color=model_colors[i], alpha=<span class="hljs-number">0.7</span>)

ax1.<span class="hljs-built_in">set_xlabel</span>(<span class="hljs-string">'误差成分'</span>)
ax1.<span class="hljs-built_in">set_ylabel</span>(<span class="hljs-string">'比例'</span>)
ax1.<span class="hljs-built_in">set_title</span>(<span class="hljs-string">'各模型误差成分比例'</span>, fontweight=<span class="hljs-string">'bold'</span>)
ax1.<span class="hljs-built_in">set_xticks</span>(np.<span class="hljs-built_in">arange</span>(<span class="hljs-built_in">len</span>(components)) + <span class="hljs-number">0.3</span>)
ax1.<span class="hljs-built_in">set_xticklabels</span>(components)
ax1.<span class="hljs-built_in">legend</span>()
ax1.<span class="hljs-built_in">grid</span>(True, alpha=<span class="hljs-number">0.3</span>)

# 子图<span class="hljs-number">2</span>: 模型选择建议
recommendations = []
for name in model_names:
    bias_ratio = results[name][<span class="hljs-string">'bias_squared'</span>] / results[name][<span class="hljs-string">'total_error'</span>]
    variance_ratio = results[name][<span class="hljs-string">'variance'</span>] / results[name][<span class="hljs-string">'total_error'</span>]
    
    if bias_ratio &gt; <span class="hljs-number">0.6</span>:
        rec = <span class="hljs-string">"高偏差\n增加复杂度"</span>
        color = <span class="hljs-string">'red'</span>
    elif variance_ratio &gt; <span class="hljs-number">0.6</span>:
        rec = <span class="hljs-string">"高方差\n使用正则化"</span>
        color = <span class="hljs-string">'blue'</span>
    else:
        rec = <span class="hljs-string">"平衡\n表现良好"</span>
        color = <span class="hljs-string">'green'</span>
    
    recommendations.<span class="hljs-built_in">append</span>(rec)

bars = ax2.<span class="hljs-built_in">bar</span>(model_names, total_error_vals, color=model_colors, alpha=<span class="hljs-number">0.7</span>)
ax2.<span class="hljs-built_in">set_ylabel</span>(<span class="hljs-string">'总误差'</span>)
ax2.<span class="hljs-built_in">set_title</span>(<span class="hljs-string">'模型选择建议 (基于总误差)'</span>, fontweight=<span class="hljs-string">'bold'</span>)
ax2.<span class="hljs-built_in">set_xticklabels</span>(model_names, rotation=<span class="hljs-number">45</span>)

# 添加建议标注
for i, (bar, rec) in <span class="hljs-built_in">enumerate</span>(<span class="hljs-built_in">zip</span>(bars, recommendations)):
    ax2.<span class="hljs-built_in">text</span>(bar.<span class="hljs-built_in">get_x</span>() + bar.<span class="hljs-built_in">get_width</span>()/<span class="hljs-number">2</span>, bar.<span class="hljs-built_in">get_height</span>() + <span class="hljs-number">0.01</span>, 
             rec, ha=<span class="hljs-string">'center'</span>, va=<span class="hljs-string">'bottom'</span>, fontweight=<span class="hljs-string">'bold'</span>)

ax2.<span class="hljs-built_in">grid</span>(True, alpha=<span class="hljs-number">0.3</span>)

plt.<span class="hljs-built_in">tight_layout</span>()
plt.<span class="hljs-built_in">show</span>()

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n模型选择建议:"</span>)
for name in model_names:
    bias_ratio = results[name][<span class="hljs-string">'bias_squared'</span>] / results[name][<span class="hljs-string">'total_error'</span>]
    variance_ratio = results[name][<span class="hljs-string">'variance'</span>] / results[name][<span class="hljs-string">'total_error'</span>]
    
    <span class="hljs-built_in">print</span>(f<span class="hljs-string">"\n{name}:"</span>)
    if bias_ratio &gt; <span class="hljs-number">0.6</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"  → 主要问题: 高偏差 (欠拟合)"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"  → 建议: 增加模型复杂度，添加更多特征"</span>)
    elif variance_ratio &gt; <span class="hljs-number">0.6</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"  → 主要问题: 高方差 (过拟合)"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"  → 建议: 使用正则化，增加训练数据，减少特征"</span>)
    else:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"  → 状态: 偏差和方差相对平衡"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"  → 建议: 当前模型表现良好，可微调参数"</span>)

<span class="hljs-built_in">print</span>(f<span class="hljs-string">"\n最佳模型选择: {best_model}"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"总误差最小，在偏差和方差之间取得了最佳平衡"</span>)
</code></pre>
<p><strong>步骤8分析：</strong></p>
<ul>
<li>左侧图表显示了每个模型的误差成分比例</li>
<li>右侧图表提供了基于分析结果的模型选择建议</li>
<li>线性模型主要受高偏差影响，建议增加复杂度</li>
<li>15次多项式主要受高方差影响，建议使用正则化</li>
<li>4次多项式和带正则化的15次多项式表现相对平衡</li>
<li>4次多项式是总误差最小的模型，是最佳选择</li>
</ul>
<p><strong>输出结果：</strong></p>
<blockquote>
<p>步骤8: 综合总结与模型选择建议<br/>
--------------------------------------------------<br/>
根据总误差，最佳模型是: 4次多项式 (平衡)</p>
<p>模型选择建议:</p>
<p>线性模型 (高偏差):<br/>
→ 主要问题: 高偏差 (欠拟合)<br/>
→ 建议: 增加模型复杂度，添加更多特征</p>
<p>4次多项式 (平衡):<br/>
→ 主要问题: 高偏差 (欠拟合)<br/>
→ 建议: 增加模型复杂度，添加更多特征</p>
<p>15次多项式 (高方差):<br/>
→ 主要问题: 高方差 (过拟合)<br/>
→ 建议: 使用正则化，增加训练数据，减少特征</p>
<p>带正则化的15次多项式:<br/>
→ 主要问题: 高偏差 (欠拟合)<br/>
→ 建议: 增加模型复杂度，添加更多特征</p>
<p>最佳模型选择: 4次多项式 (平衡)<br/>
总误差最小，在偏差和方差之间取得了最佳平衡</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/baa19afe01ec4f42a53b320877fc4ba8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b285bK46Iqx5byA5LqG5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767494753&amp;x-signature=GRkP2r31nGrP89CjIsksKqTVed8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-20">示例总结</h3>
<p>通过这8个步骤的详细分析，我们全面理解了偏差-方差分解：</p>
<p><strong>1. 偏差：模型预测的平均值与真实值之间的差异</strong></p>
<ul>
<li>高偏差模型过于简单，无法捕捉数据中的复杂模式</li>
<li>表现为欠拟合，训练误差和测试误差都较高</li>
</ul>
<p><strong>2. 方差：模型对训练数据变化的敏感性</strong></p>
<ul>
<li>高方差模型过于复杂，过度拟合训练数据中的噪声</li>
<li>表现为过拟合，训练误差低但测试误差高</li>
</ul>
<p>**3. 噪声：**数据中固有的随机误差，无法通过模型减少</p>
<p><strong>4. 偏差-方差权衡：</strong></p>
<ul>
<li>简单模型：高偏差，低方差</li>
<li>复杂模型：低偏差，高方差</li>
<li>目标：找到平衡点，使总误差最小</li>
</ul>
<p><strong>5. 实际应用：</strong></p>
<ul>
<li>诊断模型问题是欠拟合还是过拟合</li>
<li>指导模型选择和调优策略</li>
<li>设置合理的性能期望</li>
</ul>
<p>这个逐步分析过程展示了如何通过偏差-方差分解来深入理解模型行为，并做出更明智的建模决策。</p>
<h2 data-id="heading-21">六、偏差-方差权衡</h2>
<p>说明偏差-方差权衡之前，先要了解清楚它与偏差-方差分解的区别，两者是完全不同的概念。</p>
<h3 data-id="heading-22">1. 核心区别</h3>
<p><strong>1.1 偏差-方差分解：</strong></p>
<ul>
<li>**基础理解：**是一个数学定理或分析框架</li>
<li>**作用：**将模型的期望误差分解为三个明确组成部分</li>
<li>**关注点：**误差的来源分析和定量计算</li>
</ul>
<p><strong>1.2 偏差-方差权衡：</strong></p>
<ul>
<li>**基础理解：**是一个现象或设计原则</li>
<li>**作用：**描述模型复杂度与泛化性能之间的权衡关系</li>
<li>**关注点：**模型选择的策略指导</li>
</ul>
<h3 data-id="heading-23">2. 深入理解</h3>
<p><strong>2.1 偏差-方差分解：</strong></p>
<ul>
<li>**公式表达：**总误差 = 偏差² + 方差 + 噪声</li>
<li>**核心思想：**任何监督学习模型的期望泛化误差都可以被分解为这三个不可约简的组成部分。</li>
<li><strong>应用场景：</strong>
<ul>
<li>诊断模型问题的具体来源</li>
<li>定量分析不同误差成分的贡献度</li>
<li>理解模型的理论性能界限</li>
</ul>
</li>
</ul>
<p><strong>2.2 偏差-方差权衡：</strong></p>
<ul>
<li><strong>核心现象：</strong>
<ul>
<li>随着模型复杂度增加：</li>
<li>- 偏差 ↓ (模型更能拟合训练数据)</li>
<li>- 方差 ↑ (模型对数据变化更敏感)</li>
<li>- 总误差先↓后↑ (存在最优复杂度点)</li>
</ul>
</li>
<li><strong>应用场景：</strong>
<ul>
<li>指导模型复杂度选择</li>
<li>制定正则化策略</li>
<li>平衡过拟合与欠拟合</li>
</ul>
</li>
</ul>
<h3 data-id="heading-24">3. 关系图示</h3>
<pre><code class="hljs language-scss" lang="scss">偏差-方差分解
    ↓ (提供理论基础)
误差成分分析
    ↓ (揭示内在规律)  
偏差-方差权衡现象
    ↓ (指导实践应用)
模型选择与优化
</code></pre>
<h3 data-id="heading-25">4. 场景剖析</h3>
<h4 data-id="heading-26">1. 多项式回归</h4>
<p><strong>1.1 使用偏差-方差分解：</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 分析一个15次多项式模型的误差来源</span>
bias² = 0.02    <span class="hljs-comment"># 偏差平方：模型平均预测与真实函数的差异</span>
<span class="hljs-attr">variance</span> = <span class="hljs-number">0.35</span> <span class="hljs-comment"># 方差：不同训练集上预测的波动</span>
<span class="hljs-attr">noise</span> = <span class="hljs-number">0.09</span>    <span class="hljs-comment"># 噪声：数据中的随机误差</span>
<span class="hljs-attr">total_error</span> = <span class="hljs-number">0.46</span>  <span class="hljs-comment"># 总误差 = 0.02 + 0.35 + 0.09</span>
</code></pre>
<p>**结论：**该模型主要问题是高方差（过拟合）</p>
<p><strong>1.2 使用偏差-方差权衡：</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 比较不同复杂度模型的权衡关系</span>
模型复杂度: <span class="hljs-section">[1次, 4次, 15次]</span>
偏差:      <span class="hljs-section">[0.45, 0.08, 0.02]</span>  <span class="hljs-comment"># 随复杂度增加而减少</span>
方差:      <span class="hljs-section">[0.04, 0.12, 0.35]</span>  <span class="hljs-comment"># 随复杂度增加而增加</span>
总误差:    <span class="hljs-section">[0.58, 0.29, 0.46]</span>  <span class="hljs-comment"># 先减少后增加</span>
</code></pre>
<p>**结论：**4次多项式在偏差和方差之间取得了最佳平衡</p>
<h4 data-id="heading-27">2. 大模型的训练</h4>
<p><strong>2.1 偏差-方差分解视角：</strong></p>
<ul>
<li>分析模型在特定任务上的错误类型</li>
<li>确定错误主要是由于知识缺乏（高偏差）还是不一致性（高方差）</li>
<li>为针对性改进提供依据</li>
</ul>
<p><strong>2.2 偏差-方差权衡视角：</strong></p>
<ul>
<li>决定预训练的数据量和模型参数量</li>
<li>调整微调阶段的学习率和正则化强度</li>
<li>在模型能力和泛化性能之间找到平衡点</li>
</ul>
<h3 data-id="heading-28">5. 差异总结</h3>
<ul>
<li>偏差-方差分解是"解剖分析"——把误差拆开看看里面有什么</li>
<li>偏差-方差权衡是"导航指导"——告诉你应该往哪个方向走</li>
</ul>
<h2 data-id="heading-29">七、总结</h2>
<p>通过偏差-方差的视角，我们能够清晰地看到大模型从死记硬背到真正理解的演进路径。这个过程不是简单的线性进步，而是在不同学习模式间的动态平衡。真正理解的本质，是在保持对基础知识准确掌握（低偏差）的同时，具备灵活应用和创造性思维的能力（适度方差）。这就像一位优秀的学者，既要有扎实的专业基础，又要有创新的思维方式。</p>
<p>当我们训练和使用大模型时，应该时刻关注这个平衡点：</p>
<ul>
<li>避免模型陷入机械记忆的陷阱（高偏差）</li>
<li>防止模型走向过度发散的极端（高方差）</li>
<li>追求深度理解与稳定表现的统一（最佳平衡）</li>
</ul>
<p>在这个意义上，偏差-方差理论不仅是一个技术框架，更是一种理解智能本质的哲学视角。它告诉我们，真正的智能既不是简单的模式识别，也不是无约束的随机发散，而是在约束与自由、确定与不确定之间找到的微妙平衡。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[不止是代码堆放：带你全面掌握 Monorepo 核心技术与选型]]></title>    <link>https://juejin.cn/post/7588109656041144366</link>    <guid>https://juejin.cn/post/7588109656041144366</guid>    <pubDate>2025-12-28T03:43:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588109656041144366" data-draft-id="7588080521445851182" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="不止是代码堆放：带你全面掌握 Monorepo 核心技术与选型"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-28T03:43:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="明月_清风"/> <meta itemprop="url" content="https://juejin.cn/user/1081575170131006"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            不止是代码堆放：带你全面掌握 Monorepo 核心技术与选型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1081575170131006/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    明月_清风
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T03:43:26.000Z" title="Sun Dec 28 2025 03:43:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在前端工程化日益复杂的今天，很多开发者对 <strong>Monorepo</strong> 的第一印象往往是：“不就是把好几个项目的代码塞进一个 Git 仓库吗？”</p>
<p>如果仅仅是“物理堆放”，那不仅不能提效，反而会带来权限混乱和构建缓慢的灾难。真正的 Monorepo 是一套<strong>工程化管理方案</strong>，它通过精妙的工具链，解决了多项目协作中代码复用、依赖同步和版本管理的痛点。</p>
<hr/>
<h2 data-id="heading-0">一、 为什么我们需要 Monorepo？</h2>
<p>在传统的 <strong>Multirepo</strong>（多仓库）模式下，如果你维护着一个组件库 <code>UI-Lib</code> 和三个业务项目，流程通常是这样的：</p>
<ol>
<li>修改 <code>UI-Lib</code> 的代码。</li>
<li>更新版本号，发布到 npm。</li>
<li>到三个业务项目中分别执行 <code>npm update</code>。</li>
<li>如果发现 Bug，重复上述步骤……</li>
</ol>
<p>这种“发布-拉取”的循环极大地浪费了开发时间。而 <strong>Monorepo</strong> 将它们置于同一工作区：</p>
<ul>
<li><strong>实时反馈</strong>：修改组件库，业务项目立即生效，无需发布 npm。</li>
<li><strong>原子重构</strong>：当你需要改动一个核心接口时，可以在同一个 Commit 中修改所有受影响的子项目，确保系统始终处于可用状态。</li>
</ul>
<hr/>
<h2 data-id="heading-1">二、 核心技术：支撑 Monorepo 的三根支柱</h2>
<p>要玩转 Monorepo，你必须掌握以下三个层面的技术选型：</p>
<h3 data-id="heading-2">1. 依赖管理层（Workspaces）</h3>
<p>这是 Monorepo 的心脏。它负责将仓库内的各个 Package 互相“软链接”，并统一管理第三方依赖。</p>
<ul>
<li><strong>pnpm Workspaces (首选)</strong> ：通过内容寻址存储，极大节省磁盘空间，并能严格禁止未声明的依赖访问（解决幻影依赖问题）。</li>
<li><strong>Yarn Workspaces</strong>：老牌方案，生态完善。</li>
</ul>
<h3 data-id="heading-3">2. 任务编排层（Build Pipeline）</h3>
<p>当仓库里有几十个项目时，运行 <code>npm run build</code> 如果要等半小时，那是不可接受的。我们需要“聪明”的工具：</p>
<ul>
<li><strong>Turborepo</strong>：由 Vercel 出品。核心能力是 <strong>指纹缓存（Hashing）</strong> ——如果代码没变，直接从缓存读取结果；以及 <strong>并行执行</strong>——自动分析依赖图谱，让互不影响的项目同时构建。</li>
<li><strong>Nx</strong>：功能更全面的“重型武器”，支持可视化依赖图谱分析，适合对构建流程有极致定制化需求的大厂。</li>
</ul>
<h3 data-id="heading-4">3. 发布与版本层（Versioning）</h3>
<p>如何决定哪个包需要发版？如何自动生成 Changelog？</p>
<ul>
<li><strong>Changesets</strong>：非常推荐。它通过在 PR 中添加描述文件，自动化处理版本更新和发布流程，尤其适合开源项目或多人协作。</li>
</ul>
<hr/>
<h2 data-id="heading-5">三、 选型指南：你真的需要它吗？</h2>
<p>Monorepo 不是银弹，它也有自己的“适用边界”：</p>






























<table><thead><tr><th><strong>维度</strong></th><th><strong>建议使用 Monorepo</strong></th><th><strong>建议保持 Multirepo</strong></th></tr></thead><tbody><tr><td><strong>项目关联度</strong></td><td>存在大量共享组件、工具类、类型定义。</td><td>各项目业务独立，几乎没有代码交集。</td></tr><tr><td><strong>技术栈</strong></td><td>统一使用 React 或 Vue，规范一致。</td><td>混合了多种框架或不同年代的老旧项目。</td></tr><tr><td><strong>团队规模</strong></td><td>中小型团队，追求快速迭代与低沟通成本。</td><td>跨部门超大型团队，对代码权限有极其严格限制。</td></tr><tr><td><strong>构建压力</strong></td><td>具备配置 Turborepo 等工具的能力。</td><td>没有专人维护配置，不愿增加构建工具复杂度。</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-6">四、 落地建议：从 0 到 1 的最优路径</h2>
<p>如果你准备在团队落地 Monorepo，建议采用这套**“黄金组合”**：</p>
<ol>
<li><strong>包管理</strong>：使用 <strong>pnpm</strong>。它的速度和依赖处理能力是目前社区的共识。</li>
<li><strong>脚手架</strong>：使用 <strong>Turborepo</strong>。它的学习曲线最平缓，只需一个 <code>turbo.json</code> 就能让构建速度起飞。</li>
<li><strong>语言</strong>：全量开启 <strong>TypeScript</strong>。Monorepo 的最大优势之一就是跨项目的类型安全——你修改了 A 包的接口定义，B 包在编译阶段就会直接报错。</li>
</ol>
<hr/>
<h3 data-id="heading-7">结语</h3>
<p>Monorepo 的本质是将<strong>管理复杂度</strong>转化为了<strong>工具链复杂度</strong>。虽然初期配置需要一定成本，但它带来的协同效率和代码复用率是无可比拟的。</p>
<p><strong>你想了解如何用 pnpm + Turborepo 搭建一个最小可运行的 Monorepo 模板吗？我可以为你提供具体的配置步骤。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain 二：输出结果定制与历史管理能力详解]]></title>    <link>https://juejin.cn/post/7588084804093886502</link>    <guid>https://juejin.cn/post/7588084804093886502</guid>    <pubDate>2025-12-28T02:11:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588084804093886502" data-draft-id="7588069469516234793" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain 二：输出结果定制与历史管理能力详解"/> <meta itemprop="keywords" content="LangChain,OpenAI,前端"/> <meta itemprop="datePublished" content="2025-12-28T02:11:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xiaoxue_"/> <meta itemprop="url" content="https://juejin.cn/user/4065372122398027"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain 二：输出结果定制与历史管理能力详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4065372122398027/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xiaoxue_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T02:11:10.000Z" title="Sun Dec 28 2025 02:11:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">LangChain 二：输出结果定制与历史管理能力大揭秘 ✨</h2>
<p>在 AI 应用开发中，我们常常面临两个核心问题：如何让大模型输出结构化的内容？如何让模型记住上下文实现多轮对话？今天就来深入探讨 LangChain 如何轻松解决这两个问题，结合实战代码带你掌握输出结果定制与历史管理的核心技能！</p>
<h3 data-id="heading-1">第一部分：JsonOutputParser 结果定制能力 🧩</h3>
<p>当我们调用大模型时，经常会遇到这样的尴尬：模型返回的内容是一段自由文本，而我们需要的是结构化的 JSON 数据（比如提取用户信息、解析商品参数等）。这时候，<code>JsonOutputParser</code> 就成了我们的得力助手！</p>
<h4 data-id="heading-2">1. 安装相关依赖 📦</h4>
<p>要使用输出定制能力，首先需要安装必要的依赖包：</p>
<p>bash</p>
<pre><code class="hljs language-bash" lang="bash">pnpm i langchain @langchain/deepseek @langchain/core zod
</code></pre>
<p>💡 命令解析：</p>
<ul>
<li><code>langchain</code>：LangChain 核心框架，提供基础能力</li>
<li><code>@langchain/deepseek</code>：DeepSeek 模型的 LangChain 集成包</li>
<li><code>@langchain/core</code>：包含核心组件（如解析器、提示模板等）</li>
<li><code>zod</code>：用于定义和校验数据结构的工具库，是实现结构化输出的关键</li>
</ul>
<h4 data-id="heading-3">2. 导入输出结果定制能力的关键模块 🔧</h4>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 导入 JSON 输出解析器：负责将模型输出转换为 JSON 并校验格式</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">JsonOutputParser</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/core/output_parsers'</span>;

<span class="hljs-comment">// 导入 zod：用于定义数据结构规则（Schema），确保输出符合预期格式</span>
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">'zod'</span>;
</code></pre>
<p>📝 模块作用详解：</p>
<ul>
<li><code>JsonOutputParser</code>：接收模型的原始输出文本，将其解析为 JSON 对象，同时会根据预定义的规则校验格式是否正确，若不符合则抛出错误</li>
<li><code>zod</code>：一个模式验证库，我们用它来定义「模型应该输出什么样的数据结构」（比如必须包含哪些字段、字段类型是什么）</li>
</ul>
<h4 data-id="heading-4">3. Zod、Schema 规则与 Prompt 提示词的关系 🤝</h4>
<p>要实现结构化输出，需要三个核心要素协同工作：</p>
<ul>
<li><strong>Zod</strong>：工具本身，提供了定义数据结构的语法（比如 <code>z.object()</code> 定义对象、<code>z.string()</code> 定义字符串类型）</li>
<li><strong>Schema</strong>：基于 Zod 定义的具体规则。例如：<code>const UserSchema = z.object({ name: z.string(), age: z.number() })</code> 就定义了一个用户信息的结构规则（必须有字符串类型的 name 和数字类型的 age）</li>
<li><strong>Prompt 提示词</strong>：将 Schema 规则「翻译」成模型能理解的指令，告诉模型「请按照这个结构输出 JSON 数据」</li>
</ul>
<p>三者形成完美闭环：<code>用 Zod 定义 Schema 规则 → 在 Prompt 中告知模型规则 → 模型按规则输出 → JsonOutputParser 用 Zod 校验并解析为 JSON</code></p>
<h4 data-id="heading-5">4. 代码实战：实现结构化输出📝</h4>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 导入所需模块</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatDeepSeek</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/deepseek'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatPromptTemplate</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/core/prompts'</span>
<span class="hljs-comment">// 将 llm 生成的内容解析为 json 格式</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">JsonOutputParser</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/core/output_parsers'</span>
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">'zod'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'dotenv/config'</span> <span class="hljs-comment">// 你的key</span>

<span class="hljs-comment">// 1. 定义输出数据的结构规则（基于 Zod）</span>
<span class="hljs-comment">// 这里要求模型输出用户信息，包含姓名（字符串）和爱好（字符串数组）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">UserInfoSchema</span> = z.<span class="hljs-title function_">object</span>({
  <span class="hljs-attr">name</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"用户的姓名"</span>), <span class="hljs-comment">// describe 用于在提示词中说明字段含义</span>
  <span class="hljs-attr">hobbies</span>: z.<span class="hljs-title function_">array</span>(z.<span class="hljs-title function_">string</span>()).<span class="hljs-title function_">describe</span>(<span class="hljs-string">"用户的爱好列表，每个爱好是字符串"</span>)
});

<span class="hljs-comment">// 2. 创建 JSON 输出解析器，传入定义好的 Schema</span>
<span class="hljs-keyword">const</span> parser = <span class="hljs-keyword">new</span> <span class="hljs-title class_">JsonOutputParser</span>({ <span class="hljs-attr">schema</span>: <span class="hljs-title class_">UserInfoSchema</span> });

<span class="hljs-comment">// 3. 构建提示模板：告诉模型需要输出符合 Schema 的 JSON</span>
<span class="hljs-comment">// {format_instructions} 会被自动替换为 parser 生成的格式说明</span>
<span class="hljs-keyword">const</span> prompt = <span class="hljs-title class_">ChatPromptTemplate</span>.<span class="hljs-title function_">fromMessages</span>([
  [<span class="hljs-string">"system"</span>, <span class="hljs-string">"请解析用户输入的信息，按照以下格式输出 JSON：\n{format_instructions}"</span>],
  [<span class="hljs-string">"human"</span>, <span class="hljs-string">"{input}"</span>]
]);

<span class="hljs-comment">// 4. 生成格式说明（由 parser 自动生成，告诉模型具体要怎么输出）</span>
<span class="hljs-keyword">const</span> formatInstructions = parser.<span class="hljs-title function_">getFormatInstructions</span>();

<span class="hljs-comment">// 5. 构建完整的调用链：提示模板 → 模型 → 解析器</span>
<span class="hljs-keyword">const</span> chain = prompt.<span class="hljs-title function_">pipe</span>(model).<span class="hljs-title function_">pipe</span>(parser);

<span class="hljs-comment">// 6. 执行调用：解析用户输入的信息</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> chain.<span class="hljs-title function_">invoke</span>({
  <span class="hljs-attr">input</span>: <span class="hljs-string">"我叫李四，平时喜欢打篮球、听音乐，偶尔也会爬山"</span>,
  <span class="hljs-attr">format_instructions</span>: formatInstructions
});

<span class="hljs-comment">// 7. 输出结果（此时 result 已经是符合 Schema 的 JSON 对象）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"解析结果："</span>, result);
</code></pre>
<p>💡 代码关键步骤解析：</p>
<ul>
<li>步骤 1：用 <code>z.object()</code> 定义输出必须包含 <code>name</code>（字符串）和 <code>hobbies</code>（字符串数组），<code>describe</code> 让模型更清楚每个字段的含义</li>
<li>步骤 2：<code>JsonOutputParser</code> 绑定 Schema 后，会自动校验模型输出是否符合规则</li>
<li>步骤 3：提示模板中必须包含 <code>{format_instructions}</code>，否则模型不知道要输出 JSON</li>
<li>步骤 6：调用时传入用户输入和格式说明，链会自动完成「提示生成 → 模型调用 → 解析校验」全流程</li>
</ul>
<h4 data-id="heading-6">5. 效果展示 ✨</h4>
<p>当我们输入「我叫李四，平时喜欢打篮球、听音乐，偶尔也会爬山」后，模型会输出标准的 JSON 结构：</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"李四"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"hobbies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"打篮球"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"听音乐"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"爬山"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de235635ce5349e98327c764933b1e6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGlhb3h1ZV8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767492669&amp;x-signature=ulbyYeBv9EuFzW9wAFvzS2271Ek%3D" alt="QQ20251227-142706.png" loading="lazy"/></p>
<p>再也不用手动处理字符串切割或正则匹配了！如果模型输出不符合格式（比如少了 <code>hobbies</code> 字段），<code>JsonOutputParser</code> 会直接抛出错误，方便我们快速排查问题。</p>
<h3 data-id="heading-7">第二部分：LLM 历史管理能力 📜</h3>
<p>大模型的 API 调用和 HTTP 请求一样，本质是「无状态」的 —— 每次调用都是独立的，模型不会记住上一次的对话内容。这就导致如果不做特殊处理，模型无法进行多轮对话（比如你先告诉它「我叫张三」，再问「我叫什么」，它会回答「不知道」）。</p>
<h4 data-id="heading-8">为什么需要历史管理？举个例子 🌰</h4>
<p>如果直接调用模型，没有历史管理的话，会是这样的效果：</p>
<p>javascript</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 无历史管理的单轮调用</span>
<span class="hljs-type">const</span> model = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ChatDeepSeek</span>({ model: <span class="hljs-string">'deepseek-chat'</span> });

<span class="hljs-comment">// 第一轮：告诉模型姓名</span>
<span class="hljs-type">const</span> res1 = await model.<span class="hljs-built_in">invoke</span>([[<span class="hljs-string">"human"</span>, <span class="hljs-string">"我叫张三"</span>]]);
console.<span class="hljs-built_in">log</span>(res1.content); <span class="hljs-comment">// 输出：你好，张三！很高兴认识你~</span>

<span class="hljs-comment">// 第二轮：询问姓名（模型已忘记）</span>
<span class="hljs-type">const</span> res2 = await model.<span class="hljs-built_in">invoke</span>([[<span class="hljs-string">"human"</span>, <span class="hljs-string">"我叫什么？"</span>]]);
console.<span class="hljs-built_in">log</span>(res2.content); <span class="hljs-comment">// 输出：抱歉，我不知道你叫什么名字，可以告诉我吗？</span>
</code></pre>
<p><strong>输出结果:</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e176e31b6f5c45b590c86d22694852f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGlhb3h1ZV8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767492669&amp;x-signature=LhAqoXFQ585%2Bp2n4nbcczDl0j7M%3D" alt="QQ20251228-094758.png" loading="lazy"/></p>
<p>这显然不符合我们对「对话」的预期。解决办法很简单：<strong>维护一份对话历史，每次调用模型时都把历史记录一起传给它</strong>。</p>
<h4 data-id="heading-9">1. 导入历史管理能力的关键模块 🔧</h4>
<p>LangChain 提供了专门的组件来简化历史管理，核心模块如下：</p>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 提示模板工具：用于构建包含历史记录的对话提示</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatPromptTemplate</span>, <span class="hljs-title class_">MessagesPlaceholder</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/core/prompts'</span>;

<span class="hljs-comment">// 带历史的可运行对象：核心组件，自动管理对话历史与模型调用的结合</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">RunnableWithMessageHistory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/core/runnables'</span>;

<span class="hljs-comment">// 内存型历史存储：临时保存对话历史（进程结束后丢失）</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">InMemoryChatMessageHistory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/core/chat_history'</span>;
</code></pre>
<p>📝 模块作用详解：</p>
<ul>
<li><code>ChatPromptTemplate</code>：构建对话模板，支持系统消息、用户消息、AI 消息等多角色定义</li>
<li><code>MessagesPlaceholder</code>：提示模板中的「历史消息占位符」，运行时会自动替换为真实的对话历史</li>
<li><code>RunnableWithMessageHistory</code>：将基础对话链与历史存储关联，自动完成「加载历史 → 拼接提示 → 调用模型 → 保存历史」的全流程</li>
<li><code>InMemoryChatMessageHistory</code>：内存中的历史存储容器，简单易用但不适合生产环境（数据不持久化）</li>
</ul>
<h4 data-id="heading-10">2. 代码实战：实现多轮对话记忆📝</h4>
<p>下面是基于 DeepSeek 模型的完整多轮对话代码：</p>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 第一步：初始化 DeepSeek 模型</span>
<span class="hljs-keyword">const</span> model = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({
  <span class="hljs-attr">model</span>: <span class="hljs-string">'deepseek-chat'</span>, <span class="hljs-comment">// 指定模型版本</span>
  <span class="hljs-attr">temperature</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 0 表示输出更稳定、确定（适合需要准确记忆的场景）</span>
});

<span class="hljs-comment">// 第二步：构建包含历史占位符的提示模板</span>
<span class="hljs-keyword">const</span> prompt = <span class="hljs-title class_">ChatPromptTemplate</span>.<span class="hljs-title function_">fromMessages</span>([
  [<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是一个有记忆的助手，会记住之前的对话内容"</span>], <span class="hljs-comment">// 系统角色定义</span>
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessagesPlaceholder</span>(<span class="hljs-string">"history"</span>), <span class="hljs-comment">// 历史消息占位符（关键！会自动填充历史）</span>
  [<span class="hljs-string">"human"</span>, <span class="hljs-string">"{input}"</span>] <span class="hljs-comment">// 用户当前输入的占位符</span>
]);

<span class="hljs-comment">// 第三步：构建基础对话链（提示模板 → 模型）</span>
<span class="hljs-keyword">const</span> runnable = prompt.<span class="hljs-title function_">pipe</span>(model);

<span class="hljs-comment">// 第四步：初始化内存型历史存储（保存对话记录）</span>
<span class="hljs-keyword">const</span> messageHistory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryChatMessageHistory</span>();

<span class="hljs-comment">// 第五步：用 RunnableWithMessageHistory 包装对话链，实现历史管理</span>
<span class="hljs-keyword">const</span> chain = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RunnableWithMessageHistory</span>({
  <span class="hljs-attr">runnable</span>: runnable, <span class="hljs-comment">// 基础对话链</span>
  <span class="hljs-attr">getMessageHistory</span>: <span class="hljs-keyword">async</span> () =&gt; messageHistory, <span class="hljs-comment">// 提供历史存储实例</span>
  <span class="hljs-attr">inputMessagesKey</span>: <span class="hljs-string">'input'</span>, <span class="hljs-comment">// 绑定用户输入的参数名（对应 prompt 中的 {input}）</span>
  <span class="hljs-attr">historyMessagesKey</span>: <span class="hljs-string">'history'</span> <span class="hljs-comment">// 绑定历史占位符的名称（对应 MessagesPlaceholder 的 "history"）</span>
});

<span class="hljs-comment">// 第六步：执行多轮对话</span>
<span class="hljs-comment">// 第一轮：告知姓名和喜好</span>
<span class="hljs-keyword">const</span> res1 = <span class="hljs-keyword">await</span> chain.<span class="hljs-title function_">invoke</span>(
  { <span class="hljs-attr">input</span>: <span class="hljs-string">'我叫张三，喜欢喝白兰地'</span> }, <span class="hljs-comment">// 用户输入</span>
  { <span class="hljs-attr">configurable</span>: { <span class="hljs-attr">sessionId</span>: <span class="hljs-string">'makefriend'</span> } } <span class="hljs-comment">// 会话 ID（用于区分不同对话）</span>
);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'AI 回复 1：'</span>, res1.<span class="hljs-property">content</span>); <span class="hljs-comment">// 输出：你好，张三！看来你喜欢喝白兰地呢~</span>

<span class="hljs-comment">// 第二轮：验证是否记住姓名</span>
<span class="hljs-keyword">const</span> res2 = <span class="hljs-keyword">await</span> chain.<span class="hljs-title function_">invoke</span>(
  { <span class="hljs-attr">input</span>: <span class="hljs-string">'我叫什么？'</span> }, <span class="hljs-comment">// 基于历史的提问</span>
  { <span class="hljs-attr">configurable</span>: { <span class="hljs-attr">sessionId</span>: <span class="hljs-string">'makefriend'</span> } } <span class="hljs-comment">// 同一会话 ID，复用历史</span>
);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'AI 回复 2：'</span>, res2.<span class="hljs-property">content</span>); <span class="hljs-comment">// 输出：你叫张三呀，刚才你说喜欢喝白兰地呢~</span>
</code></pre>
<p>💡 核心逻辑解析：</p>
<ul>
<li>
<p>当调用 <code>chain.invoke()</code> 时，<code>RunnableWithMessageHistory</code> 会自动做三件事：</p>
<ol>
<li>从 <code>messageHistory</code> 中加载该 <code>sessionId</code> 对应的历史记录</li>
<li>将历史记录填充到 <code>MessagesPlaceholder("history")</code> 位置，与当前输入拼接成完整提示</li>
<li>调用模型后，自动将「用户输入」和「AI 回复」保存到 <code>messageHistory</code> 中</li>
</ol>
</li>
<li>
<p><code>sessionId</code> 的作用：如果有多个用户同时对话，用 <code>sessionId</code> 区分不同会话的历史记录（比如用户 A 和用户 B 分别有自己的 <code>sessionId</code>）</p>
</li>
</ul>
<h4 data-id="heading-11">3. 效果展示 ✨</h4>
<p>运行上述代码后，我们会得到这样的输出：</p>
<pre><code class="hljs">AI 回复 1：你好，张三！看来你喜欢喝白兰地呢~
AI 回复 2：你叫张三呀，刚才你说喜欢喝白兰地呢~
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e08369f75bf493ba81701dc25022398~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGlhb3h1ZV8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767492669&amp;x-signature=3xl%2BwdIjQrlLZD4iMTYdArJgz%2Fk%3D" alt="QQ20251228-095706.png" loading="lazy"/></p>
<p>可以看到，模型成功记住了第一轮对话中提到的姓名，实现了带记忆的多轮对话！</p>
<h3 data-id="heading-12">面试官可能会问这些问题 🤔</h3>
<ul>
<li><strong>1.如何让 LLM 输出固定格式的 JSON 数据？</strong></li>
</ul>
<p>答：使用 LangChain 的 <code>JsonOutputParser</code> 结合 Zod 库。先用 Zod 定义数据结构（Schema），再通过提示模板告诉模型按 Schema 输出，最后用 <code>JsonOutputParser</code> 解析并校验结果，形成「定义规则→传达规则→校验规则」的闭环。</p>
<ul>
<li><strong>2.InMemoryChatMessageHistory 有什么局限性？生产环境中如何替代？</strong></li>
</ul>
<p>答：局限性是数据保存在内存中，进程重启后丢失，且不支持分布式部署。生产环境可使用持久化存储，比如 <code>RedisChatMessageHistory</code>（基于 Redis）、<code>MongoDBChatMessageHistory</code>（基于 MongoDB）等，这些组件会将历史记录存储到数据库中。</p>
<ul>
<li><strong>3.RunnableWithMessageHistory 的核心作用是什么？</strong></li>
</ul>
<p>答：它是连接「对话链」和「历史存储」的桥梁，自动完成历史记录的加载、提示拼接、模型调用和历史保存，简化了多轮对话的实现流程，无需手动管理历史记录的传递与存储。</p>
<ul>
<li><strong>4.多轮对话中，对话历史是如何传递给模型的？</strong></li>
</ul>
<p>答：通过 <code>MessagesPlaceholder</code> 在提示模板中预留位置，<code>RunnableWithMessageHistory</code> 会在调用时将历史记录填充到该位置，与系统消息、当前输入拼接成完整提示，再传递给模型，让模型「看到」所有历史对话。</p>
<ul>
<li><strong>5.如果对话历史很长，会有什么问题？如何解决？</strong></li>
</ul>
<p>答：问题是可能超过模型的上下文窗口长度（Token 限制），导致模型无法处理。解决办法：① 用 <code>ConversationSummaryMemory</code> 对历史进行总结压缩；② 按时间或重要性截断历史记录；③ 选择支持更长上下文窗口的模型。</p>
<h3 data-id="heading-13">结语 🌟</h3>
<p>通过 LangChain 的 <code>JsonOutputParser</code> 和历史管理组件，我们可以轻松实现「结构化输出」和「多轮对话记忆」这两个核心功能。结构化输出让 AI 结果更易被程序处理，历史管理让对话更自然流畅 —— 这两者结合起来，能大幅提升 AI 应用的实用性和用户体验。</p>
<p>希望这篇文章能帮你掌握 LangChain 的进阶技巧，快去动手实践吧！如果有任何问题，欢迎在评论区交流哦～🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我用AI写了个小程序，却被人说没有底线…]]></title>    <link>https://juejin.cn/post/7588152122187137078</link>    <guid>https://juejin.cn/post/7588152122187137078</guid>    <pubDate>2025-12-28T02:23:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588152122187137078" data-draft-id="7588004376868241443" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我用AI写了个小程序，却被人说没有底线…"/> <meta itemprop="keywords" content="微信小程序,前端,交互设计"/> <meta itemprop="datePublished" content="2025-12-28T02:23:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大大花猫"/> <meta itemprop="url" content="https://juejin.cn/user/3051900006309096"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我用AI写了个小程序，却被人说没有底线…
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3051900006309096/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大大花猫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T02:23:26.000Z" title="Sun Dec 28 2025 02:23:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">大家好！</h2>
<p>今天想和大家分享一下我用AI开发的一款微信小程序——【<strong>破冰神器</strong>】。</p>
<p>作为一个喜欢和朋友聚会但又经常<strong>面临“冷场”尴尬的i人</strong>，我一直在寻找一款能够活跃聚会氛围的小程序。但市面上的应用要么做工粗糙功能单一，要么一堆广告没法玩。于是，我决定自己动手（其实只动了嘴，是AI动的手），开发一款好用、功能丰富的“破冰神器”。</p>
<p><strong>先扣一下文章标题</strong>，为什么会被人说没有底线，主要还是一些人对真心话大冒险的刻板印象吧，是添加了一些亲密互动和情侣模式，不过也是大家各取所需，物尽其用吧。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1dcc864098bb4eabaff850a4742a6075~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5aSn6Iqx54yr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767493405&amp;x-signature=wI6Zccj5ZLhChqoWXmKH7czfOpk%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-1">好了，先给大家展示一下这款小程序的主要界面</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b22ee3a2501e47d3aa1307d768d40cd6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5aSn6Iqx54yr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767493405&amp;x-signature=2FHeH3X3jGx2PvxGe2IflU8CCf0%3D" alt="WechatIMG67.jpg" loading="lazy"/></p>
<h6 data-id="heading-2">可惜掘金这里发视频不是很方便，感兴趣的朋友可以移步微信小程序体验一下。</h6>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53abd9968f354618bd0835fc4f33ea98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5aSn6Iqx54yr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767493405&amp;x-signature=sPoMY1Ko%2BkzkxeeYh8E0eSFOIMU%3D" alt="card_qrcode.jpg" loading="lazy"/></p>
<h3 data-id="heading-3">💡 开发初衷</h3>
<p>在朋友聚会、团建破冰或者KTV唱歌时，我们经常需要一些小道具来活跃气氛。比如：</p>
<ul>
<li>想玩真心话大冒险，但想不出好题目？</li>
<li>想玩摇骰子，但找不到实体骰子？</li>
<li>想抽扑克牌比大小，但没带牌？</li>
<li>喝酒时想玩个简单的猜数字游戏？
【破冰神器】就是为了解决这些场景而生的。</li>
</ul>
<h3 data-id="heading-4">🚀 功能亮点介绍</h3>
<h4 data-id="heading-5">1. 真心话大冒险 (Truth or Dare)</h4>
<p>这是小程序的核心功能。为了保证题目的趣味性和多样性，我接入了 LeanCloud 作为后端数据库，这样可以动态更新题目库，而不需要频繁发版。（已经录入了几百道题了）</p>
<ul>
<li>多模式支持 ：不仅有传统的“真心话”和“大冒险”，我还加入了“谁来喝”、“好运卡”、“亲密互动”以及“情侣模式“。</li>
<li>自定义概率 ：为了满足不同场合的诉求差异，可以自由调整每种模式的出现概率。</li>
<li>交互体验 ：卡片切换使用了平滑的动画效果，配合手机的震动反馈，抽卡的感觉非常真实。</li>
</ul>
<h4 data-id="heading-6">2. 摇骰子 (Dice)</h4>
<p>模拟真实的骰子体验。</p>
<ul>
<li>多骰子支持 ：最多支持 5 颗骰子同时摇动。</li>
<li>真实手感 ：支持“长按蓄力”和“点击”两种模式，配合震动反馈，还原真实的博弈感。</li>
<li>遮罩模式 ：摇完后默认可以覆盖结果，增加神秘感，大家猜完后再揭晓。</li>
</ul>
<h4 data-id="heading-7">3. 扑克牌 (Poker)</h4>
<p>一个极简的抽牌工具。</p>
<ul>
<li>自定义张数 ：默认抽3张，也可以根据规则调整。</li>
<li>大小王开关 ：支持配置是否包含大小王。</li>
</ul>
<h4 data-id="heading-8">4. 猜数字 (Guess Number)</h4>
<p>经典的“高低猜”游戏，非常适合作为酒桌惩罚游戏。</p>
<ul>
<li>范围设定 ：支持 1-99 和 1-999 两种难度。</li>
<li>胜利特效 ：猜中数字后会有全屏烟花特效，庆祝胜利（或者迎接惩罚）。</li>
</ul>
<h3 data-id="heading-9">🛠 技术实现分享</h3>
<h4 data-id="heading-10">0. 开发工具选择</h4>
<ul>
<li>AI开发工具我选用了TRAE，确实在国内用起来方便太多了。</li>
<li>大模型我选择谷歌的gemini3pro，它实现UI的能力让我眼前一亮，已经离不开了。</li>
</ul>
<h4 data-id="heading-11">1. 技术栈选择</h4>
<ul>
<li>前端 ：原生微信小程序 (WXML, WXSS, JS)。原生开发虽然繁琐，但在性能和体验上是最优的，特别是对于需要频繁动画交互的游戏类应用。</li>
<li>后端 ： LeanCloud (Serverless) 。对于这种轻量级的小程序，Serverless 是绝佳选择。我不需要维护服务器，只需要通过 API 获取题目数据，省心省力。</li>
<li>国际化 ：内置了 i18n 模块，为未来的多语言支持做好了准备。</li>
</ul>
<h4 data-id="heading-12">2. 沉浸式 UI 设计</h4>
<p>为了打造“夜间模式”的聚会氛围，我将整体 UI 风格定调为深色系。</p>
<ul>
<li>自定义导航栏 ：为了最大化可视面积和统一视觉风格，我取消了原生导航栏，实现了自定义 Navigation Bar，完美适配各种刘海屏机型。</li>
<li>触感反馈 ：在用户交互的关键节点（如抽卡、摇骰子、按钮点击）都加入了 wx.vibrateShort的轻微震动反馈，提升操作的确认感。</li>
</ul>
<h4 data-id="heading-13">3. 动画与性能</h4>
<ul>
<li>Canvas 烟花 ：猜数字胜利时的烟花效果使用了 Canvas 绘制，保证了流畅度。</li>
<li>CSS3 动画 ：卡片的翻转、入场动画主要依赖 CSS3 transform 和 transition ，减少 JS 线程的压力。</li>
<li>粒子爆炸效果：引入了three.js的库，太好用了只能说！</li>
</ul>
<h3 data-id="heading-14">🔮 未来展望</h3>
<p>目前的【破冰神器】已经能满足基础的聚会需求，但我还有很多想法：</p>
<ul>
<li>更多游戏 ：比如“谁是卧底”、“你画我猜”等多人在线互动游戏。</li>
<li>题库共建 ：允许用户提交自己的真心话大冒险题目、审核题目、自定义卡组等。</li>
<li>联机模式 ：不仅仅是线下传手机玩，未来希望能支持面对面建房，大家在自己的手机上操作。</li>
</ul>
<h5 data-id="heading-15">感谢大家使用【破冰神器】，如果你有任何建议或发现了 Bug，欢迎在小程序里给我留言！</h5></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CryptoAiAdmin项目数据库表自动创建和初始化]]></title>    <link>https://juejin.cn/post/7588086766248706099</link>    <guid>https://juejin.cn/post/7588086766248706099</guid>    <pubDate>2025-12-27T12:55:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588086766248706099" data-draft-id="7588067055482355721" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CryptoAiAdmin项目数据库表自动创建和初始化"/> <meta itemprop="keywords" content="后端,Python,FastAPI"/> <meta itemprop="datePublished" content="2025-12-27T12:55:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="创新技术阁"/> <meta itemprop="url" content="https://juejin.cn/user/4361127086785497"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CryptoAiAdmin项目数据库表自动创建和初始化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4361127086785497/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    创新技术阁
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T12:55:57.000Z" title="Sat Dec 27 2025 12:55:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 概述</h2>
<p>本系统采用了基于 SQLAlchemy 2.0 的异步数据库架构，实现了自动化的数据库表创建和基础数据初始化。整个初始化过程由 <code>InitializeData</code> 类（位于 <code>app/scripts/initialize.py</code>）统一管理，遵循"先创建表结构，再初始化数据"的原则，确保数据完整性和依赖关系正确性。</p>
<h2 data-id="heading-1">2. 数据库连接配置</h2>
<h3 data-id="heading-2">2.1 连接管理</h3>
<p>系统使用 <code>app/core/database.py</code> 中的函数创建数据库连接：</p>
<ul>
<li><code>create_engine_and_session()</code>: 创建同步数据库引擎和会话工厂</li>
<li><code>create_async_engine_and_session()</code>: 创建异步数据库引擎和会话工厂</li>
</ul>
<p>这些函数从配置文件中读取数据库连接参数，支持多种数据库类型（SQLite、MySQL、PostgreSQL）。</p>
<h3 data-id="heading-3">2.2 核心配置参数</h3>
<ul>
<li>数据库连接URL: <code>settings.DB_URI</code>（同步）和 <code>settings.ASYNC_DB_URI</code>（异步）</li>
<li>连接池配置: 包括连接池大小、回收时间、预检查等</li>
<li>日志配置: 控制是否输出SQL语句</li>
</ul>
<h2 data-id="heading-4">3. 模型定义架构</h2>
<h3 data-id="heading-5">3.1 基础模型设计</h3>
<p>系统采用了Mixin模式实现模型的复用和扩展：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MappedBase</span>(AsyncAttrs, DeclarativeBase):
    __abstract__: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">True</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ModelMixin</span>(<span class="hljs-title class_ inherited__">MappedBase</span>):
    __abstract__: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">True</span>
    <span class="hljs-comment"># 提供通用字段：id、uuid、status、description、created_time、updated_time</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserMixin</span>(<span class="hljs-title class_ inherited__">MappedBase</span>):
    __abstract__: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">True</span>
    <span class="hljs-comment"># 提供用户审计字段：created_id、updated_id</span>
</code></pre>
<h3 data-id="heading-6">3.2 业务模型定义</h3>
<p>业务模型通过继承基础模型实现，例如用户模型：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">UserModel</span>(ModelMixin, UserMixin):
    __tablename__: <span class="hljs-built_in">str</span> = <span class="hljs-string">"sys_user"</span>
    __table_args__: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>] = ({<span class="hljs-string">'comment'</span>: <span class="hljs-string">'用户表'</span>})
    
    username: Mapped[<span class="hljs-built_in">str</span>] = mapped_column(String(<span class="hljs-number">32</span>), nullable=<span class="hljs-literal">False</span>, unique=<span class="hljs-literal">True</span>, comment=<span class="hljs-string">"用户名/登录账号"</span>)
    password: Mapped[<span class="hljs-built_in">str</span>] = mapped_column(String(<span class="hljs-number">255</span>), nullable=<span class="hljs-literal">False</span>, comment=<span class="hljs-string">"密码哈希"</span>)
    <span class="hljs-comment"># 其他字段...</span>
    
    <span class="hljs-comment"># 关联关系</span>
    dept: Mapped[<span class="hljs-string">"DeptModel | None"</span>] = relationship(back_populates=<span class="hljs-string">"users"</span>, lazy=<span class="hljs-string">"selectin"</span>)
    roles: Mapped[<span class="hljs-built_in">list</span>[<span class="hljs-string">"RoleModel"</span>]] = relationship(secondary=<span class="hljs-string">"sys_user_roles"</span>, back_populates=<span class="hljs-string">"users"</span>, lazy=<span class="hljs-string">"selectin"</span>)
</code></pre>
<h2 data-id="heading-7">4. 表创建过程</h2>
<h3 data-id="heading-8">4.1 模型加载与依赖排序</h3>
<p>在 <code>InitializeData</code> 类中，模型按照依赖关系排序：</p>
<pre><code class="hljs language-python" lang="python">self.prepare_init_models = [
    MenuModel,
    ParamsModel,
    DeptModel,
    RoleModel,
    DictTypeModel,
    DictDataModel,
    PositionModel,
    UserModel,
    UserRolesModel,
]
</code></pre>
<h3 data-id="heading-9">4.2 表创建实现</h3>
<p>表创建通过 SQLAlchemy 的 <code>metadata.create_all()</code> 方法实现：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init_create_table</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> async_engine.begin() <span class="hljs-keyword">as</span> conn:
            <span class="hljs-keyword">await</span> conn.run_sync(MappedBase.metadata.create_all)
        log.info(<span class="hljs-string">"✅️ 数据库表结构初始化完成"</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        log.error(<span class="hljs-string">f"❌️ 数据库表结构初始化失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
        <span class="hljs-keyword">raise</span>
</code></pre>
<p>这个方法会自动创建所有继承自 <code>MappedBase</code> 的模型对应的数据库表，并处理表之间的外键关系。</p>
<h2 data-id="heading-10">5. 数据初始化过程</h2>
<h3 data-id="heading-11">5.1 初始化数据存储</h3>
<p>基础数据存储在 <code>app/scripts/data/</code> 目录下的 JSON 文件中，每个文件对应一个表：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span>/
├── sys_dept.json
├── sys_dict_data.json
├── sys_dict_type.json
├── sys_menu.json
├── sys_param.json
├── sys_role.json
├── sys_user.json
└── sys_user_roles.json
</code></pre>
<h3 data-id="heading-12">5.2 数据加载与插入</h3>
<p>数据初始化过程包括以下步骤：</p>
<ol>
<li><strong>检查表是否已有数据</strong>：避免重复初始化</li>
<li><strong>读取初始化数据文件</strong>：从 JSON 文件中加载数据</li>
<li><strong>特殊数据处理</strong>：
<ul>
<li>嵌套数据处理（如部门和菜单的树形结构）</li>
<li>关联数据处理（如字典数据与字典类型的关联）</li>
</ul>
</li>
<li><strong>批量插入数据</strong>：使用 <code>db.add_all()</code> 和 <code>db.flush()</code> 批量插入</li>
</ol>
<h3 data-id="heading-13">5.3 特殊数据处理实现</h3>
<h4 data-id="heading-14">5.3.1 嵌套数据处理</h4>
<p>对于具有树形结构的数据（如部门和菜单），系统使用递归函数创建对象：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">__create_objects_with_children</span>(<span class="hljs-params">self, data: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">dict</span>], model_class</span>) -&gt; <span class="hljs-built_in">list</span>:
    objs = []
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_object</span>(<span class="hljs-params">obj_data: <span class="hljs-built_in">dict</span></span>):
        children_data = obj_data.pop(<span class="hljs-string">'children'</span>, [])
        obj = model_class(**obj_data)
        <span class="hljs-keyword">if</span> children_data:
            obj.children = [create_object(child) <span class="hljs-keyword">for</span> child <span class="hljs-keyword">in</span> children_data]
        <span class="hljs-keyword">return</span> obj
    
    <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> data:
        objs.append(create_object(item))
    
    <span class="hljs-keyword">return</span> objs
</code></pre>
<h4 data-id="heading-15">5.3.2 关联数据处理</h4>
<p>对于存在关联关系的数据（如用户与角色），系统先初始化主表数据，再初始化关联表数据：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 处理字典类型表，保存类型映射</span>
<span class="hljs-keyword">elif</span> table_name == <span class="hljs-string">"sys_dict_type"</span>:
    objs = []
    <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> data:
        obj = model(**item)
        objs.append(obj)
        dict_type_mapping[item[<span class="hljs-string">'dict_type'</span>]] = obj
<span class="hljs-comment"># 处理字典数据表，添加dict_type_id关联</span>
<span class="hljs-keyword">elif</span> table_name == <span class="hljs-string">"sys_dict_data"</span>:
    objs = []
    <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> data:
        dict_type = item.get(<span class="hljs-string">'dict_type'</span>)
        <span class="hljs-keyword">if</span> dict_type <span class="hljs-keyword">in</span> dict_type_mapping:
            item[<span class="hljs-string">'dict_type_id'</span>] = dict_type_mapping[dict_type].<span class="hljs-built_in">id</span>
        <span class="hljs-keyword">else</span>:
            log.warning(<span class="hljs-string">f"⚠️  未找到字典类型 <span class="hljs-subst">{dict_type}</span>，跳过该字典数据"</span>)
            <span class="hljs-keyword">continue</span>
        objs.append(model(**item))
</code></pre>
<h2 data-id="heading-16">6. 完整初始化流程</h2>
<p>数据库初始化的完整流程由 <code>init_db()</code> 方法统一协调：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">init_db</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:
    <span class="hljs-comment"># 先创建表结构</span>
    <span class="hljs-keyword">await</span> self.__init_create_table()
    
    <span class="hljs-comment"># 再初始化数据</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> async_db_session() <span class="hljs-keyword">as</span> session:
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.begin():
            <span class="hljs-keyword">await</span> self.__init_data(session)
            <span class="hljs-keyword">await</span> session.commit()
</code></pre>
<h2 data-id="heading-17">8. 总结</h2>
<p>本系统的数据库初始化过程是一个高度自动化、可扩展的架构，通过 SQLAlchemy 2.0 的异步特性实现了高效的数据库操作。整个过程遵循了"先创建表结构，再初始化数据"的原则，确保了数据的完整性和依赖关系的正确性。同时，系统采用了Mixin模式实现模型的复用和扩展，提高了代码的可维护性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[NestJS 如何配置环境变量]]></title>    <link>https://juejin.cn/post/7588080521445261358</link>    <guid>https://juejin.cn/post/7588080521445261358</guid>    <pubDate>2025-12-27T12:56:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588080521445261358" data-draft-id="7588080521445244974" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="NestJS 如何配置环境变量"/> <meta itemprop="keywords" content="NestJS"/> <meta itemprop="datePublished" content="2025-12-27T12:56:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="当时只道寻常"/> <meta itemprop="url" content="https://juejin.cn/user/48816529358711"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            NestJS 如何配置环境变量
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/48816529358711/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    当时只道寻常
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T12:56:06.000Z" title="Sat Dec 27 2025 12:56:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    26
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">所需依赖</h2>
<pre><code class="hljs language-bash" lang="bash">pnpm i @nestjs/config js-yaml lodash
pnpm i @types/js-yaml @types/lodash cross-env -D
</code></pre>
<h2 data-id="heading-1">目录结构</h2>
<pre><code class="hljs language-bash" lang="bash">|- config
| |- config.yaml <span class="hljs-comment"># 通用配置文件</span>
| |- config.local.yaml <span class="hljs-comment"># 通用配置文件本地版（不会被 Git 记录）</span>
| |- config.development.yaml <span class="hljs-comment"># 开发环境配置文件版</span>
| |- config.development.local.yaml <span class="hljs-comment"># 开发环境配置文件版（不会被 Git 记录）</span>
| |- config.production.yaml <span class="hljs-comment"># 生产配置文件本地版</span>
| |- config.production.local.yaml <span class="hljs-comment"># 生产配置文件本地版（不会被 Git 记录）</span>
|- src
| |- common
|   |- config.module.ts <span class="hljs-comment"># 自定义的环境配置模块</span>
| |- app.module.ts
|- .gitignore
|- nest-cli.json
</code></pre>
<h2 data-id="heading-2">涉及文件</h2>
<h3 data-id="heading-3">1、package.json</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cross-env NODE_ENV=production nest build"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cross-env NODE_ENV=development nest start"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"start:dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cross-env NODE_ENV=development nest start --watch"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"start:debug"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cross-env NODE_ENV=development nest start --debug --watch"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"start:prod"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node dist/main"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"start:deploy"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node main.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"@nestjs/config"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^4.0.2"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"js-yaml"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^4.1.1"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"lodash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^4.17.21"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"@types/js-yaml"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^4.0.9"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"@types/lodash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^4.17.21"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"cross-env"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^10.1.0"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-4">2、config.module.ts</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { join } <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>
<span class="hljs-keyword">import</span> jsYaml <span class="hljs-keyword">from</span> <span class="hljs-string">'js-yaml'</span>
<span class="hljs-keyword">import</span> { merge } <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>
<span class="hljs-keyword">import</span> { readFileSync, existsSync } <span class="hljs-keyword">from</span> <span class="hljs-string">'fs'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigModule</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">NestConfigModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [
    <span class="hljs-title class_">NestConfigModule</span>.<span class="hljs-title function_">forRoot</span>({
      <span class="hljs-attr">load</span>: [configuration],
      <span class="hljs-attr">isGlobal</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">cache</span>: <span class="hljs-literal">true</span>,
    }),
  ],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigModule</span> {}

<span class="hljs-comment">/**
 * 读取指定路径的 YAML 配置文件并转为对象类型
 * <span class="hljs-doctag">@param</span> filePath YAML 配置文件的路径
 * <span class="hljs-doctag">@returns</span> 解析后的配置对象，如果文件不存在则返回空对象
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">loadConfig</span>(<span class="hljs-params">filePath: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">existsSync</span>(filePath) ? (jsYaml.<span class="hljs-title function_">load</span>(<span class="hljs-title function_">readFileSync</span>(filePath, <span class="hljs-string">'utf-8'</span>)) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;) : {}
}

<span class="hljs-comment">/**
 * 配置加载核心函数：读取并合并多环境 YAML 配置文件
 *
 * 功能说明：
 *  - 根据 NODE_ENV 区分开发/生产环境，确定配置文件存放目录
 *  - 按优先级读取4类 YAML 配置文件（通用→通用本地→环境→环境本地）
 *  - 深度合并配置对象，后续配置会覆盖前面的同名嵌套属性
 *  - 最终返回合并后的完整配置，供 NestJS ConfigModule 使用
 *
 * 配置优先级（从低到高，后面覆盖前面）：
 *  - config.yaml &lt; config.local.yaml &lt; config.{NODE_ENV}.yaml &lt; config.{NODE_ENV}.local.yaml
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">configuration</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 从环境变量中获取当前运行环境，默认为开发环境</span>
  <span class="hljs-keyword">const</span> { <span class="hljs-variable constant_">NODE_ENV</span> = <span class="hljs-string">'development'</span> } = process.<span class="hljs-property">env</span>

  <span class="hljs-comment">// 确定配置文件的存放目录</span>
  <span class="hljs-comment">//  - 开发环境: 读取项目根目录下的 config 文件夹</span>
  <span class="hljs-comment">//  - 生产环境: 直接读取当前文件所在的目录</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CONFIG_DIR_PATH</span> = <span class="hljs-variable constant_">NODE_ENV</span> === <span class="hljs-string">'development'</span> ? <span class="hljs-title function_">join</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'config'</span>) : __dirname

  <span class="hljs-comment">// 定义各类配置文件的路径</span>
  <span class="hljs-comment">// 通用配置文件（所有环境共享的基础配置）</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">YAML_COMMON_CONFIG_PATH</span> = <span class="hljs-title function_">join</span>(<span class="hljs-variable constant_">CONFIG_DIR_PATH</span>, <span class="hljs-string">'config.yaml'</span>)
  <span class="hljs-comment">// 通用本地配置文件（本地开发覆盖通用配置的个性化设置，不应提交到代码仓库）</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">YAML_COMMON_CONFIG_LOCAL_PATH</span> = <span class="hljs-title function_">join</span>(<span class="hljs-variable constant_">CONFIG_DIR_PATH</span>, <span class="hljs-string">'config.local.yaml'</span>)
  <span class="hljs-comment">// 特定环境的配置文件（针对当前环境的专用配置，如开发/生产环境的差异配置）</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">YAML_ENV_CONFIG_PATH</span> = <span class="hljs-title function_">join</span>(<span class="hljs-variable constant_">CONFIG_DIR_PATH</span>, <span class="hljs-string">`config.<span class="hljs-subst">${NODE_ENV || <span class="hljs-string">'development'</span>}</span>.yaml`</span>)
  <span class="hljs-comment">// 特定环境的本地配置文件（本地覆盖当前环境配置的个性化设置，不应提交到代码仓库）</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">YAML_ENV_CONFIG_LOCAL_PATH</span> = <span class="hljs-title function_">join</span>(<span class="hljs-variable constant_">CONFIG_DIR_PATH</span>, <span class="hljs-string">`config.<span class="hljs-subst">${NODE_ENV || <span class="hljs-string">'development'</span>}</span>.local.yaml`</span>)

  <span class="hljs-comment">// 读取各类配置文件的内容</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">COMMON_CONFIG</span> = <span class="hljs-title function_">loadConfig</span>(<span class="hljs-variable constant_">YAML_COMMON_CONFIG_PATH</span>)
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">COMMON_CONFIG_LOCAL</span> = <span class="hljs-title function_">loadConfig</span>(<span class="hljs-variable constant_">YAML_COMMON_CONFIG_LOCAL_PATH</span>)
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">ENV_CONFIG</span> = <span class="hljs-title function_">loadConfig</span>(<span class="hljs-variable constant_">YAML_ENV_CONFIG_PATH</span>)
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">ENV_CONFIG_LOCAL</span> = <span class="hljs-title function_">loadConfig</span>(<span class="hljs-variable constant_">YAML_ENV_CONFIG_LOCAL_PATH</span>)

  <span class="hljs-comment">// 深度合并配置，后面的配置会覆盖前面的同名配置</span>
  <span class="hljs-comment">// 这样既保证了基础配置的通用性，又允许环境和本地配置进行个性化定制</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">merge</span>(<span class="hljs-variable constant_">COMMON_CONFIG</span>, <span class="hljs-variable constant_">COMMON_CONFIG_LOCAL</span>, <span class="hljs-variable constant_">ENV_CONFIG</span>, <span class="hljs-variable constant_">ENV_CONFIG_LOCAL</span>)
}
</code></pre>
<h3 data-id="heading-5">3、app.module.ts</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./common/config.module.ts'</span>

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">ConfigModule</span>]
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppModule</span> {}
</code></pre>
<h3 data-id="heading-6">4、.gitignore</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># dotenv environment variable files</span>
.env.local
*.local.yaml
</code></pre>
<h3 data-id="heading-7">5、nest-cli.json</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"$schema"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://json.schemastore.org/nest-cli"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"collection"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"@nestjs/schematics"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sourceRoot"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"assets"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span> <span class="hljs-attr">"include"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"../package.json"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"outDir"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/package.json"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span> <span class="hljs-attr">"include"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"../pnpm-lock.yaml"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"outDir"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/pnpm-lock.yaml"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span> <span class="hljs-attr">"include"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"../config/config.yaml"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"outDir"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist"</span> <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"deleteOutDir"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"builder"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"webpack"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"generateOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"flat"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"spec"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-8">使用介绍</h2>
<h3 data-id="heading-9">1、service 服务使用</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginService</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> configService: ConfigService</span>) {}
  
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">testEnvConfig</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> dbHost = <span class="hljs-variable language_">this</span>.<span class="hljs-property">configService</span>.<span class="hljs-property">get</span>&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">'database.host'</span>,<span class="hljs-string">'localhost'</span>)
  }
}
</code></pre>
<h3 data-id="heading-10">2、main.ts 中使用</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.module'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NestFactory</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">AppModule</span>)
  
  <span class="hljs-comment">// 从应用容器中获取配置服务实例，由于 ConfigModule 被设置为全局模块，这里可以直接获取</span>
  <span class="hljs-keyword">const</span> configService = app.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">ConfigService</span>)
  <span class="hljs-keyword">const</span> serverPort = configService.<span class="hljs-property">get</span>&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-string">'server.port'</span>, <span class="hljs-number">3000</span>)
  
  <span class="hljs-comment">// 启动应用并监听配置中指定的端口</span>
  <span class="hljs-comment">// 这一步会启动 HTTP 服务器，使应用开始接收外部请求</span>
  <span class="hljs-keyword">await</span> app.<span class="hljs-title function_">listen</span>(serverPort)
  
  <span class="hljs-comment">// 打印服务启动信息，方便开发者在终端查看访问地址</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'\n--------------------------------------------------'</span>)
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`➜  Local:    http://localhost:<span class="hljs-subst">${serverPort}</span>`</span>)
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'--------------------------------------------------'</span>)
}

<span class="hljs-comment">// 调用启动函数，启动应用</span>
<span class="hljs-title function_">bootstrap</span>()
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[openresty监控]]></title>    <link>https://juejin.cn/post/7588080521445294126</link>    <guid>https://juejin.cn/post/7588080521445294126</guid>    <pubDate>2025-12-27T13:41:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588080521445294126" data-draft-id="7588149079416913974" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="openresty监控"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-27T13:41:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风的归宿55"/> <meta itemprop="url" content="https://juejin.cn/user/2840793779297303"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            openresty监控
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2840793779297303/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风的归宿55
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T13:41:03.000Z" title="Sat Dec 27 2025 13:41:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1小时+
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">介绍</h4>
<p>这篇文章主要讲解了openresty的监控界面，包括监控界面的安装，展示，以及使用。这里推荐的openresty的监控主要有两个，一个是qps，状态码，upstream连接数等nginx指标的监控大屏，还有一个是lua的异常日志的监控展示。前者让我们可以掌握nginx整体的健康状态，后者则从业务角度告诉我们，当前什么在出错。</p>
<h4 data-id="heading-1">成果展示</h4>
<p>这里贴一下grafana最终展示出来的监控效果</p>
<h6 data-id="heading-2">监控大屏</h6>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d755ab8b53a242e78490a19d76182596~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO55qE5b2S5a6_NTU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767447665&amp;x-signature=d%2FAK1RJHE4C0pWGsyoUr6Wg%2FJ3g%3D" alt="openresty_1.jpg" loading="lazy"/></p>
<h6 data-id="heading-3">异常监控</h6>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96d275d52b6046adba82e0dab7ce9ec4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO55qE5b2S5a6_NTU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767447665&amp;x-signature=HP%2B%2FnTQep43Kk6c47Tg142OprZ0%3D" alt="openresty_2.jpg" loading="lazy"/></p>
<br/>
<h4 data-id="heading-4">监控大屏</h4>
<p>这个监控大屏主要是通过openresty的prometheus库来收集数据的，有兴趣的可以看下这个官方文档 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fknyar%2Fnginx-lua-prometheus" target="_blank" title="https://github.com/knyar/nginx-lua-prometheus" ref="nofollow noopener noreferrer">github.com/knyar/nginx…</a> 。这个库里面提供了一些功能的函数，可以通过这些函数导出自己感兴趣的指标并展示，本文就额外导出了nginx中的upstream的连接数这一指标，用于协助排查问题。当然，这个库已经默认导出了qps，连接数，延迟等重要信息。</p>
<h6 data-id="heading-5">安装</h6>
<p>首先从这个git项目获取库文件进行安装： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fknyar%2Fnginx-lua-prometheus" target="_blank" title="https://github.com/knyar/nginx-lua-prometheus" ref="nofollow noopener noreferrer">github.com/knyar/nginx…</a> ，需要注意的是，这个库文件生效的前提是需要nginx已经安装了ngx_lua模块，不过对于openresty来说，这是自带的，不需要额外安装。然后可以通过以下步骤进行安装：</p>
<ol>
<li>将git项目中的prometheus.lua，prometheus_keys.lua，prometheus_resty_counter.lua 这几个库文件放置到lua的lua_package_path 指向的文件路径</li>
<li>在nginx项目启动时初始化prometheus库，即在nginx.conf配置文件中增加以下内容：</li>
</ol>

<pre><code class="hljs language-csharp" lang="csharp">lua_shared_dict prometheus_metrics <span class="hljs-number">10</span>M;
lua_package_path <span class="hljs-string">"/path/to/nginx-lua-prometheus/?.lua;;"</span>;

init_worker_by_lua_block {
  prometheus = require(<span class="hljs-string">"prometheus"</span>).<span class="hljs-keyword">init</span>(<span class="hljs-string">"prometheus_metrics"</span>)

  metric_requests = prometheus:counter(
    <span class="hljs-string">"nginx_http_requests_total"</span>, <span class="hljs-string">"Number of HTTP requests"</span>, {<span class="hljs-string">"host"</span>, <span class="hljs-string">"status"</span>})
  metric_latency = prometheus:histogram(
    <span class="hljs-string">"nginx_http_request_duration_seconds"</span>, <span class="hljs-string">"HTTP request latency"</span>, {<span class="hljs-string">"host"</span>})
  metric_connections = prometheus:gauge(
    <span class="hljs-string">"nginx_http_connections"</span>, <span class="hljs-string">"Number of HTTP connections"</span>, {<span class="hljs-string">"state"</span>})
}

log_by_lua_block {
  metric_requests:inc(<span class="hljs-number">1</span>, {ngx.<span class="hljs-keyword">var</span>.server_name, ngx.<span class="hljs-keyword">var</span>.status})
  metric_latency:observe(tonumber(ngx.<span class="hljs-keyword">var</span>.request_time), {ngx.<span class="hljs-keyword">var</span>.server_name})
}
</code></pre>
<p>3.  增加一个路由，将nginx的监控数据导出，支持prometheus抓取，可以在nginx.conf中增加以下配置：</p>

<pre><code class="hljs language-csharp" lang="csharp">server {
  listen <span class="hljs-number">9145</span>;
  allow <span class="hljs-number">192.168</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">16</span>;
  deny all;
  location /metrics {
    content_by_lua_block {
      metric_connections:<span class="hljs-keyword">set</span>(ngx.<span class="hljs-keyword">var</span>.connections_reading, {<span class="hljs-string">"reading"</span>})
      metric_connections:<span class="hljs-keyword">set</span>(ngx.<span class="hljs-keyword">var</span>.connections_waiting, {<span class="hljs-string">"waiting"</span>})
      metric_connections:<span class="hljs-keyword">set</span>(ngx.<span class="hljs-keyword">var</span>.connections_writing, {<span class="hljs-string">"writing"</span>})
      prometheus:collect()
    }
  }
}
</code></pre>
<p>4.  上面几个事官方的安装步骤，我这里加了一个导出upstream信息的路由，可以写在/metrics 这个路由下面</p>

<pre><code class="hljs language-lua" lang="lua">location = /upstreams_metrics {
            default_type text/plain;
            content_by_lua_block {
                <span class="hljs-keyword">local</span> <span class="hljs-built_in">concat</span> = <span class="hljs-built_in">table</span>.<span class="hljs-built_in">concat</span>
                <span class="hljs-keyword">local</span> upstream = <span class="hljs-built_in">require</span> <span class="hljs-string">"ngx.upstream"</span>
                <span class="hljs-keyword">local</span> get_servers = upstream.get_servers
                <span class="hljs-keyword">local</span> get_upstreams = upstream.get_upstreams
                <span class="hljs-keyword">local</span> get_primary_peers = upstream.get_primary_peers

                <span class="hljs-keyword">local</span> us = get_upstreams()
                <span class="hljs-keyword">for</span> _, u <span class="hljs-keyword">in</span> <span class="hljs-built_in">ipairs</span>(us) <span class="hljs-keyword">do</span>
                    <span class="hljs-keyword">local</span> srvs, err = get_primary_peers(u)
                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> srvs <span class="hljs-keyword">then</span>
                        ngx.say(<span class="hljs-string">"#failed to get servers in upstream "</span>, u)
                    <span class="hljs-keyword">else</span>
                        <span class="hljs-keyword">for</span> _, server <span class="hljs-keyword">in</span> <span class="hljs-built_in">ipairs</span>(srvs) <span class="hljs-keyword">do</span>
                            <span class="hljs-keyword">local</span> message = <span class="hljs-built_in">string</span>.<span class="hljs-built_in">format</span>(<span class="hljs-string">'nginx_upstream_conn_total{upstream="%s",server="%s"} %s'</span>,<span class="hljs-built_in">tostring</span>(u),<span class="hljs-built_in">tostring</span>(server.name),<span class="hljs-built_in">tostring</span>(server.conns <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>))
                            ngx.say(message)
                        <span class="hljs-keyword">end</span>
                    <span class="hljs-keyword">end</span>
                <span class="hljs-keyword">end</span>
            }
        }
</code></pre>
<p>5.  这里nginx就可以把监控数据导出了，接下来需要配置prometheus抓取这部分数据，这里分为两种情况，如果是部署的prometheus实例的话，可以直接抓取对应nginx实例的端口</p>

<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">'nginx-moniter'</span>
  <span class="hljs-attr">static_configs:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">'10.10.1.123:9145'</span>]
    <span class="hljs-attr">labels:</span>
      <span class="hljs-attr">exporter:</span> <span class="hljs-string">'nginx'</span>
</code></pre>
<p>6.  如果是使用k8s部署的nginx，并且prometheus是使用operator部署的，那可以通过如下方式导出</p>

<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">k8s的nginx</span> <span class="hljs-string">service配置：</span>

<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span>
    <span class="hljs-attr">group:</span> <span class="hljs-string">default</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span>
  <span class="hljs-attr">ports:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">metrics</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">9145</span>
      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">9145</span>
      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span>
    <span class="hljs-attr">group:</span> <span class="hljs-string">default</span>
    
    
<span class="hljs-string">k8s的nginx的deployment记得在配置中加下端口：</span>

<span class="hljs-attr">containers:</span>
  <span class="hljs-attr">ports:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">9023</span>


<span class="hljs-string">最后是prometheus的serviceMonitor的配置：</span>

<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">monitoring.coreos.com/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceMonitor</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">app.kubernetes.io/component:</span> <span class="hljs-string">monitor</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">endpoints:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-string">metrics</span>
    <span class="hljs-attr">path:</span> <span class="hljs-string">/metrics</span>
    <span class="hljs-attr">interval:</span> <span class="hljs-string">30s</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-string">metrics</span>
    <span class="hljs-attr">path:</span> <span class="hljs-string">/upstreams_metrics</span>
    <span class="hljs-attr">interval:</span> <span class="hljs-string">30s</span>
  <span class="hljs-attr">namespaceSelector:</span>
    <span class="hljs-attr">matchNames:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">default</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchExpressions:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">name</span>
      <span class="hljs-attr">operator:</span> <span class="hljs-string">In</span>
      <span class="hljs-attr">values:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">nginx</span>
</code></pre>
<p>7.  这样prometheus就抓取到nginx的监控数据了，接下来的就是在grafana中配置大屏进行展示，这个可以在grafana dashboard网页上找喜欢的界面，比如10223这个id，我这边是使用原始的界面然后改造了下，<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffengdeguisu%2Farticle%2Fblob%2Fmain%2Fopenresty%25E7%259B%2591%25E6%258E%25A7%2Fnginx%25E7%259B%2591%25E6%258E%25A7%25E5%25A4%25A7%25E5%25B1%258F.json" target="_blank" title="https://github.com/fengdeguisu/article/blob/main/openresty%E7%9B%91%E6%8E%A7/nginx%E7%9B%91%E6%8E%A7%E5%A4%A7%E5%B1%8F.json" ref="nofollow noopener noreferrer">可以通过此链接下载json文件</a>，需要的可以在grafana的导入按钮中输入json格式的数据来导入界面。</p>
<h6 data-id="heading-6">使用介绍</h6>
<p>安装完之后，就可以看到上面成果介绍中的nginx监控大屏的效果了，他可以同时监控多个nginx实例，上半部分的全站监控数据，展示了所有nginx实例汇总过后的qps，连接数，错误数，延迟等信息，下半部分是按照主机维度或者pod维度汇总的对应数据。下面简单的介绍下：</p>
<p><strong>qps</strong>： 可以用于查看每秒的请求数，确认是否有突增请求</p>
<p><strong>平均活跃连接数</strong>： 用于查看客户端的连接数，如果突增，可能是内部处理慢了，需要查看是否有瓶颈</p>
<p><strong>平均请求响应时间</strong>： 用于查看响应时间，如果太高，说明客户体验会收到严重影响，需要进行排查</p>
<p><strong>5xx错误率</strong>： 500状态码的占比，这个值升高的话，说明服务器内部出现了问题，无法处理请求，<strong>可以针对这个值增加监控预警，及时发现问题并处理</strong>。</p>
<p><strong>upstream平均活跃连接数</strong>：  展示了以upstream来进行汇总的活跃连接数量，如果某个曲线比较高，说明对应的后端服务器处理慢，导致连接池溢出了，需要进行处理。需要注意的是，这里的前提是使用nginx的upstream来代理后端，并且启用keepalive 这个配置的连接池功能，这也是推荐的做法，能通过复用后端代理连接提高性能。</p>
<h6 data-id="heading-7">监控大屏设置了几个选项，这里也介绍下：</h6>
<p><strong>upstream汇总类型</strong>： 用于设置下半部分的upstream活跃连接数，可以通过设置为pod来查看每个nginx实例的汇总代理连接数，如果这个值突增，那代表对应的nginx实例的后端代理有问题，可以使用upstream选项来查看是哪个后端服务组有问题
<strong>qps分组维度</strong>： 用于设置下半部分的各个指标的分组维度，由pod和instant两种选项，分别按照nginx实例或者主机汇总，在出现突增情况时，可以用于确定是哪个实例有问题。
<strong>upstream pod和upstream</strong>： 用于指定某个实例或者后端代理来查看对应数据</p>
<h6 data-id="heading-8">排查问题方式</h6>
<p>推荐可以先看下上半部分的整体数据，确认集群是否正常，然后再查看下半部分，确认出问题的实例。</p>
<p>出问题的维度有两种，一种是部分nginx实例有问题，此时可以通过按照pod分组查看监控找到问题实例，还有一种是某个后端代理服务有问题，此时可以通过upstream分组查看出问题的具体后端服务。</p>
<p>如果是某个后端服务有问题，比如处理请求很慢，就会出现nginx中的对应的后端代理连接数激增，然后因为连接数太多，导致nginx整体出现cpu使用率高，服务报错等情况，通过这个upstream连接数的监控就可以识别出 有问题的后端服务，快速查出问题。</p>
<br/>
<h4 data-id="heading-9">异常监控</h4>
<p>异常监控是指在使用lua处理请求时，如果有值得需要注意的情况，可以使用error级别进行打印，同时通过日志收集系统将error级别的日志过滤出来，导出到prometheus中作为监控。 这样，业务的lua异常和系统的异常就都导入到prometheus中了，可以通过查看这部分最新的数据来排查当前系统是否有问题，也可以通过增加监控来及时发现问题。</p>
<p>关于此部分，也可以查看笔者的另一篇文章<a href="https://juejin.cn/post/7580287891274186815" target="_blank" title="https://juejin.cn/post/7580287891274186815">监控利器：java异常监控</a>，这篇文章具体介绍了导出java异常监控的优势和实现方式。</p>
<h6 data-id="heading-10">安装</h6>
<ol>
<li>可以在需要关注的地方手动加入打印，使用error级别的日志打印，如 ngx.log(ngx.ERR, "there is an error")</li>
<li>error级别的日志在打印时会自带[error]的字符，在日志收集端将nginx日志中带有[error]字符的日志统一转存到一个文件，这个文件中的日志就都是error日志，包括用户打印的和nginx的系统异常日志。</li>
<li>使用mtail解析异常日志文件，将nginx的异常日志导出到prometheus中</li>
<li>grafana增加界面显示最新的nginx异常，<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffengdeguisu%2Farticle%2Fblob%2Fmain%2Fopenresty%25E7%259B%2591%25E6%258E%25A7%2Fnginx%25E5%25BC%2582%25E5%25B8%25B8%25E7%259B%2591%25E6%258E%25A7.json" target="_blank" title="https://github.com/fengdeguisu/article/blob/main/openresty%E7%9B%91%E6%8E%A7/nginx%E5%BC%82%E5%B8%B8%E7%9B%91%E6%8E%A7.json" ref="nofollow noopener noreferrer">这是json文件的链接</a>,可以通过复制json文件的内容，在grafana的导入界面导入。</li>
</ol>
<h6 data-id="heading-11">使用方式</h6>
<p>可以在界面直接查看，根据选择的日期区间，会显示指定时间范围内的nginx异常。这个监控主要有三种用法：</p>
<ol>
<li>在prometheus中增加监控规则，当某一时刻突然出现很多异常时触发报警，用于及时发现问题</li>
<li>在排查nginx的问题时，查看此监控，可能会发现一些系统异常，说不定就能直接找到问题原因</li>
<li>在排查问题结束后，查看此监控，只有确保这个监控中的最近几分钟已经确实没有新异常了，才能大概率说明nginx的问题被解决了，只要还有不断地新增异常，说明问题并未彻底解决。</li>
</ol>
<h4 data-id="heading-12">结语</h4>
<p>以上就是这篇文章的内容，主要介绍了两种openresty的监控方式，希望对大家监控和排查nginx问题有帮助。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redisson 实战指南]]></title>    <link>https://juejin.cn/post/7588104741610323978</link>    <guid>https://juejin.cn/post/7588104741610323978</guid>    <pubDate>2025-12-27T14:44:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588104741610323978" data-draft-id="7588067055481913353" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redisson 实战指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-27T14:44:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GKunLi"/> <meta itemprop="url" content="https://juejin.cn/user/430664725579725"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redisson 实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/430664725579725/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GKunLi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T14:44:59.000Z" title="Sat Dec 27 2025 14:44:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读33分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Redisson：分布式系统的Java神器 🚀</h2>
<p>Redisson是一个功能强大、设计优雅的Redis Java客户端，它不仅仅是一个简单的Redis连接器，更是一个完整的分布式解决方案！想象一下，如果你正在构建一个高并发的电商平台，需要处理大量用户的秒杀请求，或者需要在多个服务实例之间共享会话状态，Redisson就是你的得力助手。</p>
<p><strong>Redisson的核心特点：</strong></p>
<ul>
<li>🎯 <strong>丰富的分布式对象</strong>：提供分布式锁、集合、计数器等Java常用对象</li>
<li>⚡ <strong>高性能</strong>：基于Netty实现，性能卓越</li>
<li>🔒 <strong>分布式锁</strong>：支持可重入锁、公平锁、联锁等多种锁类型</li>
<li>📊 <strong>分布式集合</strong>：提供Map、Set、List、Queue等分布式集合类型</li>
<li>🎪 <strong>高级功能</strong>：支持布隆过滤器、延迟队列、分布式服务等</li>
<li>🌐 <strong>多Redis模式</strong>：支持单机、主从、哨兵、集群等多种Redis部署模式</li>
</ul>
<p>Redisson让分布式系统的开发变得简单而有趣，让你的代码在分布式环境中也能像单机应用一样优雅地运行。</p>
<h2 data-id="heading-1">高级功能实战</h2>
<h3 data-id="heading-2">1. 分布式锁</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.redisson.api.RLock;
<span class="hljs-keyword">import</span> org.redisson.api.RedissonClient;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;
<span class="hljs-keyword">import</span> java.util.concurrent.locks.Lock;

<span class="hljs-comment">/**
 * 分布式锁生产级使用示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistributedLockExample</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RedissonClient redissonClient;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DistributedLockExample</span><span class="hljs-params">(RedissonClient redissonClient)</span> {
        <span class="hljs-built_in">this</span>.redissonClient = redissonClient;
    }
    
    <span class="hljs-comment">/**
     * 带超时控制的分布式锁
     * 
     * <span class="hljs-doctag">@param</span> lockKey 锁的key
     * <span class="hljs-doctag">@param</span> leaseTime 自动释放时间
     * <span class="hljs-doctag">@param</span> unit 时间单位
     * <span class="hljs-doctag">@param</span> task 需要执行的任务
     * <span class="hljs-doctag">@return</span> 任务执行结果
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">executeWithLock</span><span class="hljs-params">(String lockKey, <span class="hljs-type">long</span> leaseTime, TimeUnit unit, Runnable task)</span> {
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(lockKey);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 尝试获取锁，最多等待10秒，锁自动释放时间为leaseTime</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">acquired</span> <span class="hljs-operator">=</span> lock.tryLock(<span class="hljs-number">10</span>, leaseTime, unit);
            <span class="hljs-keyword">if</span> (acquired) {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-comment">// 执行业务逻辑</span>
                    task.run();
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                } <span class="hljs-keyword">finally</span> {
                    <span class="hljs-comment">// 确保锁被释放，防止死锁</span>
                    <span class="hljs-keyword">if</span> (lock.isHeldByCurrentThread()) {
                        lock.unlock();
                    }
                }
            } <span class="hljs-keyword">else</span> {
                System.out.println(<span class="hljs-string">"获取锁失败，锁已被其他线程持有: "</span> + lockKey);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
            System.err.println(<span class="hljs-string">"获取锁过程中被中断: "</span> + e.getMessage());
            <span class="hljs-comment">// 恢复中断状态</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
    
    <span class="hljs-comment">/**
     * 看门狗模式锁 - 自动续期
     * 
     * <span class="hljs-doctag">@param</span> lockKey 锁的key
     * <span class="hljs-doctag">@param</span> task 需要执行的任务
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">executeWithWatchdogLock</span><span class="hljs-params">(String lockKey, Runnable task)</span> {
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(lockKey);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 使用看门狗模式，Redisson会自动续期</span>
            lock.lock(<span class="hljs-number">30</span>, TimeUnit.SECONDS);
            <span class="hljs-keyword">try</span> {
                task.run();
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-comment">// 确保锁被释放</span>
                <span class="hljs-keyword">if</span> (lock.isHeldByCurrentThread()) {
                    lock.unlock();
                }
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"执行带锁任务时发生异常: "</span> + e.getMessage());
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
}
</code></pre>
<h3 data-id="heading-3">2. 分布式集合</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.redisson.api.RList;
<span class="hljs-keyword">import</span> org.redisson.api.RMap;
<span class="hljs-keyword">import</span> org.redisson.api.RSet;
<span class="hljs-keyword">import</span> org.redisson.api.RedissonClient;
<span class="hljs-keyword">import</span> java.util.Collection;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-comment">/**
 * 分布式集合生产级使用示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistributedCollectionsExample</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RedissonClient redissonClient;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DistributedCollectionsExample</span><span class="hljs-params">(RedissonClient redissonClient)</span> {
        <span class="hljs-built_in">this</span>.redissonClient = redissonClient;
    }
    
    <span class="hljs-comment">/**
     * 分布式列表操作
     * 
     * <span class="hljs-doctag">@param</span> listName 列表名称
     * <span class="hljs-doctag">@param</span> items 要添加的项目
     * <span class="hljs-doctag">@return</span> 操作结果
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">operateList</span><span class="hljs-params">(String listName, Collection&lt;String&gt; items)</span> {
        <span class="hljs-keyword">try</span> {
            RList&lt;String&gt; list = redissonClient.getList(listName);
            
            <span class="hljs-comment">// 添加多个元素</span>
            list.addAll(items);
            
            <span class="hljs-comment">// 获取列表大小</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> list.size();
            System.out.println(<span class="hljs-string">"列表 "</span> + listName + <span class="hljs-string">" 的大小: "</span> + size);
            
            <span class="hljs-comment">// 获取指定范围的元素</span>
            <span class="hljs-keyword">if</span> (size &gt; <span class="hljs-number">0</span>) {
                <span class="hljs-type">int</span> <span class="hljs-variable">endIndex</span> <span class="hljs-operator">=</span> Math.min(<span class="hljs-number">10</span>, size); <span class="hljs-comment">// 最多取10个元素</span>
                java.util.List&lt;String&gt; subList = list.subList(<span class="hljs-number">0</span>, endIndex);
                System.out.println(<span class="hljs-string">"列表前"</span> + endIndex + <span class="hljs-string">"个元素: "</span> + subList);
            }
            
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"操作列表时发生异常: "</span> + e.getMessage());
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
    
    <span class="hljs-comment">/**
     * 分布式Map操作
     * 
     * <span class="hljs-doctag">@param</span> mapName Map名称
     * <span class="hljs-doctag">@param</span> data 要存储的数据
     * <span class="hljs-doctag">@return</span> 操作结果
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">operateMap</span><span class="hljs-params">(String mapName, Map&lt;String, Object&gt; data)</span> {
        <span class="hljs-keyword">try</span> {
            RMap&lt;String, Object&gt; map = redissonClient.getMap(mapName);
            
            <span class="hljs-comment">// 批量添加数据</span>
            map.putAll(data);
            
            <span class="hljs-comment">// 原子性操作示例：仅当key不存在时才添加</span>
            map.putIfAbsent(<span class="hljs-string">"newKey"</span>, <span class="hljs-string">"newValue"</span>);
            
            <span class="hljs-comment">// 获取所有键值对</span>
            System.out.println(<span class="hljs-string">"Map "</span> + mapName + <span class="hljs-string">" 的所有键值对: "</span> + map.readAllMap());
            
            <span class="hljs-comment">// 获取Map大小</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> map.size();
            System.out.println(<span class="hljs-string">"Map "</span> + mapName + <span class="hljs-string">" 的大小: "</span> + size);
            
            <span class="hljs-comment">// 安全删除键值对</span>
            <span class="hljs-type">Object</span> <span class="hljs-variable">removedValue</span> <span class="hljs-operator">=</span> map.remove(<span class="hljs-string">"tempKey"</span>);
            System.out.println(<span class="hljs-string">"删除的键值对: "</span> + removedValue);
            
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"操作Map时发生异常: "</span> + e.getMessage());
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
    
    <span class="hljs-comment">/**
     * 分布式Set操作
     * 
     * <span class="hljs-doctag">@param</span> setName Set名称
     * <span class="hljs-doctag">@param</span> elements 要添加的元素
     * <span class="hljs-doctag">@return</span> 操作结果
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">operateSet</span><span class="hljs-params">(String setName, Collection&lt;String&gt; elements)</span> {
        <span class="hljs-keyword">try</span> {
            RSet&lt;String&gt; set = redissonClient.getSet(setName);
            
            <span class="hljs-comment">// 添加元素并返回是否成功添加（true表示元素不存在，false表示已存在）</span>
            <span class="hljs-keyword">for</span> (String element : elements) {
                <span class="hljs-type">boolean</span> <span class="hljs-variable">added</span> <span class="hljs-operator">=</span> set.add(element);
                <span class="hljs-keyword">if</span> (!added) {
                    System.out.println(<span class="hljs-string">"元素已存在: "</span> + element);
                }
            }
            
            <span class="hljs-comment">// 检查元素是否存在</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">contains</span> <span class="hljs-operator">=</span> set.contains(<span class="hljs-string">"checkElement"</span>);
            System.out.println(<span class="hljs-string">"Set "</span> + setName + <span class="hljs-string">" 包含 'checkElement': "</span> + contains);
            
            <span class="hljs-comment">// 获取Set大小</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> set.size();
            System.out.println(<span class="hljs-string">"Set "</span> + setName + <span class="hljs-string">" 的大小: "</span> + size);
            
            <span class="hljs-comment">// 获取所有元素</span>
            java.util.Set&lt;String&gt; allElements = set.readAll();
            System.out.println(<span class="hljs-string">"Set "</span> + setName + <span class="hljs-string">" 的所有元素: "</span> + allElements);
            
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"操作Set时发生异常: "</span> + e.getMessage());
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
}
</code></pre>
<h3 data-id="heading-4">3. 分布式计数器</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.redisson.api.RAtomicLong;
<span class="hljs-keyword">import</span> org.redisson.api.RCountDownLatch;
<span class="hljs-keyword">import</span> org.redisson.api.RedissonClient;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-comment">/**
 * 分布式计数器生产级使用示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistributedCountersExample</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RedissonClient redissonClient;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DistributedCountersExample</span><span class="hljs-params">(RedissonClient redissonClient)</span> {
        <span class="hljs-built_in">this</span>.redissonClient = redissonClient;
    }
    
    <span class="hljs-comment">/**
     * 原子长整型计数器操作
     * 
     * <span class="hljs-doctag">@param</span> counterName 计数器名称
     * <span class="hljs-doctag">@return</span> 当前计数值
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">operateAtomicCounter</span><span class="hljs-params">(String counterName)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">RAtomicLong</span> <span class="hljs-variable">atomicLong</span> <span class="hljs-operator">=</span> redissonClient.getAtomicLong(counterName);
            
            <span class="hljs-comment">// 原子递增并返回新值</span>
            <span class="hljs-type">long</span> <span class="hljs-variable">newValue</span> <span class="hljs-operator">=</span> atomicLong.incrementAndGet();
            System.out.println(<span class="hljs-string">"计数器 "</span> + counterName + <span class="hljs-string">" 递增后值: "</span> + newValue);
            
            <span class="hljs-comment">// 原子递减并返回新值</span>
            <span class="hljs-type">long</span> <span class="hljs-variable">decrementedValue</span> <span class="hljs-operator">=</span> atomicLong.decrementAndGet();
            System.out.println(<span class="hljs-string">"计数器 "</span> + counterName + <span class="hljs-string">" 递减后值: "</span> + decrementedValue);
            
            <span class="hljs-comment">// 获取当前值</span>
            <span class="hljs-type">long</span> <span class="hljs-variable">currentValue</span> <span class="hljs-operator">=</span> atomicLong.get();
            System.out.println(<span class="hljs-string">"计数器 "</span> + counterName + <span class="hljs-string">" 当前值: "</span> + currentValue);
            
            <span class="hljs-comment">// 条件更新 - CAS操作</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">updated</span> <span class="hljs-operator">=</span> atomicLong.compareAndSet(currentValue, currentValue + <span class="hljs-number">10</span>);
            <span class="hljs-keyword">if</span> (updated) {
                System.out.println(<span class="hljs-string">"计数器 "</span> + counterName + <span class="hljs-string">" CAS更新成功"</span>);
            } <span class="hljs-keyword">else</span> {
                System.out.println(<span class="hljs-string">"计数器 "</span> + counterName + <span class="hljs-string">" CAS更新失败"</span>);
            }
            
            <span class="hljs-keyword">return</span> atomicLong.get();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"操作原子计数器时发生异常: "</span> + e.getMessage());
            <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
        }
    }
    
    <span class="hljs-comment">/**
     * 分布式CountDownLatch操作
     * 
     * <span class="hljs-doctag">@param</span> latchName 倒计时器名称
     * <span class="hljs-doctag">@param</span> count 初始计数
     * <span class="hljs-doctag">@param</span> task 待执行的任务
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">operateCountDownLatch</span><span class="hljs-params">(String latchName, <span class="hljs-type">int</span> count, Runnable task)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">RCountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> redissonClient.getCountDownLatch(latchName);
            
            <span class="hljs-comment">// 设置初始计数（仅在计数为0时有效）</span>
            <span class="hljs-keyword">if</span> (latch.getCount() == <span class="hljs-number">0</span>) {
                latch.trySetCount(count);
            }
            
            System.out.println(<span class="hljs-string">"倒计时器 "</span> + latchName + <span class="hljs-string">" 初始计数: "</span> + latch.getCount());
            
            <span class="hljs-comment">// 启动一个线程执行任务并倒计时</span>
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
                <span class="hljs-keyword">try</span> {
                    task.run();
                    <span class="hljs-comment">// 任务完成，倒计时</span>
                    latch.countDown();
                    System.out.println(<span class="hljs-string">"任务完成，倒计时器 "</span> + latchName + <span class="hljs-string">" 减1"</span>);
                } <span class="hljs-keyword">catch</span> (Exception e) {
                    System.err.println(<span class="hljs-string">"执行任务时发生异常: "</span> + e.getMessage());
                }
            }).start();
            
            <span class="hljs-comment">// 等待所有任务完成（带超时）</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">completed</span> <span class="hljs-operator">=</span> latch.await(<span class="hljs-number">30</span>, TimeUnit.SECONDS);
            <span class="hljs-keyword">if</span> (completed) {
                System.out.println(<span class="hljs-string">"所有任务已完成"</span>);
            } <span class="hljs-keyword">else</span> {
                System.out.println(<span class="hljs-string">"等待超时，任务可能未完成"</span>);
            }
            
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
            System.err.println(<span class="hljs-string">"等待倒计时器时被中断: "</span> + e.getMessage());
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"操作倒计时器时发生异常: "</span> + e.getMessage());
        }
    }
}
</code></pre>
<h3 data-id="heading-5">4. 信号量 (Semaphore)</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.redisson.api.RSemaphore;
<span class="hljs-keyword">import</span> org.redisson.api.RedissonClient;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-comment">/**
 * 信号量生产级使用示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SemaphoreExample</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RedissonClient redissonClient;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SemaphoreExample</span><span class="hljs-params">(RedissonClient redissonClient)</span> {
        <span class="hljs-built_in">this</span>.redissonClient = redissonClient;
    }
    
    <span class="hljs-comment">/**
     * 信号量资源访问控制
     * 
     * <span class="hljs-doctag">@param</span> semaphoreName 信号量名称
     * <span class="hljs-doctag">@param</span> permits 初始许可证数量
     * <span class="hljs-doctag">@param</span> task 需要限制并发的任务
     * <span class="hljs-doctag">@return</span> 操作结果
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">controlAccessWithSemaphore</span><span class="hljs-params">(String semaphoreName, <span class="hljs-type">int</span> <span class="hljs-keyword">permits</span>, Runnable task)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">RSemaphore</span> <span class="hljs-variable">semaphore</span> <span class="hljs-operator">=</span> redissonClient.getSemaphore(semaphoreName);
            
            <span class="hljs-comment">// 初始化许可证数量（仅在许可证为0时设置）</span>
            semaphore.trySetPermits(<span class="hljs-keyword">permits</span>);
            
            <span class="hljs-comment">// 获取许可证（带超时）</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">acquired</span> <span class="hljs-operator">=</span> semaphore.tryAcquire(<span class="hljs-number">5</span>, TimeUnit.SECONDS);
            <span class="hljs-keyword">if</span> (acquired) {
                <span class="hljs-keyword">try</span> {
                    System.out.println(<span class="hljs-string">"获取到许可证，开始执行任务"</span>);
                    task.run();
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                } <span class="hljs-keyword">finally</span> {
                    <span class="hljs-comment">// 释放许可证</span>
                    semaphore.release();
                    System.out.println(<span class="hljs-string">"任务完成，释放许可证"</span>);
                }
            } <span class="hljs-keyword">else</span> {
                System.out.println(<span class="hljs-string">"获取许可证超时，资源访问受限"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
            System.err.println(<span class="hljs-string">"获取许可证时被中断: "</span> + e.getMessage());
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"使用信号量时发生异常: "</span> + e.getMessage());
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
    
    <span class="hljs-comment">/**
     * 批量获取和释放许可证
     * 
     * <span class="hljs-doctag">@param</span> semaphoreName 信号量名称
     * <span class="hljs-doctag">@param</span> permitsToAcquire 要获取的许可证数量
     * <span class="hljs-doctag">@param</span> permitsToRelease 要释放的许可证数量
     * <span class="hljs-doctag">@return</span> 操作结果
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">batchOperateSemaphore</span><span class="hljs-params">(String semaphoreName, <span class="hljs-type">int</span> permitsToAcquire, <span class="hljs-type">int</span> permitsToRelease)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">RSemaphore</span> <span class="hljs-variable">semaphore</span> <span class="hljs-operator">=</span> redissonClient.getSemaphore(semaphoreName);
            
            <span class="hljs-comment">// 批量获取许可证</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">acquired</span> <span class="hljs-operator">=</span> semaphore.tryAcquire(permitsToAcquire, <span class="hljs-number">10</span>, TimeUnit.SECONDS);
            <span class="hljs-keyword">if</span> (acquired) {
                <span class="hljs-keyword">try</span> {
                    System.out.println(<span class="hljs-string">"批量获取 "</span> + permitsToAcquire + <span class="hljs-string">" 个许可证成功"</span>);
                    <span class="hljs-comment">// 执行需要多许可证的任务</span>
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                } <span class="hljs-keyword">finally</span> {
                    <span class="hljs-comment">// 批量释放许可证</span>
                    semaphore.release(permitsToRelease);
                    System.out.println(<span class="hljs-string">"批量释放 "</span> + permitsToRelease + <span class="hljs-string">" 个许可证"</span>);
                }
            } <span class="hljs-keyword">else</span> {
                System.out.println(<span class="hljs-string">"批量获取 "</span> + permitsToAcquire + <span class="hljs-string">" 个许可证失败"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
            System.err.println(<span class="hljs-string">"批量获取许可证时被中断: "</span> + e.getMessage());
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"批量操作信号量时发生异常: "</span> + e.getMessage());
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
}
</code></pre>
<h3 data-id="heading-6">5. 分布式队列</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.redisson.api.RBlockingQueue;
<span class="hljs-keyword">import</span> org.redisson.api.RQueue;
<span class="hljs-keyword">import</span> org.redisson.api.RedissonClient;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-comment">/**
 * 分布式队列生产级使用示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistributedQueueExample</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RedissonClient redissonClient;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DistributedQueueExample</span><span class="hljs-params">(RedissonClient redissonClient)</span> {
        <span class="hljs-built_in">this</span>.redissonClient = redissonClient;
    }
    
    <span class="hljs-comment">/**
     * 普通队列操作
     * 
     * <span class="hljs-doctag">@param</span> queueName 队列名称
     * <span class="hljs-doctag">@param</span> items 要添加的项目
     * <span class="hljs-doctag">@return</span> 操作结果
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">operateQueue</span><span class="hljs-params">(String queueName, java.util.List&lt;String&gt; items)</span> {
        <span class="hljs-keyword">try</span> {
            RQueue&lt;String&gt; queue = redissonClient.getQueue(queueName);
            
            <span class="hljs-comment">// 添加多个元素到队列</span>
            <span class="hljs-keyword">for</span> (String item : items) {
                <span class="hljs-type">boolean</span> <span class="hljs-variable">added</span> <span class="hljs-operator">=</span> queue.offer(item);
                <span class="hljs-keyword">if</span> (!added) {
                    System.out.println(<span class="hljs-string">"队列已满，无法添加元素: "</span> + item);
                }
            }
            
            <span class="hljs-comment">// 获取队列大小</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> queue.size();
            System.out.println(<span class="hljs-string">"队列 "</span> + queueName + <span class="hljs-string">" 当前大小: "</span> + size);
            
            <span class="hljs-comment">// 非阻塞获取元素</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">element</span> <span class="hljs-operator">=</span> queue.poll(); <span class="hljs-comment">// 获取并移除队首元素，如果队列为空返回null</span>
            <span class="hljs-keyword">if</span> (element != <span class="hljs-literal">null</span>) {
                System.out.println(<span class="hljs-string">"从队列获取元素: "</span> + element);
            } <span class="hljs-keyword">else</span> {
                System.out.println(<span class="hljs-string">"队列为空"</span>);
            }
            
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"操作队列时发生异常: "</span> + e.getMessage());
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
    
}
</code></pre>
<h3 data-id="heading-7">6. 延迟队列 (Delayed Queue)</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.redisson.api.RBlockingQueue;
<span class="hljs-keyword">import</span> org.redisson.api.RDelayedQueue;
<span class="hljs-keyword">import</span> org.redisson.api.RedissonClient;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-comment">/**
 * 延迟队列生产级使用示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DelayedQueueExample</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RedissonClient redissonClient;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DelayedQueueExample</span><span class="hljs-params">(RedissonClient redissonClient)</span> {
        <span class="hljs-built_in">this</span>.redissonClient = redissonClient;
    }
    
    <span class="hljs-comment">/**
     * 延迟队列操作
     * 
     * <span class="hljs-doctag">@param</span> queueName 队列名称
     * <span class="hljs-doctag">@param</span> delayedItems 延迟项目列表，包含项目和延迟时间
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">operateDelayedQueue</span><span class="hljs-params">(String queueName, java.util.List&lt;DelayedItem&gt; delayedItems)</span> {
        RBlockingQueue&lt;String&gt; queue = redissonClient.getBlockingQueue(queueName);
        RDelayedQueue&lt;String&gt; delayedQueue = redissonClient.getDelayedQueue(queue);
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 添加延迟元素</span>
            <span class="hljs-keyword">for</span> (DelayedItem item : delayedItems) {
                delayedQueue.offer(item.item, item.delay, item.unit);
                System.out.println(<span class="hljs-string">"添加延迟元素: "</span> + item.item + 
                                 <span class="hljs-string">"，延迟时间: "</span> + item.delay + <span class="hljs-string">" "</span> + item.unit);
            }
            
            <span class="hljs-comment">// 启动消费者线程处理延迟元素</span>
            <span class="hljs-type">Thread</span> <span class="hljs-variable">consumerThread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">while</span> (!Thread.currentThread().isInterrupted()) {
                        <span class="hljs-comment">// 阻塞等待延迟时间到达的元素</span>
                        <span class="hljs-type">String</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> queue.take();
                        System.out.println(<span class="hljs-string">"获取到延迟元素: "</span> + item + 
                                         <span class="hljs-string">"，到达时间: "</span> + System.currentTimeMillis());
                        
                        <span class="hljs-comment">// 处理延迟元素</span>
                        processDelayedItem(item);
                    }
                } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                    Thread.currentThread().interrupt();
                    System.out.println(<span class="hljs-string">"消费者线程被中断"</span>);
                } <span class="hljs-keyword">catch</span> (Exception e) {
                    System.err.println(<span class="hljs-string">"处理延迟元素时发生异常: "</span> + e.getMessage());
                }
            });
            
            consumerThread.start();
            
            <span class="hljs-comment">// 等待一段时间观察结果</span>
            Thread.sleep(<span class="hljs-number">10000</span>);
            
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
            System.err.println(<span class="hljs-string">"主线程被中断: "</span> + e.getMessage());
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"操作延迟队列时发生异常: "</span> + e.getMessage());
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 重要：使用完延迟队列后必须销毁</span>
            delayedQueue.destroy();
        }
    }
    
    <span class="hljs-comment">/**
     * 处理延迟元素的业务逻辑
     * 
     * <span class="hljs-doctag">@param</span> item 延迟元素
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processDelayedItem</span><span class="hljs-params">(String item)</span> {
        System.out.println(<span class="hljs-string">"处理延迟元素: "</span> + item);
        <span class="hljs-comment">// 实际业务处理逻辑</span>
    }
    
    <span class="hljs-comment">/**
     * 延迟元素封装类
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DelayedItem</span> {
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> String item;
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> delay;
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> TimeUnit unit;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">DelayedItem</span><span class="hljs-params">(String item, <span class="hljs-type">long</span> delay, TimeUnit unit)</span> {
            <span class="hljs-built_in">this</span>.item = item;
            <span class="hljs-built_in">this</span>.delay = delay;
            <span class="hljs-built_in">this</span>.unit = unit;
        }
    }
}
</code></pre>
<h3 data-id="heading-8">7. 发布/订阅模式</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.redisson.api.RTopic;
<span class="hljs-keyword">import</span> org.redisson.api.RedissonClient;
<span class="hljs-keyword">import</span> org.redisson.api.listener.MessageListener;
<span class="hljs-keyword">import</span> java.util.concurrent.CompletableFuture;
<span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService;
<span class="hljs-keyword">import</span> java.util.concurrent.Executors;

<span class="hljs-comment">/**
 * 发布/订阅模式生产级使用示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PubSubExample</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RedissonClient redissonClient;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ExecutorService executorService;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PubSubExample</span><span class="hljs-params">(RedissonClient redissonClient)</span> {
        <span class="hljs-built_in">this</span>.redissonClient = redissonClient;
        <span class="hljs-built_in">this</span>.executorService = Executors.newCachedThreadPool();
    }
    
    <span class="hljs-comment">/**
     * 订阅消息并处理
     * 
     * <span class="hljs-doctag">@param</span> topicName 主题名称
     * <span class="hljs-doctag">@param</span> messageHandler 消息处理器
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">subscribeTopic</span><span class="hljs-params">(String topicName, java.util.function.Consumer&lt;String&gt; messageHandler)</span> {
        <span class="hljs-type">RTopic</span> <span class="hljs-variable">topic</span> <span class="hljs-operator">=</span> redissonClient.getTopic(topicName);
        
        <span class="hljs-comment">// 添加消息监听器</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">listenerId</span> <span class="hljs-operator">=</span> topic.addListener(String.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageListener</span>&lt;String&gt;() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(CharSequence channel, String msg)</span> {
                System.out.println(<span class="hljs-string">"收到消息 - 频道: "</span> + channel + <span class="hljs-string">"，内容: "</span> + msg);
                
                <span class="hljs-comment">// 在独立线程中处理消息，避免阻塞Redisson的消息处理线程</span>
                executorService.submit(() -&gt; {
                    <span class="hljs-keyword">try</span> {
                        messageHandler.accept(msg);
                    } <span class="hljs-keyword">catch</span> (Exception e) {
                        System.err.println(<span class="hljs-string">"处理消息时发生异常: "</span> + e.getMessage());
                    }
                });
            }
        });
        
        System.out.println(<span class="hljs-string">"已订阅主题: "</span> + topicName + <span class="hljs-string">"，监听器ID: "</span> + listenerId);
    }
    
    <span class="hljs-comment">/**
     * 发布消息
     * 
     * <span class="hljs-doctag">@param</span> topicName 主题名称
     * <span class="hljs-doctag">@param</span> message 消息内容
     * <span class="hljs-doctag">@return</span> 发布的消息数量
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">publishMessage</span><span class="hljs-params">(String topicName, String message)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">RTopic</span> <span class="hljs-variable">topic</span> <span class="hljs-operator">=</span> redissonClient.getTopic(topicName);
            
            <span class="hljs-comment">// 发布消息</span>
            <span class="hljs-type">long</span> <span class="hljs-variable">receivers</span> <span class="hljs-operator">=</span> topic.publish(message);
            System.out.println(<span class="hljs-string">"消息已发布到主题: "</span> + topicName + 
                             <span class="hljs-string">"，接收者数量: "</span> + receivers + 
                             <span class="hljs-string">"，消息内容: "</span> + message);
            
            <span class="hljs-keyword">return</span> receivers;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"发布消息时发生异常: "</span> + e.getMessage());
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        }
    }
    
    <span class="hljs-comment">/**
     * 异步发布消息
     * 
     * <span class="hljs-doctag">@param</span> topicName 主题名称
     * <span class="hljs-doctag">@param</span> message 消息内容
     * <span class="hljs-doctag">@return</span> CompletableFuture表示发布结果
     */</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;Long&gt; <span class="hljs-title function_">publishMessageAsync</span><span class="hljs-params">(String topicName, String message)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">RTopic</span> <span class="hljs-variable">topic</span> <span class="hljs-operator">=</span> redissonClient.getTopic(topicName);
            
            <span class="hljs-comment">// 异步发布消息</span>
            <span class="hljs-keyword">return</span> topic.publishAsync(message)
                      .toCompletableFuture()
                      .whenComplete((result, throwable) -&gt; {
                          <span class="hljs-keyword">if</span> (throwable != <span class="hljs-literal">null</span>) {
                              System.err.println(<span class="hljs-string">"异步发布消息失败: "</span> + throwable.getMessage());
                          } <span class="hljs-keyword">else</span> {
                              System.out.println(<span class="hljs-string">"异步发布消息成功，接收者数量: "</span> + result);
                          }
                      });
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"异步发布消息时发生异常: "</span> + e.getMessage());
            <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(<span class="hljs-number">0L</span>);
        }
    }
    
    <span class="hljs-comment">/**
     * 关闭资源
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shutdown</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (executorService != <span class="hljs-literal">null</span> &amp;&amp; !executorService.isShutdown()) {
            executorService.shutdown();
        }
    }
}
</code></pre>
<h3 data-id="heading-9">8. 布隆过滤器 (Bloom Filter)</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.redisson.api.RBloomFilter;
<span class="hljs-keyword">import</span> org.redisson.api.RedissonClient;
<span class="hljs-keyword">import</span> java.util.Collection;

<span class="hljs-comment">/**
 * 布隆过滤器生产级使用示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BloomFilterExample</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RedissonClient redissonClient;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BloomFilterExample</span><span class="hljs-params">(RedissonClient redissonClient)</span> {
        <span class="hljs-built_in">this</span>.redissonClient = redissonClient;
    }
    
    <span class="hljs-comment">/**
     * 创建并初始化布隆过滤器
     * 
     * <span class="hljs-doctag">@param</span> filterName 过滤器名称
     * <span class="hljs-doctag">@param</span> expectedInsertions 预期插入元素数量
     * <span class="hljs-doctag">@param</span> falseProbability 误判率
     * <span class="hljs-doctag">@return</span> 布隆过滤器实例
     */</span>
    <span class="hljs-keyword">public</span> RBloomFilter&lt;String&gt; <span class="hljs-title function_">createBloomFilter</span><span class="hljs-params">(String filterName, 
                                                  <span class="hljs-type">long</span> expectedInsertions, 
                                                  <span class="hljs-type">double</span> falseProbability)</span> {
        <span class="hljs-keyword">try</span> {
            RBloomFilter&lt;String&gt; bloomFilter = redissonClient.getBloomFilter(filterName);
            
            <span class="hljs-comment">// 初始化布隆过滤器（仅在未初始化时设置）</span>
            <span class="hljs-keyword">if</span> (!bloomFilter.isExists()) {
                <span class="hljs-type">boolean</span> <span class="hljs-variable">initialized</span> <span class="hljs-operator">=</span> bloomFilter.tryInit(expectedInsertions, falseProbability);
                <span class="hljs-keyword">if</span> (initialized) {
                    System.out.println(<span class="hljs-string">"布隆过滤器 "</span> + filterName + 
                                     <span class="hljs-string">" 初始化成功，预期插入数量: "</span> + expectedInsertions + 
                                     <span class="hljs-string">"，误判率: "</span> + falseProbability);
                } <span class="hljs-keyword">else</span> {
                    System.out.println(<span class="hljs-string">"布隆过滤器 "</span> + filterName + <span class="hljs-string">" 已存在，跳过初始化"</span>);
                }
            } <span class="hljs-keyword">else</span> {
                System.out.println(<span class="hljs-string">"布隆过滤器 "</span> + filterName + <span class="hljs-string">" 已存在"</span>);
            }
            
            <span class="hljs-keyword">return</span> bloomFilter;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"创建布隆过滤器时发生异常: "</span> + e.getMessage());
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"创建布隆过滤器失败"</span>, e);
        }
    }
    
    <span class="hljs-comment">/**
     * 批量添加元素到布隆过滤器
     * 
     * <span class="hljs-doctag">@param</span> filterName 过滤器名称
     * <span class="hljs-doctag">@param</span> elements 要添加的元素集合
     * <span class="hljs-doctag">@return</span> 成功添加的元素数量
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">batchAddElements</span><span class="hljs-params">(String filterName, Collection&lt;String&gt; elements)</span> {
        <span class="hljs-keyword">try</span> {
            RBloomFilter&lt;String&gt; bloomFilter = redissonClient.getBloomFilter(filterName);
            
            <span class="hljs-keyword">if</span> (!bloomFilter.isExists()) {
                System.out.println(<span class="hljs-string">"布隆过滤器 "</span> + filterName + <span class="hljs-string">" 不存在，无法添加元素"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
            }
            
            <span class="hljs-type">int</span> <span class="hljs-variable">addedCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
            <span class="hljs-keyword">for</span> (String element : elements) {
                <span class="hljs-type">boolean</span> <span class="hljs-variable">added</span> <span class="hljs-operator">=</span> bloomFilter.add(element);
                <span class="hljs-keyword">if</span> (added) {
                    addedCount++;
                }
            }
            
            System.out.println(<span class="hljs-string">"批量添加元素完成，成功添加: "</span> + addedCount + <span class="hljs-string">" 个元素"</span>);
            <span class="hljs-keyword">return</span> addedCount;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"批量添加元素到布隆过滤器时发生异常: "</span> + e.getMessage());
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        }
    }
    
    <span class="hljs-comment">/**
     * 检查元素是否可能存在于布隆过滤器中
     * 
     * <span class="hljs-doctag">@param</span> filterName 过滤器名称
     * <span class="hljs-doctag">@param</span> element 要检查的元素
     * <span class="hljs-doctag">@return</span> true表示可能存在，false表示一定不存在
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">mightContain</span><span class="hljs-params">(String filterName, String element)</span> {
        <span class="hljs-keyword">try</span> {
            RBloomFilter&lt;String&gt; bloomFilter = redissonClient.getBloomFilter(filterName);
            
            <span class="hljs-keyword">if</span> (!bloomFilter.isExists()) {
                System.out.println(<span class="hljs-string">"布隆过滤器 "</span> + filterName + <span class="hljs-string">" 不存在"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
            
            <span class="hljs-type">boolean</span> <span class="hljs-variable">mightContain</span> <span class="hljs-operator">=</span> bloomFilter.contains(element);
            System.out.println(<span class="hljs-string">"元素 '"</span> + element + <span class="hljs-string">"' 在过滤器 "</span> + filterName + 
                             <span class="hljs-string">" 中可能存在: "</span> + mightContain);
            
            <span class="hljs-keyword">return</span> mightContain;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"检查布隆过滤器时发生异常: "</span> + e.getMessage());
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
    
    <span class="hljs-comment">/**
     * 使用布隆过滤器防止缓存穿透的完整示例
     * 
     * <span class="hljs-doctag">@param</span> userId 用户ID
     * <span class="hljs-doctag">@return</span> 用户信息（如果存在）
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">preventCachePenetration</span><span class="hljs-params">(String userId)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">filterName</span> <span class="hljs-operator">=</span> <span class="hljs-string">"user_exists_filter"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"user_cache:"</span> + userId;
        
        <span class="hljs-comment">// 创建布隆过滤器</span>
        RBloomFilter&lt;String&gt; bloomFilter = createBloomFilter(filterName, <span class="hljs-number">1000000</span>, <span class="hljs-number">0.03</span>);
        
        <span class="hljs-comment">// 首先检查布隆过滤器</span>
        <span class="hljs-keyword">if</span> (!bloomFilter.contains(userId)) {
            <span class="hljs-comment">// 布隆过滤器确认元素不存在，直接返回，避免查询缓存和数据库</span>
            System.out.println(<span class="hljs-string">"布隆过滤器确认用户不存在: "</span> + userId);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        
        <span class="hljs-comment">// 布隆过滤器认为可能存在，继续查询缓存</span>
        <span class="hljs-comment">// 这里应该查询实际缓存，但为了示例，我们模拟</span>
        System.out.println(<span class="hljs-string">"布隆过滤器认为用户可能存在，继续查询缓存/数据库: "</span> + userId);
        
        <span class="hljs-comment">// 模拟查询缓存和数据库的逻辑</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">userInfo</span> <span class="hljs-operator">=</span> queryUserInfo(userId);
        
        <span class="hljs-keyword">if</span> (userInfo == <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 如果数据库中确实不存在，可以考虑将该ID加入布隆过滤器</span>
            <span class="hljs-comment">// 但需要谨慎处理，因为用户可能在稍后创建</span>
            System.out.println(<span class="hljs-string">"用户在数据库中不存在: "</span> + userId);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 如果用户存在，将信息存储到缓存</span>
            System.out.println(<span class="hljs-string">"用户存在，更新缓存: "</span> + userId);
        }
        
        <span class="hljs-keyword">return</span> userInfo;
    }
    
    <span class="hljs-comment">/**
     * 模拟查询用户信息
     */</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">queryUserInfo</span><span class="hljs-params">(String userId)</span> {
        <span class="hljs-comment">// 实际应用中这里会查询缓存或数据库</span>
        <span class="hljs-comment">// 为了示例，我们模拟一个简单的逻辑</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"valid_user"</span>.equals(userId)) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"用户信息: "</span> + userId;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<h3 data-id="heading-10">6. 分布式对象</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.redisson.api.RBucket;
<span class="hljs-keyword">import</span> org.redisson.api.RSet;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistributedObjectsExample</span> {
    <span class="hljs-comment">// 自定义对象</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
        <span class="hljs-keyword">private</span> String name;
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age)</span> {
            <span class="hljs-built_in">this</span>.name = name;
            <span class="hljs-built_in">this</span>.age = age;
        }
        
        <span class="hljs-comment">// getter和setter方法</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> name; }
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> { <span class="hljs-built_in">this</span>.name = name; }
        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> age; }
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> { <span class="hljs-built_in">this</span>.age = age; }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">objectsExample</span><span class="hljs-params">(RedissonClient redisson)</span> {
        <span class="hljs-comment">// 存储单个对象</span>
        RBucket&lt;Person&gt; bucket = redisson.getBucket(<span class="hljs-string">"person"</span>);
        bucket.set(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"张三"</span>, <span class="hljs-number">30</span>));
        
        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> bucket.get(); <span class="hljs-comment">// 获取对象</span>
        System.out.println(person.getName()); <span class="hljs-comment">// 输出: 张三</span>
        
        <span class="hljs-comment">// 存储对象集合</span>
        RSet&lt;Person&gt; personSet = redisson.getSet(<span class="hljs-string">"personSet"</span>);
        personSet.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"李四"</span>, <span class="hljs-number">25</span>));
        personSet.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"王五"</span>, <span class="hljs-number">35</span>));
    }
}
</code></pre>
<h2 data-id="heading-11">实际应用场景</h2>
<h3 data-id="heading-12">1. 分布式锁 - 防止重复操作</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.redisson.api.RLock;
<span class="hljs-keyword">import</span> org.redisson.api.RedissonClient;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;
<span class="hljs-keyword">import</span> java.util.concurrent.CompletableFuture;

<span class="hljs-comment">/**
 * 分布式锁生产级应用场景示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistributedLockScenario</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RedissonClient redissonClient;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">DEFAULT_LEASE_TIME</span> <span class="hljs-operator">=</span> <span class="hljs-number">30</span>; <span class="hljs-comment">// 默认租约时间30秒</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">DEFAULT_WAIT_TIME</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;  <span class="hljs-comment">// 默认等待时间10秒</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DistributedLockScenario</span><span class="hljs-params">(RedissonClient redissonClient)</span> {
        <span class="hljs-built_in">this</span>.redissonClient = redissonClient;
    }
    
    <span class="hljs-comment">/**
     * 安全的分布式锁操作
     * 
     * <span class="hljs-doctag">@param</span> lockKey 锁的key
     * <span class="hljs-doctag">@param</span> businessLogic 业务逻辑
     * <span class="hljs-doctag">@return</span> 操作结果
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">executeWithDistributedLock</span><span class="hljs-params">(String lockKey, Runnable businessLogic)</span> {
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">try</span> {
            lock = redissonClient.getLock(lockKey);
            
            <span class="hljs-comment">// 尝试获取锁，最多等待DEFAULT_WAIT_TIME秒，锁自动释放时间为DEFAULT_LEASE_TIME秒</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">acquired</span> <span class="hljs-operator">=</span> lock.tryLock(DEFAULT_WAIT_TIME, DEFAULT_LEASE_TIME, TimeUnit.SECONDS);
            <span class="hljs-keyword">if</span> (acquired) {
                <span class="hljs-keyword">try</span> {
                    System.out.println(<span class="hljs-string">"获取到分布式锁: "</span> + lockKey + 
                                     <span class="hljs-string">"，线程: "</span> + Thread.currentThread().getName());
                    
                    <span class="hljs-comment">// 执行业务逻辑</span>
                    businessLogic.run();
                    
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                } <span class="hljs-keyword">finally</span> {
                    <span class="hljs-comment">// 确保锁被释放，防止死锁</span>
                    <span class="hljs-keyword">if</span> (lock != <span class="hljs-literal">null</span> &amp;&amp; lock.isHeldByCurrentThread()) {
                        lock.unlock();
                        System.out.println(<span class="hljs-string">"释放分布式锁: "</span> + lockKey);
                    }
                }
            } <span class="hljs-keyword">else</span> {
                System.out.println(<span class="hljs-string">"获取分布式锁失败，锁已被其他线程持有: "</span> + lockKey);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
            System.err.println(<span class="hljs-string">"获取分布式锁过程中被中断: "</span> + e.getMessage());
            
            <span class="hljs-comment">// 恢复中断状态并尝试释放锁</span>
            <span class="hljs-keyword">if</span> (lock != <span class="hljs-literal">null</span> &amp;&amp; lock.isHeldByCurrentThread()) {
                <span class="hljs-keyword">try</span> {
                    lock.unlock();
                } <span class="hljs-keyword">catch</span> (Exception unlockException) {
                    System.err.println(<span class="hljs-string">"释放锁时发生异常: "</span> + unlockException.getMessage());
                }
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"执行带锁操作时发生异常: "</span> + e.getMessage());
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
    
    <span class="hljs-comment">/**
     * 异步执行带锁操作
     * 
     * <span class="hljs-doctag">@param</span> lockKey 锁的key
     * <span class="hljs-doctag">@param</span> businessLogic 业务逻辑
     * <span class="hljs-doctag">@return</span> CompletableFuture表示操作结果
     */</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;Boolean&gt; <span class="hljs-title function_">executeWithDistributedLockAsync</span><span class="hljs-params">(String lockKey, Runnable businessLogic)</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-keyword">return</span> executeWithDistributedLock(lockKey, businessLogic);
        });
    }
    
    <span class="hljs-comment">/**
     * 订单处理场景 - 防止重复下单
     * 
     * <span class="hljs-doctag">@param</span> userId 用户ID
     * <span class="hljs-doctag">@param</span> orderId 订单ID
     * <span class="hljs-doctag">@return</span> 处理结果
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">processOrder</span><span class="hljs-params">(String userId, String orderId)</span> {
        <span class="hljs-comment">// 使用用户ID和订单ID作为锁的key，防止同一用户重复下单</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"order_lock:"</span> + userId + <span class="hljs-string">":"</span> + orderId;
        
        <span class="hljs-keyword">return</span> executeWithDistributedLock(lockKey, () -&gt; {
            <span class="hljs-comment">// 检查订单是否已存在</span>
            <span class="hljs-keyword">if</span> (isOrderExists(orderId)) {
                System.out.println(<span class="hljs-string">"订单已存在，跳过处理: "</span> + orderId);
                <span class="hljs-keyword">return</span>;
            }
            
            <span class="hljs-comment">// 执行订单创建逻辑</span>
            System.out.println(<span class="hljs-string">"开始处理订单: "</span> + orderId + <span class="hljs-string">"，用户: "</span> + userId);
            
            <span class="hljs-comment">// 模拟订单处理时间</span>
            <span class="hljs-keyword">try</span> {
                Thread.sleep(<span class="hljs-number">2000</span>);
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
            
            <span class="hljs-comment">// 保存订单</span>
            saveOrder(orderId, userId);
            System.out.println(<span class="hljs-string">"订单处理完成: "</span> + orderId);
        });
    }
    
    <span class="hljs-comment">/**
     * 模拟检查订单是否存在
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isOrderExists</span><span class="hljs-params">(String orderId)</span> {
        <span class="hljs-comment">// 实际应用中这里会查询数据库或缓存</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-comment">/**
     * 模拟保存订单
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveOrder</span><span class="hljs-params">(String orderId, String userId)</span> {
        <span class="hljs-comment">// 实际应用中这里会保存到数据库</span>
        System.out.println(<span class="hljs-string">"订单已保存 - 订单ID: "</span> + orderId + <span class="hljs-string">"，用户ID: "</span> + userId);
    }
}
</code></pre>
<h3 data-id="heading-13">2. 信号量 - 限制并发访问</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.redisson.api.RSemaphore;
<span class="hljs-keyword">import</span> org.redisson.api.RedissonClient;
<span class="hljs-keyword">import</span> java.util.concurrent.CompletableFuture;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-comment">/**
 * 信号量生产级应用场景示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SemaphoreScenario</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RedissonClient redissonClient;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">RESOURCE_ACCESS_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"resource_access:"</span>;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SemaphoreScenario</span><span class="hljs-params">(RedissonClient redissonClient)</span> {
        <span class="hljs-built_in">this</span>.redissonClient = redissonClient;
    }
    
    <span class="hljs-comment">/**
     * 资源访问控制
     * 
     * <span class="hljs-doctag">@param</span> resourceId 资源ID
     * <span class="hljs-doctag">@param</span> maxConcurrent 最大并发数
     * <span class="hljs-doctag">@param</span> accessTask 访问任务
     * <span class="hljs-doctag">@return</span> 访问结果
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">controlResourceAccess</span><span class="hljs-params">(String resourceId, <span class="hljs-type">int</span> maxConcurrent, Runnable accessTask)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">semaphoreKey</span> <span class="hljs-operator">=</span> RESOURCE_ACCESS_PREFIX + resourceId;
        <span class="hljs-type">RSemaphore</span> <span class="hljs-variable">semaphore</span> <span class="hljs-operator">=</span> redissonClient.getSemaphore(semaphoreKey);
        
        <span class="hljs-keyword">try</span> {

            semaphore.trySetPermits(maxConcurrent);
            
            System.out.println(<span class="hljs-string">"资源 "</span> + resourceId + <span class="hljs-string">" 当前可用许可证数: "</span> + semaphore.availablePermits());
            
            <span class="hljs-comment">// 尝试获取许可证，最多等待5秒</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">acquired</span> <span class="hljs-operator">=</span> semaphore.tryAcquire(<span class="hljs-number">5</span>, TimeUnit.SECONDS);
            <span class="hljs-keyword">if</span> (acquired) {
                <span class="hljs-keyword">try</span> {
                    System.out.println(<span class="hljs-string">"获取到资源 "</span> + resourceId + <span class="hljs-string">" 的访问权限，执行访问任务"</span>);
                    
                    <span class="hljs-comment">// 执行资源访问任务</span>
                    accessTask.run();
                    
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                } <span class="hljs-keyword">finally</span> {
                    <span class="hljs-comment">// 释放许可证</span>
                    semaphore.release();
                    System.out.println(<span class="hljs-string">"释放资源 "</span> + resourceId + <span class="hljs-string">" 的访问权限"</span>);
                }
            } <span class="hljs-keyword">else</span> {
                System.out.println(<span class="hljs-string">"获取资源 "</span> + resourceId + <span class="hljs-string">" 访问权限超时，当前可用许可证数: "</span> + 
                                 semaphore.availablePermits());
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
            System.err.println(<span class="hljs-string">"获取许可证时被中断: "</span> + e.getMessage());
            
            <span class="hljs-comment">// 尝试释放许可证</span>
            <span class="hljs-keyword">try</span> {
                semaphore.release();
            } <span class="hljs-keyword">catch</span> (Exception releaseException) {
                System.err.println(<span class="hljs-string">"释放许可证时发生异常: "</span> + releaseException.getMessage());
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"资源访问控制时发生异常: "</span> + e.getMessage());
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
    
    <span class="hljs-comment">/**
     * 秒杀系统中的并发控制
     * 
     * <span class="hljs-doctag">@param</span> productId 商品ID
     * <span class="hljs-doctag">@param</span> userId 用户ID
     * <span class="hljs-doctag">@return</span> 秒杀结果
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">flashSale</span><span class="hljs-params">(String productId, String userId)</span> {
        <span class="hljs-comment">// 使用商品ID作为信号量key，限制同时访问该商品的用户数量</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">semaphoreKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"flash_sale:"</span> + productId;
        <span class="hljs-type">RSemaphore</span> <span class="hljs-variable">semaphore</span> <span class="hljs-operator">=</span> redissonClient.getSemaphore(semaphoreKey);
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 设置秒杀活动的并发限制（例如，最多允许100个用户同时参与）</span>
            semaphore.trySetPermits(<span class="hljs-number">100</span>);
            
            <span class="hljs-comment">// 尝试获取秒杀资格</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">hasQualification</span> <span class="hljs-operator">=</span> semaphore.tryAcquire(<span class="hljs-number">2</span>, TimeUnit.SECONDS);
            <span class="hljs-keyword">if</span> (!hasQualification) {
                System.out.println(<span class="hljs-string">"用户 "</span> + userId + <span class="hljs-string">" 秒杀失败，秒杀资格已满"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
            
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 检查库存</span>
                <span class="hljs-keyword">if</span> (checkStock(productId) &gt; <span class="hljs-number">0</span>) {
                    <span class="hljs-comment">// 扣减库存</span>
                    <span class="hljs-keyword">if</span> (decreaseStock(productId)) {
                        <span class="hljs-comment">// 创建订单</span>
                        createOrder(productId, userId);
                        System.out.println(<span class="hljs-string">"用户 "</span> + userId + <span class="hljs-string">" 秒杀成功，商品: "</span> + productId);
                        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                    } <span class="hljs-keyword">else</span> {
                        System.out.println(<span class="hljs-string">"用户 "</span> + userId + <span class="hljs-string">" 秒杀失败，库存扣减失败"</span>);
                    }
                } <span class="hljs-keyword">else</span> {
                    System.out.println(<span class="hljs-string">"用户 "</span> + userId + <span class="hljs-string">" 秒杀失败，库存不足"</span>);
                }
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-comment">// 释放秒杀资格</span>
                semaphore.release();
            }
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
            System.err.println(<span class="hljs-string">"秒杀过程中被中断: "</span> + e.getMessage());
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"秒杀过程中发生异常: "</span> + e.getMessage());
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-comment">/**
     * 模拟检查库存
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">checkStock</span><span class="hljs-params">(String productId)</span> {
        <span class="hljs-comment">// 实际应用中这里会查询数据库或缓存</span>
        <span class="hljs-keyword">return</span> <span class="hljs-number">10</span>; <span class="hljs-comment">// 模拟有10个库存</span>
    }
    
    <span class="hljs-comment">/**
     * 模拟扣减库存
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">decreaseStock</span><span class="hljs-params">(String productId)</span> {
        <span class="hljs-comment">// 实际应用中这里会更新数据库</span>
        System.out.println(<span class="hljs-string">"扣减商品 "</span> + productId + <span class="hljs-string">" 的库存"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-comment">/**
     * 模拟创建订单
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(String productId, String userId)</span> {
        <span class="hljs-comment">// 实际应用中这里会创建订单记录</span>
        System.out.println(<span class="hljs-string">"为用户 "</span> + userId + <span class="hljs-string">" 创建商品 "</span> + productId + <span class="hljs-string">" 的订单"</span>);
    }
    
    <span class="hljs-comment">/**
     * 异步资源访问
     */</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;Boolean&gt; <span class="hljs-title function_">asyncResourceAccess</span><span class="hljs-params">(String resourceId, <span class="hljs-type">int</span> maxConcurrent, Runnable accessTask)</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-keyword">return</span> controlResourceAccess(resourceId, maxConcurrent, accessTask);
        });
    }
}
</code></pre>
<h3 data-id="heading-14">3. 布隆过滤器 - 高效去重和排查</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.redisson.api.RBloomFilter;
<span class="hljs-keyword">import</span> org.redisson.api.RedissonClient;
<span class="hljs-keyword">import</span> java.util.Collection;

<span class="hljs-comment">/**
 * 布隆过滤器生产级应用场景示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BloomFilterScenario</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RedissonClient redissonClient;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BloomFilterScenario</span><span class="hljs-params">(RedissonClient redissonClient)</span> {
        <span class="hljs-built_in">this</span>.redissonClient = redissonClient;
    }
    
    <span class="hljs-comment">/**
     * 防止缓存穿透的布隆过滤器
     * 
     * <span class="hljs-doctag">@param</span> key 要检查的键
     * <span class="hljs-doctag">@return</span> 如果键可能存在则返回true，如果确定不存在则返回false
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preventCachePenetration</span><span class="hljs-params">(String key)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">filterName</span> <span class="hljs-operator">=</span> <span class="hljs-string">"cache_penetration_filter"</span>;
        RBloomFilter&lt;String&gt; bloomFilter = redissonClient.getBloomFilter(filterName);
        
        <span class="hljs-comment">// 初始化布隆过滤器（预计100万个元素，3%误判率）</span>
        <span class="hljs-keyword">if</span> (!bloomFilter.isExists()) {
            bloomFilter.tryInit(<span class="hljs-number">1000000</span>, <span class="hljs-number">0.03</span>);
            System.out.println(<span class="hljs-string">"缓存穿透防护布隆过滤器已初始化"</span>);
        }
        
        <span class="hljs-comment">// 首先检查布隆过滤器</span>
        <span class="hljs-keyword">if</span> (!bloomFilter.contains(key)) {
            <span class="hljs-comment">// 布隆过滤器确认元素不存在，直接返回，避免查询缓存和数据库</span>
            System.out.println(<span class="hljs-string">"布隆过滤器确认键不存在，跳过缓存和数据库查询: "</span> + key);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        
        System.out.println(<span class="hljs-string">"布隆过滤器认为键可能存在，继续查询缓存/数据库: "</span> + key);
        <span class="hljs-comment">// 继续查询缓存和数据库...</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-comment">/**
     * URL去重场景
     * 
     * <span class="hljs-doctag">@param</span> url 要检查的URL
     * <span class="hljs-doctag">@return</span> 如果URL是新的则返回true，如果是重复的则返回false
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">urlDeduplication</span><span class="hljs-params">(String url)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">filterName</span> <span class="hljs-operator">=</span> <span class="hljs-string">"visited_urls_filter"</span>;
        RBloomFilter&lt;String&gt; bloomFilter = redissonClient.getBloomFilter(filterName);
        
        <span class="hljs-comment">// 初始化布隆过滤器（预计1000万个URL，1%误判率）</span>
        <span class="hljs-keyword">if</span> (!bloomFilter.isExists()) {
            bloomFilter.tryInit(<span class="hljs-number">10000000</span>, <span class="hljs-number">0.01</span>);
            System.out.println(<span class="hljs-string">"URL去重布隆过滤器已初始化"</span>);
        }
        
        <span class="hljs-keyword">if</span> (!bloomFilter.contains(url)) {
            <span class="hljs-comment">// 首次访问，添加到过滤器</span>
            bloomFilter.add(url);
            System.out.println(<span class="hljs-string">"首次访问URL，已添加到布隆过滤器: "</span> + url);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">else</span> {
            System.out.println(<span class="hljs-string">"URL已访问过，跳过处理: "</span> + url);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
    
    <span class="hljs-comment">/**
     * 批量添加元素到布隆过滤器
     * 
     * <span class="hljs-doctag">@param</span> filterName 过滤器名称
     * <span class="hljs-doctag">@param</span> elements 要添加的元素集合
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchAddToBloomFilter</span><span class="hljs-params">(String filterName, Collection&lt;String&gt; elements)</span> {
        RBloomFilter&lt;String&gt; bloomFilter = redissonClient.getBloomFilter(filterName);
        
        <span class="hljs-comment">// 如果过滤器不存在，使用默认参数创建</span>
        <span class="hljs-keyword">if</span> (!bloomFilter.isExists()) {
            <span class="hljs-comment">// 根据元素数量估算参数</span>
            <span class="hljs-type">long</span> <span class="hljs-variable">expectedElements</span> <span class="hljs-operator">=</span> Math.max(elements.size() * <span class="hljs-number">2</span>, <span class="hljs-number">100000L</span>);
            bloomFilter.tryInit(expectedElements, <span class="hljs-number">0.03</span>);
            System.out.println(<span class="hljs-string">"布隆过滤器 "</span> + filterName + <span class="hljs-string">" 已初始化，预期元素数: "</span> + expectedElements);
        }
        
        <span class="hljs-type">int</span> <span class="hljs-variable">addedCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (String element : elements) {
            <span class="hljs-keyword">if</span> (bloomFilter.add(element)) {
                addedCount++;
            }
        }
        
        System.out.println(<span class="hljs-string">"批量添加完成，新增 "</span> + addedCount + <span class="hljs-string">" 个元素到过滤器: "</span> + filterName);
    }
    
    <span class="hljs-comment">/**
     * 用户ID存在性检查
     * 
     * <span class="hljs-doctag">@param</span> userId 用户ID
     * <span class="hljs-doctag">@return</span> 如果用户可能存在则返回true
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkUserExists</span><span class="hljs-params">(String userId)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">filterName</span> <span class="hljs-operator">=</span> <span class="hljs-string">"user_exists_filter"</span>;
        RBloomFilter&lt;String&gt; bloomFilter = redissonClient.getBloomFilter(filterName);
        
        <span class="hljs-comment">// 初始化布隆过滤器（预计1000万个用户，3%误判率）</span>
        <span class="hljs-keyword">if</span> (!bloomFilter.isExists()) {
            bloomFilter.tryInit(<span class="hljs-number">10000000</span>, <span class="hljs-number">0.03</span>);
            System.out.println(<span class="hljs-string">"用户存在性检查布隆过滤器已初始化"</span>);
        }
        
        <span class="hljs-type">boolean</span> <span class="hljs-variable">mightExist</span> <span class="hljs-operator">=</span> bloomFilter.contains(userId);
        System.out.println(<span class="hljs-string">"用户 "</span> + userId + <span class="hljs-string">" 可能存在: "</span> + mightExist);
        <span class="hljs-keyword">return</span> mightExist;
    }
}
</code></pre>
<h3 data-id="heading-15">4. 延迟队列 - 定时任务处理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.redisson.api.RBlockingQueue;
<span class="hljs-keyword">import</span> org.redisson.api.RDelayedQueue;
<span class="hljs-keyword">import</span> org.redisson.api.RedissonClient;
<span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService;
<span class="hljs-keyword">import</span> java.util.concurrent.Executors;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-comment">/**
 * 延迟队列生产级应用场景示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DelayedQueueScenario</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RedissonClient redissonClient;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ExecutorService executorService;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DelayedQueueScenario</span><span class="hljs-params">(RedissonClient redissonClient)</span> {
        <span class="hljs-built_in">this</span>.redissonClient = redissonClient;
        <span class="hljs-built_in">this</span>.executorService = Executors.newFixedThreadPool(<span class="hljs-number">10</span>);
    }
    
    <span class="hljs-comment">/**
     * 订单超时处理场景
     * 
     * <span class="hljs-doctag">@param</span> orderId 订单ID
     * <span class="hljs-doctag">@param</span> timeout 超时时间
     * <span class="hljs-doctag">@param</span> unit 时间单位
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleOrderTimeout</span><span class="hljs-params">(String orderId, <span class="hljs-type">long</span> timeout, TimeUnit unit)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">queueName</span> <span class="hljs-operator">=</span> <span class="hljs-string">"order_timeout_queue"</span>;
        RBlockingQueue&lt;String&gt; queue = redissonClient.getBlockingQueue(queueName);
        RDelayedQueue&lt;String&gt; delayedQueue = redissonClient.getDelayedQueue(queue);
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 订单创建后timeout时间如果仍未支付，则触发超时处理</span>
            delayedQueue.offer(orderId, timeout, unit);
            System.out.println(<span class="hljs-string">"订单 "</span> + orderId + <span class="hljs-string">" 已添加到延迟队列，超时时间: "</span> + timeout + <span class="hljs-string">" "</span> + unit);
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 注意：在实际应用中，延迟队列通常在整个应用程序生命周期内保持</span>
            <span class="hljs-comment">// 这里为了示例简化，但在生产环境中不应立即销毁</span>
        }
    }
    
    <span class="hljs-comment">/**
     * 启动延迟队列消费者线程
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startDelayedQueueConsumer</span><span class="hljs-params">()</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">queueName</span> <span class="hljs-operator">=</span> <span class="hljs-string">"order_timeout_queue"</span>;
        RBlockingQueue&lt;String&gt; queue = redissonClient.getBlockingQueue(queueName);
        RDelayedQueue&lt;String&gt; delayedQueue = redissonClient.getDelayedQueue(queue);
        
        <span class="hljs-comment">// 启动消费者线程</span>
        executorService.submit(() -&gt; {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">while</span> (!Thread.currentThread().isInterrupted()) {
                    <span class="hljs-comment">// 阻塞等待超时订单</span>
                    <span class="hljs-type">String</span> <span class="hljs-variable">timeoutOrderId</span> <span class="hljs-operator">=</span> queue.take();
                    System.out.println(<span class="hljs-string">"订单超时，执行取消操作: "</span> + timeoutOrderId);
                    
                    <span class="hljs-comment">// 在独立线程中处理超时订单，避免阻塞队列消费</span>
                    executorService.submit(() -&gt; {
                        processTimeoutOrder(timeoutOrderId);
                    });
                }
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                Thread.currentThread().interrupt();
                System.out.println(<span class="hljs-string">"延迟队列消费者线程被中断"</span>);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                System.err.println(<span class="hljs-string">"延迟队列消费过程中发生异常: "</span> + e.getMessage());
            }
        });
        
        System.out.println(<span class="hljs-string">"延迟队列消费者已启动"</span>);
    }
    
    <span class="hljs-comment">/**
     * 处理超时订单
     * 
     * <span class="hljs-doctag">@param</span> orderId 超时订单ID
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processTimeoutOrder</span><span class="hljs-params">(String orderId)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 执行取消订单、释放库存等操作</span>
            System.out.println(<span class="hljs-string">"正在处理超时订单: "</span> + orderId);
            
            <span class="hljs-comment">// 模拟业务处理</span>
            cancelOrder(orderId);
            releaseInventory(orderId);
            
            System.out.println(<span class="hljs-string">"超时订单处理完成: "</span> + orderId);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"处理超时订单时发生异常，订单ID: "</span> + orderId + <span class="hljs-string">"，异常: "</span> + e.getMessage());
        }
    }
    
    <span class="hljs-comment">/**
     * 订单支付成功后取消延迟任务
     * 
     * <span class="hljs-doctag">@param</span> orderId 订单ID
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">cancelOrderTimeout</span><span class="hljs-params">(String orderId)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">queueName</span> <span class="hljs-operator">=</span> <span class="hljs-string">"order_timeout_queue"</span>;
        RBlockingQueue&lt;String&gt; queue = redissonClient.getBlockingQueue(queueName);
        RDelayedQueue&lt;String&gt; delayedQueue = redissonClient.getDelayedQueue(queue);
        
        <span class="hljs-comment">// 从延迟队列中移除，避免超时处理</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">removed</span> <span class="hljs-operator">=</span> delayedQueue.remove(orderId);
        <span class="hljs-keyword">if</span> (removed) {
            System.out.println(<span class="hljs-string">"已取消订单超时处理: "</span> + orderId);
        } <span class="hljs-keyword">else</span> {
            System.out.println(<span class="hljs-string">"订单不在延迟队列中，可能已超时处理: "</span> + orderId);
        }
        
        <span class="hljs-keyword">return</span> removed;
    }
    
    <span class="hljs-comment">/**
     * 关闭资源
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shutdown</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (executorService != <span class="hljs-literal">null</span> &amp;&amp; !executorService.isShutdown()) {
            executorService.shutdown();
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">if</span> (!executorService.awaitTermination(<span class="hljs-number">5</span>, TimeUnit.SECONDS)) {
                    executorService.shutdownNow();
                }
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                executorService.shutdownNow();
                Thread.currentThread().interrupt();
            }
        }
    }
    
    <span class="hljs-comment">/**
     * 模拟取消订单
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cancelOrder</span><span class="hljs-params">(String orderId)</span> {
        <span class="hljs-comment">// 实际应用中这里会更新订单状态</span>
        System.out.println(<span class="hljs-string">"订单已取消: "</span> + orderId);
    }
    
    <span class="hljs-comment">/**
     * 模拟释放库存
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">releaseInventory</span><span class="hljs-params">(String orderId)</span> {
        <span class="hljs-comment">// 实际应用中这里会释放占用的库存</span>
        System.out.println(<span class="hljs-string">"已释放订单库存: "</span> + orderId);
    }
}
</code></pre>
<h3 data-id="heading-16">5. 分布式计数器 - 统计和限流</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.redisson.api.RAtomicLong;
<span class="hljs-keyword">import</span> org.redisson.api.RRateLimiter;
<span class="hljs-keyword">import</span> org.redisson.api.RedissonClient;
<span class="hljs-keyword">import</span> org.redisson.api.RateIntervalUnit;
<span class="hljs-keyword">import</span> org.redisson.api.RateType;
<span class="hljs-keyword">import</span> java.util.concurrent.CompletableFuture;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-comment">/**
 * 分布式计数器生产级应用场景示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CounterScenario</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RedissonClient redissonClient;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CounterScenario</span><span class="hljs-params">(RedissonClient redissonClient)</span> {
        <span class="hljs-built_in">this</span>.redissonClient = redissonClient;
    }
    
    <span class="hljs-comment">/**
     * 接口访问限流
     * 
     * <span class="hljs-doctag">@param</span> interfaceName 接口名称
     * <span class="hljs-doctag">@param</span> maxRequests 最大请求数
     * <span class="hljs-doctag">@param</span> timeUnit 时间单位
     * <span class="hljs-doctag">@return</span> 是否允许访问
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">interfaceRateLimiting</span><span class="hljs-params">(String interfaceName, <span class="hljs-type">long</span> maxRequests, TimeUnit timeUnit)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">rateLimiterKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"api_rate_limiter:"</span> + interfaceName;
        <span class="hljs-type">RRateLimiter</span> <span class="hljs-variable">rateLimiter</span> <span class="hljs-operator">=</span> redissonClient.getRateLimiter(rateLimiterKey);
        
        <span class="hljs-comment">// 配置限流器：在指定时间间隔内最多允许maxRequests个请求</span>
        <span class="hljs-keyword">if</span> (!rateLimiter.isExists()) {
            RateIntervalUnit intervalUnit;
            <span class="hljs-type">long</span> <span class="hljs-variable">rateInterval</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
            
            <span class="hljs-keyword">switch</span> (timeUnit) {
                <span class="hljs-keyword">case</span> SECONDS:
                    intervalUnit = RateIntervalUnit.SECONDS;
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> MINUTES:
                    intervalUnit = RateIntervalUnit.MINUTES;
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> HOURS:
                    intervalUnit = RateIntervalUnit.HOURS;
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">default</span>:
                    intervalUnit = RateIntervalUnit.SECONDS;
            }
            
            rateLimiter.trySetRate(RateType.OVERALL, maxRequests, rateInterval, intervalUnit);
            System.out.println(<span class="hljs-string">"接口 "</span> + interfaceName + <span class="hljs-string">" 限流器已设置: "</span> + maxRequests + 
                             <span class="hljs-string">" 次/"</span> + timeUnit);
        }
        
        <span class="hljs-comment">// 尝试获取令牌</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">allowed</span> <span class="hljs-operator">=</span> rateLimiter.tryAcquire();
        <span class="hljs-keyword">if</span> (allowed) {
            System.out.println(<span class="hljs-string">"接口 "</span> + interfaceName + <span class="hljs-string">" 访问被允许"</span>);
        } <span class="hljs-keyword">else</span> {
            System.out.println(<span class="hljs-string">"接口 "</span> + interfaceName + <span class="hljs-string">" 访问被限流"</span>);
        }
        
        <span class="hljs-keyword">return</span> allowed;
    }
    
    <span class="hljs-comment">/**
     * 接口访问统计
     * 
     * <span class="hljs-doctag">@param</span> interfaceName 接口名称
     * <span class="hljs-doctag">@return</span> 当前访问次数
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">countApiAccess</span><span class="hljs-params">(String interfaceName)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">counterKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"api_access_counter:"</span> + interfaceName;
        <span class="hljs-type">RAtomicLong</span> <span class="hljs-variable">counter</span> <span class="hljs-operator">=</span> redissonClient.getAtomicLong(counterKey);
        
        <span class="hljs-comment">// 原子递增计数器</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> counter.incrementAndGet();
        System.out.println(<span class="hljs-string">"接口 "</span> + interfaceName + <span class="hljs-string">" 访问次数: "</span> + count);
        
        <span class="hljs-keyword">return</span> count;
    }
    
    <span class="hljs-comment">/**
     * 分布式ID生成器
     * 
     * <span class="hljs-doctag">@param</span> generatorName 生成器名称
     * <span class="hljs-doctag">@param</span> step 步长
     * <span class="hljs-doctag">@return</span> 下一个ID
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">generateDistributedId</span><span class="hljs-params">(String generatorName, <span class="hljs-type">long</span> step)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">counterKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"distributed_id_generator:"</span> + generatorName;
        <span class="hljs-type">RAtomicLong</span> <span class="hljs-variable">idGenerator</span> <span class="hljs-operator">=</span> redissonClient.getAtomicLong(counterKey);
        
        <span class="hljs-comment">// 原子性地增加step并返回新值</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">nextId</span> <span class="hljs-operator">=</span> idGenerator.addAndGet(step);
        System.out.println(generatorName + <span class="hljs-string">" 生成的下一个ID: "</span> + nextId);
        
        <span class="hljs-keyword">return</span> nextId;
    }
    
    <span class="hljs-comment">/**
     * 简单的分布式ID生成器
     * 
     * <span class="hljs-doctag">@param</span> generatorName 生成器名称
     * <span class="hljs-doctag">@return</span> 下一个ID
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">generateNextId</span><span class="hljs-params">(String generatorName)</span> {
        <span class="hljs-keyword">return</span> generateDistributedId(generatorName, <span class="hljs-number">1</span>);
    }
    
    <span class="hljs-comment">/**
     * 获取计数器当前值
     * 
     * <span class="hljs-doctag">@param</span> counterName 计数器名称
     * <span class="hljs-doctag">@return</span> 当前计数值
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getCurrentCount</span><span class="hljs-params">(String counterName)</span> {
        <span class="hljs-type">RAtomicLong</span> <span class="hljs-variable">counter</span> <span class="hljs-operator">=</span> redissonClient.getAtomicLong(counterName);
        <span class="hljs-keyword">return</span> counter.get();
    }
    
    <span class="hljs-comment">/**
     * 重置计数器
     * 
     * <span class="hljs-doctag">@param</span> counterName 计数器名称
     * <span class="hljs-doctag">@param</span> newValue 新值
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">resetCounter</span><span class="hljs-params">(String counterName, <span class="hljs-type">long</span> newValue)</span> {
        <span class="hljs-type">RAtomicLong</span> <span class="hljs-variable">counter</span> <span class="hljs-operator">=</span> redissonClient.getAtomicLong(counterName);
        counter.set(newValue);
        System.out.println(<span class="hljs-string">"计数器 "</span> + counterName + <span class="hljs-string">" 已重置为: "</span> + newValue);
    }
    
    <span class="hljs-comment">/**
     * 带条件更新的计数器操作
     * 
     * <span class="hljs-doctag">@param</span> counterName 计数器名称
     * <span class="hljs-doctag">@param</span> expectedValue 期望值
     * <span class="hljs-doctag">@param</span> newValue 新值
     * <span class="hljs-doctag">@return</span> 更新是否成功
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">conditionalUpdate</span><span class="hljs-params">(String counterName, <span class="hljs-type">long</span> expectedValue, <span class="hljs-type">long</span> newValue)</span> {
        <span class="hljs-type">RAtomicLong</span> <span class="hljs-variable">counter</span> <span class="hljs-operator">=</span> redissonClient.getAtomicLong(counterName);
        
        <span class="hljs-type">boolean</span> <span class="hljs-variable">updated</span> <span class="hljs-operator">=</span> counter.compareAndSet(expectedValue, newValue);
        <span class="hljs-keyword">if</span> (updated) {
            System.out.println(<span class="hljs-string">"计数器 "</span> + counterName + <span class="hljs-string">" 条件更新成功: "</span> + expectedValue + <span class="hljs-string">" -&gt; "</span> + newValue);
        } <span class="hljs-keyword">else</span> {
            System.out.println(<span class="hljs-string">"计数器 "</span> + counterName + <span class="hljs-string">" 条件更新失败，当前值: "</span> + counter.get());
        }
        
        <span class="hljs-keyword">return</span> updated;
    }
    
    <span class="hljs-comment">/**
     * 异步获取计数器值
     * 
     * <span class="hljs-doctag">@param</span> counterName 计数器名称
     * <span class="hljs-doctag">@return</span> CompletableFuture表示计数值
     */</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;Long&gt; <span class="hljs-title function_">getCounterValueAsync</span><span class="hljs-params">(String counterName)</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-type">RAtomicLong</span> <span class="hljs-variable">counter</span> <span class="hljs-operator">=</span> redissonClient.getAtomicLong(counterName);
            <span class="hljs-keyword">return</span> counter.get();
        });
    }
}
</code></pre>
<h3 data-id="heading-17">6. 分布式集合 - 共享数据存储</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.redisson.api.*;
<span class="hljs-keyword">import</span> org.redisson.api.mapreduce.RCollectionMapReduce;
<span class="hljs-keyword">import</span> java.util.Collection;
<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-comment">/**
 * 分布式集合并发级应用场景示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CollectionsScenario</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RedissonClient redissonClient;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CollectionsScenario</span><span class="hljs-params">(RedissonClient redissonClient)</span> {
        <span class="hljs-built_in">this</span>.redissonClient = redissonClient;
    }
    
    <span class="hljs-comment">/**
     * 分布式缓存Map操作
     * 
     * <span class="hljs-doctag">@param</span> cacheName 缓存名称
     * <span class="hljs-doctag">@param</span> key 键
     * <span class="hljs-doctag">@param</span> value 值
     * <span class="hljs-doctag">@param</span> ttl 缓存过期时间
     * <span class="hljs-doctag">@return</span> 操作结果
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">operateDistributedCache</span><span class="hljs-params">(String cacheName, String key, Object value, <span class="hljs-type">long</span> ttl, TimeUnit timeUnit)</span> {
        <span class="hljs-keyword">try</span> {
            RMap&lt;String, Object&gt; cache = redissonClient.getMap(cacheName);
            
            <span class="hljs-comment">// 设置带过期时间的键值对</span>
            <span class="hljs-type">Object</span> <span class="hljs-variable">oldValue</span> <span class="hljs-operator">=</span> cache.put(key, value, ttl, timeUnit);
            
            System.out.println(<span class="hljs-string">"在缓存 "</span> + cacheName + <span class="hljs-string">" 中设置: "</span> + key + <span class="hljs-string">" = "</span> + value + 
                             <span class="hljs-string">"，过期时间: "</span> + ttl + <span class="hljs-string">" "</span> + timeUnit);
            
            <span class="hljs-keyword">if</span> (oldValue != <span class="hljs-literal">null</span>) {
                System.out.println(<span class="hljs-string">"替换的旧值: "</span> + oldValue);
            }
            
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"操作分布式缓存时发生异常: "</span> + e.getMessage());
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
    
    <span class="hljs-comment">/**
     * 在线用户管理
     * 
     * <span class="hljs-doctag">@param</span> userId 用户ID
     * <span class="hljs-doctag">@return</span> 操作结果
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">manageOnlineUsers</span><span class="hljs-params">(String userId)</span> {
        <span class="hljs-keyword">try</span> {
            RSet&lt;String&gt; onlineUsers = redissonClient.getSet(<span class="hljs-string">"online_users"</span>);
            
            <span class="hljs-comment">// 添加用户到在线用户集合</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">added</span> <span class="hljs-operator">=</span> onlineUsers.add(userId);
            <span class="hljs-keyword">if</span> (added) {
                System.out.println(<span class="hljs-string">"用户 "</span> + userId + <span class="hljs-string">" 已上线"</span>);
            } <span class="hljs-keyword">else</span> {
                System.out.println(<span class="hljs-string">"用户 "</span> + userId + <span class="hljs-string">" 已在线"</span>);
            }
            
            <span class="hljs-comment">// 获取当前在线用户数</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">onlineCount</span> <span class="hljs-operator">=</span> onlineUsers.size();
            System.out.println(<span class="hljs-string">"当前在线用户数: "</span> + onlineCount);
            
            <span class="hljs-keyword">return</span> added;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"管理在线用户时发生异常: "</span> + e.getMessage());
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
    
    <span class="hljs-comment">/**
     * 移除在线用户
     * 
     * <span class="hljs-doctag">@param</span> userId 用户ID
     * <span class="hljs-doctag">@return</span> 是否成功移除
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">removeOnlineUser</span><span class="hljs-params">(String userId)</span> {
        <span class="hljs-keyword">try</span> {
            RSet&lt;String&gt; onlineUsers = redissonClient.getSet(<span class="hljs-string">"online_users"</span>);
            
            <span class="hljs-type">boolean</span> <span class="hljs-variable">removed</span> <span class="hljs-operator">=</span> onlineUsers.remove(userId);
            <span class="hljs-keyword">if</span> (removed) {
                System.out.println(<span class="hljs-string">"用户 "</span> + userId + <span class="hljs-string">" 已下线"</span>);
            } <span class="hljs-keyword">else</span> {
                System.out.println(<span class="hljs-string">"用户 "</span> + userId + <span class="hljs-string">" 不在在线用户列表中"</span>);
            }
            
            <span class="hljs-keyword">return</span> removed;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"移除在线用户时发生异常: "</span> + e.getMessage());
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
    
    <span class="hljs-comment">/**
     * 获取所有在线用户
     * 
     * <span class="hljs-doctag">@return</span> 在线用户列表
     */</span>
    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">getOnlineUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            RSet&lt;String&gt; onlineUsers = redissonClient.getSet(<span class="hljs-string">"online_users"</span>);
            <span class="hljs-keyword">return</span> onlineUsers.readAllSet().stream().toList();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"获取在线用户列表时发生异常: "</span> + e.getMessage());
            <span class="hljs-keyword">return</span> List.of();
        }
    }
    
    <span class="hljs-comment">/**
     * 操作分布式列表
     * 
     * <span class="hljs-doctag">@param</span> listName 列表名称
     * <span class="hljs-doctag">@param</span> elements 要添加的元素
     * <span class="hljs-doctag">@return</span> 操作结果
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">operateDistributedList</span><span class="hljs-params">(String listName, List&lt;String&gt; elements)</span> {
        <span class="hljs-keyword">try</span> {
            RList&lt;String&gt; list = redissonClient.getList(listName);
            
            <span class="hljs-comment">// 批量添加元素</span>
            list.addAll(elements);
            System.out.println(<span class="hljs-string">"向列表 "</span> + listName + <span class="hljs-string">" 添加 "</span> + elements.size() + <span class="hljs-string">" 个元素"</span>);
            
            <span class="hljs-comment">// 获取列表大小</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> list.size();
            System.out.println(<span class="hljs-string">"列表 "</span> + listName + <span class="hljs-string">" 当前大小: "</span> + size);
            
            <span class="hljs-comment">// 获取列表内容（限制数量以避免大量数据传输）</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">maxElementsToShow</span> <span class="hljs-operator">=</span> Math.min(<span class="hljs-number">10</span>, size);
            <span class="hljs-keyword">if</span> (size &gt; <span class="hljs-number">0</span>) {
                java.util.List&lt;String&gt; subList = list.subList(<span class="hljs-number">0</span>, maxElementsToShow);
                System.out.println(<span class="hljs-string">"列表前 "</span> + maxElementsToShow + <span class="hljs-string">" 个元素: "</span> + subList);
                <span class="hljs-keyword">if</span> (size &gt; maxElementsToShow) {
                    System.out.println(<span class="hljs-string">"... 还有 "</span> + (size - maxElementsToShow) + <span class="hljs-string">" 个元素"</span>);
                }
            }
            
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"操作分布式列表时发生异常: "</span> + e.getMessage());
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
    
    <span class="hljs-comment">/**
     * 批量操作Map
     * 
     * <span class="hljs-doctag">@param</span> mapName Map名称
     * <span class="hljs-doctag">@param</span> data 批量数据
     * <span class="hljs-doctag">@return</span> 操作结果
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">batchOperateMap</span><span class="hljs-params">(String mapName, Map&lt;String, Object&gt; data)</span> {
        <span class="hljs-keyword">try</span> {
            RMap&lt;String, Object&gt; map = redissonClient.getMap(mapName);
            
            <span class="hljs-comment">// 批量添加数据</span>
            map.putAll(data);
            System.out.println(<span class="hljs-string">"向Map "</span> + mapName + <span class="hljs-string">" 批量添加 "</span> + data.size() + <span class="hljs-string">" 个键值对"</span>);
            
            <span class="hljs-comment">// 获取Map大小</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> map.size();
            System.out.println(<span class="hljs-string">"Map "</span> + mapName + <span class="hljs-string">" 当前大小: "</span> + size);
            
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"批量操作Map时发生异常: "</span> + e.getMessage());
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
    
    <span class="hljs-comment">/**
     * 获取Map的所有键值对
     * 
     * <span class="hljs-doctag">@param</span> mapName Map名称
     * <span class="hljs-doctag">@return</span> 所有键值对
     */</span>
    <span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">getAllMapEntries</span><span class="hljs-params">(String mapName)</span> {
        <span class="hljs-keyword">try</span> {
            RMap&lt;String, Object&gt; map = redissonClient.getMap(mapName);
            <span class="hljs-keyword">return</span> map.readAllMap();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"获取Map所有键值对时发生异常: "</span> + e.getMessage());
            <span class="hljs-keyword">return</span> Map.of();
        }
    }
    
    <span class="hljs-comment">/**
     * 安全删除Map中的键值对
     * 
     * <span class="hljs-doctag">@param</span> mapName Map名称
     * <span class="hljs-doctag">@param</span> key 要删除的键
     * <span class="hljs-doctag">@return</span> 是否成功删除
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">safeRemoveFromMap</span><span class="hljs-params">(String mapName, String key)</span> {
        <span class="hljs-keyword">try</span> {
            RMap&lt;String, Object&gt; map = redissonClient.getMap(mapName);
            
            <span class="hljs-type">Object</span> <span class="hljs-variable">removedValue</span> <span class="hljs-operator">=</span> map.remove(key);
            <span class="hljs-keyword">if</span> (removedValue != <span class="hljs-literal">null</span>) {
                System.out.println(<span class="hljs-string">"从Map "</span> + mapName + <span class="hljs-string">" 中删除键: "</span> + key + <span class="hljs-string">"，值: "</span> + removedValue);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            } <span class="hljs-keyword">else</span> {
                System.out.println(<span class="hljs-string">"键 "</span> + key + <span class="hljs-string">" 在Map "</span> + mapName + <span class="hljs-string">" 中不存在"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"安全删除Map键值对时发生异常: "</span> + e.getMessage());
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
}
</code></pre>
<h3 data-id="heading-18">7. 发布/订阅 - 实时消息通知</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.redisson.api.RTopic;
<span class="hljs-keyword">import</span> org.redisson.api.RedissonClient;
<span class="hljs-keyword">import</span> org.redisson.api.listener.MessageListener;
<span class="hljs-keyword">import</span> java.util.concurrent.CompletableFuture;
<span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService;
<span class="hljs-keyword">import</span> java.util.concurrent.Executors;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-comment">/**
 * 发布/订阅生产级应用场景示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PubSubScenario</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RedissonClient redissonClient;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ExecutorService executorService;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PubSubScenario</span><span class="hljs-params">(RedissonClient redissonClient)</span> {
        <span class="hljs-built_in">this</span>.redissonClient = redissonClient;
        <span class="hljs-built_in">this</span>.executorService = Executors.newCachedThreadPool();
    }
    
    <span class="hljs-comment">/**
     * 订阅系统通知
     * 
     * <span class="hljs-doctag">@param</span> topicName 主题名称
     * <span class="hljs-doctag">@param</span> notificationHandler 通知处理器
     * <span class="hljs-doctag">@return</span> 监听器ID
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">subscribeSystemNotifications</span><span class="hljs-params">(String topicName, java.util.function.Consumer&lt;String&gt; notificationHandler)</span> {
        <span class="hljs-type">RTopic</span> <span class="hljs-variable">topic</span> <span class="hljs-operator">=</span> redissonClient.getTopic(topicName);
        
        <span class="hljs-comment">// 添加消息监听器</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">listenerId</span> <span class="hljs-operator">=</span> topic.addListener(String.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageListener</span>&lt;String&gt;() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(CharSequence channel, String message)</span> {
                System.out.println(<span class="hljs-string">"收到系统通知 - 频道: "</span> + channel + <span class="hljs-string">"，消息: "</span> + message);
                
                <span class="hljs-comment">// 在独立线程中处理消息，避免阻塞Redisson的消息处理线程</span>
                executorService.submit(() -&gt; {
                    <span class="hljs-keyword">try</span> {
                        notificationHandler.accept(message);
                    } <span class="hljs-keyword">catch</span> (Exception e) {
                        System.err.println(<span class="hljs-string">"处理系统通知时发生异常: "</span> + e.getMessage());
                    }
                });
            }
        });
        
        System.out.println(<span class="hljs-string">"已订阅系统通知主题: "</span> + topicName + <span class="hljs-string">"，监听器ID: "</span> + listenerId);
        <span class="hljs-keyword">return</span> listenerId;
    }
    
    <span class="hljs-comment">/**
     * 发布系统通知
     * 
     * <span class="hljs-doctag">@param</span> topicName 主题名称
     * <span class="hljs-doctag">@param</span> message 通知消息
     * <span class="hljs-doctag">@return</span> 接收者数量
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">publishSystemNotification</span><span class="hljs-params">(String topicName, String message)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">RTopic</span> <span class="hljs-variable">topic</span> <span class="hljs-operator">=</span> redissonClient.getTopic(topicName);
            
            <span class="hljs-comment">// 发布消息</span>
            <span class="hljs-type">long</span> <span class="hljs-variable">receivers</span> <span class="hljs-operator">=</span> topic.publish(message);
            System.out.println(<span class="hljs-string">"系统通知已发布 - 主题: "</span> + topicName + 
                             <span class="hljs-string">"，消息: "</span> + message + 
                             <span class="hljs-string">"，接收者数量: "</span> + receivers);
            
            <span class="hljs-keyword">return</span> receivers;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"发布系统通知时发生异常: "</span> + e.getMessage());
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        }
    }
    
    <span class="hljs-comment">/**
     * 异步发布系统通知
     * 
     * <span class="hljs-doctag">@param</span> topicName 主题名称
     * <span class="hljs-doctag">@param</span> message 通知消息
     * <span class="hljs-doctag">@return</span> CompletableFuture表示发布结果
     */</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;Long&gt; <span class="hljs-title function_">publishSystemNotificationAsync</span><span class="hljs-params">(String topicName, String message)</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-keyword">return</span> publishSystemNotification(topicName, message);
        }, executorService);
    }
    
    <span class="hljs-comment">/**
     * 订单状态变更通知场景
     * 
     * <span class="hljs-doctag">@param</span> orderId 订单ID
     * <span class="hljs-doctag">@param</span> newStatus 新状态
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyOrderStatusChange</span><span class="hljs-params">(String orderId, String newStatus)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">topicName</span> <span class="hljs-operator">=</span> <span class="hljs-string">"order_status_change"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">"订单 %s 状态变更为 %s"</span>, orderId, newStatus);
        
        publishSystemNotification(topicName, message);
    }
    
    <span class="hljs-comment">/**
     * 用户登录通知场景
     * 
     * <span class="hljs-doctag">@param</span> userId 用户ID
     * <span class="hljs-doctag">@param</span> loginTime 登录时间
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyUserLogin</span><span class="hljs-params">(String userId, <span class="hljs-type">long</span> loginTime)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">topicName</span> <span class="hljs-operator">=</span> <span class="hljs-string">"user_login"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">"用户 %s 于 %d 登录"</span>, userId, loginTime);
        
        publishSystemNotification(topicName, message);
    }
    
    <span class="hljs-comment">/**
     * 系统维护通知场景
     * 
     * <span class="hljs-doctag">@param</span> maintenanceTime 维护时间
     * <span class="hljs-doctag">@param</span> duration 维护时长
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifySystemMaintenance</span><span class="hljs-params">(<span class="hljs-type">long</span> maintenanceTime, <span class="hljs-type">long</span> duration)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">topicName</span> <span class="hljs-operator">=</span> <span class="hljs-string">"system_maintenance"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">"系统将于 %d 开始维护，预计持续 %d 秒"</span>, maintenanceTime, duration);
        
        publishSystemNotification(topicName, message);
    }
    
    <span class="hljs-comment">/**
     * 移除消息监听器
     * 
     * <span class="hljs-doctag">@param</span> topicName 主题名称
     * <span class="hljs-doctag">@param</span> listenerId 监听器ID
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeMessageListener</span><span class="hljs-params">(String topicName, <span class="hljs-type">int</span> listenerId)</span> {
        <span class="hljs-type">RTopic</span> <span class="hljs-variable">topic</span> <span class="hljs-operator">=</span> redissonClient.getTopic(topicName);
        topic.removeListener(listenerId);
        System.out.println(<span class="hljs-string">"已移除监听器，ID: "</span> + listenerId + <span class="hljs-string">"，主题: "</span> + topicName);
    }
    
    <span class="hljs-comment">/**
     * 关闭资源
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shutdown</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (executorService != <span class="hljs-literal">null</span> &amp;&amp; !executorService.isShutdown()) {
            executorService.shutdown();
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">if</span> (!executorService.awaitTermination(<span class="hljs-number">5</span>, TimeUnit.SECONDS)) {
                    executorService.shutdownNow();
                }
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                executorService.shutdownNow();
                Thread.currentThread().interrupt();
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-19">底层原理详解</h2>
<h3 data-id="heading-20">1. 分布式锁实现原理 🧩</h3>
<p>Redisson的分布式锁就像一个智能"门卫"，它的实现原理非常巧妙：</p>
<ul>
<li><strong>获取锁</strong>: 使用Redis的<code>SET key value NX EX seconds</code>命令，就像一个"先到先得"的机制，确保只有在key不存在时才设置成功，实现原子性操作</li>
<li><strong>Watchdog机制</strong>: Redisson使用后台定时任务（看门狗），每过锁过期时间的1/3就自动续期，就像给锁装了"永不断电"的电池，防止业务执行时间过长导致锁意外释放</li>
<li><strong>可重入性</strong>: 通过Redis Hash结构记录线程ID和重入次数，让同一个"客人"可以多次进入"房间"</li>
<li><strong>原子性操作</strong>: 使用Lua脚本保证多个Redis命令的原子执行，就像一个"密闭房间"，确保操作的完整性</li>
<li><strong>锁释放</strong>: 只有锁的持有者才能释放锁（通过Lua脚本验证），防止"张冠李戴"</li>
<li><strong>RedLock算法</strong>: 在多Redis节点环境下，需要半数以上节点获取锁才算成功，就像"少数服从多数"的民主机制</li>
</ul>
<h3 data-id="heading-21">2. 信号量实现原理 🚦</h3>
<p>信号量就像一个智能"交通灯"控制器：</p>
<ul>
<li><strong>许可证管理</strong>: 使用Redis的原子操作来管理许可证数量，确保许可证计数的准确性</li>
<li><strong>阻塞获取</strong>: 当许可证不足时，使用Redis的发布/订阅机制实现优雅的阻塞等待，就像"排队等座"一样</li>
<li><strong>释放许可证</strong>: 当许可证被释放时，自动通知等待的线程，实现资源的有效分配</li>
</ul>
<h3 data-id="heading-22">3. 延迟队列实现原理 ⏰</h3>
<p>延迟队列就像一个智能"闹钟"：</p>
<ul>
<li><strong>时间轮算法</strong>: Redisson使用Sorted Set (ZSET) 按时间戳顺序存储延迟元素，就像按照"闹钟时间"排列的闹钟阵列</li>
<li><strong>后台轮询</strong>: 维护一个后台线程不断轮询ZSET，将到期元素转移到底层队列，就像"时间守护者"时刻监测</li>
<li><strong>原子转移</strong>: 使用Lua脚本确保延迟元素到普通队列的转移是原子操作，避免"时间错乱"</li>
</ul>
<h3 data-id="heading-23">4. 布隆过滤器实现原理 🧺</h3>
<p>布隆过滤器就像一个神奇的"筛子"：</p>
<ul>
<li><strong>多Hash函数</strong>: 使用多个Hash函数对元素进行计算，就像用多个"筛孔"定位元素位置</li>
<li><strong>BitSet存储</strong>: 使用Redis的String类型模拟BitSet，每个bit位代表一个可能的元素位置</li>
<li><strong>误判率控制</strong>: 通过调整Hash函数个数和BitSet大小来控制误判率，就像调整"筛子精度"</li>
<li><strong>空间效率</strong>: 相比传统集合，布隆过滤器占用空间极小，但存在少量误判，是"空间换时间"的典型应用</li>
</ul>
<h3 data-id="heading-24">5. 发布/订阅机制 📡</h3>
<p>发布/订阅就像一个高效的"广播站"：</p>
<ul>
<li><strong>Redis PUB/SUB</strong>: 基于Redis的原生发布/订阅功能实现，提供实时消息传递</li>
<li><strong>模式匹配</strong>: 支持使用通配符进行频道模式匹配，让消息传递更灵活</li>
<li><strong>消息可靠性</strong>: 提供同步和异步两种消息处理方式，满足不同场景需求</li>
<li><strong>连接管理</strong>: 自动处理连接断开和重连，确保消息传递的可靠性</li>
</ul>
<h3 data-id="heading-25">6. 序列化与反序列化 📦</h3>
<p>序列化就像数据的"变身术"：</p>
<ul>
<li><strong>默认策略</strong>: 使用Jackson JSON序列化，保证数据的可读性和跨语言兼容性</li>
<li><strong>多种策略</strong>: 支持Kryo、FST、Smile、CBOR等多种序列化方式，满足不同性能需求</li>
<li><strong>性能对比</strong>: Kryo和FST序列化速度快、体积小，但Jackson兼容性更好</li>
<li><strong>自定义序列化</strong>: 可通过配置自定义序列化策略，满足特殊业务需求</li>
</ul>
<h2 data-id="heading-26">性能优化建议 🚀</h2>
<ol>
<li>
<p><strong>合理设置连接池大小</strong> 💧 - 就像给水管设置合适的口径，连接池太小会造成"供水不足"（请求排队），太大则会造成"资源浪费"（连接闲置），需要根据实际业务流量来"精确调节"</p>
</li>
<li>
<p><strong>使用本地缓存减少Redis访问</strong> 🏠 - 就像在家中储备日常用品一样，频繁访问的数据可以放在本地缓存中，减少网络往返的开销，让访问如"近水楼台先得月"</p>
</li>
<li>
<p><strong>批量操作提高效率</strong> 📦 - 就像购物时一次性购买多件商品比多次单独购买更高效一样，批量操作可以显著减少网络通信次数，提升整体性能</p>
</li>
<li>
<p><strong>合理设置锁的超时时间</strong> ⏱️ - 就像停车场的计时收费一样，锁的超时时间设置要恰到好处，太短可能导致业务未完成就被释放，太长则可能造成资源长时间占用</p>
</li>
<li>
<p><strong>选择合适的序列化方式</strong> 📝 - 就像选择不同的信封一样，不同的序列化方式有不同的特点：Jackson兼容性好但体积大，Kryo和FST速度快但适用范围有限，要根据场景选择</p>
</li>
</ol>
<h2 data-id="heading-27">常见问题与最佳实践</h2>
<h3 data-id="heading-28">1. 锁的可重入性</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.redisson.api.RLock;
<span class="hljs-keyword">import</span> org.redisson.api.RedissonClient;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-comment">/**
 * 分布式锁可重入性生产级示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReentrantLockExample</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RedissonClient redissonClient;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ReentrantLockExample</span><span class="hljs-params">(RedissonClient redissonClient)</span> {
        <span class="hljs-built_in">this</span>.redissonClient = redissonClient;
    }
    
    <span class="hljs-comment">/**
     * 演示分布式锁的可重入性
     * 
     * <span class="hljs-doctag">@param</span> lockKey 锁的key
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">demonstrateReentrantLock</span><span class="hljs-params">(String lockKey)</span> {
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(lockKey);
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 第一次获取锁</span>
            lock.lock(<span class="hljs-number">30</span>, TimeUnit.SECONDS);
            System.out.println(<span class="hljs-string">"第一次获取锁成功: "</span> + lockKey);
            
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 同一线程可以多次获取同一把锁（可重入）</span>
                lock.lock(<span class="hljs-number">30</span>, TimeUnit.SECONDS);
                System.out.println(<span class="hljs-string">"第二次获取锁成功（可重入）: "</span> + lockKey);
                
                <span class="hljs-keyword">try</span> {
                    lock.lock(<span class="hljs-number">30</span>, TimeUnit.SECONDS);
                    System.out.println(<span class="hljs-string">"第三次获取锁成功（可重入）: "</span> + lockKey);
                    
                    <span class="hljs-comment">// 执行业务逻辑</span>
                    System.out.println(<span class="hljs-string">"执行业务逻辑..."</span>);
                    
                } <span class="hljs-keyword">finally</span> {
                    <span class="hljs-comment">// 需要对应次数的unlock操作</span>
                    lock.unlock();
                    System.out.println(<span class="hljs-string">"第三次释放锁: "</span> + lockKey + <span class="hljs-string">"，锁仍被持有: "</span> + lock.isLocked());
                }
                
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-comment">// 第二次释放锁</span>
                lock.unlock();
                System.out.println(<span class="hljs-string">"第二次释放锁: "</span> + lockKey + <span class="hljs-string">"，锁仍被持有: "</span> + lock.isLocked());
            }
            
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 最后一次释放锁，真正释放锁</span>
            <span class="hljs-keyword">if</span> (lock.isHeldByCurrentThread()) {
                lock.unlock();
                System.out.println(<span class="hljs-string">"第一次释放锁: "</span> + lockKey + <span class="hljs-string">"，锁已完全释放: "</span> + !lock.isLocked());
            }
        }
    }
    
    <span class="hljs-comment">/**
     * 安全的可重入锁操作
     * 
     * <span class="hljs-doctag">@param</span> lockKey 锁的key
     * <span class="hljs-doctag">@param</span> businessLogic 业务逻辑
     * <span class="hljs-doctag">@return</span> 操作结果
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">safeReentrantOperation</span><span class="hljs-params">(String lockKey, Runnable businessLogic)</span> {
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(lockKey);
        <span class="hljs-type">int</span> <span class="hljs-variable">lockCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// 记录加锁次数</span>
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 获取主锁</span>
            lock.lock(<span class="hljs-number">30</span>, TimeUnit.SECONDS);
            lockCount++;
            
            <span class="hljs-comment">// 在业务逻辑中可能需要再次获取锁</span>
            executeNestedOperation(lock, businessLogic);
            
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"可重入锁操作异常: "</span> + e.getMessage());
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 释放所有层级的锁</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; lockCount; i++) {
                <span class="hljs-keyword">if</span> (lock.isHeldByCurrentThread()) {
                    lock.unlock();
                }
            }
        }
    }
    
    <span class="hljs-comment">/**
     * 嵌套操作，可能需要再次获取锁
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeNestedOperation</span><span class="hljs-params">(RLock lock, Runnable businessLogic)</span> {
        <span class="hljs-comment">// 模拟在业务逻辑中需要再次获取锁的情况</span>
        <span class="hljs-keyword">if</span> (lock.isHeldByCurrentThread()) {
            <span class="hljs-comment">// 同一线程可以再次获取锁</span>
            lock.lock();
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 执行业务逻辑</span>
                businessLogic.run();
            } <span class="hljs-keyword">finally</span> {
                lock.unlock(); <span class="hljs-comment">// 对应的解锁操作</span>
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-29">2. 死锁预防与超时处理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.redisson.api.RLock;
<span class="hljs-keyword">import</span> org.redisson.api.RedissonClient;
<span class="hljs-keyword">import</span> java.util.concurrent.CompletableFuture;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-comment">/**
 * 死锁预防与超时处理生产级示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DeadlockPreventionExample</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RedissonClient redissonClient;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DeadlockPreventionExample</span><span class="hljs-params">(RedissonClient redissonClient)</span> {
        <span class="hljs-built_in">this</span>.redissonClient = redissonClient;
    }
    
    <span class="hljs-comment">/**
     * 使用带超时的锁获取，防止死锁
     * 
     * <span class="hljs-doctag">@param</span> lockKey 锁的key
     * <span class="hljs-doctag">@param</span> businessLogic 业务逻辑
     * <span class="hljs-doctag">@return</span> 操作结果
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preventDeadlockWithTimeout</span><span class="hljs-params">(String lockKey, Runnable businessLogic)</span> {
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(lockKey);
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 使用tryLock设置等待时间和锁持有时间，防止无限等待和死锁</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">acquired</span> <span class="hljs-operator">=</span> lock.tryLock(<span class="hljs-number">10</span>, <span class="hljs-number">30</span>, TimeUnit.SECONDS);
            <span class="hljs-keyword">if</span> (acquired) {
                <span class="hljs-keyword">try</span> {
                    System.out.println(<span class="hljs-string">"获取锁成功: "</span> + lockKey);
                    
                    <span class="hljs-comment">// 执行业务逻辑</span>
                    businessLogic.run();
                    
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                } <span class="hljs-keyword">finally</span> {
                    <span class="hljs-comment">// 确保锁被释放</span>
                    <span class="hljs-keyword">if</span> (lock.isHeldByCurrentThread()) {
                        lock.unlock();
                        System.out.println(<span class="hljs-string">"释放锁: "</span> + lockKey);
                    }
                }
            } <span class="hljs-keyword">else</span> {
                System.out.println(<span class="hljs-string">"获取锁超时: "</span> + lockKey);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
            System.err.println(<span class="hljs-string">"获取锁时被中断: "</span> + e.getMessage());
            
            <span class="hljs-comment">// 恢复中断状态并确保锁被释放</span>
            <span class="hljs-keyword">if</span> (lock != <span class="hljs-literal">null</span> &amp;&amp; lock.isHeldByCurrentThread()) {
                <span class="hljs-keyword">try</span> {
                    lock.unlock();
                } <span class="hljs-keyword">catch</span> (Exception unlockException) {
                    System.err.println(<span class="hljs-string">"释放锁时发生异常: "</span> + unlockException.getMessage());
                }
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"锁操作异常: "</span> + e.getMessage());
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
    
    <span class="hljs-comment">/**
     * 异步锁操作与超时处理
     * 
     * <span class="hljs-doctag">@param</span> lockKey 锁的key
     * <span class="hljs-doctag">@param</span> businessLogic 业务逻辑
     * <span class="hljs-doctag">@param</span> timeoutSeconds 超时时间（秒）
     * <span class="hljs-doctag">@return</span> CompletableFuture表示操作结果
     */</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;Boolean&gt; <span class="hljs-title function_">asyncLockOperation</span><span class="hljs-params">(String lockKey, 
                                                         Runnable businessLogic, 
                                                         <span class="hljs-type">long</span> timeoutSeconds)</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(lockKey);
            
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 使用看门狗机制，自动续期</span>
                lock.lock(timeoutSeconds, TimeUnit.SECONDS);
                
                <span class="hljs-keyword">try</span> {
                    System.out.println(<span class="hljs-string">"异步操作获取锁成功: "</span> + lockKey);
                    businessLogic.run();
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                } <span class="hljs-keyword">finally</span> {
                    <span class="hljs-keyword">if</span> (lock != <span class="hljs-literal">null</span> &amp;&amp; lock.isHeldByCurrentThread()) {
                        lock.unlock();
                        System.out.println(<span class="hljs-string">"异步操作释放锁: "</span> + lockKey);
                    }
                }
            } <span class="hljs-keyword">catch</span> (Exception e) {
                System.err.println(<span class="hljs-string">"异步锁操作异常: "</span> + e.getMessage());
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        });
    }
    
    <span class="hljs-comment">/**
     * 多重锁的安全操作
     * 
     * <span class="hljs-doctag">@param</span> lockKeys 锁的keys
     * <span class="hljs-doctag">@param</span> businessLogic 业务逻辑
     * <span class="hljs-doctag">@return</span> 操作结果
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">multiLockOperation</span><span class="hljs-params">(String[] lockKeys, Runnable businessLogic)</span> {
        <span class="hljs-keyword">if</span> (lockKeys == <span class="hljs-literal">null</span> || lockKeys.length == <span class="hljs-number">0</span>) {
            System.out.println(<span class="hljs-string">"没有提供锁keys"</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        
        java.util.List&lt;RLock&gt; locks = <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.util.ArrayList&lt;&gt;();
        <span class="hljs-keyword">for</span> (String lockKey : lockKeys) {
            locks.add(redissonClient.getLock(lockKey));
        }
        
        <span class="hljs-type">RLock</span> <span class="hljs-variable">multiLock</span> <span class="hljs-operator">=</span> redissonClient.getMultiLock(locks.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RLock</span>[<span class="hljs-number">0</span>]));
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 获取多重锁，设置等待时间和持有时间</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">acquired</span> <span class="hljs-operator">=</span> multiLock.tryLock(<span class="hljs-number">10</span>, <span class="hljs-number">30</span>, TimeUnit.SECONDS);
            <span class="hljs-keyword">if</span> (acquired) {
                <span class="hljs-keyword">try</span> {
                    System.out.println(<span class="hljs-string">"获取多重锁成功: "</span> + String.join(<span class="hljs-string">", "</span>, lockKeys));
                    businessLogic.run();
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                } <span class="hljs-keyword">finally</span> {
                    <span class="hljs-comment">// 释放多重锁</span>
                    <span class="hljs-keyword">if</span> (multiLock.isHeldByCurrentThread()) {
                        multiLock.unlock();
                        System.out.println(<span class="hljs-string">"释放多重锁: "</span> + String.join(<span class="hljs-string">", "</span>, lockKeys));
                    }
                }
            } <span class="hljs-keyword">else</span> {
                System.out.println(<span class="hljs-string">"获取多重锁超时: "</span> + String.join(<span class="hljs-string">", "</span>, lockKeys));
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
            System.err.println(<span class="hljs-string">"获取多重锁时被中断: "</span> + e.getMessage());
            
            <span class="hljs-keyword">if</span> (multiLock != <span class="hljs-literal">null</span> &amp;&amp; multiLock.isHeldByCurrentThread()) {
                <span class="hljs-keyword">try</span> {
                    multiLock.unlock();
                } <span class="hljs-keyword">catch</span> (Exception unlockException) {
                    System.err.println(<span class="hljs-string">"释放多重锁时发生异常: "</span> + unlockException.getMessage());
                }
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"多重锁操作异常: "</span> + e.getMessage());
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
}
</code></pre>
<h3 data-id="heading-30">3. 客户端资源管理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.redisson.Redisson;
<span class="hljs-keyword">import</span> org.redisson.api.RedissonClient;
<span class="hljs-keyword">import</span> org.redisson.config.Config;
<span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService;
<span class="hljs-keyword">import</span> java.util.concurrent.Executors;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-comment">/**
 * Redisson客户端资源管理生产级示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResourceManagerExample</span> {
    
    <span class="hljs-comment">/**
     * 正确的Redisson客户端创建和关闭
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedissonClientManager</span> {
        <span class="hljs-keyword">private</span> RedissonClient redissonClient;
        <span class="hljs-keyword">private</span> ExecutorService executorService;
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initialize</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">Config</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Config</span>();
                config.useSingleServer()
                      .setAddress(<span class="hljs-string">"redis://127.0.0.1:6379"</span>)
                      .setConnectionPoolSize(<span class="hljs-number">100</span>)
                      .setMinimumIdle(<span class="hljs-number">10</span>)
                      .setConnectTimeout(<span class="hljs-number">10000</span>)
                      .setTimeout(<span class="hljs-number">3000</span>);
                
                config.setNettyThreads(<span class="hljs-number">32</span>);
                
                <span class="hljs-comment">// 创建Redisson客户端</span>
                <span class="hljs-built_in">this</span>.redissonClient = Redisson.create(config);
                <span class="hljs-built_in">this</span>.executorService = Executors.newCachedThreadPool();
                
                System.out.println(<span class="hljs-string">"Redisson客户端已初始化"</span>);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                System.err.println(<span class="hljs-string">"初始化Redisson客户端失败: "</span> + e.getMessage());
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Redisson客户端初始化失败"</span>, e);
            }
        }
        
        <span class="hljs-keyword">public</span> RedissonClient <span class="hljs-title function_">getRedissonClient</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">if</span> (redissonClient == <span class="hljs-literal">null</span> || redissonClient.isShutdown()) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"Redisson客户端未初始化或已关闭"</span>);
            }
            <span class="hljs-keyword">return</span> redissonClient;
        }
        
        <span class="hljs-comment">/**
         * 安全关闭Redisson客户端
         */</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shutdown</span><span class="hljs-params">()</span> {
            <span class="hljs-comment">// 首先关闭线程池</span>
            <span class="hljs-keyword">if</span> (executorService != <span class="hljs-literal">null</span> &amp;&amp; !executorService.isShutdown()) {
                executorService.shutdown();
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">if</span> (!executorService.awaitTermination(<span class="hljs-number">5</span>, TimeUnit.SECONDS)) {
                        executorService.shutdownNow();
                        <span class="hljs-keyword">if</span> (!executorService.awaitTermination(<span class="hljs-number">5</span>, TimeUnit.SECONDS)) {
                            System.err.println(<span class="hljs-string">"线程池未能正常关闭"</span>);
                        }
                    }
                } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                    executorService.shutdownNow();
                    Thread.currentThread().interrupt();
                }
            }
            
            <span class="hljs-comment">// 然后关闭Redisson客户端</span>
            <span class="hljs-keyword">if</span> (redissonClient != <span class="hljs-literal">null</span> &amp;&amp; !redissonClient.isShutdown()) {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-comment">// 优雅关闭，等待所有操作完成</span>
                    redissonClient.shutdown(<span class="hljs-number">2</span>, <span class="hljs-number">5</span>, TimeUnit.SECONDS);
                    System.out.println(<span class="hljs-string">"Redisson客户端已关闭"</span>);
                } <span class="hljs-keyword">catch</span> (Exception e) {
                    System.err.println(<span class="hljs-string">"关闭Redisson客户端时发生异常: "</span> + e.getMessage());
                }
            }
        }
    }
    
    <span class="hljs-comment">/**
     * 使用示例
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">RedissonClientManager</span> <span class="hljs-variable">manager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedissonClientManager</span>();
        
        <span class="hljs-keyword">try</span> {
            manager.initialize();
            
            <span class="hljs-comment">// 使用Redisson客户端</span>
            <span class="hljs-type">RedissonClient</span> <span class="hljs-variable">redisson</span> <span class="hljs-operator">=</span> manager.getRedissonClient();
            System.out.println(<span class="hljs-string">"Redisson客户端状态: "</span> + (redisson.isShutdown() ? <span class="hljs-string">"已关闭"</span> : <span class="hljs-string">"运行中"</span>));
            
            <span class="hljs-comment">// 执行业务操作...</span>
            
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 确保在应用结束时关闭客户端</span>
            manager.shutdown();
        }
    }
}
</code></pre>
<p>Redisson就像分布式系统中的"瑞士军刀"，是一个功能强大且易于使用的Redis Java客户端！它特别适合在分布式系统中解决并发控制、数据共享等复杂问题。通过合理使用其提供的各种分布式对象和功能，并遵循生产级最佳实践，就像有了"分布式开发的超级助手"，可以大大简化分布式应用的开发，同时确保系统的稳定性和可靠性。让我们一起用Redisson打造更稳定、更高效的分布式系统吧！ 🎉</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Anaconda]]></title>    <link>https://juejin.cn/post/7588095884070076416</link>    <guid>https://juejin.cn/post/7588095884070076416</guid>    <pubDate>2025-12-27T15:46:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588095884070076416" data-draft-id="7588092534162014208" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Anaconda"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-27T15:46:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="辜月十"/> <meta itemprop="url" content="https://juejin.cn/user/2872336891512350"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Anaconda
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2872336891512350/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    辜月十
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T15:46:59.000Z" title="Sat Dec 27 2025 15:46:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="xcode">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#000}.xml .hljs-meta{color:silver}.hljs-comment,.hljs-quote{color:#007400}.hljs-attribute,.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-tag{color:#aa0d91}.hljs-template-variable,.hljs-variable{color:#3f6e74}.hljs-code,.hljs-meta-string,.hljs-string{color:#c41a16}.hljs-link,.hljs-regexp{color:#0e0eff}.hljs-bullet,.hljs-number,.hljs-symbol,.hljs-title{color:#1c00cf}.hljs-meta,.hljs-section{color:#643820}.hljs-built_in,.hljs-builtin-name,.hljs-class .hljs-title,.hljs-params,.hljs-type{color:#5c2699}.hljs-attr{color:#836c28}.hljs-subst{color:#000}.hljs-formula{background-color:#eee;font-style:italic}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-selector-class,.hljs-selector-id{color:#9b703f}.hljs-doctag,.hljs-strong{font-weight:700}.hljs-emphasis{font-style:italic}</style><h2 data-id="heading-0">📦Anaconda与Conda的核心概念</h2>
<p>Anaconda是一个流行的<code>Python数据科学发行版</code>，它集成了Conda、Python以及超过180个科学计算和数据处理的常用包。它的强大之处在于能够高效地管理包和环境，尤其适合处理复杂的依赖关系。</p>
<p>Conda是其核心组件，它身兼两职：</p>
<ul>
<li><strong>包管理器</strong>：类似于<code>pip</code>，可以安装、更新、卸载Python包，但优势在于能自动处理复杂的依赖关系。</li>
<li><strong>环境管理器</strong>：可以创建相互隔离的虚拟环境，以便不同项目可以使用不同版本的Python和库，彻底避免版本冲突。</li>
</ul>
<blockquote>
<p><strong>重要提示</strong>：使用虚拟环境是<strong>最佳实践</strong>，能为每个项目创建独立、纯净的运行空间，强烈推荐你为每一个新项目都这样做。</p>
</blockquote>
<h2 data-id="heading-1">🌐 Anaconda 更换镜像源</h2>
<p>更换镜像源主要是通过修改 Conda 的配置文件（<code>.condarc</code>）来实现。以下是详细步骤和命令。</p>








































<table><thead><tr><th>任务</th><th>命令 / 操作</th><th>说明与示例</th></tr></thead><tbody><tr><td><strong>查看当前配置</strong></td><td><code>conda config --show channels</code></td><td>查看当前已添加的频道（镜像源）优先级列表，靠前的优先级高。</td></tr><tr><td><strong>添加镜像频道</strong></td><td>添加<strong>清华大学</strong>源： <code>conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main/</code> <code>conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/</code> <code>conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/conda-forge/</code>  <br/>添加<strong>阿里云</strong>源： <code>conda config --add channels https://mirrors.aliyun.com/anaconda/pkgs/main/</code> <code>conda config --add channels https://mirrors.aliyun.com/anaconda/pkgs/free/</code>  <br/>添加<strong>中科大</strong>源（<strong>已停用，仅作参考</strong>）： <code>conda config --add channels https://mirrors.ustc.edu.cn/anaconda/pkgs/main/</code> <code>conda config --add channels https://mirrors.ustc.edu.cn/anaconda/pkgs/free/</code></td><td><strong>命令会按执行顺序叠加</strong>，后添加的源会出现在列表更靠前的位置，拥有更高的优先级。<strong>请勿添加已停用的中科大源。</strong></td></tr><tr><td><strong>设置显示频道URL</strong></td><td><code>conda config --set show_channel_urls yes</code></td><td>执行 <code>conda install</code> 时，会显示包是从哪个镜像频道下载的，便于确认来源。</td></tr><tr><td><strong>移除指定镜像频道</strong></td><td><code>conda config --remove channels &lt;完整的频道URL&gt;</code></td><td>当某个镜像失效时，可将其移除。例如移除一个失效的清华源：<code>conda config --remove channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/</code></td></tr><tr><td><strong>恢复默认源</strong></td><td><code>conda config --remove-key channels</code></td><td><strong>一键移除所有自定义频道</strong>，恢复为 Conda 官方默认源 (<code>defaults</code>)。</td></tr><tr><td><strong>手动编辑配置文件</strong></td><td>配置文件通常位于： <code>D:\Environment\Anaconda/.condarc</code> (Windows) <code>~/.condarc</code> (Mac/Linux)</td><td>直接用文本编辑器打开此文件，按 <strong>YAML格式</strong> 进行更灵活的编辑（例如直接调整源的先后顺序）。</td></tr></tbody></table>
<ol>
<li>
<ul>
<li><code>channels</code> 列表<strong>自上而下优先级递减</strong>。你可以通过调整顺序来优先使用最快的源。编辑 <code>.condarc</code> 文件，将阿里云放在最上面以获得优先使用。
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">channels:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">https://mirrors.aliyun.com/anaconda/pkgs/main/</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">https://mirrors.aliyun.com/anaconda/pkgs/free/</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main/</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">defaults</span>
<span class="hljs-attr">show_channel_urls:</span> <span class="hljs-literal">true</span>
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong>临时使用特定源</strong></p>
<ul>
<li>如果不想修改全局配置，可以在安装命令中临时指定频道。例如，临时从清华的 <code>conda-forge</code> 频道安装某个包：
<pre><code class="hljs language-bash" lang="bash">conda install -c https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/conda-forge &lt;package_name&gt;
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong>测试与清理</strong></p>
<ul>
<li>配置完成后，可以运行 <code>conda clean -i</code> 清除索引缓存，然后尝试安装一个包 <code>conda install numpy</code>来测试新源的下载速度。</li>
</ul>
</li>
</ol>
<h2 data-id="heading-2">🌱命令大全</h2>
<h3 data-id="heading-3">⚙️环境管理与新环境</h3>













































<table><thead><tr><th>任务</th><th>命令</th><th>说明与示例</th></tr></thead><tbody><tr><td><strong>创建环境</strong></td><td><code>conda create --name &lt;环境名&gt; python=&lt;版本号&gt;</code></td><td>创建一个指定Python版本的新环境。例：<code>conda create --name my_project python=3.9</code></td></tr><tr><td><strong>激活环境</strong></td><td><code>conda activate &lt;环境名&gt;</code></td><td>进入某个环境，后续操作均在此环境中进行。Windows的旧版Anaconda可能需要使用 <code>activate &lt;环境名&gt;</code>。</td></tr><tr><td><strong>退出环境</strong></td><td><code>conda deactivate</code></td><td>退出当前环境，回到基础（base）环境。</td></tr><tr><td><strong>列出所有环境</strong></td><td><code>conda env list</code> 或 <code>conda info --envs</code></td><td>查看已创建的所有环境，当前激活的环境前会用星号<code>*</code>标记。</td></tr><tr><td><strong>删除环境</strong></td><td><code>conda remove --name &lt;环境名&gt; --all</code></td><td><strong>谨慎操作</strong>，会删除该环境及其所有包。</td></tr><tr><td><strong>克隆环境</strong></td><td><code>conda create --name &lt;新名&gt; --clone &lt;被克隆名&gt;</code>[]</td><td>复制一个现有环境，用于备份或创建相似环境。</td></tr><tr><td><strong>导出/导入环境</strong></td><td>导出：<code>conda env export &gt; environment.yml</code> 导入：<code>conda env create -f environment.yml</code></td><td>将环境的精确配置导出为YAML文件，便于在其他机器上复现相同环境。</td></tr></tbody></table>
<h3 data-id="heading-4">📦 包管理：安装与维护工具</h3>
<p>在激活的虚拟环境中，你可以使用Conda来管理所有包。</p>








































<table><thead><tr><th>任务</th><th>命令</th><th>说明与示例</th></tr></thead><tbody><tr><td><strong>安装包</strong></td><td><code>conda install &lt;包名&gt;</code></td><td>安装最新版本的包。例：<code>conda install pandas</code>。 可指定版本：<code>conda install numpy=1.19.5</code>。 可从特定频道安装：<code>conda install -c conda-forge scikit-learn</code>。</td></tr><tr><td><strong>列出已安装包</strong></td><td><code>conda list</code></td><td>查看当前环境中所有已安装的包及其版本。</td></tr><tr><td><strong>搜索包</strong></td><td><code>conda search &lt;包名&gt;</code></td><td>在Conda仓库中搜索可用的包。加<code>--info</code>可查看详细版本信息。</td></tr><tr><td><strong>更新包</strong></td><td><code>conda update &lt;包名&gt;</code></td><td>更新指定包。 更新所有包：<code>conda update --all</code>（需谨慎，可能引发依赖问题）。</td></tr><tr><td><strong>卸载包</strong></td><td><code>conda remove &lt;包名&gt;</code></td><td>从当前环境中移除指定包。</td></tr><tr><td><strong>清理缓存</strong></td><td><code>conda clean --all</code></td><td>删除不再使用的包缓存和临时文件，释放磁盘空间。</td></tr></tbody></table>
<h2 data-id="heading-5">🛠️ 配置、检查以及使用技巧</h2>
<h3 data-id="heading-6">基础与配置</h3>
<ul>
<li><strong>检查信息</strong>：使用 <code>conda info</code> 查看Conda的安装路径、环境列表等基础信息。</li>
<li><strong>更新自身</strong>：使用 <code>conda update conda</code> 和 <code>conda update anaconda</code> 来更新Conda工具和整个Anaconda发行版。</li>
<li><strong>配置镜像源</strong>：国内用户可以将默认仓库（channel）替换为国内镜像（如清华源）以显著提升下载速度。不过配置方法可能随时间变化，建议搜索“Anaconda 清华源 最新”获取当前可用的配置指令。</li>
<li><strong>环境版本回滚</strong>：Conda有记录环境变更的功能。使用 <code>conda list --revisions</code> 查看历史版本，使用 <code>conda install --revision &lt;版本号&gt;</code> 可以回滚到某一状态。</li>
</ul>
<h3 data-id="heading-7">整合与工作流建议</h3>
<ul>
<li><strong>与PyCharm等IDE结合</strong>：在PyCharm中，你可以在 <code>File &gt; Settings &gt; Project: &lt;项目名&gt; &gt; Python Interpreter</code> 中添加Anaconda虚拟环境中的Python解释器路径（通常位于 <code>Anaconda安装目录/envs/&lt;环境名&gt;/python.exe</code>），即可在该项目中使用该环境。</li>
<li><strong>Conda与Pip混用</strong>：虽然推荐优先使用 <code>conda install</code>，但如果某个包在Conda仓库中找不到，可以在激活的Conda环境中使用 <code>pip install</code>。通常不会有大问题，但极端情况下可能出现依赖冲突。</li>
<li><strong>项目工作流建议</strong>：
<ol>
<li>启动新项目时，先创建专属虚拟环境。</li>
<li>在环境中安装所有必要的依赖。</li>
<li>项目完成后，使用 <code>conda env export &gt; environment.yml</code> 导出环境配置，并和项目代码一起保存或分享。</li>
<li>对于不需要的环境，及时删除以节省空间。</li>
</ol>
</li>
</ul>
<h2 data-id="heading-8">💎 核心要点总结</h2>
<ul>
<li><strong>隔离是关键</strong>：为每个项目创建独立的虚拟环境，这是使用Anaconda最重要的好习惯。</li>
<li><strong>命令有层次</strong>：先管理好环境（<code>create</code>, <code>activate</code>），再在环境中管理包（<code>install</code>, <code>list</code>）。</li>
<li><strong>利用导出功能</strong>：用 <code>environment.yml</code> 文件记录环境，确保项目可复现。</li>
<li><strong>善用镜像加速</strong>：在国内配置镜像源可以极大提升包下载效率。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[面试官: “ 说一下你对 Cookie 的理解 ? ”]]></title>    <link>https://juejin.cn/post/7588043318359146531</link>    <guid>https://juejin.cn/post/7588043318359146531</guid>    <pubDate>2025-12-27T11:32:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588043318359146531" data-draft-id="7588095884069535744" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="面试官: “ 说一下你对 Cookie 的理解 ? ”"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2025-12-27T11:32:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="千寻girling"/> <meta itemprop="url" content="https://juejin.cn/user/2276467567770442"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            面试官: “ 说一下你对 Cookie 的理解 ? ”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2276467567770442/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    千寻girling
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T11:32:30.000Z" title="Sat Dec 27 2025 11:32:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. <strong>什么是 Cookie</strong></h2>
<p><strong>Cookie</strong>（小甜饼）是 <strong>服务器发送给浏览器并保存在客户端的一小段数据</strong>，用于：</p>
<ul>
<li>记录用户状态（如登录信息、购物车内容）</li>
<li>跟踪用户行为（如浏览历史、广告推送）</li>
<li>存储少量配置信息（如主题偏好、语言设置）</li>
</ul>
<p><strong>特点：</strong></p>
<ul>
<li>大小限制：通常每个 Cookie 最大 4KB</li>
<li>数量限制：每个域名一般最多 50 个 Cookie</li>
<li>自动携带：浏览器在访问同一域名时会自动将 Cookie 附加在请求头中发送给服务器</li>
</ul>
<hr/>
<h2 data-id="heading-1">2. <strong>Cookie 的结构</strong></h2>
<p>一个 Cookie 通常包含以下字段：</p>









































<table><thead><tr><th>字段名</th><th>说明</th></tr></thead><tbody><tr><td><strong>Name</strong></td><td>Cookie 的名称</td></tr><tr><td><strong>Value</strong></td><td>Cookie 的值（通常经过 URL 编码）</td></tr><tr><td><strong>Domain</strong></td><td>可以访问该 Cookie 的域名</td></tr><tr><td><strong>Path</strong></td><td>可以访问该 Cookie 的路径</td></tr><tr><td><strong>Expires / Max-Age</strong></td><td>Cookie 的过期时间（Expires 是具体日期，Max-Age 是秒数）</td></tr><tr><td><strong>HttpOnly</strong></td><td>如果设置，Cookie 不能通过 JavaScript 访问（防止 XSS 攻击）</td></tr><tr><td><strong>Secure</strong></td><td>如果设置，Cookie 只能通过 HTTPS 传输</td></tr><tr><td><strong>SameSite</strong></td><td>控制跨站请求时是否发送 Cookie（防止 CSRF 攻击）</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-2">3. <strong>Cookie 的工作流程</strong></h2>
<ol>
<li>
<p><strong>服务器发送 Cookie</strong> : 当浏览器第一次访问服务器时，服务器在响应头中添加：</p>
<pre><code class="hljs language-ini" lang="ini">Set-Cookie: <span class="hljs-attr">username</span>=Tom<span class="hljs-comment">; Path=/; HttpOnly; Secure</span>
</code></pre>
<p>浏览器收到后会将该 Cookie 保存到本地。</p>
</li>
<li>
<p><strong>浏览器存储 Cookie</strong>: Cookie 会被保存在浏览器的某个文件或内存中，根据 <code>Domain</code> 和 <code>Path</code> 来区分。</p>
</li>
<li>
<p><strong>浏览器发送请求时携带 Cookie</strong> : 之后每次访问同一域名和路径时，浏览器会自动在请求头中添加：</p>
<pre><code class="hljs language-ini" lang="ini">Cookie: <span class="hljs-attr">username</span>=Tom
</code></pre>
<p>服务器通过读取这个 Cookie 来识别用户。</p>
</li>
</ol>
<hr/>
<h2 data-id="heading-3">4. <strong>Cookie 的分类</strong></h2>
<h3 data-id="heading-4">（1）<strong>会话 Cookie（Session Cookie）</strong></h3>
<ul>
<li>没有设置 <code>Expires</code> 或 <code>Max-Age</code></li>
<li>浏览器关闭后自动删除</li>
<li>常用于保存短期会话信息（如登录状态）</li>
</ul>
<h3 data-id="heading-5">（2）<strong>持久 Cookie（Persistent Cookie）</strong></h3>
<ul>
<li>设置了 <code>Expires</code> 或 <code>Max-Age</code></li>
<li>在过期时间前一直有效，即使浏览器关闭</li>
<li>常用于保存长期信息（如记住登录、用户偏好）</li>
</ul>
<hr/>
<h2 data-id="heading-6">5. <strong>Cookie 的优缺点</strong></h2>
<h3 data-id="heading-7">优点</h3>
<ul>
<li><strong>简单易用</strong>：服务器和浏览器都原生支持</li>
<li><strong>自动携带</strong>：无需手动处理</li>
<li><strong>轻量级</strong>：适合存储少量数据</li>
</ul>
<h3 data-id="heading-8">缺点</h3>
<ul>
<li>
<p><strong>容量小</strong>：每个 Cookie 最大 4KB</p>
</li>
<li>
<p><strong>安全性差</strong>：</p>
<ul>
<li>容易被窃取（XSS 攻击）</li>
<li>容易被伪造（CSRF 攻击）</li>
</ul>
</li>
<li>
<p><strong>性能影响</strong>：</p>
<ul>
<li>每次请求都会携带，增加带宽消耗</li>
<li>过多 Cookie 会影响页面加载速度</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-9">6. <strong>Cookie 的安全设置</strong></h2>
<p>为了提高安全性，建议设置以下属性：</p>
<ul>
<li>
<p><strong>HttpOnly</strong>：防止 JavaScript 访问（减少 XSS 风险）</p>
</li>
<li>
<p><strong>Secure</strong>：只在 HTTPS 连接中传输</p>
</li>
<li>
<p><strong>SameSite</strong>：</p>
<ul>
<li><code>Strict</code>：仅在同站请求时发送</li>
<li><code>Lax</code>：允许部分跨站请求（如 GET 表单提交）</li>
</ul>
</li>
<li>
<p><strong>合理的过期时间</strong>：短期 Cookie 减少被盗风险</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-10">7. <strong>示例：使用 Cookie</strong></h2>
<h3 data-id="heading-11">（1）服务器设置 Cookie（Node.js + Express）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();

app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/login'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-comment">// 设置一个会话 Cookie</span>
  res.<span class="hljs-title function_">cookie</span>(<span class="hljs-string">'username'</span>, <span class="hljs-string">'Tom'</span>, {
    <span class="hljs-attr">httpOnly</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">secure</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">'production'</span>,
    <span class="hljs-attr">sameSite</span>: <span class="hljs-string">'Strict'</span>,
    <span class="hljs-attr">maxAge</span>: <span class="hljs-number">3600000</span> <span class="hljs-comment">// 1 小时</span>
  });
  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">'登录成功'</span>);
});

app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/profile'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-comment">// 读取 Cookie</span>
  <span class="hljs-keyword">const</span> username = req.<span class="hljs-property">cookies</span>.<span class="hljs-property">username</span>;
  <span class="hljs-keyword">if</span> (username) {
    res.<span class="hljs-title function_">send</span>(<span class="hljs-string">`欢迎你，<span class="hljs-subst">${username}</span>`</span>);
  } <span class="hljs-keyword">else</span> {
    res.<span class="hljs-title function_">send</span>(<span class="hljs-string">'请先登录'</span>);
  }
});

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>);
</code></pre>
<h3 data-id="heading-12">（2）浏览器查看 Cookie</h3>
<ul>
<li>Chrome：<code>F12</code> → <strong>Application</strong> → <strong>Cookies</strong></li>
<li>Firefox：<code>F12</code> → <strong>Storage</strong> → <strong>Cookies</strong></li>
</ul>
<hr/>
<h2 data-id="heading-13">8. <strong>Cookie 与 Token 的区别</strong></h2>



































<table><thead><tr><th>特性</th><th>Cookie</th><th>Token</th></tr></thead><tbody><tr><td>存储位置</td><td>浏览器</td><td>浏览器（LocalStorage/SessionStorage）或 App</td></tr><tr><td>传输方式</td><td>自动在 HTTP 请求头中发送</td><td>需要手动在请求头中添加（如 <code>Authorization: Bearer &lt;token&gt;</code>）</td></tr><tr><td>容量限制</td><td>每个 Cookie 最大 4KB</td><td>无固定限制（但过大影响性能）</td></tr><tr><td>安全性</td><td>较低（易受 XSS/CSRF 攻击）</td><td>较高（可结合 HttpOnly、Secure、SameSite）</td></tr><tr><td>适用场景</td><td>简单会话管理、短期状态存储</td><td>复杂认证授权、跨域请求、移动应用</td></tr></tbody></table>
<hr/>
<p>✅ <strong>总结</strong>：</p>
<ul>
<li><strong>Cookie</strong> 是服务器保存在浏览器的一小段数据，用于记录状态和跟踪用户</li>
<li>自动携带在请求头中，方便但有容量和安全限制</li>
<li>常用于简单会话管理，现代 Web 开发中更多与 Token 结合使用</li>
<li>安全使用需设置 <code>HttpOnly</code>、<code>Secure</code>、<code>SameSite</code> 等属性</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[nextjs中，关于Layout组件和Page组件的认知]]></title>    <link>https://juejin.cn/post/7588084804093165606</link>    <guid>https://juejin.cn/post/7588084804093165606</guid>    <pubDate>2025-12-27T11:55:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588084804093165606" data-draft-id="7588086766248165427" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="nextjs中，关于Layout组件和Page组件的认知"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2025-12-27T11:55:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RedHeartWWW"/> <meta itemprop="url" content="https://juejin.cn/user/3263006243293768"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            nextjs中，关于Layout组件和Page组件的认知
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3263006243293768/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RedHeartWWW
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T11:55:29.000Z" title="Sat Dec 27 2025 11:55:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、Layout——页面的布局结构</h2>
<p>当用户访问next项目中的一个页面，如果这个页面的路由对应文件夹下面有layout.tsx，那么next就会基于这个文件里面的dom结构，渲染当前页面结构。Layout的通常传参非常简单，因为它负责的仅仅只有<strong>负责当前页面的布局</strong>这一项工作。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// 一般路由文件夹下的layout.tsx只需要渲染children即可</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">LayoutProps</span> {
    <span class="hljs-attr">children</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span> 
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Layout</span>(<span class="hljs-params">{ children }: LayoutProps</span>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"min-h-screen w-full"</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}

</code></pre>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// app顶层文件夹的layout除了children，还需要渲染html和body</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">RootLayout</span>(<span class="hljs-params">{
  children,
}: {
  children: React.ReactNode;
}</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span>
  );
}
</code></pre>
<p>通常当用户访问页面路由，next会先匹配对应文件夹下面的page.tsx，然后再“<strong>自下而上</strong>”寻找Layout.tsx。</p>
<p>例如用户访问/blog这个页面的时候，会先寻找静态路由对应的文件夹blog，匹配到<code>app/blog/page.tsx</code>之后，如果当前文件夹中没有layout，那就逐级往上寻找layout，直到匹配到<code>app/layout.tsx</code>。</p>
<pre><code class="hljs language-plaintext" lang="plaintext">app/
 ├── (marketing)/  --&gt; 带括号，是路由组，继续往下找
 │    └── page.tsx --&gt; 对应路径 "/"
 │
 ├── blog/  --&gt; 对应路径 "/blog"
 │    └── page.tsx --&gt; 找到目标，但是当前文件夹里面没有layout.tsx
 │
 └── Layout.tsx  --&gt; 如果blog上级文件夹中有layout.tsx，那就用这个layout.tsx来渲染blog/page.tsx
</code></pre>
<h2 data-id="heading-1">二、Page——页面的业务内容</h2>
<p>Layout.tsx负责当前页面的结构，通常里面的代码都是没有复杂业务逻辑的静态纯组件，承担业务逻辑的都是Page.tsx。</p>
<p>Page有params和searchParams两个默认参数。<code>params</code>用于获取 <strong>动态路由</strong>（Dynamic Routes）中的参数。例如，如果你的文件路径是 <code>app/blog/[slug]/page.tsx</code>，那么 <code>params</code> 就会包含 <code>slug</code>。
<code>searchParams</code>用于获取 URL 中 <strong>问号后面的查询参数</strong>（Query Parameters）。例如 <code>?query=nextjs&amp;page=1</code>：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">Page</span> = <span class="hljs-keyword">async</span>(<span class="hljs-params">{
    params,
    searchParams
}:{
    params:<span class="hljs-built_in">Promise</span>&lt;{slug:<span class="hljs-built_in">string</span>}&gt;, 
    searchParams:<span class="hljs-built_in">Promise</span>&lt;{[key: <span class="hljs-built_in">string</span>]:<span class="hljs-built_in">string</span> | <span class="hljs-built_in">string</span>[] | <span class="hljs-literal">undefined</span>}&gt;
}</span>) =&gt;{
    <span class="hljs-keyword">const</span> {slug} = <span class="hljs-keyword">await</span> params;
    <span class="hljs-keyword">const</span> urlParams = <span class="hljs-keyword">await</span> searchParams;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(slug, urlParams);
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Nav</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Hello, I'm the blog page<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Page</span>
</code></pre>
<p>当访问<code>/blog/a?query=11111&amp;query=222222&amp;b=5</code>时，console会输出：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05ea5fc9b608487c8f9d8d9c687458fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmVkSGVhcnRXV1c=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767441343&amp;x-signature=5IbaBvIimCN51cIP3rK6TRdi1fs%3D" alt="image.png" loading="lazy"/>
其中<code>['a']</code>是只有访问动态路由才会有输出，如果访问一个静态路由地址，params输出就是undefined，searchParams则会以键值对的形式展示出来</p>
<h2 data-id="heading-2">三、路由组划分多根模板</h2>
<p>nextjs通过<code>(folder)</code>的方式划分路由组，路由组本身并不会被next识别为路由，比如文件结构如果是<code>/app/(marketing)/blog/page.tsx</code>，那么只需要访问<code>/blog</code>就能访问到这个page.tsx。<br/>路由组虽然不会被识别为路由，但由于上面提到的page“<strong>从内而外</strong>”匹配layout渲染的机制，不同的模块都可以有自己的rootlayout：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">app/
 ├── (marketing)/  --&gt; marketing模块对应路由组
 │    └── page.tsx --&gt; 对应路径 "/"
 |    └── layout.tsx --&gt; marketing模块下所有page的根layout 
 |
 ├── (dashboard)/  --&gt; 
 │    └── dashboard/
 │         └── page.tsx --&gt; 对应路径 "/dashboard"
 │         └── layout.tsx --&gt; dashboard模块下所有page的根layout
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[那些让你 debug 到凌晨的陷阱，我帮你踩平了：React Hooks 避坑指南]]></title>    <link>https://juejin.cn/post/7588069469517594665</link>    <guid>https://juejin.cn/post/7588069469517594665</guid>    <pubDate>2025-12-27T12:03:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588069469517594665" data-draft-id="7587062584165384230" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="那些让你 debug 到凌晨的陷阱，我帮你踩平了：React Hooks 避坑指南"/> <meta itemprop="keywords" content="React.js,前端,面试"/> <meta itemprop="datePublished" content="2025-12-27T12:03:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风止何安啊"/> <meta itemprop="url" content="https://juejin.cn/user/2517239724512420"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            那些让你 debug 到凌晨的陷阱，我帮你踩平了：React Hooks 避坑指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2517239724512420/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风止何安啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T12:03:25.000Z" title="Sat Dec 27 2025 12:03:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#444;background-image:linear-gradient(90deg,rgba(59,59,59,.1) 3%,transparent 0),linear-gradient(1turn,rgba(122,120,121,.1) 3%,transparent 0);background-size:30px 30px;background-position:50%;letter-spacing:1px;word-spacing:1px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:34px;margin-bottom:16px;font-weight:700;line-height:1.3;cursor:text;color:#444;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body h1{font-size:41px;margin-bottom:34px;line-height:1.5}.markdown-body h1:before{content:""}.markdown-body h2{font-size:30px;padding-left:.4em;border-left:.4em solid #5e5e5e;border-bottom:1px solid #444}.markdown-body h2:after{content:"🕛";position:absolute;top:0;right:0;transition:all;animation:rotate 10s linear infinite}@keyframes rotate{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}.markdown-body h3{border-left:.4em solid #8d8d8d;font-size:24px;padding-left:.4em}.markdown-body h4{font-size:20px}.markdown-body h5{font-size:16px}.markdown-body h6{font-size:14px}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body table,.markdown-body ul{margin:.8em 0}.markdown-body strong{font-weight:1000;position:relative;color:#444;padding:0 3px}.markdown-body em{font-weight:inherit}.markdown-body a{box-sizing:border-box;color:grey;position:relative}.markdown-body a:before{position:absolute;box-sizing:border-box;content:"Go -&gt;";left:0;width:100%;max-width:0;color:#fff;background-color:hsla(0,0%,50.2%,.8);white-space:nowrap;transition:.2s ease;pointer-events:none;overflow:hidden}.markdown-body a:after{content:"";position:absolute;bottom:0;left:0;width:100%;height:1px;background-color:grey}.markdown-body a:active:before,.markdown-body a:hover:before{max-width:100%;padding-left:8px;border-radius:5px}.markdown-body hr{position:relative;width:100%;height:1px;border:none;margin-top:36px;margin-bottom:36px;background:linear-gradient(90deg,grey,#f1f1f1,#444,#444,#f1f1f1,grey);overflow:visible}.markdown-body ol,.markdown-body ul{padding-left:32px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px;list-style:inherit}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol{counter-reset:my-counter}.markdown-body ol&gt;li{padding-left:6px;list-style:none;counter-increment:my-counter;position:relative}.markdown-body ol&gt;li:before{position:absolute;left:-1.5em;content:counter(my-counter);font-weight:700}.markdown-body ol&gt;li:first-child:before{content:"1️⃣"}.markdown-body ol&gt;li:nth-child(2):before{content:"2️⃣"}.markdown-body ol&gt;li:nth-child(3):before{content:"3️⃣"}.markdown-body ol&gt;li:nth-child(4):before{content:"4️⃣"}.markdown-body ol&gt;li:nth-child(5):before{content:"5️⃣"}.markdown-body ol&gt;li:nth-child(6):before{content:"6️⃣"}.markdown-body ol&gt;li:nth-child(7):before{content:"7️⃣"}.markdown-body ol&gt;li:nth-child(8):before{content:"8️⃣"}.markdown-body ol&gt;li:nth-child(9):before{content:"9️⃣"}.markdown-body ol&gt;li:nth-child(10):before{content:"🔟"}.markdown-body ul&gt;li{list-style:none;position:relative}.markdown-body ul&gt;li:before{z-index:10;position:absolute;left:-1.57em;content:"🔹";margin-right:12px}.markdown-body ul&gt;li input{margin-left:8px!important}.markdown-body blockquote{position:relative;background-color:#d3d3d3;padding:5px 10px;border-left:.2em solid #000;border-radius:3px;transition:all .8s ease}.markdown-body blockquote:hover{opacity:.7}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(69,69,77,.8);color:#fff;font-size:.87em;padding:.07em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:7px;overflow:hidden}.markdown-body pre:before{z-index:10;position:absolute;top:14px;left:14px;width:12px;height:12px;border-radius:50%;background:#fc625d;-webkit-box-shadow:20px 0 #fdbc40,40px 0 #35cd4b;box-shadow:20px 0 #fdbc40,40px 0 #35cd4b;content:" "}.markdown-body pre:after{z-index:9;content:"";position:absolute;width:100%;height:40px;top:0;background-color:#1a1a1a}.markdown-body pre&gt;code{display:block;font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#171717;color:#bababa;font-size:14px;padding:40px 20px 20px}.markdown-body del{color:grey}.markdown-body table{margin-bottom:1.25rem;border-collapse:collapse}.markdown-body table td,.markdown-body table th{margin:0;padding:8px;line-height:20px;vertical-align:middle;border:1px solid #ddd}.markdown-body table thead,.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table thead th,.markdown-body table tr:nth-child(2n) th{font-weight:700;vertical-align:middle;color:#444}.markdown-body table tbody tr td{font-weight:400;color:#444}.markdown-body table tbody tr:hover{background-color:#d3d3d3}.markdown-body table tbody tr:hover td{color:#fff}.markdown-body img{max-width:100%;margin:0 12px}@media (max-width:720px){.markdown-body h1{font-size:32.8px}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:19.2px}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:12.8px}}</style><style data-highlight="" data-highlight-key="hybrid">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1d1f21}.hljs::selection,.hljs span::selection{background:#373b41}.hljs::-moz-selection,.hljs span::-moz-selection{background:#373b41}.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#c5c8c6}.hljs-name,.hljs-title{color:#f0c674}.hljs-comment,.hljs-meta,.hljs-meta .hljs-keyword{color:#707880}.hljs-deletion,.hljs-link,.hljs-literal,.hljs-number,.hljs-symbol{color:#c66}.hljs-addition,.hljs-doctag,.hljs-regexp,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string{color:#b5bd68}.hljs-attribute,.hljs-code,.hljs-selector-id{color:#b294bb}.hljs-bullet,.hljs-keyword,.hljs-selector-tag,.hljs-tag{color:#81a2be}.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-variable{color:#8abeb7}.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-selector-class,.hljs-type{color:#de935f}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在 <strong>React 函数组件</strong>的世界里，<code>Hooks</code> 无疑是 <strong>“效率神器”</strong>—— 它用极简的 API 封装了状态管理与生命周期逻辑，让我们告别了类组件的繁琐。但就像童话里藏在糖果屋后的陷阱，这些看似友好的 API 背后，藏着不少因 <strong>“闭包特性”“依赖逻辑”“异步处理”</strong> 引发的<strong>坑</strong>。很多开发者刚上手时，总在 “写得通” 和 “写得对” 之间反复踩坑，<code>debug</code> 到怀疑人生。</p>
<p>我在刚入手时踩了不少 <strong>“坑”</strong>，所以我将用我的亲身经历帮你们填平。本文先快速梳理 <code>Hooks</code> 核心基础，再聚焦那些最容易中招的 “陷阱”，用代码案例拆解坑因、给出避坑方案，帮你避开 Hooks 路上的 <strong>“连环雷”</strong>!</p>
<h3 data-id="heading-1">一、先搭个 Hooks 小舞台</h3>
<p><code>React Hooks</code> 就像给函数组件开了挂 —— 不用写类就能拥有状态和生命周期，先来快速回顾下 <strong>“基础三件套”</strong>：</p>
<h4 data-id="heading-2">1. useState:状态管理的 “入门钥匙”</h4>
<p>它能接收<strong>值</strong>或<strong>同步函数</strong>（注意：异步代码会翻车！），返回 “状态 + 修改状态的方法”。修改状态时，<code>setXxx</code> 既可以直接传值，也能传一个 “接收旧状态、返回新状态” 的函数（这个细节是避坑关键！）。</p>
<p>比如<code>State.jsx</code>里的例子：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getDate</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-title function_">resolve</span>(<span class="hljs-number">100</span>) }, <span class="hljs-number">1000</span>)
    })
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">State</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// ❌ 错误示范：useState不支持异步函数</span>
    <span class="hljs-comment">// const [num, setNum] = useState(async () =&gt; {</span>
    <span class="hljs-comment">//   const res = await getDate();</span>
    <span class="hljs-comment">//   return res;</span>
    <span class="hljs-comment">// });</span>

    <span class="hljs-comment">// ✅ 正确：同步函数初始化状态</span>
    <span class="hljs-keyword">const</span> [num, setNum] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    });

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// ✅ 用函数形式获取“修改前的旧状态”</span>
        <span class="hljs-title function_">setNum</span>(<span class="hljs-function">(<span class="hljs-params">prev</span>) =&gt;</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(prev); <span class="hljs-comment">// 点击时打印当前num（修改前）</span>
            <span class="hljs-keyword">return</span> prev + <span class="hljs-number">1</span>;
        })
    }
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{add}</span>&gt;</span>{num}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<h4 data-id="heading-3">2. useEffect：生命周期的 “伪装者”</h4>
<p>它像个 “多面手”，能模拟组件的 “挂载、更新、卸载”，但用法不对就会踩坑：</p>
<ul>
<li><code>useEffect(() =&gt; {})</code>：组件<strong>初次加载 + 每次重渲染</strong>都触发</li>
<li><code>useEffect(() =&gt; {}, [])</code>：只在<strong>初次加载</strong>时触发</li>
<li><code>useEffect(() =&gt; {}, [x])</code>：初次加载 + <code>x</code> 变化时触发</li>
<li>返回的函数：组件<strong>卸载前</strong>执行（用来做清理，比如清定时器）</li>
</ul>
<p>看<code>Effect.jsx</code>里的定时器例子：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getData</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-title function_">resolve</span>(<span class="hljs-number">100</span>) }, <span class="hljs-number">1000</span>)
    })
    <span class="hljs-keyword">return</span> data;
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Effect</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> [num, setNum] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>; });
    <span class="hljs-keyword">const</span> [age, setAge] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">18</span>);

    <span class="hljs-comment">// 🌰 依赖项的坑（后面细说）</span>
    <span class="hljs-comment">// useEffect(() =&gt; {</span>
    <span class="hljs-comment">//   getData().then((data) =&gt; {</span>
    <span class="hljs-comment">//     console.log(data);</span>
    <span class="hljs-comment">//     setNum(data);</span>
    <span class="hljs-comment">//   })</span>
    <span class="hljs-comment">// }, [age]) // 依赖age，但实际修改的是num…</span>

    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 启动定时器</span>
        <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-comment">// setNum(num + 1); // ❌ 这里有坑！后面讲</span>
        }, <span class="hljs-number">1000</span>)
        <span class="hljs-comment">// 组件卸载前清理定时器（避免内存泄漏）</span>
        <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-built_in">clearInterval</span>(timer);
        }
    })

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params"/>) {
        <span class="hljs-title function_">setNum</span>(<span class="hljs-function">(<span class="hljs-params">prev</span>) =&gt;</span> {
            <span class="hljs-keyword">return</span> prev + <span class="hljs-number">1</span>;
        })
    }
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{add}</span>&gt;</span>{num}---{age}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<h4 data-id="heading-4">3. useReducer：复杂状态的 “调度员”</h4>
<p>当状态逻辑比较复杂时，<code>useReducer</code>比<code>useState</code>更清晰 —— 它把 “状态修改逻辑” 抽成<code>reducer</code>函数，通过<code>dispatch</code>触发：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useReducer } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>
<span class="hljs-comment">// 状态修改的“规则函数”</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">reducer</span>(<span class="hljs-params">state, action</span>) {
    <span class="hljs-keyword">switch</span>(action.<span class="hljs-property">type</span>) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">'add'</span>:
            <span class="hljs-keyword">return</span> state + action.<span class="hljs-property">num</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'minus'</span>:
            <span class="hljs-keyword">return</span> state - action.<span class="hljs-property">num</span>;
        <span class="hljs-attr">default</span>:
            <span class="hljs-keyword">return</span> state;
    }
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Trap</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 初始化状态为0，dispatch用来触发reducer</span>
    <span class="hljs-keyword">const</span> [count, dispatch] = <span class="hljs-title function_">useReducer</span>(reducer, <span class="hljs-number">0</span>);
    
    <span class="hljs-comment">// 触发“add”操作，传参num=1</span>
    <span class="hljs-title function_">dispatch</span>({<span class="hljs-attr">type</span>: <span class="hljs-string">'add'</span>, <span class="hljs-attr">num</span>: <span class="hljs-number">1</span>});
    
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{count}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p>以上我们就大致回顾了<code>hooks</code>的一些基础知识，如果想看更具体的请看我的文章：</p>
<blockquote>
<p><a href="https://juejin.cn/post/7584370833703911439" target="_blank" title="https://juejin.cn/post/7584370833703911439">一场组件的进化脱口秀——React从 “类” 到 “hooks” 的 “改头换面”</a></p>
</blockquote>
<h3 data-id="heading-5">二、重点来了：Hooks 的 “陷阱”</h3>
<p>前面都是铺垫，<strong>这些看似简单的 Hooks，藏着能让你 debug 到天亮的坑</strong>—— 接下来逐个拆解：</p>
<h4 data-id="heading-6">陷阱 1： useState 的 “异步更新”+“闭包陷阱”</h4>
<p>看<code>Effect.jsx</code>里的定时器：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">setNum</span>(num + <span class="hljs-number">1</span>); <span class="hljs-comment">// ❌ 这里有问题！</span>
    }, <span class="hljs-number">1000</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(timer);
})
</code></pre>
<p><strong>坑在哪？</strong></p>
<p><code>useEffect</code>默认没有依赖项，会在组件每次重渲染时重新执行 —— 但定时器里的<code>num</code>是 “闭包捕获的旧值”，导致<code>num + 1</code>永远只在初始值<code>1</code>的基础上加，页面不会更新。</p>
<p><strong>怎么填坑？</strong></p>
<p>用<code>setNum</code>的 “函数形式”，它能拿到最新的旧状态：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-title function_">setNum</span>(<span class="hljs-function">(<span class="hljs-params">prev</span>) =&gt;</span> prev + <span class="hljs-number">1</span>); <span class="hljs-comment">// ✅ 不管闭包，直接拿最新prev</span>
</code></pre>
<h4 data-id="heading-7">陷阱 2：useEffect 的 “依赖项迷路”</h4>
<p>再看<code>Effect.jsx</code>里被注释的代码：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">getData</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
        <span class="hljs-title function_">setNum</span>(data); <span class="hljs-comment">// 修改num</span>
    })
}, [age]) <span class="hljs-comment">// ❌ 依赖项写了age，但实际没用到age</span>
</code></pre>
<p><strong>坑在哪？</strong></p>
<p><code>useEffect</code>的依赖项数组必须包含 “回调里用到的所有外部变量”—— 这里回调里没用到<code>age</code>，却把<code>age</code>当依赖，会导致<code>age</code>变化时重复请求；反过来，如果用到了某个变量却没写进依赖，就会拿到旧值 <strong>（闭包陷阱）</strong>。</p>
<p><strong>怎么填坑？</strong></p>
<p>依赖项要 <strong>“诚实”</strong>：用到啥就写啥，没用到就别写。比如上面的代码，要么把<code>age</code>从依赖里删掉，要么在回调里真正用到<code>age</code>。</p>
<h4 data-id="heading-8">陷阱 3：useReducer 的 “dispatch 不是万能药”</h4>
<p>看<code>Trap.jsx</code>里的定时器注释：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// console.log(count); // ❌ 永远打印初始值0</span>
        <span class="hljs-comment">// setCount(count + 1); // 同样的闭包坑</span>
        <span class="hljs-comment">// setCount((prev) =&gt; prev + 1) // ✅ 用函数形式才对</span>
    }, <span class="hljs-number">1000</span>)
}, [])
</code></pre>
<p><strong>坑在哪？</strong></p>
<p>哪怕用了<code>useReducer</code>，如果在<code>useEffect</code>（依赖为空）里用<code>count</code>，还是会因为闭包捕获旧值，导致拿到的<code>count</code>永远是初始值。</p>
<p><strong>怎么填坑？</strong></p>
<p>和<code>useState</code>一样，修改状态时用 “函数形式”；或者把<code>count</code>加入<code>useEffect</code>的依赖项（但要注意重复触发的问题）。</p>
<h4 data-id="heading-9">陷阱 4：useState 的 “异步初始化”</h4>
<p>看<code>State.jsx</code>里的注释：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// ❌ useState不支持异步函数初始化</span>
<span class="hljs-comment">// const [num, setNum] = useState(async () =&gt; {</span>
<span class="hljs-comment">//     const res = await getDate();</span>
<span class="hljs-comment">//     return res;</span>
<span class="hljs-comment">// });</span>
</code></pre>
<p><strong>坑在哪？</strong></p>
<p><code>useState</code>的初始化函数必须是同步的 —— 异步代码会直接返回一个<code>Promise</code>，而不是你想要的结果。</p>
<p><strong>怎么填坑？</strong></p>
<p>把异步初始化逻辑放到<code>useEffect</code>里：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> [num, setNum] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">getDate</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-title function_">setNum</span>(res));
}, [])
</code></pre>
<h3 data-id="heading-10">三、避坑总结： Hooks 的 “生存法则”</h3>
<ol>
<li><strong>useState 修改状态，优先用函数形式</strong>：<code>setXxx(prev =&gt; prev + 1)</code>，避免闭包旧值。</li>
<li><strong>useEffect 依赖项要 “完整且诚实”</strong> ：回调里用到的变量，必须写进依赖数组；没用到的，别瞎写。</li>
<li><strong>异步逻辑别往 useState 初始化里塞</strong>：交给<code>useEffect</code>（依赖为空）来做。</li>
<li><strong>定时器 / 订阅要记得清理</strong>：在<code>useEffect</code>的返回函数里做卸载前的清理（比如清定时器）。</li>
</ol>
<h2 data-id="heading-11">结语</h2>
<p><code>Hooks</code> 的陷阱，本质上大多是对 <strong>“闭包” “React 渲染机制” 和 “Hooks 设计规则”</strong> 理解不透彻的结果。<strong>没有绝对 “万能” 的 API，只有 “用对场景” 的用法</strong> —— 比如 useState 的函数式更新、useEffect 的依赖项规范，这些看似细节的点，恰恰是避开陷阱的关键。希望本文的案例能帮你跳出 “踩坑 - debug - 再踩坑” 的循环，在使用 Hooks 时更从容、更精准。</p>
<p>记住:</p>
<blockquote>
<p>好的代码<strong>不是 “写出来的”，而是 “避坑避出来的”</strong>，多理解底层逻辑，少依赖 “经验主义”，才能真正掌握 <code>Hooks</code> 的精髓</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于 Microsoft Graph API 与 React Email 构建现代化邮件发送系统]]></title>    <link>https://juejin.cn/post/7588300640598638598</link>    <guid>https://juejin.cn/post/7588300640598638598</guid>    <pubDate>2025-12-27T12:43:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588300640598638598" data-draft-id="7588152122186481718" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于 Microsoft Graph API 与 React Email 构建现代化邮件发送系统"/> <meta itemprop="keywords" content="前端,React.js,Microsoft"/> <meta itemprop="datePublished" content="2025-12-27T12:43:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大明二代"/> <meta itemprop="url" content="https://juejin.cn/user/2349018966401277"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于 Microsoft Graph API 与 React Email 构建现代化邮件发送系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2349018966401277/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大明二代
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T12:43:34.000Z" title="Sat Dec 27 2025 12:43:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>在传统的 Node.js 服务端开发中，使用 Nodemailer 配合 SMTP 协议是发送邮件的标准做法。然而，随着安全标准的提升，微软已宣布将在 2026 年彻底停止 Outlook/Microsoft 365 对 SMTP 基础身份验证（Basic Auth）的支持。</p>
<p>为了应对这一变化，我们需要转向 Microsoft Graph API。同时，为了解决邮件模板开发中样式难以调试、兼容性差的痛点，我们可以引入 React Email。本文将介绍如何结合这两者，构建一套符合 Shadcn UI 审美风格且具备高度可靠性的邮件发送系统。</p>
<hr/>
<h2 data-id="heading-1">技术栈</h2>
<ul>
<li><strong>React Email</strong>: 使用 React 组件编写邮件模板，支持 Tailwind CSS。</li>
<li><strong>Nodemailer</strong>: 成熟的 Node.js 邮件发送库。</li>
<li><strong>Microsoft Graph API</strong>: 微软提供的现代化 API 接口，用于替代传统 SMTP。</li>
<li><strong>MSAL Node</strong>: 微软官方提供的身份验证库。</li>
</ul>
<hr/>
<h3 data-id="heading-2">1. 架构设计</h3>
<p>系统分为三层：模板层、逻辑层和传输层。</p>
<ul>
<li><strong>模板层</strong>：利用 React Email 定义 UI，确保样式在各邮件客户端（如 Gmail、Outlook、iOS Mail）中表现一致。</li>
<li><strong>传输层</strong>：通过自定义 Nodemailer 的 <code>Transport</code> 接口，将底层的邮件发送请求导向 Microsoft Graph API。</li>
<li><strong>认证层</strong>：使用 Azure 应用注册（App Registration）获取 OAuth2 令牌。</li>
</ul>
<hr/>
<h3 data-id="heading-3">2. 实现 Microsoft Graph 传输器</h3>
<p>我们需要实现一个自定义的 <code>AzureTransport</code> 类。它的核心逻辑是：在发送邮件前检查令牌是否过期，若过期则通过客户端凭据流（Client Credentials Flow）获取新令牌，随后调用 Graph API 的 <code>/sendMail</code> 接口。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> msal <span class="hljs-keyword">from</span> <span class="hljs-string">'@azure/msal-node'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">SentMessageInfo</span>, <span class="hljs-title class_">Transport</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'nodemailer'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">MailMessage</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'nodemailer/lib/mailer/mail-message'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AzureTransport</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Transport</span>&lt;<span class="hljs-title class_">SentMessageInfo</span>&gt; {
  name = <span class="hljs-string">'Azure'</span>;
  version = <span class="hljs-string">'0.1'</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">msalClient</span>: msal.<span class="hljs-property">ConfidentialClientApplication</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">tokenInfo</span>: msal.<span class="hljs-property">AuthenticationResult</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> config: <span class="hljs-built_in">any</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">msalClient</span> = <span class="hljs-keyword">new</span> msal.<span class="hljs-title class_">ConfidentialClientApplication</span>({
      <span class="hljs-attr">auth</span>: {
        <span class="hljs-attr">clientId</span>: config.<span class="hljs-property">clientId</span>,
        <span class="hljs-attr">clientSecret</span>: config.<span class="hljs-property">clientSecret</span>,
        <span class="hljs-attr">authority</span>: <span class="hljs-string">`https://login.microsoftonline.com/<span class="hljs-subst">${config.tenantId}</span>`</span>
      }
    });
  }

  <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">getAccessToken</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">tokenInfo</span> || (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tokenInfo</span>.<span class="hljs-property">expiresOn</span> &amp;&amp; <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">tokenInfo</span>.<span class="hljs-property">expiresOn</span>.<span class="hljs-title function_">getTime</span>())) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">tokenInfo</span> = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">msalClient</span>.<span class="hljs-title function_">acquireTokenByClientCredential</span>({
        <span class="hljs-attr">scopes</span>: [<span class="hljs-string">'https://graph.microsoft.com/.default'</span>]
      });
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">tokenInfo</span>!.<span class="hljs-property">accessToken</span>;
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">send</span>(<span class="hljs-params">mail: MailMessage, callback: <span class="hljs-built_in">any</span></span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> { subject, <span class="hljs-keyword">from</span>, to, html, text } = mail.<span class="hljs-property">data</span>;
      <span class="hljs-keyword">const</span> accessToken = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getAccessToken</span>();

      <span class="hljs-keyword">const</span> mailMessage = {
        <span class="hljs-attr">message</span>: {
          subject,
          <span class="hljs-attr">body</span>: { <span class="hljs-attr">content</span>: html || text, <span class="hljs-attr">contentType</span>: html ? <span class="hljs-string">'HTML'</span> : <span class="hljs-string">'Text'</span> },
          <span class="hljs-attr">toRecipients</span>: (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(to) ? to : [to]).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">addr: <span class="hljs-built_in">any</span></span>) =&gt;</span> ({
            <span class="hljs-attr">emailAddress</span>: { <span class="hljs-attr">address</span>: <span class="hljs-keyword">typeof</span> addr === <span class="hljs-string">'string'</span> ? addr : addr.<span class="hljs-property">address</span> }
          })),
        }
      };

      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`https://graph.microsoft.com/v1.0/users/<span class="hljs-subst">${<span class="hljs-keyword">from</span>}</span>/sendMail`</span>, {
        <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
        <span class="hljs-attr">headers</span>: { <span class="hljs-title class_">Authorization</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${accessToken}</span>`</span>, <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span> },
        <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(mailMessage)
      });

      <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-keyword">await</span> response.<span class="hljs-title function_">text</span>());
      <span class="hljs-title function_">callback</span>(<span class="hljs-literal">null</span>, { <span class="hljs-attr">messageId</span>: response.<span class="hljs-property">headers</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'request-id'</span>) });
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-title function_">callback</span>(error, <span class="hljs-literal">null</span>);
    }
  }
}

</code></pre>
<hr/>
<h4 data-id="heading-4">3. 使用 React Email 编写 Shadcn 风格模板</h4>
<p>Shadcn UI 的核心在于简洁的 Zinc 色调和良好的间距。以下是为用户确认设计的通用模板：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Body</span>, <span class="hljs-title class_">Container</span>, <span class="hljs-title class_">Head</span>, <span class="hljs-title class_">Heading</span>, <span class="hljs-title class_">Html</span>, <span class="hljs-title class_">Preview</span>, <span class="hljs-title class_">Text</span>, <span class="hljs-title class_">Tailwind</span>, <span class="hljs-title class_">Button</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@react-email/components"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">RequestReceivedEmail</span> = (<span class="hljs-params"/>) =&gt; (
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Html</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Head</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Preview</span>&gt;</span>Confirmation of your request<span class="hljs-tag">&lt;/<span class="hljs-name">Preview</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Tailwind</span> <span class="hljs-attr">config</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">theme:</span> { <span class="hljs-attr">extend:</span> { <span class="hljs-attr">colors:</span> { <span class="hljs-attr">brand:</span> "#<span class="hljs-attr">09090b</span>" } } } }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Body</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"bg-white font-sans text-zinc-950"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Container</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"border border-zinc-200 rounded-lg my-10 mx-auto p-8 max-w-[465px]"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Heading</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-2xl font-semibold tracking-tight"</span>&gt;</span>Request Received<span class="hljs-tag">&lt;/<span class="hljs-name">Heading</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-sm leading-6 text-zinc-600 mt-4"</span>&gt;</span>
            We have successfully received your information. Our team will review the details and respond accordingly.
          <span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"bg-zinc-950 rounded-md text-white text-sm font-medium px-6 py-3 mt-4 no-underline inline-block"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://app.aands.ai"</span>&gt;</span>
            Access Portal
          <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Container</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Body</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Tailwind</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">Html</span>&gt;</span></span>
);

</code></pre>
<hr/>
<h3 data-id="heading-5">4. 业务逻辑整合</h3>
<p>最后，我们将上述模块整合到一个服务函数中。该函数会同时向用户发送回执，并向运营团队发送内部通知。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { render } <span class="hljs-keyword">from</span> <span class="hljs-string">"@react-email/components"</span>;
<span class="hljs-keyword">import</span> nodemailer <span class="hljs-keyword">from</span> <span class="hljs-string">"nodemailer"</span>;

<span class="hljs-keyword">const</span> transporter = nodemailer.<span class="hljs-title function_">createTransport</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AzureTransport</span>({
  <span class="hljs-attr">clientId</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">AZURE_CLIENT_ID</span>,
  <span class="hljs-attr">clientSecret</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">AZURE_CLIENT_SECRET</span>,
  <span class="hljs-attr">tenantId</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">AZURE_TENANT_ID</span>
}));

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">sendNotification</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">userData: <span class="hljs-built_in">any</span></span>) =&gt; {
  <span class="hljs-keyword">const</span> userHtml = <span class="hljs-keyword">await</span> <span class="hljs-title function_">render</span>(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">RequestReceivedEmail</span> /&gt;</span></span>);
  
  <span class="hljs-keyword">await</span> transporter.<span class="hljs-title function_">sendMail</span>({
    <span class="hljs-attr">from</span>: <span class="hljs-string">"noreply@yourdomain.com"</span>,
    <span class="hljs-attr">to</span>: userData.<span class="hljs-property">email</span>,
    <span class="hljs-attr">subject</span>: <span class="hljs-string">"Request Confirmation"</span>,
    <span class="hljs-attr">html</span>: userHtml
  });
};

</code></pre>
<hr/>
<h2 data-id="heading-6">总结</h2>
<p>通过这种方式，我们不仅解决了 SMTP 认证即将过期的合规性问题，还提升了邮件的视觉质量。Microsoft Graph API 提供了比传统 SMTP 更强的可监控性和安全性，而 React Email 则极大地改善了邮件开发的开发者体验。</p>
<p>在实际生产环境中，请确保在 Azure 门户中为你的应用授予了 <code>Mail.Send</code> 权限，并根据业务需求配置环境变量。</p>
<h2 data-id="heading-7">参考资料</h2>
<ol>
<li><a href="https://juejin.cn/post/7157980257155285005" target="_blank" title="https://juejin.cn/post/7157980257155285005">构建和发送电子邮件的React组件的实例教程</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.to%2Fgevik%2Fsending-emails-via-outlook-with-nodemailer-and-microsoft-graph-b74" target="_blank" title="https://dev.to/gevik/sending-emails-via-outlook-with-nodemailer-and-microsoft-graph-b74" ref="nofollow noopener noreferrer">Sending Emails via Outlook with Nodemailer and Microsoft Graph</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 Vue 3 构建任务清单：响应式编程的优雅实践]]></title>    <link>https://juejin.cn/post/7588042910198317106</link>    <guid>https://juejin.cn/post/7588042910198317106</guid>    <pubDate>2025-12-27T13:14:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588042910198317106" data-draft-id="7588080521445277742" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 Vue 3 构建任务清单：响应式编程的优雅实践"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-27T13:14:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Zyx2007"/> <meta itemprop="url" content="https://juejin.cn/user/3924597867554890"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 Vue 3 构建任务清单：响应式编程的优雅实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3924597867554890/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Zyx2007
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T13:14:45.000Z" title="Sat Dec 27 2025 13:14:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在前端开发中，任务清单（Todos）是一个经典练习项目。它虽功能简单，却能完整体现数据驱动、状态管理与用户交互的核心思想。若用传统 DOM 操作实现，代码往往冗长且难以维护；而借助 Vue 3 的组合式 API 与响应式系统，我们只需关注“数据如何变化”，界面便会自动同步更新。这种声明式开发范式，不仅提升了开发效率，也让代码逻辑更清晰、更易测试。</p>
<h2 data-id="heading-0">从命令式到声明式：思维的转变</h2>
<p>传统 JavaScript 开发通常采用<strong>命令式编程</strong>：先获取 DOM 元素，再监听事件，最后手动修改内容。</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">app</span> = document.getElementById(<span class="hljs-string">'app'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">input</span> = document.getElementById(<span class="hljs-string">'todo-input'</span>)<span class="hljs-comment">;</span>
input.addEventListener('change', (e) =&gt; {
  <span class="hljs-attr">app.innerHTML</span> = e.target.value.trim()<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<p>这种方式直接操作渲染引擎，每一步都需精确控制。一旦逻辑复杂（如增删改查、筛选、全选），代码会迅速膨胀，且容易因状态不一致导致 bug。</p>
<p>而 Vue 的核心理念是<strong>响应式数据驱动</strong>：你不再操作 DOM，而是定义数据；当数据变化时，框架自动更新视图。开发者只需思考“业务状态是什么”，而非“页面该怎么改”。</p>
<h2 data-id="heading-1">响应式状态：用 <code>ref</code> 管理数据</h2>
<p>在 Vue 3 的 <code>&lt;script setup&gt;</code> 中，我们使用 <code>ref</code> 创建响应式变量：</p>
<pre><code class="hljs language-php" lang="php">&lt;script setup&gt;
import { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">title</span> = <span class="hljs-title function_ invoke__">ref</span>(<span class="hljs-string">'Todos 任务清单'</span>)
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">todos</span> = <span class="hljs-title function_ invoke__">ref</span>([
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'打王者'</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'吃饭'</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">true</span> }
])
&lt;/script&gt;
</code></pre>
<p><code>title</code> 和 <code>todos</code> 都是响应式引用对象。通过 <code>title.value = '新标题'</code> 修改值后，模板中所有使用 <code>{{ title }}</code> 的地方都会自动刷新。这种机制将 UI 与状态紧密绑定，消除了手动 DOM 操作的繁琐。</p>
<h2 data-id="heading-2">模板指令：简洁表达逻辑</h2>
<p>Vue 提供一系列指令，以声明方式描述 UI 行为：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;input <span class="hljs-attr">v-model</span>=<span class="hljs-string">"title"</span> @keyup.enter=<span class="hljs-string">"addTodo"</span> /&gt;
&lt;ul <span class="hljs-attr">v-if</span>=<span class="hljs-string">"todos.length"</span>&gt;
  &lt;li <span class="hljs-attr">v-for</span>=<span class="hljs-string">"todo in todos"</span> :key=<span class="hljs-string">"todo.id"</span>&gt;
    &lt;input <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span> v-model=<span class="hljs-string">"todo.done"</span> /&gt;
    &lt;span :<span class="hljs-attr">class</span>=<span class="hljs-string">"{ 'done': todo.done }"</span>&gt;{{ todo.title }}&lt;/span&gt;
  &lt;/li&gt;
&lt;/ul&gt;
</code></pre>
<ul>
<li><code>v-model</code> 实现双向绑定，输入框内容与 <code>title</code> 同步；</li>
<li><code>@keyup.enter</code> 监听回车键，触发添加任务；</li>
<li><code>v-for</code> 循环渲染列表，无需手动拼接 HTML；</li>
<li><code>:class</code> 动态绑定样式，完成项显示删除线；</li>
<li><code>v-if</code> 控制“暂无任务”提示的显示时机。</li>
</ul>
<p>这些指令将常见交互模式封装成语义化语法，大幅降低样板代码量。</p>
<h2 data-id="heading-3">计算属性：高效派生状态</h2>
<p>任务清单需要实时显示“未完成任务数”和“全选”状态。若在模板中直接写 <code>todos.filter(...).length</code>，每次渲染都会重新计算，影响性能。Vue 的 <strong><code>computed</code></strong> 提供了缓存机制：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">active</span> = computed(() =&gt; {
  return todos.value.filter(<span class="hljs-attr">todo</span> =&gt; !todo.done).length
})
</code></pre>
<p><code>active</code> 是一个计算属性，只有当 <code>todos</code> 发生变化时才会重新求值。模板中使用 <code>{{ active }}</code> 即可获得最新结果，且性能最优。</p>
<p>更巧妙的是，<code>computed</code> 支持 <strong>getter/setter</strong>，可用于实现“全选”功能：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> allDone = <span class="hljs-title function_">computed</span>({
  <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> todos.<span class="hljs-property">value</span>.<span class="hljs-title function_">every</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> todo.<span class="hljs-property">done</span>)
  },
  <span class="hljs-title function_">set</span>(<span class="hljs-params">value</span>) {
    todos.<span class="hljs-property">value</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> todo.<span class="hljs-property">done</span> = value)
  }
})
</code></pre>
<p>当用户勾选“全选”复选框时，<code>set</code> 被调用，批量更新所有任务状态；反之，若部分任务被取消，<code>get</code> 返回 <code>false</code>，复选框自动取消。这种双向联动仅需几行代码，却覆盖了复杂的交互逻辑。</p>
<h2 data-id="heading-4">添加任务：聚焦数据变更</h2>
<p>新增任务的本质是向 <code>todos</code> 数组追加一项：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">addTodo</span> = () =&gt; {
  <span class="hljs-keyword">if</span> (!title.value.<span class="hljs-title function_ invoke__">trim</span>()) <span class="hljs-keyword">return</span>
  todos.value.<span class="hljs-title function_ invoke__">push</span>({
    <span class="hljs-attr">id</span>: Date.<span class="hljs-title function_ invoke__">now</span>(),
    <span class="hljs-attr">title</span>: title.value,
    <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span>
  })
  title.value = <span class="hljs-string">''</span>
}
</code></pre>
<p>这里没有 <code>createElement</code>、<code>appendChild</code> 或 <code>innerHTML</code>，只有对数据的操作。Vue 会自动检测数组变更，并高效更新 DOM。这种“数据即 UI”的思想，让业务逻辑与视图完全解耦。</p>
<h2 data-id="heading-5">样式与体验优化</h2>
<p>通过动态类名，轻松实现视觉反馈：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.done</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#999</span>;
  <span class="hljs-attribute">text-decoration</span>: line-through;
}
</code></pre>
<p>配合 <code>:class="{ 'done': todo.done }"</code>，完成的任务自动变灰并加删除线，提升用户体验。</p>
<h2 data-id="heading-6">总结</h2>
<p>这个 Todos 应用虽小，却完整展示了 Vue 3 的核心优势：</p>
<ul>
<li><strong>响应式系统</strong>让状态与视图自动同步；</li>
<li><strong>组合式 API</strong> 提供灵活、可复用的逻辑组织方式；</li>
<li><strong>模板指令</strong> 将常见交互抽象为简洁语法；</li>
<li><strong>计算属性</strong> 在保证性能的同时简化派生状态管理。</li>
</ul>
<p>相比传统 DOM 操作，Vue 让开发者从“如何改页面”转向“数据该是什么样”，极大降低了心智负担。对于初学者，这是快速上手现代前端开发的捷径；对于资深工程师，这是构建可维护、可扩展应用的坚实基础。正如那句老话：“当你专注于数据，UI 自会跟随。”</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[wx微信小程序部分逻辑]]></title>    <link>https://juejin.cn/post/7588092534161833984</link>    <guid>https://juejin.cn/post/7588092534161833984</guid>    <pubDate>2025-12-27T13:53:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588092534161833984" data-draft-id="7399604686989656075" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="wx微信小程序部分逻辑"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-27T13:53:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户27965604270"/> <meta itemprop="url" content="https://juejin.cn/user/317130507551981"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            wx微信小程序部分逻辑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/317130507551981/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户27965604270
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T13:53:47.000Z" title="Sat Dec 27 2025 13:53:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"w-main"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">text</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"w-title"</span>&gt;</span>{{title}}<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">text</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"w-desc"</span>&gt;</span>{{desc}}<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">block</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 头像选择按钮，根据需要决定是否显示 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nickname-wrapper"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">text</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nickname-label"</span>&gt;</span>头像<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"avatar-wrapper"</span> <span class="hljs-attr">open-type</span>=<span class="hljs-string">"chooseAvatar"</span> <span class="hljs-attr">bind:chooseavatar</span>=<span class="hljs-string">"onChooseAvatar"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">image</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"avatar"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"{{userInfo.avatarUrl}}"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">image</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nickname-wrapper"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">text</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nickname-label"</span>&gt;</span>昵称<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"nickname"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nickname-input"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入昵称"</span> <span class="hljs-attr">bind:change</span>=<span class="hljs-string">"onInputChange"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">block</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">block</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">bindtap</span>=<span class="hljs-string">"onAuthLogin"</span> <span class="hljs-attr">open-type</span>=<span class="hljs-string">"getUserInfo"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"w-login-btn"</span> <span class="hljs-attr">theme</span>=<span class="hljs-string">'primary'</span>&gt;</span>
      确认授权登录
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">block</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">getApp</span>(); <span class="hljs-comment">//通过getApp()方法，能够获取App的实例，从而获取app.js文件中定义的公共数据globalData</span>
<span class="hljs-comment">// const defaultAvatarUrl = '../../images/no-login.png' // 先将avatarUrl设置为一个常量</span>
<span class="hljs-keyword">const</span> defaultAvatarUrl = <span class="hljs-string">'https://mmbiz.qpic.cn/mmbiz/icTdbqWNOwNRna42FI242Lcia07jQodd2FJGIYQfG0LAJGFxM4FbnQP6yfMxBgJ0F3YRqJCJ1aPAK2dQagdusBZg/0'</span>

<span class="hljs-title class_">Page</span>({
  <span class="hljs-comment">/**
   * 页面的初始数据
   */</span>
  <span class="hljs-attr">data</span>: {
    <span class="hljs-attr">title</span>: <span class="hljs-string">'登录确认'</span>,
    <span class="hljs-attr">desc</span>: <span class="hljs-string">'为保障您的账户安全，请确认是本人登录'</span>,
    <span class="hljs-attr">openId</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">sessionKey</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">scene</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">userInfo</span>: {
      <span class="hljs-attr">avatarUrl</span>: defaultAvatarUrl,
      <span class="hljs-attr">nickName</span>: <span class="hljs-string">''</span>,
      <span class="hljs-attr">avatarUrlBase64</span>: <span class="hljs-string">''</span>
    },
    <span class="hljs-attr">hasUserInfo</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">canIUseNicknameComp</span>: wx.<span class="hljs-title function_">canIUse</span>(<span class="hljs-string">'input.type.nickname'</span>),
  },

  <span class="hljs-comment">/**
   * 生命周期函数--监听页面加载
   */</span>
  <span class="hljs-title function_">onLoad</span>(<span class="hljs-params">options</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({
      <span class="hljs-attr">scene</span>: <span class="hljs-built_in">decodeURIComponent</span>(options.<span class="hljs-property">scene</span>)
    })
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getOpenId</span>();
  },

  <span class="hljs-title function_">getOpenId</span>(<span class="hljs-params"/>) {
    wx.<span class="hljs-title function_">login</span>({
      <span class="hljs-attr">success</span>: <span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"用户登录的临时凭证是："</span> + res.<span class="hljs-property">code</span>);
        <span class="hljs-comment">// 保存this到变量that中</span>
        <span class="hljs-keyword">const</span> that = <span class="hljs-variable language_">this</span>;
        wx.<span class="hljs-title function_">request</span>({
          <span class="hljs-attr">url</span>: <span class="hljs-string">'https://juejin.plus/prod-api/wx/public/getOpenId'</span>,
          <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
          <span class="hljs-attr">data</span>: {
            <span class="hljs-attr">code</span>: res.<span class="hljs-property">code</span>,
            <span class="hljs-attr">scene</span>: that.<span class="hljs-property">data</span>.<span class="hljs-property">scene</span> ? that.<span class="hljs-property">data</span>.<span class="hljs-property">scene</span> : <span class="hljs-string">'-1'</span> <span class="hljs-comment">// 使用that代替this</span>
          },
          <span class="hljs-attr">success</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">res</span>) {
            <span class="hljs-keyword">if</span> (res.<span class="hljs-property">data</span>.<span class="hljs-property">code</span> == <span class="hljs-number">200</span>) {
              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"用户openid："</span>, res);
              <span class="hljs-comment">// 使用变量that来引用页面实例</span>
              that.<span class="hljs-title function_">setData</span>({
                <span class="hljs-attr">openId</span>: res.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>.<span class="hljs-property">openId</span>,
                <span class="hljs-attr">sessionKey</span>: res.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>.<span class="hljs-property">sessionKey</span>
              });
            } <span class="hljs-keyword">else</span> {
              wx.<span class="hljs-title function_">showToast</span>({
                <span class="hljs-attr">title</span>: <span class="hljs-string">"用户openid获取失败"</span>,
                <span class="hljs-attr">duration</span>: <span class="hljs-number">1000</span>,
                <span class="hljs-attr">icon</span>: <span class="hljs-string">'none'</span>,
                <span class="hljs-attr">mask</span>: <span class="hljs-literal">true</span>
              })
            }
          },
          <span class="hljs-attr">fail</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"失败"</span>)
          }
        });
      }
    });
  },

  <span class="hljs-title function_">onAuthLogin</span>(<span class="hljs-params">e</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">userInfo</span>.<span class="hljs-property">avatarUrlBase64</span> === <span class="hljs-string">''</span>) {
      wx.<span class="hljs-title function_">showToast</span>({
        <span class="hljs-attr">title</span>: <span class="hljs-string">"请选择头像"</span>,
        <span class="hljs-attr">duration</span>: <span class="hljs-number">1000</span>,
        <span class="hljs-attr">icon</span>: <span class="hljs-string">'none'</span>,
        <span class="hljs-attr">mask</span>: <span class="hljs-literal">true</span>
      })
      <span class="hljs-keyword">return</span>
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">userInfo</span>.<span class="hljs-property">nickName</span> === <span class="hljs-string">''</span>) {
      wx.<span class="hljs-title function_">showToast</span>({
        <span class="hljs-attr">title</span>: <span class="hljs-string">"请输入昵称"</span>,
        <span class="hljs-attr">duration</span>: <span class="hljs-number">1000</span>,
        <span class="hljs-attr">icon</span>: <span class="hljs-string">'none'</span>,
        <span class="hljs-attr">mask</span>: <span class="hljs-literal">true</span>
      })
      <span class="hljs-keyword">return</span>
    }
    wx.<span class="hljs-title function_">getUserProfile</span>({
      <span class="hljs-attr">desc</span>: <span class="hljs-string">'用于完善用户资料'</span>,
      <span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> that = <span class="hljs-variable language_">this</span>;
        that.<span class="hljs-title function_">setData</span>({
          <span class="hljs-attr">isLogin</span>: <span class="hljs-literal">true</span>
        });
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"用户信息："</span>, res)
        <span class="hljs-keyword">var</span> params = {
          <span class="hljs-string">'openId'</span>: that.<span class="hljs-property">data</span>.<span class="hljs-property">openId</span>,
          <span class="hljs-string">'sessionKey'</span>: that.<span class="hljs-property">data</span>.<span class="hljs-property">sessionKey</span>,
          <span class="hljs-string">'encryptedData'</span>: res.<span class="hljs-property">encryptedData</span>,
          <span class="hljs-string">'rawData'</span>: res.<span class="hljs-property">rawData</span>,
          <span class="hljs-string">'signature'</span>: res.<span class="hljs-property">signature</span>,
          <span class="hljs-string">'iv'</span>: res.<span class="hljs-property">iv</span>,
          <span class="hljs-string">'scene'</span>: that.<span class="hljs-property">data</span>.<span class="hljs-property">scene</span> ? that.<span class="hljs-property">data</span>.<span class="hljs-property">scene</span> : <span class="hljs-string">'-1'</span>,
          <span class="hljs-string">'nickName'</span>: that.<span class="hljs-property">data</span>.<span class="hljs-property">userInfo</span>.<span class="hljs-property">nickName</span>,
          <span class="hljs-string">'avatarUrlBase64'</span>: that.<span class="hljs-property">data</span>.<span class="hljs-property">userInfo</span>.<span class="hljs-property">avatarUrlBase64</span>,
        }
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"param:"</span>, params)
        wx.<span class="hljs-title function_">request</span>({
          <span class="hljs-attr">url</span>: <span class="hljs-string">'https://juejin.plus/prod-api/wx/public/getWxUserInfo'</span>,
          <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
          <span class="hljs-attr">data</span>: params,
          <span class="hljs-attr">success</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">res</span>) {
            <span class="hljs-keyword">if</span> (res.<span class="hljs-property">data</span>.<span class="hljs-property">code</span> == <span class="hljs-number">200</span>) {
              that.<span class="hljs-title function_">setData</span>({
                <span class="hljs-attr">isLogin</span>: <span class="hljs-literal">true</span>
              });
              app.<span class="hljs-property">globalData</span>.<span class="hljs-property">loginState</span> = <span class="hljs-literal">true</span>;
              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"登录状态修改成功"</span>)
              wx.<span class="hljs-title function_">showToast</span>({
                <span class="hljs-attr">title</span>: <span class="hljs-string">'登录成功!'</span>,
                <span class="hljs-attr">icon</span>: <span class="hljs-string">'success'</span>,
                <span class="hljs-attr">duration</span>: <span class="hljs-number">3000</span>,
                <span class="hljs-attr">success</span>: <span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
                  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
                    wx.<span class="hljs-title function_">reLaunch</span>({
                      <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/home/home'</span>,
                    })
                  }, <span class="hljs-number">2000</span>)
                },
              })
            } <span class="hljs-keyword">else</span> {
              wx.<span class="hljs-title function_">showToast</span>({
                <span class="hljs-attr">title</span>: <span class="hljs-string">"登录失败"</span>,
                <span class="hljs-attr">duration</span>: <span class="hljs-number">1000</span>,
                <span class="hljs-attr">icon</span>: <span class="hljs-string">'none'</span>,
                <span class="hljs-attr">mask</span>: <span class="hljs-literal">true</span>
              })
            }
          }
        })
      }
    })
  },

  <span class="hljs-title function_">onChooseAvatar</span>(<span class="hljs-params">e</span>) {
    <span class="hljs-keyword">const</span> {
      avatarUrl
    } = e.<span class="hljs-property">detail</span>

    <span class="hljs-comment">//对临时图片链接进行base64编码</span>
    <span class="hljs-keyword">var</span> avatarUrl_base64 = <span class="hljs-string">'data:image/jpeg;base64,'</span> + wx.<span class="hljs-title function_">getFileSystemManager</span>().<span class="hljs-title function_">readFileSync</span>(avatarUrl, <span class="hljs-string">'base64'</span>)
    <span class="hljs-keyword">const</span> {
      nickName
    } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">userInfo</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({
      <span class="hljs-string">"userInfo.avatarUrl"</span>: avatarUrl,
      <span class="hljs-string">"userInfo.avatarUrlBase64"</span>: avatarUrl_base64,
      <span class="hljs-attr">hasUserInfo</span>: nickName &amp;&amp; avatarUrl &amp;&amp; avatarUrl !== defaultAvatarUrl,
    })
  },
  <span class="hljs-title function_">onInputChange</span>(<span class="hljs-params">e</span>) {
    <span class="hljs-keyword">const</span> nickName = e.<span class="hljs-property">detail</span>.<span class="hljs-property">value</span>
    <span class="hljs-keyword">const</span> {
      avatarUrl
    } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">userInfo</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({
      <span class="hljs-string">"userInfo.nickName"</span>: nickName,
      <span class="hljs-attr">hasUserInfo</span>: nickName &amp;&amp; avatarUrl &amp;&amp; avatarUrl !== defaultAvatarUrl,
    })
  },
  <span class="hljs-comment">/**
   * 生命周期函数--监听页面初次渲染完成
   */</span>
  <span class="hljs-title function_">onReady</span>(<span class="hljs-params"/>) {

  },

  <span class="hljs-comment">/**
   * 生命周期函数--监听页面显示
   */</span>
  <span class="hljs-title function_">onShow</span>(<span class="hljs-params"/>) {

  },

  <span class="hljs-comment">/**
   * 生命周期函数--监听页面隐藏
   */</span>
  <span class="hljs-title function_">onHide</span>(<span class="hljs-params"/>) {

  },

  <span class="hljs-comment">/**
   * 生命周期函数--监听页面卸载
   */</span>
  <span class="hljs-title function_">onUnload</span>(<span class="hljs-params"/>) {

  },

  <span class="hljs-comment">/**
   * 页面相关事件处理函数--监听用户下拉动作
   */</span>
  <span class="hljs-title function_">onPullDownRefresh</span>(<span class="hljs-params"/>) {

  },

  <span class="hljs-comment">/**
   * 页面上拉触底事件的处理函数
   */</span>
  <span class="hljs-title function_">onReachBottom</span>(<span class="hljs-params"/>) {

  },

  <span class="hljs-comment">/**
   * 用户点击右上角分享
   */</span>
  <span class="hljs-title function_">onShareAppMessage</span>(<span class="hljs-params"/>) {

  },
})
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[eslint匹配规则速通]]></title>    <link>https://juejin.cn/post/7588152122186809398</link>    <guid>https://juejin.cn/post/7588152122186809398</guid>    <pubDate>2025-12-27T14:15:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588152122186809398" data-draft-id="7588149079417110582" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="eslint匹配规则速通"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-27T14:15:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sujiu"/> <meta itemprop="url" content="https://juejin.cn/user/282996947551584"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            eslint匹配规则速通
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/282996947551584/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sujiu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T14:15:06.000Z" title="Sat Dec 27 2025 14:15:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">eslint匹配规则速通</h2>
<h3 data-id="heading-1">匹配规则</h3>
<p>在 <code>eslint.config.js</code> 里，<strong>“当前文件”</strong> 到底会被哪一个（或哪几个）配置对象命中，是按下述流程逐条计算的。
只要记住一句话：</p>
<blockquote>
<p><strong>ESLint 会把文件路径依次跟每个配置对象的 <code>files</code>/<code>ignores</code> 做 glob 匹配，命中且未被忽略的就生效；多个对象都命中就层层合并。</strong></p>
</blockquote>
<p>下面把“匹配”这件事拆成 5 个具体问题，一次性讲透。</p>
<hr/>
<ol>
<li>
<p>拿谁来匹配？
文件在磁盘里的<strong>绝对路径</strong>（Windows 带盘符，Unix 以 <code>/</code> 开头）。
例：
<code>/home/me/proj/src/utils/is-empty.js</code>
<code>D:\repo\src\utils\is-empty.js</code></p>
</li>
<li>
<p>跟谁匹配？
每个配置对象里可能出现的两组 glob 模式：</p>
<ul>
<li><code>files</code> 数组 —— 白名单</li>
<li><code>ignores</code> 数组 —— 黑名单（支持 <code>!</code> 否定）</li>
</ul>
</li>
<li>
<p>匹配顺序（级联）
对<strong>每一个</strong>配置对象：</p>
<ol>
<li>若对象<strong>没有</strong> <code>files</code>，视为 <code>files:["**/*"]</code>（全选）。</li>
<li>拿文件路径去跟 <code>files</code> 里每一项做 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fisaacs%2Fminimatch" target="_blank" title="https://github.com/isaacs/minimatch" ref="nofollow noopener noreferrer">minimatch</a>（类 <code>.gitignore</code> 语法）。
<ul>
<li>只要<strong>有一项命中</strong>就认为该对象“适用于”此文件。</li>
</ul>
</li>
<li>若对象还有 <code>ignores</code>，再跟这些模式比对：
<ul>
<li>命中任何 <code>ignores</code> 就<strong>立即把该对象排除</strong>，不再参与后续合并。</li>
<li>支持否定写法 <code>"!xxx"</code>，可再把文件“捞回来”。</li>
</ul>
</li>
<li>全局忽略规则（对象里只有 <code>ignores</code>，没有 <code>files</code> 等其他键）会在<strong>所有对象</strong>之前先算一次，原理相同。</li>
</ol>
</li>
<li>
<p>合并结果
经过上面筛选后，可能 0 ～ N 个对象对当前文件生效。</p>
<ul>
<li>0 个 → ESLint 报错 “No configuration provided for …”</li>
<li>≥1 个 → 按数组顺序<strong>浅合并</strong>（靠后的覆盖靠前的）：
<code>languageOptions</code>/<code>linterOptions</code>/<code>plugins</code>/<code>settings</code> 递归合并；
<code>rules</code> 直接覆盖同名键。</li>
</ul>
</li>
<li>
<p>快速验证
命令行看一眼到底哪条配置命中：</p>
<pre><code class="hljs language-bash" lang="bash">npx eslint --inspect-config src/utils/is-empty.js
</code></pre>
<p>会打印出最终合并后的完整配置以及“来自哪几个对象”，调试神器。</p>
</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> [
  {                           <span class="hljs-comment">// 对象 A</span>
    <span class="hljs-attr">ignores</span>: [<span class="hljs-string">"**/*.config.js"</span>]   <span class="hljs-comment">// 全局忽略</span>
  },
  {                           <span class="hljs-comment">// 对象 B</span>
    <span class="hljs-attr">files</span>: [<span class="hljs-string">"src/**/*.js"</span>],
    <span class="hljs-attr">ignores</span>: [<span class="hljs-string">"**/*.test.js"</span>],
    <span class="hljs-attr">rules</span>: { <span class="hljs-attr">semi</span>: <span class="hljs-string">"warn"</span> }
  },
  {                           <span class="hljs-comment">// 对象 C</span>
    <span class="hljs-attr">files</span>: [<span class="hljs-string">"**/*.test.js"</span>],
    <span class="hljs-attr">rules</span>: { <span class="hljs-attr">semi</span>: <span class="hljs-string">"off"</span> }
  }
]
</code></pre>
<p>现在 lint 文件
<code>/proj/src/utils/is-empty.js</code></p>
<ol>
<li>全局忽略 A 先算 —— 文件名不是 <code>*.config.js</code>，<strong>未被忽略</strong>，继续。</li>
<li>对象 B：<code>files</code> 命中 <code>src/**/*.js</code>，且不在 <code>ignores</code> 里 → <strong>生效</strong>。</li>
<li>对象 C：<code>files</code> 命中 <code>**/*.test.js</code>，但当前文件不是测试 → <strong>跳过</strong>。</li>
</ol>
<p>最终只有 B 生效，<code>semi: "warn"</code>。</p>
<p>再把
<code>/proj/src/utils/is-empty.test.js</code>
走一遍：</p>
<ol>
<li>全局忽略 A 同上，未忽略。</li>
<li>对象 B：虽然命中 <code>src/**/*.js</code>，但紧接着被 <code>**/*.test.js</code> 忽略 → <strong>对象 B 被排除</strong>。</li>
<li>对象 C：命中 <code>**/*.test.js</code> → <strong>生效</strong>，<code>semi: "off"</code>。</li>
</ol>
<h3 data-id="heading-2">合并规则</h3>
<p>flat Config 的“合并”并不是深度合并（deep merge），而是<strong>按数组顺序、一级一级地“覆盖 + 累加”</strong>，规则非常干脆：</p>
<ol>
<li><strong>数组顺序 = 优先级</strong>
后出现的 config 对象如果和前面的<strong>同字段同名</strong>，就<strong>整值覆盖</strong>；不同名就累加。</li>
<li><strong>命中范围（files / ignores）独立判断</strong>
对单个文件来说，ESLint 会把<strong>所有路径命中</strong>的 config 对象收集起来，再按顺序合并；
只要某一段 config 的 <code>ignores</code> 匹配了，这段及后面同路径的 config 就被整段跳过。</li>
<li><strong>合并粒度只到“字段”一级</strong>
<ul>
<li><code>languageOptions</code>、<code>plugins</code>、<code>rules</code> 都是<strong>整对象替换</strong>，不会递归合并内部子键。</li>
<li>想“增量”就必须把前面那段再抄一遍，或者利用展开运算符自己拼装。</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-3">看一段代码就懂</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> [
  {                                                    <span class="hljs-comment">// ①</span>
    <span class="hljs-attr">files</span>: [<span class="hljs-string">'**/*.ts'</span>],
    <span class="hljs-attr">languageOptions</span>: { <span class="hljs-attr">parser</span>: ts.<span class="hljs-property">parser</span>, <span class="hljs-attr">ecmaVersion</span>: <span class="hljs-number">2022</span> },
    <span class="hljs-attr">rules</span>: { <span class="hljs-string">'@typescript-eslint/no-explicit-any'</span>: <span class="hljs-string">'warn'</span>, <span class="hljs-string">'no-console'</span>: <span class="hljs-string">'off'</span> }
  },
  {                                                    <span class="hljs-comment">// ②</span>
    <span class="hljs-attr">files</span>: [<span class="hljs-string">'**/*.ts'</span>],
    <span class="hljs-attr">rules</span>: { <span class="hljs-string">'no-console'</span>: <span class="hljs-string">'error'</span> }                   <span class="hljs-comment">// 整对象覆盖，结果只剩 no-console:error</span>
  }
];
</code></pre>
<p>对任意 <code>.ts</code> 文件：</p>
<ul>
<li>先收集 ① → 再收集 ②</li>
<li>② 的 <code>rules</code> 是全新对象，直接把 ① 的 <code>rules</code> 整份替换掉；<code>languageOptions</code> 保留 ① 的，因为 ② 没写。</li>
</ul>
<p>最终生效的只有：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">languageOptions</span>: { <span class="hljs-attr">parser</span>: ts.<span class="hljs-property">parser</span>, <span class="hljs-attr">ecmaVersion</span>: <span class="hljs-number">2022</span> }
<span class="hljs-attr">rules</span>: { <span class="hljs-string">'no-console'</span>: <span class="hljs-string">'error'</span> }
</code></pre>
<p><code>@typescript-eslint/no-explicit-any</code> 这条规则被“覆盖没”了——<strong>不会自动保留</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python 基础再升级！5 个超实用小技巧，写代码快人一步]]></title>    <link>https://juejin.cn/post/7588042910198382642</link>    <guid>https://juejin.cn/post/7588042910198382642</guid>    <pubDate>2025-12-27T14:16:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588042910198382642" data-draft-id="7588084804093427750" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python 基础再升级！5 个超实用小技巧，写代码快人一步"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-27T14:16:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AAA简单玩转程序设计"/> <meta itemprop="url" content="https://juejin.cn/user/4294056357689099"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python 基础再升级！5 个超实用小技巧，写代码快人一步
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4294056357689099/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AAA简单玩转程序设计
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T14:16:18.000Z" title="Sat Dec 27 2025 14:16:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>刚入门 Python 能实现功能，但想让代码更简洁、更高效？这 5 个进阶偏基础的小技巧，看似简单却能大幅提升编码体验，每个都附可直接运行的示例，新手也能轻松掌握～</p>
<h2 data-id="heading-0">1. 巧用 enumerate：遍历列表同时获取索引</h2>
<p>遍历列表时想知道元素的位置，不用手动加计数器，<code>enumerate()</code> 能直接返回索引和元素，还能自定义起始索引。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 待遍历的列表</span>
fruits = [<span class="hljs-string">"苹果"</span>, <span class="hljs-string">"香蕉"</span>, <span class="hljs-string">"橙子"</span>, <span class="hljs-string">"葡萄"</span>]

<span class="hljs-comment"># 基础用法：默认从0开始</span>
<span class="hljs-keyword">for</span> idx, fruit <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(fruits):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"索引<span class="hljs-subst">{idx}</span>：<span class="hljs-subst">{fruit}</span>"</span>)

<span class="hljs-comment"># 进阶用法：指定起始索引（比如从1开始）</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n指定起始索引："</span>)
<span class="hljs-keyword">for</span> idx, fruit <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(fruits, start=<span class="hljs-number">1</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"第<span class="hljs-subst">{idx}</span>个水果：<span class="hljs-subst">{fruit}</span>"</span>)

<span class="hljs-comment"># 输出：</span>
<span class="hljs-comment"># 索引0：苹果</span>
<span class="hljs-comment"># 索引1：香蕉</span>
<span class="hljs-comment"># 索引2：橙子</span>
<span class="hljs-comment"># 索引3：葡萄</span>
<span class="hljs-comment"># </span>
<span class="hljs-comment"># 指定起始索引：</span>
<span class="hljs-comment"># 第1个水果：苹果</span>
<span class="hljs-comment"># 第2个水果：香蕉</span>
<span class="hljs-comment"># 第3个水果：橙子</span>
<span class="hljs-comment"># 第4个水果：葡萄</span>
</code></pre>
<h2 data-id="heading-1">2. zip () 函数：多列表同步遍历，超省心</h2>
<p>需要同时遍历多个列表的对应元素时，<code>zip()</code> 能把多个可迭代对象打包成元组，避免手动处理索引。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 多个关联列表</span>
names = [<span class="hljs-string">"张三"</span>, <span class="hljs-string">"李四"</span>, <span class="hljs-string">"王五"</span>]
scores = [<span class="hljs-number">85</span>, <span class="hljs-number">92</span>, <span class="hljs-number">78</span>]
subjects = [<span class="hljs-string">"数学"</span>, <span class="hljs-string">"语文"</span>, <span class="hljs-string">"英语"</span>]

<span class="hljs-comment"># 同步遍历三个列表</span>
<span class="hljs-keyword">for</span> name, score, subject <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(names, scores, subjects):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{name}</span>的<span class="hljs-subst">{subject}</span>成绩：<span class="hljs-subst">{score}</span>分"</span>)

<span class="hljs-comment"># 输出：</span>
<span class="hljs-comment"># 张三的数学成绩：85分</span>
<span class="hljs-comment"># 李四的语文成绩：92分</span>
<span class="hljs-comment"># 王五的英语成绩：78分</span>
</code></pre>
<h2 data-id="heading-2">3. 用 set 快速去重：比列表遍历高效 N 倍</h2>
<p>列表去重不用写循环判断，转成集合（set）再转回列表，一行就能搞定，且时间复杂度更低。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 含重复元素的列表</span>
nums = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]

<span class="hljs-comment"># 快速去重</span>
unique_nums = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">set</span>(nums))
<span class="hljs-built_in">print</span>(<span class="hljs-string">"去重后："</span>, unique_nums)  <span class="hljs-comment"># 输出：去重后：[1, 2, 3, 4, 5]</span>

<span class="hljs-comment"># 拓展：保持原列表顺序（Python 3.7+）</span>
unique_nums_ordered = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">dict</span>.fromkeys(nums))
<span class="hljs-built_in">print</span>(<span class="hljs-string">"去重且保序："</span>, unique_nums_ordered)  <span class="hljs-comment"># 输出：去重且保序：[1, 2, 3, 4, 5]</span>
</code></pre>
<h2 data-id="heading-3">4. 三元表达式：简化简单的条件判断</h2>
<p>简单的 if-else 赋值逻辑，用三元表达式能精简代码，保持可读性的同时减少行数。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 需求：判断成绩是否及格，返回对应提示</span>
score = <span class="hljs-number">88</span>

<span class="hljs-comment"># 传统if-else写法</span>
<span class="hljs-keyword">if</span> score &gt;= <span class="hljs-number">60</span>:
    result = <span class="hljs-string">"及格"</span>
<span class="hljs-keyword">else</span>:
    result = <span class="hljs-string">"不及格"</span>

<span class="hljs-comment"># 三元表达式写法</span>
result = <span class="hljs-string">"及格"</span> <span class="hljs-keyword">if</span> score &gt;= <span class="hljs-number">60</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"不及格"</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"成绩<span class="hljs-subst">{score}</span>：<span class="hljs-subst">{result}</span>"</span>)  <span class="hljs-comment"># 输出：成绩88：及格</span>

<span class="hljs-comment"># 进阶：嵌套三元表达式（适用于简单场景）</span>
score = <span class="hljs-number">95</span>
result = <span class="hljs-string">"优秀"</span> <span class="hljs-keyword">if</span> score &gt;= <span class="hljs-number">90</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"良好"</span> <span class="hljs-keyword">if</span> score &gt;= <span class="hljs-number">80</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"及格"</span> <span class="hljs-keyword">if</span> score &gt;= <span class="hljs-number">60</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"不及格"</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"成绩<span class="hljs-subst">{score}</span>：<span class="hljs-subst">{result}</span>"</span>)  <span class="hljs-comment"># 输出：成绩95：优秀</span>
</code></pre>
<h2 data-id="heading-4">5. with 语句：自动管理文件 / 资源，告别忘记 close ()</h2>
<p>操作文件时用<code>with</code>语句，无需手动调用<code>close()</code>，代码块执行完会自动关闭文件，避免资源泄露。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 传统写法（需手动close）</span>
f = <span class="hljs-built_in">open</span>(<span class="hljs-string">"test.txt"</span>, <span class="hljs-string">"w"</span>, encoding=<span class="hljs-string">"utf-8"</span>)
f.write(<span class="hljs-string">"Python基础进阶技巧"</span>)
f.close()

<span class="hljs-comment"># with语句写法（推荐）</span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"test.txt"</span>, <span class="hljs-string">"r"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
    content = f.read()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"文件内容："</span>, content)  <span class="hljs-comment"># 输出：文件内容：Python基础进阶技巧</span>

<span class="hljs-comment"># 注：with语句块结束后，文件会自动关闭，即使报错也不影响</span>
</code></pre>
<hr/>
<h3 data-id="heading-5">总结</h3>
<ol>
<li><code>enumerate()</code> 遍历带索引、<code>zip()</code> 同步遍历多列表，解决遍历场景的常见痛点；</li>
<li>集合（set）快速去重效率高，三元表达式简化简单条件赋值；</li>
<li><code>with</code> 语句自动管理资源，操作文件 / 网络连接时更安全。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[原子化 CSS 与 Fragment：现代前端开发的高效实践]]></title>    <link>https://juejin.cn/post/7588080521445343278</link>    <guid>https://juejin.cn/post/7588080521445343278</guid>    <pubDate>2025-12-27T14:33:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588080521445343278" data-draft-id="7588086766248820787" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="原子化 CSS 与 Fragment：现代前端开发的高效实践"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-27T14:33:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ohyeah"/> <meta itemprop="url" content="https://juejin.cn/user/740446536480618"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            原子化 CSS 与 Fragment：现代前端开发的高效实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/740446536480618/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ohyeah
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T14:33:53.000Z" title="Sat Dec 27 2025 14:33:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在现代前端开发中，提升开发效率、优化性能以及保持代码可维护性是开发者持续追求的目标。近年来，原子化 CSS（Atomic CSS）理念与 React 中的 Fragment 模式逐渐成为主流实践，它们分别从样式管理和 DOM 结构两个维度，为开发者提供了更优雅、高效的解决方案。本文将围绕这两个核心概念展开，结合 Tailwind CSS 的使用方式和原生 JavaScript 与 React 中的 Fragment 应用，探讨如何构建高性能、高复用性的前端项目。</p>
<hr/>
<h2 data-id="heading-0">一、传统 CSS 的局限与原子化 CSS 的兴起</h2>
<p>传统的 CSS 编写方式通常以“语义化类名”为核心，例如 <code>.article-card</code>、<code>.user-profile</code> 等。这类类名虽然具有良好的业务含义，但往往导致样式高度耦合于具体组件，难以跨项目或跨组件复用。一个典型的痛点是：即使两个组件需要相同的内边距或文字颜色，开发者仍需重复编写相似的样式规则，或者通过复杂的继承结构来共享样式，这不仅增加了维护成本，也降低了开发效率。</p>
<p>为了解决这一问题，<strong>原子化 CSS</strong>（Atomic CSS）应运而生。其核心思想是将 CSS 规则拆解为最小、不可再分的“原子类”，每个类只负责单一的样式属性。例如：</p>
<ul>
<li><code>p-4</code> 表示 <code>padding: 1rem</code>（默认 16px）</li>
<li><code>flex</code> 表示 <code>display: flex</code></li>
<li><code>text-gray-500</code> 表示特定的灰色文字颜色</li>
</ul>
<p>这种写法看似“冗长”，实则带来了极高的<strong>复用性</strong>和<strong>一致性</strong>。开发者不再需要为每个新组件创建新的 CSS 文件或类名，而是直接组合已有的原子类即可快速构建 UI。</p>
<h3 data-id="heading-1">面向对象的 CSS 思维</h3>
<p>原子化 CSS 并非完全抛弃面向对象的思想，而是将其重新诠释：</p>
<ul>
<li><strong>封装</strong>：原子类本身就是对单一样式规则的封装；</li>
<li><strong>多态</strong>：通过不同类的组合，同一原子类可在不同上下文中呈现不同效果；</li>
<li><strong>组合优于继承</strong>：避免深层嵌套和复杂选择器，通过类名组合实现样式叠加。</li>
</ul>
<p>这种模式尤其适合快速原型开发和团队协作，因为所有开发者都基于同一套“设计系统”进行构建，减少了风格不一致的问题。</p>
<hr/>
<h2 data-id="heading-2">二、Tailwind CSS：原子化 CSS 的最佳实践</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ftailwindcss.com%2F" target="_blank" title="https://tailwindcss.com/" ref="nofollow noopener noreferrer">Tailwind CSS</a> 是目前最流行的原子化 CSS 框架。它提供了一套高度可配置的实用类（utility classes），几乎无需手写自定义 CSS 即可完成复杂界面的搭建。</p>
<h3 data-id="heading-3">快速上手 Tailwind + Vite</h3>
<p>在现代前端工程中，Tailwind 通常与构建工具如 Vite 配合使用。安装步骤如下：</p>
<pre><code class="hljs language-csharp" lang="csharp">npm install -D tailwindcss postcss autoprefixer
npx tailwindcss <span class="hljs-keyword">init</span> -p
</code></pre>
<p>然后在 <code>vite.config.js</code> 中引入插件（若使用官方模板，通常已自动集成）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> react <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-react'</span>
<span class="hljs-keyword">import</span> tailwindcss <span class="hljs-keyword">from</span> <span class="hljs-string">'tailwindcss'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">react</span>(), <span class="hljs-title function_">tailwindcss</span>()]
})
</code></pre>
<p>接着在入口 CSS 文件中引入 Tailwind 的基础样式：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@tailwind</span> base;
<span class="hljs-variable">@tailwind</span> components;
<span class="hljs-variable">@tailwind</span> utilities;
</code></pre>
<p>至此，即可在 JSX 或 HTML 中直接使用 Tailwind 类名。</p>
<h3 data-id="heading-4">示例：构建一个卡片组件</h3>
<p>以下是一个使用 Tailwind 构建的简单文章卡片组件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">ArticleCard</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"p-4 bg-white rounded-xl shadow hover:shadow-lg transition"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-lg font-bold"</span>&gt;</span>Tailwindcss<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-gray-500 mt-2"</span>&gt;</span>
        用 utility class 快速构建 UI
      <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p>可以看到，所有样式均通过类名内联声明，无需额外 CSS 文件。<code>p-4</code> 控制内边距，<code>rounded-xl</code> 设置圆角，<code>shadow</code> 和 <code>hover:shadow-lg</code> 实现悬停阴影效果，<code>transition</code> 添加过渡动画。这种写法直观、高效，且天然支持响应式。</p>
<h3 data-id="heading-5">响应式布局：移动端优先</h3>
<p>Tailwind 默认采用 <strong>Mobile First</strong>（移动端优先）策略。例如：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"flex flex-col md:flex-row gap-4"</span>&gt;
  &lt;main <span class="hljs-attr">className</span>=<span class="hljs-string">"bg-blue-100 p-4 md:w-2/3"</span>&gt;主内容&lt;/main&gt;
  &lt;aside <span class="hljs-attr">className</span>=<span class="hljs-string">"bg-green-100 p-4 md:w-1/3"</span>&gt;侧边栏&lt;/aside&gt;
&lt;/div&gt;
</code></pre>
<ul>
<li>在小屏设备上，容器为垂直布局（<code>flex-col</code>）；</li>
<li>当屏幕宽度 ≥ 768px（<code>md</code> 断点）时，切换为水平布局（<code>md:flex-row</code>），并设置主内容占 2/3，侧边栏占 1/3。</li>
</ul>
<p>这种声明式响应式语法极大简化了媒体查询的编写，使布局逻辑一目了然。</p>
<hr/>
<h2 data-id="heading-6">三、Fragment：优雅解决 DOM 结构冗余</h2>
<p>在 React 开发中，组件必须返回单个根元素。早期开发者常被迫包裹一层无意义的 <code>&lt;div&gt;</code>，这不仅污染 DOM 结构，还可能影响 CSS 布局（如 Flex 容器的子项数量变化）。</p>
<p>React 提供了 <strong>Fragment</strong> 来解决这一问题：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>标题1<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>标题2<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"</span>&gt;</span>
        提交
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ArticleCard</span> /&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  )
}
</code></pre>
<p>这里的 <code>&lt;&gt;...&lt;/&gt;</code> 是 <code>&lt;React.Fragment&gt;</code> 的简写语法。它在渲染时<strong>不会生成任何实际 DOM 节点</strong>，仅作为逻辑容器存在，从而保持 DOM 树的简洁性。</p>
<h3 data-id="heading-7">原生 JavaScript 中的 DocumentFragment</h3>
<p>Fragment 的思想不仅存在于 React，在原生 DOM 操作中同样重要。当需要批量插入多个节点时，频繁调用 <code>appendChild</code> 会触发多次<strong>重排（reflow）<strong>和</strong>重绘（repaint）</strong> ，严重影响性能。</p>
<p>此时可使用 <code>DocumentFragment</code>：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;script&gt;
  const <span class="hljs-attr">container</span> = document.querySelector(<span class="hljs-string">'.container'</span>)
  const <span class="hljs-attr">p1</span> = document.createElement(<span class="hljs-string">'p'</span>)
  <span class="hljs-attr">p1.textContent</span> = <span class="hljs-string">'111'</span>
  const <span class="hljs-attr">p2</span> = document.createElement(<span class="hljs-string">'p'</span>)
  <span class="hljs-attr">p2.textContent</span> = <span class="hljs-string">'222'</span>

  const <span class="hljs-attr">fragment</span> = document.createDocumentFragment()
  fragment.appendChild(p1)
  fragment.appendChild(p2)

  container.appendChild(fragment) // 仅一次 DOM 操作
&lt;/script&gt;
</code></pre>
<p><code>DocumentFragment</code> 是一个<strong>脱离文档流的内存节点</strong>，在其上操作不会触发浏览器渲染。只有最终将其插入真实 DOM 时，才会一次性将所有子节点挂载，从而将 N 次 DOM 操作优化为 1 次。</p>
<blockquote>
<p>关键优势：<strong>减少重排/重绘次数，显著提升性能</strong>，尤其在处理大量动态内容（如列表渲染、表格生成）时效果明显。</p>
</blockquote>
<hr/>
<h2 data-id="heading-8">四、协同增效：原子化 CSS + Fragment 的现代开发范式</h2>
<p>将原子化 CSS 与 Fragment 结合，构成了现代前端开发的高效工作流：</p>
<ul>
<li><strong>样式层面</strong>：通过 Tailwind 的原子类，开发者在 JSX 中直接声明样式，无需切换文件上下文，提升开发连贯性；</li>
<li><strong>结构层面</strong>：使用 Fragment 避免无意义的包装元素，保持语义清晰、DOM 精简；</li>
<li><strong>性能层面</strong>：DocumentFragment 优化原生 DOM 操作，React Fragment 优化虚拟 DOM 渲染，两者共同保障应用流畅性。</li>
</ul>
<p>更重要的是，这种组合天然契合 <strong>AI 辅助编程</strong> 的趋势。当使用自然语言描述 UI（如“一个带阴影的白色卡片，包含标题和灰色描述文本”），LLM 更容易生成语义明确、结构规范的 Tailwind 代码，而无需理解复杂的 CSS 选择器逻辑。</p>
<hr/>
<h2 data-id="heading-9">结语</h2>
<p>原子化 CSS 与 Fragment 并非炫技，而是对“<strong>关注点分离</strong>”和“<strong>性能优先</strong>”原则的务实体现。前者让样式回归组合与复用，后者让结构回归语义与效率。在 Tailwind CSS 和 React 等现代工具链的支持下，开发者可以更专注于业务逻辑本身，而非被繁琐的样式管理和 DOM 冗余所困扰。</p>
<p>无论是个人项目还是大型团队协作，拥抱这些实践都将带来更清爽的代码、更快的迭代速度和更佳的用户体验。正如前端生态不断演进，我们的开发方式也应随之精进——少写 CSS，少造 div，多组合，多优化。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 实现一个容器内部元素可平移、缩放和旋转等功能（九）]]></title>    <link>https://juejin.cn/post/7588149079417159734</link>    <guid>https://juejin.cn/post/7588149079417159734</guid>    <pubDate>2025-12-27T14:45:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588149079417159734" data-draft-id="7588146449005740068" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 实现一个容器内部元素可平移、缩放和旋转等功能（九）"/> <meta itemprop="keywords" content="Flutter,前端"/> <meta itemprop="datePublished" content="2025-12-27T14:45:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="名字被你们想完了"/> <meta itemprop="url" content="https://juejin.cn/user/3065854916834782"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 实现一个容器内部元素可平移、缩放和旋转等功能（九）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3065854916834782/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    名字被你们想完了
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T14:45:21.000Z" title="Sat Dec 27 2025 14:45:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Flutter 实现一个容器内部元素可平移、缩放和旋转等功能（九）</h2>
<p>Flutter: 3.35.7</p>
<p>今天的功能完成那基本功能就完成了，所以给出github链接：</p>
<pre><code class="hljs language-text" lang="text">https://github.com/yhtqw/FrontEndDemo/tree/main/flutter_demo/lib/pages/transform_use/widgets/multiple_transform
</code></pre>
<p>前面我们简单实现了图片元素和文本元素的新增，优先实现的功能，很多地方还可以优化。今天我来讨论一下文本元素的拖动缩放。</p>
<p>对于文本元素，文本元素的高度是由文本自身的样式来决定的，所以我们限制文本元素只能缩放宽度，高度自动计算。这样就会对缩放区域进行元素类型判断，如果是文本元素，那么只缩放宽度，高度自适应；如果是其他元素，则同上对宽度高度进行缩放。既然功能又区别，那么icon也要有区别，那么之前的元素操作区域得做出更改，新增这种特殊功能区分元素类型对应图标不一样的配置：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ResponseAreaModel</span> </span>{
  <span class="hljs-comment">// 其他省略...</span>

  <span class="hljs-comment">/// <span class="markdown">元素类型不同展示不同的操作icon</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">String</span>&gt;? iconConfig;

  <span class="hljs-comment">// 其他省略...</span>
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConstantsConfig</span> </span>{
  <span class="hljs-comment">// 其他省略...</span>

  <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;ResponseAreaModel&gt; baseAreaList = [
    <span class="hljs-comment">// 其他省略...</span>

    <span class="hljs-comment">// 缩放</span>
    ResponseAreaModel(
      areaWidth: <span class="hljs-number">20</span>,
      areaHeight: <span class="hljs-number">20</span>,
      xRatio: <span class="hljs-number">1</span>,
      yRatio: <span class="hljs-number">1</span>,
      status: ElementStatus.scale.value,
      icon: <span class="hljs-string">'assets/images/icon_scale.png'</span>,
      trigger: TriggerMethod.move,
      iconConfig: {
        ElementType.textType.type: <span class="hljs-string">'assets/images/icon_scale_text.png'</span>,
      },
    ),

    <span class="hljs-comment">// 其他省略...</span>
  ],

  <span class="hljs-comment">// 其他省略...</span>
}

<span class="hljs-comment">// 其他省略...</span>

<span class="hljs-comment">// 如果选中，则展示操作区域</span>
<span class="hljs-keyword">if</span> (selected) ...areaList.map((item) =&gt; Positioned(
  top: elementItem.elementHeight * item.yRatio - item.areaHeight / <span class="hljs-number">2</span>,
  left: elementItem.elementWidth * item.xRatio - item.areaWidth / <span class="hljs-number">2</span>,
  child: Container(
    width: item.areaWidth,
    height: item.areaHeight,
    alignment: Alignment.center,
    decoration: BoxDecoration(
      color: Colors.blueAccent,
      borderRadius: BorderRadius.circular(item.areaWidth / <span class="hljs-number">2</span>),
    ),
    child: Image.asset(
      <span class="hljs-comment">// 判断对应类型的图片是否单独存在</span>
      item.iconConfig?[elementItem.type] ?? item.icon,
      width: item.areaWidth - ConstantsConfig.areaIconMargin,
      height: item.areaHeight - ConstantsConfig.areaIconMargin,
      fit: BoxFit.scaleDown,
      color: Colors.white,
    ),
  ),
)),
</code></pre>
<p>运行效果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/600d8604918640c8b86a3dc7bcd9965c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767451521&amp;x-signature=O51Ojk40bc%2BzwMhvyZIbHnbPN%2F8%3D" alt="image01.gif" loading="lazy"/></p>
<p>这样我们就通过元素状态区分了特殊功能的图标展示，现在就是功能的实现了：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">处理元素缩放</span></span>
<span class="hljs-comment">///</span>
<span class="hljs-comment">/// <span class="markdown">通过移动点坐标[x]和[y]与按下的初始坐标，</span></span>
<span class="hljs-keyword">void</span> _onScale({<span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> x, <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> y}) {
  <span class="hljs-keyword">if</span> (_currentElement?.type == ElementType.textType.type) {
    _onScaleText(x: x, y: y);
  } <span class="hljs-keyword">else</span> {
    _onScaleBase(x: x, y: y);
  }
}

<span class="hljs-comment">/// <span class="markdown">抽取获取缩放需要的基础参数</span></span>
(<span class="hljs-built_in">double</span>, <span class="hljs-built_in">double</span>, <span class="hljs-built_in">double</span>, <span class="hljs-built_in">double</span>, <span class="hljs-built_in">double</span>) _getScaleParams({<span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> x, <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> y}) {
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> oWidth = _temporary!.width;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> oHeight = _temporary!.height;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> oX = _temporary!.x;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> oY = _temporary!.y;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> resizeRatio = _calcResizeRatio(x: x, y: y);

  <span class="hljs-keyword">return</span> (oWidth, oHeight, oX, oY, resizeRatio);
}

<span class="hljs-comment">/// <span class="markdown">处理非文本元素的缩放</span></span>
<span class="hljs-keyword">void</span> _onScaleBase({<span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> x, <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> y}) {
  <span class="hljs-keyword">if</span> (_currentElement == <span class="hljs-keyword">null</span> || _temporary == <span class="hljs-keyword">null</span>) <span class="hljs-keyword">return</span>;
  
  <span class="hljs-keyword">final</span> (oWidth, oHeight, oX, oY, resizeRatio) = _getScaleParams(x: x, y: y);
  <span class="hljs-built_in">double</span> newW = oWidth * resizeRatio;
  <span class="hljs-built_in">double</span> newH = oHeight * resizeRatio;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> minSize = ConstantsConfig.minSize;

  <span class="hljs-comment">// 以短边为基准来计算最小宽高</span>
  <span class="hljs-keyword">if</span> (oWidth &lt;= oHeight &amp;&amp; newW &lt; minSize) {
    newW = minSize;
    newH = minSize * oHeight / oWidth;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (oHeight &lt; oWidth &amp;&amp; newH &lt; minSize) {
    newH = minSize;
    newW = minSize * oWidth / oHeight;
  }

  <span class="hljs-comment">// 以长边为基准来计算最大宽高</span>
  <span class="hljs-keyword">if</span> (oWidth &gt;= oHeight &amp;&amp; newW &gt;= _transformWidth) {
    newW = _transformWidth;
    newH = _transformWidth * oHeight / oWidth;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (oHeight &gt; oWidth &amp;&amp; newH &gt;= _transformHeight) {
    newH = _transformHeight;
    newW = _transformHeight * oWidth / oHeight;
  }

  <span class="hljs-keyword">if</span> (
    newW == _currentElement?.elementWidth &amp;&amp;
      newH == _currentElement?.elementHeight
  ) {
    <span class="hljs-keyword">return</span>;
  }

  _currentElement = _currentElement?.copyWith(
    elementWidth: newW,
    elementHeight: newH,
    x: oX - (newW - oWidth) / <span class="hljs-number">2</span>,
    y: oY - (newH - oHeight) / <span class="hljs-number">2</span>,
  );
  _onChange();
}

<span class="hljs-comment">/// <span class="markdown">文本元素的缩放</span></span>
<span class="hljs-keyword">void</span> _onScaleText({<span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> x, <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> y}) {
  <span class="hljs-keyword">if</span> (_currentElement == <span class="hljs-keyword">null</span> || _temporary == <span class="hljs-keyword">null</span>) <span class="hljs-keyword">return</span>;
  
  <span class="hljs-keyword">final</span> (oWidth, oHeight, oX, oY, resizeRatio) = _getScaleParams(x: x, y: y);
  <span class="hljs-built_in">double</span> newW = oWidth * resizeRatio;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> minSize = ConstantsConfig.minSize;

  <span class="hljs-comment">// 以短边为基准来计算最小宽高</span>
  <span class="hljs-keyword">if</span> (oWidth &lt;= oHeight &amp;&amp; newW &lt; minSize) {
    newW = minSize;
  }

  <span class="hljs-comment">// 以长边为基准来计算最大宽高</span>
  <span class="hljs-keyword">if</span> (oWidth &gt;= oHeight &amp;&amp; newW &gt;= _transformWidth) {
    newW = _transformWidth;
  }

  <span class="hljs-keyword">final</span> TextStyle style = _getTextStyle(_currentElement!.textOptions!);
  <span class="hljs-keyword">final</span> (tempWidth, tempHeight) = TransformUtils.calculateTextSize(
    text: _currentElement!.textOptions!.text,
    style: style,
    maxWidth: newW,
  );

  _currentElement = _currentElement?.copyWith(
    elementWidth: newW,
    elementHeight: tempHeight,
    x: oX - (newW - oWidth) / <span class="hljs-number">2</span>,
    y: oY - (tempHeight - oHeight) / <span class="hljs-number">2</span>,
  );
  _onChange();
}
</code></pre>
<p>运行效果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/20381b3d80ea432c8bf64ad405ac9823~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767451521&amp;x-signature=k4NYzMkI7lU%2FQwO61AIKsspaaoA%3D" alt="image02.gif" loading="lazy"/></p>
<p>这样我们就实现了文本元素的拉伸效果。可以看到，随着功能的增加，可能就需要对之前的逻辑做更改，不过因为抽取了配置，很多地方就只需要加入少量的代码即可实现部分功能。</p>
<p>基础的功能差不多就完成了，接下来主功能就还有一个，那就是保存，我们不知道这个功能是否还存在编辑，如果不存在，直接将该结构转成图片返回即可，所以我们保存就直接将数据和图片都传递过去即可。一般这种大量数据存后端都是JSON字符串，所以我们直接转成json字符串存储：</p>
<pre><code class="hljs language-dart" lang="dart">Future&lt;<span class="hljs-keyword">void</span>&gt; _onSave() <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">if</span> (_isLoading) <span class="hljs-keyword">return</span>;
  _isLoading = <span class="hljs-keyword">true</span>;

  <span class="hljs-keyword">if</span> (_currentElement != <span class="hljs-keyword">null</span>) {
    setState(() {
      _currentElement = <span class="hljs-keyword">null</span>;
    });
  }

  <span class="hljs-keyword">if</span> (_currentElement == <span class="hljs-keyword">null</span>) {
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> imagePath = <span class="hljs-keyword">await</span> _getImagePath();
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;&gt; tempStringList = _elementList.map((item) =&gt; ElementModel.toJson(item)).toList();

    widget.onSave(imgSrc: imagePath, data: jsonEncode(tempStringList));

    _isLoading = <span class="hljs-keyword">false</span>;
  } <span class="hljs-keyword">else</span> {
    _isLoading = <span class="hljs-keyword">false</span>;
    _onSave();
  }
}
</code></pre>
<p>运行效果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/748f17a3018a49ba9d0ff1e5f5c2b255~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767451521&amp;x-signature=B6r1hNHSSOFgtXUEILCAwe5wbmg%3D" alt="image03.gif" loading="lazy"/></p>
<p>这样我们就简单实现了图片的生成，并且将数据转换成JSON字符串传递给后端保存，后续后端返回这个字符串再还原就可以进行编辑。这样就简单实现了基础的功能，后续就实现辅助的功能。</p>
<p>感兴趣的也可以关注我的微信公众号【前端学习小营地】，不定时会分享一些小功能～</p>
<p>好了，今天的分享到此结束，感谢阅读～拜拜～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[static 和 lib/assets资源区别]]></title>    <link>https://juejin.cn/post/7588149079417208886</link>    <guid>https://juejin.cn/post/7588149079417208886</guid>    <pubDate>2025-12-27T14:50:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588149079417208886" data-draft-id="7588149079417192502" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="static 和 lib/assets资源区别"/> <meta itemprop="keywords" content="前端,Svelte"/> <meta itemprop="datePublished" content="2025-12-27T14:50:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Robet"/> <meta itemprop="url" content="https://juejin.cn/user/193141028175320"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            static 和 lib/assets资源区别
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/193141028175320/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Robet
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T14:50:05.000Z" title="Sat Dec 27 2025 14:50:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是一个非常关键的问题！在 <strong>SvelteKit</strong> 项目中，<code>static/</code> 目录和 <code>src/lib/assets/</code>（或任何 <code>src/</code> 下的资源）处理方式<strong>完全不同</strong>，直接影响到：</p>
<ul>
<li>资源是否被 <strong>构建工具处理</strong></li>
<li>是否支持 <strong>哈希文件名（缓存优化）</strong></li>
<li>如何 <strong>引用资源路径</strong></li>
<li>是否能使用 <strong>ESM 导入语法</strong></li>
</ul>
<hr/>
<h2 data-id="heading-0">✅ 核心区别总结</h2>



































<table><thead><tr><th>特性</th><th><code>static/</code> 目录</th><th><code>src/lib/assets/</code>（或其他 <code>src/</code> 下）</th></tr></thead><tbody><tr><td><strong>是否经过 Vite 构建</strong></td><td>❌ 不处理，原样复制</td><td>✅ 会经过 Vite 处理（压缩、哈希、优化）</td></tr><tr><td><strong>输出位置</strong></td><td>直接复制到 <code>build/</code> 根目录</td><td>打包进 <code>build/_app/assets/...</code></td></tr><tr><td><strong>引用方式</strong></td><td>绝对路径 <code>/image.png</code></td><td>必须通过 <strong>ESM 导入</strong>：<code>import img from '$lib/assets/image.png'</code></td></tr><tr><td><strong>文件名哈希</strong></td><td>❌ 无（不利于长期缓存）</td><td>✅ 有（如 <code>image.abc123.png</code>，利于 CDN 缓存）</td></tr><tr><td><strong>适用场景</strong></td><td>robots.txt、favicon.ico、sitemap.xml 等<strong>静态 Web 资源</strong></td><td>应用内使用的图片、图标、字体等<strong>模块化资源</strong></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-1">🔍 详细解释</h2>
<h3 data-id="heading-2">1. <strong><code>static/</code> 目录 —— “纯静态 Web 根目录”</strong></h3>
<ul>
<li>
<p>SvelteKit 在构建时，会<strong>原封不动地将 <code>static/</code> 内容复制到输出目录（<code>build/</code>）的根部</strong>。</p>
</li>
<li>
<p>这些文件<strong>不会被 Vite 处理</strong>（不压缩、不重命名、不哈希）。</p>
</li>
<li>
<p>浏览器通过 <strong>绝对路径</strong> 访问：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 在 +layout.svelte 或 app.html 中 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"icon"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/favicon.ico"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/images/logo.png"</span> /&gt;</span>
</code></pre>
</li>
<li>
<p><strong>典型用途</strong>：</p>
<ul>
<li><code>favicon.ico</code></li>
<li><code>robots.txt</code></li>
<li><code>sitemap.xml</code></li>
<li>第三方验证文件（如 <code>google-site-verification=xxx.html</code>）</li>
<li>需要固定 URL 的公开资源</li>
</ul>
</li>
</ul>
<blockquote>
<p>⚠️ 如果你把应用内的图片放这里（如 <code>/static/product.jpg</code>），会导致：</p>
<ul>
<li>无法利用内容哈希 → 用户可能看到旧图（缓存问题）</li>
<li>无法 tree-shaking 未使用的图片</li>
<li>无法使用现代图像格式自动转换（如 WebP）</li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-3">2. <strong><code>src/lib/assets/</code> —— “模块化资源”</strong></h3>
<ul>
<li>
<p>这些文件被视为 <strong>JavaScript 模块依赖</strong>。</p>
</li>
<li>
<p>必须通过 <strong>ESM <code>import</code> 语句</strong> 引用：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 在 .svelte 或 .js 文件中 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">import</span> logo <span class="hljs-keyword">from</span> <span class="hljs-string">'$lib/assets/logo.png'</span>;
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">{logo}</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"Logo"</span> /&gt;</span>
</code></pre>
</li>
<li>
<p>Vite 会：</p>
<ul>
<li>为文件生成 <strong>唯一哈希名</strong>（如 <code>logo.a1b2c3.png</code>）</li>
<li>自动优化（压缩、转 WebP 等，需配置）</li>
<li>只打包<strong>实际被引用的资源</strong></li>
<li>支持动态 <code>import()</code>（按需加载）</li>
</ul>
</li>
<li>
<p>输出路径示例：</p>
<pre><code class="hljs">build/
└── _app/
    └── assets/
        └── logo.a1b2c3.png
</code></pre>
</li>
</ul>
<blockquote>
<p>✅ <strong>这是 SvelteKit 推荐的应用内资源管理方式！</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-4">🧪 对比示例</h2>
<h3 data-id="heading-5">场景：在页面中显示一张 logo</h3>
<h4 data-id="heading-6">❌ 错误做法（把应用图片放 static）</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- src/routes/+page.svelte --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/logo.png"</span> /&gt;</span>  <span class="hljs-comment">&lt;!-- 来自 static/logo.png --&gt;</span>
</code></pre>
<ul>
<li>问题：URL 固定为 <code>/logo.png</code>，浏览器缓存后更新困难。</li>
</ul>
<h4 data-id="heading-7">✅ 正确做法（用 <code>$lib/assets/</code>）</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- src/routes/+page.svelte --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">import</span> logo <span class="hljs-keyword">from</span> <span class="hljs-string">'$lib/assets/logo.png'</span>;
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">{logo}</span> /&gt;</span>
</code></pre>
<ul>
<li>渲染结果：<code>&lt;img src="/_app/assets/logo.a1b2c3.png" /&gt;</code></li>
<li>优势：文件名含哈希，更新即失效缓存，CDN 友好。</li>
</ul>
<hr/>
<h2 data-id="heading-8">📁 推荐目录结构</h2>
<pre><code class="hljs language-scss" lang="scss">project/
├── static/
│   ├── favicon<span class="hljs-selector-class">.ico</span>        ← 必须放这里（浏览器固定请求 /favicon<span class="hljs-selector-class">.ico</span>）
│   ├── robots<span class="hljs-selector-class">.txt</span>         ← 必须放这里
│   └── vercel<span class="hljs-selector-class">.svg</span>         ← 第三方验证文件
└── <span class="hljs-attribute">src</span>/
    └── lib/
        └── assets/
            ├── images/
            │   ├── logo<span class="hljs-selector-class">.png</span>
            │   └── hero<span class="hljs-selector-class">.jpg</span>
            └── icons/
                └── star<span class="hljs-selector-class">.svg</span>
</code></pre>
<hr/>
<h2 data-id="heading-9">💡 特殊情况：什么时候用 <code>static/</code> 存图片？</h2>
<p>仅当你<strong>需要固定 URL 且不希望被构建工具处理</strong>时，例如：</p>
<ul>
<li>一个公开的分享图，URL 必须是 <code>https://yoursite.com/share-banner.jpg</code></li>
<li>第三方平台要求特定路径的图片（如微信公众号素材）</li>
<li>非常大的背景图，不想被打包（但通常仍建议用 ESM + 动态导入）</li>
</ul>
<p>否则，<strong>一律使用 <code>$lib/assets/</code> + <code>import</code></strong>。</p>
<hr/>
<h2 data-id="heading-10">✅ 总结一句话</h2>
<blockquote>
<p><strong><code>static/</code> 是给“Web 服务器”看的静态文件；<br/>
<code>src/lib/assets/</code> 是给“你的应用代码”用的模块化资源。</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别重复传参！用柯里化提升代码优雅度]]></title>    <link>https://juejin.cn/post/7588146449005838372</link>    <guid>https://juejin.cn/post/7588146449005838372</guid>    <pubDate>2025-12-27T15:54:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588146449005838372" data-draft-id="7588191506606129158" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别重复传参！用柯里化提升代码优雅度"/> <meta itemprop="keywords" content="JavaScript,面试,前端"/> <meta itemprop="datePublished" content="2025-12-27T15:54:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鱼鱼块"/> <meta itemprop="url" content="https://juejin.cn/user/4302802432307224"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别重复传参！用柯里化提升代码优雅度
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4302802432307224/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鱼鱼块
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T15:54:39.000Z" title="Sat Dec 27 2025 15:54:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">柯里化：让函数“慢慢来”，一次只吃一口</h2>
<p>在编程世界里，我们常常会遇到这样一种场景：一个函数需要多个参数才能完成任务。但有时候，这些参数并不会一下子全部准备好——可能今天知道第一个，明天拿到第二个，后天才凑齐全部。</p>
<p>这时候，<strong>柯里化（Currying）</strong> 就派上用场了。它就像一位耐心的厨师，不急着把整道菜做完，而是先记住你已经给的食材，等你把剩下的材料陆续送来，再一锅炒好。</p>
<hr/>
<h3 data-id="heading-1">从最简单的加法说起</h3>
<p>假设我们有一个普通的加法函数：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>) {
  <span class="hljs-keyword">return</span> a + b;
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)); <span class="hljs-comment">// 输出 3</span>
</code></pre>
<p>这很直接：两个数一起传进去，立刻出结果。但如果我只能先给你 <code>a</code>，过一会儿再告诉你 <code>b</code> 呢？普通函数就无能为力了。</p>
<p>于是我们可以手动“柯里化”一下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">b</span>) {
    <span class="hljs-keyword">return</span> a + b;
  };
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>)(<span class="hljs-number">2</span>)); <span class="hljs-comment">// 输出 3</span>
</code></pre>
<p>你看，现在 <code>add(1)</code> 返回的是一个新函数，这个函数“记得”了 <code>a = 1</code>，等你再调用它传入 <code>b</code>，就能算出结果。这背后靠的是 <strong>闭包</strong>——内部函数可以“记住”外部函数的变量，即使外部函数已经执行完了。</p>
<p>这种写法虽然可行，但只适用于固定两个参数的情况。如果函数有三个、四个甚至更多参数，手动嵌套写起来会非常繁琐，而且难以复用</p>
<hr/>
<h3 data-id="heading-2">自动柯里化：通用解决方案</h3>
<p>手动为每个函数写柯里化版本太麻烦了。有没有办法写一个“万能工具”，自动把任意多参函数变成可逐步传参的形式？</p>
<p>当然有！来看这个通用的 <code>curry</code> 函数：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b, c, d</span>) {
  <span class="hljs-keyword">return</span> a + b + c + d;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">curry</span>(<span class="hljs-params">fn</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">curried</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">if</span> (args.<span class="hljs-property">length</span> &gt;= fn.<span class="hljs-property">length</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">fn</span>(...args); <span class="hljs-comment">// 参数够了，直接执行</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">...rest</span>) =&gt;</span> <span class="hljs-title function_">curried</span>(...args, ...rest); <span class="hljs-comment">// 不够？继续收</span>
  };
}

<span class="hljs-keyword">const</span> curriedAdd = <span class="hljs-title function_">curry</span>(add);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">curriedAdd</span>(<span class="hljs-number">1</span>)(<span class="hljs-number">2</span>)(<span class="hljs-number">3</span>)(<span class="hljs-number">4</span>)); <span class="hljs-comment">// 10</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">curriedAdd</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>)); <span class="hljs-comment">// 10，也可以一次传多个</span>
</code></pre>
<h4 data-id="heading-3">它是怎么工作的？</h4>
<ul>
<li><code>fn.length</code> 是 JavaScript 中函数的一个属性，表示该函数<strong>声明时定义的参数个数</strong>（不包括剩余参数）。</li>
<li>每次调用 <code>curried</code>，都会收集当前传入的参数（通过 <code>...args</code>）。</li>
<li>如果当前参数数量 ≥ 原函数所需参数数量，就立即执行 <code>fn(...args)</code>。</li>
<li>否则，返回一个新函数，这个新函数会把已有的 <code>args</code> 和后续传入的 <code>rest</code> 合并，再次调用 <code>curried</code> —— 这就是递归的思想。</li>
</ul>
<p>只要收集到足够数量的参数，就立刻执行；否则，返回一个新函数继续等待。</p>
<blockquote>
<p>🔍 <strong>注意</strong>：这个实现利用了 <strong>闭包 + 递归</strong> 的思想。每次调用都把已有的参数“存起来”，直到攒够为止。而闭包保证了这些中间参数不会丢失。</p>
</blockquote>
<hr/>
<h3 data-id="heading-4">实战：日志函数的柯里化妙用</h3>
<p>柯里化不只是炫技，它在实际开发中非常有用。比如处理日志：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">log</span> = type =&gt; <span class="hljs-function"><span class="hljs-params">message</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${type}</span>: <span class="hljs-subst">${message}</span>`</span>);
};

<span class="hljs-keyword">const</span> errorLog = <span class="hljs-title function_">log</span>(<span class="hljs-string">'ERROR'</span>);
<span class="hljs-keyword">const</span> infoLog = <span class="hljs-title function_">log</span>(<span class="hljs-string">'info'</span>);

<span class="hljs-title function_">errorLog</span>(<span class="hljs-string">'接口异常'</span>);        <span class="hljs-comment">// 输出: ERROR: 接口异常</span>
<span class="hljs-title function_">infoLog</span>(<span class="hljs-string">'页面加载完成'</span>);     <span class="hljs-comment">// 输出: info: 页面加载完成</span>
</code></pre>
<p>这里，<code>log</code> 是一个柯里化函数。我们先固定日志类型（如 <code>'ERROR'</code>），得到一个专门打错误日志的函数 <code>errorLog</code>。以后只要传消息内容就行，不用每次都写类型。</p>
<h4 data-id="heading-5">优势在哪里？</h4>
<ol>
<li><strong>减少重复代码</strong>：不需要每次写 <code>log('error', 'xxx')</code>。</li>
<li><strong>提高可读性</strong>：<code>errorLog('xxx')</code> 比 <code>log('error', 'xxx')</code> 更直观。</li>
<li><strong>便于组合与复用</strong>：可以轻松创建不同级别的日志器，并在多个模块中共享。</li>
</ol>
<hr/>
<h3 data-id="heading-6">总结：柯里化的三大核心</h3>
<ol>
<li><strong>闭包</strong>：保存已传入的参数，不会被垃圾回收。</li>
<li><strong>递归/链式调用</strong>：每次返回新函数，继续接收剩余参数。</li>
<li><strong>退出条件</strong>：当参数数量达到原函数要求（<code>fn.length</code>），就执行并返回结果。</li>
</ol>
<p>柯里化不是必须用的技术，但它能让你的函数更灵活、更具组合性。就像乐高积木——你可以先拼好一部分，等需要时再接上其他模块，最终搭出完整作品。</p>
<p>下次当你发现某个函数总是在不同地方传相同的前几个参数时，不妨试试柯里化——让函数学会“等一等”，说不定代码会变得更优雅！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI Agents]]></title>    <link>https://juejin.cn/post/7588042910198038578</link>    <guid>https://juejin.cn/post/7588042910198038578</guid>    <pubDate>2025-12-27T10:35:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588042910198038578" data-draft-id="7536182225327718442" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI Agents"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-27T10:35:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="昭牧De碎碎念"/> <meta itemprop="url" content="https://juejin.cn/user/2718458506388391"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI Agents
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2718458506388391/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    昭牧De碎碎念
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T10:35:56.000Z" title="Sat Dec 27 2025 10:35:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">AI Agent 定义、原理</h2>
<blockquote>
<p>先抓住核心原理、定义和关键特征，避免被细节淹没。</p>
</blockquote>
<h3 data-id="heading-1">发展历史</h3>
<p>AI Agent 不是某一个人在某一刻发明的专利概念，而是几十年里随着人工智能领域的发展逐渐演变，由行业总结出来的</p>

























<table><thead><tr><th>时间</th><th>事件/人物</th><th>贡献</th></tr></thead><tbody><tr><td>1960s-1990s</td><td>人工智能研究发展，产生自动推理、专家系统、智能机器人、机器学习等研究方向。具有代表性的是 ELIZA，ELIZA 通过"关键词匹配"+"模版替换"的方式，将用户陈述转化为问题，引导对话延续来模拟心理治疗师。        <a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FELIZA" target="_blank" title="https://en.wikipedia.org/wiki/ELIZA" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53cefc04bc5742d49bf308c67fe1c845~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pit54mnRGXnoo7noo7lv7U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767436556&amp;x-signature=fYbT99B3iSSRvdvs4LDBguiFW9g%3D" alt="image.png" loading="lazy"/></a></td><td>虽无真正的智能，却用最简单的技术对智能作出了探索</td></tr><tr><td>1995年</td><td>《 Artificial Intelligence: A Modern Approach 》出版 ，统一了 AI 研究方向，无论符号主义、连接主义还是概率方法，最终都可归为，设计理性智能体（Rational Agent）的不同实现方式。<a href="https://link.juejin.cn?target=https%3A%2F%2Fpeople.eecs.berkeley.edu%2F~russell%2Faima1e%2Fchapter02.pdf" target="_blank" title="https://people.eecs.berkeley.edu/~russell/aima1e/chapter02.pdf" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe802f6aa71849178b105caeb2c0f8b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pit54mnRGXnoo7noo7lv7U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767436556&amp;x-signature=tsXns2DYUxldtEtuNGmdMNQ%2BoSE%3D" alt="image.png" loading="lazy"/></a></td><td>提出 Agent 的经典定义，通过感知环境、自主决策并执行行动以最大化目标达成的实体</td></tr><tr><td>2020年代</td><td>OpenAI、Google DeepMind、Anthropic 等公司根据行业实践和研究逐步总结出来 AI Agent 的定义 <a href="https://link.juejin.cn?target=https%3A%2F%2Fbytebytego.com%2Fguides%2Fwhat-is-an-ai-agent%2F" target="_blank" title="https://bytebytego.com/guides/what-is-an-ai-agent/" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c9da32a871341a8b3df0e809ff5b293~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pit54mnRGXnoo7noo7lv7U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767436556&amp;x-signature=qXJmzR2xqPwtutT1Bkrq7PpUVVk%3D" alt="image.png" loading="lazy"/></a></td><td>基于 AI 的快速发展，和已有的 Agent 概念，总结出 AI Agent</td></tr></tbody></table>
<h3 data-id="heading-2">定义</h3>
<p>AI Agent 是一个能让 <strong>大模型（LLM）</strong> 通过 <strong>访问工具（Access To Tools）</strong> 、<strong>记忆和知识（Memory Knowledge）</strong> ，去 <strong>执行操作（Perform Actions）</strong> 的系统。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2Fai-agents-for-beginners%2Fblob%2Fmain%2F01-intro-to-ai-agents%2FREADME.md" target="_blank" title="https://github.com/microsoft/ai-agents-for-beginners/blob/main/01-intro-to-ai-agents/README.md" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3eaaaae77faa43f386c02abbc63fc572~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pit54mnRGXnoo7noo7lv7U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767436556&amp;x-signature=jQqEwqGRaQij1FDlslvJn9iv6hw%3D" alt="image.png" loading="lazy"/></a></p>
<ul>
<li>
<p><strong>LLM Large Language Model</strong>，大语言模型，例如 GPT-4、Claude、Gemini。Agent 的概念在 LLM 诞生之前就已经存在，使用 LLM 去构建 AI Agent 的优势在于，LLM 能更好的理解和解释人类语言。</p>
</li>
<li>
<p><strong>访问工具(Access To Tools)</strong> 访问工具是指 AI Agent 被授予使用外部资源或功能的能力。例如：</p>
<ul>
<li>知识获取类：如浏览器、搜索引擎、数据库查询器等，用于获取信息</li>
<li>行为执行类：如 API 调用、电子邮件发送、表单填写等，用于让 Agent 对外部环境产生影响</li>
</ul>
</li>
</ul>
<p>LLM 可以访问哪些工具由 AI Agent 开发者 显示添加/定义。假设是个旅游 AI Agent，这个 AI Agent 允许在携程的预定系统中，那开发者就需要在初始化Agent时，通过声明 tools 的描述、参数结构，将访问航班信息的工具注册给LLM。LLM 根据用户输入内容与 tools 描述的匹配程度，判断是否需要生成 req 调用这个 tools。</p>
<ul>
<li><strong>执行操作(Perform Actions)</strong>。如果没有 AI Agent 这个系统，LLM 只能基于用户给的 prompt 生成内容。有了 AI Agent 后，LLM 就可以基于对用户请求的理解，去使用环节中可用的工具完成任务。</li>
</ul>
<blockquote>
<p>Perform Actions 指的是决策并使用工具执行具体操作的过程，在 LangChain 等框架中，对应AgentExecutor的接口定义，由 Agents 框架 结合 Tools 机制直接实现，没有单独定义模块名。</p>
</blockquote>
<ul>
<li>
<p><strong>记忆和知识(Memory+Knowledge)</strong></p>
<ul>
<li>记忆(Memory)是 Agent 在和用户交互过程中所记住的内容，如:上下文信息，过去的经验等，偏个性化。比如，用户在旅游 AI Agent 期望的出行时间、出行地点。</li>
<li>知识(Knowledge)是用户在当前 AI Agent 环境以外能获取的信息。比如，今年夏季由于北京多雨，到北京旅游人倾向于博物馆等室内活动而不是户外活动。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-3">类比</h3>
<blockquote>
<p>用类比加速理解</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ecc3b7e9b7ac4d5397cbf2e0a2c3222d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pit54mnRGXnoo7noo7lv7U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767436556&amp;x-signature=g5EdkeELh6rfNQGdgfLCGu9X1bk%3D" alt="image.png" loading="lazy"/></p>
<p>可以将 Agent 类比为 PC 电脑，一开始有了 CPU 不够，大多数人没法直接用 CPU 加法器和减法器完成任务，需要很多的外围设备+操作系统才能搭建出给人能使用的工具</p>
<p>可以把 Agent 类比为一台 PC。一开始只有 CPU（对应 LLM），还远远不够。大多数用户并不会直接操控 CPU 的加法器或减法器来完成任务——他们依赖操作系统进行任务调度，依靠工具接口调用外部服务，还要依赖不同层级的存储（如 RAM、硬盘）来支撑流程。类似地，AI Agent 也无法仅靠 LLM。它需要：</p>
<ul>
<li>一个 <strong>规划模块（Planner）</strong> 来拆解与调度任务。类似于操作系统，调度资源、加载程序、管理内存；</li>
<li>多层次的 <strong>内存（Memory）</strong> ，包括短期记忆、工作记忆 scratchpad 和长期记忆，来管理上下文与持久知识。类似于 RAM + 硬盘存储架构，提供不同持久性和访问速度；</li>
<li>各种 <strong>工具（Tools）</strong> ，包括各类插件、外部 API、数据库等，才能完成具体操作，类似于电脑通过网线、USB访问外设或外部资源。</li>
</ul>
<h3 data-id="heading-4">涉及的技术</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.bytebytego.com%2Fp%2Fep169-rag-vs-agentic-rag" target="_blank" title="https://blog.bytebytego.com/p/ep169-rag-vs-agentic-rag" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2378dc506bed46b59fb7820479a9914a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pit54mnRGXnoo7noo7lv7U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767436556&amp;x-signature=GRrJlubBCA8eHwIrN1sx1%2B6wsfU%3D" alt="image.png" loading="lazy"/></a></p>
<p>LLM 出现后，为了解决LLM几个天然的问题，诞生了 RAG、CoT、Function Calling、ReAct、Long term 等的技术，最终这些技术都被归纳到了 Tools、Plan、Memory 这几个模块。</p>



































<table><thead><tr><th>问题</th><th>原因</th><th>解决办法</th></tr></thead><tbody><tr><td>无实时信息</td><td>LLM 的知识来自训练语料，是静态的、过去的。训练完成后，除非重新训练，否则它不会更新认知。新的法律、政策、新闻，用户私有文档，它都不知道</td><td>引入 RAG（2020年） <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fshorts%2F4jYZg6pkXyc" target="_blank" title="https://www.youtube.com/shorts/4jYZg6pkXyc" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/942a358b2d3b4fa5bf087758390af756~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pit54mnRGXnoo7noo7lv7U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767436556&amp;x-signature=0sXu3M1BLcxG14Xip49yh4DV2iY%3D" alt="image.png" loading="lazy"/></a></td></tr><tr><td>逻辑推理能力不佳</td><td>LLM 的核心机制是基于训练集中的学习到的模式预测下一词，而不是理解问题背后的概念或结构，更不存在逻辑推理能力，不能完成需要精确计算或复杂计算/推理的任务。如: 数学题</td><td>引入 CoT（2022年），帮助 LLM 在多个中间步骤间维持连贯逻辑，提高准确率 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgonzoml.substack.com%2Fp%2Fchain-of-thought-tree-of-thought" target="_blank" title="https://gonzoml.substack.com/p/chain-of-thought-tree-of-thought" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76a3f7b7e8754aa79eb24732ace48427~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pit54mnRGXnoo7noo7lv7U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767436556&amp;x-signature=aUGSB41OkzjfqYIeeijluxpCee4%3D" alt="image.png" loading="lazy"/></a></td></tr><tr><td>无行动能力</td><td>只能输出文字，不能真正去访问工具、执行操作</td><td>引入 Function Calling（2023年）-   2023 年 6 月 13 日，OpenAI 发布了题为 “Function calling and other API updates” 的公告，宣布推出新的 function calling 功能，允许开发者向模型描述函数，并让模型在合适的时候输出一个 JSON 格式的函数调用参数。 <a href="https://link.juejin.cn?target=https%3A%2F%2Fzilliz.com%2Fblog%2Ffunction-calling-vs-mcp-vs-a2a-developers-guide-to-ai-agent-protocols" target="_blank" title="https://zilliz.com/blog/function-calling-vs-mcp-vs-a2a-developers-guide-to-ai-agent-protocols" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d7fe1f68ccd49a28a38127cbf93ba7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pit54mnRGXnoo7noo7lv7U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767436556&amp;x-signature=krEkk1E8xteGByWU0RjiJOp8ACE%3D" alt="image.png" loading="lazy"/></a></td></tr><tr><td>推理孤立（Reasoning Only）难以纠正</td><td>单纯依赖 Chain-of-Thought 推理，会随着多步推理累积错误，造成误导或最终结果出错，且难以纠正。</td><td>引入 ReAct（2023年），通过 Reasoning + Action 循环交替（Thought → Action → Observation → Thought…）在推理过程中更新计划，处理异常，并借助观察修正路径 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.philschmid.de%2Flanggraph-gemini-2-5-react-agent" target="_blank" title="https://www.philschmid.de/langgraph-gemini-2-5-react-agent" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/678a0c9dedad4031ab0212369311a116~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pit54mnRGXnoo7noo7lv7U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767436556&amp;x-signature=j873XmrCudvDd5%2FygzkAqMrw2qw%3D" alt="image.png" loading="lazy"/></a></td></tr><tr><td>上下文只能保留有限token</td><td>LLM 的上下文窗口有严格上限，即便如今某些模型已支持到百万 token，都意味着信息量依然受到限制。在多轮对话或长任务中，老旧或不重要的信息往往被截断或遗忘，导致连贯性和整体理解能力下降</td><td>引入 Long-Term Memory(2023年)， "<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F%2F2306.07174" target="_blank" title="https://arxiv.org/abs//2306.07174" ref="nofollow noopener noreferrer">Augmenting Language Models with Long-Term Memory</a>"</td></tr></tbody></table>
<h3 data-id="heading-5">实现拆解</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flilianweng.github.io%2Fposts%2F2023-06-23-agent%2F%3Futm_source%3Dchatgpt.com%23scientific-discovery-agent" target="_blank" title="https://lilianweng.github.io/posts/2023-06-23-agent/?utm_source=chatgpt.com#scientific-discovery-agent" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a76ad40a9f474d63914b77051b3ae9ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pit54mnRGXnoo7noo7lv7U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767436556&amp;x-signature=zcJ2qyijsIpSel%2FEOBc8fK6yas0%3D" alt="image.png" loading="lazy"/></a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fnewsletter.maartengrootendorst.com%2Fp%2Fa-visual-guide-to-llm-agents" target="_blank" title="https://newsletter.maartengrootendorst.com/p/a-visual-guide-to-llm-agents" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49cba25fa2914992b7af28d0c871dbe3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pit54mnRGXnoo7noo7lv7U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767436556&amp;x-signature=ooidQ7HF%2FKvGgO1mh0XHSfzxk8g%3D" alt="image.png" loading="lazy"/></a></p>
<h4 data-id="heading-6">Tools</h4>
<p><strong>Tools的定义</strong></p>
<p>Tools 是一种抽象，将一个函数（或其他实现）包装成LLM 可以调用的对象，其中包含名称、描述（用于提示模型）以及输入参数的 JSON schema 描述</p>
<p><strong>Tools 在 Agent 的使用</strong></p>
<ul>
<li>Agent 会根据 Tools 提供的名称、描述和参数 schema，拼进prompt 内，通过 prompt 让 LLM 知道何时可以调用哪个工具</li>
</ul>
<pre><code class="hljs language-python" lang="python">    Tool(
        name=<span class="hljs-string">"Calculator"</span>,
        func=calculator_function,
        description=<span class="hljs-string">"Use this tool to perform calculations."</span>
    )
</code></pre>
<p>在 LLM 生成结果时，如果 LLM 认为某个工具的调用是必要的，会在结果中包含一个 tool_calls 字段，指示需要调用的工具及其参数。这个结构化的输出使得 Agent 能够准确地解析工具调用，并执行相应的操作。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"tool_calls"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"call_1"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"function"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"{\"a\": 2, \"b\": 3}"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"multiply"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"function"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li>Agent 分析 LLM 生成的内容，如果需要使用 Tool，则调用具体的 Tool 并将结果反馈给模型，形成“模型→工具→模型”的循环结构。</li>
</ul>
<p>当 Agent 决定需要调用某个 Tool 时，它会生成一个结构化的 ToolCall 对象。该对象包含：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>

  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"multiply"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"a"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"b"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"call_1"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tool_call"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>Agent 执行 Tool 并获取结果</p>
<pre><code class="hljs language-python" lang="python">tool_output = multiply.invoke({<span class="hljs-string">"a"</span>: <span class="hljs-number">2</span>, <span class="hljs-string">"b"</span>: <span class="hljs-number">3</span>})
</code></pre>
<p>Agent 将 Tool 结果反馈给 LLM</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># tool_output 结果为 </span>
tool_message = ToolMessage(
    content=<span class="hljs-string">"The result is 42."</span>,
    tool_call_id=<span class="hljs-string">"call_1"</span>
)

<span class="hljs-comment"># 假设 chat_history 是一个短期记忆的实例，更新对话历史, 支持LLM多轮对话时可以利用之前的 tool 结果，避免重复调用</span>
chat_history.add_messages([tool_message])

<span class="hljs-comment"># 假设 user_input 是用户的输入</span>
messages = [
    (<span class="hljs-string">"human"</span>, user_input),
    (<span class="hljs-string">"tool"</span>, tool_message.content)
]

<span class="hljs-comment"># 将 tool 的输出作为上下文信息提供给 LLM，生成最终的结果</span>
ai_message = llm_with_tools.invoke(messages)
</code></pre>
<h4 data-id="heading-7">Planning</h4>
<p>Planning 是指让 LLM 具备分解复杂任务、规划执行步骤、动态调整策略的能力，以解决需要多步推理或多工具协作的复杂问题。模拟了人类解决问题时，拆分目标-&gt;制定步骤-&gt;执行调整的思维过程。</p>
<p>Planning的实现有三种</p>
<ol>
<li>提示词（Prompt-based）
通过精心设计的提示词引导 LLM 自主完成任务拆解和步骤规划，适用于逻辑相对固定、无需复杂工具调用的场景。</li>
<li>Chain 结构化规划
通过 链（Chain） 将多个子任务按固定流程串联，适用于步骤明确、依赖关系固定的场景，本质是硬编码规划。预先定义子任务的执行顺序（如: 数据采集-&gt;清洗-&gt;分析-&gt;输出），用 Chain 组件将每个步骤的输入输出衔接，形成流水线式规划。</li>
<li>Agent 动态规划
Agent 自主拆解任务、调整步骤、执行工具以完成复杂目标。具体实现方式有 ReAct(思考Reason-&gt;行动Act-&gt;观察Observe)、Plan and Execute、Self Reflective</li>
</ol>
<p>小思考:</p>
<ul>
<li>Agent如何从失败Plan中学习经验?</li>
<li>CoT 和 WorkFlow 的关系是什么?</li>
</ul>
<h4 data-id="heading-8">Memory</h4>
<p>Memory 支撑 Agent 实现上下文感知、历史经验复用、长期决策连贯性。
不同类型的 Memory 对应不同的应用场景，其实现方案差异显著。最经典的分类方式是按时间跨度划分：</p>























<table><thead><tr><th>类型</th><th>核心场景</th><th>数据特点</th><th>存储周期</th></tr></thead><tbody><tr><td><strong>短期记忆（STM）</strong></td><td>会话内交互、实时决策</td><td>数据量小、时效性强、完整度高</td><td>单次会话 / 分钟级</td></tr><tr><td><strong>长期记忆（LTM）</strong></td><td>跨会话复用、经验积累</td><td>数据量大、需提炼、长期有效</td><td>跨会话 / 永久级</td></tr></tbody></table>
<p><strong>短期记忆（STM）实现</strong></p>
<p>用队列（deque）实现，限制最大长度（避免内存溢出）</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> deque

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ShortTermMemory</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, max_length=<span class="hljs-number">10</span></span>):
        self.memory = deque(maxlen=max_length)  <span class="hljs-comment"># 固定长度队列，自动FIFO</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">store</span>(<span class="hljs-params">self, content, source</span>):
        <span class="hljs-string">"""存储新的会话信息"""</span>
        entry = {
            <span class="hljs-string">"entry_id"</span>: <span class="hljs-string">f"stm-<span class="hljs-subst">{<span class="hljs-built_in">len</span>(self.memory)}</span>"</span>,
            <span class="hljs-string">"content"</span>: content,
            <span class="hljs-string">"metadata"</span>: {<span class="hljs-string">"source"</span>: source, <span class="hljs-string">"timestamp"</span>: self._get_current_time()}
        }
        self.memory.append(entry)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">retrieve_all</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""检索所有短期记忆（用于当前会话决策）"""</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">list</span>(self.memory)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_current_time</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">import</span> datetime
        <span class="hljs-keyword">return</span> datetime.datetime.now().strftime(<span class="hljs-string">"%Y-%m-%d %H:%M:%S"</span>)
</code></pre>
<p><strong>长期记忆（LTM）实现</strong></p>
<p>采用 SQLite 存元数据 + FAISS 存向量 的混合方案，支持语义检索</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> sqlite3
<span class="hljs-keyword">import</span> faiss
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">from</span> sentence_transformers <span class="hljs-keyword">import</span> SentenceTransformer

<span class="hljs-comment"># 1. 初始化 Embedding 模型（用于生成内容向量）</span>
emb_model = SentenceTransformer(<span class="hljs-string">'all-MiniLM-L6-v2'</span>)
emb_dim = <span class="hljs-number">384</span>  <span class="hljs-comment"># all-MiniLM-L6-v2 的输出维度</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">LongTermMemory</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, db_path=<span class="hljs-string">"ltm.db"</span>, faiss_index_path=<span class="hljs-string">"ltm_index.faiss"</span></span>):
        <span class="hljs-comment"># 初始化 SQLite 数据库（存元数据）</span>
        self.conn = sqlite3.connect(db_path)
        self._create_table()
        <span class="hljs-comment"># 初始化 FAISS 索引（存向量）</span>
        self.faiss_index = self._load_faiss_index(faiss_index_path)
        self.faiss_index_path = faiss_index_path
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_create_table</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""创建元数据表"""</span>
        cursor = self.conn.cursor()
        cursor.execute(<span class="hljs-string">'''
            CREATE TABLE IF NOT EXISTS memory_entries (
                entry_id TEXT PRIMARY KEY,
                content TEXT,
                memory_type TEXT,
                timestamp TEXT,
                source TEXT,
                relevance_score REAL
            )
        '''</span>)
        self.conn.commit()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_load_faiss_index</span>(<span class="hljs-params">self, path</span>):
        <span class="hljs-string">"""加载或创建 FAISS 索引"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">return</span> faiss.read_index(path)
        <span class="hljs-keyword">except</span>:
            index = faiss.IndexFlatL2(emb_dim)  <span class="hljs-comment"># 简单的L2距离索引（适合小数据）</span>
            faiss.write_index(index, path)
            <span class="hljs-keyword">return</span> index
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">store</span>(<span class="hljs-params">self, content, memory_type, source, relevance_score=<span class="hljs-number">0.5</span></span>):
        <span class="hljs-string">"""存储长期记忆（元数据→SQLite，向量→FAISS）"""</span>
        <span class="hljs-comment"># 生成 Entry ID 和向量</span>
        entry_id = <span class="hljs-string">f"ltm-<span class="hljs-subst">{self._get_next_id()}</span>"</span>
        embedding = emb_model.encode([content])[<span class="hljs-number">0</span>].astype(np.float32)
        
        <span class="hljs-comment"># 1. 存入 SQLite</span>
        cursor = self.conn.cursor()
        cursor.execute(INSERT INTO memory_entries)
        self.conn.commit()
        
        <span class="hljs-comment"># 2. 存入 FAISS（需将向量添加到索引，并用ID映射）</span>
        self.faiss_index.add(np.array([embedding]))
        faiss.write_index(self.faiss_index, self.faiss_index_path)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">retrieve_semantic</span>(<span class="hljs-params">self, query, top_k=<span class="hljs-number">3</span></span>):
        <span class="hljs-string">"""语义检索：找和 query 最相关的 top_k 条记忆"""</span>
        <span class="hljs-comment"># 1. 生成查询向量</span>
        query_emb = emb_model.encode([query])[<span class="hljs-number">0</span>].astype(np.float32)
        <span class="hljs-comment"># 2. FAISS 检索（返回距离和索引）</span>
        distances, indices = self.faiss_index.search(np.array([query_emb]), top_k)
        <span class="hljs-comment"># 3. 从 SQLite 中获取对应元数据</span>
        cursor = self.conn.cursor()
        results = []
        <span class="hljs-keyword">for</span> idx, dist <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(indices[<span class="hljs-number">0</span>], distances[<span class="hljs-number">0</span>]):
            <span class="hljs-comment"># 假设 FAISS 索引的 idx 与 SQLite 的 entry_id 按顺序对应（简化处理）</span>
            entry_id = <span class="hljs-string">f"ltm-<span class="hljs-subst">{idx+<span class="hljs-number">1</span>}</span>"</span>  <span class="hljs-comment"># 需根据实际ID映射调整</span>
            cursor.execute(<span class="hljs-string">'SELECT * FROM memory_entries WHERE entry_id = ?'</span>, (entry_id,))
            entry = cursor.fetchone()
            <span class="hljs-keyword">if</span> entry:
                results.append({
                    <span class="hljs-string">"entry_id"</span>: entry[<span class="hljs-number">0</span>],
                    <span class="hljs-string">"content"</span>: entry[<span class="hljs-number">1</span>],
                    <span class="hljs-string">"similarity"</span>: <span class="hljs-number">1</span> - dist/<span class="hljs-number">2</span>  <span class="hljs-comment"># 将L2距离转为相似度（0~1）</span>
                })
        <span class="hljs-keyword">return</span> results
</code></pre>
<h3 data-id="heading-9">小思考</h3>
<ul>
<li>AI Agent 的定义这么宽泛，是否所有的AI应用都是 AI Agent，包括对话机器人</li>
</ul>
<h2 data-id="heading-10">Agent 架构&amp;&amp;流程图</h2>
<h3 data-id="heading-11">常见 Agent 架构</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fk7v4GMrutHRuTzliZwFH1A" target="_blank" title="https://mp.weixin.qq.com/s/k7v4GMrutHRuTzliZwFH1A" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/k7v4GMrut…</a></p>
<ul>
<li>反思模式（Reflection Pattern）</li>
<li>工具模式（Tool Use Pattern）</li>
<li>ReAct 推理与行动模式（Reasoning &amp; Acting）</li>
<li>规划模式（Planning Pattern）</li>
<li>多智能体模式（Multi - agent Pattern）</li>
</ul>
<h3 data-id="heading-12">AI Agent 时序图</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmedium.com%2Faingineer%2Fa-comprehensive-reference-guide-to-building-agentic-ai-systems-823319cb282a" target="_blank" title="https://medium.com/aingineer/a-comprehensive-reference-guide-to-building-agentic-ai-systems-823319cb282a" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5631250996941d2869a3884e8e8e3b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pit54mnRGXnoo7noo7lv7U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767436556&amp;x-signature=ml99M6yUfIbuKCHUr2l8RT%2BVa9Q%3D" alt="image.png" loading="lazy"/></a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Sidecar不就是在Pod里多跑一个容器吗！]]></title>    <link>https://juejin.cn/post/7588146449005445156</link>    <guid>https://juejin.cn/post/7588146449005445156</guid>    <pubDate>2025-12-27T11:15:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588146449005445156" data-draft-id="7588149079416750134" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Sidecar不就是在Pod里多跑一个容器吗！"/> <meta itemprop="keywords" content="Linux,Kubernetes"/> <meta itemprop="datePublished" content="2025-12-27T11:15:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ydswin"/> <meta itemprop="url" content="https://juejin.cn/user/536217403032472"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Sidecar不就是在Pod里多跑一个容器吗！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/536217403032472/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ydswin
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T11:15:18.000Z" title="Sat Dec 27 2025 11:15:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>深入理解云原生时代的核心设计模式</p>
</blockquote>
<p>乍看之下，Sidecar 模式确实只是在 Pod 里多运行一个容器而已。但这种表面理解，就像说“互联网不过是一堆电缆和服务器”一样，忽略了其背后的精妙设计思想和革命性价值。今天，我们就来深入探讨这个看似简单却极具威力的云原生核心模式。</p>
<h2 data-id="heading-0">从一个认知误区说起</h2>
<p><strong>"Pod 就是容器"</strong>——这是许多 Kubernetes 初学者最常见的误解。事实上，Pod 并不是容器，而是<strong>容器的容器</strong>，是一个可以容纳一个或多个紧密关联容器的“逻辑主机”。</p>
<p>当我们说“在 Pod 里多跑一个容器”时，这意味着什么？意味着这个额外的容器与主应用容器共享着几乎所有关键资源：<strong>网络命名空间</strong>（同一 IP，通过 localhost 直接通信）、<strong>存储卷</strong>（Volume）以及<strong>生命周期</strong>（同生共死）。</p>
<p>这种共享关系，正是 Sidecar 魔力的源泉。</p>
<h2 data-id="heading-1">Sidecar 的本质：不只是“多一个容器”</h2>
<h3 data-id="heading-2">设计模式而非技术实现</h3>
<p>Sidecar 本质上是一种<strong>容器设计模式</strong>，而不是简单的技术实现。它代表了一种架构哲学：将辅助功能从主业务逻辑中解耦，让专业容器做专业事。</p>
<p>举个例子，想象一位主厨（主应用容器）在厨房工作。主厨专注炒菜（业务逻辑），而配菜、打扫、菜单更新等杂事由助手（Sidecar 容器）完成。这种分工协作大大提升了效率和专业性。</p>
<h3 data-id="heading-3">云原生时代的“功能扩展槽”</h3>
<p>在云原生架构中，Sidecar 如同计算机主板上的<strong>扩展槽</strong>，允许我们为应用动态添加各种能力而无须修改应用本身。</p>
<ul>
<li><strong>日志收集</strong>：主容器写日志到共享卷，Sidecar 容器负责收集和发送到日志系统</li>
<li><strong>服务网格</strong>：如 Istio 使用 Envoy 作为 Sidecar 代理，实现服务间通信的监控、安全和控制</li>
<li><strong>配置管理</strong>：Sidecar 监听配置中心，动态更新配置文件，主容器只需读取本地文件</li>
<li><strong>安全代理</strong>：如 Vault Agent Sidecar，负责与密钥管理系统交互，主应用无感知</li>
</ul>
<h2 data-id="heading-4">为什么“多跑一个容器”如此重要？</h2>
<h3 data-id="heading-5">1. 无侵入式架构设计</h3>
<p>传统做法中，要为应用添加监控、安全或通信功能，通常需要修改应用代码。而 Sidecar 模式通过“多跑一个容器”实现了<strong>零侵入</strong>的功能增强。</p>
<p>以服务网格为例，应用代码无需关心服务发现、熔断、重试等复杂逻辑，所有这些都由 Sidecar 代理透明处理。</p>
<h3 data-id="heading-6">2. 技术栈无关性</h3>
<p>Sidecar 容器可以用任何语言编写，与主应用容器的技术栈无关。一个 Java 应用可以搭配一个 Go 或 Rust 编写的 Sidecar，充分发挥各语言优势。</p>
<h3 data-id="heading-7">3. 独立性和可复用性</h3>
<p>Sidecar 容器可以<strong>独立开发、升级和部署</strong>。一个精心设计的日志收集 Sidecar 可以被全公司所有服务复用，大大降低开发维护成本。</p>
<h2 data-id="heading-8">实战示例：Sidecar 如何工作</h2>
<p>让我们通过一个具体例子看看“多跑一个容器”如何实际运作：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-with-logger</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">volumes:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-logs</span>
    <span class="hljs-attr">emptyDir:</span> {}  <span class="hljs-comment"># 临时共享目录</span>

  <span class="hljs-attr">containers:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span>
    <span class="hljs-attr">volumeMounts:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-logs</span>
      <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/log/nginx</span>

  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">log-sidecar</span>  <span class="hljs-comment"># 这就是“多跑”的容器</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">busybox</span>
    <span class="hljs-attr">command:</span> [<span class="hljs-string">"/bin/sh"</span>, <span class="hljs-string">"-c"</span>]
    <span class="hljs-attr">args:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">while</span> <span class="hljs-literal">true</span><span class="hljs-string">;</span> <span class="hljs-string">do</span>
        <span class="hljs-string">if</span> [ <span class="hljs-string">-f</span> <span class="hljs-string">/var/log/nginx/access.log</span> ]<span class="hljs-string">;</span> <span class="hljs-string">then</span>
          <span class="hljs-string">tail</span> <span class="hljs-string">-n</span> <span class="hljs-number">10</span> <span class="hljs-string">/var/log/nginx/access.log;</span>
        <span class="hljs-string">fi;</span>
        <span class="hljs-string">sleep</span> <span class="hljs-number">5</span><span class="hljs-string">;</span>
      <span class="hljs-string">done</span>
    <span class="hljs-attr">volumeMounts:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-logs</span>
      <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/log/nginx</span>
</code></pre>
<p>在这个例子中：</p>
<ul>
<li><strong>nginx 容器</strong>：专注提供 Web 服务，将日志写入 <code>/var/log/nginx</code></li>
<li><strong>log-sidecar 容器</strong>：负责读取日志并处理（示例中只是打印，实际可发送到日志系统）</li>
</ul>
<p>两个容器通过 <strong>emptyDir 卷</strong>共享日志目录，通过 <strong>localhost</strong> 通信（如果需要），共同构成一个完整的 Web 服务单元。</p>
<h2 data-id="heading-9">超越“多一个容器”：Sidecar 的高级模式</h2>
<h3 data-id="heading-10">服务网格中的 Sidecar</h3>
<p>在服务网格（如 Istio）中，Sidecar 模式发挥到极致。每个 Pod 中注入的 Envoy 代理容器透明地拦截和处理所有进出流量，实现精细化的流量管理、安全加密和可观测性。</p>
<p>这时，“多跑的容器”不再是简单的辅助角色，而是构成了<strong>分布式系统的通信基础设施</strong>。</p>
<h3 data-id="heading-11">适配器模式</h3>
<p>Sidecar 可以作为<strong>适配器</strong>，在不同接口或协议间进行转换。例如，主容器暴露 <code>/metrics</code> 接口，而监控系统需要 <code>/health</code> 接口，Sidecar 容器负责协议转换，无需修改主应用。</p>
<h2 data-id="heading-12">最佳实践与注意事项</h2>
<p>虽然 Sidecar 功能强大，但也需要谨慎使用：</p>
<h3 data-id="heading-13">启动顺序协调</h3>
<p>Kubernetes 不保证容器启动顺序，如果 Sidecar 需要先于主容器就绪（如配置同步 Sidecar），需要通过 initContainers 或健康检查机制协调。</p>
<h3 data-id="heading-14">资源管理</h3>
<p>为 Sidecar 设置合理的资源请求和限制，避免与主容器资源争抢。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">resources:</span>
  <span class="hljs-attr">requests:</span>
    <span class="hljs-attr">cpu:</span> <span class="hljs-string">100m</span>
    <span class="hljs-attr">memory:</span> <span class="hljs-string">128Mi</span>
  <span class="hljs-attr">limits:</span>
    <span class="hljs-attr">cpu:</span> <span class="hljs-string">200m</span>
    <span class="hljs-attr">memory:</span> <span class="hljs-string">256Mi</span>
</code></pre>
<h3 data-id="heading-15">避免过度使用</h3>
<p>不是所有功能都适合 Sidecar 模式。如果架构不复杂，直接使用 API 网关或传统中间件可能更简单。</p>
<h2 data-id="heading-16">与其他模式的关系</h2>
<h3 data-id="heading-17">Sidecar vs Init 容器</h3>
<ul>
<li><strong>Init 容器</strong>：在 Pod 启动前运行，完成即退出，用于初始化工作</li>
<li><strong>Sidecar 容器</strong>：与主容器并行运行，在整个生命周期内提供辅助功能</li>
</ul>
<h3 data-id="heading-18">Sidecar vs DaemonSet</h3>
<ul>
<li><strong>Sidecar</strong>：每个应用实例一个，与特定应用紧密绑定</li>
<li><strong>DaemonSet</strong>：每个节点一个，提供节点级别服务</li>
</ul>
<h2 data-id="heading-19">总结：简单概念背后的深远影响</h2>
<p>回到最初的问题：“Sidecar 不就是 Pod 里多跑一个容器吗？”——<strong>是，但远不止于此</strong>。</p>
<p>这个看似简单的“多跑一个容器”设计，实际上代表了云原生架构的核心思想：<strong>关注点分离、松散耦合、可复用性</strong>。它让应用开发者专注业务逻辑，而将通用能力下沉到基础设施层。</p>
<p>从简单的日志收集到复杂的服务网格，从配置管理到安全代理，Sidecar 模式已经成为现代云原生架构不可或缺的组成部分。它不是什么银弹，但当合理使用时，确实能够极大地提升系统的可维护性、可观测性和灵活性。</p>
<p>所以，需要理解这简单表象背后蕴含的深厚架构智慧。</p>
<p><em>是的，它就是多跑一个容器，但正是这个“多跑”的容器，让云原生应用架构变得如此强大而优雅。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 Haskell 到 Go：记一次 RSA 加密协议移植与“字节陷阱”排查实录]]></title>    <link>https://juejin.cn/post/7588093282530754612</link>    <guid>https://juejin.cn/post/7588093282530754612</guid>    <pubDate>2025-12-28T01:04:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588093282530754612" data-draft-id="7588092534162309120" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 Haskell 到 Go：记一次 RSA 加密协议移植与“字节陷阱”排查实录"/> <meta itemprop="keywords" content="Go,Haskell"/> <meta itemprop="datePublished" content="2025-12-28T01:04:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lupino"/> <meta itemprop="url" content="https://juejin.cn/user/3051900006579256"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 Haskell 到 Go：记一次 RSA 加密协议移植与“字节陷阱”排查实录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3051900006579256/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lupino
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T01:04:45.000Z" title="Sun Dec 28 2025 01:04:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 背景与目标</h2>
<p>本次任务的目标是将一个用 Haskell 编写的加密传输协议（<code>Metro.TP.RSA</code>）移植到 Go 语言中，并封装为标准的 <code>net.Conn</code> 接口，以便替换原有的 <code>XORConn</code> 实现。</p>
<p>该协议不仅仅是简单的加密，还是一个带有状态协商的混合协议，主要包含以下特性：</p>
<ul>
<li>
<p><strong>身份握手</strong>：基于 RSA 公私钥交换指纹（SHA256），验证客户端和服务端的合法性。</p>
</li>
<li>
<p><strong>模式协商</strong>：支持三种传输模式：</p>
<ul>
<li><code>Plain</code> (0): 明文直连。</li>
<li><code>RSA</code> (1): 全程使用 RSA-OAEP 加密（传统/兼容模式）。</li>
<li><code>AES</code> (2): 使用协商出的 Session Key 进行 AES-256-CTR 加密（高性能模式）。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-1">2. 遇到的核心问题</h2>
<p>在初步移植完成后，我们遇到了一个非常诡异的现象：</p>
<ul>
<li><strong>Plain 模式</strong>：一切正常，握手成功，数据传输流畅。</li>
<li><strong>AES/RSA 模式</strong>：握手看似完成，但随后连接陷入“假死”状态（Hang），无法读取数据。</li>
</ul>
<p>通常如果是加密算法错误（如 IV 错误、Padding 错误），程序往往会直接报错（Decryption Failed）。这种“卡住”的现象通常意味着<strong>协议状态机不同步</strong>或**数据分包（Framing）**出了问题。</p>
<h2 data-id="heading-2">3. 深度排查：字节级“脑裂”</h2>
<p>经过排查，问题的根源隐藏在 Haskell 和 Go 对枚举类型（Enum）默认序列化行为的差异中。</p>
<h3 data-id="heading-3">3.1 协议差异分析</h3>
<ul>
<li>
<p>Haskell 端 (Data.Binary)：</p>
<p>RSAMode 派生自 Generic。对于这种简单的 Sum Type（枚举），Haskell 的标准二进制库将其编码为 1 个字节 的索引值（0, 1, 2）。</p>
</li>
<li>
<p>Go 端 (旧代码)：</p>
<p>我们在发送模式时，习惯性地使用了 binary.BigEndian.PutUint64，发送了 8 个字节。</p>
</li>
</ul>
<h3 data-id="heading-4">3.2 故障重现</h3>
<p>当 Go 客户端请求 <strong>AES 模式 (2)</strong> 时，发生了以下交互：</p>
<ol>
<li>
<p><strong>Go 发送</strong>：<code>00 00 00 00 00 00 00 02</code> (8字节)。</p>
</li>
<li>
<p><strong>Haskell 接收</strong>：读取 <strong>1个字节</strong>，读到了 <code>00</code>。</p>
</li>
<li>
<p><strong>Haskell 状态</strong>：<code>00</code> 对应 <code>Plain</code> 模式。Haskell 认为协商结束，进入明文接收状态。</p>
</li>
<li>
<p><strong>Go 状态</strong>：发送完毕，认为协商成功，进入 AES 模式，开始发送加密后的 Session Key。</p>
</li>
<li>
<p><strong>结果（脑裂）</strong> ：</p>
<ul>
<li>Haskell 在等明文应用数据。</li>
<li>Go 发送了一堆加密的二进制流（Session Key）。</li>
<li>Haskell 读入这些乱码试图处理，导致逻辑错乱或在等待后续数据包头（Length Header）时无限阻塞。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-5">3.3 为什么 Plain 模式能跑通？</h3>
<p>这是一个极具迷惑性的巧合。</p>
<p>当 Go 请求 Plain (0) 时，发送的是 00 00 00 00 00 00 00 00。</p>
<p>Haskell 读取第一个字节 00，解析为 Plain。</p>
<p>虽然 Go 多发了7个字节的 00，但因为后续是明文传输，这几个空字节可能被应用层忽略或恰好未造成严重破坏（视具体应用层协议而定），从而掩盖了 bug。</p>
<h2 data-id="heading-6">4. 解决方案与最终实现</h2>
<h3 data-id="heading-7">4.1 修复序列化</h3>
<p>将 Go 代码中的模式发送与接收严格限制为 <strong>1 字节</strong>：</p>
<p>Go</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 发送 (Client)</span>
modeByte := []<span class="hljs-type">byte</span>{<span class="hljs-type">byte</span>(mode)}
c.sendDataOAEP(modeByte)

<span class="hljs-comment">// 接收 (Server)</span>
modeBytes, _ := c.recvDataOAEP()
mode := <span class="hljs-type">int</span>(modeBytes[<span class="hljs-number">0</span>])
</code></pre>
<h3 data-id="heading-8">4.2 完善流式处理</h3>
<p>由于 AES-CTR 是流加密，但协议定义了 <code>[Length][IV][Body]</code> 的封包格式，而 <code>net.Conn.Read</code> 是流式的。为了防止 TCP 粘包或断包导致解密失败，我们在 Go 结构体中引入了 <code>bytes.Buffer</code>：</p>
<p>Go</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> RSAConn <span class="hljs-keyword">struct</span> {
    net.Conn
    <span class="hljs-comment">// ... keys ...</span>
    readBuf bytes.Buffer <span class="hljs-comment">// 关键：内部缓冲</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *RSAConn)</span></span> Read(b []<span class="hljs-type">byte</span>) (n <span class="hljs-type">int</span>, err <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 优先从缓冲区吐出已解密数据</span>
    <span class="hljs-keyword">if</span> c.readBuf.Len() &gt; <span class="hljs-number">0</span> {
        <span class="hljs-keyword">return</span> c.readBuf.Read(b)
    }
    <span class="hljs-comment">// 缓冲区空，从网络读取完整的一个加密包，解密后填入缓冲区</span>
    <span class="hljs-comment">// ... recvDataAES logic ...</span>
}
</code></pre>
<h2 data-id="heading-9">5. 总结与经验</h2>
<ol>
<li><strong>跨语言协议必须精确到字节</strong>：不要假设 <code>Int</code> 是 4 字节还是 8 字节，也不要依赖语言特定的序列化库（如 Haskell 的 <code>Generic</code> 或 Go 的 <code>gob</code>），除非你完全掌控两端的实现。明确规定 <code>uint8</code>、<code>uint64</code> (BigEndian) 是最稳妥的。</li>
<li><strong>警惕“部分正常”的 Bug</strong>：Plain 模式的正常运行是最大的干扰项，它让我们误以为握手逻辑是完美的，从而将排查方向引向了复杂的加密算法本身，实际上问题只是简单的类型宽度不匹配。</li>
<li><strong>流式接口的适配</strong>：将基于包（Packet-based）的协议适配到流（Stream-based）接口（如 <code>io.Reader</code>）时，<strong>必须</strong>实现内部缓冲机制，否则极易出现粘包处理不当的问题。</li>
</ol>
<p>通过这次修复，我们成功实现了一个兼容 Haskell 后端、支持 RSA 身份验证和 AES 高速加密的 Go 语言传输层模块，为后续的服务端功能扩展（如 CS2 开箱服务）打下了坚实基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[短思考第266天，玩IP路上的几点感悟，这几点很重要！]]></title>    <link>https://juejin.cn/post/7588300640599146502</link>    <guid>https://juejin.cn/post/7588300640599146502</guid>    <pubDate>2025-12-28T00:57:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588300640599146502" data-draft-id="7588191506606374918" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="短思考第266天，玩IP路上的几点感悟，这几点很重要！"/> <meta itemprop="keywords" content="创业,前端,后端"/> <meta itemprop="datePublished" content="2025-12-28T00:57:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员码歌"/> <meta itemprop="url" content="https://juejin.cn/user/764915820529831"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            短思考第266天，玩IP路上的几点感悟，这几点很重要！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/764915820529831/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员码歌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T00:57:58.000Z" title="Sun Dec 28 2025 00:57:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>1、砍掉无复利或者复利不高的项目，删掉无价值的好友，做减法。专注有长线积累的短文写作、公众号专栏、社群合伙人等</p>
<p>2、玩IP， 一定要忘了阅读量指标，用处不大。核心是文章获取的精准用户，点赞、收藏、咨询、导私域、成交等数据</p>
<p>3、“日入800”，总能看到类似的简介引流，去吸引副业小白付费学习。类似这样的，一律别理，普通人几乎不可能，大概率是赚你学费</p>
<p>4、对完全没基础的同学玩副业IP， 要做好3年之内收入不稳定的心理准备，意味着你必须有一份主业，确保有基础的收入来源，别盲目裸辞。一人企业探索需要时间周期，很长。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[响应式编程不只有概念！万字长文 + 代码示例，手把手带你玩转 RxJava]]></title>    <link>https://juejin.cn/post/7588095884070273024</link>    <guid>https://juejin.cn/post/7588095884070273024</guid>    <pubDate>2025-12-28T01:07:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588095884070273024" data-draft-id="7588093282530770996" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="响应式编程不只有概念！万字长文 + 代码示例，手把手带你玩转 RxJava"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-28T01:07:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java随想录"/> <meta itemprop="url" content="https://juejin.cn/user/2837192913204935"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            响应式编程不只有概念！万字长文 + 代码示例，手把手带你玩转 RxJava
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2837192913204935/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java随想录
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T01:07:20.000Z" title="Sun Dec 28 2025 01:07:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读29分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文已收录至GitHub，推荐阅读 👉 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FBookSea4j%2FJavaRecord" target="_blank" title="https://github.com/BookSea4j/JavaRecord" ref="nofollow noopener noreferrer">Java随想录</a></p>
<p>微信公众号：Java随想录</p>
<h2 data-id="heading-0">Reactive Streams 介绍</h2>
<p>在聊 Reactive Streams 之前，先了解一下 Reactive Programming（反应式/响应式编程）。为了解决异步编程中出现的各种问题，程序员们提出了各种的思路去解决这些问题，这些解决问题的方式、方法，手段就可以叫做 Reactive Programming。</p>
<p>Reactive Programming 是一种编程思想，类似面向对象，函数式编程。</p>
<p>本质上是对数据流或某种变化做出的反应，这个变化什么时候触发是未知的，所以他是一种基于异步、回调的方式在处理问题。</p>
<p>当越来越多的程序员，开始使用这种编程思想时，需要一些大佬来统一一个思想规范。所以国外的几个大佬公司启动了 Reactive Streams 项目。Netflix、Pivotal、Lightbend 联合来为异步流处理提供标准，规范。</p>
<p>Reactive Streams 翻译过来就是响应式/反应式流。<strong>其实是一种基于异步流处理的标准化规范，目的是在使用流处理时更加可靠，高效和响应式。</strong></p>
<h2 data-id="heading-1">Java 层面的 Reactive Streams</h2>
<p>基于这个规范的实现很多，比如三方库中比较出名的 RxJava，Reactor 等等。</p>
<p>但是 JDK8 版本中，Java 已经有了 CompletableFuture 的支撑，我们可以将大量的异步任务做好编排。但是在 JDK8 版本中的 CompletableFuture 依然有很多特性无法支撑。所以在 JDK9，CompletableFuture 做了很多的更新，比如支持延迟，超时，子类化之类的功能。</p>
<p>这时，咱们会发现，其实 CompletableFuture 已经可以去支撑做一些异步编程的操作了。但是为什么很多大公司依然还是使用 RxJava，Reactor 这种三方依赖库呢？</p>
<p>问题在于，大多数的时候，咱们采用异步编程处理的任务并不是非常复杂的。这个时候，咱们确实不需要去使用 Reactive Streams 反应流的框架。如果系统越来越复杂，或者你处理的业务本身就是及其复杂的那种，你就要去写一个让人头皮发麻的代码了。随着时间的推移，这种代码会变成非常难以维护。</p>
<p>其次 CompletableFuture 并不是真正的基于 Reactive Streams 去实现。CompletableFuture 描述的是单次执行的结果。尽管可以通过各种方法将异步任务之间构建成一串任务组成的流程图，本质上依然是单次的结果。</p>
<p>反应式流，面向的是 Stream。 咱们 Java 中的 Stream API 更类似 Reactive Streams 的思想。Stream API 是同步阻塞的。</p>
<p>最经典的就是 CompletableFuture 无法处理 Reactive Streams 中的一个核心概念，Back Pressure（背压，反压，回压），比如在上下游承载能力不同时，比如下游玩不转了，需要告知上游采取一些策略去解决。CompletableFuture 明显无法处理这种。</p>
<p>其次还有 Java 中提供的回调，Future 机制在实现响应式编程中，问题和缺点都比较难处理。有个比较出名的概念叫做 Callback Hell（回调地狱）。简单来说就是回调里面套回调，虽然将子过程做到解耦，但是随着业务的负责，回调代码的可读性、复杂性就大大的增加，这个就是回调地狱。</p>
<p>所以，咱们需要一套框架或者说类库来实现真正响应式流，大概需要几个特性：</p>
<ul>
<li>支持将异步任务做封装以及组装，需要 API 对异步任务进行包装，并且需要很多子任务来对异步操作进行链式组装，过程中包括过滤，异常处理，超时等等操作。</li>
<li>减少异步任务的嵌套，减少代码的复杂性，增加可读性，避免 Callback Hell 这种及其复杂恶心的代码。</li>
<li>支持背压 Back Pressure，也就需要有上游和下游的概念，可以做到协商处理数据流的速度。</li>
</ul>
<h2 data-id="heading-2">Java 层面 Reactive Steams 的 API</h2>
<p>首先 Reactive Steams 响应流实现方式其实是基于观察者模式的扩展，同时也能看到发布订阅模式，责任链模式等等。</p>
<p>整个 Reactive Steams 流程大致如下。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9592c871e5e40f1be90efcf888187cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yemaj-aDs-W9lQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767488840&amp;x-signature=TSgTt3xeOZBxptm6EuAjG8vQSSg%3D" alt="" loading="lazy"/></p>
<p>直接在 JDK9 版本之上查看 Doug Lee 提供的 Flow 类。</p>
<p>在 Flow 类中，提供了核心的四个接口：Publisher，Subscriber，Subscription，Processor</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09f5138c2bb440098f904bb47b27b6ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yemaj-aDs-W9lQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767488840&amp;x-signature=7316XjMXvFoj2HFpvI5fx5Tv08I%3D" alt="" loading="lazy"/></p>
<p>Publisher：Publisher 是函数式接口，负责发布数据的。 Publisher 内部有一个方法 subscribe 方法，去和具体的订阅者绑定关系。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bd5da1cce0a48768a6c10bd3325c266~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yemaj-aDs-W9lQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767488840&amp;x-signature=0yFzU%2FEhU6cf%2FLDc%2FhYGO%2FgDKY8%3D" alt="" loading="lazy"/></p>
<p>Subscriber：Subscriber 是订阅者，负责订阅，消费数据。四个方法：</p>
<ul>
<li>onSubscribe：订阅成功后触发，并且表明可以开始接收发布者的数据元素了。</li>
<li>onNext：每次获取到发布者的数据元素都会执行 onNext。</li>
<li>onError：接收数据元素时，出现异常等问题时，走 onError。</li>
<li>onComplete：当指定接收的元素个数搞定后，触发 onComplete。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b00cfd018c9e4d6d9eab9109a953eac6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yemaj-aDs-W9lQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767488840&amp;x-signature=KN1vhpT34Ny2FvK3c39OX73WOuI%3D" alt="" loading="lazy"/></p>
<p>Subscription：发布者和订阅者是基于 Subscription 关联的。当建立了订阅的关系后，发布者会将 Subscription 传递给订阅者。订阅者指定获取元素的数量和取消订阅操作，都要基于 Subscription 去操作。提供了两个方法：</p>
<ul>
<li>request：订阅者要获取的元素个数。</li>
<li>cancel：取消订阅，当前的订阅者不接收当前发布者的元素。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c68ad044b9374c3eab14b2f3b49f13c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yemaj-aDs-W9lQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767488840&amp;x-signature=Jpp0h1Y6ZxFtnBsdj86KdC4YnpI%3D" alt="" loading="lazy"/></p>
<p>Processor：Processor 继承了 Publisher 和 Subscriber，即是发布者也是订阅者。Processor 一般作为数据的中转，订阅者处理完数据元素，可以再次发给下一个订阅者。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a42047a535c9423995491f68ce606ee3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yemaj-aDs-W9lQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767488840&amp;x-signature=xtE0ChJLm8qslq46IFzHStHC4YA%3D" alt="" loading="lazy"/></p>
<p>这四个接口很重要，是 Reactive Streams 的规范，但是可以明显的看到，内部没有具体的内容实现。</p>
<p>这里就类似 JDBC 这种规范，规范在 JDK9 中提出来了，想实现，可以基于当前的这四个接口再做具体的逻辑处理以及实现的细节。</p>
<h2 data-id="heading-3">Java 层面 Reactive Steams 基本操作</h2>
<p>咱们测试 Java 中的 Flow 里提供的 API 时，就是走最基本的操作。</p>
<p>其中 Processor 不需要重写，玩最基本的操作，不去做订阅者和发布者的转换。</p>
<p>其次 Subscription 也不需要重写，这东西就是提供了订阅者指定订阅的消息个数，以及取消的操作。</p>
<p>然后 Publisher 需要重写，但是 JDK 中已经提供了一个 Publisher 的实现，SubmissionPublisher，可以直接使用。</p>
<p>最后，Subscriber 需要咱们自己重写，指定好订阅消息的个数，已经消费的一些逻辑</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.Flow;


<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MySubscriber</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Flow</span>.Subscriber&lt;Integer&gt; {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-comment">// 绑定好订阅关系后，就会触发这个方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSubscribe</span><span class="hljs-params">(Flow.Subscription subscription)</span> {
        subscription.request(<span class="hljs-number">10</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onNext</span><span class="hljs-params">(Integer item)</span> {
        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">"：接收到数据流："</span> + item);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onError</span><span class="hljs-params">(Throwable throwable)</span> {
        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">"：接收消息出现异常："</span> + throwable.getMessage());
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onComplete</span><span class="hljs-params">()</span> {
        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">"：当前订阅者要求接收的消息全部处理完毕。"</span>);
    }
}
</code></pre>
<p>直接使用 SubmissionPublisher 测试整体效果</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
    <span class="hljs-comment">// 只有一个工作线程的线程池</span>
    <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">1</span>);
    <span class="hljs-comment">// 指定缓冲区的大小</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">maxBufferCapacity</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;

    <span class="hljs-comment">// 需要指定两个参数</span>
    <span class="hljs-comment">// 第一个参数需要传递一个线程池，指定订阅者使用的线程</span>
    <span class="hljs-comment">// 第二个参数，需要指定一个缓冲区，发布者发布消息后，消息会扔到缓冲区里。</span>
    SubmissionPublisher&lt;Integer&gt; publisher = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SubmissionPublisher</span>&lt;&gt;(executor,maxBufferCapacity);

    <span class="hljs-comment">// 绑定订阅者</span>
    <span class="hljs-type">MySubscriber</span> <span class="hljs-variable">subscriber</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MySubscriber</span>();
    publisher.subscribe(subscriber);

    <span class="hljs-comment">// 发布消息</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">"：发布消息："</span> + i);
        publisher.submit(i);
    }

    <span class="hljs-comment">// 释放资源</span>
    publisher.close();
    executor.shutdown();
}
</code></pre>
<p>结果输出如下：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">main</span>：发布消息：<span class="hljs-number">0</span>
<span class="hljs-selector-tag">main</span>：发布消息：<span class="hljs-number">1</span>
<span class="hljs-selector-tag">main</span>：发布消息：<span class="hljs-number">2</span>
<span class="hljs-selector-tag">main</span>：发布消息：<span class="hljs-number">3</span>
<span class="hljs-selector-tag">main</span>：发布消息：<span class="hljs-number">4</span>
<span class="hljs-selector-tag">main</span>：发布消息：<span class="hljs-number">5</span>
<span class="hljs-selector-tag">main</span>：发布消息：<span class="hljs-number">6</span>
<span class="hljs-selector-tag">main</span>：发布消息：<span class="hljs-number">7</span>
<span class="hljs-selector-tag">main</span>：发布消息：<span class="hljs-number">8</span>
<span class="hljs-selector-tag">main</span>：发布消息：<span class="hljs-number">9</span>
pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>：接收到数据流：<span class="hljs-number">0</span>
pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>：接收到数据流：<span class="hljs-number">1</span>
pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>：接收到数据流：<span class="hljs-number">2</span>
pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>：接收到数据流：<span class="hljs-number">3</span>
pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>：接收到数据流：<span class="hljs-number">4</span>
pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>：接收到数据流：<span class="hljs-number">5</span>
pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>：接收到数据流：<span class="hljs-number">6</span>
pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>：接收到数据流：<span class="hljs-number">7</span>
pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>：接收到数据流：<span class="hljs-number">8</span>
pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>：接收到数据流：<span class="hljs-number">9</span>
pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>：当前订阅者要求接收的消息全部处理完毕。
</code></pre>
<ul>
<li><strong>缓冲区：</strong> 缓冲区就是发布者和订阅者之间的一块内存，类似线程池中的阻塞队列，可以将消息扔到这个缓存区里。其次咱们设置的缓冲区大小是 5，但是发现 get 出来的时候，5 被替换为了 8。这是因为 SubmissionPublisher 为了更有效的使用内存，默认会基于 roundCapacity 方法将传递的缓冲区大小替换为 2 的 n 次幂。</li>
<li><strong>背压效果：</strong> 当订阅者指定的消息已经全部处理完毕后，发布者最多只能发布缓冲区大小个数的消息，剩下的内容会基于背压的效果直接暂时不发送。</li>
<li><strong>onComplete：</strong> 需要发布者做了close 操作，确认了发布者已经将消息全部发送，并且订阅者也已经将全部的消息处理完毕后，才会触发 onComplete。</li>
<li><strong>Subscription：</strong> 订阅者可以在 onNext 或者其他方法中动态的使用 subscription 去指定后续需要几个消息订阅，以及是否需要取消订阅消息等操作。</li>
</ul>
<h2 data-id="heading-4">Reactive Steams 落地体验</h2>
<h3 data-id="heading-5">回调地狱问题</h3>
<p>前面的方式大致了解了 JDK9 中更新的 Reactive Streams 的规范，咱们实现也仅仅是看到了发布订阅和回压的效果。并没有看到如何解决回调地狱的问题。咱们可以通过 Spring5 官网提供的一个例子，来体验一下 CallBack Hell 回调地狱带来的问题。后面再根据三方的实现来看一下基于 Reactive Streams 实现后效果如何。这里基本是根据伪代码走的。</p>
<p>例子：在用户的 UI 页面上，展示当前用户最喜欢的 Top5 的商品详情。这里会根据用户的 ID 去查询当前用户 Top5 商品的ID，如果 ID 可以查询到之后再根据商品的 ID 去查询商品的详情。如果当前用户 ID 查询的结果不存在喜欢的 Top 商品，没有的话，通过推荐服务查询 Top5 的商品信息。展示给用户。</p>
<p>当前例子需要三个服务的支撑：</p>
<ul>
<li>根据用户 ID 查询用户的 Top5 商品ID。</li>
<li>根据 Top5 商品ID查询商品详情。</li>
<li>调用推荐服务，获取5个商品详情。</li>
</ul>
<p>基于 Java 最原生的异步编程方式，实现上述操作，来看看到底什么是回调地狱。。。</p>
<p>商品详情实体类：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Fav</span> {

    <span class="hljs-keyword">private</span> String itemId;

    <span class="hljs-keyword">private</span> String itemName;

    <span class="hljs-keyword">private</span> String itemDetail;

}
</code></pre>
<p>准备回调方法，拿到结果后触发</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Callback</span>&lt;T&gt; {

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSuccess</span><span class="hljs-params">(T t)</span>;

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onError</span><span class="hljs-params">(Throwable throwable)</span>;

}
</code></pre>
<p>准备了访问三个服务的 Service 接口</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserService</span> {

    <span class="hljs-comment">/**
     * 根据用户Id查询用户的Top5商品Id
     * <span class="hljs-doctag">@param</span> userId
     * <span class="hljs-doctag">@param</span> list
     */</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">getFav</span><span class="hljs-params">(String userId, Callback&lt;List&lt;String&gt;&gt; list)</span>;

}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ItemService</span> {
    
    <span class="hljs-comment">/**
     * 根据商品Id查询商品的详情
     *
     * <span class="hljs-doctag">@param</span> itemId
     * <span class="hljs-doctag">@param</span> callback
     */</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">getDetail</span><span class="hljs-params">(String itemId, Callback&lt;Fav&gt; callback)</span>;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SuggestionService</span> {

    <span class="hljs-comment">/**
     * 调用推荐服务，获取推荐商品
     * <span class="hljs-doctag">@param</span> favs
     */</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">getSuggestion</span><span class="hljs-params">(Callback&lt;List&lt;Fav&gt;&gt; favs)</span>;
}
</code></pre>
<p>准备了响应数据的 UI 线程工具以及响应方法</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UiUtils</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">submitOnUiThread</span><span class="hljs-params">(Runnable runnable)</span>{
        <span class="hljs-comment">// 线程池中的线程做响应的操作………………</span>
    }


    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">show</span><span class="hljs-params">(Object obj)</span>{
        <span class="hljs-comment">// 利用UI线程展示具体数据</span>
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">error</span><span class="hljs-params">(Object obj)</span>{
        <span class="hljs-comment">// 出现错误响应的内容</span>
    }

}
</code></pre>
<p>完成了 Controller 中的异步编程效果</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CallBackHellController</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ItemService itemService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> SuggestionService suggestionService;


    <span class="hljs-meta">@GetMapping("/callbackhell")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">callbackHell</span><span class="hljs-params">(String userId)</span>{
        <span class="hljs-comment">//1、调用用户服务，查询Top5商品Id</span>
        userService.getFav(userId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Callback</span>&lt;List&lt;String&gt;&gt;() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSuccess</span><span class="hljs-params">(List&lt;String&gt; list)</span> {
                <span class="hljs-comment">// 已经查询到商品Id，但是不知道是否有值</span>
                <span class="hljs-keyword">if</span> (list.isEmpty()){
                    <span class="hljs-comment">// 3、用户没有Top5商品Id，通过推荐服务查询推荐商品详情</span>
                    suggestionService.getSuggestion(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Callback</span>&lt;List&lt;Fav&gt;&gt;(){
                        <span class="hljs-meta">@Override</span>
                        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSuccess</span><span class="hljs-params">(List&lt;Fav&gt; favs)</span> {
                            <span class="hljs-comment">// 推荐服务查询到了商品详情，响应即可</span>
                            UiUtils.submitOnUiThread(() -&gt; {
                                favs.stream().limit(<span class="hljs-number">5</span>).forEach(UiUtils::show);
                            });
                        }
                        <span class="hljs-meta">@Override</span>
                        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onError</span><span class="hljs-params">(Throwable throwable)</span> {
                            UiUtils.error(throwable);
                        }
                    });

                }
                <span class="hljs-keyword">else</span>{
                    <span class="hljs-comment">// 2、通过用户查询到了Top5商品Id，通过商品Id查询商品详情</span>
                    list.stream().limit(<span class="hljs-number">5</span>).forEach(itemId -&gt; itemService.getDetail(itemId,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Callback</span>&lt;Fav&gt;(){

                        <span class="hljs-meta">@Override</span>
                        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSuccess</span><span class="hljs-params">(Fav fav)</span> {
                            <span class="hljs-comment">// 查询到了商品详情，利用UI线程，给客户端响应数据</span>
                            UiUtils.submitOnUiThread(() -&gt; UiUtils.show(fav));
                        }

                        <span class="hljs-meta">@Override</span>
                        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onError</span><span class="hljs-params">(Throwable throwable)</span> {
                            <span class="hljs-comment">// 出现异常了。</span>
                            UiUtils.error(throwable);
                        }
                    }));
                }
            }
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onError</span><span class="hljs-params">(Throwable throwable)</span> {
                <span class="hljs-comment">// 出现异常了。</span>
                UiUtils.error(throwable);
            }
        });


    }

}
</code></pre>
<h3 data-id="heading-6">解决回调地狱问题</h3>
<p>这里为了解决回调地狱问题，需要一个 Reactor 的依赖来帮助咱们实现异步编程。</p>
<p>需要导入依赖</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!--reactor的核心依赖--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.projectreactor<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>reactor-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.7.7<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>不能再使用之前的 Callback 方式了。需要使用 reactor 提供的 Flux，并且这种链式操作会更直观，也更好维护。就只需要修改三个服务对应的 Service。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserService</span> {

    <span class="hljs-comment">/**
     * 根据用户ID查询Top5商品ID
     * <span class="hljs-doctag">@param</span> userId
     * <span class="hljs-doctag">@return</span>
     */</span>
    Flux&lt;List&lt;String&gt;&gt; <span class="hljs-title function_">getFav</span><span class="hljs-params">(String userId)</span>;

}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ItemService</span> {


    <span class="hljs-comment">/**
     * 根据商品ID查询商品详情
     * <span class="hljs-doctag">@param</span> itemId
     * <span class="hljs-doctag">@return</span>
     */</span>
    Flux&lt;Fav&gt; <span class="hljs-title function_">getDetail</span><span class="hljs-params">(String itemId)</span>;

}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SuggestionService</span> {

    <span class="hljs-comment">/**
     * 获取推荐的商品详情
     * <span class="hljs-doctag">@return</span>
     */</span>
    Flux&lt;List&lt;Fav&gt;&gt; <span class="hljs-title function_">getSuggestion</span><span class="hljs-params">()</span>;

}
</code></pre>
<p>然后就可以利用 Flux 提供的 API 来解决之前回调地狱的问题。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactorCallbackController</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ItemService itemService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> SuggestionService suggestionService;


    <span class="hljs-meta">@GetMapping("reactorcallback")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reactorCallback</span><span class="hljs-params">(String userId)</span>{
        userService
                .getFav(userId)   <span class="hljs-comment">// 根据用户Id查询Top5商品Id</span>
                .flatMap(itemService::getDetail)  <span class="hljs-comment">// 根据商品ID查询商品详情</span>
                .switchIfEmpty(suggestionService.getSuggestion())  <span class="hljs-comment">// 如果前面为null，这里通过推荐服务查询商品详情</span>
                .take(<span class="hljs-number">5</span>)    <span class="hljs-comment">// 获取前5个数据</span>
                .publishOn(UiUtils.reactorOnUiThread())    <span class="hljs-comment">// 使用Ui线程</span>
                .subscribe(UiUtils::show,UiUtils::error);   <span class="hljs-comment">// 成功走show，失败走error</span>
    }

}
</code></pre>
<h3 data-id="heading-7">CompletableFuture 的异步编程</h3>
<p>Future 的形式相比 Callback Hell 效果要好一些，虽然 JDK8 和 9 都对 CompletableFuture 做了各种优化，但是他的表现还是不太好。多个Future在嵌套时，可读性还是比较差的。并且 CompletableFuture 不存在什么回压，或者是延迟调用的功能。</p>
<p>现在借助 CompletableFuture 来实现一个场景。</p>
<ol>
<li>获取一个用户ID的列表。</li>
<li>通过用户ID分别获取他的名字以及统计信息。（希望这两个操作是并行执行的）</li>
<li>当两个信息都获取到之后，封装成一个普通字符串即可。</li>
<li>响应数据，最后拿到结果（输出一下）。</li>
</ol>
<p>实现代码</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GetNameAndStatTestByCF</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 1、获取一组用户ID列表</span>
        CompletableFuture&lt;List&lt;String&gt;&gt; idList = getID();
        CompletableFuture&lt;List&lt;String&gt;&gt; dataCompletableFuture = idList.thenComposeAsync(ids -&gt; {
            Stream&lt;CompletableFuture&lt;String&gt;&gt; resultStream = ids.stream().map(id -&gt; {
                <span class="hljs-comment">// 2、并行基于ID查询名称信息</span>
                CompletableFuture&lt;String&gt; nameTask = getName();
                <span class="hljs-comment">// 2、并行基于ID查询统计信息</span>
                CompletableFuture&lt;Integer&gt; statTask = getStat();
                <span class="hljs-comment">// 让两个查询名称信息和查询统计信息操作并行执行</span>
                <span class="hljs-keyword">return</span> nameTask.thenCombineAsync(statTask, (name, stat) -&gt; {
                    <span class="hljs-comment">// 3、拿到信息组装</span>
                    <span class="hljs-keyword">return</span> <span class="hljs-string">"Name："</span> + name + <span class="hljs-string">"，Stat："</span> + stat;
                });
            });
            <span class="hljs-comment">// 将resultStream转换成一个数组</span>
            List&lt;CompletableFuture&lt;String&gt;&gt; resultList = resultStream.toList();
            <span class="hljs-comment">// 全部的任务封装起来</span>
            CompletableFuture&lt;Void&gt; allDone = CompletableFuture.allOf(resultList.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletableFuture</span>[]{}));
            <span class="hljs-comment">// 执行全部任务</span>
            <span class="hljs-keyword">return</span> allDone.thenApplyAsync(v -&gt; resultList.stream()
                    .map(CompletableFuture::join)
                    .collect(Collectors.toList()));
        });

        <span class="hljs-comment">// 4、获取全部的组件信息后响应客户端（输出）</span>
        List&lt;String&gt; data = dataCompletableFuture.join();
        System.out.println(data);
    }

    <span class="hljs-comment">// 模拟zz服务获取统计信息</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> CompletableFuture&lt;Integer&gt; <span class="hljs-title function_">getStat</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; <span class="hljs-number">666</span>);
    }

    <span class="hljs-comment">// 模拟yy服务获取名称信息</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; <span class="hljs-string">"张三"</span>);
    }

    <span class="hljs-comment">// 模拟xx服务，获取一组用户ID</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> CompletableFuture&lt;List&lt;String&gt;&gt; <span class="hljs-title function_">getID</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-comment">// 模拟查询三方服务</span>
            List&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
            list.add(<span class="hljs-string">"1"</span>);
            list.add(<span class="hljs-string">"2"</span>);
            list.add(<span class="hljs-string">"3"</span>);
            <span class="hljs-keyword">return</span> list;
        });
    }

}
</code></pre>
<h3 data-id="heading-8">解决 CompletableFuture 的问题</h3>
<p>CompletableFuture 可以实现一些简单的异步编程，但是可看性和维护性以后后期的扩展都需要对整体代码做比较大成本的维护。依然采用 Reactor 来实现一个一模一样的逻辑，再看代码效果。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GetNameAndStatByReactor</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 1、获取一组用户ID列表</span>
        Flux&lt;String&gt; idFlux = getId();

        Flux&lt;String&gt; result = idFlux.flatMap(id -&gt; {
            <span class="hljs-comment">// 2、并行基于ID查询名称信息</span>
            Flux&lt;String&gt; nameFlux = getName(id);
            <span class="hljs-comment">// 2、并行基于ID查询统计信息</span>
            Flux&lt;Integer&gt; statFlux = getStat(id);
            <span class="hljs-comment">// 俩任务并行处理完毕，触发3</span>
            <span class="hljs-keyword">return</span> nameFlux.zipWith(statFlux, (name, stat) -&gt; {
                <span class="hljs-comment">// 3、拿到信息组装</span>
                <span class="hljs-keyword">return</span> <span class="hljs-string">"Name："</span> + name + <span class="hljs-string">"，Stat："</span> + stat;
            });
        });
        Mono&lt;List&lt;String&gt;&gt; listMono = result.collectList();
        List&lt;String&gt; info = listMono.block();
        <span class="hljs-comment">// 4、获取全部的组件信息后响应客户端（输出）</span>
        System.out.println(info);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Flux&lt;Integer&gt; <span class="hljs-title function_">getStat</span><span class="hljs-params">(String id)</span> {
        <span class="hljs-comment">// 会查询三方服务，然后封装结果</span>
        <span class="hljs-keyword">return</span> Flux.just(<span class="hljs-number">888</span>);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Flux&lt;String&gt; <span class="hljs-title function_">getName</span><span class="hljs-params">(String id)</span> {
        <span class="hljs-comment">// 会查询三方服务，然后封装结果</span>
        <span class="hljs-keyword">return</span> Flux.just(<span class="hljs-string">"张三"</span>);
    }


    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Flux&lt;String&gt; <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 会查询三方服务，然后封装结果</span>
        <span class="hljs-keyword">return</span> Flux.just(<span class="hljs-string">"1"</span>,<span class="hljs-string">"2"</span>,<span class="hljs-string">"3"</span>);
    }
}
</code></pre>
<h2 data-id="heading-9">RxJava2 实现异步编程</h2>
<p>RxJava 是一个小框架，或者是依赖库。在 RxJava 的1.x版本中，它并不基于 Reactive Streams 去实现的。没有关系，因为 RxJava 的 2 版本，就是基于Reactive Streams 实现的了。</p>
<p>使用 RxJava 巨简单，因为作者想将 RxJava 尽量做到轻量级，就一个依赖。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!--RxJava2的依赖--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.reactivex.rxjava2<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rxjava<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.21<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h3 data-id="heading-10">RxJava2 的入门操作</h3>
<p>获取一个 Person 对象的集合，将 Person 集合中的所有年龄大于10岁的 Person 对象筛选出来，并输出他的名字。</p>
<p>采用 RxJava 来实现一下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">//1、获取Person对象集合</span>
        List&lt;Person&gt; personList = getPersonList();

        <span class="hljs-comment">//2、完成上面要求的操作</span>
        <span class="hljs-comment">//2.1、将person集合转换为RxJava的流</span>
        Flowable.fromArray(personList.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>[]{}))
                <span class="hljs-comment">//2.2 过滤年龄大于10岁的</span>
                .filter(person -&gt; person.getAge() &gt; <span class="hljs-number">10</span>)
                <span class="hljs-comment">//2.3 获取筛选后的Person名称</span>
                .map(person -&gt; person.getName())
                <span class="hljs-comment">//2.4 输出Name</span>
                .subscribe(System.out::println);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> List&lt;Person&gt; <span class="hljs-title function_">getPersonList</span><span class="hljs-params">()</span> {
        List&lt;Person&gt; personList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        personList.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"大娃"</span>,<span class="hljs-number">5</span>));
        personList.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"二娃"</span>,<span class="hljs-number">7</span>));
        personList.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"三娃"</span>,<span class="hljs-number">9</span>));
        personList.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"四娃"</span>,<span class="hljs-number">11</span>));
        personList.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"五娃"</span>,<span class="hljs-number">13</span>));
        <span class="hljs-keyword">return</span> personList;
    }
}
</code></pre>
<h3 data-id="heading-11">RxJava2 的基础处理流程</h3>
<p>在 RxJava 中有三个核心的角色</p>
<ul>
<li>被观察者（Observable）</li>
<li>观察者（Observer）</li>
<li>订阅（Subscribe）</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo2</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">//1、构建Observable</span>
        Observable&lt;String&gt; observable = Observable.create(emitter -&gt; {
            emitter.onNext(<span class="hljs-string">"Hello"</span>);
            emitter.onNext(<span class="hljs-string">"World"</span>);
            emitter.onComplete();
        });

        <span class="hljs-comment">//2、构建Observer</span>
        Observer&lt;String&gt; observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Observer</span>&lt;&gt;() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSubscribe</span><span class="hljs-params">(Disposable d)</span> {
                System.out.println(<span class="hljs-string">"开始订阅"</span>);
            }

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onNext</span><span class="hljs-params">(String s)</span> {
                System.out.println(<span class="hljs-string">"观察者："</span> + s);
            }

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onError</span><span class="hljs-params">(Throwable e)</span> {
                e.printStackTrace();
            }

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onComplete</span><span class="hljs-params">()</span> {
                System.out.println(<span class="hljs-string">"订阅结束"</span>);
            }
        };

        <span class="hljs-comment">//3、订阅</span>
        observable.subscribe(observer);
    }

}
</code></pre>
<h3 data-id="heading-12">创建操作符</h3>
<h4 data-id="heading-13">create</h4>
<p>Observable.create() 是手动创建 Observable 的方法，允许完全控制数据的发射、完成和错误处理。</p>
<pre><code class="hljs language-java" lang="java">Observable&lt;String&gt; observable = Observable.create(emitter -&gt; {
    emitter.onNext(<span class="hljs-string">"Hello"</span>);
    emitter.onNext(<span class="hljs-string">"World"</span>);
    emitter.onComplete();
});

observable.subscribe(
    item -&gt; System.out.println(<span class="hljs-string">"收到: "</span> + item),
    error -&gt; System.err.println(<span class="hljs-string">"错误: "</span> + error),
    () -&gt; System.out.println(<span class="hljs-string">"完成"</span>)
);

<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 收到: Hello</span>
<span class="hljs-comment">// 收到: World</span>
<span class="hljs-comment">// 完成</span>
</code></pre>
<h4 data-id="heading-14">just</h4>
<p>just 用于创建一个发射固定数据的 Observable，数据是预定义的，发射后立即完成。</p>
<pre><code class="hljs language-java" lang="java">Observable.just(<span class="hljs-string">"Hello"</span>)
    .subscribe(item -&gt; 
        System.out.println(<span class="hljs-string">"收到: "</span> + item)
    );

<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 收到: Hello</span>
</code></pre>
<h4 data-id="heading-15">fromArray</h4>
<p>fromArray 用于从数组创建一个 Observable，按数组顺序发射所有元素。</p>
<pre><code class="hljs language-java" lang="java">String[] fruits = {<span class="hljs-string">"Apple"</span>, <span class="hljs-string">"Banana"</span>, <span class="hljs-string">"Cherry"</span>, <span class="hljs-string">"Date"</span>};
Observable.fromArray(fruits)
    .subscribe(fruit -&gt; 
        System.out.print(fruit + <span class="hljs-string">" "</span>)
    );

<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// Apple Banana Cherry Date</span>
</code></pre>
<h4 data-id="heading-16">fromCallable</h4>
<p>fromCallable 用于从 Callable 创建 Observable，Callable 的返回值会被包装成 Observable 发射。</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Observable.fromCallable(() -&gt; <span class="hljs-string">"计算结果: "</span> + System.currentTimeMillis())
                .subscribe(System.out::println);

        <span class="hljs-comment">// 输出：</span>
        <span class="hljs-comment">// 计算结果: 1620000000000</span>
    }
</code></pre>
<h4 data-id="heading-17">timer</h4>
<p>timer 用于创建一个延迟指定时间后发射单个数据的 Observable，通常是 0L，然后结束。</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        System.out.println(<span class="hljs-string">"开始时间: "</span> + System.currentTimeMillis());

        Observable.timer(<span class="hljs-number">2</span>, TimeUnit.SECONDS)
                .subscribe(tick -&gt;
                        System.out.println(<span class="hljs-string">"触发时间: "</span> + System.currentTimeMillis() + <span class="hljs-string">"，值: "</span> + tick)
                );

        Thread.sleep(<span class="hljs-number">3000</span>);
    }
</code></pre>
<p>默认使用 <code>Schedulers.computation()</code>线程池计算，线程池中的线程是守护线程，如果主线程结束守护线程也会随之终止。</p>
<h4 data-id="heading-18">interval</h4>
<p>interval() 方法用于创建一个 周期性定时发射的 Observable，它会按照指定的时间间隔无限期地发射递增的数字序列（从0开始）。</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException {
        Observable.interval(<span class="hljs-number">2</span>, TimeUnit.SECONDS)
                .subscribe(aLong -&gt; System.out.println(Thread.currentThread().getName() + <span class="hljs-string">"："</span> + aLong));

        System.in.read();
    }
</code></pre>
<h4 data-id="heading-19">intervalRange</h4>
<p>intervalRange() 是 interval() 的增强版本，用于创建一个有限次数的周期性发射的 Observable。它允许你指定起始值、发射次数、初始延迟和间隔时间。</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException {
        Observable.intervalRange(<span class="hljs-number">100</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, TimeUnit.SECONDS)
                .subscribe(aLong -&gt; System.out.println(Thread.currentThread().getName() + <span class="hljs-string">"："</span> + aLong));
        System.in.read();
    }
</code></pre>
<h4 data-id="heading-20">range &amp; rangeLong</h4>
<p>这两个方法用于创建一个发射连续整数序列的 Observable：</p>
<ul>
<li><code>range(start, count)</code>：发射 Integer 类型的连续整数。</li>
<li><code>rangeLong(start, count)</code>：发射 Long 类型的连续整数。</li>
</ul>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException {
        Observable.range(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>)
                .subscribe(integer -&gt; System.out.println(Thread.currentThread().getName() + <span class="hljs-string">"："</span> + integer));
        System.in.read();
    }
</code></pre>
<h4 data-id="heading-21">never、error、empty</h4>
<p>这三个方法都是创建特殊的 Observable 的工厂方法，用于特定的场景。</p>
<ul>
<li>never：创建一个永远不会发射任何数据，也不会终止的 Observable。</li>
<li>error：创建一个立即发射错误的 Observable。</li>
<li>empty：创建一个立即完成但不发射任何数据的 Observable。</li>
</ul>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// Observable.never()</span>
        <span class="hljs-comment">// Observable.error(new RuntimeException("error事件"))</span>
        Observable.empty()
                .subscribe(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Observer</span>() {
                    <span class="hljs-meta">@Override</span>
                    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSubscribe</span><span class="hljs-params">(Disposable d)</span> {
                        System.out.println(<span class="hljs-string">"开始订阅"</span>);
                    }

                    <span class="hljs-meta">@Override</span>
                    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onNext</span><span class="hljs-params">(Object s)</span> {
                        System.out.println(<span class="hljs-string">"观察者："</span> + s);
                    }

                    <span class="hljs-meta">@Override</span>
                    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onError</span><span class="hljs-params">(Throwable e)</span> {
                        System.out.println(<span class="hljs-string">"出现异常："</span> + e.getMessage());
                    }

                    <span class="hljs-meta">@Override</span>
                    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onComplete</span><span class="hljs-params">()</span> {
                        System.out.println(<span class="hljs-string">"订阅结束"</span>);
                    }
                });
    }
</code></pre>
<h3 data-id="heading-22">转换操作符</h3>
<p>转换操作符是 RxJava 中用于对 Observable 发射的数据进行变换、处理、组合的操作符，用于实现数据流的各种转换逻辑。</p>
<h4 data-id="heading-23">map</h4>
<p>map() 是 RxJava 中最基本、最常用的转换操作符，用于对 Observable 发射的每个元素进行一对一转换。</p>
<p>简单来说：输入一个值，输出另一个值（1进1出）。</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Observable.just(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)
                .map(number -&gt; <span class="hljs-string">"数字: "</span> + number)
                .subscribe(text -&gt; System.out.println(text));
    }
</code></pre>
<h4 data-id="heading-24">flatMap</h4>
<p>flatMap() 用于将每个发射项转换为 Observable，然后"扁平化"合并成一个 Observable。
简单来说：输入一个值，可以输出任意多个值（1进N出）。</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Observable.just(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>)
                .map(letter -&gt; letter + <span class="hljs-string">"1"</span>)
                .subscribe(result -&gt; System.out.print(result + <span class="hljs-string">" "</span>));
        <span class="hljs-comment">// 输出: A1 B1</span>

        <span class="hljs-comment">// flatMap: 1对多转换</span>
        Observable.just(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>)
                .flatMap(letter -&gt;
                        Observable.just(letter + <span class="hljs-string">"1"</span>, letter + <span class="hljs-string">"2"</span>, letter + <span class="hljs-string">"3"</span>)
                )
                .subscribe(result -&gt; System.out.print(result + <span class="hljs-string">" "</span>));
        <span class="hljs-comment">// 输出: A1 A2 A3 B1 B2 B3</span>
    }
</code></pre>
<h4 data-id="heading-25">concatMap</h4>
<p>concatMap() 是 flatMap() 的顺序保持版本，它会严格按照原始顺序依次处理每个元素，只有前一个元素的 Observable 完成之后，才会处理下一个。
简单来说：flatMap是并发处理，concatMap是串行处理。</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException {
        Observable.just(<span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>)  <span class="hljs-comment">// 注意顺序：3, 1, 2</span>
                .flatMap(num -&gt;
                        Observable.just(num)
                                .delay(num, TimeUnit.SECONDS)  <span class="hljs-comment">// 延迟对应的秒数</span>
                )
                .subscribe(num -&gt; System.out.println(<span class="hljs-string">"flatMap: "</span> + num));
        <span class="hljs-comment">// 输出顺序：1 2 3（谁先完成谁先输出）</span>

        Observable.just(<span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
                .concatMap(num -&gt;
                        Observable.just(num)
                                .delay(num, TimeUnit.SECONDS)
                )
                .subscribe(num -&gt; System.out.println(<span class="hljs-string">"concatMap: "</span> + num));
        <span class="hljs-comment">// 输出顺序：3 1 2（严格保持原始顺序）</span>
        System.in.read();
    }
</code></pre>
<h4 data-id="heading-26">buffer</h4>
<p>buffer() 用于将 Observable 发射的数据项收集到集合中，然后一次性发射这些集合，而不是单个发射。
简单来说：把多个单独的数据"打包"成一批一起发射。</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Observable.range(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>)  <span class="hljs-comment">// 发射1-10</span>
                .buffer(<span class="hljs-number">3</span>)           <span class="hljs-comment">// 每3个一批</span>
                .subscribe(batch -&gt;
                        System.out.println(<span class="hljs-string">"批次: "</span> + batch)
                );

        <span class="hljs-comment">// 输出：</span>
        <span class="hljs-comment">// 批次: [1, 2, 3]</span>
        <span class="hljs-comment">// 批次: [2, 4, 6]</span>
        <span class="hljs-comment">// 批次: [7, 8, 9]</span>
        <span class="hljs-comment">// 批次: [10]           ← 最后一批不足3个</span>
    }
</code></pre>
<h4 data-id="heading-27">scan</h4>
<p>scan() 用于对 Observable 发射的数据进行累积计算，并发射每个中间结果。
简单来说：像 Excel 里的累计求和，每来一个新数据，就与前一个结果计算，并输出当前累计值。</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Observable.just(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)
                .scan(Integer::sum)
                .subscribe(result -&gt; System.out.print(result + <span class="hljs-string">" "</span>));

        <span class="hljs-comment">// 输出：</span>
        <span class="hljs-comment">// 1 3 6 10 15</span>

        <span class="hljs-comment">// 计算过程：</span>
        <span class="hljs-comment">// 初始：无种子值，第一次直接发射1</span>
        <span class="hljs-comment">// 1 + 2 = 3</span>
        <span class="hljs-comment">// 3 + 3 = 6</span>
        <span class="hljs-comment">// 6 + 4 = 10</span>
        <span class="hljs-comment">// 10 + 5 = 15</span>
    }
</code></pre>
<h4 data-id="heading-28">window</h4>
<p>window() 用于将 Observable 发射的数据分组到多个子 Observable 中，然后发射这些子 Observable 而不是单个数据项。
简单来说：创建多个"窗口"，每个窗口是一个 Observable，将数据分配到不同窗口中。</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// buffer: 直接发射List</span>
        Observable.range(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>)
                .buffer(<span class="hljs-number">2</span>)
                .subscribe(list -&gt;
                        System.out.println(<span class="hljs-string">"buffer输出List: "</span> + list)
                );

        <span class="hljs-comment">// window: 发射Observable，需要进一步处理</span>
        Observable.range(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>)
                .window(<span class="hljs-number">2</span>)
                .flatMapSingle(Observable::toList  <span class="hljs-comment">// 需要手动转换</span>
                )
                .subscribe(list -&gt;
                        System.out.println(<span class="hljs-string">"window输出List: "</span> + list)
                );

        <span class="hljs-comment">// 两者输出相同，但window更灵活：</span>
        <span class="hljs-comment">// 输出：</span>
        <span class="hljs-comment">// [1, 2]</span>
        <span class="hljs-comment">// [3, 4]</span>
        <span class="hljs-comment">// [5]</span>
    }
</code></pre>
<p>window 和 buffer 的区别就是：</p>
<ul>
<li>window 返回的是被观察者的集合。</li>
<li>buffer 返回的是数据的集合。</li>
</ul>
<h3 data-id="heading-29">过滤操作符</h3>
<p>过滤操作符用于从数据流中筛选出需要的数据，过滤掉不需要的数据。</p>
<h4 data-id="heading-30">filter</h4>
<p>filter() 是 RxJava 中最基本的过滤操作符，用于根据指定条件筛选 Observable 发射的数据，只让满足条件的数据通过，不满足条件的被过滤掉。</p>
<p>对每个数据项进行判断，返回 true则通过，返回 false则丢弃。</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Observable.range(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>)  <span class="hljs-comment">// 发射1-10</span>
                .filter(number -&gt; number % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>)  <span class="hljs-comment">// 只保留偶数</span>
                .subscribe(even -&gt; System.out.print(even + <span class="hljs-string">" "</span>));

        <span class="hljs-comment">// 输出：</span>
        <span class="hljs-comment">// 2 4 6 8 10</span>
    }
</code></pre>
<h4 data-id="heading-31">ofType</h4>
<p>ofType() 是一个类型过滤操作符，用于过滤 Observable 发射的数据，只保留指定类型的数据，其他类型的数据会被过滤掉。
核心思想：只让指定类型的数据通过，相当于 filter(item -&gt; item instanceof TargetType) 的简化版。</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Observable&lt;Object&gt; mixedObservable = Observable.just(
                <span class="hljs-string">"Hello"</span>,      <span class="hljs-comment">// String</span>
                <span class="hljs-number">123</span>,          <span class="hljs-comment">// Integer</span>
                <span class="hljs-number">45.6</span>,         <span class="hljs-comment">// Double</span>
                <span class="hljs-string">"World"</span>,      <span class="hljs-comment">// String</span>
                <span class="hljs-literal">true</span>,         <span class="hljs-comment">// Boolean</span>
                <span class="hljs-number">789</span>           <span class="hljs-comment">// Integer</span>
        );

        <span class="hljs-comment">// 只保留字符串类型</span>
        mixedObservable
                .ofType(String.class)
                .subscribe(str -&gt;
                        System.out.println(<span class="hljs-string">"字符串: "</span> + str)
                );

        <span class="hljs-comment">// 输出：</span>
        <span class="hljs-comment">// 字符串: Hello</span>
        <span class="hljs-comment">// 字符串: World</span>
    }
</code></pre>
<h4 data-id="heading-32">distinct</h4>
<p>distinct() 用于过滤 Observable 中重复的数据项，确保每个数据项只发射一次。
核心思想：去重，保证发射的数据序列中不包含重复元素。</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Observable.just(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1</span>)
                .distinct()
                .subscribe(num -&gt; System.out.print(num + <span class="hljs-string">" "</span>));

        <span class="hljs-comment">// 输出：</span>
        <span class="hljs-comment">// 1 2 3 4 5</span>
        <span class="hljs-comment">// 注意：最后的 1 也被去重了</span>
    }
</code></pre>
<h4 data-id="heading-33">skip &amp; skipLast</h4>
<ul>
<li>skip(n)：跳过 Observable 发射的前 n 个数据项。</li>
<li>skipLast(n)：跳过 Observable 发射的后 n 个数据项。</li>
</ul>
<p>核心思想：skip是"跳过开头"，skipLast是"跳过结尾"。</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Observable.create(emitter -&gt; {
                    emitter.onNext(<span class="hljs-number">1</span>);
                    emitter.onNext(<span class="hljs-number">2</span>);
                    emitter.onError(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"中间出错"</span>));
                })
                .skipLast(<span class="hljs-number">1</span>) 
                .subscribe(
                        num -&gt; System.out.println(<span class="hljs-string">"数据: "</span> + num),
                        error -&gt; System.err.println(<span class="hljs-string">"错误: "</span> + error.getMessage()),
                        () -&gt; System.out.println(<span class="hljs-string">"完成"</span>)
                );

        <span class="hljs-comment">// 输出：</span>
        <span class="hljs-comment">// 数据: 1</span>
        <span class="hljs-comment">// 错误: 中间出错</span>
    }
</code></pre>
<h4 data-id="heading-34">distinctUntilChanged</h4>
<p>distinctUntilChanged() 用于过滤掉连续重复的数据，只保留发生变化的数据。
核心思想：去重，但只去重连续相同的值，不连续出现的相同值会被保留。</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Observable.just(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>)
                .distinctUntilChanged()
                .subscribe(num -&gt; System.out.print(num + <span class="hljs-string">" "</span>));

        <span class="hljs-comment">// 输出：</span>
        <span class="hljs-comment">// 1 2 1 3 2 1</span>

        <span class="hljs-comment">// 解释：</span>
        <span class="hljs-comment">// 原始: 1, 1, 2, 2, 1, 3, 3, 2, 2, 1</span>
        <span class="hljs-comment">// 去重连续重复后: 1, 2, 1, 3, 2, 1</span>
        <span class="hljs-comment">// 注意：中间的 1 虽然出现过，但因为不连续，所以保留了</span>
    }
</code></pre>
<h4 data-id="heading-35">take</h4>
<p>take() 用于从 Observable 的开头取出指定数量的数据，然后完成。
核心思想：只取前 N 个数据，之后的数据忽略，Observable 提前完成。</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Observable.range(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>)  <span class="hljs-comment">// 发射1-10</span>
                .take(<span class="hljs-number">3</span>)             <span class="hljs-comment">// 只取前3个</span>
                .subscribe(
                        num -&gt; System.out.print(num + <span class="hljs-string">" "</span>),
                        error -&gt; {
                        },
                        () -&gt; System.out.println(<span class="hljs-string">"\n已完成"</span>)
                );

        <span class="hljs-comment">// 输出：</span>
        <span class="hljs-comment">// 1 2 3</span>
        <span class="hljs-comment">// 已完成</span>
        <span class="hljs-comment">// 注意：4-10 不会被发射</span>
    }
</code></pre>
<h4 data-id="heading-36">firstElement &amp; lastElement &amp; elementAt</h4>
<p>这三个操作符都用于从 Observable 中取出特定位置的单个元素：</p>
<ul>
<li><strong><code>firstElement()</code></strong>：取第一个元素</li>
<li><strong><code>lastElement()</code></strong>：取最后一个元素</li>
<li><strong><code>elementAt(index)</code></strong>：取指定索引位置的元素</li>
</ul>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Observable.range(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>)  <span class="hljs-comment">// 1,2,3,4,5</span>
                .firstElement()      <span class="hljs-comment">// 取第一个</span>
                .subscribe(
                        num -&gt; System.out.println(<span class="hljs-string">"第一个: "</span> + num),
                        error -&gt; {
                        },
                        () -&gt; System.out.println(<span class="hljs-string">"没有第一个元素"</span>)
                );

        <span class="hljs-comment">// 输出：</span>
        <span class="hljs-comment">// 第一个: 1</span>
    }
</code></pre>
<h3 data-id="heading-37">组合操作符</h3>
<p>组合操作符是 RxJava 中用于将多个 Observable 组合成一个 Observable 的操作符。它们处理多个数据流之间的关系，实现流的合并、连接、组合等操作。</p>
<h4 data-id="heading-38">concat</h4>
<p>concat() 用于顺序连接多个 Observable，前一个 Observable 完成后，才开始发射下一个 Observable 的数据。
核心思想：串行连接，保持顺序，像排队一样一个接一个。</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Observable&lt;String&gt; first = Observable.just(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>);
        Observable&lt;String&gt; second = Observable.just(<span class="hljs-string">"D"</span>, <span class="hljs-string">"E"</span>, <span class="hljs-string">"F"</span>);
        Observable&lt;String&gt; third = Observable.just(<span class="hljs-string">"G"</span>, <span class="hljs-string">"H"</span>);

        Observable.concat(first, second, third)
                .subscribe(
                        letter -&gt; System.out.print(letter + <span class="hljs-string">" "</span>),
                        error -&gt; {
                        },
                        () -&gt; System.out.println(<span class="hljs-string">"\n全部完成"</span>)
                );

        <span class="hljs-comment">// 输出：</span>
        <span class="hljs-comment">// A B C D E F G H</span>
        <span class="hljs-comment">// 全部完成</span>
        <span class="hljs-comment">// 严格按照 first → second → third 的顺序</span>
    }
</code></pre>
<h4 data-id="heading-39">concatArray</h4>
<p>concatArray() 是 concat() 的数组版本，用于顺序连接多个 Observable（以数组形式提供），功能与 concat() 完全相同，只是参数形式不同。</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 创建Observable数组</span>
        Observable&lt;String&gt;[] observables = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Observable</span>[]{
                Observable.just(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>),
                Observable.just(<span class="hljs-string">"C"</span>, <span class="hljs-string">"D"</span>, <span class="hljs-string">"E"</span>),
                Observable.just(<span class="hljs-string">"F"</span>, <span class="hljs-string">"G"</span>)
        };

        <span class="hljs-comment">// 使用 concatArray 连接</span>
        Observable.concatArray(observables)
                .subscribe(letter -&gt; System.out.print(letter + <span class="hljs-string">" "</span>));

        <span class="hljs-comment">// 输出：</span>
        <span class="hljs-comment">// A B C D E F G</span>
        <span class="hljs-comment">// 顺序连接所有数组中的Observable</span>
    }
</code></pre>
<h4 data-id="heading-40">merge</h4>
<p>merge() 用于并发合并多个 Observable，将所有数据按实际到达时间顺序混合发射。</p>
<p>核心思想：并行执行，谁先到谁先出，像多车道合并成单车道。</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        Observable&lt;Long&gt; fast = Observable.interval(<span class="hljs-number">100</span>, TimeUnit.MILLISECONDS)
                .map(i -&gt; i + <span class="hljs-number">100</span>)  <span class="hljs-comment">// 100, 101, 102...</span>
                .take(<span class="hljs-number">3</span>);
        Observable&lt;Long&gt; slow = Observable.interval(<span class="hljs-number">200</span>, TimeUnit.MILLISECONDS)
                .map(i -&gt; i + <span class="hljs-number">200</span>)  <span class="hljs-comment">// 200, 201, 202...</span>
                .take(<span class="hljs-number">3</span>);

        Observable.merge(fast, slow)
                .subscribe(num -&gt; System.out.print(num + <span class="hljs-string">" "</span>));

        Thread.sleep(<span class="hljs-number">1000</span>);

        <span class="hljs-comment">// 输出（实际时间顺序）：</span>
        <span class="hljs-comment">// 100 101 200 102 201 202</span>
        <span class="hljs-comment">// 解释：</span>
        <span class="hljs-comment">// 100ms: fast发射100</span>
        <span class="hljs-comment">// 200ms: slow发射200, fast发射101</span>
        <span class="hljs-comment">// 300ms: fast发射102</span>
        <span class="hljs-comment">// 400ms: slow发射201</span>
        <span class="hljs-comment">// 600ms: slow发射202</span>
    }
</code></pre>
<h4 data-id="heading-41">zip</h4>
<p>zip() 用于将多个 Observable 的数据按索引配对组合，像拉链一样一一对应。</p>
<p>核心思想：等待所有Observable都有数据，然后配对发射，以最短的Observable为准。</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Observable&lt;String&gt; letters = Observable.just(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>, <span class="hljs-string">"D"</span>);
        Observable&lt;Integer&gt; numbers = Observable.just(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>);

        Observable.zip(
                        letters,
                        numbers,
                        (letter, number) -&gt; letter + number
                )
                .subscribe(result -&gt; System.out.print(result + <span class="hljs-string">" "</span>));

        <span class="hljs-comment">// 输出：</span>
        <span class="hljs-comment">// A1 B2 C3</span>
        <span class="hljs-comment">// 注意：D 被丢弃了，因为 numbers 只有3个</span>

    }
</code></pre>
<h4 data-id="heading-42">startWith &amp; startWithArray</h4>
<p>这两个操作符都用于在 Observable 发射数据之前，先发射一些指定的数据，就像给数据流添加"开场白"。</p>
<ul>
<li>startWith()：添加单个元素或 Observable。</li>
<li>startWithArray()：添加多个元素（可变参数）。</li>
</ul>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// startWith: 添加单个元素</span>
        Observable.just(<span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>)
                .startWith(<span class="hljs-string">"A"</span>)
                .subscribe(letter -&gt; System.out.print(<span class="hljs-string">"startWith: "</span> + letter + <span class="hljs-string">" "</span>));

        <span class="hljs-comment">// startWithArray: 添加多个元素</span>
        Observable.just(<span class="hljs-string">"D"</span>, <span class="hljs-string">"E"</span>)
                .startWithArray(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>)
                .subscribe(letter -&gt; System.out.print(<span class="hljs-string">"startWithArray: "</span> + letter + <span class="hljs-string">" "</span>));

        <span class="hljs-comment">// 输出：</span>
        <span class="hljs-comment">// startWith: A B C</span>
        <span class="hljs-comment">// startWithArray: A B C D E</span>
    }
</code></pre>
<h4 data-id="heading-43">count</h4>
<p>count() 用于统计 Observable 发射的元素数量，返回一个发射单个计数值的 Observable。</p>
<p>核心思想：数一数发射了多少个元素。</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Observable.just(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>, <span class="hljs-string">"D"</span>, <span class="hljs-string">"E"</span>)
                .count()
                .subscribe(count -&gt;
                        System.out.println(<span class="hljs-string">"元素数量: "</span> + count)
                );

        <span class="hljs-comment">// 输出：</span>
        <span class="hljs-comment">// 元素数量: 5</span>
    }
</code></pre>
<h3 data-id="heading-44">功能操作符</h3>
<p>功能操作符是 RxJava 中用于辅助调试、监控、错误处理、资源管理和工具性功能的操作符。它们不直接处理数据流，而是提供辅助功能。</p>
<h4 data-id="heading-45">delay</h4>
<p>delay() 用于延迟发射 Observable 的数据，可以延迟整个流，也可以延迟每个元素。
核心思想：让数据"等一会儿"再发射。</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        System.out.println(<span class="hljs-string">"开始时间: "</span> + System.currentTimeMillis());

        Observable.just(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>)
                .delay(<span class="hljs-number">1</span>, TimeUnit.SECONDS)  <span class="hljs-comment">// 延迟1秒</span>
                .subscribe(item -&gt;
                        System.out.println(System.currentTimeMillis() + <span class="hljs-string">": "</span> + item)
                );

        Thread.sleep(<span class="hljs-number">2000</span>);

        <span class="hljs-comment">// 输出：</span>
        <span class="hljs-comment">// 开始时间: 1766569373459</span>
        <span class="hljs-comment">// 1766569374574: A</span>
        <span class="hljs-comment">// 1766569374580: B</span>
        <span class="hljs-comment">// 1766569374580: C</span>
        <span class="hljs-comment">// 注意：A,B,C几乎同时发射，都延迟了1秒</span>
    }
</code></pre>
<h4 data-id="heading-46">subscribeOn &amp; observerOn</h4>
<p>这两个操作符用于控制 Observable 在哪个线程上执行和观察，是 RxJava 线程调度的核心。</p>
<ul>
<li><strong><code>subscribeOn()</code></strong>：指定 Observable 执行在哪个线程</li>
<li><strong><code>observeOn()</code></strong>：指定 Observer 观察在哪个线程</li>
</ul>
<p>subscribeOn 示例：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        Observable.create(emitter -&gt; {
                    System.out.println(<span class="hljs-string">"执行线程: "</span> + Thread.currentThread().getName());
                    emitter.onNext(<span class="hljs-string">"数据"</span>);
                    emitter.onComplete();
                })
                .subscribeOn(Schedulers.io())  <span class="hljs-comment">// 在IO线程执行</span>
                .subscribe(data -&gt;
                        System.out.println(<span class="hljs-string">"接收线程: "</span> + Thread.currentThread().getName())
                );

        Thread.sleep(<span class="hljs-number">1000</span>);

        <span class="hljs-comment">// 输出：</span>
        <span class="hljs-comment">// 执行线程: RxCachedThreadScheduler-1</span>
        <span class="hljs-comment">// 接收线程: RxCachedThreadScheduler-1</span>
        <span class="hljs-comment">// 注意：执行和接收都在IO线程</span>
    }
</code></pre>
<p>observeOn 示例：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        Observable.create(emitter -&gt; {
                    System.out.println(<span class="hljs-string">"执行线程: "</span> + Thread.currentThread().getName());
                    emitter.onNext(<span class="hljs-string">"数据"</span>);
                    emitter.onComplete();
                })
                .observeOn(Schedulers.io())  <span class="hljs-comment">// 在IO线程接收</span>
                .subscribe(data -&gt;
                        System.out.println(<span class="hljs-string">"接收线程: "</span> + Thread.currentThread().getName())
                );

        Thread.sleep(<span class="hljs-number">1000</span>);

        <span class="hljs-comment">// 输出：</span>
        <span class="hljs-comment">// 执行线程: main</span>
        <span class="hljs-comment">// 接收线程: RxCachedThreadScheduler-1</span>
        <span class="hljs-comment">// 注意：执行在主线程，接收在IO线程</span>
    }
</code></pre>
<h4 data-id="heading-47">retry</h4>
<p>retry 用于在 Observable 发生错误时自动重试，实现错误恢复机制，直到成功或达到重试上限。</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">attempt</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>();

        Observable.create(emitter -&gt; {
                    attempt.getAndIncrement();
                    System.out.println(<span class="hljs-string">"第"</span> + attempt + <span class="hljs-string">"次尝试"</span>);
                    <span class="hljs-keyword">if</span> (attempt.get() &lt; <span class="hljs-number">3</span>) {
                        emitter.onError(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"随机失败"</span>));
                    } <span class="hljs-keyword">else</span> {
                        emitter.onNext(<span class="hljs-string">"成功"</span>);
                        emitter.onComplete();
                    }
                })
                .retry(<span class="hljs-number">2</span>)  <span class="hljs-comment">// 最多重试2次</span>
                .subscribe(
                        data -&gt; System.out.println(<span class="hljs-string">"结果: "</span> + data),
                        error -&gt; System.err.println(<span class="hljs-string">"最终失败: "</span> + error.getMessage())
                );

    <span class="hljs-comment">// 输出：</span>
    <span class="hljs-comment">// 第1次尝试</span>
    <span class="hljs-comment">// 第2次尝试</span>
    <span class="hljs-comment">// 第3次尝试</span>
    <span class="hljs-comment">// 结果: 成功</span>
    <span class="hljs-comment">// 尝试3次后成功（初始1次+重试2次）</span>
    }
</code></pre>
<h4 data-id="heading-48">retryUntil</h4>
<p>retryUntil 用于自定义重试停止条件，当条件满足时停止重试。</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">attempt</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>);
        Observable.create(emitter -&gt; {
                    <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> attempt.incrementAndGet();
                    System.out.println(<span class="hljs-string">"第"</span> + count + <span class="hljs-string">"次尝试"</span>);
                    <span class="hljs-keyword">if</span> (count &lt; <span class="hljs-number">3</span>) {
                        emitter.onError(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"失败"</span>));
                    } <span class="hljs-keyword">else</span> {
                        emitter.onNext(<span class="hljs-string">"成功"</span>);
                        emitter.onComplete();
                    }
                })
                .retryUntil(() -&gt; {
                    <span class="hljs-comment">// 返回 true 时停止重试</span>
                    <span class="hljs-keyword">return</span> attempt.get() &gt;= <span class="hljs-number">3</span>;  <span class="hljs-comment">// 尝试3次后停止</span>
                })
                .subscribe(
                        data -&gt; System.out.println(<span class="hljs-string">"结果: "</span> + data),
                        error -&gt; System.err.println(<span class="hljs-string">"最终失败: "</span> + error.getMessage())
                );

        <span class="hljs-comment">// 输出：</span>
        <span class="hljs-comment">// 第1次尝试</span>
        <span class="hljs-comment">// 第2次尝试</span>
        <span class="hljs-comment">// 第3次尝试</span>
        <span class="hljs-comment">// 结果: 成功</span>
    }
</code></pre>
<h3 data-id="heading-49">生命周期的功能操作符</h3>
<p>很多功能操作符贯穿整个发布订阅的生命周期中。</p>
<h4 data-id="heading-50">doOnSubscribe- 订阅时</h4>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Observable.just(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>)
                .doOnSubscribe(disposable -&gt;
                        System.out.println(<span class="hljs-string">"有人订阅了！"</span>)
                )
                .subscribe();
        <span class="hljs-comment">// 输出：</span>
        <span class="hljs-comment">// 有人订阅了！</span>
    }
</code></pre>
<h4 data-id="heading-51">doOnNext - 发射每个元素时</h4>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Observable.range(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>)
                .doOnNext(num -&gt;
                        System.out.println(<span class="hljs-string">"即将发射: "</span> + num)
                )
                .map(num -&gt; num * <span class="hljs-number">2</span>)
                .doOnNext(num -&gt;
                        System.out.println(<span class="hljs-string">"发射后: "</span> + num)
                )
                .subscribe();

        <span class="hljs-comment">// 输出：</span>
        <span class="hljs-comment">// 即将发射: 1</span>
        <span class="hljs-comment">// 发射后: 2</span>
        <span class="hljs-comment">// 即将发射: 2</span>
        <span class="hljs-comment">// 发射后: 4</span>
        <span class="hljs-comment">// 即将发射: 3</span>
        <span class="hljs-comment">// 发射后: 6</span>
    }
</code></pre>
<h4 data-id="heading-52">doAfterNext - 发射后执行</h4>
<pre><code class="hljs language-java" lang="java">Observable.just(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>)
    .doOnNext(item -&gt; 
        System.out.println(<span class="hljs-string">"发射前: "</span> + item)
    )
    .doAfterNext(item -&gt; 
        System.out.println(<span class="hljs-string">"发射后: "</span> + item)
    )
    .subscribe(item -&gt; 
        System.out.println(<span class="hljs-string">"接收: "</span> + item)
    );

<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 发射前: A</span>
<span class="hljs-comment">// 接收: A</span>
<span class="hljs-comment">// 发射后: A</span>
<span class="hljs-comment">// 发射前: B</span>
<span class="hljs-comment">// 接收: B</span>
<span class="hljs-comment">// 发射后: B</span>
<span class="hljs-comment">// 发射前: C</span>
<span class="hljs-comment">// 接收: C</span>
<span class="hljs-comment">// 发射后: C</span>
</code></pre>
<h4 data-id="heading-53">doOnError - 出错时</h4>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Observable.error(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"测试错误"</span>))
                .doOnError(error -&gt;
                        System.err.println(<span class="hljs-string">"捕获到错误: "</span> + error.getMessage())
                )
                .onErrorReturnItem(<span class="hljs-string">"默认值"</span>)
                .subscribe();

        <span class="hljs-comment">// 输出：</span>
        <span class="hljs-comment">// 捕获到错误: 测试错误</span>
    }
</code></pre>
<h4 data-id="heading-54">doOnComplete - 完成时</h4>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Observable.just(<span class="hljs-string">"任务1"</span>, <span class="hljs-string">"任务2"</span>)
                .doOnComplete(() -&gt;
                        System.out.println(<span class="hljs-string">"所有任务都完成了！"</span>)
                )
                .subscribe();

        <span class="hljs-comment">// 输出：</span>
        <span class="hljs-comment">// 所有任务都完成了！</span>
    }
</code></pre>
<h4 data-id="heading-55">doOnTerminate - 完成/错误前执行</h4>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 正常完成的情况</span>
        Observable.just(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>)
                .doOnTerminate(() -&gt;
                        System.out.println(<span class="hljs-string">"即将完成/出错"</span>)
                )
                .doOnComplete(() -&gt;
                        System.out.println(<span class="hljs-string">"doOnComplete"</span>)
                )
                .subscribe(
                        item -&gt; System.out.println(<span class="hljs-string">"接收: "</span> + item),
                        error -&gt; {
                        },
                        () -&gt; System.out.println(<span class="hljs-string">"onComplete"</span>)
                );

        <span class="hljs-comment">// 输出：</span>
        <span class="hljs-comment">// 接收: A</span>
        <span class="hljs-comment">// 接收: B</span>
        <span class="hljs-comment">// 即将完成/出错</span>
        <span class="hljs-comment">// doOnComplete</span>
        <span class="hljs-comment">// onComplete</span>

        <span class="hljs-comment">// 出错的情况</span>
        Observable.error(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"测试"</span>))
                .doOnTerminate(() -&gt;
                        System.out.println(<span class="hljs-string">"即将完成/出错"</span>)
                )
                .doOnError(error -&gt;
                        System.out.println(<span class="hljs-string">"doOnError: "</span> + error.getMessage())
                )
                .subscribe(
                        item -&gt; {
                        },
                        error -&gt; System.out.println(<span class="hljs-string">"onError: "</span> + error.getMessage())
                );

        <span class="hljs-comment">// 输出：</span>
        <span class="hljs-comment">// 即将完成/出错</span>
        <span class="hljs-comment">// doOnError: 测试</span>
        <span class="hljs-comment">// onError: 测试</span>

    }
</code></pre>
<h4 data-id="heading-56">doAfterTerminate - 完成/错误后执行</h4>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 正常完成的情况</span>
        Observable.just(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>)
                .doAfterTerminate(() -&gt;
                        System.out.println(<span class="hljs-string">"完成/出错后执行"</span>)
                )
                .doOnComplete(() -&gt;
                        System.out.println(<span class="hljs-string">"doOnComplete"</span>)
                )
                .subscribe(
                        item -&gt; System.out.println(<span class="hljs-string">"接收: "</span> + item),
                        error -&gt; {
                        },
                        () -&gt; System.out.println(<span class="hljs-string">"onComplete"</span>)
                );

        <span class="hljs-comment">// 输出：</span>
        <span class="hljs-comment">// 接收: A</span>
        <span class="hljs-comment">// 接收: B</span>
        <span class="hljs-comment">// doOnComplete</span>
        <span class="hljs-comment">// onComplete</span>
        <span class="hljs-comment">// 完成/出错后执行</span>

        <span class="hljs-comment">// 出错的情况</span>
        Observable.error(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"测试"</span>))
                .doAfterTerminate(() -&gt;
                        System.out.println(<span class="hljs-string">"完成/出错后执行"</span>)
                )
                .doOnError(error -&gt;
                        System.out.println(<span class="hljs-string">"doOnError: "</span> + error.getMessage())
                )
                .subscribe(
                        item -&gt; {
                        },
                        error -&gt; System.out.println(<span class="hljs-string">"onError: "</span> + error.getMessage())
                );

        <span class="hljs-comment">// 输出：</span>
        <span class="hljs-comment">// doOnError: 测试</span>
        <span class="hljs-comment">// onError: 测试</span>
        <span class="hljs-comment">// 完成/出错后执行</span>
    }
</code></pre>
<h4 data-id="heading-57">doOnDispose - 取消订阅时</h4>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        <span class="hljs-type">Disposable</span> <span class="hljs-variable">disposable</span> <span class="hljs-operator">=</span> Observable.interval(<span class="hljs-number">1</span>, TimeUnit.SECONDS)
                .doOnDispose(() -&gt;
                        System.out.println(<span class="hljs-string">"订阅被取消了"</span>)
                )
                .subscribe(num -&gt;
                        System.out.println(<span class="hljs-string">"计数: "</span> + num)
                );

        Thread.sleep(<span class="hljs-number">3500</span>);
        disposable.dispose();

        <span class="hljs-comment">// 输出：</span>
        <span class="hljs-comment">// 计数: 0</span>
        <span class="hljs-comment">// 计数: 1</span>
        <span class="hljs-comment">// 计数: 2</span>
        <span class="hljs-comment">// 订阅被取消了</span>
    }
</code></pre>
<h4 data-id="heading-58">doFinally - 最终执行</h4>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Observable.just(<span class="hljs-string">"数据"</span>)
                .doFinally(() -&gt;
                        System.out.println(<span class="hljs-string">"无论如何都会执行"</span>)
                )
                .subscribe();

        <span class="hljs-comment">// 输出：</span>
        <span class="hljs-comment">// 无论如何都会执行</span>
    }
</code></pre>
<h4 data-id="heading-59">doOnEach - 每个事件时</h4>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Observable.just(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>)
                .doOnEach(notification -&gt; {
                    <span class="hljs-keyword">if</span> (notification.isOnNext()) {
                        System.out.println(<span class="hljs-string">"发射: "</span> + notification.getValue());
                    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (notification.isOnComplete()) {
                        System.out.println(<span class="hljs-string">"完成"</span>);
                    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (notification.isOnError()) {
                        System.out.println(<span class="hljs-string">"错误: "</span> + notification.getError());
                    }
                })
                .subscribe();

        <span class="hljs-comment">// 输出：</span>
        <span class="hljs-comment">// 发射: A</span>
        <span class="hljs-comment">// 发射: B</span>
        <span class="hljs-comment">// 发射: C</span>
        <span class="hljs-comment">// 完成</span>
    }
</code></pre>
<h4 data-id="heading-60">doOnRequest - 请求时（背压相关）</h4>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Flowable.range(<span class="hljs-number">1</span>, <span class="hljs-number">100</span>)
                .doOnRequest(requested -&gt;
                        System.out.println(<span class="hljs-string">"下游请求了 "</span> + requested + <span class="hljs-string">" 个元素"</span>)
                )
                .subscribe(
                        num -&gt; System.out.println(<span class="hljs-string">"接收: "</span> + num),
                        error -&gt; {
                        },
                        () -&gt; System.out.println(<span class="hljs-string">"完成"</span>)
                );

    }
</code></pre>
<h2 data-id="heading-61">结束</h2>
<p>响应式编程确实需要一些时间来掌握，但一旦理解核心概念，你就会发现它在处理异步数据流时的强大之处。</p>
<p>从回调地狱到流畅的链式调用，从手忙脚乱的资源管理到智能的背压控制，响应式编程让复杂异步操作变得清晰可控。虽然学习曲线存在，但投入是值得的。</p>
<p>记住，不是所有场景都需要响应式。在合适的业务场景下使用，才能发挥最大价值。建议从实际项目的小模块开始尝试，逐步积累经验。</p>
<p>希望这篇内容能为你打开响应式编程的大门。编程之路就是不断学习的过程，保持好奇，继续探索吧！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SPA首屏加载速度优化！]]></title>    <link>https://juejin.cn/post/7588043318360014883</link>    <guid>https://juejin.cn/post/7588043318360014883</guid>    <pubDate>2025-12-28T01:29:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588043318360014883" data-draft-id="7588092534162374656" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SPA首屏加载速度优化！"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-28T01:29:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大知闲闲i"/> <meta itemprop="url" content="https://juejin.cn/user/3799545205237111"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SPA首屏加载速度优化！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3799545205237111/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大知闲闲i
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T01:29:58.000Z" title="Sun Dec 28 2025 01:29:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">⚡ 首屏加载速度为何如此重要？</h2>
<p>首屏加载时间（First Contentful Paint）是决定用户留存率的关键指标。据统计：</p>
<ul>
<li>
<p><strong>53%的用户</strong> 会在3秒内放弃加载缓慢的移动网站</p>
</li>
<li>
<p><strong>每提高1秒</strong> 的加载速度，转化率提升7%</p>
</li>
<li>
<p>Google已将页面速度纳入搜索排名因素</p>
</li>
</ul>
<h2 data-id="heading-1">🔍 精准诊断：你的应用到底"慢"在哪里？</h2>
<h3 data-id="heading-2">首屏时间计算方法</h3>
<pre><code class="hljs language-ini" lang="ini">// 现代浏览器API
const <span class="hljs-attr">getFirstContentfulPaint</span> = () =&gt; {
  const <span class="hljs-section">[entry]</span> = performance.getEntriesByName('first-contentful-paint')<span class="hljs-comment">;</span>
  return entry.startTime<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
​
// 传统计算方法
const <span class="hljs-attr">firstScreenTime</span> = () =&gt; {
  return performance.timing.domContentLoadedEventEnd - 
         performance.timing.navigationStart<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<h2 data-id="heading-3">🚀 七大核心理念：从根源解决加载问题</h2>
<h3 data-id="heading-4">一、代码分割：智能加载的艺术</h3>
<h4 data-id="heading-5">动态导入 + 路由懒加载</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 传统方式（不推荐）</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Home</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/views/Home.vue'</span>;
​
<span class="hljs-comment">// 现代化懒加载（强烈推荐）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">Home</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-keyword">import</span>(<span class="hljs-comment">/* webpackChunkName: "home" */</span> <span class="hljs-string">'@/views/Home.vue'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title function_">About</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-keyword">import</span>(<span class="hljs-comment">/* webpackChunkName: "about" */</span> <span class="hljs-string">'@/views/About.vue'</span>);
​
<span class="hljs-comment">// Vue Router配置</span>
<span class="hljs-keyword">const</span> routes = [
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/views/Home.vue'</span>),
    <span class="hljs-attr">meta</span>: { <span class="hljs-attr">preload</span>: <span class="hljs-literal">true</span> } <span class="hljs-comment">// 关键路由预加载标记</span>
  }
];
​
<span class="hljs-comment">// 预加载策略</span>
router.<span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">(<span class="hljs-params">to, <span class="hljs-keyword">from</span>, next</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> preloadList = to.<span class="hljs-property">matched</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">meta</span>.<span class="hljs-property">preload</span>);
  preloadList.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">route</span> =&gt;</span> {
    route.<span class="hljs-property">components</span>.<span class="hljs-title function_">default</span>().<span class="hljs-keyword">catch</span>(<span class="hljs-function">() =&gt;</span> {});
  });
  <span class="hljs-title function_">next</span>();
});
</code></pre>
<h3 data-id="heading-6">二、Tree Shaking：剔除无用代码</h3>
<h4 data-id="heading-7">Webpack配置优化</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">//</span> <span class="hljs-string">webpack.config.js</span>
<span class="hljs-string">module.exports</span> <span class="hljs-string">=</span> {
  <span class="hljs-attr">mode:</span> <span class="hljs-string">'production'</span>,
  <span class="hljs-attr">optimization:</span> {
    <span class="hljs-attr">usedExports:</span> <span class="hljs-literal">true</span>, <span class="hljs-string">//</span> <span class="hljs-string">标记未使用代码</span>
    <span class="hljs-attr">minimize:</span> <span class="hljs-literal">true</span>,
    <span class="hljs-attr">splitChunks:</span> {
      <span class="hljs-attr">chunks:</span> <span class="hljs-string">'all'</span>,
      <span class="hljs-attr">minSize:</span> <span class="hljs-number">20000</span>,
      <span class="hljs-attr">maxSize:</span> <span class="hljs-number">244000</span>,
      <span class="hljs-attr">cacheGroups:</span> {
        <span class="hljs-attr">vendor:</span> {
          <span class="hljs-attr">test:</span> <span class="hljs-string">/</span>[<span class="hljs-string">\\/</span>]<span class="hljs-string">node_modules</span>[<span class="hljs-string">\\/</span>]<span class="hljs-string">/</span>,
          <span class="hljs-attr">name:</span> <span class="hljs-string">'vendors'</span>,
          <span class="hljs-attr">chunks:</span> <span class="hljs-string">'all'</span>,
          <span class="hljs-attr">priority:</span> <span class="hljs-number">10</span>,
          <span class="hljs-attr">reuseExistingChunk:</span> <span class="hljs-literal">true</span>
        },
        <span class="hljs-attr">common:</span> {
          <span class="hljs-attr">minChunks:</span> <span class="hljs-number">2</span>,
          <span class="hljs-attr">priority:</span> <span class="hljs-number">5</span>,
          <span class="hljs-attr">reuseExistingChunk:</span> <span class="hljs-literal">true</span>
        }
      }
    }
  }
}<span class="hljs-string">;</span>
</code></pre>
<h3 data-id="heading-8">三、UI框架按需加载：告别"全量"包袱</h3>
<h4 data-id="heading-9">Element-UI优化示例</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// .babelrc 配置</span>
{
  <span class="hljs-string">"plugins"</span>: [
    [
      <span class="hljs-string">"component"</span>,
      {
        <span class="hljs-string">"libraryName"</span>: <span class="hljs-string">"element-ui"</span>,
        <span class="hljs-string">"styleLibraryName"</span>: <span class="hljs-string">"theme-chalk"</span>
      }
    ]
  ]
}
​
<span class="hljs-comment">// 按需引入组件</span>
import Vue <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
import { Button, Select, Pagination } <span class="hljs-keyword">from</span> <span class="hljs-string">'element-ui'</span>;
​
Vue.<span class="hljs-keyword">use</span>(Button);
Vue.<span class="hljs-keyword">use</span>(Select);
Vue.<span class="hljs-keyword">use</span>(Pagination);
</code></pre>
<h3 data-id="heading-10">四、图片资源革命级优化</h3>
<h4 data-id="heading-11">现代图片处理方案</h4>
<pre><code class="hljs language-ini" lang="ini">// Vue图片懒加载指令
Vue.directive('lazy', {
  inserted: (el, binding) =&gt; {
    const <span class="hljs-attr">observer</span> = new IntersectionObserver((entries) =&gt; {
      entries.forEach(<span class="hljs-attr">entry</span> =&gt; {
        if (entry.isIntersecting) {
          const <span class="hljs-attr">img</span> = new Image()<span class="hljs-comment">;</span>
          <span class="hljs-attr">img.src</span> = binding.value<span class="hljs-comment">;</span>
          <span class="hljs-attr">img.onload</span> = () =&gt; {
            <span class="hljs-attr">el.src</span> = binding.value<span class="hljs-comment">;</span>
            el.classList.add('loaded')<span class="hljs-comment">;</span>
          }<span class="hljs-comment">;</span>
          observer.unobserve(el)<span class="hljs-comment">;</span>
        }
      })<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>
    observer.observe(el)<span class="hljs-comment">;</span>
  }
})<span class="hljs-comment">;</span>
​
// WebP自动降级方案
&lt;picture&gt;
  &lt;source <span class="hljs-attr">srcset</span>=<span class="hljs-string">"image.webp"</span> type=<span class="hljs-string">"image/webp"</span>&gt;
  &lt;source <span class="hljs-attr">srcset</span>=<span class="hljs-string">"image.jpg"</span> type=<span class="hljs-string">"image/jpeg"</span>&gt;
  &lt;img <span class="hljs-attr">src</span>=<span class="hljs-string">"image.jpg"</span> alt=<span class="hljs-string">"Description"</span>&gt;
&lt;/picture&gt;
</code></pre>
<h3 data-id="heading-12">五、缓存策略：极致利用浏览器能力</h3>
<h4 data-id="heading-13">多级缓存体系</h4>
<pre><code class="hljs language-ini" lang="ini">// Service Worker 缓存策略
const <span class="hljs-attr">CACHE_NAME</span> = <span class="hljs-string">'v1'</span><span class="hljs-comment">;</span>
const <span class="hljs-attr">urlsToCache</span> = [<span class="hljs-string">'/'</span>, <span class="hljs-string">'/styles/main.css'</span>, <span class="hljs-string">'/scripts/main.js'</span>]<span class="hljs-comment">;</span>
​
self.addEventListener('install', <span class="hljs-attr">event</span> =&gt; {
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then(<span class="hljs-attr">cache</span> =&gt; cache.addAll(urlsToCache))
  )<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
​
self.addEventListener('fetch', <span class="hljs-attr">event</span> =&gt; {
  event.respondWith(
    caches.match(event.request)
      .then(<span class="hljs-attr">response</span> =&gt; {
        if (response) return response<span class="hljs-comment">;</span>
        
        return fetch(event.request).then(<span class="hljs-attr">response</span> =&gt; {
          // 动态缓存重要资源
          if (event.request.url.includes('/api/critical')) {
            const <span class="hljs-attr">responseClone</span> = response.clone()<span class="hljs-comment">;</span>
            caches.open(CACHE_NAME).then(<span class="hljs-attr">cache</span> =&gt; {
              cache.put(event.request, responseClone)<span class="hljs-comment">;</span>
            })<span class="hljs-comment">;</span>
          }
          return response<span class="hljs-comment">;</span>
        })<span class="hljs-comment">;</span>
      })
  )<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-14">六、构建优化：发布前的最后冲刺</h3>
<h4 data-id="heading-15">Webpack高级配置</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// vue.config.js</span>
<span class="hljs-type">const</span> CompressionPlugin = <span class="hljs-built_in">require</span>(<span class="hljs-string">'compression-webpack-plugin'</span>);
<span class="hljs-type">const</span> BundleAnalyzerPlugin = <span class="hljs-built_in">require</span>(<span class="hljs-string">'webpack-bundle-analyzer'</span>).BundleAnalyzerPlugin;
​
<span class="hljs-keyword">module</span>.exports = {
  chainWebpack: config =&gt; {
    <span class="hljs-comment">// 打包分析</span>
    config.<span class="hljs-built_in">plugin</span>(<span class="hljs-string">'analyzer'</span>).<span class="hljs-built_in">use</span>(BundleAnalyzerPlugin);
    
    <span class="hljs-comment">// 移除 prefetch/preload</span>
    config.plugins.<span class="hljs-built_in">delete</span>(<span class="hljs-string">'prefetch'</span>);
    config.plugins.<span class="hljs-built_in">delete</span>(<span class="hljs-string">'preload'</span>);
    
    <span class="hljs-comment">// 压缩配置</span>
    config.optimization.<span class="hljs-built_in">minimize</span>(<span class="hljs-literal">true</span>);
    
    <span class="hljs-comment">// Gzip压缩</span>
    config.<span class="hljs-built_in">plugin</span>(<span class="hljs-string">'compression'</span>).<span class="hljs-built_in">use</span>(CompressionPlugin, [{
      algorithm: <span class="hljs-string">'gzip'</span>,
      test: /\.(js|css)$/,
      threshold: <span class="hljs-number">10240</span>,
      minRatio: <span class="hljs-number">0.8</span>
    }]);
    
    <span class="hljs-comment">// Brotli压缩（更高效）</span>
    config.<span class="hljs-built_in">plugin</span>(<span class="hljs-string">'brotli'</span>).<span class="hljs-built_in">use</span>(CompressionPlugin, [{
      algorithm: <span class="hljs-string">'brotliCompress'</span>,
      filename: <span class="hljs-string">'[path].br[query]'</span>,
      test: /\.(js|css|html|svg)$/,
      compressionOptions: { level: <span class="hljs-number">11</span> },
      threshold: <span class="hljs-number">10240</span>,
      minRatio: <span class="hljs-number">0.8</span>
    }]);
  }
};
</code></pre>
<h3 data-id="heading-16">七、服务端优化：全链路性能提升</h3>
<h4 data-id="heading-17">Nginx配置优化</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Gzip压缩配置</span>
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types 
    text/plain
    text/css
    text/xml
    text/javascript
    application/javascript
    application/xml+rss
    application/json
    image/svg+xml;
​
<span class="hljs-comment"># 缓存策略</span>
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
    expires 1y;
    add_header Cache-Control <span class="hljs-string">"public, immutable"</span>;
}
​
<span class="hljs-comment"># Brotli压缩（需要额外模块）</span>
brotli on;
brotli_comp_level 6;
brotli_types text/plain text/css application/json application/javascript;
</code></pre>
<h4 data-id="heading-18">Node.js Express优化</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">express</span> = <span class="hljs-keyword">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">compression</span> = <span class="hljs-keyword">require</span>(<span class="hljs-string">'compression'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">helmet</span> = <span class="hljs-keyword">require</span>(<span class="hljs-string">'helmet'</span>);
​
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">app</span> = <span class="hljs-title function_ invoke__">express</span>();
​
<span class="hljs-comment">// 安全头部</span>
app.<span class="hljs-keyword">use</span>(<span class="hljs-title function_ invoke__">helmet</span>({
  <span class="hljs-attr">contentSecurityPolicy</span>: <span class="hljs-literal">false</span>,
}));
​
<span class="hljs-comment">// 压缩中间件</span>
app.<span class="hljs-keyword">use</span>(<span class="hljs-title function_ invoke__">compression</span>({
  <span class="hljs-attr">level</span>: <span class="hljs-number">6</span>,
  <span class="hljs-attr">threshold</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">filter</span>: (req, res) =&gt; {
    <span class="hljs-keyword">if</span> (req.headers[<span class="hljs-string">'x-no-compression'</span>]) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> compression.<span class="hljs-title function_ invoke__">filter</span>(req, res);
  }
}));
​
<span class="hljs-comment">// 静态资源缓存</span>
app.<span class="hljs-keyword">use</span>(express.<span class="hljs-built_in">static</span>(<span class="hljs-string">'dist'</span>, {
  maxAge: <span class="hljs-string">'1y'</span>,
  setHeaders: (res, path) =&gt; {
    <span class="hljs-keyword">if</span> (path.<span class="hljs-title function_ invoke__">endsWith</span>(<span class="hljs-string">'.html'</span>)) {
      res.<span class="hljs-title function_ invoke__">setHeader</span>(<span class="hljs-string">'Cache-Control'</span>, <span class="hljs-string">'public, max-age=0'</span>);
    }
  }
}));
</code></pre>
<h2 data-id="heading-19">🎯 进阶方案：突破性能瓶颈</h2>
<h3 data-id="heading-20">1. SSR（服务端渲染）</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">//</span> <span class="hljs-string">Nuxt.js配置示例</span>
<span class="hljs-string">export</span> <span class="hljs-string">default</span> {
  <span class="hljs-attr">target:</span> <span class="hljs-string">'server'</span>,
  <span class="hljs-attr">render:</span> {
    <span class="hljs-string">//</span> <span class="hljs-string">开启HTTP/2推送</span>
    <span class="hljs-attr">http2:</span> {
      <span class="hljs-attr">push:</span> <span class="hljs-literal">true</span>
    },
    <span class="hljs-string">//</span> <span class="hljs-string">资源提示</span>
    <span class="hljs-attr">resourceHints:</span> <span class="hljs-literal">true</span>
  },
  <span class="hljs-attr">build:</span> {
    <span class="hljs-string">//</span> <span class="hljs-string">提取CSS</span>
    <span class="hljs-attr">extractCSS:</span> <span class="hljs-literal">true</span>,
    <span class="hljs-string">//</span> <span class="hljs-string">优化配置</span>
    <span class="hljs-attr">optimization:</span> {
      <span class="hljs-attr">splitChunks:</span> {
        <span class="hljs-attr">chunks:</span> <span class="hljs-string">'all'</span>,
        <span class="hljs-attr">automaticNameDelimiter:</span> <span class="hljs-string">'.'</span>,
        <span class="hljs-attr">name:</span> <span class="hljs-literal">true</span>,
        <span class="hljs-attr">maxSize:</span> <span class="hljs-number">256000</span>
      }
    }
  }
}<span class="hljs-string">;</span>
</code></pre>
<h3 data-id="heading-21">2. 预渲染关键路径</h3>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 使用prerender-spa-plugin</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PrerenderSPAPlugin</span> = <span class="hljs-keyword">require</span>(<span class="hljs-string">'prerender-spa-plugin'</span>);
​
module.exports = {
  plugins: [
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrerenderSPAPlugin</span>({
      staticDir: path.<span class="hljs-title function_ invoke__">join</span>(__dirname, <span class="hljs-string">'dist'</span>),
      routes: [<span class="hljs-string">'/'</span>, <span class="hljs-string">'/about'</span>, <span class="hljs-string">'/contact'</span>],
      renderer: <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrerenderSPAPlugin</span>.<span class="hljs-title function_ invoke__">PuppeteerRenderer</span>({
        <span class="hljs-attr">inject</span>: {},
        <span class="hljs-attr">renderAfterDocumentEvent</span>: <span class="hljs-string">'render-event'</span>
      })
    })
  ]
};
</code></pre>
<h3 data-id="heading-22">3. CDN动态加速</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 智能CDN选择 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">const</span> cdnList = [
    <span class="hljs-string">'https://cdn1.example.com'</span>,
    <span class="hljs-string">'https://cdn2.example.com'</span>,
    <span class="hljs-string">'https://cdn3.example.com'</span>
  ];
  
  <span class="hljs-comment">// 测速选择最快的CDN</span>
  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getFastestCDN</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> promises = cdnList.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">url</span> =&gt;</span> 
      <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`<span class="hljs-subst">${url}</span>/ping.txt`</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> ({
        url,
        <span class="hljs-attr">time</span>: performance.<span class="hljs-title function_">now</span>()
      })).<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-literal">null</span>)
    );
    
    <span class="hljs-keyword">const</span> results = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(promises);
    <span class="hljs-keyword">const</span> valid = results.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r !== <span class="hljs-literal">null</span>);
    valid.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">time</span> - b.<span class="hljs-property">time</span>);
    <span class="hljs-keyword">return</span> valid[<span class="hljs-number">0</span>].<span class="hljs-property">url</span>;
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h2 data-id="heading-23">📊 监控与持续优化</h2>
<h3 data-id="heading-24">性能监控仪表板</h3>
<pre><code class="hljs language-ini" lang="ini">// 实时性能监控
const <span class="hljs-attr">metrics</span> = {}<span class="hljs-comment">;</span>
​
// 收集性能数据
const <span class="hljs-attr">collectMetrics</span> = () =&gt; {
  const <span class="hljs-attr">paintMetrics</span> = performance.getEntriesByType(<span class="hljs-string">'paint'</span>)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">navigationMetrics</span> = performance.getEntriesByType(<span class="hljs-string">'navigation'</span>)[<span class="hljs-number">0</span>]<span class="hljs-comment">;</span>
  
  <span class="hljs-attr">metrics.FCP</span> = paintMetrics.find(m =&gt; m.name === <span class="hljs-string">'first-contentful-paint'</span>)<span class="hljs-comment">;</span>
  <span class="hljs-attr">metrics.LCP</span> = performance.getEntriesByName(<span class="hljs-string">'largest-contentful-paint'</span>)[<span class="hljs-number">0</span>]<span class="hljs-comment">;</span>
  <span class="hljs-attr">metrics.FID</span> = performance.getEntriesByName(<span class="hljs-string">'first-input'</span>)[<span class="hljs-number">0</span>]<span class="hljs-comment">;</span>
  
  // 发送到监控系统
  sendToAnalytics(metrics)<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
​
// 用户行为关联分析
const <span class="hljs-attr">correlateWithUserActions</span> = () =&gt; {
  // 关联加载性能与用户转化率
}<span class="hljs-comment">;</span>
</code></pre>
<h2 data-id="heading-25">🎁 总结：构建你的优化清单</h2>
<h3 data-id="heading-26">立即执行（今天就能做）</h3>
<ul>
<li>启用路由懒加载</li>
<li>配置Webpack代码分割</li>
<li>开启Gzip/Brotli压缩</li>
<li>优化图片格式和尺寸</li>
<li>设置合适的HTTP缓存头</li>
</ul>
<h3 data-id="heading-27">短期规划（1-2周）</h3>
<ul>
<li>实现Service Worker离线缓存</li>
<li>UI框架按需加载优化</li>
<li>关键资源预加载</li>
<li>部署CDN加速</li>
<li>添加性能监控</li>
</ul>
<h3 data-id="heading-28">长期战略（1-3个月）</h3>
<ul>
<li>实施SSR/SSG方案</li>
<li>建立性能预算机制</li>
<li>开发渐进式Web应用特性</li>
<li>建立自动化的性能测试流水线</li>
</ul>
<h2 data-id="heading-29">💡 终极思考</h2>
<p>首屏优化不是一次性任务，而是<strong>持续的过程</strong>。随着应用发展，需要：</p>
<ol>
<li>
<p><strong>建立性能文化</strong> - 让每个开发者都有性能意识</p>
</li>
<li>
<p><strong>设置性能预算</strong> - 为每个关键指标设置上限</p>
</li>
<li>
<p><strong>自动化监控</strong> - 实时发现问题，快速响应</p>
</li>
<li>
<p><strong>A/B测试</strong> - 用数据驱动优化决策</p>
</li>
</ol>
<p>记住：<strong>每一毫秒都值得争取</strong>，因为对于用户来说，速度不仅是一种功能，更是一种体验的保证。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MyBatis 动态 SQL 为什么这么灵活？背后靠的是 OGNL]]></title>    <link>https://juejin.cn/post/7588042910198087730</link>    <guid>https://juejin.cn/post/7588042910198087730</guid>    <pubDate>2025-12-27T11:01:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588042910198087730" data-draft-id="7588104741610061834" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MyBatis 动态 SQL 为什么这么灵活？背后靠的是 OGNL"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-27T11:01:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JavaEdge在掘金"/> <meta itemprop="url" content="https://juejin.cn/user/26044012176424"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MyBatis 动态 SQL 为什么这么灵活？背后靠的是 OGNL
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/26044012176424/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JavaEdge在掘金
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T11:01:05.000Z" title="Sat Dec 27 2025 11:01:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文已收录在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FJava-Edge%2FJava-Interview-Tutorial" target="_blank" title="https://github.com/Java-Edge/Java-Interview-Tutorial" ref="nofollow noopener noreferrer">Github</a>，<strong>关注我，紧跟本系列专栏文章，咱们下篇再续！</strong></p>
<ul>
<li>🚀 魔都架构师 | 全网30W技术追随者</li>
<li>🔧 大厂分布式系统/数据中台实战专家</li>
<li>🏆 主导交易系统百万级流量调优 &amp; 车联网平台架构</li>
<li>🧠 AIGC应用开发先行者 | 区块链落地实践者</li>
<li>🌍 以技术驱动创新，我们的征途是改变世界！</li>
<li>👉 实战干货：<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.javaedge.cn%2F" target="_blank" title="http://www.javaedge.cn/" ref="nofollow noopener noreferrer">编程严选网</a></li>
</ul>
<h2 data-id="heading-0">0 前言</h2>
<p><strong>OGNL（Object Graph Navigation Language，对象图导航语言）</strong>，在 Struts2 时代是绝对的核心，而在如今 Spring Boot 和 MyBatis 架构，依然在幕后扮演着极其关键的角色。</p>
<h2 data-id="heading-1">1 啥是 OGNL？</h2>
<p>如果把你的 Java 程序比作一座巨大的城市，里面的对象就是一栋栋大楼，而对象的属性就是大楼里的房间。</p>
<h3 data-id="heading-2">1.1 传统方式</h3>
<p>你想去某个房间，得亲自走楼梯、开门（手动编写 <code>getUser().getAddress().getCity()</code>）。如果中间有一个门锁了（为 <code>null</code>），你就摔倒了（NullPointerException）。</p>
<h3 data-id="heading-3">1.2 OGNL 方式</h3>
<p>你只需要输入一个地址字符串 <code>"user.address.city"</code>，OGNL 就像一个<strong>智能导航仪</strong>，自动帮你穿梭在大楼之间，找到那个房间并取出东西。</p>
<p>核心定义：OGNL 是一种表达式语言（EL），通过简单的字符串语法，就可存取 Java 对象树中的任意属性、调用方法、甚至进行简单的逻辑运算。</p>
<h2 data-id="heading-4">2 MyBatis 中的动态 SQL</h2>
<p>OGNL 是 MyBatis 动态 SQL 的灵魂。</p>
<h3 data-id="heading-5">2.1 业务背景</h3>
<p>假设你正在开发一个<strong>电商平台的订单搜索功能</strong>。用户可按订单状态、时间范围、关键词进行筛选。不用 OGNL，可能要写无数个 <code>if-else</code>。</p>
<h3 data-id="heading-6">2.2 落地实现</h3>
<p>MyBatis XML 看到的 test 表达式就是 OGNL：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;select <span class="hljs-attr">id</span>=<span class="hljs-string">"findOrders"</span> resultType=<span class="hljs-string">"Order"</span>&gt;
   SELECT * FROM orders
   WHERE <span class="hljs-attr">1</span>=<span class="hljs-number">1</span>
   &lt;if <span class="hljs-attr">test</span>=<span class="hljs-string">"status != null and status != ''"</span>&gt;
     AND status = <span class="hljs-comment">#{status}</span>
   &lt;/if&gt;
   &lt;if <span class="hljs-attr">test</span>=<span class="hljs-string">"keywords != null and keywords.length() &gt; 0"</span>&gt;
     AND title LIKE CONCAT('%', <span class="hljs-comment">#{keywords}, '%')</span>
   &lt;/if&gt;
 &lt;/select&gt;
</code></pre>
<p>为啥这要用 OGNL？因为它解耦“逻辑判断”和“SQL”。你无需在 Java 代码里拼装字符串，只需在 XML 里写简单的“导航公式”，OGNL 自动帮你解析参数对象里的值。</p>
<h2 data-id="heading-7">3 “热修改”与线上排查</h2>
<h3 data-id="heading-8">3.1 业务背景</h3>
<p>你的微服务已上线，突然发现某接口返回数据异常。你想知：<strong>现在内存里某个全局配置变量的值到底是多少？</strong> 或想在不重启服务时，<strong>临时修改一下某个 Bean 的开关状态</strong>。</p>
<h3 data-id="heading-9">3.2 落地实现：结合 Arthas</h3>
<p>Java 诊断利器 <strong>Arthas</strong> 深度集成 OGNL。可直接在命令行输入 OGNL 表达式来“窥探”运行中的系统。</p>
<h4 data-id="heading-10">查看静态变量的值</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看类中静态变量的值</span>
 ognl <span class="hljs-string">'@com.example.ConfigManager@getConfig().getTimeout()'</span>
</code></pre>
<h4 data-id="heading-11">线上“开挂”修改配置</h4>
<pre><code class="hljs language-swift" lang="swift"># 动态修改线上运行中的某个开关
 ognl '#config<span class="hljs-operator">=</span><span class="hljs-meta">@com</span>.example.<span class="hljs-type">ConfigManager</span><span class="hljs-meta">@instance</span>, #config.setEnableDebug(<span class="hljs-literal">true</span>)'
</code></pre>
<p>微服务架构下，节点众多，重启代价大。利用 OGNL 的<strong>动态执行能力</strong>，可在不触动代码前提下，精准观察和干预生产环境的对象状态。</p>
<h2 data-id="heading-12">4 避坑</h2>
<p>虽然 OGNL 很强大，但在分布式设计意：</p>
<h3 data-id="heading-13">性能损耗</h3>
<p>OGNL 毕竟是基于反射和解析的。在高性能、高并发的内层循环中，频繁使用复杂的表达式会导致 CPU 抖动。<strong>最佳实践</strong>：复杂的逻辑尽量在 Java 代码中处理好，传给 OGNL 的应该是“结果”。</p>
<h3 data-id="heading-14">安全风险</h3>
<p>这就是著名的“Struts2 漏洞”根源。如果你的系统允许用户输入 OGNL 表达式并在后台执行，攻击者可以通过构造特殊的字符串（如执行 <code>Runtime.getRuntime().exec("rm -rf /")</code>）来控制你的服务器。<strong>最佳实践</strong>：绝不要将用户输入的参数直接作为 OGNL 表达式执行。</p>
<h2 data-id="heading-15">5 总结</h2>
<p>OGNL 不是什么深奥的数学模型，它就是一个**“胶水工具”<strong>。它让</strong>字符串<strong>和</strong>内存对象**之间建立了一座桥梁：</p>
<ul>
<li>在 <strong>MyBatis</strong> 里，它是 SQL 的“指挥官”。</li>
<li>在 <strong>Arthas</strong> 里，它是线上的“透视镜”。</li>
<li>在 <strong>数据校验</strong> 里，它是灵活的“规则引擎”。</li>
</ul>
<p>掌握了 OGNL，你不仅能写出更优雅的动态 SQL，更能在系统出问题时，通过表达式直接与内存对话。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RBAC介绍以及如何设计一个简易且高可用的RBAC1的鉴权系统]]></title>    <link>https://juejin.cn/post/7588146449005461540</link>    <guid>https://juejin.cn/post/7588146449005461540</guid>    <pubDate>2025-12-27T11:32:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588146449005461540" data-draft-id="7588152122186416182" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RBAC介绍以及如何设计一个简易且高可用的RBAC1的鉴权系统"/> <meta itemprop="keywords" content="后端,架构"/> <meta itemprop="datePublished" content="2025-12-27T11:32:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Thanwinde"/> <meta itemprop="url" content="https://juejin.cn/user/634833993739484"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RBAC介绍以及如何设计一个简易且高可用的RBAC1的鉴权系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/634833993739484/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Thanwinde
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T11:32:52.000Z" title="Sat Dec 27 2025 11:32:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">RBAC介绍以及如何设计一个简易且高可用的RBAC1的鉴权系统</h2>
<h3 data-id="heading-1">一.RBAC0,RBAC1,RBAC2,RBAC3</h3>
<p>RBAC，即为<strong>以角色为基础的访问控制</strong>，不同于把权限赋予用户，而是把权限赋给角色，用户获得角色，是一种非常灵活的鉴权设计</p>
<p>其设计围绕着 <strong>用户 角色 权限（功能）</strong> 展开</p>
<h4 data-id="heading-2">（一）RBAC0</h4>
<p>RBAC0又叫<strong>扁平 RBAC（Flat RBAC）</strong> ，用户通过角色获取权限；通过多对多分配；用户可同时使用多个角色的权限 ；有用户-角色审查（能知道一个用户有多少角色）</p>
<p>假如有这么一个架构：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5874e142e5234e80b98a95c07e10ae02~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVGhhbndpbmRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767439971&amp;x-signature=lXtHx%2BBpXkLWDpO03JlHXNJmbOo%3D" alt="image-20251227163700084.png" loading="lazy"/></p>
<p>需要用RBAC0对其进行鉴权，结果会是这样：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98ccd5c6747f4eeabf31c62f70ef2b0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVGhhbndpbmRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767439971&amp;x-signature=scddnskH2VTxVi6zJMlsh89Th1M%3D" alt="image-20251227164146052.png" loading="lazy"/></p>
<p>如你所见，非常丑陋且复杂</p>
<p><strong>RBAC0不适用于处理权限复用的情况</strong>，更适应<strong>每个角色的权限都不同</strong>的情况</p>
<h4 data-id="heading-3">（二）RBAC1</h4>
<p>RBAC1又叫<strong>层次 RBAC(Hierarchical RBAC)</strong> ,<strong>包含扁平 RBAC</strong> ，支持角色层次结构（偏序关系），支持任意层次结构(2a型)，支持受限层次结构（如树状）（2b型）</p>
<p>翻译成人话就是在RBAC0加入了<strong>继承系统</strong>，举个例子：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a8dcef9412045af924d70d95ab9511b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVGhhbndpbmRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767439971&amp;x-signature=0f%2FFdqc%2BbTcIQ%2BaFWswF1QKEYXY%3D" alt="image-20251227164925444.png" loading="lazy"/></p>
<p>这就是一个典型的2b型的RBAC1系统，角色之间有<strong>偏序</strong>关系，可以<strong>继承</strong>：一个角色可以同时继承多个父角色的权限，获得了管理员权限就获得了商家，用户的权限</p>
<h4 data-id="heading-4">（三）RBAC2</h4>
<p>RBAC2又叫<strong>受限 RBAC (Constrained RBAC)</strong> ,<strong>包含层次 RBAC</strong>, 必须强制执行职责分离（SOD）,<strong>3a/3b:</strong> 分别对应任意或受限层次结构 。</p>
<p>SOD通过将行动或任务的责任和权限分散给多个用户，来减少欺诈和意外损害的可能性 ,也就是说不能<strong>当选手又当裁判</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e731ca0931949e08cf35e404c1356f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVGhhbndpbmRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767439971&amp;x-signature=94ekHgZgXLhQNibGaKHskaDEO4Q%3D" alt="image-20251227165737822.png" loading="lazy"/></p>
<p>本质上就是RBAC1 + SOD,要求要么具有<strong>SSD(静态职责分离，直接禁止你当选手又当裁判)</strong> ，要么具有<strong>DSD(动态职责分离，允许你当选手又当裁判，但不能同时当)</strong></p>
<p>较为复杂，SOD靠业务实现</p>
<h4 data-id="heading-5">（四）RBAC3</h4>
<p>RBAC3又叫<strong>对称 RBAC(Symmetric RBAC)</strong> ,<strong>包含受限 RBAC</strong> ,支持权限-角色审查（Permission-Role Review），其性能需与用户-角色审查相当</p>
<p>类似于RBAC0的用户-角色审查。系统必须能够知道<strong>特定角色分配了哪些权限</strong>，以及<strong>特定权限被分配给了哪些角色</strong></p>
<p>也就是加入了一个<strong>反推</strong>的操作，且性能要相当</p>
<p>既能<strong>role-&gt;perms</strong>，也能<strong>perm-&gt;roles</strong></p>
<p>为什么这里会单独提出一个反推的功能？</p>
<p>因为它<strong>在大型分布式系统中本质上很难实现</strong>。</p>
<ul>
<li><strong>非对称性：</strong> 大多数访问控制系统是为了快速回答“用户 X 能做什么？“而优化的，以便在用户登录或访问资源时快速鉴权。</li>
<li><strong>反向查询昂贵：</strong> 要回答“谁拥有权限 Y？”，通常需要反向遍历整个权限映射表。在拥有成千上万个权限和角色的系统中，如果系统架构不支持双向索引，这种查询的性能消耗巨大，类似于数据库中的全表扫描。</li>
</ul>
<h3 data-id="heading-6">如何设计一个高可用的RBAC1系统</h3>
<p>首先，在你要设计前，你应当知道你们业务的需求来决定应该选用哪一个级别的RBAC</p>
<p>实际上，在真正的生产应用阶段，<strong>绝大多数企业都是采用基于RBAC1，RBAC0或其变种再加上RBAC3的反推</strong>，因为<strong>SOD，层级其实很难实现</strong></p>
<p>但无论如何，RBAC鉴权系统的思路其实大差不差：<strong>访问快速，能承受一定压力，内存占用不大，支持热修改，支持分布式</strong></p>
<p>这里我以一个标准的RBAC1进行演示</p>
<h4 data-id="heading-7">（一）系统分析</h4>
<p>这里以Java为例</p>
<p>首先，鉴权系统必须处于系统<strong>最前方</strong>，但是有些接口并不需要鉴权，如何实现？我们大可以把鉴权放在<strong>拦截器</strong>，然后像SpringSecurity那样维护一个<strong>匹配表匹配哪些URL要鉴权</strong>，<strong>哪些URL要什么角色来访问</strong>，但既然引入了RBAC，本身就是为了<strong>更方便更细粒度</strong>的去鉴权。这里我给出的方法是设计一个<strong>注解</strong>，<strong>注解参数</strong>是访问此接口所需的权限，用<strong>AOP</strong>拦截具有这个注释的方法，检查访问的User有没有权限</p>
<p>为了获得访问的userId，可以采用ThreadLocal来存储，在网关截取Token放入Threadlocal</p>
<p>但我这里建议不要用ThreadLocal，直接在请求中注入userId到请求参数中，AOP中就从请求参数中拿带userId，这样用着更加方便，也避免了ThreadLocal<strong>内存泄漏</strong>的风险（概率极低）</p>
<p>具体来说：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Target</span>(ElementType.PARAMETER)
<span class="hljs-variable">@Retention</span>(RetentionPolicy.RUNTIME)
public <span class="hljs-variable">@interface</span> CurrentUserId {
}
</code></pre>
<p>这个注释用来放在userId前，用于AOP拿到userId，否则就需要从元数据中拿，非常不便</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Target</span>(ElementType.METHOD) <span class="hljs-comment">// 作用在方法上</span>
<span class="hljs-variable">@Retention</span>(RetentionPolicy.RUNTIME) <span class="hljs-comment">// 运行时有效</span>
public <span class="hljs-variable">@interface</span> RequirePermission {
​
    <span class="hljs-comment">/**
     * 需要的权限标识，例如: {"user:add", "user:edit"}
     */</span>
    <span class="hljs-selector-tag">String</span><span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">value</span>();
​
    <span class="hljs-comment">/**
     * 校验逻辑：AND (所有权限都要有) / OR (只要有一个权限即可)
     * 默认为 AND
     */</span>
    <span class="hljs-selector-tag">Logical</span> <span class="hljs-selector-tag">logical</span>() <span class="hljs-selector-tag">default</span> <span class="hljs-selector-tag">Logical</span><span class="hljs-selector-class">.AND</span>;
​
    <span class="hljs-selector-tag">enum</span> <span class="hljs-selector-tag">Logical</span> {
        <span class="hljs-selector-tag">AND</span>, <span class="hljs-selector-tag">OR</span>
    }
}
</code></pre>
<p>这里支持 或，与</p>
<pre><code class="hljs language-ini" lang="ini">@Before("@annotation(top.twindworld.treeauthority.demos.aop.annotation.RequirePermission)")
public void checkPermission(JoinPoint point) {
    // 1. 获取注解详情
    MethodSignature <span class="hljs-attr">signature</span> = (MethodSignature) point.getSignature()<span class="hljs-comment">;</span>
    Method <span class="hljs-attr">method</span> = signature.getMethod()<span class="hljs-comment">;</span>
    RequirePermission <span class="hljs-attr">annotation</span> = method.getAnnotation(RequirePermission.class)<span class="hljs-comment">;</span>
    if (<span class="hljs-attr">annotation</span> == null) {
        return<span class="hljs-comment">;</span>
    }
​
    // 2. 获取当前登录用户拥有的权限集合 (从 请求 中拿)
​
    Annotation<span class="hljs-section">[]</span><span class="hljs-section">[]</span> <span class="hljs-attr">paramAnnotations</span> = method.getParameterAnnotations()<span class="hljs-comment">;</span>
    // 获取所有参数值
    Object<span class="hljs-section">[]</span> <span class="hljs-attr">args</span> = point.getArgs()<span class="hljs-comment">;</span>
    Long <span class="hljs-attr">currentUserId</span> = null<span class="hljs-comment">;</span>
    for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; paramAnnotations.length; i++) {</span>
        for (Annotation a : paramAnnotations<span class="hljs-section">[i]</span>) {
            if (a instanceof CurrentUserId) {
                // 找到了！返回对应的参数值
                <span class="hljs-attr">currentUserId</span> = (Long) args[i]<span class="hljs-comment">;</span>
                break<span class="hljs-comment">;</span>
            }
        }
    }
    if (<span class="hljs-attr">currentUserId</span> == null) {
        throw new NoAuthorityException(401,"无法获取当前用户 ID，权限校验失败")<span class="hljs-comment">;</span>
    }
    Set&lt;String&gt; <span class="hljs-attr">roleKeys</span> = redisAuthorityService.getUserRoleKeys(currentUserId)<span class="hljs-comment">;</span>
    if (<span class="hljs-attr">roleKeys</span> == null || roleKeys.isEmpty()) {
        throw new NoAuthorityException(403, "用户暂无角色权限")<span class="hljs-comment">;</span>
    }
​
    // 3. 获取接口要求的权限
    String<span class="hljs-section">[]</span> <span class="hljs-attr">requiredPerms</span> = annotation.value()<span class="hljs-comment">;</span>
    RequirePermission.Logical <span class="hljs-attr">logical</span> = annotation.logical()<span class="hljs-comment">;</span>
​
    // 4. 开始校验
    HashSet&lt;String&gt; <span class="hljs-attr">functionSet</span> = new HashSet&lt;&gt;()<span class="hljs-comment">;</span>
    for (String roleKey : roleKeys) {
        functionSet.addAll(redisAuthorityService.getRoleFunctionKeys(roleKey))<span class="hljs-comment">;</span>
    }
    check(functionSet, requiredPerms, logical)<span class="hljs-comment">;</span>
}
</code></pre>
<p>用的时候就只需要这样：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">"/hello"</span>)
<span class="hljs-variable">@RequirePermission</span>(value = {<span class="hljs-string">"user:manage"</span>}, logical = RequirePermission.Logical.<span class="hljs-keyword">AND</span>)
public String <span class="hljs-built_in">hello</span>(<span class="hljs-variable">@CurrentUserId</span> Long userId) {
    <span class="hljs-selector-tag">return</span>  "<span class="hljs-selector-tag">hello</span>";
}
</code></pre>
<p>非常的简单方便！</p>
<h4 data-id="heading-8">（二）鉴权流程分析</h4>
<p>鉴权需要有 <strong>访问快速，能承受一定压力，内存占用不大，支持热修改，支持分布式</strong>的特点，那<strong>Redis</strong>便是一个非常好的一个选择</p>
<p>我们维护 <strong>user:{userId} = Set(roleKey)</strong> 和 <strong>role:{roleKey} = Set(functionKey)</strong></p>
<p>假如有一个用户进来，我们根据其userId到Redis查其role，再根据其role去拿到对应的functionKey,然后比对该注释中要求的功能（权限）这个用户满不满足，满足的话就放行，反之拦截</p>
<p>思路很简单，但有很多细节：<strong>用户的role是有继承关系的</strong>，假如一用户有一个role是admin，他可能继承了来着商家，用户的众多functions，Redis里面的role-&gt;functions也必须是<strong>己继承</strong>的，不然每一次鉴权都要去<strong>递归继承</strong></p>
<p>这是一个典型的为了读而牺牲写，但鉴权本身就是更倾向于读</p>
<p>在<strong>修改role的functions</strong>时，需要递归的修改其<strong>父角色（继承它的角色）</strong> 的functions，这是一个较为消耗性能的操作，但是role本身数据<strong>不多</strong>，还能接受</p>
<p>不采用<strong>user-&gt;functions</strong>的理由是，隐去了role，导致修改role的时候需要有一个<strong>反向索引</strong>去找到该role的user，这极其消耗性能，而且user数量众多，<strong>很占用内存</strong>，这也就是RBAC3的问题</p>
<p>而且为了节省内存，<strong>user-&gt;role</strong>也应该采用懒加载，不然用户数一多，一次加载直接卡死</p>
<p>对于TTL，<strong>user-&gt;role</strong>应该有TTL，一天半天都可，<strong>role-&gt;functions</strong>可以把TTL设为较长，因为这个数据本身修改的频率不大，在修改的时候修改即可</p>
<p>下面是流程图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25549a17e18b4002a2bde2c7115c4a00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVGhhbndpbmRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767439971&amp;x-signature=iF0f6O2beo2Lzho8QU9mf%2BAgh9E%3D" alt="image-20251227190322808.png" loading="lazy"/></p>
<p>修改流程：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82f1e18f1caa46bbb78e9d7a9e5949a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVGhhbndpbmRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767439971&amp;x-signature=WUY6ELUfdCzW%2BCYa1lvTEOxyBJk%3D" alt="image-20251227191152465.png" loading="lazy"/></p>
<hr/>
<p>大致流程便是如此，对于RBAC的更详细的介绍可以看<a href="https://link.juejin.cn?target=https%3A%2F%2Fcsrc.nist.gov%2FCSRC%2Fmedia%2FPublications%2Fconference-paper%2F2000%2F07%2F26%2Fthe-nist-model-for-role-based-access-control-towards-a-unified-%2Fdocuments%2Fsandhu-ferraiolo-kuhn-00.pdf" target="_blank" title="https://csrc.nist.gov/CSRC/media/Publications/conference-paper/2000/07/26/the-nist-model-for-role-based-access-control-towards-a-unified-/documents/sandhu-ferraiolo-kuhn-00.pdf" ref="nofollow noopener noreferrer">The NIST Model for Role-Based Access Control: Towards a Unified Standard</a></p>
<p>也可以看我在github中的小demo：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FThanwinde%2Ftree-authority" target="_blank" title="https://github.com/Thanwinde/tree-authority" ref="nofollow noopener noreferrer">Thanwinde/tree-authority: 一个简单的基于RBAC1的鉴权系统</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🎉 TRAE 一年使用的过程体验 🎉]]></title>    <link>https://juejin.cn/post/7588124225701953576</link>    <guid>https://juejin.cn/post/7588124225701953576</guid>    <pubDate>2025-12-28T01:48:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588124225701953576" data-draft-id="7588043318360031267" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🎉 TRAE 一年使用的过程体验 🎉"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-28T01:48:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大知闲闲i"/> <meta itemprop="url" content="https://juejin.cn/user/3799545205237111"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🎉 TRAE 一年使用的过程体验 🎉
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3799545205237111/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大知闲闲i
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T01:48:37.000Z" title="Sun Dec 28 2025 01:48:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言：编译革命，智造未来</h2>
<p>在2025年的数字浪潮中，我们迎来了一场编程范式的革命——TRAE AI编译器，这不是一次简单的技术迭代，而是一次开发者体验的量子飞跃！让我们揭开这场智能编译革命的神秘面纱。</p>
<h2 data-id="heading-1">1.TRAE AI编译器智能理解引擎</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 2025年你的高光时刻</span>
<span class="hljs-keyword">const</span> yourMilestones = {
  <span class="hljs-attr">fastestCompile</span>: {
    <span class="hljs-attr">date</span>: <span class="hljs-string">"2025-03-15"</span>,
    <span class="hljs-attr">project</span>: <span class="hljs-string">"xxxx框架"</span>,
    <span class="hljs-attr">time</span>: <span class="hljs-string">"0.8秒"</span>,
    <span class="hljs-attr">achievement</span>: <span class="hljs-string">"🚀 打破个人最快编译记录"</span>
  },
  <span class="hljs-attr">biggestOptimization</span>: {
    <span class="hljs-attr">date</span>: <span class="hljs-string">"2025-07-22"</span>, 
    <span class="hljs-attr">project</span>: <span class="hljs-string">"数据可视化平台"</span>,
    <span class="hljs-attr">improvement</span>: <span class="hljs-string">"编译时间减少76%"</span>,
    <span class="hljs-attr">memory</span>: <span class="hljs-string">"内存占用降低62%"</span>
  },
  <span class="hljs-attr">mostComplexProject</span>: {
    <span class="hljs-attr">date</span>: <span class="hljs-string">"2025-10-30"</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">"智能城市管理系统"</span>,
    <span class="hljs-attr">languages</span>: [<span class="hljs-string">"TypeScript"</span>, <span class="hljs-string">"Python"</span>, <span class="hljs-string">"Rust"</span>],
    <span class="hljs-attr">modules</span>: <span class="hljs-number">89</span>,
    <span class="hljs-attr">lines</span>: <span class="hljs-string">"42,317行"</span>
  }
  <span class="hljs-comment">//在写数据的时候TRAE智能推荐：简洁高效 ✅</span>
};

<span class="hljs-comment">// TRAE独有的跨语言智能优化</span>
<span class="hljs-comment">// 自动识别各语言最佳特性并融合</span>
​
<span class="hljs-comment">// TypeScript + Python风格混合（TRAE智能桥接）</span>
<span class="hljs-meta">@decorator</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> processData&lt;T&gt;(<span class="hljs-attr">data</span>: T[]): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Result</span>&gt; {
    <span class="hljs-comment">// 自动类型推断 + Python式列表推导</span>
    <span class="hljs-keyword">const</span> filtered = data.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> <span class="hljs-title function_">isValid</span>(x))
                         .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> <span class="hljs-title function_">transform</span>(x));
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-title function_">processBatch</span>(filtered);
}
</code></pre>
<p><strong>用户心声：</strong></p>
<blockquote>
<p>"就像有个编程大师在旁边指导，TRAE能理解我的意图，而不仅仅是执行指令！"</p>
<p>原本自己整理数据构建45分钟，现在平均只要25分钟。效率直接翻倍！"</p>
</blockquote>
<pre><code class="hljs language-markdown" lang="markdown">TRAE智能编译模式：
  智能模式:
<span class="hljs-bullet">    -</span> 自动分析项目结构
<span class="hljs-bullet">    -</span> 动态调整优化策略
<span class="hljs-bullet">    -</span> 学习团队协作模式
  
  性能模式:
<span class="hljs-bullet">    -</span> 极限速度优化
<span class="hljs-bullet">    -</span> 激进缓存策略
<span class="hljs-bullet">    -</span> 并行编译加速
<span class="hljs-code">    
  节能模式:
    - 智能资源管理
    - 后台静默编译
    - 电池友好优化
</span></code></pre>
<h2 data-id="heading-2">⚡ 效率提升时间线</h2>
<h3 data-id="heading-3">📅 2025年成长轨迹</h3>
<h3 data-id="heading-4">📸 年度时刻回顾</h3>
<pre><code class="hljs language-markdown" lang="markdown">✨ 难忘的编译瞬间：
<span class="hljs-bullet">1.</span> 最复杂的编译：涉及89个模块，42秒完成
<span class="hljs-bullet">2.</span> 最神奇的优化：一行建议节省3小时工作量  
<span class="hljs-bullet">3.</span> 最及时的预警：阻止了线上重大故障
<span class="hljs-bullet">4.</span> 最自豪的项目：为开源社区贡献核心优化
</code></pre>
<blockquote>
<p><strong>"优雅的代码不仅要能运行，更要会思考"</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 18 性能优化实战：5个被低估的Hooks用法让你的应用快30%]]></title>    <link>https://juejin.cn/post/7588093282530721844</link>    <guid>https://juejin.cn/post/7588093282530721844</guid>    <pubDate>2025-12-28T00:16:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588093282530721844" data-draft-id="7588092534162276352" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 18 性能优化实战：5个被低估的Hooks用法让你的应用快30%"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-28T00:16:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 18 性能优化实战：5个被低估的Hooks用法让你的应用快30%
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T00:16:45.000Z" title="Sun Dec 28 2025 00:16:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>React 18 性能优化实战：5个被低估的Hooks用法让你的应用快30%</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>React 18带来了许多令人兴奋的新特性，尤其是并发渲染（Concurrent Rendering）和自动批处理（Automatic Batching）等能力，进一步提升了应用的性能。然而，许多开发者在使用Hooks时仍停留在基础层面，未能充分利用其潜力。事实上，React Hooks的设计初衷不仅是为了简化状态逻辑的复用，还隐藏了许多可以显著提升性能的技巧。</p>
<p>本文将深入探讨5个被低估的Hooks用法，结合实战案例和性能分析，帮助你解锁React应用的额外性能潜力。这些技巧经过实际项目验证，合理使用后甚至能让应用速度提升30%以上。</p>
<hr/>
<h2 data-id="heading-2">主体</h2>
<h3 data-id="heading-3">1. <code>useMemo</code> + <code>useCallback</code>：避免不必要的子组件重渲染</h3>
<h4 data-id="heading-4">问题背景</h4>
<p>在React中，父组件的状态更新会导致所有子组件默认重新渲染，即使子组件的props并未变化。这种“过度渲染”在复杂应用中会带来明显的性能损耗。</p>
<h4 data-id="heading-5">优化方案</h4>
<p>通过<code>useMemo</code>和<code>useCallback</code>缓存值和函数，可以避免子组件的无效渲染：</p>
<ul>
<li><code>useMemo</code>：缓存计算结果，避免重复计算。</li>
<li><code>useCallback</code>：缓存函数引用，避免因函数重新创建导致的子组件更新。</li>
</ul>
<h4 data-id="heading-6">代码示例</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> <span class="hljs-title class_">ExpensiveComponent</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">memo</span>(<span class="hljs-function">(<span class="hljs-params">{ compute, data }</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">compute</span>(data);
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{result}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
});

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> data = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>], []); <span class="hljs-comment">// 缓存数据</span>
  <span class="hljs-keyword">const</span> compute = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> data.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a + b), []); <span class="hljs-comment">// 缓存函数</span>

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(c =&gt; c + 1)}&gt;Click {count}<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ExpensiveComponent</span> <span class="hljs-attr">compute</span>=<span class="hljs-string">{compute}</span> <span class="hljs-attr">data</span>=<span class="hljs-string">{data}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-7">性能收益</h4>
<ul>
<li><strong>减少子组件渲染次数</strong>：通过<code>React.memo</code>配合<code>useCallback</code>和<code>useMemo</code>，可以避免因父组件无关状态更新导致的子组件重渲染。</li>
<li><strong>降低计算开销</strong>：对于复杂计算或大数据处理，<code>useMemo</code>能显著减少重复计算的开销。</li>
</ul>
<hr/>
<h3 data-id="heading-8">2. <code>useTransition</code>：优先处理高优先级更新</h3>
<h4 data-id="heading-9">React并发特性的核心Hook</h4>
<p>React引入并发模式的核心目标之一是让应用能够区分“紧急”和“非紧急”更新。例如：用户在输入框中输入是紧急任务；而搜索结果的过滤可能是非紧急任务。</p>
<h4 data-id="heading-10"><code>useTransition</code>的作用</h4>
<p>它允许你将某些状态标记为“低优先级”，从而不阻塞用户交互：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();

<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleChange</span>(<span class="hljs-params">e</span>) {
   <span class="hljs-title function_">setInput</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>); <span class="hljs-comment">// High-priority update</span>
   <span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
     <span class="hljs-title function_">setFilteredData</span>(<span class="hljs-title function_">filter</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>)); <span class="hljs-comment">// Low-priority update</span>
   });
}
</code></pre>
<h4 data-id="heading-11"><strong>适用场景</strong></h4>
<ul>
<li><strong>搜索/过滤大列表</strong></li>
<li><strong>动态加载路由</strong></li>
</ul>
<hr/>
<p>###3．巧用Deferred Values (<code>defer</code>)
在某些情况下我们希望延迟某些UI内容的展示以避免闪烁或卡顿。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> deferredValue=<span class="hljs-title function_">unstable_deferredValue</span>(value)
</code></pre>
<p>当value变化时react会尝试延迟新ui内容的展示直到浏览器空闲时才完成绘制。</p>
<hr/>
<p>##总结</p>
<p>本文介绍了五个关键但常被忽视的react hooks技巧：</p>
<p>1．利用memoization hooks(<code> usememo</code>,<code>usecallback</code>)减少无效重渲柒
2．通过transition管理更新优先级以提升交互流畅度
3．使用deferred values推迟非关键内容加载</p>
<p>正确运用这些技术不仅能提高程序运行效率还能显著改善用户体验。</p>
<p>希望你能将这些方法应用到实际项目中并见证显著的性能提升！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前后端分离框架 CatchAdmin V5 beta.2 发布 插件化与开发效率的进一步提升]]></title>    <link>https://juejin.cn/post/7588146449005936676</link>    <guid>https://juejin.cn/post/7588146449005936676</guid>    <pubDate>2025-12-28T00:23:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588146449005936676" data-draft-id="7588300640599130118" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前后端分离框架 CatchAdmin V5 beta.2 发布 插件化与开发效率的进一步提升"/> <meta itemprop="keywords" content="后端,PHP,开源"/> <meta itemprop="datePublished" content="2025-12-28T00:23:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前后端分离框架 CatchAdmin V5 beta.2 发布 插件化与开发效率的进一步提升
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T00:23:07.000Z" title="Sun Dec 28 2025 00:23:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前后端分离框架 CatchAdmin V5 beta.2 发布 插件化与开发效率的进一步提升</h2>
<h3 data-id="heading-1">关于 CatchAdmin</h3>
<p>CatchAdmin 是一款基于 Laravel 和 Element Plus 二次开发而成后台管理系统。Laravel 社区也有许多非常优秀的后台管理系统，例如 Nova，官方出品，当然是收费的，免费的有基于 Livewire 的 Filament，还有不得不说的 Laravel Admin。它采用前后端分离架构，CatchAdmin 集成了 Token 鉴权、权限管理、动态路由、动态表格、分页封装、资源权限、上传下载、代码生成器支持一键导出导入，数据回收站，附件管理的一款模块化框架。Laravel 框架仅仅作为 Api 输出。将管理系统模块之间的耦合降到了最低限度。每个模块之间都有独立的控制器，路由，模型，数据表。在开发上尽可能将模块之间的影响降到最低，降低了开发上的难度。基于 CatchAdmin 可以开发 CMS，CRM，OA 等等系统。也封装了很多实用的工具，提升开发体验。</p>
<h3 data-id="heading-2">本次更新亮点</h3>
<h4 data-id="heading-3">导入导出功能增强</h4>
<p>Beta.3 版本对数据导入导出功能进行了核心层面的增强。在实际业务中，批量导入用户、订单、商品等数据是高频需求。此次更新优化了导入导出的底层逻辑，支持更大数据量的处理，并提供了更灵活的字段映射配置。在代码生成器中勾选"支持导入导出"，即可为模块自动生成完整的导入导出功能，无需手写 Excel 处理代码。</p>
<h4 data-id="heading-4">插件系统正式支持</h4>
<p>插件系统是 v5.0 的核心特性之一。CatchAdmin 没有自己发明一套插件机制，而是直接绑定 Composer 生态——任何符合 Laravel Package 规范的 Composer 包都可以作为 CatchAdmin 插件使用。</p>
<p>本次更新增强了插件安装的 Hook 功能，开发者可以在插件安装、卸载时执行自定义逻辑（如初始化配置、创建数据表等）。同时优化了插件安装页面，支持在后台可视化管理插件的启用、禁用与卸载。</p>
<p>这种设计让 CatchAdmin 可以无缝集成第三方服务（支付、短信、OSS 等），也方便将业务逻辑封装成插件在不同项目间复用。</p>
<h4 data-id="heading-5">SFC 远程加载性能优化</h4>
<p>CatchAdmin 的前端支持"即时渲染"，即无需编译即可直接加载 Vue 单文件组件（SFC）。这在开发阶段非常方便，但远程加载会影响首屏渲染速度。</p>
<p>Beta.3 版本优化了 SFC 的加载机制，通过缓存策略和按需加载，显著提升了页面渲染速度。在实际测试中，列表页的首次加载时间缩短了约 30%。</p>
<h4 data-id="heading-6">安装体验优化</h4>
<p>简化了项目初始化流程，修复了因 Composer 依赖冲突导致的安装失败问题。现在从创建项目到启动后台，整个过程更加流畅，基本不需要手动干预。</p>
<p>此外，左侧菜单现在支持自动更新——安装新模块或插件后，刷新页面即可看到对应的菜单项，无需手动配置路由。</p>
<h3 data-id="heading-7">插件市场已正式上线</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.vip%2Fplugins" target="_blank" title="https://catchadmin.vip/plugins" ref="nofollow noopener noreferrer">CatchAdmin 插件市场</a></p>
<h3 data-id="heading-8">快速开始</h3>
<pre><code class="hljs language-shell" lang="shell">composer global -W require catchadmin/installer
<span class="hljs-meta prompt_">
# </span><span class="bash">新建项目</span>
catch new catchadmin
<span class="hljs-meta prompt_">
# </span><span class="bash">安装项目</span>
cd catchadmin &amp;&amp; php artisan catch:install
<span class="hljs-meta prompt_">
# </span><span class="bash">启动项目</span>
composer run dev
</code></pre>
<h3 data-id="heading-9">功能</h3>
<ul>
<li>☑️<strong>用户管理</strong> 完成用户添加、修改、删除配置，支持不同用户登录后台看到不同的首页</li>
<li>☑️<strong>部门管理</strong> 部门组织机构（公司、部门、小组），树结构展现</li>
<li>☑️<strong>岗位管理</strong> 可以给用户配置所担任职务</li>
<li>☑️<strong>角色管理</strong> 树结构设计，支持角色菜单和按钮权限分配，支持角色数据权限分配、强大的角色管理体系</li>
<li>☑️<strong>菜单管理</strong> 配置系统菜单和按钮等</li>
<li>☑️<strong>字典管理</strong> 对系统中经常使用并且固定的数据可以重复使用和维护</li>
<li>☑️<strong>系统配置</strong> 系统的一些常用设置管理</li>
<li>☑️<strong>操作日志</strong> 用户对系统的一些正常操作的查询</li>
<li>☑️<strong>登录日志</strong> 用户登录系统的记录查询</li>
<li>☑️<strong>文件上传</strong> 支持<code>本地</code>、<code>七牛云</code>、<code>阿里云</code>、<code>腾讯云</code></li>
<li>☑️<strong>附件管理</strong> 管理当前系统上传的文件及图片等信息</li>
<li>☑️<strong>数据表维护</strong> 对系统的数据表可以进行清理碎片和优化，并且管理所有数据的回收和销毁</li>
<li>☑️<strong>代码生成</strong> 前后端代码的生成（php、vue、 数据库迁移），支持一键生成到模块</li>
<li>☑️<strong>支持 Vue 即时渲染</strong> 支持前端 Vue 即时渲染 无需编译</li>
<li>☑️<strong>支持插件系统</strong> CatchAdmin 插件即 Composer 包，无需再学一次插件开发，完全绑定 Composer 生态</li>
</ul>
<h3 data-id="heading-10">在线体验</h3>
<ul>
<li>演示地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpro.catchadmin.com" target="_blank" title="https://pro.catchadmin.com" ref="nofollow noopener noreferrer">pro.catchadmin.com</a></li>
<li>账户：<code>catch@admin.com</code></li>
<li>密码：<code>catchadmin</code></li>
</ul>
<h3 data-id="heading-11">项目地址</h3>
<ul>
<li>GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FJaguarJack%2Fcatch-admin" target="_blank" title="https://github.com/JaguarJack/catch-admin" ref="nofollow noopener noreferrer">github.com/JaguarJack/…</a></li>
<li>Gitee：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fcatchadmin%2Fcatchadmin" target="_blank" title="https://gitee.com/catchadmin/catchadmin" ref="nofollow noopener noreferrer">gitee.com/catchadmin/…</a></li>
</ul>
<h3 data-id="heading-12">界面预览</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22ee6d61947949968475529847960b10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmluZ29Hbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767486187&amp;x-signature=uVOz8TqSnNI%2B6GWQ1gworl5LlbI%3D" alt="CatchAdmin v5.0 Beta 欢迎页" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb362fcd7e3c48c59b7d84eecc518065~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmluZ29Hbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767486187&amp;x-signature=Wfz%2FYZH1Vy4OAaA6Mu3%2F2KiVMb0%3D" alt="CatchAdmin v5.0 Beta 数据面板" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc174d54e85a48119ad7980ab173deab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmluZ29Hbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767486187&amp;x-signature=Z9kJN6qRbScmi4IaSPDAQAb5GiA%3D" alt="CatchAdmin v5.0 Beta 用户管理" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c13ea608179b40529a6b16839966a644~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmluZ29Hbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767486187&amp;x-signature=ePYKf%2Bxi%2Ffwt4XYHV8gmKAQ7%2FY4%3D" alt="CatchAdmin v5.0 Beta 代码生成" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2025-12%2Fcatchadmin-v5-beta" target="_blank" title="https://catchadmin.com/post/2025-12/catchadmin-v5-beta" ref="nofollow noopener noreferrer">原文- 前后端分离框架 CatchAdmin V5 beta.2 发布 插件化与开发效率的进一步提升</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【金仓数据库】ksql 指南（五） —— 创建与管理索引和视图（KingbaseES 查询优化核心）]]></title>    <link>https://juejin.cn/post/7588086766249132083</link>    <guid>https://juejin.cn/post/7588086766249132083</guid>    <pubDate>2025-12-28T00:31:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588086766249132083" data-draft-id="7588104741610569738" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【金仓数据库】ksql 指南（五） —— 创建与管理索引和视图（KingbaseES 查询优化核心）"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2025-12-28T00:31:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="倔强的石头_"/> <meta itemprop="url" content="https://juejin.cn/user/3168119757484368"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【金仓数据库】ksql 指南（五） —— 创建与管理索引和视图（KingbaseES 查询优化核心）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3168119757484368/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    倔强的石头_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-28T00:31:10.000Z" title="Sun Dec 28 2025 00:31:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc9cfc399d0f419985382edb3f07627a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767486670&amp;x-signature=AVxDGNXwajtU%2BvM%2F5fUFSVnn7Ys%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">引言</h2>
<p>掌握表的基本运作之后，若想优化查询效率并简化数据访问，就要去学习“索引”和“视图”的运用，索引类似于“书籍目录”，可以极大地加快查询速度；视图类似“数据窗口”，能够隐藏复杂的查询逻辑，还能控制数据的可见性。本文就“ksql命令行操作索引与视图”展开论述，把从“作用到创建，再到查看，维持直至删除”的全过程拆解成实际操作步骤，并结合例子和避坑提示，以使初学者能够领悟并付诸实行。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/083024ed594c4e09b9016a8c2b6ae714~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767486670&amp;x-signature=UALdp3zTq4EqYHTIjbevxhKh5oY%3D" alt="" loading="lazy"/>
@[toc]</p>
<h3 data-id="heading-1">一、前置准备：确认操作基础（衔接前文，确保连贯）</h3>
<p>索引和视图要依托已有的表，所以得先做好如下预备工作（参照第四篇“表的运作”相关内容），以防止在操作过程中因为依赖缺失而出现错误提示。</p>
<h4 data-id="heading-2">1.1 1. 连接数据库并切换目标模式</h4>
<p>利用 ksql 建立与本地 KingbaseES 数据库的联系，转到先前所创建的 <code>test_schema</code> 模式当中，检查目标表是否确实存在（拿 <code>sys_user</code> 表来说，要是没有就再次创建它，或者用一个新的例子），这样做的目的是确保后续操作能够顺利执行。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 1. 连接数据库（若未连接）</span>
ksql <span class="hljs-operator">-</span>d kingbase <span class="hljs-operator">-</span>U <span class="hljs-keyword">system</span>
<span class="hljs-comment">-- 2. 切换到 test_schema 模式</span>
<span class="hljs-keyword">SET</span> search_path <span class="hljs-keyword">TO</span> test_schema, public;
<span class="hljs-comment">-- 3. 确认目标表存在（如 sys_user 表）</span>
\dt sys_user;
<span class="hljs-comment">-- 若不存在，创建示例表（用于后续索引/视图操作）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> sys_user (
    id SERIAL <span class="hljs-keyword">PRIMARY</span> KEY,
    name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    phone <span class="hljs-type">CHAR</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    create_time <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
) TABLESPACE test_ts;
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6b5c243932443dc8cbbe5de8c694016~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767486670&amp;x-signature=G0tY%2BgoaAjKp%2BF1KfEyucsXbhIc%3D" alt="image.png" loading="lazy"/></p>
<p>执行后若显示 <code>Table "test_schema.sys_user" does not exist</code>，则先执行上述 <code>CREATE TABLE</code> 语句创建表，确保后续操作有载体。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e52d9913afa04d62bf8f7261fa9de948~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767486670&amp;x-signature=N77MBA7G%2F%2B2aBjWlCDMeN4axOrU%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-3">1.2 2. 插入测试数据（用于验证索引 / 视图效果）</h4>
<p>为了后续可以检测索引的查询速度，并查看视图的数据展示情况，要给 <code>sys_user</code> 表增添大量模拟数据来做测试（能够添加上千条记录以模拟真实场景）。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 批量插入10条测试数据（可复制扩展）</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> test_schema.sys_user (name, phone, email)
<span class="hljs-keyword">VALUES</span> 
(<span class="hljs-string">'张三'</span>, <span class="hljs-string">'13800138000'</span>, <span class="hljs-string">'zhangsan@test.com'</span>),
(<span class="hljs-string">'李四'</span>, <span class="hljs-string">'13900139000'</span>, <span class="hljs-string">'lisi@test.com'</span>),
(<span class="hljs-string">'王五'</span>, <span class="hljs-string">'13700137000'</span>, <span class="hljs-string">'wangwu@test.com'</span>),
(<span class="hljs-string">'赵六'</span>, <span class="hljs-string">'13600136000'</span>, <span class="hljs-string">'zhaoliu@test.com'</span>),
(<span class="hljs-string">'孙七'</span>, <span class="hljs-string">'13500135000'</span>, <span class="hljs-string">'sunqi@test.com'</span>),
(<span class="hljs-string">'周八'</span>, <span class="hljs-string">'13400134000'</span>, <span class="hljs-string">'zhouba@test.com'</span>),
(<span class="hljs-string">'吴九'</span>, <span class="hljs-string">'13300133000'</span>, <span class="hljs-string">'wuj iu@test.com'</span>),
(<span class="hljs-string">'郑十'</span>, <span class="hljs-string">'13200132000'</span>, <span class="hljs-string">'zhengshi@test.com'</span>),
(<span class="hljs-string">'钱一'</span>, <span class="hljs-string">'13100131000'</span>, <span class="hljs-string">'qianyi@test.com'</span>),
(<span class="hljs-string">'冯二'</span>, <span class="hljs-string">'1300130000'</span>, <span class="hljs-string">'fenger@test.com'</span>);
</code></pre>
<p>执行后提示 <code>INSERT 0 10</code>，表示数据插入成功，为后续操作提供测试基础。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59643bed5b884fa09303c9fc83ac42c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767486670&amp;x-signature=iTjCqhECFdFCdPVi5bQevD7gOgg%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">二、索引管理：给表 “加目录”，加速查询</h3>
<p>索引是 KingbaseES 优化查询性能的核心手段 —— 当表数据量较大时（如 10 万条 +），无索引的查询会 “全表扫描”（逐行查找），而有索引的查询会通过 “索引目录” 直接定位数据，速度提升成百上千倍。接下来我们按 “创建→查看→维护→删除” 展开讲解</p>
<h4 data-id="heading-5">2.1 1. 先懂基础：索引的类型与适用场景</h4>
<p>新手需先明确不同索引的作用，避免盲目创建（索引并非越多越好，会增加更新 / 插入的开销）：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3218ac55b8574a06b17704a0c38641ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767486670&amp;x-signature=kLVGjxmrzyf8qmSLBew%2FUIHJ6UI%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-6">2.2 2. 创建索引：用 CREATE INDEX 语句</h4>
<h5 data-id="heading-7">2.2.1 示例 1：创建普通索引（加速单字段查询）</h5>
<p>给 <code>sys_user</code> 表的 <code>phone</code> 列建普通索引（频繁按手机号查用户时用）：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 语法：CREATE INDEX 索引名 ON 表名(字段名);</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_sys_user_phone <span class="hljs-keyword">ON</span> test_schema.sys_user(phone);
</code></pre>
<ul>
<li>
<p><strong>索引名规范</strong>提议采用“idx_表名_字段名”格式，这样便于识别，比如“idx_sys_user_phone”就表示“sys_user”表中“phone”列的索引。</p>
</li>
<li>
<p><strong>成功验证</strong>：执行后提示 <code>CREATE INDEX</code>，表示索引创建成功。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/527b8aecc1de4ab5be6cb6960a4936ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767486670&amp;x-signature=oT6oM8BhRa7lGD8VM7jXFvc5Dhg%3D" alt="image.png" loading="lazy"/></p>
</li>
</ul>
<h5 data-id="heading-8">2.2.2 示例 2：创建唯一索引（确保字段唯一 + 加速查询）</h5>
<p>给 <code>sys_user</code> 表的 <code>email</code> 列建唯一索引（既确保邮箱不重复，又加速邮箱查询）：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 语法：CREATE UNIQUE INDEX 索引名 ON 表名(字段名);</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> INDEX idx_sys_user_email <span class="hljs-keyword">ON</span> test_schema.sys_user(email);
</code></pre>
<ul>
<li><strong>与 UNIQUE 约束的区别</strong>：唯一索引只保证值唯一，UNIQUE 约束包含约束和唯一索引，如果表已有 <code>email</code> 的 UNIQUE 约束，则不必再创建 <code>email</code> 的唯一索引，因为约束本身就会生成索引。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/228788c91e354239973e35dfbcb69567~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767486670&amp;x-signature=jN3w8ln%2BrX3TTj6Qs2G%2F61B833w%3D" alt="image.png" loading="lazy"/></li>
</ul>
<h5 data-id="heading-9">2.2.3 示例 3：创建复合索引（加速多字段组合查询）</h5>
<p>为<code>sys_user</code>表的<code>name</code>和<code>create_time</code>列创建复合索引，当经常依照“姓名+创建时间范围”执行查询的时候会用到这个索引。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 语法：CREATE INDEX 索引名 ON 表名(字段1, 字段2);</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_sys_user_name_createtime <span class="hljs-keyword">ON</span> test_schema.sys_user(name, create_time);
</code></pre>
<ul>
<li><strong>字段顺序注意</strong>：复合索引依照“最左符合原则”，索引(name, create - time)可加强 name 单字段查询，也可加强 name + create - time 综合查询，但无法加强 create - time 单字段查询，要按照查询习惯来确定字段顺序。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91afcbbf23744aacabd6644e54c78b99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767486670&amp;x-signature=zpxIFWw%2FiFrNNV5nSbASD0SW9qg%3D" alt="image.png" loading="lazy"/></li>
</ul>
<h4 data-id="heading-10">2.3 3. 查看索引：确认索引存在与关联表</h4>
<p>创建索引后，需通过 ksql 命令查看索引列表、关联表及详情，推荐 <code>\di</code> 和 <code>\dt+</code> 命令：</p>
<h5 data-id="heading-11">2.3.1 示例 1：查看所有索引（\di 命令）</h5>
<p>执行 <code>\di</code> 可列出当前模式下的所有索引，确认索引是否创建成功：</p>
<pre><code class="hljs language-sql" lang="sql">\di
</code></pre>
<p><strong>执行结果示例：</strong></p>
<p><strong>关键信息解读：</strong></p>
<ul>
<li><code>Table</code>：索引关联的表（确认是 <code>sys_user</code>）；</li>
<li><code>Columns</code>：索引对应的字段（单字段 / 多字段）；</li>
<li><code>sys_user_pkey</code>：主键自动创建的索引（无需手动创建）。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56541cf7d7d64c03b258768b3382b26a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767486670&amp;x-signature=MOsNGgrmRvYTucwMhVc0zmpV90A%3D" alt="image.png" loading="lazy"/></li>
</ul>
<h5 data-id="heading-12">2.3.2 示例 2：查看表关联的索引（\dt+ 表名）</h5>
<p>若需查看某张表的所有索引（如 <code>sys_user</code>），执行 <code>\d+ 表名</code>：</p>
<pre><code class="hljs language-sql" lang="sql">\d<span class="hljs-operator">+</span> test_schema.sys_user
</code></pre>
<p><strong>执行结果示例（索引部分）：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bccf956d98dd4763ad219001dbdf466b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767486670&amp;x-signature=4h4ZhOa7304PY%2F5wnmph5m7%2B63E%3D" alt="463bec18ca0d0e9375930d3460bbb07c.png" loading="lazy"/></p>
<p>直接展示表关联的所有索引，包括类型（PRIMARY KEY/UNIQUE/ 普通）和字段，清晰直观。</p>
<h4 data-id="heading-13">2.4 4. 索引维护：优化性能与调整结构</h4>
<p>索引经过一定时间的使用之后，有可能会出现由于数据频繁被删除或者更新而造成的“碎片化”现象，即索引文件中存在许多空白空间，这种情况下要借助重建索引来改善这种情况，而且按照个人需求也可以重新命名或者直接删除索引。</p>
<h5 data-id="heading-14">2.4.1 示例 1：重建索引（解决碎片化，提升查询速度）</h5>
<p>当索引查询速度变慢时，重建索引可整理碎片，恢复性能（表大时建议离线执行，避免影响业务）：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 语法：REINDEX INDEX 索引名;</span>
REINDEX INDEX idx_sys_user_phone;
<span class="hljs-comment">-- 进阶：重建表的所有索引（更高效）</span>
REINDEX <span class="hljs-keyword">TABLE</span> sys_user;
</code></pre>
<ul>
<li><strong>成功验证</strong>：执行后提示 <code>REINDEX</code>，表示重建完成。</li>
</ul>
<h5 data-id="heading-15">2.4.2 示例 2：重命名索引（规范命名）</h5>
<p>索引名若不符合规范，可以重新命名，可以把<code>idx_sys_user_phone</code>改为<code>idx_sys_user_mobile</code>。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 语法：ALTER INDEX 旧索引名 RENAME TO 新索引名;</span>
<span class="hljs-keyword">ALTER</span> INDEX idx_sys_user_phone RENAME <span class="hljs-keyword">TO</span> idx_sys_user_mobile;
</code></pre>
<ul>
<li><strong>验证</strong>：执行 <code>\d+ test_schema.sys_user</code> 可看到索引名已更新。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e8979bd27dc4ef49a996e146018f802~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767486670&amp;x-signature=S1iUE%2BoaO3pWzk0noAv8QvNWpnc%3D" alt="6a3f5aa361f83070f3ae48b8f04c2a75.png" loading="lazy"/></li>
</ul>
<h5 data-id="heading-16">2.4.3 示例 3：删除索引（无用索引清理）</h5>
<p>某字段查询频率降低或者索引致使插入/更新变慢的时候，要删除无用索引（要注意的是，主键索引以及与唯一约束相关联的索引不能直接删，应当先删约束）。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 语法：DROP INDEX IF EXISTS 索引名;</span>
<span class="hljs-keyword">DROP</span> INDEX IF <span class="hljs-keyword">EXISTS</span> idx_sys_user_name_createtime;
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c368996dc523453e90de69be67e22b92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767486670&amp;x-signature=DdBnqlQ77Rh%2BUWelwD1vGqzT6o4%3D" alt="532407218768843c859b33c2822afad1.png" loading="lazy"/></p>
<ul>
<li><code>IF EXISTS</code>：避免索引不存在时报错，仅提示警告；</li>
<li><strong>验证</strong>：执行 <code>\d+ test_schema.sys_user</code> 确认索引已移除。</li>
</ul>
<h4 data-id="heading-17">2.5 5. 索引使用注意事项（新手避坑指南）</h4>
<ol>
<li><strong>索引并非越多越好</strong>，索引会加重插入，更新和删除时的开销，因为每当数据发生变动的时候，都要同步更新索引。所以一张表的索引最好别超过5个。</li>
<li><strong>小表不需要创建索引</strong>，当数据量小于1万条时，全表扫描比索引查询速度更快，因为索引查询要先查找索引再查找数据，这就多了一次IO操作。</li>
<li><strong>列如果经常更新就不要创建索引</strong>，比如“订单状态”这个字段（其值每秒都在变），给它创建索引之后，索引就会频繁地执行同步操作，从而影响到整体的性能表现。</li>
<li><strong>要避开对函数执行索引字段</strong>，像 <code>WHERE SUBSTR(phone,1,3) = '138'</code> 这种情况会使索引失效，应该改成 <code>WHERE phone LIKE '138%'</code>（前缀符合能够利用索引）。</li>
</ol>
<h3 data-id="heading-18">三、视图管理：给数据 “开窗口”，简化查询与控制权限</h3>
<p>视图属于“虚拟表”，它依靠SQL查询结果生成，并未储存实际数据（数据仍旧保存在原始表当中），其关键意义在于“隐匿复杂查询逻辑”以及“调控数据可见范围”（譬如仅仅向用户显示某些列），我们按照“创建 - 查看 - 操作 - 删除”的顺序来执行。</p>
<h4 data-id="heading-19">3.1 1. 先懂基础：视图的核心作用（新手必知）</h4>
<p>新手容易混淆 “表” 和 “视图”，用通俗比喻理解：</p>
<ul>
<li>表：“仓库”，存储实际数据；</li>
<li>视图名为“仓库窗口”，此视图仅显示指定区域的货物（数据），无法看到整个仓库的概貌，而且该窗口不可直接被修改，要经过此窗口去更改仓库的数据，不过存在一些限制。</li>
</ul>
<p>视图的核心场景：</p>
<ol>
<li><strong>简化复杂查询</strong>，多表关联查询（JOIN）可以被封装成视图，之后的查询直接针对该视图展开，不必再次书写复杂的 SQL 语句。</li>
<li><strong>数据权限控制方面</strong>，可以向普通用户展示 <code>sys_user</code> 表中 <code>name</code> 和 <code>phone</code> 字段的内容，而将 <code>email</code> 这类敏感信息遮盖起来，这要依靠视图来达成。</li>
<li><strong>数据一致性</strong>：多系统共用同一查询逻辑时，视图可确保所有系统使用相同的筛选条件。</li>
</ol>
<h4 data-id="heading-20">3.2 2. 创建视图：用 CREATE VIEW 语句</h4>
<h5 data-id="heading-21">3.2.1 示例 1：基础视图（简化单表查询）</h5>
<p>创建 “用户基础信息视图 <code>vw_sys_user_basic</code>”，只包含 <code>id</code>、<code>name</code>、<code>phone</code> 列（隐藏 <code>email</code> 敏感信息）：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 语法：CREATE VIEW 视图名 AS SELECT 语句;</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> vw_sys_user_basic <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> id, name, phone 
<span class="hljs-keyword">FROM</span> test_schema.sys_user;
</code></pre>
<ul>
<li><strong>成功验证</strong>：执行后提示 <code>CREATE VIEW</code>，表示视图创建成功。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05ca57890de246bb85db7ed9f73923ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767486670&amp;x-signature=oGrrH6dR5%2FucFT6g4JyG%2B6VY4O0%3D" alt="9c263f90-f43a-4c65-bd61-18968f051c79.png" loading="lazy"/></li>
</ul>
<h5 data-id="heading-22">3.2.2 示例 2：进阶视图（带筛选条件的复杂查询）</h5>
<p>创建 “2024 年创建的用户视图 <code>vw_sys_user_2024</code>”，筛选 <code>create_time</code> 在 2024 年的用户，包含 <code>name</code>、<code>email</code>、<code>create_time</code> 列：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> vw_sys_user_2024 <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> name, email, create_time 
<span class="hljs-keyword">FROM</span> test_schema.sys_user 
<span class="hljs-keyword">WHERE</span> create_time <span class="hljs-operator">&gt;=</span> <span class="hljs-string">'2024-01-01 00:00:00'</span> 
  <span class="hljs-keyword">AND</span> create_time <span class="hljs-operator">&lt;</span> <span class="hljs-string">'2025-01-01 00:00:00'</span>;
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e6a23dc074d4ef09e80dbdf141b4a85~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767486670&amp;x-signature=n85fvsOHRJn%2BemSkdr%2FYtN0Z4FE%3D" alt="b96dd12a-d747-4511-a1e9-210afc759dd3.png" loading="lazy"/></p>
<ul>
<li><strong>动态性</strong>：视图数据会随原表变化自动更新（如原表新增 2024 年用户，视图会自动包含该数据）。</li>
</ul>
<h5 data-id="heading-23">3.2.3 示例 3：只读视图（禁止修改数据）</h5>
<p>若需确保视图数据不被修改（如报表视图），可添加 <code>WITH READ ONLY</code> 选项：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> vw_sys_user_report <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> name, phone, create_time 
<span class="hljs-keyword">FROM</span> test_schema.sys_user 
<span class="hljs-keyword">WITH</span> READ <span class="hljs-keyword">ONLY</span>;
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac6edd45c0444862aeaa079aad4fb989~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767486670&amp;x-signature=fT4ClO1pAb7%2F9hzLM1RSd2vm8Po%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><strong>效果</strong>：后续若尝试通过视图修改数据（如 <code>UPDATE vw_sys_user_report SET name='张三'</code>），会报错 “cannot update a read-only view”。</li>
</ul>
<h4 data-id="heading-24">3.3 3. 查看视图：确认视图定义与关联表</h4>
<p>创建视图之后，要利用 ksql 命令来查看视图列表，定义以及相关联的表，建议使用 <code>\dv</code> 和 <code>\d+</code> 这两个命令。</p>
<h5 data-id="heading-25">3.3.1 示例 1：查看所有视图（\dv 命令）</h5>
<p>执行 <code>\dv</code> 可列出当前模式下的所有视图，确认视图是否创建成功：</p>
<p><strong>执行结果示例：</strong>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a400e2bd015e4b5799c9e6bf13ac4aeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767486670&amp;x-signature=nyfJoWN%2BDYSdNXhqQ3zH92q5SAo%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-26">3.3.2 示例 2：查看视图定义（\d+ 视图名）</h5>
<p>若需确认视图的底层 SQL（如忘记视图筛选条件），执行 <code>\d+ 视图名</code>：</p>
<pre><code class="hljs language-sql" lang="sql">\d<span class="hljs-operator">+</span> vw_sys_user_2024
</code></pre>
<p><strong>执行结果示例（定义部分）：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6a6f06047d040c6b0112b3af6eb9428~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767486670&amp;x-signature=jEBLtQrZwBeDNunk0pGdh7DzbOg%3D" alt="image.png" loading="lazy"/></p>
<p>直接展示视图的完整 SQL 定义，便于后续修改或验证逻辑。</p>
<h4 data-id="heading-27">3.4 4. 视图操作：查询、修改与删除</h4>
<p>视图的核心操作是 “查询”，修改和删除需遵循特定规则</p>
<h5 data-id="heading-28">3.4.1 示例 1：查询视图数据（与表查询一致）</h5>
<p>查询视图数据的语法和查询表完全相同，无需额外学习：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查询基础视图数据</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> vw_sys_user_basic;
<span class="hljs-comment">-- 查询2024年用户视图，按创建时间排序</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> vw_sys_user_2024 <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> create_time <span class="hljs-keyword">DESC</span>;
</code></pre>
<ul>
<li><strong>效果</strong>：返回结果与查询原表筛选后的数据一致，但看不到隐藏的列（如 <code>email</code> 在 <code>vw_sys_user_basic</code> 中不可见）。</li>
</ul>
<h5 data-id="heading-29">3.4.2 示例 2：修改视图定义（CREATE OR REPLACE）</h5>
<p>若需调整视图的筛选条件或列（如 <code>vw_sys_user_2024</code> 改为包含 2023 年数据），无需删除视图，直接用 <code>CREATE OR REPLACE</code> 修改：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">VIEW</span> vw_sys_user_2024 <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> name, email, create_time 
<span class="hljs-keyword">FROM</span> test_schema.sys_user 
<span class="hljs-keyword">WHERE</span> create_time <span class="hljs-operator">&gt;=</span> <span class="hljs-string">'2023-01-01 00:00:00'</span> 
  <span class="hljs-keyword">AND</span> create_time <span class="hljs-operator">&lt;</span> <span class="hljs-string">'2025-01-01 00:00:00'</span>;
</code></pre>
<ul>
<li><strong>验证</strong>：执行 <code>\d+ vw_sys_user_2024</code> 确认定义已更新。</li>
</ul>
<h5 data-id="heading-30">3.4.3 示例 3：删除视图（DROP VIEW）</h5>
<p>当视图不再使用时，执行删除命令（<strong>删除视图不影响原表数据</strong>，仅删除视图定义）：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 语法：DROP VIEW IF EXISTS 视图名;</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">VIEW</span> IF <span class="hljs-keyword">EXISTS</span> vw_sys_user_report;
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5db1de87c1814f35b1c307739b2d7462~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767486670&amp;x-signature=SZSaEVKxDZzT0owYyL9PPyLRCXw%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><strong>验证</strong>：执行 <code>\dv</code> 确认视图已移除。</li>
</ul>
<h4 data-id="heading-31">3.5 5. 视图使用注意事项（新手避坑指南）</h4>
<ol>
<li><strong>视图修改限制</strong>：含以下情况的视图无法修改数据（即使未加 <code>READ ONLY</code>）：
<ul>
<li>视图涵盖 <code>DISTINCT</code>（去重），<code>GROUP BY</code>（分组），<code>HAVING</code>（筛选分组）。</li>
<li>视图包含聚合函数（如 <code>COUNT</code>、<code>SUM</code>）；</li>
<li>视图来自多表关联（<code>JOIN</code>）；</li>
</ul>
</li>
<li><strong>原表删除影响</strong>：若原表（比如 <code>sys_user</code> 表）被删除，则该视图就会成为“无效视图”，在执行查询的时候，会收到“relation does not exist”的错误提示。</li>
<li><strong>性能注意</strong>：复杂视图包含多表关联或者聚合情况时，其查询效率依靠原表索引，所以要保证原表中相关联的字段已有索引，比如在多表 <code>JOIN</code> 操作里涉及的关联列就需要事先创建好索引。</li>
</ol>
<h3 data-id="heading-32">四、常见问题排查：索引与视图的高频报错</h3>
<h4 data-id="heading-33">问题 1：创建索引报错 “重复的键名”</h4>
<p><strong>报错信息</strong>：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">ERROR:  duplicate key name "idx_sys_user_phone"
</code></pre>
<p><strong>原因</strong>：同名索引已存在（如之前已创建 <code>idx_sys_user_phone</code>）。<br/>
<strong>解决方案</strong>：</p>
<ul>
<li>执行 <code>\di</code> 查看索引名，确认是否重复；</li>
<li>若需重新建索引，先删除旧索引（<code>DROP INDEX idx_sys_user_phone;</code>），再创建新索引。</li>
</ul>
<h4 data-id="heading-34">问题 2：查询视图报错 “关系对象不存在”</h4>
<p><strong>报错信息</strong>：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">ERROR:  relation "vw_sys_user_basic" does not exist
</code></pre>
<p><strong>原因</strong>：</p>
<ol>
<li>视图名拼写错误（如 <code>vw_sys_user_basci</code>）；</li>
<li>视图所在模式不在搜索路径中（如视图在 <code>test_schema</code>，但当前搜索路径是 <code>public</code>）。<br/>
<strong>解决方案</strong>：</li>
</ol>
<ul>
<li>检查视图名拼写（执行 <code>\dv</code> 确认正确名称）；</li>
<li>切换到视图所在模式（<code>SET search_path TO test_schema, public;</code>），或用 “模式名。视图名” 全称查询（<code>SELECT * FROM test_schema.vw_sys_user_basic;</code>）。</li>
</ul>
<h4 data-id="heading-35">问题 3：通过视图修改数据报错 “无法更新只读视图”</h4>
<p><strong>报错信息</strong>：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">ERROR:  cannot update a read-only view "vw_sys_user_report"
</code></pre>
<p><strong>原因</strong>：视图创建时加了 <code>WITH READ ONLY</code> 选项，禁止修改。<br/>
<strong>解决方案</strong>：</p>
<ul>
<li>
<p>若需允许修改，重新创建视图（去掉 <code>WITH READ ONLY</code>）：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">VIEW</span> vw_sys_user_report <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> name, phone, create_time <span class="hljs-keyword">FROM</span> sys_user;
</code></pre>
</li>
<li>
<p>注意：重新创建前需确认视图无修改限制（如不含 <code>GROUP BY</code>、聚合函数等）。</p>
</li>
</ul>
<h3 data-id="heading-36">五、总结：索引与视图的配合使用</h3>
<p>本文完整覆盖了索引和视图的核心操作，核心要点可总结为：</p>
<p>1.<strong>管理</strong>“查询速度”时，依照查询场景来挑选普通/唯一/复合索引，不要过度创建，要定时执行重建并改善性能。
2. <strong>视图</strong>：管 “查询简化与权限”，封装复杂逻辑、隐藏敏感数据，注意修改限制和原表依赖；</p>
<ol start="3">
<li><strong>配合使用</strong>：视图的查询速度与原表索引相关，给<code>vw_sys_user_2024</code>视图对应的<code>sys_user</code>原表创建<code>create - time</code>索引之后，其查询效率会得到很大的改善。</li>
</ol>
<p>掌握了索引和视图之后，你就具有了 KingbaseES 高效查询的关键能力，下篇文章我们会学习“用户与权限管理”，从而保障数据库访问的安全，并做到“不同用户访问不同数据”这样细致的控制。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（7）Hibernate的Session是什么？]]></title>    <link>https://juejin.cn/post/7588680081325686826</link>    <guid>https://juejin.cn/post/7588680081325686826</guid>    <pubDate>2025-12-27T23:14:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588680081325686826" data-draft-id="7588191506606276614" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（7）Hibernate的Session是什么？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-27T23:14:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（7）Hibernate的Session是什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T23:14:28.000Z" title="Sat Dec 27 2025 23:14:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Hibernate的<code>Session</code>是一个核心接口，它表示与数据库的单个会话。<code>Session</code>对象负责执行CRUD（创建、读取、更新、删除）操作，并将持久化对象的状态与数据库同步。每个<code>Session</code>对象都是短暂的，并且不应该在多个线程之间共享。</p>
<h3 data-id="heading-0">主要功能</h3>
<ol>
<li><strong>CRUD操作</strong>：使用<code>save</code>、<code>update</code>、<code>delete</code>等方法进行持久化操作。</li>
<li><strong>查询操作</strong>：通过HQL（Hibernate Query Language）或Criteria API执行数据库查询。</li>
<li><strong>事务管理</strong>：通过<code>beginTransaction</code>、<code>getTransaction</code>等方法管理事务。</li>
<li><strong>缓存管理</strong>：管理一级缓存（Session缓存），减少数据库访问次数。</li>
</ol>
<h3 data-id="heading-1">详细深入结合代码</h3>
<h4 data-id="heading-2">1. 获取Session</h4>
<p>通常，通过<code>SessionFactory</code>获取<code>Session</code>对象：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateUtil</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 创建SessionFactory</span>
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title function_">getSessionFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sessionFactory;
    }
}
</code></pre>
<h4 data-id="heading-3">2. 使用Session进行CRUD操作</h4>
<p>以下是一个完整的代码示例，展示如何使用<code>Session</code>进行CRUD操作。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 获取SessionFactory</span>
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> HibernateUtil.getSessionFactory();
        <span class="hljs-comment">// 打开一个新的Session</span>
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();

        <span class="hljs-comment">// 启动事务</span>
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();

        <span class="hljs-comment">// 创建并保存Student对象</span>
        <span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(<span class="hljs-string">"John Doe"</span>, <span class="hljs-number">20</span>);
        session.save(student); <span class="hljs-comment">// 保存对象</span>

        <span class="hljs-comment">// 提交事务</span>
        transaction.commit();

        <span class="hljs-comment">// 重新开始一个新的事务</span>
        transaction = session.beginTransaction();

        <span class="hljs-comment">// 读取Student对象</span>
        <span class="hljs-type">Student</span> <span class="hljs-variable">retrievedStudent</span> <span class="hljs-operator">=</span> session.get(Student.class, student.getId());
        System.out.println(<span class="hljs-string">"Retrieved Student: "</span> + retrievedStudent.getName() + <span class="hljs-string">", Age: "</span> + retrievedStudent.getAge());

        <span class="hljs-comment">// 更新Student对象</span>
        retrievedStudent.setAge(<span class="hljs-number">21</span>);
        session.update(retrievedStudent); <span class="hljs-comment">// 更新对象</span>

        <span class="hljs-comment">// 删除Student对象</span>
        session.delete(retrievedStudent); <span class="hljs-comment">// 删除对象</span>

        <span class="hljs-comment">// 提交事务</span>
        transaction.commit();

        <span class="hljs-comment">// 关闭Session</span>
        session.close();
        <span class="hljs-comment">// 关闭SessionFactory</span>
        sessionFactory.close();
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> {
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">()</span> {}

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age)</span> {
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-built_in">this</span>.age = age;
    }

    <span class="hljs-comment">// getters 和 setters</span>
    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> name;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-built_in">this</span>.name = name;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> age;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> {
        <span class="hljs-built_in">this</span>.age = age;
    }
}
</code></pre>
<h3 data-id="heading-4">详细解释</h3>
<ol>
<li><strong>获取SessionFactory</strong>：通过<code>HibernateUtil.getSessionFactory()</code>获取<code>SessionFactory</code>。</li>
<li><strong>打开Session</strong>：通过<code>sessionFactory.openSession()</code>打开一个新的<code>Session</code>。</li>
<li><strong>开始事务</strong>：通过<code>session.beginTransaction()</code>开始一个事务。</li>
<li><strong>CRUD操作</strong>：
<ul>
<li><strong>创建并保存对象</strong>：使用<code>session.save(student)</code>方法将对象持久化到数据库中。</li>
<li><strong>读取对象</strong>：使用<code>session.get(Student.class, student.getId())</code>方法从数据库中读取对象。</li>
<li><strong>更新对象</strong>：修改对象属性后，使用<code>session.update(retrievedStudent)</code>方法更新数据库中的记录。</li>
<li><strong>删除对象</strong>：使用<code>session.delete(retrievedStudent)</code>方法从数据库中删除对象。</li>
</ul>
</li>
<li><strong>提交事务</strong>：通过<code>transaction.commit()</code>提交事务，将所有更改同步到数据库。</li>
<li><strong>关闭Session</strong>：通过<code>session.close()</code>关闭<code>Session</code>。</li>
<li><strong>关闭SessionFactory</strong>：通过<code>sessionFactory.close()</code>关闭<code>SessionFactory</code>。</li>
</ol>
<h3 data-id="heading-5">事务管理</h3>
<p>在以上示例中，事务管理是一个关键部分。事务用于确保一组数据库操作要么全部成功，要么全部回滚，以保持数据的一致性。Hibernate通过<code>Session</code>对象提供了对事务的管理。</p>
<h4 data-id="heading-6">事务示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
<span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;

<span class="hljs-keyword">try</span> {
    transaction = session.beginTransaction();
    <span class="hljs-comment">// 执行一组数据库操作</span>
    session.save(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(<span class="hljs-string">"John Doe"</span>, <span class="hljs-number">20</span>));
    transaction.commit(); <span class="hljs-comment">// 提交事务</span>
} <span class="hljs-keyword">catch</span> (Exception e) {
    <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
        transaction.rollback(); <span class="hljs-comment">// 回滚事务</span>
    }
    e.printStackTrace();
} <span class="hljs-keyword">finally</span> {
    session.close(); <span class="hljs-comment">// 关闭Session</span>
}
</code></pre>
<p>在这个例子中，如果在事务中发生任何异常，事务将被回滚，确保数据库状态不受影响。</p>
<h3 data-id="heading-7">总结</h3>
<p>Hibernate的<code>Session</code>是一个功能强大的接口，用于处理持久化对象的生命周期管理。它提供了CRUD操作、查询、事务管理和缓存管理等功能，是Hibernate与数据库交互的核心组件。通过正确使用<code>Session</code>，开发者可以高效地进行数据库操作，同时确保数据的一致性和完整性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（8）什么是Hibernate的SessionFactory？]]></title>    <link>https://juejin.cn/post/7588300640599080966</link>    <guid>https://juejin.cn/post/7588300640599080966</guid>    <pubDate>2025-12-27T23:15:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588300640599080966" data-draft-id="7588152122186989622" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（8）什么是Hibernate的SessionFactory？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-27T23:15:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（8）什么是Hibernate的SessionFactory？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T23:15:44.000Z" title="Sat Dec 27 2025 23:15:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>SessionFactory</code>是Hibernate的核心组件之一，它负责创建和管理Session对象。<code>SessionFactory</code>是一个线程安全（thread-safe）的对象，通常在应用程序初始化时创建，并在整个应用程序运行期间存在。每个数据库需要一个唯一的<code>SessionFactory</code>实例，它充当连接数据库的工厂。</p>
<h3 data-id="heading-0">主要功能</h3>
<ol>
<li><strong>创建Session</strong>：负责创建新的<code>Session</code>对象。</li>
<li><strong>管理Session</strong>：管理已经创建的<code>Session</code>对象。</li>
<li><strong>缓存配置</strong>：为<code>Session</code>提供二级缓存支持。</li>
<li><strong>数据库连接管理</strong>：管理与数据库的连接。</li>
<li><strong>性能优化</strong>：通过缓存和连接池技术提高性能。</li>
</ol>
<h3 data-id="heading-1">创建SessionFactory</h3>
<p>通常，<code>SessionFactory</code>由配置文件（如<code>hibernate.cfg.xml</code>）配置，并在应用程序启动时通过<code>Configuration</code>对象创建。</p>
<h4 data-id="heading-2"><code>hibernate.cfg.xml</code> 示例</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">hibernate-configuration</span> <span class="hljs-keyword">PUBLIC</span>
        <span class="hljs-string">"-//Hibernate/Hibernate Configuration DTD 3.0//EN"</span>
        <span class="hljs-string">"http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 数据库连接配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.driver_class"</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.url"</span>&gt;</span>jdbc:mysql://localhost:3306/your_database<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.username"</span>&gt;</span>your_username<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.password"</span>&gt;</span>your_password<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- Hibernate 属性配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.show_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.format_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.hbm2ddl.auto"</span>&gt;</span>update<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 映射类配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Student"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h3 data-id="heading-3">使用SessionFactory</h3>
<p>通过<code>Configuration</code>对象读取配置文件并创建<code>SessionFactory</code>实例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateUtil</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 从配置文件创建SessionFactory</span>
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            <span class="hljs-comment">// 记录启动失败的错误</span>
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title function_">getSessionFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sessionFactory;
    }
}
</code></pre>
<h3 data-id="heading-4">使用Session进行操作</h3>
<p>以下是一个完整的例子，展示如何使用<code>SessionFactory</code>创建<code>Session</code>并进行CRUD操作：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 获取SessionFactory</span>
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> HibernateUtil.getSessionFactory();
        <span class="hljs-comment">// 打开一个新的Session</span>
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();

        <span class="hljs-comment">// 启动事务</span>
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();

        <span class="hljs-comment">// 创建并保存Student对象</span>
        <span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(<span class="hljs-string">"John Doe"</span>, <span class="hljs-number">20</span>);
        session.save(student); <span class="hljs-comment">// 保存对象</span>

        <span class="hljs-comment">// 提交事务</span>
        transaction.commit();

        <span class="hljs-comment">// 重新开始一个新的事务</span>
        transaction = session.beginTransaction();

        <span class="hljs-comment">// 读取Student对象</span>
        <span class="hljs-type">Student</span> <span class="hljs-variable">retrievedStudent</span> <span class="hljs-operator">=</span> session.get(Student.class, student.getId());
        System.out.println(<span class="hljs-string">"Retrieved Student: "</span> + retrievedStudent.getName() + <span class="hljs-string">", Age: "</span> + retrievedStudent.getAge());

        <span class="hljs-comment">// 更新Student对象</span>
        retrievedStudent.setAge(<span class="hljs-number">21</span>);
        session.update(retrievedStudent); <span class="hljs-comment">// 更新对象</span>

        <span class="hljs-comment">// 删除Student对象</span>
        session.delete(retrievedStudent); <span class="hljs-comment">// 删除对象</span>

        <span class="hljs-comment">// 提交事务</span>
        transaction.commit();

        <span class="hljs-comment">// 关闭Session</span>
        session.close();
        <span class="hljs-comment">// 关闭SessionFactory</span>
        sessionFactory.close();
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> {
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">()</span> {}

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age)</span> {
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-built_in">this</span>.age = age;
    }

    <span class="hljs-comment">// getters 和 setters</span>
    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> name;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-built_in">this</span>.name = name;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> age;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> {
        <span class="hljs-built_in">this</span>.age = age;
    }
}
</code></pre>
<h3 data-id="heading-5">详细解释</h3>
<ol>
<li><strong>配置SessionFactory</strong>：在<code>HibernateUtil</code>类中，通过<code>Configuration</code>对象读取<code>hibernate.cfg.xml</code>配置文件，创建<code>SessionFactory</code>实例。这个过程通常在应用程序启动时执行，并且<code>SessionFactory</code>在整个应用程序的生命周期中是单例的。</li>
<li><strong>获取Session</strong>：通过<code>SessionFactory.openSession()</code>方法获取新的<code>Session</code>对象。<code>Session</code>对象用于执行CRUD操作。</li>
<li><strong>启动事务</strong>：通过<code>session.beginTransaction()</code>方法启动事务。</li>
<li><strong>CRUD操作</strong>：
<ul>
<li><strong>创建并保存对象</strong>：使用<code>session.save(student)</code>方法将对象持久化到数据库中。</li>
<li><strong>读取对象</strong>：使用<code>session.get(Student.class, student.getId())</code>方法从数据库中读取对象。</li>
<li><strong>更新对象</strong>：修改对象属性后，使用<code>session.update(retrievedStudent)</code>方法更新数据库中的记录。</li>
<li><strong>删除对象</strong>：使用<code>session.delete(retrievedStudent)</code>方法从数据库中删除对象。</li>
</ul>
</li>
<li><strong>提交事务</strong>：通过<code>transaction.commit()</code>方法提交事务，将所有更改同步到数据库。</li>
<li><strong>关闭Session</strong>：通过<code>session.close()</code>方法关闭<code>Session</code>。</li>
<li><strong>关闭SessionFactory</strong>：通过<code>sessionFactory.close()</code>方法关闭<code>SessionFactory</code>。</li>
</ol>
<h3 data-id="heading-6">性能优化</h3>
<p><code>SessionFactory</code>还提供一些性能优化功能，例如：</p>
<ul>
<li><strong>二级缓存</strong>：通过配置二级缓存，减少对数据库的直接访问，提高性能。</li>
<li><strong>连接池管理</strong>：通过配置连接池，管理和优化数据库连接的使用。</li>
</ul>
<h4 data-id="heading-7">二级缓存配置示例</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 二级缓存配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.cache.use_second_level_cache"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.cache.region.factory_class"</span>&gt;</span>org.hibernate.cache.ehcache.EhCacheRegionFactory<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.cache.provider_class"</span>&gt;</span>org.hibernate.cache.EhCacheProvider<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<p>通过上述配置，启用Hibernate的二级缓存机制，可以显著提高应用程序性能。</p>
<h3 data-id="heading-8">总结</h3>
<p><code>SessionFactory</code>是Hibernate的核心组件之一，负责创建和管理<code>Session</code>对象，提供了数据库连接、缓存管理和性能优化等功能。在一个典型的Hibernate应用程序中，<code>SessionFactory</code>通常在应用程序启动时初始化，并在整个应用程序生命周期中使用。正确地使用<code>SessionFactory</code>和<code>Session</code>，可以有效地进行数据库操作，提高应用程序的性能和稳定性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RAG技术演进：从外部知识库到智能体核心记忆系统]]></title>    <link>https://juejin.cn/post/7588080521445523502</link>    <guid>https://juejin.cn/post/7588080521445523502</guid>    <pubDate>2025-12-27T16:24:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588080521445523502" data-draft-id="7588104741610455050" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RAG技术演进：从外部知识库到智能体核心记忆系统"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-27T16:24:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="moshuying"/> <meta itemprop="url" content="https://juejin.cn/user/2700056289356936"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RAG技术演进：从外部知识库到智能体核心记忆系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2700056289356936/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    moshuying
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T16:24:19.000Z" title="Sat Dec 27 2025 16:24:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">技术演进全景图</h3>
<p>检索增强生成技术自2020年提出以来，经历了明确的范式演进。以下时间轴概括了各核心范式出现的时间点与演进关系：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">timeline
    title RAG技术演进时间轴
    2020 : 朴素RAG奠基
         : 检索-生成基础架构
    2022 : 语义增强RAG兴起
         : 向量检索与多跳查询
    2023 : 多模态与图RAG发展
         : 跨模态检索与知识图谱
    2024 : 自适应与智能体RAG
         : 动态决策与工具调用

</code></pre>
<h3 data-id="heading-1">1. 基础范式：朴素RAG架构与局限性</h3>
<p>朴素RAG确立了“检索-增强-生成”的基础流水线，其架构直接反映了该核心思想。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[用户Query] --&gt; B[查询向量化]
    B --&gt; C[向量数据库检索]
    C --&gt; D[拼接上下文与Query]
    D --&gt; E[LLM生成]
    E --&gt; F[最终答案]

</code></pre>
<p>该范式的技术实现直接，但其局限性在工业场景中迅速暴露：</p>
<ol>
<li><strong>检索效率瓶颈</strong>：依赖TF-IDF/BM25等稀疏检索，在专业领域召回率常低于40%。</li>
<li><strong>上下文失真</strong>：固定长度文本切块导致超过30%的关键信息被割裂或丢失。</li>
<li><strong>生成可控性差</strong>：未经校准的检索结果直接输入生成器，导致事实错误率高达15-20%。</li>
</ol>
<p>此阶段RAG在通用问答基准上的F1值约为0.62，较纯生成模型提升有限，揭示了“垃圾进、垃圾出”的本质问题。</p>
<h3 data-id="heading-2">2. 语义增强范式：向量检索与多跳查询</h3>
<p>为突破基础范式的局限，语义增强RAG引入了稠密向量检索与多跳查询机制，其核心是<strong>通过语义理解提升检索精度</strong>。</p>
<ul>
<li><strong>稠密向量检索</strong>：采用双塔编码器（如Sentence-BERT），将查询与文档映射到同一768维语义空间，通过余弦相似度计算匹配度，使检索从关键词匹配升级为语义匹配。</li>
<li><strong>多跳检索</strong>：对于复杂查询，系统执行迭代检索。例如，对于“爱因斯坦在诺贝尔奖演讲中提到了谁的理论？”，系统可能首轮检索“爱因斯坦诺贝尔演讲”，从中提取关键实体（如“牛顿”），再进行第二轮检索。</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 多跳检索简化示例</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">multi_hop_retrieval</span>(<span class="hljs-params">initial_query, max_hops=<span class="hljs-number">2</span></span>):
    current_query = initial_query
    retrieved_contexts = []

    <span class="hljs-keyword">for</span> hop <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(max_hops):
        <span class="hljs-comment"># 1. 语义检索</span>
        docs = dense_vector_retriever.search(current_query, top_k=<span class="hljs-number">3</span>)
        retrieved_contexts.extend(docs)

        <span class="hljs-comment"># 2. 判断是否需进一步查询（由一个小型分类器或规则判断）</span>
        <span class="hljs-keyword">if</span> need_further_hop(current_query, docs):
            <span class="hljs-comment"># 3. 生成下一跳查询（利用LLM提炼新查询焦点）</span>
            current_query = llm_generate_next_query(current_query, docs)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">return</span> aggregate_contexts(retrieved_contexts)

</code></pre>
<p>该范式将检索召回率提升至80%以上，并在HotpotQA等多跳推理数据集上实现超过25%的性能提升。</p>
<h3 data-id="heading-3">3. 多模态融合范式：跨模态知识对齐</h3>
<p>当信息不限于文本时，多模态RAG成为必然。其核心是构建<strong>统一的跨模态语义空间</strong>。</p>
<ul>
<li><strong>统一编码</strong>：采用如CLIP的模型，将图像、文本等不同模态数据编码到同一向量空间，实现“以图搜文”或“以文搜图”。</li>
<li><strong>联合检索</strong>：针对多模态查询（如“找一张类似下图中风景照的诗词配图”），系统并行检索多模态数据库，并对结果进行跨模态相关性融合。</li>
</ul>
<p>该范式在医疗影像报告生成等场景中，将诊断描述准确率从77%提升至91%，证明了处理复合信息源的价值。</p>
<h3 data-id="heading-4">4. 上下文感知范式：动态检索与重排序</h3>
<p>为解决“上下文窗口滥用”导致的信息过载与性能下降问题，上下文感知RAG引入了动态决策机制。</p>
<ul>
<li><strong>动态检索窗口</strong>：系统根据查询复杂度与对话历史，自适应决定检索范围和返回片段数量，避免无关信息稀释关键内容。</li>
<li><strong>重排序器</strong>：在初步向量检索后，引入轻量级交叉编码器模型对Top-K结果进行精排，重新评估查询与每个片段的细微相关性，将Top-1准确率提升约22%。</li>
<li><strong>迭代修正</strong>：引入“生成-检索-验证”循环，当LLM对当前检索结果置信度低时，触发新一轮修正检索。</li>
</ul>
<p>此范式在金融、法律等高精度要求的场景中，将答案准确率稳定在90%以上。</p>
<h3 data-id="heading-5">5. 代码RAG的现状与核心难点</h3>
<p>将RAG应用于代码检索与生成是极具价值的场景，但面临不同于自然语言的独特挑战。代码的强结构性、精确性和抽象性，使得通用RAG范式在此水土不服。</p>
<p><strong>核心难点与应对思路：</strong></p>
<ol>
<li><strong>语义匹配与精确符号匹配的冲突</strong>
<ul>
<li><strong>难点</strong>：代码中函数名、变量名、API调用需精确匹配。纯语义检索可能因理解“创建”的语义，而返回<code>generate()</code>或<code>build()</code>，而非实际所需的<code>create()</code>函数。</li>
<li><strong>方案</strong>：采用<strong>混合检索（Hybrid Search）</strong>。结合稠密向量检索（理解代码功能语义）与稀疏关键词检索（精确匹配符号名）。例如，使用BM25确保命中“<code>pandas.read_csv</code>”，同时用向量检索理解“读取CSV文件”的意图。</li>
</ul>
</li>
<li><strong>代码结构在切分时的破坏</strong>
<ul>
<li><strong>难点</strong>：按固定长度切分文本会切碎函数定义、类声明，导致检索到无效片段。</li>
<li><strong>方案</strong>：采用<strong>基于抽象语法树的智能分块</strong>。利用AST解析代码，按函数、类、方法等自然边界进行分块，保持逻辑单元的完整性。</li>
</ul>
</li>
<li><strong>长距离依赖与全局上下文缺失</strong>
<ul>
<li><strong>难点</strong>：理解一个函数可能需要其导入的模块、父类定义或相关配置，这些信息可能分布在代码库不同位置。</li>
<li><strong>方案</strong>：实施<strong>多跳检索</strong>。第一跳定位目标函数，第二跳检索其依赖或调用链，第三跳检索相关类型定义，逐步构建完整上下文图谱。</li>
</ul>
</li>
<li><strong>Agentic RAG在代码场景中的决策复杂性</strong>
<ul>
<li><strong>难点</strong>：智能体需自主判断何时检索、检索什么（代码、文档、错误日志）、以及如何组合信息。例如，“修复这个Bug”需分解为：检索错误代码、检索相似Issue、检索相关API文档、检索单元测试等多步。</li>
<li><strong>方案</strong>：强化智能体的<strong>任务规划与工具调用</strong>能力。为其配备代码解析器、静态分析工具、测试运行器等专用工具，使其能像高级工程师一样执行复合操作。</li>
</ul>
</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 一个简化的代码导向智能体决策逻辑</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CodeAwareRAGAgent</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_and_fix</span>(<span class="hljs-params">self, issue_description</span>):
        <span class="hljs-comment"># 1. 规划：分解任务</span>
        plan = self.llm_planner(issue_description)
        <span class="hljs-comment"># 输出: ["定位核心代码", "查找相似错误模式", "检索API约束", "生成补丁"]</span>

        contexts = []
        <span class="hljs-keyword">for</span> step <span class="hljs-keyword">in</span> plan:
            <span class="hljs-keyword">if</span> <span class="hljs-string">"定位代码"</span> <span class="hljs-keyword">in</span> step:
                <span class="hljs-comment"># 2. 检索：混合检索核心代码段</span>
                contexts.append(self.hybrid_retrieve(issue_description, use_ast=<span class="hljs-literal">True</span>))
            <span class="hljs-keyword">elif</span> <span class="hljs-string">"查找错误"</span> <span class="hljs-keyword">in</span> step:
                <span class="hljs-comment"># 3. 工具调用：搜索Issue跟踪系统</span>
                contexts.append(self.tool_search_jira(issue_description))
            <span class="hljs-comment"># ... 其他步骤</span>
        <span class="hljs-comment"># 4. 生成与验证：综合所有上下文生成修复，并建议运行测试</span>
        patch = self.llm_generate_patch(contexts)
        <span class="hljs-keyword">return</span> patch, <span class="hljs-string">"建议执行单元测试：pytest tests/test_module.py::TestClass"</span>

</code></pre>
<p>当前，代码RAG的成功应用（如Cursor IDE）均非单一技术，而是<strong>混合检索、结构感知分块、多跳查询与智能体规划</strong>的综合体。其评估指标也更严格，不仅看生成代码的语义正确性，更需通过编译和测试用例。</p>
<h3 data-id="heading-6">6. 自适应与智能体范式：自主决策系统的核心</h3>
<p>RAG的最终演进方向是成为自主智能体的核心记忆与知识子系统。在此范式中，RAG不再是被动查询工具，而是智能体<strong>认知循环</strong>的一部分。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[复杂任务] --&gt; B[智能体任务规划]
    B --&gt; C{决策: 需要何种知识?}
    C --&gt;|事实查询| D[调用RAG进行检索]
    C --&gt;|程序执行| E[调用代码解释器]
    C --&gt;|实时信息| F[调用搜索引擎]
    D &amp; E &amp; F --&gt; G[综合信息进行推理]
    G --&gt; H{子任务解决?}
    H --&gt;|否| B
    H --&gt;|是，继续| I[执行下一子任务]
    I --&gt; J{所有任务完成?}
    J --&gt;|否| B
    J --&gt;|是| K[整合输出最终结果]

</code></pre>
<p>在此架构中：</p>
<ul>
<li><strong>RAG作为记忆体</strong>：为智能体提供长期、结构化的事实知识。</li>
<li><strong>动态上下文管理</strong>：智能体根据任务阶段，主动从RAG系统中写入、读取、压缩或隔离相关知识片段，实现高效的“上下文工程”。</li>
<li><strong>工具集成</strong>：RAG与代码解释器、计算器、API调用等工具平级，由智能体统一调度，协同解决复杂问题。</li>
</ul>
<p>该范式在自动化数据分析、复杂系统故障排查等场景中展现出潜力，其核心挑战在于智能体规划与决策的可靠性。</p>
<h3 data-id="heading-7">未来展望：作为基础设施的RAG</h3>
<p>RAG技术的演进路径表明，其正从独立的“检索-生成”应用，演变为<strong>智能体系统的标准知识组件</strong>和<strong>连接异构数据源的语义层</strong>。未来关注点将集中于：</p>
<ol>
<li><strong>与长上下文模型的协同</strong>：探索RAG如何与百万Token上下文窗口的LLM协同，RAG负责高效筛选、组织关键信息，长上下文模型负责深度融合与推理，形成互补。</li>
<li><strong>标准化语义层</strong>：推动建立企业级数据语义化标准，使RAG能统一理解来自数据库、文档、图谱、API的结构化与非结构化信息。</li>
<li><strong>强化评估与可解释性</strong>：尤其在代码、医疗、金融等高风险领域，需发展更严格的评估基准，并提升检索结果与生成过程的可靠解释性。</li>
</ol>
<p>对于工程师而言，理解RAG从静态管道到动态智能体组件的演进，有助于在设计下一代系统时，将其定位为<strong>可编程、可集成、可观测的核心知识基础设施</strong>，而非一个封闭的问答黑盒。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Mybatis入门到精通 二]]></title>    <link>https://juejin.cn/post/7588042910198595634</link>    <guid>https://juejin.cn/post/7588042910198595634</guid>    <pubDate>2025-12-27T23:54:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588042910198595634" data-draft-id="7588067055482404873" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Mybatis入门到精通 二"/> <meta itemprop="keywords" content="Java,MyBatis,源码阅读"/> <meta itemprop="datePublished" content="2025-12-27T23:54:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员侠客行"/> <meta itemprop="url" content="https://juejin.cn/user/556801719828361"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Mybatis入门到精通 二
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/556801719828361/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员侠客行
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T23:54:45.000Z" title="Sat Dec 27 2025 23:54:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在<a href="https://juejin.cn/post/7588084804093280294" target="_blank" title="https://juejin.cn/post/7588084804093280294">《Mybatis入门到精通 一》</a>中，我们了解了Mybatis启动过程：配置解析、创建SqlSession。本文介绍了SQL执行引擎Executor，以及和Executor密切相关的一二级缓存实现。</p>
<blockquote>
<p>注：本文中源码来自mybatis 3.4.x版本，地址<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmybatis%2Fmybatis-3.git" target="_blank" title="https://github.com/mybatis/mybatis-3.git" ref="nofollow noopener noreferrer">github.com/mybatis/myb…</a></p>
</blockquote>
<h2 data-id="heading-0">一 Executor接口</h2>
<h3 data-id="heading-1">1.1 作用</h3>
<p>Executor接口中，是MyBatis的SQL执行引擎，通过精巧的设计模式组合，实现了SQL执行的高效协调和灵活扩展。该接口有以下关键职责：</p>
<ol>
<li>SQL执行协调</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 查询操作</span>
&lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler)</span>;
<span class="hljs-comment">// 更新操作  </span>
<span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(MappedStatement ms, Object parameter)</span>;
</code></pre>
<ol start="2">
<li>缓存管理</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 一级缓存管理</span>
CacheKey <span class="hljs-title function_">createCacheKey</span><span class="hljs-params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, BoundSql boundSql)</span>;
<span class="hljs-type">boolean</span> <span class="hljs-title function_">isCached</span><span class="hljs-params">(MappedStatement ms, CacheKey key)</span>;
<span class="hljs-keyword">void</span> <span class="hljs-title function_">clearLocalCache</span><span class="hljs-params">()</span>;
</code></pre>
<ol start="3">
<li>事务控制</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">commit</span><span class="hljs-params">(<span class="hljs-type">boolean</span> required)</span>;
<span class="hljs-keyword">void</span> <span class="hljs-title function_">rollback</span><span class="hljs-params">(<span class="hljs-type">boolean</span> required)</span>;
Transaction <span class="hljs-title function_">getTransaction</span><span class="hljs-params">()</span>;
</code></pre>
<ol start="4">
<li>延迟加载</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">deferLoad</span><span class="hljs-params">(MappedStatement ms, MetaObject resultObject, String property, CacheKey key, Class&lt;?&gt; targetType)</span>;
</code></pre>
<h3 data-id="heading-2">1.2 接口体系</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7c8cd68f25843149d18189d2ee1370b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5L6g5a6i6KGM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767484485&amp;x-signature=qEpKeL%2FIBpUb1BIym4NO%2FEzN%2FPM%3D" alt="" loading="lazy"/></p>
<p>BaseExecutor是顶级父抽象类，用模版方法实现公共逻辑，如维护一级缓存。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseExecutor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Executor</span> {
    <span class="hljs-comment">// 模板方法：定义执行流程</span>
    <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(...)</span> {
        <span class="hljs-comment">// 1. 检查一级缓存</span>
        list = localCache.getObject(key);
        <span class="hljs-keyword">if</span> (list != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> list;
        }
        <span class="hljs-comment">// 2. 从数据库查询</span>
        <span class="hljs-keyword">return</span> queryFromDatabase(...);
    }
    
    <span class="hljs-comment">// 抽象方法：子类实现具体策略</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">doQuery</span><span class="hljs-params">(...)</span>;
}
</code></pre>
<p>使用策略模式，BaseExecutor有以下实现类</p>
<ul>
<li>SimpleExecutor，每次执行完都关闭Statement</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">doUpdate</span><span class="hljs-params">(MappedStatement ms, Object parameter)</span> {
    <span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">try</span> {
        <span class="hljs-type">StatementHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> configuration.newStatementHandler(...);
        stmt = prepareStatement(handler, ms.getStatementLog());
        <span class="hljs-keyword">return</span> handler.update(stmt);
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-comment">// 每次都关闭Statement</span>
        closeStatement(stmt);
    }
}
</code></pre>
<ul>
<li>ReuseExecutor ，缓存Statement对象，实现重用</li>
<li>BatchExecutor，批量执行，提升性能</li>
</ul>
<p>CachingExecutor采用了装饰器模式，在BaseExecutor基础上，提供了二级缓存能力。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CachingExecutor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Executor</span> {
    <span class="hljs-comment">// 被装饰的BaseExecutor子类对象</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Executor delegate; 
    
    <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(...)</span> {
        <span class="hljs-type">Cache</span> <span class="hljs-variable">cache</span> <span class="hljs-operator">=</span> ms.getCache();
        <span class="hljs-keyword">if</span> (cache != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 二级缓存逻辑</span>
            List&lt;E&gt; list = tcm.getObject(cache, key);
            <span class="hljs-comment">// 未命中缓存，查询数据库并放入缓存池</span>
            <span class="hljs-keyword">if</span> (list == <span class="hljs-literal">null</span>) {
                list = delegate.query(...); <span class="hljs-comment">// 委托给原执行器</span>
                tcm.putObject(cache, key, list);
            }
            <span class="hljs-keyword">return</span> list;
        }
        <span class="hljs-comment">//未启用二级缓存，直接查询数据库 </span>
        <span class="hljs-keyword">return</span> delegate.query(...);
    }
}
</code></pre>
<h3 data-id="heading-3">1.3 创建Executor</h3>
<p>Configuration#newExecutor方法会根据executorType来创建相应的实现类对象，并使用插件增强。</p>
<p>默认得executorType = ExecutorType.SIMPLE，即使用SimpleExecutor。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">newExecutor</span><span class="hljs-params">(Transaction transaction, ExecutorType executorType)</span> {
    executorType = executorType == <span class="hljs-literal">null</span> ? defaultExecutorType : executorType;
    executorType = executorType == <span class="hljs-literal">null</span> ? ExecutorType.SIMPLE : executorType;
    Executor executor;
    <span class="hljs-keyword">if</span> (ExecutorType.BATCH == executorType) {
        executor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BatchExecutor</span>(<span class="hljs-built_in">this</span>, transaction);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ExecutorType.REUSE == executorType) {
        executor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReuseExecutor</span>(<span class="hljs-built_in">this</span>, transaction);
    } <span class="hljs-keyword">else</span> {
        executor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleExecutor</span>(<span class="hljs-built_in">this</span>, transaction);
    }
    <span class="hljs-comment">// 二级缓存装饰</span>
    <span class="hljs-keyword">if</span> (cacheEnabled) {
        executor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CachingExecutor</span>(executor);
    }
    <span class="hljs-comment">// 代理增强</span>
    executor = (Executor) interceptorChain.pluginAll(executor);
    <span class="hljs-keyword">return</span> executor;
}
</code></pre>
<h2 data-id="heading-4">二 缓存体系</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a112f03986a41ed858ae259c4f7762b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5L6g5a6i6KGM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767484485&amp;x-signature=K%2FXRIhY6CGMlDhgyY7PIf%2FrGM9M%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d059800ba2a64aa29c132e3bf6ca705e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5L6g5a6i6KGM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767484485&amp;x-signature=ybspKlGagetMilNDCR9D6Ug4Cdc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">2.1 一级缓存</h3>
<h4 data-id="heading-6">2.1.1 特点和启用</h4>
<p>一级缓存有如下特点：</p>
<ul>
<li>作用域：SqlSession级别，不同Session不共享</li>
<li>生命周期：SqlSession创建到关闭</li>
<li>存储结构：HashMap（PerpetualCache）</li>
<li>默认状态：始终开启，无法关闭</li>
<li>清理时机：commit、rollback、update操作</li>
</ul>
<p><strong>一级缓存默认开启，默认作用域是SESSION。</strong> 启用方式如下：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- mybatis-config.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">settings</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- SESSION: 会话级别（默认） --&gt;</span>
    <span class="hljs-comment">&lt;!-- STATEMENT: 语句级别（执行完立即清空） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">setting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"localCacheScope"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"SESSION"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">settings</span>&gt;</span>
</code></pre>
<p>来看一个命中一级缓存的示例</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">SqlSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sqlSessionFactory.openSession();
<span class="hljs-keyword">try</span> {
    <span class="hljs-type">UserMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> session.getMapper(UserMapper.class);
    
    <span class="hljs-comment">// 第一次查询，走数据库</span>
    <span class="hljs-type">User</span> <span class="hljs-variable">user1</span> <span class="hljs-operator">=</span> mapper.selectById(<span class="hljs-number">1</span>);
    
    <span class="hljs-comment">// 第二次查询，命中一级缓存，不走数据库</span>
    <span class="hljs-type">User</span> <span class="hljs-variable">user2</span> <span class="hljs-operator">=</span> mapper.selectById(<span class="hljs-number">1</span>);
    
    System.out.println(user1 == user2); <span class="hljs-comment">// true，同一对象</span>
} <span class="hljs-keyword">finally</span> {
    session.close();
}
</code></pre>
<h4 data-id="heading-7">2.1.2 作用域</h4>
<p>localCacheScope决定了一级缓存的有效范围。取值<code>SESSION</code>和<code>STATEMENT</code>有如下区别：</p>
<p><code>SESSION</code>：</p>
<ol>
<li>一级缓存在<strong>整个 SqlSession 会话期间都有效</strong>。</li>
<li>只有当<code>SqlSession</code>执行<code>insert</code>/<code>update</code>/<code>delete</code>操作（会自动清空当前 SqlSession 的一级缓存）、调用<code>sqlSession.clearCache()</code>手动清空缓存，或<code>SqlSession</code>关闭（<code>sqlSession.close()</code>）时，该会话的一级缓存才会失效或被销毁。</li>
</ol>
<p><code>STATEMENT</code>：</p>
<ol>
<li><strong>一级缓存仅对当前查询语句有效，查询结束后缓存立即失效</strong> <strong>，相当于 “禁用了一级缓存”；</strong></li>
<li>查询执行完成后，缓存会被立即清空 / 失效，第二次查询不会复用第一次的缓存结果，仍然会去数据库重新查询；</li>
<li>用于解决嵌套查询的重复数据加载问题，如关联查询中的相同数据避免重复查询。</li>
</ol>
<h4 data-id="heading-8">2.1.3 非线程安全</h4>
<p>一级缓存实现是PerpetualCache，不是线程安全的，因为底层使用了HashMap，而且putObject方法也不加锁。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b6cc278a0ac480e87617f44f297a6d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5L6g5a6i6KGM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767484485&amp;x-signature=8Zqu9TCHmWr2Xkt89E%2FCZBOgllY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bafe22add6a64a83ab7682bbf700b12b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5L6g5a6i6KGM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767484485&amp;x-signature=kf%2B3YNSxdP27Ah1qvjkkpa6%2Fcio%3D" alt="" loading="lazy"/></p>
<p>那么为什么不使用线程安全的Map呢？基于以下几点原因：</p>
<ol>
<li>MyBatis的设计原则：SqlSession不应该被多线程共享</li>
<li>使用ConcurrentHashMap会带来性能开销</li>
</ol>
<p><strong>因此，每个线程应当使用独立的SqlSession（如使用SqlSessionManager ），或使用Spring等框架提供的线程安全封装（如SqlSessionTemplate ）。</strong></p>
<h3 data-id="heading-9">2.2 二级缓存</h3>
<h4 data-id="heading-10">2.2.1 特点和启用</h4>
<p>二级缓存有以下特点：</p>
<ul>
<li>作用域：Mapper（Namespace）级别，跨Session共享</li>
<li>生命周期：应用启动到关闭</li>
<li>存储结构：可配置（LRU、FIFO等）</li>
<li>默认状态：关闭，需手动开启</li>
<li>事务性：commit后才生效，rollback会清空</li>
</ul>
<p>启用二级缓存，需要满足三个条件：</p>
<ul>
<li>全局开启（<strong>默认启用</strong>）</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- mybatis-config.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">settings</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">setting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"cacheEnabled"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"true"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">settings</span>&gt;</span>
</code></pre>
<p>只有当Configuration中cacheEnabled=true时，才会创建CachingExecutor。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca009c4f0fb6466d9d1dd5f315d411bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5L6g5a6i6KGM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767484485&amp;x-signature=sT7vSCqqku%2FTE6bfiA2%2FAGD6K2Y%3D" alt="" loading="lazy"/></p>
<ul>
<li>Mapper局部配置（<strong>必须手动配置</strong>）</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"com.example.mapper.UserMapper"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 基本配置，激活二级缓存 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">cache</span>/&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 完整配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">cache</span>
        <span class="hljs-attr">eviction</span>=<span class="hljs-string">"LRU"</span>           &lt;!<span class="hljs-attr">--</span> <span class="hljs-attr">淘汰策略</span>：<span class="hljs-attr">LRU</span>/<span class="hljs-attr">FIFO</span>/<span class="hljs-attr">SOFT</span>/<span class="hljs-attr">WEAK</span> <span class="hljs-attr">--</span>&gt;</span>
        flushInterval="60000"    <span class="hljs-comment">&lt;!-- 刷新间隔：60秒 --&gt;</span>
        size="512"               <span class="hljs-comment">&lt;!-- 缓存对象数量 --&gt;</span>
        readOnly="false"/&gt;       <span class="hljs-comment">&lt;!-- 是否只读 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span>
</code></pre>
<ul>
<li>提供实体类序列化（推荐）</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p><strong>Mapper 中的</strong><code>select</code><strong>查询语句useCache默认为true。</strong></p>
<p><strong>当执行</strong><code>insert</code> <strong>、</strong> <code>update</code> <strong>、</strong> <code>delete</code><strong>操作时（</strong> <code>flushCache</code><strong>默认为true），MyBatis 会自动清空当前 Mapper 命名空间下的二级缓存，确保缓存数据与数据库数据一致性。</strong></p>
<p>来看跨Session共享二级缓存的示例</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Session A</span>
<span class="hljs-type">SqlSession</span> <span class="hljs-variable">session1</span> <span class="hljs-operator">=</span> sqlSessionFactory.openSession();
<span class="hljs-keyword">try</span> {
    <span class="hljs-type">UserMapper</span> <span class="hljs-variable">mapper1</span> <span class="hljs-operator">=</span> session1.getMapper(UserMapper.class);
    <span class="hljs-type">User</span> <span class="hljs-variable">user1</span> <span class="hljs-operator">=</span> mapper1.selectById(<span class="hljs-number">1</span>);  <span class="hljs-comment">// 查询数据库</span>
    session1.commit();  <span class="hljs-comment">// 提交后才放入二级缓存</span>
} <span class="hljs-keyword">finally</span> {
    session1.close();
}

<span class="hljs-comment">// Session B</span>
<span class="hljs-type">SqlSession</span> <span class="hljs-variable">session2</span> <span class="hljs-operator">=</span> sqlSessionFactory.openSession();
<span class="hljs-keyword">try</span> {
    <span class="hljs-type">UserMapper</span> <span class="hljs-variable">mapper2</span> <span class="hljs-operator">=</span> session2.getMapper(UserMapper.class);
    <span class="hljs-type">User</span> <span class="hljs-variable">user2</span> <span class="hljs-operator">=</span> mapper2.selectById(<span class="hljs-number">1</span>);  <span class="hljs-comment">// 命中二级缓存</span>
} <span class="hljs-keyword">finally</span> {
    session2.close();
}
</code></pre>
<h4 data-id="heading-11">2.2.2 其他特性</h4>
<p>此外，二级缓存支持语句级控制、自定义缓存实现、启用缓存日志</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"com.example.mapper.UserMapper"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">cache</span>/&gt;</span>
    
    <span class="hljs-comment">&lt;!-- select默认使用缓存，可不配置useCache --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectById"</span> <span class="hljs-attr">useCache</span>=<span class="hljs-string">"true"</span>&gt;</span>
        SELECT * FROM user WHERE id = #{id}
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 不使用缓存 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectRealtime"</span> <span class="hljs-attr">useCache</span>=<span class="hljs-string">"false"</span>&gt;</span>
        SELECT * FROM user WHERE id = #{id}
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 更新操作清空缓存（默认） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"updateUser"</span> <span class="hljs-attr">flushCache</span>=<span class="hljs-string">"true"</span>&gt;</span>
        UPDATE user SET name = #{name} WHERE id = #{id}
    <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 使用Redis作为二级缓存 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">cache</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"org.mybatis.caches.redis.RedisCache"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"host"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"localhost"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"port"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"6379"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">cache</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 开启缓存日志 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">cache</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"org.apache.ibatis.cache.decorators.LoggingCache"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"logImpl"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"STDOUT_LOGGING"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">cache</span>&gt;</span>
</code></pre>
<h3 data-id="heading-12">2.3 总结</h3>



































<table><thead><tr><th>特性</th><th>一级缓存</th><th>二级缓存</th></tr></thead><tbody><tr><td>作用域</td><td>SqlSession</td><td>Mapper（即Namespace<a href="https://link.juejin.cn?target=%255Burl%255D(%255Burl%255D(%255Burl%255D(url)))" target="_blank" title="%5Burl%5D(%5Burl%5D(%5Burl%5D(url)))" ref="nofollow noopener noreferrer">）</a></td></tr><tr><td>默认状态</td><td>开启</td><td>关闭</td></tr><tr><td>线程安全</td><td>否</td><td>是</td></tr><tr><td>序列化</td><td>不需要</td><td>需要</td></tr><tr><td>适用场景</td><td>单次会话优化</td><td>跨会话共享</td></tr></tbody></table>
<ul>
<li>一级缓存是SqlSession级别，无法关闭。<strong>但是当设置LocalCacheScope为STATEMENT时，查询语句执行结束时都会清空一级缓存，相当于 “禁用了一级缓存的跨查询复用能力”；</strong></li>
<li><strong>二级缓存，适合读多写少场景，需谨慎使用；</strong></li>
<li><strong>在分布式系统下，需要禁用Mybatis的一二级缓存，因为它们都是本地缓存</strong>，会引起数据不一致问题。应当使用Redis等分布式缓存。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[浅谈django的设计模式]]></title>    <link>https://juejin.cn/post/7588093282530607156</link>    <guid>https://juejin.cn/post/7588093282530607156</guid>    <pubDate>2025-12-27T17:06:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588093282530607156" data-draft-id="7588095884070158336" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="浅谈django的设计模式"/> <meta itemprop="keywords" content="Django"/> <meta itemprop="datePublished" content="2025-12-27T17:06:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哈里谢顿"/> <meta itemprop="url" content="https://juejin.cn/user/3678304397695056"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            浅谈django的设计模式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3678304397695056/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哈里谢顿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T17:06:24.000Z" title="Sat Dec 27 2025 17:06:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Django 之所以被称为“Web 开发中的教科书”，很大原因在于它把经典的设计模式用得既准又深。下面按“模式 → Django 中对应组件 → 源码级例子 → 一句话总结”四个维度，把最常用的 10 个设计模式一次梳理完。看完你能在代码里直接指出“这段就是 xxx 模式”。</p>
<hr/>
<ol>
<li>MTV（Model–Template–View）——Django 的“MVC”
模式角色<br/>
Model ↔ 数据访问<br/>
Template ↔ 表现层<br/>
View ↔ 业务逻辑/路由分发</li>
</ol>
<p>源码定位<br/>
django/db/models/base.py（Model）<br/>
django/template/response.py（TemplateResponse）<br/>
django/views/generic/base.py（View）</p>
<p>最小例子</p>
<h2 data-id="heading-0">urls.py</h2>
<p>path('book/<a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">int:pk</a>/', views.BookDetailView.as_view(), name='book_detail')</p>
<h2 data-id="heading-1">views.py</h2>
<p>class BookDetailView(DetailView):
model = Book          # → Model
template_name = 'book/detail.html'  # → Template
# 自定义业务逻辑
def get_context_data(self, **kwargs):
ctx = super().get_context_data(**kwargs)
ctx['reviews'] = self.object.reviews.select_related('user')
return ctx
一句话：MVC 的 Django 方言，把“控制器”拆解成 URLConf + View。</p>
<hr/>
<ol start="2">
<li>Front Controller（前端控制器）——WSGI 入口 + URLConf
整个请求先被 django/core/handlers/wsgi.py:WSGIHandler 截获，再交给 ROOT_URLCONF 去二次分发，典型 Front Controller。</li>
</ol>
<p>源码片段<br/>
class WSGIHandler(base.BaseHandler):
def <strong>call</strong>(self, environ, start_response):
request = self.request_class(environ)
response = self.get_response(request)   # → 进入 URL 解析
...
一句话：单点入口，集中路由。</p>
<hr/>
<ol start="3">
<li>Model–View–ViewModel（MVVM）——Django Forms
Mode l（数据库字段）与 View（HTML 表单）形态不同，Forms 层充当 ViewModel，负责数据校验/转换。</li>
</ol>
<p>例子<br/>
class RegisterForm(forms.Form):
username = forms.CharField(max_length=150, regex=r'^[\w.@+-]+$')
password = forms.CharField(widget=forms.PasswordInput)
# 两次密码一致性逻辑
def clean_password2(self):
...
一句话：Forms = 服务端 ViewModel，把“数据库表示”与“页面表示”解耦。</p>
<hr/>
<ol start="4">
<li>Active Record——Model 即表，对象即行
每个模型类直接映射一张表，实例即一行，封装 CRUD。</li>
</ol>
<p>源码<br/>
django/db/models/base.py:Model.save/delete</p>
<p>例子<br/>
book = Book(title='Clean Code', price=58)
book.save()          # INSERT
book.price = 48
book.save(update_fields=['price'])  # UPDATE
一句话：对象自带数据库行为，数据+操作二合一。</p>
<hr/>
<ol start="5">
<li>Manager / QuerySet——Factory + Strategy
objects = Manager 实例，返回 QuerySet；QuerySet 延迟执行，内部用策略模式拼装 SQL。</li>
</ol>
<p>源码<br/>
django/db/models/query.py:QuerySet<br/>
django/db/models/manager.py:Manager</p>
<p>例子<br/>
qs = Book.objects.filter(price__lte=50).select_related('publisher')
qs = qs.exclude(stock=0)          # 链式策略
sql = qs.query.<strong>str</strong>()          # 只看 SQL，不查库
一句话：Manager 是工厂，QuerySet 是策略链。</p>
<hr/>
<ol start="6">
<li>Middleware——职责链（Chain of Responsibility）
请求/响应对象在到达视图前要经过一串中间件，每个中间件可短路或追加功能。</li>
</ol>
<p>源码<br/>
django/utils/deprecation.py:MiddlewareMixin<br/>
settings.MIDDLEWARE = [
'django.middleware.security.SecurityMiddleware',
'django.contrib.sessions.middleware.SessionMiddleware',
...
]</p>
<p>自定义例子<br/>
class SimpleCorsMiddleware:
def <strong>init</strong>(self, get_response):
self.get_response = get_response
def <strong>call</strong>(self, request):
response = self.get_response(request)
response['Access-Control-Allow-Origin'] = '*'
return response
一句话：链表式处理，可插拔。</p>
<hr/>
<ol start="7">
<li>Signals——观察者模式（Observer）
模型保存、用户登录等事件发出“信号”，多个接收者解耦响应。</li>
</ol>
<p>源码<br/>
django/dispatch/dispatcher.py:Signal</p>
<p>例子<br/>
from django.db.models.signals import post_save
from django.dispatch import receiver</p>
<p>@receiver(post_save, sender=User)
def create_user_profile(sender, instance, created, **kwargs):
if created:
Profile.objects.create(user=instance)
一句话：发布-订阅，降低模块间耦合。</p>
<hr/>
<ol start="8">
<li>Template Method——通用视图骨架
django/views/generic/base.py:View.dispatch 定义执行骨架（get/post 分支），子类只覆写“变体”方法。</li>
</ol>
<p>例子<br/>
class BookCreateView(CreateView):
model = Book
fields = '<strong>all</strong>'
success_url = reverse_lazy('book_list')
# 只覆写“模板方法”允许的小钩子
def form_valid(self, form):
form.instance.created_by = self.request.user
return super().form_valid(form)
一句话：父类搭框架，子类填细节。</p>
<hr/>
<ol start="9">
<li>Decorator——函数视图增强
django/contrib/auth/decorators.py:login_required<br/>
django/views/decorators/cache.py:cache_page</li>
</ol>
<p>例子<br/>
@login_required
@cache_page(60 * 15)
def dashboard(request):
...
一句话：不动原函数，动态叠加功能。</p>
<hr/>
<ol start="10">
<li>Dependency Injection——设置就是“容器”
Django 不靠硬编码类，而是把依赖放进 settings：</li>
</ol>
<ul>
<li>数据库后端 → DATABASES['default']['ENGINE']</li>
<li>认证后端 → AUTHENTICATION_BACKENDS</li>
<li>缓存 → CACHES</li>
</ul>
<p>运行时用 django/conf/<strong>init</strong>.py:LazySettings 动态导入，符合 DI 思想。</p>
<p>一句话：配置即注入，替换实现无需改业务代码。</p>
<hr/>
<p>速查表（收藏级）</p>
<p>MTV / MVC        → 目录结构一眼看懂<br/>
Front Controller → WSGIHandler + urls.py<br/>
MVVM             → Forms/Serializers<br/>
Active Record    → Model.save()<br/>
Factory          → Manager<br/>
Strategy         → QuerySet 链式过滤<br/>
Chain            → Middleware<br/>
Observer         → Signals<br/>
Template Method  → generic.View<br/>
Decorator        → @login_required<br/>
DI               → settings.py</p>
<p>打开任意 Django 项目，你都能把上表对照到具体文件；面试时把“模式 + 源码位置”脱口而出，就是加分项。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>