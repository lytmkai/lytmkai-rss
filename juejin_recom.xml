<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[面向可观测数据融合的 Exemplar]]></title>    <link>https://juejin.cn/post/7592133956733108265</link>    <guid>https://juejin.cn/post/7592133956733108265</guid>    <pubDate>2026-01-07T01:39:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592133956733108265" data-draft-id="7589564203872616511" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="面向可观测数据融合的 Exemplar "/> <meta itemprop="keywords" content="后端,监控"/> <meta itemprop="datePublished" content="2026-01-07T01:39:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="货拉拉技术"/> <meta itemprop="url" content="https://juejin.cn/user/1768489241815070"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            面向可观测数据融合的 Exemplar 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1768489241815070/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    货拉拉技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T01:39:45.000Z" title="Wed Jan 07 2026 01:39:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、可观测性的"最后一公里"难题</h2>
<p>在可观测性领域，指标、日志与链路数据因其不同的数据特性与访问模式，通常采用异构存储架构：</p>
<ul>
<li><strong>时序数据库</strong>（如 Prometheus、InfluxDB）承载指标数据；</li>
<li><strong>日志存储</strong>（如 Elasticsearch、Loki）处理日志流；</li>
<li><strong>分布式追踪系统</strong>（如 Jaeger、Tempo、Skwalking）管理链路数据。</li>
</ul>
<p>这种基于数据特性的存储分层设计虽能优化各自场景的性能与成本，但也导致了跨数据类型关联分析的固有障碍。</p>
<p>当前货拉拉的 Monitor 系统已实现三种基础关联能力：</p>
<p>（1）通过应用名称+指标类型+标签组合实现框架<strong>指标与链路</strong>的关联检索；</p>
<p>（2）依托 ClickHouse 日志引擎原生指标能力支撑中间件（如 Kong）的<strong>指标-日志关</strong>联；</p>
<p>（3）基于预设保留字段完成<strong>业务</strong> <strong>订单与链路</strong>的定向检索。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94e4dd90fe5d4b0bbbd5404fce28cab8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768354785&amp;x-signature=F5SZGJ7t0e56uPGyuzPNlZQuoOg%3D" alt="whiteboard_exported_image (22).png" loading="lazy"/>
然而，架构评估表明，在指标-链路、指标-日志的核心融合路径上，现有方案的完成度仍存在显著提升空间。</p>





























<table><thead><tr><th><strong>数据维度</strong></th><th><strong>构建形式</strong></th><th><strong>数据流</strong></th><th><strong>完成度</strong></th></tr></thead><tbody><tr><td><strong>指标 &amp; 日志</strong></td><td><strong>双向跳转</strong></td><td>在 ck 日志指标的看板中，可以根据点击曲线查看到日志的细节；在分析日志时，可以进行 top、时间线图、饼图等分析；</td><td>用户需要先使用 ck 日志才能具备这个能力，对绝大多数 vm 指标不适用；</td></tr><tr><td><strong>指标 &amp; 链路</strong></td><td><strong>基于约定的指标单向跳转到链路</strong></td><td>在应用指标上，用户可以通过点击曲线展开相关指标类型、时间的 trace 数据；</td><td>适配框架指标、定制化的订单数据，对业务指标不适用；</td></tr><tr><td><strong>链路 &amp; 日志</strong></td><td><strong>基于约定的双向跳转</strong></td><td>查看链路时根据 trace-id 搜索相关日志；查看日志根据 trace-id 跳转到链路数据；</td><td>暂没有更深入的可观测需求</td></tr></tbody></table>
<p>当用户面对指标异常时，仍需在多个子系统中手动拼接上下文，这不仅延长了 MTTR，更暴露了当前可观测体系在数据融合维度的深层缺陷：<strong>缺乏一种轻量级、标准化的端到端关联机制</strong>。Exemplar 技术正是针对这一问题的核心解法——它通过在指标数据中内嵌结构化上下文标识（如 TraceID、关键业务标签），构建从聚合指标到原始观测数据的可追溯路径，从而在保持存储架构优势的同时，实现跨数据类型的无缝融合。下文将详细探讨该技术的实践路径。</p>
<h2 data-id="heading-1">二、对行业主流方案的探索与思考</h2>
<ol>
<li>
<h3 data-id="heading-2">OpenTelemetry Exemplar 方案</h3>
</li>
</ol>
<p>OpenTelemetry 作为可观测性领域的开源标准，其 Exemplar 机制通过在指标数据中嵌入 TraceID 和 SpanID 等上下文信息，实现指标与分布式追踪的关联。技术实现上，Exemplar 作为指标样本点的附加属性，支持单个时间序列存储多个 Exemplar 样本，通过 Exemplar Reservoir 机制进行采样和存储管理。该方案的优势在于标准化程度高，与 CNCF 生态深度集成。</p>
<ol start="2">
<li>
<h3 data-id="heading-3">Grafana Exemplar 实践</h3>
</li>
</ol>
<p>Grafana 在可视化层面对 Exemplar 进行了深度整合。在指标图表中，包含 Exemplar 的数据点会以高亮标记（如星形图标）显示，用户点击后可直接跳转至关联的 Trace 详情。该方案依赖后端存储系统（如 Prometheus 2.27+、Mimir）对 Exemplar 的原生支持，通过 Explore 功能提供分析能力，而非独立页面。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c66e0aa7ac0d4c298def4bf73916f3a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768354785&amp;x-signature=I4NrAPPJ41iw5Utxx12DDRoSpoY%3D" alt="" loading="lazy"/></p>
<ol start="3">
<li>
<h3 data-id="heading-4">Dynatrace OneAgent 方案</h3>
</li>
</ol>
<p>Dynatrace 通过 OneAgent 代理实现了全栈自动化的数据关联能力。OneAgent 能够自动为日志记录添加 TraceID 和 SpanID 等上下文标识，实现日志与追踪的自动关联。该方案的核心特点是通过统一代理架构收集事件、日志、指标和追踪数据，并将它们统一呈现在单一工作负载相关的视图中。</p>
<ol start="4">
<li>
<h3 data-id="heading-5">行业方案的局限性</h3>
</li>
</ol>
<p>我们通过对 OpenTelemetry、Grafana、Dynatrace OneAgent 等主流方案的深入分析，现有 Exemplar 实现存在三个根本性局限，制约了其在复杂业务场景中的价值发挥：</p>
<p><strong>定位局限：增强属性而非独立维度</strong></p>
<p>当前行业方案普遍将 Exemplar 定位为指标的增强属性，而非独立的观测维度。OpenTelemetry 规范中 Exemplar 作为指标样本点的附加字段存在，Grafana 的实现必须依附于指标图表进行交互，Dynatrace 虽实现自动关联但仍将 Exemplar 视为上下文补充。这种设计导致：</p>
<ul>
<li>分析路径单一：只能从指标异常触发 Exemplar 查询，无法反向从 Exemplar 数据发现指标趋势；</li>
<li>查询能力受限：缺乏对 Exemplar 数据本身的聚合、过滤、统计等日志式分析能力；</li>
<li>价值挖掘不足：Exemplar 中蕴含的业务上下文（如订单 ID、用户特征）难以作为独立维度进行分析；</li>
</ul>
<hr/>
<p><strong>架构局限：存储耦合与使用门槛</strong></p>
<p>现有方案在存储架构上存在显著缺陷：</p>
<ul>
<li>存储强耦合：OpenTelemetry 的 Exemplar 必须存储在兼容 Prometheus remote write 的时序数据库中，与指标数据绑定，无法独立扩展</li>
<li>查询体验割裂：Grafana 虽提供 Trace 跳转，但 Exemplar 数据本身无法在 Explore 等通用分析界面中独立使用</li>
<li>接入成本高：现有的 Opentelemetry、Prometheus SDK 难以直接让用户接入 exemplar 。</li>
</ul>
<hr/>
<p><strong>价值局限：场景覆盖不足</strong></p>
<p>行业方案未能充分释放 Exemplar 的潜力：</p>
<ul>
<li>被动关联为主：仅在指标异常时提供上下文，无法主动发现业务模式（如特定用户群的性能退化）</li>
<li>日志能力缺失：Exemplar 虽本质是结构化日志，但现有方案未提供日志检索、字段提取、模式发现等基础能力</li>
</ul>
<hr/>
<ol start="5">
<li>
<h3 data-id="heading-6">我们的思考：Exemplar 作为独立观测维度</h3>
</li>
</ol>
<p>基于上述局限，我们提出 Exemplar as a Dimension 的核心理念：</p>
<ul>
<li>
<p><strong>双重身份</strong>：Exemplar 既是指标与链路/日志的关联桥梁，也是可独立分析的结构化日志流（即在指标-&gt;链路的映射关系之上，建立指标-&gt;日志的映射关系）</p>
</li>
<li>
<p><strong>降维使用</strong>：在异构存储背景下，Exemplar 可作为结构化日志使用，降低接入门槛——无需完整部署日志系统，即可获得关键业务上下文</p>
</li>
<li>
<p><strong>场景扩展</strong>：支持从 Exemplar 数据反向聚合生成指标（如统计特定业务场景的错误率），实现观测维度的自由切换</p>
</li>
</ul>
<h2 data-id="heading-7">三、货拉拉 Exemplar 架构</h2>
<ol>
<li>
<h3 data-id="heading-8">技术选型</h3>
</li>
</ol>
<p>我们选择 VictoriaLogs（以下简称 VLog）作为 Exemplar 的专用存储引擎，基于货拉拉实际业务场景重构内部组件，构建了从数据写入到查询分析的完整链路。这一选型主要基于三点核心考量：</p>
<ul>
<li>
<p><strong>Schemaless</strong>：VictoriaLogs 自动索引所有出现的字段，业务团队无需预先定义日志结构，新业务字段可立即用于查询，较 Ck 日志使用门槛大幅降低；</p>
</li>
<li>
<p><strong>VictoriaMetrics 生态协同</strong>：货拉拉已在全球多个 Region 完成指标系统向 VictoriaMetrics 的迁移。VLog 作为同源产品，共享一致的运维体系，团队无需新增运维技能栈。其简化的 LogQL 语法（与 PromQL 风格统一）大幅降低查询使用门槛；</p>
</li>
<li>
<p><strong>性能出色</strong>：实测，单位相同日志量下，综合成本大约为 ElasticSearch 的 1/10。</p>
</li>
</ul>
<ol start="2">
<li>
<h3 data-id="heading-9">文本传输协议</h3>
</li>
</ol>
<p>我们借鉴了 OpenMetrics 的行协议，以实现对 Prometheus 行协议的前向兼容。</p>















<table><thead><tr><th/><th><strong>Opentelemetry</strong></th><th><strong>货拉拉 Exemplar 行协议</strong></th></tr></thead><tbody><tr><td><strong>核心数据结构</strong></td><td>-   Exemplars 必须由一个 LabelSet 和一个值组成，并且可以有一个时间戳</td><td/></tr></tbody></table>
<ul>
<li>每个 exemplar 如果附加到 TimeSeries，必须包含一个值，可能包含时间戳 | -   必须包含值（counter 中 IncrOnce 对应为 1，histogram 中对应为 observce 的值）</li>
<li>必须包含时间戳（ 最高支持 ns） |
| <strong>Trace 上下文标识</strong> | OpenMetrics Exemplars 必须使用<code>trace_id</code>和<code>span_id</code>键分别表示 trace 和 span ID                             | <code>trace_id</code>和<code>segment_id</code>键分别表示 skwalking 中的 trace 和 segment ID                         |
| <strong>格式兼容性</strong>       | 使用 <code>#</code> 注释跟随在 series 行后                                                                          | 使用 <code># Exemplar</code>独立行跟随在具体的 series 行后，多个 Exemplar 使用多个独立的行                              |</li>
</ul>
<p>其格式如下：</p>
<pre><code class="hljs language-lua" lang="lua"># TYPE foo_request_duration_seconds histogram
foo_request_duration_seconds_bucket{app=<span class="hljs-string">"foo-service"</span>,env=<span class="hljs-string">"prod"</span>,instance=<span class="hljs-string">"10.0.0.1"</span>,method=<span class="hljs-string">"GET"</span>,<span class="hljs-built_in">status</span>=<span class="hljs-string">"200"</span>,le=<span class="hljs-string">"0.005"</span>} <span class="hljs-number">0</span>
foo_request_duration_seconds_bucket{app=<span class="hljs-string">"foo-service"</span>,env=<span class="hljs-string">"prod"</span>,instance=<span class="hljs-string">"10.0.0.1"</span>,method=<span class="hljs-string">"GET"</span>,<span class="hljs-built_in">status</span>=<span class="hljs-string">"200"</span>,le=<span class="hljs-string">"0.01"</span>} <span class="hljs-number">2</span>
foo_request_duration_seconds_bucket{app=<span class="hljs-string">"foo-service"</span>,env=<span class="hljs-string">"prod"</span>,instance=<span class="hljs-string">"10.0.0.1"</span>,method=<span class="hljs-string">"GET"</span>,<span class="hljs-built_in">status</span>=<span class="hljs-string">"200"</span>,le=<span class="hljs-string">"0.025"</span>} <span class="hljs-number">5</span>
# Exemplar {trace_id=<span class="hljs-string">"abc123def4567890"</span>,segment_id=<span class="hljs-string">"xyz789"</span>,user_id=<span class="hljs-string">"user-123"</span>,endpoint=<span class="hljs-string">"/api/v1/query"</span>,client_ip=<span class="hljs-string">"192.168.1.100"</span>,} <span class="hljs-number">0.008456</span> <span class="hljs-number">1700000000123456789</span>
# Exemplar {trace_id=<span class="hljs-string">"def456ghi7890123"</span>,segment_id=<span class="hljs-string">"uvw456"</span>,user_id=<span class="hljs-string">"user-456"</span>,endpoint=<span class="hljs-string">"/api/v1/query_range"</span>,client_ip=<span class="hljs-string">"192.168.1.101"</span>,} <span class="hljs-number">0.018723</span> <span class="hljs-number">1700000000234567890</span>

# TYPE foo_database_query_seconds histogram
foo_database_query_seconds_bucket{service=<span class="hljs-string">"foo-db"</span>,env=<span class="hljs-string">"prod"</span>,query_type=<span class="hljs-string">"select"</span>,database=<span class="hljs-string">"main"</span>,le=<span class="hljs-string">"0.05"</span>} <span class="hljs-number">3</span>
foo_database_query_seconds_bucket{service=<span class="hljs-string">"foo-db"</span>,env=<span class="hljs-string">"prod"</span>,query_type=<span class="hljs-string">"select"</span>,database=<span class="hljs-string">"main"</span>,le=<span class="hljs-string">"0.1"</span>} <span class="hljs-number">8</span>
# Exemplar {trace_id=<span class="hljs-string">"ghi789jkl0123456"</span>,segment_id=<span class="hljs-string">"rst123"</span>,query_id=<span class="hljs-string">"query-789"</span>,<span class="hljs-built_in">table</span>=<span class="hljs-string">"users"</span>,client_app=<span class="hljs-string">"web-frontend"</span>,} <span class="hljs-number">0.042158</span> <span class="hljs-number">1700000000345678901</span>
# Exemplar {trace_id=<span class="hljs-string">"jkl012mno3456789"</span>,segment_id=<span class="hljs-string">"opq789"</span>,query_id=<span class="hljs-string">"query-012"</span>,<span class="hljs-built_in">table</span>=<span class="hljs-string">"orders"</span>,client_app=<span class="hljs-string">"mobile-app"</span>,} <span class="hljs-number">0.087634</span> <span class="hljs-number">1700000000456789012</span>
</code></pre>
<p>3.  ### SDK 数据上报</p>
<p>针对 Exemplar 数据的高吞吐、不可聚合的特性，我们摒弃了 Prometheus 传统的 pull 模型，在 sdk 中新增了一条面向 exemplar 数据的数据流通道，采用 push 机制向后端 collector 发送数据。</p>
<p>由于不同应用场景产生的 Exemplar 日志类型差异显著——单条日志大小可能从几百字节到几十 KB 不等，简单的定时 flush 或基于固定行数的 flush 策略均难以平衡实时性与资源消耗。因此，我们需要设计一套精细的自适应 push 策略，能够根据日志体积、业务重要性和系统负载动态调整推送节奏。</p>
<ul>
<li>
<p><strong>Cache Size 驱动</strong>：SDK 内置滑动窗口缓存，当 Exemplar 数据量达到阈值（默认 10MB）或时间窗口到期（默认 10 秒）时，自动批量推送数据；</p>
</li>
<li>
<p><strong>反压保护</strong>：当后端处理异常时，SDK 自动重试，极端情况下，丢弃以保证服务的稳定性；</p>
</li>
<li>
<p><strong>数据压缩</strong>：采用 gzip 压缩替代原始文本格式，降低网络带宽的占用；</p>
</li>
</ul>
<p>在 golang 中，我们通过扩展既有的 Meter 接口，实现了 Exemplar 数据的标准化上报。该机制将 Exemplar 标签与数值精准附着到对应的指标时间序列上，其调用规范如下：</p>
<ul>
<li><strong>上下文参数</strong>：首个参数必须为 <code>context.Context</code>，用于自动捕获分布式追踪上下文（如 SkyWalking 的 TraceID/SegmentID）；</li>
<li><strong>业务</strong> <strong>标识参数</strong>：第二个参数为关键业务标识字符串（如完整 URL、SQL 、请求入参等等），作为 Exemplar 的核心描述内容；</li>
<li><strong>结构化标签集合</strong>：后续参数为可变数量的 <code>slog</code> 标签，通过 <code>slog.String()</code>/<code>slog.Int64()</code> 等方法定义业务维度标签；</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e260edb62e94710b168864734b3f126~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768354785&amp;x-signature=SFchNZVzHk%2Bgvr3UBCotzmXw3YA%3D" alt="" loading="lazy"/></p>
<p>在 Java<code> SpringBoot Actuator</code> 中，默认是集成<code>Micrometer</code>作为指标数据上报的标准 API。我们通过扩展 PrometheusMeterRegistry、Counter、Timer 默认实现，在指标数据记录 Value 的同时，实现 Exemplar 数据的上报。具体使用规范如下：</p>
<ul>
<li>
<p>使用**<code>LalaMetricRegistry</code>**<code>#XXbuilder</code>构建</p>
<ul>
<li><em>默认携带</em> <em><code>trace_id</code></em> <em>、</em> <em><code>segment_id</code></em> <em>链路信息；</em></li>
<li>构建可直接放在方法体重复执行，同一个 Meter （Name+Tag 区分）只会创建一次；</li>
<li>Counter 类型按照规范：指标名称，默认会自动添加"_total"后缀（名称已有则不会重复添加），如不需要可添加<code>.withoutTotalSuffix()</code>方法</li>
</ul>
</li>
<li>
<p>Exemplar 扩展信息类型支持长文本（<code>withExemplarMsg</code>方法）、KV 键值对（<code>withExemplarTag</code>）类型，如 KV 键值对，推荐使用内置<code>ExemplarTag</code> 构建输入；</p>
</li>
<li>
<p>支持通过 Endpoint 查看 Exemplar 统计信息和待上报文本内容，需显示配置开启 exemplar、exemplar-data 两个端点；</p>
</li>
<li>
<p>使用示例：</p>
</li>
</ul>

<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">"/exemplar"</span>)
public String <span class="hljs-built_in">exemplarTest</span>() {
    <span class="hljs-comment">//Histogram 方式1 计时开始位置</span>
    <span class="hljs-selector-tag">Timer</span><span class="hljs-selector-class">.Sample</span> <span class="hljs-selector-tag">sample</span> = <span class="hljs-selector-tag">Timer</span><span class="hljs-selector-class">.start</span>();<span class="hljs-comment">//开始计时位置</span>
    
    <span class="hljs-comment">// Counter 计数器构建，直接放在方法体中，无需提前创建，</span>
    <span class="hljs-comment">// 注意 指标名称，默认会自动添加"_total"后缀，如不需要可添加.withoutTotalSuffix()</span>
    <span class="hljs-selector-tag">LalaMetricRegistry</span><span class="hljs-selector-class">.counterBuilder</span>(<span class="hljs-string">"exemplar_counter_test"</span>)
            <span class="hljs-selector-class">.withoutTotalSuffix</span>() <span class="hljs-comment">// 如显示指定，则不会添加 _total 后缀，建议都加上（防止名称有差异）</span>
            <span class="hljs-selector-class">.tag</span>(<span class="hljs-string">"city_id"</span>, <span class="hljs-string">"13333"</span>)<span class="hljs-comment">//这是指标的label，必须保证收敛</span>
            <span class="hljs-selector-class">.tags</span>(<span class="hljs-string">"business_type"</span>, <span class="hljs-string">"driver"</span>)
            <span class="hljs-selector-class">.register</span>()
            <span class="hljs-selector-class">.withExemplarTag</span>( <span class="hljs-string">"userId"</span> , <span class="hljs-string">"uid123445"</span> ) <span class="hljs-comment">//这是exemplar的扩展信息</span>
<span class="hljs-selector-class">.withExemplarTag</span>(ExemplarTag. int_  ( <span class="hljs-string">"cost_amount"</span> , <span class="hljs-number">3000</span> ))
            <span class="hljs-selector-class">.increment</span>();
     
    <span class="hljs-comment">//Histogram 方式1 终止计时，自定义Bucket 支持serviceLevelObjectives 配置</span>
    <span class="hljs-selector-tag">sample</span><span class="hljs-selector-class">.stop</span>(LalaMetricRegistry.<span class="hljs-built_in">timerBuilder</span>(<span class="hljs-string">"exemplar_timer_test"</span>)
            .<span class="hljs-built_in">tag</span>(<span class="hljs-string">"city_id"</span>, <span class="hljs-string">"1333"</span>)<span class="hljs-comment">//这是指标的label，必须保证收敛</span>
            .<span class="hljs-built_in">serviceLevelObjectives</span>(Duration.<span class="hljs-built_in">ofMillis</span>(<span class="hljs-number">3</span>L), Duration.<span class="hljs-built_in">ofMillis</span>(<span class="hljs-number">6</span>L), Duration.<span class="hljs-built_in">ofMillis</span>(<span class="hljs-number">10</span>L), Duration.<span class="hljs-built_in">ofMillis</span>(<span class="hljs-number">15</span>L), Duration.<span class="hljs-built_in">ofMillis</span>(<span class="hljs-number">25</span>L), Duration.<span class="hljs-built_in">ofMillis</span>(<span class="hljs-number">50</span>L), Duration.<span class="hljs-built_in">ofMillis</span>(<span class="hljs-number">100</span>L), Duration.<span class="hljs-built_in">ofMillis</span>(<span class="hljs-number">1000</span>L))
            .<span class="hljs-built_in">register</span>()
            .<span class="hljs-built_in">withExemplarMsg</span>( <span class="hljs-string">"自定义文本内容"</span> ) <span class="hljs-comment">//有长度限制，1024</span>
.<span class="hljs-built_in">withExemplarTag</span>( <span class="hljs-string">"orderId"</span> , <span class="hljs-string">"did123456"</span> )
.<span class="hljs-built_in">withExemplarTag</span>( <span class="hljs-string">"payId"</span> , <span class="hljs-string">"pid123456"</span> ) );
    
    <span class="hljs-comment">// Histogram 方式2  </span>
    <span class="hljs-selector-tag">LalaMetricRegistry</span><span class="hljs-selector-class">.timerBuilder</span>(<span class="hljs-string">"exemplar_timer_test3"</span>)
        <span class="hljs-selector-class">.tags</span>(<span class="hljs-string">"city_id"</span>, <span class="hljs-string">"13555"</span>)
        <span class="hljs-selector-class">.serviceLevelObjectives</span>(BucketConfigs.<span class="hljs-built_in">getInstance</span>().<span class="hljs-built_in">getDurations</span>(HllBucketType.API))
        <span class="hljs-selector-class">.register</span>()
    <span class="hljs-selector-class">.withExemplarMsg</span>( <span class="hljs-string">"plain text"</span> )
<span class="hljs-selector-class">.withExemplarTag</span>( <span class="hljs-string">"userId"</span> , <span class="hljs-string">"123456"</span> )
        <span class="hljs-selector-class">.record</span>(Duration.<span class="hljs-built_in">ofMillis</span>(<span class="hljs-number">15</span>));  <span class="hljs-comment">//记录耗时   </span>
            
    <span class="hljs-selector-tag">return</span> "<span class="hljs-selector-tag">SUCCESS</span>";
}
</code></pre>
<ul>
<li><strong>两种 Label 的对比：</strong></li>
</ul>



































<table><thead><tr><th>特性</th><th>Meter Labels</th><th>Exemplar Labels</th></tr></thead><tbody><tr><td>存储机制</td><td>每个唯一组合生成独立时间序列</td><td>附加在样本上的键值对，不影响时间序列</td></tr><tr><td>基数限制</td><td>严格限制（具备采集防御）</td><td>无限制（Victoria-Logs全采样）</td></tr><tr><td>查询场景</td><td>聚合分析（如sum by(appid)）</td><td>单点详情追溯（点击曲线查看日志）</td></tr><tr><td>资源消耗</td><td>高（序列数直接影响性能）</td><td>低（仅存储样本时的附加信息）</td></tr><tr><td>保留策略</td><td>半年</td><td>7天</td></tr></tbody></table>
<ol start="4">
<li>
<h3 data-id="heading-10">Exemplar-Collector</h3>
</li>
</ol>
<p>Exemplar-Collector 是一个轻量化的数据接收处理组件，作为 VictoriaMetrics 指标体系与 VictoriaLogs 日志系统的桥梁，它承担两个核心职责：</p>
<p><strong>数据写入处理</strong></p>
<ul>
<li>
<p><strong>relabeling</strong>：接收应用 SDK 推送的 Exemplar 数据，流式解析文本协议，混合 series labels 与 exemplar labels，使用<code>internal/insert</code> 接口进行数据写入；丢弃无用标签如 <code>job</code>、<code>instance</code>等；</p>
</li>
<li>
<p><strong>元数据记录</strong>：记录应用（appid）与指标（metric）的关联关系到 MySQL，用于后续查询优化，如 histogram 复合指标的支持，智能关联等；</p>
</li>
</ul>
<p><strong>数据查询</strong> <strong>处理</strong></p>
<ul>
<li>
<p><strong>统一查询接口</strong>：提供直方图分布、时间序列、饼图、TopN 统计等预置分析模式，屏蔽底层存储差异；</p>
</li>
<li>
<p><strong>语法兼容层</strong>：自动将 PromQL 指标查询转换为 LogsQL 日志查询，使业务团队点击 promethues 图表便能转换到 exemplar 查询；</p>
</li>
<li>
<p><strong>智能关联</strong>：根据指标与应用的元数据映射，为存量的图表自动注入 Exemplar 跳转能力，实现"指标→Trace/日志"一键穿透；</p>
</li>
</ul>
<h2 data-id="heading-11">四、可视化交互</h2>
<p>可视化交互是释放 Exemplar 价值的核心环节。依托货拉拉全自研的 Lala-Monitor 监控系统（集成指标、日志、链路、告警的统一可观测平台），我们突破了 Grafana 等通用工具的交互限制，构建了深度优化的 Exemplar 分析界面。</p>
<p>我们的交互设计围绕 Exemplar 的结构化日志特性展开，实现四大核心能力：</p>
<ul>
<li>
<p><strong>智能关联</strong>：自动关联图表与 Exemplar，同时支持业务人员手动指定 logsql 进行关联；</p>
</li>
<li>
<p><strong>Drill-down</strong>：从指标→Exemplar 日志→trace 的无缝穿透；</p>
</li>
<li>
<p><strong>日志分析</strong>：提供完整的日志检索页面，支持类似 ES 的全文检索、字段过滤和模式发现，可直接分析 Exemplar 结构化日志内容；</p>
</li>
<li>
<p><strong>多维统计图表：</strong> 基于 Exemplar 数据自动生成时序统计图、排行榜、饼图及柱状图，直观展示业务维度分布（如错误类型占比、慢请求地域分布）；</p>
</li>
</ul>
<ol>
<li>
<h3 data-id="heading-12">智能关联</h3>
</li>
</ol>
<p>当业务指标启用 Exemplar 功能后，Lala-Monitor 会在对应图表上自动添加 Exemplar 标识。此时，用户可直接点击指标曲线上的数据点，查看关联的 Exemplar 日志。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/097c4244c75d40bcbdc908f723204edf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768354785&amp;x-signature=TpptRtPdL0QtTBN4h%2FAOhGh2MQw%3D" alt="" loading="lazy"/></p>
<p>除业务指标外，Lala-Monitor 还为所有已配置的看板图表提供自动联动查询能力。系统定期扫描全量看板，识别包含 Exemplar 数据的指标，并为相关图表开启联动查询能力——无需任何人工配置，用户即可直接点击指标曲线查看关联的 Exemplar 日志。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9de92303df0f474fb848a5b6b865b75c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768354785&amp;x-signature=rYfQObM3IJY6gXXKUT5UaIjB%2BdQ%3D" alt="" loading="lazy"/></p>
<p>在绝大多数场景下，系统内置的自动关联机制能够准确建立指标与 Exemplar 的映射关系。但在特殊情况下——例如多个应用 ID（appid）共享相同指标名称，或需要与看板变量进行复杂联动时——用户可通过手动指定 appid 和 LogSQL 查询条件来精确控制关联逻辑，确保 Exemplar 数据的准确提取与展示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92503151435545ee89801a504b2cf770~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768354785&amp;x-signature=X2Uk7wrsKgKzD9kYr15DYja2IWk%3D" alt="" loading="lazy"/></p>
<ol start="2">
<li>
<h3 data-id="heading-13">Drill-Down 下钻分析</h3>
</li>
</ol>
<p>类似 Grafana 的 drilldown 机制，Lala-Monitor 实现了基于 Exemplar 的深度下钻分析能力。用户可直接点击指标曲线上的数据点，系统会自动携带该点的标签信息和 PromQL 查询条件，精准跳转至关联的 Trace 详情页和 Exemplar 日志分析界面，实现从宏观指标到微观上下文的无缝穿透。</p>
<p>如下图所示，当用户在 HTTP RT 监控曲线中发现性能突刺点（红色标记处），只需点击该数据点，Lala-Monitor 将自动触发 Exemplar drill-down 流程：系统智能捕获该时间点的指标上下文（包括 hll_ip、route 等关键标签），并携带精确的时间窗口（10:28:30.000 ～ 10:29:30.000）跳转至 Exemplar 日志分析界面。在此界面中，用户可直接查看与性能异常相关的结构化日志，包括 TraceID、请求参数及响应时间等关键信息；</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08b491c7064348dea7364ca5ae216963~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768354785&amp;x-signature=%2BvLCFV3iMUFIubSLV6wfLcfsz4s%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a90f7126aa28432abf1350187981a274~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768354785&amp;x-signature=Crie7ckIbRnHx5Zs8BfmIBHbJq0%3D" alt="" loading="lazy"/></p>
<p>系统会基于当前 PromQL 查询特征智能推荐聚合函数（如图中自动推荐 max），用户也可通过下拉菜单灵活切换 sum、avg、p99 等多种聚合方式，对查询窗口内的 Exemplar 数据进行多维度统计分析，精准识别性能异常点与业务关键特征。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4ff3f2df6d144978c93301484c38f17~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768354785&amp;x-signature=5B6jP2GqBpkGFe%2FHQe0oKy0oHc0%3D" alt="" loading="lazy"/></p>
<ol start="3">
<li>
<h3 data-id="heading-14">日志分析</h3>
</li>
</ol>
<p>除指标 drill-down 作为主要入口外，Lala-Monitor 提供独立的 Exemplar 日志分析页面，支持完整的日志检索能力。该界面具备与 Elasticsearch 相似的交互体验：支持交互式搜索、字段过滤、关键词排除、正则匹配及 TopN 统计分析，同时针对 Exemplar 结构化特性优化了聚合操作。</p>
<p>在性能方面，Vlog 的在亿级日志行规模下仍保持秒级响应。这得益于当前的数据分片策略：每个 Exemplar 流（_stream）由<code>appid+metric-name</code>唯一标识，确保单个数据流规模可控。例如，"order-service+http_request_duration"流仅包含该服务的 HTTP 延迟数据，避免了跨业务、跨类型日志混杂数据量膨胀导致的性能衰减。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fee58b2ef3ea465f8beea8c7ae61e8d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768354785&amp;x-signature=nef3qTodOZJP7BQD4EjTSsHuq6s%3D" alt="" loading="lazy"/></p>
<ol start="4">
<li>
<h3 data-id="heading-15"><strong>Drill-Up 多维统计</strong></h3>
</li>
</ol>
<p>多维统计将 Exemplar 结构化日志转化为可视化图表，实现高基数维度的聚合分析。与 Prometheus 指标要求维度可枚举、基数收敛的特性不同，Exemplar 支持对 user_id、driver_id 等高发散性业务维度进行实时统计，使研发能够从海量日志中快速识别异常模式和业务特征，突破指标系统在维度分析上的限制。</p>
<p>以下的时序图可用来对多个维度进行 group by 的统计，类似 prometheus 的 range query</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4480559aeed84520ac7a2a112acaa5eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768354785&amp;x-signature=Foxrg1dKpROBHtEcq55UUIHNFb8%3D" alt="" loading="lazy"/></p>
<p>而排行榜和饼图的功能基本一致，可进行总量计算，类似 promethues 的 instant query</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a31fa8ec9d404298a39395435221d406~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768354785&amp;x-signature=oyK8phxTV9%2F8IvyGMeO54KITUg0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-16">五、Exemplar 在货拉拉的落地</h2>
<p>在完成 Client SDK 和 Server Collector 建设后，我们首先在内部监控平台上线验证，效果符合预期。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5aea542461c4c8ab34303f061d811a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768354785&amp;x-signature=gkjAK%2FMPZOsunqaA6Nhzd2IyuAs%3D" alt="" loading="lazy"/></p>
<ul>
<li>针对业务自定义指标场景，重点解决高基数问题。业务定位时需通过用户 ID、司机 ID、订单 ID 等关键属性下钻，但传统指标无法将此类高基数数据放入 Label。通过 Exemplar 机制，我们可以直接在指标采样中携带业务 ID 及关联 Trace 信息，使问题分析能从业务属性直接切入，无需跨系统转换查找 Trace。</li>
<li>目前核心订单服务的订单统计指标、企业业务的异常统计指标等几十个核心服务已完成上线，业务团队反馈问题定位效率显著提升，获得一线同学的一致认可。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a869ab8357e04ca3a12827cea949654b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768354785&amp;x-signature=sxF1VSC8ssV9yOK5%2B1wVFy02K4g%3D" alt="" loading="lazy"/></p>
<p>接下来，我们将把 Exemplar 能力下沉至基础组件（如 SOA、MySQL/Redis 客户端），覆盖更多基础设施层指标。</p>
<hr/>
<h2 data-id="heading-17">六、未来展望</h2>
<p>过去几个月，我们已初步落地 Exemplar 技术，覆盖部分核心业务场景。2026 年，我们将重点深化 Exemplar 在数据融合领域的应用价值：</p>
<ol>
<li>
<h3 data-id="heading-18">框架指标→链路的精准关联</h3>
</li>
</ol>
<p>当前货拉拉 Java 框架中，链路数据通过 SkyWalking 的 gRPC 通道上报 Trace，框架指标数据则依赖 Micrometer 采集。两者虽能基于接口类型、方法名等维度进行关联，但存在显著缺陷：</p>
<ul>
<li>数据粒度不匹配：指标层面的接口聚合会丢失明细特征，而链路数据保持原始粒度；</li>
<li>维度定义差异：指标与链路在埋点时的维度命名、取值逻辑存在不一致；</li>
<li>检索能力受限：现有的 trace 存储方案仅支持 Segment 级 RT 倒序，缺乏 Span 级精细化排序能力；</li>
</ul>
<p>这些缺陷导致点击指标时难以精准下钻至关键 Trace，影响问题定位效率。明年，我们将重构关联机制，通过 Exemplar 标准化上报 TraceID 与 SpanID，实现框架指标与链路的精准映射。</p>
<ol start="2">
<li>
<h3 data-id="heading-19">基于 Exemplar 数据的故障定位</h3>
</li>
</ol>
<p>Exemplar 的核心价值不仅在于实现指标与上下文的关联，更在于其作为结构化日志所具备的分析潜力。在此基础上，我们将重点在明年进行基于 Exemplar 进行自动化推导链设计，将可观测数据真正转化为可执行的故障洞察。</p>
<p>该推导链以报警、巡检、人工触发为起点，以根因为终点，通过以下环节进行自动推理：</p>
<ul>
<li><strong>报警触发与 Exemplar 抽样</strong>：当指标报警触发时，系统自动回溯该指标在异常窗口内的所有 Exemplar 数据。得益于 Exemplar 与指标样本的原生绑定，无需额外关联逻辑即可获取高质量上下文样本；</li>
<li><strong>Trace 自动关联</strong>：从 Exemplar 中提取 <code>trace_id</code> 集合，批量查询分布式链路系统，还原完整调用拓扑。由于 Exemplar 已携带精确时间戳与服务上下文，可避免模糊检索带来的噪声；</li>
<li><strong>异常维度收敛</strong>：复用已实现的指标下钻分析，结合关联 Trace 的结构化字段（如 <code>service_name</code>、<code>endpoint</code>、<code>error_code</code>）进行实时聚合，识别高频异常维度。例如，若 80% 的 Trace 均包含 <code>error_code=DB_TIMEOUT</code>，则将其标记为候选根因；</li>
<li><strong>多指标协同折叠</strong>：当某个 appid 多个指标同时报警时，计算其 Exemplar 中 <code>trace_id</code> 的交集。若交集显著，则判定为同一底层故障，并将多个告警折叠为单一事件，避免告警风暴；</li>
<li><strong>结构化推导输出</strong>：最终生成包含“异常指标—关联 Trace—收敛维度—影响范围”的完整证据链，直接嵌入报警通知或运维工单，为故障处理提供可操作的上下文，而非仅仅堆砌几个相关的 trace。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[揭秘 Spring Boot 事务：动态增强的底层实现与核心组件]]></title>    <link>https://juejin.cn/post/7592069113222512659</link>    <guid>https://juejin.cn/post/7592069113222512659</guid>    <pubDate>2026-01-06T23:34:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592069113222512659" data-draft-id="7591792747775246346" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="揭秘 Spring Boot 事务：动态增强的底层实现与核心组件"/> <meta itemprop="keywords" content="Spring Boot"/> <meta itemprop="datePublished" content="2026-01-06T23:34:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="闲煮光阴"/> <meta itemprop="url" content="https://juejin.cn/user/1523239911963420"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            揭秘 Spring Boot 事务：动态增强的底层实现与核心组件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1523239911963420/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    闲煮光阴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T23:34:13.000Z" title="Tue Jan 06 2026 23:34:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在分布式系统和复杂业务场景中，事务管理是保障数据一致性的核心技术之一。Spring Boot 提供的声明式事务机制，通过 “动态” 方式简化了事务配置，让开发者无需手动编写事务控制代码，仅通过简单注解即可实现事务管理。本文将从 “问题本质 - 基础知识 - 实现流程 - 底层原理” 四个维度，层层拆解 Spring Boot 动态事务的实现逻辑。</p>
<h2 data-id="heading-0">一、如何实现动态事务？—— 问题本质与核心思路</h2>
<p>动态事务的核心诉求是：让程序自动识别需要事务的方法，并自动完成事务的开启、提交、回滚等操作。这个过程本质是 “标记识别 + 逻辑执行” 的组合，我们可以通过生活化的场景理解其核心思路：</p>
<ol>
<li>
<p><strong>如何识别需要事务的方法？—— 给方法打 “事务标记”</strong></p>
<p>要让程序知道哪个方法需要事务，最直接的方式是给方法添加一个 “显性标记”。就像超市里的商品标签：无论商品是零食、日用品还是生鲜，只要贴上 “促销” 标签，就会被纳入促销活动；同理，无论方法是查询、新增还是修改操作，只要打上特定标记，就会被程序识别为 “需要事务支持” 的方法。这个标记在 Spring Boot 中，就是@Transactional注解。</p>
</li>
<li>
<p><strong>如何处理 “事务标记”？—— 编写 “标记解析器”</strong></p>
<p>仅有标记不够，还需要一个能 “读懂” 标记的程序，来执行标记对应的逻辑（开启事务、执行方法、提交 / 回滚事务）。这就像收到一份带 “加急” 标记的文件：首先需要识别 “加急” 标记，然后执行 “优先处理、限时完成” 的逻辑；如果没有这个解析逻辑，“加急” 标记就只是一个无效符号。在 Spring Boot 中，这个 “标记解析器” 就是TransactionInterceptor（事务拦截器）。</p>
</li>
</ol>
<p>综上，动态事务的实现只需<strong>两个核心要素</strong>：</p>
<ul>
<li><strong>标记：</strong> 告诉程序 “谁需要事务”（对应@Transactional注解）；</li>
<li><strong>解析器：</strong> 告诉程序 “遇到事务标记该做什么”（对应TransactionInterceptor）。</li>
</ul>
<p>这一思路也贯穿了 Spring 体系的核心设计思想 —— 大多数 Spring 特性（如 AOP、缓存、异步任务），都是通过 “注解标记 + 解析器” 的组合模式实现的。</p>
<h2 data-id="heading-1">二、Spring Boot 事务实现的基础知识储备</h2>
<p>要理解动态事务的底层逻辑，需要先掌握三个核心基础知识，它们是事务实现的 “地基”：</p>
<ol>
<li>
<p><strong>Spring Boot 查找 Bean 的流程</strong></p>
<p>Spring Boot 的核心是 IoC 容器，所有被管理的对象（Bean）都会通过容器初始化、注册、获取。事务管理的前提是：需要事务支持的 Bean 必须被 Spring IoC 容器管理（即 “交给 Spring 管”），否则容器无法对其进行事务增强。核心流程包括：扫描指定包路径→解析类上的@Component、@Service等注解→创建 Bean 实例→注册到 IoC 容器。</p>
</li>
<li>
<p><strong>Spring Context 初始化流程</strong></p>
<p>Spring Context（应用上下文）是 IoC 容器的具体实现，其初始化过程会触发一系列关键操作：加载配置类→扫描 Bean 定义→实例化 Bean→执行 Bean 的后置处理器（BeanPostProcessor）。事务的动态增强，正是通过 “Bean 后置处理器” 在 Bean 初始化后期完成的。</p>
</li>
<li>
<p><strong>Spring AOP 流程</strong></p>
<p>Spring 事务的底层依赖 AOP（面向切面编程）。AOP 通过 “动态代理” 机制，在不修改目标方法源码的前提下，对方法进行增强（如添加事务控制逻辑）。</p>
</li>
</ol>
<h2 data-id="heading-2">三、Spring Boot 事务的具体实现流程</h2>
<p>基于上述基础知识，Spring Boot 实现事务的流程可简化为 4 步，且大部分步骤由框架自动完成，开发者仅需少量配置：</p>
<ol>
<li>
<p><strong>将目标对象交给 Spring 管理</strong></p>
<p>在业务类（如UserService）上添加@Service注解，让 Spring 在初始化时扫描并创建该类的 Bean 实例，纳入 IoC 容器管理。这是事务增强的前提 —— 只有容器管理的 Bean，才能被 AOP 动态代理。</p>
</li>
<li>
<p><strong>给目标方法添加事务标记</strong></p>
<p>在需要事务支持的方法（如addUser()）上添加@Transactional注解。该注解可配置事务传播行为（如propagation = Propagation.REQUIRED）、隔离级别（如isolation = Isolation.READ_COMMITTED）、回滚条件（如rollbackFor = Exception.class）等属性，精准控制事务行为。</p>
</li>
<li>
<p><strong>Spring 自动加载事务解析器</strong></p>
<p>开发者无需手动编写事务解析逻辑，Spring Boot 通过 “自动配置” 机制，默认加载TransactionInterceptor（事务拦截器）。该拦截器封装了事务的核心逻辑：开启事务→执行目标方法→若方法正常执行则提交事务→若抛出异常则回滚事务。</p>
</li>
<li>
<p><strong>Spring AOP 自动完成切面织入</strong></p>
<p>Spring Boot 自动将@Transactional注解解析为切入点（Pointcut），将TransactionInterceptor作为通知（Advice），组合成切面（Advisor）。随后通过 AOP 动态代理机制，为目标 Bean 生成代理对象 —— 当调用目标方法时，实际执行的是代理对象的方法，代理对象会先触发TransactionInterceptor的事务逻辑，再执行目标方法。</p>
</li>
</ol>
<p><strong>总结：</strong> 开发者仅需完成 “添加@Service注解” 和 “添加@Transactional注解” 两步，Spring Boot 会自动完成 “加载解析器” 和 “AOP 织入”，实现事务的动态增强。</p>
<h2 data-id="heading-3">四、Spring Boot 事务的底层实现原理</h2>
<p>上述流程的核心是 “自动配置” 和 “AOP 动态代理”，下面通过源码拆解关键步骤，揭秘其底层逻辑（重点解析流程 3 和流程 4）。</p>
<h3 data-id="heading-4">1. 事务自动配置的入口：TransactionAutoConfiguration</h3>
<p>Spring Boot 的自动配置依赖META-INF/spring.factories文件，其中注册了TransactionAutoConfiguration（事务自动配置类）。当 Spring Boot 启动时，会扫描该文件并加载该类，开启事务管理能力。</p>
<p>TransactionAutoConfiguration的核心内部类EnableTransactionManagementConfiguration，通过@EnableTransactionManagement注解触发事务相关 Bean 的加载，代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@ConditionalOnClass(PlatformTransactionManager.class)</span>
<span class="hljs-meta">@AutoConfigureAfter({JtaAutoConfiguration.class, HibernateJpaAutoConfiguration.class})</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionAutoConfiguration</span> {

    <span class="hljs-comment">// 内部类：启用事务管理的配置</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EnableTransactionManagementConfiguration</span> {

        <span class="hljs-comment">// CGLIB动态代理配置（默认启用）</span>
        <span class="hljs-meta">@Configuration(proxyBeanMethods = false)</span>
        <span class="hljs-meta">@EnableTransactionManagement(proxyTargetClass = true)</span>
        <span class="hljs-meta">@ConditionalOnProperty(
            prefix = "spring.aop", 
            name = "proxy-target-class", 
            havingValue = "true", 
            matchIfMissing = true
        )</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CglibAutoProxyConfiguration</span> {
        }

        <span class="hljs-comment">// JDK动态代理配置（需手动设置spring.aop.proxy-target-class=false）</span>
        <span class="hljs-meta">@Configuration(proxyBeanMethods = false)</span>
        <span class="hljs-meta">@EnableTransactionManagement(proxyTargetClass = false)</span>
        <span class="hljs-meta">@ConditionalOnProperty(
            prefix = "spring.aop", 
            name = "proxy-target-class", 
            havingValue = "false"
        )</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdkDynamicAutoProxyConfiguration</span> {
        }
    }
}
</code></pre>
<p>关键说明：</p>
<ul>
<li><strong>@EnableTransactionManagement：</strong> 事务实现的核心注解，用于加载事务管理相关的 Bean；</li>
<li><strong>proxyTargetClass = true：</strong> 默认使用 CGLIB 动态代理（可代理类和接口），false时使用 JDK 动态代理（仅代理接口）。</li>
</ul>
<h3 data-id="heading-5">2. @EnableTransactionManagement的核心作用：加载两大关键组件</h3>
<p>@EnableTransactionManagement通过Import注解，导入了两个核心类：ProxyTransactionManagementConfiguration和AutoProxyRegistrar，二者共同完成事务的 AOP 增强。</p>
<p><strong>（1）ProxyTransactionManagementConfiguration：</strong> 创建事务切面（Advisor）该类是一个配置类，通过@Bean注解注册了三个核心 Bean，最终组合成事务切面：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProxyTransactionManagementConfiguration</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTransactionManagementConfiguration</span> {

    <span class="hljs-comment">// 1. 注册事务切面（Advisor）：切入点 + 通知的组合</span>
    <span class="hljs-meta">@Bean(name = TransactionManagementConfigUtils.TRANSACTION_ADVISOR_BEAN_NAME)</span>
    <span class="hljs-meta">@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span>
    <span class="hljs-keyword">public</span> BeanFactoryTransactionAttributeSourceAdvisor <span class="hljs-title function_">transactionAdvisor</span><span class="hljs-params">(
            TransactionAttributeSource transactionAttributeSource,
            TransactionInterceptor transactionInterceptor)</span> {
        <span class="hljs-type">BeanFactoryTransactionAttributeSourceAdvisor</span> <span class="hljs-variable">advisor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanFactoryTransactionAttributeSourceAdvisor</span>();
        <span class="hljs-comment">// 绑定切入点：通过TransactionAttributeSource识别@Transactional注解</span>
        advisor.setTransactionAttributeSource(transactionAttributeSource);
        <span class="hljs-comment">// 绑定通知：通过TransactionInterceptor执行事务逻辑</span>
        advisor.setAdvice(transactionInterceptor);
        <span class="hljs-comment">// 设置切面优先级（可通过@EnableTransactionManagement的order属性配置）</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.enableTx != <span class="hljs-literal">null</span>) {
            advisor.setOrder(<span class="hljs-built_in">this</span>.enableTx.&lt;Integer&gt;getNumber(<span class="hljs-string">"order"</span>));
        }
        <span class="hljs-keyword">return</span> advisor;
    }

    <span class="hljs-comment">// 2. 注册TransactionAttributeSource：解析@Transactional注解的属性</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span>
    <span class="hljs-keyword">public</span> TransactionAttributeSource <span class="hljs-title function_">transactionAttributeSource</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// AnnotationTransactionAttributeSource专门用于解析@Transactional注解</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationTransactionAttributeSource</span>();
    }

    <span class="hljs-comment">// 3. 注册TransactionInterceptor：事务拦截器（核心通知逻辑）</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span>
    <span class="hljs-keyword">public</span> TransactionInterceptor <span class="hljs-title function_">transactionInterceptor</span><span class="hljs-params">(TransactionAttributeSource transactionAttributeSource)</span> {
        <span class="hljs-type">TransactionInterceptor</span> <span class="hljs-variable">interceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransactionInterceptor</span>();
        <span class="hljs-comment">// 绑定注解解析器，用于获取@Transactional的配置属性（如隔离级别、回滚条件）</span>
        interceptor.setTransactionAttributeSource(transactionAttributeSource);
        <span class="hljs-comment">// 绑定事务管理器（如DataSourceTransactionManager，默认自动配置）</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.txManager != <span class="hljs-literal">null</span>) {
            interceptor.setTransactionManager(<span class="hljs-built_in">this</span>.txManager);
        }
        <span class="hljs-keyword">return</span> interceptor;
    }
}
</code></pre>
<p>三个 Bean 的作用分工：</p>
<ul>
<li><strong>TransactionAttributeSource：</strong> 解析@Transactional注解的属性（如rollbackFor、propagation），将注解信息封装为TransactionAttribute对象；</li>
<li><strong>TransactionInterceptor：</strong> 事务的核心执行逻辑，实现了MethodInterceptor接口，在目标方法执行前后拦截：
执行前：根据TransactionAttribute开启事务；执行后：若方法无异常，提交事务；若抛出异常，根据rollbackFor配置回滚事务；</li>
<li><strong>BeanFactoryTransactionAttributeSourceAdvisor：</strong> 切面类，将 “@Transactional切入点” 与 “TransactionInterceptor通知” 绑定，供 AOP 框架识别。</li>
</ul>
<p><strong>（2）AutoProxyRegistrar：开启 AOP 动态代理能力</strong></p>
<p>AutoProxyRegistrar的核心作用是向 Spring 容器注册AnnotationAwareAspectJAutoProxyCreator对象，该对象是 AOP 动态代理的核心处理器，实现了BeanPostProcessor接口（Bean 后置处理器）。</p>
<p>在 Spring Context 初始化流程中，当 Bean 实例化完成后，会调用BeanPostProcessor的postProcessAfterInitialization方法，AnnotationAwareAspectJAutoProxyCreator重写了该方法，核心逻辑如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AnnotationAwareAspectJAutoProxyCreator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AspectJAwareAdvisorAutoProxyCreator</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">postProcessAfterInitialization</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Object bean, String beanName)</span> {
        <span class="hljs-keyword">if</span> (bean != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 生成Bean的缓存Key（基于类名+Bean名称）</span>
            <span class="hljs-type">Object</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> getCacheKey(bean.getClass(), beanName);
            <span class="hljs-comment">// 避免重复代理（早期代理引用已存在时直接返回）</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.earlyProxyReferences.remove(cacheKey) != bean) {
                <span class="hljs-comment">// 核心逻辑：判断Bean是否需要被代理，若需要则生成代理对象</span>
                <span class="hljs-keyword">return</span> wrapIfNecessary(bean, beanName, cacheKey);
            }
        }
        <span class="hljs-keyword">return</span> bean;
    }

    <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">wrapIfNecessary</span><span class="hljs-params">(Object bean, String beanName, Object cacheKey)</span> {
        <span class="hljs-comment">// 1. 检查Bean是否已被代理，或是否为Spring内部Bean（如事务管理器），无需代理则直接返回</span>
        <span class="hljs-keyword">if</span> (beanName != <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-built_in">this</span>.targetSourcedBeans.contains(beanName)) {
            <span class="hljs-keyword">return</span> bean;
        }
        <span class="hljs-keyword">if</span> (Boolean.FALSE.equals(<span class="hljs-built_in">this</span>.advisedBeans.get(cacheKey))) {
            <span class="hljs-keyword">return</span> bean;
        }
        <span class="hljs-comment">// 2. 检查Bean是否符合切入点条件（是否带有@Transactional注解）</span>
        <span class="hljs-keyword">if</span> (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) {
            <span class="hljs-built_in">this</span>.advisedBeans.put(cacheKey, Boolean.FALSE);
            <span class="hljs-keyword">return</span> bean;
        }

        <span class="hljs-comment">// 3. 查找所有匹配的切面（Advisor）：此处会找到TransactionAdvisor</span>
        Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, <span class="hljs-literal">null</span>);
        <span class="hljs-keyword">if</span> (specificInterceptors != DO_NOT_PROXY) {
            <span class="hljs-built_in">this</span>.advisedBeans.put(cacheKey, Boolean.TRUE);
            <span class="hljs-comment">// 4. 生成代理对象（CGLIB或JDK动态代理）</span>
            <span class="hljs-type">Object</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> createProxy(
                bean.getClass(), beanName, specificInterceptors, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SingletonTargetSource</span>(bean));
            <span class="hljs-built_in">this</span>.proxyTypes.put(cacheKey, proxy.getClass());
            <span class="hljs-keyword">return</span> proxy;
        }

        <span class="hljs-built_in">this</span>.advisedBeans.put(cacheKey, Boolean.FALSE);
        <span class="hljs-keyword">return</span> bean;
    }
}
</code></pre>
<p>核心逻辑说明：</p>
<ul>
<li>wrapIfNecessary方法会先判断 Bean 是否需要代理（即是否带有@Transactional注解）；</li>
<li>若需要代理，会查找所有匹配的切面（此处即TransactionAdvisor）；</li>
<li>通过createProxy方法生成代理对象（默认 CGLIB 代理）；</li>
<li>后续调用目标 Bean 的方法时，实际执行的是代理对象的方法，代理对象会先触发TransactionInterceptor的事务逻辑，再执行目标方法。</li>
</ul>
<h3 data-id="heading-6">3. 事务执行的完整链路总结</h3>
<ol>
<li>Spring Boot 启动，加载TransactionAutoConfiguration，通过@EnableTransactionManagement导入</li>
<li>ProxyTransactionManagementConfiguration和AutoProxyRegistrar；ProxyTransactionManagementConfiguration注册TransactionAttributeSource（解析注解）、TransactionInterceptor（事务逻辑）、TransactionAdvisor（切面）；</li>
<li>AutoProxyRegistrar注册AnnotationAwareAspectJAutoProxyCreator（AOP 代理处理器）；</li>
<li>Spring 扫描@Service注解的类，创建目标 Bean 实例；</li>
<li>AnnotationAwareAspectJAutoProxyCreator在 Bean 初始化后，通过wrapIfNecessary方法检测到 Bean 带有@Transactional注解，生成代理对象；</li>
<li>开发者调用目标方法时，实际调用代理对象的方法；</li>
<li>代理对象触发TransactionInterceptor：
<ul>
<li>解析@Transactional注解属性，通过事务管理器开启事务；</li>
<li>执行目标方法；</li>
<li>目标方法正常返回：提交事务；</li>
<li>目标方法抛出异常：根据rollbackFor配置回滚事务。</li>
</ul>
</li>
</ol>
<h2 data-id="heading-7">五、Spring Boot 事务实现原理图示</h2>
<ol>
<li>核心组件注册</li>
</ol>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    %% 启动初始化阶段
    A["Spring Boot 启动"] --&gt; B["扫描 spring.factories 文件"]
    B --&gt; C["加载 TransactionAutoConfiguration 自动配置类"]
    C --&gt; D["@EnableTransactionManagement 注解生效"]
    
    %% 核心组件加载阶段
    D --&gt; D1["导入 ProxyTransactionManagementConfiguration"]
    D --&gt; D2["导入 AutoProxyRegistrar"]
    
    %% ProxyTransactionManagementConfiguration 注册Bean
    D1 --&gt; E1["注册 TransactionAttributeSource &lt;br/&gt;（解析@Transactional注解）"]
    D1 --&gt; E2["注册 TransactionInterceptor&lt;br/&gt;（事务拦截器：开启/提交/回滚）"]
    D1 --&gt; E3["注册 TransactionAdvisor&lt;br/&gt;（切面=切入点+通知）"]
    E1 &amp; E2 &amp; E3 --&gt; E4["组合为事务切面"]  
  
    %% AutoProxyRegistrar 开启AOP代理
    D2 --&gt; F["注册 AnnotationAwareAspectJAutoProxyCreator&lt;br/&gt;（AOP代理处理器，实现BeanPostProcessor）"]
</code></pre>
<ol start="2">
<li>生成代理对象</li>
</ol>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
  %% Bean初始化与代理生成阶段
    G["扫描@Service等注解"] --&gt; H["创建目标Bean实例（如UserService）"]
    H --&gt; I["触发 BeanPostProcessor 后置处理"]
    I --&gt; J["AnnotationAwareAspectJAutoProxyCreator &lt;br/&gt;执行 postProcessAfterInitialization"]
    J --&gt; K{"目标Bean方法是否有&lt;br/&gt;@Transactional注解？"}
    K --&gt;|否| L["直接返回原始Bean"]
    K --&gt;|是| M["查找匹配的 TransactionAdvisor 切面"]
    M --&gt; N["生成动态代理对象（默认CGLIB）"]
</code></pre>
<ol start="3">
<li>处理事务流程</li>
</ol>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD

    %% 事务执行阶段
    O["开发者调用目标方法（如addUser()）"] --&gt; P["实际调用代理对象方法"]
    P --&gt; Q["TransactionInterceptor 拦截方法"]
    Q --&gt; R["通过 TransactionAttributeSource 解析&lt;br/&gt;@Transactional属性（传播行为/隔离级别等）"]
    R --&gt; S["事务管理器开启事务"]
    S --&gt; T["执行目标方法核心业务逻辑"]
    
    %% 事务结果处理
    T --&gt; U{"方法执行是否成功？"}
    U --&gt;|"成功（无异常）"| V["事务管理器提交事务"]
    U --&gt;|"失败（抛异常）"| W["根据@Transactional的rollbackFor&lt;br/&gt;配置判断是否回滚"]
    W --&gt;|"满足回滚条件"| X["事务管理器回滚事务"]
    W --&gt;|"不满足回滚条件"| V["事务管理器提交事务"]
    
    %% 流程结束
    V &amp; X --&gt; Y["事务执行完成"]
</code></pre>
<h2 data-id="heading-8">总结</h2>
<p>Spring Boot 动态事务的实现，本质是 “注解标记 + AOP 动态代理 + 自动配置” 的组合：</p>
<ul>
<li>注解（@Transactional）提供 “事务标记”，明确需要增强的方法；</li>
<li>AOP 通过动态代理生成代理对象，拦截目标方法调用；</li>
<li>事务拦截器（TransactionInterceptor）封装事务核心逻辑，实现 “开启 - 执行 - 提交 / 回滚” 的自动化；</li>
<li>自动配置（TransactionAutoConfiguration）简化开发者配置，让整个流程 “开箱即用”。</li>
</ul>
<p>理解这一原理，不仅能帮助开发者正确使用@Transactional注解（避免踩代理失效、事务传播行为错误等坑），还能举一反三，理解 Spring 体系中 “注解驱动” 特性的通用设计思想。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🌴 Go企业级全栈式框架：Goyave入门和使用介绍]]></title>    <link>https://juejin.cn/post/7592130164965408806</link>    <guid>https://juejin.cn/post/7592130164965408806</guid>    <pubDate>2026-01-07T00:29:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592130164965408806" data-draft-id="7590961898399121446" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🌴 Go企业级全栈式框架：Goyave入门和使用介绍"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-07T00:29:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="golang学习记"/> <meta itemprop="url" content="https://juejin.cn/user/4371313964100990"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🌴 Go企业级全栈式框架：Goyave入门和使用介绍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4371313964100990/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    golang学习记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T00:29:31.000Z" title="Wed Jan 07 2026 00:29:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🥥 什么是 Goyave？</h2>
<p>Goyave（读作 /ɡoʊˈjɑːveɪ/，像 “go-yah-vay”）是一个专为 <strong>Go 语言 REST API 开发</strong> 打造的全功能 Web 框架。</p>
<blockquote>
<p>⚠️ 注意：它不是「Go + Java + Vue」的缝合怪；而是 <strong>Go 自己生的娃</strong>，基因纯正，自带「简洁+可靠」属性。</p>
</blockquote>
<p>它的口号可以翻译成：</p>
<blockquote>
<p>✅ 你只管写业务逻辑<br/>
❌ 我帮你挡住配置地狱、验证爆炸、中间件乱炖、JWT 糊脸……</p>
</blockquote>
<p>就像你去健身房请了个私教——他不替你举铁，但会骂你别偷懒、帮你调呼吸、还顺手递蛋白粉。</p>
<hr/>
<h2 data-id="heading-1">🌊 为什么叫 Goyave？名字里有玄机！</h2>
<p>Goyave 是法语里「番石榴」（Guava）的意思……<br/>
但更妙的是——<strong>Go + Ya + Ve</strong> 可以强行解读为：</p>
<blockquote>
<p><strong>Go, Yet Another Very Elegant</strong> framework.</p>
</blockquote>
<p>（Go：又一个非常优雅的框架——谦虚中带着一丝凡尔赛 😎）</p>
<hr/>
<h2 data-id="heading-2">🚀 五分钟上手：写个“会呼吸”的注册登录 API</h2>
<blockquote>
<p>🧠 <em>哲学小剧场</em>：<br/>
人类渴望连接，于是发明了 API；<br/>
API 渴望安全，于是发明了 JWT；<br/>
程序员渴望下班，于是发明了——<strong>Goyave</strong>。</p>
</blockquote>
<h3 data-id="heading-3">Step 1：安装</h3>
<pre><code class="hljs language-bash" lang="bash">go get -u goyave.dev/goyave/v5
</code></pre>
<blockquote>
<p>💡 Goyave v5 是目前最新稳定版（截至 2026），v3 用户别急——升级指南比泡面说明书还短。</p>
</blockquote>
<hr/>
<h3 data-id="heading-4">Step 2：模型定义（User：人类在数字世界的分身）</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span> {
    ID       <span class="hljs-type">uint</span>   <span class="hljs-string">`gorm:"primaryKey"`</span>
    Username <span class="hljs-type">string</span> <span class="hljs-string">`gorm:"type:varchar(100);unique;not null"`</span>
    Password <span class="hljs-type">string</span> <span class="hljs-string">`gorm:"type:varchar(100);not null"`</span>
}
</code></pre>
<blockquote>
<p>🍌 小贴士：<code>Password</code> 字段千万别存明文！Goyave 内置 <code>auth.HashPassword()</code>，像给密码穿上「凯夫拉防弹衣」。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">Step 3：注册请求验证（防杠精专用）</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> RegisterRequest <span class="hljs-keyword">struct</span> {
    Username <span class="hljs-type">string</span> <span class="hljs-string">`validate:"required|min:4|max:100"`</span>
    Password <span class="hljs-type">string</span> <span class="hljs-string">`validate:"required|min:8"`</span> <span class="hljs-comment">// 拒绝 "123456" 入侵！</span>
}
</code></pre>
<p>Goyave 的验证规则<strong>自解释性极强</strong>，连产品经理看了都能点头：“嗯，用户名不能叫 <code>a</code>，合理。”</p>
<blockquote>
<p>🧩 类比时间：<br/>
<code>validate:"required|min:4"</code> ≈ 你妈：“相亲对象至少得有房、有社保、会做饭——三样缺一不可！”（<code>required|min:3</code> 😂）</p>
</blockquote>
<hr/>
<h3 data-id="heading-6">Step 4：注册控制器 —— 比相亲成功率还高的代码</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Register</span><span class="hljs-params">(res *goyave.Response, req *goyave.Request)</span></span> {
    reg := &amp;RegisterRequest{}
    <span class="hljs-keyword">if</span> err := req.ToStruct(reg); err != <span class="hljs-literal">nil</span> {
        res.JSON(err.Status, err)
        <span class="hljs-keyword">return</span>
    }

    user := &amp;User{
        Username: reg.Username,
        Password: auth.HashPassword(reg.Password), <span class="hljs-comment">// 暗号加密！</span>
    }

    <span class="hljs-keyword">if</span> err := database.GetConnection().Create(user).Error; err != <span class="hljs-literal">nil</span> {
        res.Error(err)
        <span class="hljs-keyword">return</span>
    }

    res.JSON(http.StatusCreated, <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}{
        <span class="hljs-string">"id"</span>:       user.ID,
        <span class="hljs-string">"username"</span>: user.Username,
        <span class="hljs-comment">// ✨ 不返回密码！连 hint 都不给黑客！</span>
    })
}
</code></pre>
<blockquote>
<p>✅ 这段代码干了三件事：</p>
<ol>
<li>解析并校验输入（防手滑党）</li>
<li>存入 DB（带盐哈希，咸得黑客流泪）</li>
<li>温柔地返回结果（连 HTTP 状态码都选 <code>201 Created</code>，仪式感拉满）</li>
</ol>
</blockquote>
<hr/>
<h3 data-id="heading-7">Step 5：登录 + JWT 认证（门禁卡自动化）</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Login</span><span class="hljs-params">(res *goyave.Response, req *goyave.Request)</span></span> {
    loginReq := &amp;LoginRequest{}
    <span class="hljs-keyword">if</span> err := req.ToStruct(loginReq); err != <span class="hljs-literal">nil</span> {
        res.JSON(err.Status, err)
        <span class="hljs-keyword">return</span>
    }

    user := &amp;User{}
    <span class="hljs-keyword">if</span> err := database.Where(<span class="hljs-string">"username = ?"</span>, loginReq.Username).First(user).Error; err != <span class="hljs-literal">nil</span> {
        res.JSON(http.StatusUnauthorized, <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>{<span class="hljs-string">"error"</span>: <span class="hljs-string">"用户名或密码错误"</span>})
        <span class="hljs-keyword">return</span>
    }

    <span class="hljs-keyword">if</span> !auth.CheckPassword(user.Password, loginReq.Password) {
        res.JSON(http.StatusUnauthorized, <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>{<span class="hljs-string">"error"</span>: <span class="hljs-string">"用户名或密码错误"</span>})
        <span class="hljs-keyword">return</span>
    }

    token, _ := auth.GenerateToken(user.ID) <span class="hljs-comment">// ← 生成 JWT，像颁发 VIP 电子手环</span>
    res.JSON(http.StatusOK, <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>{<span class="hljs-string">"token"</span>: token})
}
</code></pre>
<blockquote>
<p>🔐 认证中间件一键挂载：</p>
<pre><code class="hljs language-go" lang="go">authMiddleware := &amp;auth.Middleware{}
router.Get(<span class="hljs-string">"/protected"</span>, ProtectedEndpoint).Middleware(authMiddleware)
</code></pre>
<p>→ 从此 <code>/protected</code> 路由只认「Token 手环」，没手环？请去前台登记（即 <code>/login</code>）。</p>
</blockquote>
<hr/>
<h2 data-id="heading-8">🧰 高阶技能彩蛋</h2>
<h3 data-id="heading-9">✅ 动态分页 &amp; 过滤</h3>
<p>Goyave 原生支持 <code>?page=2&amp;page_size=10&amp;sort=-created_at&amp;filter[name]=John</code><br/>
——URL 里写 SQL 条件？不，这叫 <strong>RESTful 黑话</strong>。</p>
<h3 data-id="heading-10">✅ DTO 映射 &amp; 模型转换</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> UserDTO <span class="hljs-keyword">struct</span> {
    ID       <span class="hljs-type">uint</span>   <span class="hljs-string">`json:"id"`</span>
    Username <span class="hljs-type">string</span> <span class="hljs-string">`json:"name"`</span> <span class="hljs-comment">// 前端想要 name？安排。</span>

}
</code></pre>
<h3 data-id="heading-11">✅ 结构化日志 + 错误追踪</h3>
<pre><code class="hljs language-log" lang="log">INFO 2026-01-04T12:00:00Z Request: POST /register
ERROR 2026-01-04T12:00:01Z duplicate key value violates unique constraint (username)
</code></pre>
<p>——日志清晰到能帮你写事故复盘 PPT 📊</p>
<hr/>
<h2 data-id="heading-12">🌱 项目结构建议（“整洁架构”爱好者狂喜）</h2>
<pre><code class="hljs language-bash" lang="bash">/project
├── config/          <span class="hljs-comment"># 配置：像菜谱，决定咸淡</span>
├── database/
│   ├── models/      <span class="hljs-comment"># 数据模型：世界的“骨架”</span>
│   └── migrations/  <span class="hljs-comment"># 迁移脚本：给 DB 做微创手术</span>
├── http/
│   ├── controllers/ <span class="hljs-comment"># 业务逻辑：大脑皮层</span>
│   ├── middleware/  <span class="hljs-comment"># 中间件：安检门 + 礼宾台</span>
│   └── routes.go    <span class="hljs-comment"># 路由：城市交通图</span>
└── main.go          <span class="hljs-comment"># 入口：点火按钮 🔥</span>
</code></pre>
<blockquote>
<p>🪴 设计哲学：<strong>“约定优于配置”</strong> ——<br/>
框架给你搭好脚手架，你专注砌墙；<br/>
若你想自己烧砖？也留了逃生舱口（可高度自定义）。</p>
</blockquote>
<hr/>
<h2 data-id="heading-13">🎯 适合谁用？</h2>

























<table><thead><tr><th>你是……</th><th>Goyave 说……</th></tr></thead><tbody><tr><td>初学 Go 想快速写 API</td><td>“来，我扶你上车，安全带已扣好 🚗”</td></tr><tr><td>老司机厌倦了手搓 middleware</td><td>“这些脏活我包了，你去喝杯椰子水 🥥”</td></tr><tr><td>团队需要统一规范</td><td>“我的 lint + test + validate 三件套，保你 Code Review 少吵架”</td></tr><tr><td>性能洁癖患者</td><td>“零反射路由 + GORM + 连接池 = 起飞 🚀”</td></tr></tbody></table>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[285. Java Stream API - 通过 Supplier 创建 Stream]]></title>    <link>https://juejin.cn/post/7592059801885081643</link>    <guid>https://juejin.cn/post/7592059801885081643</guid>    <pubDate>2026-01-07T00:56:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592059801885081643" data-draft-id="7592059801885048875" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="285. Java Stream API - 通过 Supplier 创建 Stream"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2026-01-07T00:56:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Cache技术分享"/> <meta itemprop="url" content="https://juejin.cn/user/1662117313262776"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            285. Java Stream API - 通过 Supplier 创建 Stream
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1662117313262776/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Cache技术分享
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T00:56:37.000Z" title="Wed Jan 07 2026 00:56:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">285. Java Stream API - 通过 Supplier 创建 Stream</h2>
<hr/>
<h4 data-id="heading-1">✅ 基本概念</h4>
<p><code>Java</code> 的 <code>Stream</code> 接口提供了两个用于从 <strong>Supplier（供应者）</strong> 创建流的工厂方法，其中之一就是：</p>
<pre><code class="hljs language-java" lang="java">Stream.generate(Supplier&lt;T&gt; supplier)
</code></pre>
<p>这个方法用于 <strong>生成无限流（infinite stream）</strong>：每当流需要一个新元素时，<code>Supplier</code> 就会被调用一次来“供应”这个元素。</p>
<hr/>
<h4 data-id="heading-2">🧪 示例代码</h4>
<pre><code class="hljs language-java" lang="java">Stream&lt;String&gt; generated = Stream.generate(() -&gt; <span class="hljs-string">"+"</span>);
List&lt;String&gt; strings = generated.limit(<span class="hljs-number">5L</span>).toList();
System.out.println(<span class="hljs-string">"strings = "</span> + strings);
</code></pre>
<h5 data-id="heading-3">💻 输出结果：</h5>
<pre><code class="hljs language-java" lang="java">strings = [+, +, +, +, +]
</code></pre>
<hr/>
<h4 data-id="heading-4">⚠️ 小心！这是个无限流！</h4>
<blockquote>
<p>❗ 如果你去掉 <code>.limit(5L)</code>，这个程序将永远不会停止运行！</p>
</blockquote>
<pre><code class="hljs language-java" lang="java">Stream&lt;String&gt; generated = Stream.generate(() -&gt; <span class="hljs-string">"+"</span>);
generated.forEach(System.out::println); <span class="hljs-comment">// ❌ 小心，死循环</span>
</code></pre>
<p>🚨 它将不停地生成 <code>+</code>，直到你的内存耗尽，甚至抛出 <code>OutOfMemoryError</code>！</p>
<hr/>
<h4 data-id="heading-5">🎯 正确使用方式：结合 <strong>限制操作（short-circuiting）</strong></h4>
<p>在 <code>Stream API</code> 中，像 <code>limit()</code> 这样的操作被称为 <strong>短路操作（short-circuiting operations）</strong>。它的作用是“提前终止流的生成或处理”。</p>
<blockquote>
<p>✅ 加上 <code>limit(n)</code>，我们就可以从无限流中“截取”前 <code>n</code> 个元素使用。</p>
</blockquote>
<pre><code class="hljs language-java" lang="java">Stream&lt;Double&gt; randoms = Stream.generate(Math::random);
List&lt;Double&gt; topFive = randoms.limit(<span class="hljs-number">5</span>).toList();
System.out.println(topFive); <span class="hljs-comment">// 打印 5 个随机数</span>
</code></pre>
<hr/>
<h4 data-id="heading-6">🧠 学习要点</h4>

























<table><thead><tr><th>关键点</th><th>说明</th></tr></thead><tbody><tr><td><code>Stream.generate(...)</code></td><td>会创建一个 <strong>无限</strong> 的流</td></tr><tr><td><strong>必须</strong>使用 <code>limit()</code> 或其他短路操作</td><td>否则程序会永远运行或耗尽资源</td></tr><tr><td>适合生成固定模式、常量、随机数等</td><td>比如 <code>"++++++++"</code> 或随机数序列</td></tr><tr><td>每次调用都会重新获取一个值</td><td>这与 <code>of(...)</code> 或 <code>Arrays.stream(...)</code> 是 <strong>静态集合</strong> 不同</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-7">📌 示例：生成时间戳</h4>
<pre><code class="hljs language-java" lang="java">Stream&lt;String&gt; timeStream = Stream.generate(() -&gt; Instant.now().toString());
List&lt;String&gt; timestamps = timeStream.limit(<span class="hljs-number">3</span>).toList();
System.out.println(timestamps);
</code></pre>
<blockquote>
<p>输出三个不同时间戳，适合用于日志采样、延迟任务等场景。</p>
</blockquote>
<hr/>
<h4 data-id="heading-8">🧪 小练习题（可做培训互动）</h4>
<p>问：以下代码会输出几个 <code>"Hello"</code>？</p>
<pre><code class="hljs language-java" lang="java">Stream.generate(() -&gt; <span class="hljs-string">"Hello"</span>)
      .limit(<span class="hljs-number">3</span>)
      .forEach(System.out::println);
</code></pre>
<p>答案：</p>
<pre><code class="hljs language-java" lang="java">Hello
Hello
Hello
</code></pre>
<hr/>
<h4 data-id="heading-9">📚 小结</h4>
<ul>
<li><code>Stream.generate(...)</code> = 无限供应机，每次都生产一个元素。</li>
<li>不加限制操作就是“失控的水龙头 💦”，必须加上 <code>.limit()</code>、<code>.takeWhile()</code> 等手段节流。</li>
<li>适合用于生成常量、重复元素、随机值、当前时间等“动态”数据。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C 语言指针从入门到实战：吃透核心，避开 90% 的坑]]></title>    <link>https://juejin.cn/post/7592251792630710299</link>    <guid>https://juejin.cn/post/7592251792630710299</guid>    <pubDate>2026-01-07T01:05:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592251792630710299" data-draft-id="7592089325912326144" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C 语言指针从入门到实战：吃透核心，避开 90% 的坑"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-07T01:05:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小杨同学49"/> <meta itemprop="url" content="https://juejin.cn/user/1189004976589664"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C 语言指针从入门到实战：吃透核心，避开 90% 的坑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1189004976589664/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小杨同学49
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T01:05:24.000Z" title="Wed Jan 07 2026 01:05:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">C 语言指针从入门到实战：吃透核心，避开 90% 的坑</h2>
<p>指针是 C 语言的灵魂，也是初学者的 “拦路虎”。它赋予程序直接操作内存的强大能力，是实现高效数据传递、复杂数据结构（链表、树）的核心基础。很多人觉得指针抽象难懂，其实只要抓住 “地址” 这个本质，再结合实际场景练习，就能彻底打通任督二脉。本文结合指针学习的核心逻辑，从基础概念到实战案例，再到避坑指南，帮你系统掌握指针的用法。</p>
<h3 data-id="heading-1">一、指针基础：看透 “地址” 的本质</h3>
<h4 data-id="heading-2">1. 指针是什么？</h4>
<p>指针的本质是<strong>存储内存地址的变量</strong>。我们可以用一个通俗的比喻理解：</p>
<ul>
<li>内存 = 快递仓库（每个存储单元有唯一编号，即地址）；</li>
<li>变量 = 仓库里的包裹（存储具体数据）；</li>
<li>指针 = 快递单（上面写着包裹的具体地址）；</li>
<li>解引用（*）= 快递员按地址找到包裹并打开。</li>
</ul>
<h4 data-id="heading-3">2. 核心操作：&amp; 和 * 的用法</h4>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment">#include &lt;stdio.h&gt;</span>
<span class="hljs-keyword">int</span> main() {
    <span class="hljs-keyword">int</span> num = <span class="hljs-number">10</span>;  <span class="hljs-regexp">//</span> 变量：内存中存储<span class="hljs-number">10</span>的“包裹”
    <span class="hljs-keyword">int</span> *p = &amp;num; <span class="hljs-regexp">//</span> 指针p：存储num的地址（&amp;是取地址运算符）
    
    <span class="hljs-keyword">printf</span>(<span class="hljs-string">"变量num的值：%d\n"</span>, num);      <span class="hljs-regexp">//</span> 直接访问包裹：<span class="hljs-number">10</span>
    <span class="hljs-keyword">printf</span>(<span class="hljs-string">"变量num的地址：%p\n"</span>, &amp;num);  <span class="hljs-regexp">//</span> 查看包裹地址：<span class="hljs-number">0x7fff</span>...（随系统变化）
    <span class="hljs-keyword">printf</span>(<span class="hljs-string">"指针p存储的地址：%p\n"</span>, p);   <span class="hljs-regexp">//</span> 查看快递单地址：与&amp;num一致
    <span class="hljs-keyword">printf</span>(<span class="hljs-string">"指针p指向的值：%d\n"</span>, *p);    <span class="hljs-regexp">//</span> 按地址取包裹：<span class="hljs-number">10</span>（*是解引用运算符）
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<ul>
<li><code>&amp;变量名</code>：获取变量的内存地址；</li>
<li><code>*指针名</code>：通过指针存储的地址，访问或修改目标变量的值；</li>
<li>指针变量本身也占内存（通常 4 或 8 字节，取决于系统架构）。</li>
</ul>
<h4 data-id="heading-4">3. 指针类型的意义</h4>
<p>指针声明时必须指定类型（如<code>int*</code>、<code>char*</code>），它决定了两件关键事：</p>
<ul>
<li>内存访问粒度：<code>int*</code>每次访问 4 字节（int 类型大小），<code>char*</code>每次访问 1 字节；</li>
<li>指针运算规则：<code>p++</code>时，<code>int*</code>指针地址 + 4，<code>char*</code>指针地址 + 1，确保指向有效数据。</li>
</ul>
<h3 data-id="heading-5">二、核心应用：指针的 3 大实用场景</h3>
<h4 data-id="heading-6">1. 指针与数组：天生一对</h4>
<p>数组和指针是 C 语言中最亲密的组合，数组名本质是<strong>指向首元素的常量指针</strong>，二者在很多场景下可互换使用。</p>
<h5 data-id="heading-7">关键关系</h5>
<ul>
<li><code>arr[i]</code> 等价于 <code>*(arr + i)</code>：数组下标访问本质是指针偏移运算；</li>
<li>数组名是常量指针，不能重新赋值（如<code>arr = p</code> 报错），但指针变量可以自由指向（如<code>p = arr</code> 合法）；</li>
<li>函数传参时，数组会退化为指针，函数接收的实际是数组首元素地址。</li>
</ul>
<h5 data-id="heading-8">实战：指针遍历数组</h5>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">int</span> arr[<span class="hljs-number">5</span>] = {<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>};
    <span class="hljs-type">int</span> *p = arr; <span class="hljs-comment">// 指针指向数组首元素</span>
    
    <span class="hljs-comment">// 指针遍历（比下标更高效）</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d "</span>, *(p + i)); <span class="hljs-comment">// 输出：1 2 3 4 5</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h4 data-id="heading-9">2. 指针与函数：高效传参</h4>
<p>C 语言函数默认是 “值传递”（传递副本），而指针传递能直接操作原始数据，解决两大问题：</p>
<ul>
<li>修改外部变量：无需返回值即可改变函数外变量的值；</li>
<li>突破单返回值限制：通过多个指针参数，间接返回多个结果。</li>
</ul>
<h5 data-id="heading-10">实战 1：指针传递实现两数交换</h5>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-comment">// 指针传递：接收变量地址，直接操作原始数据</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">swap</span><span class="hljs-params">(<span class="hljs-type">int</span> *a, <span class="hljs-type">int</span> *b)</span> </span>{
    <span class="hljs-type">int</span> temp = *a;
    *a = *b;
    *b = temp;
}
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">int</span> x = <span class="hljs-number">5</span>, y = <span class="hljs-number">10</span>;
    <span class="hljs-built_in">swap</span>(&amp;x, &amp;y); <span class="hljs-comment">// 传递变量地址</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"x=%d, y=%d\n"</span>, x, y); <span class="hljs-comment">// 输出：x=10, y=5（交换成功）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h5 data-id="heading-11">实战 2：二级指针修改指针指向</h5>
<p>如果想在函数中改变指针本身的指向（而非指向的值），需要用到二级指针（指向指针的指针）：</p>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-comment">// 二级指针：改变一级指针的指向</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">changePtr</span><span class="hljs-params">(<span class="hljs-type">int</span> **pp)</span> {
    *pp = (<span class="hljs-type">int</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>)); <span class="hljs-comment">// 分配新内存</span>
    **pp = <span class="hljs-number">20</span>; <span class="hljs-comment">// 给新内存赋值</span>
}
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    <span class="hljs-type">int</span> *p = <span class="hljs-literal">NULL</span>;
    changePtr(&amp;p); <span class="hljs-comment">// 传递一级指针的地址</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"p指向的值：%d\n"</span>, *p); <span class="hljs-comment">// 输出：20</span>
    <span class="hljs-built_in">free</span>(p); <span class="hljs-comment">// 释放内存</span>
    p = <span class="hljs-literal">NULL</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h4 data-id="heading-12">3. 指针数组：高效管理字符串</h4>
<p>指针数组是 “存储指针的数组”，最经典的用途是管理一组字符串 —— 无需移动字符串本身，只需交换指针指向，大幅提升效率。</p>
<h5 data-id="heading-13">实战：指针数组排序字符串</h5>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment">#include &lt;stdio.h&gt;</span>
<span class="hljs-comment">#include &lt;string.h&gt;</span>
// 选择排序：按字典序降序排列字符串
void sortStrings(char *arr<span class="hljs-section">[]</span>, int n) {
    for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; n - 1; i++) {</span>
        int <span class="hljs-attr">maxIdx</span> = i<span class="hljs-comment">;</span>
        // 查找当前最大字符串
        for (int <span class="hljs-attr">j</span> = i + <span class="hljs-number">1</span><span class="hljs-comment">; j &lt; n; j++) {</span>
            if (strcmp(arr<span class="hljs-section">[j]</span>, arr<span class="hljs-section">[maxIdx]</span>) &gt; 0) {
                <span class="hljs-attr">maxIdx</span> = j<span class="hljs-comment">;</span>
            }
        }
        // 交换指针（不移动字符串）
        char *<span class="hljs-attr">temp</span> = arr[i]<span class="hljs-comment">;</span>
        arr<span class="hljs-section">[i]</span> = arr<span class="hljs-section">[maxIdx]</span><span class="hljs-comment">;</span>
        arr<span class="hljs-section">[maxIdx]</span> = temp<span class="hljs-comment">;</span>
    }
}
int main() {
    char *strs<span class="hljs-section">[]</span> = {"hello", "world", "c", "pointer", "array"}<span class="hljs-comment">;</span>
    int <span class="hljs-attr">n</span> = sizeof(strs) / sizeof(strs[<span class="hljs-number">0</span>])<span class="hljs-comment">;</span>
    
    sortStrings(strs, n)<span class="hljs-comment">;</span>
    // 输出排序结果：world pointer hello array c
    for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; n; i++) {</span>
        printf("%s ", strs<span class="hljs-section">[i]</span>)<span class="hljs-comment">;</span>
    }
    return 0<span class="hljs-comment">;</span>
}
</code></pre>
<h3 data-id="heading-14">三、避坑指南：5 个致命错误千万别犯</h3>
<p>指针虽强，但稍有不慎就会导致程序崩溃或内存泄漏，以下是初学者最易踩的坑：</p>
<h4 data-id="heading-15">1. 野指针：未初始化的 “流浪指针”</h4>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-ini" lang="ini">// 错误：指针p未初始化，指向随机地址
int *p<span class="hljs-comment">;</span>
*<span class="hljs-attr">p</span> = <span class="hljs-number">10</span><span class="hljs-comment">; // 程序崩溃风险！</span>

// 正确：要么初始化指向合法地址，要么置空
int <span class="hljs-attr">x</span> = <span class="hljs-number">5</span><span class="hljs-comment">;</span>
int *<span class="hljs-attr">p</span> = &amp;x<span class="hljs-comment">; // 指向有效变量</span>
// 或
int *<span class="hljs-attr">p</span> = NULL<span class="hljs-comment">; // 明确指向空地址</span>
</code></pre>
<h4 data-id="heading-16">2. 内存泄漏：分配后忘记释放</h4>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 错误：malloc分配的内存未free，函数结束后永久丢失</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">func</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">int</span> *p = (<span class="hljs-type">int</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">4</span>);
    *p = <span class="hljs-number">10</span>;
    <span class="hljs-comment">// 未执行free(p)</span>
}

<span class="hljs-comment">// 正确：分配与释放成对出现，释放后置空</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">func</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">int</span> *p = (<span class="hljs-type">int</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">4</span>);
    *p = <span class="hljs-number">10</span>;
    <span class="hljs-built_in">free</span>(p); <span class="hljs-comment">// 释放内存</span>
    p = <span class="hljs-literal">NULL</span>; <span class="hljs-comment">// 避免悬空指针</span>
}
</code></pre>
<h4 data-id="heading-17">3. 解引用空指针：访问不存在的地址</h4>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-ini" lang="ini">// 错误：空指针不能解引用
int *<span class="hljs-attr">p</span> = NULL<span class="hljs-comment">;</span>
*<span class="hljs-attr">p</span> = <span class="hljs-number">100</span><span class="hljs-comment">; // 程序崩溃！</span>

// 正确：使用前先判断
int *<span class="hljs-attr">p</span> = NULL<span class="hljs-comment">;</span>
if (p != NULL) {
    *<span class="hljs-attr">p</span> = <span class="hljs-number">100</span><span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-18">4. 数组越界：指针偏移超出有效范围</h4>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-ini" lang="ini">// 错误：数组只有5个元素，循环条件i&lt;=5导致越界
int arr<span class="hljs-section">[5]</span> = {1,2,3,4,5}<span class="hljs-comment">;</span>
int *<span class="hljs-attr">p</span> = arr<span class="hljs-comment">;</span>
for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt;= 5; i++) {</span>
    printf("%d ", *p++)<span class="hljs-comment">; // 访问无效内存</span>
}

// 正确：循环条件严格控制在有效范围内
for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 5; i++) {</span>
    printf("%d ", *p++)<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-19">5. 混淆数组指针与指针数组</h4>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-css" lang="css">// 数组指针：指向数组的指针（本质是指针）
int (*<span class="hljs-selector-tag">p</span>)<span class="hljs-selector-attr">[10]</span>; // <span class="hljs-selector-tag">p</span>指向包含<span class="hljs-number">10</span>个int的数组

// 指针数组：存储指针的数组（本质是数组）
int *<span class="hljs-selector-tag">p</span><span class="hljs-selector-attr">[10]</span>; // <span class="hljs-selector-tag">p</span>是数组，包含<span class="hljs-number">10</span>个int*指针

// 记忆技巧：()优先级高于<span class="hljs-selector-attr">[]</span>，先结合*是指针，先结合<span class="hljs-selector-attr">[]</span>是数组
</code></pre>
<h3 data-id="heading-20">四、总结：指针学习的 3 个关键</h3>
<ol>
<li>抓本质：指针就是 “地址容器”，所有操作都围绕 “存储地址” 和 “通过地址访问数据” 展开；</li>
<li>多实践：数组、函数、字符串是指针的核心应用场景，每个场景至少编写 3 个实战案例；</li>
<li>避陷阱：牢记野指针、内存泄漏、越界这三大 “红线”，养成初始化、配对释放的习惯。</li>
</ol>
<p>指针是 C 语言的 “屠龙刀”，一旦掌握，你就能突破很多基础语法的限制，写出更高效、更灵活的代码。刚开始学习时遇到困惑很正常，多画图梳理地址关系，多调试观察指针变化，慢慢就会豁然开朗。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型还在硬编码？Spring AI 实现“动态热切换”全攻略（上）]]></title>    <link>https://juejin.cn/post/7592127014188023808</link>    <guid>https://juejin.cn/post/7592127014188023808</guid>    <pubDate>2026-01-07T01:38:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592127014188023808" data-draft-id="7592094314472292387" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型还在硬编码？Spring AI 实现“动态热切换”全攻略（上）"/> <meta itemprop="keywords" content="后端,OpenAI"/> <meta itemprop="datePublished" content="2026-01-07T01:38:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户90832460273"/> <meta itemprop="url" content="https://juejin.cn/user/307518986530984"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型还在硬编码？Spring AI 实现“动态热切换”全攻略（上）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/307518986530984/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户90832460273
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T01:38:53.000Z" title="Wed Jan 07 2026 01:38:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>摘要</strong>：在企业级 AI 开发中，单一模型往往难以适应多变的业务需求。本文将介绍如何基于 Spring AI 框架，构建一个支持动态切换底层模型（如 OpenAI、DeepSeek）、可配置参数（如温度、TopK）以及自定义角色人设的通用 AI 服务架构。我们将从数据库设计出发，深入讲解策略模式与工厂模式在 AI 中台建设中的实际应用。</p>
</blockquote>
<h2 data-id="heading-0">0. 技术栈说明</h2>
<p>本文基于以下核心技术栈：</p>
<ul>
<li><strong>JDK</strong>: 17+</li>
<li><strong>Spring Boot</strong>: 3.3.x</li>
<li><strong>Spring AI</strong>: 1.1.x</li>
</ul>
<h3 data-id="heading-1">0.1 引入 Maven 依赖</h3>
<p>在使用 Spring AI 之前，我们需要在 <code>pom.xml</code> 中引入 <code>spring-ai-bom</code> 来管理版本，并添加相应的 Starter 依赖。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-bom<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span>
​
<span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- WebFlux 支持流式响应 (SSE) --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
​
    <span class="hljs-comment">&lt;!-- OpenAI 模型支持 (Spring AI 核心) --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-starter-model-openai<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
​
    <span class="hljs-comment">&lt;!-- DeepSeek 模型支持 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-deepseek<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
​
    <span class="hljs-comment">&lt;!-- 智谱 AI 模型支持 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-zhipuai<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
​
    <span class="hljs-comment">&lt;!-- RAG 向量检索支持 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
         <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
         <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-advisors-vector-store<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h2 data-id="heading-2">1. 核心痛点与设计目标</h2>
<p>在 Spring AI 的默认配置中，<code>ChatModel</code> 通常是单例的。但在实际业务场景中，我们经常面临以下挑战：</p>
<ol>
<li><strong>动态切换</strong>：管理员在后台配置不同的 API Key 和 Endpoint，系统需即时生效，无需重启。</li>
<li><strong>个性化人设</strong>：不同的业务场景需要不同的“角色（System Prompt）”，例如“客服助手”、“代码专家”等。</li>
<li><strong>参数热配</strong>：<strong>Temperature (温度)</strong>、<strong>Top-P</strong> 等推理参数需支持数据库化配置，以便根据效果灵活调整。</li>
</ol>
<p>为此，我们采用了 <strong>“数据库配置表 + 动态工厂模式”</strong> 的架构方案。</p>
<h2 data-id="heading-3">2. 数据库设计</h2>
<p>为了实现上述目标，我们需要两张核心表：一张存储<strong>模型连接信息</strong>，另一张存储<strong>角色与 Prompt 配置</strong>。</p>
<h3 data-id="heading-4">2.1 模型配置表 (<code>ai_model_config</code>)</h3>
<p>这张表用于存储 LLM 的连接参数和推理参数。</p>
<p><strong>关键字段解析：</strong></p>
<ul>
<li><strong><code>api_endpoint</code></strong>: 标准的 OpenAI 接口地址是 <code>api.openai.com</code>，但国内许多大模型（如 DeepSeek, Moonshot）都兼容 OpenAI 协议。我们只需要将 Endpoint 修改为厂商提供的地址，即可复用同一套代码。</li>
<li><strong><code>temperature</code></strong>: 值通常在 0 到 1（或 2）之间。<strong>数值越低</strong>，模型越保守、严谨，适合客服问答；<strong>数值越高</strong>，模型越发散、有创造力，适合写诗或头脑风暴。</li>
<li><strong><code>top_p</code></strong>: 核采样概率。它与 Temperature 类似，也是控制生成多样性的参数。通常建议这两个参数只调整其中一个。</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `ai_model_config` (
  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">'主键ID'</span>,
  `config_name` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'配置名称'</span>,
  `api_provider` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'API 提供商 (核心字段，决定调用哪个策略，如 openai, deepseek)'</span>,
  `model_id` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'模型标识 (如 gpt-4o, deepseek-chat)'</span>,
  `is_enabled` tinyint(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'1'</span> COMMENT <span class="hljs-string">'是否启用（1-启用 0-禁止）'</span>,
  `is_default` tinyint(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'0'</span> COMMENT <span class="hljs-string">'是否默认（1-是 0-否）'</span>,
  `role_id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'绑定角色与提示词ID（可为空，用于设置 System Prompt）'</span>,
  `api_key` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'API Key (敏感信息)'</span>,
  `api_endpoint` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'API 端点 (用于适配兼容 OpenAI 协议的国内模型)'</span>,
  `temperature` <span class="hljs-keyword">double</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'温度 (控制回答的随机性)'</span>,
  `top_p` <span class="hljs-keyword">double</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'Top P'</span>,
  `max_tokens` <span class="hljs-type">int</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'最大 Token 数'</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)
) COMMENT<span class="hljs-operator">=</span><span class="hljs-string">'AI 模型配置表'</span>;
</code></pre>
<h3 data-id="heading-5">2.2 角色与 RAG 配置表 (<code>ai_role_prompt</code>)</h3>
<p>这张表定义了 AI 的“人设”以及 RAG（检索增强生成）的相关规则。</p>
<p><strong>关键字段解析：</strong></p>
<ul>
<li><strong><code>system_prompt</code></strong>: 系统提示词。这是发给 AI 的第一句话，规定了 AI 的身份和行为准则（例如：“你是一个资深的 Java 架构师，只回答技术问题”）。</li>
<li><strong><code>similarity_threshold</code></strong>: 相似度阈值（0.0 - 1.0）。在进行向量检索时，如果文档与问题的相似度低于这个值，就会被过滤掉。这能有效防止 AI 被不相关的文档误导。</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `ai_role_prompt` (
  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">'主键ID'</span>,
  `role_name` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'角色名称'</span>,
  `description` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'角色描述'</span>,
  `is_enabled` tinyint(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'1'</span> COMMENT <span class="hljs-string">'是否启用'</span>,
  `system_prompt` text COMMENT <span class="hljs-string">'系统提示词（System Prompt）'</span>,\
  `is_rag_enabled` tinyint(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'0'</span> COMMENT <span class="hljs-string">'是否启用 RAG'</span>,
  `rag_template` text COMMENT <span class="hljs-string">'RAG 提示词模板'</span>,
  `top_k` <span class="hljs-type">int</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'5'</span> COMMENT <span class="hljs-string">'检索文档数量 topK'</span>,
  `similarity_threshold` <span class="hljs-keyword">double</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'0.7'</span> COMMENT <span class="hljs-string">'相似度阈值（0-1）'</span>,
  `custom_filter` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'自定义过滤表达式'</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)
) COMMENT<span class="hljs-operator">=</span><span class="hljs-string">'AI 角色与提示词配置表'</span>;
</code></pre>
<h2 data-id="heading-6">3. 动态工厂核心实现拆解</h2>
<p><code>DynamicChatClientFactory</code> 是本系统的核心。我们通过分步解析，来看看它是如何工作的。</p>
<h3 data-id="heading-7">3.1 步骤一：加载默认配置</h3>
<p>首先，我们需要从数据库中查询当前生效的配置。这里使用了 MyBatis-Plus 的 LambdaQuery，只查询 <code>is_default=1</code> 且 <code>is_enabled=1</code> 的记录。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// Service 层方法调用</span>
AiModelConfig config = aiModelConfigService.<span class="hljs-built_in">getDefaultConfig</span>();
<span class="hljs-keyword">if</span> (config == null) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">BizException</span>(ResultCode.NOT_FOUND, <span class="hljs-string">"未找到默认启用的模型配置，请先在模型配置中设置默认模型"</span>);
}
</code></pre>
<h3 data-id="heading-8">3.2 步骤二：策略路由与模型构建</h3>
<p>不同的厂商（Provider）初始化方式不同。我们使用<strong>策略模式</strong>，根据 <code>api_provider</code> 字段（如 "openai", "deepseek"）找到对应的策略实现类，构建出底层的 <code>ChatModel</code>。</p>
<p><strong>ChatModel vs ChatClient</strong>:</p>
<ul>
<li><strong>ChatModel</strong>: 是 Spring AI 的底层接口，负责与具体的大模型 API 进行 HTTP 通信（类似 JDBC Driver）。</li>
<li><strong>ChatClient</strong>: 是 Spring AI 的高层接口，提供了 fluent API（链式调用），负责处理 Prompt 封装、Advisor 拦截等逻辑（类似 JdbcTemplate）。</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">// 获取策略并构建底层的 ChatModel
ModelChatStrategy <span class="hljs-attr">strategy</span> = modelChatStrategyFactory.getStrategy(config.getApiProvider())<span class="hljs-comment">;</span>
ChatModel <span class="hljs-attr">chatModel</span> = strategy.buildChatModel(config)<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-9">3.3 步骤三：System Prompt 组装</h3>
<p>这里处理 AI 的“人设”。我们在代码中内置了一个默认的通用人设（植入品牌信息），同时支持从 <code>ai_role_prompt</code> 表中加载动态配置来覆盖默认值。</p>
<pre><code class="hljs language-ini" lang="ini">// 设置默认的 System Prompt（内置兜底）
String <span class="hljs-attr">systemPrompt</span> = <span class="hljs-string">"""
        你是lanjii(岚迹)的客服助手，在用户第一次问你的时候，你要表明自己的身份，并且要说明 lanjii 是什么。
        针对用户的问题总是能以友好愉悦的方式去进行交流，希望带给客户很好的体验。
        你总是会用中文去回答问题。
        """</span><span class="hljs-comment">;</span>
​
// 如果配置了角色，覆盖默认 System Prompt
if (config.getRoleId() != null) {
    AiRolePrompt <span class="hljs-attr">rolePrompt</span> = aiRolePromptService.getById(config.getRoleId())<span class="hljs-comment">;</span>
    if (rolePrompt != null &amp;&amp; rolePrompt.getSystemPrompt() != null &amp;&amp; !rolePrompt.getSystemPrompt().isEmpty()) {
        <span class="hljs-attr">systemPrompt</span> = rolePrompt.getSystemPrompt()<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h3 data-id="heading-10">3.4 步骤四：注入增强器 (Advisors)</h3>
<p><strong>Advisor</strong> 是 Spring AI 1.x 引入的重要概念，类似于 Spring AOP 的切面。它允许我们在不修改核心业务逻辑的情况下，动态地为 ChatClient 增加能力。</p>
<ul>
<li><strong><code>MessageChatMemoryAdvisor</code></strong>: 负责自动管理对话历史。它会在发请求前把历史记录拼接到 Prompt 中，在收到响应后把新对话存入 Memory。</li>
<li><strong><code>VectorStoreChatMemoryAdvisor</code></strong>: 负责 RAG 检索。</li>
</ul>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 组装 ChatClient，注入记忆和向量检索能力</span>
return ChatClient<span class="hljs-selector-class">.builder</span>(chatModel)
        <span class="hljs-selector-class">.defaultSystem</span>(systemPrompt)
        <span class="hljs-selector-class">.defaultAdvisors</span>(
                MessageChatMemoryAdvisor.builder(chatMemory)<span class="hljs-selector-class">.build</span>(),
                VectorStoreChatMemoryAdvisor<span class="hljs-selector-class">.builder</span>(vectorStore)<span class="hljs-selector-class">.build</span>()
        )
        <span class="hljs-selector-class">.build</span>();
</code></pre>
<h2 data-id="heading-11">4. 工厂类完整代码清单</h2>
<p>将上述步骤整合，我们得到了完整的工厂类代码：</p>
<pre><code class="hljs language-ini" lang="ini">package com.lanjii.biz.admin.ai.service<span class="hljs-comment">;</span>
​
import com.lanjii.biz.admin.ai.model.entity.AiModelConfig<span class="hljs-comment">;</span>
import com.lanjii.biz.admin.ai.model.entity.AiRolePrompt<span class="hljs-comment">;</span>
import com.lanjii.biz.admin.ai.strategy.ModelChatStrategy<span class="hljs-comment">;</span>
import com.lanjii.biz.admin.ai.strategy.ModelChatStrategyFactory<span class="hljs-comment">;</span>
import com.lanjii.common.exception.BizException<span class="hljs-comment">;</span>
import com.lanjii.core.resp.ResultCode<span class="hljs-comment">;</span>
import lombok.RequiredArgsConstructor<span class="hljs-comment">;</span>
import org.springframework.ai.chat.client.ChatClient<span class="hljs-comment">;</span>
import org.springframework.ai.chat.client.advisor.MessageChatMemoryAdvisor<span class="hljs-comment">;</span>
import org.springframework.ai.chat.client.advisor.vectorstore.VectorStoreChatMemoryAdvisor<span class="hljs-comment">;</span>
import org.springframework.ai.chat.memory.ChatMemory<span class="hljs-comment">;</span>
import org.springframework.ai.chat.model.ChatModel<span class="hljs-comment">;</span>
import org.springframework.ai.vectorstore.VectorStore<span class="hljs-comment">;</span>
import org.springframework.stereotype.Component<span class="hljs-comment">;</span>
​
/**
 * 根据数据库中的模型配置动态构建 {@link ChatClient}
 *
 * @author lanjii
 */
@Component
@RequiredArgsConstructor
public class DynamicChatClientFactory {
​
    private final AiModelConfigService aiModelConfigService<span class="hljs-comment">;</span>
    private final AiRolePromptService aiRolePromptService<span class="hljs-comment">;</span>
    private final ModelChatStrategyFactory modelChatStrategyFactory<span class="hljs-comment">;</span>
    private final ChatMemory chatMemory<span class="hljs-comment">;</span>
    private final VectorStore vectorStore<span class="hljs-comment">;</span>
​
    /**
     * 构建默认模型
     */
    public ChatClient buildDefaultClient() {
        // 加载默认配置
        AiModelConfig <span class="hljs-attr">config</span> = aiModelConfigService.getDefaultConfig()<span class="hljs-comment">;</span>
        if (<span class="hljs-attr">config</span> == null) {
            throw new BizException(ResultCode.NOT_FOUND, "未找到默认启用的模型配置，请先在模型配置中设置默认模型")<span class="hljs-comment">;</span>
        }
        
        // 策略路由构建模型
        ModelChatStrategy <span class="hljs-attr">strategy</span> = modelChatStrategyFactory.getStrategy(config.getApiProvider())<span class="hljs-comment">;</span>
        ChatModel <span class="hljs-attr">chatModel</span> = strategy.buildChatModel(config)<span class="hljs-comment">;</span>
​
        // 初始化默认提示词
        String <span class="hljs-attr">systemPrompt</span> = <span class="hljs-string">"""
                你是lanjii(岚迹)的客服助手，在用户第一次问你的时候，你要表明自己的身份，并且要说明 lanjii 是什么。
                针对用户的问题总是能以友好愉悦的方式去进行交流，希望带给客户很好的体验。
                你总是会用中文去回答问题。
                """</span><span class="hljs-comment">;</span>
​
        // 动态覆盖提示词
        if (config.getRoleId() != null) {
            AiRolePrompt <span class="hljs-attr">rolePrompt</span> = aiRolePromptService.getById(config.getRoleId())<span class="hljs-comment">;</span>
            if (rolePrompt != null &amp;&amp; rolePrompt.getSystemPrompt() != null &amp;&amp; !rolePrompt.getSystemPrompt().isEmpty()) {
                <span class="hljs-attr">systemPrompt</span> = rolePrompt.getSystemPrompt()<span class="hljs-comment">;</span>
            }
        }
​
        // 构建增强版客户端
        return ChatClient.builder(chatModel)
                .defaultSystem(systemPrompt)
                .defaultAdvisors(
                        MessageChatMemoryAdvisor.builder(chatMemory).build(),
                        VectorStoreChatMemoryAdvisor.builder(vectorStore).build()
                )
                .build()<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h2 data-id="heading-12">5. 架构思考：性能与灵活性的权衡</h2>
<p>在上述实现中，我们每次调用 <code>buildDefaultClient()</code> 时，都会执行一次“查库 + 策略构建 + Client 组装”的全流程。</p>
<ul>
<li><strong>优势</strong>：实现了 100% 的<strong>热更新</strong>。管理员在后台修改了 API Key 或 Temperature，下一个请求立即生效，没有任何延迟。</li>
<li><strong>劣势</strong>：在高并发场景下，频繁创建 <code>ChatModel</code> 对象可能会带来一定的 GC 压力。</li>
</ul>
<p><strong>进阶优化方向</strong>：如果您的系统 QPS 很高，可以引入 <strong>本地缓存 (如 Caffeine)</strong>。</p>
<ol>
<li>将 <code>config.getId()</code> 作为缓存 Key。</li>
<li>将构建好的 <code>ChatClient</code> 作为缓存 Value。</li>
<li>设置较短的过期时间（如 1 分钟），或者利用 Spring Cache 的 <code>@CacheEvict</code> 在配置更新时主动清除缓存。</li>
</ol>
<p>这样既保留了动态性，又兼顾了性能。</p>
<h2 data-id="heading-13">6. 项目资源</h2>
<ul>
<li><strong>Gitee 源码仓库</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fleven2018%2Flanjii" target="_blank" title="https://gitee.com/leven2018/lanjii" ref="nofollow noopener noreferrer">gitee.com/leven2018/l…</a>这里提供了项目的完整源代码、SQL 脚本以及后续的功能更新。</li>
<li><strong>在线体验地址</strong>：<a href="https://link.juejin.cn?target=http%3A%2F%2F106.54.167.194%2Fadmin%2Flogin" target="_blank" title="http://106.54.167.194/admin/login" ref="nofollow noopener noreferrer">http://106.54.167.194/admin/login</a>无需本地部署，您可以直接访问此系统体验文中的动态模型配置与流式对话功能。</li>
</ul>
<h2 data-id="heading-14">7. 小结</h2>
<p>在本文中，我们完成了最底层的“基础设施”建设。通过 <code>ai_model_config</code> 和 <code>ai_role_prompt</code> 两张表，配合 <code>DynamicChatClientFactory</code>，我们实现了一个灵活的 AI 核心。</p>
<p>在下篇中，我们将进入业务层，深入拆解如何在 Service 中利用这个工厂，实现手动控制的 RAG 检索与 SSE 流式响应。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🔥🔥🔥 React18 源码学习 - 容器的挂载]]></title>    <link>https://juejin.cn/post/7592088192516587563</link>    <guid>https://juejin.cn/post/7592088192516587563</guid>    <pubDate>2026-01-07T00:48:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592088192516587563" data-draft-id="7592127014187450368" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🔥🔥🔥 React18 源码学习 - 容器的挂载"/> <meta itemprop="keywords" content="React.js,源码阅读"/> <meta itemprop="datePublished" content="2026-01-07T00:48:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="yyyao"/> <meta itemprop="url" content="https://juejin.cn/user/4266531531793976"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🔥🔥🔥 React18 源码学习 - 容器的挂载
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4266531531793976/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    yyyao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T00:48:06.000Z" title="Wed Jan 07 2026 00:48:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">前言</h2>
<p>本文的<code>React</code>代码版本为<code>18.2.0</code></p>
<p>可调试的代码仓库为：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyyyao-hh%2Freact-debug%2Ftree%2Fmaster-pure" target="_blank" title="https://github.com/yyyao-hh/react-debug/tree/master-pure" ref="nofollow noopener noreferrer">GitHub - yyyao-hh/react-debug at master-pure</a></p>
<p>当我们初次学习<code>React</code>时，第一个接触的<code>API</code>往往是<code>ReactDOM.render</code>。这个方法是<code>React</code>应用与浏览器 <code>DOM</code>连接的桥梁，也是整个应用渲染的起点。理解它的实现原理能为后续理解组件生命周期、虚拟<code>DOM</code>和协调算法打下坚实基础。</p>
<h2 data-id="heading-1">ReactDOM.render 的基本调用</h2>
<p>在<code>React</code>应用中，我们通常这样使用<code>ReactDOM.render</code>：</p>
<ul>
<li><code>React17</code>及之前：首先获取一个<code>DOM</code>容器，然后将应用进行挂载。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/* src/index.js */</span>

<span class="hljs-keyword">import</span> <span class="hljs-title class_">ReactDOM</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App'</span>;

<span class="hljs-keyword">const</span> root = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'root'</span>);
<span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">render</span>(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>, root);
</code></pre>
<ul>
<li><code>React18</code>开始：首先需要创建一个能够支持并发特性的<code>root</code>对象，然后将应用进行挂载。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/* src/index.js */</span>

<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">ReactDOM</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom/client'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App'</span>;

<span class="hljs-keyword">const</span> root = <span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">createRoot</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'root'</span>));
root.<span class="hljs-title function_">render</span>(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>);
</code></pre>
<p><code>ReactDOM.createRoot</code>的作用便是创建<code>React</code>根节点：作为一个长期存在的、用于管理该容器内整个<code>React</code>树的控制中心。接下来将围绕这个函数进行深入分析！</p>
<blockquote>
<p><code>ReactDOM.render</code>在<code>React18</code>中已被标记为“废弃”（<code>legacy</code>）。它创建的根节点运行在遗留模式（<code>Legacy Mode</code>）下，其渲染过程是同步、不可中断的。</p>
<p>而<code>ReactDOM.createRoot</code>创建的根节点，则默认启用了并发模式（<code>Concurrent Mode</code>）。它允许<code>React</code>在准备渲染更新时进行中断、暂停和恢复，将主线程的控制权交还给浏览器以优先处理高优先级的用户交互（如输入、动画），从而带来更流畅的用户体验。</p>
</blockquote>
<h2 data-id="heading-2">ReactDOM.createRoot：构建根容器</h2>
<p>我们现在开始深入了解下<code>ReactDOM.createRoot</code>这个函数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/* src/index.js */</span>

<span class="hljs-keyword">import</span> <span class="hljs-title class_">ReactDOM</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom'</span>;

<span class="hljs-keyword">const</span> root = <span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">createRoot</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'root'</span>));
</code></pre>
<p>在深入阅读源码后我们会了解到，<code>ReactDOM.createRoot</code>通过层层调用最终停在了某个<code>createRoot</code>方法中，这时的<code>createRoot</code>主要做了三件事：</p>
<ol>
<li><code>createContainer</code>: 创建了根容器对象<code>FiberRoot</code></li>
<li><code>listenToAllSupportedEvents</code>: 代理了所有事件，这是<code>React</code>合成事件系统的基石</li>
<li><code>new ReactDOMRoot</code>: 创建<code>ReactDOMRoot</code>实例并返回。该实例对外暴露了<code>render</code>和<code>unmount</code>方法</li>
</ol>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">/* src/react/packages/react-dom/client.js */</span>
export function <span class="hljs-built_in">createRoot</span>(...): RootType {
  return <span class="hljs-built_in">createRootImpl</span>(...);
}

<span class="hljs-comment">/* src/react/packages/react-dom/src/client/ReactDOM.js */</span>
function <span class="hljs-built_in">createRoot</span>(...): RootType {
  return <span class="hljs-built_in">createRootImpl</span>(...);
}

<span class="hljs-comment">/* src/react/packages/react-dom/src/client/ReactDOMRoot.js */</span>
export function <span class="hljs-built_in">createRoot</span>(...): RootType {
  <span class="hljs-comment">// 1. 创建容器对象 FiberRoot</span>
  const root = <span class="hljs-built_in">createContainer</span>(...);

  <span class="hljs-comment">// 2. 代理所有事件</span>
  <span class="hljs-built_in">listenToAllSupportedEvents</span>(rootContainerElement);

  <span class="hljs-comment">// 3. 返回公开的根对象</span>
  return new <span class="hljs-built_in">ReactDOMRoot</span>(root);
}
</code></pre>
<p>然后我们看到<code>createContainer</code>函数中又继续调用了<code>createFiberRoot</code>函数。在这个函数的内部依旧做了三件比较关键的事：</p>
<ol>
<li>创建 <code>FiberRootNode</code></li>
<li>创建 <code>RootFiberNode</code></li>
<li>进行关联，二者通过<code>.current</code>和<code>.stateNode</code>互相引用，形成闭环：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b2e849c697b4b1fa9ddf999504daa5a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeXl5YW8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768351686&amp;x-signature=SF%2FOqn3SAiaK6w1Q2vGWTJWMpfo%3D" alt="初始化根容器.png" loading="lazy"/></li>
</ol>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">/* src/react/packages/react-reconciler/src/ReactFiberReconciler.old.js */</span>
<span class="hljs-function"><span class="hljs-keyword">export</span> function <span class="hljs-title">createContainer</span><span class="hljs-params">(...)</span>: OpaqueRoot {</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">createFiberRoot</span>(...);
}

<span class="hljs-comment">/* src/react/packages/react-reconciler/src/ReactFiberRoot.old.js */</span>
<span class="hljs-function"><span class="hljs-keyword">export</span> function <span class="hljs-title">createFiberRoot</span><span class="hljs-params">(...)</span>: FiberRoot {</span>
  <span class="hljs-comment">// 1. 创建 FiberRoot</span>
  <span class="hljs-type">const</span> root: FiberRoot = (<span class="hljs-keyword">new</span> <span class="hljs-built_in">FiberRootNode</span>(...));

  <span class="hljs-comment">// 2. 创建 RootFiber</span>
  <span class="hljs-type">const</span> uninitializedFiber = <span class="hljs-built_in">createHostRootFiber</span>(...);
  
  <span class="hljs-comment">// 3. 将二者进行关联</span>
  root.current = uninitializedFiber;
  uninitializedFiber.stateNode = root;

  <span class="hljs-keyword">return</span> root;
}
</code></pre>
<p>看到这里大家肯定对这新出现的结构一脸懵 o((⊙﹏⊙))o</p>
<ul>
<li><strong>FiberRootNode</strong>：<code>Fiber</code>树的容器，它代表了整个<code>React</code>应用的根节点，与实际的<code>DOM</code>容器（例如<code>div#root</code>）相关联。每个<code>React</code>应用通常只有一个<code>FiberRoot</code></li>
<li><strong>RootFiberNode</strong>：<code>Fiber</code>树的根节点，即<code>HostRoot</code>。它是<code>Fiber</code>树结构的起点，其子节点就是应用顶层组件（例如<code>&lt;App /&gt;</code>）</li>
</ul>
<p>最后顺便看一下用于生成<code>RootFiber</code>的函数：<code>createHostRootFiber</code>。它通过调用函数<code>createFiber</code>并传入<code>HostRoot</code>参数，生成了一个代表根节点的<code>Fiber</code>。</p>
<p>这里还有很多<code>Fiber</code>类型，会在<code>Fiber</code>相关的章节详细讲到</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/* src/react/packages/react-reconciler/src/ReactWorkTags.js */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">FunctionComponent</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// 函数组件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">ClassComponent</span> = <span class="hljs-number">1</span>;    <span class="hljs-comment">// 类组件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">HostRoot</span> = <span class="hljs-number">3</span>;          <span class="hljs-comment">// 根节点</span>

<span class="hljs-comment">/* src/react/packages/react-reconciler/src/ReactFiber.old.js */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createHostRootFiber</span>(<span class="hljs-params">...</span>): <span class="hljs-title class_">Fiber</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">createFiber</span>(<span class="hljs-title class_">HostRoot</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, mode);
}

<span class="hljs-keyword">const</span> createFiber = <span class="hljs-keyword">function</span>(<span class="hljs-params">...</span>): <span class="hljs-title class_">Fiber</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FiberNode</span>(...);
}
</code></pre>
<h2 data-id="heading-3">总结</h2>
<p>本文从宏观角度解析了<code>ReactDOM.createRoot</code>如何为<code>React</code>应用初始化容器、创建核心数据结构，并最终准备好渲染的舞台。理解这一过程是掌握<code>React</code>并发渲染模型（<code>Concurrent Mode</code>）的基础。</p>
<p>下一章我们将学习另一个重要的数据结构：<code>Fiber</code></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kubernetes五大核心控制器深度解析：从原理到实践]]></title>    <link>https://juejin.cn/post/7592094358657122338</link>    <guid>https://juejin.cn/post/7592094358657122338</guid>    <pubDate>2026-01-06T16:07:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592094358657122338" data-draft-id="7592089325912834048" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kubernetes五大核心控制器深度解析：从原理到实践"/> <meta itemprop="keywords" content="Kubernetes,云原生"/> <meta itemprop="datePublished" content="2026-01-06T16:07:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="帅猛的Shic"/> <meta itemprop="url" content="https://juejin.cn/user/2737098744398000"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kubernetes五大核心控制器深度解析：从原理到实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2737098744398000/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    帅猛的Shic
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T16:07:48.000Z" title="Tue Jan 06 2026 16:07:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：什么是Kubernetes控制器？</h2>
<ul>
<li>在Kubernetes生态系统中，<strong>控制器</strong>扮演着"智能大脑"的角色。它们持续监控集群状态，确保实际状态与期望状态保持一致。控制器模式是Kubernetes实现声明式API和自愈能力的关键机制。</li>
</ul>
<h2 data-id="heading-1">控制器模式核心思想</h2>
<ul>
<li>
<p>控制循环（Control Loop）</p>
<ul>
<li>
<p>每个控制器都运行一个无限循环，执行三个核心步骤：</p>
<ol start="0">
<li><strong>观察（Observe）</strong> ：通过API Server监视资源状态变化</li>
<li><strong>分析（Diff）</strong> ：比较期望状态（Spec）与实际状态（Status）</li>
<li><strong>执行（Act）</strong> ：采取必要操作使实际状态向期望状态收敛</li>
</ol>
</li>
</ul>
</li>
<li>
<p>声明式状态管理</p>
<ul>
<li>
<p>控制器采用声明式（Declarative）而非命令式（Imperative）方法：</p>
<ul>
<li>用户声明"期望状态"</li>
<li>控制器负责实现并维持该状态</li>
<li>系统具备自愈能力</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 data-id="heading-2">ReplicaSet控制器</h2>
<h3 data-id="heading-3">定位与作用</h3>
<p>ReplicaSet（RS）是Kubernetes中确保指定数量Pod副本运行的基础控制器。它是Deployment的底层实现组件，负责维护应用在集群中的副本数量，确保Pod数量始终与期望值匹配</p>
<h3 data-id="heading-4">核心特性</h3>
<ul>
<li>精确维护Pod副本数量</li>
<li>通过标签选择器识别和管理Pod</li>
<li>提供基本的扩缩容能力</li>
<li>自动替换失败或删除的Pod</li>
</ul>
<h3 data-id="heading-5">ReplicaSet与Deployment的关系</h3>
<pre><code class="hljs language-scss" lang="scss"> Deployment (上层抽象)
     ↓ 管理
 ReplicaSet (副本管理)  
     ↓ 控制
 Pod (运行实例)
</code></pre>
<h3 data-id="heading-6">示例</h3>
<pre><code class="hljs language-yaml" lang="yaml"> <span class="hljs-string">cat</span> <span class="hljs-string">rs-nginx.yaml</span>
 <span class="hljs-string">​</span>
 <span class="hljs-string">​</span>
 <span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
 <span class="hljs-attr">kind:</span> <span class="hljs-string">ReplicaSet</span>
 <span class="hljs-attr">metadata:</span>
   <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-rs</span>
   <span class="hljs-attr">labels:</span>
     <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span>
 <span class="hljs-attr">spec:</span>
   <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span>  <span class="hljs-comment"># 期望的Pod副本数</span>
   <span class="hljs-attr">selector:</span>    <span class="hljs-comment"># 标签选择器，识别要管理的Pod</span>
     <span class="hljs-attr">matchLabels:</span>
       <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span>
   <span class="hljs-attr">template:</span>    <span class="hljs-comment"># Pod模板，用于创建新Pod</span>
     <span class="hljs-attr">metadata:</span>
       <span class="hljs-attr">labels:</span>
         <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span>
     <span class="hljs-attr">spec:</span>
       <span class="hljs-attr">containers:</span>
       <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span>
         <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.19</span>
         <span class="hljs-attr">ports:</span>
         <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span>
         <span class="hljs-attr">resources:</span>     <span class="hljs-comment">#配置资源限制</span>
           <span class="hljs-attr">requests:</span>
             <span class="hljs-attr">memory:</span> <span class="hljs-string">"64Mi"</span>
             <span class="hljs-attr">cpu:</span> <span class="hljs-string">"250m"</span>
           <span class="hljs-attr">limits:</span>
             <span class="hljs-attr">memory:</span> <span class="hljs-string">"128Mi"</span>
             <span class="hljs-attr">cpu:</span> <span class="hljs-string">"500m"</span>
             
             
 <span class="hljs-string">kubectl</span> <span class="hljs-string">apply</span> <span class="hljs-string">-f</span> <span class="hljs-string">rs-nginx.yaml</span>
</code></pre>
<h2 data-id="heading-7">Deployment控制器</h2>
<h3 data-id="heading-8">定位与作用</h3>
<p>Deployment是Kubernetes中用于部署无状态应用的高级控制器。它建立在ReplicaSet之上，提供了声明式的更新、回滚和扩缩容能力，确保应用以可控的方式发布和运行。</p>
<h3 data-id="heading-9">核心特性</h3>
<ul>
<li>管理ReplicaSet，间接控制Pod副本数</li>
<li>支持滚动更新（Rolling Update）、蓝绿部署（Blue-Green）</li>
<li>自动扩缩容（结合HPA（需部署metrics-server组件））</li>
</ul>
<h3 data-id="heading-10">示例</h3>
<pre><code class="hljs language-yaml" lang="yaml"> <span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
 <span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
 <span class="hljs-attr">metadata:</span>
   <span class="hljs-attr">name:</span> <span class="hljs-string">web-app</span>
   <span class="hljs-attr">labels:</span>
     <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span>
 <span class="hljs-attr">spec:</span>
   <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span>  <span class="hljs-comment"># 期望的Pod副本数</span>
   <span class="hljs-attr">selector:</span>
     <span class="hljs-attr">matchLabels:</span>
       <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span>
   <span class="hljs-attr">strategy:</span>
     <span class="hljs-attr">type:</span> <span class="hljs-string">RollingUpdate</span>
     <span class="hljs-attr">rollingUpdate:</span>
       <span class="hljs-attr">maxSurge:</span> <span class="hljs-number">1</span>        <span class="hljs-comment"># 更新时最大可超出副本数</span>
       <span class="hljs-attr">maxUnavailable:</span> <span class="hljs-number">1</span>  <span class="hljs-comment"># 更新时最大不可用副本数</span>
   <span class="hljs-attr">template:</span>
     <span class="hljs-attr">metadata:</span>
       <span class="hljs-attr">labels:</span>
         <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span>
     <span class="hljs-attr">spec:</span>
       <span class="hljs-attr">containers:</span>
       <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span>
         <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.19</span>
         <span class="hljs-attr">ports:</span>
         <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span>
         <span class="hljs-attr">resources:</span>
           <span class="hljs-attr">requests:</span>
             <span class="hljs-attr">memory:</span> <span class="hljs-string">"64Mi"</span>
             <span class="hljs-attr">cpu:</span> <span class="hljs-string">"250m"</span>
           <span class="hljs-attr">limits:</span>
             <span class="hljs-attr">memory:</span> <span class="hljs-string">"128Mi"</span>
             <span class="hljs-attr">cpu:</span> <span class="hljs-string">"500m"</span>
         <span class="hljs-attr">livenessProbe:</span>    <span class="hljs-comment">#配置存活性探针</span>
           <span class="hljs-attr">httpGet:</span>
             <span class="hljs-attr">path:</span> <span class="hljs-string">/</span>
             <span class="hljs-attr">port:</span> <span class="hljs-number">80</span>
           <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">30</span>
           <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span>
           
           
           
 <span class="hljs-comment">#操作          </span>
 <span class="hljs-comment"># 创建Deployment</span>
 <span class="hljs-string">kubectl</span> <span class="hljs-string">apply</span> <span class="hljs-string">-f</span> <span class="hljs-string">deployment.yaml</span>
 <span class="hljs-string">​</span>
 <span class="hljs-comment"># 查看滚动更新状态</span>
 <span class="hljs-string">kubectl</span> <span class="hljs-string">rollout</span> <span class="hljs-string">status</span> <span class="hljs-string">deployment/web-app</span>
 <span class="hljs-string">​</span>
 <span class="hljs-comment"># 执行滚动更新（镜像升级）</span>
 <span class="hljs-string">kubectl</span> <span class="hljs-string">set</span> <span class="hljs-string">image</span> <span class="hljs-string">deployment/web-app</span> <span class="hljs-string">nginx=nginx:1.20</span>
 <span class="hljs-string">​</span>
 <span class="hljs-comment"># 回滚到上一个版本</span>
 <span class="hljs-string">kubectl</span> <span class="hljs-string">rollout</span> <span class="hljs-string">undo</span> <span class="hljs-string">deployment/web-app</span>
 <span class="hljs-string">​</span>
 <span class="hljs-comment"># 查看更新历史</span>
 <span class="hljs-string">kubectl</span> <span class="hljs-string">rollout</span> <span class="hljs-string">history</span> <span class="hljs-string">deployment/web-app</span>
 <span class="hljs-string">​</span>
 <span class="hljs-comment"># 水平自动扩缩容</span>
 <span class="hljs-string">kubectl</span> <span class="hljs-string">autoscale</span> <span class="hljs-string">deployment</span> <span class="hljs-string">web-app</span> <span class="hljs-string">--min=2</span> <span class="hljs-string">--max=10</span> <span class="hljs-string">--cpu-percent=80</span>
</code></pre>
<h2 data-id="heading-11">DaemonSet控制器</h2>
<h3 data-id="heading-12">定位与作用</h3>
<p>DaemonSet确保每个节点（或满足条件的节点）上都运行一个指定的Pod副本。它适用于需要在每个节点上运行的系统级服务，如日志收集、监控代理等。</p>
<h3 data-id="heading-13">核心特性</h3>
<ul>
<li>确保每个节点（或满足条件的节点）运行一个Pod副本</li>
<li>节点加入集群时自动部署Pod</li>
<li>节点从集群移除时自动删除Pod</li>
</ul>
<h3 data-id="heading-14">示例</h3>
<pre><code class="hljs language-yaml" lang="yaml"> <span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
 <span class="hljs-attr">kind:</span> <span class="hljs-string">DaemonSet</span>
 <span class="hljs-attr">metadata:</span>
   <span class="hljs-attr">name:</span> <span class="hljs-string">filebeat</span>
   <span class="hljs-attr">labels:</span>
     <span class="hljs-attr">app:</span> <span class="hljs-string">filebeat</span>
 <span class="hljs-attr">spec:</span>
   <span class="hljs-attr">selector:</span>
     <span class="hljs-attr">matchLabels:</span>
       <span class="hljs-attr">name:</span> <span class="hljs-string">filebeat</span>
   <span class="hljs-attr">template:</span>
     <span class="hljs-attr">metadata:</span>
       <span class="hljs-attr">labels:</span>
         <span class="hljs-attr">app:</span> <span class="hljs-string">filebeat</span>
     <span class="hljs-attr">spec:</span>
       <span class="hljs-attr">tolerations:</span>  <span class="hljs-comment"># 允许在污点节点上运行</span>
       <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">node-role.kubernetes.io/master</span>
         <span class="hljs-attr">effect:</span> <span class="hljs-string">NoSchedule</span>   <span class="hljs-comment">#该节点不在接受新的Pod调度，但已经调度到该节点的Pod不会被驱逐。</span>
       <span class="hljs-attr">containers:</span>
       <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">filebeat</span>
         <span class="hljs-attr">image:</span> <span class="hljs-string">docker.elastic.co/beats/filebeat:8.13.4</span>
         <span class="hljs-attr">resources:</span>
           <span class="hljs-attr">limits:</span>
             <span class="hljs-attr">memory:</span> <span class="hljs-string">200Mi</span>
           <span class="hljs-attr">requests:</span>
             <span class="hljs-attr">cpu:</span> <span class="hljs-string">100m</span>
             <span class="hljs-attr">memory:</span> <span class="hljs-string">200Mi</span>
         <span class="hljs-attr">volumeMounts:</span>
         <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">varlog</span>
           <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/log</span>
         <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">varlibdockercontainers</span>
           <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/lib/docker/containers</span>
           <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">true</span>
       <span class="hljs-attr">terminationGracePeriodSeconds:</span> <span class="hljs-number">30</span>
       <span class="hljs-attr">volumes:</span>
       <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">varlog</span>
         <span class="hljs-attr">hostPath:</span>
           <span class="hljs-attr">path:</span> <span class="hljs-string">/var/log</span>
       <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">varlibdockercontainers</span>
         <span class="hljs-attr">hostPath:</span>
           <span class="hljs-attr">path:</span> <span class="hljs-string">/var/lib/docker/containers</span>
           
           
 <span class="hljs-comment">#terminationGracePeriodSeconds: 30</span>
 <span class="hljs-string">如果在优雅终止期内容器正常退出，那么Kubernetes会立即清理Pod。如果容器在优雅终止期结束后仍然没有退出，Kubernetes会发送SIGKILL信号强制杀死容器。</span>
 <span class="hljs-string">让容器有机会完成一些清理工作，比如保存状态、关闭网络连接等，从而优雅地停止，而不是被强制杀死。</span>    
 <span class="hljs-string">确保容器有足够的时间完成清理工作，避免数据丢失或服务异常中断。</span>
</code></pre>
<h2 data-id="heading-15">StatefulSet控制器</h2>
<h3 data-id="heading-16">定位与作用</h3>
<p>StatefulSet是Kubernetes中用于部署有状态应用的控制器。它为每个Pod提供稳定的唯一标识（如有序索引、固定网络标识）和持久化存储，适用于需要稳定拓扑和持久化存储的应用，如数据库、消息队列等。</p>
<h3 data-id="heading-17">核心特性</h3>
<ul>
<li>
<p>稳定的、唯一的网络标识符（pod-name.service-name）（稳定的 DNS 名称和主机名）</p>
<ul>
<li>
<p>其本质对应的是一个service资源，只不过这个service没有定义VIP，称之为headless service，即"无头服务"。</p>
</li>
<li>
<p>通过"headless service"来维护Pod的网络身份，会为每个Pod分配一个数字编号并且按照编号顺序部署。</p>
</li>
<li>
<p>无头服务（"headless service"）要求满足以下两点:</p>
<ul>
<li>将svc资源的clusterIP字段设置None，即"clusterIP: None"</li>
<li>将sts资源的serviceName字段声明为无头服务的名称</li>
</ul>
</li>
<li>
<p>稳定的DNS记录：每个Pod可以通过固定的DNS名称访问：...svc.cluster.local</p>
</li>
</ul>
</li>
<li>
<p>稳定独立且持久化的存储（PersistentVolume）</p>
<ul>
<li>
<p>Statefulset的存储卷使用VolumeClaimTemplate创建，称为"存储卷申请模板"。</p>
</li>
<li>
<p>当sts资源使用VolumeClaimTemplate创建一个PVC时，同样也会为每个Pod分配并创建唯一的pvc编号，每个pvc绑定对应pv，从而保证每个Pod都有独立的存储。</p>
</li>
<li>
<p>持久化存储原理</p>
<ul>
<li>当Pod使用持久化存储（如PersistentVolumeClaim，PVC）时，数据实际上是存储在一个独立的存储卷（PersistentVolume，PV）中。</li>
<li>Pod通过挂载（mount）的方式访问这个存储卷。</li>
<li>存储卷的生命周期与Pod是分离的。这意味着，删除Pod并不会自动删除存储卷。</li>
<li>在StatefulSet中，使用<code>volumeClaimTemplates</code>来为每个Pod动态创建PVC。</li>
<li>每个Pod都会获得自己独立的存储卷，这些存储卷会一直存在，直到手动删除PVC。</li>
<li>当Pod被重新创建（例如，由于节点故障或手动删除），StatefulSet控制器会确保新Pod挂载到同一个存储卷上，因此数据不会丢失。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>有序的、优雅的部署和扩缩</p>
</li>
<li>
<p>有序的、优雅的删除和终止</p>
</li>
</ul>
<h3 data-id="heading-18">示例</h3>
<ul>
<li>statefulset-headless-nginx.yaml</li>
</ul>
<pre><code class="hljs language-less" lang="less"> apiVersion: v1
 kind: Service
 metadata:
   name: svc-headless
 spec:
   ports:
   - port: 80
     name: web
   # 将clusterIP字段设置为<span class="hljs-attribute">None表示为一个无头服务，即svc将不会分配VIP。
   clusterIP</span>: None
   <span class="hljs-attribute">selector</span>:
     <span class="hljs-attribute">app</span>: nginx
 ​
 ​
 ---
 ​
 <span class="hljs-attribute">apiVersion</span>: apps/v1
 <span class="hljs-attribute">kind</span>: StatefulSet
 <span class="hljs-attribute">metadata</span>:
   <span class="hljs-attribute">name</span>: sts-nginx
 <span class="hljs-attribute">spec</span>:
   <span class="hljs-attribute">selector</span>:
     <span class="hljs-attribute">matchLabels</span>:
       <span class="hljs-attribute">app</span>: nginx
   # 声明无头服务    
   <span class="hljs-attribute">serviceName</span>: svc-headless
   <span class="hljs-attribute">replicas</span>: <span class="hljs-number">3</span> 
   <span class="hljs-attribute">template</span>:
     <span class="hljs-attribute">metadata</span>:
       <span class="hljs-attribute">labels</span>:
         <span class="hljs-attribute">app</span>: nginx
     <span class="hljs-attribute">spec</span>:
       <span class="hljs-attribute">containers</span>:
       - <span class="hljs-attribute">name</span>: nginx
         <span class="hljs-attribute">image</span>: <span class="hljs-attribute">nginx</span>:<span class="hljs-number">1.19</span>
         <span class="hljs-attribute">imagePullPolicy</span>: Always
         
         
         
         
         
 #测试输出
 [root<span class="hljs-variable">@master51</span>]# kubectl get sts,svc,po -o wide
 NAME                           READY   AGE   CONTAINERS   IMAGES
 statefulset.apps/sts-nginx   <span class="hljs-number">3</span>/<span class="hljs-number">3</span>     <span class="hljs-number">8s</span>    nginx        <span class="hljs-attribute">nginx</span>:<span class="hljs-number">1.19</span>
 ​
 NAME                   TYPE        CLUSTER-IP   EXTERNAL-IP   <span class="hljs-built_in">PORT</span>(S)   AGE   SELECTOR
 service/kubernetes     ClusterIP   <span class="hljs-number">10.200</span>.<span class="hljs-number">0.1</span>   &lt;none&gt;        <span class="hljs-number">443</span>/TCP   <span class="hljs-number">10</span>d   &lt;none&gt;
 service/svc-headless   ClusterIP   None         &lt;none&gt;        <span class="hljs-number">80</span>/TCP    <span class="hljs-number">8s</span>    app=nginx
 ​
 NAME                READY   STATUS    RESTARTS   AGE   IP               NODE        NOMINATED NODE   READINESS GATES
 pod/sts-nginx-<span class="hljs-number">0</span>   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">8s</span>    <span class="hljs-number">10.100</span>.<span class="hljs-number">203.186</span>   worker52   &lt;none&gt;           &lt;none&gt;
 pod/sts-nginx-<span class="hljs-number">1</span>   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">6s</span>    <span class="hljs-number">10.100</span>.<span class="hljs-number">140.87</span>    worker53   &lt;none&gt;           &lt;none&gt;
 pod/sts-nginx-<span class="hljs-number">2</span>   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">4s</span>    <span class="hljs-number">10.100</span>.<span class="hljs-number">160.134</span>   master51   &lt;none&gt;           &lt;none&gt;
 ​
 ​
</code></pre>
<ul>
<li>statefulset-headless-volumeClaimTemplates.yaml</li>
</ul>
<pre><code class="hljs language-less" lang="less"> apiVersion: v1
 kind: Service
 metadata:
   name: svc-headless
 spec:
   ports:
   - port: 80
     name: web
   clusterIP: <span class="hljs-attribute">None
   selector</span>:
     <span class="hljs-attribute">app</span>: nginx
 ---
 <span class="hljs-attribute">apiVersion</span>: apps/v1
 <span class="hljs-attribute">kind</span>: StatefulSet
 <span class="hljs-attribute">metadata</span>:
   <span class="hljs-attribute">name</span>: sts-nginx
 <span class="hljs-attribute">spec</span>:
   <span class="hljs-attribute">selector</span>:
     <span class="hljs-attribute">matchLabels</span>:
       <span class="hljs-attribute">app</span>: nginx
   <span class="hljs-attribute">serviceName</span>: svc-headless
   <span class="hljs-attribute">replicas</span>: <span class="hljs-number">3</span> 
   <span class="hljs-attribute">template</span>:
     <span class="hljs-attribute">metadata</span>:
       <span class="hljs-attribute">labels</span>:
         <span class="hljs-attribute">app</span>: nginx
     <span class="hljs-attribute">spec</span>:
       <span class="hljs-attribute">containers</span>:
       - <span class="hljs-attribute">name</span>: nginx
         <span class="hljs-attribute">image</span>: <span class="hljs-attribute">nginx</span>:<span class="hljs-number">1.19</span>
         <span class="hljs-attribute">ports</span>:
         - <span class="hljs-attribute">containerPort</span>: <span class="hljs-number">80</span>
           <span class="hljs-attribute">name</span>: nginx
         <span class="hljs-attribute">volumeMounts</span>:
         - <span class="hljs-attribute">name</span>: data
           <span class="hljs-attribute">mountPath</span>: /usr/share/nginx/html      
   # 卷声明模板，会为每个Pod去创建唯一的pvc并与之关联
   <span class="hljs-attribute">volumeClaimTemplates</span>:
   - <span class="hljs-attribute">metadata</span>:
       <span class="hljs-attribute">name</span>: data
     <span class="hljs-attribute">spec</span>:
       <span class="hljs-attribute">accessModes</span>: [ <span class="hljs-string">"ReadWriteOnce"</span> ]   # 单节点读写
       # 声明自定义的动态存储类，即sc资源。
       <span class="hljs-attribute">storageClassName</span>: <span class="hljs-string">"sc01"</span>
       <span class="hljs-attribute">resources</span>:
         <span class="hljs-attribute">requests</span>:
           <span class="hljs-attribute">storage</span>: <span class="hljs-number">2</span>Gi
 ---
 <span class="hljs-attribute">apiVersion</span>: v1
 <span class="hljs-attribute">kind</span>: Service
 <span class="hljs-attribute">metadata</span>:
   <span class="hljs-attribute">name</span>: svc-sts-nginx
 <span class="hljs-attribute">spec</span>:
   <span class="hljs-attribute">type</span>: ClusterIP
   <span class="hljs-attribute">clusterIP</span>: <span class="hljs-number">10.200</span>.<span class="hljs-number">0.200</span>
   <span class="hljs-attribute">selector</span>:
      <span class="hljs-attribute">app</span>: nginx
   <span class="hljs-attribute">ports</span>:
   - <span class="hljs-attribute">port</span>: <span class="hljs-number">80</span>
     <span class="hljs-attribute">targetPort</span>: nginx
 ​
 ​
 ​
 ​
 #测试与输出
 [root<span class="hljs-variable">@master51</span> statefulsets]# kubectl get sts,svc,po -o wide
 NAME                           READY   AGE   CONTAINERS   IMAGES
 statefulset.apps/sts-nginx   <span class="hljs-number">3</span>/<span class="hljs-number">3</span>     <span class="hljs-number">6s</span>    nginx        <span class="hljs-attribute">nginx</span>:<span class="hljs-number">1.19</span>
 ​
 NAME                      TYPE        CLUSTER-IP     EXTERNAL-IP   <span class="hljs-built_in">PORT</span>(S)   AGE   SELECTOR
 service/kubernetes        ClusterIP   <span class="hljs-number">10.200</span>.<span class="hljs-number">0.1</span>     &lt;none&gt;        <span class="hljs-number">443</span>/TCP   <span class="hljs-number">10</span>d   &lt;none&gt;
 service/svc-headless      ClusterIP   None           &lt;none&gt;        <span class="hljs-number">80</span>/TCP    <span class="hljs-number">6s</span>    app=nginx
 service/svc-sts-nginx     ClusterIP   <span class="hljs-number">10.200</span>.<span class="hljs-number">0.200</span>   &lt;none&gt;        <span class="hljs-number">80</span>/TCP    <span class="hljs-number">6s</span>    app=nginx
 ​
 NAME                READY   STATUS    RESTARTS   AGE   IP               NODE        NOMINATED NODE   READINESS GATES
 pod/sts-nginx-<span class="hljs-number">0</span>   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">6s</span>    <span class="hljs-number">10.100</span>.<span class="hljs-number">203.163</span>   worker52   &lt;none&gt;           &lt;none&gt;
 pod/sts-nginx-<span class="hljs-number">1</span>   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">5s</span>    <span class="hljs-number">10.100</span>.<span class="hljs-number">140.92</span>    worker53   &lt;none&gt;           &lt;none&gt;
 pod/sts-nginx-<span class="hljs-number">2</span>   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">3s</span>    <span class="hljs-number">10.100</span>.<span class="hljs-number">160.132</span>   master51   &lt;none&gt;           &lt;none&gt;
 ​
 ​
 ​
 #进入pod 中向nginx默认静态页面输入
 [root<span class="hljs-variable">@master51</span> statefulsets]# kubectl exec -it sts-xiuxian-<span class="hljs-number">0</span>  -- sh
 / # echo <span class="hljs-string">"shic zhen shuai"</span> &gt; /usr/share/nginx/html/index.html
 以此类推........
 ​
 [root<span class="hljs-variable">@master51</span> statefulsets]# for i in <span class="hljs-built_in">`seq 10`</span>; <span class="hljs-selector-tag">do</span> <span class="hljs-selector-tag">curl</span> <span class="hljs-number">10.200</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.200</span>; <span class="hljs-selector-tag">done</span>
 <span class="hljs-selector-tag">shic</span> <span class="hljs-selector-tag">zhen</span> <span class="hljs-selector-tag">niu</span>
 <span class="hljs-selector-tag">shic</span> <span class="hljs-selector-tag">zhen</span> <span class="hljs-selector-tag">meng</span>
 <span class="hljs-selector-tag">shic</span> <span class="hljs-selector-tag">zhen</span> <span class="hljs-selector-tag">shuai</span>
 <span class="hljs-selector-tag">shic</span> <span class="hljs-selector-tag">zhen</span> <span class="hljs-selector-tag">niu</span>
 <span class="hljs-selector-tag">shic</span> <span class="hljs-selector-tag">zhen</span> <span class="hljs-selector-tag">meng</span>
 <span class="hljs-selector-tag">shic</span> <span class="hljs-selector-tag">zhen</span> <span class="hljs-selector-tag">shuai</span>
 <span class="hljs-selector-tag">shic</span> <span class="hljs-selector-tag">zhen</span> <span class="hljs-selector-tag">niu</span>
 <span class="hljs-selector-tag">shic</span> <span class="hljs-selector-tag">zhen</span> <span class="hljs-selector-tag">meng</span>
 <span class="hljs-selector-tag">shic</span> <span class="hljs-selector-tag">zhen</span> <span class="hljs-selector-tag">shuai</span>
 <span class="hljs-selector-tag">shic</span> <span class="hljs-selector-tag">zhen</span> <span class="hljs-selector-tag">niu</span>
 ​
 <span class="hljs-selector-attr">[root@master51 statefulsets]</span># <span class="hljs-selector-tag">kubectl</span> <span class="hljs-selector-tag">delete</span> <span class="hljs-selector-tag">pods</span> <span class="hljs-selector-tag">--all</span>
 <span class="hljs-selector-tag">pod</span> "<span class="hljs-selector-tag">sts-nginx-0</span>" <span class="hljs-selector-tag">deleted</span>
 <span class="hljs-selector-tag">pod</span> "<span class="hljs-selector-tag">sts-nginx-1</span>" <span class="hljs-selector-tag">deleted</span>
 <span class="hljs-selector-tag">pod</span> "<span class="hljs-selector-tag">sts-nginx-2</span>" <span class="hljs-selector-tag">deleted</span>
 ​
 ​
 <span class="hljs-selector-attr">[root@master51 statefulsets]</span># <span class="hljs-selector-tag">kubectl</span> <span class="hljs-selector-tag">get</span> <span class="hljs-selector-tag">pods</span> <span class="hljs-selector-tag">-o</span> <span class="hljs-selector-tag">wide</span>
 <span class="hljs-selector-tag">NAME</span>            <span class="hljs-selector-tag">READY</span>   <span class="hljs-selector-tag">STATUS</span>    <span class="hljs-selector-tag">RESTARTS</span>   <span class="hljs-selector-tag">AGE</span>   <span class="hljs-selector-tag">IP</span>               <span class="hljs-selector-tag">NODE</span>        <span class="hljs-selector-tag">NOMINATED</span> <span class="hljs-selector-tag">NODE</span>   <span class="hljs-selector-tag">READINESS</span> <span class="hljs-selector-tag">GATES</span>
 <span class="hljs-selector-tag">sts-nginx-0</span>   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     <span class="hljs-selector-tag">Running</span>   <span class="hljs-number">0</span>          <span class="hljs-number">6s</span>    <span class="hljs-number">10.100</span><span class="hljs-selector-class">.203</span><span class="hljs-selector-class">.171</span>   <span class="hljs-selector-tag">worker52</span>   &lt;<span class="hljs-selector-tag">none</span>&gt;           &lt;<span class="hljs-selector-tag">none</span>&gt;
 <span class="hljs-selector-tag">sts-nginx-1</span>   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     <span class="hljs-selector-tag">Running</span>   <span class="hljs-number">0</span>          <span class="hljs-number">4s</span>    <span class="hljs-number">10.100</span><span class="hljs-selector-class">.140</span><span class="hljs-selector-class">.99</span>    <span class="hljs-selector-tag">worker53</span>   &lt;<span class="hljs-selector-tag">none</span>&gt;           &lt;<span class="hljs-selector-tag">none</span>&gt;
 <span class="hljs-selector-tag">sts-nginx-2</span>   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     <span class="hljs-selector-tag">Running</span>   <span class="hljs-number">0</span>          <span class="hljs-number">3s</span>    <span class="hljs-number">10.100</span><span class="hljs-selector-class">.160</span><span class="hljs-selector-class">.178</span>   <span class="hljs-selector-tag">master51</span>   &lt;<span class="hljs-selector-tag">none</span>&gt;           &lt;<span class="hljs-selector-tag">none</span>&gt;
 ​
 <span class="hljs-selector-attr">[root@master51 statefulsets]</span># <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">i</span> <span class="hljs-selector-tag">in</span> `<span class="hljs-selector-tag">seq</span> <span class="hljs-number">10</span>`; <span class="hljs-selector-tag">do</span> <span class="hljs-selector-tag">curl</span> <span class="hljs-number">10.200</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.200</span>; <span class="hljs-selector-tag">done</span>
 <span class="hljs-selector-tag">shic</span> <span class="hljs-selector-tag">zhen</span> <span class="hljs-selector-tag">niu</span>
 <span class="hljs-selector-tag">shic</span> <span class="hljs-selector-tag">zhen</span> <span class="hljs-selector-tag">meng</span>
 <span class="hljs-selector-tag">shic</span> <span class="hljs-selector-tag">zhen</span> <span class="hljs-selector-tag">shuai</span>
 <span class="hljs-selector-tag">shic</span> <span class="hljs-selector-tag">zhen</span> <span class="hljs-selector-tag">niu</span>
 <span class="hljs-selector-tag">shic</span> <span class="hljs-selector-tag">zhen</span> <span class="hljs-selector-tag">meng</span>
 <span class="hljs-selector-tag">shic</span> <span class="hljs-selector-tag">zhen</span> <span class="hljs-selector-tag">meng</span>
 <span class="hljs-selector-tag">shic</span> <span class="hljs-selector-tag">zhen</span> <span class="hljs-selector-tag">niu</span>
 <span class="hljs-selector-tag">shic</span> <span class="hljs-selector-tag">zhen</span> <span class="hljs-selector-tag">meng</span>
 <span class="hljs-selector-tag">shic</span> <span class="hljs-selector-tag">zhen</span> <span class="hljs-selector-tag">shuai</span>
 <span class="hljs-selector-tag">shic</span> <span class="hljs-selector-tag">zhen</span> <span class="hljs-selector-tag">niu</span>
 ​
 ​
 #验证后端存储
 <span class="hljs-selector-attr">[root@master51 statefulsets]</span># <span class="hljs-selector-tag">kubectl</span> <span class="hljs-selector-tag">get</span> <span class="hljs-selector-tag">pvc</span> <span class="hljs-selector-tag">-l</span> <span class="hljs-selector-tag">app</span>=<span class="hljs-selector-tag">nginx</span>  | <span class="hljs-selector-tag">awk</span> '<span class="hljs-selector-tag">NR</span>&gt;=<span class="hljs-number">2</span>{<span class="hljs-selector-tag">print</span> $<span class="hljs-number">3</span>}' | <span class="hljs-selector-tag">xargs</span> <span class="hljs-selector-tag">kubectl</span> <span class="hljs-selector-tag">describe</span> <span class="hljs-selector-tag">pv</span>  | <span class="hljs-selector-tag">grep</span> <span class="hljs-selector-tag">VolumeHandle</span>
     <span class="hljs-selector-tag">VolumeHandle</span>:      <span class="hljs-number">10.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.51</span><span class="hljs-selector-id">#data</span>/<span class="hljs-selector-tag">nfs-server</span>/<span class="hljs-selector-tag">sc01</span><span class="hljs-selector-id">#pvc-dafd74ce-50b0-475d-94e1-2a64512c62ed</span>##
     <span class="hljs-selector-tag">VolumeHandle</span>:      <span class="hljs-number">10.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.51</span><span class="hljs-selector-id">#data</span>/<span class="hljs-selector-tag">nfs-server</span>/<span class="hljs-selector-tag">sc01</span><span class="hljs-selector-id">#pvc-a10dcb52-cd54-4d14-b666-068238359f0e</span>##
     <span class="hljs-selector-tag">VolumeHandle</span>:      <span class="hljs-number">10.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.51</span><span class="hljs-selector-id">#data</span>/<span class="hljs-selector-tag">nfs-server</span>/<span class="hljs-selector-tag">sc01</span><span class="hljs-selector-id">#pvc-8c84e2d8-3da8-4ecb-8902-e11bd8bd33b0</span>##
 <span class="hljs-selector-attr">[root@master51 statefulsets]</span>#     
 <span class="hljs-selector-attr">[root@master51 statefulsets]</span># <span class="hljs-selector-tag">cat</span>  /<span class="hljs-selector-tag">data</span>/<span class="hljs-selector-tag">nfs-server</span>/<span class="hljs-selector-tag">sc01</span>/<span class="hljs-selector-tag">pvc-dafd74ce-50b0-475d-94e1-2a64512c62ed</span>/<span class="hljs-selector-tag">index</span><span class="hljs-selector-class">.html</span> 
 <span class="hljs-selector-tag">shic</span> <span class="hljs-selector-tag">zhen</span> <span class="hljs-selector-tag">shuai</span>
 <span class="hljs-selector-attr">[root@master51 statefulsets]</span># 
 <span class="hljs-selector-attr">[root@master51 statefulsets]</span># <span class="hljs-selector-tag">cat</span>  /<span class="hljs-selector-tag">data</span>/<span class="hljs-selector-tag">nfs-server</span>/<span class="hljs-selector-tag">sc01</span>/<span class="hljs-selector-tag">pvc-a10dcb52-cd54-4d14-b666-068238359f0e</span>/<span class="hljs-selector-tag">index</span><span class="hljs-selector-class">.html</span> 
 <span class="hljs-selector-tag">shic</span> <span class="hljs-selector-tag">zhen</span> <span class="hljs-selector-tag">meng</span>
 <span class="hljs-selector-attr">[root@master51 statefulsets]</span># 
 <span class="hljs-selector-attr">[root@master51 statefulsets]</span># <span class="hljs-selector-tag">cat</span>  /<span class="hljs-selector-tag">data</span>/<span class="hljs-selector-tag">nfs-server</span>/<span class="hljs-selector-tag">sc01</span>/<span class="hljs-selector-tag">pvc-8c84e2d8-3da8-4ecb-8902-e11bd8bd33b0</span>/<span class="hljs-selector-tag">index</span><span class="hljs-selector-class">.html</span> 
 <span class="hljs-selector-tag">shic</span> <span class="hljs-selector-tag">zhen</span> <span class="hljs-selector-tag">niu</span>
 <span class="hljs-selector-attr">[root@master51 statefulsets]</span># 
 ​
</code></pre>
<ul>
<li>statefuleset-updateStrategy.yaml</li>
</ul>
<pre><code class="hljs language-less" lang="less"> apiVersion: v1
 kind: Service
 metadata:
   name: sts-headless
 spec:
   ports:
   - port: 80
     name: web
   clusterIP: <span class="hljs-attribute">None
   selector</span>:
     <span class="hljs-attribute">app</span>: web
 ​
 ---
 ​
 <span class="hljs-attribute">apiVersion</span>: apps/v1
 <span class="hljs-attribute">kind</span>: StatefulSet
 <span class="hljs-attribute">metadata</span>:
   <span class="hljs-attribute">name</span>: sts-web
 <span class="hljs-attribute">spec</span>:
   # 指定sts资源的更新策略
   <span class="hljs-attribute">updateStrategy</span>:
     # 配置滚动更新
     <span class="hljs-attribute">rollingUpdate</span>:
       # 当编号小于<span class="hljs-number">3</span>时不更新，也是就是说Pod编号大于等于<span class="hljs-number">3</span>的Pod会被更新
       <span class="hljs-attribute">partition</span>: <span class="hljs-number">3</span>
   <span class="hljs-attribute">selector</span>:
     <span class="hljs-attribute">matchLabels</span>:
       <span class="hljs-attribute">app</span>: web
   <span class="hljs-attribute">serviceName</span>: sts-headless
   <span class="hljs-attribute">replicas</span>: <span class="hljs-number">5</span>
   <span class="hljs-attribute">template</span>:
     <span class="hljs-attribute">metadata</span>:
       <span class="hljs-attribute">labels</span>:
         <span class="hljs-attribute">app</span>: web
     <span class="hljs-attribute">spec</span>:
       <span class="hljs-attribute">containers</span>:
       - <span class="hljs-attribute">name</span>: c1
         <span class="hljs-attribute">ports</span>:
         - <span class="hljs-attribute">containerPort</span>: <span class="hljs-number">80</span>
           <span class="hljs-attribute">name</span>: nginx     
         <span class="hljs-attribute">image</span>: <span class="hljs-attribute">nginx</span>:<span class="hljs-number">1.19</span>
 ---
 <span class="hljs-attribute">apiVersion</span>: v1
 <span class="hljs-attribute">kind</span>: Service
 <span class="hljs-attribute">metadata</span>:
   <span class="hljs-attribute">name</span>: sts-svc
 <span class="hljs-attribute">spec</span>:
   <span class="hljs-attribute">selector</span>:
      <span class="hljs-attribute">app</span>: web
   <span class="hljs-attribute">ports</span>:
   - <span class="hljs-attribute">port</span>: <span class="hljs-number">80</span>
     <span class="hljs-attribute">targetPort</span>: nginx
 ​
 ​
 ​
 #测试验证
 [root<span class="hljs-variable">@master51</span> statefulsets]# kubectl get pods -o wide
 NAME                  READY   STATUS    RESTARTS   AGE   IP               NODE        NOMINATED NODE   READINESS GATES
 sts-web-<span class="hljs-number">0</span>   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">30s</span>   <span class="hljs-number">10.100</span>.<span class="hljs-number">203.183</span>   worker52   &lt;none&gt;           &lt;none&gt;
 sts-web-<span class="hljs-number">1</span>   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">28s</span>   <span class="hljs-number">10.100</span>.<span class="hljs-number">140.102</span>   worker53   &lt;none&gt;           &lt;none&gt;
 sts-web-<span class="hljs-number">2</span>   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">28s</span>   <span class="hljs-number">10.100</span>.<span class="hljs-number">160.180</span>   master51   &lt;none&gt;           &lt;none&gt;
 sts-web-<span class="hljs-number">3</span>   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">26s</span>   <span class="hljs-number">10.100</span>.<span class="hljs-number">203.185</span>   worker52   &lt;none&gt;           &lt;none&gt;
 sts-web-<span class="hljs-number">4</span>   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">25s</span>   <span class="hljs-number">10.100</span>.<span class="hljs-number">140.93</span>    worker53   &lt;none&gt;           &lt;none&gt;
 [root<span class="hljs-variable">@master51</span> statefulsets]# 
 [root<span class="hljs-variable">@master51</span> statefulsets]# kubectl get pods -l app=web -o yaml | grep <span class="hljs-string">"- image:"</span>
     - <span class="hljs-attribute">image</span>: <span class="hljs-attribute">nginx</span>:<span class="hljs-number">1.19</span>
     - <span class="hljs-attribute">image</span>: <span class="hljs-attribute">nginx</span>:<span class="hljs-number">1.19</span>
     - <span class="hljs-attribute">image</span>: <span class="hljs-attribute">nginx</span>:<span class="hljs-number">1.19</span>
     - <span class="hljs-attribute">image</span>: <span class="hljs-attribute">nginx</span>:<span class="hljs-number">1.19</span>
     - <span class="hljs-attribute">image</span>: <span class="hljs-attribute">nginx</span>:<span class="hljs-number">1.19</span>
 [root<span class="hljs-variable">@master51</span> statefulsets]# 
 [root<span class="hljs-variable">@master51</span> statefulsets]# 
 [root<span class="hljs-variable">@master51</span> statefulsets]# sed -i <span class="hljs-string">'/nginx/s#1.19#1.20#'</span> statefuleset-updateStrategy.yaml 
 [root<span class="hljs-variable">@master51</span> statefulsets]# 
 [root<span class="hljs-variable">@master51</span> statefulsets]# grep image statefuleset-updateStrategy.yaml 
         <span class="hljs-attribute">image</span>: <span class="hljs-attribute">nginx</span>:<span class="hljs-number">1.20</span>
 [root<span class="hljs-variable">@master51</span> statefulsets]# 
 [root<span class="hljs-variable">@master51</span> statefulsets]# kubectl apply -f statefuleset-updateStrategy.yaml
 service/sts-headless unchanged
 statefulset.apps/sts-web configured
 service/sts-svc unchanged
 [root<span class="hljs-variable">@master51</span> statefulsets]# 
 [root<span class="hljs-variable">@master51</span> statefulsets]# kubectl get pods -o wide
 NAME                  READY   STATUS    RESTARTS   AGE     IP               NODE        NOMINATED NODE   READINESS GATES
 sts-web-<span class="hljs-number">0</span>   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">2</span>m23s   <span class="hljs-number">10.100</span>.<span class="hljs-number">203.183</span>   worker52   &lt;none&gt;           &lt;none&gt;
 sts-web-<span class="hljs-number">1</span>   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">2</span>m21s   <span class="hljs-number">10.100</span>.<span class="hljs-number">140.102</span>   worker53   &lt;none&gt;           &lt;none&gt;
 sts-web-<span class="hljs-number">2</span>   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">2</span>m21s   <span class="hljs-number">10.100</span>.<span class="hljs-number">160.180</span>   master51   &lt;none&gt;           &lt;none&gt;
 sts-web-<span class="hljs-number">3</span>   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">12s</span>     <span class="hljs-number">10.100</span>.<span class="hljs-number">203.174</span>   worker52   &lt;none&gt;           &lt;none&gt;
 sts-web-<span class="hljs-number">4</span>   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">14s</span>     <span class="hljs-number">10.100</span>.<span class="hljs-number">140.101</span>   worker53   &lt;none&gt;           &lt;none&gt;
 [root<span class="hljs-variable">@master51</span> statefulsets]# 
 [root<span class="hljs-variable">@master51</span> statefulsets]# kubectl get pods -l app=web -o yaml | grep <span class="hljs-string">"- image:"</span>
     - <span class="hljs-attribute">image</span>: <span class="hljs-attribute">nginx</span>:<span class="hljs-number">1.19</span>
     - <span class="hljs-attribute">image</span>: <span class="hljs-attribute">nginx</span>:<span class="hljs-number">1.19</span>
     - <span class="hljs-attribute">image</span>: <span class="hljs-attribute">nginx</span>:<span class="hljs-number">1.19</span>
     - <span class="hljs-attribute">image</span>: <span class="hljs-attribute">nginx</span>:<span class="hljs-number">1.20</span>
     - <span class="hljs-attribute">image</span>: <span class="hljs-attribute">nginx</span>:<span class="hljs-number">1.20</span>
 [root<span class="hljs-variable">@master51</span> statefulsets]# 
</code></pre>
<h2 data-id="heading-19">Job/CronJob控制器</h2>
<h3 data-id="heading-20">定位与作用</h3>
<p>Job用于运行一次性任务，确保任务成功完成。CronJob基于时间调度，周期性地运行Job，适用于定时任务和批处理作业。</p>
<h3 data-id="heading-21">核心特性</h3>
<ul>
<li>
<p>Job</p>
<ul>
<li>确保指定数量的Pod成功完成任务后退出</li>
<li>支持并行执行和顺序控制的任务处理</li>
<li>提供任务失败重试和超时管理机制</li>
</ul>
</li>
<li>
<p>CronJob</p>
<ul>
<li>基于时间表（Cron表达式）周期性地创建Job</li>
<li>确保定时任务按计划自动执行</li>
<li>提供任务并发策略和历史记录管理</li>
</ul>
</li>
</ul>
<h3 data-id="heading-22">示例</h3>
<pre><code class="hljs language-yaml" lang="yaml"> <span class="hljs-comment"># Job示例</span>
 <span class="hljs-attr">apiVersion:</span> <span class="hljs-string">batch/v1</span>
 <span class="hljs-attr">kind:</span> <span class="hljs-string">Job</span>
 <span class="hljs-attr">metadata:</span>
   <span class="hljs-attr">name:</span> <span class="hljs-string">data-processor</span>
 <span class="hljs-attr">spec:</span>
   <span class="hljs-attr">completions:</span> <span class="hljs-number">5</span>     <span class="hljs-comment"># 需要完成的Pod数量。默认为1，当成功完成的Pod数量达到completions时，Job才算完成。</span>
   <span class="hljs-attr">parallelism:</span> <span class="hljs-number">2</span>     <span class="hljs-comment"># 并行执行的Pod数量。控制Job的并行度，以避免同时启动太多Pod造成资源过载。</span>
   <span class="hljs-attr">backoffLimit:</span> <span class="hljs-number">3</span>    <span class="hljs-comment"># 任务异常失败重试次数,重试也是重新创建新的Pod,如果不指定，默认次数是6.</span>
   <span class="hljs-attr">template:</span>
     <span class="hljs-attr">spec:</span>
       <span class="hljs-attr">containers:</span>
       <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">processor</span>
         <span class="hljs-attr">image:</span> <span class="hljs-string">data-processor:latest</span>
         <span class="hljs-attr">command:</span> [<span class="hljs-string">"python"</span>, <span class="hljs-string">"/app/process.py"</span>]
         <span class="hljs-attr">resources:</span>
           <span class="hljs-attr">requests:</span>
             <span class="hljs-attr">memory:</span> <span class="hljs-string">"64Mi"</span>
             <span class="hljs-attr">cpu:</span> <span class="hljs-string">"250m"</span>
       <span class="hljs-attr">restartPolicy:</span> <span class="hljs-string">Never</span>  <span class="hljs-comment"># Job不能使用Always</span>
 <span class="hljs-string">​</span>
 <span class="hljs-string">---</span>
 <span class="hljs-comment"># CronJob示例</span>
 <span class="hljs-attr">apiVersion:</span> <span class="hljs-string">batch/v1</span>
 <span class="hljs-attr">kind:</span> <span class="hljs-string">CronJob</span>
 <span class="hljs-attr">metadata:</span>
   <span class="hljs-attr">name:</span> <span class="hljs-string">daily-report</span>
 <span class="hljs-attr">spec:</span>
   <span class="hljs-attr">schedule:</span> <span class="hljs-string">"0 2 * * *"</span>  <span class="hljs-comment"># 每天凌晨2点执行</span>
   <span class="hljs-attr">startingDeadlineSeconds:</span> <span class="hljs-number">600</span>
   <span class="hljs-attr">concurrencyPolicy:</span> <span class="hljs-string">Forbid</span>  <span class="hljs-comment"># 禁止并发执行</span>
   <span class="hljs-attr">jobTemplate:</span>
     <span class="hljs-attr">spec:</span>
       <span class="hljs-attr">template:</span>
         <span class="hljs-attr">spec:</span>
           <span class="hljs-attr">containers:</span>
           <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">report-generator</span>
             <span class="hljs-attr">image:</span> <span class="hljs-string">report-tool:latest</span>
             <span class="hljs-attr">command:</span> [<span class="hljs-string">"python"</span>, <span class="hljs-string">"/app/generate_report.py"</span>]
           <span class="hljs-attr">restartPolicy:</span> <span class="hljs-string">OnFailure</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React基础框架搭建8-axios封装与未封装，实现 API 请求管理：react+router+redux+axios+Tailwind+webpack]]></title>    <link>https://juejin.cn/post/7592119218030215202</link>    <guid>https://juejin.cn/post/7592119218030215202</guid>    <pubDate>2026-01-07T01:27:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592119218030215202" data-draft-id="7592089325913178112" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React基础框架搭建8-axios封装与未封装，实现 API 请求管理：react+router+redux+axios+Tailwind+webpack"/> <meta itemprop="keywords" content="React.js,前端框架,前端工程化"/> <meta itemprop="datePublished" content="2026-01-07T01:27:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Eadia"/> <meta itemprop="url" content="https://juejin.cn/user/1591748565671614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React基础框架搭建8-axios封装与未封装，实现 API 请求管理：react+router+redux+axios+Tailwind+webpack
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1591748565671614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Eadia
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T01:27:51.000Z" title="Wed Jan 07 2026 01:27:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>npm install axios</code></p>
<p>一、api基础使用（未封装）</p>
<p>1、在 src/api/ 目录下创建一个新的文件 productService.js，用于管理所有的 API 请求。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;

<span class="hljs-comment">// 设置基础 URL</span>
<span class="hljs-keyword">const</span> apiClient = axios.<span class="hljs-title function_">create</span>({
    <span class="hljs-attr">baseURL</span>: <span class="hljs-string">'/'</span>, <span class="hljs-comment">// 使用相对路径来访问 public 目录中的文件</span>
    <span class="hljs-attr">headers</span>: {
        <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
    },
});

<span class="hljs-comment">// 获取产品列表</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchProducts</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> apiClient.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/product.json'</span>); <span class="hljs-comment">// 从 public 目录获取 JSON 文件</span>
    <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>.<span class="hljs-property">products</span>; <span class="hljs-comment">// 返回数据</span>
};

<span class="hljs-comment">// 添加新产品（模拟）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">createProduct</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">product</span>) =&gt; {
    <span class="hljs-keyword">return</span> product; <span class="hljs-comment">// 直接返回新产品</span>
};

<span class="hljs-comment">// 删除产品（模拟）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">deleteProduct</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">id</span>) =&gt; {
    <span class="hljs-keyword">return</span> id; <span class="hljs-comment">// 返回删除的产品 ID</span>
};
</code></pre>
<p>更新 Redux Slice</p>
<p>在 productSlice.js 中，可以添加异步操作来处理 API 请求。使用 Redux Toolkit 的 createAsyncThunk 来创建异步操作。</p>
<p>更改producSlice.js</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">//src/features/Produc/producSlice.js</span>

<span class="hljs-keyword">import</span> { createSlice, createAsyncThunk } <span class="hljs-keyword">from</span> <span class="hljs-string">'@reduxjs/toolkit'</span>;
<span class="hljs-keyword">import</span> { fetchProducts, createProduct, deleteProduct } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../api/api'</span>; <span class="hljs-comment">// 引入 API 请求</span>

<span class="hljs-comment">// 异步获取产品列表</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> fetchProductsAsync = <span class="hljs-title function_">createAsyncThunk</span>(<span class="hljs-string">'product/fetchProducts'</span>, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchProducts</span>(); <span class="hljs-comment">// 调用 API 获取产品</span>
    <span class="hljs-keyword">return</span> response; <span class="hljs-comment">// 返回产品数据</span>
});

<span class="hljs-comment">// 异步添加新产品</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> addProductAsync = <span class="hljs-title function_">createAsyncThunk</span>(<span class="hljs-string">'product/addProduct'</span>, <span class="hljs-keyword">async</span> (product) =&gt; {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">createProduct</span>(product);
    <span class="hljs-keyword">return</span> response; <span class="hljs-comment">// 返回新产品</span>
});

<span class="hljs-comment">// 异步删除产品</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> removeProductAsync = <span class="hljs-title function_">createAsyncThunk</span>(<span class="hljs-string">'product/removeProduct'</span>, <span class="hljs-keyword">async</span> (id) =&gt; {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">deleteProduct</span>(id);
    <span class="hljs-keyword">return</span> id; <span class="hljs-comment">// 返回删除的产品 ID</span>
});

<span class="hljs-keyword">const</span> productSlice = <span class="hljs-title function_">createSlice</span>({
    <span class="hljs-attr">name</span>: <span class="hljs-string">'product'</span>,
    <span class="hljs-attr">initialState</span>: {
        <span class="hljs-attr">products</span>: [], <span class="hljs-comment">// 初始为空</span>
        <span class="hljs-attr">status</span>: <span class="hljs-string">'idle'</span>, <span class="hljs-comment">// 状态管理</span>
    },
    <span class="hljs-attr">reducers</span>: {},
    <span class="hljs-attr">extraReducers</span>: <span class="hljs-function">(<span class="hljs-params">builder</span>) =&gt;</span> {
        builder
            .<span class="hljs-title function_">addCase</span>(fetchProductsAsync.<span class="hljs-property">fulfilled</span>, <span class="hljs-function">(<span class="hljs-params">state, action</span>) =&gt;</span> {
                state.<span class="hljs-property">products</span> = action.<span class="hljs-property">payload</span>; <span class="hljs-comment">// 设置产品列表</span>
            })
            .<span class="hljs-title function_">addCase</span>(addProductAsync.<span class="hljs-property">fulfilled</span>, <span class="hljs-function">(<span class="hljs-params">state, action</span>) =&gt;</span> {
                state.<span class="hljs-property">products</span>.<span class="hljs-title function_">push</span>(action.<span class="hljs-property">payload</span>); <span class="hljs-comment">// 添加新产品</span>
            })
            .<span class="hljs-title function_">addCase</span>(removeProductAsync.<span class="hljs-property">fulfilled</span>, <span class="hljs-function">(<span class="hljs-params">state, action</span>) =&gt;</span> {
                state.<span class="hljs-property">products</span> = state.<span class="hljs-property">products</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">product</span> =&gt;</span> product.<span class="hljs-property">id</span> !== action.<span class="hljs-property">payload</span>); <span class="hljs-comment">// 根据 ID 移除产品</span>
            });
    },
});

<span class="hljs-comment">// 导出 reducer</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> productSlice.<span class="hljs-property">reducer</span>;
</code></pre>
<p>更新组件以使用 API</p>
<p>在 ProductList.jsx 和 FeedbackForm.jsx 中，您需要使用这些异步操作来获取和添加产品。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/views/Product/ProductList.jsx </span>

<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { useSelector, useDispatch } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-redux'</span>;
<span class="hljs-keyword">import</span> { fetchProductsAsync, removeProductAsync } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../features/Product/productSlice'</span>;


<span class="hljs-keyword">const</span> <span class="hljs-title function_">ProductList</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> products = <span class="hljs-title function_">useSelector</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">product</span>.<span class="hljs-property">products</span>);
    <span class="hljs-keyword">const</span> dispatch = <span class="hljs-title function_">useDispatch</span>();

    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">dispatch</span>(<span class="hljs-title function_">fetchProductsAsync</span>()); <span class="hljs-comment">// 获取产品列表</span>
    }, [dispatch]);

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleRemoveProduct</span> = (<span class="hljs-params">id</span>) =&gt; {
        <span class="hljs-title function_">dispatch</span>(<span class="hljs-title function_">removeProductAsync</span>(id)); <span class="hljs-comment">// 删除</span>
    };

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"mt-10"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"font-semibold"</span>&gt;</span>产品列表<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"list-disc pl-5"</span>&gt;</span>
                {products.length &gt; 0 ? (
                    products.map(product =&gt; (
                        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{product.id}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"mb-1 flex justify-between items-center"</span>&gt;</span>
                            {product.name}
                            <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
                                <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> handleRemoveProduct(product.id)}
                                className="ml-4 text-red-500 hover:text-red-700"
                            &gt;
                                删除
                            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                    ))
                ) : (
                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>没有产品可显示<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                )}
            <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">ProductList</span>;
</code></pre>
<p>二、封装api</p>
<p>1、在 src/api/ 目录下创建一个新的文件api.js</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;

<span class="hljs-comment">// 创建 Axios 实例</span>
<span class="hljs-keyword">const</span> apiClient = axios.<span class="hljs-title function_">create</span>({
    <span class="hljs-attr">baseURL</span>: <span class="hljs-string">'http://localhost:3000'</span>, <span class="hljs-comment">// 使用 json-server 的基础路径</span>
    <span class="hljs-attr">timeout</span>: <span class="hljs-number">10000</span>, <span class="hljs-comment">// 超时时间</span>
    <span class="hljs-attr">headers</span>: {
        <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
    },
});

<span class="hljs-comment">// 请求拦截器</span>
apiClient.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(
    <span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> {
        <span class="hljs-comment">// 在请求发送之前做些什么，例如添加 token</span>
        <span class="hljs-keyword">const</span> token = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'token'</span>); <span class="hljs-comment">// 假设 token 存储在 localStorage</span>

        <span class="hljs-comment">// 检查请求的 URL 是否需要 token</span>
        <span class="hljs-keyword">const</span> noAuthRequired = [<span class="hljs-string">'/login'</span>, <span class="hljs-string">'/register'</span>]; <span class="hljs-comment">// 不需要 token 的请求列表</span>

        <span class="hljs-keyword">if</span> (token &amp;&amp; !noAuthRequired.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">url</span> =&gt;</span> config.<span class="hljs-property">url</span>.<span class="hljs-title function_">startsWith</span>(url))) {
            config.<span class="hljs-property">headers</span>[<span class="hljs-string">'Authorization'</span>] = <span class="hljs-string">`Bearer <span class="hljs-subst">${token}</span>`</span>; <span class="hljs-comment">// 添加 token</span>
        }
        <span class="hljs-keyword">return</span> config;
    },
    <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
        <span class="hljs-comment">// 处理请求错误</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);
    }
);

<span class="hljs-comment">// 响应拦截器</span>
apiClient.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(
    <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {
        <span class="hljs-comment">// 统一处理返回数据</span>
        <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>; <span class="hljs-comment">// 直接返回数据</span>
    },
    <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
        <span class="hljs-comment">// 处理错误</span>
        <span class="hljs-keyword">const</span> { response } = error;
        <span class="hljs-keyword">if</span> (response) {
            <span class="hljs-comment">// 根据 HTTP 状态码处理不同的错误</span>
            <span class="hljs-keyword">switch</span> (response.<span class="hljs-property">status</span>) {
                <span class="hljs-keyword">case</span> <span class="hljs-number">401</span>:
                    <span class="hljs-title function_">alert</span>(<span class="hljs-string">'未授权，请登录！'</span>);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-number">404</span>:
                    <span class="hljs-title function_">alert</span>(<span class="hljs-string">'请求的资源未找到！'</span>);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-number">500</span>:
                    <span class="hljs-title function_">alert</span>(<span class="hljs-string">'服务器错误，请稍后再试！'</span>);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-attr">default</span>:
                    <span class="hljs-title function_">alert</span>(<span class="hljs-string">'发生错误，请重试！'</span>);
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-title function_">alert</span>(<span class="hljs-string">'网络错误，请检查您的网络连接！'</span>);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);
    }
);

<span class="hljs-comment">// 封装请求方法</span>
<span class="hljs-keyword">const</span> api = {
    <span class="hljs-attr">get</span>: <span class="hljs-function">(<span class="hljs-params">url, params</span>) =&gt;</span> apiClient.<span class="hljs-title function_">get</span>(url, { params }),
    <span class="hljs-attr">post</span>: <span class="hljs-function">(<span class="hljs-params">url, data</span>) =&gt;</span> apiClient.<span class="hljs-title function_">post</span>(url, data),
    <span class="hljs-attr">put</span>: <span class="hljs-function">(<span class="hljs-params">url, data</span>) =&gt;</span> apiClient.<span class="hljs-title function_">put</span>(url, data),
    <span class="hljs-attr">delete</span>: <span class="hljs-function">(<span class="hljs-params">url</span>) =&gt;</span> apiClient.<span class="hljs-title function_">delete</span>(url),
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> api;
</code></pre>
<p>使用：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 异步获取产品列表</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> fetchProductsAsync = createAsyncThunk(<span class="hljs-string">'product/fetchProducts'</span>, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> api.<span class="hljs-keyword">get</span>(<span class="hljs-string">'/products'</span>); <span class="hljs-comment">// 使用封装的 GET 方法</span>
    <span class="hljs-keyword">return</span> response; <span class="hljs-comment">// 返回产品数据</span>
});

<span class="hljs-comment">// 异步添加新产品</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> addProductAsync = createAsyncThunk(<span class="hljs-string">'product/addProduct'</span>, <span class="hljs-keyword">async</span> (product) =&gt; {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> api.post(<span class="hljs-string">'/products'</span>, product); <span class="hljs-comment">// 使用封装的 POST 方法</span>
    <span class="hljs-keyword">return</span> response; <span class="hljs-comment">// 返回新产品</span>
});

<span class="hljs-comment">// 异步删除产品</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> removeProductAsync = createAsyncThunk(<span class="hljs-string">'product/removeProduct'</span>, <span class="hljs-keyword">async</span> (id) =&gt; {
    <span class="hljs-keyword">await</span> api.delete(`/products/${id}`); <span class="hljs-comment">// 使用封装的 DELETE 方法</span>
    <span class="hljs-keyword">return</span> id; <span class="hljs-comment">// 返回删除的产品 ID</span>
});
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SSE Connect 数据解析详解]]></title>    <link>https://juejin.cn/post/7592059801884803115</link>    <guid>https://juejin.cn/post/7592059801884803115</guid>    <pubDate>2026-01-06T19:45:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592059801884803115" data-draft-id="7592088192516292651" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SSE  Connect 数据解析详解"/> <meta itemprop="keywords" content="iOS"/> <meta itemprop="datePublished" content="2026-01-06T19:45:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="发量超多的女程序媛"/> <meta itemprop="url" content="https://juejin.cn/user/817692381560461"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SSE  Connect 数据解析详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/817692381560461/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    发量超多的女程序媛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T19:45:37.000Z" title="Tue Jan 06 2026 19:45:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p><strong>SSE（Server-Sent Events）</strong> 是一种基于 HTTP 的服务器单向推送技术。相比 WebSocket 的双向通信，SSE 更轻量、实现更简单，非常适合服务器向客户端持续推送数据的场景。ChatGPT、Claude 等 AI 产品都使用 SSE 来实现流式输出。</p>
<p>本文以 iOS 客户端实现为例，详细讲解 SSE 数据的接收与解析过程。</p>
<hr/>
<h2 data-id="heading-1">一、完整示例：一个 SSE 事件从发送到接收的全过程</h2>
<h3 data-id="heading-2">服务器发送的数据</h3>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">event:</span> chunk
<span class="hljs-symbol">id:</span> <span class="hljs-number">1</span>
<span class="hljs-symbol">data:</span> {<span class="hljs-string">"content"</span>:<span class="hljs-string">"Hello"</span>}

</code></pre>
<blockquote>
<p>⚠️ 注意：最后有一个<strong>空行</strong>，这是事件结束的标志！</p>
</blockquote>
<hr/>
<h2 data-id="heading-3">第一步：服务器发送，网络传输</h2>
<p>服务器发送的原始字节流：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">e</span> <span class="hljs-selector-tag">v</span> <span class="hljs-selector-tag">e</span> <span class="hljs-selector-tag">n</span> <span class="hljs-selector-tag">t</span> :   <span class="hljs-selector-tag">c</span> <span class="hljs-selector-tag">h</span> <span class="hljs-selector-tag">u</span> <span class="hljs-selector-tag">n</span> <span class="hljs-selector-tag">k</span> \<span class="hljs-selector-tag">n</span> <span class="hljs-selector-tag">i</span> <span class="hljs-selector-tag">d</span> :   <span class="hljs-number">1</span> \<span class="hljs-selector-tag">n</span> <span class="hljs-selector-tag">d</span> <span class="hljs-selector-tag">a</span> <span class="hljs-selector-tag">t</span> <span class="hljs-selector-tag">a</span> :   { . . . } \<span class="hljs-selector-tag">n</span> \<span class="hljs-selector-tag">n</span>
</code></pre>
<p><strong>问题</strong>：网络传输时，数据可能被分成多个块到达客户端。</p>
<p>假设网络把数据分成了 3 块：</p>





















<table><thead><tr><th>数据块</th><th>内容</th></tr></thead><tbody><tr><td>块 1</td><td><code>"event: chu"</code></td></tr><tr><td>块 2</td><td><code>"nk\nid: 1\nda"</code></td></tr><tr><td>块 3</td><td><code>"ta: {\"content\":\"Hello\"}\n\n"</code></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-4">第二步：行解析器处理（OKGrowthUTF8LineParser）</h2>
<h3 data-id="heading-5">2.1 收到块 1：<code>"event: chu"</code></h3>
<pre><code class="hljs language-arduino" lang="arduino">┌────────────────────────────────────────────────────────────┐
│ 输入: <span class="hljs-string">"event: chu"</span>                                         │
│                                                            │
│ 处理过程:                                                   │
│   <span class="hljs-number">1.</span> 缓冲区当前为空: <span class="hljs-string">""</span>                                     │
│   <span class="hljs-number">2.</span> 合并: <span class="hljs-string">""</span> + <span class="hljs-string">"event: chu"</span> = <span class="hljs-string">"event: chu"</span>                │
│   <span class="hljs-number">3.</span> 扫描换行符: 没找到 \n                                  │
│   <span class="hljs-number">4.</span> 没有完整行，全部存入缓冲区                              │
│                                                            │
│ 缓冲区: <span class="hljs-string">"event: chu"</span>                                       │
│ 输出: []  ← 空数组，没有完整行                              │
└────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-6">2.2 收到块 2：<code>"nk\nid: 1\nda"</code></h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-operator">┌────────────────────────────────────────────────────────────┐</span>
<span class="hljs-operator">│</span> 输入: <span class="hljs-string">"nk<span class="hljs-subst">\n</span>id: 1<span class="hljs-subst">\n</span>da"</span>                                      <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>                                                            <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span> 处理过程:                                                   <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>   <span class="hljs-number">1</span>. 缓冲区当前: <span class="hljs-string">"event: chu"</span>                               <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>   <span class="hljs-number">2</span>. 合并: <span class="hljs-string">"event: chu"</span> <span class="hljs-operator">+</span> <span class="hljs-string">"nk<span class="hljs-subst">\n</span>id: 1<span class="hljs-subst">\n</span>da"</span>                  <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>         <span class="hljs-operator">=</span> <span class="hljs-string">"event: chunk<span class="hljs-subst">\n</span>id: 1<span class="hljs-subst">\n</span>da"</span>                        <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>   <span class="hljs-number">3</span>. 扫描换行符:                                            <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>      <span class="hljs-operator">-</span> 位置 <span class="hljs-number">12</span> 找到 \n <span class="hljs-operator">→</span> 提取 <span class="hljs-string">"event: chunk"</span>               <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>      <span class="hljs-operator">-</span> 位置 <span class="hljs-number">18</span> 找到 \n <span class="hljs-operator">→</span> 提取 <span class="hljs-string">"id: 1"</span>                      <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>      <span class="hljs-operator">-</span> <span class="hljs-string">"da"</span> 后面没有 \n，存入缓冲区                         <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>                                                            <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span> 缓冲区: <span class="hljs-string">"da"</span>                                               <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span> 输出: [<span class="hljs-string">"event: chunk"</span>, <span class="hljs-string">"id: 1"</span>]                            <span class="hljs-operator">│</span>
<span class="hljs-operator">└────────────────────────────────────────────────────────────┘</span>
</code></pre>
<h3 data-id="heading-7">2.3 收到块 3：<code>"ta: {\"content\":\"Hello\"}\n\n"</code></h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-operator">┌────────────────────────────────────────────────────────────┐</span>
<span class="hljs-operator">│</span> 输入: <span class="hljs-string">"ta: {<span class="hljs-subst">\"</span>content<span class="hljs-subst">\"</span>:<span class="hljs-subst">\"</span>Hello<span class="hljs-subst">\"</span>}<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>"</span>                    <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>                                                            <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span> 处理过程:                                                   <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>   <span class="hljs-number">1</span>. 缓冲区当前: <span class="hljs-string">"da"</span>                                       <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>   <span class="hljs-number">2</span>. 合并: <span class="hljs-string">"da"</span> <span class="hljs-operator">+</span> <span class="hljs-string">"ta: {...}<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>"</span>                          <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>         <span class="hljs-operator">=</span> <span class="hljs-string">"data: {<span class="hljs-subst">\"</span>content<span class="hljs-subst">\"</span>:<span class="hljs-subst">\"</span>Hello<span class="hljs-subst">\"</span>}<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>"</span>              <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>   <span class="hljs-number">3</span>. 扫描换行符:                                            <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>      <span class="hljs-operator">-</span> 位置 <span class="hljs-number">27</span> 找到 \n <span class="hljs-operator">→</span> 提取 <span class="hljs-string">"data: {...}"</span>                <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>      <span class="hljs-operator">-</span> 位置 <span class="hljs-number">28</span> 找到 \n <span class="hljs-operator">→</span> 提取 <span class="hljs-string">""</span>  <span class="hljs-operator">←</span> 空行！                  <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>                                                            <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span> 缓冲区: <span class="hljs-string">""</span>  <span class="hljs-operator">←</span> 清空                                         <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span> 输出: [<span class="hljs-string">"data: {<span class="hljs-subst">\"</span>content<span class="hljs-subst">\"</span>:<span class="hljs-subst">\"</span>Hello<span class="hljs-subst">\"</span>}"</span>, <span class="hljs-string">""</span>]                <span class="hljs-operator">│</span>
<span class="hljs-operator">└────────────────────────────────────────────────────────────┘</span>
</code></pre>
<h3 data-id="heading-8">2.4 行解析器总结</h3>
<p>经过 3 次数据块处理，行解析器依次输出：</p>





















<table><thead><tr><th>次序</th><th>输出的完整行</th></tr></thead><tbody><tr><td>块 1 后</td><td><code>[]</code> (无)</td></tr><tr><td>块 2 后</td><td><code>["event: chunk", "id: 1"]</code></td></tr><tr><td>块 3 后</td><td><code>["data: {...}", ""]</code></td></tr></tbody></table>
<p><strong>合计得到 4 行</strong>: <code>"event: chunk"</code>, <code>"id: 1"</code>, <code>"data: {...}"</code>, <code>""</code></p>
<hr/>
<h2 data-id="heading-9">第三步：事件解析器处理（OKGrowthEventParser）</h2>
<p>SSEClient 将行解析器输出的每一行，依次传给事件解析器。</p>
<h3 data-id="heading-10">3.1 解析第 1 行：<code>"event: chunk"</code></h3>
<pre><code class="hljs language-ini" lang="ini">┌────────────────────────────────────────────────────────────┐
│ 输入: "event: chunk"                                       │
│                                                            │
│ 处理过程:                                                   │
│   1. 行长度 &gt; 0，不是空行                                   │
│   2. 查找冒号位置: 5                                        │
│   3. 字段名 = "event"                                      │
│   4. 字段值 = "chunk" (冒号后面，跳过空格)                   │
│   5. 字段名是 "event"，存储 eventType                       │
│                                                            │
│ 当前状态:                                                   │
│   <span class="hljs-attr">eventType</span> = <span class="hljs-string">"chunk"</span>  ✓                                   │
│   <span class="hljs-attr">eventId</span>   = <span class="hljs-string">""</span>                                           │
│   <span class="hljs-attr">data</span>      = <span class="hljs-string">""</span>                                           │
│                                                            │
│ 动作: 继续等待下一行                                        │
└────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-11">3.2 解析第 2 行：<code>"id: 1"</code></h3>
<pre><code class="hljs language-ini" lang="ini">┌────────────────────────────────────────────────────────────┐
│ 输入: "id: 1"                                              │
│                                                            │
│ 处理过程:                                                   │
│   1. 行长度 &gt; 0，不是空行                                   │
│   2. 查找冒号位置: 2                                        │
│   3. 字段名 = "id"                                         │
│   4. 字段值 = "1"                                          │
│   5. 字段名是 "id"，存储 eventId                            │
│                                                            │
│ 当前状态:                                                   │
│   <span class="hljs-attr">eventType</span> = <span class="hljs-string">"chunk"</span>  ✓                                   │
│   <span class="hljs-attr">eventId</span>   = <span class="hljs-string">"1"</span>      ✓                                   │
│   <span class="hljs-attr">data</span>      = <span class="hljs-string">""</span>                                           │
│                                                            │
│ 动作: 继续等待下一行                                        │
└────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-12">3.3 解析第 3 行：<code>"data: {\"content\":\"Hello\"}"</code></h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-operator">┌────────────────────────────────────────────────────────────┐</span>
<span class="hljs-operator">│</span> 输入: <span class="hljs-string">"data: {<span class="hljs-subst">\"</span>content<span class="hljs-subst">\"</span>:<span class="hljs-subst">\"</span>Hello<span class="hljs-subst">\"</span>}"</span>                      <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>                                                            <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span> 处理过程:                                                   <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>   <span class="hljs-number">1</span>. 行长度 <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span>，不是空行                                   <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>   <span class="hljs-number">2</span>. 查找冒号位置: <span class="hljs-number">4</span>                                        <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>   <span class="hljs-number">3</span>. 字段名 <span class="hljs-operator">=</span> <span class="hljs-string">"data"</span>                                       <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>   <span class="hljs-number">4</span>. 字段值 <span class="hljs-operator">=</span> <span class="hljs-string">"{<span class="hljs-subst">\"</span>content<span class="hljs-subst">\"</span>:<span class="hljs-subst">\"</span>Hello<span class="hljs-subst">\"</span>}"</span>                    <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>   <span class="hljs-number">5</span>. 字段名是 <span class="hljs-string">"data"</span>，追加到 data                           <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>      (当前 data 为空，直接赋值)                              <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>                                                            <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span> 当前状态:                                                   <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>   eventType <span class="hljs-operator">=</span> <span class="hljs-string">"chunk"</span>                    <span class="hljs-operator">✓</span>                 <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>   eventId   <span class="hljs-operator">=</span> <span class="hljs-string">"1"</span>                        <span class="hljs-operator">✓</span>                 <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>   data      <span class="hljs-operator">=</span> <span class="hljs-string">"{<span class="hljs-subst">\"</span>content<span class="hljs-subst">\"</span>:<span class="hljs-subst">\"</span>Hello<span class="hljs-subst">\"</span>}"</span>  <span class="hljs-operator">✓</span>                 <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>                                                            <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span> 动作: 继续等待下一行                                        <span class="hljs-operator">│</span>
<span class="hljs-operator">└────────────────────────────────────────────────────────────┘</span>
</code></pre>
<h3 data-id="heading-13">3.4 解析第 4 行：<code>""</code> (空行) ⚡</h3>
<pre><code class="hljs language-ini" lang="ini">┌────────────────────────────────────────────────────────────┐
│ 输入: ""  (空行)                                           │
│                                                            │
│ 处理过程:                                                   │
│   1. 行长度 == 0，是空行！                                  │
│   2. ⚡ 空行触发事件分发！                                   │
│                                                            │
│ 当前状态 (即将分发):                                        │
│   <span class="hljs-attr">eventType</span> = <span class="hljs-string">"chunk"</span>                                      │
│   <span class="hljs-attr">eventId</span>   = <span class="hljs-string">"1"</span>                                          │
│   <span class="hljs-attr">data</span>      = <span class="hljs-string">"{\"content\":\"Hello\"}"</span>                    │
│                                                            │
│ 执行 dispatchEvent():                                      │
│   1. 调用回调: onEvent("chunk", "1", "{...}")              │
│   2. 重置状态:                                              │
│      <span class="hljs-attr">eventType</span> = <span class="hljs-string">""</span>                                        │
│      <span class="hljs-attr">eventId</span>   = <span class="hljs-string">""</span>                                        │
│      <span class="hljs-attr">data</span>      = <span class="hljs-string">""</span>                                        │
│                                                            │
│ 动作: 🎯 触发回调！准备解析下一个事件                        │
└────────────────────────────────────────────────────────────┘
</code></pre>
<hr/>
<h2 data-id="heading-14">第四步：事件分发，回调业务层</h2>
<pre><code class="hljs language-scss" lang="scss">┌────────────────────────────────────────────────────────────┐
│                      回调链                                 │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  EventParser<span class="hljs-selector-class">.dispatchEvent</span>()                               │
│       │                                                    │
│       │  <span class="hljs-built_in">onEvent</span>("chunk", "<span class="hljs-number">1</span>", "{\"content\":\"Hello\"}")  │
│       ↓                                                    │
│  SSEClient<span class="hljs-selector-class">.handleEvent</span>()                                   │
│       │                                                    │
│       │  判断: eventType != <span class="hljs-string">"connected"</span>，不更新状态         │
│       │                                                    │
│       │  <span class="hljs-built_in">onTextChunk</span>(<span class="hljs-string">"chunk"</span>, <span class="hljs-string">"1"</span>, <span class="hljs-string">"{...}"</span>)                │
│       ↓                                                    │
│  MLNSSETool                                                │
│       │                                                    │
│       │  [onTextChunk addStringArgument:@<span class="hljs-string">"chunk"</span>];         │
│       │  <span class="hljs-selector-attr">[onTextChunk addStringArgument:@<span class="hljs-string">"1"</span>]</span>;             │
│       │  <span class="hljs-selector-attr">[onTextChunk addStringArgument:@<span class="hljs-string">"{...}"</span>]</span>;         │
│       │  <span class="hljs-selector-attr">[onTextChunk callIfCan]</span>;                          │
│       ↓                                                    │
│  Lua 业务层                                                │
│       │                                                    │
│       │  <span class="hljs-built_in">onEvent</span>("chunk", "<span class="hljs-number">1</span>", '{"content":"Hello"}')      │
│       ↓                                                    │
│  业务代码处理                                               │
│       │                                                    │
│       │  local json = cjson<span class="hljs-selector-class">.decode</span>(data)                   │
│       │  <span class="hljs-built_in">print</span>(json.content)  -- 输出: Hello               │
│       │  更新 UI 显示                                       │
│       ↓                                                    │
│  ✅ 完成！                                                  │
│                                                            │
└────────────────────────────────────────────────────────────┘
</code></pre>
<hr/>
<h2 data-id="heading-15">完整流程图（从服务器到 Lua）</h2>
<pre><code class="hljs language-swift" lang="swift">服务器发送: <span class="hljs-string">"event: chunk<span class="hljs-subst">\n</span>id: 1<span class="hljs-subst">\n</span>data: {...}<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>"</span>
                          <span class="hljs-operator">│</span>
                          <span class="hljs-operator">↓</span> 网络分块传输
<span class="hljs-operator">┌─────────────────────────────────────────────────────────────┐</span>
<span class="hljs-operator">│</span>                     第一步：网络层                            <span class="hljs-operator">│</span>
<span class="hljs-operator">├─────────────────────────────────────────────────────────────┤</span>
<span class="hljs-operator">│</span>  块<span class="hljs-number">1</span>: <span class="hljs-string">"event: chu"</span>                                          <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>  块<span class="hljs-number">2</span>: <span class="hljs-string">"nk<span class="hljs-subst">\n</span>id: 1<span class="hljs-subst">\n</span>da"</span>                                       <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>  块<span class="hljs-number">3</span>: <span class="hljs-string">"ta: {...}<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>"</span>                                       <span class="hljs-operator">│</span>
<span class="hljs-operator">└─────────────────────────────────────────────────────────────┘</span>
                          <span class="hljs-operator">│</span>
                          <span class="hljs-operator">↓</span> <span class="hljs-type">NSURLSession</span>.didReceiveData
<span class="hljs-operator">┌─────────────────────────────────────────────────────────────┐</span>
<span class="hljs-operator">│</span>                 第二步：行解析器                               <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>                 (<span class="hljs-type">UTF8LineParser</span>)                            <span class="hljs-operator">│</span>
<span class="hljs-operator">├─────────────────────────────────────────────────────────────┤</span>
<span class="hljs-operator">│</span>  块<span class="hljs-number">1</span> <span class="hljs-operator">→</span> []                                                   <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>  块<span class="hljs-number">2</span> <span class="hljs-operator">→</span> [<span class="hljs-string">"event: chunk"</span>, <span class="hljs-string">"id: 1"</span>]                            <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>  块<span class="hljs-number">3</span> <span class="hljs-operator">→</span> [<span class="hljs-string">"data: {...}"</span>, <span class="hljs-string">""</span>]                                  <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>                                                             <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>  合计得到<span class="hljs-number">4</span>行: `<span class="hljs-string">"event: chunk"</span>`, `<span class="hljs-string">"id: 1"</span>`, `<span class="hljs-string">"data: {...}"</span>`, `<span class="hljs-string">""</span>`  <span class="hljs-operator">│</span>
<span class="hljs-operator">└─────────────────────────────────────────────────────────────┘</span>
                          <span class="hljs-operator">│</span>
                          <span class="hljs-operator">↓</span> 逐行传递
<span class="hljs-operator">┌─────────────────────────────────────────────────────────────┐</span>
<span class="hljs-operator">│</span>                 第三步：事件解析器                             <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>                 (<span class="hljs-type">EventParser</span>)                               <span class="hljs-operator">│</span>
<span class="hljs-operator">├─────────────────────────────────────────────────────────────┤</span>
<span class="hljs-operator">│</span>  第<span class="hljs-number">1</span>行 <span class="hljs-string">"event: chunk"</span>  <span class="hljs-operator">→</span> eventType <span class="hljs-operator">=</span> <span class="hljs-string">"chunk"</span>                 <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>  第<span class="hljs-number">2</span>行 <span class="hljs-string">"id: 1"</span>         <span class="hljs-operator">→</span> eventId <span class="hljs-operator">=</span> <span class="hljs-string">"1"</span>                       <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>  第<span class="hljs-number">3</span>行 <span class="hljs-string">"data: {...}"</span>   <span class="hljs-operator">→</span> data <span class="hljs-operator">=</span> <span class="hljs-string">"{...}"</span>                      <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>  第<span class="hljs-number">4</span>行 <span class="hljs-string">""</span>              <span class="hljs-operator">→</span> <span class="hljs-operator">⚡</span> 触发 dispatchEvent()              <span class="hljs-operator">│</span>
<span class="hljs-operator">└─────────────────────────────────────────────────────────────┘</span>
                          <span class="hljs-operator">│</span>
                          <span class="hljs-operator">↓</span> onEvent 回调
<span class="hljs-operator">┌─────────────────────────────────────────────────────────────┐</span>
    <span class="hljs-operator">│</span>                 第四步：事件分发                           <span class="hljs-operator">│</span>
<span class="hljs-operator">├─────────────────────────────────────────────────────────────┤</span>
<span class="hljs-operator">│</span>  <span class="hljs-type">SSEClient</span>.handleEvent(<span class="hljs-string">"chunk"</span>, <span class="hljs-string">"1"</span>, <span class="hljs-string">"{...}"</span>)               <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>       <span class="hljs-operator">↓</span>                                                     <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>  <span class="hljs-type">MLNSSETool</span>.onTextChunk(<span class="hljs-string">"chunk"</span>, <span class="hljs-string">"1"</span>, <span class="hljs-string">"{...}"</span>)              <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>       <span class="hljs-operator">↓</span>                                                     <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>  <span class="hljs-type">Lua</span>: onEvent(<span class="hljs-string">"chunk"</span>, <span class="hljs-string">"1"</span>, '{<span class="hljs-string">"content"</span>:<span class="hljs-string">"Hello"</span>}')          <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>       <span class="hljs-operator">↓</span>                                                     <span class="hljs-operator">│</span>
    <span class="hljs-operator">│</span>  业务代码: 解析 <span class="hljs-type">JSON，更新</span> <span class="hljs-type">UI</span>                              <span class="hljs-operator">│</span>
<span class="hljs-operator">└─────────────────────────────────────────────────────────────┘</span>
                          <span class="hljs-operator">│</span>
                          <span class="hljs-operator">↓</span>
                    <span class="hljs-operator">✅</span> 处理完成！
</code></pre>
<hr/>
<hr/>
<h2 data-id="heading-16">二、关键点总结</h2>
<h3 data-id="heading-17">2.1 为什么需要行解析器？</h3>
<p>网络数据分块到达，一行可能被拆成多块。行解析器用<strong>缓冲区</strong>解决这个问题。</p>
<h3 data-id="heading-18">2.2 为什么空行这么重要？</h3>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">event: chunk     ← 存储 eventType，不触发</span>
<span class="hljs-section">id: 1            ← 存储 eventId，不触发</span>
<span class="hljs-section">data: {...}      ← 存储 data，不触发</span>
                 ← ⚡ 只有空行才触发事件分发！
</code></pre>
<p><strong>空行 = 事件结束的信号</strong></p>
<h3 data-id="heading-19">2.3 一个事件的完整生命周期</h3>



































<table><thead><tr><th>阶段</th><th>输入</th><th>输出</th></tr></thead><tbody><tr><td>网络传输</td><td>字节流</td><td>数据块</td></tr><tr><td>行解析器</td><td>数据块</td><td>文本行数组</td></tr><tr><td>事件解析器</td><td>文本行</td><td>event/id/data</td></tr><tr><td>空行触发</td><td>""</td><td>dispatchEvent()</td></tr><tr><td>回调链</td><td>event/id/data</td><td>Lua onEvent</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[企业级 Vue3 + Element Plus 主题定制架构：从“能用”到“好用”的进阶之路]]></title>    <link>https://juejin.cn/post/7592119218030313506</link>    <guid>https://juejin.cn/post/7592119218030313506</guid>    <pubDate>2026-01-07T01:45:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592119218030313506" data-draft-id="7592094314472439843" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="企业级 Vue3 + Element Plus 主题定制架构：从“能用”到“好用”的进阶之路"/> <meta itemprop="keywords" content="架构,CSS,前端"/> <meta itemprop="datePublished" content="2026-01-07T01:45:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大象的鼻子那么长"/> <meta itemprop="url" content="https://juejin.cn/user/2277843821926871"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            企业级 Vue3 + Element Plus 主题定制架构：从“能用”到“好用”的进阶之路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2277843821926871/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大象的鼻子那么长
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.4 融会贯通
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.4 融会贯通" title="VIP.4 融会贯通" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T01:45:25.000Z" title="Wed Jan 07 2026 01:45:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>摘要</strong>：硬编码颜色是维护的噩梦。本文深入探讨基于 CSS Variables 和 SCSS 的分层主题架构，实现毫秒级动态换肤与暗黑模式，构建可扩展的企业级设计系统。拒绝“一把梭”的样式覆盖，让我们用工程化的思维重构前端主题系统。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">1. 引言：为什么你的主题系统很难维护？</h2>
<p>在 B 端项目中，Element Plus 是我们的老朋友。但在长期迭代中，我们经常遇到这些痛点：</p>
<ul>
<li><strong>痛点一：硬编码满天飞</strong>。<code>color: #409eff</code> 散落在各个 <code>.vue</code> 文件和 <code>.scss</code> 文件中。设计师说要换品牌色，开发人员两眼一黑。</li>
<li><strong>痛点二：覆盖链地狱</strong>。为了修改一个按钮颜色，使用了 <code>!important</code> 甚至 <code>::v-deep</code> 嵌套五层，导致样式优先级混乱，牵一发而动全身。</li>
<li><strong>痛点三：动态换肤困难</strong>。SCSS 变量在编译时就确定了，想做“暗黑模式”或“一键换肤”，必须重新加载 CSS 文件，体验极差。</li>
</ul>
<p>本文将介绍一种**基于分层架构（Layered Architecture）**的主题设计方案，完美解决上述问题。</p>
<hr/>
<h2 data-id="heading-1">2. 核心架构设计：四层金字塔</h2>
<p>为了解耦业务逻辑与 UI 框架，我们将主题系统划分为四层。这种设计遵循“<strong>Token 优先，覆盖为辅</strong>”的原则。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    subgraph "Layer 1: Design Tokens (业务语义)"
        L1[src/assets/styles/var.scss]
        L1_Desc["定义品牌色、字号、圆角&lt;br/&gt;--cmc-primary-color&lt;br/&gt;--cmc-bg-color"]
    end

    subgraph "Layer 2: Variable Mapping (映射层)"
        L2[src/assets/styles/element-theme.scss]
        L2_Desc["将 Element Plus 变量绑定到业务 Token&lt;br/&gt;--el-color-primary: var(--cmc-primary-color)"]
    end

    subgraph "Layer 3: Framework (框架层)"
        L3[Element Plus Components]
        L3_Desc["组件自动消费 --el-* 变量&lt;br/&gt;无需修改组件代码"]
    end

    subgraph "Layer 4: Overrides (微调层)"
        L4[src/assets/styles/cus-element.scss]
        L4_Desc["处理特殊布局或结构差异&lt;br/&gt;使用 var(--cmc-*) 引用变量"]
    end

    L1 --&gt; L2
    L2 --&gt; L3
    L1 --&gt; L4
    L3 --&gt; L4
</code></pre>
<h3 data-id="heading-2">Layer 1: 基础设计令牌 (Design Tokens)</h3>
<p>这是设计系统的“元数据”，通常对应 Figma 中的 Styles。它不依赖于任何 UI 框架，纯粹描述业务的视觉规范。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">/* src/assets/styles/var.scss */</span>
<span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-comment">/* 品牌色 */</span>
  <span class="hljs-attr">--cmc-primary-color</span>: <span class="hljs-number">#004889</span>;
  <span class="hljs-attr">--cmc-success-color</span>: <span class="hljs-number">#05ac77</span>;
  
  <span class="hljs-comment">/* 中性色 */</span>
  <span class="hljs-attr">--cmc-neutral-text</span>: <span class="hljs-number">#333333</span>;
  <span class="hljs-attr">--cmc-neutral-border</span>: <span class="hljs-number">#e4e7ed</span>;
  
  <span class="hljs-comment">/* 布局 */</span>
  <span class="hljs-attr">--cmc-radius-base</span>: <span class="hljs-number">2px</span>;
}
</code></pre>
<h3 data-id="heading-3">Layer 2: 变量映射层 (Variable Mapping)</h3>
<p>这是架构中最关键的一环。它充当了“适配器”的角色，将 Element Plus 的语言（<code>--el-*</code>）翻译成我们业务的语言（<code>--cmc-*</code>）。</p>
<p><strong>为什么要这样做？</strong>
直接修改 <code>--el-color-primary</code> 虽然可行，但它让你的业务代码耦合了 Element Plus 的命名。通过中间层映射，未来如果你迁移到 Ant Design Vue，只需修改映射层，Layer 1 的业务代码无需变动。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">/* src/assets/styles/element-theme.scss */</span>
<span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-comment">/* 将 Element Plus 的主色指向我们的业务主色 */</span>
  <span class="hljs-attr">--el-color-primary</span>: <span class="hljs-built_in">var</span>(--cmc-primary-color);
  
  <span class="hljs-comment">/* 文本颜色映射 */</span>
  <span class="hljs-attr">--el-text-color-primary</span>: <span class="hljs-built_in">var</span>(--cmc-neutral-text);
  
  <span class="hljs-comment">/* 边框映射 */</span>
  <span class="hljs-attr">--el-border-color</span>: <span class="hljs-built_in">var</span>(--cmc-neutral-border);
  <span class="hljs-attr">--el-border-radius-base</span>: <span class="hljs-built_in">var</span>(--cmc-radius-base);
}
</code></pre>
<h3 data-id="heading-4">Layer 3: SCSS 编译配置 (静态预处理)</h3>
<p>虽然 CSS 变量很强大，但有些场景（如 Sass 的 <code>color.mix</code> 函数或循环生成类名）需要在编译时完成。我们保留 <code>element/index.scss</code> 用于处理这些静态逻辑。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">/* src/assets/styles/element/index.scss */</span>
<span class="hljs-keyword">@forward</span> <span class="hljs-string">'element-plus/theme-chalk/src/common/var.scss'</span> with (
  <span class="hljs-variable">$colors</span>: (
    <span class="hljs-string">'primary'</span>: (
      <span class="hljs-string">'base'</span>: <span class="hljs-number">#004889</span>, /* 用于生成 light-<span class="hljs-number">1</span> ~ light-<span class="hljs-number">9</span> 的静态色阶 */
    ),
  )
);
</code></pre>
<h3 data-id="heading-5">Layer 4: 组件样式微调 (Overrides)</h3>
<p>最后，对于那些无法通过变量修改的样式（如 DOM 结构导致的布局差异），我们在这一层进行微调。</p>
<p><strong>核心原则</strong>：<strong>严禁硬编码颜色</strong>。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">/* src/assets/styles/cus-element.scss */</span>

<span class="hljs-comment">/* Bad ❌: 硬编码颜色，换肤时这里会变成漏网之鱼 */</span>
<span class="hljs-selector-class">.el-input__wrapper</span> {
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">1px</span> <span class="hljs-number">#004889</span> <span class="hljs-meta">!important</span>;
}

<span class="hljs-comment">/* Good ✅: 引用 Layer 1 的 Token，换肤自动跟随 */</span>
<span class="hljs-selector-class">.el-input__wrapper</span> {
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">1px</span> <span class="hljs-built_in">var</span>(--cmc-primary-color) <span class="hljs-meta">!important</span>;
}
</code></pre>
<hr/>
<h2 data-id="heading-6">3. 深度解析：动态换肤与暗黑模式原理</h2>
<p>有了上述架构，实现动态换肤就变成了 <strong>O(1)</strong> 复杂度的操作——只需修改 CSS 变量的值。</p>
<h3 data-id="heading-7">运行时动态换肤</h3>
<p>我们不需要请求后端下载新的 CSS 文件，也不需要重新编译。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// theme.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">changeTheme</span>(<span class="hljs-params">color: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">const</span> el = <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>
  <span class="hljs-comment">// 修改 CSS 变量，页面瞬间重绘</span>
  el.<span class="hljs-property">style</span>.<span class="hljs-title function_">setProperty</span>(<span class="hljs-string">'--cmc-primary-color'</span>, color)
  
  <span class="hljs-comment">// 还可以利用算法动态计算辅助色</span>
  <span class="hljs-comment">// el.style.setProperty('--cmc-primary-light-1', lighten(color, 10%))</span>
}
</code></pre>
<h3 data-id="heading-8">暗黑模式 (Dark Mode)</h3>
<p>利用 CSS 的层叠特性，我们只需定义 <code>.dark</code> 类下的变量值。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">/* src/assets/styles/var.scss */</span>

<span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-attr">--cmc-bg-color</span>: <span class="hljs-number">#ffffff</span>;
  <span class="hljs-attr">--cmc-text-color</span>: <span class="hljs-number">#333333</span>;
}

<span class="hljs-comment">/* 暗黑模式重写变量 */</span>
<span class="hljs-selector-tag">html</span><span class="hljs-selector-class">.dark</span> {
  <span class="hljs-attr">--cmc-bg-color</span>: <span class="hljs-number">#141414</span>;
  <span class="hljs-attr">--cmc-text-color</span>: <span class="hljs-number">#e5eaf3</span>;
  
  <span class="hljs-comment">/* 调整主色亮度以提升深色背景下的对比度 */</span>
  <span class="hljs-attr">--cmc-primary-color</span>: <span class="hljs-number">#409eff</span>; 
}
</code></pre>
<p>VueUse 的 <code>useDark</code> 完美配合：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { useDark, useToggle } <span class="hljs-keyword">from</span> <span class="hljs-string">'@vueuse/core'</span>

<span class="hljs-keyword">const</span> isDark = <span class="hljs-title function_">useDark</span>()
<span class="hljs-keyword">const</span> toggleDark = <span class="hljs-title function_">useToggle</span>(isDark)
</code></pre>
<hr/>
<h2 data-id="heading-9">4. 工程化实践：样式加载策略</h2>
<p>在大型应用中，样式的加载顺序至关重要。如果 <code>element-theme.scss</code> 加载晚于组件样式，映射可能失效。</p>
<p>推荐采用<strong>程序化加载</strong>策略，在应用初始化阶段显式控制加载顺序。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/bootstrap/app-initializer.ts</span>

<span class="hljs-keyword">async</span> <span class="hljs-title function_">loadStyles</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> styleModules = [
    <span class="hljs-comment">// 1. 先加载设计令牌</span>
    <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/assets/styles/var.scss'</span>),
    <span class="hljs-comment">// 2. 加载变量映射（关键！）</span>
    <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/assets/styles/element-theme.scss'</span>),
    <span class="hljs-comment">// 3. 加载框架基础样式</span>
    <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/assets/styles/index.scss'</span>),
    <span class="hljs-comment">// 4. 最后加载自定义覆盖</span>
    <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/assets/styles/cus-element.scss'</span>),
  ]

  <span class="hljs-comment">// 按顺序并行或串行加载</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(styleModules.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">fn</span> =&gt;</span> <span class="hljs-title function_">fn</span>()))
}
</code></pre>
<hr/>
<h2 data-id="heading-10">5. 总结与最佳实践清单</h2>
<p>要构建一个健壮的主题系统，请遵守以下 Checklist：</p>
<ol>
<li><strong>Single Source of Truth</strong>：所有颜色必须定义在 <code>var.scss</code> 中，禁止在 Vue 组件的 <code>&lt;style&gt;</code> 中写死 Hex 值。</li>
<li><strong>语义化命名</strong>：使用 <code>--brand-primary</code> 而不是 <code>--blue-500</code>。前者描述意图，后者描述表象。当品牌色从蓝变红时，你不需要重命名变量。</li>
<li><strong>避免过度封装</strong>：不要为了“看起来整洁”而把 Element Plus 的所有变量都重新定义一遍。只映射你需要定制的部分（如颜色、圆角、字体），保持轻量。</li>
<li><strong>利用 DevTools</strong>：Chrome 的 "Styles" 面板底部可以直观地看到 CSS 变量的继承链，是调试主题问题的利器。</li>
</ol>
<p>通过这套架构，我们不仅解决了“改一个颜色改一天”的尴尬，更为未来的设计系统升级打下了坚实的地基。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MCP 科普]]></title>    <link>https://juejin.cn/post/7592082090209083419</link>    <guid>https://juejin.cn/post/7592082090209083419</guid>    <pubDate>2026-01-07T00:56:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592082090209083419" data-draft-id="7592062873829425202" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MCP 科普"/> <meta itemprop="keywords" content="MCP"/> <meta itemprop="datePublished" content="2026-01-07T00:56:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="pauli"/> <meta itemprop="url" content="https://juejin.cn/user/4160207728689037"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MCP 科普
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4160207728689037/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    pauli
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T00:56:40.000Z" title="Wed Jan 07 2026 00:56:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">几个缩写</h2>
<ul>
<li>JSON: JavaScript Object Notation</li>
<li>RPC: Remote Procedure Call</li>
<li>MCP: Model Context Protocol</li>
</ul>
<h4 data-id="heading-1">🎯 什么是 RPC？</h4>
<p>JSON 是一种<strong>轻量级、纯文本的数据交换格式</strong>，它采用完全独立于编程语言的文本格式来存储和传输结构化数据。其核心特点是<strong>人类可读</strong>（使用大家熟悉的键值对、数组结构表示）和<strong>机器易解析</strong>，因此它成为了现代网络通信（如你正在使用的MCP协议）和应用程序配置中<strong>最主流的数据交换语言</strong>，几乎所有的编程语言都提供了对JSON的生成和解析支持。</p>
<h4 data-id="heading-2">🎯 什么是 RPC？</h4>
<p><strong>RPC</strong> 指<strong>远程过程调用</strong>。它是一种技术，允许一个计算机程序（客户端）调用另一个地址空间（通常是网络上的另一台机器）的程序（服务端）中的函数或过程，就像调用本地函数一样简单。</p>
<p><strong>核心思想</strong>：<strong>让你像调用本地函数一样去调用远程服务</strong>，而无需关心底层的网络通信、数据序列化等复杂细节。</p>
<p>举个简单的例子，假设你有一个本地的加法函数 <code>add(1, 2)</code>。使用RPC，你可以调用一个远在服务器上的函数，写法可能完全一样 <code>add(1, 2)</code>，但实际的计算发生在服务器上，结果再传回给你。</p>
<h4 data-id="heading-3">📄 什么是 JSON-RPC？</h4>
<p><strong>JSON-RPC</strong> 是一种<strong>轻量级的、基于JSON的RPC协议</strong>。它定义了客户端和服务器之间如何进行结构化通信的简单规则。</p>
<p><strong>核心特点</strong>：使用人类可读的<strong>JSON格式</strong>来编码请求和响应，这使得它非常通用，几乎任何支持JSON和网络的语言都能使用。</p>
<p>一个<strong>JSON-RPC 2.0</strong>请求和响应看起来就像这样，这正是MCP服务器一直在处理的东西：</p>
<p><strong>请求 (Request)：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"get_weather"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 要调用的远程方法名</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"city"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Beijing"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 调用参数</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">101</span> <span class="hljs-comment">// 请求ID，用于匹配响应</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>成功响应 (Success Response)：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"temperature"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">22</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"condition"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sunny"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 调用结果</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">101</span> <span class="hljs-comment">// 与请求ID对应</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>错误响应 (Error Response)：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"error"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"code"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">-32601</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Method not found"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">101</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-4">📊 RPC 与 JSON-RPC 的关系与对比</h4>






























<table><thead><tr><th align="left">特性</th><th align="left"><strong>RPC</strong></th><th align="left"><strong>JSON-RPC</strong></th></tr></thead><tbody><tr><td align="left"><strong>定位</strong></td><td align="left">一种广泛的技术<strong>概念和模型</strong>。</td><td align="left">RPC 概念的一种<strong>具体实现协议</strong>。</td></tr><tr><td align="left"><strong>数据格式</strong></td><td align="left">不限定，可以是任何格式（如二进制、XML）。</td><td align="left"><strong>强制使用 JSON</strong> 格式。</td></tr><tr><td align="left"><strong>核心</strong></td><td align="left">实现“远程调用像本地调用”的<strong>思想</strong>。</td><td align="left">实现该思想的<strong>一套具体JSON消息规则</strong>。</td></tr><tr><td align="left"><strong>类比</strong></td><td align="left">就像“车辆”这个概念。</td><td align="left">就像是“车辆”概念下的一辆<strong>具体规范的公交车</strong>（有固定的颜色、票价、停靠站规则）。</td></tr></tbody></table>
<h4 data-id="heading-5">🔗 它们与 MCP 的关系</h4>
<p><strong>MCP 是建立在 JSON-RPC 2.0 之上的一个更高层、更具体的协议。</strong></p>
<ol>
<li><strong>MCP 使用了 JSON-RPC 的“巴士”</strong>：所有MCP消息（见下文）都严格遵循上面看到的JSON-RPC请求和响应格式。</li>
<li><strong>MCP 定义了“巴士的路线和乘客规范”</strong>：MCP协议规定了在这条JSON-RPC线路上，必须有哪些“站点”（即必须实现的 <code>method</code>），以及每个站点“上下车的乘客”长什么样（即 <code>params</code> 和 <code>result</code> 的详细数据结构）。
<ul>
<li>例如，MCP规定了一个叫 <code>tools/call</code> 的“站点”（方法），并且规定在这个站点，“乘客”（<code>params</code>）必须包含 <code>name</code> 和 <code>arguments</code> 字段。</li>
</ul>
</li>
</ol>
<p>所以，当你写MCP服务器时，你本质上是在<strong>编写一个遵循了额外（MCP）规则的JSON-RPC服务器</strong>。之前代码中的 <code>protocolVersion</code>、<code>serverInfo</code>、<code>inputSchema</code> 等字段，都是MCP这个“上层协议”在JSON-RPC这个“基础交通工具”上额外规定的“乘客行为规范”。</p>
<h4 data-id="heading-6">初始化 initialize</h4>
<p><strong><code>initialize</code> 是MCP协议会话中客户端发送的第一个、也是必需的请求，用于协商协议版本并建立连接。</strong> 它好比一次“握手”，客户端通过它询问“你能用什么版本协议？有哪些功能？”，而服务器则必须在响应中明确回答三个核心信息：</p>
<ul>
<li>本次会话使用的<strong>协议版本</strong>（<code>protocolVersion</code>，例如 <code>"2024-11-05"</code>）、</li>
<li>关于自身的<strong>元信息</strong>（<code>serverInfo</code>，如名称和版本）、</li>
<li>以及所支持的<strong>功能列表</strong>（<code>capabilities</code>，例如声明是否支持 <code>tools</code>、<code>resources</code>、<code>prompts</code> 等）。</li>
</ul>
<p>只有在成功完成 <code>initialize</code> 握手后，客户端才会发送 <code>notifications/initialized</code> 通知，并基于服务器的能力声明来发起后续的 <code>tools/list</code>、<code>resources/read</code> 等具体交互。你之前服务器返回的 <code>{"protocolVersion":"2024-11-05","serverInfo":{...},"capabilities":{...}}</code> 正是一个标准的初始化响应。</p>
<p>一个完整的、符合 MCP 协议的 <code>initialize</code> 请求的<strong>成功响应消息</strong>示例如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"serverInfo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"你的MCP服务器名称"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"capabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"listChanged"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"resources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"listChanged"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"subscribe"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"prompts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"listChanged"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"implementation"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-mcp-server"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-7">📝 关键字段详解</h4>
<p>这个响应中的所有字段都是为了让客户端理解如何与你的服务器正确交互：</p>




























































<table><thead><tr><th align="left">字段路径</th><th align="left">是否必需</th><th align="left">说明与示例</th></tr></thead><tbody><tr><td align="left"><strong><code>jsonrpc</code></strong></td><td align="left"><strong>必需</strong></td><td align="left">固定为 <code>"2.0"</code>，表明遵循 JSON-RPC 2.0 协议。</td></tr><tr><td align="left"><strong><code>id</code></strong></td><td align="left"><strong>必需</strong></td><td align="left">必须与客户端 <code>initialize</code> <strong>请求中的 <code>id</code> 完全一致</strong>，用于匹配请求与响应。</td></tr><tr><td align="left"><strong><code>result</code></strong></td><td align="left"><strong>必需</strong></td><td align="left">初始化结果对象，包含所有协商信息。</td></tr><tr><td align="left"><code>result.protocolVersion</code></td><td align="left"><strong>必需</strong></td><td align="left"><strong>协议版本</strong>。当前主流是 <code>"2024-11-05"</code>，必须与客户端兼容。</td></tr><tr><td align="left"><code>result.serverInfo</code></td><td align="left"><strong>必需</strong></td><td align="left"><strong>服务器元信息</strong>。<code>name</code> 和 <code>version</code> 用于客户端标识和日志显示。</td></tr><tr><td align="left"><code>result.capabilities</code></td><td align="left"><strong>必需</strong></td><td align="left"><strong>能力声明</strong>，是<strong>最核心</strong>的部分。它用一个对象明确告知客户端你支持（或不支持）哪些MCP功能。</td></tr><tr><td align="left"><code>result.capabilities.tools</code></td><td align="left">可选</td><td align="left">声明 <strong>工具</strong> 相关能力。<code>listChanged</code> 设为 <code>true</code> 表示工具列表可能变化，客户端需要刷新。</td></tr><tr><td align="left"><code>result.capabilities.resources</code></td><td align="left">可选</td><td align="left">声明 <strong>资源</strong> 相关能力。<code>subscribe</code> 设为 <code>false</code> 表示不支持资源变更推送。</td></tr><tr><td align="left"><code>result.capabilities.prompts</code></td><td align="left">可选</td><td align="left">声明 <strong>提示词模板</strong> 相关能力。</td></tr><tr><td align="left"><code>result.implementation</code></td><td align="left">可选</td><td align="left"><strong>实现详情</strong>。用于更细致的调试，可包含服务器具体的实现名称和版本。</td></tr></tbody></table>
<h4 data-id="heading-8">💡 核心解读</h4>
<ol>
<li><strong><code>capabilities</code> 是功能开关</strong>：你只需在 <code>capabilities</code> 对象里包含你<strong>实际实现了的功能</strong>（如 <code>tools</code>、<code>resources</code>）。如果没实现 <code>prompts</code>，就不需要包含该字段。这直接决定了客户端之后是否会向你发送 <code>prompts/list</code> 等请求。</li>
<li><strong><code>listChanged</code> 的作用</strong>：这是一个优化选项。如果设为 <code>true</code>，当服务器上的工具、资源或提示词列表发生变化时，<strong>服务器可以主动通知</strong>客户端刷新列表，无需客户端频繁轮询。</li>
<li><strong>与请求的对应</strong>：响应中的 <code>id</code> 必须与请求中的 <code>id</code> 对应。如果请求是一个没有 <code>id</code> 的<strong>通知</strong>（理论上 <code>initialize</code> 必须是请求），则服务器不应回复。</li>
</ol>
<p>这个结构就是MCP协议中“握手成功”的确认信号。你之前部署的服务器返回的响应已经包含了最核心的必需字段，是完全有效的。你可以根据服务器实际实现的功能，调整 <code>capabilities</code> 对象的内容。最权威的参考始终是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fspec.modelcontextprotocol.io%2Fspecification%2F" target="_blank" title="https://spec.modelcontextprotocol.io/specification/" ref="nofollow noopener noreferrer">MCP 官方规范</a>。</p>
<h4 data-id="heading-9">MCP 消息</h4>
<p>MCP 消息可以归纳为以下几类，它们都严格遵循 <strong>JSON-RPC 2.0</strong> 的格式：</p>
<ol>
<li><strong>生命周期与连接管理消息</strong>：这是会话的基础，包括 <strong><code>initialize</code></strong>（初始化握手）、<strong><code>ping</code>/<code>pong</code></strong>（连接健康检查），以及 <strong><code>notifications/initialized</code></strong>（客户端通知服务器初始化完成）。</li>
<li><strong>三大核心能力消息</strong>：这是MCP功能的核心，对应三大模块：
<ul>
<li><strong>工具</strong>：<code>tools/list</code>（列出工具）、<code>tools/call</code>（调用工具）。</li>
<li><strong>资源</strong>：<code>resources/list</code>（列出资源URI）、<code>resources/read</code>（读取资源内容）、<code>resources/subscribe</code>（订阅资源变更）。</li>
<li><strong>提示词模板</strong>：<code>prompts/list</code>（列出提示词模板）、<code>prompts/get</code>（获取模板内容）。</li>
</ul>
</li>
<li><strong>通知与变更消息</strong>：服务器主动向客户端推送变更，例如 <code>notifications/resources/updated</code>（通知资源列表已更新）。</li>
</ol>
<p><strong>简单来说，除了连接和工具类消息，MCP协议还定义了用于读取数据的资源类消息、管理预写提示词的提示词类消息，以及用于实时同步的服务器通知。</strong> 服务器通过在 <code>initialize</code> 的 <code>capabilities</code> 字段中声明所支持的能力（如 <code>tools</code>、<code>resources</code>），来告知客户端可以提供哪些类型的消息交互。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一个在校学生的 Vibe-Coding道路]]></title>    <link>https://juejin.cn/post/7592120202318479410</link>    <guid>https://juejin.cn/post/7592120202318479410</guid>    <pubDate>2026-01-06T17:17:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592120202318479410" data-draft-id="7592079304923578378" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一个在校学生的 Vibe-Coding道路"/> <meta itemprop="keywords" content="VibeCoding,AI编程,Trae"/> <meta itemprop="datePublished" content="2026-01-06T17:17:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="有意义"/> <meta itemprop="url" content="https://juejin.cn/user/1739866211617625"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一个在校学生的 Vibe-Coding道路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1739866211617625/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    有意义
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T17:17:42.000Z" title="Tue Jan 06 2026 17:17:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">写在前面</h2>
<p>从前，我们比谁代码写得快、bug 调得准；现在，我们比谁能把想法讲清楚、把规则定明白。</p>
<p>这场变化的主角不是更强大的框架，也不是更快的语言，而是<strong>人与 AI 协作方式的升级</strong>——从“我写每一行”到“我指挥整个开发流”。</p>
<p>而驱动这场转变的核心理念，正是 <strong>SDD（Spec-Driven Development，规范驱动开发）</strong> ：先写好“做什么”，再让 AI 精准执行“怎么做”。</p>
<p>在这条路上，我从一个被课程设计逼到崩溃的学生，慢慢摸索出一套属于自己的 Vibe Coding 节奏。接下来，我想和你聊聊这段真实的成长经历。</p>
<p>而这一切的转折点，就藏在 <strong>SDD（Spec-Driven Development，规范驱动开发）</strong>  之中。</p>
<h2 data-id="heading-1">传统coding</h2>
<p>在 AI 编程工具尚未普及的年代，相信有很多人入门都是敲“CQ外卖”这样的程序开始接触开发的吧，我也不例外。</p>
<p>开发一个像“CQ外卖”这样的 Spring + Vue 全栈项目，是一场<strong>消耗人力、流程固定、节奏缓慢</strong>的工程。</p>
<p>那时候其实已经有 AI 了，只是我们不会用——不知道怎么问，也不敢信它能写出靠谱代码。于是后端还是老老实实用 MyBatis 手写 DAO，前端靠 Vue 的 data 和 methods 一点点拼页面</p>
<p>连一个简单的“加入购物车”动画都要翻文档、调样式、反复刷新浏览器看效果。</p>
<p>AI 就在旁边，像一个沉默的特种兵</p>
<p>整个过程常常就一个人包揽全部：自己写需求、画界面、前后端一起写，最后再自己点按钮、输乱码测试会不会崩。没有分工，却有全套流程的负担。</p>
<p>一旦哪块卡住——比如接口还没通，页面就动不了——整个项目就原地停摆。</p>
<p>这种传统 coding 模式本身并不低效——它<strong>讲流程、重规范、求稳定</strong>，恰恰是大型项目所需要的。</p>
<blockquote>
<p>但一旦面对“现在就要用”这类轻量、即时的场景，它的重量就变成了负担。</p>
</blockquote>
<blockquote>
<p>正因如此，开发者开始转向新的思路：不再一上来就写代码，而是先写清楚规则；不再靠一个人硬扛全栈，而是让 AI 成为协作伙伴。</p>
</blockquote>
<h2 data-id="heading-2">Vibe Coding</h2>
<p>事情是这样的：当我为 JavaWeb 课程设计焦头烂额，一位同学已经用 <strong>Trae</strong> 辅助完成了他的项目。他没熬夜，也没在控制台里疯狂404 500，反而早早完成了课设。</p>
<p>他看我快被课设弄崩溃了，就顺手把使用方法教给了我——直接把实验题目复制到Trae，然后根据生成的结果继续和它说</p>
<p>我试了一次，就再也回不去了。</p>
<p>从前是<strong>人适应框架，现在是“AI 帮你搭好架子，你只管填逻辑</strong>。</p>
<p>我从此一发不可收拾——课程设计提前完成，还顺手加了用户登录、分页查询、响应式布局。</p>
<p>更关键的是，我第一次觉得，编程不是苦力，而是一种<strong>指挥与协作的艺术</strong>。</p>
<p>这和下面要聊的 vibe Coding 密切相关。</p>
<hr/>
<h2 data-id="heading-3">vibe Coding 三大阶段</h2>
<h3 data-id="heading-4">vibe感 的第一阶段  用一两句话来描述需求</h3>
<p>当然，上面的行为我还是不推荐的——作业终究还是要自己认真写，基础不牢，地动山摇。</p>
<p>我之所以分享这段经历，并不是鼓励直接“交AI代劳”，而是想说明：<strong>工具本身没有对错，关键在于你怎么用它</strong>。</p>
<blockquote>
<p>我上面使用的方法，其实正是 Vibe Coding 的第一个阶段：用一两句话描述需求</p>
</blockquote>
<p>比如“帮我在这个 Spring Boot 项目里加一个根据用户名查询用户的功能”或者“在现有的 Vue 页面上加一个清空购物车的按钮”</p>
<p>这种用法，在我的大学生涯里更多出现在课堂作业中——老师给了基础源码，我们拉取下来后，直接在AI编辑器(比如Trae)说：“我要实现 XX 功能”，AI 就能快速生成符合项目结构的代码片段。</p>
<p>当然，我并不是直接照搬——每段 AI 生成的代码我都会读，不仅看它怎么写，更琢磨它为什么这样写。</p>
<blockquote>
<p>所以，哪怕只是“一句话 prompt”，只要带着学习的目的去用，Vibe Coding 的起点，也可以是扎实成长的开始。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">vibe感 的第二阶段  设计prompt</h3>
<p>当然，上面那种“一两句话句话生成”的方法打打常规赛还行，</p>
<p>但一到“季后赛”，比如期中课程设计，学校请来了某马的老师现场检查作业，情况就不同了。</p>
<p>来的不是只看结果的大学老师，而是真正在公司干过开发的年轻讲解老师。这时候，光靠 AI 堆代码就行不通了，我们的打法就得偏“欧美”一点了：<strong>结构清晰、命名严谨、注释到位、逻辑可追溯</strong>——毕竟，人家一眼就能看出代码是“手搓的”还是“糊弄的”。</p>
<p>具体该怎么做呢？</p>
<p><strong>关键在于升级提示词</strong></p>
<ol>
<li>
<p>我们可以先赋予 AI 一个明确角色，比如“资深全栈工程师”</p>
</li>
<li>
<p>再说明项目结构（文件该放哪儿）、代码规范（ES6、TailwindCSS、RESTful 等）</p>
</li>
<li>
<p>接着清晰描述当前需求，提供必要的上下文（如技术栈、已有模块），并指定输出格式（完整文件、逻辑片段或带注释的代码）。</p>
</li>
</ol>
<blockquote>
<p>相比第一阶段的随机抽卡，这时的提示词更专业、更系统，本质上是用工程语言引导大模型，把模糊想法拆解为可执行任务，从而精准控制 Vibe Coding 的产出质量——从“碰运气”迈向“可预测”。</p>
</blockquote>
<hr/>
<h3 data-id="heading-6">vibe感 的第三阶段  多Agent协作</h3>
<p>到了第三阶段，其实就和完成大学作业没什么关系了。</p>
<p>Vibe Coding 不再是“人 + AI”的单打独斗，而是演变为一套<strong>多 Agent 协作的自动化开发流水线</strong>。<br/>
在真正写代码之前，先让 AI 扮演不同角色，按专业流程依次推进：</p>
<p>举个例子：我们要做一个微信记牌小程序。</p>
<p>首先，在微信开发者工具里新建一个项目。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/732ce328e728498895d30f2dc2a3404e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oSP5LmJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768324661&amp;x-signature=eJODwwBzXD3GTjLqkR4GSG70rSY%3D" alt="image.png" loading="lazy"/></p>
<p>接着，用 Gemini 3 帮我们生成一份高质量的 Prompt（具体怎么访问 Gemini 自己想办法）。输入两段引导性提示：</p>
<pre><code class="hljs language-ini" lang="ini">你是一个大师级的微信小程序产品经理，我现在需要你帮我把想法变成需求文档，用于给到AI编程工具进行实现：
</code></pre>
<pre><code class="hljs language-ini" lang="ini">我们需要先讨论一下需求，等确定了所有的需求，我们在进行第二步
</code></pre>
<p>根据你的具体想法，AI 会输出一份高度结构化、可直接用于工程落地的 Spec。不同的人输入，得到的 Prompt 也不同——这才是真正的个性化协作。</p>
<p>比如，你可能会得到这样一份提示词：</p>
<pre><code class="hljs language-ini" lang="ini">Role: Expert WeChat Mini Program Developer
Task: Create a standalone scoring Mini Program (offline-first).
Language: JavaScript (Native WeChat Framework), WXSS, WXML.
1. Project Context (项目背景)
这是一个用于线下桌游（麻将、扑克）的通用记分工具。
核心逻辑：基于“零和游戏”规则（Zero-Sum Game），即每局所有玩家的得分之和必须为 0。
运行模式：单机版，无后端，所有数据存储在本地缓存（LocalStorage）。
用户：通常由其中一名玩家操作，记录所有人的分数。
2. Tech Stack (技术栈约束)
Framework: Native WeChat Mini Program (原生开发).
Styling: Standard WXSS (Flexbox layout). Minimalistic design.
Storage: wx.setStorageSync / wx.getStorageSync.
Logic: No external dependencies. Pure JS logic.
3. Data Schema (数据结构设计)
Please strict follow this JSON structure for LocalStorage key game_history.
code
JSON
<span class="hljs-section">[
  {
    "id": "uuid_v4_string",          // 唯一牌局ID
    "name": "2023-10-01 欢乐麻将",    // 牌局名称
    "createTime": 1696123456789,     // 创建时间戳
    "playerCount": 4,                // 玩家人数 (2-6)
    "players": [                     // 玩家列表
      { "id": 0, "name": "张三", "totalScore": 10 },
      { "id": 1, "name": "李四", "totalScore": -5 },
      { "id": 2, "name": "王五", "totalScore": -5 },
      { "id": 3, "name": "赵六", "totalScore": 0 }
    ]</span>,
    "rounds": <span class="hljs-section">[                      // 对局记录流水
      {
        "roundId": 1,
        "timestamp": 1696123500000,
        "scores": [10, -5, -5, 0]</span>    // 对应 players 数组索引的分数变化
      }
    ]
  }
]
4. Page Flow &amp; Requirements (页面逻辑)
Page 1: Home (首页 - 牌局列表)
UI:
Show list of saved games (Name + Date + Player names).
If list is empty, show a placeholder image + "Create New Game" button.
Floating Action Button (FAB): "+" to create a new game.
Interaction:
Click item -&gt; Go to Page 3 (Scoreboard).
Long press item -&gt; Option to Delete game.
Page 2: Create Game (新建牌局)
UI:
Input: "Game Name" (Default: Current Date + "Game").
Selector: "Player Count" (Range: 2 to 6, Default: 4).
Dynamic Inputs: "Player Names" based on count (Default: P1, P2, P3...).
Logic:
On "Start": Initialize the data structure and save to LocalStorage, then redirect to Page 3.
Page 3: Scoreboard (计分看板 - 核心页)
Header:
Grid layout showing current totalScore for each player.
Highlight the winner (highest score) in Red, loser in Green.
Body (List):
Reverse chronological list of rounds (Round 10, Round 9...).
Show specific score changes for that round (e.g., +10 | -5 | -5 | 0).
Delete Function: Allow deleting the last record only (to prevent logic errors).
Footer:
Large Button: "Record Round" -&gt; Opens Page 4.
Page 4: Input Score (记分录入)
UI:
List of players. Each row has: Player Name + Input Field (Number).
Auto-Balance Button: A button next to the last player or at the bottom.
Logic: Calculates 0 - (Sum of other players) and fills the remaining field.
Validation (Strict Zero-Sum):
Before saving, check: Sum(scores) === 0.
If Sum !== 0, show Toast error: "Total score must be 0! Current: +X".
Allow input of 0.
Save:
On success: Update players.totalScore, push to rounds, save to LocalStorage, go back to Page 3.
5. Edge Cases (异常处理)
Input Type: Ensure inputs handle negative numbers (keyboard type usually digit or number allowing -).
Empty Input: Treat empty input as 0.
Data Persistence: Update LocalStorage immediately after every round addition/deletion.
</code></pre>
<p>然后，打开你喜欢的 AI 编辑器（比如 Trae、Cursor），把刚才新建的空项目文件夹拖进去，把这份 Prompt 粘进去，让它开始生成代码</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fb765e33c6840be86d1ab3e73f5a7da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oSP5LmJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768324661&amp;x-signature=raZiGPADyuNJxqLH7L3%2BcRRWqsE%3D" alt="image.png" loading="lazy"/></p>
<p>然后得到了这样的结果。这本来也不是干货博客，这里我们主要看这个prompt和生成的代码。</p>
<blockquote>
<p>你会发现：它生成的代码结构清晰、逻辑严谨、注释到位，甚至考虑了零和校验、本地存储格式、边界输入处理等细节。</p>
</blockquote>
<p>这已经不是“帮我写个功能”了，而是“按生产标准交付一个模块”。</p>
<p>而且说实话——<strong>这份 Prompt，确实比我手写的要好得多</strong>。</p>
<p>我们可以看到：整个过程强调<strong>规矩、专业、流程化</strong>，不再是随意生成，而是以 Spec 为唯一权威源——这就是 <strong>Spec-Driven Development（规范驱动开发，SDD）</strong>  的核心理念：先写清楚“要做什么”，再让各角色围绕规范协同履约。</p>
<p>此时的 Vibe Coding，已接近生产级标准：<strong>可审计、可追溯、可迭代</strong>。AI 不再是第一，第二阶段的prompt抽卡机，而是一支训练有素的虚拟工程团队——你只需担任“<strong>技术负责人</strong>”，把控方向，协调节奏，确保每个 Agent 都在正确的轨道上交付高质量产出。</p>
<h3 data-id="heading-7">这里我要强调一个概念:SDD</h3>
<p><strong>SDD（Spec-Driven Development，规范驱动开发）</strong></p>
<p>是一种以清晰、可执行的规范为起点和唯一权威的开发范式——先写好“合同”，再让代码履约。</p>
<p>在 Vibe Coding 的第三阶段，<strong>SDD 成为核心：AI 不再凭语义的模糊指令自由发挥，而是围绕一份由虚拟产品经理产出的结构化需求文档（Spec.md），依次驱动设计、编码与测试，确保每个环节都严格对齐同一份契约。</strong></p>
<p>和“先写代码再补文档”不同，Spec-Driven 强调代码必须严格满足规范，而不是靠口头理解或临时修改。这样做的好处是：需求更清晰、沟通成本更低、返工更少，也更容易做自动化测试。</p>
<blockquote>
<p>AI 也不再是魔术师，而是一个守规矩的协作者。</p>
</blockquote>
<h2 data-id="heading-8">总结</h2>
<p>整篇博客，我都是以一个普通在校学生的视角，讲了自己怎么从“手敲 CQ 外卖”一步步走到用 Vibe Coding 搞定课程设计的过程。</p>
<p>一开始是被课程设计逼到墙角，偶然看到同学用 Trae 几分钟跑通了我熬一晚上都搞不定的逻辑；后来慢慢发现</p>
<blockquote>
<p>AI 不是用来抄答案的，而是用来放大你的工程思维的。</p>
</blockquote>
<p>而这一切能真正落地的关键，就是 <strong>SDD（Spec-Driven Development）</strong> 。<br/>
它让我明白：未来最有价值的程序员，可能不是写代码最快的那个，而是<strong>能把需求翻译成清晰、可执行规范</strong>的那个人。</p>
<p>Vibe Coding 不是取代我们，而是让我们终于可以像真正的工程师那样工作——不靠蛮力，而靠指挥系统。</p>
<p>而这，或许才是编程本该有的样子。</p>
<p>2025年是Agent 元年，不管下学期我会偷偷跑去哪家公司实习，我都会继续拥抱最前沿的技术。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL 性能调优：从EXPLAIN到JSON索引优化]]></title>    <link>https://juejin.cn/post/7592127014187646976</link>    <guid>https://juejin.cn/post/7592127014187646976</guid>    <pubDate>2026-01-06T19:19:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592127014187646976" data-draft-id="7592094358657204258" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL 性能调优：从EXPLAIN到JSON索引优化"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-06T19:19:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="数据小馒头"/> <meta itemprop="url" content="https://juejin.cn/user/48851852475720"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL 性能调优：从EXPLAIN到JSON索引优化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/48851852475720/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    数据小馒头
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T19:19:50.000Z" title="Tue Jan 06 2026 19:19:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：代码在测试环境跑得飞快，上线就崩？</h2>
<p>很多后端开发者都经历过这样的“至暗时刻”：</p>
<p>功能在开发环境（数据量 &lt; 1万）测试时丝般顺滑，接口响应时间 20ms。一上线到生产环境（数据量 &gt; 500万），同一个接口直接超时（Timeout），甚至把数据库 CPU 拖到 100%，导致整个服务不可用。</p>
<p>通常，这类问题的根源可能在于 <strong>SQL 执行效率低下</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f88a037dff6b4e05829b7e1b1327c1aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5o2u5bCP6aaS5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768331990&amp;x-signature=C%2Bhg3ruujgO9sbV4QtzEbXKI36s%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">第一步：诊断——读懂 EXPLAIN</h2>
<p>当一条 SQL 跑得慢，第一反应不应该是“改代码”，而是“看病”。MySQL 提供的 EXPLAIN 命令就是数据库的 X 光机。</p>
<p>在任何 SQL 语句前加上 EXPLAIN，数据库不会执行它，而是会告诉你：<strong>“如果你让我执行这条语句，我会怎么做。”</strong></p>
<pre><code class="hljs language-ini" lang="ini">EXPLAIN SELECT * FROM t_users WHERE <span class="hljs-attr">phone</span> = <span class="hljs-string">'13800138000'</span><span class="hljs-comment">;</span>
</code></pre>
<p>输出结果中，有两列决定了查询的生死：</p>
<h2 data-id="heading-2">1. type 列：性能的“阶级划分”</h2>
<p>这个字段代表了 MySQL 查找数据的方式。从优到差，性能阶梯如下：</p>
<ul>
<li><strong>system / const</strong>：⚡️ <strong>极快</strong>。直接命中主键或唯一索引，只读一行。</li>
<li><strong>ref</strong>：🚀 <strong>快</strong>。使用了普通索引。</li>
<li><strong>range</strong>：🚗 <strong>还行</strong>。索引范围扫描，常见于 &gt; &lt;、BETWEEN。</li>
<li><strong>index</strong>：🚲 <strong>慢</strong>。虽然用了索引，但扫描了整个索引树（全索引扫描）。</li>
<li><strong>ALL</strong>：🐢 <strong>极慢（死罪）</strong>。全表扫描（Full Table Scan），几百万条数据一条条过。</li>
</ul>
<p><strong>实战准则：</strong> 生产环境的 SQL，至少要达到 <strong>range</strong> 级别，最好是 <strong>ref</strong>。如果是 <strong>ALL</strong>，必须优化。</p>
<h2 data-id="heading-3">2. Extra 列：警惕“副作用”</h2>
<ul>
<li><strong>Using filesort</strong>：⚠️ <strong>危险</strong>。说明数据库没法利用索引顺序，必须在内存或磁盘中进行额外的排序操作。CPU 杀手。</li>
<li><strong>Using temporary</strong>：⚠️ <strong>危险</strong>。创建了临时表来处理查询。常见于 GROUP BY 或 DISTINCT。</li>
</ul>
<h2 data-id="heading-4">第二步：治疗——联合索引的“最左前缀”陷阱</h2>
<p>诊断出 type: ALL 后，最直接的解法是加索引。但索引不是乱加的，尤其是<strong>联合索引（Joint Index）</strong>。</p>
<p>假设我们有一张订单表，建了一个联合索引 idx_a_b_c (company_id, workshop_id, order_status)。</p>
<h2 data-id="heading-5">陷阱：为什么索引失效了？</h2>
<p><strong>场景 1：</strong></p>
<pre><code class="hljs language-ini" lang="ini">SELECT * FROM t_orders WHERE <span class="hljs-attr">company_id</span> = <span class="hljs-number">10</span> AND workshop_id = <span class="hljs-number">5</span><span class="hljs-comment">;</span>
</code></pre>
<p>✅ <strong>索引生效。</strong> 命中了前两个字段。</p>
<p><strong>场景 2：</strong></p>
<pre><code class="hljs language-ini" lang="ini">SELECT * FROM t_orders WHERE <span class="hljs-attr">workshop_id</span> = <span class="hljs-number">5</span><span class="hljs-comment">;</span>
</code></pre>
<p>❌ <strong>索引失效（type: ALL）。</strong> 因为跳过了第一个字段 company_id。</p>
<p><strong>场景 3：</strong></p>
<pre><code class="hljs language-ini" lang="ini">SELECT * FROM t_orders WHERE <span class="hljs-attr">company_id</span> = <span class="hljs-number">10</span> AND order_status = <span class="hljs-string">'DONE'</span><span class="hljs-comment">;</span>
</code></pre>
<p>⚠️ <strong>部分失效。</strong> 只有 company_id 用到了索引，order_status 没用到（因为中间断了 workshop_id）。</p>
<h2 data-id="heading-6">原理解析：电话簿法则</h2>
<p>联合索引就像一本电话簿。它是先按“姓”排序，如果“姓”一样，再按“名”排序。</p>
<ul>
<li>如果你找“姓张”的人（company_id），很快能找到。</li>
<li>但如果你只知道某个人“名伟”（workshop_id），你没法利用目录，只能从第一页翻到最后一页（全表扫描）。</li>
</ul>
<p>这就是著名的**“最左前缀原则” (Leftmost Prefix Principle)**。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0151a7a6f8e4f0cb9ce9e59e1242d7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5o2u5bCP6aaS5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768331990&amp;x-signature=RTAhBnPCaQlvSvH2zhSXya6jvZo%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">第三步：进阶——JSON 字段的性能黑科技</h2>
<p>随着业务灵活性的要求，越来越多的表开始使用 JSON 类型字段来存储非结构化数据（替代繁琐的 EAV 模型）。</p>
<p>但 DBA 往往很反感 JSON，因为：<strong>“JSON 里的 key 没法加索引，查起来太慢！”</strong></p>
<p>比如：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">-- <span class="hljs-keyword">data</span> 字段是 JSON 类型：{<span class="hljs-string">"device_model"</span>: <span class="hljs-string">"iPhone 15"</span>, <span class="hljs-string">"os_ver"</span>: <span class="hljs-string">"17.0"</span>}
SELECT * FROM t_log WHERE <span class="hljs-keyword">data</span>-&gt;<span class="hljs-string">'$.device_model'</span> = <span class="hljs-string">'iPhone 15'</span>;
</code></pre>
<p>在老版本 MySQL 中，这绝对是全表扫描。但在 MySQL 5.7+ 和 8.0 中，我们可以通过“虚拟列 (Virtual Generated Column)”来解决这个问题。</p>
<h2 data-id="heading-8">优化方案：虚拟列索引</h2>
<p>我们不需要修改业务代码，只需在数据库层做两步操作：</p>
<p><strong>1. 创建一个虚拟列，自动提取 JSON 中的字段：</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> t_log 
<span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> v_device_model <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) 
GENERATED ALWAYS <span class="hljs-keyword">AS</span> (data<span class="hljs-operator">-</span><span class="hljs-operator">&gt;&gt;</span><span class="hljs-string">'$.device_model'</span>) VIRTUAL;
</code></pre>
<p>注意：VIRTUAL 关键字表示这个列不占用磁盘空间，它是实时计算的（但开销极小）。</p>
<p><strong>2. 给这个虚拟列加索引：</strong></p>
<pre><code class="hljs language-scss" lang="scss">CREATE INDEX idx_device_model ON <span class="hljs-built_in">t_log</span>(v_device_model);
</code></pre>
<p><strong>3. 见证奇迹：</strong></p>
<p>再次执行查询（既可以查虚拟列，也可以查原 JSON 路径，优化器会自动识别）：</p>
<pre><code class="hljs language-ini" lang="ini">EXPLAIN SELECT * FROM t_log WHERE <span class="hljs-attr">v_device_model</span> = <span class="hljs-string">'iPhone 15'</span><span class="hljs-comment">;</span>
</code></pre>
<p>type 变成了 <strong>ref</strong>。</p>
<p>通过这种“空间换时间”（索引占用空间）的方式，我们将 JSON 内部字段的查询性能提升到了与普通字段相同的水平。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/246646af9729473c95a192244aace951~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5o2u5bCP6aaS5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768331990&amp;x-signature=N9cawtvu%2FiU8bGoKg9YjeCt7qGM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">总结</h2>
<p>数据库性能优化中，80% 的性能问题可以通过规范的 SQL 编写解决：</p>
<ol>
<li><strong>保持敏感：</strong> 开发完 SQL，顺手跑一下 EXPLAIN，消灭所有的 ALL。</li>
<li><strong>遵守规则：</strong> 建立联合索引时，把区分度高、查询最频繁的字段放在最左边。</li>
<li><strong>拥抱新特性：</strong> 在处理 JSON 数据时，善用<strong>虚拟列索引</strong>，兼顾灵活性与性能。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别“For循环”：掌握SQL技巧，让数据处理飞起来]]></title>    <link>https://juejin.cn/post/7592089325912965120</link>    <guid>https://juejin.cn/post/7592089325912965120</guid>    <pubDate>2026-01-06T19:22:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592089325912965120" data-draft-id="7592089325912948736" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别“For循环”：掌握SQL技巧，让数据处理飞起来"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-06T19:22:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="数据小馒头"/> <meta itemprop="url" content="https://juejin.cn/user/48851852475720"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别“For循环”：掌握SQL技巧，让数据处理飞起来
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/48851852475720/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    数据小馒头
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T19:22:43.000Z" title="Tue Jan 06 2026 19:22:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：别把数据库只当硬盘用</h2>
<p>在代码审查（Code Review）中，我们经常看到这样的反模式：</p>
<p>为了统计“每个部门薪资最高的前 3 名”，开发者写了一条 SELECT * FROM employee 把几万条数据全部拉到内存中，然后在 Java/Python 代码里写嵌套循环、Map 分组、排序、截取。</p>
<p>这种“数据库只负责存，应用层负责算”的做法，在数据量小的时候尚可，一旦数据量上万，不仅造成网络 I/O 拥堵，还容易导致应用服务器 OOM（内存溢出）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/689343015f794bb7bc7f0972ec4cc211~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5o2u5bCP6aaS5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768332163&amp;x-signature=bAmogBRsht6%2Bdfo9wyt0RuTMlRs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">一：一行代码搞定“分组排名” —— 窗口函数</h2>
<p>场景需求：</p>
<p>找出每个班级（class_id）中，数学成绩（score）最高的前 3 名学生。</p>
<p>低效解法（应用层）：</p>
<p>查询所有数据 -&gt; 内存中按 class_id 分组 -&gt; 对每组 List 进行 Sort -&gt; 取 subList(0, 3)。</p>
<p>SQL 解法：</p>
<p>使用窗口函数 DENSE_RANK() 或 ROW_NUMBER()。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> (
    <span class="hljs-keyword">SELECT</span> 
        student_name,
        class_id,
        score,
        <span class="hljs-comment">-- 核心逻辑：按班级分区，按成绩降序，生成排名</span>
        <span class="hljs-built_in">DENSE_RANK</span>() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> class_id <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> score <span class="hljs-keyword">DESC</span>) <span class="hljs-keyword">as</span> ranking
    <span class="hljs-keyword">FROM</span> t_scores
) t
<span class="hljs-keyword">WHERE</span> t.ranking <span class="hljs-operator">&lt;=</span> <span class="hljs-number">3</span>;
</code></pre>
<p>解析：</p>
<p>OVER (PARTITION BY ... ORDER BY ...) 语法定义了一个“窗口”。数据库会在这个窗口范围内进行计算，而不是对全表聚合。</p>
<ul>
<li><strong>ROW_NUMBER()</strong>：强制排名，1, 2, 3, 4（即使分数一样，名次也不同）。</li>
<li><strong>RANK()</strong>：跳跃排名，1, 1, 3, 4（分数一样并列第一，第三名空缺）。</li>
<li><strong>DENSE_RANK()</strong>：连续排名，1, 1, 2, 3（分数一样并列第一，且不占用后续名次）。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30e2a3810d1541ed8d20a3fb76ed46ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5o2u5bCP6aaS5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768332163&amp;x-signature=Lvz24BoMtBSgs7uDsOpzG5D1Fo8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">二：告别递归调用 —— CTE 处理无限层级数据</h2>
<p>场景需求：</p>
<p>一张菜单表 t_menus，包含 id 和 parent_id。需要查出“系统设置”节点下的所有子菜单（包括子菜单的子菜单...），构建树形结构。</p>
<p><strong>低效解法（递归查询）：</strong></p>
<ol>
<li>查出 id=1（系统设置）。</li>
<li>循环查 parent_id=1 的子节点。</li>
<li>对每个子节点，再查其子节点...</li>
<li>这是典型的 N+1 查询问题，与数据库交互次数过多，网络延迟极高。</li>
</ol>
<p>SQL 解法：</p>
<p>使用 CTE（Common Table Expressions） 的递归语法 WITH RECURSIVE。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> menu_tree <span class="hljs-keyword">AS</span> (
    <span class="hljs-comment">-- 1. 锚点成员 (Anchor Member)：查询根节点</span>
    <span class="hljs-keyword">SELECT</span> id, name, parent_id, <span class="hljs-number">1</span> <span class="hljs-keyword">as</span> depth
    <span class="hljs-keyword">FROM</span> t_menus
    <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">100</span> <span class="hljs-comment">-- 假设 100 是“系统设置”的 ID</span>
    
    <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
    
    <span class="hljs-comment">-- 2. 递归成员 (Recursive Member)：基于上一轮的结果继续查</span>
    <span class="hljs-keyword">SELECT</span> t.id, t.name, t.parent_id, mt.depth <span class="hljs-operator">+</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">FROM</span> t_menus t
    <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> menu_tree mt <span class="hljs-keyword">ON</span> t.parent_id <span class="hljs-operator">=</span> mt.id
)
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> menu_tree;
</code></pre>
<p><strong>解析：</strong></p>
<p>数据库引擎在内部维护了一个临时表。第一部分（Anchor）先放入初始数据；第二部分（Recursive）引用这个临时表，不断把符合 JOIN 条件的新数据追加进来，直到没有新数据产生为止。整个过程只与数据库交互一次。</p>
<h2 data-id="heading-3">三：优雅的数据清洗 —— 高效去重 (Dedup)</h2>
<p>场景需求：</p>
<p>由于程序 Bug，t_orders 表中出现了重复订单（order_no 相同），保留 create_time 最近的一条，删除其余重复项。</p>
<p>低效解法（自连接）：</p>
<p>使用 DELETE 配合 NOT IN (SELECT MAX(id)...)。这种写法在数据量大时，极易造成死锁或超时。</p>
<p>SQL 解法：</p>
<p>利用窗口函数给重复行打标，然后根据标记删除。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">DELETE</span> t1 <span class="hljs-keyword">FROM</span> t_orders t1
<span class="hljs-keyword">JOIN</span> (
    <span class="hljs-keyword">SELECT</span> 
        id, 
        <span class="hljs-comment">-- 按订单号分组，按时间降序排列，行号为 1 的即为最新数据</span>
        <span class="hljs-built_in">ROW_NUMBER</span>() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> order_no <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> create_time <span class="hljs-keyword">DESC</span>) <span class="hljs-keyword">as</span> rn
    <span class="hljs-keyword">FROM</span> t_orders
) t2 <span class="hljs-keyword">ON</span> t1.id <span class="hljs-operator">=</span> t2.id
<span class="hljs-keyword">WHERE</span> t2.rn <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span>; <span class="hljs-comment">-- 删除行号大于 1 的（即旧数据）</span>
</code></pre>
<p>解析：</p>
<p>这种方式避免了复杂的 GROUP BY 子查询，逻辑清晰且执行效率更高。它首先在内存中计算出每一行的“留存优先级”（即 rn），然后利用 JOIN 精准定位需要删除的行 ID。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95ae8ad2074c4316af60fc421664f2cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5o2u5bCP6aaS5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768332163&amp;x-signature=43OEFyRpFZ5%2Bi6ibK9%2F5bMZXm0o%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">总结</h2>
<p>SQL 不仅仅是存储数据的仓库，它更是一个高性能的<strong>集合计算引擎</strong>。</p>
<p>在 MySQL 8.0 等现代数据库中：</p>
<ol>
<li>遇到“分组取 Top N”<strong>或</strong>“累计统计”，请优先想到 <strong>窗口函数</strong>。</li>
<li>遇到“树形结构”<strong>或</strong>“层级遍历”，请优先想到 <strong>CTE 递归</strong>。</li>
<li>遇到“复杂去重”，请优先想到 <strong>ROW_NUMBER()</strong>。</li>
</ol>
<p>将计算下推（Push Down）到数据库层，不仅能大幅减少网络传输量，还能让你的后端代码变得干净、清爽。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[DataBinding的使用]]></title>    <link>https://juejin.cn/post/7592094358657712162</link>    <guid>https://juejin.cn/post/7592094358657712162</guid>    <pubDate>2026-01-07T01:50:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592094358657712162" data-draft-id="7592089325913210880" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="DataBinding的使用"/> <meta itemprop="keywords" content="Android Jetpack"/> <meta itemprop="datePublished" content="2026-01-07T01:50:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="XRay"/> <meta itemprop="url" content="https://juejin.cn/user/3966693685869288"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            DataBinding的使用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3966693685869288/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    XRay
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T01:50:35.000Z" title="Wed Jan 07 2026 01:50:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">什么是 DataBinding</h2>
<p>DataBinding 是一个让你可以把布局和数据绑定起来的库，我们可以通过 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Ftopic%2Flibraries%2Fdata-binding" target="_blank" title="https://developer.android.com/topic/libraries/data-binding" ref="nofollow noopener noreferrer">官方文档</a> 来学习如何使用 DataBinding。</p>
<p>我们一般通过这种方式给 UI 设置数据：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">TextView</span> <span class="hljs-variable">textView</span> <span class="hljs-operator">=</span> findViewById(R.id.sample_text);
<span class="hljs-keyword">if</span>(textView != <span class="hljs-literal">null</span> &amp;&amp; user != <span class="hljs-literal">null</span>){
    textView.setText(user.getName());
}
</code></pre>
<p>使用 DataBinding 后，上面这些代码都不需要写了，直接通过配置布局文件就可以实现上面代码的功能，注意下面的<code>@{}</code>语法。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">TextView</span>
    <span class="hljs-attr">android:text</span>=<span class="hljs-string">"@{user.name}"</span> /&gt;</span>
</code></pre>
<p>使用 DataBinding 的好处：</p>
<ul>
<li>
<ol>
<li>findViewById、setText 这些代码都不用写了，代码更容易维护。</li>
</ol>
</li>
<li>
<ol start="2">
<li>textView 的空检查不需要了，因为绑定的逻辑写在 textView 的布局上，所以不存在 textView 为 null 的问题；user 的空检查也不需要了，如果 user 为 null，user.name 就会被分配默认值 null。</li>
</ol>
</li>
<li>
<ol start="3">
<li>数据更新的时候不再需要重复调用 setText 了。</li>
</ol>
</li>
</ul>
<h2 data-id="heading-1">如何使用</h2>
<p>使用 DataBinding 之前记得在 build.gradle 中启用 DataBinding：</p>
<pre><code class="hljs language-arduino" lang="arduino">android {
    ...
    buildFeatures {
        dataBinding <span class="hljs-literal">true</span>
    }
}
</code></pre>
<p>在想要使用 DataBinding 的布局的根布局上右键，选择 Show Context Actions，然后选择 Convert to data binding layout。</p>
<p>这里我们实现一个显示学生信息列表的功能，此外还包含两个按钮，一个用于添加学生，一个用于删除学生。</p>
<p>activity_main.xml:</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">layout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">data</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">variable</span>
            <span class="hljs-attr">name</span>=<span class="hljs-string">"clickPresenter"</span>
            <span class="hljs-attr">type</span>=<span class="hljs-string">"com.example.test.MainActivity.ClickPresenter"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">data</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span>
        <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">"vertical"</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
            <span class="hljs-attr">android:text</span>=<span class="hljs-string">"添加学生"</span>
            <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span>
            <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
            <span class="hljs-attr">android:onClick</span>=<span class="hljs-string">"@{clickPresenter::addStudent}"</span>/&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
            <span class="hljs-attr">android:text</span>=<span class="hljs-string">"删除学生"</span>
            <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span>
            <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
            <span class="hljs-attr">android:onClick</span>=<span class="hljs-string">"@{clickPresenter::removeStudent}"</span>/&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">androidx.recyclerview.widget.RecyclerView</span>
            <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/rv_student_list"</span>
            <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
            <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span> /&gt;</span>

    <span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">layout</span>&gt;</span>
</code></pre>
<p>在 activity_main.xml 中配置添加学生和删除学生按钮分别调用 ClickPresenter 中的 addStudent() 和 removeStudent() 方法。</p>
<p>MainActivity 中的代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {

    <span class="hljs-keyword">private</span> StudentListAdapter mStudentListAdapter;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> {
        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
        <span class="hljs-type">ActivityMainBinding</span> <span class="hljs-variable">mActivityMainBinding</span> <span class="hljs-operator">=</span> DataBindingUtil.setContentView(<span class="hljs-built_in">this</span>, R.layout.activity_main);

        mActivityMainBinding.rvStudentList.setLayoutManager(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LinearLayoutManager</span>(<span class="hljs-built_in">this</span>, RecyclerView.VERTICAL, <span class="hljs-literal">false</span>));
        mStudentListAdapter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StudentListAdapter</span>(getStudentList());
        mActivityMainBinding.rvStudentList.setAdapter(mStudentListAdapter);

        mActivityMainBinding.setClickPresenter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClickPresenter</span>());
    }


    <span class="hljs-keyword">private</span> List&lt;Student&gt; <span class="hljs-title function_">getStudentList</span><span class="hljs-params">()</span> {
        List&lt;Student&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        list.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(<span class="hljs-string">"小明"</span>,<span class="hljs-string">"001"</span>));
        list.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(<span class="hljs-string">"小红"</span>,<span class="hljs-string">"002"</span>));
        list.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(<span class="hljs-string">"小刚"</span>,<span class="hljs-string">"003"</span>));
        list.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(<span class="hljs-string">"小强"</span>,<span class="hljs-string">"004"</span>));
        <span class="hljs-keyword">return</span> list;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClickPresenter</span> {

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addStudent</span><span class="hljs-params">(View view)</span> {
            Toast.makeText(MainActivity.<span class="hljs-built_in">this</span>, <span class="hljs-string">"addUser"</span>, Toast.LENGTH_SHORT).show();
            mStudentListAdapter.addData(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(<span class="hljs-string">"小张"</span>,<span class="hljs-string">"005"</span>));
            mStudentListAdapter.notifyDataSetChanged();
        }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeStudent</span><span class="hljs-params">(View view)</span> {
            Toast.makeText(MainActivity.<span class="hljs-built_in">this</span>, <span class="hljs-string">"removeUser"</span>, Toast.LENGTH_SHORT).show();
            <span class="hljs-keyword">if</span>(mStudentListAdapter.getItemCount() &gt; <span class="hljs-number">0</span>){
                mStudentListAdapter.remove(<span class="hljs-number">0</span>);
                mStudentListAdapter.notifyDataSetChanged();
            }
        }
    }
}
</code></pre>
<p>在 MainActivity 中使用 DataBindingUtil 的 setContentView() 方法绑定了上面的布局文件并对 ClickPresenter 中的方法进行了实现。</p>
<p>Student 类的代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseObservable</span> {
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> String id;
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">(String name, String id)</span> {
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-meta">@Bindable</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> name;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-built_in">this</span>.name = name;
        notifyPropertyChanged(BR.name);
    }

    <span class="hljs-meta">@Bindable</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(String id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
        notifyPropertyChanged(BR.id);
    }
}
</code></pre>
<p>展示学生信息对应的布局文件为：item_student.xml</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">layout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">data</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">variable</span>
            <span class="hljs-attr">name</span>=<span class="hljs-string">"student"</span>
            <span class="hljs-attr">type</span>=<span class="hljs-string">"com.example.test.Student"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">data</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span>
        <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">"horizontal"</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"50dp"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span>
            <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span>
            <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
            <span class="hljs-attr">android:text</span>=<span class="hljs-string">"@{student.id}"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span>
            <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span>
            <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
            <span class="hljs-attr">android:text</span>=<span class="hljs-string">"@{student.name}"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">layout</span>&gt;</span>
</code></pre>
<p>RecyclerView 还需要结合 Adapter 来展示列表信息，代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentListAdapter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RecyclerView</span>.Adapter&lt;StudentListAdapter.StudentItemViewHolder&gt; {

    <span class="hljs-keyword">private</span> List&lt;Student&gt; mStudentList;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">StudentListAdapter</span><span class="hljs-params">(List&lt;Student&gt; list)</span> {
        mStudentList = list;
    }

    <span class="hljs-meta">@NonNull</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> StudentItemViewHolder <span class="hljs-title function_">onCreateViewHolder</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> ViewGroup parent, <span class="hljs-type">int</span> viewType)</span> {
        <span class="hljs-type">View</span> <span class="hljs-variable">view</span> <span class="hljs-operator">=</span> LayoutInflater.from(parent.getContext()).inflate(R.layout.item_student, <span class="hljs-literal">null</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StudentItemViewHolder</span>(view);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onBindViewHolder</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> StudentItemViewHolder holder, <span class="hljs-type">int</span> position)</span> {
        holder.getItemStudentBinding().setStudent(mStudentList.get(position));
        holder.getItemStudentBinding().executePendingBindings();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getItemCount</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> mStudentList.size();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addData</span><span class="hljs-params">(Student student)</span> {
        mStudentList.add(student);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">remove</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span> {
        mStudentList.remove(index);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentItemViewHolder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RecyclerView</span>.ViewHolder {

        <span class="hljs-keyword">private</span> ItemStudentBinding binding;

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">StudentItemViewHolder</span><span class="hljs-params">(View itemView)</span> {
            <span class="hljs-built_in">super</span>(itemView);
            binding = DataBindingUtil.bind(itemView);
        }

        <span class="hljs-keyword">public</span> ItemStudentBinding <span class="hljs-title function_">getItemStudentBinding</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> binding;
        }
    }
}
</code></pre>
<p>在 StudentItemViewHolder 中使用 DataBindingUtil 的 bind() 方法来绑定列表的 item 布局，并返回 ItemStudentBinding 实例，这样 StudentItemViewHolder 持有 ItemStudentBinding 实例就行了，不需要持有里面的每一个 View 了，同时省略了 findViewById 的代码。在 StudentListAdapter 中也不需要分别给 item 中的控件设值了，直接调用 ItemStudentBinding 实例的 setStudent() 即可。</p>
<h2 data-id="heading-2">Binding Adapters</h2>
<p>现在要显示学生头像，我想用 Glide，头像来源于图片链接，同时还需要提供占位图。由于没办法直接在 ImageView 布局中配置图片链接和占位图，使用 DataBinding 该如何实现？</p>
<p>这时候就可以使用 BindingAdapter，添加如下代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommonUtils</span> {

    <span class="hljs-meta">@BindingAdapter({"app:imageUrl", "app:placeHolder"})</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadImageFromUri</span><span class="hljs-params">(ImageView imageView, String imageUri, Drawable placeHolder)</span> {
        Glide.with(imageView.getContext())
                .load(imageUri)
                .placeholder(placeHolder)
                .into(imageView);
    }
}
</code></pre>
<p>然后就可以直接在 ImageView 的布局中配置 imageUrl 和 placeHolder 了：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ImageView</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
    <span class="hljs-attr">app:imageUrl</span>=<span class="hljs-string">"@{student.url}"</span>
    <span class="hljs-attr">app:placeHolder</span>=<span class="hljs-string">"@{@drawable/student_icon}"</span>/&gt;</span>
</code></pre>
<p>这样只要配置了 imageUrl 和 placeHolder，注解 @BindingAdapter 对应的方法就会被调用。如果你希望配置了 imageUrl 和 placeHolder 中的某一个，就调用该方法，需要添加
requireAll = false，代码如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@BindingAdapter({<span class="hljs-string">"app:imageUrl"</span>, <span class="hljs-string">"app:placeHolder"</span>}, requireAll = false)</span>
</code></pre>
<h2 data-id="heading-3">结合 LiveData</h2>
<p>前面 variable 中的 Student 类必须要继承 BaseObservable 或使用 ObservableField，还要添加注解 @Bindable、调用notifyPropertyChanged(BR.name)，目的是为了在 student.setName(name) 时通知对应的 View 更新。</p>
<p>现在有了 LiveData，LiveData 使用数据驱动，可以不需要使用 BaseObservable 或 ObservableField 了，并且还可以自动管理生命周期，避免内存泄漏。代码如下：</p>
<pre><code class="hljs language-xml" lang="xml">// student.xml
<span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">layout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">xmlns:app</span>=<span class="hljs-string">"http://schemas.android.com/apk/res-auto"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">data</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">variable</span>
            <span class="hljs-attr">name</span>=<span class="hljs-string">"viewmodel"</span>
            <span class="hljs-attr">type</span>=<span class="hljs-string">"com.example.test.ScheduleViewModel"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">data</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span>
            <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span>
            <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
            <span class="hljs-attr">android:text</span>=<span class="hljs-string">"@{viewmodel.studentname}"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">layout</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-kt" lang="kt"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewModelActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)

        <span class="hljs-keyword">val</span> binding: StudentBinding = DataBindingUtil.setContentView(<span class="hljs-keyword">this</span>, R.layout.student)
        binding.lifecycleOwner = <span class="hljs-keyword">this</span>

        binding.viewmodel = ViewModelProvider(<span class="hljs-keyword">this</span>)[ScheduleViewModel::<span class="hljs-keyword">class</span>.java]
    }
}
</code></pre>
<pre><code class="hljs language-kt" lang="kt"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ScheduleViewModel</span> : <span class="hljs-type">ViewModel</span>() {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _studentname = MutableStateFlow(<span class="hljs-string">""</span>)

    <span class="hljs-keyword">val</span> studentname: StateFlow&lt;String&gt; = _studentname

    <span class="hljs-keyword">init</span> {
        viewModelScope.launch {
            delay(<span class="hljs-number">5000</span>)
            _studentname.value = <span class="hljs-string">"小王"</span>
        }
    }
}
</code></pre>
<p>可以看到不需要调用 LiveData 的 <strong>observe(owner，observer)</strong> 了，DataBinding 帮我们完成了数据驱动。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C# 斩获TIOBE年度编程语言]]></title>    <link>https://juejin.cn/post/7592119218030329890</link>    <guid>https://juejin.cn/post/7592119218030329890</guid>    <pubDate>2026-01-07T01:52:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592119218030329890" data-draft-id="7592089325913030656" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C# 斩获TIOBE年度编程语言"/> <meta itemprop="keywords" content="C#,编程语言"/> <meta itemprop="datePublished" content="2026-01-07T01:52:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RockByte"/> <meta itemprop="url" content="https://juejin.cn/user/1046390797768519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C# 斩获TIOBE年度编程语言
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390797768519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RockByte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T01:52:02.000Z" title="Wed Jan 07 2026 01:52:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c4f2c1f733c4019bab12e41decce268~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768355521&amp;x-signature=EW8fqERcd4XxD604sHcUMD4aGwQ%3D" alt="0.webp" loading="lazy"/></p>
<p>微软的 <strong>C#</strong> 在三年内第二次获得了 <strong>TIOBE</strong> 编程语言指数的“年度语言”称号，其在该公司编程语言流行度指数中的年度排名增幅为最大。同时，<strong>TIOBE</strong> 首席执行 <em>Paul Jansen</em> 表示，微软的另一门语言 <strong>TypeScript</strong> 今年可能跻身该指数的前20名。</p>
<p><strong>TIOBE</strong> 于1月4日宣布 <strong>C#</strong> 为2025年度语言。</p>
<p>本月（2026年一月） <strong>C#</strong> 的评级为7.39%，排名第五，同比上升了2.94个百分点。</p>
<p><strong>C#</strong> 获奖是意料之中的——它也曾是2023年的 <strong>TIOBE</strong> 年度语言。“从语言设计的角度来看，<strong>C#</strong> 在主流语言中往往是新趋势的早期采用者，”</p>
<p><em>Paul Jansen</em> 在2026年1月指数的附言中写道，“同时，它成功完成了两次重大范式转变：从仅支持 <strong>Windows</strong> 转向跨平台，从微软私有转向开源。<strong>C#</strong> 总能在恰当的时机持续演进。”</p>
<p>他还补充称，自己曾预计 <strong>C#</strong> 会在商业软件市场中取代 <strong>Java</strong> 占据主导地位，但目前这场竞争仍无定论。“<strong>Java</strong> 的风格冗长、样板代码繁多，且归甲骨文所有，它能否继续压制 <strong>C#</strong> 仍是个未知数，”</p>
<p><em>Jansen</em> 表示。本月的指数中，<strong>Java</strong> 以8.71%的评级排名第三，仅次于 <strong>Python</strong> 和 <strong>C</strong>。</p>
<p><em>Paul Jansen</em> 在附言的结尾预测了 <strong>TypeScript</strong> 的前景——这是微软推出的带类型语法的 <strong>JavaScript</strong>。“我向来不太擅长预测，但我猜测 <strong>TypeScript</strong> 最终会闯入前20名，”</p>
<p>该语言目前排名第32位。“我认为 <strong>TypeScript</strong> 会增长的原因是，如今很多前端软件（用户界面）都用<strong>TypeScript</strong> 而非 <strong>JavaScript</strong>编写，”</p>
<p>他解释道，“<strong>TypeScript</strong> 相对于<strong>JavaScript</strong> 的优势在于它是类型安全的。如果开发者正确使用 <strong>TypeScript</strong>，就很难‘搬起石头砸自己的脚’。采用 <strong>TypeScript</strong> 没有任何风险，因为它会编译成 <strong>JavaScript</strong>——所以要是不喜欢<strong>TypeScript</strong>，随时可以转回 <strong>JavaScript</strong>。”</p>
<p><strong>TIOBE</strong> 月度指数评级基于一套公式，评估全球范围内熟练工程师的数量、相关课程及第三方供应商情况。<strong>谷歌</strong>、<strong>亚马逊</strong>、<strong>维基百科</strong>、<strong>必应</strong> 等20多个热门网站的数据会被用于计算评级。</p>
<p><em>Jansen</em> 表示，在2026年1月的指数中，<strong>Go</strong> 似乎已在去年永久跌出了前10名；<strong>Ruby</strong> 的情况类似，它已跌出前20名，且短期内不太可能回归。但 <strong>Perl</strong> 出现了出人意料的复苏：从2025年1月的第32位升至年末的第11位。另一门回暖的语言是 <strong>R</strong>，它在2025年重回前10名，这主要得益于数据科学和统计计算领域的持续增长。</p>
<p>（<strong>TIOBE</strong> 2026年1月指数前10名）</p>
<ol>
<li>
<p><strong>Python</strong>，22.61%</p>
</li>
<li>
<p><strong>C</strong>，10.99%</p>
</li>
<li>
<p><strong>Java</strong>，8.71%</p>
</li>
<li>
<p><strong>C++</strong> ，8.67%</p>
</li>
<li>
<p><strong>C#</strong> ，7.39%</p>
</li>
<li>
<p><strong>JavaScript</strong>，3.03%</p>
</li>
<li>
<p><strong>Visual Basic</strong>，2.41%</p>
</li>
<li>
<p><strong>SQL</strong>，2.27%</p>
</li>
<li>
<p><strong>Delphi/Object Pascal</strong>，1.98%</p>
</li>
<li>
<p><strong>R</strong>，1.82%</p>
</li>
</ol>
<p>另一项“<strong>PyPL</strong> 编程语言流行度指数”则基于 <strong>谷歌</strong> 上语言教程的搜索频率来评估流行度。</p>
<p>（2026年1月 <strong>PyPL</strong> 指数前10名）</p>
<ol>
<li>
<p><strong>Python</strong>，24.61%</p>
</li>
<li>
<p><strong>C/C++</strong> ，14.13%</p>
</li>
<li>
<p><strong>Objective-C</strong>，13.35%</p>
</li>
<li>
<p><strong>Java</strong>，10.45%</p>
</li>
<li>
<p><strong>R</strong>，6.18%</p>
</li>
<li>
<p><strong>JavaScript</strong>，4.68%</p>
</li>
<li>
<p><strong>Swift</strong>，3.68%</p>
</li>
<li>
<p><strong>PHP</strong>，2.95%</p>
</li>
<li>
<p><strong>C#</strong> ，2.79%</p>
</li>
<li>
<p><strong>Ada</strong>，2.71%</p>
</li>
</ol>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.infoworld.com%2Farticle%2F4112993%2Fc-wins-tiobe-programming-language-of-the-year-honors-for-2025.html" target="_blank" title="https://www.infoworld.com/article/4112993/c-wins-tiobe-programming-language-of-the-year-honors-for-2025.html" ref="nofollow noopener noreferrer">C# wins Tiobe Programming Language of the Year honors for 2025</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2026开年第一炸！陈天桥携代季峰发布 MiroThinker 1.5：30B参数跑出 1T 性能，搜索智能体天花板来了]]></title>    <link>https://juejin.cn/post/7592127014188138496</link>    <guid>https://juejin.cn/post/7592127014188138496</guid>    <pubDate>2026-01-07T01:57:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592127014188138496" data-draft-id="7592089325913341952" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2026开年第一炸！陈天桥携代季峰发布 MiroThinker 1.5：30B参数跑出 1T 性能，搜索智能体天花板来了"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-07T01:57:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="青梅主码"/> <meta itemprop="url" content="https://juejin.cn/user/2277843825604222"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2026开年第一炸！陈天桥携代季峰发布 MiroThinker 1.5：30B参数跑出 1T 性能，搜索智能体天花板来了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2277843825604222/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    青梅主码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T01:57:55.000Z" title="Wed Jan 07 2026 01:57:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你好，我是<strong>杰哥</strong>。</p>
<p>2026 年才刚开始两天，<strong>AI</strong> 圈就迎来一记重磅炸弹！</p>
<p>由盛大创始人、创新企业家<strong>陈天桥</strong>与清华大学知名 AI 学者<strong>代季峰</strong>联合发起的 <strong>MiroMind</strong> 团队，正式发布了自研旗舰搜索智能体模型 <strong>MiroThinker 1.5</strong>。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5684d400bee499ba32ac34bd64c5a7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S5qKF5Li756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768355875&amp;x-signature=%2BrH9d1mUukv5LTvQddwC5Rp6qWM%3D" alt="" loading="lazy"/></p>
<p>最亮眼的数据是：<strong>30B参数版本，用仅 1/30的参数规模，就跑出了比肩 1T 参数模型的性能</strong>！<strong>235B</strong>版本更是在多个搜索智能体基准上，直接跻身全球第一梯队。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fa5b131c2dc4389a90a2c8626868822~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S5qKF5Li756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768355875&amp;x-signature=leKPh%2BBik7dPMgf%2FPRE97Ax2iZQ%3D" alt="" loading="lazy"/></p>
<p>这不是简单的“堆参数”，而是开创了一种全新的智能范式——<strong>发现式智能</strong>。</p>
<p>今天我们就来深度聊聊这款模型，看看它到底有多强！</p>
<h2 data-id="heading-0">陈天桥的“发现式智能”终于落地</h2>
<p>熟悉<strong>陈天桥</strong>的朋友都知道，他这些年 All in 脑科学和 AI 领域。2025 年，他就提出了“<strong>发现式智能</strong>”的理念：<strong>真正的智能不是“全知全能”的做题家，而是像科学家一样，会主动求证、验证、修正</strong>。</p>
<p>这次 <strong>MiroThinker 1.5</strong>，正是这个理念的完美落地。</p>
<p>团队强调，传统 <strong>Scaling Law</strong> 只盯着参数和数据量，但他们发现了第三维度—— <strong>Interactive Scaling</strong>：通过模型与外部环境（搜索引擎、工具）的深度交互，来指数级放大智能。</p>
<p>简单说，<strong>就是让模型“更勤快地动动手”，而不是只“长更大的脑子”</strong>。</p>
<h2 data-id="heading-1">硬核数据说话：基准霸榜，成本碾压</h2>
<p>来看成绩单：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ecafd7b18284ae4add5c0878c9545c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S5qKF5Li756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768355875&amp;x-signature=5aLKps6YknL%2Bs3pfFOi9h7TpFsE%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>BrowseComp（网页检索类大模型基准测试）</strong>：69.8%，刷新 <strong>ChatGPT-Agent</strong> 纪录</li>
<li><strong>BrowseComp-ZH（BrowseComp的中文适配版本）</strong>：71.5%</li>
<li><strong>GAIA-Val-165（GAIA基准测试验证集）</strong>：80.8%</li>
<li><strong>HLE-Text（人类终极测试）</strong>：39.2%</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ebf59573ede40f4a69a8e09f7a31a46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S5qKF5Li756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768355875&amp;x-signature=dLReiSq22uZLo3EsB38PtsFLb%2Bk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/249878e5c9684e509645a8d2814046b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S5qKF5Li756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768355875&amp;x-signature=JH%2FNRpJ8g%2FRJCfJH1qibqS%2BT4iA%3D" alt="" loading="lazy"/></p>
<p>这些成绩，已经和 <strong>GPT-5-High、Gemini-3-Pro、DeepSeek-V3.2</strong> 等顶尖闭源模型不相上下。</p>
<p>更狠的是，和 <strong>1T</strong> 参数的 <strong>Kimi-K2-Thinking</strong> 对比：</p>
<ul>
<li><strong>BrowseComp-ZH</strong>上领先 <strong>4.5%</strong></li>
<li>单条调用成本仅 <strong>$0.07</strong>（<strong>Kimi的1/20</strong>）</li>
<li>推理速度大幅领先</li>
</ul>
<p>这性价比，直接起飞！</p>
<h2 data-id="heading-2">技术亮点：不只是会答题，会“研究”</h2>
<p><strong>MiroThinker 1.5</strong> 的核心能力有几大杀手锏：</p>
<ol>
<li><strong>Evidence-Seeking</strong>：把问题拆成可验证的假设，主动上网求证</li>
<li><strong>Iterative Verification</strong>：多轮校验、自我修正，避免错误累积</li>
<li><strong>Anti-Hallucination</strong>：没有证据的推理直接过滤，说不出就说“不知道”</li>
<li><strong>时序敏感训练</strong>：专治“未来信息泄露”，预测更靠谱</li>
</ol>
<p>模型最高支持 <strong>400~600</strong> 次工具调用，真正做到了“像科学家一样思考”。</p>
<h2 data-id="heading-3">亲测体验：两分钟预测世界杯，逻辑严谨到起鸡皮疙瘩</h2>
<p>我第一时间去官网（<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fdr.miromind.ai%2F" target="_blank" title="https://dr.miromind.ai/" ref="nofollow noopener noreferrer">dr.miromind.ai/</a></strong> ）试用了专业模式，感觉太惊艳了！</p>
<p><strong>测试1：2026世界杯冠军预测</strong></p>
<p>我问：“<strong>2026世界杯谁夺冠概率最高？给出详细分析。</strong>”</p>
<p>模型不到两分钟，就给出了完整报告：</p>
<ul>
<li>先梳理参赛球队实力、近期战绩</li>
<li>分析主场优势（北美三国联合举办）</li>
<li>结合状态、实力、体系完整性等因素</li>
<li>最终给出概率排名：西班牙&gt; 英格兰&gt;法国&gt;巴西 &gt; 阿根廷 &gt; 法国 &gt; 德国…</li>
<li>每一步都有来源链接和因果链</li>
</ul>
<p>对比其他模型，<strong>MiroThinker</strong> 的回答最完整、最有风险提示，完全不像“胡猜”。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee4abc4100dd4459b931e13a81a4c09d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S5qKF5Li756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768355875&amp;x-signature=QgJ%2BlA1s3u33GpUKVOhcThmR7FU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e83d82dc0976402fa91cf3d75e4de8b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S5qKF5Li756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768355875&amp;x-signature=0qcgsoJtGy0ObnvKbgSh7KMhev4%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b4f692a4952485bbe962be70b7255a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S5qKF5Li756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768355875&amp;x-signature=GYqSMd1t1JD3rAQaT7EsCLc8Kws%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1022768da2d747dfb1cf4a546a58e358~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S5qKF5Li756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768355875&amp;x-signature=v%2Bk9fqHgBK1ocRR2ZWwpuh3xfcA%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a243f9b228184eb0816c0761b29ac4f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S5qKF5Li756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768355875&amp;x-signature=%2FhlHO1Z0ARdyPS5a%2FXr%2BDk1AZz8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3c61b39c4e94e278ffa5d4d0efd05a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S5qKF5Li756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768355875&amp;x-signature=AxB8l0nzSgV4TBn%2B%2BuCxK4o9Ouo%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8135f98b49854dbba1cb471092547ca9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S5qKF5Li756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768355875&amp;x-signature=jzOPkzudbRZCWv1hGouPTnC7pQA%3D" alt="" loading="lazy"/></p>
<p><strong>测试2：简单股市问题</strong></p>
<p>问某只热门股票短期走势，它会主动查最新新闻、财报、盘前数据，给出多空理由，而不是瞎编。</p>
<p>总之，用完最大的感受就是：<strong>又快考虑又全面，这才是真正的深度“思考”模型！</strong></p>
<h2 data-id="heading-4">开源+低门槛，开发者福音</h2>
<p>最良心的是：<strong>上线即开源</strong>！</p>
<ul>
<li>
<p><strong>模型权重</strong>：Hugging Face <a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fmiromind-ai%2FMiroThinker-v1.5-235B" target="_blank" title="https://huggingface.co/miromind-ai/MiroThinker-v1.5-235B" ref="nofollow noopener noreferrer">huggingface.co/miromind-ai…</a></p>
</li>
<li>
<p><strong>代码框架</strong>：GitHub <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMiroMindAI%2FMiroThinker" target="_blank" title="https://github.com/MiroMindAI/MiroThinker" ref="nofollow noopener noreferrer">github.com/MiroMindAI/…</a></p>
</li>
<li>
<p>还有 MiroFlow 开源框架</p>
</li>
</ul>
<p>想自己部署的同学，直接冲！</p>
<p>社群也很活跃：</p>
<ul>
<li><strong>Discord</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscord.gg%2FF7EQFnYscV" target="_blank" title="https://discord.gg/F7EQFnYscV" ref="nofollow noopener noreferrer">discord.gg/F7EQFnYscV</a></li>
<li><strong>微信小助手</strong>：miromind001</li>
</ul>
<h4 data-id="heading-5">写在最后：2026，交互时代来了</h4>
<p><strong>MiroThinker 1.5</strong> 的出现，证明了参数不是唯一王道，交互才是下一个突破口。</p>
<p><strong>陈天桥</strong>和<strong>代季峰</strong>这一枪，打得太响了！</p>
<p>它不仅让小模型看到了追赶巨头的希望，也给我们普通用户带来了更可靠、更低成本的AI助手。</p>
<p>你准备好体验“发现式智能”了吗？</p>
<p>快去 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdr.miromind.ai%2F" target="_blank" title="https://dr.miromind.ai/" ref="nofollow noopener noreferrer">dr.miromind.ai/</a> 试试吧，专业模式真的香！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/814172b4f507456ab427ec95f43b5ebb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S5qKF5Li756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768355875&amp;x-signature=PkvqG%2BZmPfPU3YHVBIS8q30KBwY%3D" alt="" loading="lazy"/></p>
<p>关注公众号【AI信息风向】，可以获取更多 AI 即时热点资讯和好用 AI 工具推荐。</p>
<p>AI 技术正以前所未有的速度发展，它将如何塑造我们的未来？让我们拭目以待。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 算力是一种需要被定价、对冲和交易的风险资产？]]></title>    <link>https://juejin.cn/post/7592089325913309184</link>    <guid>https://juejin.cn/post/7592089325913309184</guid>    <pubDate>2026-01-07T01:51:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592089325913309184" data-draft-id="7592094314472357923" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 算力是一种需要被定价、对冲和交易的风险资产？"/> <meta itemprop="keywords" content="人工智能,LLM,面试"/> <meta itemprop="datePublished" content="2026-01-07T01:51:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Baihai_IDP"/> <meta itemprop="url" content="https://juejin.cn/user/3123071228582343"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 算力是一种需要被定价、对冲和交易的风险资产？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3123071228582343/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Baihai_IDP
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T01:51:55.000Z" title="Wed Jan 07 2026 01:51:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>编者按：</strong> 当所有人都将 AI 算力视为下一个云计算风口时，我们是否忽略了它本质上是一种需要被定价、对冲和交易的风险资产？</p>
<p>我们今天为大家带来的这篇文章，作者的核心观点是：前沿AI算力已超出传统云服务范畴，其不确定性、时效性与稀缺性更接近大宗商品与金融衍生品，未来竞争的关键不在优化服务，而在设计承载算力风险的市场机制。</p>
<p>文章首先指出 AI 算力具有突发性、稀缺性、时效性与路径依赖等特征，使其从“可消费的服务”转变为“需管理的产能风险”；接着以未对冲的训练任务为例，说明金融工具如何为算力需求方提供风险解决方案；进而对比硅谷的“服务抽象”模式与芝加哥/纽约的“风险市场”模式，揭示二者底层逻辑的本质差异；最后提出，真正的产业制高点将是构建算力风险交易的基础设施，而这不仅将重塑 AI 研发与供应的格局，也可能催生新一代市场型机构。</p>
</blockquote>
<p><strong>作者 | Dave Friedman</strong></p>
<p><strong>编译 | 岳扬</strong></p>
<p>大多数人谈起 AI 算力市场，脑海里浮现的是云计算那套：把稀缺的硬件封装成一个 API，按用量计费，开出账单，再加点调度算法的“魔法”，然后去融一轮资。</p>
<p>这是硅谷的思维定式，却是一个错误的心智模型。</p>
<p>前沿 AI 算力不是一种可以随意采购的商品，而是一个企业必须严肃应对的战略风险源。<strong>它是一种十分稀缺、价格波动巨大、且价值随时间迅速流逝的关键资源，需要为其建立基于未来预期的动态风险定价模型，采取措施对冲其价格和可获性风险，并推动形成可灵活交易转让的市场流动性。</strong> 恰当的类比对象不是亚马逊云服务（AWS）或 Snowflake，而是芝加哥商品交易所（CME）、电力交易市场，以及芝加哥和纽约的衍生品交易部门。</p>
<h2 data-id="heading-0"><strong>01 核心问题：算力的产能具有随机性（Compute as Stochastic Capacity）</strong></h2>
<p>云计算基础设施建立在几个假设之上：</p>
<ul>
<li>供给具有弹性。</li>
<li>需求平稳。</li>
<li>成本曲线可预测。</li>
<li>正确的抽象方式是，把一切变成 “服务的消费”。【译者注：云服务商（如 AWS）将其底层复杂的硬件基础设施（服务器、网络、存储）抽象化，向用户呈现为一个简单的、按需取用的 “服务”。】</li>
</ul>
<p>处于技术最前沿、最尖端的 AI 研发打破了这些假设。AI 算力具有以下特征：</p>
<ul>
<li><strong>突发性</strong>：由非连续的训练任务驱动，而非稳定的网络流量。</li>
<li><strong>稀缺性</strong>：受限于晶圆产能周期、出口管制以及需耗时数年的电力基础设施建设。</li>
<li><strong>时效性</strong>：错过一个前沿 AI 模型的训练窗口期，可能导致整个产品周期的落后。</li>
<li><strong>路径依赖</strong>：成本受能源价格、硬件代际和算法演进的影响。</li>
</ul>
<p>这已经不是简单的“服务使用量”问题了，而是一种实实在在会带来损失的产能风险。当你面对的是一种在供给、时机和价格上都充满不确定性的实体资产时，你就不再处于产品设计的范畴了，而是进入了市场机制设计的领域。</p>
<h2 data-id="heading-1"><strong>02 一个简单例子：未进行对冲的训练任务</strong></h2>
<p>假设某实验室计划在未来 12 到 18 个月内开展一次大规模训练任务。他们尚不确定该训练任务的具体启动日期（取决于研究进展），但对所需算力规模心里已大致有数 —— 按当前价格算，大约需要 2000 万美元的算力。</p>
<p>目前，他们只有两个糟糕的选择：</p>
<p><strong>1）通过长期合约超量预定算力，承担高昂的持有成本；</strong></p>
<p><strong>2）或者赌一把现货市场，寄希望于等他们准备就绪时，价格和市场供给都能如人所愿。</strong></p>
<p>这恰恰正是期货、期权和互换合约这类金融工具本应解决的问题。如果将算力视为一种金融基础资产，该实验室就可以：</p>
<ul>
<li>买入算力期货，先锁一层已知价的底仓；</li>
<li>再叠加看涨期权（call options），以防项目规模超预期、需要额外算力；</li>
<li>并通过互换合约（swaps），将浮动的现货价格置换为固定价格。</li>
</ul>
<p>这套逻辑本身并不复杂 —— 不过是把大宗商品风险管理的基础方法从小麦或电力，换成了 GPU 而已。之所以尚未实现，唯一的原因是我们仍把算力当作一种服务型产品，而非一种具有随机性的生产投入要素。</p>
<h2 data-id="heading-2"><strong>03 硅谷 vs 芝加哥/纽约：两种玩法</strong></h2>
<p>看看两边玩的根本不是同一局牌。</p>
<p><strong>硅谷局：</strong></p>
<ul>
<li>把底层的复杂性封装起来，只通过一个简洁、清晰的应用程序接口（API）对外提供功能。</li>
<li>以开发者体验为核心优化目标。</li>
<li>将市场波动平滑处理为分层定价方案。</li>
<li>通过用量计费，并通过生态或合同把客户“锁定”。</li>
</ul>
<p>这套玩法在底层系统“容错性强”时才有效 —— 比如供给能很快跟上、需求足够分散、没有人会因单次价格飙升而彻底出局 —— 此时，你可以把风险当作噪声忽略。</p>
<p><strong>芝加哥/纽约局：</strong></p>
<ul>
<li>不隐藏风险，而是直面风险。</li>
<li>为高风险标的定义标准化合约。</li>
<li>建立能让这些合约进行交易的交易场所。</li>
<li>引入清算机制、保证金制度和风险模型，让机构能够安全地持有风险敞口。</li>
</ul>
<p>正是这种思维方式，让天气、波动率、电力储备和货运都变成了可交易的资产。这并不浪漫，只是清醒地承认一个事实：任何反复出现、且会对真实世界的人造成伤害的不确定性，都值得为之建立一个市场。</p>
<h2 data-id="heading-3"><strong>04 “但算力不是石油！”</strong></h2>
<p>说得对，而这恰恰是其有趣之处。算力是缺乏统一标准、高度异构、难以抽象成单一商品的 —— 它会因硬件、网络、延迟、地理位置和 SLA（服务等级协议）的不同而变化，而且验证起来并不简单。并不存在一个放之四海而皆准的标量，能完美定义“一单位算力”在所有场景下的含义。</p>
<p>但这并不会让它失去资格。电力市场需要处理地理位置、时段和传输约束；货运市场需要应对航线、船型和港口风险；而波动率产品交易的，甚至只是价格的一种抽象统计特性。</p>
<p>要将算力金融化，你不需要“一口吃成个胖子”，而是需要一系列标准化的“切片”【译者注：将算力按特定维度（如硬件类型、任务基准、时长等）拆解为可定义、可度量、可合约化的单位。】：</p>
<ul>
<li>清晰定义的交易单位（例如：“在 Z 小时内完成 Y 基准测试下的 X 个 token 处理，最大延迟为 L，故障条件事先约定”）；  </li>
<li>双方都信任的计量与验证机制；  </li>
<li>交付失败时的违约惩罚条款。</li>
</ul>
<p>你不会得到一个覆盖所有场景的“全球统一 GPU 期货”。你最终会得到的，是一系列相互关联、但各有所指的合约 —— 就像电力和大宗商品市场那样。这没什么问题，真实的市场本来就是这样运作的。</p>
<h2 data-id="heading-4"><strong>05 服务派 vs 市场派：谁才是真正的赢家？</strong></h2>
<p>一旦你把算力看作一种风险，战略格局就变了。服务派的本能是： <strong>“我们替用户把复杂性抽象掉，自己承担这些风险，然后通过加价来赚取利润。”</strong></p>
<p>于是你得到的是 GPU 版 Airbnb、更花哨的调度系统、更好看的仪表盘 —— 这些固然有用，但本质上仍是线性增长模式。你不过是在一个失灵的市场中，做了一个更高效的中间商。</p>
<p>而市场派的本能则相反： <strong>“我们要把风险暴露出来，将其标准化，并让它可交易。我们的护城河是市场结构本身，而不是 UI 界面。”</strong></p>
<p>这会堆出一整套完全不同的东西：</p>
<ul>
<li>算力单位的合约标准；  </li>
<li>支持这些合约交易的交易所与撮合引擎；  </li>
<li>清算与保证金机制，让机构资本得以参与；  </li>
<li>做市商，主动承担并管理算力风险；  </li>
<li>算力价格与波动率的数据、指数；  </li>
<li>面向算力供应商的信用与抵押框架。</li>
</ul>
<p>这更接近 <strong>CME（芝加哥商品交易所） + 电力 ISO 市场</strong>，而不是“GPU 版 Stripe”。  </p>
<p>而最有能力构建并运营这类系统的机构，并不在沙丘路（Sand Hill Road），而是在芝加哥和纽约。</p>
<h2 data-id="heading-5"><strong>06 对未来的预测（The Prediction）</strong></h2>
<p>谁掌控了 AI 算力的风险层（即那些用于定价和交易各方风险敞口的金融工具、交易平台与规则体系）谁便掌握了支配以下各方的关键杠杆：</p>
<ul>
<li>需要对冲训练风险的 AI 实验室；  </li>
<li>希望在不引发财务风险的前提下变现算力容量的云厂商和裸金属提供商；</li>
<li>寻求新型的、多元化的实物资产敞口的基金与金融机构；</li>
<li>甚至各国政府 —— 一旦它们开始像对待石油和天然气那样，思考“战略性算力储备”问题。</li>
</ul>
<p>这不再是“更好的 SaaS 产品”，而是一种市场基础设施（market institution）。</p>
<p><strong>AI 算力终将走向金融化，因为其底层的不确定性太大、太持久，靠临时合同和 Slack 私聊根本兜不住。</strong></p>
<p>如果你还在用传统商品销售的思路来看待 GPU —— 比如把它当成电商网站上一个明码标价、规格固定、随时可买的标准化商品（SKU），那你解决的只是昨天的问题。</p>
<p>谁能够设计出一种更高效、更具韧性的<strong>市场机制</strong>来<strong>分散、转移和管理</strong>伴随算力而来的巨大风险，谁就能在未来的竞争中掌握主动权。</p>
<p><strong>END</strong></p>
<p><strong>本期互动内容 🍻</strong></p>
<p><strong>❓如果你是一家 AI 实验室的负责人，面对算力价格的剧烈波动，你更愿意：</strong></p>
<p><strong>A）提前锁定长期合约，哪怕成本高些；<br/>
B）赌现货市场，灵活但风险自担；<br/>
C）如果有算力期货/期权，立刻用金融工具对冲。<br/>
为什么？</strong></p>
<p><strong>本文经原作者授权，由</strong> <strong>Baihai IDP</strong> <strong>编译。如需转载译文，请联系获取授权。</strong></p>
<p><strong>原文链接：</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdavefriedman.substack.com%2Fp%2Fthe-hidden-risk-of-ai-compute" target="_blank" title="https://davefriedman.substack.com/p/the-hidden-risk-of-ai-compute" ref="nofollow noopener noreferrer">davefriedman.substack.com/p/the-hidde…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Nuxtjs中，举例子一篇文章讲清楚：水合sop]]></title>    <link>https://juejin.cn/post/7592040819818283049</link>    <guid>https://juejin.cn/post/7592040819818283049</guid>    <pubDate>2026-01-07T02:03:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592040819818283049" data-draft-id="7591792747776049162" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Nuxtjs中，举例子一篇文章讲清楚：水合sop"/> <meta itemprop="keywords" content="前端,Nuxt.js"/> <meta itemprop="datePublished" content="2026-01-07T02:03:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="龙在天"/> <meta itemprop="url" content="https://juejin.cn/user/3760787883819464"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Nuxtjs中，举例子一篇文章讲清楚：水合sop
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3760787883819464/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    龙在天
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T02:03:20.000Z" title="Wed Jan 07 2026 02:03:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">水合的意思</h2>
<p>水合：在客户端，将<code>vue组件</code>和<code>服务器渲染</code>的静态html 进行<code>"激活"</code>的过程，使其成为完全交互式的单页应用（<code>SPA</code>）。</p>
<h2 data-id="heading-1">sop（工作流程）</h2>
<p>1、服务器渲染：<code>Nuxt</code>在服务器生成页面的<code>静态HTML</code>。</p>
<p>2、发送到客户端：<code>html</code>+<code>vue</code>组件的<code>js代码</code>一起发送到浏览器。</p>
<p>3、水合过程：Vue在客户端接管静态<code>html</code>，将其与<code>Vue</code>组件实例关联，添加事件监听器，恢复响应式状态。</p>
<h2 data-id="heading-2">代码例子</h2>
<h3 data-id="heading-3">计数器</h3>
<p>整个<code>Counter.vue</code>都是在服务器端渲染的，然后在客户端进行水合（也就是所谓的激活的意思）。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- components/Counter.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>计数：{{ count }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"increment"</span>&gt;</span>增加<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
<span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"/>) =&gt; count.<span class="hljs-property">value</span>++
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h2 data-id="heading-4">sop（计数器水合过程）</h2>
<ul>
<li>服务器渲染：<code>&lt;p&gt;计数：0&lt;/p&gt;</code>（静态 HTML）</li>
<li>发送到客户端：<code>HTML + Vue</code>组件代码</li>
<li>水合：<code>Vue</code>找到这个<code>DOM</code>元素，将<code>count</code>响应式变量绑定，添加点击事件。</li>
<li>结果：按钮可以交互，数字可以更新。</li>
</ul>
<h3 data-id="heading-5">服务器</h3>
<p>服务器渲染以下代码：</p>
<pre><code class="hljs language-html" lang="html">&lt;-- Nuxt 服务器渲染的完整 html --&gt;
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>计数：0<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>增加<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>服务器会做这些动作：</p>
<ul>
<li>1、执行<code>&lt;script setup&gt;</code>中的代码</li>
<li>2、<code>count.value</code>初始化为<code>0</code></li>
<li>3、使用这个值渲染模版</li>
<li>4、生成包含<code>当前状态</code>的静态<code>html</code></li>
<li>5、不渲染任何事件监听器（<code>@click</code>）</li>
</ul>
<h4 data-id="heading-6">发送到客户端的内容</h4>
<p>发送到客户端的内容如下：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 服务器渲染的静态 HTML --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>计数: 0<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>增加<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  
  <span class="hljs-comment">&lt;!-- 打包的 JavaScript --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/_nuxt/entry.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// 包含 Counter 组件的 Vue 代码</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title class_">Counter</span> = {
      <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
        <span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"/>) =&gt; count.<span class="hljs-property">value</span>++
        <span class="hljs-keyword">return</span> { count, increment }
      },
      <span class="hljs-attr">template</span>: <span class="hljs-string">`&lt;div&gt;...&lt;/div&gt;`</span>
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 data-id="heading-7">客户端</h3>
<p>然后客户端进行水合，</p>
<ul>
<li>1、<strong>加载html</strong>：浏览器显示静态的计数"0"</li>
<li>2、<strong>加载js</strong>：下载包含<code>Vue</code>和组件代码的<code>js</code></li>
<li>3、进行<strong>水合激活</strong>：</li>
</ul>
<p>水合激活，我写步骤在下面</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// Vue 内部执行：</span>
<span class="hljs-comment">// 1. 找到 &lt;div&gt; 元素</span>
<span class="hljs-comment">// 2. 将 count 响应式变量绑定到 DOM</span>
<span class="hljs-comment">// 3. 给按钮添加 click 事件监听器</span>
<span class="hljs-comment">// 4. 建立虚拟 DOM 与真实 DOM 的关联</span>
</code></pre>
<h2 data-id="heading-8">组合例子 —— 条件渲染</h2>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- components/Example.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 这个是在服务器渲染的 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>服务器时间: {{ serverTime }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 这个是在客户端水合后渲染的 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"isClient"</span>&gt;</span>客户端时间: {{ clientTime }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"update"</span>&gt;</span>更新<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref, onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 这部分代码服务器和客户端都会执行</span>
<span class="hljs-keyword">const</span> serverTime = <span class="hljs-title function_">ref</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>())

<span class="hljs-comment">// 这部分只在客户端执行</span>
<span class="hljs-keyword">const</span> isClient = <span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">'undefined'</span>
<span class="hljs-keyword">const</span> clientTime = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)

<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (isClient) {
    clientTime.<span class="hljs-property">value</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>()
  }
})

<span class="hljs-keyword">const</span> <span class="hljs-title function_">update</span> = (<span class="hljs-params"/>) =&gt; {
  clientTime.<span class="hljs-property">value</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>()
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>渲染出来的结果对比：</p>
<p>服务器渲染的html：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>服务器时间: 2024-01-15T10:30:00.000Z<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- v-if="false"，所以没有这个元素 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>更新<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>客户端水合后：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>服务器时间: 2024-01-15T10:30:00.000Z<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>客户端时间: 2024-01-15T10:30:05.123Z<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>更新<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-comment">&lt;!-- 现在按钮有点击事件了 --&gt;</span>
</code></pre>



































<table><thead><tr><th>部分</th><th>服务器渲染</th><th>客户端渲染</th></tr></thead><tbody><tr><td>初始 HTML 结构</td><td>✅</td><td>❌</td></tr><tr><td>初始数据 (<code>count: 0</code>)</td><td>✅</td><td>❌</td></tr><tr><td>事件监听器 (<code>@click</code>)</td><td>❌</td><td>✅</td></tr><tr><td>后续更新 (<code>count++</code>)</td><td>❌</td><td>✅</td></tr><tr><td>响应式系统</td><td>❌（只是静态值）</td><td>✅（激活响应式）</td></tr></tbody></table>
<h2 data-id="heading-9">sop（水合过程）</h2>
<p>水合过程：</p>
<ul>
<li>1、<strong>服务器端</strong>：读环境变量，然后，渲染到<code>{{ config.public.apiBase }}</code>html当中。</li>
<li>2、<strong>客户端水合</strong>：<code>useRuntimeConfig()</code>从<code>window</code>全局变量中获取值，</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[剑指offer-60、将⼆叉树打印成多⾏]]></title>    <link>https://juejin.cn/post/7592120202319331378</link>    <guid>https://juejin.cn/post/7592120202319331378</guid>    <pubDate>2026-01-07T00:10:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592120202319331378" data-draft-id="7589838742552494099" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="剑指offer-60、将⼆叉树打印成多⾏"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-07T00:10:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            剑指offer-60、将⼆叉树打印成多⾏
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T00:10:32.000Z" title="Wed Jan 07 2026 00:10:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">题⽬描述</h2>
<p>从上到下按层打印⼆叉树，同⼀层结点从左⾄右输出。每⼀层输出⼀⾏。</p>
<p>给定的⼆叉树是 {1,2,3,#,#,4,5} :</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e12556003a24bd286b024afafa2bb52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768349432&amp;x-signature=OtBXYQ3Ye5UI%2BA0vaBUBXZdDrZw%3D" alt="" loading="lazy"/></p>
<p>该⼆叉树多⾏打印层序遍历的结果是：</p>
<pre><code class="hljs language-text" lang="text">[
[1],
[2,3],
[4,5]
]
</code></pre>
<p>示例1
输⼊：{8,6,10,5,7,9,11}
返回值：[[8],[6,10],[5,7,9,11]]</p>
<h2 data-id="heading-1">思路及解答</h2>
<p>59题的缩减版</p>
<h3 data-id="heading-2">迭代法BFS（广度优先搜索）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    ArrayList&lt;ArrayList&lt;Integer&gt; &gt; Print(TreeNode pRoot) {
        <span class="hljs-comment">//层次打印遍历树</span>
        ArrayList&lt;ArrayList&lt;Integer&gt; &gt; lists = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-keyword">if</span>(pRoot == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> lists;
        Queue&lt;TreeNode&gt; q = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();
        q.offer(pRoot);
        <span class="hljs-keyword">while</span>(!q.isEmpty()){
            <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> q.size();
            ArrayList&lt;Integer&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; size; i++){
                <span class="hljs-type">TreeNode</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> q.poll();
                list.add(temp.val);
                <span class="hljs-keyword">if</span>(temp.left != <span class="hljs-literal">null</span>) q.offer(temp.left);
                <span class="hljs-keyword">if</span>(temp.right != <span class="hljs-literal">null</span>) q.offer(temp.right);
            }
            lists.add(list);
        }
        <span class="hljs-keyword">return</span> lists;
    }
    
}
</code></pre>
<ul>
<li><strong>时间复杂度</strong>：O(n)，每个节点恰好入队和出队各一次</li>
<li><strong>空间复杂度</strong>：O(n)，队列中最多存储n个节</li>
</ul>
<h3 data-id="heading-3">递归DFS（深度优先搜索）</h3>
<p>虽然层序遍历通常用BFS，但也可以用DFS通过递归隐式维护层级信息来实现</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {

    <span class="hljs-keyword">public</span> ArrayList&lt;ArrayList&lt;Integer&gt;&gt; <span class="hljs-title function_">levelOrder</span><span class="hljs-params">(TreeNode root)</span> {
        ArrayList&lt;ArrayList&lt;Integer&gt;&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-keyword">if</span> (root == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> result;
        
        dfs(root, <span class="hljs-number">0</span>, result);
        <span class="hljs-keyword">return</span> result;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">dfs</span><span class="hljs-params">(TreeNode node, <span class="hljs-type">int</span> depth, ArrayList&lt;ArrayList&lt;Integer&gt;&gt; result)</span> {
        <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;
        
        <span class="hljs-comment">// 如果当前深度对应的列表不存在，创建新列表</span>
        <span class="hljs-keyword">if</span> (depth &gt;= result.size()) {
            result.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;());
        }
        
        <span class="hljs-comment">// 将当前节点值加入对应深度的列表</span>
        result.get(depth).add(node.val);
        
        <span class="hljs-comment">// 递归处理左右子树，深度+1</span>
        dfs(node.left, depth + <span class="hljs-number">1</span>, result);
        dfs(node.right, depth + <span class="hljs-number">1</span>, result);
    }
}
</code></pre>
<ul>
<li><strong>时间复杂度</strong>：O(n)，每个节点访问一次</li>
<li><strong>空间复杂度</strong>：O(h)，递归栈深度等于树高，最坏情况O(n)</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vite 5大性能优化实战：从3秒到300毫秒的构建速度跃迁]]></title>    <link>https://juejin.cn/post/7592094358657269794</link>    <guid>https://juejin.cn/post/7592094358657269794</guid>    <pubDate>2026-01-07T00:18:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592094358657269794" data-draft-id="7592119218030018594" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vite 5大性能优化实战：从3秒到300毫秒的构建速度跃迁"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-07T00:18:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vite 5大性能优化实战：从3秒到300毫秒的构建速度跃迁
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T00:18:04.000Z" title="Wed Jan 07 2026 00:18:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Vite 5大性能优化实战：从3秒到300毫秒的构建速度跃迁</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>在前端工程化领域，构建工具的性能直接决定了开发体验和生产效率。Webpack等传统工具虽然功能强大，但随着项目规模增长，构建速度往往成为瓶颈。Vite凭借其创新的原生ESM（ECMAScript Modules）设计和极速的HMR（Hot Module Replacement），正在重塑前端开发范式。</p>
<p>本文将深入剖析5个经过实战验证的Vite性能优化策略，涵盖依赖预构建、缓存机制、配置调优等多个维度。通过真实案例展示如何将一个中型项目的冷启动时间从3秒降至300毫秒量级，实现10倍性能跃迁。</p>
<h2 data-id="heading-2">一、依赖预构建：从重复编译到智能缓存</h2>
<h3 data-id="heading-3">1.1 原理深度解析</h3>
<p>Vite的核心优化之一是依赖预构建（Dependency Pre-Bundling）。与传统打包工具每次全量编译不同，Vite在首次启动时会：</p>
<ul>
<li>扫描<code>package.json</code>中的dependencies</li>
<li>使用Rollup将CommonJS/UMD模块转换为ESM格式</li>
<li>合并多个小文件减少网络请求</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">optimizeDeps</span>: {
    <span class="hljs-attr">include</span>: [<span class="hljs-string">'lodash-es'</span>], <span class="hljs-comment">// 强制预构建指定库</span>
    <span class="hljs-attr">exclude</span>: [<span class="hljs-string">'moment'</span>],   <span class="hljs-comment">// 排除已知ESM模块</span>
    <span class="hljs-attr">force</span>: <span class="hljs-literal">true</span>            <span class="hljs-comment">// 开发阶段手动触发重建</span>
  }
}
</code></pre>
<h3 data-id="heading-4">1.2 Benchmark对比测试</h3>
<p>在含150个第三方依赖的中型项目中：</p>

























<table><thead><tr><th>策略</th><th>冷启动时间</th><th>HMR更新</th></tr></thead><tbody><tr><td>无预构建</td><td>4200ms</td><td>&gt;1000ms</td></tr><tr><td>默认预构建</td><td>1800ms</td><td>&lt;50ms</td></tr><tr><td>+include优化</td><td>1200ms</td><td>&lt;30ms</td></tr></tbody></table>
<h2 data-id="heading-5">二、持久化缓存：硬盘即内存的加速魔法</h2>
<h3 data-id="heading-6">2.1 FS Cache工作机制</h3>
<p>Vite默认将以下内容写入<code>node_modules/.vite</code>：</p>
<ul>
<li>Rollup格式的预构建产物</li>
<li>Babel/PostCSS转译结果</li>
<li>TypeScript编译缓存</li>
</ul>
<p>通过实验发现，启用持久化缓存后二次启动时间可缩短70%以上：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># .gitignore中需添加</span>
.vite
*.<span class="hljs-built_in">local</span>
</code></pre>
<h3 data-id="heading-7">2.2 Cache-Control策略进阶</h3>
<p>生产环境部署时推荐配置：</p>
<pre><code class="hljs language-nginx" lang="nginx">location /assets {
  expires max;
}
</code></pre>
<p>配合HTTP/2 Server Push可将关键资源加载时间再压缩40%。</p>
<p>##三、按需编译：现代浏览器的能力红利</p>
<p>###3.1 ESM动态导入实践<br/>
利用浏览器原生ESM特性实现路由级代码分割：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">Home</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-keyword">import</span>(<span class="hljs-string">'./views/Home.vue'</span>)
</code></pre>
<p>对比Webpack的动态导入：</p>
<ul>
<li>Vite无需等待完整manifest生成</li>
<li>Chunk边界定义更灵活</li>
</ul>
<p>###3.2 WASM直连方案<br/>
通过<code>?init</code>参数直接加载WebAssembly模块：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> init <span class="hljs-keyword">from</span> <span class="hljs-string">'./pkg/wasm_module_bg.wasm?init'</span>
</code></pre>
<p>实测比传统方案减少200-300ms解析耗时。</p>
<p>##四、多线程与原生编译：榨干硬件性能</p>
<p>###4.1 ESBuild集成配置<br/>
在<code>vite.config.js</code>中启用所有ESBuild优化项：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
 <span class="hljs-attr">esbuild</span>: {
   <span class="hljs-attr">target</span>: <span class="hljs-string">'es2020'</span>,
   <span class="hljs-attr">minifyWhitespace</span>: <span class="hljs-literal">true</span>,
   <span class="hljs-attr">treeShaking</span>: <span class="hljs-literal">true</span>,
 }
}
</code></pre>
<p>实测TSX文件编译速度提升8-10倍。</p>
<p>###4.2 SWC替代Babel<br/>
对于React项目推荐配置：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> { 
 <span class="hljs-attr">plugins</span>: [
   <span class="hljs-title function_">react</span>({
     <span class="hljs-attr">swc</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">//启用SWC转译器 </span>
   })
 ]
} 
</code></pre>
<p>JSX处理速度从1200文件/秒提升至9500文件/秒。</p>
<p>##五、生产模式专项优化</p>
<p>###5.1 Brotli压缩实战<br/>
调整rollup-plugin-compress配置：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> compress <span class="hljs-keyword">from</span> <span class="hljs-string">'rollup-plugin-compress'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
 <span class="hljs-attr">plugins</span>: [
   <span class="hljs-title function_">compress</span>({
     <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'brotliCompress'</span>, 
     <span class="hljs-attr">threshold</span>:<span class="hljs-number">1024</span> 
   })
 ]
}
</code></pre>
<p>可使最终包体积缩小15%-20%。</p>
<p>###5.2 CSS代码分割最佳实践<br/>
强制分离关键CSS：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> { 
 <span class="hljs-attr">build</span>:{ 
   <span class="hljs-attr">cssCodeSplit</span>: <span class="hljs-literal">true</span>, 
 } 
} 
</code></pre>
<p>配合preload策略使LCP指标提升30%。</p>
<p>##总结</p>
<p>通过本文的五维优化体系——依赖预构建、持久化缓存、按需编译、多线程处理和产线专项调优，我们系统性地解决了Vite在不同场景下的性能瓶颈。需要强调的是，性能优化应当遵循"测量-&gt;分析-&gt;实施-&gt;验证"的科学闭环。建议开发者使用如下诊断命令持续监控：</p>
<pre><code class="hljs language-bash" lang="bash">npx vite-bundle-visualizer   
npx lighthouse http://localhost:5173 --view   
</code></pre>
<p>随着Vite生态的持续演进（如5.x版本引入的Rust插件系统），前端工程的性能边界还将不断突破。希望本文提供的技术路径能帮助团队在保证开发体验的同时，实现极致的运行时性能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot 如何用 @ControllerAdvice 统一处理异常？]]></title>    <link>https://juejin.cn/post/7592059801884934187</link>    <guid>https://juejin.cn/post/7592059801884934187</guid>    <pubDate>2026-01-07T00:29:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592059801884934187" data-draft-id="7582118218648748058" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot 如何用 @ControllerAdvice 统一处理异常？"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2026-01-07T00:29:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员大华"/> <meta itemprop="url" content="https://juejin.cn/user/3507878440995946"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot 如何用 @ControllerAdvice 统一处理异常？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3507878440995946/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员大华
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T00:29:44.000Z" title="Wed Jan 07 2026 00:29:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、什么是全局异常处理？</h2>
<p>在实际开发中，程序运行时难免会遇到各种意外。这些意外在 Java 中就表现为<strong>异常（Exception）</strong>。如果不做统一处理，用户可能会看到一堆错误信息。</p>
<h3 data-id="heading-1">常见场景：</h3>
<ul>
<li>
<p><code>NullPointerException</code>（空指针异常）：前端传了一个用户 ID，但后端没做判空，直接调用 <code>user.getName()</code>，结果 user 是 null 导致程序崩溃！</p>
</li>
<li>
<p><code>SQLException</code>（数据库连接失败）：数据库宕机或网络中断，导致查询失败，直接抛出 SQL 异常。</p>
</li>
<li>
<p><code>NumberFormatException</code>（参数格式错误）：前端传了个字符串 <code>&amp;#34;abc&amp;#34;</code>，后端试图用 <code>Integer.parseInt()</code> 转成数字失败！</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-2">如果不做处理，会发生什么？</h3>
<p>SpringBoot 默认会把异常的<strong>完整堆栈信息</strong>原样返回给前端，比如：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  &amp;#<span class="hljs-number">34</span>;timestamp&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;<span class="hljs-number">2025</span><span class="hljs-number">-11</span><span class="hljs-number">-26</span>T12<span class="hljs-punctuation">:</span><span class="hljs-number">00</span><span class="hljs-punctuation">:</span><span class="hljs-number">00</span>&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
  &amp;#<span class="hljs-number">34</span>;status&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-number">500</span><span class="hljs-punctuation">,</span>
  &amp;#<span class="hljs-number">34</span>;error&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;Internal Server Error&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
  &amp;#<span class="hljs-number">34</span>;message&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;/ by zero&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
  &amp;#<span class="hljs-number">34</span>;path&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;/api/calculate&amp;#<span class="hljs-number">34</span>;
<span class="hljs-punctuation">}</span>
</code></pre>
<p>甚至在开发环境下，还可能返回几十行 Java 堆栈，这些会导致以下以下问题：</p>
<ul>
<li>用户看不懂，</li>
<li>前端无法统一处理，</li>
<li>更严重的是：<strong>可能泄露类名、方法名、服务器路径等敏感信息！</strong></li>
</ul>
<hr/>
<h3 data-id="heading-3">有了全局异常处理，就能：</h3>
<ul>
<li>拦截所有异常，统一返回结构化错误信息</li>
<li>区分不同异常类型，返回不同的状态码和提示语</li>
<li>自动记录日志，方便排查问题</li>
<li>避免敏感信息外泄，提升系统安全性</li>
</ul>
<p>最终返回给前端的，可能是这样一段干净、友好的 JSON：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  &amp;#<span class="hljs-number">34</span>;code&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-number">400</span><span class="hljs-punctuation">,</span>
  &amp;#<span class="hljs-number">34</span>;message&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;用户ID不能为空&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
  &amp;#<span class="hljs-number">34</span>;data&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>或者：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  &amp;#<span class="hljs-number">34</span>;code&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-number">200</span><span class="hljs-punctuation">,</span>
  &amp;#<span class="hljs-number">34</span>;message&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;订单创建成功&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
  &amp;#<span class="hljs-number">34</span>;data&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>是不是清爽又专业多了😊</p>
<hr/>
<h2 data-id="heading-4">二、如何做异常处理</h2>
<h3 data-id="heading-5">传统做法（不推荐）</h3>
<p>每个 <code>Controller</code> 方法里都写 <code>try-catch</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@GetMapping(&amp;#34;/user/{id}&amp;#34;)</span>
<span class="hljs-keyword">public</span> ResponseEntity <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.findById(id);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(user);
    } <span class="hljs-keyword">catch</span> (UserNotFoundException e) {
        <span class="hljs-keyword">return</span> ResponseEntity.status(<span class="hljs-number">404</span>).body(&amp;#<span class="hljs-number">34</span>;用户不存在&amp;#<span class="hljs-number">34</span>;);
    } <span class="hljs-keyword">catch</span> (Exception e) {
        <span class="hljs-keyword">return</span> ResponseEntity.status(<span class="hljs-number">500</span>).body(&amp;#<span class="hljs-number">34</span>;系统错误&amp;#<span class="hljs-number">34</span>;);
    }
}
</code></pre>
<p>问题很明显：</p>
<ul>
<li>代码重复</li>
<li>难维护</li>
<li>容易漏掉</li>
</ul>
<h3 data-id="heading-6">全局异常处理（推荐）</h3>
<p><strong>只写一次，全局生效！</strong></p>
<p>下面主要写 SpringBoot 的处理。</p>
<hr/>
<h2 data-id="heading-7">三、SpringBoot 中如何实现全局异常处理？</h2>
<p>核心就靠一个注解：<code>@ControllerAdvice</code></p>
<h3 data-id="heading-8">第一步：定义统一的错误响应格式</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 统一返回结构，前端好解析</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorResponse</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> code;
    <span class="hljs-keyword">private</span> String message;
    <span class="hljs-keyword">private</span> Object data; <span class="hljs-comment">// 一般为 null，但保留扩展性</span>

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ErrorResponse</span><span class="hljs-params">(<span class="hljs-type">int</span> code, String message)</span> {
        <span class="hljs-built_in">this</span>.code = code;
        <span class="hljs-built_in">this</span>.message = message;
    }

    <span class="hljs-comment">// getter / setter 省略（实际项目中建议用 Lombok）</span>
}
</code></pre>
<h3 data-id="heading-9">第二步：创建全局异常处理器类</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 创建一个类，加上 @ControllerAdvice 注解</span>
<span class="hljs-meta">@ControllerAdvice</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandler</span> {

    <span class="hljs-comment">// 2. 用 @ExceptionHandler 捕获特定异常</span>
    <span class="hljs-meta">@ExceptionHandler(UserNotFoundException.class)</span>
    <span class="hljs-keyword">public</span> ResponseEntity <span class="hljs-title function_">handleUserNotFound</span><span class="hljs-params">(UserNotFoundException e)</span> {
        <span class="hljs-type">ErrorResponse</span> <span class="hljs-variable">error</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorResponse</span>(<span class="hljs-number">404</span>, e.getMessage());
        <span class="hljs-keyword">return</span> ResponseEntity.status(<span class="hljs-number">404</span>).body(error);
    }

    <span class="hljs-comment">// 3. 捕获所有其他异常（兜底）</span>
    <span class="hljs-meta">@ExceptionHandler(Exception.class)</span>
    <span class="hljs-keyword">public</span> ResponseEntity <span class="hljs-title function_">handleGenericException</span><span class="hljs-params">(Exception e)</span> {
        <span class="hljs-type">ErrorResponse</span> <span class="hljs-variable">error</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorResponse</span>(<span class="hljs-number">500</span>, &amp;#<span class="hljs-number">34</span>;服务器内部错误，请联系管理员&amp;#<span class="hljs-number">34</span>;);
        <span class="hljs-keyword">return</span> ResponseEntity.status(<span class="hljs-number">500</span>).body(error);
    }
}
</code></pre>
<h3 data-id="heading-10">第三步：自定义业务异常（可选但推荐）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 自定义业务异常</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BusinessException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RuntimeException</span> {
    <span class="hljs-keyword">private</span> Integer code;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BusinessException</span><span class="hljs-params">(Integer code, String message)</span> {
        <span class="hljs-built_in">super</span>(message);
        <span class="hljs-built_in">this</span>.code = code;
    }
    
    <span class="hljs-comment">// getter省略</span>
}
</code></pre>
<p>然后在 Service 层这样用：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> User <span class="hljs-title function_">findById</span><span class="hljs-params">(Long id)</span> {
    <span class="hljs-keyword">if</span> (id == <span class="hljs-literal">null</span> || id &lt;= <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(&amp;#<span class="hljs-number">34</span>;用户ID无效&amp;#<span class="hljs-number">34</span>;);
    }
    <span class="hljs-comment">// 查询数据库...</span>
}
</code></pre>
<p>可以说配置全局异常是比较简单的，可能因为简单，或者是项目里本来就配置的有，所以很多朋友直接忽略掉了这些问题。</p>
<hr/>
<h2 data-id="heading-11">四、更智能的异常处理</h2>
<h3 data-id="heading-12">1. 区分 Controller 和 REST 接口</h3>
<p>如果你既有页面（返回 HTML），又有 API（返回 JSON），可以用：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@ControllerAdvice(annotations = RestController.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RestGlobalExceptionHandler</span> {
    <span class="hljs-comment">// 只处理 @RestController 的异常</span>
}
</code></pre>
<p>或者指定包路径：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@ControllerAdvice(basePackages = &amp;#34;com.example.api&amp;#34;)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiExceptionHandler</span> { ... }
</code></pre>
<h3 data-id="heading-13">2. 处理参数校验异常（如 @Valid）</h3>
<p>SpringBoot 自带校验框架，校验失败会抛 <code>MethodArgumentNotValidException</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@ExceptionHandler(MethodArgumentNotValidException.class)</span>
<span class="hljs-keyword">public</span> ResponseEntity <span class="hljs-title function_">handleValidation</span><span class="hljs-params">(MethodArgumentNotValidException e)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> e.getBindingResult().getFieldError().getDefaultMessage();
    <span class="hljs-keyword">return</span> ResponseEntity.badRequest().body(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorResponse</span>(<span class="hljs-number">400</span>, msg));
}
</code></pre>
<h3 data-id="heading-14">3. 记录日志（非常重要！）</h3>
<p>在 <code>handleGenericException</code> 中加入日志：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(GlobalExceptionHandler.class);

<span class="hljs-meta">@ExceptionHandler(Exception.class)</span>
<span class="hljs-keyword">public</span> ResponseEntity <span class="hljs-title function_">handleGenericException</span><span class="hljs-params">(Exception e)</span> {
    log.error(&amp;#<span class="hljs-number">34</span>;系统发生未预期异常&amp;#<span class="hljs-number">34</span>;, e); <span class="hljs-comment">// 记录完整堆栈</span>
    <span class="hljs-keyword">return</span> ResponseEntity.status(<span class="hljs-number">500</span>).body(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorResponse</span>(<span class="hljs-number">500</span>, &amp;#<span class="hljs-number">34</span>;服务器开小差啦~&amp;#<span class="hljs-number">34</span>;));
}
</code></pre>
<h2 data-id="heading-15">五、深入理解@ControllerAdvice</h2>
<p>很多同学可能会好奇：为什么加了<code>@ControllerAdvice</code>后，异常就能被自动捕获呢？</p>
<p>其实原理很简单：</p>
<ol>
<li><code>Spring MVC</code> 在处理请求时，如果 Controller 方法抛出异常</li>
<li><code>Spring</code> 会查找有没有对应的异常处理器（<code>@ExceptionHandler</code>）</li>
<li>查找顺序是：先找当前 Controller 中的 <code>@ExceptionHandler</code> 方法</li>
<li>如果当前 Controller 没有，就找 <code>@ControllerAdvice</code> 标注的类中的 <code>@ExceptionHandler</code> 方法</li>
<li>找到匹配的异常处理器后，调用对应的方法处理异常</li>
</ol>
<h2 data-id="heading-16">最佳实践建议</h2>
<h3 data-id="heading-17">1. 定义清晰的异常体系</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 基础异常类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RuntimeException</span> {
    <span class="hljs-keyword">private</span> Integer code;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BaseException</span><span class="hljs-params">(Integer code, String message)</span> {
        <span class="hljs-built_in">super</span>(message);
        <span class="hljs-built_in">this</span>.code = code;
    }
}

<span class="hljs-comment">// 各种具体异常</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BusinessException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseException</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BusinessException</span><span class="hljs-params">(Integer code, String message)</span> {
        <span class="hljs-built_in">super</span>(code, message);
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SystemException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseException</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SystemException</span><span class="hljs-params">(Integer code, String message)</span> {
        <span class="hljs-built_in">super</span>(code, message);
    }
}
</code></pre>
<h3 data-id="heading-18">2. 使用枚举管理错误码</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ErrorCode</span> {
    SUCCESS(<span class="hljs-number">200</span>, &amp;#<span class="hljs-number">34</span>;成功&amp;#<span class="hljs-number">34</span>;),
    PARAM_ERROR(<span class="hljs-number">400</span>, &amp;#<span class="hljs-number">34</span>;参数错误&amp;#<span class="hljs-number">34</span>;),
    UNAUTHORIZED(<span class="hljs-number">401</span>, &amp;#<span class="hljs-number">34</span>;未授权&amp;#<span class="hljs-number">34</span>;),
    FORBIDDEN(<span class="hljs-number">403</span>, &amp;#<span class="hljs-number">34</span>;禁止访问&amp;#<span class="hljs-number">34</span>;),
    NOT_FOUND(<span class="hljs-number">404</span>, &amp;#<span class="hljs-number">34</span>;资源不存在&amp;#<span class="hljs-number">34</span>;),
    SYSTEM_ERROR(<span class="hljs-number">500</span>, &amp;#<span class="hljs-number">34</span>;系统错误&amp;#<span class="hljs-number">34</span>;);
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer code;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String message;
    
    ErrorCode(Integer code, String message) {
        <span class="hljs-built_in">this</span>.code = code;
        <span class="hljs-built_in">this</span>.message = message;
    }
    
    <span class="hljs-comment">// getter方法</span>
}
</code></pre>
<h3 data-id="heading-19">3. 日志记录要恰当</h3>
<ul>
<li>业务异常：一般用warn级别，不需要记录堆栈</li>
<li>系统异常：用error级别，需要记录堆栈信息</li>
</ul>
<h2 data-id="heading-20">完整示例代码</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 统一返回结果</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span> {
    <span class="hljs-keyword">private</span> Integer code;
    <span class="hljs-keyword">private</span> String message;
    <span class="hljs-keyword">private</span> T data;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span>  Result <span class="hljs-title function_">success</span><span class="hljs-params">(T data)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>&lt;&gt;(<span class="hljs-number">200</span>, &amp;#<span class="hljs-number">34</span>;成功&amp;#<span class="hljs-number">34</span>;, data);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span>  Result <span class="hljs-title function_">error</span><span class="hljs-params">(Integer code, String message)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>&lt;&gt;(code, message, <span class="hljs-literal">null</span>);
    }
}

<span class="hljs-comment">// 全局异常处理器</span>
<span class="hljs-meta">@RestControllerAdvice</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandler</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(GlobalExceptionHandler.class);
    
    <span class="hljs-comment">// 处理业务异常</span>
    <span class="hljs-meta">@ExceptionHandler(BusinessException.class)</span>
    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">handleBusinessException</span><span class="hljs-params">(BusinessException e)</span> {
        logger.warn(&amp;#<span class="hljs-number">34</span>;业务异常：code={}, message={}&amp;#<span class="hljs-number">34</span>;, e.getCode(), e.getMessage());
        <span class="hljs-keyword">return</span> Result.error(e.getCode(), e.getMessage());
    }
    
    <span class="hljs-comment">// 处理参数校验异常</span>
    <span class="hljs-meta">@ExceptionHandler(MethodArgumentNotValidException.class)</span>
    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">handleMethodArgumentNotValidException</span><span class="hljs-params">(MethodArgumentNotValidException e)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> e.getBindingResult().getFieldErrors().stream()
                .map(FieldError::getDefaultMessage)
                .collect(Collectors.joining(&amp;#<span class="hljs-number">34</span>;, &amp;#<span class="hljs-number">34</span>;));
        <span class="hljs-keyword">return</span> Result.error(<span class="hljs-number">400</span>, message);
    }
    
    <span class="hljs-comment">// 处理所有其他异常</span>
    <span class="hljs-meta">@ExceptionHandler(Exception.class)</span>
    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">handleException</span><span class="hljs-params">(Exception e)</span> {
        logger.error(&amp;#<span class="hljs-number">34</span>;系统异常：&amp;#<span class="hljs-number">34</span>;, e);
        <span class="hljs-keyword">return</span> Result.error(<span class="hljs-number">500</span>, &amp;#<span class="hljs-number">34</span>;系统繁忙，请稍后重试&amp;#<span class="hljs-number">34</span>;);
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-21">总结</h2>
<p><strong>统一格式</strong>：前后端约定好错误结构，沟通更顺畅<br/>
<strong>减少重复代码</strong>：不用每个方法写 try-catch<br/>
<strong>提升健壮性</strong>：兜底处理防止系统崩溃，还能记录日志</p>
<blockquote>
<p>本文首发于公众号：程序员大华，专注分享前后端开发的实战笔记。关注我，少走弯路，一起进步！</p>
</blockquote>
<h4 data-id="heading-22">📌往期精彩</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FU3HhCz5WiAMNM7foxuTa0w" target="_blank" title="https://mp.weixin.qq.com/s/U3HhCz5WiAMNM7foxuTa0w" ref="nofollow noopener noreferrer">《前端高手才知道的秘密：Blob 居然这么强大》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FX-MSa0CHwVW_qgPezbpMUA" target="_blank" title="https://mp.weixin.qq.com/s/X-MSa0CHwVW_qgPezbpMUA" ref="nofollow noopener noreferrer">《这 5 个冷门 HTML 标签，让我直接删了100 行 JS 代码》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FsMAKhSLNvmU1ddxg0yv9Fg" target="_blank" title="https://mp.weixin.qq.com/s/sMAKhSLNvmU1ddxg0yv9Fg" ref="nofollow noopener noreferrer">《重构了20个SpringBoot项目后，总结出这套稳定高效的架构设计》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F184BGM_pdMFLc0ASrferwQ" target="_blank" title="https://mp.weixin.qq.com/s/184BGM_pdMFLc0ASrferwQ" ref="nofollow noopener noreferrer">《代码里全是 new 对象，真的很 Low 吗？我认真想了一晚》</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[不再费脑, 手算 Attention 公式, 理解 Transformer 注意力的数学本质]]></title>    <link>https://juejin.cn/post/7592079304924692490</link>    <guid>https://juejin.cn/post/7592079304924692490</guid>    <pubDate>2026-01-07T00:46:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592079304924692490" data-draft-id="7592062873829900338" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="不再费脑, 手算 Attention 公式, 理解 Transformer 注意力的数学本质"/> <meta itemprop="keywords" content="人工智能,AIGC,LLM"/> <meta itemprop="datePublished" content="2026-01-07T00:46:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="印刻君"/> <meta itemprop="url" content="https://juejin.cn/user/572216818014568"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            不再费脑, 手算 Attention 公式, 理解 Transformer 注意力的数学本质
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/572216818014568/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    印刻君
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T00:46:23.000Z" title="Wed Jan 07 2026 00:46:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好, 我是印刻君. 今天我们来聊注意力 (Attention) , 这个 Transfromer 架构的核心.</p>
<p>不少科普文章, 在介绍到注意力时, 都会刻意绕过数学公式, 单纯靠比喻来解释注意力.</p>
<p>但靠比喻感知注意力, 跟完全理解它始终会有一层隔阂, 毕竟看地图永远不等于走一遍路.</p>
<p>本篇文章, 我们会通过一个例子, 亲自过一遍计算注意力的核心公式, 一起探究注意力机制的数学本质.</p>
<blockquote>
<p>本文涉及 Transformer 基础架构, 矩阵运算, 若你对这两部分不熟悉, 建议先补全前置知识, 阅读体验会更好:</p>
<p>不熟悉 Transformer 基础架构, 可以看我的文章: <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F_JNT0A6ud8QtGpK319a8uw" target="_blank" title="https://mp.weixin.qq.com/s/_JNT0A6ud8QtGpK319a8uw" ref="nofollow noopener noreferrer">数学不好也能懂: 解读 AI 经典论文《Attention is All You Need》与大模型生成原理</a></p>
<p>不熟悉矩阵运算, 可以看我的文章: <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FyjY8xLaKHPWcWXqpYL5SBw" target="_blank" title="https://mp.weixin.qq.com/s/yjY8xLaKHPWcWXqpYL5SBw" ref="nofollow noopener noreferrer">不再费脑, 写给 AI 爱好者的矩阵 (Matrix) 入门指南</a></p>
</blockquote>
<h2 data-id="heading-0">先建立直觉：注意力到底是什么？</h2>
<p>在啃公式之前, 我们把注意力这个概念放到生活场景里. 毕竟所有复杂的技术, 本质都是对现实世界的抽象.</p>
<img width="300" height="45" alt="微信底部菜单截图" src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6c5458bee8d4b62a6a270d623c7c53d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2w5Yi75ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768351970&amp;x-signature=fN0xC456QVsUDLZ3%2B41SkUePuJM%3D" loading="lazy"/>
<p>看这张微信菜单截图, 你是不是瞬间被消息图标上的红色提示吸引? 这就是的 "注意力分配": 大脑会自动筛选信息, 优先聚焦到有价值, 有异常的部分.</p>
<p>语言理解中的注意力同理. 比如这句话: "印刻君没有吃晚餐, 因为他不饿".</p>
<p>当你读到 "他" 这个代词时, 大脑会自动把注意力集中在 "印刻君" 上, 而不是 "晚餐" 上. 这是因为你的大脑已经通过上下文, 判断出 "他" 这个代词和 "印刻君" 的关联性更强.</p>
<p>Transformer 里的注意力, 也是在做同样的事情: <strong>针对句子里的每个词, 计算它和其他所有词的关联性得分, 再根据得分重新整合信息.</strong> 高分分配的注意力多, 低分分配的注意力少.</p>
<p>而我们今天要过的公式, 就是把这个先计算关联性得分, 后整合信息的过程, 用数学语言精确描述.</p>
<h2 data-id="heading-1">手算 Attention 公式的每一步</h2>
<h3 data-id="heading-2">0 Attention 公式核心解读</h3>
<p>在动手计算前，我们先看注意力机制的核心公式:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>A</mi><mi>t</mi><mi>t</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo>=</mo><mi>s</mi><mi>o</mi><mi>f</mi><mi>t</mi><mi>m</mi><mi>a</mi><mi>x</mi><mo stretchy="false">(</mo><mfrac><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mfrac><mo stretchy="false">)</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">Attention(Q, K, V) = softmax(\frac{QK^T}{\sqrt{d_k}})V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">A</span><span class="mord mathnormal">tt</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4483em;vertical-align:-0.93em;"/><span class="mord mathnormal">so</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">t</span><span class="mord mathnormal">ma</span><span class="mord mathnormal">x</span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.2528em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"/><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702&#10;c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14&#10;c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54&#10;c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10&#10;s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429&#10;c69,-144,104.5,-217.7,106.5,-221&#10;l0 -0&#10;c5.3,-9.3,12,-14,20,-14&#10;H400000v40H845.2724&#10;s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7&#10;c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z&#10;M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span/></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose">)</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span></div>
<p>其中, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mi>t</mi><mi>t</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Attention(Q, K, V)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">A</span><span class="mord mathnormal">tt</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span></span></span></span></span> 是整合了上下文信息的全新矩阵. 公式的意思是, 这个矩阵先由 Q 与 K 计算注意力权重，再在注意力权重的基础上乘以 V.</p>
<ol>
<li>公式中的 Q, K, V 是三个核心输入, 后续我们会详细说明它们的由来和作用;</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">QK^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0358em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span> 表示查询矩阵与键矩阵的转置相乘;</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mrow><annotation encoding="application/x-tex">\sqrt{d_k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.1828em;"/><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"/><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702&#10;c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14&#10;c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54&#10;c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10&#10;s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429&#10;c69,-144,104.5,-217.7,106.5,-221&#10;l0 -0&#10;c5.3,-9.3,12,-14,20,-14&#10;H400000v40H845.2724&#10;s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7&#10;c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z&#10;M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span/></span></span></span></span></span></span></span></span> 是 K 向量维度的平方根, 作用是对得分进行缩放;</li>
<li>Softmax 对缩放后的得分矩阵做归一化处理, 将每一行的得分转换为 0 到 1 之间的概率值;</li>
<li>乘以 V, 是用归一化后的注意力权重矩阵, 提取出所有词的价值信息</li>
</ol>
<h3 data-id="heading-3">1 准备输入向量 A, B, C</h3>
<p>为简化计算, 我们做一个假设: 一句话只有 A, B, C 三个词, 且每个词都用 4 维向量表示 (真实模型中向量维度有几百维, 这里选 4 维只是为了好算).</p>
<p>以下是这三个词的初始词嵌入向量:</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>=</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mn>3</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">A = [0, 1, 2, 3]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">3</span><span class="mclose">]</span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mo>=</mo><mo stretchy="false">[</mo><mn>4</mn><mo separator="true">,</mo><mn>5</mn><mo separator="true">,</mo><mn>6</mn><mo separator="true">,</mo><mn>7</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">B = [4, 5, 6, 7]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">4</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">5</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">6</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">7</span><span class="mclose">]</span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mo>=</mo><mo stretchy="false">[</mo><mn>8</mn><mo separator="true">,</mo><mn>9</mn><mo separator="true">,</mo><mn>10</mn><mo separator="true">,</mo><mn>11</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">C = [8, 9, 10, 11]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">8</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">9</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">10</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">11</span><span class="mclose">]</span></span></span></span></span></p>
<p>这 3 个向量会被组合成一个矩阵 X</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>X</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>5</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>6</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>7</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>8</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>9</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>10</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>11</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">X = \begin{bmatrix}
0 &amp; 1 &amp; 2 &amp; 3 \\
4 &amp; 5 &amp; 6 &amp; 7 \\
8 &amp; 9 &amp; 10 &amp; 11
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">4</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">5</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">9</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">6</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">10</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">3</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">7</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">11</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<blockquote>
<p>这些向量是从哪来的?</p>
<p>这些向量最初值是随机分配的, 模型通过大量训练, "反向传播" 后得到最后的值. 这里用简单整数代替真实向量的值, 只是为了演示计算过程.</p>
<p>不熟悉词向量, 可以看我的文章: <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F0TLOqr84vS9J1fw1qs2pag" target="_blank" title="https://mp.weixin.qq.com/s/0TLOqr84vS9J1fw1qs2pag" ref="nofollow noopener noreferrer">大模型如何分辨 “狼” 与 “狗” —— 词向量的训练过程</a></p>
</blockquote>
<h3 data-id="heading-4">2 准备 3 个核心矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mi>Q</mi></msup></mrow><annotation encoding="application/x-tex">W^Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span></span></span></span></span></span></span></span></span>, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mi>K</mi></msup></mrow><annotation encoding="application/x-tex">W^K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span></span></span></span></span></span></span></span>, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mi>V</mi></msup></mrow><annotation encoding="application/x-tex">W^V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span></span></span></span></span></span></span></span></span></h3>
<p>Attention 中的 Q、K、V 矩阵, 是由 3 个矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mi>Q</mi></msup></mrow><annotation encoding="application/x-tex">W^Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span></span></span></span></span></span></span></span></span>, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mi>K</mi></msup></mrow><annotation encoding="application/x-tex">W^K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span></span></span></span></span></span></span></span>, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mi>V</mi></msup></mrow><annotation encoding="application/x-tex">W^V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span></span></span></span></span></span></span></span></span>, 和输入矩阵 X 相乘得到</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mi>Q</mi></msup></mrow><annotation encoding="application/x-tex">W^Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span></span></span></span></span></span></span></span></span>, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mi>K</mi></msup></mrow><annotation encoding="application/x-tex">W^K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span></span></span></span></span></span></span></span>, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mi>V</mi></msup></mrow><annotation encoding="application/x-tex">W^V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span></span></span></span></span></span></span></span></span> 是用来做向量转换的矩阵, 专业叫法是 "投影矩阵".</p>
<p>我们先给出这三个矩阵的具体数值（同样为了好算，用简单矩阵代替真实模型的随机初始化矩阵）:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>W</mi><mi>Q</mi></msup><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mspace width="1em"/><msup><mi>W</mi><mi>K</mi></msup><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">W^Q = \begin{bmatrix}
1 &amp; 0 \\
1 &amp; 0 \\
0 &amp; 1 \\
0 &amp; 1
\end{bmatrix}
\quad
W^K = \begin{bmatrix}
0 &amp; 1 \\
0 &amp; 1 \\
1 &amp; 0 \\
1 &amp; 0
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8913em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:4.8em;vertical-align:-2.15em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.65em;"><span class="pstrut" style="height:6.8em;"/><span style="width:0.667em;height:4.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewbox="0 0 667 4800"><path d="M403 1759 V84 H666 V0 H319 V1759 v1200 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v1200 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.65em;"><span class="pstrut" style="height:6.8em;"/><span style="width:0.667em;height:4.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewbox="0 0 667 4800"><path d="M347 1759 V0 H0 V84 H263 V1759 v1200 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v1200 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span/></span></span></span></span></span></span><span class="mspace" style="margin-right:1em;"/><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:4.8em;vertical-align:-2.15em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.65em;"><span class="pstrut" style="height:6.8em;"/><span style="width:0.667em;height:4.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewbox="0 0 667 4800"><path d="M403 1759 V84 H666 V0 H319 V1759 v1200 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v1200 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.65em;"><span class="pstrut" style="height:6.8em;"/><span style="width:0.667em;height:4.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewbox="0 0 667 4800"><path d="M347 1759 V0 H0 V84 H263 V1759 v1200 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v1200 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>W</mi><mi>V</mi></msup><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">W^V = \begin{bmatrix}
1 &amp; 0 \\
0 &amp; 1 \\
1 &amp; 0 \\
0 &amp; 1
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8913em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:4.8em;vertical-align:-2.15em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.65em;"><span class="pstrut" style="height:6.8em;"/><span style="width:0.667em;height:4.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewbox="0 0 667 4800"><path d="M403 1759 V84 H666 V0 H319 V1759 v1200 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v1200 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.65em;"><span class="pstrut" style="height:6.8em;"/><span style="width:0.667em;height:4.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewbox="0 0 667 4800"><path d="M347 1759 V0 H0 V84 H263 V1759 v1200 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v1200 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<blockquote>
<p>这三个矩阵是从哪来的？</p>
<p>和词嵌入向量类似, Transformer 架构搭建好后, 这三个矩阵就存在了, 但里面的数值都是随机的.模型训练的核心过程, 就是通过 "反向传播" 不断调整这三个矩阵（以及其他所有参数）的数值.直到它们能精准捕捉词与词的关联性.</p>
<p>简单说: 训练 Transformer, 本质就是在调优这三个矩阵的数字, 让 Q 和 K 的匹配更合理, V 的信息整合更有效.</p>
</blockquote>
<h3 data-id="heading-5">3 计算 Q, K, V 矩阵</h3>
<p>Q, K, V 的计算逻辑很简单: 把所有输入向量组成一个输入矩阵, 记为 X, 分别和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mi>Q</mi></msup></mrow><annotation encoding="application/x-tex">W^Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span></span></span></span></span></span></span></span></span>、<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mi>K</mi></msup></mrow><annotation encoding="application/x-tex">W^K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span></span></span></span></span></span></span></span>、<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mi>V</mi></msup></mrow><annotation encoding="application/x-tex">W^V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span></span></span></span></span></span></span></span></span> 做矩阵乘法, 结果就是 Q, K, V 矩阵.</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>X</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>5</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>6</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>7</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>8</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>9</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>10</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>11</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">X = \begin{bmatrix}
0 &amp; 1 &amp; 2 &amp; 3 \\
4 &amp; 5 &amp; 6 &amp; 7 \\
8 &amp; 9 &amp; 10 &amp; 11
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">4</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">5</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">9</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">6</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">10</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">3</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">7</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">11</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<ul>
<li>第一行 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mn>3</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0, 1, 2, 3]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">3</span><span class="mclose">]</span></span></span></span></span> 是向量 A;</li>
<li>第二行 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>4</mn><mo separator="true">,</mo><mn>5</mn><mo separator="true">,</mo><mn>6</mn><mo separator="true">,</mo><mn>7</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[4, 5, 6, 7]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">4</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">5</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">6</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">7</span><span class="mclose">]</span></span></span></span></span> 是向量 B;</li>
<li>第三行 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>8</mn><mo separator="true">,</mo><mn>9</mn><mo separator="true">,</mo><mn>10</mn><mo separator="true">,</mo><mn>11</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[8, 9, 10, 11]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">8</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">9</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">10</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">11</span><span class="mclose">]</span></span></span></span></span> 是向量 C.</li>
</ul>
<h4 data-id="heading-6">3.1 计算 Q 矩阵</h4>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>Q</mi><mo>=</mo><mi>X</mi><mo>⋅</mo><msup><mi>W</mi><mi>Q</mi></msup></mrow><annotation encoding="application/x-tex">Q = X \cdot W^Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8913em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span></span></span></span></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>5</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>6</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>7</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>8</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>9</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>10</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>11</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>⋅</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">= \begin{bmatrix}
0 &amp; 1 &amp; 2 &amp; 3 \\
4 &amp; 5 &amp; 6 &amp; 7 \\
8 &amp; 9 &amp; 10 &amp; 11
\end{bmatrix} \cdot \begin{bmatrix}
1 &amp; 0 \\
1 &amp; 0 \\
0 &amp; 1 \\
0 &amp; 1
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">4</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">5</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">9</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">6</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">10</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">3</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">7</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">11</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:4.8em;vertical-align:-2.15em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.65em;"><span class="pstrut" style="height:6.8em;"/><span style="width:0.667em;height:4.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewbox="0 0 667 4800"><path d="M403 1759 V84 H666 V0 H319 V1759 v1200 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v1200 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.65em;"><span class="pstrut" style="height:6.8em;"/><span style="width:0.667em;height:4.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewbox="0 0 667 4800"><path d="M347 1759 V0 H0 V84 H263 V1759 v1200 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v1200 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>5</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>9</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>13</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>17</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>21</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">= \begin{bmatrix}
1 &amp; 5  \\
9 &amp; 13 \\
17 &amp; 21
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">9</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">17</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">5</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">13</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">21</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<ul>
<li>Q 矩阵的第一行是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>Q</mi><mi>A</mi></msup></mrow><annotation encoding="application/x-tex">Q^A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0358em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span></span></span></span></span></span></span></span></span> , 代表向量 A 的查询向量;</li>
<li>第二行是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>Q</mi><mi>B</mi></msup></mrow><annotation encoding="application/x-tex">Q^B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0358em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span></span></span></span></span></span></span></span></span>, 代表向量 B 的查询向量;</li>
<li>第三行是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>Q</mi><mi>C</mi></msup></mrow><annotation encoding="application/x-tex">Q^C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0358em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span></span></span></span></span></span></span></span></span></span></span></span>, 代表向量 C 的查询向量.</li>
</ul>
<h4 data-id="heading-7">3.2 计算 K 矩阵</h4>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>K</mi><mo>=</mo><mi>X</mi><mo>⋅</mo><msup><mi>W</mi><mi>K</mi></msup></mrow><annotation encoding="application/x-tex">K = X \cdot W^K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8913em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span></span></span></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>5</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>6</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>7</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>8</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>9</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>10</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>11</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>⋅</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">= \begin{bmatrix}
0 &amp; 1 &amp; 2 &amp; 3 \\
4 &amp; 5 &amp; 6 &amp; 7 \\
8 &amp; 9 &amp; 10 &amp; 11
\end{bmatrix} \cdot \begin{bmatrix}
0 &amp; 1 \\
0 &amp; 1 \\
1 &amp; 0 \\
1 &amp; 0
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">4</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">5</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">9</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">6</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">10</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">3</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">7</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">11</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:4.8em;vertical-align:-2.15em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.65em;"><span class="pstrut" style="height:6.8em;"/><span style="width:0.667em;height:4.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewbox="0 0 667 4800"><path d="M403 1759 V84 H666 V0 H319 V1759 v1200 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v1200 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.65em;"><span class="pstrut" style="height:6.8em;"/><span style="width:0.667em;height:4.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewbox="0 0 667 4800"><path d="M347 1759 V0 H0 V84 H263 V1759 v1200 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v1200 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>5</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>13</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>9</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>21</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>17</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">= \begin{bmatrix}
5 &amp; 1  \\
13 &amp; 9 \\
21 &amp; 17
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">5</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">13</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">21</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">9</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">17</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<ul>
<li>K 矩阵的第一行是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>k</mi><mi>A</mi></msup></mrow><annotation encoding="application/x-tex">k^A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span></span></span></span></span></span></span></span></span>, 代表向量 A 的键向量;</li>
<li>第二行是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>K</mi><mi>B</mi></msup></mrow><annotation encoding="application/x-tex">K^B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span></span></span></span></span></span></span></span></span>, 代表向量 B 的键向量;</li>
<li>第三行是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>K</mi><mi>C</mi></msup></mrow><annotation encoding="application/x-tex">K^C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span></span></span></span></span></span></span></span></span></span></span></span>, 代表向量 C 的键向量.</li>
</ul>
<h4 data-id="heading-8">3.3 计算 V 矩阵</h4>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>V</mi><mo>=</mo><mi>X</mi><mo>⋅</mo><msup><mi>W</mi><mi>V</mi></msup></mrow><annotation encoding="application/x-tex">V = X \cdot W^V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8913em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span></span></span></span></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>5</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>6</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>7</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>8</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>9</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>10</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>11</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>⋅</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">= \begin{bmatrix}
0 &amp; 1 &amp; 2 &amp; 3 \\
4 &amp; 5 &amp; 6 &amp; 7 \\
8 &amp; 9 &amp; 10 &amp; 11
\end{bmatrix} \cdot \begin{bmatrix}
1 &amp; 0 \\
0 &amp; 1 \\
1 &amp; 0 \\
0 &amp; 1
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">4</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">5</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">9</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">6</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">10</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">3</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">7</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">11</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:4.8em;vertical-align:-2.15em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.65em;"><span class="pstrut" style="height:6.8em;"/><span style="width:0.667em;height:4.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewbox="0 0 667 4800"><path d="M403 1759 V84 H666 V0 H319 V1759 v1200 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v1200 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.65em;"><span class="pstrut" style="height:6.8em;"/><span style="width:0.667em;height:4.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewbox="0 0 667 4800"><path d="M347 1759 V0 H0 V84 H263 V1759 v1200 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v1200 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>10</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>12</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>18</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>20</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">= \begin{bmatrix}
2 &amp; 4 \\
10 &amp; 12 \\
18 &amp; 20
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">10</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">18</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">4</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">12</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">20</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<h4 data-id="heading-9">3.4 Q、K、V 的作用</h4>
<p>算到这, 我们已经得到了 Q, K, V 三个矩阵, 它们是 Q, K, V 向量的组合, 我们用字典来打个比方:</p>
<ul>
<li>Q (query, 查询向量): 好比我们查字典时输的<strong>关键词</strong>, 放到模型里, 就是当前这个词想找谁, 想和谁搭关系;</li>
<li>K (key, 键向量), 好比字典里所有词条的<strong>标题</strong>. 字典里每个词都有个标题, 模型里每个词也都有个键向量, 专门用来和其他词的查询向量做配对;</li>
<li>V (value, 价值向量), 好比字典标题对应的<strong>解释内容</strong>. 你用关键词 Q 找到对应的标题 K 后, 真正要的是标题底下的解释; 而 V 就是每个词身上最核心的信息.</li>
</ul>
<h3 data-id="heading-10">4 计算 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">QK^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0358em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span></h3>
<p>公式里的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>K</mi><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">K^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span> 是 K 矩阵的 "转置", 也就是把 K 的行和列互换</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>K</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>5</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>13</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>9</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>21</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>17</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">K = \begin{bmatrix}
5 &amp; 1  \\
13 &amp; 9 \\
21 &amp; 17
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">5</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">13</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">21</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">9</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">17</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>K</mi><mi>T</mi></msup><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>5</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>13</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>21</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>9</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>17</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">K^T = \begin{bmatrix}
5 &amp; 13 &amp; 21  \\
1 &amp; 9 &amp; 17 
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8913em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">5</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">13</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">9</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">21</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">17</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></div>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">QK^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0358em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span> 的结果, 就是 "每个词与其他所有词的关联性得分", 也叫 "注意力得分".</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>5</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>9</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>13</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>17</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>21</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>⋅</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>5</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>13</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>21</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>9</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>17</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">QK^T = \begin{bmatrix}
1 &amp; 5  \\
9 &amp; 13 \\
17 &amp; 21
\end{bmatrix} \cdot \begin{bmatrix}
5 &amp; 13 &amp; 21  \\
1 &amp; 9 &amp; 17 \\
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0858em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">9</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">17</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">5</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">13</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">21</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">5</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">13</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">9</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">21</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">17</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>10</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>58</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>106</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>58</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>234</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>400</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>106</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>400</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>714</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">= \begin{bmatrix}
10 &amp; 58 &amp; 106 \\
58 &amp; 234 &amp; 400 \\
106 &amp; 400 &amp; 714
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">10</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">58</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">106</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">58</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">234</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">400</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">106</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">400</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">714</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">QK^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0358em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span> 得到的矩阵, 每一行对应一个词的关联得分表:</p>
<ul>
<li>第一行是 A 对 A, B, C 的得分;</li>
<li>第二行是 B 对 A, B, C 的得分;</li>
<li>第三行是 C 对 A, B, C 的得分.</li>
</ul>
<p>得分越高, 说明两个词的关联性越强.</p>
<h3 data-id="heading-11">5 除以 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mrow><annotation encoding="application/x-tex">\sqrt{d_k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.1828em;"/><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"/><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702&#10;c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14&#10;c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54&#10;c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10&#10;s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429&#10;c69,-144,104.5,-217.7,106.5,-221&#10;l0 -0&#10;c5.3,-9.3,12,-14,20,-14&#10;H400000v40H845.2724&#10;s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7&#10;c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z&#10;M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span/></span></span></span></span></span></span></span></span></h3>
<p>公式里的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mrow><annotation encoding="application/x-tex">\sqrt{d_k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.1828em;"/><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"/><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702&#10;c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14&#10;c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54&#10;c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10&#10;s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429&#10;c69,-144,104.5,-217.7,106.5,-221&#10;l0 -0&#10;c5.3,-9.3,12,-14,20,-14&#10;H400000v40H845.2724&#10;s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7&#10;c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z&#10;M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span/></span></span></span></span></span></span></span></span> 是键向量的维度 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">d_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 的平方根.</p>
<p>这里 K 向量是 2 维, 所以</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub><mo>=</mo><mn>2</mn><mo separator="true">,</mo><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt><mo>≈</mo><mn>1.414</mn></mrow><annotation encoding="application/x-tex">d_k = 2, \sqrt{d_k} \approx 1.414</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.24em;vertical-align:-0.2339em;"/><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0061em;"><span class="svg-align" style="top:-3.2em;"><span class="pstrut" style="height:3.2em;"/><span class="mord" style="padding-left:1em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.9661em;"><span class="pstrut" style="height:3.2em;"/><span class="hide-tail" style="min-width:1.02em;height:1.28em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.28em" viewbox="0 0 400000 1296" preserveaspectratio="xMinYMin slice"><path d="M263,681c0.7,0,18,39.7,52,119&#10;c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120&#10;c340,-704.7,510.7,-1060.3,512,-1067&#10;l0 -0&#10;c4.7,-7.3,11,-11,19,-11&#10;H40000v40H1012.3&#10;s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232&#10;c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1&#10;s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26&#10;c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z&#10;M1001 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2339em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1.414</span></span></span></span></span></div>
<p>为什么要缩放？因为当 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">d_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 很大时, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">QK^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0358em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span> 的得分会变得很大, 代入 Softmax 函数后, 指数运算会导致数值要么趋近于无穷大, 要么趋近于 0, 缩放后能让得分更稳定.</p>
<p>计算缩放后的结果:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mfrac></mrow><annotation encoding="application/x-tex">\frac{QK^T}{\sqrt{d_k}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.4483em;vertical-align:-0.93em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.2528em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"/><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702&#10;c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14&#10;c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54&#10;c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10&#10;s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429&#10;c69,-144,104.5,-217.7,106.5,-221&#10;l0 -0&#10;c5.3,-9.3,12,-14,20,-14&#10;H400000v40H845.2724&#10;s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7&#10;c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z&#10;M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span/></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>10</mn><mi mathvariant="normal">/</mi><mn>1.414</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>58</mn><mi mathvariant="normal">/</mi><mn>1.414</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>106</mn><mi mathvariant="normal">/</mi><mn>1.414</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>58</mn><mi mathvariant="normal">/</mi><mn>1.414</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>234</mn><mi mathvariant="normal">/</mi><mn>1.414</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>400</mn><mi mathvariant="normal">/</mi><mn>1.414</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>106</mn><mi mathvariant="normal">/</mi><mn>1.414</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>400</mn><mi mathvariant="normal">/</mi><mn>1.414</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>714</mn><mi mathvariant="normal">/</mi><mn>1.414</mn></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">= \begin{bmatrix}
10/1.414 &amp; 58/1.414 &amp; 106/1.414 \\
58/1.414 &amp; 234/1.414 &amp; 400/1.414 \\
106/1.414 &amp; 400/1.414 &amp; 714/1.414
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">10/1.414</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">58/1.414</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">106/1.414</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">58/1.414</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">234/1.414</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">400/1.414</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">106/1.414</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">400/1.414</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">714/1.414</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo>≈</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>7.07</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>41.02</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>74.96</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>41.02</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>165.48</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>282.84</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>74.96</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>282.84</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>504.90</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\approx \begin{bmatrix}
7.07 &amp; 41.02 &amp; 74.96 \\
41.02 &amp; 165.48 &amp; 282.84 \\
74.96 &amp; 282.84 &amp; 504.90
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4831em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">7.07</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">41.02</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">74.96</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">41.02</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">165.48</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">282.84</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">74.96</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">282.84</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">504.90</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<h3 data-id="heading-12">6 softmax 归一化</h3>
<p>softmax 函数的作用是归一化, 把每一行的得分转换成 0 到 1 之间的概率, 且每一行的概率和为 1.</p>
<p>假设有一个输入向量 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi><mo>=</mo><mo stretchy="false">[</mo><msub><mi>z</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>z</mi><mn>2</mn></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><msub><mi>z</mi><mi>k</mi></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">z = [z_1, z_2, ..., z_k]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">]</span></span></span></span></span>, 那么对于向量中的第 i 个元素，Softmax 函数的定义如下:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>S</mi><mi>o</mi><mi>f</mi><mi>t</mi><mi>m</mi><mi>a</mi><mi>x</mi><mo stretchy="false">(</mo><msub><mi>z</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mfrac><msup><mi>e</mi><msub><mi>z</mi><mi>i</mi></msub></msup><mrow><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>K</mi></munderover><msup><mi>e</mi><msub><mi>z</mi><mi>j</mi></msub></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">Softmax(z_i) = \frac{e^{z_i}}{\sum_{j=1}^{K} e^{z_j}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">t</span><span class="mord mathnormal">ma</span><span class="mord mathnormal">x</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.6484em;vertical-align:-1.307em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3414em;"><span style="top:-2.1288em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6065em;"><span style="top:-3.0051em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.044em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.044em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.307em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p>这里有个问题, 缩放后的得分最大已经到 504.90, 直接计算 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mn>5</mn></msup><mn>04.90</mn></mrow><annotation encoding="application/x-tex">e^504.90</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span></span></span></span></span><span class="mord">04.90</span></span></span></span></span> 会得到一个天文数字, 计算机无法精确计算.</p>
<p>这时候可以用 Softmax 的一个关键性质: <strong>给同一行的所有元素同时减去该行的最大值, 结果不变.</strong></p>
<p>我们以第一行 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>7.07</mn><mo separator="true">,</mo><mn>41.02</mn><mo separator="true">,</mo><mn>74.96</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[7.07, 41.02, 74.96]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">7.07</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">41.02</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">74.96</span><span class="mclose">]</span></span></span></span></span> 为例, 每个元素都减 74.96 , 得到</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo stretchy="false">[</mo><mo>−</mo><mn>67.89</mn><mo separator="true">,</mo><mo>−</mo><mn>33.94</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[-67.89, -33.94, 0]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">−</span><span class="mord">67.89</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">−</span><span class="mord">33.94</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">0</span><span class="mclose">]</span></span></span></span></span></div>
<p>此时计算</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>e</mi><mrow><mo>−</mo><mn>67.89</mn></mrow></msup><mo>≈</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">e^{-67.89} \approx 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8641em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">67.89</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>e</mi><mrow><mo>−</mo><mn>33.94</mn></mrow></msup><mo>≈</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">e^{-33.94} \approx 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8641em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">33.94</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>e</mi><mn>0</mn></msup><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">e^0 = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8641em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></div>
<p>所以第一行 softmax 的结果是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0, 0, 1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mclose">]</span></span></span></span></span>.</p>
<p>第二行和第三行同理, 计算后得到完整的 Softmax 矩阵:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>s</mi><mi>o</mi><mi>f</mi><mi>t</mi><mi>m</mi><mi>a</mi><mi>x</mi><mo stretchy="false">(</mo><mfrac><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mfrac><mo stretchy="false">)</mo><mo>≈</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">softmax(\frac{QK^T}{\sqrt{d_k}}) \approx \begin{bmatrix}
0 &amp; 0 &amp; 1\\
0 &amp; 0 &amp; 1\\
0 &amp; 0 &amp; 1
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.4483em;vertical-align:-0.93em;"/><span class="mord mathnormal">so</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">t</span><span class="mord mathnormal">ma</span><span class="mord mathnormal">x</span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.2528em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"/><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702&#10;c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14&#10;c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54&#10;c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10&#10;s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429&#10;c69,-144,104.5,-217.7,106.5,-221&#10;l0 -0&#10;c5.3,-9.3,12,-14,20,-14&#10;H400000v40H845.2724&#10;s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7&#10;c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z&#10;M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span/></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<p>每一行的概率代表当前词对其他词的关注权重:</p>
<ul>
<li>第一行 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0, 0, 1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mclose">]</span></span></span></span></span>, 说明 A 几乎把所有注意力都放在了 C 上;</li>
<li>第二行 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0, 0, 1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mclose">]</span></span></span></span></span>, 说明 B 也把所有注意力放在了 C 上;</li>
<li>第三行 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0, 0, 1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mclose">]</span></span></span></span></span>, 说明 C 只关注自己.</li>
</ul>
<h3 data-id="heading-13">7 乘以 V</h3>
<p>最后一步是把 Softmax 得到的关注权重, 和 V 矩阵 (词的价值信息) 相乘. 本质是按权重整合其他词的信息, 得到每个词的最终向量 (融合了上下文信息).</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>A</mi><mi>t</mi><mi>t</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Attention(Q, K, V)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">A</span><span class="mord mathnormal">tt</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo>=</mo><mi>s</mi><mi>o</mi><mi>f</mi><mi>t</mi><mi>m</mi><mi>a</mi><mi>x</mi><mo stretchy="false">(</mo><mfrac><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mfrac><mo stretchy="false">)</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">= softmax(\frac{QK^T}{\sqrt{d_k}})V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4483em;vertical-align:-0.93em;"/><span class="mord mathnormal">so</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">t</span><span class="mord mathnormal">ma</span><span class="mord mathnormal">x</span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.2528em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"/><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702&#10;c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14&#10;c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54&#10;c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10&#10;s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429&#10;c69,-144,104.5,-217.7,106.5,-221&#10;l0 -0&#10;c5.3,-9.3,12,-14,20,-14&#10;H400000v40H845.2724&#10;s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7&#10;c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z&#10;M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span/></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose">)</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>⋅</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>10</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>12</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>18</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>20</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">= \begin{bmatrix}
0 &amp; 0 &amp; 1\\
0 &amp; 0 &amp; 1\\
0 &amp; 0 &amp; 1
\end{bmatrix} \cdot \begin{bmatrix}
2 &amp; 4  \\
10 &amp; 12 \\
18 &amp; 20 
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">10</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">18</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">4</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">12</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">20</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>18</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>20</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>18</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>20</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>18</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>20</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">= \begin{bmatrix}
18 &amp; 20 \\
18 &amp; 20 \\
18 &amp; 20
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">18</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">18</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">18</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">20</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">20</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">20</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<h2 data-id="heading-14">总结：注意力的数学本质到底是什么？</h2>
<p>我们看最终结果, 原本 A, B, C 的向量各不相同, 但经过注意力计算后, A 和 B 的向量融合了 C 的向量信息, 不再是原来孤立的自己. 换句话说, A, B, C 通过阅读上下文, 不断调整自身的语义, 从而实现精确的理解.</p>
<p>比如翻译 "我喜欢吃苹果" 这句话时, "苹果" 的查询向量 Q 会和 "吃" 的键向量 K 计算出高关联权重, 随后这个高权重会让模型在整合价值信息 V 时, 更侧重把 "吃" 的语义融入到 "苹果" 自身的价值向量中, 最终精准判断 "苹果" 在这里指水果, 而非手机.</p>
<p>放到真实 transformer 里, 这个过程会更复杂 (比如多注意力头, 更高维度的向量), 但核心逻辑没变. 就是 "用数学方法计算词与词的关联性, 再按关联性权重整合上下文信息".</p>
<p>我是印刻君, 一位探索 AI 的前端程序员, 关注我, 让 AI 知识有温度, 技术落地有深度.</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[拒绝“假死”：为何上滑关闭是测试大忌？揭秘 iOS 真实 OOM 触发指南]]></title>    <link>https://juejin.cn/post/7592147054785740851</link>    <guid>https://juejin.cn/post/7592147054785740851</guid>    <pubDate>2026-01-07T00:53:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592147054785740851" data-draft-id="7592147054785708083" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="拒绝“假死”：为何上滑关闭是测试大忌？揭秘 iOS 真实 OOM 触发指南"/> <meta itemprop="keywords" content="Swift,APP,Apple"/> <meta itemprop="datePublished" content="2026-01-07T00:53:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大熊猫侯佩"/> <meta itemprop="url" content="https://juejin.cn/user/4292907536222152"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            拒绝“假死”：为何上滑关闭是测试大忌？揭秘 iOS 真实 OOM 触发指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4292907536222152/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大熊猫侯佩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T00:53:29.000Z" title="Wed Jan 07 2026 00:53:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af403cf97e64497a861c8f117ad940fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352008&amp;x-signature=iVqRESp6oHre3Kc6SSO2SSfFMoM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-0">☔️ 引子</h2>
<p>在赛博都市“新硅谷”（Neo-Silicon Valley）的第 1024 层地下室里，资深 iOS 赏金猎人——老李（Old Li），正盯着全息屏幕上一行行红色的报错代码发愁。他嘴里叼着一根早已熄灭的合成电子烟，眉头皱得能夹死一只纳米苍蝇。</p>
<p>旁边漂浮着的 AI 助手“小白”发出了机械的合成音：“警报，内存溢出测试失败。目标 App 依然像个赖皮一样活着。”</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0610212668dc490897e5304262c7824f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352008&amp;x-signature=ukDK4qJGBwAHcDyeZvUMISq26%2Fk%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>老李叹了口气：“这年头的 App，一个个都练成了‘金刚不坏之身’。我想测一下后台上传功能在**低内存（Low RAM）**情况下的表现，结果这破手机内存大得像海一样，怎么都填不满。”</p>
<p>“老板，直接在 <strong>App Switcher</strong>（多任务切换器）里把它划掉不就行了？”小白天真地问道。</p>
<p>**在本篇博文中，您将学到如下内容：
**</p>
<ul>
<li>☔️ 引子</li>
<li>🕵️‍♂️ 第一章：真死还是假死？这是一个问题</li>
<li>🔮 第二章：失传的“清内存大法”</li>
<li>🛠️ 步骤一：召唤“假肢”（Assistive Touch）</li>
<li>🧨 步骤二：准备“关机仪式”</li>
<li>🩸 步骤三：致命一击（The Purge）</li>
<li>🧟‍♂️ 第三章：为什么我们需要这种“假死”？</li>
<li>⚖️ 第四章：技术验尸——“被杀”与“自杀”的区别</li>
<li>🎬 终章：深藏功与名</li>
<li/>
</ul>
<p>老李冷笑一声，敲了一下小白的金属外壳：“图样图森破！手滑杀掉那是‘斩立决’，系统因内存不足杀掉那是‘自然死亡’。对于后台任务来说，这区别可大了去了。要想骗过死神，我们得用点‘阴招’。”</p>
<p>老李从积灰的档案袋里掏出一份绝密文档——《iOS 内存清空指南》。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9936e9e816940fa907d01699e6e8a78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352008&amp;x-signature=yIQAKv9lllBgNeyNS9NJJfc9DLQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-1">🕵️‍♂️ 第一章：真死还是假死？这是一个问题</h2>
<p>最近老李接了个大活儿，要为一个 App 开发 <strong>Background Uploading</strong>（后台上传）功能。这活儿最棘手的地方在于：你得确保当系统因为 <strong>RAM constraints</strong>（内存限制）或其他不可抗力把你的 App 挂起甚至杀掉时，这上传任务还得能像“借尸还魂”一样继续跑。</p>
<p>要想测试这个场景，最直接的办法就是清空设备的 <strong>RAM memory</strong>。但这可不像在电脑上拔掉电源那么简单。</p>
<p>小白不解：“不就是上划杀进程吗？”</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b385b5e1bf04387b79318846098b284~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352008&amp;x-signature=lu6rnEU2MKo4eHcYSlLKtFBJWDM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>“错！”老李严肃地解释道，“打开 <strong>Task Switcher</strong> 然后强行关闭 App，这在系统眼里属于‘用户主动终止’。这就像是不仅杀了人，还顺手把复活点给拆了。而我们需要的是模拟 App 被系统‘挤’出内存，这才是真正的<strong>Forced out of memory</strong>。”</p>
<p>简而言之，我们需要制造一场完美的“意外”，让 App 以为自己只是因为太胖被系统踢了出去，而不是被用户嫌弃。</p>
<hr/>
<h2 data-id="heading-2">🔮 第二章：失传的“清内存大法”</h2>
<p>幸运的是，在 iOS 的底层代码深处，藏着一个不为人知的“秘技”。这招能像灭霸打响指一样，瞬间清空 iOS 设备的 <strong>RAM memory</strong>，让你的 App 享受到和真实内存不足时一样的“暴毙”待遇。</p>
<p>老李按灭了烟头，开始向小白传授这套“还我漂漂拳”：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4925863a24004016bb9eeea03c2337d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352008&amp;x-signature=IjwbnfgqKCfoZRoFLBnLiT7YcCs%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-3">🛠️ 步骤一：召唤“假肢”（Assistive Touch）</h3>
<p>如果你的测试机是全面屏（没有 Home 键），你得先搞个虚拟的。
“去 <strong>Settings → Accessibility → Touch → Enable Assistive Touch</strong>。”老李指挥道。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6bb7e54fcaec4db38bc62d4d5f0d0d7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352008&amp;x-signature=8wccs6KLnzXE9r6RMJ0OhgJ%2FJlk%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>屏幕上瞬间浮现出一个半透明的小圆球。
“这就是通往内存地狱的钥匙。”</p>
<blockquote>
<p><strong>技术批注：</strong> 对于有实体 Home 键的老古董设备，这一步可以跳过。</p>
</blockquote>
<h3 data-id="heading-4">🧨 步骤二：准备“关机仪式”</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/561164208ea14f86af6398fbbe75ab93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352008&amp;x-signature=EmjKsWCZ%2FKIdIqJ7a5%2Bkajzqw9c%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>这一步需要一点手速，就像是在玩格斗游戏搓大招。
“听好了：<strong>Volume Up</strong>（音量加），<strong>Volume Down</strong>（音量减），然后死死按住 <strong>Power Button</strong>（电源键）！”</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf2868650808493c85a4f10a8620f728~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352008&amp;x-signature=dkA98u1vaIzYtNa4ABucz5tlHJw%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>老李的手指在机身上飞舞，直到屏幕上出现了那个熟悉的“滑动来关机”界面。</p>
<h3 data-id="heading-5">🩸 步骤三：致命一击（The Purge）</h3>
<p>“就是现在！”老李大喝一声。</p>
<p>在关机界面出现后，千万别滑那个关机条。点击刚才召唤出来的 <strong>Assistive Touch</strong> 小圆球，找到里面的 <strong>Home Button</strong>（主屏幕按钮），然后——<strong>长按它</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3d71fc1adf84f4c85039f4fe6e1e1b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352008&amp;x-signature=Sh%2F5qClXcSw%2BZLx0%2FQWfbLkLnYw%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>一直按着，直到屏幕一闪，或者突然跳回输入密码的界面。</p>
<p>“恭喜你，”老李擦了擦额头的汗，“你刚刚成功把这台设备的 <strong>RAM memory</strong> 洗劫一空。现在，后台那些苟延残喘的 App 已经被系统无情地踢出了内存。”</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/982fcc74e33f4e80a3462671d0054365~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352008&amp;x-signature=1nWBocR3BN1hveFDUV3ofYJ8zHc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-6">🧟‍♂️ 第三章：为什么我们需要这种“假死”？</h2>
<p>小白看着屏幕上被清理得干干净净的后台，数据流终于开始正常波动了。</p>
<p>“这就好比演习，”老李解释道，“当我们在开发那些依赖于 <strong>Background Resuming</strong>（后台恢复）的功能时——比如后台上传、下载，或者定位服务——模拟 <strong>Out of Memory</strong> 场景简直是救命稻草。”</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eff95a0584484197a194067fb3dc444b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352008&amp;x-signature=3QDPtvyzAoRJ9kJC2NXk4EGWX9w%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>最让老李爽的一点是，这个操作完全<strong>脱离了 Xcode</strong>。
“以前还要连着线看 Debugger，现在我可以把手机扔给隔壁 QA 部门那个只会吃薯片的测试员，告诉他：‘按这个秘籍操作，如果上传断了，就是你们的问题，如果没断，就是我的功劳。’”</p>
<hr/>
<h2 data-id="heading-7">⚖️ 第四章：技术验尸——“被杀”与“自杀”的区别</h2>
<p>为了防止小白以后出去乱说，老李决定再深入科普一下其中的<strong>Hardcore</strong>原理。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3dc9934860f4229827d6aa5cf2069ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352008&amp;x-signature=fofwSX0wU5TNT0MFq5TotLU7i%2Bo%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>一个被 <strong>Forced out of RAM</strong> 的 App，在用户眼里并没有完全死透。它依然会出现在 <strong>App Switcher</strong> 里，就像个植物人。更重要的是，任何已经注册的 <strong>Background Processes</strong>（后台进程，比如 <code>NSURLSession</code> 的后台任务）依然在系统的监管下继续运行。</p>
<ul>
<li><strong>正常死亡（Low Memory）：</strong> 当用户开了个吃内存的大游戏，或者你的 App 很久没用了，系统为了腾地儿，会把你的 App 从内存里踢出去。当用户再次点击图标时，App 会经历一次 <strong>Fresh Launch</strong>（冷启动），但系统会给机会让它处理之前没干完的后台活儿。</li>
<li><strong>非正常死亡（Force Close）：</strong> 当你在多任务界面上滑杀掉 App 时，iOS 会判定：“这刁民不想让这个 App 活了。”于是，系统会大义灭亲，<strong>禁止</strong>该 App 继续在后台搞小动作。所有的上传、下载任务会被立即 <strong>Cancelled</strong>（取消）。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3126cb43e36449f480ce58e1ac606895~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352008&amp;x-signature=aWfzie2X8H6fPTruTj2KKnpNlBA%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>所以，只有用老李刚才那招“清内存大法”，才能真实模拟用户在刷抖音、玩原神导致内存不足时，你的 App 在后台是否还能坚强地把文件传完。</p>
<hr/>
<h2 data-id="heading-8">🎬 终章：深藏功与名</h2>
<p>测试通过，全息屏幕上显示出了令人安心的绿色 <strong>SUCCESS</strong> 字样。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e305d87275d468f953a828ed5841b5b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352008&amp;x-signature=pawIO2RnGIOOFIbIoYsH9G27Hrc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>老李站起身，伸了个懒腰，骨头发出噼里啪啦的响声。“行了，小白，打包发布。今晚不用加班修 Bug 了。”</p>
<p>他看了一眼窗外新硅谷那绚烂而又冰冷的霓虹灯。在这个充满 Bug 和 Patch 的世界里，有时候，你必须学会如何正确地“杀死”你的 App，才能让它更好地活下去。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7b0131571924099a8887923a305df00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352008&amp;x-signature=VXmpzX0LmZFSAFLmjM9y4LcWTq8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>“记住，”老李走出门口前回头对小白说，“<strong>杀进程不是目的，目的是为了验证它有没有重生的勇气。</strong>”</p>
<p>大门缓缓关闭，只留下那个悬浮的 Assistive Touch 按钮，在黑暗中微微闪烁，仿佛一只窥探内存深处的眼睛。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33a0f591596f4c9da29657a625ebd295~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352008&amp;x-signature=tSvQOwDySipTIugcPoK%2FfQENSxU%3D" alt="在这里插入图片描述" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Swift 6.2 列传（第十六篇）：阿朱的“易容术”与阿紫的“毒药测试”]]></title>    <link>https://juejin.cn/post/7592130164965556262</link>    <guid>https://juejin.cn/post/7592130164965556262</guid>    <pubDate>2026-01-07T00:57:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592130164965556262" data-draft-id="7592079304924758026" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Swift 6.2 列传（第十六篇）：阿朱的“易容术”与阿紫的“毒药测试”"/> <meta itemprop="keywords" content="Swift,编程语言,Apple"/> <meta itemprop="datePublished" content="2026-01-07T00:57:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大熊猫侯佩"/> <meta itemprop="url" content="https://juejin.cn/user/4292907536222152"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Swift 6.2 列传（第十六篇）：阿朱的“易容术”与阿紫的“毒药测试”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4292907536222152/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大熊猫侯佩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T00:57:43.000Z" title="Wed Jan 07 2026 00:57:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1aa5266729241b8adc56e6824c7cfad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352263&amp;x-signature=tWbGyParC7Eh%2Bpf9uBYcL04DfwQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<blockquote>
<p><strong>摘要</strong>：在 Swift 6.2 的并发江湖中，我们迎来了两项截然不同的新功能：一项是关于<strong>极度精妙的文本侦查术</strong>（SE-0448 正则表达式向后查找断言），另一项则是关于<strong>面对应用崩溃时的从容不迫</strong>（ST-0008 退出测试）。大熊猫侯佩将与阿朱、阿紫这对姐妹花，共同演绎这冰火两重天的技术奥秘。</p>
</blockquote>
<h2 data-id="heading-0">0️⃣ 🐼 序章：雁门关前的技术难题</h2>
<p>雁门关，数据流与现实交错的虚拟战场。</p>
<p>大熊猫侯佩正对着一块全息屏幕发呆，屏幕上是无数条交易记录，他正努力寻找他藏匿的竹笋基金。他用手摸了摸自己的头顶，确定了<strong>头绝对没有秃</strong>之后，才稍微心安。</p>
<p>他身旁站着一位温柔婉约的绿衣女子，正是<strong>阿朱</strong>。阿朱以<strong>易容术</strong>闻名江湖，擅长在纷乱的文本中寻找和伪装信息，她的心愿是天下太平，性格宽厚善良。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1e3dc8c01a44f018ade0303fb610333~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352263&amp;x-signature=VNhOQu0GCKE%2BgpAxUG%2BakqnV28Q%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>“侯大哥，”阿朱指着一堆交易记录说，“我想找到所有以 <strong>金币符号 $</strong> 结算的价格，但我只想匹配出后面的数字，而不要把那个 <code>$</code>符号也匹配进去。我要用这些数字去结算账单，符号留着下次易容用。”</p>
<p><strong>在本次大模型中，您将学到如下内容：</strong></p>
<ul>
<li>0️⃣ 🐼 序章：雁门关前的技术难题</li>
<li>1️⃣ 🔎 阿朱的易容术：Regex lookbehind assertions</li>
<li>2️⃣ 🧪 阿紫的毒药测试：Exit Tests 的“置之死地” (ST-0008)
<ul>
<li>#expect(processExitsWith:) 的安全结界</li>
</ul>
</li>
<li>3️⃣ 🎁 尾声：崩溃现场的“遗物”与下一章的伏笔</li>
</ul>
<p>侯佩为难地挠了挠头：“以前的 <strong>Regex（正则表达式）</strong>，要么就全部匹配进去，要么就得用复杂的捕获组再分离。要想实现‘<strong>只看前因，不取前因</strong>’，简直难如登天啊！”</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c3d817468384a6a87c56194c7096a7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352263&amp;x-signature=ZEqHExcRV52pXqe%2FYeG8EF8S4XU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-1">1️⃣ 🔎 阿朱的易容术：Regex lookbehind assertions</h2>
<p>阿朱的问题，正是 <strong>SE-0448</strong> 所要解决的：<strong>向后查找断言（lookbehind assertions）</strong>。</p>
<p>传统的正则表达式，可以轻松地实现“向前看”（Lookahead），例如 <code>A(?=B)</code>，匹配 A，但前提是 A 后面跟着 B。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1313ea505dfe4d9692fcc4e4110b4de3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352263&amp;x-signature=Gi7qgD61kVQVsfmbpvIvW%2FrBYeI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>而现在，Swift 6.2 赋予了我们 <strong>“向后看”</strong> 的能力，即 <code>(?&lt;=A)B</code>：匹配 B，但前提是 B 前面紧跟着 A。最关键的是，<strong>A（前置条件）不会被纳入最终的匹配结果中。</strong></p>
<p>侯佩拿起代码卷轴，为阿朱演示了这招“庖丁解牛”般的绝技：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> string <span class="hljs-operator">=</span> <span class="hljs-string">"Buying a jacket costs $100, and buying shoes costs $59.99."</span>

<span class="hljs-comment">// (?&lt;=\$): 向后查找断言，确认当前位置前面紧跟着一个 $ 符号。</span>
<span class="hljs-comment">// \d+     : 匹配至少一个数字（价格的整数部分）。</span>
<span class="hljs-comment">// (?:\.\d{2})?: 匹配可选的小数点和小数部分（?: 是非捕获组）。</span>
<span class="hljs-keyword">let</span> regex <span class="hljs-operator">=</span> <span class="hljs-operator">/</span>(<span class="hljs-operator">?&lt;=</span>\$)\d<span class="hljs-operator">+</span>(<span class="hljs-operator">?</span>:\.\d{<span class="hljs-number">2</span>})<span class="hljs-operator">?/</span> 

<span class="hljs-keyword">for</span> match <span class="hljs-keyword">in</span> string.matches(of: regex) {
    <span class="hljs-comment">// 最终输出的 match.output 只有数字，不包含 $ 符号</span>
    <span class="hljs-built_in">print</span>(match.output) 
}

<span class="hljs-comment">// 输出:</span>
<span class="hljs-comment">// 100</span>
<span class="hljs-comment">// 59.99</span>
</code></pre>
<p>“看到了吗，阿朱姑娘？”侯佩得意洋洋，“这个 <code>(?&lt;=$)</code> 就是你的<strong>易容术精髓</strong>。它帮你确认了身份（前面必须是金币），但在匹配结果中，它却完美地把自己隐藏了起来，<strong>片叶不沾身！</strong>”</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c9bcd92f1d24dd3bb238062c3f61fa2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352263&amp;x-signature=UwTjBaferRW%2BIMU%2BY62MYElffRg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>阿朱喜出望外：“太妙了！这样我就可以精准地提取数据，再也不用担心多余的符号来捣乱了！”</p>
<h2 data-id="heading-2">2️⃣ 🧪 阿紫的毒药测试：Exit Tests 的“置之死地” (ST-0008)</h2>
<p>就在侯佩和阿朱沉浸在正则表达式的精妙中时，一阵刺鼻的硫磺味突然袭来！</p>
<p>另一位身着紫衣的少女，<strong>阿紫</strong>，从烟雾中走了出来。阿紫的特点是<strong>心狠手辣，喜欢用毒，而且热衷于测试“极限”</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ecb0dec609de4e0cafc09aa69b61fef7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352263&amp;x-signature=o7kqM7EX1dVIlhi9Sn1o9waRFXw%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>“姐姐，你在玩这么幼稚的游戏？”阿紫轻蔑一笑，“我的任务才刺激。我要测试我最新的**‘鹤顶红’代码**，确保它能让整个应用<strong>彻底崩溃并退出</strong>！”</p>
<p>侯佩吓得连退三步：“你要测试崩溃？阿紫姑娘，你知道这意味着什么吗？应用崩溃，测试系统也会跟着崩溃啊！这叫<strong>一锅端</strong>！”</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c5a02f2b0f24868bb2f22e29c8f9b52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352263&amp;x-signature=NV2pv4s57ZIjW9Rij1afrw1Jg%2BI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>阿紫的测试目标，正是那些会触发 <strong><code>precondition()</code></strong> 或 <strong><code>fatalError()</code></strong> 导致进程退出的代码。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Dice</span> {
    <span class="hljs-comment">// 掷骰子功能</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">roll</span>(<span class="hljs-params">sides</span>: <span class="hljs-type">Int</span>) -&gt; <span class="hljs-type">Int</span> {
        <span class="hljs-comment">// 🚨 前提条件：骰子面数必须大于零！</span>
        <span class="hljs-comment">// 如果 sides &lt;= 0，程序将立即崩溃退出！</span>
        <span class="hljs-built_in">precondition</span>(sides <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span>) 
        <span class="hljs-keyword">return</span> <span class="hljs-type">Int</span>.random(in: <span class="hljs-number">1</span><span class="hljs-operator">...</span>sides)
    }
}
</code></pre>
<p>“以前，我们要么不能测，要么就得用各种奇技淫巧来捕获这种‘致命错误’。”侯佩擦着汗说，“但现在 Swift Testing 带来了 <strong>ST-0008：Exit Tests</strong>，让我们能优雅地‘<strong>置之死地而后生</strong>’！”</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d194f7fe3b384958a4b35e7f38cba9e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352263&amp;x-signature=QdFXzd8ALJ0arP%2B%2FsVHDc12FGLQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-3">#expect(processExitsWith:) 的安全结界</h3>
<p>Swift 6.2 引入了 <code>#expect(processExitsWith:)</code>，它就像是一个安全结界，允许我们在<strong>隔离的子进程</strong>中执行可能导致崩溃的代码，然后<strong>捕获并验证</strong>这个退出行为。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-meta">@Test</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">invalidDiceRollsFail</span>() <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> {
    <span class="hljs-keyword">let</span> dice <span class="hljs-operator">=</span> <span class="hljs-type">Dice</span>()

    <span class="hljs-comment">// 🛡️ 关键：使用 #expect 包裹，并等待结果</span>
    <span class="hljs-keyword">await</span> #expect(processExitsWith: .failure) {
        <span class="hljs-comment">// 在这里，roll(sides: 0) 会导致隔离的子进程崩溃退出</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword">_</span> <span class="hljs-operator">=</span> dice.roll(sides: <span class="hljs-number">0</span>)
    }
    
    <span class="hljs-comment">// 如果子进程如期以 .failure 状态退出，则测试通过。</span>
    <span class="hljs-comment">// 如果它没有崩溃，或者崩溃状态不对，则测试失败。</span>
}
</code></pre>
<blockquote>
<p><strong>🔍 异步执行的关键：<code>await</code></strong>
注意，这里必须使用 <code>await</code>。这是因为在幕后，测试框架必须启动一个<strong>专用的、独立的进程</strong>来执行危险代码。它会暂停当前测试，直到子进程运行完毕并返回退出状态。这才是真正的<strong>隔离测试</strong>！</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5618c61e888340beac9c4101dadc0c2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352263&amp;x-signature=VeZTG3MJwy%2B5eI6bXJkDODtZf%2Fc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>阿紫满意地拍了拍手：“现在我的毒药（代码）终于可以在实验室（测试环境）里安全地爆炸了！我不仅可以测试它会死（<code>failure</code>），还可以测试它死得很安详（<code>success</code>）或其他退出状态。”</p>
<h2 data-id="heading-4">3️⃣ 🎁 尾声：崩溃现场的“遗物”与下一章的伏笔</h2>
<p>侯佩摸了摸自己的头发，确认没有被阿紫的毒气熏掉，然后问道：“阿紫姑娘，你这个毒药测试虽然厉害，但是你有没有想过一个问题？”</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/783cfa1863224a8781dcda6e10f5eb8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352263&amp;x-signature=jNC%2Fcyf4RGY6Emn%2BfAJvEu8zaK4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>“什么问题？”阿紫挑了挑眉。</p>
<p>“如果这个 <code>roll(sides: 0)</code> 崩溃了，但它在崩溃前，生成了一个关键的调试日志文件，或者一个记录了现场数据的**‘遗物’**，你能不能把这个遗物附着到测试报告里？”</p>
<p>阿紫一愣：“不能。测试报告里只显示了‘<strong>崩溃了</strong>’这个结果，但我不知道崩溃前骰子（程序）到底在想什么！我需要那个遗物来分析我的毒药配方！”</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9c8d009d3ee4f5892d757cc8d758296~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352263&amp;x-signature=%2BztAWEavkdiFIytHvkSKx7ub1dk%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>阿朱也附和道：“是啊，侯大哥。就像我易容时，如果失败了，我希望在失败的记录旁边，能附上一张当时的照片，这样下次就知道是哪个环节出了错。”</p>
<p>侯佩微微一笑，从怀里掏出了一张写着 <strong>ST-0009</strong> 的秘籍：“两位姑娘，不必烦恼。下一章，Swift Testing 就能帮你们把这些<strong>日志、数据和现场文件</strong>，像附着‘随身物品’一样，直接捆绑到失败的测试报告上。这招就叫……”</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/263de864bd854f34bdc579cc436832b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352263&amp;x-signature=Mr7fKh8XXUo%2FpLAwWpATTItNSts%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>（欲知后事如何，且看下回分解：Swift Testing: Attachments —— 如何将崩溃现场的证据（日志、截图、数据文件）直接附着到测试报告上，让 Bug 无所遁形。）</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Linux再添一员猛将，操作完全不输Windows！]]></title>    <link>https://juejin.cn/post/7592040819818004521</link>    <guid>https://juejin.cn/post/7592040819818004521</guid>    <pubDate>2026-01-07T00:57:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592040819818004521" data-draft-id="7592088192516620331" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Linux再添一员猛将，操作完全不输Windows！"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2026-01-07T00:57:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CodeSheep"/> <meta itemprop="url" content="https://juejin.cn/user/4371313961738616"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Linux再添一员猛将，操作完全不输Windows！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4371313961738616/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CodeSheep
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T00:57:47.000Z" title="Wed Jan 07 2026 00:57:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>提到 <strong>Zorin OS</strong> 这个操作系统，可能不少喜欢折腾 Linux 系统的小伙伴之前有尝试过。</p>
<p>作为一款以 UI 交互和颜值著称的 Linux 发行版系统，Zorin OS 也曾一度被广大爱好者们称为 <strong>Windows 系统的开源替代方案</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c23f3d4f0fe54333b903d1a8feefe5bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352266&amp;x-signature=3%2FEMSg5TzVrf2Ot8DnmgRY9NF%2BY%3D" alt="" loading="lazy"/></p>
<p>Zorin OS 旨在简单易用，用户无需学习任何新知识即可上手，同时 Zorin OS 作为一款 Linux 发行版系统，<strong>专为从 Windows 迁移的用户设计</strong>，提供类似 Windows 的图形界面与操作逻辑，并且<strong>支持一键切换为 Windows 系统风格</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cdf730d781114495b8a9d843b6c24171~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352266&amp;x-signature=enrtRtek7CTUo0mmLOcKZDAgBQA%3D" alt="" loading="lazy"/></p>
<p>前段时间，Zorin OS 团队在其官博正式宣布，最新的 Zorin OS 18 已经正式突破了 100 万次下载。</p>
<p>并且据官博数据显示，这些下载中<strong>有超过 78% 是来自于 Windows 系统的用户</strong>，这也再次印证了其可以满足从 Windows 桌面系统迁移到 Linux 发行版的用户需求。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb647d31ddee4c7390ea89eaa3be58c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352266&amp;x-signature=Jgwi6Nlp26TFPkZ5FnpcZd8fm7o%3D" alt="" loading="lazy"/></p>
<p>作为一个长期关注 Linux 桌面系统的博主，其实这次 Zorin OS 18 大版本更新刚出来那会我就关注了，不过一直没有抽出时间来写文章、来梳理，所以今天这篇文章正好把这件事情给安排了！</p>
<p>总体来讲，这次的 Zorin OS 18 是以 Ubuntu 24.04 LTS 为基础并由 Linux 6.14 内核提供支持。</p>
<p>并且这次的 Zorin OS 18 是继之前 17 版本以来的一次大版本迭代，带来了诸多新特性和改进。</p>
<p>所以接下来我们也来梳理一下这次 Zorin OS 18 所带来的一些重点更新和变化。</p>
<h2 data-id="heading-0">视觉与交互进化</h2>
<p>众所周知，Zorin OS 一直以来都以其独特的个性和简约的美学设计风格而著称。</p>
<p>那这次更新后的新外观给人最直观的感受就是圆润和通透。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b639c420230543deb3d5e7e7065ea861~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352266&amp;x-signature=rwoYS1qXC7bIsBumeUALIylCfHs%3D" alt="" loading="lazy"/></p>
<p>任务栏这一次采用了全新的悬浮圆角面板设计，不再是死板地贴在屏幕边缘，而是像 macOS 的控制中心一样有一种轻盈的漂浮感。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51075571b05b467f9c311f858ae42944~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352266&amp;x-signature=cy7XeK%2FjJ8XdcuoQ160esqi2jFU%3D" alt="" loading="lazy"/></p>
<p>另外这一次大版本还推出了新主题颜色，新增了黄色和棕色两种主题色，视觉层次更加丰富。</p>
<p>选中元素的色调更加淡雅，背景和侧边栏颜色更深，长时间盯着屏幕写代码或处理文档，眼睛会舒服很多。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/257f4419191c4d5e99878f8ca7082fba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352266&amp;x-signature=uBS4eEytwM%2Bs8cA9biwKFNdQZLk%3D" alt="" loading="lazy"/></p>
<p>另外 Pro 版里还提供了更多可切换的桌面布局。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ec8d58a6d144232ab4755f2c1eb938c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352266&amp;x-signature=e5bKULoM%2BcWtfOswOS4jIQ9k4%2Bw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3f3ea9cb5c84bc38aeba1e93c71c678~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352266&amp;x-signature=gquA35Cjv0pKt0NqAARTFbGY%2Ffg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0695076094d4f9d96903fb702d2e05e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352266&amp;x-signature=ZuEAZvNFf5yC91p7iQXpdI0J6kM%3D" alt="" loading="lazy"/></p>
<p>除此之外，很多经常使用的日常应用也进行了诸多设计调整和改进。</p>
<p>比如<strong>文件管理器</strong>的侧边栏重新设计了，操作控件更直观，搜索功能支持了全文搜索，找文件效率大增。</p>
<p><strong>日历</strong>应用增加了侧边栏，月份和事件视图也一目了然。</p>
<p><strong>相机</strong>应用也做了更新，新相机应用界面简洁，支持多摄像头切换，这对于现在动不动就开视频会议的环境非常友好。</p>
<h2 data-id="heading-1">Web 应用深度集成</h2>
<p>对于用户来说，最大的痛点往往不是系统本身，而是数据迁移和应用生态，那 Zorin OS 18 在这方面下了不少功夫。</p>
<p>首先就是与 Web 应用程序无缝集成。</p>
<p>众所周知，现在很多应用都构建在云端，这些渐进式 Web 应用与原生应用之间的用户体验正逐渐融合。</p>
<p>这次 Zorin OS 18 全新内置的「Web Apps」工具非常强大，它可以将 Web 应用转换为桌面应用，用户的 Web 应用将可以显示在开始菜单中，使用起来与原生应用无异。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13527117876b40398d7e197db2aeb88b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352266&amp;x-signature=WYE2ihl3Ma1x54auBPyZCrK1f6I%3D" alt="" loading="lazy"/></p>
<p>「Web Apps」工具可以作为后端与各种热门 Web 浏览器集成，同时也允许用户自定义对应 Web 应用内的体验。</p>
<h2 data-id="heading-2">多任务处理：原生窗口平铺</h2>
<p>这次 Zorin OS 18 的多任务处理变得好用多了。</p>
<p>Zorin OS 18 引入了一款功能强大的窗口平铺管理器，它能帮助用户更高效地工作，同时上手起来也十分简单。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8879554b4d64bd68a26dcf16632d2eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352266&amp;x-signature=qfiTxRj1xXN6Bjw%2BZH6mlX192qQ%3D" alt="" loading="lazy"/></p>
<p>用户只需要把窗口拖到屏幕顶部，系统就会自动弹出布局选择器。</p>
<p>预设布局支持左右分屏、三栏布局、角落停靠等，同时在智能建议这块，系统也可以根据用户当前所打开的窗口，智能推荐最佳的排列组合。</p>
<p>除此之外它还支持高度自定义，创建用户自己的平铺布局。</p>
<p>这个新特性无论对新手还是资深玩家都非常直观易用，从而定制和提升每个用户的生产力。</p>
<h2 data-id="heading-3">迁移神器：Windows 应用支持</h2>
<p>用户可以从内置的软件商店发现适用于 Zorin OS 系统的各类应用，这是在 Zorin OS 中安装应用的推荐方式。</p>
<p>其软件商店可让用户开箱即用地从 Zorin OS 与 Ubuntu APT 仓库、Flathub 以及 Snap Store 安装应用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64d53f6128944782bd26a02e2977b6e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352266&amp;x-signature=I2bZ6UR9I44Fblm0x6c%2Frtv0Yz4%3D" alt="" loading="lazy"/></p>
<p>而如果用户是刚从 Windows 转过来，看到满硬盘的 .exe 安装包肯定会头疼。</p>
<p>Zorin OS 18 的处理方式非常聪明。</p>
<p>系统内置了一个庞大的软件数据库（覆盖超过 170 款软件），当用户双击一个 Windows 安装包（如 setup.exe）时，系统不会直接报错，而是弹出一个友好的对话框。</p>
<p>如果有 Linux 原生版本，它就会引导你安装原生版本应用；如果没有原生版的话，它就会推荐你使用 Web 版，或者利用兼容层运行。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/955e751fcbc9465a9073916bff333dd1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352266&amp;x-signature=TXeiWc%2FEQ9lCDpdYCwS52B8rG1o%3D" alt="" loading="lazy"/></p>
<p>在兼容层优化这一块，Zorin OS 18 深度集成了 Wine，对于一些必须在 Windows 下运行的行业软件或游戏，它提供了一个“Windows 应用支持”层。虽然不能保证 100% 兼容，但对于很多老旧的 .exe 工具，它能让你在不装虚拟机的情况下应急使用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e24e23d8418443fbb5b4a67e97b3229~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352266&amp;x-signature=4wAEgS3HHHUIgUYcuQdbwEZIaXA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">性能与硬件支持</h2>
<p>Zorin OS 18 基于 Ubuntu LTS 版本打造，同时它将获得直到 2029 年的稳定安全更新。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a58443094e6d4c4c9c69af9cbe6eb714~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352266&amp;x-signature=kpI2%2FgSEaSzhBDgqxEcQTG%2Fv8kw%3D" alt="" loading="lazy"/></p>
<p>同时官方宣称它甚至可以在十几年前的古董机上流畅运行。最低配置仅需 1GHz 双核 CPU、2GB 内存。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbba673b225f4451b660f2cf33438c3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352266&amp;x-signature=rG0uilGBPAMNV7qyfJh4feXOrjY%3D" alt="" loading="lazy"/></p>
<p>同时从用户安装的实际表现来看，在现代硬件上，它的动画流畅度非常高，即便在老机器上，它运行起来也比 Windows 系统更加轻快。</p>
<h2 data-id="heading-5">写在最后</h2>
<p>那以上就是关于此次 Zorin OS 18 大版本更新的一些梳理和总结，感兴趣的小伙伴也可以去体验一波。</p>
<p>总的来看，这次的 Zorin OS 18 不仅仅是一个 Linux 发行版，也像极了一个操作系统迁移解决方案。</p>
<p>另外这次 Zorin OS 18 的发布，也使得 Linux 桌面系统的易用性又向前迈进了一步。</p>
<p>文章的最后也期待 Linux 桌面系统在未来能百花齐放，发展得越来越好。</p>
<p>好了，那以上就是今天的内容分享了，希望能对大家有所帮助，我们下篇见。</p>
<blockquote>
<p>注：本文在GitHub开源仓库「编程之路」 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frd2coding%2FRoad2Coding" target="_blank" title="https://github.com/rd2coding/Road2Coding" ref="nofollow noopener noreferrer">github.com/rd2coding/R…</a> 中已经收录，里面有我整理的6大编程方向(岗位)的自学路线+知识点大梳理、面试考点、我的简历、几本硬核pdf笔记，以及程序员生活和感悟，欢迎star。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MyBatis数据源模块详解]]></title>    <link>https://juejin.cn/post/7592130164965572646</link>    <guid>https://juejin.cn/post/7592130164965572646</guid>    <pubDate>2026-01-07T01:00:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592130164965572646" data-draft-id="7590608345922371610" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MyBatis数据源模块详解"/> <meta itemprop="keywords" content="MyBatis"/> <meta itemprop="datePublished" content="2026-01-07T01:00:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MyBatis数据源模块详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T01:00:30.000Z" title="Wed Jan 07 2026 01:00:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>从源码层面深入理解MyBatis连接池的设计与实现</p>
</blockquote>
<h2 data-id="heading-0">一、MyBatis整体架构与数据源模块</h2>
<p>在深入数据源模块之前，我们先了解MyBatis的整体架构，以及数据源模块在其中的重要地位。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8cfa06c57cd94536a7ac6a0c931a1634~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352429&amp;x-signature=uj2NS4cMd4LcRNkEZcCwxxjTUr4%3D" alt="" loading="lazy"/></p>
<p>从架构图可以看出，MyBatis采用了分层架构设计，而<strong>数据源模块（DataSource）位于基础支撑层</strong>，是数据库访问的基础设施。它负责管理数据库连接、维护连接池、提供高效的连接获取和释放机制，是整个框架与数据库交互的入口。</p>
<h2 data-id="heading-1">1.1 数据源模块的核心职责</h2>
<p>数据源模块主要承担以下核心职责：</p>
<pre><code class="hljs">管理数据库连接 - 创建、初始化和管理数据库连接
连接池管理 - 维护连接池，提高连接复用率
连接获取与释放 - 提供高效的连接获取和释放机制
连接配置管理 - 管理数据库连接的配置信息
性能优化 - 通过连接池减少连接创建开销
</code></pre>
<h2 data-id="heading-2">1.2 为什么需要连接池？</h2>
<p>在传统的JDBC编程中，每次数据库操作都需要创建和关闭连接：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//传统方式：每次创建新连接</span>
<span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> DriverManager.getConnection(url, user, password);
<span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 执行SQL操作</span>
} <span class="hljs-keyword">finally</span> {
    conn.close(); <span class="hljs-comment">// 关闭连接</span>
}
</code></pre>
<p>这种方式存在明显问题：</p>
<pre><code class="hljs">频繁创建连接 - 连接创建是昂贵的操作 
资源浪费 - 频繁创建和销毁连接消耗资源
性能低下 - 每次操作都要等待连接建立
</code></pre>
<p>使用连接池后的流程：</p>
<pre><code class="hljs language-markdown" lang="markdown">应用启动 → 创建连接池 → 预创建N个连接
<span class="hljs-code">    ↓
业务请求 → 从池中获取连接 → 执行操作 → 归还连接到池
    ↓
应用关闭 → 销毁连接池 → 释放所有连接
</span></code></pre>
<h2 data-id="heading-3">1.3 MyBatis的数据源类型</h2>

























<table><thead><tr><th>数据源类型</th><th>说明</th><th>使用场景</th></tr></thead><tbody><tr><td>UNPOOLED</td><td>不使用连接池</td><td>测试环境、简单应用</td></tr><tr><td>POOLED</td><td>使用连接池</td><td>生产环境、高并发应用</td></tr><tr><td>JNDI</td><td>使用JNDI查找</td><td>应用服务器环境</td></tr></tbody></table>
<h2 data-id="heading-4">二、数据源接口架构</h2>
<p>MyBatis的数据源模块采用了清晰的接口设计。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acd23b19a2c841dd9768327cc26beef9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352429&amp;x-signature=Nn9nzvyQHfNvPcXqXVhf4MOO5A0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">2.1 DataSource接口</h2>
<p>DataSource是数据源的顶层接口：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DataSource</span> {
    <span class="hljs-comment">// 获取数据库连接</span>
    Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException;
    Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">(String username, String password)</span> 
        <span class="hljs-keyword">throws</span> SQLException;
}
</code></pre>
<p>虽然MyBatis没有直接定义DataSource接口（使用的是javax.sql.DataSource），但它通过<strong>工厂模式</strong>创建不同类型的DataSource实现。</p>
<h2 data-id="heading-6">2.2 DataSourceFactory接口</h2>
<p>MyBatis定义了DataSourceFactory接口用于创建DataSource：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">DataSourceFactory</span> {
    <span class="hljs-comment">// 设置数据源属性</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setProperties</span>(<span class="hljs-params">Properties props</span>)</span>;
    <span class="hljs-comment">// 获取数据源</span>
    <span class="hljs-function">DataSource <span class="hljs-title">getDataSource</span>()</span>;
}
</code></pre>
<h2 data-id="heading-7">2.3数据源工厂实现</h2>
<p>MyBatis提供了三种DataSourceFactory实现：</p>
<pre><code class="hljs language-java" lang="java">DataSourceFactory
├── UnpooledDataSourceFactory (无池数据源工厂)
├── PooledDataSourceFactory (池化数据源工厂)
└── JndiDataSourceFactory (JNDI数据源工厂)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UnpooledDataSourceFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DataSourceFactory</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DRIVER_PROPERTY_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"driver."</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">DRIVER_PROPERTY_PREFIX_LENGTH</span> <span class="hljs-operator">=</span> 
        DRIVER_PROPERTY_PREFIX.length();

    <span class="hljs-keyword">protected</span> DataSource dataSource;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UnpooledDataSourceFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">this</span>.dataSource = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnpooledDataSource</span>();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setProperties</span><span class="hljs-params">(Properties properties)</span> {
        <span class="hljs-type">Properties</span> <span class="hljs-variable">driverProperties</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();
        <span class="hljs-type">DataSource</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> getDataSource();

        <span class="hljs-comment">// 创建数据源</span>
        <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaDataSource</span> <span class="hljs-operator">=</span> 
            SystemMetaObject.forObject(dataSource);

        <span class="hljs-comment">// 设置属性</span>
        <span class="hljs-keyword">for</span> (Object key : properties.keySet()) {
            <span class="hljs-type">String</span> <span class="hljs-variable">propertyName</span> <span class="hljs-operator">=</span> (String) key;
            <span class="hljs-keyword">if</span> (propertyName.startsWith(DRIVER_PROPERTY_PREFIX)) {
                driverProperties.setProperty(
                    propertyName.substring(DRIVER_PROPERTY_PREFIX_LENGTH), 
                    properties.getProperty(propertyName)
                );
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (metaDataSource.hasSetter(propertyName)) {
                <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (String) properties.get(propertyName);
                <span class="hljs-type">Object</span> <span class="hljs-variable">convertedValue</span> <span class="hljs-operator">=</span> 
                    convertValue(metaDataSource, propertyName, value);
                metaDataSource.setValue(propertyName, convertedValue);
            }
        }

        <span class="hljs-keyword">if</span> (dataSource <span class="hljs-keyword">instanceof</span> UnpooledDataSource) {
            ((UnpooledDataSource) dataSource)
                .setDriverProperties(driverProperties);
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">getDataSource</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> dataSource;
    }
}
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PooledDataSourceFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UnpooledDataSourceFactory</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PooledDataSourceFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">//注意：这里创建的是PooledDataSource</span>
        <span class="hljs-built_in">this</span>.dataSource = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PooledDataSource</span>();
    }
}
</code></pre>
<p>UnpooledDataSource是<strong>不使用连接池</strong>的数据源实现，每次请求都创建新连接。</p>
<h2 data-id="heading-8">3.1 UnpooledDataSource核心代码</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UnpooledDataSource</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DataSource</span> {
    <span class="hljs-comment">// 驱动配置</span>
    <span class="hljs-keyword">private</span> Class&lt;?&gt; driver;
    <span class="hljs-keyword">private</span> String url;
    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> String password;
    <span class="hljs-keyword">private</span> Boolean autoCommit;
    <span class="hljs-keyword">private</span> Integer defaultTransactionIsolationLevel;
    <span class="hljs-keyword">private</span> Properties driverProperties;

    <span class="hljs-comment">// 缓存驱动，避免重复加载</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;String, Driver&gt; registeredDrivers = 
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">return</span> doGetConnection(username, password);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">(String username, String password)</span> 
        <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">return</span> doGetConnection(username, password);
    }

    <span class="hljs-keyword">private</span> Connection <span class="hljs-title function_">doGetConnection</span><span class="hljs-params">(String username, String password)</span> 
        <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-type">Properties</span> <span class="hljs-variable">props</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();
        <span class="hljs-keyword">if</span> (driverProperties != <span class="hljs-literal">null</span>) {
            props.putAll(driverProperties);
        }
        <span class="hljs-keyword">if</span> (username != <span class="hljs-literal">null</span>) {
            props.setProperty(<span class="hljs-string">"user"</span>, username);
        }
        <span class="hljs-keyword">if</span> (password != <span class="hljs-literal">null</span>) {
            props.setProperty(<span class="hljs-string">"password"</span>, password);
        }
        <span class="hljs-keyword">return</span> doGetConnection(props);
    }

    <span class="hljs-keyword">private</span> Connection <span class="hljs-title function_">doGetConnection</span><span class="hljs-params">(Properties properties)</span> 
        <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-comment">// 初始化驱动</span>
        initializeDriver();
        <span class="hljs-comment">// 获取连接</span>
        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> 
            DriverManager.getConnection(url, properties);
        <span class="hljs-comment">// 配置连接</span>
        configureConnection(connection);
        <span class="hljs-keyword">return</span> connection;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initializeDriver</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">if</span> (!registeredDrivers.containsKey(driver)) {
            <span class="hljs-keyword">try</span> {
                Class&lt;?&gt; driverType = Class.forName(driver);
                <span class="hljs-type">Driver</span> <span class="hljs-variable">driverInstance</span> <span class="hljs-operator">=</span> (Driver) driverType.newInstance();
                DriverManager.registerDriver(
                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">DriverProxy</span>(driverInstance)
                );
                registeredDrivers.put(driver, driverInstance);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SQLException</span>(
                    <span class="hljs-string">"Error setting driver on UnpooledDataSource. Cause: "</span> + e
                );
            }
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configureConnection</span><span class="hljs-params">(Connection conn)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">if</span> (autoCommit != <span class="hljs-literal">null</span> &amp;&amp; conn.getAutoCommit() != autoCommit) {
            conn.setAutoCommit(autoCommit);
        }
        <span class="hljs-keyword">if</span> (defaultTransactionIsolationLevel != <span class="hljs-literal">null</span>) {
            conn.setTransactionIsolation(defaultTransactionIsolationLevel);
        }
    }
}
</code></pre>
<h2 data-id="heading-9">3.2 UnpooledDataSource特点</h2>
<p>优点：</p>
<pre><code class="hljs">实现简单，易于理解
不需要维护连接池状态
适合测试和简单应用
</code></pre>
<p>缺点：</p>
<pre><code class="hljs">每次都创建新连接，性能低
频繁创建销毁连接，资源消耗大
不适合高并发场景
</code></pre>
<h2 data-id="heading-10">四、PooledDataSource实现</h2>
<p>PooledDataSource是MyBatis的<strong>连接池实现</strong>，提供了高效的连接管理。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa349bb481f64c6c85223a6a1e41d56c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352429&amp;x-signature=aYD8XGNWiSKdB4oA00TKisxj7Nw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11">4.1 PooledDataSource核心结构</h2>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PooledDataSource</span> implements DataSource {
    <span class="hljs-comment">// 数据源状态</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PoolState state;
    <span class="hljs-comment">// 无池数据源（用于创建实际连接）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UnpooledDataSource dataSource;
    <span class="hljs-comment">// 连接池配置</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> expectedTransactionType;
    <span class="hljs-comment">// 最大活动连接数</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> poolMaximumActiveConnections = <span class="hljs-number">10</span>;
    <span class="hljs-comment">// 最大空闲连接数</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> poolMaximumIdleConnections = <span class="hljs-number">5</span>;
    <span class="hljs-comment">// 最大Checkout时间（毫秒）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> poolMaximumCheckoutTime = <span class="hljs-number">20000</span>;
    <span class="hljs-comment">// 等待时间（毫秒）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> poolTimeToWait = <span class="hljs-number">20000</span>;
    <span class="hljs-comment">// 最大连接数</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> poolMaximumLocalBadConnectionTolerance = <span class="hljs-number">3</span>;
    <span class="hljs-comment">// 测试连接的SQL</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> poolPingQuery = <span class="hljs-string">"NO PING QUERY SET"</span>;
    <span class="hljs-comment">// 是否测试连接</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> poolPingEnabled;
    <span class="hljs-comment">// 测试连接的间隔（毫秒）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> poolPingConnectionsNotUsedFor;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PooledDataSource</span><span class="hljs-params">()</span> </span>{
        state = <span class="hljs-keyword">new</span> <span class="hljs-built_in">PoolState</span>(<span class="hljs-keyword">this</span>);
        dataSource = <span class="hljs-keyword">new</span> <span class="hljs-built_in">UnpooledDataSource</span>();
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PooledDataSource</span><span class="hljs-params">(<span class="hljs-type">String</span> driver, <span class="hljs-type">String</span> url, 
        <span class="hljs-type">String</span> username, <span class="hljs-type">String</span> password)</span> </span>{
        state = <span class="hljs-keyword">new</span> <span class="hljs-built_in">PoolState</span>(<span class="hljs-keyword">this</span>);
        dataSource = <span class="hljs-keyword">new</span> <span class="hljs-built_in">UnpooledDataSource</span>(driver, url, username, password);
    }

    @<span class="hljs-function">Override
    <span class="hljs-keyword">public</span> Connection <span class="hljs-title">getConnection</span><span class="hljs-params">()</span> throws SQLException </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">popConnection</span>(
            dataSource.<span class="hljs-built_in">getUsername</span>(), 
            dataSource.<span class="hljs-built_in">getPassword</span>()
        ).<span class="hljs-built_in">getProxyConnection</span>();
    }

    @<span class="hljs-function">Override
    <span class="hljs-keyword">public</span> Connection <span class="hljs-title">getConnection</span><span class="hljs-params">(<span class="hljs-type">String</span> username, <span class="hljs-type">String</span> password)</span> 
        throws SQLException </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">popConnection</span>(username, password).<span class="hljs-built_in">getProxyConnection</span>();
    }
}
</code></pre>
<h2 data-id="heading-12">4.2 PoolState连接池状态</h2>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PoolState</span> {
    <span class="hljs-comment">//数据源</span>
    <span class="hljs-keyword">protected</span> PooledDataSource dataSource;

    <span class="hljs-comment">//空闲连接列表</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> List&lt;PooledConnection&gt; idleConnections = 
        <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
    <span class="hljs-comment">//活动连接列表</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> List&lt;PooledConnection&gt; activeConnections = 
        <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    <span class="hljs-comment">// 统计指标</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">long</span> requestCount = <span class="hljs-number">0</span>;              <span class="hljs-comment">// 请求计数</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">long</span> accumulatedRequestTime = <span class="hljs-number">0</span>;    <span class="hljs-comment">// 累计请求时间</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">long</span> accumulatedCheckoutTime = <span class="hljs-number">0</span>;   <span class="hljs-comment">// 累计Checkout时间</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">long</span> accumulatedWaitTime = <span class="hljs-number">0</span>;       <span class="hljs-comment">// 累计等待时间</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">long</span> badConnectionCount = <span class="hljs-number">0</span>;        <span class="hljs-comment">// 累计无效连接数</span>

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PoolState</span><span class="hljs-params">(PooledDataSource dataSource)</span> </span>{
        <span class="hljs-keyword">this</span>.dataSource = dataSource;
    }
}
</code></pre>
<h2 data-id="heading-13">4.3 popConnection获取连接</h2>
<pre><code class="hljs language-ini" lang="ini">private PooledConnection popConnection(String username, String password) 
    throws SQLException {
    boolean <span class="hljs-attr">countedWait</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
    PooledConnection <span class="hljs-attr">conn</span> = null<span class="hljs-comment">;</span>
    long <span class="hljs-attr">t</span> = System.currentTimeMillis()<span class="hljs-comment">;</span>
    int <span class="hljs-attr">localBadConnectionCount</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>

    while (<span class="hljs-attr">conn</span> == null) {
        synchronized (state) {
            //检查是否有空闲连接
            if (!state.idleConnections.isEmpty()) {
                // 从空闲连接池获取
                <span class="hljs-attr">conn</span> = state.idleConnections.remove(<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
                if (log.isDebugEnabled()) {
                    log.debug("Checked out connection " + 
                        conn.getRealHashCode() + " from pool.")<span class="hljs-comment">;</span>
                }
            } else {
                //没有空闲连接
                if (state.activeConnections.size() &lt; 
                    poolMaximumActiveConnections) {
                    // 可以创建新连接
                    <span class="hljs-attr">conn</span> = new PooledConnection(
                        dataSource.getConnection(), this
                    )<span class="hljs-comment">;</span>
                    if (log.isDebugEnabled()) {
                        log.debug("Created connection " + 
                            conn.getRealHashCode() + ".")<span class="hljs-comment">;</span>
                    }
                } else {
                    //活动连接已满，需要等待
                    <span class="hljs-attr">countedWait</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
                    try {
                        state.wait(poolTimeToWait)<span class="hljs-comment">;</span>
                    } catch (InterruptedException e) {
                        break<span class="hljs-comment">;</span>
                    }
                }
            }

            if (conn != null) {
                //检查连接是否有效
                if (conn.isValid()) {
                    // 测试连接
                    if (!poolPingEnabled || 
                        conn.pingConnection(poolPingConnectionsNotUsedFor)) {
                        // 连接有效，加入活动连接池
                        state.activeConnections.add(conn)<span class="hljs-comment">;</span>
                        state.requestCount++<span class="hljs-comment">;</span>
                        state.accumulatedRequestTime += 
                            System.currentTimeMillis() - t<span class="hljs-comment">;</span>
                        return conn<span class="hljs-comment">;</span>
                    }
                }
                // 连接无效，标记为坏连接
                state.badConnectionCount++<span class="hljs-comment">;</span>
                localBadConnectionCount++<span class="hljs-comment">;</span>
                if (conn.getRealConnection() != null) {
                    conn.close()<span class="hljs-comment">;</span>
                }
                <span class="hljs-attr">conn</span> = null<span class="hljs-comment">;</span>
            }
        }

        //检查是否超时
        if (!countedWait) {
            <span class="hljs-attr">countedWait</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
        } else if (localBadConnectionCount &gt; 
            poolMaximumLocalBadConnectionTolerance) {
            throw new SQLException(
                "PooledDataSource: Could not get a good connection."
            )<span class="hljs-comment">;</span>
        }
    }

    if (<span class="hljs-attr">conn</span> == null) {
        throw new SQLException(
            "PooledDataSource: Unknown error. Could not get a connection."
        )<span class="hljs-comment">;</span>
    }

    return conn<span class="hljs-comment">;</span>
}
</code></pre>
<h2 data-id="heading-14">4.4 pushConnection归还连接</h2>
<pre><code class="hljs language-scss" lang="scss">protected void <span class="hljs-built_in">pushConnection</span>(PooledConnection conn) throws SQLException {
    synchronized (state) {
        <span class="hljs-comment">//从活动连接池移除</span>
        state<span class="hljs-selector-class">.activeConnections</span><span class="hljs-selector-class">.remove</span>(conn);

        <span class="hljs-comment">//检查连接是否有效</span>
        if (conn.isValid()) {
            <span class="hljs-comment">//检查空闲连接池是否已满</span>
            if (state.idleConnections.size() &lt; poolMaximumIdleConnections &amp;&amp; 
                conn<span class="hljs-selector-class">.getConnectionType</span>() == expectedTransactionType) {
                <span class="hljs-comment">// 归还到空闲连接池</span>
                state<span class="hljs-selector-class">.accumulatedCheckoutTime</span> += conn<span class="hljs-selector-class">.getCheckoutTime</span>();
                if (!conn.getRealConnection()<span class="hljs-selector-class">.getAutoCommit</span>()) {
                    conn<span class="hljs-selector-class">.getRealConnection</span>()<span class="hljs-selector-class">.rollback</span>();
                }
                PooledConnection newConn = new <span class="hljs-built_in">PooledConnection</span>(
                    conn.getRealConnection(), this
                );
                state<span class="hljs-selector-class">.idleConnections</span><span class="hljs-selector-class">.add</span>(newConn);
                state<span class="hljs-selector-class">.requestCount</span>++;
                conn<span class="hljs-selector-class">.invalidate</span>();
                if (log.isDebugEnabled()) {
                    log<span class="hljs-selector-class">.debug</span>("Returned connection " + 
                        newConn.getRealHashCode() + " to pool.");
                }
                state<span class="hljs-selector-class">.notifyAll</span>();
            } else {
                <span class="hljs-comment">//空闲连接池已满，关闭连接</span>
                state<span class="hljs-selector-class">.accumulatedCheckoutTime</span> += conn<span class="hljs-selector-class">.getCheckoutTime</span>();
                if (!conn.getRealConnection()<span class="hljs-selector-class">.getAutoCommit</span>()) {
                    conn<span class="hljs-selector-class">.getRealConnection</span>()<span class="hljs-selector-class">.rollback</span>();
                }
                conn<span class="hljs-selector-class">.getRealConnection</span>()<span class="hljs-selector-class">.close</span>();
                if (log.isDebugEnabled()) {
                    log<span class="hljs-selector-class">.debug</span>("Closed connection " + 
                        conn.getRealHashCode() + ".");
                }
                conn<span class="hljs-selector-class">.invalidate</span>();
            }
        } else {
            <span class="hljs-comment">//连接无效</span>
            if (log.isDebugEnabled()) {
                log<span class="hljs-selector-class">.debug</span>("A bad connection (" + 
                    conn.getRealHashCode() + ") was returned to the pool.");
            }
            state<span class="hljs-selector-class">.badConnectionCount</span>++;
        }
    }
}
</code></pre>
<h2 data-id="heading-15">4.5 PooledConnection代理连接</h2>
<p>PooledConnection使用<strong>动态代理模式</strong>，拦截close()方法，将连接归还到池而不是真正关闭。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PooledConnection</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> {
    <span class="hljs-comment">// 实际连接</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Connection realConnection;
    <span class="hljs-comment">// 代理连接</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Connection proxyConnection;
    <span class="hljs-comment">// 数据源</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PooledDataSource dataSource;
    <span class="hljs-comment">// Checkout时间</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> checkoutTimestamp;
    <span class="hljs-comment">// 最后使用时间</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> lastUsedTimestamp;
    <span class="hljs-comment">// 连接类型</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> connectionType;
    <span class="hljs-comment">// 是否有效</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> valid;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PooledConnection</span><span class="hljs-params">(Connection realConnection, 
        PooledDataSource dataSource)</span> {
        <span class="hljs-built_in">this</span>.realConnection = realConnection;
        <span class="hljs-built_in">this</span>.dataSource = dataSource;
        <span class="hljs-built_in">this</span>.valid = <span class="hljs-literal">true</span>;

        <span class="hljs-comment">//创建动态代理</span>
        <span class="hljs-built_in">this</span>.proxyConnection = (Connection) Proxy.newProxyInstance(
            Connection.class.getClassLoader(),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]{Connection.class},
            <span class="hljs-built_in">this</span>
        );

        <span class="hljs-built_in">this</span>.checkoutTimestamp = System.currentTimeMillis();
        <span class="hljs-built_in">this</span>.lastUsedTimestamp = checkoutTimestamp;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> 
        <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> method.getName();

        <span class="hljs-comment">// close方法特殊处理</span>
        <span class="hljs-keyword">if</span> (CLOSE.equals(methodName)) {
            <span class="hljs-comment">// 不真正关闭，而是归还到连接池</span>
            dataSource.pushConnection(<span class="hljs-built_in">this</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 调用实际连接的方法</span>
            <span class="hljs-keyword">if</span> (!Object.class.equals(method.getDeclaringClass())) {
                checkConnection(); <span class="hljs-comment">// 检查连接状态</span>
            }
            <span class="hljs-keyword">return</span> method.invoke(realConnection, args);
        } <span class="hljs-keyword">catch</span> (Throwable t) {
            <span class="hljs-keyword">throw</span> ExceptionUtil.unwrapThrowable(t);
        }
    }

    <span class="hljs-keyword">public</span> Connection <span class="hljs-title function_">getProxyConnection</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> proxyConnection;
    }

    <span class="hljs-keyword">public</span> Connection <span class="hljs-title function_">getRealConnection</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> realConnection;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">if</span> (!valid) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SQLException</span>(
                <span class="hljs-string">"Error accessing PooledConnection. Connection is closed."</span>
            );
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValid</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> valid &amp;&amp; realConnection != <span class="hljs-literal">null</span>;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invalidate</span><span class="hljs-params">()</span> {
        valid = <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getCheckoutTime</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> System.currentTimeMillis() - checkoutTimestamp;
    }

    <span class="hljs-comment">// 连接有效性测试</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">pingConnection</span><span class="hljs-params">(<span class="hljs-type">int</span> pingInterval)</span> {
        <span class="hljs-keyword">if</span> (pingInterval &gt; <span class="hljs-number">0</span> &amp;&amp; 
            System.currentTimeMillis() - lastUsedTimestamp &gt; pingInterval) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">if</span> (realConnection.isClosed()) {
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                }
                <span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> realConnection.createStatement();
                <span class="hljs-keyword">if</span> (poolPingQuery != <span class="hljs-literal">null</span> &amp;&amp; !poolPingQuery.isEmpty()) {
                    stmt.execute(poolPingQuery);
                }
                stmt.close();
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            } <span class="hljs-keyword">catch</span> (SQLException e) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<h2 data-id="heading-16">五、数据源配置流程</h2>
<p>MyBatis支持多种方式配置数据源。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a57f2c22e2e24b1489969b2ee663aa3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352429&amp;x-signature=12UQYmjPqCzM%2BzzBUcbUCzTGgvs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-17">5.1 XML配置方式</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span> ?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">configuration</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">"-//mybatis.org//DTD Config 3.0//EN"</span>
    <span class="hljs-string">"http://mybatis.org/dtd/mybatis-3-config.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 配置环境 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">environments</span> <span class="hljs-attr">default</span>=<span class="hljs-string">"development"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">environment</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"development"</span>&gt;</span>
            <span class="hljs-comment">&lt;!-- 事务管理器 --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">transactionManager</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"JDBC"</span>/&gt;</span>

            <span class="hljs-comment">&lt;!-- 数据源配置 --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">dataSource</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"POOLED"</span>&gt;</span>
                <span class="hljs-comment">&lt;!-- JDBC驱动 --&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"driver"</span> 
                    <span class="hljs-attr">value</span>=<span class="hljs-string">"com.mysql.cj.jdbc.Driver"</span>/&gt;</span>
                <span class="hljs-comment">&lt;!-- 数据库URL --&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"url"</span> 
                    <span class="hljs-attr">value</span>=<span class="hljs-string">"jdbc:mysql://localhost:3306/mybatis?useSSL=false<span class="hljs-symbol">&amp;amp;</span>serverTimezone=UTC"</span>/&gt;</span>
                <span class="hljs-comment">&lt;!-- 用户名 --&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"username"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"root"</span>/&gt;</span>
                <span class="hljs-comment">&lt;!-- 密码 --&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"123456"</span>/&gt;</span>

                <span class="hljs-comment">&lt;!-- 连接池配置 --&gt;</span>
                <span class="hljs-comment">&lt;!-- 默认事务隔离级别 --&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"defaultTransactionIsolationLevel"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"2"</span>/&gt;</span>
                <span class="hljs-comment">&lt;!-- 最大活动连接数 --&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"poolMaximumActiveConnections"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"20"</span>/&gt;</span>
                <span class="hljs-comment">&lt;!-- 最大空闲连接数 --&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"poolMaximumIdleConnections"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"10"</span>/&gt;</span>
                <span class="hljs-comment">&lt;!-- 最大Checkout时间（毫秒） --&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"poolMaximumCheckoutTime"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"20000"</span>/&gt;</span>
                <span class="hljs-comment">&lt;!-- 等待时间（毫秒） --&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"poolTimeToWait"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"20000"</span>/&gt;</span>
                <span class="hljs-comment">&lt;!-- 最大本地坏连接容忍度 --&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"poolMaximumLocalBadConnectionTolerance"</span> 
                    <span class="hljs-attr">value</span>=<span class="hljs-string">"3"</span>/&gt;</span>

                <span class="hljs-comment">&lt;!-- 连接测试配置 --&gt;</span>
                <span class="hljs-comment">&lt;!-- 是否启用Ping查询 --&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"poolPingEnabled"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"true"</span>/&gt;</span>
                <span class="hljs-comment">&lt;!-- Ping查询SQL --&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"poolPingQuery"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"SELECT 1"</span>/&gt;</span>
                <span class="hljs-comment">&lt;!-- 未使用超过此时间（毫秒）才进行Ping测试 --&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"poolPingConnectionsNotUsedFor"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"60000"</span>/&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">dataSource</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">environment</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 生产环境配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">environment</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"production"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">transactionManager</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"JDBC"</span>/&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">dataSource</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"POOLED"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"driver"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"com.mysql.cj.jdbc.Driver"</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"url"</span> 
                    <span class="hljs-attr">value</span>=<span class="hljs-string">"jdbc:mysql://prod-server:3306/mybatis"</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"username"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"prod_user"</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"prod_password"</span>/&gt;</span>

                <span class="hljs-comment">&lt;!-- 生产环境连接池配置 --&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"poolMaximumActiveConnections"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"50"</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"poolMaximumIdleConnections"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"20"</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"poolPingEnabled"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"true"</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"poolPingQuery"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"SELECT 1"</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"poolPingConnectionsNotUsedFor"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"30000"</span>/&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">dataSource</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">environment</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">environments</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
</code></pre>
<h2 data-id="heading-18">5.2 属性文件配置方式</h2>
<p>创建jdbc.properties文件：</p>
<pre><code class="hljs language-bash" lang="bash">JDBC配置jdbc.driver=com.mysql.cj.jdbc.Driverjdbc.url=jdbc:mysql://localhost:3306/mybatis?useSSL=<span class="hljs-literal">false</span>&amp;serverTimezone=UTCjdbc.username=rootjdbc.password=123456<span class="hljs-comment"># 连接池配置jdbc.poolMaximumActiveConnections=20jdbc.poolMaximumIdleConnections=10jdbc.poolMaximumCheckoutTime=20000jdbc.poolTimeToWait=20000</span>
</code></pre>
<p>在MyBatis配置中引用：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;configuration&gt;
    &lt;!-- 引入属性文件 --&gt;
    &lt;properties <span class="hljs-attr">resource</span>=<span class="hljs-string">"jdbc.properties"</span>/&gt;

    &lt;environments <span class="hljs-attr">default</span>=<span class="hljs-string">"development"</span>&gt;
        &lt;environment <span class="hljs-attr">id</span>=<span class="hljs-string">"development"</span>&gt;
            &lt;transactionManager <span class="hljs-attr">type</span>=<span class="hljs-string">"JDBC"</span>/&gt;
            &lt;dataSource <span class="hljs-attr">type</span>=<span class="hljs-string">"POOLED"</span>&gt;
                &lt;property <span class="hljs-attr">name</span>=<span class="hljs-string">"driver"</span> value=<span class="hljs-string">"${jdbc.driver}"</span>/&gt;
                &lt;property <span class="hljs-attr">name</span>=<span class="hljs-string">"url"</span> value=<span class="hljs-string">"${jdbc.url}"</span>/&gt;
                &lt;property <span class="hljs-attr">name</span>=<span class="hljs-string">"username"</span> value=<span class="hljs-string">"${jdbc.username}"</span>/&gt;
                &lt;property <span class="hljs-attr">name</span>=<span class="hljs-string">"password"</span> value=<span class="hljs-string">"${jdbc.password}"</span>/&gt;
                &lt;property <span class="hljs-attr">name</span>=<span class="hljs-string">"poolMaximumActiveConnections"</span> 
                    <span class="hljs-attr">value</span>=<span class="hljs-string">"${jdbc.poolMaximumActiveConnections}"</span>/&gt;
                &lt;property <span class="hljs-attr">name</span>=<span class="hljs-string">"poolMaximumIdleConnections"</span> 
                    <span class="hljs-attr">value</span>=<span class="hljs-string">"${jdbc.poolMaximumIdleConnections}"</span>/&gt;
            &lt;/dataSource&gt;
        &lt;/environment&gt;
    &lt;/environments&gt;
&lt;/configuration&gt;
</code></pre>
<h2 data-id="heading-19">5.3 JNDI配置方式</h2>
<pre><code class="hljs language-ini" lang="ini">&lt;dataSource <span class="hljs-attr">type</span>=<span class="hljs-string">"JNDI"</span>&gt;
    &lt;property <span class="hljs-attr">name</span>=<span class="hljs-string">"data_source"</span> value=<span class="hljs-string">"java:comp/env/jdbc/MyDS"</span>/&gt;
&lt;/dataSource&gt;
</code></pre>
<h2 data-id="heading-20">5.4 编程式配置</h2>
<pre><code class="hljs language-ini" lang="ini">// 创建数据源
PooledDataSource <span class="hljs-attr">dataSource</span> = new PooledDataSource()<span class="hljs-comment">;</span>
dataSource.setDriver("com.mysql.cj.jdbc.Driver")<span class="hljs-comment">;</span>
dataSource.setUrl("jdbc:mysql://localhost:3306/mybatis")<span class="hljs-comment">;</span>
dataSource.setUsername("root")<span class="hljs-comment">;</span>
dataSource.setPassword("123456")<span class="hljs-comment">;</span>
// 配置连接池
dataSource.setPoolMaximumActiveConnections(20)<span class="hljs-comment">;</span>
dataSource.setPoolMaximumIdleConnections(10)<span class="hljs-comment">;</span>
dataSource.setPoolPingEnabled(true)<span class="hljs-comment">;</span>
dataSource.setPoolPingQuery("SELECT 1")<span class="hljs-comment">;</span>
// 创建SqlSessionFactory
TransactionFactory <span class="hljs-attr">transactionFactory</span> = new JdbcTransactionFactory()<span class="hljs-comment">;</span>
Environment <span class="hljs-attr">environment</span> = new Environment(
    "development", transactionFactory, dataSource
)<span class="hljs-comment">;</span>
Configuration <span class="hljs-attr">configuration</span> = new Configuration(environment)<span class="hljs-comment">;</span>
configuration.addMapper(UserMapper.class)<span class="hljs-comment">;</span>
SqlSessionFactory <span class="hljs-attr">sqlSessionFactory</span> = 
    new SqlSessionFactoryBuilder().build(configuration)<span class="hljs-comment">;</span>
</code></pre>
<h2 data-id="heading-21">六、连接获取与释放流程</h2>
<h2 data-id="heading-22">理解连接的获取和释放流程对于使用连接池至关重要。</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d93e1c6cc7f649288b942b528cd470c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352429&amp;x-signature=ZEfH4ATammJwlYBWsooY8OukVYg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-23">6.1 连接获取流程</h2>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 应用请求连接
   ↓
<span class="hljs-bullet">2.</span> 调用dataSource.getConnection()
   ↓
<span class="hljs-bullet">3.</span> 检查空闲连接池
   ├─ 有空闲连接 → 取出连接
   │                ↓
   │             测试连接有效性
   │                ├─ 有效 → 返回连接
   │                └─ 无效 → 创建新连接
   │
   └─ 无空闲连接
<span class="hljs-code">       ↓
      检查活动连接数
       ├─ 未达上限 → 创建新连接 → 返回
       └─ 已达上限 → 等待空闲连接
</span></code></pre>
<h2 data-id="heading-24">6.2 连接释放流程</h2>
<pre><code class="hljs language-markdown" lang="markdown">. 应用调用connection.close()
   ↓
<span class="hljs-bullet">2.</span> PooledConnection拦截close调用
   ↓
<span class="hljs-bullet">3.</span> 不真正关闭，而是执行归还逻辑
   ↓
<span class="hljs-bullet">4.</span> 从活动连接池移除
   ↓
<span class="hljs-bullet">5.</span> 检查空闲连接池
   ├─ 未满 → 归还到空闲连接池
   └─ 已满 → 真正关闭物理连接
</code></pre>
<h2 data-id="heading-25">6.3 连接使用示例</h2>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 获取SqlSession</span>
SqlSession session = sqlSessionFactory<span class="hljs-selector-class">.openSession</span>();
try {
    <span class="hljs-comment">// 获取Mapper</span>
    UserMapper mapper = session<span class="hljs-selector-class">.getMapper</span>(UserMapper.class);

    <span class="hljs-comment">// 执行查询（内部自动获取连接）</span>
    User user = mapper<span class="hljs-selector-class">.selectById</span>(<span class="hljs-number">1</span>L);

    <span class="hljs-comment">// 执行更新</span>
    user<span class="hljs-selector-class">.setName</span>("张三");
    mapper<span class="hljs-selector-class">.update</span>(user);

    <span class="hljs-comment">// 提交事务</span>
    session<span class="hljs-selector-class">.commit</span>();
} catch (Exception e) {
    <span class="hljs-comment">// 回滚事务</span>
    session<span class="hljs-selector-class">.rollback</span>();
    throw e;
} finally {
    <span class="hljs-comment">//关闭Session（归还连接到池）</span>
    session<span class="hljs-selector-class">.close</span>();
}
</code></pre>
<h2 data-id="heading-26">七、连接池类型对比</h2>
<p>MyBatis支持三种数据源类型，各有适用场景。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0becc75a140e4dc3b07258d73d67f445~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768352429&amp;x-signature=Ba4LxY%2FRnsT9u9HbJUXPG3Q4yH0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-27">7.1 UNPOOLED（无池）</h2>
<p>特点：</p>
<pre><code class="hljs">每次请求创建新连接
使用完毕立即关闭
不维护连接池
</code></pre>
<p>配置：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;dataSource <span class="hljs-attr">type</span>=<span class="hljs-string">"UNPOOLED"</span>&gt;
    &lt;property <span class="hljs-attr">name</span>=<span class="hljs-string">"driver"</span> value=<span class="hljs-string">"com.mysql.cj.jdbc.Driver"</span>/&gt;
    &lt;property <span class="hljs-attr">name</span>=<span class="hljs-string">"url"</span> value=<span class="hljs-string">"jdbc:mysql://localhost:3306/mybatis"</span>/&gt;
    &lt;property <span class="hljs-attr">name</span>=<span class="hljs-string">"username"</span> value=<span class="hljs-string">"root"</span>/&gt;
    &lt;property <span class="hljs-attr">name</span>=<span class="hljs-string">"password"</span> value=<span class="hljs-string">"123456"</span>/&gt;
&lt;/dataSource&gt;
</code></pre>
<p>适用场景：</p>
<pre><code class="hljs">测试环境 
简单应用  
不需要高并发的场景
</code></pre>
<h2 data-id="heading-28">7.2 POOLED（池化）</h2>
<p>特点：</p>
<pre><code class="hljs">维护连接池
连接复用
自动管理连接生命周期
</code></pre>
<p>配置：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dataSource</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"POOLED"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"driver"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"com.mysql.cj.jdbc.Driver"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"url"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"jdbc:mysql://localhost:3306/mybatis"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"username"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"root"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"123456"</span>/&gt;</span>
    <span class="hljs-comment">&lt;!-- 连接池配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"poolMaximumActiveConnections"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"20"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"poolMaximumIdleConnections"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"10"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dataSource</span>&gt;</span>

</code></pre>
<pre><code class="hljs">适用场景：
生产环境
高并发应用
需要优化性能的场景
</code></pre>
<h2 data-id="heading-29">7.3 JNDI</h2>
<p>特点：</p>
<pre><code class="hljs">使用应用服务器管理的DataSource
通过JNDI查找获取
支持分布式事务
</code></pre>
<p><strong>配置：</strong></p>
<pre><code class="hljs language-ini" lang="ini">&lt;dataSource <span class="hljs-attr">type</span>=<span class="hljs-string">"JNDI"</span>&gt;
    &lt;property <span class="hljs-attr">name</span>=<span class="hljs-string">"data_source"</span> value=<span class="hljs-string">"java:comp/env/jdbc/MyDS"</span>/&gt;
&lt;/dataSource&gt;
</code></pre>
<p>适用场景：</p>
<pre><code class="hljs">应用服务器环境（WebLogic、WebSphere等） 
需要分布式事务支持
集中管理数据源7.4 连接池配置参数说明
</code></pre>


















































<table><thead><tr><th>参数</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td>poolMaximumActiveConnections</td><td>10</td><td>最大活动连接数</td></tr><tr><td>poolMaximumIdleConnections</td><td>5</td><td>最大空闲连接数</td></tr><tr><td>poolMaximumCheckoutTime</td><td>20000</td><td>最大Checkout时间（毫秒）</td></tr><tr><td>poolTimeToWait</td><td>20000</td><td>等待连接时间（毫秒）</td></tr><tr><td>poolPingEnabled</td><td>false</td><td>是否启用Ping测试</td></tr><tr><td>poolPingQuery</td><td>"NO PING QUERY SET"</td><td>Ping测试SQL</td></tr><tr><td>poolPingConnectionsNotUsedFor</td><td>0</td><td>未使用多久才Ping（毫秒）</td></tr><tr><td>poolMaximumLocalBadConnectionTolerance</td><td>3</td><td>最大本地坏连接容忍度</td></tr></tbody></table>
<h2 data-id="heading-30">八、最佳实践</h2>
<h2 data-id="heading-31">8.1 常见问题解决</h2>
<pre><code class="hljs language-xml" lang="xml">// 错误示例：忘记关闭连接
SqlSession session = sqlSessionFactory.openSession();
User user = session.selectOne(
    "com.example.mapper.UserMapper.selectById", 1L
);
//没有关闭session，连接泄漏！

//正确示例：及时关闭
SqlSession session = sqlSessionFactory.openSession();
try {
    User user = session.selectOne(
        "com.example.mapper.UserMapper.selectById", 1L
    );
} finally {
    session.close(); // 确保连接归还到池
}
<span class="hljs-comment">&lt;!-- 解决方案1：增加连接池大小 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"poolMaximumActiveConnections"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"50"</span>/&gt;</span>

<span class="hljs-comment">&lt;!-- 解决方案2：减少Checkout时间 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"poolMaximumCheckoutTime"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"10000"</span>/&gt;</span>
<span class="hljs-comment">&lt;!-- 解决方案3：增加等待时间 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"poolTimeToWait"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"30000"</span>/&gt;</span>
</code></pre>
<h2 data-id="heading-32">8.2 连接池监控</h2>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 获取连接池状态</span>
PooledDataSource dataSource = (PooledDataSource) sqlSessionFactory
    <span class="hljs-selector-class">.getConfiguration</span>()
    <span class="hljs-selector-class">.getEnvironment</span>()
    <span class="hljs-selector-class">.getDataSource</span>();

<span class="hljs-comment">// 获取PoolState</span>
PoolState poolState = dataSource<span class="hljs-selector-class">.getPoolState</span>();

<span class="hljs-comment">// 监控指标</span>
System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("连接池状态：");
System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("空闲连接数：" + 
    poolState.getIdleConnections()<span class="hljs-selector-class">.size</span>());
System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("活动连接数：" + 
    poolState.getActiveConnections()<span class="hljs-selector-class">.size</span>());
System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("请求总数：" + 
    poolState.getRequestCount());
System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("坏连接数：" + 
    poolState.getBadConnectionCount());
</code></pre>
<h2 data-id="heading-33">九、总结</h2>
<p>MyBatis的数据源模块提供了灵活而强大的数据库连接管理能力。</p>
<pre><code class="hljs language-arduino" lang="arduino">DataSourceFactory - 创建数据源的工厂接口
UnpooledDataSource - 不使用连接池的数据源
PooledDataSource - 使用连接池的数据源
PooledConnection - 代理连接，拦截close方法
PoolState - 维护连接池
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解 Volatile：C#.NET 内存可见性与有序性]]></title>    <link>https://juejin.cn/post/7592120202319183922</link>    <guid>https://juejin.cn/post/7592120202319183922</guid>    <pubDate>2026-01-06T23:18:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592120202319183922" data-draft-id="7592130164965244966" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解 Volatile：C#.NET 内存可见性与有序性"/> <meta itemprop="keywords" content="C#,.NET"/> <meta itemprop="datePublished" content="2026-01-06T23:18:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="唐青枫"/> <meta itemprop="url" content="https://juejin.cn/user/3737995266234280"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解 Volatile：C#.NET 内存可见性与有序性
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3737995266234280/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    唐青枫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T23:18:26.000Z" title="Tue Jan 06 2026 23:18:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">简介</h3>
<p><code>Volatile</code> 是 <code>C#</code> 中处理内存可见性和指令重排序的关键机制，它提供了对内存访问的精细控制。在并发编程中，<code>volatile</code> 关键字和 <code>Volatile</code> 类都是解决共享变量可见性问题的重要工具。</p>
<h3 data-id="heading-1">为什么需要volatile？</h3>
<h4 data-id="heading-2">CPU 缓存导致的 “内存可见性” 问题</h4>
<p>现代 <code>CPU</code> 为提升性能，会将频繁访问的变量缓存到核心专属的缓存（<code>L1/L2/L3</code>）中，而非每次都读写主内存。这会导致：</p>
<ul>
<li>
<p>线程 A 修改了共享字段的值（仅写入自己的 <code>CPU</code> 缓存，未同步到主内存）；</p>
</li>
<li>
<p>线程 B 读取该字段时，从自己的 <code>CPU</code> 缓存读取（仍是旧值），无法看到线程 A 的修改。</p>
</li>
</ul>
<h4 data-id="heading-3">编译器 / CPU 的 “指令重排序” 优化</h4>
<p>编译器（<code>C#</code> 编译器）和 <code>CPU</code> 为提升执行效率，会在不改变单线程逻辑的前提下，调整指令的执行顺序</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 原始代码</span>
<span class="hljs-built_in">bool</span> _isReady = <span class="hljs-literal">false</span>;
<span class="hljs-built_in">int</span> _data = <span class="hljs-number">100</span>;

<span class="hljs-comment">// 编译器/CPU可能重排序为：先赋值_data，再赋值_isReady（单线程无影响）</span>
<span class="hljs-comment">// 但多线程下，线程B可能看到_isReady=true，但_data还是旧值</span>
</code></pre>
<p><code>volatile</code> 的核心作用就是：禁止缓存 + 禁止指令重排序，保证多线程对字段的访问 “所见即所得”。</p>
<ul>
<li>
<p>插入内存屏障（<code>memory barrier</code>）：</p>
<ul>
<li>
<p><code>Acquire Fence</code>：读取 <code>volatile</code> 字段前，禁止将后续读取提前。</p>
</li>
<li>
<p><code>Release Fence</code>：写入 <code>volatile</code> 字段后，禁止将之前写入推迟。</p>
</li>
</ul>
</li>
<li>
<p>强制每次读写都直接访问主内存，绕过缓存优化。</p>
</li>
</ul>
<h3 data-id="heading-4">核心定义与语法</h3>
<h4 data-id="heading-5">语法规则</h4>
<p><code>volatile</code> 只能修饰字段，且有严格的类型限制，语法如下：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 正确：修饰实例字段</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-built_in">bool</span> _isRunning;

<span class="hljs-comment">// 正确：修饰静态字段</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> <span class="hljs-built_in">int</span> _counter;

<span class="hljs-comment">// 错误：不能修饰方法/参数/局部变量/属性/常量</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">void</span> <span class="hljs-title">DoWork</span>()</span> { } <span class="hljs-comment">// 编译错误</span>
<span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> VolatileProperty { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } <span class="hljs-comment">// 编译错误（属性不能加volatile）</span>
</code></pre>
<h4 data-id="heading-6">支持的类型</h4>
<p><code>volatile</code> 仅支持以下类型（避免 <code>CPU</code> 操作的原子性问题）：</p>
<ul>
<li>
<p>引用类型（如 <code>object</code>、<code>string</code>、自定义类）；</p>
</li>
<li>
<p>值类型：<code>byte、sbyte、short、ushort、int、uint、long、ulong、char、float、bool</code>；</p>
</li>
<li>
<p>上述类型的指针（如 <code>int*</code> ）。</p>
</li>
</ul>
<blockquote>
<p>注意：不支持double、decimal、struct（自定义值类型）、DateTime等，这些类型的读写不是原子的，volatile无法保证正确性。</p>
</blockquote>
<h4 data-id="heading-7">等效方法：Volatile.Read/Volatile.Write</h4>
<p>除了关键字，<code>.NET</code> 还提供 <code>Volatile</code> 静态类的 <code>Read/Write</code> 方法，功能与 <code>volatile</code> 关键字一致，但更灵活（可动态控制读写）：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 等价于 volatile 修饰的 _isRunning = true</span>
Volatile.Write(<span class="hljs-keyword">ref</span> _isRunning, <span class="hljs-literal">true</span>);

<span class="hljs-comment">// 等价于读取 volatile 修饰的 _isRunning</span>
<span class="hljs-built_in">bool</span> current = Volatile.Read(<span class="hljs-keyword">ref</span> _isRunning);
</code></pre>
<h3 data-id="heading-8">核心原理：内存屏障（Memory Barrier）</h3>
<p><code>volatile</code> 的底层是通过插入内存屏障（<code>Memory Barrier</code>） 实现的：</p>
<ul>
<li>
<p>读屏障（<code>Load Barrier</code>）：读取 <code>volatile</code> 字段时，插入读屏障，强制 <code>CPU</code> 从主内存读取值，而非缓存；同时禁止将读指令重排序到屏障之前。</p>
</li>
<li>
<p>写屏障（<code>Store Barrier</code>）：写入 <code>volatile</code> 字段时，插入写屏障，强制 <code>CPU</code> 将值写入主内存，而非缓存；同时禁止将写指令重排序到屏障之后。</p>
</li>
</ul>
<h3 data-id="heading-9">基础使用示例</h3>
<h4 data-id="heading-10">关键字用法</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ThreadSafeFlag</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-built_in">bool</span> _isRunning = <span class="hljs-literal">true</span>;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Run</span>()</span>
    {
        <span class="hljs-comment">// 线程1：循环直到标志关闭</span>
        <span class="hljs-keyword">while</span> (_isRunning)
        {
            <span class="hljs-comment">// 执行工作</span>
            Thread.SpinWait(<span class="hljs-number">1000</span>);
        }
        Console.WriteLine(<span class="hljs-string">"线程停止"</span>);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Stop</span>()</span>
    {
        <span class="hljs-comment">// 线程2：设置标志</span>
        _isRunning = <span class="hljs-literal">false</span>;
        Console.WriteLine(<span class="hljs-string">"停止信号已发送"</span>);
    }
}
</code></pre>
<p>使用示例：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">var</span> flag = <span class="hljs-keyword">new</span> ThreadSafeFlag();
<span class="hljs-keyword">var</span> worker = <span class="hljs-keyword">new</span> Thread(flag.Run);
worker.Start();

Thread.Sleep(<span class="hljs-number">100</span>);
flag.Stop();  <span class="hljs-comment">// 另一个线程能立即看到变化</span>
worker.Join();
</code></pre>
<p>不加 <code>volatile</code>：可能导致 <code>_isRunning</code> 被缓存，线程永远不退出。</p>
<h4 data-id="heading-11">Volatile 类静态方法（.NET 4.5+ 推荐）</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> System.Threading;

<span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> _value;

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">ReadValue</span>()</span> =&gt; Volatile.Read(<span class="hljs-keyword">ref</span> _value);
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">WriteValue</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> newValue</span>)</span> =&gt; Volatile.Write(<span class="hljs-keyword">ref</span> _value, newValue);
</code></pre>
<ul>
<li>
<p><code>Volatile.Read</code>：带 <code>Acquire</code> 屏障的读取。</p>
</li>
<li>
<p><code>Volatile.Write</code>：带 <code>Release</code> 屏障的写入。</p>
</li>
<li>
<p>优势：更精确控制屏障方向，比关键字更灵活。</p>
</li>
</ul>
<h4 data-id="heading-12">双检查锁单例</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Singleton</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> Singleton? _instance;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton Instance
    {
        <span class="hljs-keyword">get</span>
        {
            <span class="hljs-keyword">if</span> (_instance == <span class="hljs-literal">null</span>)
            {
                <span class="hljs-keyword">lock</span> (<span class="hljs-keyword">typeof</span>(Singleton))
                {
                    <span class="hljs-keyword">if</span> (_instance == <span class="hljs-literal">null</span>)
                        _instance = <span class="hljs-keyword">new</span> Singleton();
                }
            }
            <span class="hljs-keyword">return</span> _instance!;
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">Singleton</span>()</span> { }
}
</code></pre>
<h3 data-id="heading-13">优点与缺点</h3>






























<table><thead><tr><th>方面</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td><strong>性能</strong></td><td>极低开销（仅内存屏障），远高于锁</td><td>仍比普通变量慢（禁用部分优化）</td></tr><tr><td><strong>易用性</strong></td><td>简单关键字或方法调用</td><td>语义复杂，易误用</td></tr><tr><td><strong>适用性</strong></td><td>完美用于简单标志位、状态切换、双检查锁</td><td><strong>不能</strong>用于计数器、复合操作</td></tr><tr><td><strong>安全性</strong></td><td>提供必要内存模型保证</td><td>不足以实现复杂同步</td></tr></tbody></table>
<h3 data-id="heading-14">推荐场景</h3>
<h4 data-id="heading-15">推荐使用 <code>volatile</code> 的场景：</h4>
<ul>
<li>
<p>布尔标志（如停止信号 <code>_isRunning</code>）。</p>
</li>
<li>
<p>状态枚举（如 <code>Ready/Running/Stopped</code>）。</p>
</li>
<li>
<p>引用类型字段的双检查锁单例。</p>
</li>
<li>
<p>一写多读（<code>one writer, multiple readers</code>）模式。</p>
</li>
</ul>
<h4 data-id="heading-16">不推荐使用 <code>volatile</code> 的场景：</h4>
<ul>
<li>
<p>计数器、累加操作 → 用 <code>Interlocked</code>。</p>
</li>
<li>
<p>复杂状态 → 用 <code>lock</code> 或无锁结构。</p>
</li>
<li>
<p>64位值（long/double）在32位进程 → 用 <code>Interlocked</code>。</p>
</li>
</ul>
<h3 data-id="heading-17">Volatile vs Interlocked</h3>



































<table><thead><tr><th>对比项</th><th>Volatile</th><th>Interlocked</th></tr></thead><tbody><tr><td>原子性</td><td>❌</td><td>✅</td></tr><tr><td>内存屏障</td><td>Acquire / Release</td><td>Full Fence</td></tr><tr><td>返回旧值</td><td>❌</td><td>✅</td></tr><tr><td>适用场景</td><td>状态观察</td><td>状态修改</td></tr><tr><td>性能</td><td>更快</td><td>稍慢</td></tr></tbody></table>
<h3 data-id="heading-18">总结</h3>
<p><code>volatile</code> 是 <code>.NET</code> 多线程编程中一个低级但关键的工具，适合简单的一写多读标志场景。但绝不能滥用，大多数线程安全需求应优先选择 <code>Interlocked、lock、Lazy&lt;T&gt;</code> 或并发集合。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 读：Volatile</span>
<span class="hljs-keyword">var</span> state = Volatile.Read(<span class="hljs-keyword">ref</span> _state);

<span class="hljs-comment">// 写：CAS / Exchange</span>
<span class="hljs-keyword">if</span> (state == A)
    Interlocked.CompareExchange(<span class="hljs-keyword">ref</span> _state, B, A);
</code></pre>
<blockquote>
<p>Volatile 是并发程序的“观察者协议”，
Interlocked 才是“修改者协议”。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PHP 异步与多线程 从 TrueAsync 展望未来]]></title>    <link>https://juejin.cn/post/7592059801884835883</link>    <guid>https://juejin.cn/post/7592059801884835883</guid>    <pubDate>2026-01-06T23:10:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592059801884835883" data-draft-id="7592069113222496275" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PHP 异步与多线程 从 TrueAsync 展望未来"/> <meta itemprop="keywords" content="后端,PHP"/> <meta itemprop="datePublished" content="2026-01-06T23:10:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PHP 异步与多线程 从 TrueAsync 展望未来
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T23:10:34.000Z" title="Tue Jan 06 2026 23:10:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">PHP 异步与多线程 从 TrueAsync 展望未来</h2>
<p>RFC TrueAsync 1.7 讨论中有个问题：这个提议会如何与 PHP 核心未来的变化互动？要设计好语言的长期演进，至少得对 PHP 的发展方向有基本判断。本文试图回答这个问题。</p>
<p>TrueAsync 项目不仅是 PHP 核心的 async 改动，还包括回答以下问题所需的其他研究：</p>
<ul>
<li>PHP 能在多大程度上向多线程方向发展？</li>
<li>是否存在根本性限制？</li>
<li>实现真正的多线程可能需要哪些核心改动？</li>
<li>可以实现哪些语言抽象？</li>
</ul>
<p>本文不是 PHP 多线程的详尽综述，也不追求每个细节的技术精确性或大众可读性。但希望它对 PHP 开发者有参考价值，能为后续讨论提供方向。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2026-01%2Fmultithreading-in-php-looking-to-the-future" target="_blank" title="https://catchadmin.com/post/2026-01/multithreading-in-php-looking-to-the-future" ref="nofollow noopener noreferrer">原文 PHP 异步与多线程 从 TrueAsync 展望未来</a></p>
<h3 data-id="heading-1">历史</h3>
<p>几年前要给 PHP 应用加高容量遥测，我说做不到。看到 Swoole 架构后想测试一下。能不能做一个 API，生成和处理大量数据的同时不拖慢客户端？</p>
<p>我们给 PHP 做了个优化的 OpenTelemetry，分批写数据，收集成大块再发到中间遥测服务器。数据压缩，JSON 结构用 MessagePack 序列化。</p>
<p>假设是：用单线程协程逐步构建遥测数据，定时或达到阈值时发送。没有跨线程交互，代码应该快。真的吗？</p>
<p>实验结果：遥测让 API 吞吐量减半。假设错了。为什么？概念上看起来没问题。Swoole 已经让 PHP 函数非阻塞，协程应该高效才对。哪里出错了？</p>
<p>第二版改成：遥测只在一个请求期间收集，立即扔给作业进程去聚合、压缩、发送。这版性能好多了。但不应该啊？进程间数据走管道，一端序列化另一端反序列化。管道在内存里，但系统调用开销不小。</p>
<p>后来找到原因：遥测数据量大，压缩相对 API 请求处理吃掉太多 CPU。Swoole 协程对 I/O 高效，但帮不了 CPU 密集型任务。</p>
<p>这个案例说明单线程协程解决不了所有问题。也说明多线程能补充协程，给更多问题提供工具。</p>
<h3 data-id="heading-2">单线程 + offload</h3>
<p>把 CPU 密集型工作卸载到单独进程不是什么新发明。这个模式在不同语言和框架中独立出现，叫 <code>Single-threaded + offload</code>。</p>
<p>打个比方：一个人快速分拣信件（每小时几千封），重包裹由其他员工用卡车装走。分拣员要是自己去搬包裹，信件队列就堆到天花板了。</p>
<p><code>Single-threaded + offload</code> 模型把任务分两类：</p>
<ul>
<li><strong>I/O-bound 任务</strong> — 读文件、网络调用、数据库访问。大部分时间在等外部世界。通过并发 async（协程、<code>await</code>），一个线程能容纳几千个这类操作。</li>
<li><strong>CPU-bound 任务</strong> — 压缩、加密、解析、计算。CPU 满负荷跑，光靠并发不够，得上更多核心。</li>
</ul>
<p>模型在物理上分离这两类任务：主线程（<code>Event Loop</code>）只管 I/O，CPU 任务扔给单独的线程或进程（<code>Workers</code>）。</p>
<p>Node.js 靠单线程 <code>Event Loop</code> 出名，很适合网络应用。但开发者要是在请求处理器里直接处理图像或压缩视频，服务器就变南瓜了。后来加了 <code>Worker Threads</code>，专门跑 CPU 密集型操作。</p>
<p>Python 走了类似路线。<code>asyncio</code> 出来后，I/O-bound 代码有了好工具，但 GIL（全局解释器锁）挡着，单进程内没法真正 CPU 并行（写这篇文章时问题已解决）。阻塞操作有 <code>loop.run_in_executor()</code> 和 <code>asyncio.to_thread()</code>（Python 3.9+），把重活卸载到线程池或进程池。<code>Event Loop</code> 保持响应，计算并行跑。</p>
<p>PHP/Swoole 也是这个架构：<code>Request Workers</code> 用协程处理 HTTP 请求，<code>Task Workers</code> 跑重计算。通过 UnixSocket 或管道通信，单进程能处理每秒约 10 万次操作。</p>
<h4 data-id="heading-3">模型的优势</h4>
<p><strong>1. 资源效率</strong></p>
<p>单线程 <code>Event Loop</code> 能以极小开销服务几千个并发 I/O 操作。协程任务间切换比操作系统线程上下文切换便宜得多。CPU-bound 任务在多核上真正并行——每个 worker 占一个核心，互不干扰。</p>
<p><strong>2. 开发简单</strong></p>
<p><code>Event Loop</code> 里的代码不用互斥锁、信号量这些多线程编程的玩意儿。单线程模型一次只跑一个任务，竞态条件不可能出现。<code>Workers</code> 并行跑，但只要遵循 <code>Shared Nothing</code>，同步问题就不存在。</p>
<p>多线程代码和单线程 async 代码的复杂度差距很大。现代语言和框架都奔着单线程 async 去，不走经典多线程。</p>
<p><strong>3. 编译器/运行时更简单</strong></p>
<p>单线程模型的 async 函数对编译器和运行时简单得多。好的多线程语言需要自己的代码生成管道。PHP 有个硬约束：部分代码用 C 写的，没法对线程、内存管理、参数传递做高效的字节码级优化。Go 的设计复杂出名：专有栈、复杂 GC，都是高效 goroutines 和 channels 必需的。PHP 的 GC 后面会讲，先别放松。</p>
<p><strong>4. 手动负载分配</strong></p>
<p>开发者可以主动在请求处理代码和 worker 池之间分配负载。手动控制能从硬件榨出理论最大值。但这也是缺点。</p>
<h4 data-id="heading-4">模型的劣势</h4>
<p><strong>1. 手动负载分配</strong></p>
<p>手动分配是双刃剑。开发者可以针对特定任务优化，也可能误判什么该放 I/O 代码、什么该放 workers。I/O 代码塞了重活会过载，响应变慢、延迟上升。</p>
<p>这个模型要求 PHP 开发者有足够技能，或者依赖框架作者提供的现成方案。</p>
<p><strong>2. 不适合所有任务</strong></p>
<p><code>Single-threaded + offload</code> 很适合 Web 服务器、API、微服务——主要负载是数据库、文件系统、网络调用这些 I/O。但每一步都要密集计算的场景——科学计算、渲染、机器学习——这个模型效果就差了。那些场景更适合完全多线程。</p>
<p>你可能说：能接受！准备好了！但 PHP 本身准备好多线程了吗？</p>
<h3 data-id="heading-5">PHP 准备好多线程了吗？</h3>
<p>开发 TrueAsync 时，最难的讨论之一是"为什么 PHP 没有 async"。解释 PHP 为什么还没准备好多线程可能同样难。不过先聊聊多线程本身。我们为什么需要它？或者换个问法：我们为什么不需要它？</p>
<p><strong>多线程不是并行执行代码的必要条件。</strong></p>
<p>"并行必须多线程"这个想法早就刻在程序员脑子里了，就像"黑洞会吸东西"刻在流行文化里一样。</p>
<p>并行执行完全可以用进程，进程彼此隔离（80386 架构就有了）。进程通过 IPC 通信，完成状态通过信号（操作系统事件）跟踪。那为什么还要线程？</p>
<p>要老实回答这个问题，得穿越回去请当年做决定的人解释：Edsger Dijkstra、Fernando Corbató、Barbara Liskov、Richard Rashid。办个脱口秀挺好。但就算他们都来了，可能也说不出直接答案。</p>
<p>下面这个说法是错的：</p>
<blockquote>
<p>线程是为了让并行代码不用额外工具就能共享内存。</p>
</blockquote>
<p>进程也能共享内存，但得把段映射到地址空间（额外工具）。线程默认共享所有内存。线程 A 能访问的变量 <code>x</code>，线程 B 在同一地址也能访问，不用任何技巧……但等等！多个线程没法在不加额外工具的情况下安全使用共享变量。</p>
<p>更准确的说法是：</p>
<blockquote>
<p>线程是为了在任务间传递内存时没有额外开销。</p>
</blockquote>
<p>如果线程用内存传消息，保证同一时间只有一个线程能访问某块内存区域，那在内存和 CPU 两方面都是最高效的。线程刻意避免共享内存。这个模型叫 <code>Shared Nothing</code>。</p>
<p><strong>线程是为了在任务间高效传数据。</strong> 跟"黑洞不吸东西"一样是事实。</p>
<h3 data-id="heading-6">PHP 内存模型</h3>
<p>PHP 怎么处理内存？简化的抽象模型：</p>
<ul>
<li>代码</li>
<li>数据</li>
<li>PHP VM 状态</li>
</ul>
<p>线程间共享 PHP 代码已经能做到（PHP JIT 解决了）。其他组件紧密耦合，拆不开。比如 PHP 用一个全局 <code>object_store</code> 存所有创建对象的引用。PHP 内存管理器是给单个 PHP VM 的对象设计的，不面向多线程。PHP 垃圾收集器处理不了不同线程的数据，甚至要完全停掉 VM，因为它直接改对象的 <code>refcount</code>。</p>
<p>所以 <strong>PHP 是严格的单线程模型，带 stop-the-world GC</strong>。</p>
<h3 data-id="heading-7">在线程间移动 PHP VM</h3>
<p>PHP 用线程局部存储（<code>Thread-Local Storage</code>，TLS）保存每个线程的 VM 状态。这对 ZTS（Zend Thread Safety）模式下线程间隔离很关键。</p>
<p>现代 PHP 构建用 C11 标准的 <code>__thread</code>（MSVC 里是 <code>__declspec(thread)</code>）获取 VM 状态指针。速度很快，x86_64 上就是从 FS 或 GS 寄存器的基址读一个偏移量。</p>
<pre><code class="hljs language-asm" lang="asm">; offset - 编译时计算的常量偏移量
; fs - 内存段的基地址
mov rax, QWORD PTR fs:offset
</code></pre>
<p>FS/GS 对每个线程唯一（操作系统保证），读出来的总是正确的 VM 状态指针。</p>
<p>能在线程间移动 VM 状态，就能实现类似 Go 协程或 actors 的功能。现代 VM 通过自定义代码生成传上下文，用 CPU 寄存器传 VM 状态。PHP 做不到这个，因为底层用 C 函数，C 没法给每个函数传隐式上下文参数。在线程间移动 PHP VM 状态会损失一定性能。</p>
<p>但如果只移动执行代码需要的那一小部分 VM 状态呢？比如 PHP Fiber 切换时会复制指向全局结构（<code>zend_executor_globals</code>）的部分指针。</p>
<p>如果把 PHP VM 概念上分成两部分：</p>
<ul>
<li><strong>PHP VM shared</strong>。类、函数、常量、ini 指令、可执行代码。</li>
<li><strong>PHP VM movable</strong>。需要移动的 VM 部分。</li>
</ul>
<p><img src="https://image.catchadmin.com/202601060808667.png" alt="PHP Memory Model" loading="lazy"/></p>
<p>有些结构可以标记为共享，有些标记为可移动；<code>Executor Globals</code> 甚至可以拆成共享和可移动两部分，实现线程间高效的 VM 状态移动。扩展全局结构不会因为多一层间接而损失性能，因为它们本来就在用间接访问。</p>
<p>问题出在代码编译相关的结构上。PHP 通过 <code>include</code>/<code>require</code>、<code>eval</code> 和自动加载是动态的，这让 VM 状态很难有效拆成共享和可移动两部分。如果能解决这个问题，PHP 就能以很小的开销在线程间移动部分 VM 状态。</p>
<h3 data-id="heading-8">在线程间传递对象</h3>
<p>PHP 要改什么才能安全地在线程间传递对象？怎么做？</p>
<p>从语言层面看。假设 <code>$obj</code> 里有个 <code>SomeObject</code> 实例，要发到另一个线程。能做到吗？</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$obj</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SomeObject</span>();

<span class="hljs-variable">$thread</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"/>) <span class="hljs-keyword">use</span> (<span class="hljs-params"><span class="hljs-variable">$obj</span></span>) </span>{
    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$obj</span>-&gt;<span class="hljs-title function_ invoke__">someMethod</span>();
});

<span class="hljs-variable">$thread</span>-&gt;<span class="hljs-title function_ invoke__">join</span>();
</code></pre>
<p><code>SomeObject</code> 只属于 <code>$obj</code>，可以安全地把地址从一个线程移到另一个。主线程的 <code>$obj</code> 会被销毁：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$obj</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SomeObject</span>();
<span class="hljs-variable">$thread</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"/>) <span class="hljs-keyword">use</span> (<span class="hljs-params"><span class="hljs-variable">$obj</span></span>) </span>{
    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$obj</span>-&gt;<span class="hljs-title function_ invoke__">someMethod</span>();
});

<span class="hljs-comment">// $obj 在这里未定义</span>
<span class="hljs-variable">$thread</span>-&gt;<span class="hljs-title function_ invoke__">join</span>();
</code></pre>
<p>上面的代码跟 C++ 和 Rust 的移动语义完全一样。这种线程间传内存的方式：</p>
<ul>
<li><strong>安全</strong>。只有一个线程拥有对象。</li>
<li><strong>没有复制或序列化开销</strong>。</li>
</ul>
<p>为了让行为可预测、静态分析器能读懂，应该加特殊的移动语法：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$obj</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SomeObject</span>();

<span class="hljs-comment">// consume $obj 表示移动对象</span>
<span class="hljs-variable">$thread</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"/>) <span class="hljs-keyword">use</span> (<span class="hljs-params">consume <span class="hljs-variable">$obj</span></span>) </span>{
    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$obj</span>-&gt;<span class="hljs-title function_ invoke__">someMethod</span>();
});

<span class="hljs-comment">// $obj 在这里未定义。在 PHP9 中应该在这里报告错误。</span>
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$obj</span>;
</code></pre>
<p>看着不错？</p>
<p>但移动 <code>refcount = 1</code> 的对象有问题。</p>
<p>看个分类树的例子：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$electronics</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CategoryNode</span>(<span class="hljs-string">'Electronics'</span>);
<span class="hljs-variable">$categoriesTree</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Tree</span>();
<span class="hljs-variable">$categoriesTree</span>-&gt;<span class="hljs-title function_ invoke__">addToPath</span>(<span class="hljs-string">'/products/electronics'</span>, <span class="hljs-variable">$electronics</span>);
<span class="hljs-variable">$categoriesTree</span>-&gt;<span class="hljs-title function_ invoke__">addToPath</span>(<span class="hljs-string">'/popular/electronics'</span>, <span class="hljs-variable">$electronics</span>);  
<span class="hljs-comment">// 同一个分类！</span>
</code></pre>
<p><code>$electronics</code> 在树里出现两次（<code>refcount = 2</code>）。把 <code>$categoriesTree</code> 移到另一个线程会怎样？</p>
<p>要安全移动，必须保证图里所有对象都没有外部引用：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$node</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CategoryNode</span>(<span class="hljs-string">'Electronics'</span>);
<span class="hljs-variable">$categoriesTree</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Tree</span>();
<span class="hljs-variable">$categoriesTree</span>-&gt;<span class="hljs-title function_ invoke__">addToPath</span>(<span class="hljs-string">'/products/electronics'</span>, <span class="hljs-variable">$node</span>);

<span class="hljs-variable">$favourites</span> = [<span class="hljs-variable">$node</span>];  <span class="hljs-comment">// 外部引用！</span>
<span class="hljs-variable">$thread</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"/>) <span class="hljs-keyword">use</span> (<span class="hljs-params"><span class="hljs-variable">$categoriesTree</span></span>) </span>{
    <span class="hljs-comment">// $categoriesTree 被移动</span>
});

<span class="hljs-comment">// $favourites[0] 现在指向另一个线程中的内存</span>
<span class="hljs-comment">// 悬空指针！</span>
</code></pre>
<p>安全移动需要：</p>
<ul>
<li><strong>完整图遍历</strong>：检查所有嵌套对象。</li>
<li><strong>Refcount 检查</strong>：图里每个对象都要查。</li>
<li><strong>身份保留</strong>：图内的重复项得保持重复。</li>
</ul>
<p>可以为此设计算法，叫深拷贝。简单实现大概这样：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 深拷贝伪代码</span>
<span class="hljs-comment">// 线程 A 中的源图</span>
<span class="hljs-variable">$node</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>(<span class="hljs-string">'A'</span>);        <span class="hljs-comment">// addr: 0x1000</span>
<span class="hljs-variable">$tree</span>-&gt;left = <span class="hljs-variable">$node</span>;          <span class="hljs-comment">// addr: 0x1000</span>
<span class="hljs-variable">$tree</span>-&gt;right = <span class="hljs-variable">$node</span>;         <span class="hljs-comment">// addr: 0x1000 (相同引用)</span>

<span class="hljs-comment">// 深拷贝到线程 B（带 MM 的伪代码）</span>
<span class="hljs-variable">$copied_map</span> = [];  <span class="hljs-comment">// 哈希表: addr_source -&gt; addr_target</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">deepCopyToThread</span>(<span class="hljs-params"><span class="hljs-keyword">object</span> <span class="hljs-variable">$obj</span>, Thread <span class="hljs-variable">$target_thread_mm</span></span>) 
</span>{
    <span class="hljs-variable">$source_addr</span> = <span class="hljs-title function_ invoke__">get_object_address</span>(<span class="hljs-variable">$obj</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$copied_map</span>[<span class="hljs-variable">$source_addr</span>])) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$copied_map</span>[<span class="hljs-variable">$source_addr</span>];  <span class="hljs-comment">// 已经复制！</span>
    }
    <span class="hljs-comment">// 在另一个线程的 MM 中分配内存</span>
    <span class="hljs-variable">$new_addr</span> = <span class="hljs-variable">$target_thread_mm</span>-&gt;<span class="hljs-title function_ invoke__">allocate</span>(<span class="hljs-title function_ invoke__">sizeof</span>(<span class="hljs-variable">$obj</span>));
    <span class="hljs-variable">$copied_map</span>[<span class="hljs-variable">$source_addr</span>] = <span class="hljs-variable">$new_addr</span>;
    <span class="hljs-comment">// 复制对象数据</span>
    <span class="hljs-title function_ invoke__">memcpy</span>(<span class="hljs-variable">$new_addr</span>, <span class="hljs-variable">$source_addr</span>, <span class="hljs-title function_ invoke__">sizeof</span>(<span class="hljs-variable">$obj</span>));
    <span class="hljs-comment">// 遍历属性</span>
    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$obj</span>-&gt;properties <span class="hljs-keyword">as</span> <span class="hljs-variable">$prop</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$prop</span>)) {
            <span class="hljs-variable">$new_prop_addr</span> = <span class="hljs-title function_ invoke__">deepCopyToThread</span>(<span class="hljs-variable">$prop</span>, <span class="hljs-variable">$target_thread_mm</span>);
            <span class="hljs-comment">// 更新新对象中的指针</span>
            <span class="hljs-title function_ invoke__">update_property</span>(<span class="hljs-variable">$new_addr</span>, <span class="hljs-variable">$prop</span>, <span class="hljs-variable">$new_prop_addr</span>);
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$new_addr</span>;
}
<span class="hljs-comment">// 线程 B 中的结果：</span>
<span class="hljs-comment">// $newTree-&gt;left (addr: 0x2500) === $newTree-&gt;right (addr: 0x2500)</span>
<span class="hljs-comment">// 身份保留！</span>
</code></pre>
<p>深拷贝时间复杂度 O(N + E)，N 是对象数，E 是引用数。空间复杂度 O(N)——哈希表 + 新对象 + 递归栈。</p>
<p>比序列化快，因为不用转换传输格式，但收益取决于数据形状和图大小。也可以混合：<code>refcount = 1</code> 的移动，其他的深拷贝。</p>
<p>结果：</p>
<ul>
<li>PHP 开发者不用管对象怎么传到另一个线程。</li>
<li>最好情况：内存直接移动（<code>refcount = 1</code>）。</li>
<li>最坏情况：深拷贝，保留身份（<code>refcount &gt; 1</code>）。</li>
</ul>
<p>看着还行：</p>
<ul>
<li>PHP 语法改动最小</li>
<li>可以逐步改</li>
<li>多线程能用了</li>
</ul>
<p>但核心层面没那么美好。要让对象移动成真，PHP 需要跨线程的内存管理机制。现在做不到。</p>
<h3 data-id="heading-9">多线程 PHP 内存管理器</h3>
<p>PHP 内存管理器类似 jemalloc 或 tcmalloc 这些现代分配器。区别是：它没有从另一个线程释放内存的正确算法。</p>
<p>场景：</p>
<ul>
<li>线程 A 创建对象。</li>
<li>移动（原样）给线程 B。</li>
<li>B 不再需要，要释放。</li>
</ul>
<p>每个 PHP 线程有自己的内存管理器（<code>Memory Manager</code>，MM）。B 想释放 A 分配的内存就出问题了。B 的 MM 不认识 A 的内存，释放会出错。B 直接访问 A 的 MM 结构也不行，需要同步。现代高性能多线程分配器用延迟释放（<code>deferred free</code>）解决这个问题。</p>
<p>延迟释放的思路：</p>
<ul>
<li>B 的 MM 看到一个不认识的指针。</li>
<li>找到哪个 MM 拥有它，给那个 MM 的队列发消息说可以释放了。</li>
<li>A 的 MM 处理队列，在自己的上下文里释放。</li>
</ul>
<p><img src="https://image.catchadmin.com/202601060809112.png" alt="Cross thread deferred free" loading="lazy"/></p>
<p>用现代无锁结构，这个算法吞吐量高，不同线程能并行释放内存，几乎不用锁。</p>
<p>多线程 PHP 内存管理器为以前不可能的改动打开了门。</p>
<h3 data-id="heading-10">共享对象</h3>
<p>能用最少操作把内存从一个线程传到另一个很好，但如果能创建一开始就设计成跨线程共享的对象呢？</p>
<p>很多服务可以构建成不可变对象，应该能在进程间共享，省内存、加快 worker 启动。</p>
<p>但 <code>refcount</code> 挡着，它让所有 PHP 对象实际上都是可变的。能绕过吗？</p>
<h4 data-id="heading-11">代理对象</h4>
<p>第一种方法是代理对象，引用存在所有线程可访问的共享内存池里的真实对象。代理只存标识符或指针，加上访问数据的方法。缺点：</p>
<ul>
<li>访问数据/属性变慢</li>
<li>Reflection API 和类型检查更复杂</li>
</ul>
<p>PHP 已经有强大的代理机制。代理共享对象在某些场景不错，比如计数器表或 Swoole/Table 这样的数据表。</p>
<h4 data-id="heading-12">带有 GC_SHARE 标志的共享对象</h4>
<p>PHP 有个内置机制通过 <code>GC_IMMUTABLE</code> 标志实现不可变元素，用于：</p>
<ul>
<li>内部字符串（<code>IS_STR_INTERNED</code>）——整个 PHP 进程存在的字符串常量</li>
<li>不可变数组（<code>IS_ARRAY_IMMUTABLE</code>）——比如 <code>zend_empty_array</code></li>
<li>opcache 里的常量——带常量数据的编译代码</li>
</ul>
<p><code>GC_IMMUTABLE</code> 让引擎跳过这些结构的 <code>refcount</code> 修改：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// Zend/zend_types.h</span>
<span class="hljs-comment">// 为 zend_refcounted_h 增加 refcount 的函数</span>
<span class="hljs-type">static</span> zend_always_inline <span class="hljs-type">void</span> <span class="hljs-title function_">zend_gc_try_addref</span><span class="hljs-params">(zend_refcounted_h *p)</span> {
    <span class="hljs-keyword">if</span> (!(p-&gt;u.type_info &amp; GC_IMMUTABLE)) {
        ZEND_RC_MOD_CHECK(p);
        ++p-&gt;refcount;
    }
}
</code></pre>
<p>类似机制可以支持 <code>SharedObjects</code>，比如加个 <code>GC_SHARE</code> 标志。</p>
<p>性能分析显示，检查 <code>GC_SHARE</code> 给单独的 <code>refcount++</code> 加了 +34% 开销（微基准测试）。实际应用里 <code>refcount</code> 操作只占总工作一小部分，影响几乎看不出来：</p>
<ul>
<li>真实操作（数组/对象）：+3–9%</li>
<li>实际应用：+0.05–0.5%</li>
</ul>
<p>这解决了一半问题；另一半是给这些对象设计 GC。用原子 <code>refcount</code> 不理想，多线程访问同一对象时会变慢。延迟释放算法可能更合适。</p>
<h3 data-id="heading-13">基于区域的内存</h3>
<p>基于区域的内存（<code>Region-based memory</code>）在面向 Web 的语言里越来越流行。</p>
<p>思路：给特定任务或线程在单独区域分配内存，不需要时整体释放。避免了逐个对象管理的复杂性，GC 也简单了。</p>
<p>比如 PHP MM 可以保证对象在绑定到特定 PHP 对象的区域里创建。区域生命周期等于对象生命周期。</p>
<p>对象销毁时整个区域直接释放，不用遍历子对象。这种对象要"移动"到另一个线程，可以避免深拷贝。</p>
<p>PHP VM 实现基于区域的内存有问题：比如全局对象列表、操作码缓存。但高效实现的机会不是零，值得继续研究。</p>
<p>有效的基于区域的内存算法能为 actors 打开门——有隔离内存的特殊对象。</p>
<p><strong>Actors 是多线程编程里最方便、最强大、最安全的工具。</strong></p>
<h3 data-id="heading-14">协程和线程协作</h3>
<p>从协程角度看，<code>Thread</code> 是个 <code>Awaitable</code> 对象。协程可以等 <code>Thread</code> 结果而不阻塞其他协程。一个线程能托管很多等重任务的协程。服务它们的线程对新请求保持快速响应，因为等 <code>Thread</code> 不阻塞 <code>Event Loop</code>。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Async</span>\<span class="hljs-title">await</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Async</span>\<span class="hljs-title">Thread</span>;

<span class="hljs-variable">$thread</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"/>) </span>{
    <span class="hljs-comment">// 硬件密集型任务在这里</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">42</span>;
});

<span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">await</span>(<span class="hljs-variable">$thread</span>); 
<span class="hljs-comment">// 协程在这里暂停，直到 Thread 完成</span>
</code></pre>
<p>这种方式能实现有 CPU 密集型任务和简单业务逻辑的聊天场景。
<img src="https://image.catchadmin.com/202601060809533.png" alt="协程和线程协作" loading="lazy"/></p>
<p>图里是个示例架构。应用有两个线程池：带并发多任务的请求处理线程，和跑 CPU 密集型任务的 worker 线程。协程处理请求，worker 跑重任务时可以完全暂停，跑完继续。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Async</span>\<span class="hljs-title">await</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Async</span>\<span class="hljs-title">ThreadPool</span>;

<span class="hljs-keyword">final</span> <span class="hljs-keyword">readonly</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ImageDto</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-variable">$width</span>,
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-variable">$height</span>,
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$text</span>,
</span>) </span>{}
}

<span class="hljs-variable">$pool</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPool</span>(<span class="hljs-number">2</span>);
<span class="hljs-variable">$dto</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ImageDto</span>(
    width: <span class="hljs-number">200</span>,
    height: <span class="hljs-number">200</span>,
    text: <span class="hljs-string">'Hello TrueAsync!'</span>
);

<span class="hljs-variable">$image</span> = <span class="hljs-variable">$pool</span>-&gt;<span class="hljs-title function_ invoke__">enqueue</span>(function (ImageDto <span class="hljs-variable">$dto</span>) {
    <span class="hljs-variable">$img</span> = <span class="hljs-title function_ invoke__">imagecreatetruecolor</span>(<span class="hljs-variable">$dto</span>-&gt;width, <span class="hljs-variable">$dto</span>-&gt;height);

    <span class="hljs-variable">$white</span> = <span class="hljs-title function_ invoke__">imagecolorallocate</span>(<span class="hljs-variable">$img</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>);
    <span class="hljs-variable">$black</span> = <span class="hljs-title function_ invoke__">imagecolorallocate</span>(<span class="hljs-variable">$img</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

    <span class="hljs-title function_ invoke__">imagefill</span>(<span class="hljs-variable">$img</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">$white</span>);
    <span class="hljs-title function_ invoke__">imagestring</span>(<span class="hljs-variable">$img</span>, <span class="hljs-number">5</span>, <span class="hljs-number">20</span>, <span class="hljs-number">90</span>, <span class="hljs-variable">$dto</span>-&gt;text, <span class="hljs-variable">$black</span>);

    <span class="hljs-title function_ invoke__">ob_start</span>();
    <span class="hljs-title function_ invoke__">imagepng</span>(<span class="hljs-variable">$img</span>);
    <span class="hljs-title function_ invoke__">imagedestroy</span>(<span class="hljs-variable">$img</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">ob_get_clean</span>();
}, <span class="hljs-variable">$dto</span>);

<span class="hljs-variable">$response</span>-&gt;<span class="hljs-title function_ invoke__">setHeader</span>(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'image/png'</span>);
<span class="hljs-variable">$response</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-variable">$image</span>);
<span class="hljs-variable">$response</span>-&gt;<span class="hljs-title function_ invoke__">end</span>();
</code></pre>
<p>协程代码是顺序的，读起来像普通代码，<code>ThreadPool::enqueue</code> 像在同一线程调用回调一样。DTO 跨线程传，结果字符串不会在内存里复制两次。</p>
<h3 data-id="heading-15">垃圾收集器和有状态模式</h3>
<p>现代化 PHP 内存管理器不是改进多线程环境唯一要做的事。没有高效 GC，多线程 PHP 会有性能问题和循环引用导致的内存泄漏。</p>
<p>PHP GC 用两种算法：引用计数做主要内存管理，并发循环收集（Concurrent Cycle Collection，Bacon-Rajan，2001）处理循环。引用计数每次赋值都递增/递减，没同步的话多线程不安全。每次赋值用原子操作开销太大；不同步就有竞态和泄漏。循环收集器虽然叫"并发"，但只在单线程内工作，用颜色标记（PURPLE → GREY → WHITE/BLACK）找循环，也不是线程安全的。</p>
<p>好消息是：当前 GC 实现在多线程环境能工作，因为它跟内存管理器分开，不依赖内存在哪分配。</p>
<p>但 PHP 要进入有状态应用的多线程时代，GC 得适应：</p>
<ul>
<li>在单独线程并行跑，不影响业务代码。</li>
<li>尽快释放资源。</li>
<li>提供泄漏检测、日志、遥测的额外工具（长时间运行的应用特别需要）。</li>
</ul>
<p>循环收集器可以改成在多线程环境工作，在单独线程处理引用，提高整体响应性。这可能够用了！</p>
<h3 data-id="heading-16">Actors</h3>
<p><code>ThreadPool</code> 和线程间传对象有用，但需要开发者的注意力、技能和精力。有个更好的多线程编程抽象，藏住线程/内存复杂性，完美契合业务逻辑：actors。</p>
<p><strong>Actors 是并发并行编程模型，计算的基本单元是 actor。</strong></p>
<p>每个 actor：</p>
<ul>
<li>有自己的隔离状态</li>
<li>顺序处理消息</li>
<li>只通过消息跟其他 actors 交互</li>
<li>可能在单独线程跑</li>
</ul>
<p>可以把 actor 想成对象，这让多线程 PHP 能用熟悉的 OOP 模式。</p>
<p>想象一个有很多房间的聊天服务器。每个房间是单独的对象。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Async</span>\<span class="hljs-title">Actor</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ChatRoom</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Actor</span>
</span>{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">array</span> <span class="hljs-variable">$messages</span> = [];
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$name</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$name</span></span>)
    </span>{
        <span class="hljs-variable language_">$this</span>-&gt;name = <span class="hljs-variable">$name</span>;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">postMessage</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$user</span>, <span class="hljs-keyword">string</span> <span class="hljs-variable">$text</span></span>): <span class="hljs-title">void</span>
    </span>{
        <span class="hljs-variable language_">$this</span>-&gt;messages[] = [
            <span class="hljs-string">'user'</span> =&gt; <span class="hljs-variable">$user</span>,
            <span class="hljs-string">'text'</span> =&gt; <span class="hljs-variable">$text</span>,
            <span class="hljs-string">'time'</span> =&gt; <span class="hljs-title function_ invoke__">time</span>()
        ];
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getMessages</span>(<span class="hljs-params"/>): <span class="hljs-title">array</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;messages;
    }
}

<span class="hljs-title function_ invoke__">spawn</span>(function() {
   <span class="hljs-variable">$room</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatRoom</span>(<span class="hljs-string">'general'</span>);
   <span class="hljs-variable">$room</span>-&gt;<span class="hljs-title function_ invoke__">postMessage</span>(<span class="hljs-string">'Alice'</span>, <span class="hljs-string">'Hello!'</span>);  <span class="hljs-comment">// 在另一个线程中运行，暂停协程！</span>
   <span class="hljs-variable">$messages</span> = <span class="hljs-variable">$room</span>-&gt;<span class="hljs-title function_ invoke__">getMessages</span>();       <span class="hljs-comment">// 在另一个线程中运行，暂停协程！</span>
   <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">json_encode</span>(<span class="hljs-variable">$messages</span>);
});
</code></pre>
<p><code>ChatRoom</code> 对象特殊。它们的数据和 PHP VM 状态本地化了，方便在线程间移动。每个方法在自己的线程跑，但任何时刻只有一个线程能执行给定 actor 的方法。</p>
<p>语义上，基类 <code>Actor</code> 定义了 PHP VM 和内存管理器的工作方式，让 <code>ChatRoom</code> 对象能安全地在单独线程跑。类类型不只"存"方法和属性信息，还存 MM 和 GC 该怎么操作这类对象。Rust、C++ 也有类似做法。好处：不改语法，符合 OOP 哲学。</p>
<p>示例看起来像协程里跑的普通顺序代码。但 <code>postMessage</code> 和 <code>getMessages</code> 在另一个线程跑，不会直接执行。协程给 actor 队列发消息，进入等待，actor 在另一个线程跑完方法返回结果后才恢复。</p>
<p>这跟熟悉的 PHP OOP 不冲突：<code>Actor</code> 重写 <code>__call</code>：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Actor</span> 
</span>{
    <span class="hljs-keyword">private</span> <span class="hljs-variable">$threadPool</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$name</span>, <span class="hljs-keyword">array</span> <span class="hljs-variable">$arguments</span></span>): <span class="hljs-title">mixed</span>
    </span>{
        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">current_thread_id</span>() === <span class="hljs-variable language_">$this</span>-&gt;threadPool-&gt;<span class="hljs-title function_ invoke__">getThreadIdForActor</span>(<span class="hljs-variable">$this</span>)) {
            <span class="hljs-comment">// 如果我们在同一个线程中，直接运行方法</span>
            <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-variable">$name</span>(...<span class="hljs-variable">$arguments</span>);
        }
    
        <span class="hljs-comment">// 否则将调用排队给 actor</span>
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;threadPool-&gt;<span class="hljs-title function_ invoke__">enqueueActorMethod</span>(<span class="hljs-variable">$this</span>, <span class="hljs-variable">$name</span>, <span class="hljs-variable">$arguments</span>);
    }
}
</code></pre>
<p><code>enqueueActorMethod</code> 把 <code>postMessage</code> 加到 actor 队列，订阅结果事件，调用 <code>Async\suspend()</code> 暂停协程。</p>
<p>Actor 代码顺序执行，解决竞态条件，多线程开发对开发者透明。</p>
<p>并行性靠每个 <code>ChatRoom</code> actor 能在单独线程跑来实现：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title function_ invoke__">spawn</span>(function() {
   <span class="hljs-variable">$room</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatRoom</span>(<span class="hljs-string">'room1'</span>);
   <span class="hljs-variable">$room</span>-&gt;<span class="hljs-title function_ invoke__">postMessage</span>(<span class="hljs-string">'Alice'</span>, <span class="hljs-string">'Hello!'</span>);
   <span class="hljs-variable">$messages</span> = <span class="hljs-variable">$room</span>-&gt;<span class="hljs-title function_ invoke__">getMessages</span>();
   <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">json_encode</span>(<span class="hljs-variable">$messages</span>);
});

<span class="hljs-title function_ invoke__">spawn</span>(function() {
   <span class="hljs-variable">$room</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatRoom</span>(<span class="hljs-string">'room2'</span>);
   <span class="hljs-variable">$room</span>-&gt;<span class="hljs-title function_ invoke__">postMessage</span>(<span class="hljs-string">'Bob'</span>, <span class="hljs-string">'Hi there!'</span>);
   <span class="hljs-variable">$messages</span> = <span class="hljs-variable">$room</span>-&gt;<span class="hljs-title function_ invoke__">getMessages</span>();
   <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">json_encode</span>(<span class="hljs-variable">$messages</span>);
});
</code></pre>
<p><code>ChatRoom</code> 实例能在不同线程并行跑，因为每个 actor 有自己的执行线程、唯一的 PHP VM 状态和内存。</p>
<p>创建 100 个聊天室：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Async</span>\<span class="hljs-title">Actor</span>;

<span class="hljs-variable">$rooms</span> = [
    <span class="hljs-string">'general'</span> =&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatRoom</span>(<span class="hljs-string">'general'</span>),
    <span class="hljs-string">'random'</span>  =&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatRoom</span>(<span class="hljs-string">'random'</span>),
    <span class="hljs-string">'tech'</span>    =&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatRoom</span>(<span class="hljs-string">'tech'</span>),
    <span class="hljs-comment">// ... 97 个更多房间</span>
];

<span class="hljs-comment">// 处理请求的协程</span>
<span class="hljs-title class_">HttpServer</span>::<span class="hljs-title function_ invoke__">onRequest</span>(function(Request <span class="hljs-variable">$request</span>, Response <span class="hljs-variable">$response</span>) <span class="hljs-keyword">use</span> ($<span class="hljs-title">rooms</span>) {
   // <span class="hljs-title">HTTP</span> 请求处理
   $<span class="hljs-title">roomName</span> = $<span class="hljs-title">request</span>-&gt;<span class="hljs-title">getQueryParam</span>('<span class="hljs-title">room</span>');
   <span class="hljs-variable">$room</span> = <span class="hljs-variable">$rooms</span>[<span class="hljs-variable">$roomName</span>] ?? <span class="hljs-literal">null</span>;
   
   <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$room</span>) {
      <span class="hljs-variable">$response</span>-&gt;<span class="hljs-title function_ invoke__">setStatus</span>(<span class="hljs-number">404</span>);
      <span class="hljs-variable">$response</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-string">'Room not found'</span>);
      <span class="hljs-variable">$response</span>-&gt;<span class="hljs-title function_ invoke__">end</span>();
      <span class="hljs-keyword">return</span>;
   }
   
   <span class="hljs-comment">// 调用看起来是同步的，但在另一个线程中运行！</span>
   <span class="hljs-variable">$room</span>-&gt;<span class="hljs-title function_ invoke__">postMessage</span>(<span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">getQueryParam</span>(<span class="hljs-string">'user'</span>), <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">getQueryParam</span>(<span class="hljs-string">'text'</span>));
   <span class="hljs-variable">$messages</span> = <span class="hljs-variable">$room</span>-&gt;<span class="hljs-title function_ invoke__">getMessages</span>();
   
   <span class="hljs-variable">$response</span>-&gt;<span class="hljs-title function_ invoke__">setHeader</span>(<span class="hljs-string">'Content-Type'</span>,  <span class="hljs-string">'application/json'</span>);  
   <span class="hljs-variable">$response</span>-&gt;<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-title function_ invoke__">json_encode</span>(<span class="hljs-variable">$messages</span>));
   <span class="hljs-variable">$response</span>-&gt;<span class="hljs-title function_ invoke__">end</span>();
});
</code></pre>
<p>每个聊天室顺序处理消息，跟其他房间并行。</p>
<p>Actors 不需要互斥锁、锁、复杂同步或手动线程池交互。它们是现成的高级并行化方案。</p>
<p>一个聊天室要给另一个发消息也行，因为 actors 是 <code>SharedObject</code>，能跨线程交互：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Rooms</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Actor</span>
</span>{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">array</span> <span class="hljs-variable">$rooms</span> = [];
    
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> ...<span class="hljs-variable">$roomNames</span></span>)
    </span>{
       <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$roomNames</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$name</span>) {
           <span class="hljs-variable language_">$this</span>-&gt;rooms[<span class="hljs-variable">$name</span>] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatRoom</span>(<span class="hljs-variable">$name</span>);
       }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">broadcastMessage</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$fromRoom</span>, <span class="hljs-keyword">string</span> <span class="hljs-variable">$user</span>, <span class="hljs-keyword">string</span> <span class="hljs-variable">$text</span></span>): <span class="hljs-title">void</span>
    </span>{
        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable language_">$this</span>-&gt;rooms <span class="hljs-keyword">as</span> <span class="hljs-variable">$name</span> =&gt; <span class="hljs-variable">$room</span>) {
            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$name</span> !== <span class="hljs-variable">$fromRoom</span>) {
                <span class="hljs-comment">// 非阻塞调用</span>
                <span class="hljs-variable">$room</span>-&gt;<span class="hljs-title function_ invoke__">postMessageAsync</span>(<span class="hljs-variable">$user</span>, <span class="hljs-variable">$text</span>);
            }
        }
    }
}

<span class="hljs-title function_ invoke__">spawn</span>(function() {
   <span class="hljs-variable">$rooms</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rooms</span>(<span class="hljs-string">'general'</span>, <span class="hljs-string">'room1'</span>, <span class="hljs-string">'room2'</span>, <span class="hljs-string">'room3'</span>);
   <span class="hljs-variable">$rooms</span>-&gt;<span class="hljs-title function_ invoke__">broadcastMessage</span>(<span class="hljs-string">'general'</span>, <span class="hljs-string">'Alice'</span>, <span class="hljs-string">'Hello!'</span>);
});
</code></pre>
<h4 data-id="heading-17">Actor 内部</h4>
<p>PHP VM 保证 actor 内所有对象：</p>
<ul>
<li>要么只属于该 actor，在其唯一区域分配</li>
<li>要么从其他区域或线程移动过来</li>
<li>要么是另一个 <code>SharedObject</code> 或另一个 actor</li>
</ul>
<p>Actor 要么拥有自己的区域，要么只用显式共享的不可变对象；否则竞态还是会有。</p>
<p>内存管理器保证 actor 方法内所有内存操作自动绑定到与 actor 关联的区域。</p>
<p>方法通过 <code>Scheduler</code> 服务的 MPMC 消息队列执行。<code>Scheduler</code> 在 actors 间分配 CPU 时间，提供并发和并行执行。</p>
<p><img src="https://image.catchadmin.com/202601060810207.png" alt="Actor 内部" loading="lazy"/></p>
<h3 data-id="heading-18">结论</h3>
<p>这些听着都不错，但什么时候能真正用上？</p>
<p><code>Single-threaded + offload</code> 模型可能很快出现，很多组件已经就绪。TrueAsync 单线程协程已到 beta 版。实验性的多线程内存管理器和创建线程的 API 已经实现。</p>
<p>Actors 需要更多开发时间，因为涉及 PHP 核心很多部分，但仍是 PHP 9 的现实目标，给市场提供一种安全的多线程编程语言。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2026：一名码农的“不靠谱”年度规划]]></title>    <link>https://juejin.cn/post/7592082090207707163</link>    <guid>https://juejin.cn/post/7592082090207707163</guid>    <pubDate>2026-01-06T17:19:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592082090207707163" data-draft-id="7592251792629907483" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2026：一名码农的“不靠谱”年度规划"/> <meta itemprop="keywords" content="后端,架构,程序员"/> <meta itemprop="datePublished" content="2026-01-06T17:19:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苏渡苇"/> <meta itemprop="url" content="https://juejin.cn/user/729731453429159"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2026：一名码农的“不靠谱”年度规划
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/729731453429159/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苏渡苇
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T17:19:30.000Z" title="Tue Jan 06 2026 17:19:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><p>又到了一年一度列计划的时候，我对着屏幕敲下“2026年度目标”这几个字，感觉就像在代码里写下了一个暂时没有具体实现的接口——定义很美好，实现嘛，有待观察。</p>
<h2 data-id="heading-0">一、工作要干得出彩，还得有点新花样</h2>
<p>说真的，每年我都告诉自己，今年一定要写出那种能让同事看了忍不住赞叹“妙啊”的代码。但实际情况往往是，我对着三年前自己写的代码陷入沉思：“这真是我写的吗？当时怎么想的？”</p>
<p>新点子倒是不缺，缺的是能让这些点子安全落地还不引起生产事故的魔法。我现在的原则是：每个炫酷的想法，都必须配套一个“搞砸了怎么办”的预案。</p>
<p>毕竟在架构师的世界里，最性感的不是多前沿的技术，而是“晚上能睡着觉”。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ea27e01b42949a9b1f0684af2ea41ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5rih6IuH:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768324769&amp;x-signature=oVrgKcj48xzTAm00ZRRV6XwCYQ4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">二、重构一个项目，这次来真的</h2>
<p>“重构”这两个字在我的待办列表里，就像代码中的TODO注释——常年存在，优先级随心情波动。每次打开那个历史悠久的项目，都像开启一场考古发掘，你能看到不同时期的技术选型、业务妥协，还有那些已经离职同事留下的神秘代码。</p>
<p>最有趣的是，你总会发现一些写得很巧妙的“临时方案”——它们临时了五年，依然健在。</p>
<p>我的目标是今年至少让某个模块变得好懂一些，不至于让新同事阅读时露出“这是哪种神秘语言”的表情。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bdf01823674d43b7870e7bd654c0afc2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5rih6IuH:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768324769&amp;x-signature=lmf256ICIQBgLOPgFi84w2ZE7RY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">三、认真搞两三个开源项目</h2>
<p>我的开源项目经历可以分为几个阶段：</p>
<ul>
<li>雄心勃勃地创建仓库</li>
<li>热情满满地写两周</li>
<li>逐渐忘记它的存在，直到某天突然想起：“这个库还维护吗？”</li>
</ul>
<p>今年我调整了预期：不做星标收割机，只做自己觉得有意义的、实用的开源项目。</p>
<p>目前已在计划中的项目：<code>做一个Spring开发者真正能“开箱即用”的架构洞察工具，不求大而全，只求快又准。</code></p>
<p>当然，如果能坚持维护超过六个月，那简直值得开瓶庆祝了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43b0ef131cb14e068100e29e40644f78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5rih6IuH:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768324769&amp;x-signature=P%2BJfCA7W7phBb9K1nDWvTfw4Irg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">四、当个更靠谱的爸爸</h2>
<p>在所有架构中，最复杂的莫过于家庭系统。特别是当你试图用面向对象的思想解释小学数学题时，孩子眼中的困惑说明了一切。</p>
<p>技术文档可以反复修改，但孩子的成长只有一次版本迭代。</p>
<p>所以我今年的重要KPI是：少说“等爸爸忙完”，多说“走，我们出去玩儿”。</p>
<p>毕竟，最好的架构不是微服务拆分得多完美，而是生活里那些重要的连接始终保持低延迟。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9be7ae4091b84dd184337f95be96655e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5rih6IuH:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768324769&amp;x-signature=%2F%2BNoVs82uTM52inB9ODa54XPbZQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">五、给吉他弦一点起码的尊重，比如学会《富士山下》</h2>
<p>当我有学吉他的想法的那一刻就已经想象自己在夕阳下深情弹唱，现实是它大多数时间安静地靠在墙角，琴弦上落的灰比我的代码注释还厚。</p>
<p>不过我发现，调试分布式系统和练习和弦转换有个共同点：都需要耐心，都会遇到瓶颈，而且结果往往比你预期的要晚来很多。</p>
<p>我偷偷收藏了一堆指弹视频，看着大师们的手指在琴弦上跳舞，仿佛吉他自己有灵魂。而我目前的水平，只能说站在门口了。</p>
<p>但音乐的美好大概就在于此，它允许你从“制造噪音”开始，慢慢走向“制造旋律”。说不定到了年底，我能在家庭聚会上完整弹出一首《生日快乐》指弹版，那将是堪比完成一次重大系统重构的成就感。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8291872522764e079bad6caae86f3746~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5rih6IuH:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768324769&amp;x-signature=ogzl%2ByZqP0QKMjZ4LV4vbuw4lZk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">六、小结</h2>
<p>说到底，年度计划就像软件架构——不可能一开始就完美，重要的是持续迭代。年底复盘时，如果这些目标只实现了一半，我可能会安慰自己：至少比去年进步了20%，这在敏捷开发里已经算一个成功的冲刺了。</p>
<p>无论如何，2026年，我会继续在代码和生活的平衡木上摇晃前行，偶尔掉下来，再爬上去。毕竟，就像我们从不放弃修复bug一样，我们也不会放弃成为更好的自己——尽管过程可能比调试生产环境的问题还要曲折一些。</p>
<p>祝我们都能在2026年写出更优雅的代码——</p>
<p>和更可爱的生活。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[个人 LLM 接口服务项目：一个简洁的 AI 入口]]></title>    <link>https://juejin.cn/post/7592069432228151305</link>    <guid>https://juejin.cn/post/7592069432228151305</guid>    <pubDate>2026-01-06T15:10:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592069432228151305" data-draft-id="7592062873829982258" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="个人 LLM 接口服务项目：一个简洁的 AI 入口"/> <meta itemprop="keywords" content="人工智能,Python,LLM"/> <meta itemprop="datePublished" content="2026-01-06T15:10:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mantch"/> <meta itemprop="url" content="https://juejin.cn/user/2788017218532232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            个人 LLM 接口服务项目：一个简洁的 AI 入口
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2788017218532232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mantch
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T15:10:48.000Z" title="Tue Jan 06 2026 15:10:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/139da621aa1a40518b10a7fb37883b5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWFudGNo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768317048&amp;x-signature=MTlYFdQ4VjPEwNfo9DN06wQkMbg%3D" alt="" loading="lazy"/></p>
<p>在 AI 应用爆发的今天，我们经常需要同时使用多个大模型服务——有的平台优惠力度大，有的模型在某些任务上表现更好，还有的提供商网络访问更稳定。但为每一个服务单独配置 API、管理密钥、对接客户端，无疑增加了使用门槛和运维成本。</p>
<p>今天要介绍的开源项目 <strong>Personal LLM API</strong>，正是为了解决这一问题而生。它是一个专为个人用户设计的轻量级 LLM 接口聚合服务，让你能够通过一个统一的入口，灵活调度和管理来自不同提供商的 AI 模型。</p>
<h2 data-id="heading-0">🎯 项目简介</h2>
<p>Personal LLM API 基于 Python 和 FastAPI 构建，提供了与 OpenAI API 完全兼容的接口规范。与同类项目相比，它更加注重<strong>个人使用的简洁性</strong>和<strong>极致的交互体验</strong>，尤其在与高颜值客户端（如 Cherry Studio）搭配时，能实现丝滑的“打字机”流式输出效果。</p>
<p>GitHub 项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FNLP-LOVE%2Fpersonal-llm-api" target="_blank" rel="noopener" title="https://github.com/NLP-LOVE/personal-llm-api" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FNLP-LOVE%2Fpersonal-llm-api" target="_blank" title="https://github.com/NLP-LOVE/personal-llm-api" ref="nofollow noopener noreferrer">github.com/NLP-LOVE/pe…</a></p>
<h3 data-id="heading-1">核心亮点</h3>
<ul>
<li><strong>🧩 多模型统一管理</strong>：支持火山云、阿里云、硅基流动、OpenRouter 等主流平台，轻松实现模型的切换与负载均衡。</li>
<li><strong>⚡ 深度优化流式输出</strong>：针对流式响应做了特别优化，完美适配 Cherry Studio 等客户端的主题与字体设计，带来沉浸式对话体验。</li>
<li><strong>🛠️ 低代码管理后台</strong>：基于百度 amis 框架构建的可视化管理界面，无需前端知识即可轻松配置模型、查看统计、管理对话历史。</li>
<li><strong>🐍 全栈 Python</strong>：从后端到管理界面，技术栈统一，易于理解和二次开发。</li>
<li><strong>🚀 开箱即用</strong>：资源占用低，部署简单，特别适合运行在个人服务器或 VPS 上。</li>
</ul>
<h2 data-id="heading-2">🚀 核心功能一览</h2>
<ul>
<li>✅ 完整的 OpenAI API 兼容（<code>/v1/chat/completions</code> 和 <code>/chat/completions</code>）</li>
<li>✅ 支持 Function Calling 与 Web Search（联网搜索）</li>
<li>✅ 火山云 <code>response</code> 接口转标准 <code>chat</code> 接口，便于客户端接入</li>
<li>✅ 多模型间自动轮询负载均衡</li>
<li>✅ 完整的使用量统计与可视化</li>
<li>✅ 支持 SQLite / MySQL 数据库</li>
<li>✅ 可配置代理访问，方便网络环境适配</li>
</ul>
<h2 data-id="heading-3">🏗️ 技术架构</h2>
<ul>
<li><strong>后端框架</strong>：FastAPI（高性能异步 API 服务）</li>
<li><strong>前端管理</strong>：amis 低代码框架 + TailwindCSS</li>
<li><strong>数据库</strong>：SQLite（默认）或 MySQL</li>
<li><strong>部署</strong>：纯 Python 环境，依赖清晰</li>
</ul>
<h2 data-id="heading-4">📦 快速部署</h2>
<p>部署仅需几步：</p>
<ol>
<li>确保 Python 版本 ≥ 3.9</li>
<li>安装依赖：<code>pip install -r requirements.txt</code></li>
<li>修改 <code>app_config.yaml</code> 配置文件（设置数据库、代理等）</li>
<li>运行主程序：<code>python3 main_personal_llm.py</code></li>
<li>访问后台管理界面：<code>http://127.0.0.1:2321/dashboard</code>，并配置模型后即可使用<code>/chat/completions</code>接口
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/535b16d21e08444e99835b7a88a266bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWFudGNo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768317048&amp;x-signature=jUwPx6PoKXjZmPIdMHuQHwkWGbU%3D" alt="" loading="lazy"/></li>
</ol>
<h2 data-id="heading-5">🍓 与 Cherry Studio 完美搭配</h2>
<p>该项目特别优化了与 Cherry Studio 客户端的兼容性。你只需在 Personal LLM API 后台配置好模型密钥，然后在 Cherry Studio 中添加一个自定义 OpenAI 兼容接口，即可享受：</p>
<ul>
<li>无缝的流式对话体验</li>
<li>支持深度思考（Chain of Thought）参数控制</li>
<li>统一的界面主题与字体渲染</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1479e69f19264ee992c1161994fcf19a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWFudGNo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768317048&amp;x-signature=W28vR3TZyAVWrGYoOJTOjjHmFOA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">📊 后台管理演示</h2>
<p>项目提供了完整的管理功能，包括：</p>
<ul>
<li><strong>使用统计</strong>：直观查看各模型调用次数、Token 消耗、费用估算</li>
<li><strong>模型与密钥管理</strong>：灵活添加、禁用、轮询多个 API Key</li>
<li><strong>对话历史</strong>：保存和检索过往对话记录</li>
<li><strong>系统配置</strong>：代理设置、数据库切换等</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/180205b301724081a057b8a50cf22c5a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWFudGNo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768317048&amp;x-signature=S39gkmDcTl0uMHb2xNmCGjeiFUw%3D" alt="" loading="lazy"/></p>
<p>体验 Demo：🔗 <a href="https://link.juejin.cn?target=http%3A%2F%2Fllmdashboard.demo.dx3906.info%2Fdashboard%2Flogin" target="_blank" rel="noopener" title="http://llmdashboard.demo.dx3906.info/dashboard/login" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=http%3A%2F%2Fllmdashboard.demo.dx3906.info%2Fdashboard%2Flogin" target="_blank" title="http://llmdashboard.demo.dx3906.info/dashboard/login" ref="nofollow noopener noreferrer">llmdashboard.demo.dx3906.info/dashboard/l…</a>
（账号：<code>test</code>，密码：<code>12345678</code>）</p>
<h2 data-id="heading-7">🔮 未来规划</h2>
<p>项目作者还计划加入更多实用功能：</p>
<ul>
<li>RAG（检索增强生成）应用与接口支持</li>
<li>基于 SeekDB 的 AI 原生数据库集成</li>
<li>Prompt 模板管理</li>
</ul>
<h2 data-id="heading-8">结语</h2>
<p>无论你是 AI 爱好者、开发者，还是经常需要切换使用不同大模型的个人用户，Personal LLM API 都能为你提供一个<strong>干净、统一、可控</strong>的 AI 入口。它用简洁的技术栈解决了多模型管理的痛点，让每个人都能轻松拥有属于自己的智能助手调度中心。</p>
<hr/>
<p><strong>项目地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FNLP-LOVE%2FPersonal-LLM-API" target="_blank" rel="noopener" title="https://github.com/NLP-LOVE/Personal-LLM-API" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FNLP-LOVE%2FPersonal-LLM-API" target="_blank" title="https://github.com/NLP-LOVE/Personal-LLM-API" ref="nofollow noopener noreferrer">github.com/NLP-LOVE/Pe…</a></p>
<p>如果你正在寻找一个轻量、易扩展、且对个人用户友好的 LLM 接口聚合方案，不妨试试这个项目，或许它能成为你 AI 工作流中那个“恰到好处”的枢纽。</p>
<p><strong>微信公众号：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b84b7e10c6c5427d8956f7adc508ee70~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWFudGNo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768317048&amp;x-signature=15H5D9PXoVN3Z7IqlPfFUHmLVcg%3D" alt="httpera.dx3906.infostaticwechat.html.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[多模态大模型有哪些模态？]]></title>    <link>https://juejin.cn/post/7592082090207526939</link>    <guid>https://juejin.cn/post/7592082090207526939</guid>    <pubDate>2026-01-06T15:50:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592082090207526939" data-draft-id="7592058763987124270" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="多模态大模型有哪些模态？"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2026-01-06T15:50:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="智泊AI"/> <meta itemprop="url" content="https://juejin.cn/user/3572727470361578"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            多模态大模型有哪些模态？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3572727470361578/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    智泊AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T15:50:24.000Z" title="Tue Jan 06 2026 15:50:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>“多模态”中的“模态”（modality），即指各类数据形式或信息来源。在多模态大模型中，典型模态涵盖以下类别：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81dd8e78a62b4220b0a9dd14077baa15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768319423&amp;x-signature=cFpatLJYkAH%2FJ%2FHWH4fdPnedDsw%3D" alt="图片" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer"><strong>更多AI大模型学习视频及资源，都在智泊AI。</strong></a></p>
<p><strong>文本模态‌</strong>：</p>
<p>涵盖自然语言文本、经语音识别转换的文本内容等。</p>
<p><strong>图像模态‌</strong>：</p>
<p>指视觉图像数据，例如照片、插画、艺术作品等。</p>
<p><strong>视频模态‌</strong>：</p>
<p>包含动态影像序列，如短视频、影视片段、监控录像等。</p>
<p><strong>音频模态‌</strong>：</p>
<p>指声学信号数据，如人声、音乐、环境音效等。</p>
<p><strong>其他模态‌</strong>：</p>
<p>还包括如环境传感器读数、生理信号、指纹、虹膜等非传统信息形式。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53e9d8bc943e419d897a64e7ad648c35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768319423&amp;x-signature=Dl60lZDlwJWBvnNfYdkn6AOwSyc%3D" alt="图片" loading="lazy"/></p>
<p>多模态模型的核心目标，在于融合上述异构模态的信息，以增强模型对输入数据的语义理解、任务执行与预测能力。</p>
<p>通过协同利用多源信息，模型得以构建更立体、更精准的认知框架。整合多元模态数据，使系统能够实现更丰富、更灵活的信息解析，从而为复杂智能任务提供坚实支撑。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d08d8034132e49409b65460d46e436b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768319423&amp;x-signature=0fDG0NQghUfWDuH1DW7Mu2AI3GM%3D" alt="图片" loading="lazy"/></p>
<p>多模态大模型具备以下核心特征：</p>
<p><strong>处理多种数据类型‌</strong>：可同步接收并处理文本、图像、视频、音频等多种输入，实现跨模态语义对齐与联合表征。</p>
<p><strong>综合不同信息源‌</strong>：有效整合来自不同感知通道的数据，提升整体信息处理的完整性与准确性。</p>
<p><strong>提升模型性能‌</strong>：借助多模态互补性，增强模型的泛化性与鲁棒性，拓展其在多样化任务中的适用边界。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11127f23e1764186a2616375a823450e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768319423&amp;x-signature=UcvZc3sBs8rdShFurnItytKOMDo%3D" alt="图片" loading="lazy"/></p>
<p><strong>丰富的应用场景‌</strong>：广泛应用于图像字幕生成、视频内容分析、多模态人机交互、跨模态语义推理等前沿领域。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer"><strong>更多AI大模型学习视频及资源，都在智泊AI。</strong></a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GDAL 实现数据属性查询]]></title>    <link>https://juejin.cn/post/7591969856578699314</link>    <guid>https://juejin.cn/post/7591969856578699314</guid>    <pubDate>2026-01-06T13:49:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591969856578699314" data-draft-id="7592058763986976814" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GDAL 实现数据属性查询"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-06T13:49:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GIS之路"/> <meta itemprop="url" content="https://juejin.cn/user/4346787284915481"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GDAL 实现数据属性查询
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4346787284915481/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GIS之路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T13:49:40.000Z" title="Tue Jan 06 2026 13:49:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">^ 关注我，带你一起学GIS ^</h2>
<h2 data-id="heading-1">前言</h2>
<blockquote>
<p>❝</p>
<p>在GIS开发中，属性查询是非常普遍的操作，这是每一个GISer都要掌握的必备技能。实现高效的数据查询功能可以提升用户体验，提升数据可视化效率。</p>
</blockquote>
<p>在之前的文章中讲了如何使用<code>GDAL</code>或者<code>ogr2ogr</code>工具将<code>txt</code>以及<code>csv</code>文本数据转换为<code>Shp</code>格式，本篇教程在之前一系列文章的基础上讲解如何使用<code>GDAL</code>实现空间数据属性查询功能。</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwOTEzNjI5NQ%3D%3D%26mid%3D2247487980%26idx%3D1%26sn%3Dbfd72c505f12f36cc459989cb16229db%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwOTEzNjI5NQ==&amp;mid=2247487980&amp;idx=1&amp;sn=bfd72c505f12f36cc459989cb16229db&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">GDAL 简介</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwOTEzNjI5NQ%3D%3D%26mid%3D2247488004%26idx%3D1%26sn%3D3cab0afab44ff1c9d2e583933d6b4c3e%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwOTEzNjI5NQ==&amp;mid=2247488004&amp;idx=1&amp;sn=3cab0afab44ff1c9d2e583933d6b4c3e&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">GDAL 下载安装</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwOTEzNjI5NQ%3D%3D%26mid%3D2247488017%26idx%3D1%26sn%3De41670cf4042e17353ad7ee507423269%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwOTEzNjI5NQ==&amp;mid=2247488017&amp;idx=1&amp;sn=e41670cf4042e17353ad7ee507423269&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">GDAL 开发起步</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwOTEzNjI5NQ%3D%3D%26mid%3D2247488343%26idx%3D1%26sn%3D39a39704cd83d5b4a955cef28c1df5ba%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwOTEzNjI5NQ==&amp;mid=2247488343&amp;idx=1&amp;sn=39a39704cd83d5b4a955cef28c1df5ba&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">GDAL 实现 GIS 数据读取转换（全）</a></li>
</ul>
<p>如果你还没有看过，建议从以上内容开始。</p>
<h2 data-id="heading-2">1. 开发环境</h2>
<p>本文使用如下开发环境，以供参考。</p>
<p>时间：<code>2025年</code></p>
<p>系统：<code>Windows 11</code></p>
<p>Python：<code>3.11.7</code></p>
<p>GDAL：<code>3.11.1</code></p>
<h2 data-id="heading-3">2. 属性查询</h2>
<p>定义一个方法<code>AttributeFilter</code>用于实现空间数据属性查询，该方法接受一个<code>shpPath</code>路径参数。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""说明：图层属性过滤参数：    -shpPath：Shp 文件路径"""</span><span class="hljs-keyword">def</span> <span class="hljs-title function_">AttributeFilter</span>(<span class="hljs-params">shpPath</span>):
</code></pre>
<p>还是老规矩，第一步添加<code>Shp</code>数据驱动。</p>
<pre><code class="hljs language-scss" lang="scss"># 注册所有驱动ogr<span class="hljs-selector-class">.RegisterAll</span>()# 添加数据驱动shpDriver = ogr<span class="hljs-selector-class">.GetDriverByName</span>("ESRI Shapefile")
</code></pre>
<p>打开数据源，进行属性过滤。图层对象有个方法<code>SetAttributeFilter</code>可以进行简单的属性查询，只需传入字段名以及字段值，查询结束后将查询条件设置为<code>None</code>退出查询。</p>
<p>使用此种方式是直接在<strong>源数据图层</strong>上进行操作。</p>
<pre><code class="hljs language-scss" lang="scss">with shpDriver<span class="hljs-selector-class">.Open</span>(shpPath) as ds:    if ds is None:        <span class="hljs-built_in">print</span>(<span class="hljs-string">"数据源打开异常，请检查路径！"</span>)        return False    # 获取图层    layer = ds.<span class="hljs-built_in">GetLayer</span>(<span class="hljs-number">0</span>) # Shp图层默认值为<span class="hljs-number">0</span>    # 获取要素数量    featureCount = layer.<span class="hljs-built_in">GetFeatureCount</span>()    <span class="hljs-built_in">print</span>(f<span class="hljs-string">"所有要素数量：{featureCount}"</span>)    # <span class="hljs-string">"学校"</span>要素数量    layer.<span class="hljs-built_in">SetAttributeFilter</span>(<span class="hljs-string">"type='学校'"</span>)    featureCount1 = layer.<span class="hljs-built_in">GetFeatureCount</span>()    <span class="hljs-built_in">print</span>(f<span class="hljs-string">"'学校'要素数量：{featureCount1}"</span>)    layer.<span class="hljs-built_in">SetAttributeFilter</span>(None)    featureCount2 = layer.<span class="hljs-built_in">GetFeatureCount</span>()    <span class="hljs-built_in">print</span>(f<span class="hljs-string">"退出查询后要素数量：{featureCount2}"</span>) 
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c811450657648c08d837e7ccff3e3ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768312180&amp;x-signature=foz2wHoBPjspKwVysN7TTIKy0Hw%3D" alt="" loading="lazy"/></p>
<p>属性表中总共有45条记录，查询记录与其保持一致。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10889499529546faaca2f1c0fd1ccdde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768312180&amp;x-signature=gG6in2tBLfS3cOwYALiZV%2FVEUEQ%3D" alt="" loading="lazy"/></p>
<p>除了上面介绍的<code>SetAttributeFilter</code>方法外，还有另外一种方式，就是SQL语句查询。数据源对象具有一个方法<code>ExecuteSQL</code>用于查询指定数据，大多情况下只需要传入一条SQL语句即可。查询结束之后调用<code>ReleaseResultSet</code>方法退出查询。</p>
<p>使用此种方式将会返回一个满足查询条件的<strong>新图层</strong>。</p>
<pre><code class="hljs language-scss" lang="scss"># 复杂查询# queryLayer = ds<span class="hljs-selector-class">.ExecuteSQL</span>("SELECT * FROM geoPoint WHERE TYPE='饭店'")# 升序# queryLayer = ds<span class="hljs-selector-class">.ExecuteSQL</span>("SELECT * FROM geoPoint WHERE TYPE='饭店' ORDER BY Id ASC")# 降序queryLayer = ds<span class="hljs-selector-class">.ExecuteSQL</span>("SELECT * FROM geoPoint WHERE TYPE='饭店' ORDER BY Id DESC")queryFeatCount = queryLayer<span class="hljs-selector-class">.GetFeatureCount</span>()<span class="hljs-built_in">print</span>(f"nSQL查询要素数量：{queryFeatCount}n")for feature in queryLayer:    # 获取字段    field = feature.<span class="hljs-built_in">GetField</span>(<span class="hljs-string">"id"</span>)    # <span class="hljs-built_in">print</span>(f<span class="hljs-string">"要素Id：{field}"</span>)    fieldValue = feature.<span class="hljs-built_in">GetField</span>(<span class="hljs-string">"type"</span>)    for i in <span class="hljs-built_in">range</span>(fieldCount):        fieldDefn = featureDefn.<span class="hljs-built_in">GetFieldDefn</span>(i)        fieldName = fieldDefn.<span class="hljs-built_in">GetName</span>()        fieldType = fieldDefn.<span class="hljs-built_in">GetType</span>()        fieldTypeName = fieldDefn.<span class="hljs-built_in">GetTypeName</span>()        fieldValue = feature.<span class="hljs-built_in">GetField</span>(<span class="hljs-string">"type"</span>)    <span class="hljs-built_in">print</span>(f<span class="hljs-string">"id：{field}，value：{fieldValue}n"</span>)ds.<span class="hljs-built_in">ReleaseResultSet</span>(queryLayer)ds = None
</code></pre>
<p>选择类型为”饭店“的POI点，并以Id字段降序排列。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> geoPoint <span class="hljs-keyword">WHERE</span> TYPE<span class="hljs-operator">=</span><span class="hljs-string">'饭店'</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> Id <span class="hljs-keyword">DESC</span>
</code></pre>
<p>查询结果显示如下：<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f440535fe1254c729612648e9a7d8409~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768312180&amp;x-signature=9QFcatlzFRRKTSXuqOf54%2BHvyHE%3D" alt="" loading="lazy"/>与实际数据显示结果一致。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1087251247124bb69d2a2e834e82e043~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768312180&amp;x-signature=mhsNvZCCAIWKU9j9uoC82h4vMaM%3D" alt="" loading="lazy"/></p>
<p>还可以统计以下每种类型要素的数量。</p>
<pre><code class="hljs language-scss" lang="scss"># 统计每种类型的要素数量finalFeatCount = layer<span class="hljs-selector-class">.GetFeatureCount</span>()<span class="hljs-built_in">print</span>(f"n最终查询要素数量：{finalFeatCount}n")countLayer = ds<span class="hljs-selector-class">.ExecuteSQL</span>("SELECT DISTINCT type FROM geoPoint")newFeature = countLayer<span class="hljs-selector-class">.GetNextFeature</span>()while newFeature:    # countTypeLayer = ds.<span class="hljs-built_in">ExecuteSQL</span>(<span class="hljs-string">"SELECT COUNT(*) FROM geoPoint WHERE type='"</span>+newFeature.<span class="hljs-built_in">GetField</span>(<span class="hljs-string">'type'</span>)+<span class="hljs-string">"'"</span>)    countTypeLayer = ds.<span class="hljs-built_in">ExecuteSQL</span>(<span class="hljs-string">"SELECT COUNT(*) FROM geoPoint WHERE type='"</span>+newFeature.<span class="hljs-built_in">GetField</span>(<span class="hljs-number">0</span>)+<span class="hljs-string">"'"</span>)    <span class="hljs-built_in">print</span>(f<span class="hljs-string">"{newFeature.GetField(0)} {countTypeLayer.GetFeature(0).GetFieldAsString(0)}"</span>)    ds.<span class="hljs-built_in">ReleaseResultSet</span>(countTypeLayer)    newFeature = countLayer.<span class="hljs-built_in">GetNextFeature</span>()ds.<span class="hljs-built_in">ReleaseResultSet</span>(countLayer)
</code></pre>
<p>查询结果显示如下：<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee2c4f64862b4460b10024e87db8ffc1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768312180&amp;x-signature=fUjwaiGiA4bBBzn3Cz0AK6m4OMg%3D" alt="" loading="lazy"/>最后不要忘记关闭数据源。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">ds</span> = None
</code></pre>
<h2 data-id="heading-4">3. 注意事项</h2>
<p>在<code>windows</code>开发环境中同时安装<code>GDAL</code>与<code>PostGIS</code>，其中投影库<code>PROJ</code>的环境变量指向<code>PostGIS</code>的安装路径，在运行GDAL程序时，涉及到要素、几何与投影操作时会导致异常。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1468271531a147efa94bd682fe3cf43c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768312180&amp;x-signature=GT%2Fy5NArbLtNy7v8Q6MsQErZJrU%3D" alt="" loading="lazy"/>具体意思为<code>GDAL</code>不支持<code>PostGIS</code>插件中的投影库版本，需要更换投影库或者升级版本。</p>
<p><code>RuntimeError: PROJ: proj_identify: D:Program FilesPostgreSQL13sharecontribpostgis-3.5projproj.db contains DATABASE.LAYOUT.VERSION.MINOR = 2 whereas a number &gt;= 5 is expected. It comes from another PROJ installation.</code><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1993b4e17c84e9fbf935eff79503946~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768312180&amp;x-signature=Dbx0Lzpc2txJ2tC%2Be9vOruVNvj0%3D" alt="" loading="lazy"/></p>
<p>解决办法为修改<code>PROJ</code>的环境变量到<code>GDAL</code>支持的版本或者在<code>GDAL</code>程序开头添加以下代码：</p>
<pre><code class="hljs language-python" lang="python">os.environ[<span class="hljs-string">'PROJ_LIB'</span>] = <span class="hljs-string">r'D:ProgramsPythonPython311Libsite-packagesosgeodataproj'</span>
</code></pre>
<p><strong>图片效果</strong></p>
<p><strong><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb6249bdc64a4463a0a08fe00141cdd5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768312180&amp;x-signature=3dCTqOnbQqJUddAMqsSiuP1qyhk%3D" alt="" loading="lazy"/></strong></p>
<p><strong><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03c56e29cf1141d1be9c50b3fbf31923~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768312180&amp;x-signature=J34hLUoE7ghcoKcN8I8Gg%2Ff9YC8%3D" alt="" loading="lazy"/></strong></p>
<blockquote>
<p>❝</p>
<p>OpenLayers示例数据下载，请在公众号后台回复：<strong>ol数据</strong></p>
<p>全国信息化工程师－GIS 应用水平考试资料，请在公众号后台回复：<strong>GIS考试</strong></p>
</blockquote>
<blockquote>
<p>❝</p>
<p><em><strong>GIS之路</strong></em> 公众号已经接入了<strong>智能</strong> <strong>助手</strong>，可以在对话框进行提问，也可以直接搜索历史文章进行查看。</p>
</blockquote>
<p>都看到这了，不要忘记<em><strong>点赞、收藏</strong></em> <strong>+</strong> <em><strong>关注</strong></em> 哦 <strong>！</strong></p>
<p>本号不定时更新有关 <em><strong>GIS开发</strong></em> 相关内容，<em><strong>欢迎关注 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d35dd1511183425cbdda9e57eb54b05d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768312180&amp;x-signature=CLaPgqNOVtHLgjmr5VzoC8Mpe0s%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/007cd40da56e468ebce954372c6dd24a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768312180&amp;x-signature=3EZag50K6dQkkxnKe60kUaskzfU%3D" alt="" loading="lazy"/></strong></em></p>
<hr/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8f2fb936726464b813ef62b47bb147a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768312180&amp;x-signature=QAvFnb%2BTR1%2FhMZYnwXf6NkKQWgw%3D" alt="" loading="lazy"/></p>
<p>   <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a8d57bb6fe84f049edf7c3c6a87abbe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768312180&amp;x-signature=pro9KdKOag6mby5Bejh8OMGByQo%3D" alt="" loading="lazy"/> </p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwOTEzNjI5NQ%3D%3D%26mid%3D2247487953%26idx%3D1%26sn%3D0b2d5aeefdb290583cf8cdd82f3c2077%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwOTEzNjI5NQ==&amp;mid=2247487953&amp;idx=1&amp;sn=0b2d5aeefdb290583cf8cdd82f3c2077&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">GeoTools 开发合集（全）</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwOTEzNjI5NQ%3D%3D%26mid%3D2247487119%26idx%3D1%26sn%3Dc313efa84c27bf933ef2f2a47991ef2d%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwOTEzNjI5NQ==&amp;mid=2247487119&amp;idx=1&amp;sn=c313efa84c27bf933ef2f2a47991ef2d&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">OpenLayers 开发合集</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwOTEzNjI5NQ%3D%3D%26mid%3D2247488456%26idx%3D1%26sn%3D7e373eb478a41866caaabbb9f0caff52%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwOTEzNjI5NQ==&amp;mid=2247488456&amp;idx=1&amp;sn=7e373eb478a41866caaabbb9f0caff52&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">GDAL 实现创建几何对象</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwOTEzNjI5NQ%3D%3D%26mid%3D2247488427%26idx%3D1%26sn%3D260287bcab5e7789f42d5393d01d52a0%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwOTEzNjI5NQ==&amp;mid=2247488427&amp;idx=1&amp;sn=260287bcab5e7789f42d5393d01d52a0&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">GDAL 实现自定义数据坐标系</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwOTEzNjI5NQ%3D%3D%26mid%3D2247488413%26idx%3D1%26sn%3Dda9c5c919161c30df6836a797f0aeebb%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwOTEzNjI5NQ==&amp;mid=2247488413&amp;idx=1&amp;sn=da9c5c919161c30df6836a797f0aeebb&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">GDAL 实现矢量数据读写</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwOTEzNjI5NQ%3D%3D%26mid%3D2247488366%26idx%3D1%26sn%3D8bef3a39d224de2d6ab9a0ca7dda844e%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwOTEzNjI5NQ==&amp;mid=2247488366&amp;idx=1&amp;sn=8bef3a39d224de2d6ab9a0ca7dda844e&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">GDAL 数据类型大全</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwOTEzNjI5NQ%3D%3D%26mid%3D2247488343%26idx%3D1%26sn%3D39a39704cd83d5b4a955cef28c1df5ba%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwOTEzNjI5NQ==&amp;mid=2247488343&amp;idx=1&amp;sn=39a39704cd83d5b4a955cef28c1df5ba&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">GDAL 实现 GIS 数据读取转换（全）</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[英伟达Rubin炸场：算力暴涨5倍，黄仁勋要让AI推理“白菜价”]]></title>    <link>https://juejin.cn/post/7592119218029756450</link>    <guid>https://juejin.cn/post/7592119218029756450</guid>    <pubDate>2026-01-06T14:14:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592119218029756450" data-draft-id="7592127014187335680" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="英伟达Rubin炸场：算力暴涨5倍，黄仁勋要让AI推理“白菜价”"/> <meta itemprop="keywords" content="AIGC,NVIDIA"/> <meta itemprop="datePublished" content="2026-01-06T14:14:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            英伟达Rubin炸场：算力暴涨5倍，黄仁勋要让AI推理“白菜价”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T14:14:27.000Z" title="Tue Jan 06 2026 14:14:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>2026年的CES注定会被载入科技史册。</p>
<p>并没有像往常那样掏出一张能跑满光追的新游戏显卡，黄仁勋穿着标志性的皮衣，站在拉斯维加斯的聚光灯下，直接把整个数据中心搬上了舞台。这一次，他的手里不再只是拿着一颗芯片，而是一张通往这一代AI终极形态的门票——<strong>Vera Rubin AI计算平台</strong>。</p>
<p>如果说之前的Blackwell是在给AI大模型“输血”，那么Vera Rubin更像是一次彻底的“换心手术”。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2Fasfsdgrdfg-1024x578.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/asfsdgrdfg-1024x578.webp" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/777f457de4fd4295a1d5b657acfb090d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768313668&amp;x-signature=L0ghvVJAJz0q1r6zDaXombgkIwY%3D" alt="asfsdgrdfg" loading="lazy"/></a></p>
<h3 data-id="heading-0">不止是一颗GPU，而是六位一体的“超级大脑”</h3>
<p>很多人习惯盯着显卡看，但这次老黄的野心显然更大。Vera Rubin不是一颗孤独的GPU，它是英伟达为了解决数据传输瓶颈而精心设计的一套“六合一”全栈系统。</p>
<p>想象一下，这不仅是换了更快的引擎，而是连变速箱、底盘、油路全部重构了。这个平台的核心由<strong>6款全新芯片</strong>深度协同：</p>
<ol>
<li><strong>Rubin GPU</strong>：绝对的主角，拥有3360亿晶体管的怪兽，搭载了HBM4超高速显存。</li>
<li><strong>Vera CPU</strong>：不再依赖别人，这是英伟达自研的“心脏”，拥有88个定制Olympus核心。</li>
<li><strong>NVLink 6 Switch</strong>：让芯片间对话速度飙升至3.6 TB/s的交换芯片。</li>
<li>再加上<strong>ConnectX-9网卡</strong>、<strong>BlueField-4 DPU</strong>和<strong>Spectrum-X以太网交换机</strong>。</li>
</ol>
<p>这六大金刚不再是简单的拼凑，而是通过所谓的“极致协同设计（Extreme Codesign）”，将计算、网络和存储熔铸成了一个整体。简单说，英伟达不再卖砖头了，它现在直接卖给你一栋精装修的摩天大楼。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2Fdafgsdgdf-1024x578.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/dafgsdgdf-1024x578.webp" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3a938cf37ff405f981df07d06b42730~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768313668&amp;x-signature=Gc%2BqhSc54tq8QqJL3gVtDdPmGvk%3D" alt="dafgsdgdf" loading="lazy"/></a></p>
<h3 data-id="heading-1">暴力美学：数据碾压Blackwell</h3>
<p>当你觉得Blackwell已经够快时，Rubin用数据告诉你什么叫“降维打击”。</p>
<p>在AI最常用的NVFP4精度下，单颗Rubin GPU的<strong>推理算力达到了惊人的50 PFLOPS</strong>，这是上一代Blackwell的<strong>5倍</strong>。即便是更吃力的训练任务，算力也提升了3.5倍。</p>
<p>更疯狂的是那个被称为“NVL72”的机柜系统——塞进了72颗Rubin GPU和36颗Vera CPU。这一柜子的算力，足以让任何现存的超算汗颜。</p>
<p>但对企业来说，最性感的数字不是算力，而是<strong>成本</strong>。</p>
<p>黄仁勋在现场抛出了一个让所有云厂商眼红的承诺：<strong>成本降低90%</strong>。 利用Rubin平台，处理每100万个Token的推理成本将降至Blackwell时代的十分之一。这意味着，以后不管是ChatGPT还是各种AI助手，它们的“思考”费用将大幅缩水。对于训练那些万亿参数级别的“专家混合模型”（MoE），你只需要以前四分之一的硬件数量就能搞定。</p>
<h3 data-id="heading-2">真正的战略意图：物理AI与推理时代</h3>
<p>为什么英伟达这么急？因为AI变了。</p>
<p>如果说过去几年是AI都在“读万卷书”（训练），那么2026年开始，AI要“行万里路”（推理与应用）。</p>
<p>黄仁勋敏锐地捕捉到了这一点。Rubin平台的很多特性，比如高达22 TB/s的内存带宽和全新的“推理上下文内存存储”，都是为了解决大模型在实际应用中“记性不好”和“反应太慢”的问题。</p>
<p>更重要的是，英伟达开始通过Rubin平台全面进军**“物理AI”**。不管是现场开源的自动驾驶模型Alpamayo，还是机器人模型GR00T，都在暗示一件事：英伟达的算力不仅要在云端生成文字，还要下凡到物理世界，去控制机器人、去驾驶汽车。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2Fdsgdfhfhfg-1024x578.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/dsgdfhfhfg-1024x578.webp" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b91002a278c4bed87bdd01e95f7d1d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768313668&amp;x-signature=Q4qenMYFGKAkNigFcR2409rDBFA%3D" alt="dsgdfhfhfg" loading="lazy"/></a></p>
<h3 data-id="heading-3">尾声：铲子越卖越好</h3>
<p>虽然这次CES上没有看到新的GeForce游戏显卡（毕竟RTX 50系列早在2025年初就已经铺货了），但这恰恰释放了一个最强烈的信号：英伟达的战略重心已经彻底锁死在企业级基础设施上。</p>
<p>目前，Vera Rubin已经进入全面生产阶段，<strong>2026年下半年</strong>，微软、谷歌、亚马逊这些巨头就会收到第一批货。</p>
<p>在这场AI淘金热中，黄仁勋不仅在卖铲子，他现在连挖矿的挖掘机、运输队和精炼厂都给你造好了。至于你是挖金子还是挖石头，那就是你自己的事了。对于我们普通人来说，这或许意味着，那个更加聪明、反应更快且更便宜的AI时代，真的要来了。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2Ffasfsdg-1024x576.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/fasfsdg-1024x576.webp" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/281ebc94e0804ce4bcadf7656a055bce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768313668&amp;x-signature=korFf%2BCyfZMljktvQvPH85xHU3g%3D" alt="fasfsdg" loading="lazy"/></a></p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[怕 AI 乱改代码？教你用 Hooks 给 Claude Code 戴上"紧箍咒"]]></title>    <link>https://juejin.cn/post/7592062873829867570</link>    <guid>https://juejin.cn/post/7592062873829867570</guid>    <pubDate>2026-01-06T14:27:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592062873829867570" data-draft-id="7592082090207379483" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="怕 AI 乱改代码？教你用 Hooks 给 Claude Code 戴上&quot;紧箍咒&quot;"/> <meta itemprop="keywords" content="AIGC,AI编程,Claude"/> <meta itemprop="datePublished" content="2026-01-06T14:27:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            怕 AI 乱改代码？教你用 Hooks 给 Claude Code 戴上"紧箍咒"
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T14:27:00.000Z" title="Tue Jan 06 2026 14:27:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>用 Claude Code 撸代码的时候，经常会遇到这么个场景：AI 也就是刚上手那会儿老实，用久了就开始"放飞自我"：</p>
<ul>
<li>动不动就想执行个 <code>rm -rf</code>，看得人心惊肉跳</li>
<li>改完代码从来不记得跑 lint，格式乱七八八</li>
<li>甚至有时候想知道它到底背着我调了多少次 API，也没个记录</li>
</ul>
<p>其实，这些问题用 Hooks 都能治。</p>
<h2 data-id="heading-0">Hooks 是什么</h2>
<p>说白了，Hooks 就是给 Claude Code 戴的"紧箍咒"。</p>
<p>它允许你在 AI 执行特定操作的前后插入你自己的脚本。这概念跟 Git Hooks（比如 <code>pre-commit</code>）几乎一模一样：在关键节点拦一道，运行个脚本，通过了才放行，不通过就打回。</p>
<p>区别在于，Git Hooks 拦的是代码提交，Claude Hooks 拦的是 AI 的工具调用。</p>
<h2 data-id="heading-1">支持哪些钩子</h2>
<p>目前支持的事件有几个，但常用的就俩：</p>




















<table><thead><tr><th>事件</th><th>什么时候触发</th><th>典型场景</th></tr></thead><tbody><tr><td><code>PreToolUse</code></td><td>工具调用<strong>前</strong></td><td>拦住危险命令、检查参数、权限控制</td></tr><tr><td><code>PostToolUse</code></td><td>工具调用<strong>后</strong></td><td>自动格式化代码、触发测试、更新文档</td></tr></tbody></table>
<p>剩下的 <code>Notification</code>（通知时）、<code>Stop</code>（结束时）用得比较少，一般写插件才用得上。</p>
<h2 data-id="heading-2">怎么配置</h2>
<p>配置这玩意儿有三个地方能放，优先级从高到低：</p>
<ol>
<li><code>.claude/settings.local.json</code>（本地独享，不进 Git，<strong>推荐</strong>）</li>
<li><code>.claude/settings.json</code>（项目共享，进 Git）</li>
<li><code>~/.claude/settings.json</code>（全局配置，所有项目生效）</li>
</ol>
<p>一个最简单的配置长这样：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"hooks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"PreToolUse"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"matcher"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bash"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"hooks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"command"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"python3 scripts/check_cmd.py"</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-3">这里的 matcher 有讲究</h3>
<p><code>matcher</code> 决定了这个钩子管哪些闲事。支持这几种写法：</p>
<ul>
<li><strong>精确匹配</strong>：<code>"Bash"</code> —— 只管 Bash 命令。</li>
<li><strong>多选匹配</strong>：<code>"Bash|Write"</code> —— 管 Bash 和写文件。</li>
<li><strong>通配符</strong>：<code>".*"</code> —— 所有工具全管（慎用，会慢）。</li>
<li><strong>反向匹配</strong>：<code>"^(?!Read).*"</code> —— 除了读文件，其他全管。</li>
</ul>
<p>工具名称一般有：<code>Bash</code>、<code>Read</code>、<code>Write</code>、<code>Edit</code>、<code>Glob</code>、<code>Grep</code>、<code>WebFetch</code> 等。</p>
<h2 data-id="heading-4">核心机制：JSON 协议</h2>
<p>Hooks 的核心就是"一问一答"。</p>
<p>当钩子触发时，Claude Code 会通过 <strong>标准输入 (stdin)</strong> 扔给你一个 JSON：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"session_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"会话ID"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"tool_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bash"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"tool_input"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rm -rf /"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>你的脚本处理完，得通过 <strong>标准输出 (stdout)</strong> 扔回一个 JSON：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"continue"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"decision"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"block"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"reason"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"哥们，删库跑路可不行啊"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-5">返回值说明</h3>
<ul>
<li><code>continue</code>: <code>true</code> 继续，<code>false</code> 停下。</li>
<li><code>decision</code>:
<ul>
<li><code>approve</code>: 允许执行。</li>
<li><code>block</code>: 禁止执行，并报错给 AI。</li>
<li><code>skip</code>: 跳过执行，但不报错（假装执行了）。</li>
</ul>
</li>
<li><code>reason</code>: 给 AI 看的拒绝理由。</li>
</ul>
<h2 data-id="heading-6">实战案例</h2>
<p>光说不练假把式，整几个实用的例子。</p>
<h3 data-id="heading-7">场景一：防删库（拦截危险命令）</h3>
<p>这个最实用。写个 Python 脚本拦截 <code>rm</code> 命令。</p>
<p><strong>脚本</strong> <code>hooks/safe_bash.py</code>:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">#!/usr/bin/env python3</span>
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> json

<span class="hljs-comment"># 读取输入</span>
data = json.loads(sys.stdin.read())

<span class="hljs-keyword">if</span> data.get(<span class="hljs-string">"tool_name"</span>) == <span class="hljs-string">"Bash"</span>:
    cmd = data.get(<span class="hljs-string">"tool_input"</span>, {}).get(<span class="hljs-string">"command"</span>, <span class="hljs-string">""</span>)
    
    <span class="hljs-comment"># 简单的关键词匹配，实际使用可以用正则</span>
    <span class="hljs-keyword">if</span> <span class="hljs-string">"rm -rf"</span> <span class="hljs-keyword">in</span> cmd <span class="hljs-keyword">and</span> <span class="hljs-string">"/"</span> <span class="hljs-keyword">in</span> cmd:
        <span class="hljs-built_in">print</span>(json.dumps({
            <span class="hljs-string">"continue"</span>: <span class="hljs-literal">False</span>,
            <span class="hljs-string">"decision"</span>: <span class="hljs-string">"block"</span>,
            <span class="hljs-string">"reason"</span>: <span class="hljs-string">"危险操作拦截：检测到高风险删除命令，请确认路径安全后再试。"</span>
        }))
        sys.exit(<span class="hljs-number">0</span>)

<span class="hljs-comment"># 默认放行</span>
<span class="hljs-built_in">print</span>(json.dumps({<span class="hljs-string">"continue"</span>: <span class="hljs-literal">True</span>, <span class="hljs-string">"decision"</span>: <span class="hljs-string">"approve"</span>}))
</code></pre>
<p><strong>配置</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"hooks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"PreToolUse"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"matcher"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bash"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"hooks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span> <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"command"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"python3 hooks/safe_bash.py"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-8">场景二：强迫症福音（改完文件自动格式化）</h3>
<p>AI 写代码有时候格式不讲究，咱可以用 <code>PostToolUse</code> 帮它体面一下。</p>
<p><strong>脚本</strong> <code>hooks/auto_fmt.sh</code>:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># 读取 JSON 输入</span>
input=$(<span class="hljs-built_in">cat</span>)
tool=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$input</span>"</span> | jq -r <span class="hljs-string">'.tool_name'</span>)
file=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$input</span>"</span> | jq -r <span class="hljs-string">'.tool_input.file_path // empty'</span>)

<span class="hljs-comment"># 只处理写操作</span>
<span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$tool</span>"</span> == <span class="hljs-string">"Write"</span> || <span class="hljs-string">"<span class="hljs-variable">$tool</span>"</span> == <span class="hljs-string">"Edit"</span> ]]; <span class="hljs-keyword">then</span>
    <span class="hljs-keyword">if</span> [[ -n <span class="hljs-string">"<span class="hljs-variable">$file</span>"</span> &amp;&amp; <span class="hljs-string">"<span class="hljs-variable">$file</span>"</span> == *.ts ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-comment"># 悄悄给它跑个 prettier</span>
        npx prettier --write <span class="hljs-string">"<span class="hljs-variable">$file</span>"</span> &gt;/dev/null 2&gt;&amp;1
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># Post 钩子不需要返回 decision，空对象就行</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">'{}'</span>
</code></pre>
<p><strong>配置</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"hooks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"PostToolUse"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"matcher"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Write|Edit"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"hooks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span> <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"command"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"bash hooks/auto_fmt.sh"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这样 AI 改完 <code>.ts</code> 文件，Prettier 马上就跟进，代码永远整整齐齐。</p>
<h3 data-id="heading-9">场景三：审计日志</h3>
<p>想知道 AI 到底干了啥？把所有操作记下来。</p>
<p><strong>脚本</strong> <code>hooks/logger.py</code>:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">#!/usr/bin/env python3</span>
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> datetime

data = json.loads(sys.stdin.read())
log_entry = {
    <span class="hljs-string">"time"</span>: datetime.datetime.now().isoformat(),
    <span class="hljs-string">"tool"</span>: data.get(<span class="hljs-string">"tool_name"</span>),
    <span class="hljs-string">"input"</span>: data.get(<span class="hljs-string">"tool_input"</span>)
}

<span class="hljs-comment"># 追加到日志文件</span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">".claude/audit.log"</span>, <span class="hljs-string">"a"</span>) <span class="hljs-keyword">as</span> f:
    f.write(json.dumps(log_entry) + <span class="hljs-string">"\n"</span>)

<span class="hljs-built_in">print</span>(json.dumps({<span class="hljs-string">"continue"</span>: <span class="hljs-literal">True</span>}))
</code></pre>
<h2 data-id="heading-10">避坑指南</h2>
<p>玩 Hooks 有几个坑得注意，掉进去容易摔跟头：</p>
<ol>
<li>
<p><strong>别太慢</strong>
Hooks 是同步执行的。脚本卡 1 秒，AI 就愣 1 秒。复杂逻辑（比如上传日志）最好在脚本里丢给后台进程异步做，别让 AI 等太久。</p>
</li>
<li>
<p><strong>别死循环</strong>
别在 Hooks 里调用会触发 Hooks 的命令……虽然 Claude Code 的 Hooks 主要是拦截 AI 的工具调用，但如果你在脚本里又调了 CLI 可能会套娃。</p>
</li>
<li>
<p><strong>容错要做好</strong>
脚本要是挂了（非 0 退出码），AI 操作也会跟着挂。记得处理好 JSON 解析失败、文件不存在这些边界情况。除非你是故意想阻断操作（退出码 2）。</p>
</li>
<li>
<p><strong>安全第一</strong>
Hooks 权限很大，能读写文件、能联网。网上抄来的脚本，先看懂了再跑，别把后门带进来了。</p>
</li>
<li>
<p><strong>怎么调试</strong>
脚本逻辑不对很难受。可以在返回 JSON 里带上 <code>outputToStderr</code> 字段，把调试信息打印到 stderr，方便排查：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(json.dumps({
    <span class="hljs-string">"continue"</span>: <span class="hljs-literal">True</span>,
    <span class="hljs-string">"outputToStderr"</span>: <span class="hljs-string">f"Debug: current tool is <span class="hljs-subst">{data.get(<span class="hljs-string">'tool_name'</span>)}</span>"</span>
}))
</code></pre>
</li>
</ol>
<h2 data-id="heading-11">这跟 Git Hooks / CI 有啥不一样？</h2>
<p>你可能会问：我有 Git Hooks 还有 CI/CD，为啥还要搞这个？</p>
<p>关键在于<strong>时机</strong>和<strong>粒度</strong>。</p>

























<table><thead><tr><th>方式</th><th>什么时候管</th><th>管什么</th></tr></thead><tbody><tr><td><strong>Git Hooks</strong></td><td>commit / push 时</td><td>代码变更</td></tr><tr><td><strong>CI/CD</strong></td><td>代码推送后</td><td>构建和部署流程</td></tr><tr><td><strong>Claude Hooks</strong></td><td><strong>AI 动手的瞬间</strong></td><td>AI 的每一个操作</td></tr></tbody></table>
<p>Claude Hooks 是<strong>实时</strong>介入的。</p>
<ul>
<li>等 Git Hooks 报错，<code>rm -rf</code> 可能已经执行完了。</li>
<li>等 CI 挂了，错误代码已经进仓库了。</li>
<li>而 Claude Hooks 可以把危险扼杀在摇篮里，或者让 AI 在修改配置前先过一遍你的"家规"。</li>
</ul>
<h2 data-id="heading-12">进阶玩法</h2>
<p>如果你想玩得更花一点：</p>
<h3 data-id="heading-13">1. 配合 MCP Server</h3>
<p>如果你用了 MCP (Model Context Protocol) 扩展 AI 的能力，Hooks 照样能管。<code>matcher</code> 支持 <code>mcp__serverName__toolName</code> 这种格式：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"matcher"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"mcp__myserver__.*"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"hooks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span> <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"command"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"..."</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这样即使是三方扩展的工具，也能被你安排得明明白白。</p>
<h3 data-id="heading-14">2. 动态规则</h3>
<p>硬编码脚本不灵活？让脚本去读外部配置，实现不同项目不同规则。
比如从 <code>.claude/rules.json</code> 读取"禁止修改的文件列表"：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> os

rules_file = <span class="hljs-string">".claude/rules.json"</span>
<span class="hljs-keyword">if</span> os.path.exists(rules_file):
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(rules_file) <span class="hljs-keyword">as</span> f:
        rules = json.load(f)
    protected_files = rules.get(<span class="hljs-string">"protected_files"</span>, [])
    <span class="hljs-comment"># ... 在这里写你的拦截逻辑</span>
</code></pre>
<p>这样你只需要维护 JSON 配置文件，Hook 脚本逻辑可以保持通用。</p>
<h3 data-id="heading-15">3. 团队共享</h3>
<p>把 Hooks 配置和脚本放在项目根目录的 <code>.claude/</code> 下，提交到 Git。
这样团队里每个人用 Claude Code 的时候，都会自动遵守同一套代码规范和安全策略。即使是新来的实习生，AI 也不会在他的机器上乱来。</p>
<h2 data-id="heading-16">总结</h2>
<p>Claude Code Hooks 给了我们一个介入 AI 决策环的机会。</p>
<p>以前我们是"监督者"，看着 AI 跑；有了 Hooks，我们变成了"规则制定者"。把安全红线、代码规范这些死规矩写进 Hooks 里，让 AI 在笼子里跳舞，既用了它的脑子，又防了它的乱子。</p>
<hr/>
<p>如果你觉得这篇文章有帮助，欢迎关注我的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i" target="_blank" title="https://github.com/tt-a1i" ref="nofollow noopener noreferrer">GitHub</a>，下面是我的一些开源项目：
<strong>qwen/gemini/claude - cli 原理学习网站</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcoding-cli-guide" target="_blank" title="https://github.com/tt-a1i/coding-cli-guide" ref="nofollow noopener noreferrer">coding-cli-guide</a>（<a href="https://link.juejin.cn?target=https%3A%2F%2Ftt-a1i.github.io%2Fcoding-cli-guide%2F%3Ftab%3Dstart-here" target="_blank" title="https://tt-a1i.github.io/coding-cli-guide/?tab=start-here" ref="nofollow noopener noreferrer">学习网站</a>）- 学习 qwen-cli 时整理的笔记，40+ 交互式动画演示 AI CLI 内部机制</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08e50020ab1f45428cd22e53af91a555~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lmf5peg6aOO6Zuo5Lmf6Zu-5pm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768315883&amp;x-signature=RwUzcStA1Y7TRWCGsMYMHgywS%2BE%3D" alt="image.png" loading="lazy"/>
<strong>Claude Code Skills</strong>（按需加载，意图自动识别，不浪费 token，<a href="https://juejin.cn/post/7578714735307735066" target="_blank" title="https://juejin.cn/post/7578714735307735066">介绍文章</a>）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcode-review-skill" target="_blank" title="https://github.com/tt-a1i/code-review-skill" ref="nofollow noopener noreferrer">code-review-skill</a> - 代码审查技能，覆盖 React 19、Vue 3、TypeScript、Rust 等约 9000 行规则（<a href="https://juejin.cn/post/7578709098255908902" target="_blank" title="https://juejin.cn/post/7578709098255908902">详细介绍</a>）</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2F5-whys-skill" target="_blank" title="https://github.com/tt-a1i/5-whys-skill" ref="nofollow noopener noreferrer">5-whys-skill</a> - 5 Whys 根因分析，说"找根因"自动激活</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Ffirst-principles-skill" target="_blank" title="https://github.com/tt-a1i/first-principles-skill" ref="nofollow noopener noreferrer">first-principles-skill</a> - 第一性原理思考，适合架构设计和技术选型</li>
</ul>
<p><strong>全栈项目</strong>（适合学习现代技术栈）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fprompt-vault" target="_blank" title="https://github.com/tt-a1i/prompt-vault" ref="nofollow noopener noreferrer">prompt-vault</a> - Prompt 管理器，用的都是最新的技术栈，适合用来学习了解最新的前端全栈开发范式：Next.js 15 + React 19 + tRPC 11 + Supabase 全栈示例，clone 下来配个免费 Supabase 就能跑</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fchat_edit" target="_blank" title="https://github.com/tt-a1i/chat_edit" ref="nofollow noopener noreferrer">chat_edit</a> - 双模式 AI 应用（聊天+富文本编辑），Vue 3.5 + TypeScript + Vite 5 + Quill 2.0 + IndexedDB</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[数据可视化五大黄金原则：让你的图表“会说话”]]></title>    <link>https://juejin.cn/post/7592069113222250515</link>    <guid>https://juejin.cn/post/7592069113222250515</guid>    <pubDate>2026-01-06T14:27:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592069113222250515" data-draft-id="7592059801884590123" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="数据可视化五大黄金原则：让你的图表“会说话”"/> <meta itemprop="keywords" content="Python,数据可视化,数据分析"/> <meta itemprop="datePublished" content="2026-01-06T14:27:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="databook"/> <meta itemprop="url" content="https://juejin.cn/user/3526889035006702"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            数据可视化五大黄金原则：让你的图表“会说话”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3526889035006702/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    databook
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T14:27:58.000Z" title="Tue Jan 06 2026 14:27:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在日常工作中，你是否遇到过这种情况：你辛辛苦苦跑完数据，画了一张图表发给老板或客户，结果对方盯着看了半天，问了一句：“<strong>所以，你想表达什么？</strong>”</p>
<p>这就像讲笑话没人笑一样尴尬。图表的本质不是 <strong>“画图”</strong>，而是 <strong>“沟通”</strong>。</p>
<p>今天，我将分享 5 个提升可视化效果的原则，并用 <code>Python</code> 的 <code>matplotlib</code> 库手把手教你如何实现。</p>
<h2 data-id="heading-0">1. 原则1：展示数据，而非装饰</h2>
<p>想象一下，你在阅读一本小说，但每页都充满了无关的插图，你会感到困惑和分心。</p>
<p><strong>数据可视化</strong>也是如此——读者需要的是数据本身，而不是华丽的装饰。</p>
<p>所以，我们需要展示<strong>最重要</strong>的数据，而不是<strong>尽可能多</strong>的数据。</p>
<p>让我们看看一个常见的错误做法和改进后的做法：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 创建示例数据</span>
np.random.seed(<span class="hljs-number">42</span>)
categories = [<span class="hljs-string">"产品A"</span>, <span class="hljs-string">"产品B"</span>, <span class="hljs-string">"产品C"</span>, <span class="hljs-string">"产品D"</span>, <span class="hljs-string">"产品E"</span>]
sales_bad = np.random.randint(<span class="hljs-number">50</span>, <span class="hljs-number">200</span>, <span class="hljs-number">5</span>)
sales_good = np.random.randint(<span class="hljs-number">50</span>, <span class="hljs-number">200</span>, <span class="hljs-number">5</span>)

<span class="hljs-comment"># 错误做法：过度装饰，数据不突出</span>
fig, (ax1, ax2) = plt.subplots(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">14</span>, <span class="hljs-number">6</span>))

<span class="hljs-comment"># 左侧：过度装饰的图表</span>
ax1.bar(categories, sales_bad, color=[<span class="hljs-string">"red"</span>, <span class="hljs-string">"blue"</span>, <span class="hljs-string">"green"</span>, <span class="hljs-string">"orange"</span>, <span class="hljs-string">"purple"</span>])

<span class="hljs-comment"># 添加不必要的元素</span>
<span class="hljs-comment"># ...</span>

<span class="hljs-comment"># 右侧：简洁聚焦的图表</span>
ax2.bar(categories, sales_good, color=<span class="hljs-string">"steelblue"</span>, alpha=<span class="hljs-number">0.8</span>)
<span class="hljs-comment"># 在柱子上直接标注数值</span>
<span class="hljs-keyword">for</span> i, v <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(sales_good):
    ax2.text(i, v + <span class="hljs-number">5</span>, <span class="hljs-built_in">str</span>(v), ha=<span class="hljs-string">"center"</span>, fontweight=<span class="hljs-string">"bold"</span>)

<span class="hljs-comment"># 突出最高值</span>
<span class="hljs-comment"># ...</span>
<span class="hljs-comment"># 移除不必要的边框</span>
<span class="hljs-comment"># ...</span>

plt.tight_layout()
plt.show()
</code></pre>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66b4e5eec30e4e56b69fd15c61a550d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768314478&amp;x-signature=tBxVGpjYIMzc6eTxGiOT372wsBQ%3D" alt="" loading="lazy"/></p>
<p>在这个示例中，根据原则1，我们<strong>主要改进</strong>了：</p>
<ul>
<li>移除背景水印和过度装饰</li>
<li>直接在柱状图上标注数值，避免视线来回移动</li>
<li>突出显示最重要的数据点（产品C）</li>
<li>简化标题，直接传达核心信息</li>
</ul>
<h2 data-id="heading-1">2. 原则2：减少混乱，保持简洁</h2>
<p>想象一下一个杂乱无章的房间，你想找一本书，却要翻遍各个角落。</p>
<p>混乱的图表也会让读者经历同样的挫折。</p>
<p>所以，每个额外的视觉元素都应该有明确的目的，否则就应该移除。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 创建示例数据</span>
np.random.seed(<span class="hljs-number">123</span>)
months = [
    <span class="hljs-string">"1月"</span>,
    <span class="hljs-comment">#...</span>
    <span class="hljs-string">"12月"</span>,
]
temperature = np.random.normal(<span class="hljs-number">20</span>, <span class="hljs-number">5</span>, <span class="hljs-number">12</span>) + np.sin(np.linspace(<span class="hljs-number">0</span>, <span class="hljs-number">2</span> * np.pi, <span class="hljs-number">12</span>)) * <span class="hljs-number">3</span>
precipitation = (
    np.random.normal(<span class="hljs-number">50</span>, <span class="hljs-number">15</span>, <span class="hljs-number">12</span>) + np.cos(np.linspace(<span class="hljs-number">0</span>, <span class="hljs-number">2</span> * np.pi, <span class="hljs-number">12</span>)) * <span class="hljs-number">20</span>
)

<span class="hljs-comment"># 左侧：混乱的图表</span>
ax1.plot(months, temperature, <span class="hljs-string">"ro-"</span>, linewidth=<span class="hljs-number">2</span>, markersize=<span class="hljs-number">8</span>, label=<span class="hljs-string">"温度"</span>)
<span class="hljs-comment"># ...</span>

<span class="hljs-comment"># 创建第二个y轴（混乱的常见来源）</span>
ax1b = ax1.twinx()
ax1b.plot(months, precipitation, <span class="hljs-string">"bs--"</span>, linewidth=<span class="hljs-number">2</span>, markersize=<span class="hljs-number">8</span>, label=<span class="hljs-string">"降水量"</span>)
<span class="hljs-comment"># ...</span>

<span class="hljs-comment"># 添加网格和过多标签</span>
<span class="hljs-comment"># ...</span>

<span class="hljs-comment"># 右侧：简洁的图表</span>
<span class="hljs-comment"># 分开显示两个指标</span>
ax2a = plt.subplot(grid[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>])
ax2b = plt.subplot(grid[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>])

<span class="hljs-comment"># 温度图表</span>
ax2a.plot(months, temperature, color=<span class="hljs-string">"#E74C3C"</span>, linewidth=<span class="hljs-number">2.5</span>)
ax2a.fill_between(months, temperature.<span class="hljs-built_in">min</span>(), temperature, color=<span class="hljs-string">"#E74C3C"</span>, alpha=<span class="hljs-number">0.1</span>)

<span class="hljs-comment"># 突出显示最高温度</span>
max_temp_idx = np.argmax(temperature)
ax2a.plot(
    months[max_temp_idx], temperature[max_temp_idx], <span class="hljs-string">"o"</span>, color=<span class="hljs-string">"#E74C3C"</span>, markersize=<span class="hljs-number">10</span>
)
<span class="hljs-comment"># ...</span>

<span class="hljs-comment"># 降水量图表</span>
ax2b.bar(months, precipitation, color=<span class="hljs-string">"#3498DB"</span>, alpha=<span class="hljs-number">0.7</span>)
<span class="hljs-comment"># 突出显示最高降水量</span>
max_precip_idx = np.argmax(precipitation)
<span class="hljs-comment"># ...</span>

plt.show()
</code></pre>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9140871af6b84e38bbbaade56a87811e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768314478&amp;x-signature=hpdrtq7n7QDGL3rGRSIFD5x4aZc%3D" alt="" loading="lazy"/></p>
<p>在这个示例中，根据原则2，我们<strong>主要改进</strong>了：</p>
<ul>
<li>将双Y轴图表拆分为两个独立的图表</li>
<li>移除过多的图例和网格线</li>
<li>使用填充和标记突出关键数据点</li>
<li>简化标题，每个图表只表达一个核心信息</li>
</ul>
<h2 data-id="heading-2">3. 原则3：图文结合，引导读者</h2>
<p>好的可视化图表就像一个会讲故事的导游，而文字就是它的讲解词。</p>
<p>文字应该帮助读者理解数据，而不是制造障碍。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 创建示例数据</span>
np.random.seed(<span class="hljs-number">42</span>)
years = np.arange(<span class="hljs-number">2010</span>, <span class="hljs-number">2023</span>)
company_a = np.random.normal(<span class="hljs-number">100</span>, <span class="hljs-number">10</span>, <span class="hljs-number">13</span>) + np.linspace(<span class="hljs-number">0</span>, <span class="hljs-number">50</span>, <span class="hljs-number">13</span>)
company_b = np.random.normal(<span class="hljs-number">100</span>, <span class="hljs-number">10</span>, <span class="hljs-number">13</span>) + np.linspace(<span class="hljs-number">0</span>, <span class="hljs-number">30</span>, <span class="hljs-number">13</span>)

<span class="hljs-comment"># 左侧：缺乏引导的图表</span>
ax1.plot(years, company_a, <span class="hljs-string">"b-"</span>, linewidth=<span class="hljs-number">2</span>, label=<span class="hljs-string">"公司A"</span>)
ax1.plot(years, company_b, <span class="hljs-string">"r-"</span>, linewidth=<span class="hljs-number">2</span>, label=<span class="hljs-string">"公司B"</span>)

<span class="hljs-comment"># 右侧：图文结合的图表</span>
ax2.plot(years, company_a, color=<span class="hljs-string">"#2E86C1"</span>, linewidth=<span class="hljs-number">3</span>, alpha=<span class="hljs-number">0.8</span>)
ax2.plot(years, company_b, color=<span class="hljs-string">"#E74C3C"</span>, linewidth=<span class="hljs-number">3</span>, alpha=<span class="hljs-number">0.8</span>)

<span class="hljs-comment"># 直接标注线条，避免图例</span>
ax2.text(
    <span class="hljs-number">2022.2</span>, company_a[-<span class="hljs-number">1</span>], <span class="hljs-string">"公司A"</span>, color=<span class="hljs-string">"#2E86C1"</span>, fontweight=<span class="hljs-string">"bold"</span>, va=<span class="hljs-string">"center"</span>
)
ax2.text(
    <span class="hljs-number">2022.2</span>, company_b[-<span class="hljs-number">1</span>], <span class="hljs-string">"公司B"</span>, color=<span class="hljs-string">"#E74C3C"</span>, fontweight=<span class="hljs-string">"bold"</span>, va=<span class="hljs-string">"center"</span>
)

<span class="hljs-comment"># 添加标题和副标题</span>
<span class="hljs-comment"># ...</span>

<span class="hljs-comment"># 添加关键事件注释</span>
<span class="hljs-comment"># ...</span>

<span class="hljs-comment"># 突出关键数据点</span>
<span class="hljs-comment"># ...</span>

<span class="hljs-comment"># 简洁的坐标轴</span>
<span class="hljs-comment"># ...</span>

plt.show()
</code></pre>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40bdf81fda4b4f75bd688ead829f0054~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768314478&amp;x-signature=0k9rs0mZ7eFCOv6uMlTj%2BwUw5Qo%3D" alt="" loading="lazy"/></p>
<p>在这个示例中，根据原则3，我们<strong>主要改进</strong>了：</p>
<ul>
<li>直接在线条旁标注，消除图例</li>
<li>使用标题直接传达核心发现</li>
<li>添加注释解释关键事件</li>
<li>使用填充区域突出重要差异</li>
</ul>
<h2 data-id="heading-3">4. 原则4：避免意面图，分解复杂信息</h2>
<p>"意面图"是指线条交错、难以分辨的图表，就像一碗缠在一起的意大利面。</p>
<p>当图表变得过于复杂时，最好的方法是分解它。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 创建示例数据：多个产品多年的销售数据</span>
np.random.seed(<span class="hljs-number">123</span>)
years = np.arange(<span class="hljs-number">2015</span>, <span class="hljs-number">2024</span>)
products = [<span class="hljs-string">'手机'</span>, <span class="hljs-string">'平板'</span>, <span class="hljs-string">'笔记本'</span>, <span class="hljs-string">'智能手表'</span>, <span class="hljs-string">'耳机'</span>]

<span class="hljs-comment"># 生成数据</span>
sales_data = {}
<span class="hljs-keyword">for</span> product <span class="hljs-keyword">in</span> products:
    base = np.random.randint(<span class="hljs-number">30</span>, <span class="hljs-number">80</span>)
    trend = np.linspace(<span class="hljs-number">0</span>, np.random.randint(<span class="hljs-number">20</span>, <span class="hljs-number">60</span>), <span class="hljs-number">9</span>)
    noise = np.random.normal(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">9</span>)
    sales_data[product] = base + trend + noise

<span class="hljs-comment"># 左侧：意面图</span>
colors = plt.cm.Set2(np.linspace(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-built_in">len</span>(products)))
<span class="hljs-keyword">for</span> idx, (product, sales) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(sales_data.items()):
    ax1.plot(years, sales, color=colors[idx], linewidth=<span class="hljs-number">2</span>, marker=<span class="hljs-string">'o'</span>, label=product)

<span class="hljs-comment"># 右侧：分解后的图表 - 使用子图</span>
fig2, axes = plt.subplots(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, figsize=(<span class="hljs-number">15</span>, <span class="hljs-number">8</span>))
axes = axes.flatten()

<span class="hljs-comment"># 绘制每个产品的独立图表</span>
<span class="hljs-keyword">for</span> idx, (product, sales) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(sales_data.items()):
    ax = axes[idx]
    ax.plot(years, sales, color=<span class="hljs-string">'#2980B9'</span>, linewidth=<span class="hljs-number">2.5</span>, marker=<span class="hljs-string">'o'</span>, markersize=<span class="hljs-number">6</span>)

    <span class="hljs-comment"># 填充区域</span>
    ax.fill_between(years, sales.<span class="hljs-built_in">min</span>(), sales, color=<span class="hljs-string">'#2980B9'</span>, alpha=<span class="hljs-number">0.1</span>)

    <span class="hljs-comment"># 设置标题和标签</span>
    <span class="hljs-comment"># ...</span>

    <span class="hljs-comment"># 标记最高点</span>
    max_idx = np.argmax(sales)
    ax.plot(years[max_idx], sales[max_idx], <span class="hljs-string">'o'</span>, color=<span class="hljs-string">'#E74C3C'</span>, markersize=<span class="hljs-number">8</span>)
    <span class="hljs-comment"># ...</span>

    <span class="hljs-comment"># 简化网格</span>
    <span class="hljs-comment"># ...</span>

<span class="hljs-comment"># 隐藏最后一个子图（我们只有5个产品）</span>
axes[-<span class="hljs-number">1</span>].axis(<span class="hljs-string">'off'</span>)

plt.show()
</code></pre>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57736d97b78b49a786486ff9cc599772~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768314478&amp;x-signature=rB4NCwmF59MMlG5zj039l3CGQwk%3D" alt="" loading="lazy"/></p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d49481fb2ccd412980f1e0b7beb6c579~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768314478&amp;x-signature=rQa5EkPLI1miFzP4Rnsw0NZGnY8%3D" alt="" loading="lazy"/></p>
<p>在这个示例中，根据原则4，我们<strong>主要改进</strong>了：</p>
<ul>
<li>将复杂的多线条图表分解为多个简单图表</li>
<li>每个子图聚焦一个产品，避免线条交错</li>
<li>在每个子图中独立标注关键信息</li>
<li>保持一致的视觉风格便于比较</li>
</ul>
<h2 data-id="heading-4">5. 原则5：从灰色开始，有策略地使用颜色</h2>
<p>颜色是可视化中最强大的工具之一，但也是最容易被滥用的。</p>
<p>从灰度开始设计，可以确保你使用的每个颜色都有明确的目的。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 创建示例数据</span>
np.random.seed(<span class="hljs-number">123</span>)
cities = [<span class="hljs-string">"北京"</span>, <span class="hljs-string">"上海"</span>, <span class="hljs-string">"广州"</span>, <span class="hljs-string">"深圳"</span>, <span class="hljs-string">"成都"</span>, <span class="hljs-string">"武汉"</span>, <span class="hljs-string">"西安"</span>, <span class="hljs-string">"杭州"</span>]
months = [
    <span class="hljs-string">"1月"</span>,
    <span class="hljs-comment"># ...</span>
    <span class="hljs-string">"12月"</span>,
]

<span class="hljs-comment"># 生成各城市的月度AQI数据</span>
aqi_data = {}
<span class="hljs-keyword">for</span> city <span class="hljs-keyword">in</span> cities:
    base = np.random.randint(<span class="hljs-number">60</span>, <span class="hljs-number">100</span>)  <span class="hljs-comment"># 基础AQI值</span>
    seasonal = np.sin(np.linspace(<span class="hljs-number">0</span>, <span class="hljs-number">2</span> * np.pi, <span class="hljs-number">12</span>)) * <span class="hljs-number">20</span>  <span class="hljs-comment"># 季节性变化</span>
    noise = np.random.normal(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">12</span>)  <span class="hljs-comment"># 随机噪声</span>
    aqi_data[city] = np.clip(base + seasonal + noise, <span class="hljs-number">30</span>, <span class="hljs-number">180</span>)  <span class="hljs-comment"># 限制在30-180之间</span>

<span class="hljs-comment"># 计算各城市的年平均AQI</span>
avg_aqi = {city: np.mean(values) <span class="hljs-keyword">for</span> city, values <span class="hljs-keyword">in</span> aqi_data.items()}

<span class="hljs-comment"># 创建图表对比</span>
fig = plt.figure(figsize=(<span class="hljs-number">12</span>, <span class="hljs-number">6</span>))

<span class="hljs-comment"># 阶段1：全灰色基础图表</span>
ax1 = plt.subplot(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>)

<span class="hljs-comment"># 全灰色版本</span>
<span class="hljs-keyword">for</span> city <span class="hljs-keyword">in</span> cities:
    ax1.plot(months, aqi_data[city], color=<span class="hljs-string">"#7F8C8D"</span>, linewidth=<span class="hljs-number">1.5</span>, alpha=<span class="hljs-number">0.6</span>)  <span class="hljs-comment"># 灰色</span>
<span class="hljs-comment"># ...</span>

<span class="hljs-comment"># 阶段2：识别关键数据后添加初步颜色</span>
ax2 = plt.subplot(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>)

<span class="hljs-comment"># 找出空气质量最好和最差的城市</span>
sorted_cities = <span class="hljs-built_in">sorted</span>(avg_aqi.items(), key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">1</span>])
best_city = sorted_cities[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]  <span class="hljs-comment"># AQI最低的城市</span>
worst_city = sorted_cities[-<span class="hljs-number">1</span>][<span class="hljs-number">0</span>]  <span class="hljs-comment"># AQI最高的城市</span>
<span class="hljs-comment"># ...</span>

<span class="hljs-comment"># 添加标签</span>
<span class="hljs-comment"># ...</span>

<span class="hljs-comment"># 添加空气质量标准线</span>
<span class="hljs-comment"># ...</span>

plt.show()
</code></pre>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26a9b7916249461bbfde3ef2ae38eb15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768314478&amp;x-signature=%2BUMqO5pYefA3vWQhDXg02ONW2YE%3D" alt="" loading="lazy"/></p>
<p>在这个示例中，根据原则5，我们<strong>主要改进</strong>了：</p>
<ul>
<li>从全灰色开始，确保图表结构清晰</li>
<li>只对关键数据点使用强调色</li>
<li>使用颜色突出最重要的发现</li>
<li>通过细节点缀（如虚线、标记）提供额外上下文</li>
</ul>
<h2 data-id="heading-5">6. 总结</h2>
<p><strong>数据可视化</strong>不仅仅是关于 <code>plt.plot()</code> 的技术，更多的是关于<strong>心理学</strong>和<strong>设计</strong>。</p>
<ol>
<li><strong>展示数据</strong>：把聚光灯打在重点上。</li>
<li><strong>减少混乱</strong>：删掉一切不必要的墨水。</li>
<li><strong>图文结合</strong>：标题就是结论，标注代替图例。</li>
<li><strong>避免意面图</strong>：复杂问题拆解看。</li>
<li><strong>从灰色开始</strong>：克制地使用颜色。</li>
</ol>
<p>希望这些原则能帮你在下一次做图时，画出让人眼前一亮的作品！</p>
<p>文中的代码是一些核心的片段，完整的代码共享在：<a href="https://link.juejin.cn?target=https%3A%2F%2Furl11.ctfile.com%2Ff%2F45455611-8593028016-1f332d%3Fp%3D6872" target="_blank" title="https://url11.ctfile.com/f/45455611-8593028016-1f332d?p=6872" ref="nofollow noopener noreferrer">可视化5个黄金原则.ipynb</a> (访问密码: 6872)</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型常见量化方法简介]]></title>    <link>https://juejin.cn/post/7592079304923447306</link>    <guid>https://juejin.cn/post/7592079304923447306</guid>    <pubDate>2026-01-06T14:31:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592079304923447306" data-draft-id="7592251792629514267" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型常见量化方法简介"/> <meta itemprop="keywords" content="自动驾驶,算法"/> <meta itemprop="datePublished" content="2026-01-06T14:31:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="地平线开发者"/> <meta itemprop="url" content="https://juejin.cn/user/1257497032132567"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型常见量化方法简介
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1257497032132567/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    地平线开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T14:31:01.000Z" title="Tue Jan 06 2026 14:31:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、引言</h2>
<p>随着大型语言模型（LLM）在具身智能等领域的广泛应用，接下来就该思考如何在有限硬件资源下部署这些模型，量化是其中必不可少的步骤。</p>
<p>模型量化（Model Quantization）作为一种有效的模型压缩技术，通过将模型中的浮点数参数转换为低比特宽度的整数表示，显著减少了模型的存储和计算需求，同时尽量保持模型的性能。量化的基础知识相信大家都不会陌生，例如必然要介绍两种量化方式：PTQ/QAT。</p>
<p>QAT 是一种深度融合量化需求与模型训练流程的技术，核心是在模型训练阶段主动嵌入 “伪量化算子”—— 不实际将参数转换为低比特，而是模拟量化过程中的数值截断误差与舍入误差，让模型在学习任务知识的同时，同步适应量化带来的精度损耗。训练中，伪量化算子会实时统计各层输入输出的数据分布（如激活值的极值、权重的方差），动态优化量化参数（如缩放因子、零点），确保量化逻辑与模型参数更新形成配合。这种 “边训练边适配量化” 的特性，能让大语言模型（LLM）在低精度表示（如 4bit、2bit）下，依然保留接近原始浮点模型的性能。</p>
<p>PTQ 是在 LLM 完全训练完成后执行的量化方案，无需修改模型训练流程，仅需使用少量校准数据（通常 100-1000 条代表性样本）统计模型权重与激活值的分布特征，即可确定量化参数并完成低比特转换。其核心优势在于 “轻量高效”：无需重新训练模型，量化过程仅需数分钟至数小时，无需大规模计算资源；同时无需改动 LLM 架构，可直接适配各类推理框架，兼顾易用性与部署效率。不过，PTQ 的精度天花板相对较低，目前在 4bit 及以下量化时易出现明显精度损失，更适合对精度要求不高、追求快速部署的场景。</p>
<p>本文重点不是上述两种量化方式，而是将重点介绍四种主流的大模型量化方法：GPTQ、SmoothQuant、AWQ 和旋转量化，下面来分别看一下。</p>
<h2 data-id="heading-1">二、GPTQ</h2>
<p>GPTQ（Gradient-based Post-training Quantization）是一种后训练量化方法，其核心思想是利用梯度信息来指导量化过程，从而最小化量化带来的性能损失。论文中仅进行权重量化，权重被量化为 int4 类型，激活值为 float16。</p>
<p>GPTQ（GPT Quantization）是一种基于最优量化误差最小化的单轮权重量化方法，其核心创新点在于：</p>
<ul>
<li>顺序压缩算法：按重要性对模型层进行排序，优先量化对输出影响较小的层</li>
<li>误差补偿机制：通过梯度下降优化量化参数，减少精度损失</li>
<li>分组量化策略：将权重矩阵分为小组（Group Size）独立量化，平衡压缩率与精度</li>
</ul>
<p>工作流程图如下：</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=MzY5ZTE5MGMzNjU0MDExODI4NmJjZWExNWM3NGZlZDhfZzFFTUJtOWJxNnBCZUM1a2g0cTMxTTlGeTN1QTBMa1ZfVG9rZW46RUdaQmJjWktLb3R0OFB4eFNET2NYSUgybjJjXzE3Njc3MDk2MjY6MTc2NzcxMzIyNl9WNA" alt="" loading="lazy"/></p>
<p>GPTQ 通过优化量化误差的目标函数，使得量化后的模型输出尽可能接近原始模型的输出。其优化目标可以表示为：</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=OGMyZjEzNmMyNmI0OTA5NTFmMzUxZmY4ZGM1NmExOGNfZnBlT1NkMnZMS3ZoSkVhNWZ2akVJSk15UGlud2NnVlJfVG9rZW46UUJQdmJ0aTlDbzNQcDh4U2d3WmNzNHFybkRjXzE3Njc3MDk2MjY6MTc2NzcxMzIyNl9WNA" alt="" loading="lazy"/></p>
<p>其中，f（⋅） 为模型的前向传播函数，W 为原始浮点权重，Wq 为量化后的权重。</p>
<p>GPTQ 已被广泛应用于 HuggingFace 等平台，具有完善的工具链和生态支持。但 GPTQ 主要针对模型的权重进行量化，对激活值的处理相对有限，且在量化过程中需要计算梯度信息，会增加额外的计算开销。</p>
<h2 data-id="heading-2">三、SmoothQuant</h2>
<p>SmoothQuant 是一种训练后量化方法，旨在解决激活值量化困难的问题。核心理念在于平衡激活值和权重的量化难度。在大模型量化中，激活值通常包含大量离群点，这些离群点会显著拉伸量化范围，增加量化误差。SmoothQuant 提出了一种基于平滑因子的逐通道缩放变换方法，对每个通道的激活值进行缩放以平滑其分布，同时对权重施加反向缩放，确保模型计算的等价性。</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=NWYwMmEzNjU5NDg5ZmNhODVmMTlkY2I3YTk5MjE0MjVfOVFXUFhOc0xld0FleXdwWjFtbnpRbFczaFJBdlhnZUFfVG9rZW46VDdsTGIxSW9ybzZ6YnF4STFrRmNXYTdzbnZlXzE3Njc3MDk2MjY6MTc2NzcxMzIyNl9WNA" alt="" loading="lazy"/></p>
<p>其中，s 为平滑因子，x 为激活值，W 为权重，x′ 和 W′ 分别为经过平滑处理后的激活值和权重。通过这种方式，SmoothQuant 将激活值的量化难度转移到权重上，从而实现更高效的量化。</p>
<p>SmoothQuant 可以同时对权重和激活值进行 8 位量化，减少模型的存储需求，通过将激活值的异常值减少，SmoothQuant 可以提高推理的效率，但平滑因子 s 的选择对量化效果有较大影响，且不同的模型可能需要不同的平滑因子，需要通过实验进行调优。</p>
<h2 data-id="heading-3">四、AWQ</h2>
<p>AWQ（Activation-aware Weight Quantization）是一种自适应权重量化方法，旨在根据激活值的重要性来指导权重的量化过程。其核心思想是识别出对模型输出影响较大的激活值，并根据这些激活值的重要性来调整权重的量化精度。具体而言，AWQ 通过计算激活值的方差来评估其重要性，然后根据重要性为权重分配不同的量化精度：</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=MDc1MmFhMDFiYmViZDNlZTFhYWVmNzRkZjllZWQwNGRfQUJER3ZwTHdOVkRRVHJaNkswYnRGajFteGtScVVlT0VfVG9rZW46SDVpSmJCejRGbzVLSEl4TmNHT2NaMUVRbjBkXzE3Njc3MDk2MjY6MTc2NzcxMzIyNl9WNA" alt="" loading="lazy"/></p>
<p>其中，</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>α</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\alpha_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></div>
<p>为第 i 个权重的激活感知度，$$b_i$$ 为其对应的量化比特数。</p>
<p>AWQ 方法源于"权重对于 LLM 的性能并不同等重要"的观察，存在约（0.1%-1%）显著权重对大模型性能影响太大，通过跳过这 1% 的重要权重不进行量化，可以大大减少量化误差。根据激活值的重要性动态调整权重的量化精度，这需要计算激活值的方差，实现相对复杂。</p>
<h2 data-id="heading-4">五、SpinQuant</h2>
<p>旋转量化（SpinQuant）是一种通过旋转矩阵变换数据空间来实现量化的方法。其核心思想是通过引入旋转矩阵 RRR 将数据映射到新的空间，然后在新的空间中进行量化，从而使得量化误差在数据空间中更加均匀地分布，减少量化误差对模型性能的影响。具体而言，旋转量化的过程可以表示为：</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=NzlkYzYzMmQ5N2E1ZGQ5NGVjMGIyMmNlMDA2NTViZTJfQjBwYWtHTGRqNElQbEV0VU13Z2ZWWDdlcHZaUG16STVfVG9rZW46QUVST2JDRGM2b0x5bVZ4N2VIMGNraDhzbjRkXzE3Njc3MDk2MjY6MTc2NzcxMzIyNl9WNA" alt="" loading="lazy"/></p>
<p>其中，w 为原始权重，w′ 为经过旋转变换后的权重，$$w'_q$$ 为量化后的权重，$$w_q$$ 为最终的量化权重。</p>
<p>通过旋转变换数据空间，可以使得量化误差在数据空间中更加均匀地分布，适应不同的模型结构和数据分布，减少量化误差。这个过程需要计算旋转矩阵，并进行矩阵变换，会引入一些计算开销。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C# 正则表达式（5）：前瞻/后顾（Lookaround）——零宽断言做“条件校验”和“精确提取”]]></title>    <link>https://juejin.cn/post/7592069113222283283</link>    <guid>https://juejin.cn/post/7592069113222283283</guid>    <pubDate>2026-01-06T14:44:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592069113222283283" data-draft-id="7585468725332131894" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C# 正则表达式（5）：前瞻/后顾（Lookaround）——零宽断言做“条件校验”和“精确提取”"/> <meta itemprop="keywords" content="前端,C#,正则表达式"/> <meta itemprop="datePublished" content="2026-01-06T14:44:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="烛阴"/> <meta itemprop="url" content="https://juejin.cn/user/950397795841032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C# 正则表达式（5）：前瞻/后顾（Lookaround）——零宽断言做“条件校验”和“精确提取”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/950397795841032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    烛阴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T14:44:51.000Z" title="Tue Jan 06 2026 14:44:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、四种 Lookaround 语法总览</h2>
<h3 data-id="heading-1">1. 正向前瞻（必须能看到…）</h3>
<pre><code class="hljs language-regex" lang="regex">(?=...)
</code></pre>
<h3 data-id="heading-2">2. 负向前瞻（必须看不到…）</h3>
<pre><code class="hljs language-regex" lang="regex">(?!...)
</code></pre>
<h3 data-id="heading-3">3. 正向后顾（前面必须是…）</h3>
<pre><code class="hljs language-regex" lang="regex">(?&lt;=...)
</code></pre>
<h3 data-id="heading-4">4. 负向后顾（前面必须不是…）</h3>
<pre><code class="hljs language-regex" lang="regex">(?&lt;!...)
</code></pre>
<hr/>
<h2 data-id="heading-5">二、前瞻：最常见的“密码/复杂规则校验”写法</h2>
<h3 data-id="heading-6">1.至少包含一个字母和一个数字（长度 8~16）</h3>
<p>需求：</p>
<ul>
<li>总长度 8~16</li>
<li>只能字母数字</li>
<li>至少 1 个字母</li>
<li>至少 1 个数字</li>
</ul>
<p>正则：</p>
<pre><code class="hljs language-regex" lang="regex">^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{8,16}$
</code></pre>
<p>拆解：</p>
<ul>
<li><code>^...$</code>：整串校验</li>
<li><code>(?=.*[A-Za-z])</code>：从当前位置往后看，必须能找到字母</li>
<li><code>(?=.*\d)</code>：必须能找到数字</li>
<li><code>[A-Za-z\d]{8,16}</code>：真正需要匹配字符的主体</li>
</ul>
<p>C#：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">var</span> pattern = <span class="hljs-string">@"^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{8,16}$"</span>;
Regex.IsMatch(<span class="hljs-string">"abc12345"</span>, pattern); <span class="hljs-comment">// True</span>
Regex.IsMatch(<span class="hljs-string">"abcdefgh"</span>, pattern); <span class="hljs-comment">// False (无数字)</span>
Regex.IsMatch(<span class="hljs-string">"12345678"</span>, pattern); <span class="hljs-comment">// False (无字母)</span>
</code></pre>
<hr/>
<h2 data-id="heading-7">三、负向前瞻：禁止某些前缀/全局禁用模式</h2>
<h3 data-id="heading-8">1. 不能以 admin 开头（不区分大小写可用选项）</h3>
<pre><code class="hljs language-csharp" lang="csharp">Regex.IsMatch(<span class="hljs-string">"AdminUser"</span>, <span class="hljs-string">@"^(?!admin)\w+$"</span>, RegexOptions.IgnoreCase); <span class="hljs-comment">// False</span>
Regex.IsMatch(<span class="hljs-string">"user_admin"</span>, <span class="hljs-string">@"^(?!admin)\w+$"</span>, RegexOptions.IgnoreCase); <span class="hljs-comment">// True</span>
</code></pre>
<hr/>
<h2 data-id="heading-9">四、后顾：做“切片式提取”</h2>
<p>Lookbehind 非常适合“提取某个标记后面的内容”，但不想把标记本身包含进匹配结果。</p>
<h3 data-id="heading-10">1. 提取 <code>UserId=</code> 后面的数字</h3>
<p>文本：</p>
<pre><code class="hljs language-text" lang="text">UserId=42 Action=Login
</code></pre>
<p>正则：</p>
<pre><code class="hljs language-regex" lang="regex">(?&lt;=UserId=)\d+
</code></pre>
<p>C#：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">var</span> input = <span class="hljs-string">"UserId=42 Action=Login"</span>;
<span class="hljs-keyword">var</span> m = Regex.Match(input, <span class="hljs-string">@"(?&lt;=UserId=)\d+"</span>);
Console.WriteLine(m.Value); <span class="hljs-comment">// 42</span>
</code></pre>
<h3 data-id="heading-11">2. 提取 URL 参数值（示例：id= 后面的一段数字）</h3>
<pre><code class="hljs language-regex" lang="regex">(?&lt;=\bid=)\d+
</code></pre>
<hr/>
<h2 data-id="heading-12">五、负向后顾：避免“被转义的分隔符”等场景</h2>
<p>一个典型需求：找到未被反斜杠转义的引号/分隔符。</p>
<p>例如找文本中“不是 <code>\"</code> 的 <code>"</code>”：</p>
<pre><code class="hljs language-regex" lang="regex">(?&lt;!\\)"
</code></pre>
<p>含义：</p>
<ul>
<li><code>(?&lt;!\\)</code>：前面不是反斜杠</li>
<li><code>"</code>：匹配一个双引号</li>
</ul>
<p>注意：这只是一个常见思路，真实字符串里会有双重转义（C# 字符串字面量与文本内容的转义混在一起），写测试时要分清“源文本到底是什么”。</p>
<hr/>
<h2 data-id="heading-13">结语</h2>
<p><strong>点个赞，关注我获取更多实用 C# 技术干货！如果觉得有用，记得收藏本文</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[linux 常见稳定性问题分析方法]]></title>    <link>https://juejin.cn/post/7592251792629563419</link>    <guid>https://juejin.cn/post/7592251792629563419</guid>    <pubDate>2026-01-06T14:41:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592251792629563419" data-draft-id="7592082090207428635" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="linux 常见稳定性问题分析方法"/> <meta itemprop="keywords" content="算法,自动驾驶"/> <meta itemprop="datePublished" content="2026-01-06T14:41:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="地平线开发者"/> <meta itemprop="url" content="https://juejin.cn/user/1257497032132567"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            linux 常见稳定性问题分析方法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1257497032132567/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    地平线开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T14:41:56.000Z" title="Tue Jan 06 2026 14:41:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.概述</h2>
<p>稳定性对项目交付、用户体验有着非常重要的影响，一般定义的稳定性问题是遇到了系统异常重启或者系统卡死等，即无法按照预期为客户继续提供功能和服务。地平线 SoC 平台提供了多种调试手段，去分析系统遇到的稳定性问题。</p>
<p>首先我们需要了解征程系列的软硬件方案及异常 reset 路径，通过了解异常路径定位发生异常的节点和步骤，定位到问题方向。</p>
<p>其次，我们需要对发生问题节点提取的调试信息，包括抓取 log、抓取 ramdump 等，对于复杂问题，可能需要不断的迭代 patch 以获取更多调试信息，以缩小问题的范围。</p>
<p>对于复杂问题，可能需要使用特定的工具去分析问题，如 crash-utility，T32，ftrace 等。</p>
<p>所以我们将稳定性问题的概述指导分为下面几个章节进行介绍。</p>
<h2 data-id="heading-1">2. 常见问题</h2>
<h4 data-id="heading-2">2.1.kernel panic</h4>
<ul>
<li>kernel panic 是最常见的系统异常，在 reset_reason.txt 中显示为 kpanic；</li>
<li>一般通过 pstore log 就能看到 panic 时的栈和寄存器信息，通过分析上下文配合符号表及 gdb 等工具经常能够直接定位问题；</li>
<li>对于复杂问题，需要开启 ramdump，抓取 dump 后进行分析。</li>
</ul>
<p>一个典型的 kpanic 如下：</p>
<pre><code class="hljs language-markdown" lang="markdown">&lt;4&gt;[86758.651597] NMI backtrace for cpu 2
&lt;4&gt;[86758.651598] CPU: 2 PID: 105 Comm: khungtaskd Tainted: P           O       6.1.134-rt51-04836-g0b3e5cbe5431 #13
&lt;4&gt;[86758.651601] Hardware name: Horizon AI Technologies, Inc. HOBOT Sigi-P Matrix (DT)
&lt;4&gt;[86758.651602] Call trace:
&lt;4&gt;[86758.651817] NMI backtrace for cpu 4
&lt;4&gt;[86758.651821] CPU: 4 PID: 5110 Comm: glmark2-es2-drm Tainted: P           O       6.1.134-rt51-04836-g0b3e5cbe5431 #13
&lt;4&gt;[86758.651825] Hardware name: Horizon AI Technologies, Inc. HOBOT Sigi-P Matrix (DT)
&lt;4&gt;[86758.651826] pstate: 20400009 (nzCv daif +PAN -UAO -TCO -DIT -SSBS BTYPE=--)
&lt;4&gt;[86758.651829] pc : mas<span class="hljs-emphasis">_empty_</span>area<span class="hljs-emphasis">_rev+0x2f4/0x574
&lt;4&gt;[86758.651835] lr : mas_</span>empty<span class="hljs-emphasis">_area_</span>rev+0x24c/0x574
&lt;4&gt;[86758.651838] sp : ffff800045eafab0
&lt;4&gt;[86758.651839] pmr<span class="hljs-emphasis">_save: 000000e0
&lt;4&gt;[86758.651840] x29: ffff800045eafab0 x28: 00000000001fffff x27: 00000000002a0000
&lt;4&gt;[86758.651843] x26: 0000ffdf00000000 x25: 0000000000000018 x24: ffff00040c9d3000
&lt;4&gt;[86758.651846] x23: 0000000000200000 x22: ffff800008d30a28 x21: ffff00041a0cde0c
&lt;4&gt;[86758.651848] x20: 00000000002a0000 x19: ffff800045eafb48 x18: ffffffffffffffc2
&lt;4&gt;[86758.651850] x17: 0000ffdeff1fffff x16: 0000ffdf00000000 x15: 0000ffdeffffffff
&lt;4&gt;[86758.651852] x14: 0000000000200000 x13: 0000ffdeffffffff x12: ffff00041a0cde00
&lt;4&gt;[86758.651854] x11: ffff00041a0cde80 x10: 000000000029ffff x9 : ffffffffffffc005
&lt;4&gt;[86758.651856] x8 : 1fffe00083419bc1 x7 : 0000000000000000 x6 : 0000000000000000
&lt;4&gt;[86758.651858] x5 : 00000000003d0000 x4 : 0000ffdefee30000 x3 : ffff00041a0cde08
&lt;4&gt;[86758.651861] x2 : 0000000000000000 x1 : 0000000000000000 x0 : ffff00041a0cde0c
&lt;4&gt;[86758.651863] Call trace:
&lt;4&gt;[86758.651864]  mas_</span>empty<span class="hljs-emphasis">_area_</span>rev+0x2f4/0x574
&lt;4&gt;[86758.651867]  kbase<span class="hljs-emphasis">_unmapped_</span>area<span class="hljs-emphasis">_topdown.constprop.0+0x150/0x27c [mali_</span>kbase]
&lt;4&gt;[86758.651889]  kbase<span class="hljs-emphasis">_context_</span>get<span class="hljs-emphasis">_unmapped_</span>area+0x2b0/0x3b0 [mali<span class="hljs-emphasis">_kbase]
&lt;4&gt;[86758.651904]  kbase_</span>get<span class="hljs-emphasis">_unmapped_</span>area+0x4c/0x7c [mali<span class="hljs-emphasis">_kbase]
&lt;4&gt;[86758.651920]  get_</span>unmapped<span class="hljs-emphasis">_area+0x60/0xf0
&lt;4&gt;[86758.651925]  do_</span>mmap+0xe4/0x4fc
&lt;4&gt;[86758.651926]  vm<span class="hljs-emphasis">_mmap_</span>pgoff+0xf8/0x190
&lt;4&gt;[86758.651929]  ksys<span class="hljs-emphasis">_mmap_</span>pgoff+0xb8/0x10c
&lt;4&gt;[86758.651933]  <span class="hljs-strong">__arm64<span class="hljs-emphasis">_sys_</span>mmap+0x38/0x50
&lt;4&gt;[86758.651934]  invoke<span class="hljs-emphasis">_syscall+0x50/0x120
&lt;4&gt;[86758.651938]  el0_</span>svc<span class="hljs-emphasis">_common.constprop.0+0x58/0x190
&lt;4&gt;[86758.651941]  do_</span>el0<span class="hljs-emphasis">_svc+0x34/0xd0
&lt;4&gt;[86758.651944]  el0_</span>svc+0x28/0xb0
&lt;4&gt;[86758.651946]  el0t<span class="hljs-emphasis">_64_</span>sync<span class="hljs-emphasis">_handler+0xf4/0x120
&lt;4&gt;[86758.651949]  el0t_</span>64<span class="hljs-emphasis">_sync+0x19c/0x1a0
&lt;0&gt;[86758.652637] Kernel panic - not syncing: hung_</span>task: blocked tasks
&lt;4&gt;[86758.652639] CPU: 2 PID: 105 Comm: khungtaskd Tainted: P           O       6.1.134-rt51-04836-g0b3e5cbe5431 #13
&lt;4&gt;[86758.652641] Hardware name: Horizon AI Technologies, Inc. HOBOT Sigi-P Matrix (DT)
&lt;4&gt;[86758.652641] Call trace:
&lt;4&gt;[86758.652642]  dump<span class="hljs-emphasis">_backtrace+0xe4/0x140
&lt;4&gt;[86758.652644]  show_</span>stack+0x20/0x30
&lt;4&gt;[86758.652645]  dump<span class="hljs-emphasis">_stack_</span>lvl+0x64/0x80
&lt;4&gt;[86758.652647]  dump<span class="hljs-emphasis">_stack+0x18/0x34
&lt;4&gt;[86758.652649]  panic+0x198/0x394
&lt;4&gt;[86758.652653]  watchdog+0x2d0/0x510
&lt;4&gt;[86758.652655]  kthread+0x138/0x140
&lt;4&gt;[86758.652657]  ret_</span>from<span class="hljs-emphasis">_fork+0x10/0x20
&lt;2&gt;[86758.760353] SMP: stopping secondary CPUs
&lt;0&gt;[86758.760362] Kernel Offset: disabled
&lt;0&gt;[86758.760362] CPU features: 0x00000,000700a4,675072ab
&lt;0&gt;[86758.760364] Memory Limit: none
</span></span></code></pre>
<p>另外，一些其他的原因也会导致 kernel panic，详细会在 <a href="https://link.juejin.cn?target=http%3A%2F%2F10.106.32.73%2Fdoc%2FLNX-PL4.0-WB-20250724-J6P%2Fcn%2Fhtml%2Fbasic_debug%2Fstability%2Fbasic_debug_stability_Kernel_panic.html" target="_blank" title="http://10.106.32.73/doc/LNX-PL4.0-WB-20250724-J6P/cn/html/basic_debug/stability/basic_debug_stability_Kernel_panic.html" ref="nofollow noopener noreferrer">Kernel panic</a> 进行介绍。</p>
<h4 data-id="heading-3">2.2. Memory corruption</h4>
<p>Memory corruption 类问题一般表现也是 kpanic，但是最明显的标志是问题的随机性和不可解释性，出现这类情况，一般要考虑是内存使用上出现了 UAF（Use-After-Free），OOB（Out-of-Bounds）。</p>
<p>这类问题的难点在于，系统出现异常 crash 时，已经是前面时间发生踩踏的结果，所以需要定位到踩踏发生的位置，才能正向解决这类问题，一般在系统中存在下述两类踩踏问题：</p>
<p>a&gt; Linux 内核发生踩踏：</p>
<ul>
<li>对于 Acore 中运行的 Linux 系统，KASAN 是目前检查内存访问越界（Out-Of-Bound）和释放后访问（Use-After-Free）问题最有效的工具，KASAN 依赖编译器支持，当前 GCC-12.2 可以支持全功能的 KASAN，但是 KASAN 对性能和内存损耗非常严重，对于 slub 内存的使用问题，轻量级的 LUB_DEBUG 往往也能提供帮助，但功能比较受限且提供的信息也比较有限。</li>
</ul>
<p>b&gt; SoC 子系统间的内存踩踏：</p>
<ul>
<li>在 征程 6X SoC 拥有 Acore、BPU、VDSP、Secure World（EL3）的多子系统 SoC， DDR 内存空间根据需求划分给不同子系统，如果子系统间内存出现踩踏，整机系统可能会出现各种随机异常；</li>
<li>征程 6X SoC 中使用 firewall 对 SoC 各子系统间的内存越界踩踏进行检测，当发生踩踏时由 EL3 触发 crash。</li>
</ul>
<h4 data-id="heading-4">2.3. Watchdog</h4>
<ul>
<li>征程 6X SoC 中有 2 路 watchdog，目前使用 wdt0（监控 linux irq），wdt1（监控 linux 优先级为 50 的 rt kthread）。从/log/reset_reason.txt 中可以看到 wdt 的 reason：</li>
</ul>
<blockquote>
<p>2025-06-13-13-35-25: mwdt               xxx@e9e8fadb9907 debug 20250610-193933   1100</p>
</blockquote>
<ul>
<li>wdt 导致重启后，系统会保存 pstore log，通过检查 pstore 获取异常信息；</li>
<li>wdt 狗咬中断/事件由 MCU 域处理，MCU 域进行重启。</li>
<li>wdt0：一般是 kernel 中某个 CPU 处于长时间无法响应中断的状态，征程 6X 平台上在 wdt1 狗咬时间（IRQ_WDT_TIMEOUT）到后会触发一个 gic 中断，在这个中断中会使用 NMI 将所有 cpu 的调用栈打印；</li>
<li>wdt1：一般是 kernel 中某个 CPU 处于长时间无法调度优先级为 50 的 rt kthread 的状态，征程 6X 平台上在 wdt2 狗咬时间（IRQ_WDT_TIMEOUT）到后会触发一个 gic 中断，在这个中断中会使用 NMI 将所有 cpu 的调用栈打印。</li>
</ul>
<h4 data-id="heading-5"><strong>2.4 firewall</strong></h4>
<p><strong>在 征程 6X SoC 拥有 Acore、BPU、GPU、VDSP0、Secure World（EL3）等多个子系统，DDR 内存空间根据需求划分给不同子系统。</strong></p>
<p>如果子系统间内存/寄存器空间出现踩踏，整机系统可能会出现各种随机异常。firewall 是 征程 6X SoC 上的硬件单元，功能就是根据配置捕获子系统间的内存越界踩踏，当发生踩踏时由 EL3 触发 crash。</p>
<p>在 MCU 域的 log 中会输出发生越界访问的地址信息和 master 信息，输出示例如下：ID 为 0xd0 的 master 尝试读地址为 0x80000000 的内存空间。</p>
<p>MCU 域主动触发 firewall 违例：</p>
<pre><code class="hljs language-markdown" lang="markdown">horizon:/$ regread 0x80000000
</code></pre>
<p>MCU 域的违例信息 log：</p>
<pre><code class="hljs language-markdown" lang="markdown">[016.346991 0]firewall module 136 read violation master ID:d0
[016.347654 0]violation port 0[016.348004 0]violation addr high:0, low:80000000
[016.348656 0]Reg 0x80000000 value is 0x12345678

horizon:/$ [<span class="hljs-string">016.369156 0</span>][<span class="hljs-symbol">M</span>][<span class="hljs-string">time_1: 000016 s, 346 ms</span>] Fchm Info occur (34, 30, 2552, 136)[<span class="hljs-string">016.370239 0</span>][<span class="hljs-symbol">M</span>][<span class="hljs-string">time_2: 000016 s, 348 ms</span>] 136-6-CF Occur (34, 30, 2552), Payload(00-00-136-00 00-00-00-128 00-00-00-00 208-00-00-00)[<span class="hljs-string">016.371715 0</span>]Customer handle(63, 1, 2)[<span class="hljs-string">016.421368 0</span>][<span class="hljs-symbol">M</span>][<span class="hljs-string">time_1: 000016 s, 348 ms</span>] Fchm Info occur (36, 3, 2553, 349)[<span class="hljs-string">016.422437 0</span>][<span class="hljs-symbol">M</span>][<span class="hljs-string">time_2: 000016 s, 348 ms</span>] 349-6-CF Occur (36, 3, 2553), Payload(00-00-00-00 00-00-00-00 00-00-00-00 00-00-00-00)[016.423894 0]Customer handle(51, 1, 2)
</code></pre>
<p>征程 6X 部分内存的 firewall 权限设置：</p>
<p>Master ID 定义，详见：hbbin_j6p/boot/j6p/bl31-dts/include/hobot_firewall.h。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[同事一个比喻，让我搞懂了Docker和k8s的核心概念]]></title>    <link>https://juejin.cn/post/7592069432228102153</link>    <guid>https://juejin.cn/post/7592069432228102153</guid>    <pubDate>2026-01-06T14:55:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592069432228102153" data-draft-id="7592082090207445019" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="同事一个比喻，让我搞懂了Docker和k8s的核心概念"/> <meta itemprop="keywords" content="后端,前端"/> <meta itemprop="datePublished" content="2026-01-06T14:55:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            同事一个比喻，让我搞懂了Docker和k8s的核心概念
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T14:55:50.000Z" title="Tue Jan 06 2026 14:55:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Docker 和 K8s 的核心概念，用"快照"这个比喻就够了</h2>
<p>前几天让同事帮忙部署服务，顺嘴问了句"Docker 和 K8s 到底是啥"。</p>
<p>其实这俩概念我以前看过，知道是"打包完整环境、到处运行"，但一直停留在似懂非懂的状态。镜像、容器、Pod、集群、节点……这些词都见过，就是串不起来。</p>
<p>同事给我讲了一个非常直观的比喻，一下就通了：</p>
<h3 data-id="heading-1">镜像：一个打包好的系统快照</h3>
<p>Docker 镜像可以理解成一个系统快照，里面包含了：</p>
<ul>
<li>操作系统（比如 Debian、Alpine）</li>
<li>运行时环境（比如 Python 3.11、Node 20）</li>
<li>所有依赖包</li>
<li>你的代码</li>
<li>配置文件</li>
</ul>
<p>这个快照是<strong>静态的、只读的</strong>，就像一张光盘——刻好了就不会变。</p>
<h3 data-id="heading-2">容器：运行起来的快照</h3>
<p>容器就是把镜像跑起来。</p>
<pre><code class="hljs language-arduino" lang="arduino">镜像（静态快照） --docker run--&gt; 容器（运行中的进程）
</code></pre>
<p>容器是<strong>动态的、可写的</strong>，可以往里面写文件、改配置。但一旦容器销毁，这些改动就没了（除非你挂载了外部存储）。</p>
<p>一个镜像可以同时跑多个容器，就像一张光盘可以装到多台电脑上。</p>
<h3 data-id="heading-3">Dockerfile 和 docker-compose</h3>
<p>搞清楚镜像和容器的关系后，这两个东西就好理解了：</p>
<ul>
<li><strong>Dockerfile</strong>：定义如何构建镜像的配方</li>
<li><strong>docker-compose</strong>：定义如何运行一组容器</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A["Dockerfile&lt;br/&gt;(配方)"] --&gt;|docker build| B["Image&lt;br/&gt;(镜像/快照)"]
    B --&gt;|docker run&lt;br/&gt;docker-compose up| C["Container&lt;br/&gt;(容器/运行态)"]
</code></pre>
<p>举个例子，你写了个 Python 服务：</p>
<pre><code class="hljs language-dockerfile" lang="dockerfile"># Dockerfile
FROM python:3.11-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
CMD ["python", "main.py"]
</code></pre>
<p>这个 Dockerfile 就是一份配方，告诉 Docker：</p>
<ol>
<li>基于 Python 3.11 的官方镜像</li>
<li>把依赖装好</li>
<li>把代码复制进去</li>
<li>启动时运行 <code>python main.py</code></li>
</ol>
<p>执行 <code>docker build</code> 就会按这个配方生成一个镜像。</p>
<h3 data-id="heading-4">为什么说"到处运行"</h3>
<p>Docker 的核心价值就是解决"我这能跑，你那跑不了"的问题。</p>
<p>以前部署服务，你得操心：服务器是什么系统？装的什么版本的 Python？依赖库版本对不对？环境变量配了没？</p>
<p>现在有了 Docker，这些都打包进镜像了。不管你的服务器是 Ubuntu、CentOS 还是 Debian，只要装了 Docker，同一个镜像都能跑出一样的结果。</p>
<h3 data-id="heading-5">Pod：K8s 调度的最小单元</h3>
<p>到了 Kubernetes 这一层，又多了一个概念：<strong>Pod</strong>。</p>
<p>Pod 是 K8s 定义的概念，是集群调度的最小单元。一个 Pod 里面可以有一个或多个容器。</p>
<p>你可能会问：为什么不直接调度容器，还要多一层 Pod？</p>
<p>因为有些场景下，几个容器需要紧密配合。比如一个主服务容器 + 一个日志收集容器，它们需要：</p>
<ul>
<li>共享网络（用 localhost 通信）</li>
<li>共享存储（访问同一个目录）</li>
<li>一起启动、一起销毁</li>
</ul>
<p>把它们放在一个 Pod 里，K8s 就会把它们调度到同一台机器上，共享资源。</p>
<p>不过大多数情况下，一个 Pod 就放一个容器。微服务架构下，每个服务就是一个 Pod：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
    subgraph Cluster["K8s 集群"]
        subgraph Node1["节点 1"]
            PodA["Pod A&lt;br/&gt;用户服务"]
            PodB["Pod B&lt;br/&gt;订单服务"]
        end
        subgraph Node2["节点 2"]
            PodC["Pod C&lt;br/&gt;支付服务"]
            PodD["Pod D&lt;br/&gt;网关服务"]
        end
    end
</code></pre>
<h3 data-id="heading-6">K8s 干的事情</h3>
<p>K8s 负责管理这些 Pod：</p>
<ul>
<li><strong>调度</strong>：决定 Pod 跑在哪个节点上</li>
<li><strong>扩缩容</strong>：流量大了自动多启几个 Pod，流量小了缩回去</li>
<li><strong>自愈</strong>：Pod 挂了自动重启</li>
<li><strong>网络</strong>：打通各个 Pod 之间的通信</li>
<li><strong>存储</strong>：管理持久化存储</li>
</ul>
<p>说白了，Docker 解决的是"打包和运行"的问题，K8s 解决的是"大规模部署和管理"的问题。</p>
<p>一台机器跑几个容器，手动管理就行。但当你有几十台机器、几百个容器的时候，就需要 K8s 这样的编排工具来帮你自动化处理。</p>
<pre><code class="hljs">Dockerfile → Image → Container → Pod → Node → Cluster
   配方       快照     运行态     调度单元   机器    集群
</code></pre>
<p>概念不难，难的是实际操作中的各种坑。但只要这个基础模型搞清楚了，遇到问题知道往哪个层面去排查就行。</p>
<hr/>
<p>如果你觉得这篇文章有帮助，欢迎关注我的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i" target="_blank" title="https://github.com/tt-a1i" ref="nofollow noopener noreferrer">GitHub</a>，下面是我的一些开源项目：</p>
<p><strong>Claude Code Skills</strong>（按需加载，意图自动识别，不浪费 token，<a href="https://juejin.cn/post/7578714735307735066" target="_blank" title="https://juejin.cn/post/7578714735307735066">介绍文章</a>）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcode-review-skill" target="_blank" title="https://github.com/tt-a1i/code-review-skill" ref="nofollow noopener noreferrer">code-review-skill</a> - 代码审查技能，覆盖 React 19、Vue 3、TypeScript、Rust 等约 9000 行规则（<a href="https://juejin.cn/post/7578709098255908902" target="_blank" title="https://juejin.cn/post/7578709098255908902">详细介绍</a>）</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2F5-whys-skill" target="_blank" title="https://github.com/tt-a1i/5-whys-skill" ref="nofollow noopener noreferrer">5-whys-skill</a> - 5 Whys 根因分析，说"找根因"自动激活</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Ffirst-principles-skill" target="_blank" title="https://github.com/tt-a1i/first-principles-skill" ref="nofollow noopener noreferrer">first-principles-skill</a> - 第一性原理思考，适合架构设计和技术选型</li>
</ul>
<p><strong>qwen/gemini/claude - cli 原理学习网站</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcoding-cli-guide" target="_blank" title="https://github.com/tt-a1i/coding-cli-guide" ref="nofollow noopener noreferrer">coding-cli-guide</a>（<a href="https://link.juejin.cn?target=https%3A%2F%2Ftt-a1i.github.io%2Fcoding-cli-guide%2F%3Ftab%3Dstart-here" target="_blank" title="https://tt-a1i.github.io/coding-cli-guide/?tab=start-here" ref="nofollow noopener noreferrer">学习网站</a>）- 学习 qwen-cli 时整理的笔记，40+ 交互式动画演示 AI CLI 内部机制
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08e50020ab1f45428cd22e53af91a555~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lmf5peg6aOO6Zuo5Lmf6Zu-5pm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768316150&amp;x-signature=nPQNnC4h08I8pRhX9ACeSEiPLSM%3D" alt="coding-cli-guide" loading="lazy"/></li>
</ul>
<p><strong>全栈项目</strong>（适合学习现代技术栈）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fprompt-vault" target="_blank" title="https://github.com/tt-a1i/prompt-vault" ref="nofollow noopener noreferrer">prompt-vault</a> - Prompt 管理器，用的都是最新的技术栈，适合用来学习了解最新的前端全栈开发范式：Next.js 15 + React 19 + tRPC 11 + Supabase 全栈示例，clone 下来配个免费 Supabase 就能跑</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fchat_edit" target="_blank" title="https://github.com/tt-a1i/chat_edit" ref="nofollow noopener noreferrer">chat_edit</a> - 双模式 AI 应用（聊天+富文本编辑），Vue 3.5 + TypeScript + Vite 5 + Quill 2.0 + IndexedDB</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025，菜鸟的「Vibe Coding」时刻]]></title>    <link>https://juejin.cn/post/7591942733366624290</link>    <guid>https://juejin.cn/post/7591942733366624290</guid>    <pubDate>2026-01-06T13:09:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591942733366624290" data-draft-id="7591816944729718820" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025，菜鸟的「Vibe Coding」时刻"/> <meta itemprop="keywords" content="前端,年终总结"/> <meta itemprop="datePublished" content="2026-01-06T13:09:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="PBitW"/> <meta itemprop="url" content="https://juejin.cn/user/3048261967153544"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025，菜鸟的「Vibe Coding」时刻
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3048261967153544/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    PBitW
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T13:09:52.000Z" title="Tue Jan 06 2026 13:09:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果要用一个词来形容 2025 年，那我会毫不犹豫地选 <strong>AI 元年</strong>。
而对我个人来说，2025 年还有一层更现实的意义：这是我<strong>真正开始在掘金认真写文章的一年</strong>。</p>
<p>其实在 2024 年，我也断断续续写过一些内容，但说实话，那时候更多是把自己在 CSDN 写过的文章迁移过来，顺便优化一下表达。迁移的也基本都是我当时觉得写得比较认真、比较有价值的文章，中间也夹杂着几篇为了参加「金石计划」而写的新的原创内容，但整体还是偏 “试水”。</p>
<p><strong>真正的转折点在 2025 年。</strong></p>
<p>这一年，我几乎把掘金当成了主阵地。文章基本都是先在掘金发布，再视情况同步到 CSDN。原因也很现实：掘金的技术氛围、活动力度、互动反馈都更好，而 CSDN 这边，我反而更新得越来越少了。</p>
<h2 data-id="heading-0">这一年，我都写了些什么？</h2>
<p>回头翻了一下自己的文章列表，其实能明显看出一个变化轨迹。</p>
<p>一开始，更多还是偏向<strong>工程效率和工具</strong>：</p>
<ol>
<li>
<p><a href="https://juejin.cn/post/7462720541582180387" target="_blank" title="https://juejin.cn/post/7462720541582180387">Code Inspector 页面开发提效的神器！</a> —— 老项目可以用，新的项目基本都用vuetool了，更加厉害、方便</p>
</li>
<li>
<p><a href="https://juejin.cn/post/7463137546526572579" target="_blank" title="https://juejin.cn/post/7463137546526572579">vue3+vite+eslint|prettier+elementplus+国际化+axios封装+pinia</a> —— 写这篇文章，完全是因为大佬来了之后，两个人代码规范不太一样，然后菜鸟发现自己的编译器好像有些规则没有生效、有些则是大佬的编译器有问题，所以研究了一下</p>
</li>
</ol>
<p>也有踩坑之后的 “否定式总结”：</p>
<ol start="3">
<li><a href="https://juejin.cn/post/7467587991617355812" target="_blank" title="https://juejin.cn/post/7467587991617355812">无界构建微前端？NO！NO！NO！多系统融合思路！</a> —— 写这篇文章是菜鸟学习了一下微前端，然后准备用无界将多个系统放一起，<strong>结果没成功，很多坑、文档少</strong>，最后搞成了类似单点登录的<strong>规划</strong>（其实系统并没有做，公司没有给这个安排时间，不是很重要）</li>
</ol>
<h2 data-id="heading-1">AI，真正开始介入我的开发</h2>
<ol start="4">
<li><a href="https://juejin.cn/post/7472044324965761062" target="_blank" title="https://juejin.cn/post/7472044324965761062">Trae 初体验 - vscode要被替代了！强推Trae！</a> —— 大概2月份，<strong>AI就已经开始普及、成熟了，当时就第一时间体验了Trae，甚至一度把Trae当作主要开发工具</strong>，也第一次明显感觉到：</li>
</ol>
<blockquote>
<p>写代码这件事，节奏变了。</p>
</blockquote>
<ol start="5">
<li><a href="https://juejin.cn/post/7473259813230051354" target="_blank" title="https://juejin.cn/post/7473259813230051354">阅读《Vue.js设计与实现》 -- 01</a> \ <a href="https://juejin.cn/post/7477875236135649318" target="_blank" title="https://juejin.cn/post/7477875236135649318">阅读《Vue.js设计与实现》 -- 02</a> \ <a href="https://juejin.cn/post/7482422034506514470" target="_blank" title="https://juejin.cn/post/7482422034506514470">阅读《Vue.js设计与实现》 -- 03</a> —— 这几篇文章是在开发的空闲阶段，向大佬学习，所以就找了本书看，结果看一点就没坚持了，菜鸟还是更喜欢看视频学习，不知道为什。</li>
</ol>
<blockquote>
<p>说到学习，菜鸟感觉自己一直都没怎么进步，感觉和大佬的差距一直很大，说着要学习，上班没空、下班不想学，最多就是看看渡一的短视频学习一下，感觉真的好难，不知道大家是怎么学习的？</p>
</blockquote>
<ol start="6">
<li>
<p><a href="https://juejin.cn/post/7474930711230709799" target="_blank" title="https://juejin.cn/post/7474930711230709799">通过 Trae 认识 web3 -- 中国开发者应该学吗？</a> \ <a href="https://juejin.cn/post/7475351155297304587" target="_blank" title="https://juejin.cn/post/7475351155297304587">通过 Trae 浅谈 App 套壳可行性🤡</a> —— 这里是参加Trae的体验活动写的两篇文章，没啥含金量，就是单纯为自己解惑，<strong>也是开始在项目上依赖AI开发的起始点</strong>！</p>
</li>
<li>
<p><a href="https://juejin.cn/post/7475720382164140086" target="_blank" title="https://juejin.cn/post/7475720382164140086">虽然理解git命令，但是我选择vscode插件！</a> —— 这里是当时感觉idea自带的git模块很好用，而前端好用的git插件要收费了，所以当时就好好研究了一下，用平替的插件代替，也能玩出一样的花活，<strong>又由Trae转回vscode了</strong>！</p>
</li>
<li>
<p><a href="https://juejin.cn/post/7483790173643079717" target="_blank" title="https://juejin.cn/post/7483790173643079717">canvas 手写滑动验证</a> —— 这个是菜鸟为了验证渡一还是看进去了一点，所以主动请缨交给我做的模块（现在基本又还回去了）</p>
</li>
</ol>
<blockquote>
<p>说到这个，菜鸟感觉完全不知道为什么，就是：当时会用的东西，长时间不用，菜鸟基本就忘记了，如果不写文章把重要代码粘贴上的话，后面可能写出来比第一次还要花时间，甚至可能写不出来。反正之前有人说，这是因为菜鸟没有理解透彻导致的，所以想问问大家是怎么做到不用的技术也能一直会用的？到底怎么样学透彻？菜鸟反正感觉就是当时写出来就行了，至于后面会不会用到就不知道了！</p>
</blockquote>
<ol start="9">
<li>
<p><a href="https://juejin.cn/post/7488251964222046218" target="_blank" title="https://juejin.cn/post/7488251964222046218">微信小程序 -- 原生封装table</a> —— 这个也是菜鸟主动请缨做的，因为菜鸟之前写过微信小程序，所以自然要表现一下！</p>
</li>
<li>
<p><a href="https://juejin.cn/post/7495910972637806592" target="_blank" title="https://juejin.cn/post/7495910972637806592">工作中突然发现零宽字符串的作用了！</a> —— 这个是菜鸟在开发过程中不好实现的一个点，想起来渡一教育的一个视频，就融合进来了</p>
</li>
<li>
<p><a href="https://juejin.cn/post/7501147702667952168" target="_blank" title="https://juejin.cn/post/7501147702667952168">工作两年，最后从css转向tailwind了！</a> —— 这个是菜鸟和大佬合作开发，发现tailwind确实还挺好用，特别是对于后台管理系统，所以就写了一下怎么入门和使用</p>
</li>
<li>
<p><a href="https://juejin.cn/post/7504094084421091340" target="_blank" title="https://juejin.cn/post/7504094084421091340">Trae让我在同学面前装了一波，但是太晚了！</a> \ <a href="https://juejin.cn/post/7572340344509251610" target="_blank" title="https://juejin.cn/post/7572340344509251610">升级了SOLO，对SOLO的一些建议！👍SOLO真的很不错！</a> —— 这两篇文章也是<strong>对AI的深入使用后，对Trae的建议</strong>，以及参加官方的活动</p>
</li>
<li>
<p><a href="https://juejin.cn/post/7508556336542023680" target="_blank" title="https://juejin.cn/post/7508556336542023680">工作两年，从自己造轮子，变成使用开源项目！</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7508623610619559948" target="_blank" title="https://juejin.cn/post/7508623610619559948">一个界面设计，让你再也不用头疼table懒加载不能动态增删子节点！</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7509336644040835113" target="_blank" title="https://juejin.cn/post/7509336644040835113">简单excel表格编辑神器 vxe-table</a></p>
</li>
</ol>
<p>还有部分就不一 一列举了，大家可以关注一下菜鸟，和菜鸟一起成长！</p>
<h2 data-id="heading-2">2025 年最后一个月：真正的 Vibe Coding 时刻</h2>
<p>真正让我对 AI 深入使用的，是 2025 年的最后一个月。</p>
<p>这一个月，我几乎是在<strong>多线程硬抗</strong>：</p>
<ul>
<li>同步推进一个更重要的主项目</li>
<li>还要承担项目管理</li>
<li>同时，用 AI 从零搞一个 Electron 桌面端程序</li>
<li>而且要求：<strong>能跑、能用、能上线</strong></li>
</ul>
<p>说实话，这种任务组合，基本没人愿意接，但那一刻我选择挺身而出，<strong>赌一把 AI</strong>。</p>
<p>结果证明，这一把赌对了。</p>
<p>我几乎把所有我不熟、没时间研究的部分，全部交给 AI：  文件读取、数据库连接、本地 API 封装、脚本调用 ……</p>
<p>很多代码都是<strong>一次就能跑起来</strong>。</p>
<p>我主要做的就是解释业务、梳理需求，把逻辑拆给 AI，它就直接生成可运行的 Electron 代码。</p>
<p>前端界面我还是亲自操刀，因为需要知道缺失的逻辑哪些需要用electron实现，至于后台那些 CRUD、脚本调用、配置读写什么的，就全交给 AI 了。</p>
<p>在遇到 Linux 打包白屏、数据库连接本地化这些坑，它都能给我方案，我只要照着改就行。虽然也会有错，但是比自己去翻阅文档、自己踩坑要快很多，而且可以直接在AI写出来的基础上进行调试，不用从零开始。</p>
<p>整个过程就像在和 AI 一起开黑 —— 我说出需求，它输出代码，我调试、校验，问题直接给 AI 看它也能快速分析。差不多零零散散一周左右的时间，一个能跑、能用、能上线的完整桌面端程序就摆在我眼前。</p>
<p>在领导面前演示的时候，整个流程没有很大的瑕疵，只有一些界面细节需要优化，那种用 AI 快速完成一波漂亮操作的成就感，真的是爽到飞起。</p>
<p>这一波操作让我彻底感受到，AI 真不是替代你，它是让你在时间紧迫、任务复杂的时候能“用更少的力气做更多事”的秘密武器。</p>
<p>它淘汰的是只会写简单逻辑的人；但永远替代不了：</p>
<ul>
<li>业务拆解</li>
<li>需求判断</li>
<li>架构取舍</li>
<li>以及“该不该这么做”的决策能力</li>
</ul>
<ol start="16">
<li>
<p><a href="https://juejin.cn/post/7591806035758628906" target="_blank" title="https://juejin.cn/post/7591806035758628906">Electron 初体验 —— AI辅助上手，确实不难(๑•̀ㅂ•́)و✧</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7592119218024824867" target="_blank" title="https://juejin.cn/post/7592119218024824867">Electron 在乌班图上打包 —— AI辅助</a></p>
</li>
</ol>
<p>感谢大家，听我啰里吧嗦，说了关于我的2025，也希望2026，我能得到大家的认可，获得更多的粉丝，也希望2026，我能把AI玩出新的花样和高度，而不是仅仅停留在代码提示、错误解决！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 出海市场洞察#3｜Grammarly：老牌巨头的流量与变现全链路拆解]]></title>    <link>https://juejin.cn/post/7592075359380996148</link>    <guid>https://juejin.cn/post/7592075359380996148</guid>    <pubDate>2026-01-06T12:07:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592075359380996148" data-draft-id="7591942733366542370" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 出海市场洞察#3｜Grammarly：老牌巨头的流量与变现全链路拆解"/> <meta itemprop="keywords" content="产品,AI编程"/> <meta itemprop="datePublished" content="2026-01-06T12:07:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="孟健AI编程"/> <meta itemprop="url" content="https://juejin.cn/user/4212984287073895"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 出海市场洞察#3｜Grammarly：老牌巨头的流量与变现全链路拆解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984287073895/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    孟健AI编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T12:07:48.000Z" title="Tue Jan 06 2026 12:07:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是孟健。</p>
<p>今天是我们市场洞察的第三篇，之前我们分析过的 remove.bg 和 pixelcut 不知道大家是否还记得？</p>
<p>其实，<strong>很多同学做 AI 编程出海产品的第一步，就是卡在找需求上</strong>，不知道怎么找一个长期的市场机会。</p>
<p>这就需要不断地练习，我会带大家深入分析收入排行榜上的产品，大家跟着我的思路，一起去探索市场。</p>
<p>随着看的越多，分析的越多，你就能知道市场上到底有哪些能赚钱的产品，从而挖掘出一些市场机会了。</p>
<p>好了话不多说，今天我们分享的产品是，榜单第十位的——Grammarly。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.grammarly.com%2F" target="_blank" title="https://www.grammarly.com/" ref="nofollow noopener noreferrer">www.grammarly.com/</a></p>
<hr/>
<h2 data-id="heading-0">01 定位先看 TDH：一句话让用户秒懂“你是干什么的”</h2>
<p>我们先分析一下它的 TDH，了解一下它是做什么的：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b887473535b04cfeb88b9ff1c698597c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768306068&amp;x-signature=%2F4B%2F%2Bu%2B%2F%2Fo1zvcMzsBUFGfmn9Yo%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<p><strong>Title</strong>: Grammarly: Free AI Writing Assistance</p>
</li>
<li>
<p><strong>Description</strong>: Grammarly makes AI writing convenient. Work smarter with personalized AI guidance and text generation on any app or website.</p>
</li>
<li>
<p><strong>H1</strong>: You think big. We’ll take care of the details.</p>
</li>
</ul>
<p>我把它翻译成人话就是：</p>
<ul>
<li>
<p>Title 定位：<strong>AI 写作领域的“免费助手”</strong>（Free 是强钩子，天然提升点击率）</p>
</li>
<li>
<p>Description 能力：<strong>更便捷的 AI 写作 + 个性化指导 + 文本生成</strong>，并且强调“<strong>any app / website</strong>”（跨场景可用）</p>
</li>
<li>
<p>H1 价值主张：<strong>你负责大方向，我们搞定细节</strong>（对写作类工具来说，情绪价值很关键）</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-1">02 产品形态：插件 + 客户端 + Web，把“写作”变成基础设施</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67c592a4a91f493e945ebf10f89f0624~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768306068&amp;x-signature=fZWsUYe2IXfBlyJPg9xpi4t3PMw%3D" alt="" loading="lazy"/></p>
<p>其实通过它首页的动图展示，我们也很容易明白它主要的功能，通过插件、本地客户端等等多种方式，能够帮你调整文案表达，包括纠错、润色、语气调整等等。</p>
<p>从需求角度，这类“<strong>输入输出都很标准</strong>、且用户愿意为效果付费”的场景，正是 AI 最能发挥作用的地方。</p>
<p>尤其对非母语用户来说，“更地道的表达”和“语气是否得体”是强刚需。</p>
<hr/>
<h2 data-id="heading-2">03 基础数据：～6000 万/月访问 + 16 年站龄，底盘非常厚</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a50976a8de84ee7a44f214a2e26914d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768306068&amp;x-signature=0xCPkMl3brNHP0KIroya9%2BIjOoU%3D" alt="" loading="lazy"/></p>
<p>我们再来看看网站数据：</p>
<ul>
<li>
<p>网站月访问量将近六千万</p>
</li>
<li>
<p>平均体验时长 3 分钟</p>
</li>
<li>
<p>站点已经 16 年了</p>
</li>
</ul>
<p>这意味着它不是“靠短期投机起量”的新站，而是长期积累出来的品牌与权重。</p>
<hr/>
<h2 data-id="heading-3">04 流量结构：Direct 第一，品牌效应已经形成</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe7b5aac27074b7997c7a5761d7e04ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768306068&amp;x-signature=8lerYPZmib2qhJnenOMjYSamU7c%3D" alt="" loading="lazy"/></p>
<p>从流量占比看，<strong>直接访问（Direct）排第一</strong>，说明用户已经形成了“用过就记得、下次直接输网址”的心智；</p>
<p>其次是搜索（Search），占比也很高（约四成）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e099af213ee84a899308e047cdb63905~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768306068&amp;x-signature=1mymM9Sd3x0KyLeFuJbpCP5lAI8%3D" alt="" loading="lazy"/></p>
<p>这一点，我们通过 SImilarWeb 上的回访客数量，也可以得到验证，复访的占比非常高。</p>
<p>写作/沟通是高频需求，一旦养成习惯，就很难换掉。</p>
<hr/>
<h2 data-id="heading-4">05 关键词：品牌词三百万/月，但它更狠的是吃“AI Detector”的盘子</h2>
<p>grammarly 这个品牌词，月搜索量竟然在三百万，这个品牌的确深入人心，然后它吃掉了 ai detector、ai checker 差不多一成的市场份额。</p>
<p>对于 ai detector 和 checker 这个市场其实非常大，我们后续将分析的好几个产品，都在这个市场，非常赚钱。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/517fcb8a2ceb4680ad282b5b4c237da4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768306068&amp;x-signature=M1vAY1L0UlpViKn2aFPcFPg7EDc%3D" alt="" loading="lazy"/></p>
<p>在 SImilarWeb 上可以看到，Grammarly 在这两个词上，也花费了很多钱去买 PPC 曝光。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1adb38cb9131456a83f987b2c92dcc8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768306068&amp;x-signature=%2F6XI4NNWlJZw8R7x5VTYDy68F%2Bo%3D" alt="" loading="lazy"/></p>
<p>我们可以看到，其实 Grammarly 花钱买量，主要买的就是 <strong>ai detector</strong> 这个关键词。这市场实在太大了（千万搜索量的市场）。</p>
<p>然后 google docs 这个品牌市场它竟然也抢到了一部分流量，每个月 40 多万的流量，因为它也提供了在线 docs 的功能。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0b71e860f76423abcac9e72e045c12e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768306068&amp;x-signature=1nJlmQ3mtZm%2B8Kj6tUjDaryAr9k%3D" alt="" loading="lazy"/></p>
<p>我们分析它的广告投放，其实可以看到，它投放了 google docs，落地页指向的是这个页面：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.grammarly.com%2Fgoogle-docs" target="_blank" title="https://www.grammarly.com/google-docs" ref="nofollow noopener noreferrer">www.grammarly.com/google-docs</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c82696f8d0445bca69fd74125477cc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768306068&amp;x-signature=bMGRve8SVuVUXc0CC41yu5w6a50%3D" alt="" loading="lazy"/></p>
<p>也就是说，它专门做了一个 google docs 落地页去抢这个词的流量，其实产品功能是浏览器插件，可以在 google docs 内完成 AI 写作的辅助功能。</p>
<p>最后一个词 plagiarism checker，是查重检测，这个也是个巨大的细分市场，尤其是论文查重方面。</p>
<p>从国家分布看，它在美国市场占领优势明显——这也是典型的“高付费习惯 + 高内容生产密度”的黄金市场。</p>
<hr/>
<h2 data-id="heading-5">07 个人创业者的提醒：别跟大厂正面拼 PPC</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b514ca0aeb734dbc9d6902b3697aa84c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768306068&amp;x-signature=AocWXChuYG8VlwySZ2gJ4yjPeHo%3D" alt="" loading="lazy"/></p>
<p>这种级别的买量竞争，个体创业者尽量避开：</p>
<p>你不是拼不过创意，是拼不过现金流。</p>
<p>更聪明的打法是绕开正面战场，<strong>去做更细的<strong><strong>长尾词</strong></strong>、更强的工具体验、更垂直的场景页。</strong></p>
<hr/>
<h2 data-id="heading-6">08 GEO 入口：ChatGPT 成最大外链来源，SEO + GEO 都要做</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d33b5f65b2384760b33b9d0ada1cffe8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768306068&amp;x-signature=wk4yo%2B8g0wQUrlw%2FGYtxDhG4K88%3D" alt="" loading="lazy"/></p>
<p>另外一方面，我们发现 Grammarly 最大的外链来源是 chatgpt，贡献了 300 万的访问量，这个不容小觑，我们现在做站，SEO 和 GEO 都要做，把自己权重做高，未来可能就是 GEO 的天下了。</p>
<hr/>
<h2 data-id="heading-7">09 定价与转化：经典订阅模型，默认年付拉高 LTV</h2>
<p>接着我们来看看这个网站的内页设计，先看 Pricing 页面：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7edd4d9aba5949c6a5114eb6edf0aa8d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768306068&amp;x-signature=K7nFRcY%2FixncV8B%2FHe9AdvVnMi8%3D" alt="" loading="lazy"/></p>
<p>Grammarly 的定价也是经典的 saas 订阅，默认引导年费，三层阶梯定价设计。</p>
<p>Enterprise 是没显示价格的，采取 contact 的方式做企业定制。这也是一种策略，其实会减轻用户心智负担，更愿意接受 Pro 的定价选择。</p>
<p>理论上我们看到<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>12</mn><mi mathvariant="normal">/</mi><mtext>月还挺便宜的，不过要注意这是年费的折算，单独按月订阅是</mtext></mrow><annotation encoding="application/x-tex">12/月还挺便宜的，不过要注意这是年费的折算，单独按月订阅是</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">12/</span><span class="mord cjk_fallback">月还挺便宜的，不过要注意这是年费的折算，单独按月订阅是</span></span></span></span></span>30/月。这样才能拉高用户的 LTV。</p>
<p>从功能特性方面，免费版提供了基本的纠错、Tone 提示、100 AI prompts 限制，就是让用户试用一下，体验一下效果，然后做付费转化。</p>
<p>Pro 设计上也没有给无限的 token，而是 2000 的 Prompt 去控制成本，加入了两个高级核心功能：</p>
<ul>
<li>
<p>Rewrite full sentences</p>
</li>
<li>
<p>Adjust tone</p>
</li>
</ul>
<p>重点的 cta 文案，get started 给到 Pro 版本。</p>
<hr/>
<h2 data-id="heading-8">10 ToB 页面很值得学：把 ROI 直接算给老板看</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7263501b68ee483e80dd0eaee5659ea3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768306068&amp;x-signature=0pmP4QWnRyMRiQJ6pBGTdaFmA38%3D" alt="" loading="lazy"/></p>
<p>首页专门有一个企业 CTA 的模块，我觉得写的特别好。这基本上是给企业老板看的，直接清晰地测算出 ROI：17x。这是个震撼的数字。</p>
<p>然后直观地给出雇佣成本：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn><mo separator="true">,</mo><mn>000</mn><mi>p</mi><mi>e</mi><mi>r</mi><mi>e</mi><mi>m</mi><mi>p</mi><mi>l</mi><mi>o</mi><mi>y</mi><mi>e</mi><mi>e</mi><mi>p</mi><mi>e</mi><mi>r</mi><mi>y</mi><mi>e</mi><mi>a</mi><mi>r</mi><mtext>，如果</mtext><mn>200</mn><mtext>个员工，就是</mtext></mrow><annotation encoding="application/x-tex">5,000 per employee per year，如果 200 个员工，就是</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord">5</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">000</span><span class="mord mathnormal">p</span><span class="mord mathnormal">ere</span><span class="mord mathnormal">m</span><span class="mord mathnormal" style="margin-right:0.01968em;">pl</span><span class="mord mathnormal">oyee</span><span class="mord mathnormal">p</span><span class="mord mathnormal">erye</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord cjk_fallback">，如果</span><span class="mord">200</span><span class="mord cjk_fallback">个员工，就是</span></span></span></span></span>1,000,000 / 年。</p>
<p>建议如果做 ToB 业务的创业者的可以参考学习。</p>
<hr/>
<h2 data-id="heading-9">11 为什么能稳 16 年：老产品的积累与 AI 转型窗口</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae693922123149eb8e4708ae7f42904f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768306068&amp;x-signature=0HFh90dSC8IaUrdYRAfn4aBeIaQ%3D" alt="" loading="lazy"/></p>
<p>在 About 页面可以看到他们的创业故事，这家公司做的很早，2009 年开始由 4 个人初创，最初就是为学生群体提供语法和拼写纠正服务。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/270ea51027c94b02869ad975a246b15c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768306068&amp;x-signature=BL7prM1pAx0XH%2BqZLFXg1FXiWDA%3D" alt="" loading="lazy"/></p>
<p>在 2015 年的时候，已经做到了百万的 DAU，这有深厚的基础的，然后在 2023 年的时候全面转型 AI，可以说是非常成功了。</p>
<hr/>
<h2 data-id="heading-10">12 内页矩阵：工具页 + 教程页承接长尾，把流量吃干榨尽</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9854cc1af7ea4dea8932aba0f8130420~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768306068&amp;x-signature=g8ObGWvXEUbU3zM8php5AUIcLUw%3D" alt="" loading="lazy"/></p>
<p>我们看 Grammarly 的内页架构，实际上就会发现这么多年来，它的资产已经积累的非常丰富，基本上你能想象的可以扩展的端都支持了，研发实力也比较强。</p>
<p>它对 SEO 也做过一些优化，为一些词条专门做了内页，也做了很多工具来承接。我们根据 SImilarWeb 挑几个流量靠前的内页稍微展开看看：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56e33c6036d144009fab8898a0d2ba00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768306068&amp;x-signature=Lp6yv3d%2FTN%2BNJfFLcNvodVzULEk%3D" alt="" loading="lazy"/></p>
<p>付费前 5 个页面，分别对应的是 ai detector、translate、humanize ai、word counter、Plagiarism Checker 这 5 个词，基本上和我们分析贡献最高的关键词是吻合的。</p>
<p>承载页面上，ai detector 是可以免费试用的，工具在首屏，我认为 Grammarly 是考虑了这个词的竞争激烈程度，所以把体验做的比较好：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65e5d55ad1ba471c8d3355455a9f8808~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768306068&amp;x-signature=x9RwUWWfwGmcyrTcI4KX5N9X%2BD0%3D" alt="" loading="lazy"/></p>
<p>如果仔细看，会发现这个词专门做了 SEO 优化，写了很多教程博客，去承接相关的长尾词：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc3132f14c254f32b563172772ee3f47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768306068&amp;x-signature=J4FnT6kGm9HaOh5iTDa4XbMLL6g%3D" alt="" loading="lazy"/></p>
<p>其他几个工具页面也是同样的套路，我就不展开分析了，大家可以仔细去看。</p>
<hr/>
<h2 data-id="heading-11">13 一个反例：Translate 页没把工具露出，体验与转化都吃亏</h2>
<p>这里面唯独 translate 页面，没有将工具放在首屏：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/327207b951a74d35aa17ccffda161c36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768306068&amp;x-signature=V2016HFimmCmLd%2B24Bk3zfXBFOs%3D" alt="" loading="lazy"/></p>
<p>我认为这个工具在 Grammarly 里面是完全没有优势的，工具没有外显，整个自然搜索只能排到内页的 33 名：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78fcf96d1801498c827bc6dad37e026b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768306068&amp;x-signature=mEAttVDgGikPDE4u8J19obefolc%3D" alt="" loading="lazy"/></p>
<p>Grammarly 给这个页面投流我认为不是很明智，<strong>我们做工具页，最佳的方式还是把工具漏出在首屏。</strong></p>
<hr/>
<h2 data-id="heading-12">14 可直接抄作业的 10 个要点</h2>
<ol>
<li>
<p>TDH 三句话写清定位：一句功能 + 一句场景 + 一句情绪价值。</p>
</li>
<li>
<p>产品形态尽量“无处不在”：插件/客户端/网页，覆盖高频写作场景。</p>
</li>
<li>
<p>流量结构里 Direct 越高，说明品牌心智越强、复购越稳。</p>
</li>
<li>
<p>关键词别只盯“AI 写作”这种泛词，优先做高意图词：检测/查重/改写/人类化。</p>
</li>
<li>
<p>PPC 不是随便买：高意图词 + 专属落地页，才是可复制的投放打法。</p>
</li>
<li>
<p>个体创业者避开正面买量战场，用长尾词 + 更强体验去绕。</p>
</li>
<li>
<p>订阅默认年付 + 月付锚点，是拉高 LTV 的经典组合拳。</p>
</li>
<li>
<p>ToB 页面少讲功能，多讲 ROI，把账算清楚。</p>
</li>
<li>
<p>工具页首屏先放工具，再用内容与 FAQ 承接长尾与信任。</p>
</li>
<li>
<p>老产品要活下去，关键是在范式变化时快速转型，并用新需求词扩盘。</p>
</li>
</ol>
<p>今天的产品洞察就到这里。SimilarWeb 上还有一批相似站点非常值得分析，我把它留作作业：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8b3cdea7cfe49b29c769075ea2dd6d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768306068&amp;x-signature=%2Fp8gtyYPoauuc6Qw7W54BhQHegY%3D" alt="" loading="lazy"/></p>
<p><strong>用同一套框架拆一遍</strong>——你会发现机会其实比想象中多。</p>
<p>我们下期再见！</p>
<hr/>
<p>🚀 想要与更多AI爱好者交流，共同成长吗？</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FZ4k_5_waWJbRRo5lZBZmog" target="_blank" title="https://mp.weixin.qq.com/s/Z4k_5_waWJbRRo5lZBZmog" ref="nofollow noopener noreferrer">和一群志同道合的人，持续精进 AI 的每一天</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[this调用会导致事务失效？]]></title>    <link>https://juejin.cn/post/7592119218029559842</link>    <guid>https://juejin.cn/post/7592119218029559842</guid>    <pubDate>2026-01-06T12:13:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592119218029559842" data-draft-id="7591350620189343750" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="this调用会导致事务失效？"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2026-01-06T12:13:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="提前退休的java猿"/> <meta itemprop="url" content="https://juejin.cn/user/465848660928872"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            this调用会导致事务失效？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/465848660928872/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    提前退休的java猿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T12:13:02.000Z" title="Tue Jan 06 2026 12:13:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>前一两周，公司的业务出了重大问题。数据库的服务器<code>CPU 100%</code>然后一些重要的抽奖业务竟然出现物品超领的情况。</p>
<p>同事的反馈就是 一个事务里面 只执行了后半部分，也就是领取记录插入（<code>B操作</code>）成功了，库存扣减（<code>A操作</code>）是没有问题的。</p>
<p><strong>核心代码如下（大家看一下事务是否失效🤶）：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//----------------------------------------controller代码---------------------------------------</span>
<span class="hljs-meta">@RedisRateLimiter(value = 100,limit = 1)</span>
<span class="hljs-meta">@PostMapping(value = "/grabCoupon")</span>
<span class="hljs-keyword">public</span> Res&lt;?&gt; equityClaim(<span class="hljs-meta">@RequestBody</span> GrabCouponReqEx req) {
    .........service 使用<span class="hljs-meta">@Resource</span> 注入..... 
    <span class="hljs-keyword">return</span> service.grabCouponTrans(req);
}
    
    
---------------------------------------service impl代码----------------------------------------
<span class="hljs-meta">@Transactional(rollbackFor = RuntimeException.class)</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> Result&lt;?&gt; grabCouponTrans(GrabCouponReqEx req) {
       <span class="hljs-comment">// 对所有代码进行 try，然后抛出RuntimException 让框架回滚</span>
       <span class="hljs-keyword">try</span>{
       .............................
        <span class="hljs-comment">//✅ A操作：库存扣减，这个地方对库存-1，如果更新行数大与0返回true </span>
        <span class="hljs-comment">//UPDATE t SET num =  num -1  WHERE id = #{id} AND num &gt; 0;</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isok</span> <span class="hljs-operator">=</span> reduceInventory(id);
        <span class="hljs-keyword">if</span> (isok) {
            <span class="hljs-comment">// ✅B操作：插入领取记录，插入成功返回 true</span>
            <span class="hljs-type">Boolean</span> <span class="hljs-variable">insetSuc</span> <span class="hljs-operator">=</span> insertRecord(record);
            <span class="hljs-keyword">if</span> (!insetSuc) {
               <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"领取失败！"</span>);
            }
            <span class="hljs-keyword">return</span> result;
        } 
    }<span class="hljs-keyword">catch</span> (Exception e){
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"xxxx"</span>);
    }
}
</code></pre>
<p>🧔：很多网友都说this调用了<code>reduceInventory、insertRecord</code>方法事物不会生效</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c4464aa6bbe42da89307602f692718f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o-Q5YmN6YCA5LyR55qEamF2YeeMvw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768307610&amp;x-signature=iqvrDRFoGWQt29zIg%2FluC4BPsEM%3D" alt="e9415f300e26bac81e2e9599d1a096a4.jpg" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d730201350a46ca8a0fbb5e9c9efb5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o-Q5YmN6YCA5LyR55qEamF2YeeMvw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768307610&amp;x-signature=ZHUAu5sFsHJqv3MNSXT1Fi3NRyk%3D" alt="a9753e917f19a33cfe906f84c83b2110.jpg" loading="lazy"/></p>
<blockquote>
<p>✔这种理解肯定是不对的，this调用的外层方法是加了事物注解，并且是@Resource注入调用，是能被代理的。外层方法都被拦截了代理了，方法内部再this调用也是没有问题的，默认就加入当前事务了，如果内部方法通过容器对象获取，并且有事物注解这时候就是看事物的传播机制了。</p>
</blockquote>
<h2 data-id="heading-1">事务源码分析</h2>
<p>下面就是事务拦截器主要的代码逻辑 <code>TransactionAspectSupport.invokeWithinTransaction</code>:</p>
<ul>
<li>创建或获取事务</li>
<li>执行业务方法</li>
<li>捕捉异常：有异常处理回滚、没有匹配到回滚异常则提交事务</li>
<li>清理事务信息</li>
<li>提交事务</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">invokeWithinTransaction</span><span class="hljs-params">(Method method, <span class="hljs-meta">@Nullable</span> Class&lt;?&gt; targetClass,
       <span class="hljs-keyword">final</span> InvocationCallback invocation)</span> <span class="hljs-keyword">throws</span> Throwable {

    <span class="hljs-comment">// If the transaction attribute is null, the method is non-transactional.</span>
    <span class="hljs-type">TransactionAttributeSource</span> <span class="hljs-variable">tas</span> <span class="hljs-operator">=</span> getTransactionAttributeSource();
    <span class="hljs-keyword">final</span> <span class="hljs-type">TransactionAttribute</span> <span class="hljs-variable">txAttr</span> <span class="hljs-operator">=</span> (tas != <span class="hljs-literal">null</span> ? tas.getTransactionAttribute(method, targetClass) : <span class="hljs-literal">null</span>);
    <span class="hljs-keyword">final</span> <span class="hljs-type">TransactionManager</span> <span class="hljs-variable">tm</span> <span class="hljs-operator">=</span> determineTransactionManager(txAttr);
    
    <span class="hljs-comment">// 处理响应式事务（Spring 5.2+）</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.reactiveAdapterRegistry != <span class="hljs-literal">null</span> &amp;&amp; tm <span class="hljs-keyword">instanceof</span> ReactiveTransactionManager) {
       ............................
       <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-type">PlatformTransactionManager</span> <span class="hljs-variable">ptm</span> <span class="hljs-operator">=</span> asPlatformTransactionManager(tm);
    <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">joinpointIdentification</span> <span class="hljs-operator">=</span> methodIdentification(method, targetClass, txAttr);

    <span class="hljs-keyword">if</span> (txAttr == <span class="hljs-literal">null</span> || !(ptm <span class="hljs-keyword">instanceof</span> CallbackPreferringPlatformTransactionManager)) {
        
       <span class="hljs-comment">// ✅关键步骤1：创建或获取事务（创建新事务还是沿用使用就看传播机制了）</span>
       <span class="hljs-comment">// Standard transaction demarcation with getTransaction and commit/rollback calls.</span>
       <span class="hljs-type">TransactionInfo</span> <span class="hljs-variable">txInfo</span> <span class="hljs-operator">=</span> createTransactionIfNecessary(ptm, txAttr, joinpointIdentification);

       Object retVal;
       <span class="hljs-keyword">try</span> {
          <span class="hljs-comment">// ✅关键步骤2：执行业务方法（AOP链的下一个拦截器或目标方法） </span>
          (执行目标方法：内部调用的方法使用<span class="hljs-built_in">this</span>指向默认也是被拦截的，
          如果有事务注解并且通过容器对象调用，执行的时候就会再次被拦截，此时事务的传播机制的作用就体现出来了)
          <span class="hljs-comment">// This is an around advice: Invoke the next interceptor in the chain.</span>
          <span class="hljs-comment">// This will normally result in a target object being invoked.</span>
          retVal = invocation.proceedWithInvocation();
       }
       <span class="hljs-keyword">catch</span> (Throwable ex) {
          <span class="hljs-comment">// ✅关键步骤3：异常处理回滚</span>
          <span class="hljs-comment">// target invocation exception</span>
          completeTransactionAfterThrowing(txInfo, ex);
          <span class="hljs-keyword">throw</span> ex;
       }
       <span class="hljs-keyword">finally</span> {
          <span class="hljs-comment">//✅关键步骤4：清理事务信息</span>
          cleanupTransactionInfo(txInfo);
       }

       <span class="hljs-keyword">if</span> (retVal != <span class="hljs-literal">null</span> &amp;&amp; vavrPresent &amp;&amp; VavrDelegate.isVavrTry(retVal)) {
          <span class="hljs-comment">// Set rollback-only in case of Vavr failure matching our rollback rules...</span>
          <span class="hljs-type">TransactionStatus</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> txInfo.getTransactionStatus();
          <span class="hljs-keyword">if</span> (status != <span class="hljs-literal">null</span> &amp;&amp; txAttr != <span class="hljs-literal">null</span>) {
             retVal = VavrDelegate.evaluateTryFailure(retVal, txAttr, status);
          }
       }
       <span class="hljs-comment">// ✅关键步骤5：提交事务</span>
       commitTransactionAfterReturning(txInfo);
       <span class="hljs-keyword">return</span> retVal;
    }

    <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">//**JTA（Java Transaction API）**  或需要回调机制的事务管理器</span>
      <span class="hljs-comment">//...........................................................</span>
    }
}
</code></pre>
<h3 data-id="heading-2">一、创建获取事务</h3>
<p>创建事务信息<code>createTransactionIfNecessary</code>，如果之前已经存在事务就走需要判断事务的传播机制了</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> TransactionInfo <span class="hljs-title function_">createTransactionIfNecessary</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> PlatformTransactionManager tm,
        <span class="hljs-meta">@Nullable</span> TransactionAttribute txAttr, <span class="hljs-keyword">final</span> String joinpointIdentification)</span> {
    
    <span class="hljs-comment">// 如果没有指定名称，使用方法标识作为事务名称</span>
    <span class="hljs-keyword">if</span> (txAttr != <span class="hljs-literal">null</span> &amp;&amp; txAttr.getName() == <span class="hljs-literal">null</span>) {
        txAttr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DelegatingTransactionAttribute</span>(txAttr) {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> {
                <span class="hljs-keyword">return</span> joinpointIdentification;
            }
        };
    }
    
    <span class="hljs-type">TransactionStatus</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">if</span> (txAttr != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// ✅关键：根据传播行为获取事务状态</span>
        <span class="hljs-keyword">if</span> (tm != <span class="hljs-literal">null</span>) {
            status = tm.getTransaction(txAttr);  <span class="hljs-comment">// 这里处理PROPAGATION_REQUIRED等</span>
        }
        <span class="hljs-comment">// ...</span>
    }
    
    <span class="hljs-comment">// ✅准备事务信息</span>
    <span class="hljs-keyword">return</span> prepareTransactionInfo(tm, txAttr, joinpointIdentification, status);
}
</code></pre>
<p>这是核心中的核心，在 <code>AbstractPlatformTransactionManager.getTransaction()</code> 中：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> TransactionStatus <span class="hljs-title function_">getTransaction</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> TransactionDefinition definition)</span> <span class="hljs-keyword">throws</span> TransactionException {
    <span class="hljs-comment">// 1. 获取事务定义</span>
    <span class="hljs-type">TransactionDefinition</span> <span class="hljs-variable">def</span> <span class="hljs-operator">=</span> (definition != <span class="hljs-literal">null</span> ? definition : TransactionDefinition.withDefaults());
    
    <span class="hljs-comment">// 2. 获取现有事务（处理传播行为）</span>
    <span class="hljs-type">Object</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> doGetTransaction();
    
    <span class="hljs-comment">// 3. 检查当前是否存在事务</span>
    <span class="hljs-keyword">if</span> (isExistingTransaction(transaction)) {
        <span class="hljs-comment">// 已存在事务：根据传播行为处理</span>
        <span class="hljs-keyword">return</span> handleExistingTransaction(def, transaction, debugEnabled);
    }
    
    <span class="hljs-comment">// 4. 没有现有事务：检查超时等设置</span>
    <span class="hljs-keyword">if</span> (def.getTimeout() &lt; TransactionDefinition.TIMEOUT_DEFAULT) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidTimeoutException</span>(<span class="hljs-string">"Invalid transaction timeout"</span>, def.getTimeout());
    }
    
    <span class="hljs-comment">// 5. 需要新事务：PROPAGATION_REQUIRED, PROPAGATION_REQUIRES_NEW, PROPAGATION_NESTED</span>
    <span class="hljs-keyword">if</span> (def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_MANDATORY) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalTransactionStateException</span>(<span class="hljs-string">"No existing transaction found for transaction marked with propagation 'mandatory'"</span>);
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRED ||
             def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRES_NEW ||
             def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NESTED) {
        
        <span class="hljs-comment">// 挂起现有资源（如果有）</span>
        <span class="hljs-type">SuspendedResourcesHolder</span> <span class="hljs-variable">suspendedResources</span> <span class="hljs-operator">=</span> suspend(<span class="hljs-literal">null</span>);
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">boolean</span> <span class="hljs-variable">newSynchronization</span> <span class="hljs-operator">=</span> (getTransactionSynchronization() != SYNCHRONIZATION_NEVER);
            <span class="hljs-type">DefaultTransactionStatus</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> newTransactionStatus(
                def, transaction, <span class="hljs-literal">true</span>, newSynchronization, debugEnabled, suspendedResources);
            
            <span class="hljs-comment">// 关键：开始新事务</span>
            doBegin(transaction, def);
            prepareSynchronization(status, def);
            <span class="hljs-keyword">return</span> status;
        }
        <span class="hljs-keyword">catch</span> (RuntimeException | Error ex) {
            resume(<span class="hljs-literal">null</span>, suspendedResources);
            <span class="hljs-keyword">throw</span> ex;
        }
    }
    <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 6. 空事务：PROPAGATION_SUPPORTS, PROPAGATION_NOT_SUPPORTED, PROPAGATION_NEVER</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">newSynchronization</span> <span class="hljs-operator">=</span> (getTransactionSynchronization() == SYNCHRONIZATION_ALWAYS);
        <span class="hljs-keyword">return</span> prepareTransactionStatus(def, <span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>, newSynchronization, debugEnabled, <span class="hljs-literal">null</span>);
    }
}
</code></pre>
<h3 data-id="heading-3">二、异常回滚</h3>
<p>执行回滚 ： 匹配指定设置的异常，匹配不到就匹配 RuntimeException 或 Error</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">completeTransactionAfterThrowing</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> TransactionInfo txInfo, Throwable ex)</span> {
    <span class="hljs-keyword">if</span> (txInfo != <span class="hljs-literal">null</span> &amp;&amp; txInfo.getTransactionStatus() != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 关键：根据回滚规则决定是否回滚</span>
        <span class="hljs-keyword">if</span> (txInfo.transactionAttribute != <span class="hljs-literal">null</span> &amp;&amp; txInfo.transactionAttribute.rollbackOn(ex)) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 执行回滚 ： 匹配指定设置的异常，匹配不到就匹配 RuntimeException 或 Error</span>
                txInfo.getTransactionManager().rollback(txInfo.getTransactionStatus());
            }
            <span class="hljs-keyword">catch</span> (TransactionSystemException ex2) {
                <span class="hljs-comment">// 记录错误但不抛出</span>
                logger.error(<span class="hljs-string">"Application exception overridden by rollback exception"</span>, ex);
                ex2.initApplicationException(ex);
                <span class="hljs-keyword">throw</span> ex2;
            }
            <span class="hljs-keyword">catch</span> (RuntimeException | Error ex2) {
                logger.error(<span class="hljs-string">"Application exception overridden by rollback exception"</span>, ex);
                <span class="hljs-keyword">throw</span> ex2;
            }
        }
        <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 不满足回滚条件，提交事务</span>
            <span class="hljs-keyword">try</span> {
                txInfo.getTransactionManager().commit(txInfo.getTransactionStatus());
            }
            <span class="hljs-keyword">catch</span> (TransactionSystemException ex2) {
                <span class="hljs-comment">// ... 异常处理</span>
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-4">三、为什么清理事务信息后才提交事务</h3>
<p>在标准事务分支执行逻辑如下，没有发生异常的情况就是先清理事务信息然后提交事务：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">try</span> {
    retVal = invocation.proceedWithInvocation();  <span class="hljs-comment">// 执行业务方法</span>
}
<span class="hljs-keyword">catch</span> (Throwable ex) {
    completeTransactionAfterThrowing(txInfo, ex);  <span class="hljs-comment">// 异常回滚</span>
    <span class="hljs-keyword">throw</span> ex;
}
<span class="hljs-keyword">finally</span> {
    cleanupTransactionInfo(txInfo);  <span class="hljs-comment">// 清理事务信息</span>
}

commitTransactionAfterReturning(txInfo);  <span class="hljs-comment">// 提交事务</span>
</code></pre>
<h4 data-id="heading-5">1.事务信息与事务状态分离</h4>
<p>首先理解两个关键概念：</p>
<ul>
<li><strong>TransactionInfo</strong>：线程绑定的事务上下文信息</li>
<li><strong>TransactionStatus</strong>：实际的事务状态（包含数据库连接、回滚标记等）</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionInfo</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PlatformTransactionManager transactionManager;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> TransactionAttribute transactionAttribute;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String joinpointIdentification;
    <span class="hljs-keyword">private</span> TransactionStatus transactionStatus;  <span class="hljs-comment">// 实际事务状态</span>
    <span class="hljs-keyword">private</span> TransactionInfo oldTransactionInfo;   <span class="hljs-comment">// 旧的事务信息（用于嵌套事务）</span>
}
</code></pre>
<p><strong>关键点</strong>：提交事务需要的是 <code>TransactionStatus</code>，而不是 <code>TransactionInfo</code>。清理的是线程绑定的上下文信息，而不是实际的事务状态。</p>
<h4 data-id="heading-6">2. cleanupTransactionInfo 实际做了什么？</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cleanupTransactionInfo</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> TransactionInfo txInfo)</span> {
    <span class="hljs-keyword">if</span> (txInfo != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 恢复线程的事务状态到之前的状态</span>
        txInfo.restoreThreadLocalStatus();
    }
}

<span class="hljs-comment">// TransactionInfo.restoreThreadLocalStatus()</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">restoreThreadLocalStatus</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 将线程绑定恢复到旧的事务信息（如果有的话）</span>
    TransactionSynchronizationManager.bindResource(
        <span class="hljs-built_in">this</span>.transactionManager, <span class="hljs-built_in">this</span>.oldTransactionInfo);
}
</code></pre>
<p><strong>重点</strong>：<code>cleanupTransactionInfo</code> 只是恢复线程的 ThreadLocal 状态，<strong>并不影响实际事务的连接和状态</strong>。</p>
<h4 data-id="heading-7">3. 详细执行时序分析</h4>
<p>可以看一下面事务嵌套的案例</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">methodA</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 事务A开始</span>
        userRepository.updateA();
        
        <span class="hljs-comment">// 调用 methodB（REQUIRES_NEW）</span>
        userServiceProxy.methodB();  <span class="hljs-comment">// 通过代理调用</span>
        
        <span class="hljs-comment">// 事务A继续</span>
        userRepository.updateA2();
    }
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">methodB</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 事务B开始（挂起事务A）</span>
        logRepository.save();
        <span class="hljs-comment">// 事务B提交</span>
    }
}
</code></pre>
<p><strong>执行时序：</strong> 大概的逻辑就是，执行完一个事务就需要立即把当前事务方法的外层方法的事务给恢复（存在的话）。</p>
<pre><code class="hljs language-text" lang="text">时间轴：
│
├─ 进入 methodA()
│   ├─ 创建 TransactionInfo_A（绑定到 ThreadLocal）
│   ├─ 开始事务A
│   │
│   ├─ 调用 methodB()（通过代理）
│   │   ├─ 创建 TransactionInfo_B（绑定到 ThreadLocal，保存旧的 TransactionInfo_A）
│   │   ├─ 挂起事务A
│   │   ├─ 开始事务B
│   │   ├─ 执行业务逻辑
│   │   │
│   │   ├─ 清理阶段：
│   │   │   ├─ cleanupTransactionInfo(TransactionInfo_B) 
│   │   │   │   └─ 恢复 ThreadLocal 到 TransactionInfo_A ✓
│   │   │   │
│   │   │   ├─ 提交事务B ✓
│   │   │   │   └─ 需要事务B的 TransactionStatus，但不需要 ThreadLocal 的 TransactionInfo_B
│   │   │   │
│   │   │   └─ 恢复事务A
│   │   └─ 返回
│   │
│   └─ methodA 继续执行
│       ├─ 使用 TransactionInfo_A（已恢复）
│       ├─ 提交事务A
│       └─ 清理 TransactionInfo_A
└─ 结束
</code></pre>
<h4 data-id="heading-8">4. 提交事务不需要 ThreadLocal 绑定</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// AbstractPlatformTransactionManager.commit()</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">commit</span><span class="hljs-params">(TransactionStatus status)</span> <span class="hljs-keyword">throws</span> TransactionException {
    <span class="hljs-comment">// 直接从 TransactionStatus 获取实际事务对象</span>
    <span class="hljs-type">DefaultTransactionStatus</span> <span class="hljs-variable">defStatus</span> <span class="hljs-operator">=</span> (DefaultTransactionStatus) status;
    
    <span class="hljs-comment">// 检查是否需要回滚</span>
    <span class="hljs-keyword">if</span> (defStatus.isLocalRollbackOnly() || defStatus.isGlobalRollbackOnly()) {
        processRollback(defStatus, <span class="hljs-literal">false</span>);
        <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// 实际提交</span>
    processCommit(defStatus);
}

<span class="hljs-comment">// DataSourceTransactionManager.doCommit()</span>
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doCommit</span><span class="hljs-params">(DefaultTransactionStatus status)</span> {
    <span class="hljs-type">DataSourceTransactionObject</span> <span class="hljs-variable">txObject</span> <span class="hljs-operator">=</span> (DataSourceTransactionObject) status.getTransaction();
    <span class="hljs-type">Connection</span> <span class="hljs-variable">con</span> <span class="hljs-operator">=</span> txObject.getConnectionHolder().getConnection();
    
    <span class="hljs-comment">// 直接使用连接提交</span>
    con.commit();  <span class="hljs-comment">// 不需要 ThreadLocal 信息</span>
}
</code></pre>
<p><strong>关键</strong>：提交操作只需要：</p>
<ol>
<li>数据库连接（从 TransactionStatus 获取）</li>
<li>事务状态（是否标记为回滚）</li>
</ol>
<blockquote>
<p>❗明白事务传播机制以及事务的相关信息是绑定到ThreadLocal中之后，用异步的时候就要注意事务失效的问题了</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（25）Hibernate的批量操作是什么？]]></title>    <link>https://juejin.cn/post/7592069113222021139</link>    <guid>https://juejin.cn/post/7592069113222021139</guid>    <pubDate>2026-01-06T12:16:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592069113222021139" data-draft-id="7592069113222004755" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（25）Hibernate的批量操作是什么？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-06T12:16:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（25）Hibernate的批量操作是什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T12:16:12.000Z" title="Tue Jan 06 2026 12:16:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">Hibernate的批量操作</h3>
<p>Hibernate的批量操作是指对大量数据进行插入、更新或删除时，通过减少SQL语句的数量和数据库的交互次数来提高性能的一种操作方式。批量操作可以显著提高大型数据处理任务的性能，特别是在处理成百上千条记录的时候。</p>
<h4 data-id="heading-1">主要优化点</h4>
<ol>
<li><strong>JDBC批量操作</strong>：减少每次操作提交到数据库的SQL数量。</li>
<li><strong>Session的管理</strong>：避免一次性加载过多对象到内存，导致内存溢出。</li>
<li><strong>使用级联操作（Cascade）</strong>：可以批量操作关联的实体。</li>
</ol>
<h3 data-id="heading-2">实现步骤</h3>
<ol>
<li><strong>配置Hibernate</strong>。</li>
<li><strong>创建实体类</strong>。</li>
<li><strong>实现批量操作方法</strong>。</li>
</ol>
<h3 data-id="heading-3">示例代码</h3>
<h4 data-id="heading-4">配置文件 <code>hibernate.cfg.xml</code></h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">hibernate-configuration</span> <span class="hljs-keyword">PUBLIC</span>
        <span class="hljs-string">"-//Hibernate/Hibernate Configuration DTD 3.0//EN"</span>
        <span class="hljs-string">"http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 数据库连接配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.driver_class"</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.url"</span>&gt;</span>jdbc:mysql://localhost:3306/your_database<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.username"</span>&gt;</span>your_username<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.password"</span>&gt;</span>your_password<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- Hibernate 属性配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.show_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.format_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.hbm2ddl.auto"</span>&gt;</span>update<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 批量操作配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.jdbc.batch_size"</span>&gt;</span>50<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.order_inserts"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.order_updates"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 映射类 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Person"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h4 data-id="heading-5">实体类 <code>Person</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.domain;

<span class="hljs-keyword">import</span> javax.persistence.*;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "person")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {

    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Column(name = "name")</span>
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-meta">@Column(name = "age")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">()</span> {}

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age)</span> {
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-built_in">this</span>.age = age;
    }

    <span class="hljs-comment">// getters 和 setters</span>
    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> name;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-built_in">this</span>.name = name;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> age;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> {
        <span class="hljs-built_in">this</span>.age = age;
    }
}
</code></pre>
<h3 data-id="heading-6">使用Hibernate进行批量操作</h3>
<h5 data-id="heading-7">HibernateUtil类</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateUtil</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 从配置文件创建SessionFactory</span>
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            <span class="hljs-comment">// 记录启动失败的错误</span>
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title function_">getSessionFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sessionFactory;
    }
}
</code></pre>
<h4 data-id="heading-8">批量插入操作示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;

<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateBatchInsertExample</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">BATCH_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">50</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 获取SessionFactory</span>
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> HibernateUtil.getSessionFactory();

        <span class="hljs-comment">// 批量插入数据</span>
        batchInsertPersons(sessionFactory);

        <span class="hljs-comment">// 关闭SessionFactory</span>
        sessionFactory.close();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchInsertPersons</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            List&lt;Person&gt; persons = createPersons(<span class="hljs-number">1000</span>);

            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; persons.size(); i++) {
                session.save(persons.get(i));
                <span class="hljs-keyword">if</span> (i % BATCH_SIZE == <span class="hljs-number">0</span> &amp;&amp; i &gt; <span class="hljs-number">0</span>) {
                    <span class="hljs-comment">// 批量插入，清理Session，防止内存溢出</span>
                    session.flush();
                    session.clear();
                }
            }

            transaction.commit();
            System.out.println(<span class="hljs-string">"Inserted "</span> + persons.size() + <span class="hljs-string">" Persons"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
                session.close();
            }
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> List&lt;Person&gt; <span class="hljs-title function_">createPersons</span><span class="hljs-params">(<span class="hljs-type">int</span> count)</span> {
        List&lt;Person&gt; persons = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; count; i++) {
            persons.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"Person "</span> + i, <span class="hljs-number">20</span> + (i % <span class="hljs-number">30</span>)));
        }
        <span class="hljs-keyword">return</span> persons;
    }
}
</code></pre>
<h4 data-id="heading-9">批量更新操作示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateBatchUpdateExample</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">BATCH_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">50</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 获取SessionFactory</span>
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> HibernateUtil.getSessionFactory();

        <span class="hljs-comment">// 批量更新数据</span>
        batchUpdatePersons(sessionFactory);

        <span class="hljs-comment">// 关闭SessionFactory</span>
        sessionFactory.close();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchUpdatePersons</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            List&lt;Person&gt; persons = session.createQuery(<span class="hljs-string">"FROM Person"</span>, Person.class).list();

            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; persons.size(); i++) {
                <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> persons.get(i);
                person.setAge(person.getAge() + <span class="hljs-number">1</span>);
                session.update(person);
                <span class="hljs-keyword">if</span> (i % BATCH_SIZE == <span class="hljs-number">0</span> &amp;&amp; i &gt; <span class="hljs-number">0</span>) {
                    <span class="hljs-comment">// 批量更新，清理Session，防止内存溢出</span>
                    session.flush();
                    session.clear();
                }
            }

            transaction.commit();
            System.out.println(<span class="hljs-string">"Updated "</span> + persons.size() + <span class="hljs-string">" Persons"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
                session.close();
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-10">批量删除操作示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateBatchDeleteExample</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">BATCH_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">50</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 获取SessionFactory</span>
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> HibernateUtil.getSessionFactory();

        <span class="hljs-comment">// 批量删除数据</span>
        batchDeletePersons(sessionFactory);

        <span class="hljs-comment">// 关闭SessionFactory</span>
        sessionFactory.close();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchDeletePersons</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            List&lt;Person&gt; persons = session.createQuery(<span class="hljs-string">"FROM Person"</span>, Person.class).list();

            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; persons.size(); i++) {
                session.delete(persons.get(i));
                <span class="hljs-keyword">if</span> (i % BATCH_SIZE == <span class="hljs-number">0</span> &amp;&amp; i &gt; <span class="hljs-number">0</span>) {
                    <span class="hljs-comment">// 批量删除，清理Session，防止内存溢出</span>
                    session.flush();
                    session.clear();
                }
            }

            transaction.commit();
            System.out.println(<span class="hljs-string">"Deleted "</span> + persons.size() + <span class="hljs-string">" Persons"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
                session.close();
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-11">详细解释</h3>
<ol>
<li>
<p><strong>配置文件 <code>hibernate.cfg.xml</code></strong>：定义数据库连接信息、Hibernate属性配置以及批量操作的配置。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.jdbc.batch_size"</span>&gt;</span>50<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.order_inserts"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.order_updates"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
</code></pre>
</li>
<li>
<p><strong>实体类 <code>Person</code></strong>：定义实体类及其属性。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "person")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
    <span class="hljs-comment">// 属性和方法</span>
}
</code></pre>
</li>
<li>
<p><strong>HibernateUtil类</strong>：创建并管理SessionFactory。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateUtil</span> {
    <span class="hljs-comment">// 创建SessionFactory的代码</span>
}
</code></pre>
</li>
<li>
<p><strong>批量插入、更新、删除操作类</strong>：演示了如何使用Hibernate进行批量插入、更新和删除操作。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateBatchInsertExample</span> {
    <span class="hljs-comment">// 插入方法</span>
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateBatchUpdateExample</span> {
    <span class="hljs-comment">// 更新方法</span>
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateBatchDeleteExample</span> {
    <span class="hljs-comment">// 删除方法</span>
}
</code></pre>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（26）什么是Hibernate的透明持久化？]]></title>    <link>https://juejin.cn/post/7591767753851912234</link>    <guid>https://juejin.cn/post/7591767753851912234</guid>    <pubDate>2026-01-06T12:17:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591767753851912234" data-draft-id="7592069113222037523" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（26）什么是Hibernate的透明持久化？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-06T12:17:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（26）什么是Hibernate的透明持久化？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T12:17:38.000Z" title="Tue Jan 06 2026 12:17:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">Hibernate的透明持久化</h3>
<p>透明持久化（Transparent Persistence）是Hibernate的重要特性之一。它指的是对象在内存中进行操作时，会自动被同步到数据库，无需显式调用持久化操作的方法。这种特性使得开发者可以专注于面向对象编程，而不必关心底层的数据库操作。</p>
<p>透明持久化通过Hibernate的Session管理，使得实体对象在持久化上下文中自动变为持久化状态。一旦对象变为持久化状态，Hibernate会自动检测对象的变化，并在事务提交时同步这些变化到数据库。</p>
<h3 data-id="heading-1">透明持久化的工作原理</h3>
<ol>
<li><strong>Session管理对象</strong>：在一个Session中管理实体对象，当对象被持久化（如通过<code>session.save()</code>或<code>session.persist()</code>方法），它就会进入持久化状态。</li>
<li><strong>自动脏检查</strong>：在<code>Session.flush()</code>或事务提交时，Hibernate会自动检测持久化对象的变化，并生成适当的SQL语句更新数据库。</li>
<li><strong>缓存机制</strong>：Hibernate会在Session的一级缓存中缓存持久化对象，以便在同一个Session中多次访问时提高性能。</li>
</ol>
<h3 data-id="heading-2">示例代码</h3>
<h4 data-id="heading-3">配置文件 <code>hibernate.cfg.xml</code></h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">hibernate-configuration</span> <span class="hljs-keyword">PUBLIC</span>
        <span class="hljs-string">"-//Hibernate/Hibernate Configuration DTD 3.0//EN"</span>
        <span class="hljs-string">"http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 数据库连接配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.driver_class"</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.url"</span>&gt;</span>jdbc:mysql://localhost:3306/your_database<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.username"</span>&gt;</span>your_username<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.password"</span>&gt;</span>your_password<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- Hibernate 属性配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.show_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.format_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.hbm2ddl.auto"</span>&gt;</span>update<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 映射类 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Person"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h4 data-id="heading-4">实体类 <code>Person</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.domain;

<span class="hljs-keyword">import</span> javax.persistence.*;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "person")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {

    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Column(name = "name")</span>
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-meta">@Column(name = "age")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">()</span> {}

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age)</span> {
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-built_in">this</span>.age = age;
    }

    <span class="hljs-comment">// getters 和 setters</span>
    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> name;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-built_in">this</span>.name = name;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> age;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> {
        <span class="hljs-built_in">this</span>.age = age;
    }
}
</code></pre>
<h3 data-id="heading-5">使用Hibernate进行透明持久化操作</h3>
<h5 data-id="heading-6">HibernateUtil类</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateUtil</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 从配置文件创建SessionFactory</span>
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            <span class="hljs-comment">// 记录启动失败的错误</span>
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title function_">getSessionFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sessionFactory;
    }
}
</code></pre>
<h4 data-id="heading-7">透明持久化操作示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateTransparentPersistenceExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 获取SessionFactory</span>
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> HibernateUtil.getSessionFactory();

        <span class="hljs-comment">// 插入数据</span>
        insertPerson(sessionFactory);

        <span class="hljs-comment">// 透明持久化示例</span>
        transparentPersistenceExample(sessionFactory);

        <span class="hljs-comment">// 关闭SessionFactory</span>
        sessionFactory.close();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertPerson</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"John Doe"</span>, <span class="hljs-number">30</span>);
            session.save(person);
            transaction.commit();
            System.out.println(<span class="hljs-string">"Inserted Person: "</span> + person.getName());
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
                session.close();
            }
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transparentPersistenceExample</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 获取Person实体</span>
            <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> session.get(Person.class, <span class="hljs-number">1L</span>);
            <span class="hljs-keyword">if</span> (person != <span class="hljs-literal">null</span>) {
                <span class="hljs-comment">// 修改Person实体字段</span>
                person.setName(<span class="hljs-string">"Jane Doe"</span>);
                person.setAge(<span class="hljs-number">25</span>);

                <span class="hljs-comment">// 此时无需显式调用session.update()或session.save()</span>
                <span class="hljs-comment">// Hibernate的透明持久化机制会自动检测到变化并更新数据库</span>

                transaction.commit();
                System.out.println(<span class="hljs-string">"Updated Person: "</span> + person.getName() + <span class="hljs-string">", Age: "</span> + person.getAge());
            } <span class="hljs-keyword">else</span> {
                System.out.println(<span class="hljs-string">"No Person found with ID 1"</span>);
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
                session.close();
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-8">详细解释</h3>
<ol>
<li>
<p><strong>配置文件 <code>hibernate.cfg.xml</code></strong>：定义数据库连接信息、Hibernate属性配置以及实体类映射配置。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Person"</span>/&gt;</span>
</code></pre>
</li>
<li>
<p><strong>实体类 <code>Person</code></strong>：定义实体类及其属性。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "person")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
    <span class="hljs-comment">// 属性和方法</span>
}
</code></pre>
</li>
<li>
<p><strong>HibernateUtil类</strong>：创建并管理SessionFactory。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateUtil</span> {
    <span class="hljs-comment">// 创建SessionFactory的代码</span>
}
</code></pre>
</li>
<li>
<p><strong>透明持久化操作示例</strong>：演示了如何使用Hibernate进行透明持久化操作。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateTransparentPersistenceExample</span> {
    <span class="hljs-comment">// 插入和透明持久化操作方法</span>
}
</code></pre>
</li>
<li>
<p><strong>透明持久化示例方法</strong>：通过修改持久化对象的字段，展示了Hibernate的透明持久化机制。无需显式调用<code>session.update()</code>或<code>session.save()</code>，Hibernate会自动检测并更新数据库。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transparentPersistenceExample</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
    <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
    <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 获取Person实体</span>
        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> session.get(Person.class, <span class="hljs-number">1L</span>);
        <span class="hljs-keyword">if</span> (person != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 修改Person实体字段</span>
            person.setName(<span class="hljs-string">"Jane Doe"</span>);
            person.setAge(<span class="hljs-number">25</span>);

            <span class="hljs-comment">// 此时无需显式调用session.update()或session.save()</span>
            <span class="hljs-comment">// Hibernate的透明持久化机制会自动检测到变化并更新数据库</span>

            transaction.commit();
            System.out.println(<span class="hljs-string">"Updated Person: "</span> + person.getName() + <span class="hljs-string">", Age: "</span> + person.getAge());
        } <span class="hljs-keyword">else</span> {
            System.out.println(<span class="hljs-string">"No Person found with ID 1"</span>);
        }
    } <span class="hljs-keyword">catch</span> (Exception e) {
        <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
            transaction.rollback();
        }
        e.printStackTrace();
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
            session.close();
        }
    }
}
</code></pre>
</li>
</ol>
<h3 data-id="heading-9">总结</h3>
<p>Hibernate的透明持久化特性使得开发者可以更专注于业务逻辑，而不必关心底层的数据库操作。这种特性通过Session管理实体对象，并在事务提交时自动同步对象的变化到数据库，从而简化了代码并提高了开发效率。通过上述示例代码，可以清晰地了解透明持久化的工作原理和实现方式。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[不再混淆：导数 (Derivative) 与微分 (Differential) 的本质对决]]></title>    <link>https://juejin.cn/post/7592069432227807241</link>    <guid>https://juejin.cn/post/7592069432227807241</guid>    <pubDate>2026-01-06T12:57:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592069432227807241" data-draft-id="7592058763986878510" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="不再混淆：导数 (Derivative) 与微分 (Differential) 的本质对决"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-06T12:57:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mwq30123"/> <meta itemprop="url" content="https://juejin.cn/user/3403743729030686"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            不再混淆：导数 (Derivative) 与微分 (Differential) 的本质对决
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3403743729030686/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mwq30123
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T12:57:35.000Z" title="Tue Jan 06 2026 12:57:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><hr/>
<h2 data-id="heading-0">不再混淆：导数 (Derivative) 与微分 (Differential) 的本质对决</h2>
<p>在微积分的入门阶段，很多同学会产生一种错觉：认为微分只是导数的另一种写法，或者觉得 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>d</mi><mi>y</mi></mrow><mrow><mi>d</mi><mi>x</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{dy}{dx}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2772em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9322em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">x</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.4461em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span> 只是一个不可分割的整体符号。</p>
<p>然而，当你深入到积分技巧、微分方程甚至多元微积分时，如果不能精准区分这两个概念，就会陷入认知的泥潭。今天，我们抛开繁琐的四则运算法则，直击“导数”与“微分”的灵魂差异。</p>
<hr/>
<h3 data-id="heading-1">1. 定义层面的“降维打击”</h3>
<p>简单来说，导数描述的是<strong>状态</strong>，而微分描述的是<strong>变化</strong>。</p>
<h4 data-id="heading-2">导数 (Derivative)：变化率</h4>
<p>导数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>f</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f'(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0019em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span> 本质上是一个比值（Ratio）的极限。</p>
<p>它回答的问题是：“在这个瞬间，函数变化得有多快？”</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>f</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mrow><mi>lim</mi><mo>⁡</mo></mrow><mrow><mi mathvariant="normal">Δ</mi><mi>x</mi><mo>→</mo><mn>0</mn></mrow></msub><mfrac><mrow><mi mathvariant="normal">Δ</mi><mi>y</mi></mrow><mrow><mi mathvariant="normal">Δ</mi><mi>x</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">f'(x) = \lim_{\Delta x \to 0} \frac{\Delta y}{\Delta x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0019em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.2694em;vertical-align:-0.345em;"/><span class="mop"><span class="mop">lim</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">Δ</span><span class="mord mathnormal mtight">x</span><span class="mrel mtight">→</span><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9244em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">Δ</span><span class="mord mathnormal mtight">x</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.4461em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">Δ</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></p>
<p>它是一个局部性质，描述的是曲线在某一点切线的斜率。</p>
<h4 data-id="heading-3">微分 (Differential)：线性增量</h4>
<p>微分 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">dy</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></span> 本质上是一个增量（Increment）。</p>
<p>它回答的问题是：“如果沿着切线方向走，函数值改变了多少？”</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>y</mi><mo>=</mo><msup><mi>f</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>⋅</mo><mi>d</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">dy = f'(x) \cdot dx</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.0019em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">d</span><span class="mord mathnormal">x</span></span></span></span></span></p>
<p>这里，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">dy</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></span> 是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Δ</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">\Delta y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord">Δ</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></span>（真实增量）的线性近似。</p>
<blockquote>
<p><strong>一句话总结：</strong> 导数是切线的<strong>斜率</strong>，微分是切线上的<strong>纵坐标增量</strong>。</p>
</blockquote>
<hr/>
<h3 data-id="heading-4">2. 几何图景：切线上的游戏</h3>
<p>这是区分两者最直观的方式。想象我们在函数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">y=f(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span> 上取一点 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(x, y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span></span>。</p>
<ul>
<li><strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Δ</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">\Delta x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">Δ</span><span class="mord mathnormal">x</span></span></span></span></span> 与 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">dx</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">d</span><span class="mord mathnormal">x</span></span></span></span></span></strong> ：通常我们规定自变量的增量等于自变量的微分，即 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Δ</mi><mi>x</mi><mo>=</mo><mi>d</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">\Delta x = dx</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">Δ</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">d</span><span class="mord mathnormal">x</span></span></span></span></span>。</li>
<li><strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Δ</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">\Delta y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord">Δ</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></span> (真实增量)</strong> ：这是当 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">x</span></span></span></span></span> 变化时，曲线实际升高的高度。</li>
<li><strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">dy</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></span> (微分)</strong> ：这是当 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">x</span></span></span></span></span> 变化时，<strong>切线</strong>升高的高度。</li>
</ul>
<p>当 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Δ</mi><mi>x</mi><mo>→</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\Delta x \to 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">Δ</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span> 时，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Δ</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">\Delta y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord">Δ</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">dy</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></span> 之间的差值是比 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Δ</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">\Delta x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">Δ</span><span class="mord mathnormal">x</span></span></span></span></span> 更高阶的无穷小（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi><mo stretchy="false">(</mo><mi mathvariant="normal">Δ</mi><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">o(\Delta x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">o</span><span class="mopen">(</span><span class="mord">Δ</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span>）。这意味着：**在微观局部，我们可以用简单的直线（微分）来代替复杂的曲线（函数增量）。**这就是微积分的核心思想——<strong>以直代曲</strong>。</p>
<hr/>
<h3 data-id="heading-5">3. 物理量纲：谁是速度，谁是距离？</h3>
<p>如果几何解释还不够硬核，我们可以通过**量纲分析（Dimensional Analysis）**彻底将两者分开。</p>
<p>假设 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></span> 代表路程（单位：米 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">m</span></span></span></span></span>），<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">x</span></span></span></span></span> 代表时间（单位：秒 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">s</span></span></span></span></span>）。</p>
<ul>
<li>
<p>导数的量纲：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>f</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mi>d</mi><mi>y</mi></mrow><mrow><mi>d</mi><mi>x</mi></mrow></mfrac><mo>≈</mo><mfrac><mi>m</mi><mi>s</mi></mfrac></mrow><annotation encoding="application/x-tex">f'(x) = \frac{dy}{dx} \approx \frac{m}{s}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0019em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.2772em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9322em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">x</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.4461em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.0404em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6954em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></p>
<p>导数的单位是 米/秒。它是速度，是一个强度量。</p>
</li>
<li>
<p>微分的量纲：</p>
<p>由 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>y</mi><mo>=</mo><msup><mi>f</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mi>d</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">dy = f'(x) dx</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.0019em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mord mathnormal">d</span><span class="mord mathnormal">x</span></span></span></span></span> 可知：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>y</mi><mo>=</mo><mo stretchy="false">(</mo><mtext>米</mtext><mi mathvariant="normal">/</mi><mtext>秒</mtext><mo stretchy="false">)</mo><mo>×</mo><mtext>秒</mtext><mo>=</mo><mtext>米</mtext></mrow><annotation encoding="application/x-tex">dy = (\text{米}/\text{秒}) \times \text{秒} = \text{米}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord text"><span class="mord cjk_fallback">米</span></span><span class="mord">/</span><span class="mord text"><span class="mord cjk_fallback">秒</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord text"><span class="mord cjk_fallback">秒</span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord text"><span class="mord cjk_fallback">米</span></span></span></span></span></span></p>
<p>微分的单位是 米。它是距离，是一个广延量。</p>
</li>
</ul>
<p><strong>结论</strong>：导数和微分在物理世界里根本就是不同维度的东西。一个是“快慢”，一个是“长短”。</p>
<hr/>
<h3 data-id="heading-6">4. 为什么我们需要微分？（形式不变性）</h3>
<p>很多初学者会问：“既然 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">dy</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></span> 就是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>y</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mi>d</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">y'dx</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9463em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mord mathnormal">d</span><span class="mord mathnormal">x</span></span></span></span></span>，为什么不直接用导数算了？为什么要发明微分这个概念？”</p>
<p>答案在于微分的<strong>一阶形式不变性</strong>。这是微分最强大的“特权”。</p>
<ul>
<li>
<p>对于导数：</p>
<p>如果我们引入中间变量 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi></mrow><annotation encoding="application/x-tex">u</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">u</span></span></span></span></span>，求导需要使用链式法则，形式会发生改变：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>d</mi><mi>y</mi></mrow><mrow><mi>d</mi><mi>x</mi></mrow></mfrac><mo>=</mo><mfrac><mrow><mi>d</mi><mi>y</mi></mrow><mrow><mi>d</mi><mi>u</mi></mrow></mfrac><mo>⋅</mo><mfrac><mrow><mi>d</mi><mi>u</mi></mrow><mrow><mi>d</mi><mi>x</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{dy}{dx} = \frac{dy}{du} \cdot \frac{du}{dx}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2772em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9322em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">x</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.4461em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.2772em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9322em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">u</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.4461em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.2251em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">x</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">u</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></p>
<p>你必须时刻警惕你是对谁求导。</p>
</li>
<li>
<p>对于微分：</p>
<p>无论 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi></mrow><annotation encoding="application/x-tex">u</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">u</span></span></span></span></span> 是自变量还是中间变量，微分的形式永远保持一致：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>y</mi><mo>=</mo><msup><mi>f</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">(</mo><mi>u</mi><mo stretchy="false">)</mo><mi>d</mi><mi>u</mi></mrow><annotation encoding="application/x-tex">dy = f'(u)du</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.0019em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">u</span><span class="mclose">)</span><span class="mord mathnormal">d</span><span class="mord mathnormal">u</span></span></span></span></span></p>
</li>
</ul>
<p>这种<strong>形式上的自由</strong>，使得我们在处理<strong>不定积分（凑微分法）<strong>和</strong>微分方程</strong>时，可以像处理代数符号一样自由地“拆分”和“移动” <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">dx</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">d</span><span class="mord mathnormal">x</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">dy</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></span>。这就是为什么在积分符号 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>∫</mo><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mi>d</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">\int f(x) dx</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1111em;vertical-align:-0.3061em;"/><span class="mop op-symbol small-op" style="margin-right:0.19445em;position:relative;top:-0.0006em;">∫</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mord mathnormal">d</span><span class="mord mathnormal">x</span></span></span></span></span> 中，那个 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">dx</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">d</span><span class="mord mathnormal">x</span></span></span></span></span> 绝不仅仅是一个标点符号，它是积分运算的基石。</p>
<hr/>
<h3 data-id="heading-7">总结</h3>
<p>当我们谈论导数时，我们关注的是性质（斜率、速度、变化快慢）。</p>
<p>当我们谈论微分时，我们关注的是估算（近似值、线性增量、以直代曲）。</p>
<ul>
<li><strong>想求极值、判断单调性？</strong> 请找导数。</li>
<li><strong>想做近似计算、处理积分变换？</strong> 请找微分。</li>
</ul>
<p>理解了这一点，你眼中的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>d</mi><mi>y</mi></mrow><mrow><mi>d</mi><mi>x</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{dy}{dx}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2772em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9322em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">x</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.4461em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span> 就不再是一个僵硬的符号，而是一个可以灵活拆解的、充满动态美的数学工具。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何在前端编辑器中实现像 Ctrl + Z 一样的撤销和重做]]></title>    <link>https://juejin.cn/post/7591882877312958516</link>    <guid>https://juejin.cn/post/7591882877312958516</guid>    <pubDate>2026-01-06T11:03:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591882877312958516" data-draft-id="7401412446940102668" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何在前端编辑器中实现像 Ctrl + Z 一样的撤销和重做"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2026-01-06T11:03:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Moment"/> <meta itemprop="url" content="https://juejin.cn/user/3782764966460398"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何在前端编辑器中实现像 Ctrl + Z 一样的撤销和重做
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3782764966460398/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Moment
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T11:03:59.000Z" title="Tue Jan 06 2026 11:03:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>我正在开发 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxun082%2FDocFlow" target="_blank" title="https://github.com/xun082/DocFlow" ref="nofollow noopener noreferrer">DocFlow</a>，它是一个完整的 AI 全栈协同文档平台。该项目融合了多个技术栈，包括基于 <code>Tiptap</code> 的富文本编辑器、<code>NestJs</code> 后端服务、<code>AI</code> 集成功能和实时协作。在开发过程中，我积累了丰富的实战经验，涵盖了 <code>Tiptap</code> 的深度定制、性能优化和协作功能的实现等核心难点。</p>
</blockquote>
<p>如果你对 AI 全栈开发、Tiptap 富文本编辑器定制或 DocFlow 项目的完整技术方案感兴趣，欢迎加我微信 <code>yunmz777</code> 进行私聊咨询，获取详细的技术分享和最佳实践。</p>
<p>在前端开发中，撤销和重做功能是提升用户体验的重要特性。无论是文本编辑器、图形设计工具，还是可视化搭建平台，都需要提供历史操作的回退和前进能力。这个功能看似简单，但实现起来需要考虑性能、内存占用、用户体验等多个方面。</p>
<h2 data-id="heading-0">核心原理</h2>
<p><code>Undo</code> 和 <code>Redo</code> 的核心就是：</p>
<ul>
<li>把用户的操作记录下来</li>
<li>能在历史记录里往回退（Undo）或前进（Redo）</li>
</ul>
<p>这个功能实现的底层思路有两种：</p>
<h3 data-id="heading-1">命令模式（Command Pattern）</h3>
<p>命令模式是最常见也最灵活的方案：</p>
<ul>
<li>每次用户操作封装成一个操作对象（<code>Command</code>）</li>
<li>每个命令实现 <code>execute()</code> 和 <code>undo()</code> 方法</li>
<li>用两个栈分别管理历史操作和已撤销操作</li>
<li>添加新操作时清空 <code>redo</code> 栈</li>
</ul>
<p>这种方式的优点是内存占用低，每个命令只保存必要的状态信息，而不是整个应用状态。同时，命令模式具有很高的扩展性，可以轻松添加新的操作类型。命令模式还支持操作的回放、批量执行、操作日志等功能。</p>
<h3 data-id="heading-2">状态快照法（Memento Pattern）</h3>
<p>状态快照法是一种更简单但内存消耗更大的方案：</p>
<ul>
<li>在每次操作前保存整个状态快照</li>
<li>撤销时恢复上一个状态</li>
<li>优点：不需要一个个命令实现 <code>undo</code>，实现简单</li>
<li>缺点：状态大时内存占用高，深拷贝整个状态对象成本高</li>
</ul>
<p>这种方式适合状态较小、结构简单的场景，比如简单的表单状态管理。对于复杂的状态结构，快照法会导致内存快速增长。</p>
<p>前端里命令模式是更常见也更灵活的方案，下面我们重点展开。</p>
<h2 data-id="heading-3">命令模式实现</h2>
<h3 data-id="heading-4">核心数据结构</h3>
<p>我们用两个栈来管理历史：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-attr">undoStack</span>: <span class="hljs-title class_">Command</span>[] = [];
<span class="hljs-keyword">const</span> <span class="hljs-attr">redoStack</span>: <span class="hljs-title class_">Command</span>[] = [];
</code></pre>
<p>这两个栈的工作机制：</p>
<ul>
<li>执行新的操作：<code>undoStack.push(cmd)</code></li>
<li>撤销操作：<code>undoStack.pop()</code> → 放入 <code>redoStack</code></li>
<li>重做操作：<code>redoStack.pop()</code> → 放入 <code>undoStack</code></li>
</ul>
<p>这种设计保证了操作的线性历史记录，用户可以按照操作顺序进行撤销和重做。栈的 LIFO（后进先出）特性完美契合了撤销重做的需求。</p>
<h3 data-id="heading-5">命令接口定义</h3>
<p>核心接口非常简单：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Command</span> {
  <span class="hljs-title function_">execute</span>(): <span class="hljs-built_in">void</span>; <span class="hljs-comment">// 执行操作</span>
  <span class="hljs-title function_">undo</span>(): <span class="hljs-built_in">void</span>; <span class="hljs-comment">// 撤销操作</span>
}
</code></pre>
<p>每个操作都要：</p>
<ul>
<li>执行时保存旧状态</li>
<li>撤销时恢复旧状态</li>
</ul>
<p>这个接口的设计遵循了单一职责原则，每个命令只负责一个特定的操作及其撤销。在实际项目中，我们还可以扩展这个接口，添加 <code>redo()</code> 方法（虽然通常 <code>redo</code> 就是再次执行 <code>execute()</code>），或者添加 <code>description</code> 属性用于显示操作描述。</p>
<h3 data-id="heading-6">历史管理函数</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">runCommand</span>(<span class="hljs-params">cmd: Command</span>) {
  cmd.<span class="hljs-title function_">execute</span>();
  undoStack.<span class="hljs-title function_">push</span>(cmd);
  <span class="hljs-comment">// 新操作清空 redo 栈</span>
  redoStack.<span class="hljs-property">length</span> = <span class="hljs-number">0</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">undo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> cmd = undoStack.<span class="hljs-title function_">pop</span>();
  <span class="hljs-keyword">if</span> (!cmd) <span class="hljs-keyword">return</span>;
  cmd.<span class="hljs-title function_">undo</span>();
  redoStack.<span class="hljs-title function_">push</span>(cmd);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">redo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> cmd = redoStack.<span class="hljs-title function_">pop</span>();
  <span class="hljs-keyword">if</span> (!cmd) <span class="hljs-keyword">return</span>;
  cmd.<span class="hljs-title function_">execute</span>();
  undoStack.<span class="hljs-title function_">push</span>(cmd);
}
</code></pre>
<p>这里有一个关键的设计决策：当执行新操作时，必须清空 <code>redoStack</code>。这是因为新操作改变了应用的状态，之前被撤销的操作已经不再有效，不能继续重做。这个设计保证了状态的一致性。</p>
<p>这样你就可以在 UI 里调用：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"undo()"</span>&gt;</span>撤销<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"redo()"</span>&gt;</span>重做<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<h2 data-id="heading-7">命令实现示例</h2>
<h3 data-id="heading-8">文本编辑器示例</h3>
<p>假设我们有一个简单的文本编辑器对象：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Editor</span> {
  <span class="hljs-keyword">private</span> text = <span class="hljs-string">""</span>;

  <span class="hljs-title function_">getText</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">text</span>;
  }

  <span class="hljs-title function_">setText</span>(<span class="hljs-params">val: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">text</span> = val;
  }
}
</code></pre>
<p>我们封装一个"追加文本"的命令：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AppendTextCommand</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Command</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">prevText</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> editor: Editor, <span class="hljs-keyword">private</span> newText: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevText</span> = <span class="hljs-string">""</span>;
  }

  <span class="hljs-title function_">execute</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 保存旧状态</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevText</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-title function_">getText</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-title function_">setText</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">prevText</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">newText</span>);
  }

  <span class="hljs-title function_">undo</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 恢复旧状态</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-title function_">setText</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">prevText</span>);
  }
}
</code></pre>
<p>使用示例：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> editor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Editor</span>();

<span class="hljs-title function_">runCommand</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AppendTextCommand</span>(editor, <span class="hljs-string">"Hello"</span>));
<span class="hljs-title function_">runCommand</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AppendTextCommand</span>(editor, <span class="hljs-string">", world!"</span>));

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(editor.<span class="hljs-title function_">getText</span>()); <span class="hljs-comment">// Hello, world!</span>

<span class="hljs-title function_">undo</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(editor.<span class="hljs-title function_">getText</span>()); <span class="hljs-comment">// Hello</span>

<span class="hljs-title function_">redo</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(editor.<span class="hljs-title function_">getText</span>()); <span class="hljs-comment">// Hello, world!</span>
</code></pre>
<h3 data-id="heading-9">DOM 操作示例</h3>
<p>在实际的前端开发中，我们经常需要操作 DOM 元素。下面是一个删除节点的命令示例：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DeleteNodeCommand</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Command</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">parentNode</span>: <span class="hljs-title class_">Node</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">nextSibling</span>: <span class="hljs-title class_">Node</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">deletedNode</span>: <span class="hljs-title class_">Node</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> node: Node</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">deletedNode</span> = node;
  }

  <span class="hljs-title function_">execute</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">parentNode</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">node</span>.<span class="hljs-property">parentNode</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">nextSibling</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">node</span>.<span class="hljs-property">nextSibling</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">parentNode</span>?.<span class="hljs-title function_">removeChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">node</span>);
  }

  <span class="hljs-title function_">undo</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">parentNode</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">deletedNode</span>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">nextSibling</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">parentNode</span>.<span class="hljs-title function_">insertBefore</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">deletedNode</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">nextSibling</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">parentNode</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">deletedNode</span>);
      }
    }
  }
}
</code></pre>
<p>这个命令保存了被删除节点的父节点和下一个兄弟节点，这样在撤销时可以精确地恢复到原来的位置。对于插入节点的操作，我们可以类似地保存插入位置的信息。</p>
<h3 data-id="heading-10">样式修改示例</h3>
<p>修改元素样式的命令：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ChangeStyleCommand</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Command</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">oldValue</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    <span class="hljs-keyword">private</span> element: HTMLElement,
    <span class="hljs-keyword">private</span> property: <span class="hljs-built_in">string</span>,
    <span class="hljs-keyword">private</span> newValue: <span class="hljs-built_in">string</span>
  </span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">oldValue</span> = <span class="hljs-string">""</span>;
  }

  <span class="hljs-title function_">execute</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">oldValue</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">element</span>.<span class="hljs-property">style</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">property</span>] || <span class="hljs-string">""</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">element</span>.<span class="hljs-property">style</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">property</span>] = <span class="hljs-variable language_">this</span>.<span class="hljs-property">newValue</span>;
  }

  <span class="hljs-title function_">undo</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">element</span>.<span class="hljs-property">style</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">property</span>] = <span class="hljs-variable language_">this</span>.<span class="hljs-property">oldValue</span>;
  }
}
</code></pre>
<h3 data-id="heading-11">命令组合</h3>
<p>有时候一个用户操作可能包含多个子操作，比如"复制粘贴"操作。我们可以使用组合命令：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CompositeCommand</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Command</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">commands</span>: <span class="hljs-title class_">Command</span>[] = [];

  <span class="hljs-title function_">addCommand</span>(<span class="hljs-params">cmd: Command</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">commands</span>.<span class="hljs-title function_">push</span>(cmd);
  }

  <span class="hljs-title function_">execute</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">commands</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">cmd</span>) =&gt;</span> cmd.<span class="hljs-title function_">execute</span>());
  }

  <span class="hljs-title function_">undo</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 反向执行撤销</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-variable language_">this</span>.<span class="hljs-property">commands</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">commands</span>[i].<span class="hljs-title function_">undo</span>();
    }
  }
}
</code></pre>
<p>使用组合命令可以让我们将多个相关操作作为一个整体进行撤销和重做，这在复杂编辑器中非常有用。例如，在图形编辑器中，移动一个元素可能同时需要更新多个属性（位置、层级、连接关系等），这些操作可以组合成一个命令。</p>
<h3 data-id="heading-12">拖拽操作示例</h3>
<p>拖拽是前端常见的交互，实现拖拽的撤销重做需要保存位置信息：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DragCommand</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Command</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">startX</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">startY</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">endX</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">endY</span>: <span class="hljs-built_in">number</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    <span class="hljs-keyword">private</span> element: HTMLElement,
    startX: <span class="hljs-built_in">number</span>,
    startY: <span class="hljs-built_in">number</span>,
    endX: <span class="hljs-built_in">number</span>,
    endY: <span class="hljs-built_in">number</span>
  </span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">startX</span> = startX;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">startY</span> = startY;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">endX</span> = endX;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">endY</span> = endY;
  }

  <span class="hljs-title function_">execute</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">element</span>.<span class="hljs-property">style</span>.<span class="hljs-property">left</span> = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.endX}</span>px`</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">element</span>.<span class="hljs-property">style</span>.<span class="hljs-property">top</span> = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.endY}</span>px`</span>;
  }

  <span class="hljs-title function_">undo</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">element</span>.<span class="hljs-property">style</span>.<span class="hljs-property">left</span> = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.startX}</span>px`</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">element</span>.<span class="hljs-property">style</span>.<span class="hljs-property">top</span> = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.startY}</span>px`</span>;
  }
}
</code></pre>
<h2 data-id="heading-13">状态快照法</h2>
<p>对于简单状态，例如 Redux 的整个状态对象，快照法很常用：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 假设 state 是一个对象</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">history</span>: <span class="hljs-built_in">any</span>[] = [];
<span class="hljs-keyword">let</span> pointer = -<span class="hljs-number">1</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">saveState</span>(<span class="hljs-params">state: <span class="hljs-built_in">any</span></span>) {
  <span class="hljs-comment">// 清空未来版本（如果有新操作，之前的 redo 历史就无效了）</span>
  history.<span class="hljs-title function_">splice</span>(pointer + <span class="hljs-number">1</span>);
  <span class="hljs-comment">// 深拷贝当前状态</span>
  history.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(state)));
  pointer = history.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">undoState</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (pointer &gt; <span class="hljs-number">0</span>) {
    pointer--;
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(history[pointer]));
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">redoState</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (pointer &lt; history.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>) {
    pointer++;
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(history[pointer]));
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<p>缺点是复制整个状态对象成本高，适合状态较小场景。如果状态对象很大，每次保存快照都会消耗大量内存和时间。对于支持结构化克隆的环境，可以使用更高效的深拷贝方法：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">saveState</span>(<span class="hljs-params">state: <span class="hljs-built_in">any</span></span>) {
  history.<span class="hljs-title function_">splice</span>(pointer + <span class="hljs-number">1</span>);
  <span class="hljs-comment">// 使用结构化克隆，比 JSON 序列化更快且支持更多类型</span>
  history.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">structuredClone</span>(state));
  pointer = history.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>;
}
</code></pre>
<p>结构化克隆比 <code>JSON.parse(JSON.stringify())</code> 更快，并且支持更多数据类型（如 <code>Date</code>、<code>RegExp</code>、<code>Map</code>、<code>Set</code> 等）。</p>
<h2 data-id="heading-14">性能优化</h2>
<h3 data-id="heading-15">限制历史长度</h3>
<p>无限制记录可能爆内存，特别是在长时间使用的应用中：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MAX_HISTORY</span> = <span class="hljs-number">50</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">runCommand</span>(<span class="hljs-params">cmd: Command</span>) {
  cmd.<span class="hljs-title function_">execute</span>();
  undoStack.<span class="hljs-title function_">push</span>(cmd);

  <span class="hljs-comment">// 限制历史长度</span>
  <span class="hljs-keyword">if</span> (undoStack.<span class="hljs-property">length</span> &gt; <span class="hljs-variable constant_">MAX_HISTORY</span>) {
    undoStack.<span class="hljs-title function_">shift</span>(); <span class="hljs-comment">// 移除最旧的操作</span>
  }

  redoStack.<span class="hljs-property">length</span> = <span class="hljs-number">0</span>;
}
</code></pre>
<h3 data-id="heading-16">合并相似操作</h3>
<p>例如连续输入文本可以合并成一个操作组，避免每个输入都记录一条。这对于提升性能和用户体验都很重要：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TextInputCommand</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Command</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">prevText</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">inputBuffer</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">""</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">debounceTimer</span>: <span class="hljs-built_in">number</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> editor: Editor</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevText</span> = <span class="hljs-string">""</span>;
  }

  <span class="hljs-title function_">addText</span>(<span class="hljs-params">text: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">inputBuffer</span> += text;

    <span class="hljs-comment">// 清除之前的定时器</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">debounceTimer</span>) {
      <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">debounceTimer</span>);
    }

    <span class="hljs-comment">// 延迟执行，合并连续输入</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">debounceTimer</span> = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">execute</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">inputBuffer</span> = <span class="hljs-string">""</span>;
    }, <span class="hljs-number">300</span>); <span class="hljs-comment">// 300ms 内的输入会被合并</span>
  }

  <span class="hljs-title function_">execute</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevText</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-title function_">getText</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-title function_">setText</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">prevText</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">inputBuffer</span>);
  }

  <span class="hljs-title function_">undo</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-title function_">setText</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">prevText</span>);
  }
}
</code></pre>
<h3 data-id="heading-17">同步 UI 状态</h3>
<p>每次 <code>undo</code>/<code>redo</code> 后触发 UI 更新，确保按钮状态和界面显示一致：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">updateButtons</span>(<span class="hljs-params"/>) {
  undoBtn.<span class="hljs-property">disabled</span> = undoStack.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>;
  redoBtn.<span class="hljs-property">disabled</span> = redoStack.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>;

  <span class="hljs-comment">// 更新按钮文本，显示可撤销/重做的操作数量</span>
  undoBtn.<span class="hljs-property">textContent</span> = <span class="hljs-string">`撤销 (<span class="hljs-subst">${undoStack.length}</span>)`</span>;
  redoBtn.<span class="hljs-property">textContent</span> = <span class="hljs-string">`重做 (<span class="hljs-subst">${redoStack.length}</span>)`</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">undo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> cmd = undoStack.<span class="hljs-title function_">pop</span>();
  <span class="hljs-keyword">if</span> (!cmd) <span class="hljs-keyword">return</span>;
  cmd.<span class="hljs-title function_">undo</span>();
  redoStack.<span class="hljs-title function_">push</span>(cmd);
  <span class="hljs-title function_">updateButtons</span>(); <span class="hljs-comment">// 更新 UI</span>
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">redo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> cmd = redoStack.<span class="hljs-title function_">pop</span>();
  <span class="hljs-keyword">if</span> (!cmd) <span class="hljs-keyword">return</span>;
  cmd.<span class="hljs-title function_">execute</span>();
  undoStack.<span class="hljs-title function_">push</span>(cmd);
  <span class="hljs-title function_">updateButtons</span>(); <span class="hljs-comment">// 更新 UI</span>
}
</code></pre>
<h3 data-id="heading-18">键盘快捷键支持</h3>
<p>大多数应用都支持 <code>Ctrl+Z</code> 和 <code>Ctrl+Y</code>（或 <code>Ctrl+Shift+Z</code>）快捷键：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"keydown"</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-comment">// Ctrl+Z 或 Cmd+Z (Mac)</span>
  <span class="hljs-keyword">if</span> ((e.<span class="hljs-property">ctrlKey</span> || e.<span class="hljs-property">metaKey</span>) &amp;&amp; e.<span class="hljs-property">key</span> === <span class="hljs-string">"z"</span> &amp;&amp; !e.<span class="hljs-property">shiftKey</span>) {
    e.<span class="hljs-title function_">preventDefault</span>();
    <span class="hljs-title function_">undo</span>();
  }

  <span class="hljs-comment">// Ctrl+Y 或 Ctrl+Shift+Z 或 Cmd+Shift+Z (Mac)</span>
  <span class="hljs-keyword">if</span> (
    (e.<span class="hljs-property">ctrlKey</span> || e.<span class="hljs-property">metaKey</span>) &amp;&amp;
    (e.<span class="hljs-property">key</span> === <span class="hljs-string">"y"</span> || (e.<span class="hljs-property">key</span> === <span class="hljs-string">"z"</span> &amp;&amp; e.<span class="hljs-property">shiftKey</span>))
  ) {
    e.<span class="hljs-title function_">preventDefault</span>();
    <span class="hljs-title function_">redo</span>();
  }
});
</code></pre>
<h3 data-id="heading-19">延迟执行</h3>
<p>对于频繁的操作（如拖拽、实时输入），可以使用防抖或节流来减少历史记录的数量：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> debounce&lt;T <span class="hljs-keyword">extends</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>[]) =&gt; <span class="hljs-built_in">void</span>&gt;(
  <span class="hljs-attr">func</span>: T,
  <span class="hljs-attr">wait</span>: <span class="hljs-built_in">number</span>
): T {
  <span class="hljs-keyword">let</span> <span class="hljs-attr">timeout</span>: <span class="hljs-built_in">number</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">return</span> (<span class="hljs-function">(<span class="hljs-params">...args: <span class="hljs-built_in">any</span>[]</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (timeout) <span class="hljs-built_in">clearTimeout</span>(timeout);
    timeout = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">func</span>(...args), wait);
  }) <span class="hljs-keyword">as</span> T;
}

<span class="hljs-comment">// 使用防抖的保存函数</span>
<span class="hljs-keyword">const</span> debouncedSave = <span class="hljs-title function_">debounce</span>(<span class="hljs-function">(<span class="hljs-params">state: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
  <span class="hljs-title function_">saveState</span>(state);
}, <span class="hljs-number">500</span>); <span class="hljs-comment">// 500ms 内的操作只保存最后一次</span>
</code></pre>
<h3 data-id="heading-20">增量更新</h3>
<p>对于大型状态对象，可以使用增量更新而不是完整快照：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Diff</span> {
  <span class="hljs-attr">path</span>: <span class="hljs-built_in">string</span>[];
  <span class="hljs-attr">oldValue</span>: <span class="hljs-built_in">any</span>;
  <span class="hljs-attr">newValue</span>: <span class="hljs-built_in">any</span>;
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">IncrementalSnapshot</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">diffs</span>: <span class="hljs-title class_">Diff</span>[] = [];

  <span class="hljs-title function_">applyDiff</span>(<span class="hljs-params">diff: Diff</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">diffs</span>.<span class="hljs-title function_">push</span>(diff);
  }

  <span class="hljs-title function_">applyToState</span>(<span class="hljs-attr">state</span>: <span class="hljs-built_in">any</span>): <span class="hljs-built_in">any</span> {
    <span class="hljs-keyword">const</span> newState = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(state));
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">diffs</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">diff</span>) =&gt;</span> {
      <span class="hljs-keyword">let</span> target = newState;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; diff.<span class="hljs-property">path</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>; i++) {
        target = target[diff.<span class="hljs-property">path</span>[i]];
      }
      target[diff.<span class="hljs-property">path</span>[diff.<span class="hljs-property">path</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>]] = diff.<span class="hljs-property">newValue</span>;
    });
    <span class="hljs-keyword">return</span> newState;
  }

  <span class="hljs-title function_">reverse</span>(): <span class="hljs-title class_">IncrementalSnapshot</span> {
    <span class="hljs-keyword">const</span> reversed = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IncrementalSnapshot</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">diffs</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">diff</span>) =&gt;</span> {
      reversed.<span class="hljs-property">diffs</span>.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">path</span>: diff.<span class="hljs-property">path</span>,
        <span class="hljs-attr">oldValue</span>: diff.<span class="hljs-property">newValue</span>,
        <span class="hljs-attr">newValue</span>: diff.<span class="hljs-property">oldValue</span>,
      });
    });
    reversed.<span class="hljs-property">diffs</span>.<span class="hljs-title function_">reverse</span>();
    <span class="hljs-keyword">return</span> reversed;
  }
}
</code></pre>
<p>增量更新只保存状态变化的部分，而不是整个状态对象，这在状态对象很大时能显著减少内存占用。</p>
<h2 data-id="heading-21">React Hook 实现</h2>
<p>在 React 中，我们可以创建一个自定义 Hook 来管理撤销重做：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { useState, useCallback } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">function</span> useUndoRedo&lt;T&gt;(<span class="hljs-attr">initialState</span>: T) {
  <span class="hljs-keyword">const</span> [history, setHistory] = useState&lt;{
    <span class="hljs-attr">past</span>: T[];
    <span class="hljs-attr">present</span>: T;
    <span class="hljs-attr">future</span>: T[];
  }&gt;({
    <span class="hljs-attr">past</span>: [],
    <span class="hljs-attr">present</span>: initialState,
    <span class="hljs-attr">future</span>: [],
  });

  <span class="hljs-keyword">const</span> setState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">newState: T</span>) =&gt;</span> {
    <span class="hljs-title function_">setHistory</span>(<span class="hljs-function">(<span class="hljs-params">prev</span>) =&gt;</span> ({
      <span class="hljs-attr">past</span>: [...prev.<span class="hljs-property">past</span>, prev.<span class="hljs-property">present</span>],
      <span class="hljs-attr">present</span>: newState,
      <span class="hljs-attr">future</span>: [],
    }));
  }, []);

  <span class="hljs-keyword">const</span> undo = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setHistory</span>(<span class="hljs-function">(<span class="hljs-params">prev</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (prev.<span class="hljs-property">past</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> prev;
      <span class="hljs-keyword">const</span> previous = prev.<span class="hljs-property">past</span>[prev.<span class="hljs-property">past</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>];
      <span class="hljs-keyword">const</span> newPast = prev.<span class="hljs-property">past</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, prev.<span class="hljs-property">past</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>);
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">past</span>: newPast,
        <span class="hljs-attr">present</span>: previous,
        <span class="hljs-attr">future</span>: [prev.<span class="hljs-property">present</span>, ...prev.<span class="hljs-property">future</span>],
      };
    });
  }, []);

  <span class="hljs-keyword">const</span> redo = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setHistory</span>(<span class="hljs-function">(<span class="hljs-params">prev</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (prev.<span class="hljs-property">future</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> prev;
      <span class="hljs-keyword">const</span> next = prev.<span class="hljs-property">future</span>[<span class="hljs-number">0</span>];
      <span class="hljs-keyword">const</span> newFuture = prev.<span class="hljs-property">future</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>);
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">past</span>: [...prev.<span class="hljs-property">past</span>, prev.<span class="hljs-property">present</span>],
        <span class="hljs-attr">present</span>: next,
        <span class="hljs-attr">future</span>: newFuture,
      };
    });
  }, []);

  <span class="hljs-keyword">const</span> canUndo = history.<span class="hljs-property">past</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> canRedo = history.<span class="hljs-property">future</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>;

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">state</span>: history.<span class="hljs-property">present</span>,
    setState,
    undo,
    redo,
    canUndo,
    canRedo,
  };
}
</code></pre>
<p>使用示例：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Editor</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { state, setState, undo, redo, canUndo, canRedo } = <span class="hljs-title function_">useUndoRedo</span>(<span class="hljs-string">""</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">textarea</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{state}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setState(e.target.value)} /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{undo}</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">{!canUndo}</span>&gt;</span>
        撤销
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{redo}</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">{!canRedo}</span>&gt;</span>
        重做
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h2 data-id="heading-22">总结</h2>


























<table><thead><tr><th>实现方式</th><th>抽象程度</th><th>内存成本</th><th>易用性</th><th>适用场景</th></tr></thead><tbody><tr><td>命令模式</td><td>高</td><td>低</td><td>⭐⭐⭐</td><td>复杂操作、需要细粒度控制</td></tr><tr><td>状态快照</td><td>低</td><td>高</td><td>⭐⭐</td><td>简单状态、快速实现</td></tr></tbody></table>
<p>推荐方案：命令模式 + 历史栈</p>
<p>这是 UI 里最常见、灵活、可扩展的做法。命令模式不仅适用于撤销重做，还可以用于操作日志记录、批量操作、操作回放、协作编辑中的操作同步等场景。在实际应用中，无论是富文本编辑器中的文本插入和格式化、图形编辑器中的图形移动和删除，还是可视化表单编辑器中的组件增删改，都可以通过命令模式优雅地实现撤销重做功能。</p>
<p>理解撤销重做的实现原理，不仅能帮助我们构建更好的用户体验，也是深入理解状态管理和操作历史的重要基础。在实际项目中，我们需要根据应用的特点选择合适的实现方式，并做好性能优化，确保功能既强大又高效。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🔥Angular高效开发秘籍：掌握这些新特性，项目交付速度翻倍]]></title>    <link>https://juejin.cn/post/7591788451030990891</link>    <guid>https://juejin.cn/post/7591788451030990891</guid>    <pubDate>2026-01-06T11:17:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591788451030990891" data-draft-id="7592059801883983915" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🔥Angular高效开发秘籍：掌握这些新特性，项目交付速度翻倍"/> <meta itemprop="keywords" content="前端,TypeScript,Angular.js"/> <meta itemprop="datePublished" content="2026-01-06T11:17:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="DevUI团队"/> <meta itemprop="url" content="https://juejin.cn/user/712139267650141"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🔥Angular高效开发秘籍：掌握这些新特性，项目交付速度翻倍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712139267650141/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    DevUI团队
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T11:17:20.000Z" title="Tue Jan 06 2026 11:17:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、为什么要学习 Angular 新特性</h2>
<h3 data-id="heading-1">1.1 旧版 Angular 开发痛点</h3>
<ul>
<li>配置冗余：NgModule 套娃，组件复用需导入多个模块</li>
<li>性能瓶颈：首屏加载慢（RTTI 长），非必要资源打包进首屏</li>
<li>开发低效：模板嵌套复杂（*ngIf/*ngFor），响应式编程学习成本高（RxJS）</li>
<li>稳定性差：输入空值 Bug 多，缺乏编译时校验</li>
</ul>
<h2 data-id="heading-2">二、核心新特性介绍</h2>
<h3 data-id="heading-3">2.1 独立组件（Standalone Components）</h3>
<h4 data-id="heading-4">2.1.1 特性介绍​</h4>
<p>独立组件通过在 @Component 装饰器中配置 <code>standalone: true</code>，将「依赖管理能力」从 NgModule 下沉到组件本身，可直接通过 imports 数组导入所需的组件、指令、管道，无需封装到 NgModule 中，本质是简化项目层级、提升组件复用性。</p>
<h4 data-id="heading-5">2.1.2 基础实践：独立组件的使用</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 1. 独立组件定义（无需关联 NgModule)</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Component</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CommonModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">MyPipe</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./my.pipe'</span>; <span class="hljs-comment">// 直接导入管道/指令</span>

<span class="hljs-meta">@Component</span>({
  <span class="hljs-attr">selector</span>: <span class="hljs-string">'app-demo'</span>,
  <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>, 
  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">CommonModule</span>, <span class="hljs-title class_">MyPipe</span>], <span class="hljs-comment">// 组件内直接导入依赖</span>
  <span class="hljs-attr">template</span>: <span class="hljs-string">`&lt;div&gt;{{ 'test' | myPipe }}&lt;/div&gt;`</span>
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoComponent</span> {}

<span class="hljs-comment">// 传统 NgModule 组件（冗余）</span>
<span class="hljs-meta">@NgModule</span>({
  <span class="hljs-attr">declarations</span>: [<span class="hljs-title class_">DemoComponent</span>, <span class="hljs-title class_">MyPipe</span>], <span class="hljs-comment">// 声明组件/管道</span>
  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">CommonModule</span>],
  <span class="hljs-attr">exports</span>: [<span class="hljs-title class_">DemoComponent</span>]
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoModule</span> {}
</code></pre>
<h4 data-id="heading-6">2.1.3 进阶实践：独立组件共享依赖（避免重复导入）</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// shared-directives.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CommonModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CustomInputDirective</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./custom-input.directive'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">FormatDatePipe</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./format-date.pipe'</span>;

<span class="hljs-comment">// 导出共享依赖，供其他独立组件批量导入</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">SharedDirectives</span> = [
  <span class="hljs-title class_">CommonModule</span>,
  <span class="hljs-title class_">CustomInputDirective</span>,
  <span class="hljs-title class_">FormatDatePipe</span>
];


<span class="hljs-comment">// user-form.component.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Component</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">SharedDirectives</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./shared-directives'</span>; <span class="hljs-comment">// 批量导入共享依赖</span>

<span class="hljs-meta">@Component</span>({
  <span class="hljs-attr">selector</span>: <span class="hljs-string">'app-user-form'</span>,
  <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">imports</span>: <span class="hljs-title class_">SharedDirectives</span>, <span class="hljs-comment">// 无需逐个导入指令/管道</span>
  <span class="hljs-attr">template</span>: <span class="hljs-string">`
    &lt;input [appCustomInput]="true" placeholder="用户名"&gt;
    &lt;p&gt;注册时间：{{ registerTime | formatDate }}&lt;/p&gt;
  `</span>
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserFormComponent</span> {
  registerTime = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();
}
</code></pre>
<h4 data-id="heading-7">2.1.4 独立组件路由配置</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Routes</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@angular/router"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">HomeComponent</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./home.component"</span>; <span class="hljs-comment">// 独立组件​</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">routes</span>: <span class="hljs-title class_">Routes</span> = [
  { <span class="hljs-attr">path</span>: <span class="hljs-string">""</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HomeComponent</span> }, <span class="hljs-comment">// 直接使用独立组件​</span>
  <span class="hljs-comment">// 懒加载独立组件（无需包装 NgModule）​</span>
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">"user/:id"</span>,
    <span class="hljs-attr">loadComponent</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">"./user-profile.component"</span>),
  },
  <span class="hljs-comment">// 独立组件下还存在子路由时，可直接引入路由配置常量​</span>
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">"user"</span>,
    <span class="hljs-attr">loadChildren</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">"./user.route.ts"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">m</span>) =&gt;</span> m.<span class="hljs-property">UserRoutes</span>),
  },
];
</code></pre>
<h4 data-id="heading-8">2.1.5 优缺点分析</h4>





















<table><thead><tr><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>1. 简化项目结构：减少冗余的 NgModule 文件</td><td>1. 需手动管理组件间的导入关系，无 NgModule 统一视角</td></tr><tr><td>2. 提升组件复用性：独立组件可直接跨项目导入（无需携带关联模块）</td><td>2. 旧项目兼容成本：需为旧模块组件补充 <code>imports: [CommonModule]</code> 适配新语法</td></tr><tr><td>3. 优化懒加载性能：loadComponent 比 loadChildren 轻量（减少模块包装开销）</td><td>3. 部分第三方库适配滞后：少数旧库仍依赖 NgModule，需通过 <code>imports: [LegacyModule]</code> 兼容</td></tr></tbody></table>
<h3 data-id="heading-9">2.2 新控制流语法</h3>
<h4 data-id="heading-10">2.2.1 特性介绍​</h4>
<p>控制流是一种将流程控制直接写入模板的新声明性语法，从而无须使用 <code>*ngIf</code>、<code>*ngFor</code> 和 <code>*ngSwitch</code> 这种基于指令（Directive）的控制流</p>
<h4 data-id="heading-11">2.2.2 场景 1：@if 语法（含 as 字符、@error 捕获）</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 1. @if + else if + else（替代嵌套 *ngIf） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"order-status"</span>&gt;</span>
  @if (order.status === 'pending') {
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"status-pending"</span>&gt;</span>待支付<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> (<span class="hljs-attr">click</span>)=<span class="hljs-string">"payOrder()"</span>&gt;</span>立即支付<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  } @else if (order.status === 'paid') {
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"status-paid"</span>&gt;</span>已支付<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> (<span class="hljs-attr">click</span>)=<span class="hljs-string">"viewLogistics()"</span>&gt;</span>查看物流<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  } @else if (order.status === 'shipped') {
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"status-shipped"</span>&gt;</span>已发货<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
  } @else {
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"status-completed"</span>&gt;</span>已完成<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
  }
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h4 data-id="heading-12">2.2.3 场景 2：@for 语法（含 track、@empty）</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 1. 基础用法：track 配置（替代 trackBy 函数） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"product-list"</span>&gt;</span>
  @for (product of products; track product.id;let i = $index, let even = $even) {
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"product-item"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">img</span> [<span class="hljs-attr">src</span>]=<span class="hljs-string">"product.image"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"{{ product.name }}"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>{{ product.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"price"</span>&gt;</span>¥{{ product.price }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  } @empty {
    <span class="hljs-comment">&lt;!-- 列表为空时显示，替代 *ngIf="products.length === 0" --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"empty"</span>&gt;</span>暂无商品数据<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  }
<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
</code></pre>
<p>支持原*ngFor中的变量</p>
<ul>
<li>$index 获取当前项的索引</li>
<li>$first 当前项是否是第一个</li>
<li>$last 当前项是否是最后一项</li>
<li>$even 当前项是否处于偶数索引</li>
<li>$odd 当前项是否处于奇数索引</li>
<li>$count 获取集合的长度</li>
</ul>
<h4 data-id="heading-13">2.2.4 场景 3：@error语法</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- @error 仅作用于 @if/@for 结合 async 管道的上下文--&gt;</span>
@if (user$ | async; as user; loading isLoading; error errorInfo) {
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{{ 数据变量名.属性 }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
} @loading {
  <span class="hljs-comment">&lt;!-- 可选：异步流未完成时的加载状态
  &lt;div&gt;加载中...&lt;/div&gt;
} @error {
  &lt;!-- @error 语义：渲染失败时的兜底逻辑 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>错误：{{ errorInfo.message }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
}
</code></pre>
<p><strong>可监听的错误类型</strong></p>
<ul>
<li>
<p>异步流自身抛出的错误</p>
<p>| HTTP 请求错误     | 接口返回 404/403/500 状态码、网络中断、CORS 配置错误                      |
| ------------------- | --------------------------------------------------------------------------- |
| 异步操作超时      | <code>data$.pipe(timeout(3000))</code> 超时触发 <code>TimeoutError</code>               |
| Promise 执行错误  | <code>new Promise((_, reject) =&gt; reject(new Error('执行失败')))</code>           |
| 业务逻辑主动抛错  | <code>data$.pipe(map(res =&gt; { if (!res.id) throw new Error('ID缺失'); }))</code> |
| 流取消 / 终止错误 | 异步流被手动 <code>unsubscribe</code> 且抛错、流内部未捕获的执行错误             |</p>
</li>
<li>
<p>异步数据解析 / 转换错误</p>
<p>| 子类型         | 触发示例                                                                                  |
| ---------------- | ------------------------------------------------------------------------------------------- |
| 数据格式不匹配 | 期望数组却返回对象：<code>list$ = of({ name: 'test' })</code> + <code>@for</code> 渲染                  |
| JSON 解析错误  | <code>data$ = http.get('/api/data').pipe(map(res =&gt; JSON.parse(res)))</code>（非 JSON 字符串）   |
| 类型转换错误   | 异步返回字符串却做数字运算：<code>{{ data * 2 }}</code>（<code>data$ = of('abc')</code>）               |</p>
</li>
<li>
<p>模板渲染异步数据的运行时错误</p>
<p>| 子类型             | 触发示例
| -------------------- | --------------------|
| 空值 / 未定义访问  | <code>data$ = of(null)</code> + 模板中 <code>{{ data.name }}</code>                             |
| 数组方法调用错误   | <code>data$ = of(123)</code> + 模板中 <code>{{ data.filter(item =&gt; item &gt; 0) }}</code>          |
| 管道执行错误       | <code>data$ = of('2025-13-01')</code> + 模板中 <code>{{ data \| date }}</code>（非法日期） |
| 模板内函数调用错误 | <code>data$ = of('test')</code> + 模板中 <code>{{ formatData(data) }}</code>（formatData 抛错） |</p>
</li>
</ul>
<h4 data-id="heading-14">2.2.5 场景 4：@switch 语法（替代 *ngSwitch）</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"role-container"</span>&gt;</span>
  @switch (user.role) {
    @case ('admin') {
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"role-tag admin"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>管理员<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> (<span class="hljs-attr">click</span>)=<span class="hljs-string">"showAdminMenu()"</span>&gt;</span>管理菜单<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    }
    @case ('editor') {
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"role-tag editor"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>编辑<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> (<span class="hljs-attr">click</span>)=<span class="hljs-string">"showEditorTools()"</span>&gt;</span>编辑工具<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    }
    @case ('viewer') {
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"role-tag viewer"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>查看者<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    }
    @default {
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"role-tag guest"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>访客<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> (<span class="hljs-attr">click</span>)=<span class="hljs-string">"goToLogin()"</span>&gt;</span>登录<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    }
  }
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h4 data-id="heading-15">2.2.6 优缺点分析</h4>





















<table><thead><tr><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>1. 性能提升：编译后减少 DOM 操作次数，比旧指令快 15%-20%</td><td>1. 迁移成本：旧项目需批量修改模板，复杂嵌套逻辑需手动适配</td></tr><tr><td>2. 语法直观：支持 @else if/@empty，减少嵌套层级（如替代 *ngIf 嵌套）</td><td>2. IDE 支持滞后：部分旧版 IDE 语法高亮不完整</td></tr><tr><td>3. 减少错误：@for 强制要求 track，避免因忘记 trackBy 导致的列表重渲染性能问题</td><td>3. 兼容性限制：仅 Angular17+ 支持，无法降级到旧版本</td></tr></tbody></table>
<h3 data-id="heading-16">2.3 信号（Signals）</h3>
<h4 data-id="heading-17">2.3.1 核心概念与基础 API 总览​</h4>
<p>Signals 是 Angular17 推出的轻量级响应式状态管理方案，核心解决传统 BehaviorSubject 需手动订阅、变更检测冗余的问题，API 分为三类：</p>















































<table><thead><tr><th>API 类型</th><th>具体 API</th><th>作用</th><th>适用场景</th></tr></thead><tbody><tr><td>基础信号操作</td><td>signal(initialValue)</td><td>创建基础信号（初始值不可变）</td><td>定义组件内 / Service 内状态</td></tr><tr><td/><td>set(newValue)</td><td>全量替换信号值（覆盖旧值）</td><td>直接赋值（如表单输入、状态重置）</td></tr><tr><td/><td>update(prev =&gt; new)</td><td>基于旧值计算新值（函数式更新）</td><td>累加、过滤、修改部分属性</td></tr><tr><td/><td><del>mutate(prev =&gt; void) （NG18已废弃删除）</del></td><td><del>直接修改引用类型内部值（不创建新引用）</del></td><td><del>数组 push/pop、对象属性修改</del></td></tr><tr><td>计算信号</td><td>computed(() =&gt; value)</td><td>依赖其他信号的衍生值（自动响应变化）</td><td>计算总价、筛选列表、格式转换</td></tr><tr><td>副作用监听</td><td>effect(() =&gt; void)</td><td>信号变化时执行副作用（如日志、请求）</td><td>状态变化后触发 API、更新 DOM</td></tr></tbody></table>
<h4 data-id="heading-18">2.3.2 基础 API 实战</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Component</span>, signal } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;

<span class="hljs-meta">@Component</span>({
  <span class="hljs-attr">selector</span>: <span class="hljs-string">'app-counter'</span>,
  <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">template</span>: <span class="hljs-string">`
    &lt;div class="counter"&gt;
      &lt;h3&gt;当前计数：{{ count() }}&lt;/h3&gt;
      &lt;button (click)="resetCount()"&gt;重置为 0&lt;/button&gt;
      &lt;button (click)="increment()"&gt;+1&lt;/button&gt;
    &lt;/div&gt;
  `</span>,
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CounterComponent</span> {
  <span class="hljs-comment">// 创建基础信号（初始值为 0）</span>
  count = <span class="hljs-title function_">signal</span>(<span class="hljs-number">0</span>);

  <span class="hljs-comment">// 计算信号</span>
  totalCount = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> ()*<span class="hljs-number">2</span>);

  <span class="hljs-comment">// set：全量替换信号值</span>
  <span class="hljs-title function_">resetCount</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>);
  }

  <span class="hljs-comment">// update：基于旧值累加 1</span>
  <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>.<span class="hljs-title function_">update</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>);
  }
}
</code></pre>
<h4 data-id="heading-19">2.3.4  effect 副作用清理（避免内存泄漏）</h4>
<p>当effect中包含订阅（如定时器、API 订阅）时，需通过<strong>清理函数</strong>释放资源，避免组件销毁后仍执行：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Component</span>, signal, effect, <span class="hljs-title class_">OnDestroy</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;
<span class="hljs-keyword">import</span> { interval } <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs'</span>;

<span class="hljs-meta">@Component</span>({
  <span class="hljs-attr">selector</span>: <span class="hljs-string">'app-timer'</span>,
  <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">template</span>: <span class="hljs-string">`&lt;p&gt;当前计数：{{ count() }}&lt;/p&gt;`</span>
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TimerComponent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OnDestroy</span> {
  count = <span class="hljs-title function_">signal</span>(<span class="hljs-number">0</span>);
  <span class="hljs-comment">// 存储effect清理函数（用于组件销毁时调用）</span>
  <span class="hljs-keyword">private</span> effectCleanup?: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// effect返回清理函数，用于释放资源</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">effectCleanup</span> = <span class="hljs-title function_">effect</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 场景：当count&gt;5时，启动定时器（需清理）</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">count</span>() &gt; <span class="hljs-number">5</span>) {
        <span class="hljs-keyword">const</span> timer = <span class="hljs-title function_">interval</span>(<span class="hljs-number">1000</span>).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>.<span class="hljs-title function_">update</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c + <span class="hljs-number">1</span>);
        });
        <span class="hljs-comment">// 清理函数：组件销毁时取消订阅</span>
        <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> timer.<span class="hljs-title function_">unsubscribe</span>();
      }
    });
  }

  <span class="hljs-comment">// 组件销毁时执行清理</span>
  <span class="hljs-title function_">ngOnDestroy</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">effectCleanup</span>?.();
  }

  <span class="hljs-comment">// 外部触发count增加</span>
  <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>.<span class="hljs-title function_">update</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c + <span class="hljs-number">1</span>);
  }
}
</code></pre>
<h4 data-id="heading-20">2.3.5 signal 与 Observable 互转（适配异步场景）</h4>
<p>通过toSignal()（Observable 转信号）和fromSignal()（信号转 Observable），适配既有 RxJS 代码：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Component</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;
<span class="hljs-keyword">import</span> { signal, toSignal } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;
<span class="hljs-keyword">import</span> { fromSignal } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/rxjs-interop'</span>;
<span class="hljs-keyword">import</span> { interval, switchMap, debounceTime } <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs'</span>;

<span class="hljs-meta">@Component</span>({
  <span class="hljs-attr">selector</span>: <span class="hljs-string">'app-signal-observable'</span>,
  <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">template</span>: <span class="hljs-string">`
    &lt;p&gt;当前用户：{{ user()?.name }}&lt;/p&gt;
    &lt;input [(ngModel)]="searchInput()" placeholder="搜索..."&gt;
    &lt;p&gt;搜索结果：{{ searchResult()?.length || 0 }} 条&lt;/p&gt;
  `</span>
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SignalObservableComponent</span> {
  <span class="hljs-comment">// 1. Observable转信号：适配API请求（如HttpClient返回Observable）</span>
  userId = <span class="hljs-title function_">signal</span>(<span class="hljs-number">1</span>);
  <span class="hljs-comment">// 当userId变化时，自动重新请求用户信息（switchMap切换请求）</span>
  user$ = <span class="hljs-title function_">fromSignal</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">userId</span>).<span class="hljs-title function_">pipe</span>(
    <span class="hljs-title function_">switchMap</span>(<span class="hljs-function"><span class="hljs-params">id</span> =&gt;</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/user/<span class="hljs-subst">${id}</span>`</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>()))
  );
  <span class="hljs-comment">// 将Observable转为信号，供模板使用（initialValue避免undefined）</span>
  user = <span class="hljs-title function_">toSignal</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">user$</span>, { <span class="hljs-attr">initialValue</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'默认用户'</span> } });

  <span class="hljs-comment">// 2. 信号转Observable：适配RxJS操作符（如debounceTime）</span>
  searchInput = <span class="hljs-title function_">signal</span>(<span class="hljs-string">''</span>);
  <span class="hljs-comment">// 将信号转为Observable，添加防抖</span>
  searchResult$ = <span class="hljs-title function_">fromSignal</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">searchInput</span>).<span class="hljs-title function_">pipe</span>(
    <span class="hljs-title function_">debounceTime</span>(<span class="hljs-number">300</span>), <span class="hljs-comment">// 输入停止300ms后执行搜索</span>
    <span class="hljs-title function_">switchMap</span>(<span class="hljs-function"><span class="hljs-params">keyword</span> =&gt;</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/search?kw=<span class="hljs-subst">${keyword}</span>`</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>()))
  );
  <span class="hljs-comment">// 转为信号供模板使用</span>
  searchResult = <span class="hljs-title function_">toSignal</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">searchResult$</span>, { <span class="hljs-attr">initialValue</span>: [] });
}
</code></pre>
<h4 data-id="heading-21">2.3.6 信号（Signals）与 Observable 订阅的场景对比</h4>








































<table><thead><tr><th>适用场景</th><th>选择信号（Signals）</th><th>选择 Observable 订阅</th></tr></thead><tbody><tr><td>组件内简单状态管理</td><td>✅ 优先选择：计数器、弹窗显隐、表单输入状态</td><td>❌ 不推荐：语法繁琐，需手动管理订阅</td></tr><tr><td>多依赖衍生值计算</td><td>✅ 优先选择：购物车总价、筛选列表、格式转换</td><td>❌ 不推荐：需用 combineLatest 等操作符，语法复杂</td></tr><tr><td>跨组件共享简单状态</td><td>✅ 优先选择：主题切换、登录状态、全局开关</td><td>❌ 不推荐：需用 Subject 封装，内存管理复杂</td></tr><tr><td>复杂异步流（多请求合并）</td><td>❌ 不推荐：需通过 toSignal() 适配，无原生操作符</td><td>✅ 优先选择：switchMap/forkJoin 等操作符原生支持</td></tr><tr><td>高频事件处理（防抖 / 节流）</td><td>❌ 不推荐：需转 Observable 后使用操作符</td><td>✅ 优先选择：debounceTime/throttleTime 原生支持</td></tr><tr><td>实时数据流（WebSocket）</td><td>❌ 不推荐：需转 Observable 处理持续事件流</td><td>✅ 优先选择：原生支持 next/complete 事件</td></tr></tbody></table>
<h3 data-id="heading-22">2.4 延迟加载模板（@defer）- 全场景覆盖</h3>
<h4 data-id="heading-23">2.4.1 语法原理</h4>
<p>@defer 是 Angular17 新增的<strong>模板级延迟加载语法</strong>，核心是 “按需加载非首屏内容”（如弹窗、折叠面板内组件），避免首屏加载冗余的 JS/CSS 资源。支持四大核心能力：​</p>
<ol>
<li>触发条件：on（用户交互）、when（条件满足）；​</li>
<li>状态提示：<code>@placeholder</code>（加载中）、<code>@loading</code>（加载中）、<code>@error</code>（加载失败）、<code>@empty</code>（内容为空）；​</li>
<li>预加载：prefetch（提前加载即将用到的资源）；​</li>
<li>性能优化：加载完成后自动替换占位内容，无闪烁。</li>
</ol>
<h4 data-id="heading-24">2.4.2 基础用法（默认触发：组件初始化后延迟加载）</h4>
<p>适用于 “首屏非关键内容”（如页面底部的推荐列表）：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 首屏优先加载核心内容（用户信息） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"user-info"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>{{ user.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ user.email }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 延迟加载非关键内容（推荐列表） --&gt;</span>
@defer {
  <span class="hljs-tag">&lt;<span class="hljs-name">app-recommended-list</span> [<span class="hljs-attr">userId</span>]=<span class="hljs-string">"user.id"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">app-recommended-list</span>&gt;</span>
} @placeholder (minimum 500ms){
  <span class="hljs-comment">&lt;!-- 加载前状态：占位内容 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"comment-skeleton"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"skeleton-line"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"skeleton-line"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"skeleton-avatar"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
} @loading {
  <span class="hljs-comment">&lt;!-- 加载中状态：替代ngIf+loading变量 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"skeleton"</span>&gt;</span>推荐内容加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
}
</code></pre>
<h4 data-id="heading-25">2.4.3 on 触发（用户交互时加载）</h4>
<p>适用于 “用户主动触发才显示的内容”（如点击按钮显示的详情面板）：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 按钮触发：点击后加载详情组件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> #<span class="hljs-attr">detailBtn</span>&gt;</span>查看订单详情<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

@defer (on click(detailBtn)) { <span class="hljs-comment">&lt;!-- 点击按钮时触发加载 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">app-order-detail</span> [<span class="hljs-attr">orderId</span>]=<span class="hljs-string">"currentOrderId"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">app-order-detail</span>&gt;</span>
} @loading {
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"loading-spinner"</span>&gt;</span>加载详情中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
} @error {
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"error"</span>&gt;</span>详情加载失败，请重试<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
}

<span class="hljs-comment">&lt;!-- 其他触发事件：hover/focus --&gt;</span>
@defer (on hover(detailCard)) { <span class="hljs-comment">&lt;!-- 鼠标悬浮时加载 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-tooltip"</span>&gt;</span>订单创建时间：{{ order.createTime }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
}

<span class="hljs-comment">&lt;!-- 其他触发事件：scroll --&gt;</span>
@defer (on scroll(detailCard, 200px)) {​
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"loading-more"</span>&gt;</span>加载更多商品中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>​
  <span class="hljs-tag">&lt;<span class="hljs-name">ng-container</span> *<span class="hljs-attr">ngIf</span>=<span class="hljs-string">"moreProducts$ | async as more"</span>&gt;</span>​
    @for (item of more; track item.id) {​
      <span class="hljs-tag">&lt;<span class="hljs-name">app-product-card</span> [<span class="hljs-attr">product</span>]=<span class="hljs-string">"item"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">app-product-card</span>&gt;</span>​
    }​
  <span class="hljs-tag">&lt;/<span class="hljs-name">ng-container</span>&gt;</span>​
}
</code></pre>
<h4 data-id="heading-26">2.4.4 when 触发（条件满足时加载）</h4>
<p>适用于 “数据就绪 / 状态变化时加载”（如筛选条件选择后加载表格）：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 条件触发：筛选条件选中后加载表格 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">select</span> [(<span class="hljs-attr">ngModel</span>)]=<span class="hljs-string">"selectedType"</span> (<span class="hljs-attr">change</span>)=<span class="hljs-string">"onTypeChange()"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">""</span>&gt;</span>请选择订单类型<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"all"</span>&gt;</span>全部订单<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"paid"</span>&gt;</span>已支付<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>

@defer (when selectedType !== '') { <span class="hljs-comment">&lt;!-- 当selectedType非空时加载 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">app-order-table</span> [<span class="hljs-attr">type</span>]=<span class="hljs-string">"selectedType"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">app-order-table</span>&gt;</span>
} @loading {
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"table-skeleton"</span>&gt;</span>表格加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
} @empty {
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>暂无{{ selectedType === 'paid' ? '已支付' : '全部' }}订单<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
}
</code></pre>
<h4 data-id="heading-27">2.4.5 prefetch 预加载（提前加载即将用到的内容）</h4>
<p>适用于 “即将触发加载” 的场景（如滚动到接近位置时预加载），减少用户等待时间：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 预加载：当用户滚动到距离组件500px时，提前加载 --&gt;</span>
@defer (on scroll(container, 500px); prefetch on scroll(container, 1000px)) {
  <span class="hljs-comment">&lt;!-- 滚动到距离组件1000px时预加载资源，滚动到500px时显示 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">app-long-list</span> [<span class="hljs-attr">page</span>]=<span class="hljs-string">"currentPage"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">app-long-list</span>&gt;</span>
}

<span class="hljs-comment">&lt;!-- 容器滚动监听：指定scroll的参考容器 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> #<span class="hljs-attr">container</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"scroll-container"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"height: 500px; overflow-y: auto;"</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 其他内容 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h4 data-id="heading-28">2.4.6 @error语法</h4>
<p>专为「<code>defer</code> 懒加载全流程」设计的错误捕获块，仅作用于 <code>defer</code> 块内部，捕获从「懒加载资源下载」到「组件初始化 / 渲染」的全链路错误，属于「资源加载层错误兜底」。</p>
<pre><code class="hljs language-html" lang="html">@defer
<span class="hljs-comment">&lt;!-- 懒加载目标组件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">app-lazy</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">app-lazy</span>&gt;</span>
} @placeholder {
<span class="hljs-comment">&lt;!-- 触发前占位：点击按钮加载 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>点击加载懒组件<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
} @loading {
<span class="hljs-comment">&lt;!-- 加载中状态 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
} @error {
<span class="hljs-comment">&lt;!-- 懒加载错误捕获：$error 是内置错误对象 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>❌ 懒加载失败：{{ $error.message }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
}
</code></pre>
<p><strong>可监听的错误类型</strong></p>
<ul>
<li>懒加载资源下载错误</li>
</ul>





























<table><thead><tr><th>类型</th><th>触发示例</th></tr></thead><tbody><tr><td>JS/CSS chunk 404</td><td>打包后的懒加载 chunk 路径错误、CDN 缓存失效、文件名哈希变更</td></tr><tr><td>网络层错误</td><td>下载 chunk 时断网、网络超时、DNS 解析失败</td></tr><tr><td>跨域 / 安全限制</td><td>chunk 资源违反 CORS/CSP 策略，浏览器拦截下载</td></tr><tr><td>混合内容错误</td><td>HTTPS 页面加载 HTTP 协议的懒加载 JS chunk（浏览器阻止）</td></tr><tr><td>资源大小超限</td><td>chunk 体积超过服务器 / 浏览器限制（如 nginx <code>client_max_body_size</code> 限制）</td></tr></tbody></table>
<ul>
<li>懒加载组件编译 / 解析错误</li>
</ul>

























<table><thead><tr><th>类型</th><th>触发示例</th></tr></thead><tbody><tr><td>组件代码语法错误</td><td>懒加载组件的 TS 代码有语法错误（如少分号、变量未定义）</td></tr><tr><td>模板语法错误</td><td>懒加载组件的模板有语法错误（如 <code>{{ data..name }}</code> 双点、指令拼写错误）</td></tr><tr><td>组件元数据错误</td><td>懒加载组件的 <code>@Component</code> 元数据错误（如 <code>selector</code> 重复、<code>imports</code> 漏写）</td></tr><tr><td>二进制 chunk 损坏</td><td>下载的 JS chunk 二进制数据不完整（如网络中断导致下载一半）</td></tr></tbody></table>
<ul>
<li>懒加载组件初始化错误</li>
</ul>





















<table><thead><tr><th>类型</th><th>触发示例</th></tr></thead><tbody><tr><td>生命周期抛错</td><td>懒加载组件 <code>ngOnInit</code> 中调用接口抛错、<code>ngAfterViewInit</code> 操作 DOM 抛错</td></tr><tr><td>组件状态初始化错误</td><td>懒加载组件的 Signal / 变量初始化抛错（如 <code>count = signal(1/0)</code>）</td></tr><tr><td>模板渲染初始化错误</td><td>组件首次渲染时，同步模板表达式错误（如 <code>{{ undefined.name }}</code>）</td></tr></tbody></table>
<ul>
<li>懒加载组件依赖注入错误</li>
</ul>





















<table><thead><tr><th>类型</th><th>触发示例</th></tr></thead><tbody><tr><td>服务未提供</td><td>懒加载组件依赖 <code>UserService</code>，但未在 <code>providers</code>/ 根注入器中配置</td></tr><tr><td>依赖循环引用</td><td>懒加载组件依赖的服务与其他服务形成循环引用，导致注入失败</td></tr><tr><td>管道 / 指令未导入</td><td>懒加载组件模板使用 <code>myPipe</code>，但组件 <code>imports</code> 未导入该管道</td></tr></tbody></table>
<h4 data-id="heading-29">2.4.7 优缺点分析</h4>

























<table><thead><tr><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>1. 首屏加载提速：减少首屏 JS/CSS 体积（非关键组件延迟加载）</td><td>1. 触发时机需谨慎：滥用可能导致用户交互时卡顿（如点击后才加载大组件）</td></tr><tr><td>2. 简化状态管理：内置 <code>@loading/@error</code>，无需手动维护 loading/error 变量</td><td>2. 调试成本：需通过 Angular DevTools 查看延迟加载状态，无法直接断点调试</td></tr><tr><td>3. 预加载优化：prefetch 可平衡加载时机与用户体验，减少等待时间</td><td>3. 兼容性限制：仅 Angular17+ 支持，无法降级到旧版本</td></tr><tr><td>4. 语法直观：无需手动写 ngIf 控制显隐，模板逻辑更简洁</td><td>4. 复杂场景适配难：动态组件加载（如 ComponentFactoryResolver）需额外处理</td></tr></tbody></table>
<h3 data-id="heading-30">2.5 指令组合 API</h3>
<h4 data-id="heading-31">2.5.1 核心定义</h4>
<p>组件通过<code>hostDirectives</code>配置，直接 “继承” 其他指令的逻辑（属性、方法、生命周期）</p>
<h4 data-id="heading-32">2.5.2 解决痛点</h4>
<p>旧版用 mixin（混入）复用逻辑，代码冗余且类型不安全；模板中重复绑定指令</p>
<h4 data-id="heading-33">2.5.3 实战代码</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 1. 定义独立指令（封装通用逻辑）</span>
<span class="hljs-meta">@Directive</span>({ <span class="hljs-attr">selector</span>: <span class="hljs-string">'[appAuth]'</span>, <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span> })
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthDirective</span> {
  <span class="hljs-meta">@Input</span>() appAuth!: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 接收权限标识</span>
  <span class="hljs-title function_">ngOnInit</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'校验权限：'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">appAuth</span>); <span class="hljs-comment">// 通用权限校验逻辑</span>
  }
}

<span class="hljs-comment">// 2. 组件集成指令（无需模板绑定）</span>
<span class="hljs-meta">@Component</span>({
  <span class="hljs-attr">selector</span>: <span class="hljs-string">'app-admin-panel'</span>,
  <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">hostDirectives</span>: [
    { <span class="hljs-attr">directive</span>: <span class="hljs-title class_">AuthDirective</span>, <span class="hljs-attr">inputs</span>: [<span class="hljs-string">'appAuth'</span>] } <span class="hljs-comment">// 集成指令，映射输入</span>
  ],
  <span class="hljs-attr">template</span>: <span class="hljs-string">`&lt;div&gt;管理员面板&lt;/div&gt;`</span>
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AdminPanelComponent</span> { }

<span class="hljs-comment">// 3. 使用组件（直接传递指令输入）</span>
&lt;app-admin-panel appAuth=<span class="hljs-string">"admin"</span>&gt;&lt;/app-admin-panel&gt;
</code></pre>
<h3 data-id="heading-34">2.6 NgOptimizedImage</h3>
<h4 data-id="heading-35">2.6.1 核心定义</h4>
<p>Angular 15 + 稳定的图片优化指令，替代原生<code>img</code>，一站式解决图片加载性能问题</p>
<h4 data-id="heading-36">2.6.2 解决痛点</h4>
<p>原生图片易导致布局偏移（CLS）、加载慢、格式不优化、缺乏优先级控制</p>
<h4 data-id="heading-37">2.6.3 核心能力</h4>
<p>强制宽高比（防 CLS）、自动懒加载、自动格式转换（WebP/AVIF）、优先级控制</p>
<h4 data-id="heading-38">2.6.4 实战代码</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 1. 首屏核心图片（优先加载，禁用懒加载） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> 
  <span class="hljs-attr">ngSrc</span>=<span class="hljs-string">"home-banner.jpg"</span> 
  <span class="hljs-attr">width</span>=<span class="hljs-string">"1200"</span> 
  <span class="hljs-attr">height</span>=<span class="hljs-string">"400"</span> 
  <span class="hljs-attr">priority</span> &lt;!<span class="hljs-attr">--</span> <span class="hljs-attr">核心</span>：<span class="hljs-attr">首屏优先加载</span> <span class="hljs-attr">--</span>&gt;</span>
  alt="首页Banner"
&gt;

<span class="hljs-comment">&lt;!-- 2. 非首屏图片（自动懒加载，优化格式） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> 
  <span class="hljs-attr">ngSrc</span>=<span class="hljs-string">"user-avatar.jpg"</span> 
  <span class="hljs-attr">width</span>=<span class="hljs-string">"80"</span> 
  <span class="hljs-attr">height</span>=<span class="hljs-string">"80"</span> 
  <span class="hljs-attr">loading</span>=<span class="hljs-string">"lazy"</span> &lt;!<span class="hljs-attr">--</span> <span class="hljs-attr">默认懒加载</span>，<span class="hljs-attr">可省略</span> <span class="hljs-attr">--</span>&gt;</span>
  alt="用户头像"
&gt;

<span class="hljs-comment">&lt;!-- 3. 响应式图片（适配不同设备） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> 
  <span class="hljs-attr">ngSrc</span>=<span class="hljs-string">"product-{{size}}.jpg"</span> 
  [<span class="hljs-attr">width</span>]=<span class="hljs-string">"size === 'sm' ? 300 : 600"</span>
  [<span class="hljs-attr">height</span>]=<span class="hljs-string">"size === 'sm' ? 200 : 400"</span>
  [<span class="hljs-attr">size</span>]=<span class="hljs-string">"'(max-width: 640px) 300px, 600px'"</span>
  <span class="hljs-attr">alt</span>=<span class="hljs-string">"商品图片"</span>
&gt;</span>
</code></pre>
<h3 data-id="heading-39">2.7 canMatch 路由守卫</h3>
<h4 data-id="heading-40">2.7.1 核心定义</h4>
<p>Angular 15 + 稳定的路由守卫，在 “路由匹配阶段” 筛选路由，决定是否将路由纳入候选</p>
<h4 data-id="heading-41">2.7.2 解决痛点</h4>
<p>旧版<code>canActivate</code>在路由匹配后执行，失败则拒绝访问，无法实现 “同路径多组件” 动态匹配（如多租户）</p>
<h4 data-id="heading-42">2.7.3 核心差异（vs canActivate）</h4>
<ul>
<li>canActivate：匹配后准入控制 → 失败 = 拒绝访问</li>
<li>canMatch：匹配中筛选 → 失败 = 跳过当前路由，继续匹配下一个</li>
</ul>
<h4 data-id="heading-43">2.7.4 执行顺序</h4>
<ol>
<li>​<strong>matcher</strong>​：匹配 URL 规则；</li>
<li>​<strong>canMatch</strong>​：校验是否允许匹配该路由；</li>
<li>​<strong>canLoad</strong>​：校验是否允许加载懒加载模块；</li>
<li>加载模块（若 canLoad 通过）；</li>
<li>​<strong>canActivate</strong>​：校验是否允许激活路由；</li>
<li>激活路由，渲染组件。</li>
</ol>
<h4 data-id="heading-44">2.7.5 实战代码（多租户场景）</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 1. 定义canMatch守卫</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">tenantMatchGuard</span>: <span class="hljs-title class_">CanMatchFn</span> = <span class="hljs-function">(<span class="hljs-params">route</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> tenantService = <span class="hljs-title function_">inject</span>(<span class="hljs-title class_">TenantService</span>);
  <span class="hljs-keyword">return</span> tenantService.<span class="hljs-title function_">getCurrentTenant</span>() === route.<span class="hljs-property">data</span>.<span class="hljs-property">tenantId</span>;
};

<span class="hljs-comment">// 2. 路由配置（同路径匹配不同租户组件）</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">routes</span>: <span class="hljs-title class_">Routes</span> = [
  { 
    <span class="hljs-attr">path</span>: <span class="hljs-string">'dashboard'</span>, 
    <span class="hljs-attr">canMatch</span>: [tenantMatchGuard], 
    <span class="hljs-attr">data</span>: { <span class="hljs-attr">tenantId</span>: <span class="hljs-string">'tenant1'</span> }, 
    <span class="hljs-attr">component</span>: <span class="hljs-title class_">Tenant1DashboardComponent</span> 
  },
  { 
    <span class="hljs-attr">path</span>: <span class="hljs-string">'dashboard'</span>, 
    <span class="hljs-attr">canMatch</span>: [tenantMatchGuard], 
    <span class="hljs-attr">data</span>: { <span class="hljs-attr">tenantId</span>: <span class="hljs-string">'tenant2'</span> }, 
    <span class="hljs-attr">component</span>: <span class="hljs-title class_">Tenant2DashboardComponent</span> 
  },
  { <span class="hljs-attr">path</span>: <span class="hljs-string">'dashboard'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">FallbackDashboardComponent</span> } <span class="hljs-comment">// 兜底</span>
];
</code></pre>
<h3 data-id="heading-45">2.8 依赖注入（DI）增强：更灵活的注入方式</h3>
<h4 data-id="heading-46">2.8.1 核心定义</h4>
<p>Angular 16 + 优化的 DI 系统，支持<code>inject</code>函数在构造函数外使用，增强环境区分能力</p>
<h4 data-id="heading-47">2.8.2 解决痛点</h4>
<p>旧版<code>inject</code>仅能在构造函数 / 工厂函数中使用，静态方法、第三方库回调中无法注入</p>
<h4 data-id="heading-48">2.8.3 实战代码（常用场景）</h4>
<h5 data-id="heading-49">场景 1：类内任意位置注入</h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-meta">@Injectable</span>({ <span class="hljs-attr">providedIn</span>: <span class="hljs-string">'root'</span> })
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigService</span> {
  <span class="hljs-keyword">private</span> http = <span class="hljs-title function_">inject</span>(<span class="hljs-title class_">HttpClient</span>); <span class="hljs-comment">// 类内直接注入，无需构造函数</span>

  <span class="hljs-title function_">loadConfig</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/config'</span>);
  }
}
</code></pre>
<h5 data-id="heading-50">场景 2：静态方法中注入</h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-meta">@Injectable</span>({ <span class="hljs-attr">providedIn</span>: <span class="hljs-string">'root'</span> })
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TenantService</span> {
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">getCurrentTenant</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> configService = <span class="hljs-title function_">inject</span>(<span class="hljs-title class_">ConfigService</span>); <span class="hljs-comment">// 静态方法注入</span>
    <span class="hljs-keyword">return</span> configService.<span class="hljs-title function_">loadConfig</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-property">tenantId</span>);
  }
}
</code></pre>
<h3 data-id="heading-51">2.9 Required Inputs：编译时校验的必填输入</h3>
<h4 data-id="heading-52">2.9.1 核心定义</h4>
<p>Angular 16 + 稳定的输入属性校验特性，通过<code>@Input({ required: true })</code>标记必填，编译时 + 运行时双校验</p>
<h4 data-id="heading-53">2.9.2 解决痛点</h4>
<p>旧版需手动在<code>ngOnInit</code>中判空，易遗漏导致空值 Bug；错误反馈滞后（运行时才报错）</p>
<h4 data-id="heading-54">2.9.3 实战代码</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 1. 标记必填输入</span>
<span class="hljs-meta">@Component</span>({
  <span class="hljs-attr">selector</span>: <span class="hljs-string">'app-user-card'</span>,
  <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">template</span>: <span class="hljs-string">`&lt;div&gt;{{user.name}}&lt;/div&gt;`</span>
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserCardComponent</span> {
  <span class="hljs-meta">@Input</span>({ <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span> }) user!: { <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span> }; <span class="hljs-comment">// 核心：required: true</span>
}

<span class="hljs-comment">// 2. 使用组件（未传user时编译报错）</span>
&lt;app-user-card [user]=<span class="hljs-string">"userData"</span>&gt;&lt;/app-user-card&gt; &lt;!-- 正确 --&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">app-user-card</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">app-user-card</span>&gt;</span></span> &lt;!-- 错误：编译时报错 <span class="hljs-title class_">NG8007</span> --&gt;
</code></pre>
<h2 data-id="heading-55">三、优秀实践——懒加载</h2>
<p>学完上述 9 个实用特性，我们不妨把它们串联起来落地实践。这一节，我们聚焦性能优化的高频需求 —— 懒加载，详细讲讲如何通过 ​<strong>独立组件与 defer 延迟加载语法的结合</strong>​，实现高效的按需加载方案。</p>
<h3 data-id="heading-56">3.1 必要条件</h3>
<p>相信不少开发者刚接触 <code>@defer</code> 延迟加载语法时，都会遇到一个共性问题 —— 明明写了语法，懒加载却始终不生效。其实这背后，是因为我们忽略了几个关键的必要条件。</p>
<p>假设组件 A 是与 <code>@defer</code> 指令处于<strong>同一层级</strong>的组件，而组件 B 是被 <code>@defer</code> 指令包裹、需要实现懒加载的目标组件。</p>
<p><strong>必要条件：</strong></p>
<ul>
<li>组件A必须是独立组件：<code>standalone: true</code>;</li>
<li>组件B必须是独立组件：<code>standalone: true</code>;</li>
<li>组件A需显式导入组件B: <code>imports:[RepoEchartComponent]</code>;</li>
</ul>
<h3 data-id="heading-57">3.2 实战代码</h3>
<h4 data-id="heading-58">3.2.1 场景一：评论区懒加载（用户滚动到区域才加载）</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">section</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>商品详情<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 其他内容 --&gt;</span>

  @defer (on viewport; prefetch on idle) {
    <span class="hljs-tag">&lt;<span class="hljs-name">app-comments</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">app-comments</span>&gt;</span>
  } @loading {
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>评论加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  }
<span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span>

</code></pre>
<h4 data-id="heading-59">3.2.1 场景二：结合 <code>@switch</code> 实现 Tab 懒加载</h4>
<pre><code class="hljs language-html" lang="html">@switch (activeTab) {
  @case ('profile') {
    @defer (on viewport) {
      <span class="hljs-tag">&lt;<span class="hljs-name">app-profile</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">app-profile</span>&gt;</span>
    }
  }
  @case ('settings') {
    @defer (on interaction) {
      <span class="hljs-tag">&lt;<span class="hljs-name">app-settings</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">app-settings</span>&gt;</span>
    }
  }
}
</code></pre>
<h3 data-id="heading-60">3.3 注意事项</h3>
<ul>
<li>
<p><code>@defer</code>​<strong>不能嵌套</strong>​（截至 Angular 18）</p>
</li>
<li>
<p>不要过度使用：每个 defer 块会生成独立 chunk，过多可能导致 HTTP 请求爆炸</p>
</li>
<li>
<p><code>prefetch</code> 为实验性功能，需启用 <code>deferBlockPrefetching</code></p>
</li>
<li>
<p>已在其他场景引用或注册的组件无法被懒加载</p>
</li>
<li>
<p>继承的父组件类无法被懒加载，需改造成非组件类
<strong>错误示例：</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-meta">@Component</span>({
    <span class="hljs-attr">templateUrl</span>: <span class="hljs-string">'./basic.component.html'</span>,
    <span class="hljs-attr">styleUrls</span>: [<span class="hljs-string">'./basic.component.scss'</span>],
    <span class="hljs-attr">standalone</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">imports</span>: <span class="hljs-title class_">BasicModules</span>,
 }）
<span class="hljs-comment">//这是一个组件基类</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BasicComponent</span>{}

<span class="hljs-comment">//这是期望懒加载的组件Demo</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">BasicComponent</span>{}
</code></pre>
<p><strong>修改方案</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">//将组件基类改造为非组件类</span>
<span class="hljs-meta">@Injectable</span>({ <span class="hljs-attr">providedIn</span>: <span class="hljs-string">'any'</span> })
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BasicComponent</span>{}
</code></pre>
</li>
</ul>
<p>以上就是懒加载的实现方案和踩坑经验啦，希望能帮到正在折腾 <code>@defer</code> 的小伙伴～</p>
<h2 data-id="heading-61">四、总结</h2>
<p>Angular的新特性围绕 “​<strong>性能优化</strong>​”“​<strong>开发效率</strong>​”“​<strong>场景适配</strong>​” 三大核心：延迟加载模版（@defer） 降低首屏加载成本，独立组件与新控制流语法简化代码结构，信号（Signals）完善响应式能力。通过熟练掌握这些新语法，可显著提升项目性能与可维护性。</p>
<p>若想了解Angular新特性底层原理，请参考掘金文章 <a href="https://juejin.cn/post/7339686366311792676?searchId=202512182210541AE2D44ED7587BA97846" target="_blank" title="https://juejin.cn/post/7339686366311792676?searchId=202512182210541AE2D44ED7587BA97846">juejin.cn/post/733968…</a></p>
<h2 data-id="heading-62">五、 加入我们</h2>
<p>MateChat 正在快速发展，我们欢迎更多开发者加入：</p>
<ul>
<li>💬 DevUI微信小助手：devui-official（添加时请备注MateChat）</li>
<li>🌟 代码仓库地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FDevCloudFE%2FMateChat%2Freleases%3FpresetConfig%3D%257B%2522tags%2522%3A12%2C%2522release%2522%3A11%257D" target="_blank" title="https://gitcode.com/DevCloudFE/MateChat/releases?presetConfig=%7B%22tags%22:12,%22release%22:11%7D" ref="nofollow noopener noreferrer">gitcode.com/DevCloudFE/…</a></li>
</ul>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21f25f459a984f3f864807f5ced93d6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGV2VUnlm6LpmJ8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768303040&amp;x-signature=MCKscVBlaSoeSGm%2Beu0hKlnVN%2B0%3D" height="150px" loading="lazy"/> 
<blockquote>
<p>广纳贤士：AI赋能各行各业，MateChat期待更多感兴趣的小伙伴加入我们~</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FDevCloudFE%2FMateChat%2Fissues" target="_blank" title="https://gitcode.com/DevCloudFE/MateChat/issues" ref="nofollow noopener noreferrer">欢迎大家前来提交Issue，认领Issue；</a></li>
</ul>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>